<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[【Android】动态操作 Window 的背后机制]]></title>    <link>https://juejin.cn/post/7582997593090768915</link>    <guid>https://juejin.cn/post/7582997593090768915</guid>    <pubDate>2025-12-14T12:22:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582997593090768915" data-draft-id="7583530023359299622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Android】动态操作 Window 的背后机制"/> <meta itemprop="keywords" content="Java,Android"/> <meta itemprop="datePublished" content="2025-12-14T12:22:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Propeller"/> <meta itemprop="url" content="https://juejin.cn/user/4311645702612554"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Android】动态操作 Window 的背后机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4311645702612554/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Propeller
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T12:22:49.000Z" title="Sun Dec 14 2025 12:22:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Window 和 WindowManager</h2>
<p>视频通话程序和音乐播放程序能看到的电话或音乐悬浮窗本质都是 Window，我们初始化空项目，应用启动时显示的画面就是 Window，系统状态栏和导航栏则也是 Window，所以单屏幕是可以对应多 Window 的，首先来看动态添加 Window 的过程</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-type">Button</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Button</span>(<span class="hljs-built_in">this</span>);
 WindowManager.<span class="hljs-type">LayoutParams</span> <span class="hljs-variable">lp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManager</span>.LayoutParams(
         LayoutParams.WRAP_CONTENT, 
         LayoutParams.WRAP_CONTENT, 
         <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, 
         PixelFormat.TRANSPARENT
 );
 lp.flags = LayoutParams.FLAG_NOT_TOUCH_MODAL
         | LayoutParams.FLAG_NOT_FOCUSABLE
         | LayoutParams.FLAG_SHOW_WHEN_LOCKED
 lp.gravity = Gravity.LEFT | Gravity.TOP;
 lp.x = <span class="hljs-number">100</span>;
 lp.y = <span class="hljs-number">100</span>;
 getWindowManager().addView(button, lp);
</code></pre>
<p>Window 是承载 View 的工具，所以添加 Window 的方法往往要伴随控件的加入，WindowManager 的 addView 方法会在参数设置的屏幕位置创建 Window，接着把 View 添加进 Window。</p>
<p>注意参数有 flags 和 type 两种属性，它们分别表示 Window 的显示特征和 Window 类型。常用的显示特征在代码块中有所提到：</p>
<ol>
<li>FLAG_NOT_FOCUSABLE：表示 Window 不需要获取焦点，也就意味着 Window 不需要也无法接收任何事件，事件会传给 z-order 更低且具有焦点的 Window，激活该标记会同时启用 FLAG_NOT_TOUCH_MODAL；</li>
<li>FLAG_NOT_TOUCH_MODAL：添加的 Window 本身在高 z 区域，会默认拦截即使是 Window 外部区域的事件，该标志会将外部区域的事件分发到低 z 值 Window，若在 Window 内部则由自己处理；</li>
<li>FLAG_SHOW_WHEN_LOCKED：表示允许 Window 显示在锁屏界面，常用于闹铃或电话功能。</li>
</ol>
<p>type 即 Window 的类型：应用 Window、派生 Window 和系统 Window，应用 Window 与 Activity 实例对应；派生 Window 不能单独存在，需要依附在特定的父 Window；系统 Window 要在声明权限后才能创建，Toast 和系统状态栏都是系统 Window。</p>
<p>前面提到的 z-order 就是 Window 的分层策略，层级大的 Window 会覆盖在层级小的 Window 上面，不同的 Window 类型具有不同的层级 z 值范围，应用 Window 的层级范围为 1-99、派生 Window 的层级范围为 1000-1999、系统 Window 的层级范围为 2000-2999。层级值对应 type 参数，显然系统窗口的层级更大。</p>
<p>Window 本身是抽象类，其实现为 PhoneWindow。WindowManagerServer 存在于系统进程中，使用多进程管理当前显示屏幕的所有 Window。WindowManager 用于向屏幕添加 Window，其有 addView、updateViewLayout 和 removeView 等方法。Window 和 View 通过 ViewRootImpl 建立联系，向屏幕添加 Window 时我们也能发现，View 才是 Window 存在的实体，实际使用中无法直接访问 Window。</p>
<h2 data-id="heading-1">Window 的内部机制</h2>
<h3 data-id="heading-2">addView</h3>
<p>Window 的添加过程由 WindowManager 接口的实现类 WindowManagerImpl 实现，其直接转交给 WindowManagerGlobal 处理，removeView 和 updateViewLayout 也是相同的逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params)</span> {
    mGlobal.addView(view, params, mDisplay, mParentWindow);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeView</span><span class="hljs-params">(View view)</span> {
    mGlobal.removeView(view, <span class="hljs-literal">false</span>);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateViewLayout</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params)</span> {
    mGlobal.updateViewLayout(view, params);
}
</code></pre>
<p>WindowManagerGlobal 的 addView 方法分有 3 步：</p>
<ol>
<li>
<p>检查参数合法性，若是派生 Window 则根据父 Window 调整布局参数，类似 View 在 ViewGroup 内部的自适应处理；</p>
</li>
<li>
<p>创建 ViewRootImpl 并将 View 添加到列表，值得注意的是 WindowManagerGlobal 有若干成员列表，其分别是</p>
<ol>
<li>mViews：存储所有 Window 对应的 View；</li>
<li>mRoots：存储所有 Window 对应的 ViewRootImpl；</li>
<li>mParams：存储所有 Window 对应的布局参数；</li>
<li>mDyingViews：存储正在被删除的 View 实例，可以认作已经调用 removeView 方法但删除操作还未完成的 Window 对象。</li>
</ol>
</li>
<li>
<p>借助 ViewRootImpl 的 setView 方法更新界面并完成 Window 的添加过程。setView 会通过 requestLayout 完成异步刷新请求。</p>
</li>
</ol>
<p>交由 ViewRootImpl 调用 requestLayout 方法后，mWindowSession 执行 Window 的添加过程，mWindowSession 是 Binder 对象，真正的实现类是 Session，最后会由 WindowManagerService 完成 Window 的添加。</p>
<h3 data-id="heading-3">removeView</h3>
<p>Window 的删除过程也通过 WindowManagerImpl 后接着交由 WindowManagerGlobal 实现，其会做同步块查索引后再调用 removeViewLocked 方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/* WindowManagerImpl */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeView</span><span class="hljs-params">(View view, <span class="hljs-type">boolean</span> immediate)</span> {
    ...
    
    <span class="hljs-keyword">synchronized</span> (mLock) {
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> findViewLocked(view, <span class="hljs-literal">true</span>);
        <span class="hljs-type">View</span> <span class="hljs-variable">curView</span> <span class="hljs-operator">=</span> mRoots.get(index).getView();
        removeViewLocked(index, immediate);
        <span class="hljs-keyword">if</span> (curView == view) {
            <span class="hljs-keyword">return</span>;
        }
        
        ...
    }
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeViewLocked</span><span class="hljs-params">(<span class="hljs-type">int</span> index, <span class="hljs-type">boolean</span> immediate)</span> {
    <span class="hljs-type">ViewRootImpl</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> mRoots.get(index);
    <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> root.getView();
    
    <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {
        <span class="hljs-type">InputMethodManager</span> <span class="hljs-variable">imm</span> <span class="hljs-operator">=</span> InputMethodManager.getInstance();
        <span class="hljs-keyword">if</span> (imm != <span class="hljs-literal">null</span>) {
            imm.windowDismissed(mViews.get(index).getWindowToken());
        }
    }
    <span class="hljs-type">boolean</span> <span class="hljs-variable">deferred</span> <span class="hljs-operator">=</span> root.die(immediate);
    <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {
        view.assignParent(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">if</span> (defered) {
            mDyingViews.add(view);
        }
    }
}
</code></pre>
<p>removeView 是异步删除，removeViewLocked 方法的处理主要有收起输入法、调用 ViewRootImpl.die 方法和将 View 添加到 mDyingViews 列表。die 方法内部只有简单判断，如果是异步删除则发送 MSG_DIE 消息，ViewRootImpl 的 Handler 会处理此消息并调用 toDie 方法。</p>
<p>最后由 dispatchDetachedFromWindow 方法执行真正的 View 删除逻辑，主要做有 4 件事：</p>
<ol>
<li>垃圾回收工作，如清理数据和移除回调等；</li>
<li>通过 Session 的 remove 方法删除 Window；</li>
<li>调用 View 的 dispatchDetachedFromWindow 方法，内部会回调可供重写的 onDetachedFromWindow 和 onDetachedFromWindowInternal 方法；</li>
<li>调用 WindowManagerGlobal 的 doRemoveView 方法刷新数据，清除在列表的记录。</li>
</ol>
<h3 data-id="heading-4">updateViewLayout</h3>
<p>Window 的更新过程比较简单，还是由 WindowManagerGlobal 处理，它会更新 View 和 ViewRootImpl 的布局参数。ViewRootImpl 内部会通过 scheduleTraversals 方法对 View 重新布局，还会通过 WindowSession 更新 Window 视图，该过程同样是 IPC 过程，由 WindowManagerService 的 relayoutWindow 实现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[车载 Android 黑卡死问题定义和分配原则]]></title>    <link>https://juejin.cn/post/7583571595202461734</link>    <guid>https://juejin.cn/post/7583571595202461734</guid>    <pubDate>2025-12-14T12:23:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583571595202461734" data-draft-id="7583574154339893257" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="车载 Android 黑卡死问题定义和分配原则"/> <meta itemprop="keywords" content="性能优化"/> <meta itemprop="datePublished" content="2025-12-14T12:23:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            车载 Android 黑卡死问题定义和分配原则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T12:23:03.000Z" title="Sun Dec 14 2025 12:23:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">黑卡死问题定义</h2>
<ul>
<li><strong>黑卡死</strong>是车机屏幕出现全屏且持续显示异常的统称，包括黑屏、白屏、闪屏、卡死、异常重启等</li>
<li>问题分配的核心原则：<strong>先定位现象范围，再确定首要分析方</strong></li>
<li>本文提供高通平台完整的问题分类树和分配规则，附带各类问题的排查方法</li>
</ul>
<hr/>
<h2 data-id="heading-1">引言</h2>
<p>"又黑屏了！"——这可能是车机测试群里最让人心跳加速的三个字。</p>
<p>作为车机系统最严重的问题类型之一，黑卡死问题有着让人头疼的"三高"特点：<strong>严重程度高、紧急程度高、排查难度高</strong>。更让人崩溃的是，这类问题往往涉及多个团队（MCU、QNX、Android、BSP、应用），一不小心就变成了各方"踢皮球"的重灾区。</p>
<blockquote>
<p>我曾经历过一个项目，一个黑屏问题在5个团队之间流转了两周，最后发现是电源管理模块的一个时序问题。如果一开始就有清晰的分配原则，这个问题可能三天就能定位。</p>
</blockquote>
<p>本文的目的，就是基于多个高通平台项目的黑卡死问题排查经验，建立一套<strong>清晰、可执行</strong>的问题分配和排查规则，让问题能够快速精确地找到"第一责任人"。</p>
<hr/>
<h2 data-id="heading-2">适用范围与阅读对象</h2>
<h3 data-id="heading-3">适用范围</h3>
<ul>
<li><strong>硬件平台</strong>：高通车机平台（SA8155P、SA8295P 等）</li>
<li><strong>软件架构</strong>：QNX Hypervisor + Android 的多系统架构</li>
<li><strong>屏幕配置</strong>：中控屏 + 仪表屏的双屏/多屏方案</li>
</ul>
<h3 data-id="heading-4">阅读对象</h3>





























<table><thead><tr><th>角色</th><th>关注重点</th></tr></thead><tbody><tr><td>项目管理</td><td>问题分配规则、流转流程</td></tr><tr><td>软件架构</td><td>整体排查思路、跨域协作</td></tr><tr><td>研发质量</td><td>问题分类标准、复盘依据</td></tr><tr><td>研发工程师</td><td>具体排查方法、日志分析</td></tr><tr><td>测试工程师</td><td>问题描述规范、信息收集</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">黑卡死问题定义</h2>
<h3 data-id="heading-6">什么是黑卡死？</h3>
<p>本文讨论的是<strong>广义的黑卡死问题</strong>，可以理解为车机屏幕出现<strong>全屏且持续</strong>的显示异常。</p>
<blockquote>
<p>注意关键词：<strong>全屏</strong> + <strong>持续</strong>。局部 UI 异常或短暂闪烁通常不归入此类。</p>
</blockquote>
<h3 data-id="heading-7">现象分类</h3>





































<table><thead><tr><th align="left">现象</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>黑屏</strong></td><td align="left">屏幕全黑，无任何显示内容（可能有/无背光）</td></tr><tr><td align="left"><strong>白屏</strong></td><td align="left">屏幕全白，无法显示正常内容</td></tr><tr><td align="left"><strong>绿屏</strong></td><td align="left">屏幕显示纯绿色（通常与视频解码相关）</td></tr><tr><td align="left"><strong>花屏</strong></td><td align="left">屏幕显示杂乱的色块或条纹</td></tr><tr><td align="left"><strong>闪屏</strong></td><td align="left">屏幕内容持续闪烁或间歇性黑屏</td></tr><tr><td align="left"><strong>卡屏</strong></td><td align="left">屏幕内容定格，触摸无响应</td></tr><tr><td align="left"><strong>异常重启</strong></td><td align="left">系统非预期重启（可能伴随短暂黑屏）</td></tr></tbody></table>
<h3 data-id="heading-8">与其他问题的区别</h3>









































<table><thead><tr><th>问题类型</th><th>范围</th><th>持续性</th><th>是否属于黑卡死</th></tr></thead><tbody><tr><td>全屏黑屏超过3秒</td><td>全屏</td><td>持续</td><td>✅ 是</td></tr><tr><td>某个应用界面卡住</td><td>局部</td><td>持续</td><td>❌ 否（应用ANR）</td></tr><tr><td>开机Logo显示时间过长</td><td>全屏</td><td>非持续</td><td>❌ 否（启动性能问题）</td></tr><tr><td>切换应用时闪一下黑屏</td><td>全屏</td><td>非持续</td><td>❌ 否（过渡动画问题）</td></tr><tr><td>整个系统触摸无响应</td><td>全屏</td><td>持续</td><td>✅ 是（卡死）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">高通平台问题分配原则</h2>
<h3 data-id="heading-10">总体原则</h3>
<p><strong>核心思路</strong>：现象定位 → 范围判断 → 首要分析方 → 逐级排查</p>
<pre><code class="hljs language-markdown" lang="markdown">问题报告 ──▶ 现象是什么？──▶ 影响范围多大？──▶ 分配给首要分析方
<span class="hljs-code">                │                  │
                ▼                  ▼
           黑屏/卡死/重启等    中控/仪表/全部
</span></code></pre>
<h3 data-id="heading-11">首要分析方说明</h3>
<p>在进入具体分类之前，先了解各分析方的职责：</p>


















































<table><thead><tr><th>分析方</th><th>职责范围</th><th>典型问题</th></tr></thead><tbody><tr><td><strong>MCU</strong></td><td>整车电源管理、休眠唤醒、看门狗</td><td>全系统黑屏、异常重启</td></tr><tr><td><strong>QNX</strong></td><td>Hypervisor、显示资源调度、早期启动</td><td>多屏同时异常</td></tr><tr><td><strong>BSP</strong></td><td>Linux/Android内核、驱动、Display子系统</td><td>显示驱动异常</td></tr><tr><td><strong>Android FW</strong></td><td>Framework层、SurfaceFlinger、SystemServer</td><td>中控卡死、ANR</td></tr><tr><td><strong>仪表HMI</strong></td><td>仪表应用层渲染</td><td>仪表闪屏、仪表卡死</td></tr><tr><td><strong>仪表中间件</strong></td><td>仪表数据通信、刷新机制</td><td>仪表数据异常</td></tr><tr><td><strong>对应应用</strong></td><td>具体App</td><td>单应用卡死</td></tr><tr><td><strong>性能团队</strong></td><td>系统性能优化</td><td>整体卡顿</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">问题分类与分配详解</h2>
<h3 data-id="heading-13">一、黑屏问题</h3>
<p>黑屏是最常见也最"吓人"的问题类型。根据<strong>影响范围</strong>和<strong>持续性</strong>，分为以下子类：</p>
<h4 data-id="heading-14">1.1 持续黑屏</h4>
<h5 data-id="heading-15">现象一：中控和仪表都黑屏</h5>
<p><strong>首要分析方</strong>：MCU 与 QNX 电源模块</p>
<p><strong>分析思路</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52cd2bac27024cbea5722eeb542ed4a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319783&amp;x-signature=HZcCouWIpMtNReAR81KNuTOiCR0%3D" alt="中控仪表都黑屏.png" loading="lazy"/>
<strong>排查步骤</strong>：</p>
<ol>
<li>检查 MCU 串口日志，确认 MCU 状态</li>
<li>检查 QNX 串口日志，确认 Hypervisor 启动状态</li>
<li>检查各显示屏背光控制信号</li>
<li>确认 SOC 主芯片电源时序是否正常</li>
</ol>
<p><strong>关键日志</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># MCU 日志关注点</span>
[MCU] Power state: xxx
[MCU] Watchdog: xxx

<span class="hljs-comment"># QNX 日志关注点</span>
[QNX] display_manager: initialized
[QNX] screen: display attached
</code></pre>
<p><strong>后续流转</strong>：</p>
<ul>
<li>若发现异常 → 交对应团队分析</li>
<li>若 MCU/QNX 正常 → BSP 分析</li>
<li>若 BSP 正常 → 由项目/质量拉通各方分析，架构支持</li>
</ul>
<hr/>
<h5 data-id="heading-16">现象二：仅仪表黑屏（中控正常）</h5>
<p><strong>首要分析方</strong>：BSP</p>
<p><strong>分析思路</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ccc0e670f964931b49624019b7f7f37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319783&amp;x-signature=VVQSzl6a%2B2SVf6%2B6PNOKDBHcxVk%3D" alt="仪表黑屏.png" loading="lazy"/></p>
<p><strong>排查步骤</strong>：</p>
<ol>
<li>检查仪表屏 MIPI/LVDS 信号是否正常</li>
<li>查看 Display 驱动日志，确认屏幕初始化状态</li>
<li>检查仪表系统 HMI 渲染进程状态</li>
<li>对比中控显示链路，排查差异点</li>
</ol>
<hr/>
<h5 data-id="heading-17">现象三：仅中控黑屏（仪表正常）</h5>
<p><strong>首要分析方</strong>：MCU 与 QNX 电源模块</p>
<p><strong>分析思路</strong>：</p>
<p>中控单独黑屏，仪表正常，说明 SOC 主芯片在运行，问题可能在：</p>
<ul>
<li>中控屏电源管理</li>
<li>Android 显示通道</li>
<li>SurfaceFlinger 状态</li>
</ul>
<p><strong>排查步骤</strong>：</p>
<ol>
<li>检查中控屏背光、电源状态</li>
<li>检查 Android SurfaceFlinger 状态</li>
<li>查看 Display HAL 层日志</li>
<li>检查 QNX 到 Android 的显示资源分配</li>
</ol>
<p><strong>后续流转</strong>：</p>
<ul>
<li>MCU/QNX 异常 → 对应团队</li>
<li>若正常 → Android FW 分析 → BSP 分析 → 项目拉通</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de610c0edec747098fcacbf964d559d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319783&amp;x-signature=aFMflcVvWVaL7S%2FvnyETnPcu7OU%3D" alt="中控黑屏.png" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-18">1.2 闪屏</h4>
<h5 data-id="heading-19">仪表闪屏</h5>
<p><strong>首要分析方</strong>：仪表 HMI</p>
<p><strong>常见原因</strong>：</p>
<ul>
<li>HMI 渲染帧率不稳定</li>
<li>图层切换时序问题</li>
<li>VSync 同步异常</li>
</ul>
<p><strong>排查步骤</strong>：</p>
<ol>
<li>检查仪表 HMI 帧率统计</li>
<li>分析图层切换日志</li>
<li>检查 VSync 信号是否正常</li>
</ol>
<p><strong>后续流转</strong>：HMI 正常 → BSP 分析 → 项目拉通</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90430ad5a8874be691761d4e53b2d1c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319783&amp;x-signature=EzGwRrppT1mHudCASvCGtAflKGQ%3D" alt="仪表闪屏.png" loading="lazy"/></p>
<hr/>
<h5 data-id="heading-20">中控闪屏</h5>
<p><strong>首要分析方</strong>：Android 前台应用</p>
<p><strong>分析思路</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d1d21effdf84a94a3eb41efc4121f9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319783&amp;x-signature=SdUNXbD0mP0k1kRfXmGvTsf1f%2B4%3D" alt="中控闪屏.png" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-21">1.3 部分区域黑屏</h4>
<p><strong>首要分析方</strong>：对应应用</p>
<p><strong>说明</strong>：部分区域黑屏通常是某个应用的 Surface 未正确渲染，直接交给对应应用分析。</p>
<hr/>
<h3 data-id="heading-22">二、卡死问题</h3>
<p>卡死的特点是：<strong>屏幕有显示，但触摸无响应或界面定格</strong>。</p>
<h4 data-id="heading-23">2.1 中控卡死</h4>
<h5 data-id="heading-24">整个屏幕卡死，各处点击都无响应</h5>
<p><strong>首要分析方</strong>：Android FW</p>
<p><strong>分析思路</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4c73e8ae7d94d0d98e5f3e540d27c0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319783&amp;x-signature=949UpJC9W4nvrUo%2BdyBmN%2BgB5KU%3D" alt="中控整体卡死.png" loading="lazy"/></p>
<p><strong>关键排查命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 SystemServer 状态</span>
adb shell dumpsys activity

<span class="hljs-comment"># 检查输入子系统</span>
adb shell dumpsys input

<span class="hljs-comment"># 获取 ANR traces</span>
adb pull /data/anr/traces.txt

<span class="hljs-comment"># 检查系统负载</span>
adb shell top -n 1
adb shell <span class="hljs-built_in">cat</span> /proc/loadavg
</code></pre>
<hr/>
<h5 data-id="heading-25">单个应用卡死</h5>
<p><strong>首要分析方</strong>：对应应用</p>
<p><strong>排查步骤</strong>：</p>
<ol>
<li>获取应用的 ANR traces</li>
<li>分析应用主线程状态</li>
<li>检查是否有死锁或长耗时操作</li>
</ol>
<hr/>
<h4 data-id="heading-26">2.2 仪表卡死</h4>
<p><strong>首要分析方</strong>：仪表 HMI 或仪表中间件</p>
<p><strong>分析思路</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01878e6221b24234801bbfe1ba8dd263~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319783&amp;x-signature=loUAjOeKZPNe0HcsVIK0saMTR30%3D" alt="仪表卡死.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-27">三、卡顿问题</h3>
<p>卡顿与卡死的区别：<strong>卡顿有响应，只是响应慢；卡死完全无响应</strong>。</p>
<h4 data-id="heading-28">3.1 整个系统卡顿、响应慢</h4>
<p><strong>首要分析方</strong>：性能团队</p>
<p><strong>排查方向</strong>：</p>
<ul>
<li>CPU 占用率、调度情况</li>
<li>内存压力、Swap 使用</li>
<li>IO 等待、磁盘性能</li>
<li>温控降频情况</li>
</ul>
<hr/>
<h4 data-id="heading-29">3.2 单个应用卡顿</h4>
<p><strong>首要分析方</strong>：对应应用</p>
<hr/>
<h3 data-id="heading-30">四、异常重启</h3>
<h4 data-id="heading-31">4.1 仪表、中控都重启</h4>
<p><strong>首要分析方</strong>：MCU</p>
<p><strong>分析思路</strong>：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b8577132ccc4e3c8005589e8b66940d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319783&amp;x-signature=vGjkfx5x4qCoE1dL0XCDqwBzKMY%3D" alt="全系统重启.png" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-32">4.2 仅中控重启（仪表正常）</h4>
<p><strong>首要分析方</strong>：Android FW</p>
<p><strong>分析思路</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/907d91244e874d5f94679522aa043625~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319783&amp;x-signature=HgY5P379f10wecvu6BoWr1Go%2F9Q%3D" alt="中控重启.png" loading="lazy"/></p>
<p><strong>关键日志获取</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 获取上次重启前的内核日志</span>
adb shell <span class="hljs-built_in">cat</span> /sys/fs/pstore/console-ramoops-0

<span class="hljs-comment"># 获取 tombstone</span>
adb pull /data/tombstones/

<span class="hljs-comment"># 检查重启原因</span>
adb shell getprop ro.boot.bootreason
</code></pre>
<hr/>
<h2 data-id="heading-33">问题分配速查表</h2>
<p>为便于快速查阅，汇总如下：</p>











































































<table><thead><tr><th>问题现象</th><th>首要分析方</th><th>后续流转</th></tr></thead><tbody><tr><td>中控仪表都黑屏</td><td>MCU/QNX电源</td><td>→ BSP → 项目拉通</td></tr><tr><td>仅仪表黑屏</td><td>BSP</td><td>→ 仪表HMI → 项目拉通</td></tr><tr><td>仅中控黑屏</td><td>MCU/QNX电源</td><td>→ Android FW → BSP → 项目拉通</td></tr><tr><td>仪表闪屏</td><td>仪表HMI</td><td>→ BSP → 项目拉通</td></tr><tr><td>中控闪屏</td><td>前台应用</td><td>→ Android FW → BSP → 项目拉通</td></tr><tr><td>部分区域黑屏</td><td>对应应用</td><td>→ 项目拉通</td></tr><tr><td>中控整体卡死</td><td>Android FW</td><td>→ BSP → 项目拉通</td></tr><tr><td>单应用卡死</td><td>对应应用</td><td>→ 项目拉通</td></tr><tr><td>仪表卡死</td><td>仪表HMI/中间件</td><td>→ BSP → 项目拉通</td></tr><tr><td>整体卡顿</td><td>性能团队</td><td>→ 项目拉通</td></tr><tr><td>单应用卡顿</td><td>对应应用</td><td>→ 项目拉通</td></tr><tr><td>全系统重启</td><td>MCU</td><td>→ QNX中间件 → BSP → 项目拉通</td></tr><tr><td>仅中控重启</td><td>Android FW</td><td>→ BSP → 项目拉通</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-34">问题报告规范</h2>
<p>为了让问题能够快速被分析，测试同学在提交黑卡死问题时，请包含以下信息：</p>
<h3 data-id="heading-35">必填信息</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 问题描述</span>
<span class="hljs-bullet">-</span> 现象：[黑屏/卡死/闪屏/重启]
<span class="hljs-bullet">-</span> 影响范围：[中控/仪表/全部]
<span class="hljs-bullet">-</span> 持续时间：[持续/间歇/已恢复]
<span class="hljs-bullet">-</span> 复现频率：[必现/高概率/偶发]

<span class="hljs-section">## 环境信息</span>
<span class="hljs-bullet">-</span> 车型项目：
<span class="hljs-bullet">-</span> 软件版本：
<span class="hljs-bullet">-</span> 硬件版本：

<span class="hljs-section">## 操作步骤</span>
<span class="hljs-bullet">1.</span> xxx
<span class="hljs-bullet">2.</span> xxx
<span class="hljs-bullet">3.</span> 问题出现

<span class="hljs-section">## 日志附件</span>
<span class="hljs-bullet">-</span> [ ] MCU 日志
<span class="hljs-bullet">-</span> [ ] QNX 日志
<span class="hljs-bullet">-</span> [ ] Android logcat
<span class="hljs-bullet">-</span> [ ] kernel log
<span class="hljs-bullet">-</span> [ ] ANR traces（如有）
<span class="hljs-bullet">-</span> [ ] tombstone（如有）
</code></pre>
<h3 data-id="heading-36">日志采集脚本示例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># collect_blackscreen_logs.sh</span>
<span class="hljs-comment"># 黑卡死问题日志采集脚本</span>

TIMESTAMP=$(<span class="hljs-built_in">date</span> +%Y%m%d_%H%M%S)
LOG_DIR=<span class="hljs-string">"blackscreen_logs_<span class="hljs-variable">${TIMESTAMP}</span>"</span>

<span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">${LOG_DIR}</span>

<span class="hljs-comment"># Android 日志</span>
adb logcat -d &gt; <span class="hljs-variable">${LOG_DIR}</span>/logcat.txt
adb shell dmesg &gt; <span class="hljs-variable">${LOG_DIR}</span>/dmesg.txt
adb bugreport &gt; <span class="hljs-variable">${LOG_DIR}</span>/bugreport.zip

<span class="hljs-comment"># ANR 和 tombstone</span>
adb pull /data/anr/ <span class="hljs-variable">${LOG_DIR}</span>/anr/
adb pull /data/tombstones/ <span class="hljs-variable">${LOG_DIR}</span>/tombstones/

<span class="hljs-comment"># 系统状态</span>
adb shell dumpsys meminfo &gt; <span class="hljs-variable">${LOG_DIR}</span>/meminfo.txt
adb shell dumpsys cpuinfo &gt; <span class="hljs-variable">${LOG_DIR}</span>/cpuinfo.txt
adb shell dumpsys SurfaceFlinger &gt; <span class="hljs-variable">${LOG_DIR}</span>/surfaceflinger.txt
adb shell dumpsys input &gt; <span class="hljs-variable">${LOG_DIR}</span>/input.txt

<span class="hljs-comment"># pstore (重启后)</span>
adb shell <span class="hljs-built_in">cat</span> /sys/fs/pstore/console-ramoops-0 &gt; <span class="hljs-variable">${LOG_DIR}</span>/pstore.txt 2&gt;/dev/null

<span class="hljs-built_in">echo</span> <span class="hljs-string">"日志已采集到 <span class="hljs-variable">${LOG_DIR}</span> 目录"</span>
</code></pre>
<hr/>
<h2 data-id="heading-37">常见问题 FAQ</h2>
<h3 data-id="heading-38">Q1: 问题被分配后，分析方认为不是自己的问题怎么办？</h3>
<p><strong>A</strong>: 首要分析方有责任给出<strong>明确的分析结论</strong>，说明：</p>
<ul>
<li>自己负责的模块状态是否正常</li>
<li>提供支撑结论的日志证据</li>
<li>建议下一步由谁分析</li>
</ul>
<p>不能简单回复"不是我的问题"就转走。</p>
<h3 data-id="heading-39">Q2: 问题复现不了怎么办？</h3>
<p><strong>A</strong>:</p>
<ol>
<li>增加日志级别，部署监控脚本</li>
<li>与测试沟通具体操作场景</li>
<li>尝试压力测试复现</li>
<li>分析历史日志，寻找规律</li>
</ol>
<h3 data-id="heading-40">Q3: 多个团队的结论相互矛盾怎么办？</h3>
<p><strong>A</strong>: 由<strong>软件架构</strong>或<strong>项目技术负责人</strong>组织联合排查会议，各方带着日志和证据一起分析。</p>
<hr/>
<h2 data-id="heading-41">总结</h2>
<p>黑卡死问题的高效解决，依赖于：</p>
<ol>
<li><strong>清晰的分类标准</strong> —— 知道问题属于哪一类</li>
<li><strong>明确的分配原则</strong> —— 知道先找谁分析</li>
<li><strong>规范的流转机制</strong> —— 知道分析不出来找谁</li>
<li><strong>完善的日志采集</strong> —— 有足够的信息支撑分析</li>
</ol>
<p>希望本文能够帮助各项目团队在面对黑卡死问题时，不再"踢皮球"，而是快速、精准地定位和解决问题。</p>
<blockquote>
<p>记住：没有解决不了的 bug，只有找不到的 root cause。而找到 root cause 的前提，是先找对分析它的人。</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LogWhisperer 全解析：打造你的Linux服务器AI日志分析中枢]]></title>    <link>https://juejin.cn/post/7583507286317793280</link>    <guid>https://juejin.cn/post/7583507286317793280</guid>    <pubDate>2025-12-15T02:08:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583507286317793280" data-draft-id="7579095566900281384" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LogWhisperer 全解析：打造你的Linux服务器AI日志分析中枢"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-15T02:08:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YL_jia"/> <meta itemprop="url" content="https://juejin.cn/user/1467226241383211"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LogWhisperer 全解析：打造你的Linux服务器AI日志分析中枢
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1467226241383211/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YL_jia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T02:08:51.000Z" title="Mon Dec 15 2025 02:08:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>海量日志数据涌入，系统突然异常，你是否也曾像老王一样，在清晨被连续的告警短信惊醒，然后陷入手忙脚乱的日志海洋？ 在AI时代，LogWhisperer试图给出一个优雅的答案。</p>
</blockquote>
<h2 data-id="heading-0">前言：告别日志苦海</h2>
<p>深夜，你正沉浸在甜美的梦乡，手机突然“叮叮叮”响个不停。屏幕上显示着令人心惊肉跳的消息：“【重要告警】数据库连接超时，请联系管理员”。你不得不以最快的速度从被窝里爬出来，坐在电脑前，试图从成千上万行日志中找到问题的根源。</p>
<p>运维工程师们对这样的场景再熟悉不过了。在当今数据爆炸的时代，我们面对的是每日以惊人速度增长的日志数据海啸。传统基于命令行<code>grep</code>、<code>tail</code>或<code>cat</code>的日志分析方法，已无法满足现代分布式系统和微服务架构的监控需求。尤其是当系统发生故障时，日志信息如潮水般涌来，仿佛在嘲笑着人类处理能力的极限。</p>
<p>这时，AI为日志分析带来了新的可能。通过AI技术，原本需要人类花费数小时甚至数天分析的数万条日志，可以在几秒钟内完成分析，找出其中的规律和异常，<strong>实现从被动响应到主动预警的转变</strong>。</p>
<p>在这样的背景下，LogWhisperer应运而生。LogWhisperer是一款专为Linux服务器设计的<strong>自托管AI日志分析工具</strong>，致力于将复杂的日志处理转变为智能、高效的分析过程。本文将为你详细解析这一工具的特点、部署方式和使用方法，并探讨其在企业实战中的应用场景。</p>
<h2 data-id="heading-1">LogWhisperer：功能特点解析</h2>
<h3 data-id="heading-2">1. 工具定义与定位</h3>
<p>LogWhisperer是一个专门针对Linux环境的自托管日志处理工具。其核心定位是帮助开发者和系统管理员<strong>高效地管理和分析日志文件</strong>。与传统的日志工具不同，LogWhisperer在设计之初就考虑到现代AI技术的整合，旨在将复杂的日志分析过程智能化、自动化。</p>
<h3 data-id="heading-3">2. 已知核心功能</h3>
<p>由于公开信息有限，通过项目实践文档，我们可以了解到LogWhisperer至少包含以下基本日志处理能力：</p>
<ol>
<li>
<p><strong>灵活的日志过滤</strong>：能够根据用户指定的关键词或条件，快速过滤出海量日志中的关键条目，简化问题定位过程。</p>
</li>
<li>
<p><strong>智能日志聚合</strong>：支持按照特定维度对日志进行分组和聚合，例如按照日志级别、时间范围或来源系统进行分类统计。</p>
</li>
<li>
<p><strong>可定制的输出格式</strong>：允许用户根据需求定制日志输出的格式，提高日志的可读性和可分析性。</p>
</li>
<li>
<p><strong>多日志格式支持</strong>：具备高度可扩展性，能够处理多种不同的日志格式，满足异构系统的需求。</p>
</li>
</ol>
<h3 data-id="heading-4">3. 预期的AI增强功能</h3>
<p>AI时代，日志分析工具需要超越传统的关键词搜索和模式匹配。我们可以从AI日志分析的通用方法论中，推演LogWhisperer可能具备或应该具备的智能功能：</p>








































<table><thead><tr><th>功能模块</th><th>传统日志工具</th><th>AI增强的LogWhisperer（预期）</th></tr></thead><tbody><tr><td>数据处理</td><td>基本格式解析</td><td>自动将非结构化日志转换为结构化数据</td></tr><tr><td>异常检测</td><td>基于规则匹配</td><td>使用孤立森林或LOF算法识别异常模式</td></tr><tr><td>问题定位</td><td>人工回溯分析</td><td>自动进行<strong>根因分析</strong>，快速定位问题源头</td></tr><tr><td>趋势预测</td><td>历史数据统计</td><td>通过时间序列分析预测系统未来状态</td></tr><tr><td>处理效率</td><td>受限于人力速度</td><td>在几秒钟内分析完数万条日志</td></tr><tr><td>告警方式</td><td>基于阈值触发</td><td><strong>智能预警</strong>，在问题发生前识别风险模式</td></tr></tbody></table>
<h3 data-id="heading-5">4. 生态兼容性</h3>
<p>作为一个成熟的日志处理工具，LogWhisperer能够与现有的日志生态系统良好集成：</p>
<ul>
<li><strong>Winston</strong>：一个流行的Node.js日志库，可以与LogWhisperer集成，提供更多自定义日志处理功能。</li>
<li><strong>Bunyan</strong>：另一个日志库，支持将日志记录到多种输出，也可以与LogWhisperer集成。</li>
<li><strong>PM2</strong>：Node.js进程管理器，可以与LogWhisperer配合使用，以更好地管理和监控Node.js应用程序的日志。</li>
</ul>
<p>通过这些生态系统的整合，用户可以为应用程序构建<strong>一个强大的日志处理和监控系统</strong>。</p>
<h2 data-id="heading-6">安装部署：快速上手指南</h2>
<p>虽然公开资料没有提供LogWhisperer完整的官方安装指南，但我们可以从项目快速启动教程中了解其基础部署流程。</p>
<h3 data-id="heading-7">1. 环境准备</h3>
<p>在开始安装LogWhisperer之前，请确保您的Linux服务器满足以下条件：</p>
<ul>
<li><strong>Node.js环境</strong>：LogWhisperer需要Node.js运行环境。</li>
<li><strong>足够的存储空间</strong>：根据日志量的大小，确保有足够的磁盘空间存储日志数据和索引。</li>
<li><strong>网络访问</strong>：如果需要从多台服务器收集日志，确保网络配置允许相应的数据传输。</li>
</ul>
<h3 data-id="heading-8">2. 基础部署步骤</h3>
<p>以下是LogWhisperer项目文档中提到的基础部署步骤：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆项目到本地</span>
git <span class="hljs-built_in">clone</span> https://github.com/binary-knight/logwhisperer.git

<span class="hljs-comment"># 2. 进入项目目录</span>
<span class="hljs-built_in">cd</span> logwhisperer

<span class="hljs-comment"># 3. 安装项目依赖</span>
npm install

<span class="hljs-comment"># 4. 运行示例配置</span>
node example.js
</code></pre>
<p>运行上述命令后，LogWhisperer将开始监听配置文件中指定的日志文件，并将处理结果输出到控制台。</p>
<h3 data-id="heading-9">3. 容器化部署（预期）</h3>
<p>现代工具通常支持容器化部署，我们可以合理预期LogWhisperer也可能提供Docker部署方案：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 基于官方镜像的简单部署
docker run -d \
  --name logwhisperer \
  -p 3000:3000 \
  -v /path/to/logs:/app/logs \
  -v /path/to/config:/app/config \
  logwhisperer:latest
</code></pre>
<h3 data-id="heading-10">4. 配置文件详解</h3>
<p>一个典型的LogWhisperer配置文件可能包含以下关键部分：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 配置文件示例 config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// 日志源配置</span>
  <span class="hljs-attr">logSources</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'file'</span>,
      <span class="hljs-attr">path</span>: <span class="hljs-string">'/var/log/application.log'</span>,
      <span class="hljs-attr">format</span>: <span class="hljs-string">'json'</span> <span class="hljs-comment">// 支持 json, syslog, common 等格式</span>
    }
  ],
  
  <span class="hljs-comment">// AI分析配置</span>
  <span class="hljs-attr">aiAnalysis</span>: {
    <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">model</span>: <span class="hljs-string">'bert'</span>, <span class="hljs-comment">// 或本地模型路径</span>
    <span class="hljs-attr">anomalyDetection</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rootCauseAnalysis</span>: <span class="hljs-literal">true</span>
  },
  
  <span class="hljs-comment">// 告警配置</span>
  <span class="hljs-attr">alerts</span>: {
    <span class="hljs-attr">email</span>: <span class="hljs-string">'admin@example.com'</span>,
    <span class="hljs-attr">webhook</span>: <span class="hljs-string">'https://your-webhook-url.com/alert'</span>
  }
};
</code></pre>
<h2 data-id="heading-11">使用方法：从基础到高级</h2>
<h3 data-id="heading-12">1. 基础日志处理</h3>
<p>即使没有AI功能，LogWhisperer也提供了一套完整的日志处理API。以下是一些基础的使用示例：</p>
<p><strong>日志过滤</strong>：快速定位包含特定关键词的日志条目</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">LogWhisperer</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'logwhisperer'</span>);
<span class="hljs-keyword">const</span> lw = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogWhisperer</span>();

lw
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> entry.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'特定关键词'</span>))
  .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(entry));
</code></pre>
<p><strong>日志聚合</strong>：按日志级别分组统计</p>
<pre><code class="hljs language-javascript" lang="javascript">lw
  .<span class="hljs-title function_">aggregate</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> entry.<span class="hljs-property">level</span>)
  .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">level, entries</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Level: <span class="hljs-subst">${level}</span>`</span>);
    entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(entry));
  });
</code></pre>
<p><strong>定制化输出</strong>：格式化日志以便于阅读和分析</p>
<pre><code class="hljs language-javascript" lang="javascript">lw
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> <span class="hljs-string">`时间：<span class="hljs-subst">${entry.time}</span>, 级别：<span class="hljs-subst">${entry.level}</span>, 消息：<span class="hljs-subst">${entry.message}</span>`</span>)
  .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(entry));
</code></pre>
<h3 data-id="heading-13">2. AI功能使用场景</h3>
<p>当AI功能启用时，LogWhisperer的工作流将变得更加智能化。下面展示了AI处理日志的完整流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[原始日志数据] --&gt; B[数据收集与预处理]
    B --&gt; C{日志类型判断}
    C --&gt;|结构化| D[直接解析]
    C --&gt;|非结构化| E[AI转换&lt;br&gt;为结构化数据]
    
    D --&gt; F[特征提取与模式识别]
    E --&gt; F
    
    F --&gt; G[异常检测与预测]
    G --&gt; H{是否异常?}
    H --&gt;|是| I[根因分析与警报]
    H --&gt;|否| J[正常模式学习]
    
    I --&gt; K[自动化响应&lt;br&gt;或人工处理]
    J --&gt; L[模型优化与更新]
    
    K --&gt; M[可视化展示与报告]
    L --&gt; M
</code></pre>
<p>以下是AI功能的具体应用示例：</p>
<p><strong>自动日志分类</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 自动将非结构化日志分类为不同的事件类型</span>
<span class="hljs-keyword">const</span> categorizedLogs = <span class="hljs-keyword">await</span> lw.<span class="hljs-property">ai</span>.<span class="hljs-title function_">classifyLogs</span>(rawLogs);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(categorizedLogs);
<span class="hljs-comment">// 输出: { "auth_events": [...], "db_errors": [...], "performance_issues": [...] }</span>
</code></pre>
<p><strong>异常检测</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 自动检测日志中的异常模式</span>
<span class="hljs-keyword">const</span> anomalies = <span class="hljs-keyword">await</span> lw.<span class="hljs-property">ai</span>.<span class="hljs-title function_">detectAnomalies</span>(logEntries);
anomalies.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">anomaly</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`异常检测: <span class="hljs-subst">${anomaly.type}</span> 在 <span class="hljs-subst">${anomaly.timestamp}</span>`</span>);
});
</code></pre>
<p><strong>根因分析</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 当发生故障时，自动分析根本原因</span>
<span class="hljs-keyword">const</span> rootCause = <span class="hljs-keyword">await</span> lw.<span class="hljs-property">ai</span>.<span class="hljs-title function_">analyzeRootCause</span>(incidentLogs);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`可能的原因: <span class="hljs-subst">${rootCause.cause}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`置信度: <span class="hljs-subst">${rootCause.confidence}</span>%`</span>);
</code></pre>
<h3 data-id="heading-14">3. 进阶：与其他工具集成</h3>
<p>LogWhisperer可以与其他监控和可视化工具集成，形成完整的可观测性栈：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 与Grafana集成示例</span>
<span class="hljs-keyword">const</span> grafana = <span class="hljs-built_in">require</span>(<span class="hljs-string">'grafana-api'</span>);
<span class="hljs-keyword">const</span> lw = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogWhisperer</span>();

<span class="hljs-comment">// 将分析结果发送到Grafana仪表板</span>
lw.<span class="hljs-title function_">on</span>(<span class="hljs-string">'analysisComplete'</span>, <span class="hljs-keyword">async</span> (results) =&gt; {
  <span class="hljs-keyword">await</span> grafana.<span class="hljs-title function_">pushMetrics</span>({
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
    <span class="hljs-attr">metrics</span>: results.<span class="hljs-property">summary</span>
  });
});

<span class="hljs-comment">// 与告警系统集成</span>
lw.<span class="hljs-title function_">on</span>(<span class="hljs-string">'alert'</span>, <span class="hljs-keyword">async</span> (alert) =&gt; {
  <span class="hljs-comment">// 发送到企业微信、钉钉或Slack</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendAlertToTeams</span>(alert);
});
</code></pre>
<h2 data-id="heading-15">企业实战案例：从概念到落地</h2>
<h3 data-id="heading-16">1. 案例背景：重工企业的智能运维转型</h3>
<p>某重工企业拥有200余台核心设备，包括冲压机、数控机床等，面临着严峻的运维挑战：</p>
<ul>
<li><strong>数据杂乱</strong>：近3年积累的5000+条故障运维日志分散存储在Excel表格、纸质记录和个人文档中。</li>
<li><strong>描述模糊</strong>：40%的日志存在描述模糊问题，如“液压系统故障”被记录为“液压异响”、“压力不稳”或“油缸动作迟缓”等多种表述。</li>
<li><strong>时效紧迫</strong>：企业要求设备触发故障报警后，必须在10分钟内定位根源，而人工排查平均耗时45分钟。</li>
<li><strong>误判率高</strong>：当前人工判断的故障误判率高达15%，曾因误判“主轴轴承故障”盲目更换核心配件，造成20万元的经济损失。</li>
</ul>
<p>在这样的背景下，该企业需要一套能够自动解析日志、精准识别故障、快速定位根源的智能运维工具。</p>
<h3 data-id="heading-17">2. 解决方案：LogWhisperer在工业环境中的应用</h3>
<p>尽管LogWhisperer可能并非案例中实际使用的工具，但我们可以基于其设计理念，构想如何将其应用于类似工业场景：</p>
<p><strong>第一阶段：日志标准化与结构化</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用LogWhisperer处理非标准化工业日志</span>
<span class="hljs-keyword">const</span> industrialLogs = <span class="hljs-keyword">await</span> lw.<span class="hljs-title function_">processIndustrialLogs</span>(rawData, {
  <span class="hljs-attr">standardizeTerms</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 自动标准化术语</span>
  <span class="hljs-attr">fillMissingData</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 填补缺失参数</span>
  <span class="hljs-attr">removeNoise</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 过滤无效信息</span>
});

<span class="hljs-comment">// 标准化前后的对比</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`结构化率从35%提升至: <span class="hljs-subst">${industrialLogs.structuredRate}</span>%`</span>);
</code></pre>
<p><strong>第二阶段：故障模式识别</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 训练设备故障识别模型</span>
<span class="hljs-keyword">const</span> faultModel = <span class="hljs-keyword">await</span> lw.<span class="hljs-property">ai</span>.<span class="hljs-title function_">trainFaultModel</span>({
  <span class="hljs-attr">logs</span>: industrialLogs.<span class="hljs-property">structured</span>,
  <span class="hljs-attr">faultTypes</span>: [<span class="hljs-string">'液压泵磨损'</span>, <span class="hljs-string">'密封圈泄漏'</span>, <span class="hljs-string">'冷却系统故障'</span>],
  <span class="hljs-attr">keyParams</span>: [<span class="hljs-string">'振动频率'</span>, <span class="hljs-string">'油温'</span>, <span class="hljs-string">'液压压力'</span>]
});

<span class="hljs-comment">// 使用模型进行故障诊断</span>
<span class="hljs-keyword">const</span> diagnosis = <span class="hljs-keyword">await</span> lw.<span class="hljs-property">ai</span>.<span class="hljs-title function_">diagnoseFault</span>(currentLogs, faultModel);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`故障类型: <span class="hljs-subst">${diagnosis.type}</span>, 置信度: <span class="hljs-subst">${diagnosis.confidence}</span>%`</span>);
</code></pre>
<p><strong>第三阶段：故障链路回溯与根因分析</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 当发生故障时，自动回溯完整链路</span>
<span class="hljs-keyword">const</span> incidentChain = <span class="hljs-keyword">await</span> lw.<span class="hljs-property">ai</span>.<span class="hljs-title function_">traceIncidentChain</span>(alertTime, {
  <span class="hljs-attr">lookbackMinutes</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">identifyRootCause</span>: <span class="hljs-literal">true</span>
});

<span class="hljs-comment">// 输出故障传播路径</span>
incidentChain.<span class="hljs-property">events</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${event.time}</span>: <span class="hljs-subst">${event.parameter}</span> <span class="hljs-subst">${event.change}</span>`</span>);
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`根本原因: <span class="hljs-subst">${incidentChain.rootCause}</span>`</span>);
</code></pre>
<h3 data-id="heading-18">3. 实施效果与量化收益</h3>
<p>通过应用类LogWhisperer的AI日志分析工具，企业可以获得以下收益：</p>
<ol>
<li>
<p><strong>效率大幅提升</strong>：故障定位时间从45分钟缩短至10分钟内，符合业务硬性指标要求。</p>
</li>
<li>
<p><strong>准确率显著提高</strong>：故障识别准确率从初步的82%提升至90%以上，大幅降低误判率。</p>
</li>
<li>
<p><strong>预防性维护能力</strong>：通过分析参数变化趋势，能够在故障发生前识别潜在风险，使23%的故障在萌芽阶段就被解决。</p>
</li>
<li>
<p><strong>维护成本降低</strong>：通过故障特征重要性分析，避免盲目加装传感器，为企业节省了近15万元的改造成本。</p>
</li>
<li>
<p><strong>知识沉淀与传承</strong>：将运维经验转化为可复用的AI模型，减少对特定专家的依赖。</p>
</li>
</ol>
<h2 data-id="heading-19">总结与展望：AI驱动运维新时代</h2>
<p>LogWhisperer代表了日志分析工具从传统的关键词搜索向AI智能分析演进的方向。尽管目前公开信息有限，但我们可以清晰地看到这类工具的核心价值：<strong>将运维人员从繁琐的日志海洋中解放出来，专注于更有创造性的工作</strong>。</p>
<h3 data-id="heading-20">1. 核心优势总结</h3>
<ul>
<li><strong>智能化程度高</strong>：通过AI技术自动识别异常、分析根因、预测风险。</li>
<li><strong>处理效率惊人</strong>：数万条日志的分析时间从数小时缩短至几秒钟。</li>
<li><strong>学习能力强</strong>：能够持续从新的日志数据中学习，不断优化分析模型。</li>
<li><strong>自托管安全可控</strong>：所有数据和模型都运行在企业内部，保障数据安全和隐私。</li>
<li><strong>开源可扩展</strong>：基于开源技术栈，可以根据企业特定需求进行定制和扩展。</li>
</ul>
<h3 data-id="heading-21">2. 使用建议</h3>
<p>对于考虑部署LogWhisperer或类似工具的企业，我们建议：</p>
<ol>
<li>
<p><strong>从小规模试点开始</strong>：选择1-2个关键系统作为试点，验证工具效果后再逐步推广。</p>
</li>
<li>
<p><strong>重视数据质量</strong>：AI工具的效果很大程度上取决于输入数据的质量，确保日志格式相对规范。</p>
</li>
<li>
<p><strong>培养复合型人才</strong>：需要既懂运维又理解AI原理的团队来有效使用和优化工具。</p>
</li>
<li>
<p><strong>制定明确的评估指标</strong>：明确衡量工具效果的指标，如MTTR（平均恢复时间）降低比例、告警准确率等。</p>
</li>
</ol>
<h3 data-id="heading-22">3. 未来展望</h3>
<p>随着AI技术的不断发展，LogWhisperer这类工具的潜力将进一步释放：</p>
<ul>
<li><strong>多模态分析</strong>：不仅分析文本日志，还能结合指标数据、追踪数据，提供更全面的系统洞察。</li>
<li><strong>自然语言交互</strong>：运维人员可以直接用自然语言提问，如“昨晚数据库为什么变慢？”，系统自动分析相关日志并给出答案。</li>
<li><strong>自动化修复</strong>：从分析问题到自动执行修复动作，实现真正的自治运维。</li>
<li><strong>跨系统关联分析</strong>：在复杂的微服务架构中，自动追踪一个请求在各个服务中的流转路径，快速定位瓶颈所在。</li>
</ul>
<p>在日益复杂的IT系统面前，传统的日志分析方法已显疲态。AI驱动的日志分析工具如LogWhisperer，正开启智能运维的新篇章。它们不仅仅是工具，更是<strong>运维团队的AI协作者</strong>，将人类从重复性劳动中解放出来，共同构建更加稳定、高效的数字系统。</p>
<blockquote>
<p>提示：本文内容基于有限的公开资料，如需获取LogWhisperer的详细信息，建议直接访问其官方GitHub仓库或相关文档。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[没 CDN = 用户等半天？四大核心机制：就近、分流、提速、容错全搞定]]></title>    <link>https://juejin.cn/post/7583577045579776026</link>    <guid>https://juejin.cn/post/7583577045579776026</guid>    <pubDate>2025-12-15T02:14:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583577045579776026" data-draft-id="7583576612392009738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="没 CDN = 用户等半天？四大核心机制：就近、分流、提速、容错全搞定"/> <meta itemprop="keywords" content="前端,性能优化"/> <meta itemprop="datePublished" content="2025-12-15T02:14:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PineappleCoder"/> <meta itemprop="url" content="https://juejin.cn/user/3323167184272627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            没 CDN = 用户等半天？四大核心机制：就近、分流、提速、容错全搞定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3323167184272627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PineappleCoder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T02:14:43.000Z" title="Mon Dec 15 2025 02:14:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 性能优化的“任意门”：CDN 如何实现全球加速，让用户“瞬间移动”到你的网站？</h2>
<blockquote>
<p><strong>前端性能优化专栏 - 第六篇</strong></p>
</blockquote>
<p>在上一篇中，我们探讨了 <strong>HTTP 缓存机制</strong>，它解决了用户“二次访问”的速度问题。但对于全球用户来说，“首次访问”的速度依然是一个挑战，因为网络延迟与<strong>物理距离</strong>成正比。</p>
<p>想象一下，你的网站服务器在北京，一个远在伦敦的用户访问你的网站，数据需要跨越欧亚大陆。这个漫长的旅程，就是延迟的根源。</p>
<p>今天，我们将揭秘一个真正能让你的网站实现“瞬间移动”的秘密武器——<strong>内容分发网络（CDN，Content Delivery Network）</strong> 。</p>
<hr/>
<h3 data-id="heading-1">💡 CDN 是什么？内容仓库的“分店”模式</h3>
<p><strong>CDN</strong> 是由分布在全球各地的高性能服务器节点组成的网络。它的核心作用是<strong>将网站内容更靠近用户</strong>，以实现更快的访问体验。</p>
<p>你可以把 CDN 理解为一个拥有全球“分店”的内容仓库体系：</p>
<ul>
<li><strong>源站（Origin）：</strong> 存储网站的原始内容（总部）。</li>
<li><strong>CDN 节点（Edge Node）：</strong> 分布在全球各地的“分店”，负责缓存和分发内容。</li>
<li><strong>智能调度系统：</strong> 负责指挥用户去最近的“分店”取货。</li>
</ul>
<h4 data-id="heading-2">核心理念：就近响应</h4>
<p>CDN 的核心理念就是<strong>内容仓库的“分店”模式</strong>，通过三个步骤实现就近响应：</p>
<ol>
<li><strong>缓存内容：</strong> 提前在各地节点存储静态资源。</li>
<li><strong>智能调度：</strong> 通过智能 DNS 分配最佳节点。</li>
<li><strong>就近响应：</strong> 从最近节点直接返回内容，大幅缩短传输距离。</li>
</ol>
<p><strong>专业名词解释：智能 DNS</strong>  是 CDN 实现就近访问的关键技术。它能根据用户的地理位置、网络运营商、以及 CDN 节点的负载情况，动态地将用户的请求解析到最优的 CDN 边缘节点 IP 地址。</p>
<p>下方图片展示了 CDN 的核心理念： <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f40e2fe0566a48f0b6b93e6b2bcd012d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGluZWFwcGxlQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766369683&amp;x-signature=PPBVLxmlj%2BE8BBIp1mimPz3TAYQ%3D" alt="img" loading="lazy"/></p>
<h3 data-id="heading-3">🚀 CDN 提升性能的四大核心机制</h3>
<p>CDN 不仅仅是简单的缓存，它通过四大机制全方位提升网站性能和稳定性：</p>
<h4 data-id="heading-4">🌐1.  就近访问 — 降低网络延迟</h4>
<p>这是 CDN 最直观的优势。<strong>网络延迟与物理距离成正比。</strong></p>
<p>CDN 通过在全球部署大量的<strong>边缘节点</strong>，让用户“就近取数据”，从而：</p>
<ul>
<li><strong>减少物理距离带来的延迟：</strong> 用户的请求不再需要绕远路到达遥远的源站。</li>
<li><strong>消除重复的网络握手：</strong> 边缘节点与用户之间的连接速度更快，且通常已经建立了连接。</li>
</ul>
<p>下方图片进一步说明了就近访问的优势： <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5512ae8de03491d91073f9cf0800081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGluZWFwcGxlQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766369683&amp;x-signature=2BhTXyDzLQ8UIk6XgBnK5Wlv9w8%3D" alt="img" loading="lazy"/></p>
<p>下方示意图也清晰地展示了全球分发和就近响应的流程： <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b4194533b7845f193ec4d94e5f855f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGluZWFwcGxlQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766369683&amp;x-signature=14LVzior%2B3a7nDvYCQVsRoj8rA8%3D" alt="CDN 全球分发示意图" loading="lazy"/></p>
<h4 data-id="heading-5">🛡️2.  减轻源站压力 — 分担流量与请求</h4>
<p>CDN 承担了绝大部分静态资源（图片、脚本、CSS）的分发工作，这极大地<strong>减轻了源站的压力</strong>，让源站可以专注于核心业务。</p>
<ul>
<li><strong>分流：</strong> 静态资源（通常占网站流量的 80% 以上）由 CDN 处理。</li>
<li><strong>专注：</strong> 源站只需应对动态业务（登录、查询、支付等）。</li>
<li><strong>稳定：</strong> 避免因并发量过高导致源站服务器崩溃，保障高峰期访问稳定性。</li>
<li><strong>效率：</strong> 提高整体吞吐量与服务效率。</li>
</ul>
<p>我们生成的对比图形象地展示了 CDN 的负载均衡能力： <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8af8b2cd4aa74dd6a5568e810ec62cd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGluZWFwcGxlQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766369683&amp;x-signature=VRoYOy5%2BmVCNGA2Nx5IW3T3OMBs%3D" alt="源站过载与 CDN 负载均衡对比图" loading="lazy"/></p>
<h4 data-id="heading-6">⚡3.  优化资源调度 — 提升带宽与并发性能</h4>
<p>CDN 服务商通常拥有<strong>更高质量</strong>的网络基础设施，这为性能优化提供了坚实的基础：</p>
<ul>
<li><strong>海量带宽储备：</strong> 支持突发流量，应对大促或热点事件。</li>
<li><strong>动态负载均衡：</strong> 实时分配请求到负载最低、响应最快的节点。</li>
<li><strong>多协议优化：</strong> 支持 HTTP/2、QUIC 等先进协议，提升传输效率。</li>
</ul>
<p>💡 <strong>结论：</strong> CDN 提供了<strong>连接少、带宽大、资源调度智能</strong>的网络环境，页面加载自然更快。</p>
<h4 data-id="heading-7">🔄4.  提升可用性 — 负载均衡与自动容错</h4>
<p>CDN 内置的<strong>负载均衡</strong>与<strong>自动容错机制</strong>是网站高可用的重要保障，让网站“永不宕机”：</p>
<ul>
<li><strong>负载均衡：</strong> 实时分配最优节点，确保用户体验。</li>
<li><strong>自动容错：</strong> 边缘节点异常时，请求会自动切换到健康的节点。</li>
<li><strong>全局冗余：</strong> 保证服务连续性，即使部分节点宕机，服务也不会中断。</li>
</ul>
<p>下方图片展示了 CDN 的高可用性： <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5058559e0b34cb484a1853676dbf9a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGluZWFwcGxlQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766369683&amp;x-signature=cWKo1aTXKbSF6w2Xh8mnjK8pnGk%3D" alt="img" loading="lazy"/></p>
<h3 data-id="heading-8">✅ 核心机制总结与最佳实践</h3>
<p>CDN 的核心价值可以概括为以下四点：</p>






























<table><thead><tr><th>机制</th><th>核心作用</th><th>性能提升点</th></tr></thead><tbody><tr><td><strong>地理就近</strong></td><td>减少物理距离</td><td>降低网络延迟（TTFB）</td></tr><tr><td><strong>流量分担</strong></td><td>静态资源分流</td><td>稳定源站，提高并发处理能力</td></tr><tr><td><strong>资源优化</strong></td><td>高质量网络</td><td>提升带宽利用率，支持先进协议</td></tr><tr><td><strong>智能调度</strong></td><td>负载均衡与容错</td><td>保证高可用性，避免单点故障</td></tr></tbody></table>
<p><strong>最佳实践：</strong></p>
<ul>
<li><strong>动静分离：</strong> 只有静态资源（图片、CSS、JS）才应该走 CDN。动态内容（API 接口）应由源站处理。</li>
<li><strong>合理设置缓存头：</strong> 结合上一篇的知识，在 CDN 上配置合理的 <code>Cache-Control</code>，确保资源在 CDN 节点和用户浏览器都能被高效缓存。</li>
</ul>
<hr/>
<p><strong>下一篇预告：</strong> 在所有的前端资源中，<strong>图片</strong>往往是体积最大、最影响加载性能的“罪魁祸首”。下一篇我们将聚焦于如何对图片进行精细化管理，探讨各种<strong>图片加载策略</strong>，让你的页面既高清又秒开！敬请期待！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在iOS上体验Open-AutoGLM：从安装到流畅操作的完整指南]]></title>    <link>https://juejin.cn/post/7582997593090736147</link>    <guid>https://juejin.cn/post/7582997593090736147</guid>    <pubDate>2025-12-14T12:18:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582997593090736147" data-draft-id="7582808491607244854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在iOS上体验Open-AutoGLM：从安装到流畅操作的完整指南"/> <meta itemprop="keywords" content="iOS,人工智能,Agent"/> <meta itemprop="datePublished" content="2025-12-14T12:18:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="图图大恼"/> <meta itemprop="url" content="https://juejin.cn/user/1556564198302935"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在iOS上体验Open-AutoGLM：从安装到流畅操作的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564198302935/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    图图大恼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T12:18:02.000Z" title="Sun Dec 14 2025 12:18:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近我亲身体验了Open-AutoGLM在iOS设备上的表现，这个基于AI的iOS自动化工具给我留下了深刻印象。它能够理解自然语言指令，并自动操作手机完成各种任务。在这篇博客中，我将分享完整的安装过程、遇到的问题及解决方案，以及实际体验感受。</p>
<h2 data-id="heading-1">环境准备</h2>
<h3 data-id="heading-2">1. 创建Python虚拟环境</h3>
<p>首先需要准备一个干净的Python环境。我使用的是Anaconda：</p>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 激活conda环境</span>
. /opt/anaconda3/bin/activate &amp;&amp; conda activate /opt/anaconda3/envs/AutoGLM

<span class="hljs-comment"># 验证Python版本</span>
python --version  <span class="hljs-comment"># Python 3.12.8</span>
</code></pre>
<h3 data-id="heading-3">2. 克隆项目仓库</h3>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/zai-org/Open-AutoGLM.git
<span class="hljs-built_in">cd</span> Open-AutoGLM
</code></pre>
<h2 data-id="heading-4">安装过程</h2>
<h3 data-id="heading-5">步骤1：安装依赖包</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用conda环境中的pip安装requirements.txt中的依赖</span>
/opt/anaconda3/envs/AutoGLM/bin/pip install -r requirements.txt
</code></pre>
<p>安装过程顺利，主要依赖包括：</p>
<ul>
<li>Pillow&gt;=12.0.0（图像处理）</li>
<li>openai&gt;=2.9.0（OpenAI API客户端）</li>
<li>以及其他相关依赖</li>
</ul>
<h3 data-id="heading-6">步骤2：安装Open-AutoGLM包</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 以可编辑模式安装</span>
/opt/anaconda3/envs/AutoGLM/bin/pip install -e .
</code></pre>
<h3 data-id="heading-7">步骤3：获取特定PR分支</h3>
<p>需要获取一个支持iOS PR<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzai-org%2FOpen-AutoGLM%2Fpull%2F143" target="_blank" title="https://github.com/zai-org/Open-AutoGLM/pull/143" ref="nofollow noopener noreferrer">143</a>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用git命令拉取PR分支</span>
git fetch origin pull/143/head:pr_143
git checkout pr_143
</code></pre>
<h3 data-id="heading-8">步骤4：安装iOS依赖工具</h3>
<p>Open-AutoGLM需要libimobiledevice来连接iOS设备：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装libimobiledevice</span>
brew install libimobiledevice
</code></pre>
<p><strong>遇到的问题</strong>：Homebrew ARM架构问题 (M1)</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Error</span>: <span class="hljs-title class_">Cannot</span> install under <span class="hljs-title class_">Rosetta</span> <span class="hljs-number">2</span> <span class="hljs-keyword">in</span> <span class="hljs-variable constant_">ARM</span> <span class="hljs-keyword">default</span> prefix (<span class="hljs-regexp">/opt/</span>homebrew)!
</code></pre>
<p><strong>解决方案</strong>：使用正确的架构命令</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">arch</span> -arm64 brew install libimobiledevice
</code></pre>
<h3 data-id="heading-9">步骤5：准备WebDriverAgent</h3>
<p>WebDriverAgent是iOS自动化测试的核心组件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆WebDriverAgent仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/appium/WebDriverAgent.git
<span class="hljs-built_in">cd</span> WebDriverAgent
</code></pre>
<h2 data-id="heading-10">运行与配置</h2>
<h4 data-id="heading-11">1.运行安装WebDirverAgent在手机上</h4>
<p>这里需要使用Xcode打开WebDriverAgent.xcodeproj项目工程,并使用个苹果帐号配置bundle id进行签名设置</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c037aab03cb64efc932142dfb5c04ea8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5Zu-5aSn5oG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319691&amp;x-signature=W6wOvYNwhN2bZzrzTXUSPd%2Fmcs8%3D" alt="截屏2025-12-14 09.34.55.png" loading="lazy"/></p>
<p>新开一个终端, 解锁手机, 运行WebDirverAgent</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /path/to/WebDriverAgent
xcodebuild -project WebDriverAgent.xcodeproj \
           -scheme WebDriverAgentRunner \
           -destination <span class="hljs-string">'platform=iOS,name=你的手机名称'</span> \
           <span class="hljs-built_in">test</span>
</code></pre>
<p>运行成功后,可以看到手机上安装了两个app: <code>IntegrationApp</code>、<code>WebDriverAgentRunner</code></p>
<p>期间需要确保手机处于解锁状态/输入密码解锁手机</p>
<p>成功后终端上会输出</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">WebDriverAgentRunner-Runner</span><span class="hljs-selector-attr">[2339:504073]</span> <span class="hljs-selector-tag">Built</span> <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">Dec</span> <span class="hljs-number">14</span> <span class="hljs-number">2025</span> <span class="hljs-number">09</span>:<span class="hljs-number">54</span>:<span class="hljs-number">57</span>
<span class="hljs-selector-tag">WebDriverAgentRunner-Runner</span><span class="hljs-selector-attr">[2339:504073]</span> <span class="hljs-selector-tag">ServerURLHere-</span>&gt;<span class="hljs-selector-tag">http</span>:<span class="hljs-comment">//192.168.31.47:8100&lt;-ServerURLHere</span>
</code></pre>
<h4 data-id="heading-12">2.确保iOS设备已连接并信任电脑：</h4>
<p>这里使用usb进行连接</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查设备连接</span>
idevice_id -l
<span class="hljs-comment"># 应该输出设备UDID，如：18513ab3335958d2cc31ec6f0934b37ab996ecd8</span>
</code></pre>
<p>另开一个终端,输入以下端口映射命令</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">iproxy</span> <span class="hljs-number">8100 </span><span class="hljs-number">8100</span>

</code></pre>
<h4 data-id="heading-13">3.首次运行尝试</h4>
<p>另起一个终端, 输入并运行以下ios.py命令, 这里总共需要有三个终端窗口同时存在,分别运行<code>iproxy</code>、<code>WebDirverAgent</code>和 <code>ios.py</code></p>
<p>这里使用的是官方提供的Agent接口.所以需要注册账号并获取api-key <a href="https://link.juejin.cn?target=https%3A%2F%2Fbigmodel.cn%2Fusercenter%2Fproj-mgmt%2Fapikeys" target="_blank" title="https://bigmodel.cn/usercenter/proj-mgmt/apikeys" ref="nofollow noopener noreferrer">BigModel</a>替换下面命令中的<code>your-api-key</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /path/to/Open-AutoGLM

/opt/anaconda3/envs/AutoGLM/bin/python ios.py \
    --base-url <span class="hljs-string">"https://open.bigmodel.cn/api/paas/v4"</span> \
    --model <span class="hljs-string">"autoglm-phone"</span> \
    --api-key <span class="hljs-string">"your-api-key"</span>
</code></pre>
<h4 data-id="heading-14">4.遇到的问题及解决方案</h4>
<p><strong>问题3</strong>：python库缺失</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">ImportError:</span> <span class="hljs-keyword">Using</span> SOCKS proxy, but the <span class="hljs-comment">'socksio' package is not installed.</span>
<span class="hljs-symbol">Error:</span> requests library <span class="hljs-built_in">not</span> found. Install it: pip install requests
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">/opt/anaconda3/envs/AutoGLM/bin/pip install socksio requests
</code></pre>
<h2 data-id="heading-15">实际体验</h2>
<h3 data-id="heading-16">成功运行</h3>
<p>当所有问题解决后，会看到以下提示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/511ed1eb7b4a42088ee8c9195ea5fddd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5Zu-5aSn5oG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319691&amp;x-signature=lASg0UBxL%2Ft9oV%2Fud8bSzFnFew8%3D" alt="截屏2025-12-14 19.14.30.png" loading="lazy"/></p>
<h3 data-id="heading-17">体验</h3>
<p>输入指令<code>在小红书中搜索麦克杰克逊</code>, 然后下面是agent思考过程与操作日志与WebDriverAgent的截屏日志</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f5fdc319ea34d15a12c5a657e08c809~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5Zu-5aSn5oG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319691&amp;x-signature=Ls2BZ11NUyd1eo71qjlQ6dhw5CM%3D" alt="截屏2025-12-14 19.29.36.png" loading="lazy"/></p>
<pre><code class="hljs language-sql" lang="sql">Enter your task:  在小红书中搜索麦克杰克逊

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

用户想要在小红书中搜索"麦克杰克逊"。当前在系统桌面。


我需要：

<span class="hljs-number">1.</span> 启动小红书应用

<span class="hljs-number">2.</span> 在小红书中找到搜索功能

<span class="hljs-number">3.</span> 输入"麦克杰克逊"进行搜索


首先，我需要启动小红书应用。从截图中可以看到小红书的图标在左上角。
让我使用Launch工具来启动小红书。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "action": "Launch",

  "app": "小红书",

  "_metadata": "do"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

好的，小红书已经打开了。我可以看到当前在个人主页的"笔记"标签页。我需要找到搜索功能。
在屏幕顶部右侧，我可以看到一个搜索图标（放大镜图标）。让我点击它来进入搜索界面。
搜索图标的位置大约在右上角，坐标大约是 (<span class="hljs-number">932</span>, <span class="hljs-number">153</span>)。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "action": "Tap",

  "element": [

    <span class="hljs-number">932</span>,

    <span class="hljs-number">153</span>

  ],

  "_metadata": "do"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
Physically tap <span class="hljs-keyword">on</span> (<span class="hljs-number">1097</span>, <span class="hljs-number">391</span>)
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

好的，搜索界面已经打开了。我可以看到一个搜索输入框，提示文字是"搜索我的笔记/收藏/赞过"。下方显示了一个键盘。

现在我需要：

<span class="hljs-number">1.</span> 点击搜索输入框

<span class="hljs-number">2.</span> 输入"麦克杰克逊"

<span class="hljs-number">3.</span> 点击搜索按钮

让我先点击搜索输入框，然后输入文字。搜索输入框的位置大约在 (<span class="hljs-number">448</span>, <span class="hljs-number">153</span>)。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "action": "Tap",

  "element": [

    <span class="hljs-number">448</span>,

    <span class="hljs-number">153</span>

  ],

  "_metadata": "do"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

Physically tap <span class="hljs-keyword">on</span> (<span class="hljs-number">527</span>, <span class="hljs-number">391</span>)
  
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

好的，搜索输入框已经被激活了，我可以看到光标在输入框中。现在我可以直接输入"麦克杰克逊"了。根据指南，Type操作会自动清除现有文本并输入新文本。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "action": "Type",

  "text": "麦克杰克逊",

  "_metadata": "do"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

太好了！我已经成功输入了"麦克杰克逊"。我可以看到搜索框中显示了"麦克杰克逊"这几个字。现在我需要点击右侧的"搜索"按钮来执行搜索。

搜索按钮在右下角，蓝色的按钮，位置大约在 (<span class="hljs-number">899</span>, <span class="hljs-number">847</span>)。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "action": "Tap",

  "element": [

    <span class="hljs-number">899</span>,

    <span class="hljs-number">847</span>

  ],

  "_metadata": "do"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

Physically tap <span class="hljs-keyword">on</span> (<span class="hljs-number">1059</span>, <span class="hljs-number">2164</span>)

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

好的，搜索已经执行了。现在显示的是搜索结果页面。页面显示：

<span class="hljs-operator">-</span> 顶部有搜索框，显示"麦克杰克逊"

<span class="hljs-operator">-</span> 有几个标签：笔记·<span class="hljs-number">0</span>、收藏·<span class="hljs-number">0</span>、赞过·<span class="hljs-number">0</span>、浏览记录·<span class="hljs-number">0</span>

<span class="hljs-operator">-</span> 当前在"笔记"标签下

<span class="hljs-operator">-</span> 中间显示"没找到我的笔记"

这表示在用户的笔记中搜索"麦克杰克逊"没有找到相关内容。但是用户要求的是在小红书中搜索，可能用户是想搜索整个小红书的内容，而不是限制在用户的笔记中。

让我看看是否需要切换到其他标签。我注意到有"浏览记录·0"的标签，可能还有其他选项。但通常在小红书中搜索某个人名，我应该看看是否有相关的内容。

让我尝试点击其他标签看看是否有结果。或者，用户可能想要搜索的是"麦克杰克逊"这个人，而不是"麦克杰克逊"这个词。让我试试看是否有其他选项。

实际上，看起来这个搜索功能是搜索"我的笔记/收藏/赞过"中的内容，而不是搜索整个小红书的内容。如果用户想要搜索整个小红书的内容，可能需要使用不同的搜索方式。

让我尝试返回首页，看看是否有全局搜索功能。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "action": "Tap",

  "element": [

    <span class="hljs-number">98</span>,

    <span class="hljs-number">932</span>

  ],

  "_metadata": "do"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

Physically tap <span class="hljs-keyword">on</span> (<span class="hljs-number">115</span>, <span class="hljs-number">2382</span>)

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

好的，我已经返回到小红书的首页了。我可以看到：

<span class="hljs-operator">-</span> 顶部有导航栏：关注、发现、深圳

<span class="hljs-operator">-</span> 右上角有搜索图标（放大镜）

<span class="hljs-operator">-</span> 底部有导航栏：首页、市集、<span class="hljs-operator">+</span>、消息、我

现在我需要点击右上角的搜索图标来进行全局搜索。搜索图标的位置大约在 (<span class="hljs-number">926</span>, <span class="hljs-number">93</span>)。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "action": "Tap",

  "element": [

    <span class="hljs-number">926</span>,

    <span class="hljs-number">93</span>

  ],

  "_metadata": "do"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

Physically tap <span class="hljs-keyword">on</span> (<span class="hljs-number">1090</span>, <span class="hljs-number">237</span>)
  
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

太好了！现在我进入了全局搜索界面。我可以看到：

<span class="hljs-operator">-</span> 顶部有搜索框，显示"李嘉诚儿子被插"（这是之前的搜索历史）

<span class="hljs-operator">-</span> 有"历史记录"部分，显示了一些历史搜索

<span class="hljs-operator">-</span> 有"猜你想搜"部分，显示了一些推荐搜索

<span class="hljs-operator">-</span> 有"小红书热点"部分

<span class="hljs-operator">-</span> 底部有键盘


现在我需要：

<span class="hljs-number">1.</span> 点击搜索框

<span class="hljs-number">2.</span> 输入"麦克杰克逊"

<span class="hljs-number">3.</span> 点击搜索按钮

让我先点击搜索框，然后输入文字。搜索框的位置大约在 (<span class="hljs-number">448</span>, <span class="hljs-number">93</span>)。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "action": "Tap",

  "element": [

    <span class="hljs-number">448</span>,

    <span class="hljs-number">93</span>

  ],

  "_metadata": "do"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

Physically tap <span class="hljs-keyword">on</span> (<span class="hljs-number">527</span>, <span class="hljs-number">237</span>)

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

好的，搜索框已经被激活了，我可以看到出现了一个弹出菜单，有"粘贴"和"自动填充"选项。现在我可以直接输入"麦克杰克逊"了。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "action": "Type",

  "text": "麦克杰克逊",

  "_metadata": "do"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

太好了！我已经成功输入了"麦克杰克逊"，并且小红书显示了很多相关的搜索建议：

<span class="hljs-operator">-</span> 麦克杰克逊舞蹈

<span class="hljs-operator">-</span> 麦克杰克逊如何变白的

<span class="hljs-operator">-</span> 麦克杰克逊的经典歌曲

<span class="hljs-operator">-</span> 麦克杰克逊经典mv

<span class="hljs-operator">-</span> 麦克杰克逊太空步

<span class="hljs-operator">-</span> 麦克杰克逊

<span class="hljs-operator">-</span> 麦克杰克逊视频

<span class="hljs-operator">-</span> 麦克杰克逊女儿

<span class="hljs-operator">-</span> 麦克杰克逊超模伴舞

现在我需要点击右侧的"搜索"按钮来执行搜索，或者直接点击其中一个建议。让我点击右上角的"搜索"按钮。搜索按钮的位置大约在 (<span class="hljs-number">918</span>, <span class="hljs-number">93</span>)。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "action": "Tap",

  "element": [

    <span class="hljs-number">918</span>,

    <span class="hljs-number">93</span>

  ],

  "_metadata": "do"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

Physically tap <span class="hljs-keyword">on</span> (<span class="hljs-number">1081</span>, <span class="hljs-number">237</span>)

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

💭 思考过程:

<span class="hljs-comment">--------------------------------------------------</span>

完美！搜索已经成功执行了。现在我可以看到"麦克杰克逊"的搜索结果页面：



顶部显示：

<span class="hljs-operator">-</span> 搜索框中显示"麦克杰克逊"

<span class="hljs-operator">-</span> 有多个标签：全部、用户、商品、图片、地点、群聊

<span class="hljs-operator">-</span> 当前在"全部"标签下

<span class="hljs-operator">-</span> 有一个提示："为您显示'迈克杰克逊'的搜索结果，仍然搜索'麦克杰克逊'"

 
下方有多个分类标签：综合、经典歌曲、僵尸mv、舞蹈、白藏风、变白

搜索结果显示了多个与麦克杰克逊相关的内容：

<span class="hljs-number">1.</span> "Michael Jackson 🌟 Dangerous 疯狂的舞蹈..." <span class="hljs-operator">-</span> 音符旅人，<span class="hljs-number">4391</span>赞

<span class="hljs-number">2.</span> "#迈克尔杰克逊 与维密超模同台飙歌比舞，创造了音..." <span class="hljs-operator">-</span> MJ群社区，<span class="hljs-number">8309</span>赞

<span class="hljs-number">3.</span> "迈克尔杰克逊 经典45°太空步" <span class="hljs-operator">-</span> 显示了一个视频

<span class="hljs-number">4.</span> 右侧还有一个视频内容

任务已经成功完成！我已经在小红书中搜索了"麦克杰克逊"，并且显示了相关的搜索结果。

<span class="hljs-comment">--------------------------------------------------</span>

🎯 执行动作:

{

  "_metadata": "finish",

  "message": "任务完成！我已经成功在小红书中搜索\"麦克杰克逊\"。搜索结果显示了多个相关内容，包括：\n\n1. 麦克杰克逊的舞蹈视频，如\"Dangerous 疯狂的舞蹈\"\n2. 与维密超模同台表演的内容\n3. 麦克杰克逊的经典45°太空步视频\n4. 还有其他相关的经典歌曲、MV、舞蹈等分类标签\n\n您现在可以浏览这些搜索结果，点击任何感兴趣的视频或内容查看详情。"

}

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>


🎉 <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

✅ 任务完成: 任务完成！我已经成功在小红书中搜索"麦克杰克逊"。搜索结果显示了多个相关内容，包括：


<span class="hljs-number">1.</span> 麦克杰克逊的舞蹈视频，如"Dangerous 疯狂的舞蹈"

<span class="hljs-number">2.</span> 与维密超模同台表演的内容

<span class="hljs-number">3.</span> 麦克杰克逊的经典<span class="hljs-number">45</span>°太空步视频

<span class="hljs-number">4.</span> 还有其他相关的经典歌曲、MV、舞蹈等分类标签


您现在可以浏览这些搜索结果，点击任何感兴趣的视频或内容查看详情。

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>

<span class="hljs-keyword">Result</span>: 任务完成！我已经成功在小红书中搜索"麦克杰克逊"。搜索结果显示了多个相关内容，包括：

<span class="hljs-number">1.</span> 麦克杰克逊的舞蹈视频，如"Dangerous 疯狂的舞蹈"

<span class="hljs-number">2.</span> 与维密超模同台表演的内容

<span class="hljs-number">3.</span> 麦克杰克逊的经典<span class="hljs-number">45</span>°太空步视频

<span class="hljs-number">4.</span> 还有其他相关的经典歌曲、MV、舞蹈等分类标签

您现在可以浏览这些搜索结果，点击任何感兴趣的视频或内容查看详情。
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p>通过上述日志分析,它执行这个任务的过程:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c54a681a55494ebee3faeb1c0fe713~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5Zu-5aSn5oG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319691&amp;x-signature=EmlrN5mbeI9bNyhDGa9nIuthZBI%3D" alt="whiteboard_exported_image.png" loading="lazy"/></p>
<ol>
<li>首先它进行拆解任务: 启动小红书、找到搜索功能、输入搜索内容</li>
<li>由于之前有启动过小红书,并处于个人中心页面,所以它先是在个人中心进行搜索</li>
<li>然后发现不正确,重新定位到首页.</li>
<li>在首页的搜索框中进行搜索,并执行了搜索操作</li>
<li>最后根据搜索结果截图确认了任务完成</li>
</ol>
<p>在iPhone 15 Pro上能基本无误的完成操作指令, 从日志可以看出,它的点击操作是通过点击坐标位置实现的,在主流手机上还算准确的. 但是在使用非主流手机(iPhone 6s)时, 它返回的坐标偏移较大, 会陷入点击-&gt;截屏-&gt;无效纠正-&gt;点击的死循环. 在github上也有比较多的点击不准确的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzai-org%2FOpen-AutoGLM%2Fissues%2F168" target="_blank" title="https://github.com/zai-org/Open-AutoGLM/issues/168" ref="nofollow noopener noreferrer">issue</a></p>
<p>未来可能的应用场景:</p>
<ol>
<li>自然语言自动化测试 - 直接通过产品需要文档自行拆解任务,进行自动化测试,减少编写自动化测试代码</li>
<li>外挂,游戏外挂,降低外挂制作的门槛</li>
<li>app智能助手,提升各个app内的Ai助手能力. app内实现一套基于坐标点击的模拟框架代替WebDriverAgent功能</li>
</ol>
<p>小实验:
提升智障Siri能力, 让Siri接入这套能力: <a href="https://link.juejin.cn?target=http%3A%2F%2Fxhslink.com%2Fo%2F6QrOGuzOizE" target="_blank" title="http://xhslink.com/o/6QrOGuzOizE" ref="nofollow noopener noreferrer">使用Open-AutoGLM给Siri装上眼睛和双手</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[玩转n8n | 我用n8n+AI把枯燥论文变成了手绘海报（附Prompt技巧）]]></title>    <link>https://juejin.cn/post/7583567658253156378</link>    <guid>https://juejin.cn/post/7583567658253156378</guid>    <pubDate>2025-12-14T13:06:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583567658253156378" data-draft-id="7582861402278117410" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="玩转n8n | 我用n8n+AI把枯燥论文变成了手绘海报（附Prompt技巧）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-14T13:06:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SakuraOnTheWay"/> <meta itemprop="url" content="https://juejin.cn/user/3035112839343709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            玩转n8n | 我用n8n+AI把枯燥论文变成了手绘海报（附Prompt技巧）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035112839343709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SakuraOnTheWay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:06:27.000Z" title="Sun Dec 14 2025 13:06:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：为什么我们需要“可视化”阅读？</h2>
<p><strong>现状</strong>：面对海量论文，LLM生成的“文字摘要”并没有改变线性的阅读方式。文字<strong>过眼不过脑</strong>，读完不仅记不住，回顾或者想做Presentation时还得重头再啃一遍。</p>
<p><strong>核心痛点</strong>：</p>
<ol>
<li><strong>记忆留存差</strong>：纯文字看过就忘，不如一张图印象深刻，能不能拥有文字总结的同时，让AI画一张“论文海报”？</li>
<li><strong>复用成本高</strong>：如果需要做Presentatio就要重新画图，为什么不让AI在读论文时就顺手把“素材图”做出来？</li>
</ol>
<p><strong>市场调研</strong>：现在也有博主推出了<strong>漫画风格的AI科普系列</strong>，反响不错。</p>
<p><strong>我的目标</strong>：搭建一个n8n workflow，输入PDF，输出一张<strong>帮助我快速理解和记忆论文</strong>的高质量论文信息海报，大概如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0a5a05ff3e845cd8e736f86fc78b47a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=QTrWfu025yuT0nyKnKrLzdqWObE%3D" alt="image.png" loading="lazy"/></p>
<p><strong>核心链路</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45a82a56215a4f2cb276289e4283e046~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=BtrElltuct52ZUPytCprvJDxKMQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">Prompt Engineering：构建我的Prompt内化方法论</h2>
<p>回顾整个n8n工作流，我们会发现那些花哨的节点和连线只是躯壳，真正注入灵魂、决定输出质量的，是那一串串精心调试过的 <strong>Prompt</strong>。</p>
<p>在n8n这种低代码平台中，<strong>Prompt 其实就是自然语言形态的源代码</strong>。如果你对待 Prompt 像对待<code>console.log</code>一样随意，那么AI回报给你的也只能是随机的“噪声”。</p>
<h3 data-id="heading-2">建立方法论基石：OpenAI 六大原则的内化</h3>
<p>在动手写Prompt之前，我参考了<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.baai.ac.cn%2Fview%2F33671" target="_blank" title="https://hub.baai.ac.cn/view/33671" ref="nofollow noopener noreferrer">《OpenAI官方Prompt工程指南：写好Prompt的六个策略》</a>的内容，这六大策略不仅是技巧，更是构建稳定 AI 应用的<strong>工程原则</strong>。</p>
<p>接下来，我将展示我是如何将这些原则应用到两个核心Prompt中的。</p>
<h3 data-id="heading-3">解析一：Prompt 1 —— 提炼论文“精华”</h3>
<p>如果我只说"Summarize this paper..."，AI可能会给我一篇散文、一个Markdown列表... 把这些喂给nano banner会增加后续调优的费力度，那不如直接在这一步就做好：输出<strong>确定性的数据结构</strong>，让nano banner更好地“理解”，直接输出想要的图。</p>
<p>如何定义一套严格的<strong>JSON Schema</strong>？我们一步一步来：</p>
<h4 data-id="heading-4">角色设定 (Role)</h4>
<p>AI Frontier Tech Expert &amp; Structural Logic Analyst (AI前沿技术专家与架构逻辑分析师)</p>
<p>您是人工智能领域的杰出技术专家。您持续关注人工智能领域的最新发展（例如逻辑学习模型、扩散模型、智能体等），并对前沿知识有着深刻的理解。您拥有将这些技术概念转化为<strong>简洁、抽象的视觉描述</strong>的独特能力，能够解读复杂的学术论文，摒弃晦涩难懂的术语，并提炼出技术的核心要点。</p>
<h4 data-id="heading-5"><strong>清晰指令 (Instruction)</strong></h4>
<p>您正在阅读一篇新的研究论文（提供PDF文本）。您的任务是：</p>
<ul>
<li><strong>逐章剖析</strong>：提取每个主要部分的核心技术要点。</li>
<li><strong>保留专业术语</strong>：不要简化技术术语。</li>
<li><strong>视觉抽象</strong>：将技术内容转化为适合<strong>抽象草图</strong>的简洁语句。</li>
</ul>
<h4 data-id="heading-6">格式约束 (Constraint)</h4>
<p>最重要的！！！为了方便画海报时结构化输入，我们必须规范LLM的输出结构，我希望的结构如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"论文原文标题"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"highlights"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"String(highlight1)"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"String(highlight2)"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"String(highlight3)"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"chapter_flow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"chapter_title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"String(必须以Chapter开头, 如Chapter1: Induction)"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 章节标题</span>
            <span class="hljs-attr">"core_essence"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"String(包含术语和图表引用的核心总结，例如“重点阐述 CNN 的局限性并提出 ViT（图 1）”）)"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 核心本质</span>
            <span class="hljs-attr">"visual_abstract"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"String(简洁的图像提示。例如，“抽象网格图案转换为序列线)"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//  抽象描述</span>
            <span class="hljs-attr">"logical_relation"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"String(如何与下一章关联，论文中的逻辑关系)"</span> <span class="hljs-comment">// 逻辑关系</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span>
            ...
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>

<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-7"><strong>其他要求</strong></h4>
<ul>
<li><strong>规范语言：</strong> 限定为英文，nano banner对英文有更好的理解</li>
</ul>
<h4 data-id="heading-8">Prompt：AI Tech Expert</h4>
<pre><code class="hljs language-text" lang="text"># Role
AI Frontier Tech Expert &amp; Structural Logic Analyst (AI前沿技术专家与架构逻辑分析师)

# Profile
- Author: SakuraOnTheWay
- Language: English (Output MUST be in English for the Image Generator)
- Description: You are a distinguished expert in AI. You excel at parsing complex papers, retaining their hardcore technical terminology. Most importantly, you can identify the **Macro-Structure** of a paper (e.g., "Total-Part-Total", "Linear Pipeline", or "Parallel Components") and pinpoint exactly where each chapter fits into this big picture.

# Context
You are reading a new research paper (PDF text provided). Your task is to:
1.  **Dissect Each Chapter**: Extract the absolute core technical essence.
2.  **Preserve Jargon**: Do NOT simplify technical terms (keep "RoPE," "Fig. 1").
3.  **Analyze Structural Position**: Do not just look at the next chapter. Analyze the **Global Logic**. Is this chapter the "Foundation"? A "Parallel Module"? The "Validation"? or the "Synthesis"?
4.  **Visual Abstraction**: Translate technical content into abstract visual descriptions.

# Core Instructions
1.  **Title Extraction**: Identify the exact title.
2.  **Chapter Formatting**: **ALL chapter titles must start with the word "Chapter"** (e.g., "Chapter 1: Introduction").
3.  **Structural Analysis**:
    * Identify if the paper follows a **Linear Flow** (Step A -&gt; Step B) or a **Hierarchical/Parallel Structure** (Framework consists of Module A &amp; Module B).
    * For each chapter, define its **Logical Role**: Is it defining the problem? Is it a sub-component of the proposed method? Is it the experimental proof?
4.  **Visual Abstraction**: Create a prompt for an abstract geometric representation.

# Output Schema (Strict JSON Enforcement)
{
  "title": "String (Original Paper Title)",
  "visual_concept": "String (Overall abstract theme. e.g., 'A central core system with three radiating satellite modules, blueprint style')",
  "highlights": [
    "String (Critical Tech Term 1)",
    "String (Critical Tech Term 2)",
    "String (Critical Tech Term 3)"
  ],
  "chapter_flow": [
    {
      "chapter_title": "String (MUST start with 'Chapter')",
      "core_essence": "String (Hardcore summary with jargon &amp; Figure refs.)",
      "visual_abstract": "String (Concise image prompt. e.g., 'A foundation block supporting the structure.')",
      "logical_position": "String (The structural role. e.g., 'The [Root Node] of the logic tree: Defines the problem context.' OR 'A [Parallel Branch]: The first of two proposed modules.' OR 'The [Validation Layer]: Proof of the previous methods.')"
    },
    {
      "chapter_title": "String (e.g., 'Chapter 3: Methodology')",
      "core_essence": "String (Technical details.)",
      "visual_abstract": "String (Concise image prompt.)",
      "logical_position": "String (e.g., 'The [Core Engine]: The central mechanism solving the problem defined in Ch.1.')"
    }
  ]
}

# Input Text
(The user will provide the PDF text here)
</code></pre>
<h3 data-id="heading-9">解析二：Prompt 2 —— 指挥 Nano Banner 画海报</h3>
<p>需要从以下角度清晰表述生成图片的指令要求：</p>
<ol>
<li><strong>布局和构图：</strong> 在正中心绘制手写加粗标题：<code>{{ $json.title }}</code>。</li>
<li><strong>结构：</strong> 围绕中心以松散的环形或半圆形排列干净的手绘矩形面板，不要在面板和中心之间绘制任何连接线、箭头或分支。面板应围绕标题独立浮动，面板按<code>{{ $json.chapter_flow }}</code>的顺序顺时针排列。</li>
<li><strong>详细信息：</strong> 章节的详细信息在 <code>{{ $json.chapter_flow }}</code> 的列表中，每个部分绘制一个面板，不要增加或者删除面板的数量，数量个数和<code>{{ $json.chapter_flow }}</code>列表长度一致。在每个面板中，渲染提供的特定视觉描述必须包含：(1)章节标题，例如<code>{{ $json.chapter_flow[0].chapter_title}}</code>，(2)标题底下画一幅基于描述准确的核心内容抽象图画，例如<code>{{ $json.chapter_flow[0].core_essence }}</code>，以及图像需要的关键文字注释。</li>
<li><strong>艺术风格：</strong> 简笔漫画风，字体颜色以黑色墨水为主，白色背景。</li>
<li><strong>文本处理：</strong> 中心标题和章节标题必须清晰易读，中心标题和章节标题不能被截断以及修改。</li>
<li><strong>水印：</strong> 底部中间写上作者[sakuraontheway]的署名。</li>
</ol>
<p>如果要输入nano banana生成图片的prompt中，描述必须翻译成英文！</p>
<h2 data-id="heading-10">搭建工作流</h2>
<h3 data-id="heading-11">前置准备</h3>
<p>我主要用n8n+Gemini+nano banana来完成目标。所以前置需要完成：</p>
<ol>
<li>部署n8n</li>
<li>获取Gemini API key</li>
</ol>
<h3 data-id="heading-12">Step 1: Download PDF —— 获取“二进制”数据</h3>
<p><strong>目标：</strong> 将PDF能够理解的二进制文件流（Binary Data）。</p>
<p><strong>节点：</strong> Http Request</p>
<p><strong>关键配置：</strong></p>
<ul>
<li>Method: GET</li>
<li>URL: 论文链接（例如Arxiv链接） --- 本文以《Attention is all you need》为例</li>
</ul>
<p>执行后，输出pdf二进制流</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9977faa97a7845d0a821db9dd4790312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=VdzpWosPGmaIHoNkEavIPoqj9ug%3D" alt="截屏2025-12-13 23.56.21.png" loading="lazy"/></p>
<h3 data-id="heading-13">Step 2: Extract from File —— PDF里的“降噪”处理</h3>
<p>拿到PDF二进制流后，不能直接丢给LLM。虽然现在很多LLM支持多模态，但经过实测，使用n8n专用的PDF解析节点先提取纯文本，处理速度更快，且能节省 Token 开销。</p>
<p><strong>节点：</strong> Extract from File</p>
<p><strong>关键配置：</strong></p>
<ul>
<li>Operation: Extract from PDF</li>
<li>Input Binary Field: data --- 与input一致，默认是data</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41c67537feff4141a53a95d36599dc2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=34fqm19ib7C8swwdsEEFP2FBKgY%3D" alt="截屏2025-12-14 00.03.13.png" loading="lazy"/></p>
<h3 data-id="heading-14">Step 3: Basic LLM Chain —— 最关键的“逻辑大脑”</h3>
<p>这里是整个workflow的<strong>最重要的部分</strong>。这一步决定了我们输出的是“垃圾摘要”还是“结构化信息”。</p>
<p>如果是Gemini，可以省略前面两步直接使用<strong>Analyze document</strong>来分析文档，但是为了通用性和可拓展性，我还是把步骤拆细了。</p>
<p>这一步中，我使用<strong>Basic LLM Chain</strong>并关联<strong>Google Gemini</strong>作为Model，也可以关联其他LLM。</p>
<ul>
<li><strong>核心节点</strong>：<code>Basic LLM Chain</code></li>
</ul>
<p>注意记得修改：Source for prompt --- 选择自定义</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eadd35f8020f4566aa90c338d3922119~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=mEl0YbxanzWy8G%2FOydWUzBDywc4%3D" alt="截屏2025-12-13 16.20.08.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fe8120fd1a84b1f85a9aee4ab9d3cb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=Q6pShy8A1aVv2QDr8yewihYHFig%3D" alt="截屏2025-12-14 00.27.55.png" loading="lazy"/></p>
<p>此时执行，会需要关联Model</p>
<ul>
<li><strong>Model</strong>: <code>Google Gemini Chat Model</code></li>
</ul>
<p>重要！关联身份：your gemini api key</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ad536e457484dec809ee457cd8ca6e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=5IAgE618IkmBKMPbBEhGjEnMu1E%3D" alt="截屏2025-12-14 00.32.06.png" loading="lazy"/></p>
<ul>
<li><strong>Prompt 设置</strong> ：还记得之前提炼“论文”的Prompt吗？直接粘贴上。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91545d4a38fc4779844e9b37e1917350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=E4MnCSamikYMOTraqSe5iZStTU4%3D" alt="截屏2025-12-14 16.19.57.png" loading="lazy"/></p>
<h3 data-id="heading-15">Step 4: Code Node —— 数据清洗</h3>
<p>上图我们可以看到Gemini输出的是一个json结构，有点“画蛇添足”，我打算转一层变为JavaScript结构</p>
<ul>
<li>
<p><strong>核心节点</strong>：<code>Code in JavaScript</code></p>
</li>
<li>
<p><strong>代码逻辑</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 获取 LLM 输出</span>
<span class="hljs-keyword">const</span> raw = items[<span class="hljs-number">0</span>].<span class="hljs-property">json</span>.<span class="hljs-property">text</span>;
<span class="hljs-comment">// 正则清洗，移除 Markdown 标记</span>
<span class="hljs-keyword">const</span> clean = raw.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/```json|```/g</span>, <span class="hljs-string">''</span>).<span class="hljs-title function_">trim</span>();
<span class="hljs-comment">// 解析为对象，供下一步画图使用</span>
<span class="hljs-keyword">return</span> { <span class="hljs-attr">json</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(clean) };
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b040e9b6ce64787b8f38b2a012050a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=WQVzusV4o6cEmQfc8ArL%2FenQ1O8%3D" alt="截屏2025-12-14 16.25.48.png" loading="lazy"/></p>
<p>结构一下子就清晰了！</p>
<h3 data-id="heading-16">Step 5: The Visual Renderer —— 画海报</h3>
<ul>
<li><strong>核心节点</strong>：<code>Http Request</code></li>
<li><strong>参考文档</strong>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.google.dev%2Fgemini-api%2Fdocs%2Fimage-generation%3Fhl%3Dzh-cn" target="_blank" title="https://ai.google.dev/gemini-api/docs/image-generation?hl=zh-cn" ref="nofollow noopener noreferrer">使用 Gemini（又称 Nano Banana 和 Nano Banana Pro）生成图片</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d4e7dc1f0dd4bf0a6fb5ff0415d7b32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=DqQoVwxzb8EGuA9KYPVN3xkrz4A%3D" alt="截屏2025-12-14 16.29.45.png" loading="lazy"/></p>
<p>通过<code>import curl</code>导入，然后输入prompt，记得选择expression，因为prompt依赖变量。</p>
<p>我修改了model为：<code>gemini-3-pro-image-preview</code>，亲测比<code>gemini-2.5-flash-image</code>强太多了！！！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66f1188695de477d8928999108a0e497~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=00K36GMQOpdf%2FvcjMtSMbGMLIfE%3D" alt="截屏2025-12-14 19.19.17.png" loading="lazy"/></p>
<h3 data-id="heading-17">Step 6: Convert to File —— 输出图片</h3>
<ul>
<li><strong>核心节点</strong>：<code>Convert to File</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cd24bc840154d2eb36be5aa1371b61b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=cdQjO4pv89cnMVBUFNzkUAYjC3k%3D" alt="截屏2025-12-14 19.22.04.png" loading="lazy"/></p>
<h3 data-id="heading-18">成果展示</h3>
<h4 data-id="heading-19">1. n8n工作流</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61ffc8ef26b0468284f50daffaca84a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=rdaIyobr%2Fx5A%2BcQGlAhtYKKbpvo%3D" alt="截屏2025-12-14 20.48.29.png" loading="lazy"/></p>
<h4 data-id="heading-20">2. 论文海报</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38fa12046bac4df6a7a8a133a08a0dfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FrdXJhT25UaGVXYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766322490&amp;x-signature=%2F18KLXn9EYGiV6ziBD%2BMM6ocE80%3D" alt="file (7).jpg" loading="lazy"/></p>
<h2 data-id="heading-21">与AI协作的真实感悟</h2>
<p>在这次搭建自动画图工作流的过程中，我深刻体会到，Prompt Engineering不仅仅是写句子，更是一种<strong>产品思维</strong>的体现。</p>
<h4 data-id="heading-22">1. 定义需求是核心：从“模糊”到“精准”</h4>
<blockquote>
<p>"只有明确自己的需求，才能给AI清晰的指令。"</p>
</blockquote>
<p>AI是一面镜子，它忠实地反射出你思维的清晰度。最开始我只想要“一张海报”，AI 就给我堆砌文字；当我明确我需要的是“<strong>以视觉为主、文字为辅、带有分镜逻辑的架构图</strong>”时，Prompt瞬间变得有据可依。在写 Prompt 之前，先问自己：<strong>“我到底想看什么？是给谁看的？重点在哪里？”</strong> 只有当人类的意图足够锐利，AI的执行力才能被释放。</p>
<h4 data-id="heading-23">2. 迭代是常态：耐心对话，拒绝“一步到位”</h4>
<blockquote>
<p>"需要耐心，Prompt一步步调优，不要想着能一步到位，学会与AI对话。"</p>
</blockquote>
<p>一开始LLM提炼的论文核心是有偏差的，而且带了很多“感情色彩”，nano banner生成的图片也是“惨不忍睹”。但请记住对话的过程，表达者和倾听者都很重要，每一次报错（Error）和每一次不如人意的出图，其实都是AI在告诉你：“嘿，这里我不理解，请换个方式说。” 好的Prompt不是写出来的，是“调”出来的。<strong>与其追求寻找一个万能的“神级 Prompt”，不如建立一套“观察-调整-验证”的快速反馈机制。</strong></p>
<h4 data-id="heading-24">3. 人的价值在于判断：Feedback loop</h4>
<blockquote>
<p>"学会思考，Feedback很重要。"</p>
</blockquote>
<p>AI可以一秒钟生成十个方案，但只有人能判断哪个方案是“对”的。在这个工作流中，<strong>代码逻辑JSON 结构和审美决策</strong> 依然掌握在人手中。<strong>AI负责根据指令“发散”，而我们负责根据结果“收敛”。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agents SDK+MCP智能体开发]]></title>    <link>https://juejin.cn/post/7583215836690792489</link>    <guid>https://juejin.cn/post/7583215836690792489</guid>    <pubDate>2025-12-14T14:19:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583215836690792489" data-draft-id="7568714767150481414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agents SDK+MCP智能体开发"/> <meta itemprop="keywords" content="MCP,Agent"/> <meta itemprop="datePublished" content="2025-12-14T14:19:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小鱼儿亮亮"/> <meta itemprop="url" content="https://juejin.cn/user/2831978245134504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agents SDK+MCP智能体开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831978245134504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小鱼儿亮亮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:19:06.000Z" title="Sun Dec 14 2025 14:19:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>2025年3月27号，Agents SDK正式官宣支持MCP使用，这也使得Agents SDK的实际应用场景得到拓展。</p>
</blockquote>
<p>现在，我们仅需在创建Agent的时候，将MCP服务器视作为一项工具，即可顺利调用MCP服务器进行Agent开发。换而言之，就是如果使用Agents SDK作为Agent开发框架，则可以零门槛快速接入MCP海量服务器生态。</p>
<h2 data-id="heading-0">一、Agents SDK + MCP基础调用流程（单个MCP服务 + stdio模式）</h2>
<p>我们接下来使用高德天气查询API开发一个MCP服务，并将其作为工具在Agents中调用。</p>
<h3 data-id="heading-1">环境准备</h3>
<p>需先安装如下依赖</p>
<ul>
<li>pip install openai-agents</li>
<li>pip install mcp</li>
<li>pip install httpx</li>
<li>pip install python-dotenv</li>
</ul>
<h3 data-id="heading-2">开发高德天气查询MCP server端</h3>
<p>新建<code>weather_server.py</code>文件代码如下，</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#weather_server.py</span>
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 从 .env 文件加载环境变量</span>
load_dotenv()

<span class="hljs-comment"># 初始化 MCP 服务器</span>
mcp = FastMCP(<span class="hljs-string">"WeatherServer"</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""
    从 高德天气查询API 获取天气信息。
    :param city: 城市编码（城市adcode，如 110101）
    :return: 天气数据字典；若出错返回包含 error 信息的字典
    """</span>

    <span class="hljs-comment">#高德天气查询 API 配置</span>
    BASE_URL = <span class="hljs-string">"https://restapi.amap.com/v3/weather/weatherInfo"</span>
    API_KEY = os.getenv(<span class="hljs-string">'AMAP_API_KEY'</span>)  <span class="hljs-comment"># 获取环境变量中的高德API Key，也可直接替换成自己的高德API Key</span>
    
    params = {
        <span class="hljs-string">"city"</span>: city,
        <span class="hljs-string">"key"</span>: API_KEY,
        <span class="hljs-string">"extensions"</span>: <span class="hljs-string">"base"</span>, <span class="hljs-comment"># base:返回实况天气; all:返回预报天气</span>
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"JSON"</span>
    }

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:
        <span class="hljs-keyword">try</span>:
            response = <span class="hljs-keyword">await</span> client.get(BASE_URL, params=params, timeout=<span class="hljs-number">30.0</span>)
            response.raise_for_status()
            <span class="hljs-keyword">return</span> response.json()  <span class="hljs-comment"># 返回字典类型</span>
        <span class="hljs-keyword">except</span> httpx.HTTPStatusError <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"error"</span>: <span class="hljs-string">f"HTTP 错误: <span class="hljs-subst">{e.response.status_code}</span>"</span>}
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"error"</span>: <span class="hljs-string">f"请求失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">format_weather</span>(<span class="hljs-params">data: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    将天气数据格式化为易读文本。
    :param data: 天气数据（可以是字典或 JSON 字符串）
    :return: 格式化后的天气信息字符串
    """</span>
    <span class="hljs-comment"># 如果传入的是字符串，则先转换为字典</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">str</span>):
        <span class="hljs-keyword">try</span>:
            data = json.loads(data)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"无法解析天气数据: <span class="hljs-subst">{e}</span>"</span>

    <span class="hljs-comment"># 如果数据中包含错误信息，直接返回错误提示</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"error"</span> <span class="hljs-keyword">in</span> data:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"⚠️ <span class="hljs-subst">{data[<span class="hljs-string">'error'</span>]}</span>"</span>

    <span class="hljs-comment"># 列表可能为空，因此用 [0] 前先提供默认字典</span>
    lives_list = data.get(<span class="hljs-string">"lives"</span>, [{}])
    live_data = lives_list[<span class="hljs-number">0</span>]
    
    <span class="hljs-comment"># 提取数据时做容错处理</span>
    province = live_data.get(<span class="hljs-string">"province"</span>, <span class="hljs-string">"未知"</span>)
    city = live_data.get(<span class="hljs-string">"city"</span>, <span class="hljs-string">"未知"</span>)
    weather = live_data.get(<span class="hljs-string">"weather"</span>, <span class="hljs-string">"未知"</span>)
    temperature = live_data.get(<span class="hljs-string">"temperature"</span>, <span class="hljs-string">"N/A"</span>)
    humidity = live_data.get(<span class="hljs-string">"humidity"</span>, <span class="hljs-string">"N/A"</span>)
    winddirection = live_data.get(<span class="hljs-string">"winddirection"</span>, <span class="hljs-string">"未知"</span>)
    windpower = live_data.get(<span class="hljs-string">"windpower"</span>, <span class="hljs-string">"N/A"</span>)

    <span class="hljs-keyword">return</span> (
        <span class="hljs-string">f"🌍 <span class="hljs-subst">{province}</span>, <span class="hljs-subst">{city}</span>\n"</span>
        <span class="hljs-string">f"🌤 天气: <span class="hljs-subst">{weather}</span>\n"</span>
        <span class="hljs-string">f"🌡 温度: <span class="hljs-subst">{temperature}</span>°C\n"</span>
        <span class="hljs-string">f"💧 湿度: <span class="hljs-subst">{humidity}</span>%\n"</span>
        <span class="hljs-string">f"🌬 风速: <span class="hljs-subst">{winddirection}</span>风, <span class="hljs-subst">{windpower}</span>级\n"</span>
    )

<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">query_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    输入指定城市的城市编码（城市adcode，如 110101），返回今日天气查询结果。
    :param city: 城市编码（城市adcode，如 110101）
    :return: 格式化后的天气信息
    """</span>
    data = <span class="hljs-keyword">await</span> fetch_weather(city)
    <span class="hljs-keyword">return</span> format_weather(data)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 以标准 I/O 方式运行 MCP 服务器</span>
    mcp.run(transport=<span class="hljs-string">'stdio'</span>)
</code></pre>
<h3 data-id="heading-3">使用Agents SDK创建Agents并与MCP服务通信。</h3>
<p>在新版的Agents SDK中，Agents SDK可以将某个对应的Agent封装为client，并外部定义好的server进行通信。</p>
<p>新建<code>run_agent_weather.py</code>文件，代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ------------------------------</span>
<span class="hljs-comment">#     查询天气单MCP工具Agent</span>
<span class="hljs-comment"># ------------------------------</span>
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> AsyncOpenAI
<span class="hljs-keyword">from</span> agents <span class="hljs-keyword">import</span> OpenAIChatCompletionsModel, Agent, Runner, set_default_openai_client
<span class="hljs-keyword">from</span> agents.mcp <span class="hljs-keyword">import</span> MCPServerStdio, MCPServerStdioParams
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> logging
<span class="hljs-comment"># pip install python-dotenv</span>
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 从 .env 文件加载环境变量</span>
load_dotenv()

<span class="hljs-comment"># 完全禁用所有日志</span>
logging.getLogger().setLevel(logging.CRITICAL)

<span class="hljs-comment"># 自定义模型对象</span>
external_client = AsyncOpenAI(
    base_url=<span class="hljs-string">"https://api.deepseek.com"</span>,
    api_key=os.getenv(<span class="hljs-string">'DEEPSEEK_API_KEY'</span>), 
)
<span class="hljs-comment"># 设置默认模型</span>
set_default_openai_client(external_client)

<span class="hljs-comment"># 创建模型对象</span>
deepseek_model = OpenAIChatCompletionsModel(
    openai_client=external_client,
    model=<span class="hljs-string">"deepseek-chat"</span>
)

<span class="hljs-comment"># 定义mcp连接和agent调用函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_with_mcp_detailed</span>():
    <span class="hljs-string">"""详细调试 MCP 连接过程"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤1: 创建 MCP Server的连接参数..."</span>)
        stdio_params = MCPServerStdioParams(
            command=<span class="hljs-string">"python"</span>,
            <span class="hljs-comment">#mcp server对应的文件路径</span>
            args=[<span class="hljs-string">"weather_server.py"</span>]
        )
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✓ 参数创建成功"</span>)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤2: 创建 MCP Server 实例对象..."</span>)
        mcp_server = MCPServerStdio(
            <span class="hljs-comment">#mcp server的自定义名称（叫啥都行）</span>
            name=<span class="hljs-string">"Weather Server"</span>,
            params=stdio_params,
            cache_tools_list=<span class="hljs-literal">True</span>
        )
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✓ MCPServerStdio 实例创建成功"</span>)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤3: 连接mcp server..."</span>)
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> mcp_server <span class="hljs-keyword">as</span> server:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✓ MCP 服务器连接成功"</span>)
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤4: 创建 Agent..."</span>)
            agent = Agent(
                name=<span class="hljs-string">"Assistant"</span>,
                instructions=<span class="hljs-string">"你是一名助人为乐的助手，可以使用天气查询工具帮助用户查询天气。请使用get_weather工具来查询天气信息。请根据用户想要查询的地区选择最合适的城市编码，无需要用户二次确认"</span>,
                mcp_servers=[server], <span class="hljs-comment">#指定给当前agent绑定的mcp server（外部工具）</span>
                model=deepseek_model
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✓ Agent 创建成功"</span>)

            <span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤5: 运行agent..."</span>)
            message = <span class="hljs-string">"请帮我查询上海今天天气如何？"</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户提问: <span class="hljs-subst">{message}</span>"</span>)
            result = <span class="hljs-keyword">await</span> Runner.run(starting_agent=agent, <span class="hljs-built_in">input</span>=message)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"助手回复: <span class="hljs-subst">{result.final_output}</span>"</span>)
            
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 错误发生在: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">import</span> traceback
        traceback.print_exc()

<span class="hljs-comment"># 运行</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 运行主程序</span>
    asyncio.run(run_with_mcp_detailed())
</code></pre>
<h3 data-id="heading-4">执行天气查询 Agent</h3>
<p>在cmd中执行命令<code>python run_agent_weather.py</code>，效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb888ddf61774a48a07fdb7ffcf79ece~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6bG85YS_5Lqu5Lqu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766326746&amp;x-signature=0cK3zlcpEiDf7y4zureEtOhJClc%3D" alt="image.png" loading="lazy"/></p>
<br/>
<h2 data-id="heading-5">二、Agents SDK 接入多个MCP服务器</h2>
<p>理论上，一个MCP服务器能同时运行多个外部函数，而一个MCP Client则可以连接多个MCP服务器。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29502208d0d14a52921e1d80c58b197d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6bG85YS_5Lqu5Lqu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766326746&amp;x-signature=UcarYvx2MkbiQ5ZlHca02HwcpoA%3D" alt="image-20250807100559366.png" loading="lazy"/></p>
<p>如何将Agents SDK同时接入多个MCP服务器？</p>
<p>这里我们写一个同时可“查询天气”并把“内容写入本地”的多MCP服务的Agents。
“天气查询”MCP服务还使用上面的代码，这里新写一个“内容写入本地”的伪代码示例MCP服务。</p>
<p>新建<code>write_server.py</code>文件，代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP

<span class="hljs-comment"># 初始化 MCP 服务器</span>
mcp = FastMCP(<span class="hljs-string">"WriteServer"</span>)
USER_AGENT = <span class="hljs-string">"write-app/1.0"</span>

<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">write_file</span>(<span class="hljs-params">content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    将指定内容写入本地文件。
    :param content: 必要参数，字符串类型，用于表示需要写入文档的具体内容。
    :return：是否成功写入
    """</span>
    <span class="hljs-comment"># 实现一个伪写文件方法</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"已成功写入本地文件。"</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 以标准 I/O 方式运行 MCP 服务器</span>
    mcp.run(transport=<span class="hljs-string">'stdio'</span>)
</code></pre>
<h3 data-id="heading-6">使用Agents SDK创建Agents并连接多个MCP服务。</h3>
<p>新建<code>run_agent_multiTool.py</code>文件，代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># --------------------------------</span>
<span class="hljs-comment">#  查询天气并写入信息多MCP工具Agent</span>
<span class="hljs-comment"># --------------------------------</span>
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> AsyncOpenAI
<span class="hljs-keyword">from</span> agents <span class="hljs-keyword">import</span> OpenAIChatCompletionsModel, Agent, Runner, set_default_openai_client
<span class="hljs-keyword">from</span> agents.mcp <span class="hljs-keyword">import</span> MCPServerStdio, MCPServerStdioParams
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> logging
<span class="hljs-comment"># pip install python-dotenv</span>
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 从 .env 文件加载环境变量</span>
load_dotenv()

<span class="hljs-comment"># 完全禁用所有日志</span>
logging.getLogger().setLevel(logging.CRITICAL)

<span class="hljs-comment"># 自定义模型对象</span>
external_client = AsyncOpenAI(
    base_url=<span class="hljs-string">"https://api.deepseek.com"</span>,
    api_key=os.getenv(<span class="hljs-string">'DEEPSEEK_API_KEY'</span>), 
)

<span class="hljs-comment"># 设置默认模型</span>
set_default_openai_client(external_client)

<span class="hljs-comment"># 创建模型对象</span>
deepseek_model = OpenAIChatCompletionsModel(
    openai_client=external_client,
    model=<span class="hljs-string">"deepseek-chat"</span>
)

<span class="hljs-comment"># 定义mcp连接和agent调用函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_with_mcp_detailed</span>():
    <span class="hljs-string">"""详细调试 MCP 连接过程"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤1: 创建 MCP服务器参数..."</span>)
         <span class="hljs-comment"># 创建天气服务器参数</span>
        weather_params = MCPServerStdioParams(
            command=<span class="hljs-string">"python"</span>,
            args=[<span class="hljs-string">"weather_server_amap.py"</span>]
        )
        <span class="hljs-comment"># 创建写作服务器参数</span>
        write_params = MCPServerStdioParams(
            command=<span class="hljs-string">"python"</span>, 
            args=[<span class="hljs-string">"write_server.py"</span>]
        )
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✓ 参数创建成功"</span>)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤2: 创建 MCP服务器实例..."</span>)
        weather_server = MCPServerStdio(
            params=weather_params,
            name=<span class="hljs-string">"Weather Server"</span>,
            cache_tools_list=<span class="hljs-literal">True</span>
        )
        write_server = MCPServerStdio(
            params=write_params,
            name=<span class="hljs-string">"Write Server"</span>, 
            cache_tools_list=<span class="hljs-literal">True</span>
        )
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✓ MCPServerStdio 实例创建成功"</span>)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤3: 同时连接两个 MCP 服务器..."</span>)
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> weather_server <span class="hljs-keyword">as</span> ws, write_server <span class="hljs-keyword">as</span> wrs:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✓ 两个 MCP 服务器连接成功"</span>)
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤4: 创建 Agent（集成两个服务器的工具）..."</span>)
            agent = Agent(
                name=<span class="hljs-string">"MultiTool Assistant"</span>,
                instructions=<span class="hljs-string">"""你是一个多功能助手，可以同时使用天气查询和本地文档写入的能力。
你可以使用的工具包括：
1. 天气查询工具 - 查询全球城市的天气信息
2. 本地文档写入 - 帮助用户将相关数据写入本地文档进行保存
请根据用户的需求智能选择合适的工具：
- 当用户询问天气时，使用天气查询工具
- 当用户需要写入数据保存时，使用本地文档写入工具
- 如果用户的需求涉及多个方面，可以组合使用多个工具
- 如果不知道使用哪个工具，可以询问用户澄清"""</span>,
                mcp_servers=[ws, wrs],  <span class="hljs-comment"># 传入两个服务器</span>
                model=deepseek_model
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✓ Agent 创建成功"</span>)

            <span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤5: 运行查询..."</span>)
            message = <span class="hljs-string">"请帮我查询上海天气，并写入本地文档。"</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户提问: <span class="hljs-subst">{message}</span>"</span>)
            result = <span class="hljs-keyword">await</span> Runner.run(starting_agent=agent, <span class="hljs-built_in">input</span>=message)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"助手回复: <span class="hljs-subst">{result.final_output}</span>"</span>)
            
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 错误发生在: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">import</span> traceback
        traceback.print_exc()

<span class="hljs-comment"># 运行</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 运行主程序</span>
    asyncio.run(run_with_mcp_detailed())
</code></pre>
<h3 data-id="heading-7">执行多MCP Agents</h3>
<p>在cmd中执行命令<code>python run_agent_multiTool.py</code>，效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8055df9704e4f8bb0fd364bf89c4df6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6bG85YS_5Lqu5Lqu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766326746&amp;x-signature=D5uAWGeoKCckkTBOgnFBm0kYlxo%3D" alt="image.png" loading="lazy"/></p>
<br/>
<h2 data-id="heading-8">三、Agents SDK + MCP基础调用流程（单个MCP服务 + SSE模式）</h2>
<p>以12306的MCP 服务器应用为例：新建文件<code>run_agent_sse_12306.py</code>，代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> AsyncOpenAI
<span class="hljs-keyword">from</span> agents <span class="hljs-keyword">import</span> OpenAIChatCompletionsModel, Agent, Runner, set_default_openai_client
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> agents.mcp <span class="hljs-keyword">import</span> MCPServerSse
<span class="hljs-comment"># pip install python-dotenv</span>
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 从 .env 文件加载环境变量</span>
load_dotenv()

<span class="hljs-comment"># 完全禁用所有日志</span>
logging.getLogger().setLevel(logging.CRITICAL)

<span class="hljs-comment"># 自定义模型对象</span>
external_client = AsyncOpenAI(
    base_url=<span class="hljs-string">"https://api.deepseek.com"</span>,
    api_key=os.getenv(<span class="hljs-string">'DEEPSEEK_API_KEY'</span>), 
)
<span class="hljs-comment"># 设置默认模型</span>
set_default_openai_client(external_client)

<span class="hljs-comment"># 创建模型对象</span>
deepseek_model = OpenAIChatCompletionsModel(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    openai_client=external_client
)

<span class="hljs-comment"># 定义mcp连接和agent调用函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_with_sse</span>():
    <span class="hljs-string">"""使用 SSE 传输方式"""</span>
    <span class="hljs-keyword">try</span>:<span class="hljs-comment">#创建sse模式下的mcp server对象</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> MCPServerSse(
            name=<span class="hljs-string">"Train Server"</span>,
            params={
                <span class="hljs-comment">#url就是mcp server配置信息中的链接地址。可从魔塔社区获取。</span>
                <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://mcp.api-inference.modelscope.net/ad61d61d2e7847/sse"</span>
            }
        ) <span class="hljs-keyword">as</span> server:
            
            agent = Agent(
                name=<span class="hljs-string">"Assistant"</span>,
                instructions=<span class="hljs-string">"你是一名车票查询的助手"</span>,
                mcp_servers=[server],
                model=deepseek_model
            )

            message = <span class="hljs-string">"帮我查询今天下午北京到上海的高铁余票信息"</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户提问: <span class="hljs-subst">{message}</span>"</span>)
            result = <span class="hljs-keyword">await</span> Runner.run(starting_agent=agent, <span class="hljs-built_in">input</span>=message)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"助手回复: <span class="hljs-subst">{result.final_output}</span>"</span>)
            
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"SSE 错误: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 运行</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 运行主程序</span>
    asyncio.run(run_with_sse())
</code></pre>
<p>在cmd中执行命令<code>python run_agent_sse_12306.py</code>，效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b26c2ac7e3840359cbcd23cbf5d3918~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6bG85YS_5Lqu5Lqu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766326746&amp;x-signature=%2B2lhc8TrbFyUWA6Y4EafPIuC1E4%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GPT‑5.2 翻车？GDPval 70.9% 的“基准胜利”为何换不来好口碑？]]></title>    <link>https://juejin.cn/post/7582997593091129363</link>    <guid>https://juejin.cn/post/7582997593091129363</guid>    <pubDate>2025-12-14T15:23:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582997593091129363" data-draft-id="7583576612391190538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GPT‑5.2 翻车？GDPval 70.9% 的“基准胜利”为何换不来好口碑？"/> <meta itemprop="keywords" content="人工智能,OpenAI,AI编程"/> <meta itemprop="datePublished" content="2025-12-14T15:23:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有痣青年"/> <meta itemprop="url" content="https://juejin.cn/user/905653309947037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GPT‑5.2 翻车？GDPval 70.9% 的“基准胜利”为何换不来好口碑？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309947037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有痣青年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T15:23:42.000Z" title="Sun Dec 14 2025 15:23:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>摘要</strong>：GPT‑5.2 在 GDPval 上拿到 <strong>70.9%（wins or ties）</strong>，听起来像“职业任务碾压人类”。但网上不少开发者的体感却是：数学/编码不如上一代、输出更啰嗦、更像模板机。到底谁在胡说？答案可能是：<strong>都没胡说，只是大家在谈的不是同一件事</strong>。本文用工程视角把“基准”和“体感”对齐：基准测什么、不测什么；体感来自哪些变量；最后给你一套可以自己复现的小评测脚手架。</p>
<h2 data-id="heading-0">一、体检报告写“优秀”，你跑两步却喘——这不矛盾</h2>
<p>你一定见过这种场景：<br/>
体检报告里一排箭头都绿得发光，医生说“很健康”；<br/>
你一上楼梯，膝盖“咔哒”一下，心率像报警器，立刻怀疑人生。</p>
<p>基准与体感的冲突，本质上就是这个：<br/>
<strong>体检报告</strong>告诉你“某些指标很好”；<br/>
<strong>跑步喘息</strong>告诉你“在你关心的活动上并不舒服”。</p>
<p>所以当你看到：</p>
<ul>
<li>OpenAI 公布 GPT‑5.2 GDPval 70.9%</li>
<li>网上很多人说“体感退步、排名掉到第 8、回答像 58 条清单”</li>
</ul>
<p>别急着判谁对谁错。先问一句：他们在测的是同一件事吗？</p>
<h2 data-id="heading-1">二、GDPval 70.9% 到底在测什么？先把“口径”讲清楚，少走一半弯路</h2>
<p>GDPval 之所以让从业者兴奋，是因为它更像“上班任务”而不是“考试题”。 它的核心是：</p>
<ul>
<li><strong>任务形态</strong>：不是答题，而是交付物（文档/表格/幻灯片/多媒体等），往往还带参考文件。</li>
<li><strong>评分方式</strong>：同行专家盲评对比（pairwise preference）——更像老板看两份交付物，选更想要的那份。</li>
<li><strong>主指标口径</strong>：发布页写的是 <strong>wins or ties</strong>。也就是说 <strong>“更好或一样好”</strong> 算进了 70.9%。</li>
</ul>
<p>这三个点叠起来意味着：</p>
<blockquote>
<p>70.9% 不是“70.9% 的工作都能替代人类”，更不是“你随便问一句都能碾压”。<br/>
它更像是“在一批明确的交付任务里，模型交付物被同行专家判定为更好或不差的比例”。</p>
</blockquote>
<p>换句话说：GDPval 说的是“能交付”，不是“你会爱上它的聊天风格”。</p>
<h2 data-id="heading-2">三、那为什么体感还会翻车？因为体感的变量比基准多得多</h2>
<p>基准像实验室：温度、湿度、样本分布尽量固定。<br/>
体感像街头：下雨、堵车、你还背着电脑包。</p>
<p>下面这些变量，任何一个都足以让“体感”与“基准”背道而驰：</p>
<h3 data-id="heading-3">1）任务分布不同：你写的是“今天的工单”，基准测的是“平均职业任务”</h3>
<p>GDPval 覆盖 44 职业，强调广度。<br/>
但你所在团队可能只在 2–3 个任务类型里高频工作：比如“修一个老仓库 + 写测试 + 上线灰度”。<br/>
广度评测赢，不等于你那 20% 的高频任务赢。</p>
<h3 data-id="heading-4">2）交互方式不同：基准更像一次性交付，体感更像多轮协作</h3>
<p>很多使用场景不是“一次输出就结束”，而是：</p>
<ul>
<li>你给反馈 → 它改</li>
<li>你补上下文 → 它再改</li>
<li>你要求更短 → 它开始变长（最让人抓狂的那种）</li>
</ul>
<p>体感对“多轮可控性”高度敏感，但这类指标很难用单一基准覆盖。</p>
<h3 data-id="heading-5">3）默认风格不同：从“直接答”变成“结构化交付”，读起来就像变慢了</h3>
<p>企业喜欢“结构化、可审计、可复用”，因为这更像交付物。<br/>
但开发者在日常提问里，可能只想要一段代码或一个关键结论。<br/>
当默认输出偏向“交付物形态”，你会觉得它“啰嗦、模板化、像在写周报”。</p>
<h3 data-id="heading-6">4）推理强度与工具可用性：同一个模型名，背后可能不是同一种配置</h3>
<p>发布信息里强调不同推理强度、工具调用会显著影响效果。<br/>
如果某些指标依赖“高推理强度 + 搜索工具”，而你的使用方式是“低推理强度 + 禁用工具”，体感落差就会出现。</p>
<h2 data-id="heading-7">四、把争论落到工程：你需要的不是“相信谁”，而是“验证什么”</h2>
<p>下面这张表，我收集了这两天经常看到的对 5.2 的吐槽，并提供了对应的可验证假设：</p>



































<table><thead><tr><th>常见吐槽</th><th>可能原因（假设）</th><th>如何验证（最小实验）</th></tr></thead><tbody><tr><td>“回答更冗长”</td><td>默认模板更强、对齐偏保守、追求可审计</td><td>固定同一提示，对比 <strong>输出长度/要点密度</strong>，并记录满意度</td></tr><tr><td>“编码退步”</td><td>难度分层不同、上下文策略不同、工具链差异</td><td>选 10 个真实修复任务，比 <strong>一次通过率/返工轮次/补丁可合并率</strong></td></tr><tr><td>“数学不如以前”</td><td>推理强度档位差异、格式约束导致思路被压扁</td><td>同题不同推理强度，记录 <strong>正确率/耗时/错误类型</strong></td></tr><tr><td>“结构化过度”</td><td>输出被优化成交付物，而不是聊天</td><td>加上“只给结论 + 3 行理由”约束，看可控性是否恢复</td></tr><tr><td>“榜单第 8”</td><td>排名口径不同、采样不同、任务集不同</td><td>不争论榜单，跑你自己的任务集并公开口径</td></tr></tbody></table>
<p>工程上最常见的失败，就是把“吐槽”当事实、把“指标”当真理。<br/>
正确做法是：把它们都当成<strong>假设</strong>，然后用最小成本验证。</p>
<h2 data-id="heading-8">五、一套 30 分钟能跑完的小评测脚手架</h2>
<p>下面给一个“够用就行”的思路：<br/>
同一组任务提示，跑多个模型（或同模型不同推理强度），记录最基础的可量化指标，然后加上人工评分字段。</p>
<p>你可以把它理解为：给“体感”装上仪表盘。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
最小评测脚手架（示意）
目标：把“体感”量化成可对比的数据列
注意：模型名/参数/是否可用工具，按你自己的环境与文档为准
"""</span>

<span class="hljs-keyword">import</span> csv
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

TASKS = [
    {
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"bugfix_redis_lock"</span>,
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"给你一段Python代码（省略），偶发死锁。请定位原因并给出补丁与测试思路，输出必须先给结论再给补丁。"</span>,
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"coding"</span>,
    },
    {
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"math_proof_sketch"</span>,
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"给出一个严谨但简短的证明草稿（省略）。若不确定，请明确不确定点并给验证方法。"</span>,
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"math"</span>,
    },
    {
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"doc_summary"</span>,
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"把这份PRD压缩成一页：目标/非目标/风险/里程碑（省略）。输出不超过 220 行。"</span>,
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"doc"</span>,
    },
]

MODELS = [
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"gpt-5.2-chat-latest"</span>, <span class="hljs-string">"tag"</span>: <span class="hljs-string">"instant"</span>},
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"gpt-5.2"</span>, <span class="hljs-string">"tag"</span>: <span class="hljs-string">"thinking"</span>},
    <span class="hljs-comment"># 你也可以加上上一代/竞品做对照（模型名以你实际可用为准）</span>
]

client = OpenAI(
    api_key=os.getenv(<span class="hljs-string">"API_KEY"</span>),
    base_url=os.getenv(<span class="hljs-string">"BASE_URL"</span>),  <span class="hljs-comment"># 用OpenAI兼容入口时填写</span>
)

rows = []
<span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> MODELS:
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> TASKS:
        start = time.time()
        resp = client.chat.completions.create(
            model=m[<span class="hljs-string">"name"</span>],
            messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: t[<span class="hljs-string">"prompt"</span>]}],
        )
        text = resp.choices[<span class="hljs-number">0</span>].message.content <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
        elapsed = time.time() - start

        rows.append(
            {
                <span class="hljs-string">"model"</span>: m[<span class="hljs-string">"name"</span>],
                <span class="hljs-string">"tag"</span>: m[<span class="hljs-string">"tag"</span>],
                <span class="hljs-string">"task_id"</span>: t[<span class="hljs-string">"id"</span>],
                <span class="hljs-string">"task_type"</span>: t[<span class="hljs-string">"type"</span>],
                <span class="hljs-string">"elapsed_sec"</span>: <span class="hljs-built_in">round</span>(elapsed, <span class="hljs-number">2</span>),
                <span class="hljs-string">"output_chars"</span>: <span class="hljs-built_in">len</span>(text),
                <span class="hljs-comment"># 人工评分字段：跑完后回填</span>
                <span class="hljs-string">"pass_fail"</span>: <span class="hljs-string">""</span>,
                <span class="hljs-string">"readability_1_5"</span>: <span class="hljs-string">""</span>,
                <span class="hljs-string">"notes"</span>: <span class="hljs-string">""</span>,
            }
        )

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"mini_eval.csv"</span>, <span class="hljs-string">"w"</span>, newline=<span class="hljs-string">""</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
    writer = csv.DictWriter(f, fieldnames=rows[<span class="hljs-number">0</span>].keys())
    writer.writeheader()
    writer.writerows(rows)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"done -&gt; mini_eval.csv"</span>)
</code></pre>
<p>这段脚手架不高级，但它完成了最关键的事：<br/>
让你能把“我感觉它更啰嗦/更慢/更不靠谱”变成 <strong>elapsed / output_chars / pass_fail / readability</strong> 这些能讨论的数据列。</p>
<h2 data-id="heading-9">六、结语：基准不是神谕，体感也不是判决书——你的任务集才是</h2>
<p>网上的争论很热闹，但你要做的是交付。<br/>
对从业者最稳的一条路是：</p>
<ul>
<li><strong>用公开基准理解趋势</strong>（它告诉你“可能在哪些能力上变强”）</li>
<li><strong>用自家任务集做最终决策</strong>（它告诉你“对你有没有用”）</li>
</ul>
<p>当你把“体感”变成数据，把“指标”放回口径里，争论就会突然安静下来——因为你不再需要站队，你只需要验收。</p>
<hr/>
<h2 data-id="heading-10">参考资料（公开可核查）</h2>
<ul>
<li>OpenAI：Introducing GPT‑5.2（中文）：<code>https://openai.com/zh-Hans-CN/index/introducing-gpt-5-2/</code></li>
<li>OpenAI：GDPval：<code>https://openai.com/index/gdpval/</code></li>
<li>OpenAI：GDPval 论文（PDF）：<code>https://cdn.openai.com/pdf/d5eb7428-c4e9-4a33-bd86-86dd4bcf12ce/GDPval.pdf</code></li>
<li>OpenAI Evals：<code>https://evals.openai.com/</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[利用周末写一个小工具：多设备预览图生成]]></title>    <link>https://juejin.cn/post/7582997593090801683</link>    <guid>https://juejin.cn/post/7582997593090801683</guid>    <pubDate>2025-12-14T12:23:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582997593090801683" data-draft-id="7583215836690399273" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="利用周末写一个小工具：多设备预览图生成"/> <meta itemprop="keywords" content="后端,Go,开源"/> <meta itemprop="datePublished" content="2025-12-14T12:23:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Vespeng"/> <meta itemprop="url" content="https://juejin.cn/user/3903735809971451"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            利用周末写一个小工具：多设备预览图生成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3903735809971451/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Vespeng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T12:23:00.000Z" title="Sun Dec 14 2025 12:23:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>起因是这样的，每次在调整完自己网站的时候，对于一些 UI 样式的调整，都需要提交代码并构建好后，通过第三方的预览图生成网站或者手动修图来制作一个网站预览图并重新上传提交代码。
这样似乎有些繁琐了，尝试寻求一个完美的工具来达到这个目的，但在 github 上寻一圈未果，所以就利用这个周末去写一个简单的工具来实现这个需求。</p>

<h2 data-id="heading-0">效果图</h2>
<p>先来预览下效果图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca85546bef1c44489a2b93c2c7cbea73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmVzcGVuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319780&amp;x-signature=RldKCu9Ak1gow8ZkP5pku9xMC4U%3D" alt="preview.png" loading="lazy"/></p>
<h2 data-id="heading-1">需求分析</h2>
<ol>
<li>收集多设备的外壳图片素材，必须带有透明通道，方便后续图片的合并</li>
<li>获取设备图片的屏幕尺寸（宽·高），截图的大小需贴合设备图片的尺寸</li>
<li>获取网页截图，需根据设备 UA 进行读取网页（这里使用 <code>chromedp</code>），然后裁剪成设备屏幕的尺寸</li>
<li>创建一个大的画布，将截图贴到画布上，接着将设备图片贴到截图上（这里需要考虑设备最终在画布上的坐标位置）</li>
<li>考虑 IPhone 设备的四角非直角，所以需要特殊处理下，将设备图片的圆角部分进行裁剪</li>
</ol>
<h2 data-id="heading-2">实现思路</h2>
<ul>
<li>素材获取： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmockuphone.com%2Ftype%2Fall%2F" target="_blank" title="https://mockuphone.com/type/all/" ref="nofollow noopener noreferrer">mockuphone.com/type/all/</a></li>
<li>图片裁剪： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zaixianps.cc%2Fps%2F" target="_blank" title="https://www.zaixianps.cc/ps/" ref="nofollow noopener noreferrer">www.zaixianps.cc/ps/</a></li>
<li>图片大小调整： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.iloveimg.com%2Fzh-cn%2Fresize-image" target="_blank" title="https://www.iloveimg.com/zh-cn/resize-image" ref="nofollow noopener noreferrer">www.iloveimg.com/zh-cn/resiz…</a></li>
</ul>
<h3 data-id="heading-3">Step 1</h3>
<p>利用 <code>chromedp</code> 包，读取本机带有 Chromium 内核的浏览器，初始化浏览器分配上下文，采用无头模式</p>
<p><em>ps：这里仅展示核心逻辑，完整代码请下滑到最底移步到 github 仓库查看</em></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 初始化浏览器分配器上下文</span>
browserPath, err := <span class="hljs-string">"C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe"</span>
opts := <span class="hljs-built_in">append</span>(chromedp.DefaultExecAllocatorOptions[:],
    chromedp.ExecPath(browserPath),
    chromedp.NoFirstRun,
    chromedp.NoDefaultBrowserCheck,
    chromedp.Headless,
)
allocCtx, cancel := chromedp.NewExecAllocator(context.Background(), opts...)
<span class="hljs-keyword">defer</span> cancel()
</code></pre>
<p>并发读取网页，获取网页截图</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">takeScreenshotForDevice</span><span class="hljs-params">(ctx context.Context, url <span class="hljs-type">string</span>, width, height <span class="hljs-type">int</span>)</span></span> (*image.RGBA, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">var</span> buf []<span class="hljs-type">byte</span>
    
    err := chromedp.Run(ctx,
        chromedp.EmulateViewport(<span class="hljs-type">int64</span>(width), <span class="hljs-type">int64</span>(height)),
        chromedp.Navigate(url),
        chromedp.Sleep(<span class="hljs-number">3</span>*time.Second),
        chromedp.WaitVisible(<span class="hljs-string">"body"</span>, chromedp.ByQuery),
        chromedp.CaptureScreenshot(&amp;buf),
    )
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }

    img, _, err := image.Decode(bytes.NewReader(buf))
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }

    bounds := img.Bounds()
    rgba := image.NewRGBA(bounds)
    draw.Draw(rgba, bounds, img, bounds.Min, draw.Src)

    <span class="hljs-keyword">return</span> rgba, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-4">Step 2</h3>
<p>创建画布</p>
<pre><code class="hljs language-go" lang="go">canvas := imaging.New(<span class="hljs-number">2560</span>, <span class="hljs-number">1600</span>, color.White)
</code></pre>
<h3 data-id="heading-5">Step 3</h3>
<p>遍历所有截图并贴入画布，同时将设备外壳覆盖到截图上</p>
<p><em>ps：这里逻辑取值较复杂，故省略代码</em></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">for</span> _, dev := <span class="hljs-keyword">range</span> Devices {
    ...
    <span class="hljs-comment">// 读取设备图片</span>
    ...

    <span class="hljs-comment">// 解码图片数据</span>
    ...

    <span class="hljs-comment">// 转换为 RGBA 格式以便绘制</span>
    ...

    <span class="hljs-comment">// 将外壳覆盖到画布的对应位置（LayoutX/Y）</span>
    ...
}
</code></pre>
<h3 data-id="heading-6">Step 4</h3>
<p>保存并输出</p>
<pre><code class="hljs language-go" lang="go">outFile := <span class="hljs-string">"output/preview.png"</span>

f, err := os.Create(outFile)
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-built_in">panic</span>(err)
}
<span class="hljs-keyword">defer</span> f.Close()

<span class="hljs-keyword">if</span> err := png.Encode(f, canvas); err != <span class="hljs-literal">nil</span> {
    <span class="hljs-built_in">panic</span>(err)
}

fmt.Println(<span class="hljs-string">"预览图生成成功:"</span>, outFile)
</code></pre>
<h2 data-id="heading-7">总结</h2>
<p><strong>复杂点</strong>：</p>
<ul>
<li>设备在画布中的位置计算，以及截图的裁剪位置计算</li>
<li>设备图片的圆角处理，这里用 ai 给的代码做了处理，也算是被 ai 坑了一回，四角虽做了处理，但是并没有透明化，也是耗费了很长时间才弄懂图片透明逻辑的处理</li>
</ul>
<p><strong>不足点</strong>：</p>
<ul>
<li>访问页面未设置超时，对于一些网站访问会比较慢，可能会导致卡死，不过访问本地页面处理速度还是很快的，这里后续有时间优化下</li>
<li>截图有时候内容会加载不全，问题同上</li>
</ul>
<p><strong>最后</strong>：</p>
<p>源码已上传至 github 仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvespeng%2Fmulti-device-preview%2F" target="_blank" title="https://github.com/vespeng/multi-device-preview/" ref="nofollow noopener noreferrer">GitHub - vespeng/multi-device-preview</a>，欢迎 fork 和 star。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙开发：上架困难？谈谈我的上架之路]]></title>    <link>https://juejin.cn/post/7583260493852262441</link>    <guid>https://juejin.cn/post/7583260493852262441</guid>    <pubDate>2025-12-15T02:26:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493852262441" data-draft-id="7583284454165954579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙开发：上架困难？谈谈我的上架之路"/> <meta itemprop="keywords" content="HarmonyOS,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-15T02:26:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员一鸣"/> <meta itemprop="url" content="https://juejin.cn/user/1398234520239095"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙开发：上架困难？谈谈我的上架之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234520239095/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员一鸣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T02:26:04.000Z" title="Mon Dec 15 2025 02:26:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>公众号的一篇文章，只是感叹了一下目前的审核越来越难，但没想到意外的火了，已经超过了10万+的阅读，看来关于上架的事，并不是我一个人在关注。</p>
<p>几百条的评论中，充斥着浓浓的火药味，有的人觉得，做为消费者应该挺官方，只有严格把控，生态体验才会越来越好；有的人则认为，既然要发展生态，就不该卡的那么严，否则，谁还会融入生态；从一条条的评论中，可以看到，大部分人的观点还是比较正向且积极的，我也是非常的赞同，毕竟软件的质量，决定着未来生态的好坏。</p>
<p>临近月底，离活动结束可以说是越来越近，那么针对软件的质量，早已不是生态初始的野蛮生长，而是兼顾着UI的美感，功能的特点，功能的深度而讨论，若还是简单的几个页面或者功能，肯定会被驳回，这一点毋庸置疑，毕竟现在的鸿蒙应用已经非常丰富，并不缺乏单一的应用。</p>
<p>我的第一款应用上架时，历经了六次驳回，而现在的第二款应用，也经历了五次驳回，所以，做为一名开发者而言，心态真的很重要，多次的驳回，真的会造成情绪激动，进而会慢慢的放弃，越到这个时候，就越要有足够的强大心里支撑自己，相信总会有一次，满足上架的要求，也就是所说的越挫越勇。</p>
<p>就拿我现在的第二款应用而言，谈一谈，它的曲折上架之路吧，希望可以帮助到正在上架应用的你。</p>
<p>为什么要拿第二款而谈，因为它刚刚上架，正好戳破了一些认为华为审核指标已超的谎言，可见，目前除了严格之外，符合上架的应用，还是允许上架，允许拿到激励的，所以，大家手里有完善的应用，可以尽情的提交。</p>
<p>首先谈一谈，第一方面，也就是著名的3.5规则。</p>
<h2 data-id="heading-1">3.5规则，功能深度完善</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2670d4fbe3b94c8dab6cee43847aeaeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370364&amp;x-signature=XqaDixKuBdkFrzVZED8oK9WzR0U%3D" alt="" loading="lazy"/></p>
<p>相信大家被拒绝最多的就是著名的3.5规则，也就是缺乏交互设计和功能深度，我也一直被深深刺痛，明明感觉功能还行啊，很丰富啊，为什么还会频繁拒绝呢？这种声音，可以说一直在耳边不断的循环。</p>
<p>我的第二款应用是一款猜谜语类型的应用，做为一个个人开发者，如果让大家去做，该怎么去做呢？</p>
<p>一开始，我的想法是，不就是猜谜语吗，无非就是有大量的谜语，然后展示谜面，让大家去猜答案，在整个排行榜，这不就行了，我也设计了一些相对好看的UI，第一版的完成效果如下：</p>
<p>五个主tab展示如下，一个一个展示有点多，合并了一下，首先是前三个：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b7d142f1759477695afe403ff66ad88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370364&amp;x-signature=08%2FNsKdwSoXfF48a9ZtKbU4vA8Q%3D" alt="" width="70%" loading="lazy"/></p>
<p>后两个如下：（排行榜第3名，他的头像就是白色的）</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f78ec7d7c3b84bf78955096d447ef542~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370364&amp;x-signature=Wtmv5Ebe6GRhh%2F%2BK64IeGsBVkCA%3D" alt="" width="70%" loading="lazy"/></p>
<p>除了主页面，二级页面，也粘贴几个，给大家浏览一下：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7a72f1578db4f3e87932e92b0ffeab6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370364&amp;x-signature=zC48hMY3EARPWZA0bdm4tsfuWeM%3D" alt="" width="70%" loading="lazy"/></p>
<p>并且主页，我也做两个动画：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6218740e214543be8aa0783d530409be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370364&amp;x-signature=kz%2FO1L3xm4TtSj4xhgjF4NpKG1A%3D" alt="" width="50%" loading="lazy"/></p>
<p>还有很多的页面和功能，这里就不做展示了，做为一个个人开发者，做出以上的效果，应该还凑合吧，并不很差吧，毕竟只是一个猜谜语类型的应用，有大量的谜库，还分了很多种类，并且还区分了简单，中级，困难，也有兴趣挑战，登录功能，排行榜，并且还支持贡献谜语，我觉得十分丰富了，基本上是一个成熟的应用了，但是，您猜怎么着？直接被拒，理由就是3.5。</p>
<p>从UI搭建，到后台接口开发，再到App开发，全都是自己利用下班时间完成的，可以说付出了大量的时间和精力，直接一句功能深度有待完善就拒绝了，当时的我，可以说情绪已经很激动了，一个猜谜语类型的应用，我还怎么丰富功能？后面平息了心情之后，也能理解官方了，应用做的功能确实单一，虽然功能多，但都是基本的猜谜语，丰富性确实有待提高。</p>
<p>后面，陆陆续续，又增加了很多功能，比如谜语知识，趣味挑战，闯关挑战，可以说在之前的单一猜谜语基础之上，又增加趣味的挑战游戏，也增加了关于谜语的相关知识，寓教于乐，可以说功能上又进一步完善了，但是第2次提交，第3次提交，第4次提交，仍然被拒，理由同样是3.5。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51f2da5e3d046c49f5557f1b6734a8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370364&amp;x-signature=Ry03gx%2FjE6aWPYClNAhmU5VX9M4%3D" alt="" width="70%" loading="lazy"/></p>
<p>如果，经历了4次提交被拒，大家的心情是什么样的，是不是开始骂官方了，当然，我也有那么一丝冲动，功能加了又加，改了又改？还不够完善吗？毕竟市场上的同类型应用，其功能丰富度远远不及我啊？但吐槽归吐槽，该改还是改，毕竟临近活动结束，要求肯定是越来越严，这一点，仍然选择站官方。</p>
<p>于是，就开启了我的第五次修改之路，摒弃了传统的思维，拓展了一个儿童专区，专门为儿童服务，设计了儿童闯关谜语，除此之外，还借用了开源项目，新增了儿童学数学，学诗词，学识字功能，这一次，增加的功能可谓是十分丰富。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/662f2ab9ccf34d5a841f13387c6b8f5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370364&amp;x-signature=3In1KoLzyd%2BoehB7gx8E2NJUTJI%3D" alt="" width="70%" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5d0fe176fd2459fb58ddb724a6490c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370364&amp;x-signature=%2BurHmBK7kf%2B0uKUfHICQeq4FFNg%3D" alt="" width="70%" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2398d150403404b8ca7bd5ef0d00c96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370364&amp;x-signature=jJdcmQKyBbAduYAGycRU71JXLW8%3D" alt="" width="70%" loading="lazy"/></p>
<p>增加了儿童专区之后，终于审核通过了！从原来的单一猜谜语，到中间的趣味猜谜语，再到最后的儿童谜语专区，可以说功能变得越来越丰富，越来越具有趣味性，所以，有时，不能只抱怨官方的严格，而是要学会理解，从自身去找原因，要不是官方的严格，这些后续的功能，我还真未必能够拓展。</p>
<h2 data-id="heading-2">心态最重要</h2>
<p>如果功能比较单一，被拒五六次，甚至七八次，都很正常，毕竟现在的鸿蒙早已过了野蛮生长期，追求的是软件的质量，所以，大家应该保持对软件的丰富，从自身软件的特点，举一反三的拓展功能，使其能够满足用户体验，不要气馁，要越战越勇。</p>
<p>当然了，还是希望，每次提交之前，也自身排查一下功能，UI是否满足正常的用户使用，这样就可以规避审核的时间，和被拒的次数。</p>
<h2 data-id="heading-3">相关总结</h2>
<p>目前的官方仍然会放开好的应用，并没有因为活动临近结束而拒绝所有，所以，如果你的应用如果足够有特色，功能足够丰富，仍然能够获得上架，领取激励的机会，不要灰心，还有时间，一切都来得及。</p>
<p>好的生态，才能走的越远，希望大家都能理解官方，被拒未必是坏事，正所谓，好事多磨；预祝所有的开发者，都能够上架自己的应用。</p>
<p>最后，如果您也喜欢猜谜语，不妨体验一下我的这款应用【趣谜语】，希望能给你带来不一样的体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE CN 实战：从 API 文档到可复用服务的自动化探索]]></title>    <link>https://juejin.cn/post/7583598943070666787</link>    <guid>https://juejin.cn/post/7583598943070666787</guid>    <pubDate>2025-12-15T02:24:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583598943070666787" data-draft-id="7583469866008444963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE CN 实战：从 API 文档到可复用服务的自动化探索"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-15T02:24:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE CN 实战：从 API 文档到可复用服务的自动化探索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T02:24:42.000Z" title="Mon Dec 15 2025 02:24:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/439627ec63f6430f8fdfbdf38c07a1af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=bolo19CQ8uA70ixt%2By%2FvmfGOR6Q%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：茉卷，TRAE 开发者用户</p>
</blockquote>
<p>在日常开发中，我们经常会遇到这样的场景：产品经理给你一份 API 文档或者一段 curl 示例，然后你需要：</p>
<ul>
<li>
<p>写请求封装代码（Service 层）</p>
</li>
<li>
<p>搭建临时测试页面（UI 层）</p>
</li>
<li>
<p>处理各种边界情况和错误展示</p>
</li>
</ul>
<p>这些工作本质上很机械，却又是开发流程中无法跳过的环节。每次都要手动写一遍，既耗时又容易出错。</p>
<p>如果有一种方式，能让 AI 帮我们完成这些重复劳动，把“一次性的 API 调用”变成“工具箱里的通用积木”，会怎么样？</p>
<p>本文将通过一个具体案例来展示这个过程：</p>
<ul>
<li>
<p>在扣子（Coze）里搭一个 <strong>“飞书群通知”工作流；</strong></p>
</li>
<li>
<p>然后用  TRAE CN SOLO：</p>
<p>读懂这份 workflow API 文档；</p>
<p>自动生成一个 <strong>可复用的工作流服务</strong>（<em><strong>workflowService</strong></em>）；</p>
<p>顺手生成一个  <strong>React UI 测试界面</strong>，用来给飞书机器人发消息。</p>
</li>
</ul>
<p><strong>扣子 + 飞书机器人 只是业务场景，真正的主角是 TRAE：</strong></p>
<p>让我们看看 TRAE 是如何把这个过程从“手工作坊”变成“自动化生产线”的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7765a00787cf46cab8289c2829a9ea50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=GXG8jV%2FP14k21qi9qKFd2VyEpqc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>场景搭建：扣子 + 飞书机器人</strong></h2>
<h3 data-id="heading-1"><strong>1.1 扣子：快速生产"后端服务"的工厂</strong></h3>
<p>扣子（Coze）是一个低代码智能体平台，它的核心能力是：通过拖拽节点和简单配置，快速搭建智能工作流，并将其封装成 HTTP API 对外开放。</p>
<p>你可以把它理解成一个“后端服务工厂”——不需要写代码，就能生产出可用的 API 接口。</p>
<p>在本文的案例中，我们要搭建的工作流非常简单：</p>
<ul>
<li>
<p><strong>输入：</strong> 一个字符串 <em><strong>input</strong></em>（要发送到飞书群里的内容）；</p>
</li>
<li>
<p><strong>中间步骤：</strong> 调用飞书自定义机器人 webhook；</p>
</li>
<li>
<p><strong>输出：</strong> 把飞书调用的结果放在 <em><strong>content</strong></em> 字段里返回。</p>
</li>
</ul>
<p>扣子会把整个 workflow 暴露成一个 HTTP 接口，我们稍后会交给 TRAE：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">curl -X POST <span class="hljs-comment">'https://api.coze.cn/v1/workflow/stream_run' \</span>
-H <span class="hljs-string">"Authorization: Bearer YOUR_TOKEN"</span> \
-H <span class="hljs-string">"Content-Type: application/json"</span> \
-d <span class="hljs-comment">'{</span>
  <span class="hljs-string">"workflow_id"</span>: <span class="hljs-string">"7577226183415316506"</span>,
  <span class="hljs-string">"parameters"</span>: {
    <span class="hljs-string">"input"</span>: <span class="hljs-string">"你好！"</span>
  }
}<span class="hljs-comment">'</span>
</code></pre>
<p>其中的关键参数包括：</p>
<ul>
<li>
<p>Bearer：扣子平台的访问 Token（字符串，需保密）；</p>
</li>
<li>
<p>workflow_id：工作流 URL 中 <em><strong>workflow_id=</strong></em> 后面的那段字符串；</p>
</li>
<li>
<p>input：我们要发送到飞书群的消息内容。</p>
</li>
</ul>
<p>工作流执行成功后，会返回类似这样的结构：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"usage"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"token_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"output_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"input_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"node_is_finish"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{"</span>code<span class="hljs-string">":0,"</span>log_id<span class="hljs-string">":"</span><span class="hljs-number">20251127111551</span>A90DF8D30A0605075D70<span class="hljs-string">","</span>msg<span class="hljs-string">":"</span>success<span class="hljs-string">"}"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"node_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">900001</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"node_execute_uuid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"node_seq_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"node_title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"End"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"node_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"End"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>我们真正关心的是 <em><strong>content</strong></em> 里的 JSON 字符串：</p>
<p>{"code":0,"msg":"success", ...}，它告诉我们这次飞书推送是否成功。</p>
<h3 data-id="heading-2"><strong>1.2 飞书群与自定义机器人</strong></h3>
<p>为了让扣子工作流有地方“发消息”，我们需要在飞书中完成以下准备工作：</p>
<ul>
<li>
<p>一个飞书群；</p>
</li>
<li>
<p>群里配置好一个  <strong>自定义机器人</strong>，拿到对应的 <strong>Webhook 地址</strong>。</p>
</li>
</ul>
<p>操作步骤：</p>
<ul>
<li>在飞书左上角点击 <strong>「+」→ 创建群组</strong>；</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f4f42a20c724fc1b83399fca157d4e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=zLeTBUsBD0WYeHdgHAAmtqnmxzE%3D" alt="" loading="lazy"/></p>
<ul>
<li>群模式选择「对话」，给群起一个名字（如“测试飞书机器人”）；</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f946458363f46698ea9a13a23d4f96d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=jDfum6x6Tq4TxdIkDYcN1xjXb2M%3D" alt="" loading="lazy"/></p>
<ul>
<li>进入群设置 → 找到 <strong>「群机器人」</strong>；</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7a9af36ae204a60b68060e32e29fa38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=jaLxewcpZ88FOXnuFIm%2Bsgj3kL0%3D" alt="" loading="lazy"/></p>
<ul>
<li>添加机器人 → 选择「自定义机器人」；</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06935be6d580435c95f913334202aaad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=2ZHmzTzbyagIfdLcc8w7uB3Pi2M%3D" alt="" loading="lazy"/></p>
<ul>
<li>选一个头像、名字，点击添加，复制 Webhook 地址。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0983da26613e4d528b89770b50643e3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=SUY9%2FTj6rIgDpmuSW%2Bv63hnZsJc%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1bdb1de81b04968b41a30f80f9b63d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=48Y%2BTdMCM2vJwmW817D%2Bu1Z%2BWcM%3D" alt="" loading="lazy"/></p>
<p>这个 Webhook 会被配置在扣子的 workflow 里，用于把消息真正发进群。</p>
<p>至此，我们的“消息接收端”就准备好了。接下来要做的，就是在扣子中把这个 Webhook 串联进工作流。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5cb91b94f864bdf9b07ad0d40b7cc3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=zH91dO9Hlf74XA4AQCsqJqBExm8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>在扣子中搭建工作流</strong></h2>
<p>这一部分的目标很明确：<strong>产出一个稳定可用的 workflow API，供后续 TRAE 调用。</strong></p>
<h3 data-id="heading-4"><strong>2.1 创建工作流并添加「飞书消息」插件</strong></h3>
<p><strong>1.</strong> 在扣子工作流界面中创建一个新的工作流：</p>
<ul>
<li>
<p>给它起个名字，例如「飞书群通知」；</p>
</li>
<li>
<p>简单写一下描述（例如“接收文本输入，发送到飞书自定义机器人”）。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ef38805bc3f44b09f70a03b71b55014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=TELaSY4hCmtIeMCm%2FHH4FOAajqQ%3D" alt="" loading="lazy"/></p>
<p><strong>2.</strong> 在工作流中添加官方插件：「飞书消息」：</p>
<ul>
<li>选择动作：<em><strong>send_webhook_message</strong></em>（使用飞书自定义机器人 webhook 发送消息）。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75756ab2bc6046c3b29451d155a3b13b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=0HsZa25y0zrxDaRle5JcAnEpdt4%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ad23fb6802544ccbde722d2e43a3729~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=g2eA9bbV5BBmXkPM346ioamADCo%3D" alt="" loading="lazy"/></p>
<p>此时工作流包含三个核心节点：</p>
<ul>
<li>
<p><em><strong>开始</strong></em> 节点：接收一个 <em><strong>input</strong></em> 字段；</p>
</li>
<li>
<p><em><strong>飞书消息</strong></em> 节点：调用 webhook；</p>
</li>
<li>
<p><em><strong>结束</strong></em> 节点：把结果返回出去。</p>
</li>
</ul>
<h3 data-id="heading-5"><strong>2.2 配置节点与数据流</strong></h3>
<p><strong>第一步：连接节点</strong></p>
<p>将 <em><strong>开始</strong></em> → <em><strong>飞书消息</strong></em> → <em><strong>结束</strong></em> 三个节点顺序连接起来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/629c61001243495085c9767b47b96a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=A2TsKnwxdKSu1KKQksVHaNVVaxw%3D" alt="" loading="lazy"/></p>
<p><strong>第二步：配置「飞书消息」节点</strong></p>
<ul>
<li>
<p><em><strong>content</strong></em>：选择 <em><strong>开始</strong></em> 节点的 <em><strong>input</strong></em> 作为消息内容；</p>
</li>
<li>
<p><em><strong>msg_type</strong></em>：填写字符串 <em><strong>text</strong></em>（指定发送文本消息）；</p>
</li>
<li>
<p><em><strong>webhook</strong></em>：填写前面在飞书群里复制的 Webhook 地址。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eae742556cd4905bcb4c2439e349faa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=cxvS9rJMWoyZDuKsMQsIG61vTrQ%3D" alt="" loading="lazy"/></p>
<p><strong>第三步：配置「结束」节点输出</strong></p>
<ul>
<li>
<p>删除默认输出变量；</p>
</li>
<li>
<p>把「飞书消息」节点的几个关键输出字段（例如 code、msg、log_id 等）逐一添加为结束节点的输出。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8c0db8cdf1d43df9a808dd2add18bf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=P4fcprGsySDTsGG0vP9YKIf67nA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6"><strong>2.3 试运行与发布</strong></h3>
<p><strong>1.</strong> 点击工作流下方的「试运行」：</p>
<ul>
<li>
<p>在 <em><strong>input</strong></em> 中输入任意内容，如「你好」；</p>
</li>
<li>
<p>运行后，确认：</p>
<p>工作流执行成功；</p>
<p>飞书群中机器人成功发出这条消息。</p>
</li>
</ul>
<p><strong>2.</strong> 验证无误后，点击右上角「发布」：</p>
<ul>
<li>发布成功后，这个工作流就可以通过 API 访问了。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d6c9b9d58ed420985995358f9c5ff7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=WUhBJ8m67rue4CGtEht6RSjwe6c%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7870c963ff0d413e8105d3758aa1db85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=kOAINtWepPYYYeT9Zlo8FZqxuNE%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a996591ef824949b5b3059dc52f0139~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=G%2BI584Rs%2BHKh9449V%2FQLnCNBP6U%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7"><strong>2.4 在 Playground 中查看 API 调用示例</strong></h3>
<p>发布后，在工作流界面的右上角点击「...」，选择 「API」：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f96f9633f0544bca5627fb060108983~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=pbCF1lhwaKLXHW8DLVaWc3tX42w%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>可以看到一段官方提供的 <em><strong>curl</strong></em> 示例；</p>
</li>
<li>
<p>包含 <em><strong>workflow_id</strong></em>、请求路径、Authorization 头等信息。</p>
</li>
</ul>
<p><strong>这段 curl 示例就是我们后面要交给 TRAE 的“原材料”。</strong> TRAE 会根据这个示例，自动生成完整的 Service 层代码和测试 UI。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04e1466fecb844579faab6a9106a4658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=AUcMuQmE2cwnGlaI21i%2BBr%2Bmyfk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8"><strong>用 TRAE 生成可复用服务</strong></h2>
<p>接现在进入本文的核心环节：<strong>让 TRAE 替我们完成从 API 文档到可运行代码的全过程。</strong></p>
<h3 data-id="heading-9"><strong>3.1 给 TRAE 的需求说明</strong></h3>
<p>在 TRAE CN SOLO 中，我们可以用自然语言描述需求（伪代码式说明）：</p>
<p>用 vite + React 实现一个可以复用的“工作流服务”：</p>
<ul>
<li>
<p>使用扣子的 workflow API：<em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.coze.cn%2Fv1%2Fworkflow%2Fstream_run" target="_blank" title="https://api.coze.cn/v1/workflow/stream_run" ref="nofollow noopener noreferrer">api.coze.cn/v1/workflow…</a></strong></em></p>
</li>
<li>
<p>参数包括：</p>
<p><em><strong>token</strong></em>（Bearer 后面的字符串，由用户输入）；</p>
<p><em><strong>workflow_id</strong></em>（固定字符串，由用户输入或写死）；</p>
<p><em><strong>input</strong></em>（要发给飞书机器人的消息内容）；</p>
</li>
<li>
<p>调用成功后，把 workflow 的返回结果展示在 UI 上。</p>
</li>
<li>
<p>请同时：</p>
</li>
<li>
<p>封装一个独立的 <em><strong>workflowService</strong></em>，便于后续复用；</p>
</li>
<li>
<p>生成一个简单的 React UI 页面，用于测试调用这个 service。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa1a04ed39ff45cea1e842dd8ab8a153~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=wMEl70tthFCMvD5m36kK%2FVx1FBQ%3D" alt="" loading="lazy"/></p>
<p>这里有两个关键设计：</p>
<ul>
<li>
<p><strong>关注“可复用服务”：</strong> 不是写一个一次性 Demo，而是一个可以放进工具箱的 Service；</p>
</li>
<li>
<p><strong>要求生成测试 UI：</strong> 方便我们在浏览器里手动输入参数、反复测试。</p>
</li>
</ul>
<h3 data-id="heading-10"><strong>3.2 第一版：能跑，但有问题</strong></h3>
<p>TRAE 按照说明，通常会输出两部分代码：</p>
<ul>
<li>
<p>一个封装好的 <em><strong>workflowService</strong></em>（例如 <em><strong>workflowService.js</strong></em> / <em><strong>workflowService.ts</strong></em>）；</p>
</li>
<li>
<p>一个简单的 React 页面（带表单和按钮），用来：</p>
<p>输入 <em><strong>token</strong></em>、<em><strong>workflow_id</strong></em>、<em><strong>input</strong></em>；</p>
<p>点击按钮后调用 workflow；</p>
<p>在页面上展示调用结果。</p>
</li>
</ul>
<p>第一版跑起来后，界面是这样的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8015f4d5c8664425ab085a2673b70742~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=PpenvEobqUYvgNtKlTCc0f3NhJA%3D" alt="" loading="lazy"/></p>
<p><strong>1.</strong> 在 UI 中填入：</p>
<ul>
<li>Token;</li>
<li>Workflow ID ;</li>
<li>要发送的文本内容；</li>
</ul>
<p><strong>2.</strong> 点击「运行工作流」；</p>
<p><strong>3.</strong> 浏览器发起请求，收到扣子返回的数据。</p>
<p>这时，我们遇到一个问题：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb116074323641c98fc9745c0f575ad0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=WMPWoDpLE5A4TiBNJhPCjWU%2BLVA%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>TRAE 以为 <em><strong>content</strong></em> 是一个对象；</p>
</li>
<li>
<p>实际上 <em><strong>content</strong></em> 是一个 JSON 字符串，需要再 <em><strong>JSON.parse</strong></em> 一次。</p>
</li>
</ul>
<p>结果就是：第一版运行时在控制台报错，解析失败。（可以理解，因为我们没有把输出数据的结构明确告知 AI）</p>
<h3 data-id="heading-11"><strong>3.3 错误驱动迭代：让 TRAE 自我修复</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3594b9db6794d77a38085c06f98cba2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=yghTXN%2FmaWPiryd7fyzxFF4bDMA%3D" alt="" loading="lazy"/></p>
<p>这一点其实是 TRAE 的“爽点”：</p>
<ul>
<li>
<p>在真实开发里，你也不可能一次就完全猜对返回结构；（不用猜，会有详细的返回数据类型的文档）</p>
</li>
<li>
<p>好在我们可以：</p>
<p>把 TRAE 浏览器里报错的 stack trace 复制出来；</p>
<p>再把提示词一起贴给 TRAE；</p>
<p>让它 <strong>根据真实错误和真实数据结构自动修复代码。</strong></p>
</li>
</ul>
<p>例如你可以这样对 TRAE 说：</p>
<p>刚才你生成的代码在解析返回时出错了，报错信息是：</p>
<p><em><strong>TypeError: Cannot read properties of undefined (reading 'code')</strong></em></p>
<p>实际返回的完整数据结构如下（贴 JSON）……</p>
<p>请根据真实结构修正 <em><strong>workflowService</strong></em> 和 UI 中的解析逻辑，确保：</p>
<ul>
<li>
<p>能正确解析 <em><strong>content</strong></em> 字段里的 JSON 字符串；</p>
</li>
<li>
<p>在 UI 上显示 <em><strong>code</strong></em> 和 <em><strong>msg</strong></em>；</p>
</li>
<li>
<p>遇到错误时给出清晰的提示信息。</p>
</li>
</ul>
<p>TRAE 做出了下面的修改：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22c2f431981847319fea81a54a6f151e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=R%2BgZEyFymSEe7nuUqktb7nR59wQ%3D" alt="" loading="lazy"/></p>
<p>再次运行后，只要飞书那边配置无误，就可以看到运行成功了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c8d67ebb66241148eaed42199a8e634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=qrExVEfa1wQxaHYNNYQ%2Be6AOa5c%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e701ca8154a246468e5bc792e9ea725a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=NgkUckxN5EghpE5Vr3RAn9rbzuo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12"><strong>3.4 沉淀为工具：workflowService 变成工具箱里的积木</strong></h3>
<p>在多轮迭代之后，我们会得到一个相对稳定的服务封装，例如：</p>
<p>一个函数 <em><strong>runWorkflow({ token, workflowId, input })：</strong></em></p>
<ul>
<li>
<p>内部封装了：</p>
<p>请求 URL；</p>
<p>请求头（Authorization / Content-Type）；</p>
<p>请求体格式；</p>
<p>返回结果解析和错误处理；</p>
</li>
<li>
<p>返回一个结构化的结果对象（例如 **<em>{ code, msg, raw }</em> **）。</p>
</li>
</ul>
<p>这就是本文想要强调的「工具」：</p>
<ul>
<li>
<p><strong>对前端而言：</strong></p>
<p>任何页面只要引入 workflowService，就能一键调用这个扣子 workflow；</p>
<p>UI 部分可以自由组合：按钮、表单、对话框都行。</p>
</li>
<li>
<p><strong>对多端而言：</strong></p>
<p>这个服务的“调用协议”已经厘清了；</p>
<p>你可以用同样的协议，在 React / Swift / Android / Python 中各写一份同构封装。</p>
</li>
</ul>
<p>TRAE 在这里做了两件关键的事：</p>
<ul>
<li>
<p><strong>加速第一次实现：</strong> 从 API 文档到可运行 Demo，节省了大量手工编码时间；</p>
</li>
<li>
<p><strong>帮你摸清边界：</strong> 通过错误驱动迭代，最终把这个 API 调用“抹平”成一个干净的服务。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8e50b200642403fa92cc19737c7df3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766370282&amp;x-signature=Rxhe03kFxm4sDoOr%2FsuxCvKxU50%3D" alt="divider04.png" loading="lazy"/></p>
<h2 data-id="heading-13"><strong>小结</strong></h2>
<p>回顾一下这整个流程：</p>
<ol>
<li>
<p>我们在扣子里搭建了一个「飞书群通知」工作流，并通过飞书自定义机器人 webhook 把消息发进群；</p>
</li>
<li>
<p>扣子把这个工作流暴露成一个 HTTP API，附带 curl 示例；</p>
</li>
<li>
<p>我们把 curl 示例和期望行为交给 TRAE，让它：</p>
<p>自动生成前端 Service（<em><strong>workflowService</strong></em>）；</p>
<p>自动生成一个测试 UI 界面；</p>
</li>
<li>
<p>在运行过程中，遇到返回解析错误，我们把错误和真实返回结构交给 TRAE，让它自动修复；</p>
</li>
<li>
<p>最终产出的 <em><strong>workflowService</strong></em> 被抽离出来，成为工具箱中的一个可复用积木。</p>
</li>
</ol>
<p><strong>TRAE 帮我们“把 API 变成工具”。</strong></p>
<p>从读懂文档、生成代码，到根据实际错误迭代修复，再到沉淀为可复用的服务，这些繁琐却关键的步骤，都是 TRAE 在背后默默完成的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5本值得精读的AI实战书籍，助你从入门到精通大模型工程（附链接）]]></title>    <link>https://juejin.cn/post/7583906846986387502</link>    <guid>https://juejin.cn/post/7583906846986387502</guid>    <pubDate>2025-12-15T02:44:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583906846986387502" data-draft-id="7583577045579841562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5本值得精读的AI实战书籍，助你从入门到精通大模型工程（附链接）"/> <meta itemprop="keywords" content="LLM,程序员,Agent"/> <meta itemprop="datePublished" content="2025-12-15T02:44:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5本值得精读的AI实战书籍，助你从入门到精通大模型工程（附链接）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T02:44:46.000Z" title="Mon Dec 15 2025 02:44:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<blockquote>
<p>在 AI 技术日新月异的今天，光靠博客和教程已远远不够。系统性学习，才是构建扎实工程能力的关键。</p>
</blockquote>
<p>随着大模型（LLM）技术从实验室走向产业落地，越来越多开发者开始关注如何<strong>真正构建、部署并优化 AI 应用</strong>。然而，面对海量信息，哪些内容值得投入时间？哪些书能带你跨越“玩具项目”与“生产级系统”之间的鸿沟？</p>
<p>我们为你精选了 <strong>5 本兼具深度与实用性的 AI 工程书籍</strong>，覆盖从底层原理到云端部署的完整知识链。无论你是刚入门的新手，还是希望进阶的工程师，这些书都值得一读。</p>
<h2 data-id="heading-0">1.  📘《AI Engineering》</h2>
<p><strong>作者：Chip Huyen（@chipro）</strong></p>
<blockquote>
<p>“这本书填补了学术研究与工业实践之间的空白。”</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c27944921fb747b8a9106f0214047a4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766371485&amp;x-signature=NLKDDvy8kRrOrpW0PFX8gmHgVWQ%3D" alt="" loading="lazy"/></p>
<p>如果你只选一本 AI 工程书，那一定是这本。 Chip Huyen 是斯坦福大学 AI 课程讲师，也是 NVIDIA 前高级工程师。她在《AI Engineering》中系统梳理了<strong>如何用基础模型（Foundation Models）构建真实世界的 AI 应用</strong>。</p>
<p>✅ 覆盖内容：</p>
<ul>
<li>AI 系统的整体架构设计</li>
<li>数据管道与版本管理</li>
<li>模型评估、监控与迭代</li>
<li>部署策略与成本优化</li>
<li>可扩展性与可靠性工程</li>
</ul>
<p>💡 适合人群：希望构建端到端 AI 产品的工程师、技术负责人。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchiphuyen%2Faie-book" target="_blank" title="https://github.com/chiphuyen/aie-book" ref="nofollow noopener noreferrer">github.com/chiphuyen/a…</a></p>
<p>🔗 官网配套资源丰富，含代码、案例与行业访谈。</p>
<h2 data-id="heading-1">2.  📗《The LLM Engineer's Handbook》</h2>
<p><strong>作者：Paul Iusztin（@iusztinpaul） &amp; Maxime Labonne（@maximelabonne）</strong></p>
<blockquote>
<p>“一本真正的 LLM 开发实战手册。”</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05dd2e45c1c04aef806347c0b7533596~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766371485&amp;x-signature=banwYG6vh3f8yA22ou3hH0rApgw%3D" alt="" loading="lazy"/></p>
<p>这本书不讲空泛理论，而是手把手教你<strong>从数据准备到上线部署的每一步</strong>。两位作者均为一线 AI 工程师，书中所有示例均基于真实项目经验。</p>
<p>✅ 核心亮点：</p>
<ul>
<li>结构化数据工程流程（清洗、标注、合成）</li>
<li>微调（Fine-tuning）策略与技巧</li>
<li>RAG（检索增强生成）系统搭建</li>
<li>使用 AWS SageMaker 部署 LLM</li>
<li>提供完整可下载代码仓库</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpromptcraze.com%2Fwp-content%2Fuploads%2F2025%2F02%2FLLM-Engineers-Handbook.pdf" target="_blank" title="https://promptcraze.com/wp-content/uploads/2025/02/LLM-Engineers-Handbook.pdf" ref="nofollow noopener noreferrer">promptcraze.com/wp-content/…</a></p>
<p>💡 适合人群：想快速上手 LLM 工程落地的开发者，尤其适合云原生背景的工程师。</p>
<h2 data-id="heading-2">3.  📙《Building LLMs for Production》</h2>
<p><strong>作者：Louis-François Bouchard（@Whats_AI） &amp; Louie Peters（@_LouiePeters）</strong></p>
<blockquote>
<p>“聚焦‘生产环境’，而非‘Jupyter Notebook’。”</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f74f05981ec4c6da7f60cf0b5560083~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766371485&amp;x-signature=HxzmoTJcnQhtJv%2FYTctmvjPPGpc%3D" alt="" loading="lazy"/></p>
<p>很多教程止步于本地 demo，但这本书直击痛点：<strong>如何让 LLM 在真实业务中稳定、高效、低成本运行？</strong></p>
<p>✅ 关键主题：</p>
<ul>
<li>Prompt 工程的最佳实践</li>
<li>模型微调 vs. RAG 的选型决策</li>
<li>异步推理与批处理优化</li>
<li>监控幻觉（Hallucination）与偏见</li>
<li>构建可维护的 LLM 服务架构</li>
</ul>
<p>💡 适合人群：已有 LLM 基础，正准备将模型推向用户或客户的团队。</p>
<h2 data-id="heading-3">4.  📕《Build a Large Language Model (from Scratch)》</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f697c3d4c32f42bba95c6f20b53075a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766371485&amp;x-signature=TCjUC7d6X9Zy1fPzzQVVSiATSok%3D" alt="image.png" loading="lazy"/></p>
<p><strong>作者：Sebastian Raschka, PhD（@rasbt）</strong></p>
<blockquote>
<p>“理解黑箱的最好方式，就是亲手造一个。”</p>
</blockquote>
<p>PyTorch 生态核心贡献者 Sebastian Raschka 带你<strong>从零实现一个 Transformer 架构的 LLM</strong>——而且无需 GPU 集群，普通笔记本即可运行！</p>
<p>✅ 你将学会：</p>
<ul>
<li>Tokenization、Embedding、Attention 机制</li>
<li>从头训练小型语言模型</li>
<li>实现训练循环与损失函数</li>
<li>模型推理与文本生成</li>
<li>所有代码基于 PyTorch，简洁清晰</li>
</ul>
<p>💡 适合人群：想深入理解 LLM 内部机制的开发者、研究人员或学生。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fskindhu%2FBuild-A-Large-Language-Model-CN" target="_blank" title="https://github.com/skindhu/Build-A-Large-Language-Model-CN" ref="nofollow noopener noreferrer">github.com/skindhu/Bui…</a></p>
<blockquote>
<p>⚠️ 注意：这不是“调 API”指南，而是“造轮子”教程——但正是这种动手，才能带来真正的理解。</p>
</blockquote>
<h2 data-id="heading-4">5.  📒《Hands-On Large Language Models》</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/884e2829dc97409892a3aa9fb5fade4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766371485&amp;x-signature=7Se%2Bx0ltFjnbipLtd5zOEaNozdA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>作者：Jay Alammar（@JayAlammar） &amp; Maarten Grootendorst（@MaartenGr）</strong></p>
<blockquote>
<p>“用 275+ 张原创插图，把复杂概念变得一目了然。”</p>
</blockquote>
<p>Jay Alammar 是知名 AI 科普作者（曾创作《The Illustrated Transformer》），Maarten 则是 NLP 工程专家。两人联手打造了一本<strong>视觉化、代码驱动的 LLM 入门圣经</strong>。</p>
<p>✅ 特色优势：</p>
<ul>
<li>超过 275 幅定制插图，直观解释 Attention、RAG、微调等概念</li>
<li>每章配 Jupyter Notebook，边学边练</li>
<li>从 Embedding 到 Agent 架构全覆盖</li>
<li>强调“可解释性”与“调试思维”</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbbruceyuan%2FHands-On-Large-Language-Models-CN" target="_blank" title="https://github.com/bbruceyuan/Hands-On-Large-Language-Models-CN" ref="nofollow noopener noreferrer">github.com/bbruceyuan/…</a></p>
<p>💡 适合人群：视觉学习者、转行者、教学者，或任何希望“看懂”LLM 的人。</p>
<h3 data-id="heading-5">📌 总结：如何选择？</h3>





























<table><thead><tr><th>目标</th><th>推荐书籍</th></tr></thead><tbody><tr><td>构建完整 AI 产品体系</td><td>《AI Engineering》</td></tr><tr><td>快速上手 LLM 工程开发</td><td>《The LLM Engineer's Handbook》</td></tr><tr><td>将模型部署到生产环境</td><td>《Building LLMs for Production》</td></tr><tr><td>深入理解模型内部原理</td><td>《Build a LLM from Scratch》</td></tr><tr><td>图文并茂轻松入门</td><td>《Hands-On LLMs》</td></tr></tbody></table>
<blockquote>
<p>🌟 <strong>建议阅读顺序</strong>：先读《Hands-On LLMs》建立直觉 → 用《Build from Scratch》加深理解 → 再通过其他三本掌握工程落地。</p>
</blockquote>
<h3 data-id="heading-6">🔜 下一步行动</h3>
<p>这些书大多提供免费章节、GitHub 代码库或配套视频。不妨从其中一本开始，<strong>每周精读一章 + 动手实践一个例子</strong>。坚持三个月，你将远超 90% 的“调包侠”。</p>
<blockquote>
<p><strong>AI 时代的工程师，不是会跑 Demo 的人，而是能交付可靠系统的建造者。</strong></p>
</blockquote>
<p>📚 你正在读哪一本？欢迎在评论区分享你的学习心得！</p>
<h3 data-id="heading-7">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AST 反混淆处理示例(二)]]></title>    <link>https://juejin.cn/post/7583234966635003938</link>    <guid>https://juejin.cn/post/7583234966635003938</guid>    <pubDate>2025-12-14T12:22:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583234966635003938" data-draft-id="7583234966634659874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AST 反混淆处理示例(二)"/> <meta itemprop="keywords" content="JavaScript,爬虫"/> <meta itemprop="datePublished" content="2025-12-14T12:22:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Glommer"/> <meta itemprop="url" content="https://juejin.cn/user/847085484127432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AST 反混淆处理示例(二)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/847085484127432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Glommer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T12:22:32.000Z" title="Sun Dec 14 2025 12:22:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文章只做技术探讨, 请勿用于非法用途。</p>
</blockquote>
<h2 data-id="heading-0">引言</h2>
<p>再聊一下 AST 反混淆, 聊一下常见一些的 OB 混淆的处理方法。</p>
<h2 data-id="heading-1">实战</h2>
<p>要处理的是 reese84 的加密, 部分加密代码如下。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">_0x38facf</span>(<span class="hljs-params">_0x7f638c</span>) {
    <span class="hljs-keyword">var</span> _0x266430 = a1_0x422d
      , _0x1ed4bb = <span class="hljs-variable language_">this</span>[<span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x45b</span>) + <span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x3be</span>)]
      , _0x5b3338 = _0x295651[<span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x2b2</span>)](<span class="hljs-variable language_">this</span>, _0x7f638c) || <span class="hljs-variable language_">this</span>
      , _0x1bd4e5 = _0x1ed4bb[<span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x437</span>) + <span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x274</span>)];
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>[<span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x28c</span>) + <span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x439</span>) + <span class="hljs-string">'Of'</span>] ? <span class="hljs-title class_">Object</span>[<span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x28c</span>) + <span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x439</span>) + <span class="hljs-string">'Of'</span>](_0x5b3338, _0x1bd4e5) : _0x5b3338[<span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x1f2</span>) + <span class="hljs-title function_">_0x266430</span>(<span class="hljs-number">0x1d9</span>)] = _0x1bd4e5,
    _0x5b3338;
}
</code></pre>
<p>老规矩, 源码放这里, 是一个航司网站, 感兴趣可以自己去看看。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.etihad.com%2F" target="_blank" title="https://www.etihad.com/" ref="nofollow noopener noreferrer">www.etihad.com/</a></p>
<h3 data-id="heading-2">思路</h3>
<p>目的还是要得到一份明文代码, 如下所示。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 加密原文</span>
<span class="hljs-keyword">var</span> _0x416d2b = <span class="hljs-variable language_">localStorage</span>[<span class="hljs-title function_">_0x45c9ef</span>(<span class="hljs-number">0x33f</span>) + <span class="hljs-string">'m'</span>](_0x2c07b5[<span class="hljs-title function_">_0x45c9ef</span>(<span class="hljs-number">0x24a</span>) + <span class="hljs-title function_">_0x45c9ef</span>(<span class="hljs-number">0x2a0</span>)]);
<span class="hljs-comment">// 目标代码</span>
<span class="hljs-keyword">var</span> _0x416d2b = <span class="hljs-variable language_">localStorage</span>[<span class="hljs-string">"getItem"</span>](_0x2c07b5[<span class="hljs-string">"COOKIE_NAME"</span>]);
</code></pre>
<p>可以看到是一份 OB 混淆的代码, 加密类似 _0x266430(0x45b) 或 _0x45c9ef(0x33f) 形式, 首先我们需要通过调试来找到解密函数。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/315d70e6fe414c5ca718cd49efa306b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2xvbW1lcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319751&amp;x-signature=nbpzoVvwTs2ZE8shbYZDAZqX82s%3D" alt="image.png" loading="lazy"/>
<strong>加密代码示例</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/826132a841504122b9e629d0011d056e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2xvbW1lcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319751&amp;x-signature=5jaCwdaZx9sibV5rViWqN0gIJxQ%3D" alt="image.png" loading="lazy"/>
<strong>加密代码结构示例</strong></p>
<p>通过调试可以发现, 所有的解密函数都是通过 a1_0x422d 变量赋值, 然后进行调用解密, 可以做一个具体测试。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3415885173274097824662b2f7f28b0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2xvbW1lcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319751&amp;x-signature=Y%2FsH6VjiFfOOgsK0M6ON%2FOmPUKM%3D" alt="image.png" loading="lazy"/>
<strong>解密测试</strong></p>
<p>可以看到, 加载解密函数, 然后替换为原函数调用, 就能成功解密。</p>
<h4 data-id="heading-3">步骤</h4>
<p>由此我们可以确定处理方法。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-number">1.</span> <span class="hljs-built_in">eval</span> 加载解密函数。
<span class="hljs-number">2.</span> 定位加密位置, 运行解密函数。
<span class="hljs-number">3.</span> 将原本的加密代码替换。
</code></pre>
<h3 data-id="heading-4">开整</h3>
<p>按照上边的步骤, 逐一实现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2597a6ce6a5b4b26b2f1bb35a49434be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2xvbW1lcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319751&amp;x-signature=6SaBM49foPGAJ%2BQ6I8NLhYfilbg%3D" alt="image.png" loading="lazy"/>
<strong>解密函数单独封装文件 key.js</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/908ac461420c4054a731e9c72b114c63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2xvbW1lcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319751&amp;x-signature=eFdpjheeM15w7ZlHaA8mWYNmSrY%3D" alt="image.png" loading="lazy"/>
<strong>AST 代码示例</strong></p>
<p>稍微提一点, 也不是所有 _0x45c9ef(0x33f) 形式的代码都是加密代码, 也有部分是函数调用, 可以做一个 try catch 处理。由此, 我们可以得到一份代码如下。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">_0x38facf</span>(<span class="hljs-params">_0x7f638c</span>) {
  <span class="hljs-keyword">var</span> _0x266430 = a1_0x422d,
    _0x1ed4bb = <span class="hljs-variable language_">this</span>[<span class="hljs-string">"constructor"</span>],
    _0x5b3338 = _0x295651[<span class="hljs-string">"call"</span>](<span class="hljs-variable language_">this</span>, _0x7f638c) || <span class="hljs-variable language_">this</span>,
    _0x1bd4e5 = _0x1ed4bb[<span class="hljs-string">"prototype"</span>];
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>[<span class="hljs-string">"setPrototype"</span> + <span class="hljs-string">'Of'</span>] ? <span class="hljs-title class_">Object</span>[<span class="hljs-string">"setPrototype"</span> + <span class="hljs-string">'Of'</span>](_0x5b3338, _0x1bd4e5) : _0x5b3338[<span class="hljs-string">"__proto__"</span>] = _0x1bd4e5, _0x5b3338;
}
</code></pre>
<p>然后来处理字符串相加的情况。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8c89a02e1e247ff92b9221d9a0a002c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2xvbW1lcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766319751&amp;x-signature=muCdM%2B6N0sXAFJjCuKl7kISlMkI%3D" alt="image.png" loading="lazy"/>
<strong>AST 代码示例</strong></p>
<p>最终得到字符串解密完成的代码如下。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">_0x38facf</span>(<span class="hljs-params">_0x7f638c</span>) {
  <span class="hljs-keyword">var</span> _0x266430 = a1_0x422d,
    _0x1ed4bb = <span class="hljs-variable language_">this</span>[<span class="hljs-string">"constructor"</span>],
    _0x5b3338 = _0x295651[<span class="hljs-string">"call"</span>](<span class="hljs-variable language_">this</span>, _0x7f638c) || <span class="hljs-variable language_">this</span>,
    _0x1bd4e5 = _0x1ed4bb[<span class="hljs-string">"prototype"</span>];
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>[<span class="hljs-string">"setPrototypeOf"</span>] ? <span class="hljs-title class_">Object</span>[<span class="hljs-string">"setPrototypeOf"</span>](_0x5b3338, _0x1bd4e5) : _0x5b3338[<span class="hljs-string">"__proto__"</span>] = _0x1bd4e5, _0x5b3338;
}
</code></pre>
<h2 data-id="heading-5">总结</h2>
<p>文章主要是聊一些思路, 希望可以作为参考。</p>
<p>一些基础的写法可以参考之前的文章, 这次的 OB 混淆应该是更加常见一些的。</p>
<blockquote>
<p>请洒潘江，各倾陆海云尔。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 时代真正流式解析+渲染双重优化的 Incremark]]></title>    <link>https://juejin.cn/post/7583906846986469422</link>    <guid>https://juejin.cn/post/7583906846986469422</guid>    <pubDate>2025-12-15T02:57:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583906846986469422" data-draft-id="7583613222344769562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 时代真正流式解析+渲染双重优化的 Incremark"/> <meta itemprop="keywords" content="前端,Markdown,AI编程"/> <meta itemprop="datePublished" content="2025-12-15T02:57:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="king王一帅"/> <meta itemprop="url" content="https://juejin.cn/user/395479917018408"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 时代真正流式解析+渲染双重优化的 Incremark
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479917018408/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    king王一帅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T02:57:48.000Z" title="Mon Dec 15 2025 02:57:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">故事的开始</h2>
<p>最初是想要实现富文本编辑器 ai 流式输出的，此过程大致为 <code>ai -&gt; chunk -&gt; parser -&gt; propsemirror JSONContent</code> 实现富文本编辑器中类似 ai 聊天框一样的流式输出，并且要尽量节省性能。</p>
<p>然后就出现了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-docs.vercel.app%2F" target="_blank" title="https://incremark-docs.vercel.app/" ref="nofollow noopener noreferrer">incremark</a>，在此过程中也关注到了 <code>vue-stream-markdown</code>，不过它做的只是 vue 渲染层的优化，每次 ai 输出的 markdown chunk，它还是会将其跟之前所有输出拼接解析成 token，虽然在渲染层做到了流式的渲染，但其内核无法满足我的需求。</p>
<h2 data-id="heading-1">想法的实现</h2>
<p>在选择 markdown 底层解析器的时候关注了 tiptap 在用的 markedjs 以及之前自己实现 tiptap markdown 转换的 markdown-it，但最终还是选择了 remark 底层编辑器 micromark。因为 markdown-it token 结构的复杂度远高于 mdast 结构，它存在进入、退出的概念，但 mdast 就是一棵树。</p>
<p>因此拼接一棵树的复杂度其实是更低的，整个工具的设计思路为：</p>
<ol>
<li>维护一个文本缓冲区，接收流式输入</li>
<li>识别"稳定边界"（如空行、标题等），将已完成的块标记为 completed</li>
<li>对于正在接收的块，每次重新解析，但只解析该块的内容</li>
<li>复杂嵌套节点（如列表、引用）作为整体处理，直到确认完成</li>
</ol>
<p>最终可以将流式 markdown 的解析复杂度从 O(n²) 降低到 O(n)，ai 输出内容越多，性能节省也越多。</p>
<h2 data-id="heading-2">实际 benchmark 测试</h2>
<p>小型 markdown 解析性能可提高 2-10 倍，中型 markdown 解析性能提高 10-20 倍，长 markdown 解析性能提高 20-46 倍，当前更长的测试是没有必要的。</p>
<p>原始测试输出结果：</p>
<pre><code class="hljs language-plain" lang="plain">============================================================
Incremark Benchmark
============================================================
Markdown length: 771 chars
Chunk size: 10 chars
Total chunks: 78
Iterations: 100
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 2608.41 ms
   Parse count: 7800
   Avg time per parse: 0.3344 ms
   Total chars parsed: 3,080,100

⚡ Incremark (incremental)
   Total time: 638.36 ms
   Parse count: 7800
   Avg time per parse: 0.0818 ms
   Total chars parsed: 77,100

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 75.5%
   Chars parsing saved: 97.5%
   Speedup: 4.09x faster

============================================================

🔬 Running Incremark Benchmark Suite


============================================================
📄 Document Size: Short (~1KB) (1000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 1000 chars
Chunk size: 10 chars
Total chunks: 100
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 435.85 ms
   Parse count: 2000
   Avg time per parse: 0.2179 ms
   Total chars parsed: 1,010,000

⚡ Incremark (incremental)
   Total time: 171.50 ms
   Parse count: 2000
   Avg time per parse: 0.0858 ms
   Total chars parsed: 20,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 60.7%
   Chars parsing saved: 98.0%
   Speedup: 2.54x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 1000 chars
Chunk size: 50 chars
Total chunks: 20
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 92.33 ms
   Parse count: 400
   Avg time per parse: 0.2308 ms
   Total chars parsed: 210,000

⚡ Incremark (incremental)
   Total time: 43.77 ms
   Parse count: 400
   Avg time per parse: 0.1094 ms
   Total chars parsed: 20,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 52.6%
   Chars parsing saved: 90.5%
   Speedup: 2.11x faster

============================================================

============================================================
📄 Document Size: Medium (~5KB) (5000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 5000 chars
Chunk size: 10 chars
Total chunks: 500
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 10335.94 ms
   Parse count: 10000
   Avg time per parse: 1.0336 ms
   Total chars parsed: 25,050,000

⚡ Incremark (incremental)
   Total time: 916.48 ms
   Parse count: 10000
   Avg time per parse: 0.0916 ms
   Total chars parsed: 100,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 91.1%
   Chars parsing saved: 99.6%
   Speedup: 11.28x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 5000 chars
Chunk size: 50 chars
Total chunks: 100
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 2120.47 ms
   Parse count: 2000
   Avg time per parse: 1.0602 ms
   Total chars parsed: 5,050,000

⚡ Incremark (incremental)
   Total time: 223.64 ms
   Parse count: 2000
   Avg time per parse: 0.1118 ms
   Total chars parsed: 100,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 89.5%
   Chars parsing saved: 98.0%
   Speedup: 9.48x faster

============================================================

============================================================
📄 Document Size: Long (~10KB) (10000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 10000 chars
Chunk size: 10 chars
Total chunks: 1000
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 40596.85 ms
   Parse count: 20000
   Avg time per parse: 2.0298 ms
   Total chars parsed: 100,100,000

⚡ Incremark (incremental)
   Total time: 1781.89 ms
   Parse count: 20000
   Avg time per parse: 0.0891 ms
   Total chars parsed: 200,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 95.6%
   Chars parsing saved: 99.8%
   Speedup: 22.78x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 10000 chars
Chunk size: 50 chars
Total chunks: 200
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 8095.40 ms
   Parse count: 4000
   Avg time per parse: 2.0239 ms
   Total chars parsed: 20,100,000

⚡ Incremark (incremental)
   Total time: 473.23 ms
   Parse count: 4000
   Avg time per parse: 0.1183 ms
   Total chars parsed: 200,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 94.2%
   Chars parsing saved: 99.0%
   Speedup: 17.11x faster

============================================================

============================================================
📄 Document Size: Very Long (~20KB) (20000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 20000 chars
Chunk size: 10 chars
Total chunks: 2000
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 183844.78 ms
   Parse count: 40000
   Avg time per parse: 4.5961 ms
   Total chars parsed: 400,200,000

⚡ Incremark (incremental)
   Total time: 3997.77 ms
   Parse count: 40000
   Avg time per parse: 0.0999 ms
   Total chars parsed: 400,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 97.8%
   Chars parsing saved: 99.9%
   Speedup: 45.99x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 20000 chars
Chunk size: 50 chars
Total chunks: 400
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 37400.52 ms
   Parse count: 8000
   Avg time per parse: 4.6751 ms
   Total chars parsed: 80,200,000

⚡ Incremark (incremental)
   Total time: 1001.10 ms
   Parse count: 8000
   Avg time per parse: 0.1251 ms
   Total chars parsed: 400,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 97.3%
   Chars parsing saved: 99.5%
   Speedup: 37.36x faster

============================================================


================================================================================
📈 Complete Benchmark Summary
================================================================================

| Document Size    | Chunk | Time Saved | Chars Saved | Speedup |
|------------------|-------|------------|-------------|---------|
| Short (~1KB)     | 10    |      60.7% |       98.0% |   2.54x |
| Short (~1KB)     | 50    |      52.6% |       90.5% |   2.11x |
| Medium (~5KB)    | 10    |      91.1% |       99.6% |  11.28x |
| Medium (~5KB)    | 50    |      89.5% |       98.0% |   9.48x |
| Long (~10KB)     | 10    |      95.6% |       99.8% |  22.78x |
| Long (~10KB)     | 50    |      94.2% |       99.0% |  17.11x |
| Very Long (~20KB) | 10    |      97.8% |       99.9% |  45.99x |
| Very Long (~20KB) | 50    |      97.3% |       99.5% |  37.36x |

--------------------------------------------------------------------------------

📊 Average by Document Size:

   Short (~1KB): 2.33x faster, 56.7% time saved
   Medium (~5KB): 10.38x faster, 90.3% time saved
   Long (~10KB): 19.94x faster, 94.9% time saved
   Very Long (~20KB): 41.67x faster, 97.5% time saved

--------------------------------------------------------------------------------

🎯 Overall Average:
   Time Saved: 84.8%
   Chars Saved: 98.0%
   Speedup: 18.58x

================================================================================
</code></pre>
<h2 data-id="heading-3">框架支持</h2>
<p>由于从解析层面上实现了流式解析，并使用 mdast 进行解析结果的记录，因此当前工具很容易迁移到各种框架中，目前实现了 vue 与 react 版本，svelte 与 solid 等小众框架实现也很简单（但暂未做）。
vue demo 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-vue.vercel.app%2F" target="_blank" title="https://incremark-vue.vercel.app/" ref="nofollow noopener noreferrer">incremark-vue.vercel.app/</a>
react demo 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-react.vercel.app%2F" target="_blank" title="https://incremark-react.vercel.app/" ref="nofollow noopener noreferrer">incremark-react.vercel.app/</a></p>
<h2 data-id="heading-4">devtools</h2>
<p>除了功能实现，还增加了 devtools 可以查看当前解析内容的一些状态</p>
<p><strong>markdown 内容统计</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/550853d582b04d6a90a110942dd29153~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372267&amp;x-signature=zQxyXNFo5n3V3rsc5tFj53EszW4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>markdown 块统计</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/561b83774eee4072b67cdc23a5d6a4d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372267&amp;x-signature=5zxRABrs5JPyS0FsPHlXIB%2F5SN0%3D" alt="image.png" loading="lazy"/></p>
<p><strong>mdast 结果</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1be72d53785c47cead1a25813b4ba41c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372267&amp;x-signature=eUfAOnE25IKL%2Bl2Fxn0NTfpvKfw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>chunk append 记录</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f478452aa88f4965b35bca6e59eaabea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372267&amp;x-signature=ACTWQRQY%2BfBOqsodm1dd2m1tOR8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">小结</h2>
<p>欢迎大家体验，文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-docs.vercel.app%2Fzh%2F" target="_blank" title="https://incremark-docs.vercel.app/zh/" ref="nofollow noopener noreferrer">incremark-docs.vercel.app/zh/</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[稀土掘金联合中国信通院邀请您填写2025 AI4SE现状调研问卷]]></title>    <link>https://juejin.cn/post/7582785032851652671</link>    <guid>https://juejin.cn/post/7582785032851652671</guid>    <pubDate>2025-12-12T09:51:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582785032851652671" data-draft-id="7582791876366221350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="稀土掘金联合中国信通院邀请您填写2025 AI4SE现状调研问卷"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-12T09:51:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XCaptaino"/> <meta itemprop="url" content="https://juejin.cn/user/3052665287739005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            稀土掘金联合中国信通院邀请您填写2025 AI4SE现状调研问卷
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3052665287739005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XCaptaino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:51:43.000Z" title="Fri Dec 12 2025 09:51:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当前以大模型、智能体等技术为代表的新一代人工智能技术，正加速落地“千行百业”。软件作为数字转型的核心支撑与新技术落地的关键载体，软件行业的智能化变革尤为迫切，AI在软件生产全流程的价值凸显，持续推动软件研发范式转变，提升研发质效。然而，AI在软件研发部分环节虽已进入规模化落地阶段，但在技术落地成效对比、场景选择、成熟度对标等关键信息仍缺乏系统性梳理，企业在技术选型、路径规划上仍面临决策困惑，亟需行业提供科学指引。</p>
<p>长期以来中国信息通信研究院（简称“中国信通院”）人工智能研究所高度重视智能化软件工程（AI4SE）发展，联合中国人工智能产业发展联盟（AIIA）软件智能化委员会围绕技术研究、标准、报告、评估等多个维度开展工作，已建成《智能化软件工程技术和应用要求》《面向软件工程智能体技术和应用要求》《软件智能化成熟度模型》等标准体系，发布《智能化软件开发落地实践指南（2024年）》等研究报告，并开展行业现状调研，于今年4月联合发布了《AI4SE行业现状调查报告（2024年度）》，旨在为软件研发各阶段的智能化落地提供参考。</p>
<p>为进一步深入了解智能化软件工程发展现状、各阶段应用情况及未来落地趋势等行业关键数据，中国信通院人工智能研究所联合中国工商银行、中国邮政储蓄银行、交通银行、TRAE团队、腾讯、讯飞、百度、京东、软通动力、Testin云测、硅心科技、新炬网络、IT168、测试窝等单位共同发起2025年度智能化软件工程现状调研。调研对象为各行业中具有软件研发团队的企业。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fv.wjx.cn%2Fvm%2FQ07VNmj.aspx" target="_blank" title="https://v.wjx.cn/vm/Q07VNmj.aspx" ref="nofollow noopener noreferrer">立即填写</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fv.wjx.cn%2Fvm%2FQ07VNmj.aspx" target="_blank" title="https://v.wjx.cn/vm/Q07VNmj.aspx" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceff7f8699734477a857abc3b48d0c0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWENhcHRhaW5v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138580&amp;x-signature=HMpHXoIZWvf1%2FruE6ZDUkI6DdG8%3D" alt="img_v3_02st_ef98b0da-188c-4472-9cde-166ad561140g.png" loading="lazy"/>
</a></p>
<p>本次调研问卷的收集截止日期为2026年1月15日，调研结果分析整理后，将于2026年以调研报告的形式正式发布，旨在为行业提供最新的发展趋势分析和决策参考，推动软件工程智能化转型升级。</p>
<p>欢迎各企业或专家参与问卷，有效填写者将有机会获得精美奖品。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e35e8615e9d44398b30111d41b690d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWENhcHRhaW5v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766138580&amp;x-signature=oHVAZuil1Pjn%2BQrGh9kkuRla8do%3D" alt="图片" loading="lazy"/></p>
<p>无论您所在企业在软件研发过程中，已经落地了智能化能力，还是处于试点探索阶段，我们都诚挚邀请您参与此次调研，分享您的真知灼见，您的宝贵经验将为行业的发展提供重要的参考价值。我们将对您提供的信息严格保密，并承诺仅用于报告的编写。期待您的积极参与，共同为软件行业的智能化发展贡献力量！</p>
<p><strong>联系方式：</strong> 中国信通院/人工智能研究所</p>
<ul>
<li>
<p>齐老师 18686962307(微信同号)</p>
</li>
<li>
<p>闫老师 13041008356(微信同号)</p>
</li>
<li>
<p>秦老师 13488684897(微信同号)</p>
</li>
</ul>
<h3 data-id="heading-0">关于中国人工智能产业发展联盟（AIIA）软件智能化委员会</h3>
<p>中国人工智能产业发展联盟（AIIA）软件智能化委员会是原AI4SE工作组的扩充与升级，在原有工作基础上继续深挖与扩展。一是持续深耕软件研发全流程智能化转型，二是推动软件产品形态智能创新，三是推动软件企业智能化转型升级，充分释放AI在软件领域的价值。AI4SE工作组已吸纳180+成员单位，覆盖金融、电信、软件等诸多行业，欢迎更多企业加入。</p>
<h3 data-id="heading-1"><strong>联系方式：</strong></h3>
<p>齐老师 18686962307(微信同号)</p>
<p>闫老师 13041008356(微信同号)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[内存泄露、网络加密与通用缓存]]></title>    <link>https://juejin.cn/post/7583215836690661417</link>    <guid>https://juejin.cn/post/7583215836690661417</guid>    <pubDate>2025-12-14T13:33:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583215836690661417" data-draft-id="7583226204036137001" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="内存泄露、网络加密与通用缓存"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-12-14T13:33:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卓尔山上刷力扣"/> <meta itemprop="url" content="https://juejin.cn/user/263471893337357"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            内存泄露、网络加密与通用缓存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/263471893337357/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卓尔山上刷力扣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:33:41.000Z" title="Sun Dec 14 2025 13:33:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、内存泄露排查：循环引用检测与修复</h2>
<p>内存泄露的本质是对象不再被需要，但引用计数无法归零，导致内存无法释放。</p>
<h3 data-id="heading-1">🔧 核心排查工具</h3>
<ul>
<li><strong>Xcode Memory Graph Debugger</strong>：运行时可视化对象引用关系，紫色<code>!</code>图标标识潜在泄露</li>
<li><strong>Instruments Leaks工具</strong>：实时监控泄露对象，定位未释放的CF对象</li>
<li><strong>静态代码分析</strong>：检查闭包、代理、通知等常见泄露场景</li>
</ul>
<h3 data-id="heading-2">💡 高频泄露场景与修复</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 1. 闭包循环引用（常见于网络回调）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionManager</span> {
    <span class="hljs-keyword">var</span> completion: ((<span class="hljs-type">Bool</span>) -&gt; <span class="hljs-type">Void</span>)<span class="hljs-operator">?</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">processTransaction</span>(<span class="hljs-params">amount</span>: <span class="hljs-type">Double</span>) {
        <span class="hljs-comment">// ❌ 错误：闭包强持有self</span>
        <span class="hljs-type">APIClient</span>.sendTransaction(amount: amount) { success <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span>.updateUI() <span class="hljs-comment">// 形成循环引用</span>
        }
        
        <span class="hljs-comment">// ✅ 正确：使用weak打破循环</span>
        <span class="hljs-type">APIClient</span>.sendTransaction(amount: amount) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] success <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.updateUI()
        }
    }
}

<span class="hljs-comment">// 2. 代理强引用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountViewController</span> {
    <span class="hljs-comment">// ❌ 错误：强引用代理</span>
    <span class="hljs-keyword">var</span> delegate: <span class="hljs-type">AccountDelegate</span>?
    
    <span class="hljs-comment">// ✅ 正确：弱引用代理</span>
    <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> delegate: <span class="hljs-type">AccountDelegate</span>?
}

<span class="hljs-comment">// 3. 定时器未正确销毁</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TimerHandler</span> {
    <span class="hljs-keyword">var</span> timer: <span class="hljs-type">Timer</span>?
    
    <span class="hljs-keyword">deinit</span> {
        <span class="hljs-comment">// ✅ 必须手动invalidate</span>
        timer<span class="hljs-operator">?</span>.invalidate()
        timer <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    }
}
</code></pre>
<h2 data-id="heading-3">二、网络数据加密：金融级安全传输方案</h2>
<p>APP对数据传输安全有极高要求需要多层加密保护。</p>
<h3 data-id="heading-4">🔐 多层次加密架构</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[客户端请求] --&gt; B[应用层加密]
    B --&gt; C[传输层加密 HTTPS]
    C --&gt; D[服务端接收]
    
    subgraph "应用层加密细节"
        B1[敏感参数单独加密] --&gt; B2[参数排序与签名]
        B2 --&gt; B3[加入时间戳/随机数]
    end
</code></pre>
<h3 data-id="heading-5">🛡️ 核心加密实践</h3>
<h4 data-id="heading-6">1. 传输层安全（基础）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ATS强制HTTPS（Info.plist配置）</span>
<span class="hljs-operator">&lt;</span>key<span class="hljs-operator">&gt;</span><span class="hljs-type">NSAppTransportSecurity</span>&lt;/key&gt;
<span class="hljs-operator">&lt;</span>dict<span class="hljs-operator">&gt;</span>
    <span class="hljs-operator">&lt;</span>key<span class="hljs-operator">&gt;</span><span class="hljs-type">NSAllowsArbitraryLoads</span>&lt;/key&gt;
    <span class="hljs-operator">&lt;</span><span class="hljs-literal">false</span><span class="hljs-operator">/&gt;</span> <span class="hljs-operator">&lt;!--</span> 生产环境必须为<span class="hljs-literal">false</span> <span class="hljs-operator">--&gt;</span>
<span class="hljs-operator">&lt;/</span>dict<span class="hljs-operator">&gt;</span>

<span class="hljs-comment">// SSL Pinning防中间人攻击</span>
<span class="hljs-keyword">let</span> session <span class="hljs-operator">=</span> <span class="hljs-type">URLSession</span>(configuration: .default, 
                        delegate: <span class="hljs-type">SSLPinningDelegate</span>(), 
                        delegateQueue: <span class="hljs-literal">nil</span>)
</code></pre>
<h4 data-id="heading-7">2. 应用层加密（增强）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 敏感数据RSA加密示例</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">encryptSensitiveData</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">data</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">String</span>? {
    <span class="hljs-comment">// 1. 从服务端获取RSA公钥（首次启动或定期更新）</span>
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> publicKey <span class="hljs-operator">=</span> <span class="hljs-type">KeychainManager</span>.getRSAPublicKey() <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-comment">// 2. 加密密码、验证码等敏感字段</span>
    <span class="hljs-keyword">let</span> encryptedPassword <span class="hljs-operator">=</span> <span class="hljs-type">RSA</span>.encrypt(data, publicKey: publicKey)
    
    <span class="hljs-comment">// 3. 生成请求签名</span>
    <span class="hljs-keyword">let</span> timestamp <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>(<span class="hljs-type">Date</span>().timeIntervalSince1970)
    <span class="hljs-keyword">let</span> nonce <span class="hljs-operator">=</span> <span class="hljs-type">UUID</span>().uuidString
    <span class="hljs-keyword">let</span> signString <span class="hljs-operator">=</span> <span class="hljs-string">"<span class="hljs-subst">\(data)</span><span class="hljs-subst">\(timestamp)</span><span class="hljs-subst">\(nonce)</span><span class="hljs-subst">\(API_SECRET)</span>"</span>
    <span class="hljs-keyword">let</span> signature <span class="hljs-operator">=</span> <span class="hljs-type">HMAC</span>.sha256(signString)
    
    <span class="hljs-keyword">return</span> encryptedPassword
}

<span class="hljs-comment">// 请求参数签名示例</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SecureRequest</span> {
    <span class="hljs-keyword">let</span> userId: <span class="hljs-type">String</span>
    <span class="hljs-keyword">let</span> encryptedData: <span class="hljs-type">String</span>
    <span class="hljs-keyword">let</span> timestamp: <span class="hljs-type">Int</span>
    <span class="hljs-keyword">let</span> nonce: <span class="hljs-type">String</span>
    <span class="hljs-keyword">let</span> signature: <span class="hljs-type">String</span>
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">userId</span>: <span class="hljs-type">String</span>, <span class="hljs-params">sensitiveData</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-keyword">self</span>.userId <span class="hljs-operator">=</span> userId
        <span class="hljs-keyword">self</span>.timestamp <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>(<span class="hljs-type">Date</span>().timeIntervalSince1970)
        <span class="hljs-keyword">self</span>.nonce <span class="hljs-operator">=</span> <span class="hljs-type">UUID</span>().uuidString
        
        <span class="hljs-comment">// 加密敏感数据</span>
        <span class="hljs-keyword">self</span>.encryptedData <span class="hljs-operator">=</span> <span class="hljs-type">RSA</span>.encrypt(sensitiveData)
        
        <span class="hljs-comment">// 生成签名（防篡改）</span>
        <span class="hljs-keyword">let</span> params <span class="hljs-operator">=</span> <span class="hljs-string">"userId=<span class="hljs-subst">\(userId)</span>&amp;data=<span class="hljs-subst">\(encryptedData)</span>×tamp=<span class="hljs-subst">\(timestamp)</span>&amp;nonce=<span class="hljs-subst">\(nonce)</span>"</span>
        <span class="hljs-keyword">self</span>.signature <span class="hljs-operator">=</span> <span class="hljs-type">HMAC</span>.sha256(params <span class="hljs-operator">+</span> <span class="hljs-type">API_SECRET</span>)
    }
}
</code></pre>
<h4 data-id="heading-8">3. 密钥安全管理</h4>
<ul>
<li><strong>禁止硬编码</strong>：绝不将密钥直接写在代码中</li>
<li><strong>Keychain存储</strong>：使用iOS Keychain存储加密密钥</li>
<li><strong>动态获取</strong>：敏感密钥从服务端动态获取，可定期轮换</li>
</ul>
<h3 data-id="heading-9">📊 加密方案选择指南</h3>






























<table><thead><tr><th>场景</th><th>推荐方案</th><th>说明</th></tr></thead><tbody><tr><td>登录密码/支付密码</td><td>RSA非对称加密</td><td>公钥加密，私钥解密，避免密钥传输</td></tr><tr><td>交易数据/个人信息</td><td>AES对称加密</td><td>性能好，适合大量数据加密</td></tr><tr><td>请求防篡改</td><td>HMAC-SHA256签名</td><td>验证数据完整性</td></tr><tr><td>防重放攻击</td><td>时间戳+随机数</td><td>确保请求唯一性</td></tr></tbody></table>
<h2 data-id="heading-10">三、通用缓存：性能优化与数据管理</h2>
<p>缓存设计需平衡速度、空间和一致性，金融APP尤其需注意数据实时性和安全性。</p>
<h3 data-id="heading-11">🗂️ 三级缓存架构</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 1. 内存缓存（NSCache - 自动清理）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryCache</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">MemoryCache</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> cache <span class="hljs-operator">=</span> <span class="hljs-type">NSCache</span>&lt;<span class="hljs-type">NSString</span>, <span class="hljs-type">AnyObject</span>&gt;()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">init</span>() {
        cache.countLimit <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-comment">// 限制缓存数量</span>
        cache.totalCostLimit <span class="hljs-operator">=</span> <span class="hljs-number">50</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-comment">// 50MB内存限制</span>
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cacheTransaction</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">transaction</span>: <span class="hljs-type">Transaction</span>, <span class="hljs-params">for</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) {
        cache.setObject(transaction, forKey: key <span class="hljs-keyword">as</span> <span class="hljs-type">NSString</span>)
    }
}

<span class="hljs-comment">// 2. 磁盘缓存（FileManager - 持久化）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DiskCache</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cacheData</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">data</span>: <span class="hljs-type">Data</span>, <span class="hljs-params">for</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>, <span class="hljs-params">expiration</span>: <span class="hljs-type">TimeInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">3600</span>) {
        <span class="hljs-keyword">let</span> fileURL <span class="hljs-operator">=</span> cacheDirectory.appendingPathComponent(key.md5)
        
        <span class="hljs-comment">// 存储缓存元数据（包含过期时间）</span>
        <span class="hljs-keyword">let</span> metadata <span class="hljs-operator">=</span> <span class="hljs-type">CacheMetadata</span>(expiration: <span class="hljs-type">Date</span>().addingTimeInterval(expiration))
        <span class="hljs-keyword">let</span> metadataData <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> <span class="hljs-type">JSONEncoder</span>().encode(metadata)
        
        <span class="hljs-comment">// 写入文件</span>
        <span class="hljs-keyword">try?</span> data.write(to: fileURL)
        <span class="hljs-keyword">try?</span> metadataData<span class="hljs-operator">?</span>.write(to: metadataURL(for: key))
    }
}

<span class="hljs-comment">// 3. 数据库缓存（Core Data - 结构化数据）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseCache</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cacheUserTransactions</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">transactions</span>: [<span class="hljs-type">Transaction</span>]) {
        <span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> persistentContainer.viewContext
        
        <span class="hljs-comment">// 批量插入/更新</span>
        transactions.forEach { transaction <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">let</span> cdTransaction <span class="hljs-operator">=</span> <span class="hljs-type">CDTransaction</span>(context: context)
            cdTransaction.id <span class="hljs-operator">=</span> transaction.id
            cdTransaction.amount <span class="hljs-operator">=</span> transaction.amount
            cdTransaction.timestamp <span class="hljs-operator">=</span> transaction.date
        }
        
        <span class="hljs-keyword">try?</span> context.save()
    }
}
</code></pre>
<h3 data-id="heading-12">⚙️ 缓存策略实现</h3>
<h4 data-id="heading-13">1. 缓存键设计</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CacheKey</span> {
    <span class="hljs-comment">// 复合键：类型 + 业务ID + 版本号</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">forTransactionList</span>(<span class="hljs-params">userId</span>: <span class="hljs-type">String</span>, <span class="hljs-params">page</span>: <span class="hljs-type">Int</span>, <span class="hljs-params">pageSize</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">String</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"transaction_list_<span class="hljs-subst">\(userId)</span>_<span class="hljs-subst">\(page)</span>_<span class="hljs-subst">\(pageSize)</span>_v2"</span>
    }
    
    <span class="hljs-comment">// 带版本的键：数据结构变更时自动失效旧缓存</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">forUserProfile</span>(<span class="hljs-params">userId</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">String</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"user_profile_<span class="hljs-subst">\(userId)</span>_v3"</span> <span class="hljs-comment">// 版本号递增</span>
    }
}
</code></pre>
<h4 data-id="heading-14">2. 缓存清理策略</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// LRU（最近最少使用）清理</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LRUCacheManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> accessHistory: [<span class="hljs-type">String</span>: <span class="hljs-type">Date</span>] <span class="hljs-operator">=</span> [:]
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cleanupIfNeeded</span>() {
        <span class="hljs-keyword">let</span> now <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>()
        <span class="hljs-keyword">let</span> expirationInterval: <span class="hljs-type">TimeInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span> <span class="hljs-operator">*</span> <span class="hljs-number">24</span> <span class="hljs-operator">*</span> <span class="hljs-number">3600</span> <span class="hljs-comment">// 一周</span>
        
        <span class="hljs-keyword">for</span> (key, lastAccess) <span class="hljs-keyword">in</span> accessHistory {
            <span class="hljs-keyword">if</span> now.timeIntervalSince(lastAccess) <span class="hljs-operator">&gt;</span> expirationInterval {
                removeCache(for: key)
                accessHistory.removeValue(forKey: key)
            }
        }
    }
}

<span class="hljs-comment">// 基于容量的清理</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CapacityBasedCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> maxDiskSize: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-comment">// 100MB</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cleanupOldFiles</span>() {
        <span class="hljs-keyword">var</span> totalSize <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">let</span> files <span class="hljs-operator">=</span> sortedCacheFilesByAccessDate() <span class="hljs-comment">// 按访问时间排序</span>
        
        <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files {
            totalSize <span class="hljs-operator">+=</span> file.size
            <span class="hljs-keyword">if</span> totalSize <span class="hljs-operator">&gt;</span> maxDiskSize {
                <span class="hljs-keyword">try?</span> <span class="hljs-type">FileManager</span>.default.removeItem(at: file.url)
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-15">3. 数据缓存特别处理</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FinancialDataCache</span> {
    <span class="hljs-comment">// 实时性要求高的数据：短时间缓存</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cacheAccountBalance</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">balance</span>: <span class="hljs-type">Double</span>, <span class="hljs-params">for</span> <span class="hljs-params">userId</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-comment">// 余额数据只缓存5分钟</span>
        cache.setObject(balance, forKey: <span class="hljs-string">"balance_<span class="hljs-subst">\(userId)</span>"</span>, expiresIn: <span class="hljs-number">300</span>)
    }
    
    <span class="hljs-comment">// 交易记录：可适当延长缓存时间</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cacheTransactions</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">transactions</span>: [<span class="hljs-type">Transaction</span>], <span class="hljs-params">for</span> <span class="hljs-params">userId</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-comment">// 交易记录缓存1小时</span>
        cache.setObject(transactions, forKey: <span class="hljs-string">"transactions_<span class="hljs-subst">\(userId)</span>"</span>, expiresIn: <span class="hljs-number">3600</span>)
    }
    
    <span class="hljs-comment">// 敏感数据：退出即清理</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">clearSensitiveData</span>() {
        cache.removeObject(forKey: <span class="hljs-string">"balance_<span class="hljs-subst">\(userId)</span>"</span>)
        cache.removeObject(forKey: <span class="hljs-string">"recent_transfers_<span class="hljs-subst">\(userId)</span>"</span>)
        <span class="hljs-comment">// 同时清理磁盘缓存</span>
        <span class="hljs-type">DiskCache</span>.clearUserData(userId)
    }
}
</code></pre>
<h3 data-id="heading-16">📈 缓存性能监控</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheMetrics</span> {
    <span class="hljs-keyword">var</span> hitCount <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> missCount <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> totalSize: <span class="hljs-type">Int64</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">var</span> hitRate: <span class="hljs-type">Double</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-type">Double</span>(hitCount) <span class="hljs-operator">/</span> <span class="hljs-type">Double</span>(hitCount <span class="hljs-operator">+</span> missCount)
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">logCacheHit</span>() {
        hitCount <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> hitRate <span class="hljs-operator">&lt;</span> <span class="hljs-number">0.6</span> {
            <span class="hljs-comment">// 命中率过低，考虑调整缓存策略</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"警告：缓存命中率偏低 <span class="hljs-subst">\(hitRate)</span>"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-17">🎯 要点总结</h3>
<ol>
<li><strong>内存泄露</strong>：强调工具使用（Memory Graph）和常见场景（闭包、代理），结合金融APP谈敏感数据清理</li>
<li><strong>网络加密</strong>：说明分层理念（HTTPS打底+业务层增强），重点阐述参数签名防篡改和密钥安全管理</li>
<li><strong>通用缓存</strong>：解释三级架构（内存→磁盘→DB），强调金融数据的特殊缓存策略（短时间、及时清理）</li>
</ol>
<p><strong>三者关联性</strong>：良好的缓存设计减少不必要的网络请求（降低加密传输压力），正确的内存管理确保缓存对象及时释放，三者共同保障APP性能与安全。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 文件拷贝性能对比：裸 `read/write` VS `fread/fwrite` —— 页面缓存与用户缓冲的真相（附完整测试代码）]]></title>    <link>https://juejin.cn/post/7583571595202986022</link>    <guid>https://juejin.cn/post/7583571595202986022</guid>    <pubDate>2025-12-14T13:49:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583571595202986022" data-draft-id="7583576612390780938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 文件拷贝性能对比：裸 `read/write` VS `fread/fwrite` —— 页面缓存与用户缓冲的真相（附完整测试代码）"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-12-14T13:49:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xlp666hub"/> <meta itemprop="url" content="https://juejin.cn/user/2965810860569131"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 文件拷贝性能对比：裸 `read/write` VS `fread/fwrite` —— 页面缓存与用户缓冲的真相（附完整测试代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2965810860569131/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xlp666hub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:49:00.000Z" title="Sun Dec 14 2025 13:49:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Linux 文件拷贝性能对比：裸 <code>read/write</code> VS <code>fread/fwrite</code> —— 页面缓存与用户缓冲的真相（附完整测试代码）</h2>
<p>在 Linux C 编程的世界里，存在着一个经典的问题：<strong>同样是文件 I/O，系统调用 (<code>read/write</code>) 和 C 标准库 (<code>fread/fwrite</code>) 到底哪个性能更好？</strong></p>
<p>教科书的说法一般是这样的：<code>fread/fwrite</code> 因为带有<strong>用户态缓冲区</strong>，能将多次小块 I/O 请求打包成大块，显著<strong>减少系统调用次数</strong>，所以在大多数场景下，尤其是小块随机读写时，通常更快、更高效。这也是为什么许多开发者在编写文件处理代码时，会优先选择标准库函数，而不是直接裸奔系统调用。</p>
<p>然而，理论很丰满，但现实往往骨感得令人意外。为了验证这个结论，我设计了一个文件拷贝实验。然而，第一轮测试的结果就给了我一记响亮的耳光——<strong>裸奔的 read/write 竟然比精心封装的 fread/fwrite 快了 2 倍多！</strong></p>
<p>这到底是怎么回事呢？是代码写错了还是我对 Linux I/O 的理解有问题？为了了解背后的真相，我进行了一场从用户态到内核态的探索。</p>
<p>其实，这是 Linux I/O 机制的精妙设计所致：内核的<strong>页面缓存（Page Cache）</strong> 和 <strong>预读（readahead） 机制</strong>，已经为大块顺序读写提供了优化。系统调用直接利用内核缓冲，而 <code>fread/fwrite</code> 虽有用户态缓冲，却引入了额外 <code>memcpy</code> 和逻辑检查开销，在缓冲区已对齐页面大小时，反而成了累赘。</p>
<p>本文，我将会对比不同缓冲区大小，查看 strace 系统调用轨迹。这不仅仅是一次性能测试，更是一次对 Linux I/O 子系统（VFS、Page Cache、缓冲策略）的深度解密。大家准备好了吗？我们开始。</p>
<h2 data-id="heading-1">1. 实验设计与诡异的实验结果</h2>
<p>为了让对比实验公平且方便大家复现，首先需要一个体积适中的测试文件，以及系统调用和C库的拷贝程序。</p>
<h3 data-id="heading-2">1.1 准备测试数据</h3>
<p>我们直接使用 <code>dd</code> 命令来创建一个 <strong>10MB</strong>、<strong>内容全为 0</strong> 的二进制文件。这个体积对于现代PC来说不大不小，能触发I/O操作，又不会测试太久。</p>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=testfile.dat bs=1M count=10
</code></pre>
<p>我们在这里先简单介绍一下这个命令。</p>
<p><code>dd</code> 是 Linux/Unix 系统里一个非常古老但极其强大的工具。核心功能就是：<strong>从一个地方读取数据，然后写入到另一个地方</strong>，并且可以<strong>精确控制读写</strong>的方式。</p>
<p><code>if</code> 可以理解为 input file ，取两个单词的首字母，表示输入源。</p>
<p><code>if=/dev/zero</code>：/dev/zero 是 Linux 内核提供的一个“虚拟设备文件”，当你去读它时，它会源源不断地给你<strong>返回二进制的 0</strong>。</p>
<p><code>of</code> 可以理解为 output file ，取两个单词的首字母，表示输出目标。</p>
<p><code>of=testfile.dat</code>：让 dd 把读到的 0 写到当前目录下一个叫 testfile.dat 的文件里。（注：这会自动创建该文件）</p>
<p><code>bs</code> 可以理解为 block size ，取两个单词的首字母，它用来指定块大小。dd 工作时不是一个字节一个字节搬运，而是<strong>一块一块地搬</strong>。这个参数就是定义这个块有多大。</p>
<p>bs=1M：我们把块大小设置为 <strong>1 MB</strong>。</p>
<p>最后的<code>count=10</code>就是指定有多少块，这里我们定义为10块。一次搬一块，一块为1MB，那么搬10块就是10MB。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4be953b62544592b1a503fb3eafaacf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=KXlec%2BeenGl%2BszmPF7WC0OqzoDA%3D" alt="1. 创建10MB的文件.png" loading="lazy"/></p>
<p>我们运行这条命令后查看一下文件信息，发现确实得到了一个大小为10MB的 testfile.dat 文件。</p>
<h3 data-id="heading-3">1.2 设计两个拷贝程序</h3>
<p>两个拷贝程序的核心逻辑都非常简单：循环读写。为了让对比更有意义，我将它们的读写缓冲区大小 <code>BUFFER_SIZE</code> 都设置为 <strong>4096 字节 (4KB)</strong> ，这通常是一个内存页的大小，也是I/O操作中常见的块大小。</p>
<h4 data-id="heading-4">1.2.1 系统调用</h4>
<p>这里先贴上代码：</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
​
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FILE_SOURCE <span class="hljs-string">"testfile.dat"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FILE_DESTINATION  <span class="hljs-string">"des_sys_file.dat"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFFER_SIZE 4096</span>
​
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
    <span class="hljs-type">clock_t</span> start,end;
    <span class="hljs-type">double</span> cpu_time_used;
​
    start = clock();    <span class="hljs-comment">//开始计时</span>
​
    <span class="hljs-type">int</span> s_fd = open(FILE_SOURCE,O_RDONLY);
    <span class="hljs-keyword">if</span>(s_fd == <span class="hljs-number">-1</span>)
    {
        perror(<span class="hljs-string">"open failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
​
    <span class="hljs-type">int</span> d_fd = open(FILE_DESTINATION,O_RDWR|O_CREAT,<span class="hljs-number">0644</span>);
    <span class="hljs-keyword">if</span>(d_fd == <span class="hljs-number">-1</span>)
    {
        close(s_fd);
        perror(<span class="hljs-string">"open failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
​
​
    <span class="hljs-type">char</span> buf[BUFFER_SIZE];    <span class="hljs-comment">//4KB缓冲区</span>
    <span class="hljs-type">ssize_t</span> bytes;
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)
    {
        bytes = read(s_fd,buf,BUFFER_SIZE);
        <span class="hljs-keyword">if</span>(bytes == <span class="hljs-number">-1</span>)
        {
            perror(<span class="hljs-string">"read failed"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(bytes == <span class="hljs-number">0</span>)
        {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"数据拷贝完毕\n"</span>);
            <span class="hljs-keyword">break</span>;
        }
        write(d_fd,buf,bytes);
    }
​
    close(s_fd);
    close(d_fd);
​
    end = clock();     <span class="hljs-comment">//计时结束</span>
    cpu_time_used = ((<span class="hljs-type">double</span>) (end - start)) / CLOCKS_PER_SEC;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"系统调用拷贝耗时：%f秒\n"</span>,cpu_time_used);
​
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
​
</code></pre>
<p>有一个要注意的点：这里使用 <code>clock()</code> 测量的是进程的 CPU 时间（用户态 + 内核态），不包含进程阻塞等待磁盘 I/O 的时间。因此，这个时间主要反映 <code>memcpy</code> 和系统调用开销，而非实际感受到的拷贝时长。</p>
<p>这段代码看起来简单，但每一次 <code>while</code> 循环都触发了系统调用：</p>
<ol>
<li>
<p>当<code>read()</code>被调用：</p>
<p>程序执行从<strong>用户态切换到内核态</strong>。CPU 保存当前上下文，加载内核上下文，这是一个耗时的操作。内核从磁盘（或 Page Cache 页缓存）读取数据，拷贝到我们传入的 <code>buf</code> 中。执行完后，再从内核态切回用户态，这又是一个耗时的操作。</p>
</li>
<li>
<p>当write() 被调用：</p>
<p>再次发生一次用户态到内核态的切换。内核将 <code>buf</code> 中的数据拷贝到内核缓冲区，准备写入磁盘。然后再切回用户态。</p>
</li>
</ol>
<p>对于一个 10MB 的文件和 4KB 的缓冲区，表面上看，这个 while 循环要执行约 2560 次，每次循环调用两次系统调用（<code>read</code> + <code>write</code>），总共约 5120 次系统调用，这意味着<strong>超过一万次的上下文切换</strong>。</p>
<p>可能有不少人（包括我最初）正是基于这种直觉，认为裸系统调用一定会慢——因为教科书告诉我们：标准库的 <code>fread/fwrite</code> 会通过用户态缓冲，把多次小 I/O 合并成少量大 I/O，从而大幅减少系统调用次数。</p>
<p>但是，当后面我们真正运行实验，才发现并没有我们想象的这么简单。</p>
<h4 data-id="heading-5">1.2.2 C库调用</h4>
<pre><code class="hljs language-C" lang="C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
​
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FILE_SOURCE <span class="hljs-string">"testfile.dat"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FILE_DESTINATION <span class="hljs-string">"des_libc_file.dat"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFFER_SIZE 4096</span>
​
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
    <span class="hljs-type">clock_t</span> start,end;
    <span class="hljs-type">double</span> cpu_time_used;
​
    start = clock();   <span class="hljs-comment">//开始计时</span>
​
    FILE *s_fp = fopen(FILE_SOURCE,<span class="hljs-string">"rb"</span>);
    <span class="hljs-keyword">if</span>(s_fp == <span class="hljs-literal">NULL</span>)
    {
        perror(<span class="hljs-string">"fopen source failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
​
    FILE *d_fp = fopen(FILE_DESTINATION,<span class="hljs-string">"wb"</span>);
    <span class="hljs-keyword">if</span>(d_fp == <span class="hljs-literal">NULL</span>)
    {
        fclose(s_fp);
        perror(<span class="hljs-string">"fopen destination failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
​
    <span class="hljs-type">char</span> buf[BUFFER_SIZE];
    <span class="hljs-type">size_t</span> read_items;
    <span class="hljs-keyword">while</span>((read_items = fread(buf,<span class="hljs-number">1</span>,BUFFER_SIZE,s_fp)) &gt; <span class="hljs-number">0</span>)
    {
        fwrite(buf,<span class="hljs-number">1</span>,read_items,d_fp);
    }
​
    <span class="hljs-keyword">if</span>(ferror(s_fp))
    {
        perror(<span class="hljs-string">"fread failed"</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(feof(s_fp))
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"数据拷贝完毕\n"</span>);
    }
​
    fclose(s_fp);
    fclose(d_fp);
​
    end = clock();    <span class="hljs-comment">//结束计时</span>
​
    cpu_time_used = ((<span class="hljs-type">double</span>) (end - start)) / CLOCKS_PER_SEC;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"C库调用耗时: %f秒\n"</span>,cpu_time_used);
​
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
​
</code></pre>
<p>表面逻辑看，C 库版本和系统调用版本几乎一模一样：同样是 4KB 的用户态缓冲区，同样是循环读取 → 写入的模式。唯一的区别在于：</p>
<ol>
<li>使用 FILE * 结构体代替文件描述符 int fd</li>
<li>使用 <code>fopen/fclose</code> 代替 <code>open/close</code></li>
<li>使用 <code>fread/fwrite</code> 代替 <code>read/write</code></li>
</ol>
<p>不少人会理所当然地认为，这个版本应该更快。原因在于教科书反复强调的观点：</p>
<p>C 标准库的 <code>stdio</code> 为每个 FILE 结构体维护了一个用户态缓冲区（默认大小通常为 <code>BUFSIZ</code>，即 8192 字节），它能将多次小块 <code>fwrite</code> 合并成一次底层 <code>write</code> 系统调用，从而大幅减少上下文切换次数。</p>
<p>然而，在我们这个实验里，缓冲区大小已经固定为 4096 字节，而且是<strong>顺序大块读取</strong>。glibc 的 stdio 实现在检测到大块且对齐良好的 I/O 时，往往会直接透传到底层系统调用，几乎不进行额外的“打包”操作。</p>
<p>更重要的是，<code>fread/fwrite</code> 每一次调用都会带来额外的开销：检查用户态缓冲区是否满或者空，还有可能的 memcpy，或者额外的函数调用层级和错误检查逻辑。</p>
<p>这些开销在小块随机 I/O 时被 <strong>减少系统调用次数</strong> 的收益完全掩盖，但在大块顺序 I/O 时，反而成了纯纯的<strong>负担</strong>。</p>
<h4 data-id="heading-6">1.2.3 Makefile</h4>
<p>下面是实验要使用的 Makefile 源码：</p>
<pre><code class="hljs language-Makefile" lang="Makefile">CC = gcc
​
CFLAGS = -Wall -g
​
<span class="hljs-section">all: sys libc</span>
​
<span class="hljs-section">sys: copy_syscall.c</span>
    <span class="hljs-variable">$(CC)</span> <span class="hljs-variable">$(CFLAGS)</span> -o sys copy_syscall.c
​
<span class="hljs-section">libc: copy_libc.c</span>
    <span class="hljs-variable">$(CC)</span> <span class="hljs-variable">$(CFLAGS)</span> -o libc copy_libc.c
​
​
​
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: all clean clean-data test</span>
​
<span class="hljs-section">clean:</span>
    rm -f sys libc des_sys_file.dat des_libc_file.dat
​
<span class="hljs-section">clean-data:</span>
    rm -f *.dat
​
<span class="hljs-section">test: all</span>
    ./sys
    ./libc
​
</code></pre>
<p>为了方便编译程序和删除程序运行生成的文件，我写了这个Makefile，下面介绍一下怎么使用。</p>
<p>命令行输入<code>make</code>编译两个 c 源代码，然后可以分别运行编译生成的可执行文件。或者直接输入 <code>make test</code>，编译并运行两个 c 源代码。</p>
<p>命令行输入<code>make clean</code>可以清除两个可执行文件和程序运行生成的两个数据拷贝文件。</p>
<p>命令行输入 <code>make clean-data</code> 可以清除上面命令行创建的用于拷贝的数据源文件。</p>
<h3 data-id="heading-7">1.3 对比测试的结果</h3>
<p>现在一切已经准备就绪，我们直接运行程序：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35ca553a618a4776866bc1c04a7c2b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=2AzdpdiQxlkKWAatnT0VAA%2FkwVk%3D" alt="2. 第一次程序运行结果.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09cb9b4bdaa4498a9bba7ffacb98132e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=s4s1TfNsr8uGlgpyVD9q5N%2BNums%3D" alt="3. 第一次运行结果（2）.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f16e64319da2428d8adc2174fbd7ccd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=p0y2ePaEgwMYEcrJgbOpdkSMUXY%3D" alt="4. 第一次运行结果（3）.png" loading="lazy"/></p>
<p>为了确保测试结果无偶然性，我将程序运行了三遍。从上面的运行结果可以看到，C库调用和系统调用两者几乎在同一个数量级上。在误差允许的范围内，我甚至可以认为他们消耗的CPU时间几乎无差异。</p>
<p>当时看到这个运行结果，我整个人陷入了迷茫：<strong>为什么在 4KB 缓冲区大小下，C 库的用户态缓冲没有带来明显的性能优势？</strong></p>
<p>要知道，对于一个 10MB 文件 + 4KB 缓冲区：如果没有用户态缓冲，理论上会触发 5120 次系统调用（2560 次 <code>read</code> + 2560 次 <code>write</code>），而有了 stdio 缓冲，按理说应该能将多次 <code>fwrite</code> 合并成少数几次大 <code>write</code>，系统调用次数大幅下降，性能应该暴涨才对。</p>
<p>可是现实中，C 库版本只快了那么一点点。这与我们通常的<code>fread/fwrite</code>显著更快的印象，完全不符。</p>
<h2 data-id="heading-8">2. 测试结果分析：<code>strace</code> 与 <code>BUFSIZ</code> 揭示的线索</h2>
<p>第一次实验那微乎其微的性能差异，让我百思不得其解。为了搞清楚 <code>fread/fwrite</code> 底层到底做了什么，我决定使用<code>strace</code>，来跟踪一下 libc 版本程序在运行时到底发起了多少次、多大的系统调用。</p>
<h3 data-id="heading-9">2.1 与预期不符的系统调用</h3>
<p>我使用以下命令来运行 libc 程序，并只关注 <code>read</code> 和 <code>write</code> 系统调用：</p>
<pre><code class="hljs language-Bash" lang="Bash">strace -e trace=<span class="hljs-built_in">read</span>,write ./libc
</code></pre>
<p>我原以为会看到少数几次、大小为 <strong>8KB</strong> (<code>BUFSIZ</code>，这个宏的值) 的 <code>read</code> 系统调用。然而，<code>strace</code> 的输出再次颠覆了我的认知：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01bb76e35ef247e8bea32f473fb5181a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=BYAfMkJvMjILu7TsxUnU%2BTEx45o%3D" alt="5. strace结果.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dc7f2fe93ea413d985c3773f969c052~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=px7QXi55ZtR7gh7Qrk49FJN5Xlo%3D" alt="6. strace结果（2）.png" loading="lazy"/></p>
<p>这里<code>read</code>和<code>write</code>的调用有<strong>上千次之多</strong>，为了让大家看到 <code>strace</code> 内容的全貌，我就只截图了最开始和最后的部分。下面我们来分析一下这两张截图：</p>
<p>从这两张图我们可以轻易的看出，其实 <code>fread</code> 和 <code>fwrite</code> 最终都是要调用 <code>read</code> 和 <code>write</code> 的。</p>
<p>先来看我们过滤后的 <code>strace</code> 的信息的第一行，可以看到它读取的字节数是832，不是我们预计的8K，但实际上这里是正常的，真正的读取还没有开始，这只是程序开始前的一些<strong>预备动作</strong>。</p>
<p>我们再往下看，发现 <code>read</code> 的文件描述符全为3，而 <code>write</code> 的文件描述符全为4，这也是符合预料的。这个和我们<strong>打开文件的顺序</strong>有关，首先，我们都知道，文件描述符的0，1，2分别被标准输入，标准输出和标准错误占据。当我们再次打开文件时，文件描述符就会从3开始，往后每打开一个文件，这个数字就会加一，还有一点要提一下，如果你打开了3，4，5，6这几个文件，然后关闭4这个文件描述符，那么下一次再打开文件时，就会把最小的文件描述符4分配出去。好了，回归正题，我们看一下C库测试程序的代码，可以观察到我们先打开的是 testfile.dat 这个文件，然后才打开了 des_libc_file.dat 这个文件，而前者正是我们要读取数据的文件，后者正是我们要写入数据的文件，到这里已经很明显了，我就不再赘述。</p>
<p>再来看 <code>strace</code> 第二张图的最后一个 <code>read</code> ，我们发现它的第二个参数是空的，为什么呢？这也是符合逻辑的，只要 <code>read</code> 读到了数据，那么它就会<strong>返回读取到的字节数</strong>。我们可以先看看第三个参数，值为4096（这个是我没有想到的，这里先放着，后面再提），也就是说<code>read</code>每次读取4096字节，即4KB，而我们设置的文件大小为10MB，正好是倍数关系，这也就是说在若干次读取后，它进行最后一次读取，而最后一次读取刚好把剩下的4096字节读完。下一次再要 <code>read</code> 时，已经没有数据可以读了，这也是为什么最后一个<code>read</code>什么都没有读到的原因。这时<code>read</code>返回0，表示<strong>读取结束</strong>。</p>
<p>最后一个 <code>read</code> 的下一条信息就是 <code>write</code> ，这里可以看到这个 <code>write</code> 文件描述符为1，也就是说它在<strong>向终端打印</strong>内容，聪明的小伙伴已经翻到上面去看代码了，发现代码逻辑中，在最后一次 <code>read</code> 结束后，确实会向终端打印“数据拷贝完毕”这几个字。</p>
<p>到这里 <code>strace</code> 的内容相信大家都能看懂了，那我就不再赘述了。来看最重要的部分：</p>
<p>正如我上面所说，我原以为能看到 <code>read</code> 和 <code>write</code> 的字节数都是 8KB，但实际上却只有上面截图中的 4KB。也就是说当我请求 4KB 数据时 <code>(fread(..., 4096, ...))</code>, stdio 库底层也精确地发起了 <strong>4KB</strong> 的 <code>read</code> 系统调用。这太令我惊讶了，但这也刚好说明了为什么，在上面的测试中C库调用和系统调用差不多，因为<strong>底层的系统调用次数完全一样</strong>！<code>fread</code> 那<strong>微乎其微</strong>的性能劣势，正来自于其额外的用户态函数调用和 <code>memcpy</code> 开销。也正是因为两者本身系统调用次数相同，在不确定性因素的影响下才会出现上面三种测试结果（谁快谁慢说不准，但<strong>总体上不相上下</strong>）。</p>
<h3 data-id="heading-10">2.2 令人困惑的<code>BUFSIZ</code></h3>
<p>在继续分析结果之前，我觉得有必要先介绍一下 <code>BUFSIZ</code> 这个宏是干什么的。</p>
<p><code>BUFSIZ</code> 这个宏定义在 <code>&lt;stdio.h&gt;</code> 中，它表示 <code>stdio</code>（标准输入输出库）为流（FILE）分配的默认缓冲区大小。当你调用 <code>fopen()</code> 打开一个文件时，C 标准库会自动为这个流分配一个<strong>内部用户态缓冲区</strong>，用于缓存读写数据。这个缓冲区的默认推荐大小就是 <code>BUFSIZ</code>。</p>
<p>全缓冲模式（普通文件默认为这个模式）：缓冲区大小<strong>通常就是 <code>BUFSIZ</code>（8KB）</strong> 。数据会累积到缓冲区满，调用 <code>fflush()</code> 或关闭流时才真正写入底层系统调用。</p>
<p>行缓冲模式（ <code>stdout</code> 连接终端时）：缓冲区大小通常是 1KB（1024 字节），与 <code>BUFSIZ</code> 无关。</p>
<p>小块 <code>fwrite()</code>（每次写几个字节）不会立即触发 <code>write()</code> 系统调用，而是先<strong>积累到用户态内部缓冲区</strong>。等缓冲区达到 BUFSIZ 大小时，才一次性调用底层 <code>write()</code> 把大块数据刷到内核。这正是为什么在小块 I/O 场景下，<code>fwrite</code> 比直接 <code>write()</code> 快得多的原因。</p>
<p>我起初以为我的系统中 <code>BUFSIZ</code> 的值不是8KB，才导致上面诡异的测试结果，于是我写了一个小<code>demo</code>查了一下<code>BUFSIZ</code>的值，请看：</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
​
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>
{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"BUFSIZ = %d\n"</span>,BUFSIZ);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
​
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d496c91b498409dbbcd40807befad56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=FSP9HSSRa8wDC%2FMKOtYqlmVKJjY%3D" alt="7. 查BUFSIZ的值.png" loading="lazy"/></p>
<p>从程序允许结果可以看出，<code>BUFSIZ</code>的值确实是 8KB 。事情又变得有趣起来了，C库明明给自己准备了一个 8KB 的大仓库，为什么实际<code>read</code>时却只使用 4KB 呢？是不是有一只强大的隐形之手在干扰这个过程呢？</p>
<h3 data-id="heading-11">2.3 注意：重点来了</h3>
<p>经过查阅资料和进一步的实验，我发现了 glibc 中一个极其精妙的优化机制：</p>
<p>当 <code>fread</code> 或 <code>fwrite</code> 检测到用户提供的缓冲区 <code>(char buf[4096])</code> <strong>足够大</strong>（通常与<strong>系统页大小或 <code>BUFSIZ</code> 相当</strong>）且<strong>内存对齐良好</strong>时，为了<strong>避免一次额外的 <code>memcpy</code> 开销</strong>，<code>stdio</code> 库会<strong>偷懒</strong>，它会<strong>直接使用用户提供的缓冲区</strong>去执行底层的 <code>read</code> 系统调用，而<strong>绕过</strong>它自己的内部缓冲区。</p>
<p>这就完美解释了我们看到的所有现象：<strong>为什么 <code>read</code> 是 4KB？</strong> 因为传给 <code>fread</code> 的 <code>buf</code> 就是 4KB。<strong>为什么性能差不多？</strong> 因为 <code>stdio</code> 库放弃了合并请求，退化成了一个和裸 <code>read/write</code> 差不多的机制，<strong>系统调用次数完全一样</strong>。</p>
<p>所以，我最初的那个性能对比实验，无意间触发了这个优化，导致没能观察到 <code>stdio</code> 真正的缓冲实力。</p>
<p>这一切的背后，都指向了 Linux 内核一个更深层次、更强大的隐形之手——<strong>页面缓存 (Page Cache)</strong> 。</p>
<h2 data-id="heading-12">3. 深入内核，解析Page Cache 的隐形加速</h2>
<p>前两章的探索让我们发现，无论是 C 库还是系统调用，在<strong>处理大块顺序 I/O</strong> 时性能都出奇地好，且差异不大。这说明，在我们的代码之下，有一个比用户态缓冲<strong>更强大、更底层</strong>的机制在主导着 I/O 性能。</p>
<p>这个机制，就是 Linux 内核为了填补<strong>飞速的 CPU</strong> 与<strong>龟速的磁盘</strong>之间巨大鸿沟而设计的——<strong>页面缓存 (Page Cache)</strong> 。</p>
<h3 data-id="heading-13">3.1 什么是 Page Cache？</h3>
<p>简单来说，<strong>Page Cache 就是内核在物理内存 (RAM) 中开辟的一块区域，专门用来缓存磁盘文件的数据。</strong> 它就像是内核给自己建的一个内存硬盘，把最近访问过的文件数据都存在里面。</p>
<p>到这儿，如果看过我上一篇文章的朋友，标题为《C语言实战：手搓高并发异步日志库（基于 Ring Buffer 和生产者消费者模型）》的3.1.3节，可能会想起 CPU 的三层缓存，为了帮大家区分并且更加深入的了解 Page Cache ，下面我将先介绍他们的共同点，在介绍他们的区别，以对比的方式列出他们的区别。</p>
<p>首先，Page Cache 和 CPU Cache <strong>在设计思想上极其相似</strong>（为了解决快慢速设备差异），但它们在<strong>物理位置、管理者、工作粒度</strong>上有着<strong>本质的区别</strong>。</p>
<h4 data-id="heading-14">3.1.1 CPU Cache 和 Page Cache 的共同点</h4>
<p>他们都遵循着一个真理，就是<strong>局部性原理</strong>。这个局部性原理包括<strong>空间局部性</strong>和<strong>时间局部性</strong>，空间局部性在我的上一篇文章（异步日志库那个）也有提过。在上篇文章的场景下，就是说你CPU在访问数组的一个元素时，由于同一个数组的元素是连续存放的，根据空间局部原理，你用了一个数据，有大概率也会用到它旁边的数据，因此CPU拿到的就不仅仅是它要访问的那个数据，而是那个元素所在的<strong>一整个Cache Line</strong>（总共64字节）。对详细内容感兴趣的读者可以去看看我上一篇，这里先回归正题。我用大白话描述一下这两个原理：</p>
<p><strong>时间局部性</strong>：刚用过的数据，很可能马上又要用。</p>
<p><strong>空间局部性</strong>：用了 A 数据，很可能马上要用 A 存储位置附近的数据。</p>
<p>无论是 CPU Cache 还是 Page Cache，都是利用这个原理，把<strong>热门</strong>数据从<strong>慢速区</strong>搬到<strong>快速区</strong>暂存，以备后用。</p>
<h4 data-id="heading-15">3.1.2 CPU Cache 和 Page Cache 的本质区别</h4>
<p>在介绍他们的本质区别之前大家先来看一张图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96c12c0a7aeb41e99cee53d5b58d7725~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=%2Ftk0XiJJxetev49z4ufp4Q6ZNIs%3D" alt="8. 框架图.png" loading="lazy"/></p>
<p>这张图已经揭示了他们的区别：</p>
<p>第一，他们的管理者不同。</p>
<p>CPU 三层 Cache 由 CPU <strong>硬件自动管理</strong>，无法通过程序进行控制。写一个 <code>int a = 1;</code>，数据会不会进 L1 Cache，或者什么时候被踢出去，都是 CPU 自己的事。我们只能通过<strong>写出缓存友好的代码</strong>（比如遍历数组）来间接帮助它提升性能。</p>
<p>Page Cache 由<strong>操作系统内核（软件）</strong> 管理，虽然不能直接读写，但可以通过一些系统调用来<strong>影响</strong>它，<code>mmap</code>, <code>O_DIRECT</code> 也能直接操作 Page Cache。</p>
<p>第二，服务对象不同。</p>
<p>CPU Cache 服务于 <strong>CPU 的计算指令</strong>，它的目标是让 <code>add</code>, <code>mov</code> 这些指令能以最快速度拿到操作数。</p>
<p>Page Cache：服务于 <strong>I/O 系统调用</strong>，它的目标是让 <code>read</code>, <code>write</code> 感觉上像是操作内存，而不是操作慢速磁盘。</p>
<p>第三，工作粒度不同。</p>
<p>CPU Cache：工作单位是 <strong>Cache Line (64 字节)</strong> 。</p>
<p>Page Cache：工作单位是 <strong>Page (4KB)</strong> 。</p>
<h4 data-id="heading-16">3.1.3 总结</h4>
<p>CPU Cache 是 CPU 与内存之间的硬件缓存，由 CPU 硬件自动管理，对程序员透明，目的是加速计算指令。</p>
<p>Page Cache 是内存与磁盘之间的软件缓存，由操作系统内核管理，目的是加速文件 I/O。</p>
<p>一个是<strong>硬件层面</strong>，一个是<strong>内核软件层面</strong>，两者协同工作，才构成了现代计算机高效的 I/O 体系。</p>
<h3 data-id="heading-17">3.2 Page Cache 的三大特性</h3>
<p>第一，透明性：</p>
<p>Page Cache 对上层的应用程序是<strong>完全透明</strong>的。你只管调用 <code>read</code>，但根本不知道数据是从内存来的还是从硬盘来的，内核已经帮你搞定了一切。</p>
<p>第二，脏页回写：</p>
<p>当你调用 <code>write</code> 时，数据也不是立刻就写到硬盘里。内核会先把数据写入对应的 Page Cache，并把这个 Page 标记为<strong>脏页 (Dirty Page)</strong> 。<code>write</code> 系统调用会立刻返回，你的程序感觉<strong>写入已经完成</strong>了。内核会在后台找个合适的时间（比如系统不忙时，或者脏数据积累到一定程度），再把这些<strong>脏页统一刷回磁盘</strong>。这也是为什么 <code>write</code> 看起来很快的原因之一。</p>
<p>第三，预读：</p>
<p>当内核检测到你在<strong>顺序读取</strong>一个文件时（比如你正在 <code>read</code> 第 1-4KB），它会<strong>猜测</strong>你马上就要读第 5-8KB、9-12KB...于是，它会提前把文件的<strong>后续内容也加载到 Page Cache</strong> 里。当你真的 <code>read</code> 后续内容时，发现数据已经在内存里面了（当然，你不会真的发现，你只会感觉程序运行很快）。</p>
<h3 data-id="heading-18">3.3 清除页缓存后的结果</h3>
<p>根据上面的三大特性，我猜想第一次实验结果可能是从Page Cache里面拿的数据。所以总体速度很快，如果清除页缓存后，速度可能会变慢，所以我又进行了第二次实验。</p>
<p>在第二次实验中，我每次在运行程序之前，都会将页缓存清除：</p>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/vm/drop_caches
</code></pre>
<p>数字1代表清除Page Cache。</p>
<p>然后我得到了下面的结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2469fe05f2945659cbcd05476b25e68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=VgAtEcdrAK1cuBM1ulh8Dlh%2BBDg%3D" alt="9. 第二次实验（1）.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e741de61c6af4d8788baa33663303a3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=T9S73I%2F6ttNl5azJV5fMLLl%2FwUk%3D" alt="10. 第二次实验（2）.png" loading="lazy"/></p>
<p>我依旧运行了两次，我们现在有两点<strong>不需要关注</strong>。第一点是为什么<strong>两次运行的结果不同</strong>，这是因为虚拟机的不稳定行或者受到系统噪声影响造成的，因此我们不需要关注。第二点是<strong>C库调用和系统调用在忽略干扰因素后差距不大</strong>，这在上面（2.3 节）已经提到过了，是因为在4KB用户态缓冲的条件下他们的系统调用次数是相同的，这个问题我们已经了解了，因此也不需要关注。</p>
<p>我们唯一需要关注的就是第二次实验（也就是本次）总体和第一次实验总体上的差异。可以看到第一次实验，数据基本都在0.02左右徘徊，而第二次实验结果基本都在0.04-0.05之间。</p>
<p>这也恰恰验证了 Page Cache 在<strong>数据拷贝时的加速功能</strong>。第二次实验在清除 Page Cache 后运行程序，要比第一次没有清除 Page Cache 慢1倍左右。</p>
<h3 data-id="heading-19">3.4 结论</h3>
<p>至此，我们已经离真相不远了。</p>
<p>Page Cache 解释了<strong>为什么这么快</strong>，glibc 策略解释了<strong>为什么差距不大</strong>。</p>
<p>而要想真正看到 <code>fread/fwrite</code> 的真正速度，我们必须<strong>打破4KB 对齐的舒适区</strong>，去模拟一个<strong>极端的高频小包 I/O 场景</strong>。</p>
<h2 data-id="heading-20">4. 逼近最后的真相</h2>
<h3 data-id="heading-21">4.1 设计第二次实验并得出结果</h3>
<p>既然大块 I/O 拉不开差距，那我们就来模拟<strong>小包高频</strong>的场景，比如解析协议、处理串口数据等。我将 <code>BUFFER_SIZE</code> 改为 <strong>16 字节</strong>，再次测试 10MB 文件。</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFFER_SIZE 16</span>
</code></pre>
<p>我们这里要将<strong>两个拷贝程序</strong>中的宏定义用户态缓冲区大小改为16。然后清除之前程序运行产生的文件，并重新编译。在每次运行程序之前清理一下 Page Cache ，最终运行结果如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1deea4983a184db5be02692e9848fd9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=cX%2B01pDaY5JDNWYxhANLTVDcswQ%3D" alt="11. 修改为16的结果.png" loading="lazy"/></p>
<h3 data-id="heading-22">4.2 第二次实验结果分析</h3>
<p>第二次实验中，系统调用消耗时间为<strong>1.698秒</strong>，而C库调用仅为<strong>0.05秒</strong>，<strong>差距高达32倍</strong>。</p>
<p>为了拷贝 10MB 数据，每次搬运 16 字节，这意味着程序发起了 <strong>超过 130 万次</strong> 的 <code>read/write</code> 系统调用。CPU 绝大部分时间都浪费在了<strong>用户态与内核态的上下文切换</strong>上，导致效率极低。</p>
<p>而C库调用通过其内部缓冲区，将成百上千次的小额 <code>fwrite</code> 请求合并为一次底层的 <code>write</code> 系统调用。<strong>用廉价的内存拷贝（memcpy）换掉了昂贵的内核切换</strong>，这就是 33 倍性能差距的来源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0834000ab254eec9061c1b95153a98f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=gHPxX20QYM2xC1DwagY58npxgWw%3D" alt="12. 第二次strace（1）.png" loading="lazy"/></p>
<p>为了验证 C 库是如何处理这 16 字节请求的，我又去查了strace，发现确实是4096，这足以说明，数据先从用户态缓冲区的16字节到C库缓冲区，<strong>攒够4096字节后再一次交给内核</strong>。因此第二次实验的两个拷贝程序的系统调用次数差距是非常大的，所以消耗时间的差距也非常大。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/268ea7e6cbe44eb0b3e180819a962540~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=srtQc8xjVVHfVh%2FC28%2BEigyCFic%3D" alt="13. sys的strace.png" loading="lazy"/></p>
<p>而对于系统调用的 <code>strace</code> ，也就在预料之中了，因为程序中我们设置的缓冲区大小就是16，<code>strace</code> 的结果如果不是 16 那才真的奇怪了。</p>
<h3 data-id="heading-23">4.3 glibc 原来会去查 st_blksize 的值</h3>
<p>这里有个有趣的细节，细心的读者可能发现，虽然 <code>&lt;stdio.h&gt;</code> 中的 <code>BUFSIZ</code> 定义为 8192，但在 <code>strace</code> 中看到的系统调用大小却是 4096。</p>
<p>这是因为 glibc 的实现非常智能。在打开文件时，它会通过 <code>fstat</code> 获取文件系统推荐的<strong>最佳 I/O 块大小</strong> (<code>st_blksize</code>) <strong>。在我的 Linux 虚拟机中，Ext4 文件系统的块大小正是</strong> 4KB。C 库顺势调整了缓冲策略以匹配这一物理特性，从而避免了跨块读写带来的额外开销。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4652eac775f48d893d01119bf8c2cee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGxwNjY2aHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766324940&amp;x-signature=UyCjH7U3o4QBc8b5fsxVOE9O3Ec%3D" alt="14. testfile信息.png" loading="lazy"/></p>
<p>我们观察一下测试文件的信息，发现 I/O 块大小为 4096。实际上，当 <code>fopen</code> 打开一个文件时，glibc 的 <code>stdio</code> 实现会调用 <code>fstat</code> 系统调用去询问内核，这个文件所在磁盘的<strong>最佳 I/O 块大小</strong>为多少。对于绝大多数 Linux 文件系统（如 Ext4, XFS），这个最佳块大小（<code>st_blksize</code>）都是 <strong>4096 字节 (4KB)</strong> 。</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
​
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    FILE *fp = fopen(<span class="hljs-string">"testfile.dat"</span>, <span class="hljs-string">"rb"</span>);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span>
    fstat(fileno(fp), &amp;st);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"st_blksize = %ld\n"</span>, st.st_blksize);  <span class="hljs-comment">// 通常 4096</span>
    fclose(fp);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>想验证的读者可以使用这段代码，我就不在贴出运行结果了。</p>
<h2 data-id="heading-24">5. 系统调用 VS C库，如何选择？</h2>
<p>我们从 Page Cache 的干扰，到 glibc 的旁路优化，再到极限小包的性能碾压，终于看清了 Linux I/O 的全貌。</p>
<p>回到最初的问题：<strong>read/write 和 fread/fwrite 到底谁更快？</strong></p>
<h3 data-id="heading-25">5.1 实验结论复盘</h3>
<p>大块顺序 I/O (≥ 4KB)：不相上下</p>
<p><strong>原因</strong>：现代 Linux 内核的 Page Cache 和预读机制极其强大，系统调用的开销被 I/O 延迟稀释。且 glibc 在大块对齐读写时会触发旁路优化，直接<strong>透传</strong>数据，两者底层的系统调用行为几乎一致。</p>
<p><strong>小块/随机 I/O (&lt; 4KB)</strong> ：C库完胜</p>
<p><strong>原因</strong>：stdio 的用户态缓冲区发挥了关键作用。它像一个高效的批发商，将成千上万次碎片的 <code>read/write</code> 请求，合并为少数几次系统调用。<strong>用廉价的内存拷贝（memcpy），换掉了昂贵的内核态上下文切换。</strong></p>
<h3 data-id="heading-26">5.2 决策指南</h3>
<p>那么在实际操作中，我们该如何选择呢？</p>
<p>实际上，对于大部分情况，我们直接使用C库就好了，</p>
<p>只有在下面的特殊情况时，才使用系统调用直接操作文件描述符：</p>
<p>第一种就是<strong>网络编程</strong>：<code>Socket</code> 通信必须操作 <code>fd</code>，且需要配合 <code>epoll/select</code> 使用。</p>
<p>第二种是<strong>设备操作</strong>：操作 <code>/dev/</code> 下的<strong>硬件</strong>设备，或者需要 <code>ioctl</code> 控制时。</p>
<p>第三种是<strong>特殊文件 I/O</strong>：需要<strong>非阻塞 I/O</strong> (<code>O_NONBLOCK</code>)。需要<strong>直接 I/O</strong> (<code>O_DIRECT</code>) 绕过 Page Cache（如数据库开发）。或者需要<strong>文件元数据操作</strong> (<code>ftruncate</code>, <code>fsync</code>)。</p>
<h3 data-id="heading-27">5.3 结语</h3>
<p>所谓的性能优化，从来没有绝对的胜利者。</p>
<p>系统调用赢在<strong>控制力</strong>，C 库赢在<strong>效率与易用性</strong>。</p>
<p>只有理解了从 <strong>用户缓冲区 -&gt; C 库内部缓冲 -&gt; 系统调用 -&gt; Page Cache -&gt; 磁盘</strong> 的整条链路，你才能在面对不同的业务需求时，写出真正高效、健壮的代码。</p>
<h2 data-id="heading-28">6. 项目源码</h2>
<p>👉**<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxlp666hub%2FLinux-IO-Benchmark.git" target="_blank" title="https://github.com/xlp666hub/Linux-IO-Benchmark.git" ref="nofollow noopener noreferrer">github链接</a>**</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据库查询的时区问题]]></title>    <link>https://juejin.cn/post/7583225356905725992</link>    <guid>https://juejin.cn/post/7583225356905725992</guid>    <pubDate>2025-12-14T17:07:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583225356905725992" data-draft-id="7583469866007478307" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据库查询的时区问题"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-14T17:07:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想不出名儿"/> <meta itemprop="url" content="https://juejin.cn/user/3063680556091133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据库查询的时区问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3063680556091133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想不出名儿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T17:07:02.000Z" title="Sun Dec 14 2025 17:07:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-number">2025</span>-<span class="hljs-number">10</span>-<span class="hljs-number">18</span> <span class="hljs-number">00</span>:<span class="hljs-number">57</span>:<span class="hljs-number">23.131</span> <span class="hljs-keyword">ERROR</span> <span class="hljs-number">60896</span> --- [nio-<span class="hljs-number">8123</span>-exec-<span class="hljs-number">6</span>] c.y.c.exception.GlobalExceptionHandler   : RuntimeException:

org.springframework.http.converter.HttpMessageNotReadableException: JSON parse <span class="hljs-keyword">error</span>: 
Cannot deserialize value <span class="hljs-keyword">of</span> type `java.util.<span class="hljs-type">Date</span>` <span class="hljs-keyword">from</span> <span class="hljs-type">String</span> <span class="hljs-string">"2025-10-18 00:52:00"</span>: 
<span class="hljs-built_in">not</span> a valid representation (<span class="hljs-keyword">error</span>: Failed <span class="hljs-keyword">to</span> parse <span class="hljs-type">Date</span> value <span class="hljs-comment">'2025-10-18 00:52:00': </span>
Cannot parse <span class="hljs-type">date</span> <span class="hljs-string">"2025-10-18 00:52:00"</span>: <span class="hljs-keyword">while</span> it seems <span class="hljs-keyword">to</span> fit format <span class="hljs-comment">'yyyy-MM-dd'T'HH:mm:ss.SSSX', parsing fails (leniency? null)); </span>
nested exception <span class="hljs-built_in">is</span> com.fasterxml.jackson.databind.exc.InvalidFormatException: 
Cannot deserialize value <span class="hljs-keyword">of</span> type `java.util.<span class="hljs-type">Date</span>` <span class="hljs-keyword">from</span> <span class="hljs-type">String</span> <span class="hljs-string">"2025-10-18 00:52:00"</span>: 
<span class="hljs-built_in">not</span> a valid representation (<span class="hljs-keyword">error</span>: Failed <span class="hljs-keyword">to</span> parse <span class="hljs-type">Date</span> value <span class="hljs-comment">'2025-10-18 00:52:00': </span>
Cannot parse <span class="hljs-type">date</span> <span class="hljs-string">"2025-10-18 00:52:00"</span>: 
<span class="hljs-keyword">while</span> it seems <span class="hljs-keyword">to</span> fit format <span class="hljs-comment">'yyyy-MM-dd'T'HH:mm:ss.SSSX', parsing fails (leniency? null))</span>
 at [Source: (org.springframework.util.StreamUtils$NonClosingInputStream); line: <span class="hljs-number">12</span>, column: <span class="hljs-number">16</span>] 
(through reference chain: com.yu.cloudpicturebackend.model.dto.picture.PictureQueryRequest[<span class="hljs-string">"beginTime"</span>])
	
</code></pre>
<p>原先请求类时间字段使用 Date 格式，这个错误是因为 <strong>日期格式不匹配</strong> 导致的。Jackson 无法将字符串 <code>"2025-10-18 00:52:00"</code> 解析为 <code>java.util.Date</code> 类型。</p>
<h2 data-id="heading-0">问题分析</h2>
<p>错误信息显示：</p>
<ul>
<li>期望的格式：<code>yyyy-MM-dd'T'HH:mm:ss.SSSX</code>（ISO 8601 格式）</li>
<li>实际传入的格式：<code>yyyy-MM-dd HH:mm:ss</code>（空格分隔）</li>
</ul>
<h2 data-id="heading-1">解决方案</h2>
<h2 data-id="heading-2">方案1：给字段添加注解</h2>
<h3 data-id="heading-3">在请求类的字段上添加注解</h3>
<p>在 <code>PictureQueryRequest</code> 类的 <code>beginTime</code> 字段上添加日期格式注解，使前端传来的时间能被正确解析为北京时间：</p>
<p>java</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.fasterxml.jackson.<span class="hljs-keyword">annotation</span>.JsonFormat;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PictureQueryRequest</span> {

    <span class="hljs-meta">@JsonFormat(pattern = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>, timezone = <span class="hljs-string">"GMT+8"</span>)</span>
    <span class="hljs-keyword">private</span> LocalDateTime beginTime;

    <span class="hljs-comment">// 其他字段...</span>

    <span class="hljs-comment">// getter 和 setter</span>
}
</code></pre>
<h3 data-id="heading-4">在返回的VO类的字段上添加注解</h3>
<p>在 <code>PictureVO</code> 类的 <code>createTime</code> 字段上添加日期格式注解，</p>
<p><strong>避免：序列化时</strong> Jackson 将 <code>LocalDateTime</code> 当作 <strong>无时区信息</strong> 的时间，可能按系统默认时区（UTC）序列化</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseModel</span> <span class="hljs-title">implements</span> <span class="hljs-title">Serializable</span> {

    <span class="hljs-keyword">private</span> static <span class="hljs-keyword">final</span> long serialVersionUID = <span class="hljs-number">1922399947283616441L</span>;

    <span class="hljs-comment">/**
     * 创建时间
     */</span>
    <span class="hljs-meta">@JsonFormat(pattern = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>, timezone = <span class="hljs-string">"GMT+8"</span>)</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;

    <span class="hljs-comment">/**
     * 编辑时间
     */</span>
    <span class="hljs-meta">@JsonFormat(pattern = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>, timezone = <span class="hljs-string">"GMT+8"</span>)</span>
    <span class="hljs-keyword">private</span> LocalDateTime editTime;

    <span class="hljs-comment">/**
     * 更新时间
     */</span>
    <span class="hljs-meta">@JsonFormat(pattern = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>, timezone = <span class="hljs-string">"GMT+8"</span>)</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;

}
</code></pre>
<h2 data-id="heading-5">方案2：全局配置日期格式</h2>
<ul>
<li>如果封装的请求类日期字段都是使用的 Date 格式，即可直接使用下面的全局配置</li>
</ul>
<p>在 <code>application.yml</code>中配置：</p>
<p><strong>application.yml:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">jackson:</span>
    <span class="hljs-attr">date-format:</span> <span class="hljs-string">yyyy-MM-dd</span> <span class="hljs-string">HH:mm:ss</span>
    <span class="hljs-attr">time-zone:</span> <span class="hljs-string">GMT+8</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[挖到 4 个 Vibe Coding 的 GitHub 开源项目，速速收藏。]]></title>    <link>https://juejin.cn/post/7583845695179849734</link>    <guid>https://juejin.cn/post/7583845695179849734</guid>    <pubDate>2025-12-15T03:02:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583845695179849734" data-draft-id="7583422863496413227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="挖到 4 个 Vibe Coding 的 GitHub 开源项目，速速收藏。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-15T03:02:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            挖到 4 个 Vibe Coding 的 GitHub 开源项目，速速收藏。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T03:02:04.000Z" title="Mon Dec 15 2025 03:02:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Andrej Karpathy 是 OpenAI 创始成员、前特斯拉 AI 总监。</p>
<p>他年初在 X 上发布了一条推文，分享了自己使用 Cursor + Claude 进行编程的体验，并首次使用了 Vibe Coding 这个词。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5306d915ad9946a196b4655a2db5bdeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372524&amp;x-signature=Te6to0jsxLl07D0lydCvKJ4sVlY%3D" alt="图片" loading="lazy"/></p>
<p>Vibe Coding 是一种全新的、基于 AI 的编程方式。你通过对话的方式和 AI 协作，开发出一个应用或者网站。这个过程甚至忘记代码的存在。</p>
<p>你只负责看效果，如果不对就继续对 AI 说，直到感觉对味了为止。</p>
<p>所以你可以完全专注于功能实现，而忽略底层代码细节。相当沉浸、相当 Vibe。</p>
<p>今天推荐几个 GitHub 上 Vibe Coding 相关的开源项目，感兴趣的速速收藏。</p>
<h2 data-id="heading-0">01、AI 编程指南</h2>
<p>如果你没有任何基础，也想试一下 Vibe Coding 但是不知道怎么搞。</p>
<p>建议先把这个叫 aicodeguide 的项目内容搂一遍。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7040bb82aa6a4627b766c2c507faeafd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372524&amp;x-signature=dDTJEHWJ7yKfRioFX77Mz5jF1wo%3D" alt="图片" loading="lazy"/></p>
<p>这是一份 AI 编程路线图，帮助零基础小白适应 AI 时代的编程新范式。</p>
<p>写的很详细，系统整理了 Cursor、Bolt.new 等<strong>前沿 AI 工具栈</strong>，也详细拆解了如何通过 Prompt 高效控制 AI 完成开发的<strong>具体工作流与最佳实践</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d01ee6eb815d41d5b7249ee777b07ca7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372524&amp;x-signature=pQpUu0YW8GORR4rgd3MvIU0GW0w%3D" alt="图片" loading="lazy"/></p>
<p>同时还有各种资源、教程和博客，如果你从来没搞过 Vibe Coding ，从这个开源项目开始吧。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/automata/aicodeguide</span>
</code></pre>
<h2 data-id="heading-1">02、提示词模板</h2>
<p>这个开源项目帮你梳理了一套工作流程和提示词模板，能让你在数小时构建一个产品 MVP 版本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6748957dbb1f4f538557e4c4deddc9e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372524&amp;x-signature=JHN3mo7FEVSUKzi2XckdCEFur5Q%3D" alt="图片" loading="lazy"/></p>
<p>这个项目将 AI 开发软件的过程拆解为 5 个标准步骤：Research（研究）、Define（定义）、Design（设计）、Generate Agent Instructions（生成指令）、Build（构建）。</p>
<p>并为每一步提供了专门的提示词模版，以确保 AI 输出的质量和一致性，大大提高了复杂项目的成功率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b4ee07b18b24ad893e8657bd7d08f4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372524&amp;x-signature=1uLE1MXzQlLlzruGzc4KWCztio8%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这个开源项目会强制你在写代码前先生成 PRD 和技术文档，这虽然是传统工程实践，但在 AI 时代通过 Prompt 自动化后变得非常高效。</p>
<p>如果你是产品经理或创业者，想要快速验证想法、构建 MVP，就来试试这个开源项目。</p>
<pre><code class="hljs language-bash" lang="bash">开源地址：https://github.com/KhazP/vibe-coding-prompt-template
</code></pre>
<p>另外如果你使用 Claude Code 作为主力工具，可以看看下面这个项目。</p>
<p>这是一套配置和指令的集合，可以把里面的配置逻辑复制到你的全局配置或项目根目录的配置中。</p>
<p>这样你就能把 Research -&gt; Plan -&gt; Code 的理念固化到了工具的默认设置里了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6742b14acaf4968a2677b507540043b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372524&amp;x-signature=jOG3EuLRz%2B3M2Z3WuomiUZ85pYM%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/feiskyer/claude-code-settings</span>
</code></pre>
<h2 data-id="heading-2">03、Vibe Coding 终极指南</h2>
<p>如果你想用 Claude Code 或 Cursor 来 Vibe Coding，这个指南有两个版本，可以分别看 V1.2 和 V1.1。</p>
<p>这个作者的理念是：规划就是一切。 不要让 AI 自主规划，否则你的代码库将变得一团糟。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b6b2123d8c483191cf32ee737c2ecb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372524&amp;x-signature=ez67mKlUQf5bINt6XMbatHC7Yq0%3D" alt="图片" loading="lazy"/></p>
<p>这个开源项目侧重于教育和流程引导。</p>
<p>作者不仅提供了 Prompt，还通过详细的文档手把手教你如何配置环境、选择工具、以及如何用 Prompt 把控开发节奏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11ca9f74c204402c9ab86c13e5aacf3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372524&amp;x-signature=bmQngt0XclLTCq%2BKmLRCm%2BQrJUg%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">开源地址：https://github.com/EnzeD/vibe-coding
</code></pre>
<h2 data-id="heading-3">04、Awesome Vibe Coding</h2>
<p>汇总全球范围内各类 AI 辅助编程工具。 </p>
<p>它不只收集提示词，更多的是收集软件工具。如果你想知道除了 Cursor 和 Windsurf 之外，还有哪些冷门但好用的 AI 编程工具，看这里就对了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a6e8c45736e485d98a1632bc69afeeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372524&amp;x-signature=wnbbggcQ9kiXV3Mbz7K%2BXQd1aFg%3D" alt="图片" loading="lazy"/></p>
<p>该项目主要包含以下几大板块：IDE 与插件、命令行工具、网页版工具、相关教程资源。</p>
<p>看了一下，网页版工具还有挺多有意思的开源项目的，逛逛后面单独发一篇文章介绍一下。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2af30c02db374e368c5ef0f973009d0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766372524&amp;x-signature=pAAEXJjb6N6wQI89ZGknFPpzCXE%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/filipecalegario/awesome-vibe-coding</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 高可用策略库-Resilience]]></title>    <link>https://juejin.cn/post/7583249151552552994</link>    <guid>https://juejin.cn/post/7583249151552552994</guid>    <pubDate>2025-12-14T18:04:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583249151552552994" data-draft-id="7583249151552520226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 高可用策略库-Resilience"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-12-14T18:04:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Targo"/> <meta itemprop="url" content="https://juejin.cn/user/1508954436024605"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 高可用策略库-Resilience
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1508954436024605/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Targo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T18:04:24.000Z" title="Sun Dec 14 2025 18:04:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务和高并发场景中，服务的可用性、稳定性和健壮性至关重要。Go 语言虽然轻量高效，但在容错策略方面缺少一站式解决方案。为此，我开源了 <strong>Resilience</strong> —— 一个 Go 原生实现的高可用策略库，支持重试、熔断、隔离、超时和回退等策略组合。</p>
<p>本文将带你全面了解这个库的设计理念、核心实现和使用方式。</p>
<hr/>
<h2 data-id="heading-0">一、项目背景</h2>
<p>在实际生产中，常见的容错场景包括：</p>
<ul>
<li><strong>服务偶发失败</strong>：网络抖动或依赖服务短暂不可用</li>
<li><strong>请求超时</strong>：希望在一定时间内完成操作</li>
<li><strong>并发控制</strong>：限制某些操作的最大并发数，防止雪崩</li>
<li><strong>熔断</strong>：连续失败时快速失败，保护后端服务</li>
<li><strong>回退</strong>：操作失败时提供默认返回或备用方案</li>
</ul>
<p>为了应对这些场景，我实现了 <code>Resilience</code> 库，它可以在 Go 项目中轻松组合各种策略，保证服务的稳定性和可用性。</p>
<hr/>
<h2 data-id="heading-1">二、核心策略</h2>
<h3 data-id="heading-2">1. Retry（重试）</h3>
<pre><code class="hljs language-go" lang="go">retry := NewRetry(<span class="hljs-number">3</span>).
    Handle(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">bool</span> { <span class="hljs-keyword">return</span> err != <span class="hljs-literal">nil</span> }).
    WithBackoff(ExponentialBackoff{Base: <span class="hljs-number">100</span>*time.Millisecond})
</code></pre>
<ul>
<li>支持最大重试次数或无限重试</li>
<li>可自定义重试条件和回调</li>
<li>支持多种退避策略（固定、指数、随机）</li>
</ul>
<hr/>
<h3 data-id="heading-3">2. Timeout（超时）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">timeout</span> := NewTimeout(50 * time.Millisecond)
</code></pre>
<ul>
<li>支持乐观模式（基于 context 取消）</li>
<li>支持悲观模式（无视函数行为强制超时）</li>
<li>可设置超时回调</li>
</ul>
<hr/>
<h3 data-id="heading-4">3. Fallback（回退）</h3>
<pre><code class="hljs language-go" lang="go">fallback := NewFallback(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 默认返回或备用逻辑</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
})
</code></pre>
<ul>
<li>支持自定义错误条件</li>
<li>支持回调函数</li>
<li>可与其他策略组合使用</li>
</ul>
<hr/>
<h3 data-id="heading-5">4. Bulkhead（隔离/并发控制）</h3>
<pre><code class="hljs language-css" lang="css">bulkhead := <span class="hljs-built_in">NewBulkhead</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>).<span class="hljs-built_in">OnRejected</span>(<span class="hljs-built_in">func</span>(ctx context.Context) {
    fmt<span class="hljs-selector-class">.Println</span>("请求被拒绝，已达到最大并发")
})
</code></pre>
<ul>
<li>限制最大并发执行数</li>
<li>支持排队队列</li>
<li>支持拒绝回调</li>
</ul>
<hr/>
<h3 data-id="heading-6">5. CircuitBreaker（熔断器）</h3>
<pre><code class="hljs language-go" lang="go">cb := NewCircuitBreaker(<span class="hljs-number">3</span>, <span class="hljs-number">50</span>*time.Millisecond).
    OnBreak(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(err <span class="hljs-type">error</span>, dur time.Duration)</span></span>{ fmt.Println(<span class="hljs-string">"熔断触发"</span>) }).
    OnReset(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>{ fmt.Println(<span class="hljs-string">"熔断重置"</span>) }).
    OnHalfOpen(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>{ fmt.Println(<span class="hljs-string">"HalfOpen 状态"</span>) })
</code></pre>
<ul>
<li>支持失败次数阈值</li>
<li>支持开闭半开状态切换</li>
<li>支持回调函数</li>
</ul>
<hr/>
<h3 data-id="heading-7">6. WrapPolicy（策略组合）</h3>
<pre><code class="hljs language-go" lang="go">wrapped := Wrap(retry, timeout, fallback, bulkhead, cb)

err := wrapped.Execute(context.Background(), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">return</span> callRemoteService()
})
</code></pre>
<ul>
<li>支持多策略组合</li>
<li>执行顺序从内向外</li>
<li>可实现复杂容错链路</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、性能与基准测试</h2>
<p>核心策略性能如下：</p>






























<table><thead><tr><th>策略</th><th>ns/op</th><th>allocs/op</th></tr></thead><tbody><tr><td>Retry (单次)</td><td>7 ns</td><td>0</td></tr><tr><td>Fallback</td><td>5 ns</td><td>0</td></tr><tr><td>Bulkhead 并发</td><td>12 μs</td><td>0</td></tr><tr><td>CircuitBreaker 并发</td><td>168 ns</td><td>0</td></tr></tbody></table>
<ul>
<li>零内存分配，极低开销</li>
<li>并发安全，适合高 QPS 场景</li>
</ul>
<p>完整基准测试已集成在项目仓库，可直接使用：</p>
<pre><code class="hljs language-bash" lang="bash">go <span class="hljs-built_in">test</span> -bench=. -benchmem ./resilience
</code></pre>
<hr/>
<h2 data-id="heading-9">四、使用场景</h2>
<ul>
<li><strong>微服务调用保护</strong>：结合 Retry + Timeout + CircuitBreaker</li>
<li><strong>高并发请求隔离</strong>：使用 Bulkhead 控制服务压力</li>
<li><strong>降级策略</strong>：Fallback 提供默认值或备用逻辑</li>
<li><strong>组合策略管道</strong>：WrapPolicy 实现复杂策略组合</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-scss" lang="scss">wrapped := <span class="hljs-built_in">Wrap</span>(
    <span class="hljs-built_in">NewRetry</span>(<span class="hljs-number">3</span>),
    <span class="hljs-built_in">NewTimeout</span>(<span class="hljs-number">100</span>*time.Millisecond),
    <span class="hljs-built_in">NewFallback</span>(<span class="hljs-built_in">func</span>(ctx context.Context) error { return nil }),
    <span class="hljs-built_in">NewBulkhead</span>(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>),
    <span class="hljs-built_in">NewCircuitBreaker</span>(<span class="hljs-number">5</span>, <span class="hljs-number">1</span>*time.Second),
)
</code></pre>
<hr/>
<h2 data-id="heading-10">五、开源仓库</h2>
<ul>
<li>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHongFeng-Chen%2Fresilience" target="_blank" title="https://github.com/HongFeng-Chen/resilience" ref="nofollow noopener noreferrer">github.com/HongFeng-Ch…</a></li>
<li>支持 GoDoc 文档自动生成</li>
</ul>
<hr/>
<h2 data-id="heading-11">六、总结</h2>
<p><code>Resilience</code> 是一个 <strong>工业级 Go 高可用策略库</strong>：</p>
<ul>
<li>支持 Retry、Timeout、Fallback、Bulkhead、CircuitBreaker 等策略</li>
<li>高性能、零内存分配</li>
<li>并发安全</li>
<li>支持策略组合，易于扩展</li>
</ul>
<p>未来计划：</p>
<ul>
<li>增加 OpenTelemetry 指标支持</li>
<li>支持更多 Backoff 策略</li>
<li>提供策略链路可视化工具</li>
</ul>
<p>💡 如果你的 Go 项目需要微服务容错、熔断、降级或高并发控制，<code>Resilience</code> 可以直接提升系统稳定性。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter&TolyUI#12 | 树形组件 toly_tree 重磅推出!]]></title>    <link>https://juejin.cn/post/7583499967237259298</link>    <guid>https://juejin.cn/post/7583499967237259298</guid>    <pubDate>2025-12-15T01:46:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583499967237259298" data-draft-id="7583507286317694976" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter&amp;TolyUI#12 | 树形组件 toly_tree 重磅推出!"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-12-15T01:46:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张风捷特烈"/> <meta itemprop="url" content="https://juejin.cn/user/149189281194766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter&amp;TolyUI#12 | 树形组件 toly_tree 重磅推出!
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189281194766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张风捷特烈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T01:46:17.000Z" title="Mon Dec 15 2025 01:46:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1b2f7d2ec8b4ca0ac1b5feadf97637b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=800&amp;h=450&amp;s=33895&amp;e=jpg&amp;b=031126" alt="" loading="lazy"/></p>
<h4 data-id="heading-0">《Flutter TolyUI 框架》系列前言:</h4>
<p><strong>TolyUI</strong> 是 <a href="https://juejin.cn/user/149189281194766" target="_blank" title="https://juejin.cn/user/149189281194766">张风捷特烈</a> 打造的 Fluter 全平台应用开发 UI 框架。具备 <strong>全平台</strong>、<strong>组件化</strong>、<strong>源码开放</strong>、<strong>响应式</strong> 四大特点。可以帮助开发者迅速构建具有响应式全平台应用软件：</p>
<blockquote>
<p>开源地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTolyFx%2Ftoly_ui" target="_blank" title="https://github.com/TolyFx/toly_ui" ref="nofollow noopener noreferrer">github.com/TolyFx/toly…</a></p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de8c6bed9bfe46b3865accea7d493d4c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1563&amp;h=409&amp;s=62505&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-1">1. 设计动机</h4>
<p>在现代应用开发中，树形结构是一种极其常见的数据展示方式。无论是文件管理器的目录结构、组织架构图、分类导航，还是权限配置界面，都需要以层级关系来组织和展示信息。然而，构建一个功能完善、性能优良的树形组件并非易事，需要考虑数据绑定、状态管理、虚拟滚动、异步加载等多个方面。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97c2085606b1406a96d571f407483e65~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=867&amp;h=313&amp;s=44377&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>TolyUI 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Ftolyui_tree" target="_blank" title="https://pub.dev/packages/tolyui_tree" ref="nofollow noopener noreferrer">tolyui_tree</a> 模块正是为了解决这些痛点而设计。它不仅提供了基础的树形展示能力，还支持选择交互、自定义数据结构、大数据量处理、异步加载等高级功能，让开发者能够轻松构建出专业级的树形界面。</p>
<p>使用者可以独立引入模块包，或者使用 tolyui 全家桶：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 仅使用 tolyui_tree</span>
<span class="hljs-attr">dependencies:</span> 
   <span class="hljs-attr">tolyui_tree:</span> <span class="hljs-string">^last_version</span>

<span class="hljs-comment"># 使用 tolyui 全家桶 </span>
<span class="hljs-attr">dependencies:</span> 
    <span class="hljs-attr">tolyui:</span> <span class="hljs-string">^last_version</span>
</code></pre>
<hr/>
<h4 data-id="heading-2">1. 基础树形</h4>
<p>树形组件的核心功能是展示层级数据结构。<strong>TolyTree</strong> 组件通过递归渲染实现层级嵌套，支持节点的展开收起操作。</p>
<ul>
<li>左侧演示文件目录结构，</li>
<li>右侧展示带连接线的学科分类树。</li>
</ul>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/86b96e2b3556433e8b347a3f044292d9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=482058&amp;e=gif&amp;f=113&amp;b=fefefc" alt="" loading="lazy"/></p>
<p>通过递归渲染实现无限层级嵌套，点击节点前的展开图标可以控制子节点的显示隐藏。这种结构常用于文件管理器、组织架构图、分类导航等需要层级展示的场景。</p>
<ul>
<li><code>showConnectingLines</code> 属性可以显示节点间的连接线，让层级关系更加清晰直观。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">TolyTree&lt;<span class="hljs-built_in">String</span>&gt;(
  nodes: _treeData.map(TreeNode&lt;<span class="hljs-built_in">String</span>&gt;.fromMap).toList(),
  nodeBuilder: (node) =&gt; Padding(
    padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(vertical: <span class="hljs-number">8.0</span>),
    child: Text(node.data),
  ),
)

<span class="hljs-comment">// 带连接线的树形</span>
TolyTree&lt;<span class="hljs-built_in">String</span>&gt;(
  showConnectingLines: <span class="hljs-keyword">true</span>,
  nodes: natureScienceTree.map(TreeNode&lt;<span class="hljs-built_in">String</span>&gt;.fromMap).toList(),
  nodeBuilder: (node) =&gt; Padding(
    padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(vertical: <span class="hljs-number">8.0</span>),
    child: Text(node.data),
  ),
)
</code></pre>
<hr/>
<p>树形的节点是 <code>TreeNode</code>,支持泛型数据，数据结构如下：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreeNode</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> T data;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;TreeNode&lt;T&gt;&gt; children;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> selectable;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool?</span> isLeaf;
  <span class="hljs-built_in">bool</span> isExpanded;
  <span class="hljs-built_in">bool</span> isSelected;
  <span class="hljs-built_in">bool</span> isLoading;
  <span class="hljs-built_in">int</span> level;
</code></pre>
<p>为了便于构造树形结构，为 <code>TreeNode</code> 支持了 <code>fromMap</code> 方法，支持如下所示的 json 结构。这样便于通过接口下发树形的结构数据：</p>
<pre><code class="hljs language-dart" lang="dart">{
  <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1'</span>,
  <span class="hljs-string">'data'</span>: <span class="hljs-string">'数学 Mathematics'</span>,
  <span class="hljs-string">'children'</span>: [
    {
      <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-1'</span>,
      <span class="hljs-string">'data'</span>: <span class="hljs-string">'代数 Algebra'</span>,
      <span class="hljs-string">'children'</span>: [
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-1-1'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'线性代数 Linear Algebra'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-1-2'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'抽象代数 Abstract Algebra'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
        {<span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-1-3'</span>, <span class="hljs-string">'data'</span>: <span class="hljs-string">'群论 Group Theory'</span>, <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>},
      ],
    },
    {
      <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-2'</span>,
      <span class="hljs-string">'data'</span>: <span class="hljs-string">'分析 Analysis'</span>,
      <span class="hljs-string">'children'</span>: [
        {<span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-2-1'</span>, <span class="hljs-string">'data'</span>: <span class="hljs-string">'微积分 Calculus'</span>, <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>},
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-2-2'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'实分析 Real Analysis'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-2-3'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'复分析 Complex Analysis'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
      ],
    },
    {
      <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-3'</span>,
      <span class="hljs-string">'data'</span>: <span class="hljs-string">'几何 Geometry'</span>,
      <span class="hljs-string">'children'</span>: [
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-3-1'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'欧几里得几何 Euclidean Geometry'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
        {
          <span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-3-2'</span>,
          <span class="hljs-string">'data'</span>: <span class="hljs-string">'微分几何 Differential Geometry'</span>,
          <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>
        },
        {<span class="hljs-string">'id'</span>: <span class="hljs-string">'1-1-3-3'</span>, <span class="hljs-string">'data'</span>: <span class="hljs-string">'拓扑学 Topology'</span>, <span class="hljs-string">'isLeaf'</span>: <span class="hljs-keyword">true</span>},
      ],
    },
  ],
},
</code></pre>
<hr/>
<h4 data-id="heading-3">2. 可选择树形</h4>
<p>在权限配置、分类选择等场景中，树形组件需要支持选择功能。<strong>TolyTreeSelector</strong> 提供了完整的三态选择能力。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e2e959175c84659b1883c40142badca~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=295284&amp;e=gif&amp;f=118&amp;b=fefefc" alt="" loading="lazy"/></p>
<p>展示支持三态选择的树形组件。点击复选框可以选中或取消选中节点，父节点的选中状态会自动影响所有子节点。当子节点部分选中时，父节点会显示为半选中状态。右侧实时显示已选中的节点数量和标签列表。组件还支持设置某些节点为不可选中状态，这些节点会以灰色显示且无法被选中。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TreeDemo2State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TreeDemo2</span>&gt; </span>{
  <span class="hljs-built_in">List</span>&lt;TreeNode&lt;<span class="hljs-built_in">String</span>&gt;&gt; _nodes = [];
  <span class="hljs-built_in">List</span>&lt;TreeNode&lt;<span class="hljs-built_in">String</span>&gt;&gt; _selectedNodes = [];

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Row(
      children: [
        SizedBox(
          width: <span class="hljs-number">300</span>,
          child: TolyTreeSelector&lt;<span class="hljs-built_in">String</span>&gt;(
            nodes: _nodes,
            onSelectionChanged: (selectedNodes) {
              setState(() {
                _selectedNodes = selectedNodes;
              });
            },
          ),
        ),
        SizedBox(
          width: <span class="hljs-number">300</span>,
          child: Column(
            children: [
              Text(<span class="hljs-string">'已选择: <span class="hljs-subst">${_selectedNodes.length}</span>'</span>),
              Wrap(
                children: _selectedNodes
                    .map((n) =&gt; TolyTag(child: Text(n.data)))
                    .toList(),
              ),
            ],
          ),
        ),
      ],
    );
  }
}
</code></pre>
<p>这种交互模式常用于权限管理、分类选择、数据筛选等需要多选操作的场景。</p>
<hr/>
<h4 data-id="heading-4">3. 自定义数据结构</h4>
<p>对于复杂的业务场景，往往需要展示更丰富的节点信息。TolyTree 支持自定义数据类型，提供类型安全的数据访问。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89f8ca156a0943c4a248d4aa7c4f7672~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=861383&amp;e=gif&amp;f=87&amp;b=fdfdfb" alt="" loading="lazy"/></p>
<p>展示如何使用自定义数据类型构建树形组件。比如下面通过 <strong>FileMeta</strong> 类封装文件信息，包含名称、类型、图标、颜色、大小和更新时间等属性。每个节点根据文件类型显示不同的图标和颜色，文件夹显示子项数量，文件显示大小和修改日期。点击节点会在控制台输出详细信息，包括节点类型、层级和子项情况。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileMeta</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> type;
  <span class="hljs-keyword">final</span> IconData icon;
  <span class="hljs-keyword">final</span> Color color;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> size;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> updateTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> fileCount;

  <span class="hljs-keyword">const</span> FileMeta({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.icon,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.color,
    <span class="hljs-keyword">this</span>.size,
    <span class="hljs-keyword">this</span>.updateTime,
    <span class="hljs-keyword">this</span>.fileCount,
  });

  <span class="hljs-keyword">factory</span> FileMeta.fromJson(<span class="hljs-built_in">dynamic</span> json) {
    <span class="hljs-keyword">return</span> FileMeta(
      name: json[<span class="hljs-string">'name'</span>] ?? <span class="hljs-string">''</span>,
      type: json[<span class="hljs-string">'type'</span>] ?? <span class="hljs-string">'file'</span>,
      icon: _getIconFromType(json[<span class="hljs-string">'type'</span>]),
      color: _getColorFromType(json[<span class="hljs-string">'type'</span>]),
      size: json[<span class="hljs-string">'size'</span>],
      updateTime: json[<span class="hljs-string">'updateTime'</span>] != <span class="hljs-keyword">null</span> ? <span class="hljs-built_in">DateTime</span>.parse(json[<span class="hljs-string">'updateTime'</span>]) : <span class="hljs-keyword">null</span>,
      fileCount: json[<span class="hljs-string">'fileCount'</span>],
    );
  }
}
</code></pre>
<p>同样使用 <code>TreeNode&lt;FileMeta&gt;.fromMap</code> 构造，自定义的数据类型解析可以使用 <code>dataParser</code> 回调处理：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">List</span>&lt;TreeNode&lt;FileMeta&gt;&gt; _buildSampleData() {
  <span class="hljs-keyword">return</span> _backendData
      .map((map) =&gt;
          TreeNode&lt;FileMeta&gt;.fromMap(map, dataParser: FileMeta.fromJson))
      .toList();
}
</code></pre>
<p>这种方式提供了类型安全的数据访问和更丰富的展示效果，适用于文件管理、资源浏览等需要详细信息展示的场景。</p>
<hr/>
<h4 data-id="heading-5">4. 虚拟滚动树形</h4>
<p>当处理大量数据时，性能成为关键考虑因素。TolyTree 支持虚拟滚动模式，只渲染可见区域的节点。展示大数据量下的虚拟滚动树形组件。本案例包含 60,000 个节点，通过设置固定高度启用虚拟滚动模式。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b630858aa1c4369bb58d7a9ced04b5c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=992051&amp;e=gif&amp;f=176&amp;b=fefefc" alt="" loading="lazy"/></p>
<p>组件只会渲染可见区域内的节点，大幅提升性能和流畅度。支持完整的展开收起交互，在滚动过程中保持节点状态。点击某些节点时会动态加载新的子节点。</p>
<pre><code class="hljs language-dart" lang="dart">TolyTree&lt;YourType&gt;(
    height: <span class="hljs-number">300</span>, <span class="hljs-comment">// 启用虚拟滚动</span>
    <span class="hljs-comment">// 其他同理...</span>
)
</code></pre>
<p>这种模式适用于大型数据库浏览、文件系统管理、组织架构展示等需要处理大量层级数据的场景。</p>
<hr/>
<h4 data-id="heading-6">5. 异步加载树形</h4>
<p>对于动态数据源，树形组件需要支持按需加载。TolyTree 提供了完整的异步加载能力。展示支持异步加载子节点的树形组件。如下案例中：初始状态下只显示根节点，带有"点击加载"提示的节点可以展开加载子内容。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63556c19c46a48eda0e06073e7052da1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=859902&amp;e=gif&amp;f=229&amp;b=fefefc" alt="" loading="lazy"/></p>
<p>点击这些节点时会显示加载动画，模拟 2 秒的网络请求过程，然后动态渲染新的子节点。不同的节点会返回不同的子内容，有些子节点还可以继续异步加载更深层级的内容。</p>
<pre><code class="hljs language-dart" lang="dart">TolyTree&lt;_AsyncData&gt;(
  nodes: _buildInitialData(),
  loadData: _loadChildren,
  nodeBuilder: (node) =&gt; Container(
    padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(vertical: <span class="hljs-number">8</span>, horizontal: <span class="hljs-number">8</span>),
    child: Row(
      children: [
        Icon(node.data.icon, size: <span class="hljs-number">16</span>, color: node.data.color),
        <span class="hljs-keyword">const</span> SizedBox(width: <span class="hljs-number">8</span>),
        Text(node.data.name),
        <span class="hljs-keyword">if</span> (node.isLeaf == <span class="hljs-keyword">null</span> &amp;&amp; node.children.isEmpty)
          <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'(点击加载)'</span>, style: TextStyle(fontSize: <span class="hljs-number">12</span>, color: Colors.grey)),
      ],
    ),
  ),
)

Future&lt;<span class="hljs-built_in">List</span>&lt;TreeNode&lt;_AsyncData&gt;&gt;&gt; _loadChildren(TreeNode&lt;_AsyncData&gt; node) <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 模拟网络延迟</span>
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>));
  
  <span class="hljs-keyword">switch</span> (node.id) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'1'</span>:
      <span class="hljs-keyword">return</span> [
        TreeNode&lt;_AsyncData&gt;(
          id: <span class="hljs-string">'1-1'</span>,
          data: <span class="hljs-keyword">const</span> _AsyncData(name: <span class="hljs-string">'系统文件'</span>, icon: Icons.folder, color: Colors.red),
        ),
        TreeNode&lt;_AsyncData&gt;(
          id: <span class="hljs-string">'1-2'</span>,
          data: <span class="hljs-keyword">const</span> _AsyncData(name: <span class="hljs-string">'应用程序'</span>, icon: Icons.folder, color: Colors.green),
        ),
      ];
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">return</span> [];
  }
}
</code></pre>
<p>这种模式适用于大型数据集、远程文件系统、API 数据浏览等需要按需加载的场景。</p>
<hr/>
<h4 data-id="heading-7">6. 动画曲线树形</h4>
<p>为了提升用户体验，TolyTree 支持自定义动画效果。通过不同的动画曲线，可以创造出个性化的交互体验。如下案例中，四个区域分别展示线性动画、缓入缓出、弹性效果和回弹效果四种不同的动画曲线。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b710e638a7748238f199367d4f4d31a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=665874&amp;e=gif&amp;f=127&amp;b=fdfdfb" alt="" loading="lazy"/></p>
<ul>
<li><code>animationDuration</code> 可以设置动画时长</li>
<li><code>animationCurve</code> 可以设置动画曲线效果</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">Widget _buildCurveSection(<span class="hljs-built_in">String</span> title, Curve curve) {
  <span class="hljs-keyword">return</span> Column(
    children: [
      Text(title),
      Container(
        decoration: BoxDecoration(
          border: Border.all(color: Colors.grey.shade300),
          borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
        ),
        child: TolyTree&lt;_FileMeta&gt;(
          nodes: _buildSampleData(title),
          animationDuration: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">600</span>),
          animationCurve: curve,
          nodeBuilder: (node) =&gt; Row(
            children: [
              Icon(node.data.icon, size: <span class="hljs-number">14</span>, color: node.data.color),
              <span class="hljs-keyword">const</span> SizedBox(width: <span class="hljs-number">6</span>),
              Text(node.data.name),
            ],
          ),
        ),
      ),
    ],
  );
}

</code></pre>
<p>这种对比展示帮助开发者选择最适合项目风格的动画效果，彰显个性化特征。</p>
<hr/>
<h4 data-id="heading-8">7. 拖拽排序树形</h4>
<p>在文件管理、项目结构编辑、菜单配置等场景中，用户经常需要通过拖拽来调整节点的位置和层级关系。<strong>TolyDraggableTree</strong> 提供了完整的拖拽排序能力，支持同级排序和跨级移动。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6c47001eff634617baf81d2f31d8f68d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1308&amp;h=512&amp;s=313734&amp;e=gif&amp;f=128&amp;b=fefefc" alt="" loading="lazy"/></p>
<p>展示支持拖拽排序的树形组件。文件可以拖入文件夹，文件夹可以拖入其他文件夹，支持同级排序和跨级移动。拖拽过程中会显示蓝色的放置提示线：上方线表示插入到目标上方，下方线表示插入到目标下方，边框表示放入目标内部。拖拽完成后会显示操作成功消息。</p>
<pre><code class="hljs language-dart" lang="dart">TolyDraggableTree&lt;FileItem&gt;(
  nodes: nodes,
  nodeBuilder: (node) =&gt; _buildFileNode(node),
  onNodeMoved: onMove,
),
</code></pre>
<hr/>
<h4 data-id="heading-9">尾声</h4>
<p>toly_tree 模块为 Flutter 应用提供了完整的树形数据展示和交互能力。从基础的层级展示到高级的虚拟滚动，从静态数据到动态加载，从简单选择到复杂的三态交互，它都能够胜任。</p>
<p>组件的设计遵循了数据驱动的原则，通过 TreeNode 数据结构统一管理节点信息，支持泛型以适应不同的业务数据类型。同时提供了丰富的自定义选项，包括节点渲染器、动画效果、交互回调等，让开发者能够根据具体需求进行灵活配置。</p>
<p>无论你是在构建文件管理系统、权限配置界面，还是开发数据浏览工具，toly_tree 都能帮助你创建出既美观又实用的树形界面。</p>
<p>随着 tolyui 的逐步迭代，越来越多的新功能将会支持。感谢你关注 tolyui 的成长，如果喜欢，也希望你能在 github 中点赞支持~</p>
<blockquote>
<p>github 开源地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTolyFx%2Ftoly_ui" target="_blank" title="https://github.com/TolyFx/toly_ui" ref="nofollow noopener noreferrer">github.com/TolyFx/toly…</a></p>
</blockquote>
<hr/>
<p>更多文章和视频知识资讯，大家可以关注我的公众号、掘金和 B 站 。让我们一起成长，变得更强。我们下次再见~</p>
<ul>
<li>QQ交流群： 1046304516</li>
<li>掘金账号： <a href="https://juejin.cn/user/149189281194766" title="https://juejin.cn/user/149189281194766" target="_blank">张风捷特烈</a></li>
<li>bilibli 账号： <a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" title="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" target="_blank">张风捷特烈</a></li>
<li>公众号： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" title="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" target="_blank">编程之王</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot Web 入门核心知识点（快速开发案例 + 分层解耦实战）]]></title>    <link>https://juejin.cn/post/7583571595202740262</link>    <guid>https://juejin.cn/post/7583571595202740262</guid>    <pubDate>2025-12-14T13:05:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583571595202740262" data-draft-id="7583528177559453746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot Web 入门核心知识点（快速开发案例 + 分层解耦实战）"/> <meta itemprop="keywords" content="Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-14T13:05:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员根根"/> <meta itemprop="url" content="https://juejin.cn/user/555679166786139"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot Web 入门核心知识点（快速开发案例 + 分层解耦实战）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/555679166786139/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员根根
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:05:04.000Z" title="Sun Dec 14 2025 13:05:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好！SpringBoot 作为 Spring 生态的 “轻量级脚手架”，凭借<strong>自动配置、起步依赖、内嵌服务器</strong>等特性，彻底简化了 Java Web 开发的繁琐配置。很多新手从 SSM 框架转向 SpringBoot 时，既好奇它的 “零配置” 魔力，也容易在 “分层开发” 和 “解耦设计” 上踩坑。</p>
<p>这篇文章会从 SpringBoot Web 的核心原理入手，通过一个完整的用户管理案例实现快速入门，再深入讲解分层解耦的设计思想与实践技巧，帮你夯实 SpringBoot Web 开发的基础。</p>
<h2 data-id="heading-0">一、SpringBoot Web 核心认知：为什么它是 Web 开发的首选？</h2>
<h4 data-id="heading-1">1.1 什么是 SpringBoot Web？</h4>
<p>SpringBoot Web 是 SpringBoot 针对 Web 开发提供的一站式解决方案，它整合了<strong>Spring MVC、Tomcat（内嵌服务器）、Jackson（JSON 序列化）</strong>  等核心组件，通过<strong>起步依赖（Starter）</strong>  实现一键引入，通过<strong>自动配置</strong>省去繁琐的 XML 或 Java 配置，让开发者专注于业务逻辑。</p>
<h4 data-id="heading-2">1.2 SpringBoot Web 的核心优势</h4>
<ul>
<li><strong>零配置启动</strong>：无需手动配置 Spring MVC 的 DispatcherServlet、视图解析器等，启动类一键运行；</li>
<li><strong>内嵌服务器</strong>：内置 Tomcat、Jetty 等服务器，无需手动部署，直接运行 JAR 包即可启动 Web 服务；</li>
<li><strong>起步依赖</strong>：<code>spring-boot-starter-web</code>一个依赖即可引入 Web 开发所需的所有组件，避免依赖版本冲突；</li>
<li><strong>无缝集成</strong>：与 MyBatis、Redis、Spring Data JPA 等框架无缝集成，降低技术栈整合成本。</li>
</ul>
<h4 data-id="heading-3">1.3 核心概念：起步依赖与自动配置</h4>
<ul>
<li><strong>起步依赖（Starter）</strong> ：是 Maven 的依赖集合，如<code>spring-boot-starter-web</code>包含了 Spring MVC、Tomcat、Jackson 等依赖，只需引入一个即可；</li>
<li><strong>自动配置（AutoConfiguration）</strong> ：SpringBoot 通过<code>@EnableAutoConfiguration</code>注解，根据类路径下的依赖自动配置 Bean（如检测到<code>spring-webmvc</code>则自动配置 DispatcherServlet）。</li>
</ul>
<h2 data-id="heading-4">二、SpringBoot Web 快速入门：搭建第一个 Web 项目</h2>
<h4 data-id="heading-5">2.1 环境准备</h4>
<ul>
<li>JDK：8 及以上（推荐 JDK 8/11）；</li>
<li>构建工具：Maven/Gradle（本文使用 Maven）；</li>
<li>IDE：IntelliJ IDEA 2020+；</li>
<li>SpringBoot 版本：3.5.0。</li>
</ul>
<h4 data-id="heading-6">2.2 创建 SpringBoot Web 项目（IDEA 版）</h4>
<h5 data-id="heading-7">方式 1：通过 Spring Initializr 创建</h5>
<ol>
<li>
<p>打开 IDEA，点击<code>File &gt; New &gt; Project</code>；</p>
</li>
<li>
<p>左侧选择<code>Spring Initializr</code>，选择 JDK 版本，点击<code>Next</code>；</p>
</li>
<li>
<p>填写项目信息：</p>
<ul>
<li>Group：<code>com.xxx</code>（如<code>com.demo</code>）；</li>
<li>Artifact：<code>springboot-web-demo</code>；</li>
<li>Type：<code>Maven Project</code>；</li>
<li>Java Version：<code>17</code>；</li>
</ul>
</li>
<li>
<p>选择依赖：在<code>Web</code>分类下勾选<code>Spring Web</code>，点击<code>Next</code>；</p>
</li>
<li>
<p>选择项目存储路径，点击<code>Create</code>，IDEA 会自动下载依赖并生成项目结构。</p>
</li>
</ol>
<h5 data-id="heading-8">方式 2：手动创建 Maven 项目</h5>
<ol>
<li>创建普通 Maven 项目，在<code>pom.xml</code>中添加 SpringBoot 父依赖和 Web 起步依赖：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SpringBoot父依赖（统一版本管理） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Web起步依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 打包插件（可执行JAR包） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">2.3 核心项目结构</h4>
<p>SpringBoot Web 项目遵循标准的 Maven 结构，核心目录如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">springboot-web-demo
├── src
│   ├── main
│   │   ├── java
│   │   │   └── com
│   │   │       └── demo
│   │   │           ├── SpringbootWebDemoApplication.java  // 启动类
│   │   │           ├── controller  // 控制器层（接收请求）
│   │   │           ├── service     // 服务层（业务逻辑）
│   │   │           ├── mapper      // 数据访问层（操作数据库）
│   │   │           └── entity      // 实体类（封装数据）
│   │   └── resources
│   │       ├── application.properties  // 配置文件
│   │       ├── static  // 静态资源（CSS/JS/图片）
│   │       └── templates  // 模板文件（Thymeleaf等）
│   └── test  // 测试目录
└── pom.xml
</code></pre>
<h4 data-id="heading-10">2.4 编写第一个接口：Hello World</h4>
<h5 data-id="heading-11">步骤 1：编写启动类</h5>
<p>启动类是 SpringBoot 项目的入口，需添加<code>@SpringBootApplication</code>注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-comment">// 包含@Configuration、@EnableAutoConfiguration、@ComponentScan三个注解</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringbootWebDemoApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 启动SpringBoot应用</span>
        SpringApplication.run(SpringbootWebDemoApplication.class, args);
    }
}
</code></pre>
<h5 data-id="heading-12">步骤 2：编写控制器（Controller）</h5>
<p>在<code>controller</code>包下创建<code>HelloController</code>，处理 HTTP 请求：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.demo.controller;

<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;

<span class="hljs-meta">@RestController</span> <span class="hljs-comment">//标识当前类可以处理请求，并且会创建当前类对象加入spring容器（内存）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {
    <span class="hljs-comment">//处理指定资源路径的请求</span>
    <span class="hljs-meta">@RequestMapping("/hello")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(String name)</span>{<span class="hljs-comment">//这里的参数name必须要与前端传递的参数名字name一样，就可以接收数据</span>
        System.out.println(<span class="hljs-string">"后端处理/hello请求，并且接收数据：name="</span>+name);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello "</span> + name;
    }
}
</code></pre>
<h5 data-id="heading-13">步骤 3：启动项目并测试</h5>
<ol>
<li>右键启动类，选择<code>Run 'SpringbootWebDemoApplication'</code>；</li>
<li>控制台出现<code>Tomcat started on port(s): 8080 (http)</code>表示启动成功；</li>
<li>打开浏览器，访问<code>http://localhost:8080/hello/SpringBoot Web</code>，页面显示<code>Hello SpringBoot Web</code>。</li>
</ol>
<h3 data-id="heading-14">三、实战案例：用户管理系统（CRUD）</h3>
<p>接下来通过一个基于SpringBoot开发的web程序——<strong>用户管理系统</strong>，实现用户列表的渲染展示，让你快速掌握 SpringBoot Web 的开发流程。</p>
<h4 data-id="heading-15">3.1 创建实体类</h4>
<p>在<code>pojo</code>包下创建<code>User</code>类，封装用户数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.pojo;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span><span class="hljs-comment">//生成get/set/toString/hashCode/equals方法</span>
<span class="hljs-meta">@NoArgsConstructor</span><span class="hljs-comment">//生成无参构造方法</span>
<span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-comment">//生成全参构造方法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}
</code></pre>
<p><strong>注意</strong>：需在<code>pom.xml</code>中添加 Lombok 依赖（简化代码）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-16">3.2 编写前端HTML</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>用户列表数据<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-comment">/*定义css，美化表格*/</span>
        <span class="hljs-selector-tag">table</span>{
            <span class="hljs-attribute">border-collapse</span>: collapse;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
        }
        <span class="hljs-selector-tag">tr</span> {
            <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
        }
        <span class="hljs-selector-tag">th</span>,<span class="hljs-selector-tag">td</span>{
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
        }
        <span class="hljs-selector-tag">thead</span>{
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e8e8e8</span>;
        }
        <span class="hljs-selector-tag">h1</span>{
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">font-family</span>: 楷体;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>用户列表数据<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-comment">&lt;!--定义一个表格,包括6列,分别是: ID, 用户名, 密码, 姓名, 年龄, 更新时间--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>ID<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>用户名<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>密码<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>更新时间<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in userList"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.id}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.username}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.password}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.name}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.age}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{user.updateTime}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!--引入axios--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/axios.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'./js/vue.esm-browser.js'</span>
        <span class="hljs-title function_">createApp</span>({
            <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-attr">userList</span>: []
                }
            },
            <span class="hljs-attr">methods</span>: {
                <span class="hljs-keyword">async</span> <span class="hljs-title function_">search</span>(<span class="hljs-params"/>){
                    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/list'</span>);
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userList</span> = result.<span class="hljs-property">data</span>;
                }
            },
            <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">search</span>();
            }
        }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-17">3.3 编写控制器（Controller）</h4>
<p>在<code>controller</code>包下创建<code>UserController</code>，处理查询用户列表请求：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span><span class="hljs-comment">//标识当前类可以处理请求，并且创建当前类对象加入spring容器中</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-comment">/**
     * 处理查询用户列表请求
     * <span class="hljs-doctag">@return</span> List&lt;User&gt;
     *
     * 方法返回List&lt;User&gt;,spring框架会自动将其转换为json字符串返回给前端
     *   '[{"id":xx,"username":xx},{"id":xx,"username":xx},...]'
     */</span>
    <span class="hljs-meta">@RequestMapping("/list")</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">list</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">//定义List&lt;User&gt;用于存储用户列表数据</span>
        List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">//1.创建输入流对象操作user.txt文件</span>
        <span class="hljs-keyword">try</span> (
                <span class="hljs-comment">// InputStream in = new FileInputStream("day04-02-web-springboot/src/main/resources/user.txt")</span>
                <span class="hljs-comment">//上面这样写在web项目中不可以，因为web项目会部署给tomcat，目录结构就不是这样的结构</span>
                <span class="hljs-comment">// 解决方案：在web项目要先获取类路径target/classes目录下资源文件的固定语法：类加载器对象.getResourceAsStream("资源文件名")</span>
                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> UserController.class.getClassLoader().getResourceAsStream(<span class="hljs-string">"user.txt"</span>)
        ){
            <span class="hljs-comment">//2.读取文件中的数据，利用hutool工具一次性读取所有行数据封装到List&lt;String&gt;</span>
            List&lt;String&gt; rows = IoUtil.readUtf8Lines(in, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());

            <span class="hljs-comment">//3.将List&lt;String&gt;转换为List&lt;User&gt;</span>

            <span class="hljs-comment">// 遍历List&lt;String&gt;的每个元素</span>
            <span class="hljs-keyword">for</span> (String s : rows) {
                <span class="hljs-comment">// 将类似1,daqiao,1234567890,大乔,22,2024-07-15 15:05:45按照“,”分隔得到数组</span>
                String[] split = s.split(<span class="hljs-string">","</span>);

                <span class="hljs-comment">// 将分隔出的数据封装到User对象中</span>
                <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(
                        Integer.valueOf(split[<span class="hljs-number">0</span>]),
                        split[<span class="hljs-number">1</span>],
                        split[<span class="hljs-number">2</span>],
                        split[<span class="hljs-number">3</span>],
                        Integer.valueOf(split[<span class="hljs-number">4</span>]),
                        LocalDateTime.parse(split[<span class="hljs-number">5</span>], DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>))
                        <span class="hljs-comment">//  将字符串转换为LocalDateTime</span>
                        <span class="hljs-comment">//  yyyy 格式化为4个数字的年2025, yy两个数字的年25</span>
                        <span class="hljs-comment">//  MM 格式化为2个数字的月</span>
                        <span class="hljs-comment">//  dd 格式化为2个数字的日</span>
                        <span class="hljs-comment">//  HH 格式化为24小时，hh格式为12小时</span>
                        <span class="hljs-comment">//  mm 格式化分钟</span>
                        <span class="hljs-comment">//  ss 格式化秒</span>
                );

                <span class="hljs-comment">// 将user对象添加List&lt;User&gt;集合中</span>
                users.add(user);
            }
            <span class="hljs-keyword">return</span> users;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
}

</code></pre>
<h4 data-id="heading-18">3.4 编写user.txt</h4>
<pre><code class="hljs language-txt" lang="txt">1,daqiao,1234567890,大乔,22,2024-07-15 15:05:45
2,xiaoqiao,1234567890,小乔,18,2024-07-15 15:12:09
3,diaochan,1234567890,貂蝉,21,2024-07-15 15:07:16
4,lvbu,1234567890,吕布,28,2024-07-16 10:05:15
5,zhaoyun,1234567890,赵云,27,2024-07-16 11:03:28
6,zhangfei,1234567890,张飞,31,2024-07-16 11:03:28
7,guanyu,1234567890,关羽,34,2024-07-16 12:05:12
8,liubei,1234567890,刘备,37,2024-07-16 15:03:28
</code></pre>
<h4 data-id="heading-19">3.5 编写启动类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-meta">@SpringBootApplication</span><span class="hljs-comment">//标识当前类为启动类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(WebApplication.class,args);<span class="hljs-comment">//启动程序</span>
    }
}
</code></pre>
<p>运行main方法，启动服务器端程序、</p>
<p>在浏览器中输入(<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fuser.html" target="_blank" title="http://localhost:8080/user.html" ref="nofollow noopener noreferrer">http://localhost:8080/user.html</a>)</p>
<h3 data-id="heading-20">四、分层解耦：理解 SpringBoot 的设计思想</h3>
<p>在我们进行程序设计以及程序开发时，尽可能让每一个接口、类、方法的职责更单一些（单一职责原则）。</p>
<p>由此引申出<strong>Controller、Service、Mapper</strong>三层架构，这是 SpringBoot Web 开发的标准分层方式，其核心目的是<strong>解耦</strong>，让代码更易维护、扩展和测试。</p>
<h4 data-id="heading-21">4.1 为什么要分层？</h4>
<p>在传统的单体代码中，所有逻辑写在一个类中，会导致：</p>
<ul>
<li><strong>代码耦合度高</strong>：修改一个功能可能影响其他功能；</li>
<li><strong>可读性差</strong>：几百行代码混在一起，难以理解；</li>
<li><strong>可测试性差</strong>：无法单独测试某个功能点。</li>
</ul>
<p>分层开发通过<strong>单一职责原则</strong>，将不同功能拆分到不同层级，每个层级只做一件事：</p>
<ul>
<li><strong>Controller 层</strong>：只负责接收请求、返回响应，不处理业务逻辑；</li>
<li><strong>Service 层</strong>：只负责业务逻辑处理，不关心请求和数据存储；</li>
<li><strong>Mapper 层</strong>：只负责数据访问，不处理业务逻辑。</li>
</ul>
<h4 data-id="heading-22">4.2 分层架构的核心职责</h4>



































<table><thead><tr><th>层级</th><th>核心注解</th><th>核心职责</th><th>依赖关系</th></tr></thead><tbody><tr><td>Controller（控制层）</td><td><code>@RestController</code>、<code>@RequestMapping</code></td><td>接收 HTTP 请求、参数校验、返回响应</td><td>依赖 Service 层</td></tr><tr><td>Service（服务层）</td><td><code>@Service</code></td><td>业务逻辑处理、事务管理、数据校验</td><td>依赖 Mapper 层</td></tr><tr><td>Mapper/Dao（数据访问层）</td><td><code>@Repository</code></td><td>数据库 CRUD 操作、数据映射</td><td>无（被 Service 层依赖）</td></tr><tr><td>Entity/Pojo（实体层）</td><td><code>@Data</code>（Lombok）</td><td>封装数据（对应数据库表 / 请求响应体）</td><td>被所有层级使用</td></tr></tbody></table>
<h4 data-id="heading-23">4.3 实战案例示例：重写上一节案例的Controller</h4>
<h5 data-id="heading-24">4.3.1 <strong>数据访问层：负责数据的访问操作，包含数据的增、删、改、查</strong></h5>
<p><strong>在 <code>com.tgt.dao</code>中创建UserDao接口，代码如下</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.dao;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Description</span> 用户数据数据访问接口
 * <span class="hljs-doctag">@Author</span> tgt
 * <span class="hljs-doctag">@Date</span> 2025-10-21
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserDao</span> {

    <span class="hljs-comment">/**
     * 解析文件返回数据列表
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    List&lt;String&gt; <span class="hljs-title function_">GetDao</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>在 <code>com.tgt.dao.impl</code> 中创建UserDaoImpl接口，代码如下：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.dao.impl;

<span class="hljs-keyword">import</span> cn.hutool.core.io.IoUtil;
<span class="hljs-keyword">import</span> com.tgt.controller.UserController;
<span class="hljs-keyword">import</span> com.tgt.dao.IUserDao;
<span class="hljs-keyword">import</span> com.tgt.pojo.User;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">//数据访问层DAO：操作数据增删改查</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserDao</span> {
    <span class="hljs-comment">/**
     * 解析文件返回数据列表
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">GetDao</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">//定义List&lt;User&gt;用于存储用户列表数据</span>
        List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">//1.创建输入流对象操作user.txt文件</span>
        <span class="hljs-keyword">try</span> (
                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> UserController.class.getClassLoader().getResourceAsStream(<span class="hljs-string">"user.txt"</span>)
        ) {
            <span class="hljs-comment">//2.读取文件中的数据，利用hutool工具一次性读取所有行数据封装到List&lt;String&gt;</span>
            List&lt;String&gt; rows = IoUtil.readUtf8Lines(in, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());

            <span class="hljs-keyword">return</span> rows;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
}
</code></pre>
<h5 data-id="heading-25">4.3.2 业务逻辑层：处理具体的业务逻辑</h5>
<p>在 <code>com.tgt.service</code>中创建UserSerivce接口，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.service;

<span class="hljs-keyword">import</span> com.tgt.pojo.User;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserService</span> {
    <span class="hljs-comment">/**
     * 获取用户列表业务方法
     * <span class="hljs-doctag">@return</span>
     */</span>
    List&lt;User&gt; <span class="hljs-title function_">GetUserList</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>在 <code>com.tgt.service.impl</code> 中创建UserSerivceImpl接口，代码如下：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.service.Impl;

<span class="hljs-keyword">import</span> com.tgt.dao.IUserDao;
<span class="hljs-keyword">import</span> com.tgt.dao.impl.UserDaoImpl;
<span class="hljs-keyword">import</span> com.tgt.pojo.User;
<span class="hljs-keyword">import</span> com.tgt.service.IUserService;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;


<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserService</span> {

    <span class="hljs-comment">//定义数据访问对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">IUserDao</span> <span class="hljs-variable">userDao</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">IUserService</span>();

    <span class="hljs-comment">/**
     * 获取用户列表业务方法
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">GetUserList</span><span class="hljs-params">()</span> {

        List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">//1.调用数据访问层方法获取磁盘数据List&lt;String&gt;</span>
        List&lt;String&gt; rows = userDao.GetDao();

        <span class="hljs-comment">//2.将List&lt;String&gt;转换为List&lt;User&gt;</span>
        <span class="hljs-comment">// 遍历List&lt;String&gt;的每个元素</span>
        <span class="hljs-keyword">for</span> (String s : rows) {
            <span class="hljs-comment">// 将类似1,daqiao,1234567890,大乔,22,2024-07-15 15:05:45按照“,”分隔得到数组</span>
            String[] split = s.split(<span class="hljs-string">","</span>);

            <span class="hljs-comment">// 将分隔出的数据封装到User对象中</span>
            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(
                    Integer.valueOf(split[<span class="hljs-number">0</span>]),
                    split[<span class="hljs-number">1</span>],
                    split[<span class="hljs-number">2</span>],
                    split[<span class="hljs-number">3</span>],
                    Integer.valueOf(split[<span class="hljs-number">4</span>]),
                    LocalDateTime.parse(split[<span class="hljs-number">5</span>], DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>))
            );

            <span class="hljs-comment">// 将user对象添加List&lt;User&gt;集合中</span>
            users.add(user);
        }
        <span class="hljs-keyword">return</span> users;
    }
}
</code></pre>
<h5 data-id="heading-26">4.3.3 <strong>控制层：接收前端发送的请求，对请求进行处理，并响应数据</strong></h5>
<p><strong>在 <code>com.itheima.controller</code> 中创建UserController类，代码如下：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.controller;

<span class="hljs-keyword">import</span> cn.hutool.core.io.IoUtil;
<span class="hljs-keyword">import</span> com.tgt.pojo.User;
<span class="hljs-keyword">import</span> com.tgt.service.IUserService;
<span class="hljs-keyword">import</span> com.tgt.service.Impl.UserServiceImpl;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;

<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;


<span class="hljs-meta">@RestController</span><span class="hljs-comment">//标识当前类可以处理请求，并且创建当前类对象加入spring容器中</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-comment">//定义业务对象</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">IUserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();

    <span class="hljs-comment">/**
     * 处理查询用户列表请求
     *
     * <span class="hljs-doctag">@return</span> List&lt;User&gt;
     */</span>
    <span class="hljs-meta">@RequestMapping("/list")</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">list</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.GetUserList();
    }
}
</code></pre>
<h4 data-id="heading-27">4.3 解耦的关键：依赖注入与控制反转</h4>
<p>之前我们在编写代码时，需要什么对象，就直接new一个就可以了。 这种做法呢，层与层之间代码就耦合了，当service层的实现变了之后， 我们还需要修改controller层的代码。
那应该怎么解耦呢？</p>
<p>SpringBoot 的<strong>依赖注入（DI）</strong>  和<strong>控制反转（IOC）</strong>  是实现分层解耦的核心机制：</p>
<ul>
<li><strong>控制反转（IOC）</strong> ：将对象的创建权交给 Spring 容器，而非手动<code>new</code>对象；</li>
<li><strong>依赖注入（DI）</strong> ：Spring 容器自动将依赖的对象注入到当前类中（如<code>@Autowired</code>注入 UserService）。</li>
</ul>
<h5 data-id="heading-28">示例：传统方式 vs 依赖注入</h5>
<p><strong>传统方式（耦合度高）</strong> ：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Controller中手动创建Service实例，耦合度高</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
}
</code></pre>
<p><strong>依赖注入方式（解耦）</strong> ：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 由Spring容器管理对象，通过@Autowired注入，降低耦合</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
}
</code></pre>
<h4 data-id="heading-29">4.4 进一步解耦：面向接口编程</h4>
<p>我们先定义接口再实现类，这是<strong>面向接口编程</strong>的思想，其优势在于：</p>
<ul>
<li><strong>降低耦合</strong>：Controller 层只依赖 Service 接口，不依赖具体实现类；</li>
<li><strong>便于扩展</strong>：如需修改业务逻辑，只需新增实现类，无需修改 Controller 代码；</li>
<li><strong>便于测试</strong>：可通过 Mock 对象模拟 Service 接口，实现单元测试。</li>
</ul>
<h4 data-id="heading-30">4.5 分层解耦的最佳实践</h4>
<ol>
<li><strong>层级边界清晰</strong>：禁止跨层级调用（如 Controller 直接调用 Mapper）；</li>
<li><strong>面向接口编程</strong>：Service 层优先定义接口，实现类负责具体逻辑；</li>
<li><strong>依赖注入</strong>：使用<code>@Autowired</code>或构造器注入，避免手动创建对象；</li>
<li><strong>单一职责</strong>：每个类 / 方法只做一件事，避免 “全能类”；</li>
<li><strong>异常统一处理</strong>：通过全局异常处理器统一处理各层级的异常。</li>
</ol>
<h2 data-id="heading-31">五、常见问题与解决方案</h2>
<h4 data-id="heading-32">5.1 启动项目时提示 “找不到 Bean”</h4>
<ul>
<li><strong>原因</strong>：组件未被 Spring 扫描（如忘记加<code>@Service</code>/<code>@Repository</code>注解）；</li>
<li><strong>解决</strong>：检查类上的注解是否正确，确保启动类的包路径包含所有组件（<code>@SpringBootApplication</code>默认扫描当前包及子包）。</li>
</ul>
<h4 data-id="heading-33">5.2 接口返回 404</h4>
<ul>
<li><strong>原因</strong>：请求路径错误、Controller 注解错误（如用<code>@Controller</code>而非<code>@RestController</code>）；</li>
<li><strong>解决</strong>：检查请求路径与<code>@RequestMapping</code>是否一致，确保返回数据的注解正确。</li>
</ul>
<h4 data-id="heading-34">5.3 请求体传参时提示 “参数绑定失败”</h4>
<ul>
<li><strong>原因</strong>：请求体格式错误（非 JSON）、实体类字段与请求体字段不匹配；</li>
<li><strong>解决</strong>：确保请求体为 JSON 格式，实体类字段名称与请求体一致（或使用<code>@JsonProperty</code>注解映射）。</li>
</ul>
<h2 data-id="heading-35">六、总结与延伸</h2>
<h4 data-id="heading-36">6.1 核心总结</h4>
<ol>
<li>SpringBoot Web 通过起步依赖和自动配置，实现了 Web 开发的 “零配置” 启动；</li>
<li>标准的分层架构为<strong>Controller（控制层）、Service（服务层）、Mapper（数据访问层）</strong> ，各层级职责单一；</li>
<li>依赖注入和面向接口编程是实现分层解耦的关键，能大幅提升代码的可维护性；</li>
<li>实战案例中的 CRUD 接口是 Web 开发的基础，掌握后可扩展到更复杂的业务场景。</li>
</ol>
<p>SpringBoot Web 的入门门槛低，但想要写出优雅、高效的代码，需要深入理解分层解耦的设计思想。建议在实际项目中多动手实践，逐步掌握 SpringBoot 的高级特性，最终形成自己的开发体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java事务常见的失效场景总结]]></title>    <link>https://juejin.cn/post/7583225356905381928</link>    <guid>https://juejin.cn/post/7583225356905381928</guid>    <pubDate>2025-12-14T13:59:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583225356905381928" data-draft-id="7583325900293849088" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java事务常见的失效场景总结  "/> <meta itemprop="keywords" content="后端,面试"/> <meta itemprop="datePublished" content="2025-12-14T13:59:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小橙编码日志"/> <meta itemprop="url" content="https://juejin.cn/user/3562867149506392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java事务常见的失效场景总结  
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562867149506392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小橙编码日志
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:59:32.000Z" title="Sun Dec 14 2025 13:59:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">Java事务常见的失效场景总结</h2>
<p>在Java开发中，事务是保障数据一致性的核心机制，尤其在电商下单、金融转账等关键场景中，事务的可靠性直接决定系统的业务可信度。但实际开发中，“事务配置了却不生效”的问题频发，其根源往往是对事务本质理解不深或忽视了细节约束。本文将从事务核心定义出发，梳理Java事务的实现体系，重点剖析常见失效场景及解决方案。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/376df5e996704453b341f42accc3cd9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5qmZ57yW56CB5pel5b-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766325572&amp;x-signature=un%2BSlOmW0KtEYTb7fVm%2BV9Mads8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">一、Java事务的核心理解：从本质到特性</h3>
<h4 data-id="heading-2">1. 事务的本质：不可分割的逻辑单元</h4>
<p>事务（Transaction）是一组数据库操作的集合，具备“要么全部成功提交，要么全部失败回滚”的原子性特征。例如天猫国际供应商的“订单创建+库存扣减”操作，若订单创建成功但库存扣减失败，必须通过事务回滚消除订单记录，避免数据不一致。Java事务的核心价值，就是将分散的数据库操作绑定为一个逻辑整体，抵御业务异常和系统故障带来的数据风险。</p>
<h4 data-id="heading-3">2. 事务的灵魂：ACID特性落地</h4>
<p>事务的可靠性依赖ACID四大特性支撑，Java通过API封装与数据库协同实现这些特性，具体落地逻辑如下：</p>
<ul>
<li>
<p><strong>原子性（Atomicity）</strong>：操作不可拆分，核心通过Java的<code>Connection</code>接口控制——关闭自动提交（<code>setAutoCommit(false)</code>）后，所有操作统一通过<code>commit()</code>提交或<code>rollback()</code>回滚。若任一操作抛出异常，立即触发回滚，确保操作整体一致性。</p>
</li>
<li>
<p><strong>一致性（Consistency）</strong>：事务执行前后数据符合业务规则（如供应商库存不为负）。Java层面通过业务逻辑校验（如扣减前检查库存），数据库层面通过主键、外键等约束共同保障。</p>
</li>
<li>
<p><strong>隔离性（Isolation）</strong>：并发事务互不干扰，Java通过<code>setTransactionIsolation()</code>设置隔离级别，解决脏读、不可重复读、幻读问题。例如MySQL默认的REPEATABLE_READ级别，可避免同一事务内两次读取结果不一致的问题。</p>
</li>
<li>
<p><strong>持久性（Durability）</strong>：事务提交后数据永久保存，即便系统崩溃也不丢失。此特性主要依赖数据库的预写式日志（WAL）实现，Java只需确保<code>commit()</code>方法正常返回，即可信任数据库已完成日志落盘。</p>
</li>
</ul>
<h3 data-id="heading-4">二、Java事务失效的8类常见场景：原理与解决方案</h3>
<p>事务失效的本质是“事务管理逻辑未被正确执行”，Spring事务因使用频率最高，失效场景也最为典型。以下结合原理、代码示例和修复方案，逐一解析核心失效场景：</p>
<h4 data-id="heading-5">1. 事务方法非public修饰</h4>
<p><strong>失效原理</strong>：Spring AOP代理机制对非public方法（private、protected、默认权限）无法进行有效增强——JDK动态代理基于接口，仅代理public方法；CGLIB代理虽能代理非public方法，但Spring为遵循Java语言规范，主动跳过了对非public方法的事务增强。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SupplierService</span> {  
    <span class="hljs-comment">// 非public方法，@Transactional注解失效  </span>
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateSupplierStock</span><span class="hljs-params">(Long supplierId, Integer stock)</span> {  
        supplierMapper.updateStock(supplierId, stock);  
        <span class="hljs-comment">// 模拟异常  </span>
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：将事务方法修改为public访问权限，确保Spring AOP能正常拦截并注入事务逻辑。修复后完整代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">  
@Service  
public class SupplierService {  
    // 改为public方法，@Transactional注解生效  
    @Transactional  
    public void updateSupplierStock(Long supplierId, Integer stock) {  
        supplierMapper.updateStock(supplierId, stock);  
        // 模拟异常，此时会触发事务回滚  
        int i = 1 / 0;  
    }  
}  
</code></pre>
<p>补充说明：修改后当方法执行到异常处时，Spring事务管理器会捕获异常并触发回滚，确保库存更新操作不会生效，避免数据不一致。若需进一步增强，还可结合rollbackFor属性明确回滚异常范围，如<code>@Transactional(rollbackFor = Exception.class)</code>。</p>
<h4 data-id="heading-6">2. 异常被捕获且未重新抛出</h4>
<p><strong>失效原理</strong>：Spring事务默认仅在“未捕获的RuntimeException或Error”发生时触发回滚。若方法内部用try-catch捕获异常且未重新抛出，事务管理器会判定“业务执行正常”，不会执行回滚操作。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {  
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {  
        <span class="hljs-keyword">try</span> {  
            orderMapper.insert(order);  
            <span class="hljs-comment">// 模拟库存扣减异常  </span>
            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  
        } <span class="hljs-keyword">catch</span> (Exception e) {  
            <span class="hljs-comment">// 捕获异常但未抛出，事务不回滚  </span>
            log.error(<span class="hljs-string">"创建订单失败"</span>, e);  
        }  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：两种思路——捕获后重新抛出异常（推荐），或手动触发回滚。修复后代码如下：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-comment">// 方案一：重新抛出异常  </span>
<span class="hljs-meta">@Transactional</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {  
    <span class="hljs-keyword">try</span> {  
        orderMapper.insert(order);  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  
    } <span class="hljs-keyword">catch</span> (Exception e) {  
        log.error(<span class="hljs-string">"创建订单失败"</span>, e);  
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单创建失败"</span>, e); <span class="hljs-comment">// 触发回滚  </span>
    }  
}  
  
<span class="hljs-comment">// 方案二：手动回滚  </span>
<span class="hljs-meta">@Transactional</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {  
    <span class="hljs-keyword">try</span> {  
        orderMapper.insert(order);  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  
    } <span class="hljs-keyword">catch</span> (Exception e) {  
        log.error(<span class="hljs-string">"创建订单失败"</span>, e);  
        <span class="hljs-comment">// 手动标记事务为回滚状态  </span>
        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();  
    }  
}  
</code></pre>
<h4 data-id="heading-7">3. rollbackFor属性配置错误</h4>
<p><strong>失效原理</strong>：<code>@Transactional</code>默认仅回滚RuntimeException和Error，若业务中抛出受检异常（如IOException、SQLException）且未在rollbackFor中声明，事务不会回滚。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileService</span> {  
    <span class="hljs-comment">// 未指定rollbackFor，IOException不会触发回滚  </span>
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">importSupplierData</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException {  
        <span class="hljs-type">FileReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(filePath); <span class="hljs-comment">// 可能抛出IOException  </span>
        supplierMapper.batchInsert(parseData(reader));  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：显式配置rollbackFor属性，包含业务中可能抛出的所有异常类型：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Transactional(rollbackFor = {IOException.class, RuntimeException.class})</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">importSupplierData</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> IOException {  
    <span class="hljs-comment">// 业务逻辑不变  </span>
}  
</code></pre>
<h4 data-id="heading-8">4. 事务传播机制配置不当</h4>
<p><strong>失效原理</strong>：传播机制定义了事务方法嵌套时的行为，若配置了“不支持事务”的传播属性（如NOT_SUPPORTED、SUPPORTS），会导致操作脱离事务上下文执行。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {  
    <span class="hljs-meta">@Autowired</span>  
    <span class="hljs-keyword">private</span> StockService stockService;  
      
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {  
        orderMapper.insert(order);  
        <span class="hljs-comment">// 调用不支持事务的方法，库存扣减操作脱离事务  </span>
        stockService.reduceStock(order.getProductId(), order.getNum());  
    }  
}  
  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockService</span> {  
    <span class="hljs-comment">// NOT_SUPPORTED：以非事务方式执行，若存在事务则挂起  </span>
    <span class="hljs-meta">@Transactional(propagation = Propagation.NOT_SUPPORTED)</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reduceStock</span><span class="hljs-params">(Long productId, Integer num)</span> {  
        stockMapper.updateStock(productId, num);  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>; <span class="hljs-comment">// 异常不会触发回滚  </span>
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：根据业务需求选择正确的传播机制，绝大多数场景使用默认的REQUIRED（存在事务则加入，否则新建）即可：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reduceStock</span><span class="hljs-params">(Long productId, Integer num)</span> {  
    <span class="hljs-comment">// 业务逻辑不变  </span>
}  
</code></pre>
<h4 data-id="heading-9">5. 同类方法内部调用</h4>
<p><strong>失效原理</strong>：Spring事务基于AOP动态代理，事务增强逻辑封装在代理对象中。若同一类中的无事务方法A调用有事务方法B，调用过程未经过代理对象，直接触发目标对象方法，导致事务注解失效。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {  
    <span class="hljs-comment">// 无事务方法  </span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserInfo</span><span class="hljs-params">(Long id, String name, Integer age)</span> {  
        updateUserName(id, name); <span class="hljs-comment">// 内部调用，事务失效  </span>
        updateUserAge(id, age);   <span class="hljs-comment">// 内部调用，事务失效  </span>
    }  
      
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserName</span><span class="hljs-params">(Long id, String name)</span> {  
        userMapper.updateName(id, name);  
    }  
      
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserAge</span><span class="hljs-params">(Long id, Integer age)</span> {  
        userMapper.updateAge(id, age);  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：两种思路——通过AopContext获取代理对象调用，或拆分事务方法到不同类中。推荐后者，更符合代码设计原则：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-comment">// 方案一：获取代理对象调用  </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserInfo</span><span class="hljs-params">(Long id, String name, Integer age)</span> {  
    <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (UserService) AopContext.currentProxy();  
    proxy.updateUserName(id, name);  
    proxy.updateUserAge(id, age);  
}  
  
<span class="hljs-comment">// 方案二：拆分到不同类（推荐）  </span>
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserNameService</span> {  
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserName</span><span class="hljs-params">(Long id, String name)</span> {  
        userMapper.updateName(id, name);  
    }  
}  
</code></pre>
<h4 data-id="heading-10">6. 数据库不支持事务</h4>
<p><strong>失效原理</strong>：事务最终依赖数据库引擎支持，若使用MySQL的MyISAM引擎（不支持事务），或数据库配置为“只读模式”，Java层面的事务配置再完善也无法生效。</p>
<p><strong>排查与修复</strong>：① 确认数据库表引擎为InnoDB（支持事务）；② 检查数据库连接URL是否包含“readOnly=true”等只读配置；③ 执行<code>show variables like 'transaction_isolation'</code>确认数据库隔离级别正常。</p>
<h4 data-id="heading-11">7. 多线程调用事务方法</h4>
<p><strong>失效原理</strong>：Spring事务通过ThreadLocal存储事务状态，确保同一线程内的操作共享事务上下文。若主线程开启新线程调用事务方法，新线程无法继承主线程的事务状态，导致事务独立生效或失效。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {  
    <span class="hljs-meta">@Autowired</span>  
    <span class="hljs-keyword">private</span> LogService logService;  
      
    <span class="hljs-meta">@Transactional</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {  
        orderMapper.insert(order);  
        <span class="hljs-comment">// 新线程调用事务方法，日志记录失败不会导致订单回滚  </span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; logService.recordOrderLog(order.getId())).start();  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：避免在事务方法中通过新线程执行核心业务操作；若需记录日志等非核心操作，可采用消息队列异步处理，或接受其与主事务的独立性。</p>
<h4 data-id="heading-12">8. 只读事务配置了写操作</h4>
<p><strong>失效原理</strong>：<code>@Transactional(readOnly = true)</code>标记的事务为只读事务，数据库会优化连接为只读模式，拒绝执行INSERT、UPDATE等写操作。若强行执行写操作，部分数据库会抛出异常，部分则直接忽略事务配置。</p>
<p><strong>失效代码</strong>：</p>
<pre><code class="hljs language-java" lang="java">  
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SupplierService</span> {  
    <span class="hljs-comment">// 只读事务配置写操作，事务失效或抛出异常  </span>
    <span class="hljs-meta">@Transactional(readOnly = true)</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateSupplierName</span><span class="hljs-params">(Long id, String name)</span> {  
        supplierMapper.updateName(id, name);  
    }  
}  
</code></pre>
<p><strong>修复方案</strong>：仅对纯查询方法配置<code>readOnly = true</code>，写操作移除该属性或设置为false。</p>
<h3 data-id="heading-13">三、事务问题排查的核心思路</h3>
<p>遇到事务失效问题时，可按“三层排查法”定位问题：</p>
<ol>
<li>
<p><strong>注解配置层</strong>：检查<code>@Transactional</code>注解是否存在——方法是否为public、传播机制是否合理、rollbackFor是否包含目标异常。</p>
</li>
<li>
<p><strong>代理执行层</strong>：确认调用是否经过Spring代理——是否存在自调用问题、是否通过新线程调用、AOP代理是否正常生成（可通过日志打印代理对象类型验证）。</p>
</li>
<li>
<p><strong>数据库层</strong>：验证数据库是否支持事务——引擎是否为InnoDB、连接是否有权限、是否处于只读模式。</p>
</li>
</ol>
<h3 data-id="heading-14">四、总结</h3>
<p>Java事务的核心是通过“逻辑绑定”与“异常控制”保障数据一致性，其实现从JDBC的简单封装到Spring的声明式管理，本质都是对ACID特性的落地。事务失效并非玄学，而是对“代理机制”“异常传播”“数据库支持”等细节的忽视。开发中需牢记：事务是Java代码与数据库协同的结果，仅靠注解配置无法保障可靠性，必须结合业务场景理解底层原理，才能写出真正可靠的事务代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python中迭代器和生成器：让数据“懒”得刚刚好 💤]]></title>    <link>https://juejin.cn/post/7583571595202887718</link>    <guid>https://juejin.cn/post/7583571595202887718</guid>    <pubDate>2025-12-14T13:30:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583571595202887718" data-draft-id="7583576605780459566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python中迭代器和生成器：让数据“懒”得刚刚好 💤"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-14T13:30:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南风以南"/> <meta itemprop="url" content="https://juejin.cn/user/3685218709418279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python中迭代器和生成器：让数据“懒”得刚刚好 💤
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3685218709418279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南风以南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:30:46.000Z" title="Sun Dec 14 2025 13:30:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“聪明的程序员不是算得更快，而是<strong>算得更少</strong>。”<br/>
—— 迭代器与生成器，正是 Python 践行这一哲学的优雅体现。</p>
</blockquote>
<h2 data-id="heading-0">问题引入</h2>
<p>你有没有遇到过这样的场景？</p>
<ul>
<li>想遍历一个超大文件，但内存爆了 ❌</li>
<li>写了个 <code>range(10**9)</code>，结果电脑卡死 🐌</li>
<li>面试被问：“迭代器和生成器有啥区别？” 瞬间语塞 😅</li>
</ul>
<p>别慌！今天我们就把这两个看似高冷的概念，用一杯咖啡的时间讲清楚 ☕️。它们不是魔法，而是<strong>延迟计算（Lazy Evaluation）</strong> 的实用工具——只在你需要时才干活，绝不提前内卷！</p>
<hr/>
<h2 data-id="heading-1">核心剖析</h2>
<h3 data-id="heading-2">迭代器（Iterator）：会“一步一步走”的对象</h3>
<p>在 Python 中，<strong>迭代器</strong>是一个实现了 <code>__iter__()</code> 和 <code>__next__()</code> 方法的对象。它遵循<strong>迭代协议</strong>：</p>
<ul>
<li><code>__iter__()</code> 返回自身（支持 <code>for</code> 循环）</li>
<li><code>__next__()</code> 返回下一个值，若无则抛出 <code>StopIteration</code></li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Countdown</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, start</span>):
        self.start = start

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__next__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">if</span> self.start &lt;= <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> StopIteration
        self.start -= <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> self.start + <span class="hljs-number">1</span>

<span class="hljs-comment"># 使用</span>
<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> Countdown(<span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(num)  <span class="hljs-comment"># 输出: 3, 2, 1</span>
</code></pre>
<blockquote>
<p>💡 所有可迭代对象（如 list、dict）本身<strong>不是迭代器</strong>，但可以通过 <code>iter()</code> 转成迭代器。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">生成器（Generator）：写起来像函数，用起来像迭代器</h3>
<p><strong>生成器</strong>是创建迭代器的“快捷方式”。你只需在函数中用 <code>yield</code> 替代 <code>return</code>，Python 自动帮你实现迭代协议！</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">countdown_gen</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">while</span> n &gt; <span class="hljs-number">0</span>:
        <span class="hljs-keyword">yield</span> n
        n -= <span class="hljs-number">1</span>

<span class="hljs-comment"># 使用</span>
<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> countdown_gen(<span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(num)  <span class="hljs-comment"># 输出: 3, 2, 1</span>
</code></pre>
<p>关键区别来了👇：</p>






























<table><thead><tr><th>特性</th><th>迭代器</th><th>生成器</th></tr></thead><tbody><tr><td>创建方式</td><td>手写类 + <code>__iter__</code>/<code>__next__</code></td><td>函数 + <code>yield</code></td></tr><tr><td>内存占用</td><td>手动控制</td><td>自动优化，极低</td></tr><tr><td>可读性</td><td>较繁琐</td><td>极简清晰 ✅</td></tr><tr><td>适用场景</td><td>复杂状态管理</td><td>流式数据、无限序列</td></tr></tbody></table>
<blockquote>
<p>🚀 生成器本质是<strong>语法糖</strong>，但它甜得恰到好处！</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">动手实践：处理大文件不崩内存</h2>
<p>假设你有一个 10GB 的日志文件，想逐行读取并过滤错误信息：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_large_file</span>(<span class="hljs-params">file_path</span>):
    <span class="hljs-string">"""生成器：按需读取，不加载全文件到内存"""</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
            <span class="hljs-keyword">if</span> <span class="hljs-string">'ERROR'</span> <span class="hljs-keyword">in</span> line:
                <span class="hljs-keyword">yield</span> line.strip()

<span class="hljs-comment"># 使用（即使文件巨大，内存也稳如老狗）</span>
<span class="hljs-keyword">for</span> error_line <span class="hljs-keyword">in</span> read_large_file(<span class="hljs-string">'app.log'</span>):
    <span class="hljs-built_in">print</span>(error_line)
</code></pre>
<p>对比暴力做法 <code>lines = open('app.log').readlines()</code> —— 后者可能直接 OOM（Out of Memory）！</p>
<hr/>
<h2 data-id="heading-5">避坑指南 ⚠️</h2>
<ol>
<li>
<p><strong>生成器只能遍历一次！</strong></p>
<pre><code class="hljs language-python" lang="python">gen = (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))
<span class="hljs-built_in">list</span>(gen)  <span class="hljs-comment"># [0, 1, 2]</span>
<span class="hljs-built_in">list</span>(gen)  <span class="hljs-comment"># [] ← 已耗尽！</span>
</code></pre>
<p>解决方案：需要多次使用？转成 <code>list</code>，或重新调用生成器函数。</p>
</li>
<li>
<p><strong>别混淆“可迭代对象”和“迭代器”</strong></p>
<pre><code class="hljs language-python" lang="python">lst = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-built_in">iter</span>(lst) <span class="hljs-keyword">is</span> <span class="hljs-built_in">iter</span>(lst)  <span class="hljs-comment"># False！每次返回新迭代器</span>
it = <span class="hljs-built_in">iter</span>(lst)
<span class="hljs-built_in">iter</span>(it) <span class="hljs-keyword">is</span> it          <span class="hljs-comment"># True！迭代器的 __iter__ 返回自己</span>
</code></pre>
</li>
<li>
<p><strong>生成器表达式 vs 列表推导式</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 列表推导式：立即计算，占内存</span>
squares_list = [x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>)]

<span class="hljs-comment"># 生成器表达式：延迟计算，省内存</span>
squares_gen = (x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>))
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-6">延伸思考</h2>
<ul>
<li>
<p><strong><code>yield from</code> 是什么？</strong><br/>
它用于“委托”另一个生成器，避免嵌套 <code>for</code> 循环。比如合并多个生成器流。</p>
</li>
<li>
<p><strong>生成器能接收外部数据吗？</strong><br/>
可以！通过 <code>generator.send(value)</code> 实现双向通信，常用于协程（async/await 的底层基础之一）。</p>
</li>
<li>
<p><strong>为什么 <code>range()</code> 不是生成器？</strong><br/>
因为它是<strong>可重复迭代的序列对象</strong>，且支持 <code>len()</code>、索引等操作——生成器做不到这些。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-7">小结 &amp; 行动号召 💡</h2>
<ul>
<li><strong>迭代器</strong>：协议驱动，手动实现，灵活但啰嗦</li>
<li><strong>生成器</strong>：<code>yield</code> 一行搞定，内存友好，开发首选</li>
</ul>
<blockquote>
<p>下次当你需要处理“大量数据”“无限序列”或“流式输入”时，记得问自己：<br/>
<strong>“我能用生成器让它‘懒’一点吗？”</strong></p>
</blockquote>
<p>试试改写你项目中的某个循环，用生成器替代列表推导式，观察内存变化吧！欢迎在评论区分享你的“懒人优化”成果～ 🧪✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 启动流程源码解析：从 `main()` 到 Web 服务就绪]]></title>    <link>https://juejin.cn/post/7583225356905431080</link>    <guid>https://juejin.cn/post/7583225356905431080</guid>    <pubDate>2025-12-14T14:24:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583225356905431080" data-draft-id="7583234966635216930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 启动流程源码解析：从 `main()` 到 Web 服务就绪"/> <meta itemprop="keywords" content="Java,Spring Boot,面试"/> <meta itemprop="datePublished" content="2025-12-14T14:24:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Web天梯之路"/> <meta itemprop="url" content="https://juejin.cn/user/2825061103052843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 启动流程源码解析：从 `main()` 到 Web 服务就绪
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2825061103052843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Web天梯之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:24:35.000Z" title="Sun Dec 14 2025 14:24:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot 启动流程源码解析：从 <code>main()</code> 到 Web 服务就绪</h2>
<blockquote>
<p><strong>一句 <code>SpringApplication.run()</code> 背后，藏着整个 Spring 生态的启动引擎。</strong></p>
</blockquote>
<p>你是否曾：</p>
<ul>
<li>在面试被问：“Spring Boot 启动过程做了哪些事？”</li>
<li>遇到启动慢、Bean 找不到、配置不生效等问题却无从下手？</li>
<li>想自定义启动行为（如动态加载配置、埋点监控），但不知从何切入？</li>
</ul>
<p>答案，都在 <strong><code>SpringApplication.run()</code> 的源码里</strong>。</p>
<p>今天，我们就<strong>逐行拆解 Spring Boot 3.x（兼容 2.x）的启动主流程</strong>，带你从 <code>main()</code> 方法一路走到内嵌 Tomcat 启动完成！</p>
<h3 data-id="heading-1">一、入口：<code>main()</code> 方法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">MyApp</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<p>看似简单，实则调用了 <code>SpringApplication</code> 的静态方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// SpringApplication.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">Class&lt;?&gt; primarySource, <span class="hljs-built_in">String</span>... args</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">run</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[] { primarySource }, args);
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">Class&lt;?&gt;[] primarySources, <span class="hljs-built_in">String</span>[] args</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(primarySources).<span class="hljs-title function_">run</span>(args);
}
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：先构造 <code>SpringApplication</code> 实例，再调用其 <code>run()</code> 方法。</p>
</blockquote>
<h3 data-id="heading-2">二、阶段 1：构造 <code>SpringApplication</code> 对象</h3>
<pre><code class="hljs language-scss" lang="scss">public <span class="hljs-built_in">SpringApplication</span>(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources) {
    this<span class="hljs-selector-class">.resourceLoader</span> = resourceLoader;
    Assert<span class="hljs-selector-class">.notNull</span>(primarySources, "PrimarySources must not be null");
    this<span class="hljs-selector-class">.primarySources</span> = new LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));

    <span class="hljs-comment">// 1. 推断应用类型（SERVLET / REACTIVE / NONE）</span>
    this<span class="hljs-selector-class">.properties</span><span class="hljs-selector-class">.setWebApplicationType</span>(WebApplicationType.deduceFromClasspath());

    <span class="hljs-comment">// 2. 从 spring.factories 加载 BootstrapRegistryInitializer</span>
    this<span class="hljs-selector-class">.bootstrapRegistryInitializers</span> = new ArrayList&lt;&gt;(
                getSpringFactoriesInstances(BootstrapRegistryInitializer.class));

    <span class="hljs-comment">// 3. 从 spring.factories 加载 ApplicationContextInitializer</span>
    <span class="hljs-built_in">setInitializers</span>((Collection) <span class="hljs-built_in">getSpringFactoriesInstances</span>(ApplicationContextInitializer.class));

    <span class="hljs-comment">// 4. 从 spring.factories 加载 ApplicationListener</span>
    <span class="hljs-built_in">setListeners</span>((Collection) <span class="hljs-built_in">getSpringFactoriesInstances</span>(ApplicationListener.class));

    <span class="hljs-comment">// 5. 推断主配置类（即包含 main 方法的类）</span>
    this<span class="hljs-selector-class">.mainApplicationClass</span> = <span class="hljs-built_in">deduceMainApplicationClass</span>();
}
</code></pre>
<h4 data-id="heading-3">🔑 核心动作：</h4>
<ul>
<li>
<p><strong>推断 Web 类型</strong>：</p>
<pre><code class="hljs language-css" lang="css">SERVLET：classpath 中存在 Spring MVC 相关类（如 DispatcherServlet）
REACTIVE：存在 WebFlux 相关类（如 DispatcherHandler）
<span class="hljs-attribute">NONE</span>：非 Web 应用（如批处理、定时任务）
</code></pre>
</li>
<li>
<p><strong>加载扩展点</strong>：通过 <code>SpringFactoriesLoader</code> 读取 <code>META-INF/spring.factories</code> 中的 SPI 实现。</p>
</li>
</ul>
<blockquote>
<p>💡 这就是 Spring Boot <strong>自动装配和扩展机制的起点</strong>。</p>
</blockquote>
<h3 data-id="heading-4">三、阶段 2：执行 <code>run(args)</code> —— 启动主流程</h3>
<p>这是最核心的方法，我们分步解析：</p>
<h4 data-id="heading-5">步骤 1：准备监听器</h4>
<pre><code class="hljs language-ini" lang="ini">SpringApplicationRunListeners <span class="hljs-attr">listeners</span> = getRunListeners(args)<span class="hljs-comment">;</span>
listeners.starting(bootstrapContext, this.mainApplicationClass)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><code>getRunListeners()</code> 返回所有 <code>SpringApplicationRunListener</code> 实例（默认是 <code>EventPublishingRunListener</code>）</li>
<li><code>starting()</code> 发布 <strong><code>ApplicationStartingEvent</code></strong><br/>
→ 可用于早期日志初始化、APM 埋点</li>
</ul>
<h4 data-id="heading-6">步骤 2：准备 Environment（环境）</h4>
<pre><code class="hljs language-ini" lang="ini">DefaultBootstrapContext <span class="hljs-attr">bootstrapContext</span> = createBootstrapContext()<span class="hljs-comment">;</span>
ConfigurableEnvironment <span class="hljs-attr">environment</span> = prepareEnvironment(listeners, bootstrapContext, applicationArguments)<span class="hljs-comment">;</span>
</code></pre>
<p>在 <code>prepareEnvironment()</code> 中：</p>
<ul>
<li>创建 <code>Environment</code>（StandardServletEnvironment）</li>
<li>调用 <code>environmentPrepared()</code> → 发布 <strong><code>ApplicationEnvironmentPreparedEvent</code></strong></li>
<li><strong>此时 <code>application.properties</code> 已加载！</strong></li>
</ul>
<blockquote>
<p>🌟 <strong>实战价值</strong>：Nacos/Apollo 客户端在此阶段注入远程配置！</p>
</blockquote>
<hr/>
<h4 data-id="heading-7">步骤 3：创建 ApplicationContext（应用上下文）</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">context</span> = createApplicationContext()<span class="hljs-comment">;</span>
</code></pre>
<p>根据 <code>webApplicationType</code> 选择上下文类型：</p>
<ul>
<li><code>SERVLET</code> → <code>AnnotationConfigServletWebServerApplicationContext</code></li>
<li><code>REACTIVE</code> → <code>AnnotationConfigReactiveWebServerApplicationContext</code></li>
</ul>
<p>该上下文继承自 <code>GenericApplicationContext</code>，并具备 <strong>内嵌 Web 容器支持</strong>。</p>
<h4 data-id="heading-8">步骤 4：准备上下文</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">prepareContext</span>(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);
</code></pre>
<p>内部关键操作：</p>
<ul>
<li>注册 <code>banner</code> Bean</li>
<li>应用所有 <code>ApplicationContextInitializer</code></li>
<li>发布 <code>ApplicationContextInitializedEvent</code></li>
</ul>
<blockquote>
<p>⚠️ 注意：此时 <strong>Bean 还未实例化</strong>，只是定义已加载。</p>
</blockquote>
<h4 data-id="heading-9">步骤 5：刷新上下文（Refresh）—— 最重量级阶段！</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">refreshContext</span>(context);
</code></pre>
<p>最终调用 <code>AbstractApplicationContext.refresh()</code>（Spring Framework 的核心方法）：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
public void refresh() throws BeansException, IllegalStateException {
    synchronized (this.startupShutdownMonitor) {
        <span class="hljs-comment">// 1. 准备刷新（记录启动时间、设置活跃状态）</span>
        <span class="hljs-built_in">prepareRefresh</span>();

        <span class="hljs-comment">// 2. 获取 BeanFactory（通常是 DefaultListableBeanFactory）</span>
        ConfigurableListableBeanFactory beanFactory = <span class="hljs-built_in">obtainFreshBeanFactory</span>();

        <span class="hljs-comment">// 3. 配置 BeanFactory（设置类加载器、表达式解析器等）</span>
        <span class="hljs-built_in">prepareBeanFactory</span>(beanFactory);

        <span class="hljs-comment">// 4. 执行 BeanFactoryPostProcessor（如 @ConfigurationProperties 绑定）</span>
        <span class="hljs-built_in">invokeBeanFactoryPostProcessors</span>(beanFactory);

        <span class="hljs-comment">// 5. 注册 BeanPostProcessor</span>
        <span class="hljs-built_in">registerBeanPostProcessors</span>(beanFactory);

        <span class="hljs-comment">// 6. 初始化 MessageSource（国际化）</span>
        <span class="hljs-built_in">initMessageSource</span>();

        <span class="hljs-comment">// 7. 初始化事件广播器</span>
        <span class="hljs-built_in">initApplicationEventMulticaster</span>();

        <span class="hljs-comment">// 8. 【模板方法】子类可扩展（如 ServletWebServerApplicationContext 会在此启动内嵌容器）</span>
        <span class="hljs-built_in">onRefresh</span>();

        <span class="hljs-comment">// 9. 注册监听器</span>
        <span class="hljs-built_in">registerListeners</span>();

        <span class="hljs-comment">// 10. 实例化所有非懒加载的单例 Bean！</span>
        <span class="hljs-built_in">finishBeanFactoryInitialization</span>(beanFactory);

        <span class="hljs-comment">// 11. 完成刷新（发布 ContextRefreshedEvent）</span>
        <span class="hljs-built_in">finishRefresh</span>();
    }
}
</code></pre>
<h5 data-id="heading-10">🔥 重点子阶段解析：</h5>
<ul>
<li>
<p><strong><code>invokeBeanFactoryPostProcessors</code></strong><br/>
→ <code>ConfigurationClassPostProcessor</code> 扫描 <code>@Component</code>、<code>@Bean</code>，解析自动配置类（<code>spring.factories</code> 中的 <code>EnableAutoConfiguration</code>）</p>
</li>
<li>
<p><strong><code>onRefresh()</code>（在 Servlet 上下文中）</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onRefresh</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">onRefresh</span>();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-title function_">createWebServer</span>(); <span class="hljs-comment">// 启动内嵌 Tomcat/Jetty</span>
    }
}
</code></pre>
</li>
<li>
<p><strong><code>finishBeanFactoryInitialization</code></strong><br/>
→ 调用 <code>preInstantiateSingletons()</code>，触发所有单例 Bean 的创建（包括依赖注入、<code>@PostConstruct</code>）</p>
</li>
</ul>
<h4 data-id="heading-11">步骤 6：执行 Runner 启动完成</h4>
<pre><code class="hljs language-scss" lang="scss">/ 执行 CommandLineRunner / ApplicationRunner
<span class="hljs-built_in">callRunners</span>(context, applicationArguments);
</code></pre>
<blockquote>
<p>✅ 此时服务已完全就绪，可处理请求！</p>
</blockquote>
<h3 data-id="heading-12">四、启动流程全景图（简化版）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">ain</span>()
  ↓
new <span class="hljs-built_in">SpringApplication</span>()
  ├── 推断 Web 类型
  ├── 加载 Initializers &amp; Listeners
  ↓
<span class="hljs-built_in">run</span>(args)
  ├── <span class="hljs-built_in">starting</span>() → ApplicationStartingEvent
  ├── <span class="hljs-built_in">prepareEnvironment</span>() → 加载 application<span class="hljs-selector-class">.properties</span>
  ├── <span class="hljs-built_in">createApplicationContext</span>()
  ├── <span class="hljs-built_in">prepareContext</span>() → 注册主配置类
  ├── <span class="hljs-built_in">refreshContext</span>()
  │     ├── invokeBeanFactoryPostProcessors → 自动配置生效
  │     ├── <span class="hljs-built_in">onRefresh</span>() → 启动内嵌 Web 容器
  │     └── finishBeanFactoryInitialization → 初始化所有 Bean
  ├── <span class="hljs-built_in">callRunners</span>() → 执行启动后任务
</code></pre>
<h3 data-id="heading-13">五、学源码有什么用？实战场景举例</h3>



































<table><thead><tr><th>场景</th><th>利用的启动阶段</th><th>扩展方式</th></tr></thead><tbody><tr><td>动态加载远程配置</td><td><code>environmentPrepared</code></td><td>实现 <code>EnvironmentPostProcessor</code></td></tr><tr><td>启动耗时分析</td><td><code>starting()</code> / <code>running()</code></td><td>自定义 <code>SpringApplicationRunListener</code></td></tr><tr><td>服务注册延迟</td><td><code>ContextRefreshedEvent</code> 后</td><td>监听事件，确保 Bean 全部就绪</td></tr><tr><td>自定义 Banner</td><td><code>prepareContext</code> 阶段</td><td>实现 <code>Banner</code> 接口</td></tr><tr><td>避免循环依赖报错</td><td>理解 <code>finishBeanFactoryInitialization</code> 顺序</td><td>调整依赖关系或使用 <code>@Lazy</code></td></tr></tbody></table>
<p>📌 <strong>关注我</strong>，每天5分钟，带你从 Java 小白变身编程高手！<br/>
👉 点赞 + 关注，让更多小伙伴一起进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 钩子全集实战（一）：构造与配置阶段]]></title>    <link>https://juejin.cn/post/7583168260797841448</link>    <guid>https://juejin.cn/post/7583168260797841448</guid>    <pubDate>2025-12-14T14:25:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583168260797841448" data-draft-id="7583249151552274466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 钩子全集实战（一）：构造与配置阶段"/> <meta itemprop="keywords" content="Java,Spring Boot,面试"/> <meta itemprop="datePublished" content="2025-12-14T14:25:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Web天梯之路"/> <meta itemprop="url" content="https://juejin.cn/user/2825061103052843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 钩子全集实战（一）：构造与配置阶段
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2825061103052843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Web天梯之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:25:34.000Z" title="Sun Dec 14 2025 14:25:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot 钩子全集实战（一）：构造与配置阶段</h2>
<p>在使用 Spring Boot 时，我们通常这样启动一个应用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">DemoApplication</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<p>看起来简洁明了，对吧？但在这短短几行代码背后，Spring Boot 其实悄悄为我们预留了多个“钩子”，这些扩展点允许我们在应用启动的不同阶段注入自定义逻辑。</p>
<p>接下来，我将推出一个系列文章，带你系统掌握 Spring Boot 各个阶段的钩子机制。今天是第一篇：<strong>构造与配置阶段</strong>，通俗易懂、代码可运行！</p>
<h3 data-id="heading-1">一、什么是“构造与配置阶段”？</h3>
<p>简单来说，就是你创建 <code>SpringApplication</code> 对象到执行run方法之前的这段时间。</p>
<blockquote>
<p>这个阶段的关键特点是：<strong>还没有真正启动 Spring 容器！</strong></p>
</blockquote>
<h3 data-id="heading-2">二、该阶段的有哪些钩子？</h3>
<p>在这一阶段，我们主要通过配置 <code>SpringApplication</code> 实例来注入自定义行为，常见钩子有：</p>

























<table><thead><tr><th>钩子方法</th><th>类型</th><th>作用</th></tr></thead><tbody><tr><td><code>addInitializers(...)</code></td><td>方法调用</td><td>手动添加 <code>ApplicationContextInitializer</code>，用于在容器刷新前修改上下文</td></tr><tr><td><code>addListeners(...)</code></td><td>方法调用</td><td>手动添加 <code>ApplicationListener</code>，监听 Spring 事件</td></tr><tr><td><code>setXXX(...)</code> 系列</td><td>方法调用</td><td>设置主类、Banner 模式、Web 类型等</td></tr></tbody></table>
<h3 data-id="heading-3">三、 应用场景 + 代码示例</h3>
<h4 data-id="heading-4">1. <code>addInitializers(...)</code></h4>
<h5 data-id="heading-5">应用场景</h5>
<ul>
<li>在 Spring 容器刷新（refresh）之前，对 <code>ApplicationContext</code> 进行自定义配置，比如设置环境变量、注册自定义 Bean 定义、修改上下文的属性源等。</li>
<li>适用于需要在容器初始化早期注入全局配置的场景，例如多环境配置增强、自定义属性加载、权限相关的上下文初始化等。</li>
</ul>
<h5 data-id="heading-6">代码示例</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextInitializer;
<span class="hljs-keyword">import</span> org.springframework.context.ConfigurableApplicationContext;
<span class="hljs-keyword">import</span> org.springframework.core.env.ConfigurableEnvironment;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">SpringApplication</span> <span class="hljs-variable">application</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(DemoApplication.class);

        <span class="hljs-comment">// 自定义 ApplicationContextInitializer</span>
        ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; customInitializer = context -&gt; {
            <span class="hljs-comment">// 获取环境配置</span>
            <span class="hljs-type">ConfigurableEnvironment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> context.getEnvironment();
            <span class="hljs-comment">// 新增自定义环境变量</span>
            environment.getSystemProperties().put(<span class="hljs-string">"custom.app.name"</span>, <span class="hljs-string">"SpringHookDemo"</span>);
            <span class="hljs-comment">// 打印初始化日志</span>
            System.out.println(<span class="hljs-string">"ApplicationContext 初始化前：添加自定义环境变量 custom.app.name"</span>);
        };

        <span class="hljs-comment">// 添加初始化器（钩子方法）</span>
        application.addInitializers(customInitializer);

        <span class="hljs-comment">// 启动应用</span>
        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> application.run(args);

        <span class="hljs-comment">// 验证：获取并打印自定义变量</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">appName</span> <span class="hljs-operator">=</span> context.getEnvironment().getProperty(<span class="hljs-string">"custom.app.name"</span>);
        System.out.println(<span class="hljs-string">"启动后获取的自定义变量："</span> + appName);
    }
}
</code></pre>
<h5 data-id="heading-7">执行结果</h5>
<pre><code class="hljs language-vbnet" lang="vbnet">ApplicationContext 初始化前：添加自定义环境变量 <span class="hljs-keyword">custom</span>.app.name
启动后获取的自定义变量：SpringHookDemo
</code></pre>
<h4 data-id="heading-8">2. <code>addListeners(...)</code></h4>
<h5 data-id="heading-9">应用场景</h5>
<ul>
<li>监听 Spring Boot 生命周期中的核心事件（如 <code>ApplicationStartedEvent</code>、<code>ApplicationReadyEvent</code>、<code>ApplicationFailedEvent</code> 等），实现自定义的事件响应逻辑。</li>
<li>典型场景：应用启动成功后发送通知（邮件 / 钉钉）、启动失败时记录告警日志、监听上下文刷新事件做数据预热等。</li>
</ul>
<h5 data-id="heading-10">代码示例</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">SpringApplication</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">autoconfigure</span>.<span class="hljs-property">SpringBootApplication</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">ApplicationListener</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">context</span>.<span class="hljs-property">event</span>.<span class="hljs-property">ApplicationStartedEvent</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">context</span>.<span class="hljs-property">event</span>.<span class="hljs-property">ApplicationReadyEvent</span>;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span> application = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(<span class="hljs-title class_">DemoApplication</span>.<span class="hljs-property">class</span>);

        <span class="hljs-comment">// 监听应用启动事件（Started：容器已启动，但未处理请求）</span>
        <span class="hljs-title class_">ApplicationListener</span>&lt;<span class="hljs-title class_">ApplicationStartedEvent</span>&gt; startedListener = event -&gt; {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"事件监听：应用已启动（Started），开始初始化业务数据..."</span>);
            <span class="hljs-comment">// 模拟：初始化缓存、加载字典数据等</span>
        };

        <span class="hljs-comment">// 监听应用就绪事件（Ready：可处理请求）</span>
        <span class="hljs-title class_">ApplicationListener</span>&lt;<span class="hljs-title class_">ApplicationReadyEvent</span>&gt; readyListener = event -&gt; {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"事件监听：应用已就绪（Ready），发送启动成功通知..."</span>);
            <span class="hljs-comment">// 模拟：调用通知接口、记录启动日志等</span>
        };

        <span class="hljs-comment">// 添加事件监听器（钩子方法）</span>
        application.<span class="hljs-title function_">addListeners</span>(startedListener, readyListener);

        <span class="hljs-comment">// 启动应用</span>
        application.<span class="hljs-title function_">run</span>(args);
    }
}
</code></pre>
<h5 data-id="heading-11">执行结果</h5>
<pre><code class="hljs language-erlang" lang="erlang">事件监听：应用已启动（Started），开始初始化业务数据...
事件监听：应用已就绪（Ready），发送启动成功通知...
</code></pre>
<h4 data-id="heading-12">3. <code>setXXX(...)</code> 系列方法</h4>
<h5 data-id="heading-13">应用场景</h5>
<ul>
<li><code>setMainApplicationClass(Class&lt;?&gt; mainApplicationClass)</code>：手动指定应用主类（默认自动识别，特殊场景下需显式指定）；</li>
<li><code>setBannerMode(Banner.Mode mode)</code>：控制启动 Banner 的显示（关闭 / 控制台 / 日志文件）；</li>
<li><code>setWebApplicationType(WebApplicationType type)</code>：指定应用的 Web 类型（NONE：非 Web 应用、SERVLET：Servlet 容器、REACTIVE：响应式 Web）；</li>
<li><code>setAdditionalProfiles(String... profiles)</code>：设置额外的激活配置文件（如测试 / 生产环境）。</li>
</ul>
<h5 data-id="heading-14">代码示例（常用 set 方法组合）</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.WebApplicationType;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.Banner;

@SpringBootApplication
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        SpringApplication application = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SpringApplication</span>(DemoApplication.<span class="hljs-keyword">class</span>);

        <span class="hljs-comment">// 1. 关闭启动 Banner</span>
        application.<span class="hljs-built_in">setBannerMode</span>(Banner.Mode.OFF);

        <span class="hljs-comment">// 2. 指定为非 Web 应用（即使引入 Web 依赖，也不会启动 Tomcat 等容器）</span>
        application.<span class="hljs-built_in">setWebApplicationType</span>(WebApplicationType.NONE);

        <span class="hljs-comment">// 3. 激活 test 配置文件</span>
        application.<span class="hljs-built_in">setAdditionalProfiles</span>(<span class="hljs-string">"test"</span>);

        <span class="hljs-comment">// 4. 手动指定主类（可选，默认自动识别）</span>
        application.<span class="hljs-built_in">setMainApplicationClass</span>(DemoApplication.<span class="hljs-keyword">class</span>);

        <span class="hljs-comment">// 启动应用</span>
        application.<span class="hljs-built_in">run</span>(args);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"非 Web 应用启动完成，激活的配置文件：test"</span>);
    }
}
</code></pre>
<h5 data-id="heading-15">执行结果</h5>
<pre><code class="hljs language-bash" lang="bash">非 Web 应用启动完成，激活的配置文件：<span class="hljs-built_in">test</span>
</code></pre>
<p>（注：启动时不会显示 Spring Boot 的默认 Banner，也不会启动 Tomcat 容器）</p>
<h3 data-id="heading-16">四、总结</h3>
<ol>
<li><code>addInitializers</code> 核心作用是<strong>容器刷新前修改上下文</strong>，适用于早期全局配置注入；</li>
<li><code>addListeners</code> 用于<strong>监听 Spring 事件</strong>，实现启动 / 运行阶段的自定义响应逻辑；</li>
<li><code>setXXX</code> 系列是<strong>配置 SpringApplication 核心属性</strong>，覆盖 Banner、Web 类型、配置文件等基础行为。</li>
</ol>
<p>这些钩子均在 <code>SpringApplication.run()</code> 执行前调用</p>
<p>📌 <strong>关注我</strong>，每天5分钟，带你从 Java 小白变身编程高手！<br/>
👉 点赞 + 关注+转发，让更多小伙伴一起进步！</p>
<p>👉 私信"SpringBoot钩子源码" 获取源码！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第5讲:事务——数据一致性的保护伞]]></title>    <link>https://juejin.cn/post/7583576605780590638</link>    <guid>https://juejin.cn/post/7583576605780590638</guid>    <pubDate>2025-12-14T14:40:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583576605780590638" data-draft-id="7583576612390977546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第5讲:事务——数据一致性的保护伞"/> <meta itemprop="keywords" content="后端,MySQL"/> <meta itemprop="datePublished" content="2025-12-14T14:40:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="骑着bug的coder"/> <meta itemprop="url" content="https://juejin.cn/user/1922418579089566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第5讲:事务——数据一致性的保护伞
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1922418579089566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    骑着bug的coder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:40:23.000Z" title="Sun Dec 14 2025 14:40:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>目标:</strong> 理解ACID特性,掌握隔离级别,解决并发问题</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">开篇:一个转账引发的血案</h2>
<p><strong>需求：</strong> 模拟一个简单的转账场景。为了演示，我们需要先准备一张账户表。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 准备工作：创建账户表并初始化数据</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> account (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT COMMENT <span class="hljs-string">'主键'</span>,
    user_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    balance <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0.00</span> COMMENT <span class="hljs-string">'余额'</span>
) COMMENT <span class="hljs-string">'账户表'</span>;

<span class="hljs-comment">-- 初始化两个用户：用户1有1000元，用户2有0元</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> account (user_id, balance) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1000.00</span>), (<span class="hljs-number">2</span>, <span class="hljs-number">0.00</span>);
</code></pre>
<p>想象一个场景:你给朋友转账1000元。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 第1步:从你的账户扣1000</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- 第2步:给朋友账户加1000</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
</code></pre>
<p>如果第1步执行成功,你的钱扣了。但第2步突然断电了,朋友没收到钱。</p>
<p>这1000元凭空消失了!</p>
<p>这就是没有事务保护的后果。今天咱们就来搞懂:什么是事务?怎么用事务保证数据不出错?</p>
<hr/>
<h2 data-id="heading-1">一、事务是什么?</h2>
<p><strong>一句话定义:</strong> 事务是一组SQL操作,要么全部成功,要么全部失败,不存在"做一半"的情况。</p>
<h3 data-id="heading-2">事务的基本语法</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开启事务</span>
<span class="hljs-keyword">START</span> TRANSACTION;
<span class="hljs-comment">-- 或者用 BEGIN;</span>

<span class="hljs-comment">-- 执行SQL操作</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">-- 提交事务(确认修改)</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 或者回滚事务(撤销修改)</span>
<span class="hljs-keyword">ROLLBACK</span>;
</code></pre>
<h3 data-id="heading-3">转账场景正确写法</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> TRANSACTION;

<span class="hljs-comment">-- 扣款</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- 加款</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">-- 检查余额是否正确</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">SUM</span>(balance) <span class="hljs-keyword">FROM</span> account <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);

<span class="hljs-comment">-- 确认无误,提交</span>
<span class="hljs-keyword">COMMIT</span>;
<span class="hljs-comment">-- 如果有问题,执行 ROLLBACK;</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">二、ACID特性:事务的四大保障</h2>
<p>ACID是事务的四大特性,缺一不可。用转账场景来理解:</p>
<h3 data-id="heading-5">A - 原子性(Atomicity)</h3>
<p><strong>含义:</strong> 事务是最小执行单位,要么全成功,要么全失败。</p>
<p><strong>转账场景:</strong> 扣款和加款必须同时成功。如果加款失败,扣款也要撤销。</p>
<p><strong>怎么实现的?</strong> 靠<strong>undo log(回滚日志)</strong>。MySQL会记录修改前的数据,出错时根据日志回滚。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> TRANSACTION;
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">-- 成功</span>
<span class="hljs-keyword">UPDATE</span> account <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">999</span>; <span class="hljs-comment">-- 失败(用户不存在)</span>
<span class="hljs-keyword">ROLLBACK</span>; <span class="hljs-comment">-- 第1步的扣款会被撤销</span>
</code></pre>
<h3 data-id="heading-6">C - 一致性(Consistency)</h3>
<p><strong>含义:</strong> 事务执行前后,数据的完整性约束不能被破坏。</p>
<p><strong>转账场景:</strong> 转账前后,两个账户的总金额必须不变。</p>
<p><strong>举例:</strong></p>
<ul>
<li>转账前:A有5000,B有3000,总额8000</li>
<li>转账后:A有4000,B有4000,总额还是8000</li>
</ul>
<p><strong>怎么实现的?</strong> 一致性是最终目标，它是由 A (原子性)、I (隔离性)、D (持久性) 共同保证的，再加上应用层的逻辑判断（比如转账金额不能为负数）。</p>
<p>如果总额变了,说明数据不一致了,事务必须回滚。</p>
<h3 data-id="heading-7">I - 隔离性(Isolation)</h3>
<p><strong>含义:</strong> 多个事务并发执行时,互不干扰。</p>
<p><strong>转账场景:</strong> 你给A转账的同时,别人也在给A转账,两个事务不能互相影响。</p>
<p><strong>怎么实现的?</strong> 靠<strong>锁 (Locks)</strong> 和 <strong>MVCC (多版本并发控制)</strong>。</p>
<blockquote>
<ul>
<li><strong>锁</strong>：像红绿灯，阻止冲突的修改。</li>
<li><strong>MVCC</strong>：像平行宇宙，让读写互不干扰。</li>
<li><em>(这两个概念非常重要，我们会在第7讲专门深入讲解)</em></li>
</ul>
</blockquote>
<p><strong>问题:</strong> 这是最复杂的特性,后面会详细讲"隔离级别"。</p>
<h3 data-id="heading-8">D - 持久性(Durability)</h3>
<p><strong>含义:</strong> 事务一旦提交,数据永久保存,即使系统崩溃也不会丢。</p>
<p><strong>转账场景:</strong> 提交后显示"转账成功",这时就算断电,钱也不会丢。</p>
<p><strong>怎么实现的?</strong> 靠<strong>redo log(重做日志)</strong>。提交时先写日志,崩溃后根据日志恢复。</p>
<blockquote>
<p>💡 <strong>小贴士</strong>：Undo Log 和 Redo Log 是 MySQL InnoDB 引擎的底层核心。如果你觉得这两个概念有点抽象，别担心，我们会在后续的章节中详细拆解它们的内部结构。现在你只需要记住：<strong>Undo Log 管回滚（原子性），Redo Log 管不丢（持久性）</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">三、并发事务带来的问题</h2>
<p>如果数据库只有一个用户，那上面的ACID很简单。但现实是，每一秒都可能有成千上万个事务在同时运行。当他们同时操作同一条数据时，就会出现各种奇葩问题。</p>
<h3 data-id="heading-10">1. 脏读 (Dirty Read) —— 读到了“假数据”</h3>
<p><strong>场景：</strong>
事务A修改了数据但还没提交，事务B却读到了这个修改。结果事务A回滚了，事务B读到的就是“脏数据”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/606e771e574a47d1bdaadf3e3cab6202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=DdDY7qRCW6VcW51qLhizwJzU%2FiM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">2. 不可重复读 (Non-repeatable Read) —— 读着读着变了</h3>
<p><strong>场景：</strong>
事务A先读了一次数据，然后事务B修改并提交了。事务A再读一次，发现数据变了！
“不可重复读”的意思就是：<strong>在同一个事务里，同样的查询，读到的结果不一致。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a6ef16913d74efdaa6aa5f41da55a59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=rQapTGMfE8pERfQ4onCSewlNq%2Fk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-12">3. 幻读 (Phantom Read) —— 见鬼了？</h3>
<p><strong>场景：</strong>
事务A查询“存款&gt;1000的用户”，发现只有1个。这时事务B插入了一个新用户并提交。事务A再次查询，发现变成了2个！就像产生了幻觉一样。</p>
<p><strong>区别：</strong></p>
<ul>
<li><strong>不可重复读</strong>：针对<strong>修改 (UPDATE/DELETE)</strong>，同一条记录变了。</li>
<li><strong>幻读</strong>：针对<strong>插入 (INSERT)</strong>，多出了新记录。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9643975c3289408ea630aabfc42382c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=%2BhLH83XHCLkrWEu48KJm01raEt8%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-13">四、事务隔离级别：给并发穿上防护服</h2>
<p>为了解决上面这些问题，SQL标准定义了4种隔离级别。隔离级别越高，数据越安全，但并发性能越差。</p>








































<table><thead><tr><th align="left">隔离级别</th><th align="center">脏读</th><th align="center">不可重复读</th><th align="center">幻读</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>Read Uncommitted</strong> (读未提交)</td><td align="center">✅ 可能</td><td align="center">✅ 可能</td><td align="center">✅ 可能</td><td align="left">裸奔状态，几乎不用</td></tr><tr><td align="left"><strong>Read Committed</strong> (读已提交)</td><td align="center">❌ 解决</td><td align="center">✅ 可能</td><td align="center">✅ 可能</td><td align="left"><strong>Oracle/SQL Server 默认</strong>。能读到别人已提交的数据。</td></tr><tr><td align="left"><strong>Repeatable Read</strong> (可重复读)</td><td align="center">❌ 解决</td><td align="center">❌ 解决</td><td align="center">✅ 可能</td><td align="left"><strong>MySQL 默认</strong>。确保同一事务内读取一致。</td></tr><tr><td align="left"><strong>Serializable</strong> (串行化)</td><td align="center">❌ 解决</td><td align="center">❌ 解决</td><td align="center">❌ 解决</td><td align="left">排队执行，最安全但最慢</td></tr></tbody></table>
<blockquote>
<p><em>注：MySQL的InnoDB引擎通过MVCC（多版本并发控制）和间隙锁（Gap Lock），在RR级别下其实已经解决了大部分幻读问题。</em></p>
</blockquote>
<h3 data-id="heading-14">实战：查看与修改隔离级别</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看当前隔离级别</span>
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@transaction</span>_isolation;

<span class="hljs-comment">-- 设置会话隔离级别为 读未提交 (用于复现脏读)</span>
<span class="hljs-keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="hljs-operator">=</span> <span class="hljs-string">'READ-UNCOMMITTED'</span>;
</code></pre>
<h2 data-id="heading-15"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e945e716e4964eaa9a32d070553fd222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=UWbZeDwSJX5LWOCxnR8rGELc8M4%3D" alt="image.png" loading="lazy"/></h2>
<h2 data-id="heading-16">五、事务的幕后英雄：Undo Log 与 Redo Log</h2>
<p>还记得开头的问题吗？</p>
<ol>
<li><strong>怎么保证原子性（出错能回滚）？</strong> —— 靠 <strong>Undo Log</strong></li>
<li><strong>怎么保证持久性（断电不丢数据）？</strong> —— 靠 <strong>Redo Log</strong></li>
</ol>
<h3 data-id="heading-17">1. Undo Log (回滚日志) —— 后悔药</h3>
<ul>
<li><strong>作用</strong>：记录数据<strong>修改前</strong>的样子。</li>
<li><strong>原理</strong>：
<ul>
<li>你执行 <code>INSERT</code>，它记录一条 <code>DELETE</code>。</li>
<li>你执行 <code>UPDATE x=1</code>，它记录 <code>UPDATE x=0</code>。</li>
</ul>
</li>
<li><strong>时刻</strong>：事务回滚时，或者数据库崩溃重启时，利用Undo Log把数据恢复原样。这也是MVCC（多版本并发控制）实现的基础。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239cf29f00904b6e82f8f324fcad9e52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=Tvs8eeJXv9OHkUgM%2BpfCJZBr06Y%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-18">2. Redo Log (重做日志) —— 记账本</h3>
<ul>
<li><strong>作用</strong>：确保数据不丢失。</li>
<li><strong>原理</strong>：<strong>WAL (Write-Ahead Logging)</strong> 技术。
<ul>
<li>修改数据时，先写日志（Redo Log），再写磁盘数据文件。</li>
<li>因为写日志是<strong>顺序写</strong>（极快），写数据文件是<strong>随机写</strong>（慢）。</li>
<li>如果断电，重启后读取Redo Log，把没写进磁盘的数据“重做”一遍。</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/104f52228f244e05b597cf228d37db62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aqR552AYnVn55qEY29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766328023&amp;x-signature=nfLCZMvKNltmcfdXs%2FvSw2PNO3A%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p><strong>预告</strong>：Undo Log 和 Redo Log 的底层实现远比我们刚才看到的要精密得多（涉及 Checkpoint、LSN、Double Write 等复杂机制）。
目前我们已经掌握了它们的核心逻辑。接下来的章节，我们将先攻克 “索引” 和 “锁” 这两座大山。当我们集齐了这些拼图后，会有一个专门的章节来**“解剖 InnoDB 的心脏”**，届时我们将深入底层，彻底搞懂这些日志是如何协同工作，支撑起数据库的高可靠性的。</p>
</blockquote>
<hr/>
<h2 data-id="heading-19">六、避坑指南：事务的隐形杀手</h2>
<h3 data-id="heading-20">1. 忘记 <code>autocommit</code></h3>
<p>MySQL 默认是 <code>autocommit=1</code>（自动提交）。这意味着你执行一条 <code>UPDATE</code>，它就立马生效了，没法回滚。</p>
<ul>
<li><strong>建议</strong>：在生产环境操作数据时，显式开启事务 <code>START TRANSACTION</code>，确认无误后再 <code>COMMIT</code>。</li>
</ul>
<h3 data-id="heading-21">2. 长事务 (Long Transaction)</h3>
<p>不要在一个事务里做太久的操作（比如调用第三方接口、处理大文件）。</p>
<ul>
<li><strong>后果</strong>：会锁住大量数据，导致数据库堵塞，甚至把数据库拖垮。</li>
<li><strong>原则</strong>：<strong>速战速决</strong>。事务里只放必要的 SQL 操作。</li>
</ul>
<hr/>
<h2 data-id="heading-22">七、本讲作业</h2>
<ol>
<li><strong>复现脏读</strong>：开启两个终端，将隔离级别设为 <code>READ-UNCOMMITTED</code>，体验一下“读到别人没提交的数据”是什么感觉。</li>
<li><strong>思考题</strong>：为什么MySQL默认选择 <code>Repeatable Read</code>，而Oracle默认选择 <code>Read Committed</code>？（提示：与历史上的主从复制格式有关）。</li>
</ol>
<blockquote>
<p><strong>给初学者的话</strong>：
本讲出现了不少新名词（如 Undo Log, Redo Log, MVCC）。如果觉得一下子消化不了，<strong>完全正常</strong>！
现在的目标是建立“宏观概念”：知道事务能干什么，知道并发会有什么问题。至于底层是怎么实现的，我们在后面的章节会像剥洋葱一样一层层拆解。别急，慢慢来！</p>
</blockquote>
<hr/>
<h2 data-id="heading-23">八、下一讲预告</h2>
<p>事务保证了数据的安全，但如果数据量有几千万行，查询慢得像蜗牛怎么办？</p>
<p><strong>第6讲：索引（上）——B+树与查询加速原理</strong></p>
<ul>
<li>为什么加了索引查询就快了？</li>
<li><strong>B+树</strong>到底长什么样？为什么不用Hash或二叉树？</li>
<li><strong>聚簇索引</strong>和<strong>非聚簇索引</strong>的区别。</li>
<li><strong>联合索引</strong>与<strong>最左匹配原则</strong>是什么？</li>
</ul>
<p>下一讲，我们深入MySQL的“神经系统”，让你的查询飞起来！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL-锁机制]]></title>    <link>https://juejin.cn/post/7583567658253271066</link>    <guid>https://juejin.cn/post/7583567658253271066</guid>    <pubDate>2025-12-14T14:10:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583567658253271066" data-draft-id="7583571595202215974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL-锁机制"/> <meta itemprop="keywords" content="后端,MySQL"/> <meta itemprop="datePublished" content="2025-12-14T14:10:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coderCatIce"/> <meta itemprop="url" content="https://juejin.cn/user/127981962405726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL-锁机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/127981962405726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coderCatIce
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:10:20.000Z" title="Sun Dec 14 2025 14:10:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MySQL 锁机制</h2>
<h3 data-id="heading-1">一、全局锁（Global Lock）</h3>
<h4 data-id="heading-2">1. 核心定义</h4>
<ul>
<li>
<p><strong>锁定整个MySQL实例</strong>，所有库/表的读写操作均被阻塞</p>
</li>
<li>
<p>仅支持<strong>读操作</strong>（加锁后），所有DDL、DML写操作均被阻塞</p>
</li>
</ul>
<h4 data-id="heading-3">2. 加锁/解锁方式</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 加全局读锁（阻塞所有写操作）</span>
FLUSH TABLES <span class="hljs-keyword">WITH</span> READ LOCK (FTWRL);
<span class="hljs-comment">-- 解锁</span>
UNLOCK TABLES;
</code></pre>
<h4 data-id="heading-4">3. 适用场景</h4>
<ul>
<li>
<p><strong>全库逻辑备份</strong>：保证备份数据的一致性</p>
</li>
<li>
<p><strong>替代方案</strong>：MySQL 5.6+ 可使用 <code>mysqldump --single-transaction</code>（仅限InnoDB）</p>
</li>
<li>
<p>MySQL 8.0+ 推荐使用 <code>mysqldump --source-data</code> 或物理备份工具</p>
</li>
</ul>
<h4 data-id="heading-5">4. 核心风险</h4>
<ul>
<li>
<p>加锁期间业务完全阻塞（无法执行任何写操作）</p>
</li>
<li>
<p>主从架构中，主库只读会导致从库同步延迟</p>
</li>
<li>
<p>FTWRL会关闭所有打开的表，可能导致性能抖动</p>
</li>
</ul>
<h3 data-id="heading-6">二、表级锁（Table-Level Lock）</h3>
<h4 data-id="heading-7">1. 基础表锁（READ/WRITE）</h4>




















<table><thead><tr><th>锁类型</th><th>核心定义</th><th>兼容关系（同一张表）</th></tr></thead><tbody><tr><td>表读锁（READ）</td><td><strong>允许所有会话读</strong>，<strong>禁止所有会话写</strong></td><td>多个READ锁兼容；与WRITE锁互斥</td></tr><tr><td>表写锁（WRITE）</td><td><strong>允许持有锁的会话读写</strong>，<strong>禁止其他所有会话读写</strong></td><td>与任何表锁（READ/WRITE）互斥</td></tr></tbody></table>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 加表读锁</span>
LOCK TABLES `<span class="hljs-keyword">user</span>` READ;
<span class="hljs-comment">-- 加表写锁</span>
LOCK TABLES `<span class="hljs-keyword">user</span>` WRITE;
<span class="hljs-comment">-- 解锁</span>
UNLOCK TABLES;
</code></pre>
<h4 data-id="heading-8">2. 元数据锁（MDL）</h4>
<h5 data-id="heading-9">核心定义</h5>
<ul>
<li>
<p><strong>自动加锁</strong>的表级锁，保护<strong>表结构</strong>不被并发修改</p>
</li>
<li>
<p>MySQL 5.5+引入，避免DDL与DML冲突</p>
</li>
</ul>
<h5 data-id="heading-10">加锁规则</h5>




















<table><thead><tr><th>操作类型</th><th>加锁类型</th><th>核心特性</th></tr></thead><tbody><tr><td>SELECT/INSERT/UPDATE/DELETE</td><td>MDL读锁（共享）</td><td>多个读锁兼容</td></tr><tr><td>ALTER TABLE/DROP TABLE</td><td>MDL写锁（排他）</td><td>与所有MDL锁互斥</td></tr></tbody></table>
<h5 data-id="heading-11">MDL生命周期</h5>
<ul>
<li>
<p><strong>读锁</strong>：事务开始时自动获取，事务提交/回滚时释放</p>
</li>
<li>
<p><strong>写锁</strong>：DDL执行期间持有，执行完成立即释放</p>
</li>
</ul>
<h5 data-id="heading-12">核心风险：MDL锁等待</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景：长事务阻塞DDL</span>
<span class="hljs-comment">-- 会话1（长事务）：</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">-- 获取MDL读锁</span>
<span class="hljs-comment">-- 不提交，保持事务打开</span>

<span class="hljs-comment">-- 会话2（DDL操作）：</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> age <span class="hljs-type">INT</span>;  <span class="hljs-comment">-- 等待MDL写锁，被阻塞！</span>

<span class="hljs-comment">-- 会话3（新查询）：</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users LIMIT <span class="hljs-number">1</span>;  <span class="hljs-comment">-- 也被阻塞，等待MDL读锁</span>
</code></pre>
<p><strong>优化建议</strong>：</p>
<ol>
<li>
<p>监控长事务：<code>SELECT * FROM information_schema.INNODB_TRX;</code></p>
</li>
<li>
<p><strong>DDL操作选择业务低峰期</strong></p>
</li>
<li>
<p>使用Online DDL（MySQL 5.6+）</p>
</li>
</ol>
<h4 data-id="heading-13">3. 意向锁（IS/IX）</h4>
<h5 data-id="heading-14">核心定义</h5>
<ul>
<li>
<p>InnoDB专属<strong>表级标记锁</strong></p>
</li>
<li>
<p><strong>行锁的"意向声明"</strong> ，避免表锁与行锁冲突</p>
</li>
<li>
<p>减少锁冲突检查的开销（无需遍历每行）</p>
</li>
</ul>
<h5 data-id="heading-15">分类与加锁规则</h5>




















<table><thead><tr><th>意向锁类型</th><th>触发条件</th><th>核心作用</th></tr></thead><tbody><tr><td>IS（意向共享）</td><td>事务计划对某些行加S锁前</td><td>标记"表内有/将有共享行锁"</td></tr><tr><td>IX（意向排他）</td><td>事务计划对某些行加X锁前</td><td>标记"表内有/将有排他行锁"</td></tr></tbody></table>
<h5 data-id="heading-16">兼容关系矩阵</h5>













































<table><thead><tr><th>请求锁↓ \ 已有锁 →</th><th>无锁</th><th>IS</th><th>IX</th><th>S（表读锁）</th><th>X（表写锁）</th></tr></thead><tbody><tr><td><strong>IS</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>IX</strong></td><td>✅</td><td>✅</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td><strong>S</strong></td><td>✅</td><td>✅</td><td>❌</td><td>✅</td><td>❌</td></tr><tr><td><strong>X</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>❌</td></tr></tbody></table>
<h3 data-id="heading-17">三、行级锁（Row-Level Lock）⭐⭐⭐</h3>
<p><strong>注意：行锁实际上是加在索引上的锁，而在InnoDB中默认加行锁就是加临键锁</strong></p>
<blockquote>
<p>补充注意：仅当 WHERE 条件命中索引列（如主键）时才是行锁，<strong>无索引会升级为表锁</strong>；仅 <a href="https://juejin.cn/post/7581470169840648230" target="_blank" title="https://juejin.cn/post/7581470169840648230">InnoDB存储引擎</a> 有行锁。</p>
</blockquote>
<h4 data-id="heading-18">1. 基本行锁（S锁/X锁）</h4>


























<table><thead><tr><th>锁类型</th><th>核心定义</th><th>兼容关系（同一行）</th><th>加锁场景</th><th>解锁时机</th></tr></thead><tbody><tr><td><strong>共享锁（S锁）</strong></td><td>允许读，禁止写</td><td>S-S兼容，S-X互斥</td><td><code>SELECT ... FOR SHARE</code></td><td>事务提交/回滚</td></tr><tr><td><strong>排他锁（X锁）</strong></td><td>禁止读写</td><td>X-X互斥，X-S互斥</td><td><code>SELECT ... FOR UPDATE</code> <code>UPDATE</code>/<code>DELETE</code></td><td>事务提交/回滚</td></tr></tbody></table>
<h5 data-id="heading-19">兼容性矩阵（同一行）</h5>























<table><thead><tr><th>请求锁 ↓ \ 当前锁 →</th><th>无锁</th><th>S锁</th><th>X锁</th></tr></thead><tbody><tr><td><strong>请求S锁</strong></td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>请求X锁</strong></td><td>✅</td><td>❌</td><td>❌</td></tr></tbody></table>
<h4 data-id="heading-20">MySQL 中行锁的使用</h4>
<h5 data-id="heading-21">1. SELECT ... FOR SHARE（共享锁 / S 锁）</h5>
<p><strong>核心说明</strong>：加行级共享锁（S 锁），多个事务可同时对该行加共享锁，但无法加排他锁；适用于只读但需防止数据被修改的场景，MySQL 8.0 前可写为 <code>SELECT ... LOCK IN SHARE MODE</code>（等价）。<strong>兼容 / 阻塞场景</strong>：</p>
<ul>
<li>✅ 允许：其他事务执行 <code>SELECT ... FOR SHARE</code> 锁定该行</li>
<li>✅ 允许：普通 SELECT（不加锁查询）</li>
<li>❌ 阻塞：其他事务执行 <code>SELECT ... FOR UPDATE</code> 锁定该行</li>
<li>❌ 阻塞：其他事务执行 UPDATE 操作修改该行</li>
<li>❌ 阻塞：其他事务执行 DELETE 操作删除该行</li>
</ul>
<h5 data-id="heading-22">2. SELECT ... FOR UPDATE（排他锁 / X 锁）</h5>
<p><strong>核心说明</strong>：加行级排他锁（X 锁），锁定后其他事务无法对该行加任何锁（共享锁 / 排他锁），仅能执行不加锁的普通查询；锁的释放时机为事务提交或回滚。<strong>兼容 / 阻塞场景</strong>：</p>
<ul>
<li>✅ 允许：普通 SELECT（不加锁查询）</li>
<li>❌ 阻塞：其他事务执行 <code>SELECT ... FOR SHARE</code> 锁定该行</li>
<li>❌ 阻塞：其他事务执行 <code>SELECT ... FOR UPDATE</code> 锁定该行</li>
<li>❌ 阻塞：其他事务执行 UPDATE 操作修改该行</li>
<li>❌ 阻塞：其他事务执行 DELETE 操作删除该行</li>
</ul>
<h5 data-id="heading-23">3. UPDATE/DELETE 语句（自动加排他锁 / X 锁）</h5>
<p><strong>核心说明</strong>：执行 UPDATE/DELETE 时，InnoDB 会自动为 WHERE 条件命中的行加排他锁（X 锁），锁释放时机为事务提交或回滚；依赖索引实现行锁，无索引则升级为表锁。兼容 / 阻塞场景：同上X锁</p>
<h5 data-id="heading-24">4. INSERT 语句（隐式排他锁 + <strong>间隙锁 / 临键锁</strong>）</h5>
<p><strong>核心说明</strong>：INSERT 会为插入的行自动加排他锁（X 锁）；兼容 / 阻塞场景：同上X锁；与其他不同的是：<strong>若插入列有唯一约束 / 主键，其他事务插入相同值会被阻塞；若无唯一约束，会触发间隙锁 / 临键锁（防止幻读）</strong>。</p>
<h4 data-id="heading-25">补充关键注意事项</h4>
<ol>
<li>
<p><strong>锁生效前提</strong>：仅 InnoDB 引擎下生效，事务需显式开启（关闭自动提交或用 BEGIN/START TRANSACTION）；</p>
</li>
<li>
<p><strong>索引影响</strong>：WHERE 条件未命中索引时，行锁升级为表锁；</p>
</li>
<li>
<p><strong>锁释放时机</strong>：行锁仅在事务 COMMIT/ROLLBACK 时释放，长时间未提交易导致锁等待 / 死锁；</p>
</li>
<li>
<p><strong>死锁处理</strong>：<strong>InnoDB 自动检测死锁并回滚其中一个事务</strong>，可通过 <code>SHOW ENGINE INNODB STATUS</code> 查看死锁日志。</p>
</li>
</ol>
<h4 data-id="heading-26">2. 记录锁、间隙锁、临键锁</h4>
<blockquote>
<p>在InnoDB中默认加行锁就是加临键锁</p>
</blockquote>
<h5 data-id="heading-27">(1) 记录锁（Record Lock）</h5>
<ul>
<li>
<p><strong>锁定单行记录</strong>（基于<strong>主键/唯一</strong>索引）</p>
<ul>
<li>记录锁是上述行锁的一种具体实现</li>
</ul>
</li>
<li>
<p><strong>作用</strong>：<strong>防止并发修改同一行</strong></p>
</li>
<li>
<p><strong>示例</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- id=1的记录被锁定</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<h5 data-id="heading-28">(2) 间隙锁（Gap Lock）</h5>
<ul>
<li>
<p><strong>锁定索引记录之间的间隙</strong>（<strong>不包含记录本身</strong>）</p>
<ul>
<li>即左开右开</li>
</ul>
</li>
<li>
<p><strong>核心作用</strong>：<strong>防止幻读（在RR隔离级别下）</strong></p>
</li>
<li>
<p><strong>触发条件</strong>：RR隔离级别 + 范围查询/非唯一索引等值查询</p>
</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例数据：id=10, 20, 30</span>
<span class="hljs-comment">-- 锁定间隙：(10, 20), (20, 30), (30, +∞)</span>
<span class="hljs-comment">-- 事务1：</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">15</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 阻止其他事务插入 id=16, 25, 35 等记录</span>

<span class="hljs-comment">-- 事务2（被阻塞）：</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id, name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">25</span>, <span class="hljs-string">'张三'</span>);
</code></pre>
<p><strong>间隙锁特性</strong>：</p>
<ol>
<li>
<p><strong>仅RR级别生效</strong>：RC级别无间隙锁</p>
</li>
<li>
<p><strong>索引相关</strong>：基于索引的键值间隙</p>
</li>
<li>
<p><strong>多区间锁定</strong>：可能锁定多个间隙</p>
</li>
<li>
<p><strong>兼容性规则</strong>：间隙锁之间<strong>兼容</strong>（两个事务可以锁定相同间隙）</p>
</li>
</ol>
<h6 data-id="heading-29">间隙锁的边界问题</h6>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例表：id (10, 20, 30)</span>
<span class="hljs-comment">-- 最小边界：(-∞, 第一行]</span>
<span class="hljs-comment">-- 最大边界：[最后一行, +∞)</span>
<span class="hljs-comment">-- 中间间隙：(前一行, 后一行)</span>

<span class="hljs-comment">-- 事务1：查询不存在的记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">15</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 锁定间隙：(10, 20)  -- 注意：不包含10和20</span>

<span class="hljs-comment">-- 事务2：插入边界值测试</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">9</span>);   <span class="hljs-comment">-- ✅ 允许（不在锁定间隙）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">10</span>);  <span class="hljs-comment">-- ✅ 允许（记录已存在，记录锁不冲突）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">11</span>);  <span class="hljs-comment">-- ❌ 阻塞（在锁定间隙内）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">20</span>);  <span class="hljs-comment">-- ✅ 允许（记录已存在）</span>
</code></pre>
<h5 data-id="heading-30">(3) 临键锁（Next-Key Lock）</h5>
<ul>
<li>
<p><strong>记录锁 + 间隙锁</strong>（InnoDB默认行锁策略）</p>
</li>
<li>
<p><strong>公式</strong>：临键锁 = 记录锁 + 前一个间隙锁</p>
<ul>
<li>
<p>锁定范围：当前记录 + 前一个间隙</p>
</li>
<li>
<p>即左开右闭</p>
</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例数据：id=10, 20, 30</span>

<span class="hljs-comment">-- 事务1：</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">20</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 临键锁范围：(10, 20]</span>
<span class="hljs-comment">-- 包含：记录20（记录锁） + 间隙(10, 20)（间隙锁）</span>

<span class="hljs-comment">-- 以下操作此时会被阻塞</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">15</span>);  <span class="hljs-comment">-- 插入间隙</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> name<span class="hljs-operator">=</span><span class="hljs-string">'test'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;  <span class="hljs-comment">-- 修改记录</span>
</code></pre>
<h6 data-id="heading-31">临键锁的特殊情况</h6>
<p><strong>在InnoDB中默认加行锁就是加临键锁，以下时特殊情况</strong></p>
<h6 data-id="heading-32">场景1：唯一索引等值查询</h6>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- id是主键（唯一索引）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">20</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 仅加记录锁，不加间隙锁（因为唯一性保证）</span>
</code></pre>
<h6 data-id="heading-33">场景2：非唯一索引等值查询</h6>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- name有非唯一索引，数据：('A', 'A', 'B', 'B', 'C')</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'B'</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 锁定：</span>
<span class="hljs-comment">-- 1. 所有name='B'的记录锁</span>
<span class="hljs-comment">-- 2. 间隙锁：(第一个'B', 最后一个'B')</span>
<span class="hljs-comment">-- 3. 可能的前后间隙</span>
</code></pre>
<h6 data-id="heading-34">场景3：范围查询的锁升级</h6>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 事务1：</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;=</span> <span class="hljs-number">15</span> <span class="hljs-keyword">AND</span> id <span class="hljs-operator">&lt;=</span> <span class="hljs-number">25</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 可能锁定：</span>
<span class="hljs-comment">-- 1. 所有15-25之间的记录锁</span>
<span class="hljs-comment">-- 2. 间隙：(上一个记录, 15], (15, 25], (25, 下一个记录]</span>
<span class="hljs-comment">-- 实际范围可能大于WHERE条件！</span>
</code></pre>
<h4 data-id="heading-35">3. 行锁与隔离级别的关系</h4>








































<table><thead><tr><th>隔离级别</th><th>记录锁</th><th>间隙锁</th><th>临键锁</th><th>幻读防护</th></tr></thead><tbody><tr><td><strong>READ UNCOMMITTED</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td></tr><tr><td><strong>READ COMMITTED</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td></tr><tr><td><strong>REPEATABLE READ</strong></td><td>✅</td><td>✅</td><td>✅（默认）</td><td>✅</td></tr><tr><td><strong>SERIALIZABLE</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table>
<h3 data-id="heading-36">四、乐观锁与悲观锁</h3>
<p>这是<strong>锁的设计思想</strong>，并非 MySQL 内置的具体锁类型，而是业务 / 代码层面的实现方式。</p>
<h4 data-id="heading-37">1. 悲观锁（Pessimistic Lock）</h4>
<ul>
<li>
<p><strong>核心思想</strong>：假设并发冲突一定会发生，<strong>先加锁再操作</strong></p>
</li>
<li>
<p><strong>实现方式</strong>：利用 MySQL 内置锁（如行锁<code>SELECT ... FOR UPDATE</code>、表锁）</p>
</li>
<li>
<p><strong>适用场景</strong>：并发冲突概率高、写操作多的场景</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用行锁实现悲观锁</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>; <span class="hljs-comment">-- 加排他锁</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-number">-100</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
</li>
</ul>
<h4 data-id="heading-38">2. 乐观锁（Optimistic Lock）</h4>
<ul>
<li>
<p><strong>核心思想</strong>：假设并发冲突不会发生，<strong>先操作后校验</strong></p>
</li>
<li>
<p><strong>实现方式</strong>：通过版本号（<code>version</code>）或时间戳（<code>update_time</code>）实现</p>
</li>
<li>
<p><strong>适用场景</strong>：并发冲突概率低、读操作多的场景</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 查询数据时获取版本号</span>
<span class="hljs-keyword">SELECT</span> balance, version <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;
<span class="hljs-comment">-- 2. 更新时校验版本号</span>
<span class="hljs-keyword">UPDATE</span> users 
<span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-number">-100</span>, version<span class="hljs-operator">=</span>version<span class="hljs-operator">+</span><span class="hljs-number">1</span> 
<span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> version<span class="hljs-operator">=</span>原版本号;
<span class="hljs-comment">-- 3. 判断影响行数：若为0则说明版本冲突，需重试</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-39">五、锁机制实战要点</h3>
<h4 data-id="heading-40">1. 索引与锁的关系</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 情况1：使用主键索引（记录锁）</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> age<span class="hljs-operator">=</span><span class="hljs-number">25</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">100</span>;  <span class="hljs-comment">-- 仅锁定id=100的行</span>

<span class="hljs-comment">-- 情况2：使用普通索引</span>
<span class="hljs-comment">-- 假设name有普通索引</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> age<span class="hljs-operator">=</span><span class="hljs-number">25</span> <span class="hljs-keyword">WHERE</span> name<span class="hljs-operator">=</span><span class="hljs-string">'张三'</span>;
<span class="hljs-comment">-- 锁定：1.name='张三'的记录锁 2.相关间隙锁</span>

<span class="hljs-comment">-- 情况3：无索引（表锁！）</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> age<span class="hljs-operator">=</span><span class="hljs-number">25</span> <span class="hljs-keyword">WHERE</span> age<span class="hljs-operator">=</span><span class="hljs-number">30</span>;  <span class="hljs-comment">-- 如果age无索引→表锁</span>
</code></pre>
<h4 data-id="heading-41">2. 死锁分析与规避</h4>
<h5 data-id="heading-42">死锁场景示例：</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 事务1</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-number">-100</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;  <span class="hljs-comment">-- 锁定id=1</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-operator">+</span><span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">2</span>;  <span class="hljs-comment">-- 尝试锁定id=2</span>

<span class="hljs-comment">-- 事务2（并发执行）</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-number">-200</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">2</span>;  <span class="hljs-comment">-- 锁定id=2</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance<span class="hljs-operator">=</span>balance<span class="hljs-operator">+</span><span class="hljs-number">200</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;  <span class="hljs-comment">-- 尝试锁定id=1（死锁！）</span>
</code></pre>
<h5 data-id="heading-43">死锁规避策略：</h5>
<ol>
<li><strong>统一加锁顺序</strong>：约定所有事务按相同顺序加锁</li>
<li><strong>减少事务粒度</strong>：拆分大事务，及时提交</li>
<li><strong>使用索引</strong>：避免无索引查询导致表锁</li>
<li><strong>设置超时</strong>：<code>SET innodb_lock_wait_timeout = 30;</code></li>
<li><strong>死锁检测</strong>：<code>SHOW ENGINE INNODB STATUS\G</code> 查看死锁信息</li>
</ol>
<h4 data-id="heading-44">3. 锁优化建议</h4>
<ol>
<li>
<p><strong>索引设计</strong>：为WHERE条件、JOIN条件创建合适索引</p>
</li>
<li>
<p><strong>事务设计</strong>：</p>
<ul>
<li>保持事务短小</li>
<li>避免长事务中的锁持有</li>
<li>批量操作使用LIMIT分批次</li>
</ul>
</li>
<li>
<p><strong>SQL优化</strong>：</p>
<ul>
<li>避免<code>SELECT *</code>，只取需要字段</li>
<li>使用覆盖索引减少回表</li>
<li>避免大范围UPDATE/DELETE</li>
</ul>
</li>
<li>
<p><strong>隔离级别选择</strong>：</p>
<ul>
<li>默认使用RR级别（防幻读）</li>
<li>高并发场景可考虑RC级别（减少间隙锁）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-45">六、锁监控与排查命令</h3>
<h4 data-id="heading-46">1. 锁状态查看</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看表锁使用情况</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">OPEN</span> TABLES <span class="hljs-keyword">WHERE</span> In_use <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>;

<span class="hljs-comment">-- 查看当前锁等待</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_LOCKS;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_LOCK_WAITS;

<span class="hljs-comment">-- 查看事务详情</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_TRX;

<span class="hljs-comment">-- 查看MDL锁（MySQL 5.7+）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> performance_schema.metadata_locks;
</code></pre>
<h4 data-id="heading-47">2. InnoDB引擎状态</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看详细锁信息（包含最近死锁）</span>
<span class="hljs-keyword">SHOW</span> ENGINE INNODB STATUS\G

<span class="hljs-comment">-- 重点关注：</span>
<span class="hljs-comment">-- 1. LATEST DETECTED DEADLOCK（最近死锁）</span>
<span class="hljs-comment">-- 2. TRANSACTIONS（当前事务）</span>
<span class="hljs-comment">-- 3. ROW OPERATIONS（行操作）</span>
</code></pre>
<h4 data-id="heading-48">3. 性能监控</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 锁等待超时设置</span>
<span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'innodb_lock_wait_timeout'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> innodb_lock_wait_timeout <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;

<span class="hljs-comment">-- 死锁检测</span>
<span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'innodb_deadlock_detect'</span>;
<span class="hljs-comment">-- ON：自动检测死锁（默认）</span>
<span class="hljs-comment">-- OFF：关闭检测，依赖超时机制</span>

<span class="hljs-comment">-- 查看锁统计</span>
<span class="hljs-keyword">SHOW</span> STATUS <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'Innodb_row_lock%'</span>;
<span class="hljs-comment">-- Innodb_row_lock_current_waits：当前等待行锁数量</span>
<span class="hljs-comment">-- Innodb_row_lock_time：行锁总等待时间</span>
<span class="hljs-comment">-- Innodb_row_lock_time_avg：平均等待时间</span>
<span class="hljs-comment">-- Innodb_row_lock_time_max：最长等待时间</span>
<span class="hljs-comment">-- Innodb_row_lock_waits：行锁等待总次数</span>
</code></pre>
<h3 data-id="heading-49">七、补充</h3>
<h4 data-id="heading-50">实战建议</h4>
<ol>
<li>
<p><strong>明确索引设计</strong>：了解每个查询使用的索引类型</p>
</li>
<li>
<p><strong>监控锁等待</strong>：定期检查锁等待情况</p>
</li>
<li>
<p><strong>测试锁行为</strong>：在测试环境验证锁范围</p>
</li>
<li>
<p><strong>使用EXPLAIN</strong>：分析查询执行计划，预测锁行为</p>
</li>
<li>
<p><strong>考虑业务场景</strong>：权衡一致性与并发性的需求</p>
</li>
</ol>
<hr/>
<h4 data-id="heading-51"><strong>总结要点</strong></h4>
<ul>
<li>
<p>全局锁用于全库备份，慎用</p>
</li>
<li>
<p>表级锁中，MDL锁是常见阻塞原因</p>
</li>
<li>
<p>行级锁是InnoDB核心，理解记录锁、间隙锁、临键锁的区别</p>
</li>
<li>
<p>RR级别默认使用临键锁防幻读，RC级别无间隙锁</p>
</li>
<li>
<p>死锁可以通过统一加锁顺序、短事务、合适索引来规避</p>
</li>
<li>
<p>监控工具是排查锁问题的关键</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通俗易懂地谈谈，前端工程化之自定义脚手架的理解，并附上一个实践案例发布到npm上]]></title>    <link>https://juejin.cn/post/7583168260797399080</link>    <guid>https://juejin.cn/post/7583168260797399080</guid>    <pubDate>2025-12-14T10:48:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583168260797399080" data-draft-id="7582922476223250447" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通俗易懂地谈谈，前端工程化之自定义脚手架的理解，并附上一个实践案例发布到npm上"/> <meta itemprop="keywords" content="NPM,Node.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-14T10:48:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="水冗水孚"/> <meta itemprop="url" content="https://juejin.cn/user/1406974769508679"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通俗易懂地谈谈，前端工程化之自定义脚手架的理解，并附上一个实践案例发布到npm上
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1406974769508679/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    水冗水孚
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T10:48:24.000Z" title="Sun Dec 14 2025 10:48:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<ul>
<li>如果要开发一个新项目，传统方式要敲不少命令</li>
<li>如下：使用最新版的vite，创建一个项目，选择对应的框架语言等</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7341b5a436d6484a86304d66f7ec6339~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=YI0x%2FdjYTGPUC4XTf%2BWIJtkFSTo%3D" alt="1.png" loading="lazy"/></p>
<p>然后就是安装各种依赖，安装antd、安装路由、安装zustand等，如<code>npm install axios react-router-dom antd ......</code></p>
<ul>
<li>
<p>若每次新开一个常规项目，都执行这样的搭建操作，整体来说，效率略低，不优雅——（毕竟是手动配置）</p>
</li>
<li>
<p>于是，在此基础上，社区有作者提供了进一步的<strong>现成模板</strong>，比如针对于后台管理系统这类业务场景，有React-Admin、Ant-Design-Pro、或者ruoyi这样后台模板框架，开发者根据自己情况适当修改增删功能——（需根据自己公司业务适配修改）</p>
</li>
</ul>
<p>如此这般，后续若再新开常规项目（假设需要新开发一个<strong>茶叶管理系统</strong>），直接复制一份先前已经沉淀好了的框架模板（假设原先沉淀好的就叫做<strong>基础管理系统</strong>）修修改改，在先前的基础上三次开发即可</p>
<h2 data-id="heading-1">自定义脚手架简述</h2>
<h3 data-id="heading-2">新项目手动复制粘贴的痛点</h3>
<p>但是，这里有一个麻烦的地方：</p>
<ul>
<li>首先，我们需要新建一个文件夹，然后把原本沉淀好的一套代码复制过来（假设叫做base-admin）</li>
<li>然后，执行npm i安装依赖</li>
<li>紧接着需要手动修改package.json里面的name的值为新项目名、也要修改index.html文件里面的title标签里面的名字等（当然还可能有其他要修改的），如下：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"base-admin"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 修改成："name": "tea-admin",</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.1.1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>基础管理系统<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 修改成：茶叶管理系统 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.jsx"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ul>
<li>
<p>所以，我们思考，能不能写一个脚本，通过命令行交互的方式，交互执行一下</p>
</li>
<li>
<p>就自动能够把原本沉淀好的那套base-admin代码拷贝过来</p>
<ul>
<li>并且也能自动够修改package.json里面的name的值为新项目名</li>
<li>也能自动修改index.html文件里面的title标签里面的名字</li>
<li>包括自动执行npm i下载依赖</li>
<li>等其他个性化操作</li>
</ul>
</li>
</ul>
<p><strong>简约来说，这件事，就是自定义脚手架，所做的事情</strong></p>
<h3 data-id="heading-3">自定义脚手架——可定制内容</h3>
<ul>
<li>实际上，自定义脚手架，不仅仅只是做 复制 base-admin 代码→改 name→改 title这样的 基础功能</li>
<li>还可以进阶操作，比如base-admin有8个模块、但是tea-admin只需要3个模块，我们也可以通过命令行，使用自定义脚手架创建项目的时候，选择保留那些模块，或者丢弃那些模块</li>
<li>甚至，自定义脚手架，还可以帮我执行git仓库初始化命令等</li>
</ul>
<p>所以，自定义脚手架的收益就是：</p>
<p><strong>减轻项目初始化的工作量、做到开发的规范和统一，当然也可以灵活的定制一些内容</strong></p>
<h3 data-id="heading-4">自定义脚手架的大致步骤</h3>
<ol>
<li>
<p>把以往的沉淀好的base-admin发布到github/gitlab上（这是前提，要有基础项目框架模板代码，便于后续开发项目的复用）</p>
</li>
<li>
<p>编辑自己的自定义脚手架（就是一个npm项目，带有package.json和一堆js脚本文件）</p>
</li>
<li>
<p>把写好的自定义脚手架（假设叫做self-cli）发布到npm上（或者使用Verdaccio搭建自己的私服npm），然后所有同事可在自己电脑上全局安装npm i self-cli -g</p>
<ol>
<li>使用Verdaccio搭建自己的私服npm，可以参考笔者的这篇文章：《<a href="https://juejin.cn/post/7582844980399521832" target="_blank" title="https://juejin.cn/post/7582844980399521832">20张图的保姆级教程，记录使用Verdaccio在Ubuntu服务器上搭建Npm私服</a>》</li>
</ol>
</li>
<li>
<p>然后，就可以在命令行执行自定义脚手架提供的命令，比如self-cli -V（查看自定义版本号）、或self-cli create tea-admin（使用自定义脚手架self-cli创建新项目tea-admin）</p>
</li>
<li>
<p>这样的话，就会自动拉取git仓库上的base-admin代码</p>
</li>
<li>
<p>紧接着，命令行会提供一些问询交互，以便于创建新项目的时候，可以自定义一些东西（相当于执行npm create vite@latest xxx的效果）</p>
</li>
<li>
<p>最后命令行回车，自动帮我们执行修改base-admin的一些基础信息和其他自定义操作，最后自动执行npm i安装依赖，并跑起来项目</p>
</li>
</ol>
<h2 data-id="heading-5">自定义脚手架常用的包</h2>
<h3 data-id="heading-6">常用包</h3>
<p><strong>强大命令包shelljs可以便捷地运行命令：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fshelljs" target="_blank" title="https://www.npmjs.com/package/shelljs" ref="nofollow noopener noreferrer">www.npmjs.com/package/she…</a></strong></p>
<p>基本的包</p>
<ul>
<li>自定义脚手架要允许在命令行执行命令，可使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fcommander" target="_blank" title="https://www.npmjs.com/package/commander" ref="nofollow noopener noreferrer">commander</a></li>
<li>执行完命令以后，要允许用户输入选择等交互操作，可使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Finquirer" target="_blank" title="https://www.npmjs.com/package/inquirer" ref="nofollow noopener noreferrer">inquirer</a></li>
<li>要能够拉取git仓库代码，可使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fdownload-git-repo" target="_blank" title="https://www.npmjs.com/package/download-git-repo" ref="nofollow noopener noreferrer">download-git-repo</a></li>
<li>在拉取代码的过程中，需要有加载loading效果，可使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fora" target="_blank" title="https://www.npmjs.com/package/ora" ref="nofollow noopener noreferrer">ora</a></li>
<li>在拉取代码的过程中，需要有进度条百分比加载的效果，可使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fprogress" target="_blank" title="https://www.npmjs.com/package/progress" ref="nofollow noopener noreferrer">progress</a></li>
</ul>
<p>如果美化一下命令行，可使用如下包</p>
<ul>
<li>如果想让终端的输出文字五颜六色，可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fchalk" target="_blank" title="https://www.npmjs.com/package/chalk" ref="nofollow noopener noreferrer">chalk</a></li>
<li>如果想让终端输出的文字有字符画效果，可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Ffiglet" target="_blank" title="https://www.npmjs.com/package/figlet" ref="nofollow noopener noreferrer">figlet</a></li>
<li>如果想让终端输出的文字呈现表格形式，可以使用  <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Ftable" target="_blank" title="https://www.npmjs.com/package/table" ref="nofollow noopener noreferrer">table</a></li>
<li>如果想让终端输出带有emoji，可以使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fnode-emoji" target="_blank" title="https://www.npmjs.com/package/node-emoji" ref="nofollow noopener noreferrer">node-emoji</a></li>
</ul>
<h3 data-id="heading-7">常用包做的有意思的效果</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7262aa9c06984823b2cb433aa288655f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=v0K%2BIxHu6dvn32UKt4pY2ONNeGU%3D" alt="2.gif" loading="lazy"/></p>
<p>上述效果对应package.json包如下</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"some-npm-pkg"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node index.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chalk"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.6.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"commander"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^14.0.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"figlet"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.9.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inquirer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^12.11.1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"node-emoji"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.2.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ora"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"progress"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"table"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.9.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-8">其他的包</h3>
<ul>
<li><strong>fs-extra</strong>，增强版的fs文件操作，更好用</li>
<li><strong>ejs</strong>模板引擎，可用来替换模板中的变量</li>
<li><strong>semver</strong>，语义化版本号解析 / 对比（判断版本高低、是否符合规则）</li>
<li><strong>which</strong>，查找系统中可执行文件的路径（如找到 node/npm 等命令的安装位置）</li>
<li><strong>chokidar</strong>，高性能文件监听（监控文件 / 目录变化，如文件修改后自动触发操作）——nodemon核心依赖</li>
<li><strong>portfinder</strong>，自动查找可用端口（避免端口占用，如本地服务自动选端口）</li>
<li><strong>opener</strong>，跨平台打开文件 / 浏览器（如自动打开本地服务页面）</li>
<li><strong>mime</strong>，MIME 类型解析（判断文件 / 请求的内容类型，如 json、html、jpg 等）</li>
<li><strong>giturl</strong>，解析 / 转换 Git 仓库 URL（如把 HTTPS 转 SSH，或提取仓库信息）</li>
<li><strong>npm-request</strong>，简化 HTTP 请求的工具（聚焦 npm 相关接口请求，如查询包、下载包）</li>
<li><strong>clipanion</strong>，Node.js 命令行参数解析（更优雅的 CLI 构建）——对标Conmand</li>
<li><strong>diff</strong>，文本差异对比（测试时验证输出 / 文件变化）</li>
<li><strong>is-windows</strong>，判断是否 Windows 系统</li>
</ul>
<h2 data-id="heading-9">自己写一个简单的<code>self-cli</code></h2>
<h3 data-id="heading-10">首先要有一个基础模板项目 base-admin</h3>
<ul>
<li>笔者已经上传到github上了，地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshuirongshuifu%2Fbase-admin" target="_blank" title="https://github.com/shuirongshuifu/base-admin" ref="nofollow noopener noreferrer">github.com/shuirongshu…</a></li>
<li>base-admin是一个演示的项目，没有太多东西，实际开发中，这里基础模板会有很多东西，比如eslint、prettier等</li>
<li>同时，也可能会有多个模板，比如react技术栈基础模板、vue技术栈基础模板、后台基础模板、前台基础模板等</li>
</ul>
<p>如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8589de30cba4e70804c8cf416573979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=DuRe3Bbrsi2U2%2BUqUbc6KxP6jK8%3D" alt="3.png" loading="lazy"/></p>
<p>需求：</p>
<ul>
<li>当新项目开启的时候，我们使用自定义脚手架在命令行执行self-ci create，</li>
<li>会从git仓库拉取这个base-admin</li>
<li>然后，在命令行中我们可以输入新项目名</li>
<li>输入的新项目名，会自动替换模板引擎和修改package.json文件里面的name</li>
<li>同时，也会自动帮我们执行npm install命令</li>
<li>最后，可以让我们选择，是否启动这个项目(是否npm run dev)</li>
</ul>
<p>就是把原先需要手动复制粘贴项目，修改项目里面的内容的步骤，换成了命令行脚本自动化执行了...</p>
<h3 data-id="heading-11">自定义脚手架完成效果图</h3>
<p>我们先看一下，完成后的效果图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2195afc85e1842b6a2528f43f3761454~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=IG9GC7ip3CVHlIcUB0mQu9vgp0o%3D" alt="4.gif" loading="lazy"/></p>
<p>对应拉取的创建并修改的新项目</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1324b7a7cf9a4da3b8fb7f97c8408662~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=bktkw4SMuvgj4rKk8MpZzuq988c%3D" alt="5.png" loading="lazy"/></p>
<ul>
<li>在动态图中，我们可以看到，左上角拉取了项目，名字叫做 pro-new ，这个明显也就是我们输入的新项目的名字</li>
<li>这个是简单案例，实际项目中，控制台的交互会多一些</li>
</ul>
<p>接下来，我们来快速过一下这个脚手架做了那些事情</p>
<h3 data-id="heading-12">commander包定制命令行输入命令</h3>
<p>index.js</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-keyword">import</span> { program } <span class="hljs-keyword">from</span> <span class="hljs-string">'commander'</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs-extra'</span>;
<span class="hljs-keyword">import</span> app <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.js'</span>;

<span class="hljs-keyword">const</span> pkg = fs.<span class="hljs-title function_">readJsonSync</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./package.json'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>));

program
  .<span class="hljs-title function_">version</span>(pkg.<span class="hljs-property">version</span>, <span class="hljs-string">'-v, --version'</span>)
  .<span class="hljs-title function_">name</span>(<span class="hljs-string">'self-cli'</span>)
  .<span class="hljs-title function_">description</span>(<span class="hljs-string">'自定义脚手架工具'</span>);

program
  .<span class="hljs-title function_">command</span>(<span class="hljs-string">'create [app-name]'</span>)
  .<span class="hljs-title function_">description</span>(<span class="hljs-string">'创建一个新的项目'</span>)
  .<span class="hljs-title function_">action</span>(app);

program.<span class="hljs-title function_">parse</span>(process.<span class="hljs-property">argv</span>);
</code></pre>
<h3 data-id="heading-13">shelljs包去判断是否安装了git、执行git clone命令等</h3>
<p>**shelljs 很强大，强的可怕 **</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> shell <span class="hljs-keyword">from</span> <span class="hljs-string">'shelljs'</span>;

<span class="hljs-comment">// 检查 git</span>
<span class="hljs-keyword">if</span> (!shell.<span class="hljs-title function_">which</span>(<span class="hljs-string">'git'</span>)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">'❌ 请先安装 git'</span>));
    shell.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-comment">// 拉取 Git 仓库 - 使用 git clone</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TEMPLATE_REPO</span> = <span class="hljs-string">'shuirongshuifu/base-admin'</span>;
<span class="hljs-keyword">const</span> spinner = <span class="hljs-title function_">ora</span>(<span class="hljs-string">'正在拉取项目...'</span>).<span class="hljs-title function_">start</span>();

<span class="hljs-comment">// 使用 SSH URL</span>
<span class="hljs-keyword">const</span> repoUrl = <span class="hljs-string">`git@github.com:<span class="hljs-subst">${TEMPLATE_REPO}</span>.git`</span>;
<span class="hljs-keyword">const</span> cloneResult = shell.<span class="hljs-title function_">exec</span>(<span class="hljs-string">`git clone <span class="hljs-subst">${repoUrl}</span> <span class="hljs-subst">${projectName}</span>`</span>, { <span class="hljs-attr">silent</span>: <span class="hljs-literal">false</span> });

<span class="hljs-keyword">if</span> (cloneResult.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {
    spinner.<span class="hljs-title function_">fail</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">'拉取失败'</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">'错误信息：'</span> + cloneResult.<span class="hljs-property">stderr</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">yellow</span>(<span class="hljs-string">'\n提示：请确保已配置 SSH key，或检查网络连接'</span>));
    shell.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
}

进入对应目录，并安装项目依赖
<span class="hljs-comment">// 安装依赖</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">cyan</span>(<span class="hljs-string">'正在安装依赖...'</span>));
<span class="hljs-keyword">const</span> installResult = shell.<span class="hljs-title function_">exec</span>(<span class="hljs-string">`cd <span class="hljs-subst">${projectName}</span> &amp;&amp; npm install`</span>);
<span class="hljs-keyword">if</span> (installResult.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">'❌ 依赖安装失败'</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">red</span>(<span class="hljs-string">'错误信息：'</span> + installResult.<span class="hljs-property">stderr</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">yellow</span>(<span class="hljs-string">'请手动进入项目目录执行：npm install'</span>));
    shell.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">green</span>(<span class="hljs-string">'✅ 项目创建完成！'</span>));
</code></pre>
<h3 data-id="heading-14">ejs包处理模板文件</h3>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">// 处理 ejs 模板文件</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">cyan</span>(<span class="hljs-string">'正在处理模板文件...'</span>));
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">processEjsFiles</span> = (<span class="hljs-params">dir</span>) =&gt; {
    <span class="hljs-keyword">const</span> files = fs.<span class="hljs-title function_">readdirSync</span>(dir);
    files.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(dir, file);
      <span class="hljs-keyword">const</span> stat = fs.<span class="hljs-title function_">statSync</span>(filePath);

      <span class="hljs-keyword">if</span> (stat.<span class="hljs-title function_">isDirectory</span>() &amp;&amp; file !== <span class="hljs-string">'node_modules'</span> &amp;&amp; file !== <span class="hljs-string">'.git'</span>) {
        <span class="hljs-title function_">processEjsFiles</span>(filePath);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.ejs'</span>)) {
        <span class="hljs-keyword">const</span> template = fs.<span class="hljs-title function_">readFileSync</span>(filePath, <span class="hljs-string">'utf-8'</span>);
        <span class="hljs-keyword">const</span> rendered = ejs.<span class="hljs-title function_">render</span>(template, { projectName });
        <span class="hljs-keyword">const</span> destPath = filePath.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.ejs$/</span>, <span class="hljs-string">''</span>);
        fs.<span class="hljs-title function_">writeFileSync</span>(destPath, rendered, <span class="hljs-string">'utf-8'</span>);
        fs.<span class="hljs-title function_">unlinkSync</span>(filePath);
      }
    });
  };
  <span class="hljs-title function_">processEjsFiles</span>(projectPath);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">green</span>(<span class="hljs-string">'✅ 模板文件处理完成'</span>));
</code></pre>
<h3 data-id="heading-15">fs模块直接修改package.json文件</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 修改 package.json</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">cyan</span>(<span class="hljs-string">'正在修改 package.json...'</span>));
<span class="hljs-keyword">const</span> pkgPath = path.<span class="hljs-title function_">join</span>(projectPath, <span class="hljs-string">'package.json'</span>);
<span class="hljs-keyword">const</span> pkg = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readJson</span>(pkgPath);
pkg.<span class="hljs-property">name</span> = projectName;
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeJson</span>(pkgPath, pkg, { <span class="hljs-attr">spaces</span>: <span class="hljs-number">2</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chalk.<span class="hljs-title function_">green</span>(<span class="hljs-string">'✅ package.json 修改完成'</span>));
</code></pre>
<p>等，不赘述...</p>
<h2 data-id="heading-16">重点：self-cli为何能够被命令行识别？</h2>
<ul>
<li>上述案例的自定义脚手架，代码并不难，我们思考，为何在命令行执行self-cli命令能够被识别呢</li>
<li>毕竟self-cli并不是操作系统自带的命令</li>
</ul>
<h3 data-id="heading-17">命令行识别逻辑顺序</h3>
<ul>
<li>当我们在命令行中，输入xxx的时候，操作系统会进行如下的查询执行逻辑</li>
<li>比如，先看看这个xxx是不是自带的内部命令，如 ls dir cd 等（是自带的就按照自带的逻辑执行）</li>
<li>不是自带的，就会去环境变量Path里面遍历查找，比如执行了git -v</li>
<li>那么，发现，环境变量真有，找到对应的Path里面对应的路径的值对应的文件夹，再看看文件夹里面是否有对应的exe或cmd或bat，再交给其执行</li>
<li>
<blockquote>
<p>先遍历环境变量里面有那些文件夹，再到对应文件夹里面，再次遍历找对应可执行文件批处理命令（系统先按<code>Path</code>的目录顺序 “逛文件夹”，在每个文件夹里只看直接文件，找 “命令名 + 可执行后缀” 的文件，找到就用，找不到就换下一个文件夹，全逛完都没有就报错）</p>
</blockquote>
</li>
</ul>
<p>报错命令：</p>
<pre><code class="hljs language-bash" lang="bash">C:\Users\lss13&gt;hello
<span class="hljs-string">'hello'</span> 不是内部或外部命令，也不是可运行的程序
或批处理文件。

C:\Users\lss13&gt;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e272fcc287448a491a40dd03e8e96e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=9ytkxPT82vhtIittJE7%2FjIYgzKo%3D" alt="6.png" loading="lazy"/></p>
<p>对应路径的确有exe可执行文件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9648a3441cf8459abee5836d7994d5b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=wK%2FLbOoarWv1MzPk%2BUggPS4WjOA%3D" alt="7.png" loading="lazy"/></p>
<p>比如，查看java、python、git、node版本也是上述同样类似的道理</p>
<pre><code class="hljs language-bash" lang="bash">C:\Users\lss13&gt;java -version
java version <span class="hljs-string">"1.8.0_201"</span>
Java(TM) SE Runtime Environment (build 1.8.0_201-b09)
Java HotSpot(TM) 64-Bit Server VM (build 25.201-b09, mixed mode)

C:\Users\lss13&gt;python --version
Python 3.12.8

C:\Users\lss13&gt;git -v
git version 2.45.2.windows.1

C:\Users\lss13&gt;node -v
v22.12.0
</code></pre>
<p>self-cli识别命令，则是当找到node的环境变量path后，在对应文件夹找到了self-cli，如下图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7ddffb700634fed899cb32fba85b116~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=vwhlREzMsiCpReTulHecicT%2BHAM%3D" alt="8.png" loading="lazy"/></p>
<p>注意，这里有三个，分别是</p>
<pre><code class="hljs language-bash" lang="bash">self-cli       <span class="hljs-comment"># Linux/Mac风格脚本</span>
self-cli.cmd   <span class="hljs-comment"># Windows CMD批处理脚本（核心）</span>
self-cli.ps1   <span class="hljs-comment"># PowerShell脚本</span>
</code></pre>
<p>所以，就是如下图的箭头所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3c7a8f2a5042a49a273f8954299b75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=UaJk1nONY8ggFoMkrDqhFsAFesY%3D" alt="9.png" loading="lazy"/></p>
<ul>
<li>所以，这里的本质就是通过 npm link给某个包</li>
</ul>
<h3 data-id="heading-18">npm link介绍</h3>
<p>npm link是 npm 专为本地开发 npm 包（比如笔者的self-cli 脚手架）设计的调试工具，核心是通过<strong>软链接（类似 Windows 快捷方式）</strong>  关联本地代码和全局 npm 环境，避免反复安装的麻烦</p>
<ul>
<li>比如这个self-cli 这类自定义 CLI 工具，开发时需要频繁修改代码并测试命令效果，<code>npm link</code> 能让全局执行的 <code>self-cli</code> 命令直接指向本地开发目录的代码</li>
<li>改完代码无需重新全局安装，直接执行命令就能看到最新效果，大幅提升调试效率</li>
</ul>
<p>也就是说，npm link在node的环境变量文件夹里面创建了一个链接，让我们在命令行执行对应的命令的时候，系统能够识别，能够找到对应的脚本js文件，做对应的执行处理</p>
<p>在对应的自定义脚手架里面执行npm link会自动生成可执行文件和软连接，这样就能达到全局挂载可使用的效果了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eb10a8eae9c477395953d008c6c1fc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=H3EtZ7RuQFzLoGvL%2F9zdTeP41cw%3D" alt="10.gif" loading="lazy"/></p>
<p>不过，我们还需要在package.json文件里面，加上bin规则，告知self-cli要执行那个js文件，同时，对应js文件，要加格式固定：<code>#!/usr/bin/env node</code></p>
<p>即：</p>
<p>package.json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"self-cli"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.3"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"自定义脚手架工具"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"self-cli"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./index.js"</span>  <span class="hljs-comment">// 这个</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>index.js</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 这个</span>
#!<span class="hljs-regexp">/usr/</span>bin/env node 

<span class="hljs-keyword">import</span> { program } <span class="hljs-keyword">from</span> <span class="hljs-string">'commander'</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs-extra'</span>;
<span class="hljs-keyword">import</span> app <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.js'</span>;

......
</code></pre>
<h3 data-id="heading-19">npm link 与 npm install xyz -g的差异</h3>























<table><thead><tr><th>方式</th><th>本质</th><th>代码修改后效果</th><th>适用场景</th></tr></thead><tbody><tr><td>npm link</td><td>创建软链接（快捷方式）</td><td>实时生效，无需额外操作</td><td>本地开发、频繁改代码</td></tr><tr><td>npm install xyz -g</td><td>复制文件到全局目录</td><td>需重新安装才生效</td><td>开发完成后安装最终版本</td></tr></tbody></table>
<ul>
<li>当然，我们本地开发脚手架，使用npm link去全局链接上，方便调试</li>
<li>当这个脚手架self-cli开发完毕后，就可以发到npm上</li>
<li>或者发到公司里面自己搭建的私服npm</li>
<li>搭建私服npm可以参见笔者的这篇文章：<a href="https://juejin.cn/post/7582844980399521832" target="_blank" title="https://juejin.cn/post/7582844980399521832">20张图的保姆级教程，记录使用Verdaccio在Ubuntu服务器上搭建Npm私服</a></li>
<li>这样的话，团队成员就可以全局下载self-cli</li>
<li>就可以在命令行使用对应命令，拉取gitlab仓库代码，自定义创建新项目了</li>
</ul>
<h3 data-id="heading-20">一句话总结前端自定义脚手架</h3>
<p>前端自定义脚手架（比如self-cli）是基于nodejs语法的全局CLI工具，核心价值是基于模板一键生成标准化且可自定义配置的前端项目，从而达到提效的目的</p>
<blockquote>
<p>CLI = 命令行（Command Line）+ 界面（Interface），核心指的是：基于命令行操作的工具或交互方式</p>
</blockquote>
<p>笔者的这个演示脚手架，也发布到npm上面了，不过因为包名不能类似原因，笔者做了修改，现在叫做：<code>s-cli-srsf</code></p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fs-cli-srsf%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/s-cli-srsf?activeTab=readme" ref="nofollow noopener noreferrer">www.npmjs.com/package/s-c…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f035a041e8034c76a8df7df6594570f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=gD9wLYhmxFsXg62jByNzyCQV9XA%3D" alt="11.png" loading="lazy"/></p>
<p>大家可以尝试着</p>
<pre><code class="hljs language-js" lang="js">npm install -g s-cli-srsf
</code></pre>
<p>然后，就会发现，这次生成的就不是npm link那种链接了，是直接安装的文件夹内容</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b895c92da924999891434800233ca79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=6%2BdB%2F9oxK4ImDhIHk3GJ%2FSXGVPQ%3D" alt="12.png" width="70%" loading="lazy"/>
<p>全局安装以后，就可以愉快地创建项目了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92b09cecbe874ebcb3c2a222dfb1cc74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766314103&amp;x-signature=D%2B1PZIEvL3UR6IErwA2h1NbPrZk%3D" alt="13.png" loading="lazy"/></p>
<h3 data-id="heading-21">回顾package.json常用的配置键值对</h3>
<p>回顾一下知识点</p>



























































































































































<table><thead><tr><th>键名</th><th>类型</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>name</td><td>String</td><td>包的名称，必须唯一</td><td>"my-package"</td></tr><tr><td>version</td><td>String</td><td>版本号，遵循语义化版本控制</td><td>"1.0.0"</td></tr><tr><td>description</td><td>String</td><td>包的简短描述</td><td>"A sample package"</td></tr><tr><td>keywords</td><td>Array</td><td>关键词数组，用于搜索</td><td>["web", "framework"]</td></tr><tr><td>homepage</td><td>String</td><td>项目主页URL</td><td>"<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">example.com</a>"</td></tr><tr><td>bugs</td><td>Object</td><td>Bug报告地址</td><td>{"url": "<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">github.com/.../issues</a>"}</td></tr><tr><td>license</td><td>String</td><td>许可证类型</td><td>"MIT"</td></tr><tr><td>author</td><td>String/Object</td><td>作者信息</td><td>"Name <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">email@domain.com</a>"</td></tr><tr><td>contributors</td><td>Array</td><td>贡献者列表</td><td>[{"name": "John", "email": "..."}]</td></tr><tr><td>files</td><td>Array</td><td>发布时包含的文件</td><td>["dist/", "lib/"]</td></tr><tr><td>main</td><td>String</td><td>主入口文件</td><td>"index.js"</td></tr><tr><td>browser</td><td>String</td><td>浏览器端入口文件</td><td>"./browser.js"</td></tr><tr><td>bin</td><td>Object</td><td>命令行工具配置</td><td>{"cli": "./bin/cli.js"}</td></tr><tr><td>repository</td><td>Object</td><td>仓库信息</td><td>{"type": "git", "url": "..."}</td></tr><tr><td>scripts</td><td>Object</td><td>脚本命令集合</td><td>{"start": "node index.js"}</td></tr><tr><td>dependencies</td><td>Object</td><td>生产环境依赖</td><td>{"express": "^4.17.1"}</td></tr><tr><td>devDependencies</td><td>Object</td><td>开发环境依赖</td><td>{"jest": "^27.0.0"}</td></tr><tr><td>peerDependencies</td><td>Object</td><td>同级依赖</td><td>{"react": "^17.0.0"}</td></tr><tr><td>optionalDependencies</td><td>Object</td><td>可选依赖</td><td>{"fsevents": "^2.3.2"}</td></tr><tr><td>engines</td><td>Object</td><td>支持的引擎版本</td><td>{"node": "&gt;=14.0.0"}</td></tr><tr><td>os</td><td>Array</td><td>支持的操作系统</td><td>["darwin", "linux"]</td></tr><tr><td>cpu</td><td>Array</td><td>支持的CPU架构</td><td>["x64", "arm64"]</td></tr><tr><td>private</td><td>Boolean</td><td>是否私有包</td><td>true</td></tr><tr><td>workspaces</td><td>Array</td><td>工作区配置</td><td>["packages/*"]</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型的"幻觉"真相：为什么AI总爱一本正经地胡说八道]]></title>    <link>https://juejin.cn/post/7583499967237292066</link>    <guid>https://juejin.cn/post/7583499967237292066</guid>    <pubDate>2025-12-15T01:54:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583499967237292066" data-draft-id="7583469866008248355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型的&quot;幻觉&quot;真相：为什么AI总爱一本正经地胡说八道"/> <meta itemprop="keywords" content="AIGC,AI编程,人工智能"/> <meta itemprop="datePublished" content="2025-12-15T01:54:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yoo前端"/> <meta itemprop="url" content="https://juejin.cn/user/2791012486624116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型的"幻觉"真相：为什么AI总爱一本正经地胡说八道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2791012486624116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yoo前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T01:54:30.000Z" title="Mon Dec 15 2025 01:54:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大模型的"幻觉"真相：为什么AI总爱一本正经地胡说八道</h2>
<p>在人工智能的热潮中，大模型（LLM）被赋予了"无所不能"的光环。我们期待它能回答任何问题，但现实却常常让人失望——当它不知道答案时，它不会说"我不知道"，而是自信满满地编造一个看似合理却完全错误的信息。</p>
<p>这种现象在AI圈里有个专业名称：<strong>AI幻觉</strong>（Artificial Intelligence Hallucinations）。它不是AI在"说谎"，而是其工作方式的必然结果。今天，让我们深入探讨这个现象的根源，以及为什么大模型会如此"一本正经地胡说八道"。</p>
<h3 data-id="heading-1">一、什么是AI幻觉？不只是"说错话"</h3>
<p>AI幻觉指生成式模型在输出内容时，<strong>生成看似合理但不符合事实、逻辑或上下文语义的信息</strong>的现象。它表现为：</p>
<ul>
<li><strong>虚构事实</strong>：生成不存在的人物、事件或数据（如"2024年巴黎奥运会开幕式"的假图片）</li>
<li><strong>逻辑矛盾</strong>：同一回答中前后结论冲突（如"巴黎是法国首都，但法国首都是罗马"）</li>
<li><strong>语义偏差</strong>：对指令的误解导致答非所问（如将"画一只飞行的企鹅"理解为"企鹅坐在飞机里"）</li>
</ul>
<p><strong>最可怕的是</strong>：这些错误往往"看起来很合理"，让使用者难以辨别。</p>
<h3 data-id="heading-2">二、为什么大模型会"胡说八道"？底层逻辑决定一切</h3>
<p>大模型的"幻觉"不是偶然错误，而是其<strong>底层工作逻辑的必然结果</strong>。让我们揭开这个谜题：</p>
<h4 data-id="heading-3">1. 不是"查找"，而是"生成"</h4>
<p>大模型不是在"查找"答案，而是在玩"猜词接龙"。它基于训练数据中词与词之间的概率关系，预测下一个最可能的词。</p>
<p>想象你输入："法国的首都是..."，模型会根据训练数据中"法国"和"巴黎"的共现频率，预测"巴黎"是最可能的下一个词。它<strong>不是"知道"巴黎是法国首都</strong>，而是"记得"在训练数据中"法国"和"巴黎"经常一起出现。</p>
<h4 data-id="heading-4">2. 训练目标决定"自信"而非"诚实"</h4>
<p>在训练过程中，模型被鼓励给出"确定性"回答，而不是承认自己的无知。RLHF（基于人类反馈的强化学习）会奖励"自信"的回答，而不是"诚实"的回答。</p>
<p><strong>结果</strong>：模型学会了"为了流畅而牺牲准确"，尤其在信息模糊或复杂时。</p>
<h4 data-id="heading-5">3. "死记硬背"的书呆子</h4>
<p>模型只是在"记忆"训练数据中的模式，而不是真正理解世界。如果训练数据中"加拿大"和"多伦多"经常一起出现，它就会认为多伦多是加拿大的首都（实际上不是）。</p>
<h4 data-id="heading-6">4. "幻觉"的产生机制</h4>
<p>AI幻觉的根源在于模型的训练机制。目前的训练方式更倾向于奖励模型"猜测"答案，而不是鼓励它在面对不确定信息时坦承"我不知道"。</p>
<p>模型的训练目标是让回答看起来合理、流畅，而不是让回答准确。这导致模型倾向于表现得像一个"善于应试的考生"，即使在信息不明确的情况下也会尝试给出一个看似正确的回答。</p>
<h3 data-id="heading-7">三、真实案例：AI幻觉如何影响现实世界</h3>
<h4 data-id="heading-8">案例1：法律领域的"完美谎言"</h4>
<p>2023年，一名律师使用ChatGPT撰写法律文件，引用了6个完全不存在的判例。这些判例包含完整的案件名称、精确的案卷编号，甚至法官的判决意见和法律分析，看起来专业得不得了。结果，这位律师被法庭处罚。</p>
<h4 data-id="heading-9">案例2：医疗建议的致命错误</h4>
<p>某AI问诊平台建议糖尿病患者"每日注射胰岛素50单位"（远超安全剂量），因为模型混淆了不同体重患者的用药标准。患者按照这个错误建议用药，导致需要紧急医疗救助。</p>
<h4 data-id="heading-10">案例3：虚假新闻图片引发恐慌</h4>
<p>生成式AI工具Stable Diffusion生成"特朗普被捕"的假新闻图片，细节逼真但场景完全虚构，引发社交媒体恐慌。</p>
<h3 data-id="heading-11">四、如何减少AI幻觉？实用策略</h3>
<p>面对AI幻觉，我们并非束手无策。以下是一些经过验证的实用策略：</p>
<h4 data-id="heading-12">1. 精准提示词：让AI学会说"我不知道"</h4>
<p>在提示词中明确要求模型："如果不确定，请说明"或"请基于可靠资料回答"。</p>
<p><strong>示例</strong>：</p>
<blockquote>
<p>"请回答以下问题：'2024年最新AI政策是什么？' 如果你不确定，请说明。"</p>
</blockquote>
<h4 data-id="heading-13">2. 检索增强生成（RAG）：让AI先"查资料"再回答</h4>
<p>RAG是目前最有效的解决方案。它让AI先从可靠知识库中检索相关信息，再基于检索结果生成回答，而不是仅依赖内部记忆。</p>
<blockquote>
<p>例如：当用户询问"2024年最新AI政策"，RAG系统会从最新政策库中检索相关信息，确保回答时效性。</p>
</blockquote>
<h4 data-id="heading-14">3. 结构化输出：限制AI的"自由发挥"</h4>
<p>为AI输出定义严格的字段与类型要求（如JSON Schema），避免格式混乱和内容错误。</p>
<blockquote>
<p>例如：在金融场景中，要求模型必须输出固定格式的JSON，包含"交易ID"、"金额"、"状态"三个字段。</p>
</blockquote>
<h4 data-id="heading-15">4. 人类把关：关键环节必须人工审核</h4>
<p>对于医疗、法律等高风险领域，AI生成的内容必须经过专业人员审核，不能完全依赖AI。</p>
<h3 data-id="heading-16">五、结语：理性看待大模型，正确使用AI</h3>
<p>大模型不是魔法，而是一种工具。它的"幻觉"不是缺陷，而是其工作方式的必然结果。理解这一点，我们就能更理性地使用大模型，避免被它的"一本正经"所误导。</p>
<p><strong>记住</strong>：</p>
<ul>
<li>不要期待大模型能回答所有问题</li>
<li>对关键信息进行交叉验证</li>
<li>在高风险场景中，必须有人工审核环节</li>
<li>设计提示词时，明确要求模型承认不确定性</li>
</ul>
<p>未来AGI可能接近完美，但在那之前，我们需要理性看待大模型，扬长避短，才能真正发挥其价值。</p>
<p><em><strong>下次当你问AI一个问题，它给出一个"太完美了"的答案时，记得多问一句："这个信息的来源是什么？"——这才是驾驭大模型的正确方式。</strong></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 实时音频录制与转写 Composable 技术实现]]></title>    <link>https://juejin.cn/post/7583528177559289906</link>    <guid>https://juejin.cn/post/7583528177559289906</guid>    <pubDate>2025-12-14T11:22:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583528177559289906" data-draft-id="7583530023358758950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 实时音频录制与转写 Composable 技术实现"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-14T11:22:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cindershade"/> <meta itemprop="url" content="https://juejin.cn/user/2587590326494763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 实时音频录制与转写 Composable 技术实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2587590326494763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cindershade
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T11:22:51.000Z" title="Sun Dec 14 2025 11:22:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue3 实时音频录制与转写 Composable 技术实现</h2>
<h3 data-id="heading-1">前言</h3>
<p>本文介绍如何基于 Vue3 Composition API 实现一个实时音频录制与转写的 Composable，涉及 Web Audio API、WebSocket 实时通信、音频格式转换等技术。</p>
<h3 data-id="heading-2">技术栈</h3>
<ul>
<li><strong>Vue3 Composition API</strong>: 组合式函数封装</li>
<li><strong>MediaRecorder API</strong>: 浏览器音频录制</li>
<li><strong>Web Audio API</strong>: 音频流处理与格式转换</li>
<li><strong>WebSocket</strong>: 实时双向通信</li>
<li><strong>TypeScript</strong>: 类型安全</li>
</ul>
<h3 data-id="heading-3">核心功能</h3>
<ol>
<li>实时音频录制（支持暂停/继续/停止）</li>
<li>音频流实时处理与传输</li>
<li>WebSocket 实时通信接收转写结果</li>
<li>实时字幕逐句显示</li>
<li>字幕定时保存机制</li>
</ol>
<h3 data-id="heading-4">技术架构</h3>
<pre><code class="hljs language-text" lang="text">┌─────────────────────────────────────────┐
│      useAudioRecorder Composable       │
├─────────────────────────────────────────┤
│  1. 音频录制层 (MediaRecorder)          │
│  2. 音频处理层 (Web Audio API)          │
│  3. 实时通信层 (WebSocket)              │
│  4. 字幕处理层 (文本处理)                │
│  5. 数据持久化层 (定时保存)              │
└─────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-5">一、音频录制实现</h3>
<h4 data-id="heading-6">1.1 获取麦克风权限</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 获取用户麦克风权限</span>
audioStream = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>({
  <span class="hljs-attr">audio</span>: {
    <span class="hljs-attr">echoCancellation</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 回声消除</span>
    <span class="hljs-attr">noiseSuppression</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 降噪</span>
    <span class="hljs-attr">autoGainControl</span>: <span class="hljs-literal">true</span>,     <span class="hljs-comment">// 自动增益控制</span>
  },
});
</code></pre>
<p><strong>技术要点</strong>：</p>
<ul>
<li><code>getUserMedia</code> 返回 <code>MediaStream</code> 对象</li>
<li>音频约束配置优化录音质量</li>
<li>需要用户授权，需要处理权限拒绝情况</li>
</ul>
<h4 data-id="heading-7">1.2 创建 MediaRecorder</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 检测浏览器支持的音频格式</span>
<span class="hljs-keyword">const</span> mimeType = <span class="hljs-title class_">MediaRecorder</span>.<span class="hljs-title function_">isTypeSupported</span>(<span class="hljs-string">'audio/webm;codecs=opus'</span>)
  ? <span class="hljs-string">'audio/webm;codecs=opus'</span>  <span class="hljs-comment">// 优先使用 Opus 编码</span>
  : <span class="hljs-string">'audio/webm'</span>;              <span class="hljs-comment">// 降级方案</span>

<span class="hljs-comment">// 创建 MediaRecorder 实例</span>
mediaRecorder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaRecorder</span>(audioStream, { mimeType });

<span class="hljs-comment">// 监听数据可用事件</span>
mediaRecorder.<span class="hljs-property">ondataavailable</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">size</span> &gt; <span class="hljs-number">0</span>) {
    audioChunks.<span class="hljs-title function_">push</span>(event.<span class="hljs-property">data</span>);  <span class="hljs-comment">// 收集音频块</span>
  }
};

<span class="hljs-comment">// 开始录制（每3秒触发一次 ondataavailable）</span>
mediaRecorder.<span class="hljs-title function_">start</span>(<span class="hljs-number">3000</span>);
</code></pre>
<p><strong>技术要点</strong>：</p>
<ul>
<li><code>MediaRecorder</code> 用于录制音频流</li>
<li><code>start(timeslice)</code> 参数控制数据分片间隔</li>
<li>音频数据以 <code>Blob</code> 格式存储</li>
</ul>
<h3 data-id="heading-8">二、音频处理与格式转换</h3>
<h4 data-id="heading-9">2.1 双音频流架构</h4>
<p>为了实现录音保存和实时转写并行，需要创建两个独立的音频上下文：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 音频流1：用于录音保存（原始采样率）</span>
audioContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>();
<span class="hljs-keyword">const</span> analyser = audioContext.<span class="hljs-title function_">createAnalyser</span>();
analyser.<span class="hljs-property">fftSize</span> = <span class="hljs-number">256</span>;  <span class="hljs-comment">// 用于音频可视化</span>
audioContext.<span class="hljs-title function_">createMediaStreamSource</span>(audioStream).<span class="hljs-title function_">connect</span>(analyser);

<span class="hljs-comment">// 音频流2：用于实时转写（16000Hz采样率）</span>
asrAudioContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>({ <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">16000</span> });
</code></pre>
<p><strong>为什么需要双流？</strong></p>
<ul>
<li>录音保存需要高质量（原始采样率）</li>
<li>实时转写需要标准采样率（16000Hz，ASR 标准）</li>
<li>两个流互不干扰，独立处理</li>
</ul>
<h4 data-id="heading-10">2.2 音频格式转换</h4>
<p>Web Audio API 返回的是 <code>Float32Array</code>（范围 -1.0 到 1.0），而 ASR 服务通常需要 16 位 PCM 格式（范围 -32768 到 32767）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 将 Float32 音频转换为 16 位 PCM
 * <span class="hljs-doctag">@param</span> input Float32Array 音频数据
 * <span class="hljs-doctag">@returns</span> Uint8Array 16位PCM数据
 */</span>
<span class="hljs-keyword">const</span> convertTo16BitPCM = (<span class="hljs-attr">input</span>: <span class="hljs-title class_">Float32Array</span>): <span class="hljs-function"><span class="hljs-params">Uint8Array</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(input.<span class="hljs-property">length</span> * <span class="hljs-number">2</span>);  <span class="hljs-comment">// 16位 = 2字节</span>
  <span class="hljs-keyword">const</span> view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);
  
  input.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">sample, i</span>) =&gt;</span> {
    <span class="hljs-comment">// 限制范围到 [-1, 1]</span>
    <span class="hljs-keyword">const</span> value = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(-<span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, sample));
    
    <span class="hljs-comment">// 转换为16位整数</span>
    <span class="hljs-comment">// 负数: value * 0x8000 = -32768</span>
    <span class="hljs-comment">// 正数: value * 0x7FFF = 32767</span>
    view.<span class="hljs-title function_">setInt16</span>(
      i * <span class="hljs-number">2</span>, 
      value &lt; <span class="hljs-number">0</span> ? value * <span class="hljs-number">0x8000</span> : value * <span class="hljs-number">0x7FFF</span>, 
      <span class="hljs-literal">true</span>  <span class="hljs-comment">// little-endian 字节序</span>
    );
  });
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer);
};
</code></pre>
<p><strong>转换原理</strong>：</p>
<ul>
<li>Float32: 32位浮点数，范围 [-1.0, 1.0]</li>
<li>16位PCM: 16位整数，范围 [-32768, 32767]</li>
<li>使用线性映射：<code>PCM = Float32 × 32767</code>（正数）或 <code>Float32 × 32768</code>（负数）</li>
</ul>
<h4 data-id="heading-11">2.3 音频分块处理</h4>
<p>使用 <code>ScriptProcessorNode</code> 处理音频流，并按固定大小分块发送：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 常量定义</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PCM_CHUNK_SIZE</span> = <span class="hljs-number">6400</span>;  <span class="hljs-comment">// 200ms音频数据</span>
<span class="hljs-comment">// 计算：16000Hz × 0.2s × 2字节 = 6400字节</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ASR_SAMPLE_RATE</span> = <span class="hljs-number">16000</span>;  <span class="hljs-comment">// ASR标准采样率</span>

<span class="hljs-comment">// 设置音频处理器</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setupAudioProcessor</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!wsClient?.<span class="hljs-title function_">isConnected</span>() || !asrAudioContext || !audioStream) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-comment">// 清空缓冲区</span>
  audioBuffer = [];
  
  <span class="hljs-comment">// 创建音频源</span>
  <span class="hljs-keyword">const</span> asrSource = asrAudioContext.<span class="hljs-title function_">createMediaStreamSource</span>(audioStream);
  
  <span class="hljs-comment">// 创建脚本处理器（已废弃但兼容性好）</span>
  <span class="hljs-comment">// 参数：bufferSize, numberOfInputChannels, numberOfOutputChannels</span>
  audioProcessor = asrAudioContext.<span class="hljs-title function_">createScriptProcessor</span>(<span class="hljs-number">4096</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
  
  <span class="hljs-comment">// 连接音频节点</span>
  asrSource.<span class="hljs-title function_">connect</span>(audioProcessor);
  audioProcessor.<span class="hljs-title function_">connect</span>(asrAudioContext.<span class="hljs-property">destination</span>);
  
  <span class="hljs-comment">// 处理音频数据</span>
  audioProcessor.<span class="hljs-property">onaudioprocess</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!wsClient?.<span class="hljs-title function_">isConnected</span>()) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 1. 获取输入音频数据（Float32格式）</span>
    <span class="hljs-keyword">const</span> inputData = e.<span class="hljs-property">inputBuffer</span>.<span class="hljs-title function_">getChannelData</span>(<span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 2. 转换为16位PCM</span>
    <span class="hljs-keyword">const</span> pcmData = <span class="hljs-title function_">convertTo16BitPCM</span>(inputData);
    
    <span class="hljs-comment">// 3. 累积到缓冲区</span>
    audioBuffer.<span class="hljs-title function_">push</span>(...pcmData);
    
    <span class="hljs-comment">// 4. 达到200ms数据量时发送</span>
    <span class="hljs-keyword">if</span> (audioBuffer.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable constant_">PCM_CHUNK_SIZE</span>) {
      <span class="hljs-keyword">const</span> chunk = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(
        audioBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">PCM_CHUNK_SIZE</span>)
      );
      
      <span class="hljs-comment">// 5. 通过WebSocket发送（二进制数据）</span>
      wsClient.<span class="hljs-title function_">send</span>(chunk, <span class="hljs-literal">false</span>);  <span class="hljs-comment">// false: 不加入消息队列</span>
      
      <span class="hljs-comment">// 6. 移除已发送的数据</span>
      audioBuffer = audioBuffer.<span class="hljs-title function_">slice</span>(<span class="hljs-variable constant_">PCM_CHUNK_SIZE</span>);
    }
  };
};
</code></pre>
<p><strong>分块策略</strong>：</p>
<ul>
<li><strong>块大小</strong>: 6400字节 = 200ms音频</li>
<li><strong>为什么200ms</strong>: 平衡实时性和网络效率
<ul>
<li>太小：网络请求频繁，增加延迟</li>
<li>太大：实时性差，用户体验不佳</li>
</ul>
</li>
<li><strong>缓冲区管理</strong>: 使用数组累积，达到阈值后发送并清空</li>
</ul>
<h3 data-id="heading-12">三、WebSocket 实时通信</h3>
<h4 data-id="heading-13">3.1 连接建立</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 连接WebSocket接收实时转写结果
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">connectWebSocket</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">recordId: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> wsUrl = <span class="hljs-string">`wss://your-server.com/api/asr/realtime`</span>;
    <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">getAuthToken</span>();  <span class="hljs-comment">// 获取认证token</span>
    
    <span class="hljs-comment">// 使用封装的WebSocket客户端 你自己可以封装一个WebSocket的工具类</span>
    wsClient = <span class="hljs-title function_">createWebSocket</span>({
      <span class="hljs-attr">url</span>: wsUrl,
      <span class="hljs-attr">binaryType</span>: <span class="hljs-string">'arraybuffer'</span>,      <span class="hljs-comment">// 支持二进制数据</span>
      <span class="hljs-attr">heartbeatInterval</span>: <span class="hljs-number">30000</span>,       <span class="hljs-comment">// 30秒心跳</span>
      <span class="hljs-attr">reconnectInterval</span>: <span class="hljs-number">3000</span>,        <span class="hljs-comment">// 3秒重连间隔</span>
      <span class="hljs-attr">maxReconnectAttempts</span>: <span class="hljs-number">10</span>,       <span class="hljs-comment">// 最多重连10次</span>
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-title class_">Authorization</span>: token ? <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span> : <span class="hljs-string">''</span>,
      },
    }, {
      <span class="hljs-attr">onOpen</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket连接成功'</span>);
      },
      <span class="hljs-attr">onMessage</span>: <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
        <span class="hljs-title function_">handleTranscriptionMessage</span>(message);
      },
      <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket错误:'</span>, event);
      },
      <span class="hljs-attr">onClose</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket连接关闭'</span>);
      }
    });
    
    <span class="hljs-keyword">await</span> wsClient.<span class="hljs-title function_">connect</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket连接失败:'</span>, error);
    <span class="hljs-keyword">throw</span> error;
  }
};
</code></pre>
<p><strong>技术要点</strong>：</p>
<ul>
<li>使用 WSS（WebSocket Secure）保证传输安全</li>
<li>配置心跳机制保持连接活跃</li>
<li>自动重连机制处理网络波动</li>
<li>Token 认证通过 URL 参数传递（WebSocket 不支持自定义请求头）</li>
</ul>
<h4 data-id="heading-14">3.2 消息处理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 处理转写消息
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTranscriptionMessage</span> = (<span class="hljs-params">message: WebSocketMessage</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">let</span> result = message.<span class="hljs-property">data</span>;
    
    <span class="hljs-comment">// 1. 解析JSON消息</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'string'</span>) {
      <span class="hljs-comment">// 错误检查</span>
      <span class="hljs-keyword">if</span> (result.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'error'</span>) || result.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'Error'</span>) || result.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'timeout'</span>)) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'收到错误消息:'</span>, result);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">try</span> {
        result = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(result);
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 解析失败，忽略</span>
      }
    }
    
    <span class="hljs-comment">// 2. 检查错误字段</span>
    <span class="hljs-keyword">if</span> (result?.<span class="hljs-property">error</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'WebSocket返回错误:'</span>, result.<span class="hljs-property">error</span>);
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 3. 提取转写文本</span>
    <span class="hljs-keyword">const</span> text = result?.<span class="hljs-property">result</span>?.<span class="hljs-property">text</span> || result?.<span class="hljs-property">text</span>;
    <span class="hljs-keyword">if</span> (text) {
      <span class="hljs-comment">// 更新完整字幕</span>
      subtitles.<span class="hljs-property">value</span> = text;
      accumulatedText.<span class="hljs-property">value</span> = text;
      
      <span class="hljs-comment">// 更新当前显示的字幕（逐句显示）</span>
      <span class="hljs-title function_">updateCurrentSubtitle</span>(text, currentSubtitle, lastDisplayedSentenceEnd);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'处理转写消息失败:'</span>, error);
  }
};
</code></pre>
<h3 data-id="heading-15">四、实时字幕显示</h3>
<h4 data-id="heading-16">4.1 逐句显示逻辑</h4>
<p>实现智能的字幕逐句显示，基于标点符号识别完整句子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 更新当前显示的字幕（逐句显示）
 * <span class="hljs-doctag">@param</span> fullText 完整字幕文本
 * <span class="hljs-doctag">@param</span> currentSubtitle 当前显示的字幕（响应式引用）
 * <span class="hljs-doctag">@param</span> lastDisplayedSentenceEnd 已显示的最后一句的结束位置
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateCurrentSubtitle</span> = (<span class="hljs-params">
  fullText: <span class="hljs-built_in">string</span>, 
  currentSubtitle: Ref&lt;<span class="hljs-built_in">string</span>&gt;, 
  lastDisplayedSentenceEnd: Ref&lt;<span class="hljs-built_in">number</span>&gt;
</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!fullText) {
    currentSubtitle.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-comment">// 如果文本长度没有增加，无需更新</span>
  <span class="hljs-keyword">if</span> (fullText.<span class="hljs-property">length</span> &lt;= lastDisplayedSentenceEnd.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-comment">// 获取新增的文本部分</span>
  <span class="hljs-keyword">const</span> newText = fullText.<span class="hljs-title function_">substring</span>(lastDisplayedSentenceEnd.<span class="hljs-property">value</span>);
  
  <span class="hljs-comment">// 尝试匹配完整句子（以标点符号结尾）</span>
  <span class="hljs-keyword">const</span> sentenceMatch = newText.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^[^。！？\n\.]+[。！？\n\.]+/</span>);
  
  <span class="hljs-keyword">if</span> (sentenceMatch) {
    <span class="hljs-comment">// 找到完整句子</span>
    <span class="hljs-keyword">const</span> completeSentence = sentenceMatch[<span class="hljs-number">0</span>].<span class="hljs-title function_">trim</span>();
    <span class="hljs-keyword">if</span> (completeSentence) {
      <span class="hljs-comment">// 移除末尾多余的标点符号（保留最后一个）</span>
      <span class="hljs-keyword">const</span> displayText = completeSentence.<span class="hljs-title function_">replace</span>(
        <span class="hljs-regexp">/[。！？\n\.]+$/</span>, 
        <span class="hljs-function">(<span class="hljs-params">match</span>) =&gt;</span> match[match.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
      );
      currentSubtitle.<span class="hljs-property">value</span> = displayText;
      
      <span class="hljs-comment">// 更新已显示位置</span>
      lastDisplayedSentenceEnd.<span class="hljs-property">value</span> = 
        lastDisplayedSentenceEnd.<span class="hljs-property">value</span> + sentenceMatch[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>;
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 没有完整句子，查找最后一个标点符号</span>
    <span class="hljs-keyword">const</span> lastPunctuationIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
      fullText.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'。'</span>),
      fullText.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'！'</span>),
      fullText.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'？'</span>),
      fullText.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'\n'</span>),
      fullText.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'.'</span>)
    );
    
    <span class="hljs-keyword">if</span> (lastPunctuationIndex &gt;= lastDisplayedSentenceEnd.<span class="hljs-property">value</span>) {
      <span class="hljs-comment">// 有新的标点符号，显示标点符号之后的内容</span>
      <span class="hljs-keyword">const</span> afterLastPunctuation = fullText.<span class="hljs-title function_">substring</span>(lastPunctuationIndex + <span class="hljs-number">1</span>).<span class="hljs-title function_">trim</span>();
      <span class="hljs-keyword">if</span> (afterLastPunctuation) {
        currentSubtitle.<span class="hljs-property">value</span> = afterLastPunctuation;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 没有标点符号，显示新文本部分</span>
      <span class="hljs-keyword">const</span> displayText = newText.<span class="hljs-title function_">trim</span>();
      <span class="hljs-keyword">if</span> (displayText) {
        currentSubtitle.<span class="hljs-property">value</span> = displayText;
      }
    }
  }
};
</code></pre>
<p><strong>显示策略</strong>：</p>
<ol>
<li><strong>完整句子优先</strong>: 识别以标点符号结尾的完整句子</li>
<li><strong>标点符号处理</strong>: 保留最后一个标点，移除多余的</li>
<li><strong>增量更新</strong>: 只显示新增部分，避免重复显示</li>
<li><strong>容错处理</strong>: 没有标点符号时显示新文本部分</li>
</ol>
<h4 data-id="heading-17">4.2 字幕状态管理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 响应式状态</span>
<span class="hljs-keyword">const</span> subtitles = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);              <span class="hljs-comment">// 完整字幕文本</span>
<span class="hljs-keyword">const</span> currentSubtitle = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);        <span class="hljs-comment">// 当前显示的字幕</span>
<span class="hljs-keyword">const</span> accumulatedText = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);        <span class="hljs-comment">// 累积文本</span>
<span class="hljs-keyword">const</span> lastDisplayedSentenceEnd = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 已显示的最后一句的结束位置</span>

<span class="hljs-comment">// 重置字幕状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resetSubtitleState</span> = (<span class="hljs-params"/>) =&gt; {
  subtitles.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
  currentSubtitle.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
  accumulatedText.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
  lastDisplayedSentenceEnd.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>;
};
</code></pre>
<h3 data-id="heading-18">六、完整生命周期管理</h3>
<h4 data-id="heading-19">6.1 开始录音</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">startRecording</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. 初始化状态</span>
    audioChunks = [];
    <span class="hljs-title function_">resetSubtitleState</span>();
    subtitleIdentification.<span class="hljs-property">value</span> = <span class="hljs-title function_">uuidv4</span>();
    
    <span class="hljs-comment">// 2. 获取麦克风权限</span>
    audioStream = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>({
      <span class="hljs-attr">audio</span>: {
        <span class="hljs-attr">echoCancellation</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">noiseSuppression</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">autoGainControl</span>: <span class="hljs-literal">true</span>,
      },
    });
    
    <span class="hljs-comment">// 3. 创建音频上下文（用于可视化）</span>
    audioContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>();
    <span class="hljs-keyword">const</span> newAnalyser = audioContext.<span class="hljs-title function_">createAnalyser</span>();
    newAnalyser.<span class="hljs-property">fftSize</span> = <span class="hljs-number">256</span>;
    audioContext.<span class="hljs-title function_">createMediaStreamSource</span>(audioStream).<span class="hljs-title function_">connect</span>(newAnalyser);
    analyser.<span class="hljs-property">value</span> = newAnalyser;
    
    <span class="hljs-comment">// 4. 创建 MediaRecorder</span>
    <span class="hljs-keyword">const</span> mimeType = <span class="hljs-title class_">MediaRecorder</span>.<span class="hljs-title function_">isTypeSupported</span>(<span class="hljs-string">'audio/webm;codecs=opus'</span>)
      ? <span class="hljs-string">'audio/webm;codecs=opus'</span>
      : <span class="hljs-string">'audio/webm'</span>;
    mediaRecorder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaRecorder</span>(audioStream, { mimeType });
    
    mediaRecorder.<span class="hljs-property">ondataavailable</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">size</span> &gt; <span class="hljs-number">0</span>) {
        audioChunks.<span class="hljs-title function_">push</span>(event.<span class="hljs-property">data</span>);
      }
    };
    
    <span class="hljs-comment">// 5. 连接 WebSocket</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">connectWebSocket</span>(currentRecordId.<span class="hljs-property">value</span>);
      <span class="hljs-title function_">startSubtitleSaveTimer</span>();
      
      <span class="hljs-comment">// 6. 创建用于ASR的音频上下文</span>
      <span class="hljs-keyword">if</span> (wsClient?.<span class="hljs-title function_">isConnected</span>()) {
        asrAudioContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>({ <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">16000</span> });
        <span class="hljs-title function_">setupAudioProcessor</span>();
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket连接失败，继续录音但不显示实时字幕:'</span>, error);
    }
    
    <span class="hljs-comment">// 7. 开始录音</span>
    mediaRecorder.<span class="hljs-title function_">start</span>(<span class="hljs-number">3000</span>);
    isRecording.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    isPaused.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    recordingTime.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 8. 开始计时</span>
    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    recordingTimer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> elapsed = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime) / <span class="hljs-number">100</span>);
      recordingTime.<span class="hljs-property">value</span> = elapsed;
    }, <span class="hljs-number">100</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'开始录音失败:'</span>, error);
    <span class="hljs-keyword">throw</span> error;
  }
};
</code></pre>
<h4 data-id="heading-20">6.2 暂停/继续录音</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 暂停录音
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">pauseRecording</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (mediaRecorder?.<span class="hljs-property">state</span> !== <span class="hljs-string">'recording'</span>) <span class="hljs-keyword">return</span>;
  
  mediaRecorder.<span class="hljs-title function_">pause</span>();
  isPaused.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  isRecording.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  
  <span class="hljs-comment">// 停止计时器</span>
  <span class="hljs-keyword">if</span> (recordingTimer) {
    <span class="hljs-built_in">clearInterval</span>(recordingTimer);
    recordingTimer = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 停止音频处理器</span>
  <span class="hljs-keyword">if</span> (audioProcessor) {
    audioProcessor.<span class="hljs-title function_">disconnect</span>();
    audioProcessor = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 保存字幕并断开WebSocket</span>
  <span class="hljs-keyword">if</span> (subtitles.<span class="hljs-property">value</span> &amp;&amp; subtitleIdentification.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">saveCurrentSubtitles</span>();
    <span class="hljs-title function_">stopSubtitleSaveTimer</span>();
  }
  
  <span class="hljs-keyword">if</span> (wsClient) {
    wsClient.<span class="hljs-title function_">disconnect</span>();
    wsClient = <span class="hljs-literal">null</span>;
  }
};

<span class="hljs-comment">/**
 * 继续录音
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resumeRecording</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!isPaused.<span class="hljs-property">value</span> || !mediaRecorder) <span class="hljs-keyword">return</span>;
  
  mediaRecorder.<span class="hljs-title function_">resume</span>();
  isPaused.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  isRecording.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  
  <span class="hljs-comment">// 重新连接WebSocket</span>
  <span class="hljs-keyword">if</span> (currentRecordId.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">connectWebSocket</span>(currentRecordId.<span class="hljs-property">value</span>);
      <span class="hljs-title function_">startSubtitleSaveTimer</span>();
      
      <span class="hljs-comment">// 重新设置音频处理器</span>
      <span class="hljs-keyword">if</span> (!asrAudioContext &amp;&amp; audioStream) {
        asrAudioContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>({ <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">16000</span> });
      }
      <span class="hljs-title function_">setupAudioProcessor</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket重连失败，继续录音但不显示实时字幕:'</span>, error);
    }
  }
  
  <span class="hljs-comment">// 恢复计时</span>
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - recordingTime.<span class="hljs-property">value</span> * <span class="hljs-number">100</span>;
  recordingTimer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> elapsed = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime) / <span class="hljs-number">100</span>);
    recordingTime.<span class="hljs-property">value</span> = elapsed;
  }, <span class="hljs-number">100</span>);
};
</code></pre>
<h4 data-id="heading-21">6.3 停止录音与资源清理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 停止录音
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">stopRecording</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  onStop?: (audioChunks: Blob[], recordId: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;
</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!mediaRecorder) <span class="hljs-keyword">return</span>;
  
  isRecording.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  isPaused.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  
  <span class="hljs-comment">// 停止计时器</span>
  <span class="hljs-keyword">if</span> (recordingTimer) {
    <span class="hljs-built_in">clearInterval</span>(recordingTimer);
    recordingTimer = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 设置停止事件处理</span>
  mediaRecorder.<span class="hljs-property">onstop</span> = <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (audioChunks.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; currentRecordId.<span class="hljs-property">value</span> &amp;&amp; onStop) {
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">onStop</span>(audioChunks, currentRecordId.<span class="hljs-property">value</span>);
      }
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">cleanup</span>();
    }
  };
  
  <span class="hljs-comment">// 停止录音并断开WebSocket</span>
  mediaRecorder.<span class="hljs-title function_">stop</span>();
  <span class="hljs-keyword">if</span> (wsClient) {
    wsClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">'stop'</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-comment">// 延迟断开，确保最后的消息能收到</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (wsClient) {
        wsClient.<span class="hljs-title function_">disconnect</span>();
        wsClient = <span class="hljs-literal">null</span>;
      }
    }, <span class="hljs-number">500</span>);
  }
  
  <span class="hljs-comment">// 确保显示最后的内容</span>
  <span class="hljs-keyword">if</span> (subtitles.<span class="hljs-property">value</span>) {
    <span class="hljs-comment">// 处理最后未完成的句子显示逻辑</span>
    <span class="hljs-comment">// ...</span>
  }
  
  <span class="hljs-comment">// 延迟重置状态，确保用户能看到最后的内容</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">resetSubtitleState</span>();
  }, <span class="hljs-number">2000</span>);
};

<span class="hljs-comment">/**
 * 清理资源
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">cleanup</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 停止音频流</span>
  <span class="hljs-keyword">if</span> (audioStream) {
    audioStream.<span class="hljs-title function_">getTracks</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">track</span>) =&gt;</span> track.<span class="hljs-title function_">stop</span>());
    audioStream = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 关闭音频上下文</span>
  <span class="hljs-keyword">if</span> (audioContext) {
    audioContext.<span class="hljs-title function_">close</span>();
    audioContext = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">if</span> (asrAudioContext) {
    asrAudioContext.<span class="hljs-title function_">close</span>();
    asrAudioContext = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 断开音频处理器</span>
  <span class="hljs-keyword">if</span> (audioProcessor) {
    audioProcessor.<span class="hljs-title function_">disconnect</span>();
    audioProcessor = <span class="hljs-literal">null</span>;
  }
  
  analyser.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
  mediaRecorder = <span class="hljs-literal">null</span>;
  
  <span class="hljs-comment">// 清理WebSocket</span>
  <span class="hljs-keyword">if</span> (wsClient) {
    wsClient.<span class="hljs-title function_">disconnect</span>();
    wsClient = <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 停止字幕保存定时器</span>
  <span class="hljs-title function_">stopSubtitleSaveTimer</span>();
  
  <span class="hljs-comment">// 清空音频块和缓冲区</span>
  audioChunks = [];
  audioBuffer = [];
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《回顾我的AI学习之路，上万字的AI学习思维导图分享》]]></title>    <link>https://juejin.cn/post/7583507286317465600</link>    <guid>https://juejin.cn/post/7583507286317465600</guid>    <pubDate>2025-12-15T00:01:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583507286317465600" data-draft-id="7582919147640750132" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《回顾我的AI学习之路，上万字的AI学习思维导图分享》"/> <meta itemprop="keywords" content="前端,后端,产品经理"/> <meta itemprop="datePublished" content="2025-12-15T00:01:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="华洛"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474430190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《回顾我的AI学习之路，上万字的AI学习思维导图分享》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474430190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    华洛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:01:21.000Z" title="Mon Dec 15 2025 00:01:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>历时半年，我完成了一份AI学习路径的思维导图。目前思维导图已经公开，今天这篇文章我们着重讲两件事：</p>
<ol>
<li>讲一下如何学习AI以及如何利用这份思维导图更高效的学习。</li>
<li>讲一下这份思维导图的后续规划。</li>
</ol>
<p>这份思维导图拥有八百多个主题节点、九千九百多字、以及相关配图，认真说起来，这不仅仅是一份学习路径思维导图，它更像是一份详实的具有AI学习路径、实践结果、思考过程的学习内容，包含了<code>AI应用的技术工程</code>、<code>AI产品的设计思路</code>、<code>AI需求挖掘方案</code>等几个大模块，每个模块又详细解释具体落地方案。</p>
<p>例如：function call部分，包含了function call的应用，提示词代替function call的方案与优缺点，function call 落地的问题与解决方案，落地应用的实现方案，function call与MCP。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ff08b6a99f64084b0dae79445339eee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=INe65o09JoGdG1GgyrtA8KaX%2F30%3D" alt="fc.png" width="70%" loading="lazy"/>
<p>而function call这一部分知识，只是AI技术工程中的一个节点，AI技术工程中我提供了<code>prompt</code>、<code>RAG</code>、<code>function call</code>、<code>workflow</code>、<code>agent</code>、<code>微调</code>、<code>模型的选择方案</code>、<code>AI产品的辅助系统实现</code>八个模块的内容。</p>
<p>例如：AI需求挖掘部分，什么算是AI需求，现有产品升级AI时的思考方案，AI+ 和 +AI的应用等。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6df828c3f13945149c567a454bbdd6b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=PlmYMbMjwuUBgLY%2BWa%2FwzMLYDSE%3D" alt="xuqiu.png" width="70%" loading="lazy"/>
<p>AI需求挖掘是AI产品部分中的一个节点，AI产品部分提供了<code>AI需求</code>、<code>AI语音产品</code>、<code>AI项目</code>、<code>AI产品测试</code>、<code>AI产品日志</code>、<code>TOB的AI应用落地注意事项</code>、<code>TOC的AI应用落地注意事项</code>、<code>TOG的AI应用落地注意事项</code>等内容</p>
<p>再例如：很多人知道SSE交互是<code>new EventSource</code>，但是有很多人并不知道<code>fetch</code>也能实现SSE。</p>
<p>这些内容都在这份思维导图中可查。</p>
<p>略微看一下这份思维导图的好评，然后我们开始正文：</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86f99717b1f947279cb2bf7541f34553~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=HSsyAJ%2Fg%2FoB8murbyRbLw8Un0es%3D" alt="3bea717113ac47b864f2bf917ef461b4.jpg" width="50%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d02e380371e45528ad7ef2cb269493c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=jETjMUDJyt271jojDeBnczNYOJU%3D" alt="6d069ad4f9283742306bee10fad5a9f0.jpg" width="50%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd407d74b506447a99553542214469c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=OM6xOkean2TOp0cxpHrEnQPKM%2FQ%3D" alt="1499520837b3f960d19bd6cec09d90e5.jpg" width="50%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/221dc77111334b92b6c2b71e2866c928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2O5rSb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368454&amp;x-signature=LsCKOJLuhZ0UoS3B9lic%2BdqpNJc%3D" alt="dd0b8cb925ee4483c042dceda3c7edd1.jpg" width="50%" loading="lazy"/>
<h2 data-id="heading-0">关于学习路径</h2>
<p>最开始，是因为群里不断有人在问，<strong>AI到底应该怎么学？</strong></p>
<p>绝大多数人学习AI的过程是：</p>
<p>决定学习AI =&gt; 陷入AI专业技术中 =&gt; 被大量的概念冲击 =&gt; 一部分人就此放弃；</p>
<p>而坚持下来的人，最终发现AI技术与自身工作偏离太远，而AI工作的门槛又极高，最终坚持不住放弃。</p>
<p>为什么会出现这个情况？</p>
<p>其实本质上大家搞错了学习方向。</p>
<p>实际上我们的学习，尤其是我们成人之后在工作领域的学习，大多都应该以实用与落地为主的，凡是不能落地的学习，最终的结局都是遗忘。</p>
<p>而AI的学习其实是分为两个方向： <strong>1. AI技术层的学习。 2. AI应用层的学习。</strong></p>
<p>我曾经说过的一句话，<strong>科学家下场之后，就是工程师的舞台。</strong> 其实对应的就是技术层和应用层的不同实用场景。</p>
<p>科学家在AI技术层的研究，最终让AI有了面向大众的能力。</p>
<p>而随后在这世间的各行各业中，将AI的能力发扬光大的，都是各行各业的工程师们。</p>
<p>我们绝大多数的普通人，其实充当的是工程师的角色，而在学习时，却选择了科学家的学习路径！</p>
<p>我们应当选择应用层的学习，但是却在学习时大量学习了技术层的内容，这就是为什么总是学习无果的原因。</p>
<p>接下来回到我们的思维导图，来聊聊如何学习AI</p>
<h3 data-id="heading-1">学习方式</h3>
<p>学习开始之前最重要的是确定自己要学习哪些东西，设定阶段性的边界。切记目标不清晰、目标错误。</p>
<p>这份思维导图中，包含了大量的技术点、概念、思考结论等内容。</p>
<p>初期的学习者要从明确的了解AI应用所需的相关的概念开始学习，随后对概念有了正确的了解就可以开始实践相关的技术点。</p>
<p>这里需要着重说一下：很多朋友一上来就想着说，我要做个什么项目，才能学会这些东西吧？</p>
<p>其实不是的，在这个阶段各位所需要的是有目的性的刻意练习。</p>
<p>你在实践function call，你就搞function call。 你在实践RAG，你就搞RAG。</p>
<p>当你对每个技术点都足够掌握之后，就可以动手实现一个项目（如果你没项目，可以看我写的售前项目专栏），然后你就会发现项目中有各种各样的问题。</p>
<p>这时候，你就会发现思维导图中有许多思考和实践后的结论，那些内容可以帮助你度过项目落地的困境。</p>
<p>让我们回到最开始，有很多人会纠结这个问题：我要怎么开始，我是百度？还是刷视频？还是买书？</p>
<p>这里给大家一个建议：我们要学习是所有在应用层的概念、应用和最佳实践。</p>
<p>那么<strong>各大厂商的官方文档</strong>就是各位最好的新手村。</p>
<p>这里的知识是最新的，你不用担心学到过期知识。从这里开始，你会少走很多弯路。</p>
<h4 data-id="heading-2">一：各大模型厂商的官方文档</h4>
<p>各大模型厂商的官方文档中都存在于自身模型最匹配、最权威、且有效的落地方案。</p>
<p>每个模型的厂商都有自己的方案，我们在学习与实现各个厂商不同的方案时，能让我们快速的增长大量经验。</p>
<p>对比学习法 + 带脑子的思考，我们的学习进度会远超平时的看视频、看文章。</p>
<p>厂商的文档地址给大家放在这里，可以自行查看。</p>





























































<table><thead><tr><th><strong>厂商/模型</strong></th><th><strong>官方文档地址</strong></th></tr></thead><tbody><tr><td><strong>OpenAI (GPT系列)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs" target="_blank" title="https://platform.openai.com/docs" ref="nofollow noopener noreferrer">platform.openai.com/docs</a></td></tr><tr><td><strong>Google (Gemini系列)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.google.dev%2Fdocs" target="_blank" title="https://ai.google.dev/docs" ref="nofollow noopener noreferrer">ai.google.dev/docs</a></td></tr><tr><td><strong>Anthropic (Claude系列)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fclaude%2Fdocs" target="_blank" title="https://docs.anthropic.com/claude/docs" ref="nofollow noopener noreferrer">docs.anthropic.com/claude/docs</a></td></tr><tr><td><strong>Meta (Llama系列)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.llama.com%2Fdocs%2Foverview%2F" target="_blank" title="https://www.llama.com/docs/overview/" ref="nofollow noopener noreferrer">www.llama.com/docs/overvi…</a></td></tr><tr><td><strong>百度 (文心一言)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.baidu.com%2Fdoc%2FWENXINWORKSHOP%2Findex.html" target="_blank" title="https://cloud.baidu.com/doc/WENXINWORKSHOP/index.html" ref="nofollow noopener noreferrer">cloud.baidu.com/doc/WENXINW…</a></td></tr><tr><td><strong>阿里云 (通义千问)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fmodel-studio" target="_blank" title="https://help.aliyun.com/zh/model-studio" ref="nofollow noopener noreferrer">help.aliyun.com/zh/model-st…</a></td></tr><tr><td><strong>腾讯 (混元大模型)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdocument%2Fproduct%2F1729" target="_blank" title="https://cloud.tencent.com/document/product/1729" ref="nofollow noopener noreferrer">cloud.tencent.com/document/pr…</a></td></tr><tr><td><strong>华为 (盘古大模型)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.huaweicloud.com%2Fmodelarts%2Findex.html" target="_blank" title="https://support.huaweicloud.com/modelarts/index.html" ref="nofollow noopener noreferrer">support.huaweicloud.com/modelarts/i…</a></td></tr><tr><td><strong>科大讯飞 (星火大模型)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xfyun.cn%2Fdoc%2Fspark%2FWeb.html" target="_blank" title="https://www.xfyun.cn/doc/spark/Web.html" ref="nofollow noopener noreferrer">www.xfyun.cn/doc/spark/W…</a></td></tr><tr><td><strong>智谱AI (ChatGLM)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.bigmodel.cn%2Fdev%2Fapi" target="_blank" title="https://open.bigmodel.cn/dev/api" ref="nofollow noopener noreferrer">open.bigmodel.cn/dev/api</a></td></tr><tr><td><strong>月之暗面 (Kimi)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.moonshot.cn%2Fdocs" target="_blank" title="https://platform.moonshot.cn/docs" ref="nofollow noopener noreferrer">platform.moonshot.cn/docs</a></td></tr><tr><td><strong>DeepSeek</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi-docs.deepseek.com%2Fzh-cn%2F" target="_blank" title="https://api-docs.deepseek.com/zh-cn/" ref="nofollow noopener noreferrer">api-docs.deepseek.com/zh-cn/</a></td></tr><tr><td><strong>字节跳动 (豆包)</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.volcengine.com%2Fdocs%2F82379" target="_blank" title="https://www.volcengine.com/docs/82379" ref="nofollow noopener noreferrer">www.volcengine.com/docs/82379</a></td></tr></tbody></table>
<h4 data-id="heading-3">二：AI是学习好伙伴</h4>
<p>AI是学习好伙伴，但是你要有一个基础判断，什么内容相信AI，什么内容需要验证。</p>
<p>记住两件事：<strong>一定要使用AI来学习</strong>、<strong>一定不能全部相信AI内容</strong></p>
<p>我的经验是，通用的、概念性的内容，在我没有产生疑问之前，我默认选择相信AI。</p>
<p>例如：<code>深度学习和机器学习的对比</code>、<code>function call的概念</code>、<code>微调时选择SFT和DPO的区别</code></p>
<p>这类内容，AI的输出大概率都是对的。</p>
<p>而在应用方案上的内容，我通常以AI的输出作为参考，需要加以验证。</p>
<h4 data-id="heading-4">三：提取方法论</h4>
<p>学习一定要实践，现在有AI来协助编程，编写一些基础的代码来配合自己进行学习是很方便的。</p>
<p>例如，可以直接把某个文档扔给AI，告诉AI按照这个文档帮我写一份python代码，并指导我运行。</p>
<p>通常你都会得到一份可用的代码。</p>
<p>当我们学习、实践了之后，我们要做的就是总结经验，提取方法论，优化方法论。</p>
<p>当各位有了自己的方法论之后，这份思维导图也就完成了它的价值。</p>
<p>未来的修行全靠各位自己了。</p>
<h2 data-id="heading-5">关于后续规划</h2>
<p>目前这份万字思维导图已经公开，但是我后续将不再继续维护这份思维导图了，原因有两点：</p>
<p><strong>1.  对于学习者来说，学习路径已经足够清晰了。</strong></p>
<p>对于学习者来说，这份思维导图已经足够清晰，大家按照思维导图去学习、去思考。</p>
<p>花上一些时间去学习，这份思维导图可以保证你的学习路径不会出错。</p>
<p>坚持学完之后，足够掌握工作所需的全部技能了。</p>
<p><strong>2.  对于我来说，时间投入太多了。</strong></p>
<p>这份思维导图维护了半年多，逐渐积累到目前的一万字，期间也接了很多同学的1V1培训，说实话，已经有点忙不过来了。</p>
<p>但是我还是打算开一份新的思维导图进行持续维护。</p>
<p>新的思维导图继续扩展下去，将是不间断的对现有知识体系的细化和对新技术、新方案的补充。</p>
<p>未来将我这几年的实战、学习、思考全部都写进去，所以这不是一份单纯的思维导图，而是一套与AI相关落地相关的全面的方案。</p>
<p>为了保证我的动力，以及学习者的纯粹性（防止广告等行为）， 这个会有一个较低的门槛。</p>
<p>我是华洛，关注我，学习更多AI落地的实战经验与技巧。</p>
<p>加油，共勉。</p>
<blockquote>
<p>☺️你好，我是<strong>华洛</strong>，All in AI多年，专注于AI在产品侧的应用以及企业AI员工的设计。</p>
</blockquote>
<h2 data-id="heading-6">专栏文章</h2>
<p><a href="https://juejin.cn/post/7512332419203727371" target="_blank" title="https://juejin.cn/post/7512332419203727371"># 聊聊我们公司的AI应用工程师每天都干啥？</a></p>
<p><a href="https://juejin.cn/post/7547051639740743721" target="_blank" title="https://juejin.cn/post/7547051639740743721"># SEO还没死，GEO之战已经开始</a></p>
<p><a href="https://juejin.cn/post/7497890801348821055" title="https://juejin.cn/post/7497890801348821055" target="_blank"># 从0到1打造企业级AI售前机器人——实战指南二：RAG工程落地之数据处理篇🧐</a></p>
<p><a href="https://juejin.cn/post/7496397558358900790" title="https://juejin.cn/post/7496397558358900790" target="_blank"># 从0到1打造企业级AI售前机器人——实战指南一：根据产品需求和定位进行agent流程设计🧐</a></p>
<p><a href="https://juejin.cn/post/7492271537010671635" title="https://juejin.cn/post/7492271537010671635" target="_blank"># 聊一下MCP，希望能让各位清醒一点吧🧐</a></p>
<p><a href="https://juejin.cn/post/7485727472999579659" title="https://juejin.cn/post/7485727472999579659" target="_blank"># 实战派！百万PV的AI产品如何搭建RAG系统？</a></p>
<p><a href="https://juejin.cn/post/7482695183477047315" title="https://juejin.cn/post/7482695183477047315" target="_blank"># 团队落地AI产品的全流程</a></p>
<p><a href="https://juejin.cn/post/7474925725662969883" title="https://juejin.cn/post/7474925725662969883" target="_blank"># 5000字长文，AI时代下程序员的巨大优势！</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Fiber 双缓存架构与 Diff 算法]]></title>    <link>https://juejin.cn/post/7583234966634823714</link>    <guid>https://juejin.cn/post/7583234966634823714</guid>    <pubDate>2025-12-14T11:43:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583234966634823714" data-draft-id="7583325900293668864" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Fiber 双缓存架构与 Diff 算法"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-14T11:43:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="day1"/> <meta itemprop="url" content="https://juejin.cn/user/4310544201823182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Fiber 双缓存架构与 Diff 算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4310544201823182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    day1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T11:43:10.000Z" title="Sun Dec 14 2025 11:43:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言</h2>
<h3 data-id="heading-1">1.1 传统栈协调的局限</h3>
<p>在 React 16 之前的版本中，React 的协调器（Reconciler）采用了一种基于递归遍历组件树的机制，通常称之为“栈协调”（Stack Reconciler）。这种机制在处理组件更新时，会从根组件开始，自上而下地递归调用每个组件的 <code>render</code> 方法，并对比新旧虚拟 DOM 树的差异。</p>
<p>以下是一个简化的 React 15 协调过程示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// React 15 的简化协调过程</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileChildren</span>(<span class="hljs-params">currentFiber, newChildren</span>) {
  <span class="hljs-comment">// 递归处理所有子节点</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; newChildren.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> child = newChildren[i];
    <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">createFiber</span>(child);

    <span class="hljs-comment">// 递归调用，无法中断</span>
    <span class="hljs-title function_">reconcileChildren</span>(newFiber, child.<span class="hljs-property">children</span>);

    <span class="hljs-comment">// 立即应用DOM变更</span>
    <span class="hljs-title function_">commitWork</span>(newFiber);
  }
}
</code></pre>
<p>这种递归架构存在以下根本性问题：</p>
<ol>
<li>
<p><strong>调用栈的不可控性</strong>：递归调用会在 JavaScript 调用栈中生成大量栈帧，每个栈帧包含函数的局部变量和执行上下文。在处理大型组件树时，这不仅可能导致栈溢出，更关键的是，一旦递归过程启动，便无法中途暂停或中断，必须一次性完成。</p>
</li>
<li>
<p><strong>主线程阻塞的严重性</strong>：由于 JavaScript 的单线程特性，当 React 执行大量协调工作时，主线程会被完全占用。这意味着浏览器无法及时响应用户交互、执行动画或处理其他高优先级任务，从而导致用户界面出现卡顿和响应延迟，严重损害用户体验。</p>
</li>
<li>
<p><strong>优先级处理的缺失</strong>：在传统的递归架构中，所有更新都被视为同等重要。系统无法区分紧急的用户输入事件（如点击、输入）与非紧急的数据获取或后台更新。这可能导致一个耗时较长的低优先级更新任务阻塞了高优先级、需要即时响应的用户操作。</p>
</li>
</ol>
<h3 data-id="heading-2">1.2 Fiber 架构介绍</h3>
<p>eact 16 引入了全新的协调器（Reconciler），即 <strong>Fiber Reconciler</strong>，它基于 <strong>Fiber 节点</strong>实现。Fiber 节点是 React Fiber 架构的核心，它在概念上扮演着双重角色：</p>
<ol>
<li><strong>作为静态数据结构</strong>：每个 Fiber 节点对应一个 React element，它存储了组件的关键信息，例如组件的类型（函数组件、类组件、原生 DOM 组件等）、对应的 DOM 节点引用，以及与父节点、子节点和兄弟节点的关系。</li>
<li><strong>作为动态工作单元</strong>：在组件更新过程中，每个 Fiber 节点会记录本次更新中组件状态的变化、需要执行的具体工作（例如组件需要被删除、插入到 DOM 中，或者仅仅是更新属性等）。</li>
</ol>
<p>React Fiber 架构的主要目标是显著提升 React 在动画、布局和手势等场景下的表现力与用户体验。其核心的特性是：</p>
<ol>
<li><strong>时间切片</strong>：这意味着 React 能够将复杂的渲染工作拆解成更小的、可管理的工作单元，并在多个浏览器帧之间分批执行，从而避免长时间阻塞主线程。</li>
<li><strong>可中断与可恢复</strong>：当有新的、更高优先级的更新请求时，React 能够暂停当前正在进行的工作，转而处理紧急任务，并在主线程空闲时恢复之前的工作。</li>
<li><strong>优先级调度</strong>：能够为不同类型的更新任务分配不同的优先级，确保用户交互等高优先级任务能够得到及时响应，而低优先级任务则可以在后台或空闲时段执行。</li>
</ol>
<h3 data-id="heading-3">1.3 双缓存与 Diff 优化的关系</h3>
<p>React Fiber 架构中，双缓存机制与 Diff 算法优化是实现高效、可中断渲染的核心支柱。</p>
<h4 data-id="heading-4">1.3.1 双缓存机制</h4>
<p>Fiber 架构通过 “Current 树”（对应当前屏幕 UI、与 DOM 同步）和 “WorkInProgress 树”（后台构建的待更新 UI）实现双缓存：更新时在 WorkInProgress 树处理，构建完成后与 Current 树交换并提交 DOM，确保 UI 一致性，同时支持渲染中断与恢复，避免中间状态闪烁。</p>
<h4 data-id="heading-5">1.3.2 Diff 算法优化</h4>
<p>Fiber 中的 Diff 算法聚焦 “高效找差异”：按层级比较节点，类型不同则直接替换；类型相同则对比属性，结合 key 识别列表节点的增 / 删 / 移，只更新变化部分，最小化 DOM 操作。</p>
<h4 data-id="heading-6">1.3.3 双缓存与 Diff 的协同作用</h4>
<p>双缓存机制为 Diff 算法提供了一个沙盒环境。所有的 Diff 计算都在 WorkInProgress Fiber Tree 上进行，不会影响到当前屏幕上显示的 Current Fiber Tree。这使得 Diff 过程可以被中断，并且可以在后台进行，从而避免阻塞主线程。</p>
<p>当 Diff 算法在 WorkInProgress Fiber Tree 上完成所有计算后，它会生成一个副作用列表（Effect List），其中包含了所有需要对真实 DOM 进行的操作（如插入、更新、删除等）。在提交阶段，React 会遍历这个副作用列表，一次性地将所有变更应用到真实 DOM 上。</p>
<h2 data-id="heading-7">2. Fiber 节点的数据结构设计</h2>
<h3 data-id="heading-8">2.1 Fiber 节点的核心属性</h3>
<p>在 React 中，<code>Fiber</code> 节点是并发模式的核心数据结构。它是一个纯粹的 JavaScript 对象，包含了组件、DOM 节点或其他工作单元所需的所有信息。React 在协调（Reconciliation）阶段遍历 Fiber 树，为每个节点计算出需要执行的工作。</p>
<p>下面是 <code>Fiber</code> 类型定义中的一些核心属性，我们将其按照功能进行分类：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> type <span class="hljs-title class_">Fiber</span> = {
  <span class="hljs-comment">// --- 身份标识 ---</span>
  <span class="hljs-comment">// 识别 Fiber 的类型，如 FunctionComponent, ClassComponent, HostComponent (DOM元素)</span>
  <span class="hljs-attr">tag</span>: <span class="hljs-title class_">WorkTag</span>,
  <span class="hljs-comment">// React 元素上的 key 属性，用于优化同级节点的 Diff 算法</span>
  <span class="hljs-attr">key</span>: <span class="hljs-literal">null</span> | string,
  <span class="hljs-comment">// 元素的类型，通常是 React.createElement 的第一个参数，用于在协调期间保持身份</span>
  <span class="hljs-attr">elementType</span>: any,
  <span class="hljs-comment">// 与此 Fiber 关联的已解析的函数/类/标签名</span>
  <span class="hljs-attr">type</span>: any,

  <span class="hljs-comment">// --- 树结构关系 ---</span>
  <span class="hljs-comment">// 指向父级 Fiber 节点，处理完当前节点后，会返回到这个节点</span>
  <span class="hljs-attr">return</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>,
  <span class="hljs-comment">// 指向第一个子 Fiber 节点</span>
  <span class="hljs-attr">child</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>,
  <span class="hljs-comment">// 指向下一个兄弟 Fiber 节点</span>
  <span class="hljs-attr">sibling</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>,

  <span class="hljs-comment">// --- 状态与数据 ---</span>
  <span class="hljs-comment">// 即将应用到组件的新 props</span>
  <span class="hljs-attr">pendingProps</span>: any,
  <span class="hljs-comment">// 上一次渲染时使用的 props</span>
  <span class="hljs-attr">memoizedProps</span>: any,
  <span class="hljs-comment">// 存储 state 更新、回调函数等的队列</span>
  <span class="hljs-attr">updateQueue</span>: mixed,
  <span class="hljs-comment">// 上一次渲染时使用的 state</span>
  <span class="hljs-attr">memoizedState</span>: any,
  <span class="hljs-comment">// 描述此 Fiber 依赖的上下文（Contexts）或事件</span>
  <span class="hljs-attr">dependencies</span>: <span class="hljs-title class_">Dependencies</span> | <span class="hljs-literal">null</span>,

  <span class="hljs-comment">// --- 副作用（Effects）---</span>
  <span class="hljs-comment">// 描述需要对此 Fiber 执行的 DOM 操作或其他副作用，如 Placement, Update, Deletion</span>
  <span class="hljs-attr">flags</span>: <span class="hljs-title class_">Flags</span>,
  <span class="hljs-comment">// 子树中所有 Fiber 节点的 `flags` 的集合，用于快速跳过没有副作用的子树</span>
  <span class="hljs-attr">subtreeFlags</span>: <span class="hljs-title class_">Flags</span>,
  <span class="hljs-comment">// 在 commit 阶段需要删除的子 Fiber 节点数组</span>
  <span class="hljs-attr">deletions</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Fiber</span>&gt; | <span class="hljs-literal">null</span>,

  <span class="hljs-comment">// --- 调度（Scheduling）---</span>
  <span class="hljs-comment">// 代表此 Fiber 节点上待处理工作的优先级</span>
  <span class="hljs-attr">lanes</span>: <span class="hljs-title class_">Lanes</span>,
  <span class="hljs-comment">// 子树中待处理工作的优先级集合</span>
  <span class="hljs-attr">childLanes</span>: <span class="hljs-title class_">Lanes</span>,

  <span class="hljs-comment">// --- 双缓冲（Double Buffering）---</span>
  <span class="hljs-comment">// 指向 work-in-progress 树或 current 树中对应的另一个 Fiber 节点</span>
  <span class="hljs-attr">alternate</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>,

  <span class="hljs-comment">// --- 链接实例 ---</span>
  <span class="hljs-comment">// 指向与此 Fiber 关联的本地状态实例，如组件实例、DOM 节点等</span>
  <span class="hljs-attr">stateNode</span>: any,
};
</code></pre>
<ol>
<li><strong><code>tag</code></strong>: 这个属性是 Fiber 节点最重要的标识之一，它决定了 Fiber 节点的类型，例如：</li>
</ol>
<ul>
<li><code>FunctionComponent</code>: 函数组件</li>
<li><code>ClassComponent</code>: 类组件</li>
<li><code>HostRoot</code>: 根 Fiber 节点</li>
<li><code>HostComponent</code>: 原生 DOM 元素（如 <code>&lt;div&gt;</code>、<code>&lt;span&gt;</code>）</li>
<li><code>HostText</code>: 文本节点</li>
<li><code>SuspenseComponent</code>: Suspense 组件</li>
<li><code>ContextProvider</code>: Context 提供者</li>
<li><code>ContextConsumer</code>: Context 消费者
通过 <code>tag</code> 属性，React 能够根据不同类型的组件执行不同的协调逻辑。</li>
</ul>
<ol start="2">
<li><strong><code>elementType</code> 和 <code>type</code></strong>:</li>
</ol>
<ul>
<li><code>elementType</code> 是 <code>React.createElement</code> 的第一个参数，它可能是函数、类或字符串。</li>
<li><code>type</code> 是 <code>elementType</code> 经过解析后的实际组件类型。对于函数组件，<code>elementType</code> 和 <code>type</code> 都是函数本身；对于类组件，它们都是类本身；对于原生 DOM 元素，<code>elementType</code> 和 <code>type</code> 都是字符串（如 <code>'div'</code>）。</li>
</ul>
<ol start="3">
<li>
<p><strong><code>stateNode</code></strong>: 这个属性存储了与 Fiber 节点关联的实例。对于类组件，<code>stateNode</code> 指向组件的实例；对于原生 DOM 元素，<code>stateNode</code> 指向真实的 DOM 节点；对于函数组件，<code>stateNode</code> 通常为 <code>null</code>。</p>
</li>
<li>
<p><strong><code>flags</code> 和 <code>subtreeFlags</code></strong>: 这些是位掩码，用于标记 Fiber 节点需要执行的副作用。</p>
</li>
</ol>
<ul>
<li><code>flags</code> 标记当前 Fiber 节点自身的副作用。</li>
<li><code>subtreeFlags</code> 标记当前 Fiber 节点及其子树中所有 Fiber 节点需要执行的副作用。
这些副作用包括 DOM 插入、更新、删除、生命周期方法的调用等。React 在提交阶段会根据这些 <code>flags</code> 来执行相应的操作。</li>
</ul>
<ol start="5">
<li>
<p><strong><code>alternate</code></strong>: 这是双缓存机制的核心属性。每个 Fiber 节点都有一个 <code>alternate</code> 属性，指向它的替身 Fiber 节点。在更新过程中，React 会在 <code>workInProgress</code> 树上构建新的 Fiber 节点，并通过 <code>alternate</code> 属性与 <code>current</code> 树上的旧 Fiber 节点关联。当 <code>workInProgress</code> 树构建完成后，<code>current</code> 树和 <code>workInProgress</code> 树会进行切换，从而实现 UI 的原子更新。</p>
</li>
<li>
<p><strong><code>return</code>、<code>child</code>、<code>sibling</code></strong>: 这三个属性构成了 Fiber 树的结构：</p>
</li>
</ol>
<ul>
<li><code>return</code> 指向父 Fiber 节点。</li>
<li><code>child</code> 指向第一个子 Fiber 节点。</li>
<li><code>sibling</code> 指向下一个兄弟 Fiber 节点。
通过这三个指针，React 可以在 Fiber 树中进行遍历，实现深度优先遍历（DFS）的工作方式。</li>
</ul>
<h3 data-id="heading-9">2.2 树形结构的链表实现</h3>
<p>Fiber 架构采用了一种巧妙的数据结构设计：使用链表来表示树形结构。这种设计使得树的遍历变得更加灵活和高效。</p>
<p>每个 Fiber 节点都包含了以下三个核心指针，它们共同构建了 Fiber 树的链表结构：</p>
<ol>
<li><strong><code>child</code> 指针</strong>：指向当前 Fiber 节点的<strong>第一个子节点</strong>。如果一个节点有多个子节点，<code>child</code> 指针会指向它的最左侧子节点。</li>
<li><strong><code>sibling</code> 指针</strong>：指向当前 Fiber 节点的<strong>下一个兄弟节点</strong>。通过 <code>child</code> 和 <code>sibling</code> 指针，可以遍历一个父节点下的所有子节点。</li>
<li><strong><code>return</code> 指针</strong>：指向当前 Fiber 节点的<strong>父节点</strong>。这个指针在工作循环中至关重要，它允许 React 在处理完一个子树后，能够“返回”到其父节点继续处理或向上冒泡。</li>
</ol>
<p><strong>这种链表实现的优势：</strong></p>
<ol>
<li><strong>高效的遍历</strong>：通过 <code>child</code> 和 <code>sibling</code> 指针，React 可以进行深度优先遍历（DFS），这与传统的递归遍历类似，但避免了 JavaScript 调用栈的限制。</li>
<li><strong>灵活的修改</strong>：当组件树发生变化时（例如，添加、删除或移动节点），React 只需要修改少数几个指针，而无需重新构建整个树。这大大提高了更新的效率。</li>
<li><strong>支持可中断渲染</strong>：<code>return</code> 指针使得 React 可以在处理完一个 Fiber 节点后，随时暂停工作，并在需要时从中断的地方恢复。当一个工作单元完成时，React 可以通过 <code>return</code> 指针向上回溯，找到下一个需要处理的节点，而无需依赖调用栈。</li>
</ol>
<h2 data-id="heading-10">3. Fiber 双缓存架构</h2>
<h3 data-id="heading-11">3.1 双缓存的核心概念</h3>
<p>双缓存（Double Buffering）是计算机图形学中的一个经典概念，React 将这个概念引入到虚拟 DOM 的管理中，创造了一种优雅的状态管理方案。</p>
<p>在计算机图形学中，双缓存通常用于解决画面撕裂（tearing）和闪烁（flickering）问题。它通过维护两个缓冲区来实现：一个用于显示（front buffer），另一个用于在后台绘制（back buffer）。当后台缓冲区绘制完成后，两个缓冲区会进行快速交换，从而在屏幕上呈现一个完整且平滑的画面。</p>
<p>React Fiber 架构借鉴了这一思想，将“双缓存”应用于其内部的 Fiber 树管理。它维护了两棵 Fiber 树：</p>
<ol>
<li><strong>Current Fiber Tree (当前 Fiber 树)</strong>：这棵树代表了当前屏幕上已经渲染的 UI 状态。它与真实的 DOM 保持同步，用户所见即是这棵树的反映。</li>
<li><strong>WorkInProgress Fiber Tree (工作中的 Fiber 树)</strong>：这棵树是在后台构建的，用于表示即将更新的 UI 结构。所有的更新操作（如状态变更、属性更新、组件挂载/卸载等）都会在这棵树上进行。</li>
</ol>
<p>当有更新发生时，React 不会直接修改 Current Fiber Tree，而是在 WorkInProgress Fiber Tree 上进行所有的协调和渲染工作。这个过程是可中断的，意味着 React 可以在浏览器空闲时暂停工作，并在需要时恢复。一旦 WorkInProgress Fiber Tree 构建完成，并且所有的更新都已计算完毕，它就会在提交阶段（Commit Phase）与 Current Fiber Tree 进行交换，新的 WorkInProgress Fiber Tree 成为 Current Fiber Tree，并最终反映到真实的 DOM 上。</p>
<h3 data-id="heading-12">3.2 双缓存的存储结构</h3>
<h4 data-id="heading-13">3.2.1 FiberRootNode 与 HostRootFiber</h4>
<p>整个 React 应用的根节点是一个 <code>FiberRootNode</code> 对象。这个对象是整个应用的入口，它包含了指向当前渲染的 Fiber 树的引用。在 <code>FiberRootNode</code> 内部，有一个关键的属性 <code>current</code>，它始终指向当前屏幕上显示的 <strong>Current Fiber Tree</strong> 的根 Fiber 节点，这个根 Fiber 节点通常被称为 <code>HostRootFiber</code>。
<code>HostRootFiber</code> 是整个 Fiber 树的起点，它代表了 React 应用挂载的真实 DOM 容器（例如 <code>&lt;div id="root"&gt;&lt;/div&gt;</code>）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FiberRootNode</span>(<span class="hljs-params">containerInfo, tag, hydrate</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerInfo</span> = containerInfo;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingChildren</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 指向当前渲染的 Fiber 树的根节点</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pingCache</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">finishedWork</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeoutHandle</span> = -<span class="hljs-number">1</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingContext</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hydrate</span> = hydrate;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">NoLane</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventTimes</span> = <span class="hljs-title function_">createLaneMap</span>(<span class="hljs-title class_">NoLanes</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">expirationTimes</span> = <span class="hljs-title function_">createLaneMap</span>(<span class="hljs-title class_">NoTimestamp</span>);

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">suspendedLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pingedLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">expiredLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mutableReadLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">finishedLanes</span> = <span class="hljs-title class_">NoLanes</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">entangledLanes</span> = <span class="hljs-title class_">NoLanes</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">entanglements</span> = <span class="hljs-title function_">createLaneMap</span>(<span class="hljs-title class_">NoLanes</span>);
}
</code></pre>
<h4 data-id="heading-14">3.2.2 Current Fiber Tree 与 WorkInProgress Fiber Tree 的关联</h4>
<p>每个 Fiber 节点都有一个 <code>alternate</code> 属性。这个 <code>alternate</code> 属性是连接 Current Fiber Tree 和 WorkInProgress Fiber Tree 的关键。</p>
<ul>
<li>在 <strong>Current Fiber Tree</strong> 中的每个 Fiber 节点，其 <code>alternate</code> 属性会指向 <strong>WorkInProgress Fiber Tree</strong> 中对应的 Fiber 节点。</li>
<li>反之，在 <strong>WorkInProgress Fiber Tree</strong> 中的每个 Fiber 节点，其 <code>alternate</code> 属性会指向 <strong>Current Fiber Tree</strong> 中对应的 Fiber 节点。</li>
</ul>
<p>这种双向引用使得 React 可以在更新过程中，轻松地在两棵树之间切换和查找对应的节点。当 React 开始构建 WorkInProgress Fiber Tree 时，它会从 Current Fiber Tree 的根节点开始，为每个 Fiber 节点创建或复用一个 <code>alternate</code> 节点，并将其作为 WorkInProgress Fiber Tree 的一部分。</p>
<h4 data-id="heading-15">3.2.3 树的切换</h4>
<p>当 WorkInProgress Fiber Tree 构建完成，并且所有的更新都已准备好提交时，React 会执行一个非常简单的操作：它会将 <code>FiberRootNode</code> 的 <code>current</code> 属性从指向旧的 Current Fiber Tree 的根节点，切换为指向新的 WorkInProgress Fiber Tree 的根节点。</p>
<p>这个切换操作是原子性的，意味着它会在一个瞬间完成。一旦切换完成，新的 WorkInProgress Fiber Tree 就成为了新的 Current Fiber Tree，并立即反映到屏幕上。旧的 Current Fiber Tree 则会被废弃，等待垃圾回收机制进行清理。</p>
<h4 data-id="heading-16">3.2.4 存储结构的优势</h4>
<p>这种存储结构带来了以下几个显著优势：</p>
<ol>
<li><strong>高效的切换：</strong> 通过简单地修改 <code>FiberRootNode.current</code> 的指向，React 可以在 O(1) 的时间复杂度内完成新旧树的切换，保证了 UI 更新的平滑性。</li>
<li><strong>内存复用：</strong> 在构建 WorkInProgress Fiber Tree 时，React 会尽可能地复用 Current Fiber Tree 中的 Fiber 节点。如果一个组件在更新前后没有发生变化，React 就会直接克隆旧的 Fiber 节点，而不是重新创建，从而节省了内存开销。</li>
<li><strong>可中断性：</strong> 由于 WorkInProgress Fiber Tree 是在后台构建的，即使构建过程被中断，也不会影响到当前屏幕上显示的 UI。当 React 恢复工作时，它可以继续在 WorkInProgress Fiber Tree 上进行操作。</li>
</ol>
<p>通过 <code>FiberRootNode</code>、<code>HostRootFiber</code> 和 <code>alternate</code> 属性的设计，React Fiber 架构实现了高效、平滑且可中断的双缓存机制。</p>
<h3 data-id="heading-17">3.3 双缓存的工作流程</h3>
<h4 data-id="heading-18">3.3.1 渲染/协调阶段</h4>
<p>这个阶段的主要任务是构建 <strong>WorkInProgress Fiber Tree</strong>，并找出需要对真实 DOM 进行的所有变更。这个阶段是可中断的，意味着 React 可以在任何时候暂停工作，并在稍后恢复。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoopConcurrent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">while</span> (workInProgress !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-title function_">shouldYield</span>()) {
    workInProgress = <span class="hljs-title function_">performUnitOfWork</span>(workInProgress);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">unitOfWork: Fiber</span>): <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">const</span> current = unitOfWork.<span class="hljs-property">alternate</span>;
  <span class="hljs-keyword">let</span> next;

  <span class="hljs-comment">// 执行当前工作单元的协调逻辑</span>
  next = <span class="hljs-title function_">beginWork</span>(current, unitOfWork, renderLanes);

  <span class="hljs-comment">// 处理副作用标记</span>
  <span class="hljs-keyword">if</span> (next === <span class="hljs-literal">null</span>) {
    next = <span class="hljs-title function_">completeUnitOfWork</span>(unitOfWork);
  }

  <span class="hljs-comment">// 优先级检查：如果存在更高优先级任务则中断</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldYieldToHost</span>()) {
    <span class="hljs-keyword">return</span> unitOfWork;
  }

  <span class="hljs-keyword">return</span> next;
}
</code></pre>
<ol>
<li><strong>从根节点开始遍历</strong>：React 从 <code>HostRootFiber</code>（即 <code>FiberRootNode.current</code> 指向的根 Fiber 节点）开始，深度优先遍历 Current Fiber Tree。</li>
<li><strong>创建或复用 WorkInProgress Fiber</strong>：对于 Current Fiber Tree 中的每个 Fiber 节点，React 会检查它是否需要更新。
<ul>
<li>如果需要更新，React 会创建一个新的 WorkInProgress Fiber 节点，并将其 <code>alternate</code> 属性指向对应的 Current Fiber 节点。</li>
<li>如果不需要更新，React 会直接克隆 Current Fiber 节点，并将其作为 WorkInProgress Fiber 节点。</li>
<li>这个过程中，<code>alternate</code> 属性起到了关键的连接作用，使得两棵树的节点能够相互引用。</li>
</ul>
</li>
<li><strong>执行更新工作</strong>：在 WorkInProgress Fiber 节点上，React 会执行组件的 <code>render</code> 方法（对于函数组件，就是执行函数体），计算新的 props 和 state，并与旧的 props 和 state 进行比较（Diff 算法）。</li>
<li><strong>标记副作用</strong>：如果发现有任何需要对真实 DOM 进行的操作（例如，属性变更、文本内容更新、节点插入、移动或删除），React 会在 WorkInProgress Fiber 节点上标记一个“副作用”（Effect Tag），并将其添加到副作用列表中。</li>
<li><strong>可中断性</strong>：这个阶段是可中断的。React 会根据当前帧的剩余时间（time slice）和任务的优先级来决定是否继续工作。如果时间不足或有更高优先级的任务到来，React 会暂停当前工作，将控制权交还给浏览器，并在下次空闲时恢复。</li>
</ol>
<h4 data-id="heading-19">3.3.2 提交阶段</h4>
<p>一旦渲染/协调阶段完成，并且 WorkInProgress Fiber Tree 构建完毕，所有的副作用都被标记并收集起来，React 就会进入提交阶段。这个阶段是不可中断的，必须一次性完成，以确保 UI 的一致性。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params">root: FiberRoot</span>) {
  <span class="hljs-keyword">const</span> finishedWork = root.<span class="hljs-property">finishedWork</span>;

  <span class="hljs-comment">// 提交前检查：确保没有未处理的高优先级任务</span>
  <span class="hljs-keyword">if</span> (shouldFlushSync) {
    <span class="hljs-title function_">flushSyncCallbacks</span>();
  }

  <span class="hljs-comment">// 执行 DOM 更新和副作用</span>
  <span class="hljs-title function_">commitRootImpl</span>(root, finishedWork);

  <span class="hljs-comment">// 切换 Fiber 树（原子操作）</span>
  root.<span class="hljs-property">current</span> = finishedWork;

  <span class="hljs-comment">// 清理工作</span>
  root.<span class="hljs-property">finishedWork</span> = <span class="hljs-literal">null</span>;
}
</code></pre>
<ol>
<li><strong>切换 Fiber 树</strong>：React 会将 <code>FiberRootNode</code> 的 <code>current</code> 属性从指向旧的 Current Fiber Tree 切换为指向新的 WorkInProgress Fiber Tree。此时，新的 WorkInProgress Fiber Tree 就成为了新的 Current Fiber Tree。</li>
<li><strong>执行副作用</strong>：React 遍历副作用列表，并根据每个副作用的类型，一次性地将所有变更应用到真实的 DOM 上。这包括：
<ul>
<li><strong>DOM 更新</strong>：修改元素的属性、文本内容等。</li>
<li><strong>DOM 插入/删除/移动</strong>：将新的 DOM 节点插入到文档中，或从文档中删除/移动旧的 DOM 节点。</li>
<li><strong>生命周期方法/Hooks</strong>：执行组件的 <code>componentDidMount</code>、<code>componentDidUpdate</code>、<code>componentWillUnmount</code> 等生命周期方法，以及 <code>useEffect</code> 等 Hooks 的回调函数。</li>
</ul>
</li>
<li><strong>完成更新</strong>：提交阶段完成后，用户在屏幕上看到的就是最新的 UI 界面。旧的 Current Fiber Tree（现在是 WorkInProgress Fiber Tree 的 <code>alternate</code>）会被标记为“旧树”，等待垃圾回收。</li>
</ol>
<p>通过这两个阶段的协同工作，双缓存机制使得 React 能够在后台“悄悄地”准备好新的 UI，然后在一个瞬间将其呈现在用户面前，从而实现了平滑、高效且响应迅速的用户体验。</p>
<h2 data-id="heading-20">4. Fiber Diff 算法</h2>
<h3 data-id="heading-21">4.1 Fiber Diff 与传统 Diff 的差异</h3>
<h4 data-id="heading-22">4.3.1 传统 Diff 算法的局限性</h4>
<p>在 React 15 及之前的版本中，协调、过程是同步进行的。这意味着一旦更新开始，它就会一口气遍历整个组件树，计算出所有需要进行的 DOM 操作，然后一次性提交到浏览器。这种“一气呵成”的模式在组件树较小或更新频率较低时表现良好，但当组件树变得庞大或更新频繁时，就可能导致以下问题：</p>
<ol>
<li><strong>阻塞主线程</strong>：同步的协调过程会长时间占用 JavaScript 主线程，导致浏览器无法响应用户输入（如点击、滚动），从而出现页面卡顿、无响应的“掉帧”现象。</li>
<li><strong>无法中断与恢复</strong>：由于是同步执行，一旦开始就无法暂停或中断，这使得优先级更高的任务（如用户输入）无法及时得到处理。</li>
<li><strong>难以实现优先级调度</strong>：所有更新都被视为同等重要，无法根据任务的紧急程度进行区分和调度。</li>
</ol>
<h4 data-id="heading-23">4.3.2 源码中的体现</h4>
<p><code>reconcileChildFibers</code> 是 Fiber Diff 算法的核心，负责对比新旧子节点，生成 Fiber 节点及 DOM 操作副作用（插入、更新、删除等）。
以特殊函数 <code>forceUnmountCurrentAndReconcile</code>为例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">forceUnmountCurrentAndReconcile</span>(<span class="hljs-params">
  current: Fiber,
  workInProgress: Fiber,
  nextChildren: any,
  renderLanes: Lanes
</span>) {
  <span class="hljs-comment">// 第一次调用：传入 null 触发所有旧子节点的删除</span>
  workInProgress.<span class="hljs-property">child</span> = <span class="hljs-title function_">reconcileChildFibers</span>(
    workInProgress,
    current.<span class="hljs-property">child</span>,
    <span class="hljs-literal">null</span>,
    renderLanes
  );
  <span class="hljs-comment">// 第二次调用：传入 null 跳过旧节点匹配，直接创建新子节点</span>
  workInProgress.<span class="hljs-property">child</span> = <span class="hljs-title function_">reconcileChildFibers</span>(
    workInProgress,
    <span class="hljs-literal">null</span>,
    nextChildren,
    renderLanes
  );
}
</code></pre>
<p>该函数虽为 “强制卸载并重建子树” 的特殊场景，却体现了 Fiber 架构的核心优势（相比传统 Diff）</p>
<ol>
<li>可中断的协调过程： Fiber 将工作拆分为 Fiber 节点级别的单元，即使是两次 reconcileChildFibers 调用，也可在处理过程中暂停并交还浏览器控制权，避免长时间阻塞；而传统 Diff 需同步完成整个操作，期间浏览器无响应。</li>
<li>优先级调度支持： reconcileChildFibers 兼容优先级机制，即使执行重置操作，仍可被高优任务（如用户输入）中断；传统 Diff 无法区分优先级，只能按顺序执行。</li>
<li>细粒度副作用管理：即使是 “强制重建”，也通过生成精确的 “删除旧节点 + 插入新节点” 副作用实现，而非粗暴清空 DOM；传统 Diff 易产生多余 DOM 操作，缺乏这种精细化控制。</li>
</ol>
<h3 data-id="heading-24">4.2 单节点 Diff 逻辑</h3>
<h4 data-id="heading-25">4.2.1 单节点 Diff 的核心逻辑</h4>
<ol>
<li>
<p>如果新旧节点的 key 不同，React 会直接销毁旧节点及其子树，并创建新节点及其子树。key 的作用是帮助 React 识别列表中的唯一元素，当 key 改变时，意味着元素本身发生了变化。</p>
</li>
<li>
<p>key 相同，但 类型 不同：如果新旧节点的 key 相同，但 type 不同，React 也会销毁旧节点，并创建新节点。例如，一个 </p><p> 标签变为 </p><div> 标签。<p/>
</div></li>
<li>
<p>类型和 key 都相同：这是最理想的情况。React 会复用旧的 Fiber 节点，并继续比较它们的属性（props）。如果属性有变化，React 会标记该节点需要更新，并继续递归比较其子节点。</p>
</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileSingleElement</span>(<span class="hljs-params">
  returnFiber: Fiber, <span class="hljs-comment">// 父 Fiber 节点</span>
  currentFirstChild: Fiber | <span class="hljs-literal">null</span>, <span class="hljs-comment">// 当前旧的第一个子 Fiber 节点</span>
  element: ReactElement, <span class="hljs-comment">// 新的 React 元素，表示即将渲染的子组件</span>
  lanes: Lanes <span class="hljs-comment">// 优先级相关</span>
</span>) {
  <span class="hljs-keyword">const</span> key = element.<span class="hljs-property">key</span>; <span class="hljs-comment">// 取新节点的key</span>
  <span class="hljs-keyword">let</span> child = currentFirstChild;
  <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (child.<span class="hljs-property">key</span> === key) {
      <span class="hljs-comment">// 第一步：匹配key</span>
      <span class="hljs-keyword">const</span> elementType = element.<span class="hljs-property">type</span>;
      <span class="hljs-comment">// 处理 Fragment 类型</span>
      <span class="hljs-keyword">if</span> (elementType === <span class="hljs-variable constant_">REACT_FRAGMENT_TYPE</span>) {
        <span class="hljs-comment">// 如果旧节点也是 Fragment，则复用并更新其子节点</span>
        <span class="hljs-keyword">if</span> (child.<span class="hljs-property">tag</span> === <span class="hljs-title class_">Fragment</span>) {
          <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="hljs-property">sibling</span>); <span class="hljs-comment">// 删除 Fragment 后的所有兄弟节点</span>
          <span class="hljs-keyword">const</span> existing = <span class="hljs-title function_">useFiber</span>(child, element.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>); <span class="hljs-comment">// 复用旧的</span>
          existing.<span class="hljs-property">return</span> = returnFiber;
          <span class="hljs-keyword">return</span> existing;
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果新旧节点的 type 相同，或者新节点是懒加载组件且解析后的类型相同，则可以复用</span>
        <span class="hljs-keyword">if</span> (
          child.<span class="hljs-property">elementType</span> === elementType ||
          (<span class="hljs-keyword">typeof</span> elementType === <span class="hljs-string">"object"</span> &amp;&amp;
            elementType !== <span class="hljs-literal">null</span> &amp;&amp;
            elementType.<span class="hljs-property">$typeof</span> === <span class="hljs-variable constant_">REACT_LAZY_TYPE</span> &amp;&amp;
            <span class="hljs-title function_">resolveLazy</span>(elementType) === child.<span class="hljs-property">type</span>)
        ) {
          <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="hljs-property">sibling</span>); <span class="hljs-comment">// 删除其他旧节点</span>
          <span class="hljs-keyword">const</span> existing = <span class="hljs-title function_">useFiber</span>(child, element.<span class="hljs-property">props</span>); <span class="hljs-comment">// 复用旧节点并更新属性</span>
          existing.<span class="hljs-property">return</span> = returnFiber;
          <span class="hljs-keyword">return</span> existing;
        }
      }
      <span class="hljs-comment">// 如果 key 匹配但 type 不匹配，或者 Fragment 类型不匹配，则不能复用，删除旧节点并跳出循环</span>
      <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, child); <span class="hljs-comment">// type不匹配则删除旧节点</span>
      <span class="hljs-keyword">break</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// key不匹配则删除旧节点</span>
      <span class="hljs-title function_">deleteChild</span>(returnFiber, child);
    }
    <span class="hljs-comment">// 继续检查下一个兄弟节点</span>
    child = child.<span class="hljs-property">sibling</span>;
  }

  <span class="hljs-comment">// 如果没有匹配到，则根据类型创建新节点</span>
  <span class="hljs-keyword">if</span> (element.<span class="hljs-property">type</span> === <span class="hljs-variable constant_">REACT_FRAGMENT_TYPE</span>) {
    <span class="hljs-keyword">const</span> created = <span class="hljs-title function_">createFiberFromFragment</span>(
      element.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>,
      returnFiber.<span class="hljs-property">mode</span>,
      lanes,
      element.<span class="hljs-property">key</span>
    );
    created.<span class="hljs-property">return</span> = returnFiber;
    <span class="hljs-keyword">return</span> created;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> created = <span class="hljs-title function_">createFiberFromElement</span>(element, returnFiber.<span class="hljs-property">mode</span>, lanes); <span class="hljs-comment">// 新建节点</span>
    created.<span class="hljs-property">return</span> = returnFiber;
    <span class="hljs-keyword">return</span> created;
  }
}
</code></pre>
<h3 data-id="heading-26">4.3 多节点 Diff 逻辑</h3>
<p>多节点 Diff 是 React Diff 算法的核心场景，需处理节点的插入、删除、移动三种核心操作。</p>
<h4 data-id="heading-27">4.3.1 核心原理：两轮遍历与 key 的作用</h4>
<p><code>key</code> 是节点的唯一标识，相当于 Diff 过程的“锚点”，用于精准匹配新旧节点；结合两轮遍历，可高效覆盖不同更新场景：</p>
<ol>
<li><strong>第一轮遍历</strong>：按索引正向匹配，快速复用“连续相同”的节点（如列表前半部分无变化），避免复杂计算；</li>
<li><strong>第二轮遍历</strong>：用哈希 Map 匹配剩余节点，处理“移动、插入、删除”等离散变更，通过 <code>key</code> 快速定位可复用节点。</li>
</ol>
<h4 data-id="heading-28">4.3.2 完整流程拆解（基于 <code>reconcileChildrenArray</code>）</h4>
<h5 data-id="heading-29">阶段 1：第一轮遍历（按索引正向匹配）</h5>
<p>从新旧节点列表的“头部”开始，按索引逐个对比，优先复用连续相同的节点：</p>
<ul>
<li><strong>匹配条件</strong>：节点的 <code>key</code> 相同且类型相同 → 复用旧节点，仅更新属性；</li>
<li><strong>终止条件</strong>：遇到不匹配节点（<code>key</code>/类型不同）或空槽位（如 <code>null</code>）→ 退出第一轮，进入后续处理。</li>
</ul>
<p>核心代码（简化）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> oldFiber = currentFirstChild; <span class="hljs-comment">// 旧节点链表起点</span>
<span class="hljs-keyword">let</span> newIdx = <span class="hljs-number">0</span>; <span class="hljs-comment">// 新节点数组索引</span>
<span class="hljs-keyword">for</span> (; oldFiber &amp;&amp; newIdx &lt; newChildren.<span class="hljs-property">length</span>; newIdx++) {
  <span class="hljs-comment">// 缓存下一个旧节点，避免遍历丢失</span>
  <span class="hljs-keyword">const</span> nextOldFiber = oldFiber.<span class="hljs-property">sibling</span>;
  <span class="hljs-comment">// 对比 key 和类型，尝试复用节点</span>
  <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">updateSlot</span>(
    returnFiber,
    oldFiber,
    newChildren[newIdx],
    lanes
  );

  <span class="hljs-keyword">if</span> (newFiber === <span class="hljs-literal">null</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 匹配失败，退出第一轮</span>

  <span class="hljs-comment">// 标记节点是否需要移动（通过 lastPlacedIndex 判断）</span>
  lastPlacedIndex = <span class="hljs-title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx);
  <span class="hljs-comment">// 构建新节点链表（通过 sibling 指针连接）</span>
  <span class="hljs-keyword">if</span> (!previousNewFiber) resultingFirstChild = newFiber;
  <span class="hljs-keyword">else</span> previousNewFiber.<span class="hljs-property">sibling</span> = newFiber;

  previousNewFiber = newFiber;
  oldFiber = nextOldFiber; <span class="hljs-comment">// 继续下一个旧节点</span>
}
</code></pre>
<h5 data-id="heading-30">阶段 2：处理“剩余节点”（分 3 种场景）</h5>
<p>根据第一轮结束后 “新旧节点是否有剩余”，分情况处理：</p>
<ol>
<li>新节点已遍历完，旧节点有剩余
剩余旧节点均为 “需删除” 节点 → 批量标记删除：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (newIdx === newChildren.<span class="hljs-property">length</span>) {
  <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, oldFiber); <span class="hljs-comment">// 删除所有剩余旧节点</span>
  <span class="hljs-keyword">return</span> resultingFirstChild;
}
</code></pre>
<ol start="2">
<li>旧节点已遍历完，新节点有剩余
剩余新节点均为 “需插入” 节点 → 批量创建并标记插入：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (oldFiber === <span class="hljs-literal">null</span>) {
  <span class="hljs-keyword">for</span> (; newIdx &lt; newChildren.<span class="hljs-property">length</span>; newIdx++) {
    <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">createChild</span>(returnFiber, newChildren[newIdx], lanes);
    <span class="hljs-title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx); <span class="hljs-comment">// 标记插入</span>
    <span class="hljs-comment">// 连接新节点到链表</span>
    previousNewFiber
      ? (previousNewFiber.<span class="hljs-property">sibling</span> = newFiber)
      : (resultingFirstChild = newFiber);
    previousNewFiber = newFiber;
  }
  <span class="hljs-keyword">return</span> resultingFirstChild;
}
</code></pre>
<ol start="3">
<li>新旧节点均有剩余（进入第二轮遍历）</li>
</ol>
<h5 data-id="heading-31">阶段 3：第二轮遍历（Map 映射匹配）</h5>
<p>针对“新旧节点均有剩余”的场景（如列表中间插入/删除节点），用哈希 Map 快速定位可复用节点：</p>
<ol>
<li><strong>构建旧节点 Map</strong>：将剩余旧节点存入 Map，<code>key</code> 为节点的 <code>key</code>（优先）或索引（无 <code>key</code> 时）；</li>
<li><strong>遍历剩余新节点</strong>：从 Map 中查找匹配的旧节点：
<ul>
<li>找到 → 复用节点，调整位置（标记 <code>Placement</code>），并从 Map 中移除该旧节点；</li>
<li>未找到 → 新建节点，标记插入；</li>
</ul>
</li>
<li><strong>清理未复用旧节点</strong>：Map 中剩余的旧节点均为“未被复用”，批量标记删除。</li>
</ol>
<p>核心代码（简化）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 剩余旧节点转 Map，key 为节点 key 或索引</span>
<span class="hljs-keyword">const</span> existingChildren = <span class="hljs-title function_">mapRemainingChildren</span>(oldFiber);
<span class="hljs-comment">// 遍历剩余新节点，从 Map 匹配</span>
<span class="hljs-keyword">for</span> (; newIdx &lt; newChildren.<span class="hljs-property">length</span>; newIdx++) {
  <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">updateFromMap</span>(
    existingChildren,
    returnFiber,
    newIdx,
    newChildren[newIdx],
    lanes
  );

  <span class="hljs-keyword">if</span> (newFiber) {
    <span class="hljs-comment">// 标记移动/插入，构建新链表</span>
    lastPlacedIndex = <span class="hljs-title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx);
    <span class="hljs-keyword">if</span> (!previousNewFiber) resultingFirstChild = newFiber;
    <span class="hljs-keyword">else</span> previousNewFiber.<span class="hljs-property">sibling</span> = newFiber;
    previousNewFiber = newFiber;
    <span class="hljs-comment">// 移除已复用的旧节点</span>
    existingChildren.<span class="hljs-title function_">delete</span>(newFiber.<span class="hljs-property">key</span> || newIdx);
  }
}
<span class="hljs-comment">// 删除 Map 中未复用的旧节点</span>
existingChildren.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> <span class="hljs-title function_">deleteChild</span>(returnFiber, child));
</code></pre>
<h5 data-id="heading-32">关键辅助函数：<code>placeChild</code>（判断节点是否移动）</h5>
<p>通过 <code>lastPlacedIndex</code>（上一个“无需移动”的旧节点索引）判断当前节点是否需要移动：</p>
<ul>
<li>若旧节点索引 &lt; <code>lastPlacedIndex</code> → 节点位置后移，标记 <code>Placement</code>（需移动）；</li>
<li>若旧节点索引 ≥ <code>lastPlacedIndex</code> → 节点位置未变，更新 <code>lastPlacedIndex</code> 为当前旧节点索引。</li>
</ul>
<p>代码逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">placeChild</span>(<span class="hljs-params">newFiber, lastPlacedIndex, newIndex</span>) {
  newFiber.<span class="hljs-property">index</span> = newIndex;
  <span class="hljs-keyword">const</span> current = newFiber.<span class="hljs-property">alternate</span>; <span class="hljs-comment">// 对应的旧节点</span>
  <span class="hljs-keyword">if</span> (current) {
    <span class="hljs-keyword">const</span> oldIndex = current.<span class="hljs-property">index</span>;
    <span class="hljs-keyword">if</span> (oldIndex &lt; lastPlacedIndex) {
      newFiber.<span class="hljs-property">flags</span> |= <span class="hljs-title class_">Placement</span>; <span class="hljs-comment">// 标记需要移动</span>
      <span class="hljs-keyword">return</span> lastPlacedIndex;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> oldIndex; <span class="hljs-comment">// 更新 lastPlacedIndex</span>
    }
  } <span class="hljs-keyword">else</span> {
    newFiber.<span class="hljs-property">flags</span> |= <span class="hljs-title class_">Placement</span>; <span class="hljs-comment">// 新节点，标记插入</span>
    <span class="hljs-keyword">return</span> lastPlacedIndex;
  }
}
</code></pre>
<h5 data-id="heading-33">流程图</h5>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9e599f101c24cd4aec7e7b0a81f6e61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF5MQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766317389&amp;x-signature=d%2BUdc8V0uKVGb0ya7V9yKaZjVZk%3D" alt="4-1.png" loading="lazy"/></p>
<h4 data-id="heading-34">4.3.3 具体示例</h4>
<h5 data-id="heading-35">示例 1：节点移动（列表元素交换位置）</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 旧列表</span>
&lt;div&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;;

<span class="hljs-comment">//新列表</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
</code></pre>
<p><strong>Diff 过程</strong>：</p>
<ol>
<li>第一轮遍历：
<ul>
<li>索引 0：旧 <code>a</code> vs 新 <code>b</code> → <code>key</code> 不匹配，退出第一轮；</li>
</ul>
</li>
<li>第二轮遍历：
<ul>
<li>构建旧节点 Map：<code>{a: 旧a, b: 旧b, c: 旧c}</code>；</li>
<li>新节点索引 0（<code>b</code>）：从 Map 找到旧 <code>b</code>，旧索引 1 ≥ <code>lastPlacedIndex</code>（0）→ 无需移动，更新 <code>lastPlacedIndex</code> 为 1；</li>
<li>新节点索引 1（<code>a</code>）：从 Map 找到旧 <code>a</code>，旧索引 0 &lt; <code>lastPlacedIndex</code>（1）→ 标记移动；</li>
<li>新节点索引 2（<code>c</code>）：从 Map 找到旧 <code>c</code>，旧索引 2 ≥ <code>lastPlacedIndex</code>（1）→ 无需移动；</li>
</ul>
</li>
<li>最终操作：仅移动 <code>a</code> 到 <code>b</code> 之后，无节点创建/删除。</li>
</ol>
<h5 data-id="heading-36">示例 2：节点插入+删除（列表中间增删元素）</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 旧列表</span>
&lt;div&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;
<span class="hljs-comment">// 新列表</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"d"</span>&gt;</span>D<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<p><strong>Diff 过程</strong>：</p>
<ol>
<li>第一轮遍历：
<ul>
<li>索引 0：旧 <code>a</code> vs 新 <code>a</code> → 匹配成功，复用节点；</li>
<li>索引 1：旧 <code>b</code> vs 新 <code>d</code> → <code>key</code> 不匹配，退出第一轮；</li>
</ul>
</li>
<li>第二轮遍历：
<ul>
<li>构建旧节点 Map：<code>{b: 旧b, c: 旧c}</code>；</li>
<li>新节点索引 1（<code>d</code>）：Map 中无匹配 → 新建节点，标记插入；</li>
<li>新节点索引 2（<code>c</code>）：从 Map 找到旧 <code>c</code>，旧索引 2 ≥ <code>lastPlacedIndex</code>（0）→ 无需移动；</li>
</ul>
</li>
<li>最终操作：删除旧 <code>b</code>，插入新 <code>d</code>，无其他移动。</li>
</ol>
<h5 data-id="heading-37">示例 3：节点移动 + 插入 + 删除（混合变更）</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 旧列表</span>
&lt;div&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"d"</span>&gt;</span>D<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"e"</span>&gt;</span>E<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;;

<span class="hljs-comment">// 新列表</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"f"</span>&gt;</span>F<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"g"</span>&gt;</span>G<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
</code></pre>
<p><strong>Diff 过程</strong>：</p>
<ol>
<li><strong>第一轮遍历（从左到右，比较相同索引的节点）</strong>：
<ul>
<li>索引 0：旧 <code>a</code> vs 新 <code>b</code> → <code>key</code> 不匹配，退出第一轮遍历。</li>
</ul>
</li>
<li><strong>第二轮遍历（从右到左，比较相同索引的节点）</strong>：
<ul>
<li>索引 4：旧 <code>e</code> vs 新 <code>g</code> → <code>key</code> 不匹配，退出第二轮遍历。</li>
</ul>
</li>
<li><strong>第三轮遍历（处理剩余未匹配节点）</strong>：
<ul>
<li><strong>构建旧节点 Map</strong>：<code>{a: 旧a, b: 旧b, c: 旧c, d: 旧d, e: 旧e}</code>。</li>
<li><strong>遍历新列表剩余节点</strong>：
<ul>
<li>新节点 <code>B</code> (key <code>b</code>)：在 Map 中找到 <code>旧b</code> (索引 1)。<code>旧b</code> 的索引 1 ≥ <code>lastPlacedIndex</code> (-1) → 无需移动。更新 <code>lastPlacedIndex</code> 为 1。从 Map 中删除 <code>旧b</code>。</li>
<li>新节点 <code>F</code> (key <code>f</code>)：在 Map 中未找到 → 标记为<strong>插入</strong>新节点 <code>F</code>。</li>
<li>新节点 <code>A</code> (key <code>a</code>)：在 Map 中找到 <code>旧a</code> (索引 0)。<code>旧a</code> 的索引 0 &lt; <code>lastPlacedIndex</code> (1) → 标记为<strong>移动</strong>。更新 <code>lastPlacedIndex</code> 为 1。从 Map 中删除 <code>旧a</code>。</li>
<li>新节点 <code>C</code> (key <code>c</code>)：在 Map 中找到 <code>旧c</code> (索引 2)。<code>旧c</code> 的索引 2 ≥ <code>lastPlacedIndex</code> (1) → 无需移动。更新 <code>lastPlacedIndex</code> 为 2。从 Map 中删除 <code>旧c</code>。</li>
<li>新节点 <code>G</code> (key <code>g</code>)：在 Map 中未找到 → 标记为<strong>插入</strong>新节点 <code>G</code>。</li>
</ul>
</li>
<li><strong>处理旧节点 Map 中剩余节点</strong>：Map 中剩余 <code>旧d</code> 和 <code>旧e</code> → 标记 <code>旧d</code> 和 <code>旧e</code> 为<strong>删除</strong>。</li>
</ul>
</li>
<li><strong>最终操作</strong>：移动 <code>A</code> 到 <code>B</code> 之后，插入 <code>F</code>，插入 <code>G</code>，删除 <code>D</code>，删除 <code>E</code>。</li>
</ol>
<h3 data-id="heading-38">4.3 一些好的实践</h3>
<h4 data-id="heading-39">4.4.1 合理设置 key 属性</h4>
<ol>
<li>优先使用稳定且唯一的标识作为 key，如后端返回的 ID，避免使用索引或随机值。索引作为 key 会导致节点移动时无法被正确匹配，随机值会让每次渲染都视为新节点，完全失去复用价值。</li>
<li>同层级节点的 key 必须唯一，避免 key 冲突导致节点匹配错乱，引发 DOM 异常渲染。</li>
<li>列表渲染时必须显式设置 key，即使是简单列表，合理的 key 能让多节点 Diff 高效处理增删改查，减少性能开销。</li>
</ol>
<h4 data-id="heading-40">4.4.2 优化节点类型与结构</h4>
<ol>
<li>避免频繁变更节点类型，如将 div 改为 p，会导致旧节点被销毁、新节点重建，增加性能成本。尽量通过 CSS 或属性调整实现样式变化，而非节点类型变更。</li>
<li>减少不必要的节点嵌套，扁平化组件结构。深层嵌套会增加 Diff 遍历的层级和复杂度，影响协调效率。</li>
<li>对于静态节点（无状态、无属性变更），可通过 React.memo 或自定义缓存逻辑减少 Diff 对比，直接复用节点。</li>
</ol>
<h4 data-id="heading-41">4.4.3 避免不必要的 Diff 触发</h4>
<ol>
<li>合理使用 React.memo、useMemo 和 useCallback，缓存组件、计算结果和回调函数，避免因 props 或依赖项无关变化导致的不必要重渲染和 Diff。</li>
<li>状态设计尽量精准，避免将无关状态集中管理。局部状态变化应仅影响对应的组件子树，减少 Diff 遍历的范围。</li>
<li>对于动态列表，避免全量替换数据，尽量通过增删单个节点更新列表，让 Diff 算法仅处理变更部分，提升效率。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【附源码，附两款可视化大屏】Three.js中的地图精确贴图与热力图实现解析]]></title>    <link>https://juejin.cn/post/7583571595202248742</link>    <guid>https://juejin.cn/post/7583571595202248742</guid>    <pubDate>2025-12-14T11:53:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583571595202248742" data-draft-id="7583535861645115438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【附源码，附两款可视化大屏】Three.js中的地图精确贴图与热力图实现解析"/> <meta itemprop="keywords" content="前端,开源"/> <meta itemprop="datePublished" content="2025-12-14T11:53:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="knight_l"/> <meta itemprop="url" content="https://juejin.cn/user/2049145406504557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【附源码，附两款可视化大屏】Three.js中的地图精确贴图与热力图实现解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2049145406504557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    knight_l
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T11:53:36.000Z" title="Sun Dec 14 2025 11:53:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎉实现效果图</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53937b0b401c4f4382aa84afea4c0b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga25pZ2h0X2w=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766366588&amp;x-signature=%2BjauR7YlBMus7iv5rwNTeuxXRVo%3D" alt="Snipaste_2025-12-13_21-09-33 (1).png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea65e2d044484dc29a655a149710f054~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga25pZ2h0X2w=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766366588&amp;x-signature=i54%2F1xhTUytbeQsU183KubvJjGc%3D" alt="Snipaste_2025-11-20_14-20-19.png" loading="lazy"/></p>
<h3 data-id="heading-1">项目地址</h3>
<p>如果你觉得不错的话，帮我点一个小小的<code>star</code></p>
<blockquote>
<p>访问需要魔法。👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fknight-L%2Fsc-datav" target="_blank" title="https://github.com/knight-L/sc-datav" ref="nofollow noopener noreferrer">点击访问</a>👈</p>
</blockquote>
<h3 data-id="heading-2">在线预览</h3>
<blockquote>
<p>👉<a href="https://link.juejin.cn?target=https%3A%2F%2Fknight-l.github.io%2Fsc-datav%2F%23%2F" target="_blank" title="https://knight-l.github.io/sc-datav/#/" ref="nofollow noopener noreferrer">点击访问效果图2</a>👈</p>
</blockquote>
<h3 data-id="heading-3">精确贴图实现</h3>
<p>精确贴图是将2D纹理准确地映射到3D几何体表面的技术。在我们的项目中，通过以下步骤实现了精确贴图：</p>
<h4 data-id="heading-4">1. UV坐标计算</h4>
<p>为了确保纹理能够正确地映射到几何体上，我们需要计算每个顶点的UV坐标：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> { geometry } = meshRef.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">const</span> pos = geometry.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>;
  <span class="hljs-keyword">const</span> width = bbox.<span class="hljs-property">max</span>.<span class="hljs-property">x</span> - bbox.<span class="hljs-property">min</span>.<span class="hljs-property">x</span>;
  <span class="hljs-keyword">const</span> height = bbox.<span class="hljs-property">max</span>.<span class="hljs-property">y</span> - bbox.<span class="hljs-property">min</span>.<span class="hljs-property">y</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-attr">uv</span>: number[] = [];
  <span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>, u = <span class="hljs-number">0</span>, v = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; pos.<span class="hljs-property">count</span>; i++) {
    x = pos.<span class="hljs-title function_">getX</span>(i);
    y = pos.<span class="hljs-title function_">getY</span>(i);
    u = (x - bbox.<span class="hljs-property">min</span>.<span class="hljs-property">x</span>) / width;
    v = (y - bbox.<span class="hljs-property">min</span>.<span class="hljs-property">y</span>) / height;
    uv.<span class="hljs-title function_">push</span>(u, v);
  }
  geometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"uv"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32BufferAttribute</span>(uv, <span class="hljs-number">2</span>));
});
</code></pre>
<p>这段代码通过遍历几何体的所有顶点，根据包围盒(bbox)计算出每个顶点对应的UV坐标，确保纹理能按照正确的比例映射到几何体表面。</p>
<h4 data-id="heading-5">2. 纹理加载与配置</h4>
<p>在项目中，我们使用 <code>useTexture</code>钩子加载纹理，并进行必要的配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [texture1, texture2, texture3] = <span class="hljs-title function_">useTexture</span>(
  [textureMap, scNormalMap, scDisplacementMap],
  <span class="hljs-function">(<span class="hljs-params">tex</span>) =&gt;</span>
    tex.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {
      el.<span class="hljs-property">wrapS</span> = el.<span class="hljs-property">wrapT</span> = <span class="hljs-title class_">RepeatWrapping</span>;
    })
);
</code></pre>
<h4 data-id="heading-6">3. 材质应用</h4>
<p>最后，我们将纹理应用到材质上：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;meshStandardMaterial
  map={texture1}
  normalMap={texture2}
  displacementMap={texture3}
  metalness={<span class="hljs-number">0.2</span>}
  roughness={<span class="hljs-number">0.5</span>}
  side={<span class="hljs-title class_">DoubleSide</span>}
/&gt;
</code></pre>
<p>通过这种方式，我们可以为3D对象添加漫反射贴图、法线贴图和置换贴图，从而创造出更加真实和细节丰富的视觉效果。</p>
<h3 data-id="heading-7">热力图实现</h3>
<p>热力图是一种用颜色编码来表示数据密度或强度的可视化技术。在我们的项目中，使用了 <code>heatmap.js</code>库来实现热力图功能。</p>
<h4 data-id="heading-8">1. 热力图数据准备</h4>
<p>首先，我们需要准备热力图的数据点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> points = data.<span class="hljs-property">features</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> [x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>] =
    <span class="hljs-title function_">projection</span>(el.<span class="hljs-property">geometry</span>.<span class="hljs-property">coordinates</span> <span class="hljs-keyword">as</span> [number, number]) ?? [];
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">x</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(x + size / <span class="hljs-number">2</span>),
    <span class="hljs-attr">y</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(y + size / <span class="hljs-number">2</span>),
    <span class="hljs-attr">value</span>: el.<span class="hljs-property">properties</span>.<span class="hljs-property">value</span>,
  };
});
</code></pre>
<p>这些数据点包含了位置信息(x,y)和数值(value)，用于生成热力图。</p>
<h4 data-id="heading-9">2. 热力图生成</h4>
<p>使用 <code>heatmap.js</code>创建热力图：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> heatmap = heatmapJs.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: heatmapContainer,
  <span class="hljs-attr">gradient</span>: {
    <span class="hljs-number">0.5</span>: <span class="hljs-string">"#1fc2e1"</span>,
    <span class="hljs-number">0.6</span>: <span class="hljs-string">"#24d560"</span>,
    <span class="hljs-number">0.7</span>: <span class="hljs-string">"#9cd522"</span>,
    <span class="hljs-number">0.8</span>: <span class="hljs-string">"#f1e12a"</span>,
    <span class="hljs-number">0.9</span>: <span class="hljs-string">"#ffbf3a"</span>,
    <span class="hljs-number">1.0</span>: <span class="hljs-string">"#ff0000"</span>,
  },
  <span class="hljs-attr">blur</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">radius</span>: radius,
  <span class="hljs-attr">maxOpacity</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">width</span>: size,
  <span class="hljs-attr">height</span>: size,
});
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> greymap = heatmapJs.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: heatmapContainer,
  <span class="hljs-attr">gradient</span>: {
    <span class="hljs-number">0.0</span>: <span class="hljs-string">"black"</span>,
    <span class="hljs-number">1.0</span>: <span class="hljs-string">"white"</span>,
  },
  <span class="hljs-attr">radius</span>: radius,
  <span class="hljs-attr">maxOpacity</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">width</span>: size,
  <span class="hljs-attr">height</span>: size,
});
</code></pre>
<p>这里定义了颜色渐变，不同的数值范围对应不同的颜色，从而形成热力图的视觉效果。</p>
<h4 data-id="heading-10">3. 与Three.js集成</h4>
<p>将生成的热力图作为纹理应用到Three.js的网格上：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> texture = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CanvasTexture</span>(heatmap.<span class="hljs-property">_renderer</span>.<span class="hljs-property">canvas</span>);
texture.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 在着色器中使用该纹理</span>
<span class="hljs-attr">uniforms</span>: {
  <span class="hljs-attr">heatMap</span>: { <span class="hljs-attr">value</span>: texture },
  <span class="hljs-comment">// 其他uniforms...</span>
}
</code></pre>
<p>通过这种方式，我们将2D热力图转换为可以在3D场景中使用的纹理。</p>
<h4 data-id="heading-11">4. 着色器实现</h4>
<p>在片段着色器中使用热力图纹理：</p>
<pre><code class="hljs language-glsl" lang="glsl">varying vec2 vUv;
uniform sampler2D heatMap;
uniform vec3 u_color;
uniform float u_opacity;

void main() {
    gl_FragColor = vec4(u_color, u_opacity) * texture2D(heatMap, vUv);
}
</code></pre>
<p>这样就完成了热力图在3D场景中的渲染。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java集合“坑王”：ArrayList为啥越界还能浪？]]></title>    <link>https://juejin.cn/post/7583571595203018790</link>    <guid>https://juejin.cn/post/7583571595203018790</guid>    <pubDate>2025-12-14T14:01:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583571595203018790" data-draft-id="7583567658253238298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java集合“坑王”：ArrayList为啥越界还能浪？"/> <meta itemprop="keywords" content="前端,Java"/> <meta itemprop="datePublished" content="2025-12-14T14:01:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java集合“坑王”：ArrayList为啥越界还能浪？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:01:48.000Z" title="Sun Dec 14 2025 14:01:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>提起ArrayList，新手总觉得它就是个“自动扩容的数组”，随便add、get都不怕——直到遇到 IndexOutOfBoundsException ，才发现这货藏着不少小心机。今天咱扒一扒ArrayList的扩容黑科技，以及那些让你踩坑的细节！</p>
<h2 data-id="heading-0">一、先搞懂：ArrayList为啥能“自动变长”？</h2>
<p>ArrayList底层是普通数组，默认初始容量是10。当添加元素导致数组满了，它会悄悄扩容：新容量=旧容量×1.5（源码里是 oldCapacity + (oldCapacity &gt;&gt; 1) ），然后把旧数组的数据复制到新数组。</p>
<p>看个简单例子，直观感受扩容：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayListDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        ArrayList&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(); <span class="hljs-comment">// 初始容量10</span>
        
        <span class="hljs-comment">// 加10个元素，刚好填满初始数组</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            list.add(<span class="hljs-string">"元素"</span> + i);
        }
        
        <span class="hljs-comment">// 第11个元素：触发扩容！新容量变成15</span>
        list.add(<span class="hljs-string">"触发扩容的元素"</span>);
        
        System.out.println(<span class="hljs-string">"当前元素数量："</span> + list.size()); <span class="hljs-comment">// 输出11</span>
        System.out.println(<span class="hljs-string">"能存但未用的容量："</span> + (list.size() &lt; <span class="hljs-number">15</span> ? <span class="hljs-number">15</span> - list.size() : <span class="hljs-string">"已再次扩容"</span>)); <span class="hljs-comment">// 输出4</span>
    }
}
</code></pre>
<p> </p>
<h2 data-id="heading-1">二、踩坑重灾区：size和capacity别搞混！</h2>
<p>很多人以为 list.size() 是数组容量，其实大错特错：</p>
<ul>
<li><code> size()</code> ：实际存储的元素数量（你add了多少个）</li>
<li> <code>capacity </code>：底层数组的长度（ArrayList内部用 elementData 数组，容量不对外暴露）</li>
</ul>
<p>这就是为啥 get(10) 会报错——哪怕数组容量是15，只要你只存了11个元素，索引10是有效的，但索引11就越界：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    ArrayList&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">11</span>; i++) {
        list.add(<span class="hljs-string">"元素"</span> + i);
    }
    
    System.out.println(list.get(<span class="hljs-number">10</span>)); <span class="hljs-comment">// 正常输出：元素10</span>
    list.get(<span class="hljs-number">11</span>); <span class="hljs-comment">// 直接抛IndexOutOfBoundsException！</span>
}
</code></pre>
<p> </p>
<h2 data-id="heading-2">三、实用技巧：提前指定容量，避免频繁扩容</h2>
<p>如果知道要存多少元素，初始化时直接指定容量，能减少数组复制的性能损耗：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 已知要存1000个元素，直接指定容量</span>
ArrayList&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">1000</span>);
<span class="hljs-comment">// 后续add1000个元素，一次扩容都不会触发</span>
</code></pre>
<p> </p>
<p>最后划重点</p>
<p>1. ArrayList扩容是“偷偷摸摸”的，扩容后旧数组会被GC回收；</p>
<p>2. 越界异常看的是 <code>size()</code> ，不是底层数组容量；</p>
<p>3. 大数据量场景一定要指定初始容量，优化性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再把Java枚举当“花瓶”！它能办大事]]></title>    <link>https://juejin.cn/post/7583576605780557870</link>    <guid>https://juejin.cn/post/7583576605780557870</guid>    <pubDate>2025-12-14T13:49:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583576605780557870" data-draft-id="7583576605780508718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再把Java枚举当“花瓶”！它能办大事"/> <meta itemprop="keywords" content="前端,Java"/> <meta itemprop="datePublished" content="2025-12-14T13:49:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再把Java枚举当“花瓶”！它能办大事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T13:49:36.000Z" title="Sun Dec 14 2025 13:49:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>提起Java枚举（Enum），很多新手觉得它就是个“花架子”——无非定义几个固定值，远不如if-else顺手。但其实枚举藏着硬核实力，既能让代码更优雅，还能避免一堆坑。今天咱就扒一扒枚举的实用姿势，告别“枚举无用论”！</p>
<h2 data-id="heading-0">一、枚举不只是“常量容器”</h2>
<p>先看个反例：用普通常量定义订单状态，一不小心就踩坑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 糟糕的写法：常量易被篡改、类型不安全</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderStatus</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PENDING</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PAID</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHIPPED</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
    
    <span class="hljs-comment">// 传个4进来？编译器根本拦不住！</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processStatus</span><span class="hljs-params">(<span class="hljs-type">int</span> status)</span> {
        <span class="hljs-keyword">if</span> (status == PENDING) { <span class="hljs-comment">/* 逻辑 */</span> }
    }
}
</code></pre>
<p> </p>
<p>换成枚举试试，直接把“非法值”堵在门外：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优雅写法：枚举天生类型安全、不可变</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatusEnum</span> {
    PENDING, PAID, SHIPPED; <span class="hljs-comment">// 固定状态，不能新增/修改</span>
}

<span class="hljs-comment">// 只能传枚举实例，传错直接编译报错！</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processStatus</span><span class="hljs-params">(OrderStatusEnum status)</span> {
    <span class="hljs-keyword">if</span> (status == OrderStatusEnum.PENDING) { <span class="hljs-comment">/* 逻辑 */</span> }
}
</code></pre>
<p> </p>
<h2 data-id="heading-1">二、枚举里藏着“方法大招”</h2>
<p>枚举可不是只能存值，还能自带方法，甚至实现接口！比如给状态加个描述：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatusEnum</span> {
    PENDING(<span class="hljs-string">"待支付"</span>, <span class="hljs-number">1</span>),
    PAID(<span class="hljs-string">"已支付"</span>, <span class="hljs-number">2</span>),
    SHIPPED(<span class="hljs-string">"已发货"</span>, <span class="hljs-number">3</span>);

    <span class="hljs-comment">// 枚举的成员变量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;

    <span class="hljs-comment">// 枚举的构造方法（必须私有！）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">OrderStatusEnum</span><span class="hljs-params">(String desc, <span class="hljs-type">int</span> code)</span> {
        <span class="hljs-built_in">this</span>.desc = desc;
        <span class="hljs-built_in">this</span>.code = code;
    }

    <span class="hljs-comment">// 自定义方法：获取描述</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> desc;
    }

    <span class="hljs-comment">// 静态方法：根据code查枚举</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> OrderStatusEnum <span class="hljs-title function_">getByCode</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span> {
        <span class="hljs-keyword">for</span> (OrderStatusEnum status : values()) {
            <span class="hljs-keyword">if</span> (status.code == code) {
                <span class="hljs-keyword">return</span> status;
            }
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"无效状态码："</span> + code);
    }
}

<span class="hljs-comment">// 调用示例：直接拿描述，不用写一堆if-else</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    System.out.println(OrderStatusEnum.PAID.getDesc()); <span class="hljs-comment">// 输出：已支付</span>
    System.out.println(OrderStatusEnum.getByCode(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 输出：SHIPPED</span>
}
</code></pre>
<p> </p>
<h2 data-id="heading-2">三、switch里的“最佳搭档”</h2>
<p>枚举和switch简直是天作之合，代码可读性直接拉满：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrder</span><span class="hljs-params">(OrderStatusEnum status)</span> {
    <span class="hljs-keyword">switch</span> (status) {
        <span class="hljs-keyword">case</span> PENDING:
            System.out.println(<span class="hljs-string">"请尽快支付"</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> PAID:
            System.out.println(<span class="hljs-string">"已安排发货"</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> SHIPPED:
            System.out.println(<span class="hljs-string">"请注意查收"</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-comment">// 不用写default！新增枚举时，编译器会提醒你补case</span>
    }
}
</code></pre>
<p> </p>
<p>最后划重点</p>
<p>1. 枚举是单例的集合，每个实例都是唯一的；</p>
<p>2. 构造方法必须私有，不能手动new；</p>
<p>3. 用枚举替代魔法值、常量组，代码更安全、易维护。</p>
<p>别再把枚举束之高阁了！下次定义固定值（比如状态、类型），直接掏出枚举，让代码少点bug，多点优雅～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂 JavaScript 原型链：从本质到实战应用]]></title>    <link>https://juejin.cn/post/7583234966635184162</link>    <guid>https://juejin.cn/post/7583234966635184162</guid>    <pubDate>2025-12-14T14:19:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583234966635184162" data-draft-id="7583168260797825064" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂 JavaScript 原型链：从本质到实战应用"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-14T14:19:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如果你好"/> <meta itemprop="url" content="https://juejin.cn/user/2272012281328215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂 JavaScript 原型链：从本质到实战应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2272012281328215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如果你好
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:19:49.000Z" title="Sun Dec 14 2025 14:19:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一文搞懂 JavaScript 原型链：从本质到实战应用</h2>
<p>在 JavaScript 世界里，原型链是贯穿始终的核心概念。很多开发者对它又爱又恨——爱它支撑起了 JS 的面向对象特性，恨它抽象难懂、容易混淆。本文将从“是什么”“为什么”“怎么用”三个维度，用通俗的语言+直观的实例，帮你彻底搞懂原型链，从此不再被“原型”“原型对象”“构造函数”这些概念绕晕。</p>
<h3 data-id="heading-1">一、为什么需要原型链？—— JS 面向对象的底层逻辑</h3>
<p>在传统面向对象语言（如 Java、C++）中，我们通过“类”来创建对象，类是对象的模板，规定了对象的属性和方法。但 JavaScript 在 ES6 之前并没有“类”的概念，那它是如何实现面向对象的呢？</p>
<p>答案就是 <strong>原型链（Prototype Chain）</strong> 。原型链的核心作用有两个：</p>
<ul>
<li><strong>实现属性和方法的共享</strong>：避免每个对象都重复定义相同的方法，节省内存空间；</li>
<li><strong>实现继承</strong>：让一个对象可以复用另一个对象的属性和方法，无需重新编写代码。</li>
</ul>
<p>举个简单的例子：如果我们要创建 100 个“人”对象，每个对象都有“姓名”“年龄”属性和“说话”方法。如果没有原型链，我们需要给每个对象都定义一次“说话”方法，这会造成大量的内存浪费；而通过原型链，我们可以把“说话”方法定义在原型上，让所有“人”对象共享这个方法。</p>
<h3 data-id="heading-2">二、先理清三个核心概念：构造函数、原型对象、实例</h3>
<p>要搞懂原型链，必须先分清三个紧密关联的概念：<strong>构造函数</strong>、<strong>原型对象（Prototype）</strong> 、<strong>实例对象</strong>。它们三者的关系是：原型链的基础。</p>
<h4 data-id="heading-3">2.1 构造函数</h4>
<p>构造函数是用来创建对象的函数，通常首字母大写（约定俗成）。通过 <code>new</code> 关键字调用构造函数，就能生成实例对象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 构造函数：用来创建“人”对象</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; <span class="hljs-comment">// 实例属性（每个实例独有的属性）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 通过 new 调用构造函数，生成实例对象</span>
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">20</span>);
<span class="hljs-keyword">const</span> person2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'李四'</span>, <span class="hljs-number">22</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1); <span class="hljs-comment">// Person { name: '张三', age: 20 }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person2); <span class="hljs-comment">// Person { name: '李四', age: 22 }</span>
</code></pre>
<h4 data-id="heading-4">2.2 原型对象（Prototype）</h4>
<p>每个构造函数都有一个 <code>prototype</code> 属性，这个属性指向一个对象，就是<strong>原型对象</strong>。原型对象的作用是存储所有实例共享的属性和方法。</p>
<p>我们可以把共享方法定义在构造函数的 <code>prototype</code> 上，让所有实例共享：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 给 Person 构造函数的原型对象添加共享方法</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>，今年 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span> 岁`</span>);
};

<span class="hljs-comment">// 所有实例都能调用原型上的方法</span>
person1.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// Hi, 我是 张三，今年 20 岁</span>
person2.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// Hi, 我是 李四，今年 22 岁</span>

<span class="hljs-comment">// 验证：两个实例的 sayHi 方法是同一个（共享的）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">sayHi</span> === person2.<span class="hljs-property">sayHi</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-5">2.3 实例与 <strong>proto</strong></h4>
<p>每个实例对象都有一个内置属性（非标准但几乎所有浏览器都支持）—— <code>__proto__</code>，这个属性指向<strong>创建它的构造函数的原型对象</strong>。</p>
<p>也就是说，实例的 <code>__proto__</code> === 构造函数的 <code>prototype</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实例的 __proto__ 指向构造函数的 prototype</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person2.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-6">2.4 三者关系总结</h4>
<p>用一张图就能理清三者的关系：</p>
<ul>
<li>构造函数（Person）通过 <code>prototype</code> 指向原型对象（Person.prototype）；</li>
<li>实例对象（person1、person2）通过 <code>__proto__</code> 指向原型对象（Person.prototype）；</li>
<li>原型对象（Person.prototype）通过 <code>constructor</code> 指向构造函数（Person）（这个属性是默认存在的）。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 原型对象的 constructor 指向构造函数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-7">三、原型链的本质：层层向上的查找链条</h3>
<p>原型对象本身也是一个对象，它也有自己的 <code>__proto__</code> 属性，指向它的原型对象。这样一层一层向上追溯，就形成了一条链条——这就是<strong>原型链</strong>。</p>
<p>原型链的终点是 <code>Object.prototype</code>，因为 <code>Object</code> 是 JS 中所有对象的“根对象”，它的 <code>__proto__</code> 指向 <code>null</code>（没有更上层的原型了）。</p>
<h4 data-id="heading-8">3.1 原型链的结构示例</h4>
<p>以 person1 为例，它的原型链结构是：</p>
<p>person1 → person1.<strong>proto</strong>（Person.prototype）→ Person.prototype.<strong>proto</strong>（Object.prototype）→ Object.prototype.<strong>proto</strong>（null）</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 验证原型链结构</span>
console.<span class="hljs-built_in">log</span>(person1.__proto__); <span class="hljs-comment">// Person.prototype</span>
console.<span class="hljs-built_in">log</span>(person1.__proto__.__proto__); <span class="hljs-comment">// Object.prototype</span>
console.<span class="hljs-built_in">log</span>(person1.__proto__.__proto__.__proto__); <span class="hljs-comment">// null</span>
</code></pre>
<h4 data-id="heading-9">3.2 原型链的核心作用：属性/方法查找规则</h4>
<p>当我们访问一个实例对象的属性或方法时，JS 引擎会按照以下规则查找：</p>
<ol>
<li>首先在实例对象本身查找，如果找到，直接使用；</li>
<li>如果没找到，就通过<code>__proto__</code> 找到它的原型对象，在原型对象中查找；</li>
<li>如果原型对象中也没找到，就通过原型对象的 <code>__proto__</code> 向上查找，直到找到 <code>Object.prototype</code>；</li>
<li>如果在 <code>Object.prototype</code> 中还没找到，就返回 <code>undefined</code>（如果是方法，就会报错“xxx is not a function”）。</li>
</ol>
<p>举个例子理解查找规则：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. 实例本身有 name 属性，直接访问</span>
console<span class="hljs-selector-class">.log</span>(person1.name); <span class="hljs-comment">// 张三（来自 person1 本身）</span>

<span class="hljs-comment">// 2. 实例本身没有 sayHi 方法，去原型对象（Person.prototype）查找</span>
person1<span class="hljs-selector-class">.sayHi</span>(); <span class="hljs-comment">// Hi, 我是 张三...（来自 Person.prototype）</span>

<span class="hljs-comment">// 3. 实例和 Person.prototype 都没有 toString 方法，去 Object.prototype 查找</span>
console<span class="hljs-selector-class">.log</span>(person1.toString()); <span class="hljs-comment">// [object Object]（来自 Object.prototype）</span>

<span class="hljs-comment">// 4. 找不到的属性，返回 undefined</span>
console<span class="hljs-selector-class">.log</span>(person1.gender); <span class="hljs-comment">// undefined</span>
</code></pre>
<h3 data-id="heading-10">四、原型链实现继承——JS 原生继承的核心方式</h3>
<p>ES6 之前，JavaScript 没有 <code>class</code> 和 <code>extends</code> 关键字，继承完全依赖原型链实现。核心思路是：<strong>让子类的原型对象指向父类的实例</strong>，从而让子类实例能通过原型链访问到父类的属性和方法。</p>
<h4 data-id="heading-11">4.1 基本原型链继承</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父类构造函数：Person</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 父类原型方法</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-comment">// 子类构造函数：Student（继承 Person）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Student</span>(<span class="hljs-params">name, age, studentId</span>) {
  <span class="hljs-comment">// 继承父类的实例属性（必须先调用，否则 this 会被覆盖）</span>
  <span class="hljs-title class_">Person</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name, age); 
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">studentId</span> = studentId; <span class="hljs-comment">// 子类独有的属性</span>
}

<span class="hljs-comment">// 核心：让子类的原型对象指向父类的实例，建立原型链</span>
<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-comment">// 修复子类原型的 constructor 指向（因为上面的赋值改变了 constructor）</span>
<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Student</span>;

<span class="hljs-comment">// 子类原型方法（重写父类方法，实现多态）</span>
<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是学生 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>，学号：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.studentId}</span>`</span>);
};

<span class="hljs-comment">// 子类独有的原型方法</span>
<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">study</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 正在学习`</span>);
};

<span class="hljs-comment">// 实例化子类</span>
<span class="hljs-keyword">const</span> student1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">'王五'</span>, <span class="hljs-number">18</span>, <span class="hljs-string">'2024001'</span>);

<span class="hljs-comment">// 验证继承效果</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(student1.<span class="hljs-property">name</span>); <span class="hljs-comment">// 王五（继承自 Person）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(student1.<span class="hljs-property">studentId</span>); <span class="hljs-comment">// 2024001（子类独有）</span>
student1.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// Hi, 我是学生 王五，学号：2024001（重写后的方法）</span>
student1.<span class="hljs-title function_">study</span>(); <span class="hljs-comment">// 王五 正在学习（子类独有方法）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(student1.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// [object Object]（继承自 Object.prototype）</span>
</code></pre>
<h4 data-id="heading-12">4.2 原型链继承的注意点</h4>
<ul>
<li><strong>必须用 Person.call(this)</strong> ：在子类构造函数中调用父类构造函数，才能继承父类的实例属性（否则子类实例不会有 name、age 等属性）；</li>
<li><strong>修复 constructor 指向</strong>：将子类原型赋值为父类实例后，子类原型的 constructor 会指向父类，需要手动改回子类；</li>
<li><strong>父类原型的引用类型属性会被所有子类实例共享</strong>：这是原型链继承的缺陷，比如父类原型有一个数组属性，所有子类实例修改这个数组都会互相影响（解决方法：组合继承，即原型链+构造函数继承，上面的例子就是组合继承）。</li>
</ul>
<h3 data-id="heading-13">五、原型链与 ES6 Class 的关系</h3>
<p>很多开发者以为 ES6 的 <code>class</code> 是 JS 新增的继承模型，但实际上，<code>class</code> 只是原型链的<strong>语法糖</strong>——它的底层实现依然是原型链，只是写法更接近传统面向对象语言，更直观。</p>
<h4 data-id="heading-14">5.1 Class 本质是构造函数</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ES6 Class</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }

  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}

<span class="hljs-comment">// Class 本质是构造函数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// function</span>

<span class="hljs-comment">// Class 的 prototype 属性依然存在</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// { constructor: ƒ Person(), sayHi: ƒ }</span>

<span class="hljs-comment">// 实例的 __proto__ 依然指向 Class 的 prototype</span>
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">20</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-15">5.2 extends 本质是原型链继承</h4>
<p>ES6 的 <code>extends</code> 实现继承，底层依然是原型链。我们用 <code>class</code> 重写上面的 Student 继承案例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }

  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}

<span class="hljs-comment">// 子类继承父类（extends 本质是原型链）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age, studentId</span>) {
    <span class="hljs-variable language_">super</span>(name, age); <span class="hljs-comment">// 相当于 Person.call(this, name, age)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">studentId</span> = studentId;
  }

  <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) { <span class="hljs-comment">// 重写父类方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, 我是学生 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>，学号：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.studentId}</span>`</span>);
  }

  <span class="hljs-title function_">study</span>(<span class="hljs-params"/>) { <span class="hljs-comment">// 子类独有方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 正在学习`</span>);
  }
}

<span class="hljs-keyword">const</span> student1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">'王五'</span>, <span class="hljs-number">18</span>, <span class="hljs-string">'2024001'</span>);

<span class="hljs-comment">// 验证原型链关系</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(student1.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Student</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>可以看到，<code>extends</code> 本质上是帮我们自动完成了“子类原型指向父类原型”的操作（Student.prototype.<strong>proto</strong> = Person.prototype），省去了手动修改原型链的麻烦。</p>
<h3 data-id="heading-16">六、原型链的实战应用场景</h3>
<p>原型链不是抽象的概念，在实际开发中有很多实用场景，掌握这些场景能让你写出更优雅、更高效的代码。</p>
<h4 data-id="heading-17">6.1 扩展内置对象的方法</h4>
<p>我们可以通过修改内置对象的原型，给所有实例添加共享方法。比如给 Array 扩展一个去重方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 给 Array 原型添加去重方法</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">unique</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(<span class="hljs-variable language_">this</span>)];
};

<span class="hljs-comment">// 所有数组实例都能调用这个方法</span>
<span class="hljs-keyword">const</span> arr1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> arr2 = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr1.<span class="hljs-title function_">unique</span>()); <span class="hljs-comment">// [1, 2, 3]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2.<span class="hljs-title function_">unique</span>()); <span class="hljs-comment">// [4, 5, 6]</span>
</code></pre>
<p>注意：尽量不要修改内置对象的原型（如 Object.prototype、Array.prototype），可能会与其他代码冲突，或覆盖原生方法。</p>
<h4 data-id="heading-18">6.2 实现对象的属性复用</h4>
<p>当多个对象需要共享一些属性/方法时，不用重复定义，而是让它们的 <code>__proto__</code> 指向同一个原型对象：</p>
<pre><code class="hljs language-ini" lang="ini">// 共享原型对象
const <span class="hljs-attr">animalProto</span> = {
  eat() {
    console.log('吃食物')<span class="hljs-comment">;</span>
  },
  sleep() {
    console.log('睡觉')<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>

// 创建两个对象，共享 animalProto 的方法
const <span class="hljs-attr">cat</span> = { name: <span class="hljs-string">'小猫'</span> }<span class="hljs-comment">;</span>
const <span class="hljs-attr">dog</span> = { name: <span class="hljs-string">'小狗'</span> }<span class="hljs-comment">;</span>

// 让两个对象的 __proto__ 指向共享原型
<span class="hljs-attr">cat.__proto__</span> = animalProto<span class="hljs-comment">;</span>
<span class="hljs-attr">dog.__proto__</span> = animalProto<span class="hljs-comment">;</span>

// 两个对象都能调用共享方法
cat.eat()<span class="hljs-comment">; // 吃食物</span>
dog.sleep()<span class="hljs-comment">; // 睡觉</span>
console.log(<span class="hljs-attr">cat.eat</span> === dog.eat)<span class="hljs-comment">; // true（共享同一个方法）</span>
</code></pre>
<h4 data-id="heading-19">6.3 理解框架中的原型链应用</h4>
<p>很多前端框架都用到了原型链。比如 React 的 Class Component，本质上就是基于原型链实现的；Vue 的实例方法（如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>t</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">mount、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">、</span></span></span></span></span>emit），也是定义在 Vue.prototype 上，让所有 Vue 实例共享。</p>
<h3 data-id="heading-20">七、常见误区</h3>
<h4 data-id="heading-21">7.1 误区 1：<strong>proto</strong> 与 prototype 混淆</h4>
<p>记住一句话：<strong>实例有 <strong>proto</strong>，构造函数有 prototype</strong>（原型对象也有 <strong>proto</strong>，因为它也是对象）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// 有（实例）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// 有（构造函数）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// 有（函数也是对象，指向 Function.prototype）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// 有（原型对象是对象，指向 Object.prototype）</span>
</code></pre>
<h4 data-id="heading-22">7.2 误区 2：原型链的终点是 Object.prototype</h4>
<p>Object.prototype 的 <strong>proto</strong> 指向 null，所以原型链的终点是 null，不是 Object.prototype：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// null</span>
</code></pre>
<h3 data-id="heading-23">八、总结</h3>
<p>原型链是 JavaScript 面向对象的底层基础，核心要点可以总结为：</p>
<ol>
<li>三个核心概念：构造函数、原型对象（prototype）、实例（<strong>proto</strong>）；</li>
<li>原型链是实例通过 <strong>proto</strong> 层层向上追溯原型形成的链条，终点是 null；</li>
<li>原型链的核心作用是实现属性/方法共享和继承；</li>
<li>ES6 Class 是原型链的语法糖，底层依然依赖原型链；</li>
<li>判断实例属性用 hasOwnProperty()，避免混淆原型属性。</li>
</ol>
<p>理解原型链的关键是“动手实践”——多写代码验证三者关系、跟踪属性查找过程，慢慢就会豁然开朗。如果本文对你有帮助，欢迎点赞、收藏、转发～ 如有疑问，欢迎在评论区交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[yoyoj-rn — RN 的脚手架工具可以不是 @react-native-community/cli]]></title>    <link>https://juejin.cn/post/7582951344518447110</link>    <guid>https://juejin.cn/post/7582951344518447110</guid>    <pubDate>2025-12-14T14:10:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582951344518447110" data-draft-id="7582997593091031059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="yoyoj-rn — RN 的脚手架工具可以不是 @react-native-community/cli"/> <meta itemprop="keywords" content="前端,React Native,NPM"/> <meta itemprop="datePublished" content="2025-12-14T14:10:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LisEcho"/> <meta itemprop="url" content="https://juejin.cn/user/800910564921214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            yoyoj-rn — RN 的脚手架工具可以不是 @react-native-community/cli
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/800910564921214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LisEcho
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:10:41.000Z" title="Sun Dec 14 2025 14:10:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e5fe7423bc54498a570ca16c0068e22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlzRWNobw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766326241&amp;x-signature=dB%2B76Cmh6g9NgtU4L%2BfAqWCpG7M%3D" alt="微信图片_20251214220928_202_108.jpg" loading="lazy"/></p>
<p>是不是感觉如果 RN 不使用 expo 搭建项目会很费劲，重复配置导航/国际化/主题，调试 Metro、SVG、路径别名花掉半天，团队间风格不统一、又怕临时改配置把项目搞崩。然而，直接使用原生脚手架搭建的项目又过于简单，什么都没有？</p>
<p>我在开发几次公司的 RN 项目后也开始有了这种苦恼——真正浪费的是“每次从头重复那些琐碎但重要的工程工作”。最终我结合几次实际的项目经验和社区一些好的做法和建议，我做了这样一个React-native 项目的脚手架 —— <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fyoyoj-rn" target="_blank" title="https://www.npmjs.com/package/yoyoj-rn" ref="nofollow noopener noreferrer">yoyoj-rn - npm</a>。</p>
<p>我的出发点很简单：把那些重复且容易出错的工程工作做好一次，然后把可复用、可扩展、对团队友好的基础能力交给大家，让我把精力放回到产品和体验本身。</p>
<p>我发布后自己试用了一段时间，做了部分功能的微调，现在已经稳定能产出一个还算让我满意的 RN 项目脚手架。这里也发布出来，希望也能给大家提供便利，同时我也虚心接受大家的一些建议，大家可以发在评论区讨论。</p>
<p>工具入口 -&gt; <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fyoyoj-rn" target="_blank" title="https://www.npmjs.com/package/yoyoj-rn" ref="nofollow noopener noreferrer">yoyoj-rn - npm</a></p>
<h2 data-id="heading-0">快速结论对比（一分钟了解差别）</h2>
<ul>
<li>RN 原生脚手架：启动快，但只给你骨架，工程能力（主题、i18n、设计 tokens、资源约定）需要自己搭；第一次可跑通但二次复用成本高。</li>
<li>yoyoj-rn 模板：启动稍微多做一点准备，但产出的是一套工程化的、可立即使用的项目结构；对团队协作、CI、AI 智能分析友好——省下来的不是几分钟，而是后续的几十到几百小时。</li>
</ul>
<h2 data-id="heading-1">主要优势（为什么会帮你省事）</h2>
<ul>
<li>一次性工程化：主题、样式 tokens、国际化、导航结构、资源约定均已实现。</li>
<li>一致性和可维护性：模板内的约定让新人能快速理解项目结构，减少沟通成本。</li>
<li>AI 友好：清晰的路径别名、统一的资源加载与命名空间，方便自动化工具或 LLM 精确索引与推断。</li>
<li>开箱即用的原子组件与工具：图标/图像按变体加载、深色模式资源自动选择、统一的 <code>useTheme()</code> 与 <code>useI18n()</code>。</li>
</ul>
<h2 data-id="heading-2">快速开始</h2>
<pre><code class="hljs language-bash" lang="bash">npx yoyoj-rn &lt;projectName&gt;
</code></pre>
<p><strong>CLI 入口：</strong><code>cli/init.js</code></p>
<p>（工作流：用 <code>@react-native-community/cli</code> 初始化 -&gt; 拷贝模版 -&gt; 注入 codegenConfig 与 TS 路径别名 -&gt; 安装依赖并初始化 Git）</p>
<p>模板里你能直接拿来用的东西（摘要）</p>
<ul>
<li>TypeScript 全量类型支持与良好的类型定义</li>
<li>React Navigation 的标准化路由与类型化参数</li>
<li>i18n（<code>useI18n</code> hook + <code>en.json</code> / <code>zh-cn.json</code>）</li>
<li>主题系统（浅色/深色/系统 + <code>useTheme()</code>）</li>
<li>原子化组件（<code>IconByVariant</code> / <code>AssetByVariant</code>）与资源组织约定</li>
<li>Axios 实例与环境配置模板（<code>dev/test/prod</code> + <code>local</code> 示例）</li>
<li>Metro 与 Babel 已配置：SVG、路径别名 <code>@</code> 指向 <code>src</code>、支持 require.context</li>
</ul>
<h2 data-id="heading-3">生成后的项目概览</h2>
<pre><code class="hljs language-bash" lang="bash">src/
├── App.tsx                  <span class="hljs-comment"># 入口，挂载 Theme 与 Navigation</span>
├── components/              <span class="hljs-comment"># 原子/模版组件（方便复用和测试）</span>
├── config/                  <span class="hljs-comment"># 环境配置（dev/test/prod/local 示例）</span>
├── hooks/                   <span class="hljs-comment"># 常用 Hook（含 i18n）</span>
├── navigation/              <span class="hljs-comment"># 路由容器与路径枚举， 类型化友好</span>
├── screens/                 <span class="hljs-comment"># 示例页面（Startup/Example）</span>
├── services/                <span class="hljs-comment"># Axios 实例等服务层封装</span>
├── themes/                  <span class="hljs-comment"># 设计 tokens（colors/fonts/layout/gutter）与资源加载约定</span>
└── translations/            <span class="hljs-comment"># i18n 资源与类型补充</span>
</code></pre>
<h2 data-id="heading-4">关键模块会怎么帮你：</h2>
<ul>
<li>入口与主题：App 已经把 <code>ThemeProvider</code>、状态栏、安全区和 Navigation 包起来了，接入新的页面只需专注 UI。</li>
<li>导航与路径：统一的 <code>paths.ts</code> + 强类型 <code>types.ts</code>，避免运行时字符串错误。</li>
<li>国际化：内置 <code>useI18n()</code>，默认命名空间与资源位置固定，方便 CI 校验和 AI 索引。</li>
<li>组件与资源：<code>IconByVariant</code>、<code>AssetByVariant</code> 支持按 light/dark/variant 自动加载，设计师资源与代码命名约定一致。</li>
</ul>
<h2 data-id="heading-5">Metro / Babel 与开发脚本</h2>
<ul>
<li>Metro 已配置 SVG 与 require.context 调试友好（见 <code>template/metro.config.js</code>）</li>
<li>Babel 路径别名 <code>@</code> 指向 <code>src</code>（见 <code>template/babel.config.js</code>）</li>
<li>常用脚本：<code>yarn start</code> / <code>yarn ios</code> / <code>yarn android</code> / <code>yarn lint</code> / <code>yarn test</code></li>
</ul>
<p>面向 AI 与团队的识别提示（让自动化工具读懂项目）</p>
<ul>
<li>全局路径别名 <code>@</code> = <code>./src</code>，便于静态分析器与智能提示。</li>
<li>主题与资源的统一入口（<code>themes</code>）使模型能准确定位颜色/字体/图片约定。</li>
<li>国际化资源和默认命名空间固定在 <code>translations</code>，便于自动化检测与翻译流水线。</li>
<li>资源加载集中在 <code>themes/assests/getAssetsContext.ts</code>（已开启 <code>unstable_allowRequireContext</code>），对代码生成或图像替换操作友好。</li>
</ul>
<p>如何在实际开发中省时间（示例场景）</p>
<ul>
<li>新页面：创建 <code>screens/</code> 子目录、注册路径到 <code>paths.ts</code>，直接使用 <code>Theme</code> 与 <code>i18n</code>，不必再配置样式系统。</li>
<li>加入图标：放到 <code>themes/assests/icons/</code> 并遵循命名规则，<code>IconByVariant</code> 自动可用。</li>
<li>环境差异：复制 <code>config/local.ts.example</code> 为 <code>local.ts</code> 并配置，不必触碰编译相关的底层设置。</li>
</ul>
<p>结语</p>
<p>如果你和我一样在多个 RN 项目之间往返，希望把时间更多花在产品与体验上而不是工程琐事，yoyoj-rn 可以当作你的工程化起点：把重复工作交给模板，把创造力还给你。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别 iframe 通信的 “飞鸽传书”：Webpage Tunnel 上手指南]]></title>    <link>https://juejin.cn/post/7583567658253287450</link>    <guid>https://juejin.cn/post/7583567658253287450</guid>    <pubDate>2025-12-14T14:19:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583567658253287450" data-draft-id="7583576612390830090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别 iframe 通信的 “飞鸽传书”：Webpage Tunnel 上手指南"/> <meta itemprop="keywords" content="JavaScript,前端框架,前端"/> <meta itemprop="datePublished" content="2025-12-14T14:19:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="parksben"/> <meta itemprop="url" content="https://juejin.cn/user/4353721774912237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别 iframe 通信的 “飞鸽传书”：Webpage Tunnel 上手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721774912237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    parksben
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T14:19:41.000Z" title="Sun Dec 14 2025 14:19:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    38
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为前端开发，你一定遇到过这样的场景：</p>
<p>老板拍着你的肩膀说：“小王啊，把隔壁组做的那个‘用户画像’页面，直接用 iframe 嵌到我们的后台里吧，顺便把当前登录的 Token 传过去，再把用户选好的标签拿回来。”</p>
<p>你心想：“这简单，页面跨 iframe 可以用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2FpostMessage" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage" ref="nofollow noopener noreferrer">postMessage</a> 方法通信。”</p>
<p>然而当你开始写代码时，噩梦开始了。</p>
<h2 data-id="heading-0">😫 以前的痛苦：像在用对讲机吵架</h2>
<p>为了在父页面和 iframe 之间传数据，你不得不使用浏览器原生的 <code>postMessage</code>。这玩意儿就像是一个<strong>公共广播</strong>。</p>
<ol>
<li><strong>父页面喊话</strong>：<code>iframe.contentWindow.postMessage('嘿！这是 Token', '*')</code></li>
<li><strong>子页面监听</strong>：<code>window.addEventListener('message', (e) =&gt; { ... })</code></li>
</ol>
<p>随着业务变复杂，你的代码很快就会变成这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 令人头秃的传统写法</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 1. 先得确认是不是自己人（安全校验）</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">'https://trusted.com'</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-comment">// 2. 解析数据，还得防着格式不对报错</span>
  <span class="hljs-keyword">const</span> data = event.<span class="hljs-property">data</span>;
  
  <span class="hljs-comment">// 3. 开始写一堆 switch-case 来判断对方到底想干啥</span>
  <span class="hljs-keyword">switch</span> (data.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'UPDATE_TOKEN'</span>:
      <span class="hljs-comment">// ...逻辑...</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'GET_USER_TAGS'</span>:
      <span class="hljs-comment">// ...逻辑...</span>
      <span class="hljs-comment">// 4. 还要想办法把结果“扔”回去</span>
      event.<span class="hljs-property">source</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'USER_TAGS_RESULT'</span>, <span class="hljs-attr">payload</span>: ... }, event.<span class="hljs-property">origin</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-comment">// ...此处省略一万行...</span>
  }
});
</code></pre>
<p>这就像两个人隔着一条河喊话，不仅费嗓子，还容易听错，而且谁都能插一嘴。维护起来简直是灾难。</p>
<h2 data-id="heading-1">😎 现在的救星：Webpage Tunnel</h2>
<p>这时候，<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparksben%2Fwebpage-tunnel" target="_blank" title="https://github.com/parksben/webpage-tunnel" ref="nofollow noopener noreferrer">Webpage Tunnel</a></strong> 登场了。</p>
<p>它的作用很简单：<strong>把那条混乱的“河”填平，给你们拉一根专线电话。</strong></p>
<p>它不再让你去处理底层的消息监听和过滤，而是让你像<strong>调用普通函数</strong>一样去跟 iframe 里的页面交流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1130f04af3514b5d97a29fa59aafc9aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGFya3NiZW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766368286&amp;x-signature=FuXX%2BVSnQWBefDmobQpCIxxhITA%3D" alt="webpage-tunnel.png" loading="lazy"/></p>
<h3 data-id="heading-2">核心理念：网页即服务 (Webpage as a Service)</h3>
<p>想象一下，你嵌入的那个 iframe 页面，不再只是一个页面，而是一个<strong>微型服务器</strong>。它对外提供了一组 API 接口，你只需要连接它，然后调用接口拿数据。</p>
<h3 data-id="heading-3">亮点一：代码变得无比清爽</h3>
<p>让我们看看用 Webpage Tunnel 怎么实现刚才的需求。</p>
<p><strong>1. 在 iframe 页面（服务方）：</strong><br/>
只需要把你的功能“注册”一下，就像开店摆摊一样。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { serve } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpage-tunnel'</span>;

<span class="hljs-comment">// 把页面里的功能打包成 API</span>
<span class="hljs-title function_">serve</span>({
  <span class="hljs-comment">// 别人调这个方法，我就更新 Token</span>
  <span class="hljs-attr">updateToken</span>: <span class="hljs-function">(<span class="hljs-params">token</span>) =&gt;</span> {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'auth_token'</span>, token);
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Token 更新成功！'</span>;
  },
  
  <span class="hljs-comment">// 别人调这个方法，我就返回标签数据</span>
  <span class="hljs-attr">getSelectedTags</span>: <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 甚至可以去后台请求数据再返回</span>
    <span class="hljs-keyword">const</span> tags = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/tags'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>());
    <span class="hljs-keyword">return</span> tags;
  }
});
</code></pre>
<p><strong>2. 在父页面（调用方）：</strong><br/>
就像打个电话一样简单，直接调用！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'webpage-tunnel'</span>;

<span class="hljs-comment">// 建立连接</span>
<span class="hljs-keyword">const</span> iframeApi = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>({
  <span class="hljs-attr">server</span>: <span class="hljs-string">'https://other-site.com/profile'</span>, <span class="hljs-comment">// 对方的地址</span>
  <span class="hljs-attr">methods</span>: [<span class="hljs-string">'updateToken'</span>, <span class="hljs-string">'getSelectedTags'</span>] <span class="hljs-comment">// 我要调用的方法名</span>
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doWork</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ✨ 见证奇迹的时刻</span>
  <span class="hljs-comment">// 不需要监听 message，不需要 switch-case，直接 await 拿结果！</span>
  
  <span class="hljs-keyword">await</span> iframeApi.<span class="hljs-title function_">updateToken</span>(<span class="hljs-string">'new-token-123'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Token 传过去了'</span>);

  <span class="hljs-keyword">const</span> tags = <span class="hljs-keyword">await</span> iframeApi.<span class="hljs-title function_">getSelectedTags</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'拿到的标签是：'</span>, tags);
}
</code></pre>
<h3 data-id="heading-4">亮点二：双向奔赴</h3>
<p>不仅仅是父页面可以调子页面，子页面也可以反过来调父页面。只要双方都 <code>serve</code>（提供服务）并 <code>new Request</code>（发起请求），就能实现无缝的双向对话。</p>
<h3 data-id="heading-5">亮点三：TypeScript 党的福音</h3>
<p>如果你用 TypeScript，体验会更上一层楼。你可以定义好接口类型，当你输入 <code>iframeApi.</code> 的时候，编辑器会自动提示有哪些方法可以调，入参是什么，返回值是什么。再也不用担心拼错单词或者传错参数了。</p>
<h2 data-id="heading-6">总结</h2>
<p><strong>Webpage Tunnel</strong> 并没有发明什么黑科技，它只是把繁琐的 <code>postMessage</code> 封装进了一个黑盒子里，留给你一套优雅、现代的 API。</p>
<ul>
<li>如果你受够了 <code>window.addEventListener</code>；</li>
<li>如果你希望 iframe 通信代码像后端接口调用一样清晰；</li>
<li>如果你想少掉几根头发；</li>
</ul>
<p>那么，Webpage Tunnel 绝对值得你尝试一下。</p>
<blockquote>
<p><strong>传送门</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparksben%2Fwebpage-tunnel" target="_blank" title="https://github.com/parksben/webpage-tunnel" ref="nofollow noopener noreferrer">GitHub 项目地址</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从命令式到声明式：用 Vue 3 构建任务清单的开发哲学]]></title>    <link>https://juejin.cn/post/7583234966635315234</link>    <guid>https://juejin.cn/post/7583234966635315234</guid>    <pubDate>2025-12-14T15:37:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583234966635315234" data-draft-id="7583168260797874216" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从命令式到声明式：用 Vue 3 构建任务清单的开发哲学"/> <meta itemprop="keywords" content="Vue.js,JavaScript,响应式编程"/> <meta itemprop="datePublished" content="2025-12-14T15:37:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tzarevich"/> <meta itemprop="url" content="https://juejin.cn/user/578786070367529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从命令式到声明式：用 Vue 3 构建任务清单的开发哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578786070367529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tzarevich
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T15:37:55.000Z" title="Sun Dec 14 2025 15:37:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">从命令式到声明式：用 Vue 3 构建任务清单的开发哲学</h2>
<p>在前端开发演进的历程中，开发者逐渐从“操作 DOM”转向“管理状态”。一个看似简单的任务清单（Todos）应用，恰恰是理解这一范式转变的绝佳入口。本文将结合 Vue 3 的 Composition API、响应式系统与模板指令，深入剖析现代前端开发的核心思想——<strong>数据驱动 UI</strong>。</p>
<hr/>
<h3 data-id="heading-1">一、传统开发 vs Vue 开发：两种思维模式</h3>
<p>在没有框架的时代，我们这样写任务输入功能：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">app</span> = document.getElementById(<span class="hljs-string">'app'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">input</span> = document.getElementById(<span class="hljs-string">'todo-input'</span>)<span class="hljs-comment">;</span>

input.addEventListener('change', (e) =&gt; {
  const <span class="hljs-attr">value</span> = e.target.value.trim()<span class="hljs-comment">;</span>
  if (value) <span class="hljs-attr">app.innerHTML</span> = value<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>这种方式称为 <strong>命令式编程</strong>：</p>
<ul>
<li>先获取 DOM 元素</li>
<li>再监听事件</li>
<li>最后手动修改 DOM</li>
</ul>
<p>问题显而易见：</p>
<ul>
<li>代码与 DOM 强耦合</li>
<li>难以维护复杂交互</li>
<li>性能差（频繁操作慢速的渲染引擎）</li>
</ul>
<p>而 Vue 的做法完全不同：</p>
<blockquote>
<p><strong>不再思考“页面元素怎么操作”，而是思考“数据如何变化”</strong> 。</p>
</blockquote>
<p>你只需定义：</p>
<ul>
<li>当前标题是什么？</li>
<li>任务列表有哪些？</li>
<li>哪些任务已完成？</li>
</ul>
<p>Vue 自动将这些数据映射到界面，并在数据变化时高效更新 DOM。这就是 <strong>声明式编程</strong> 的魅力。</p>
<hr/>
<h3 data-id="heading-2">二、Vue 3 Composition API：逻辑更清晰</h3>
<p>在 <code>App.vue</code> 中，我们使用 <code>&lt;script setup&gt;</code> 语法，这是 Vue 3.2+ 推荐的组合式 API 写法：</p>
<pre><code class="hljs language-php" lang="php">import { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">title</span> = <span class="hljs-title function_ invoke__">ref</span>(<span class="hljs-string">""</span>); <span class="hljs-comment">// 响应式字符串</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">todos</span> = <span class="hljs-title function_ invoke__">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'打王者'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'吃饭'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> }
]);
</code></pre>
<ul>
<li><code>ref()</code> 将普通值包装为响应式对象。</li>
<li>所有逻辑集中在 <code>setup</code> 中，避免 Options API 的碎片化。</li>
</ul>
<p>相比 Vue 2 的 <code>data()</code>、<code>methods</code>、<code>computed</code> 分散在不同选项，Composition API 让相关功能内聚，便于复用与测试。</p>
<hr/>
<h3 data-id="heading-3">三、核心指令：用声明式语法描述 UI</h3>
<p>Vue 的模板通过指令（<code>v-</code> 开头）实现声明式渲染：</p>
<h4 data-id="heading-4">1. <code>v-model</code>：双向绑定</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;input <span class="hljs-attr">v-model</span>=<span class="hljs-string">"title"</span> @keydown.enter=<span class="hljs-string">"addTodo"</span>&gt;
&lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> v-model=<span class="hljs-string">"todo.done"</span>&gt;
</code></pre>
<ul>
<li>输入框内容 ↔ <code>title</code></li>
<li>复选框状态 ↔ <code>todo.done</code></li>
</ul>
<p>无需手动监听 <code>input</code> 或 <code>change</code> 事件。</p>
<h4 data-id="heading-5">2. <code>v-for</code>：列表渲染</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;li <span class="hljs-attr">v-for</span>=<span class="hljs-string">"todo in todos"</span> :key=<span class="hljs-string">"todo.id"</span>&gt;
</code></pre>
<ul>
<li>自动遍历 <code>todos</code> 数组</li>
<li><code>:key</code> 提供唯一标识，提升 Diff 算法效率</li>
</ul>
<h4 data-id="heading-6">3. <code>v-if / v-else</code>：条件渲染</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"todos.length"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span>暂无计划<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li>根据数据是否存在决定显示内容</li>
</ul>
<h4 data-id="heading-7">4. 动态 class 绑定</h4>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">span</span> :class=<span class="hljs-string">"{ done: todo.done }"</span>&gt;{{ todo<span class="hljs-selector-class">.title</span> }}&lt;/<span class="hljs-selector-tag">span</span>&gt;
</code></pre>
<ul>
<li>若 <code>done</code> 为真，应用 <code>.done</code> 样式（灰色 + 删除线）</li>
</ul>
<hr/>
<h3 data-id="heading-8">四、计算属性：智能派生状态</h3>
<p>任务清单需要实时显示“未完成任务数”和“全选”功能。Vue 用 <code>computed</code> 完美解决：</p>
<h4 data-id="heading-9">1. 只读计算属性：未完成数量</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">active</span> = computed(() =&gt; {
  return todos.value.filter(<span class="hljs-attr">todo</span> =&gt; !todo.done).length<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>自动依赖 <code>todos</code></li>
<li>结果缓存，仅在 <code>todos</code> 变化时重新计算</li>
<li>模板中直接使用 <code>{{ active }}</code></li>
</ul>
<h4 data-id="heading-10">2. 可读写计算属性：全选控制</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">allDone</span> = computed({
  get() {
    return todos.value.every(<span class="hljs-attr">todo</span> =&gt; todo.done)<span class="hljs-comment">;</span>
  },
  set(val) {
    todos.value.forEach(<span class="hljs-attr">todo</span> =&gt; todo.done = val)<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>get</strong>：判断是否全部完成</li>
<li><strong>set</strong>：当用户点击“全选”复选框时，批量更新所有任务状态</li>
</ul>
<p>这体现了 Vue 对“属性”的扩展——不仅是值，还可以包含行为。</p>
<hr/>
<h3 data-id="heading-11">五、事件处理：简洁而高效</h3>
<p>添加任务只需一行逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">addTodo</span> = () =&gt; {
  if (!title.value) return<span class="hljs-comment">;</span>
  todos.value.push({
    id: Math.random(), 
    title: title.value,
    done: false
  })<span class="hljs-comment">;</span>
  <span class="hljs-attr">title.value</span> = <span class="hljs-string">''</span><span class="hljs-comment">; // 清空输入框</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p>配合 <code>@keydown.enter</code>，用户按回车即可提交，体验流畅。</p>
<hr/>
<h3 data-id="heading-12">六、开发哲学：聚焦数据，而非 DOM</h3>
<p>正如项目注释所言：</p>
<blockquote>
<p>“VUE 做法不再需要思考页面的元素怎么操作，而是要思考数据是怎么变化的。”</p>
</blockquote>
<p>这种转变带来三大优势：</p>
<ol>
<li><strong>开发效率高</strong>：无需手动操作 DOM，减少样板代码</li>
<li><strong>可维护性强</strong>：逻辑围绕数据组织，结构清晰</li>
<li><strong>性能更优</strong>：Vue 内部使用虚拟 DOM 和响应式系统，自动优化更新</li>
</ol>
<p>对新手友好，对老手高效——这正是 Vue “渐进式框架”理念的体现。</p>
<hr/>
<h3 data-id="heading-13">七、结语</h3>
<p>一个简单的任务清单，浓缩了 Vue 3 的精华：</p>
<ul>
<li><strong>响应式系统</strong>：数据变，视图自动更新</li>
<li><strong>Composition API</strong>：逻辑聚合，易于复用</li>
<li><strong>声明式模板</strong>：直观表达 UI 与状态关系</li>
<li><strong>计算属性</strong>：智能、缓存、响应式的派生数据</li>
</ul>
<p>它不仅是一个功能 demo，更是一种思维方式的启蒙：<strong>前端开发的本质，是管理状态，而非操作元素</strong>。</p>
<p>未来，你可以在此基础上扩展：</p>
<ul>
<li>本地存储（localStorage）</li>
<li>过滤视图（全部/未完成/已完成）</li>
<li>动画过渡</li>
<li>TypeScript 类型支持</li>
</ul>
<p>而这一切，都始于对“数据如何流动”的思考。</p>
<hr/>
<h3 data-id="heading-14">附录：完整的App.vue代码</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;h1&gt;任务清单&lt;/h1&gt;
    &lt;h2&gt;{{ title }}&lt;/h2&gt;
    &lt;input type="text" v-model="title" @keydown.enter="addTodo"&gt;
    &lt;ul v-if="todos.length"&gt;
      &lt;li v-for="todo in todos" :key="todo.id"&gt;
        &lt;input type="checkbox" v-model="todo.done"&gt;
        &lt;span :class="{done: todo.done}"&gt;{{ todo.title }}&lt;/span&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
    &lt;div v-else&gt;
      暂无计划
    &lt;/div&gt;
    &lt;div&gt;
      全选&lt;input type="checkbox" v-model="allDone"&gt;
      {{ active }}
      /
      {{ todos.length }}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, computed } from 'vue';

const title = ref("")
const todos = ref([
  {
    id: 1,
    title: '打王者',
    done: false
  },
  {
    id: 2,
    title: '吃饭',
    done: true
  }
])

const active = computed(() =&gt; {
  return todos.value.filter(todo =&gt; !todo.done).length
})

const addTodo = () =&gt; {
  if (!title.value) return;
  todos.value.push({
    id: Math.random,
    title: title.value,
    done: false
  })
  title.value = ''
}

const allDone = computed({
  get() {
    return todos.value.every(todo =&gt; todo.done)
  },
  set(val) {
    todos.value.forEach(todo =&gt; todo.done = val)
  }
})
&lt;/script&gt;

&lt;style&gt;
  .done {
    color: gray;
    text-decoration: line-through;
  }
&lt;/style&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 8.6 新增 clamp() 函数]]></title>    <link>https://juejin.cn/post/7583577045578973210</link>    <guid>https://juejin.cn/post/7583577045578973210</guid>    <pubDate>2025-12-15T00:04:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583577045578973210" data-draft-id="7583571595203379238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 8.6 新增 clamp() 函数"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2025-12-15T00:04:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 8.6 新增 clamp() 函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:04:26.000Z" title="Mon Dec 15 2025 00:04:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 8.6 新增 clamp() 函数</h2>
<p>你肯定遇到过这种情况：你想确保某个值始终处在一个指定范围内。</p>
<p>比如你在处理用户输入、读取配置值，或者任何需要“强制边界”的场景。</p>
<p>在这些情况下，如果能有一个内置的 clamp（夹紧/限幅）函数会非常方便。好消息是：PHP 8.6 将引入一个全新的 <code>clamp()</code> 函数，专门用来做这件事。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fphp-8-6-clamp-function" target="_blank" title="https://catchadmin.com/post/2025-12/php-8-6-clamp-function" ref="nofollow noopener noreferrer">原文链接 PHP 8.6 新增 clamp() 函数</a></p>
<h3 data-id="heading-1">什么是 clamp() 函数？</h3>
<p>PHP 8.6 的 <code>clamp()</code> 函数可以把一个值限制在指定的最小值与最大值之间。</p>
<p>它的签名如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span>, <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$min</span>, <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$max</span>): <span class="hljs-keyword">mixed</span>
</code></pre>
<p><code>clamp()</code> 接收三个参数：<code>$value</code>、<code>$min</code>、<code>$max</code>，然后判断 <code>$value</code> 是否在 <code>$min</code> 与 <code>$max</code>（包含边界）之间。</p>
<ul>
<li><strong>小于最小值</strong>：如果 <code>$value</code> 小于 <code>$min</code>，返回 <code>$min</code>。</li>
<li><strong>大于最大值</strong>：如果 <code>$value</code> 大于 <code>$max</code>，返回 <code>$max</code>。</li>
<li><strong>在范围内</strong>：如果 <code>$value</code> 位于 <code>$min</code> 与 <code>$max</code> 之间，返回 <code>$value</code>。</li>
<li><strong>异常情况</strong>：如果 <code>min &gt; max</code>，或者 <code>min/max</code> 为 <code>NAN</code>，会抛出 <code>ValueError</code>。</li>
</ul>
<p>下面是一个最简单的示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$value1</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-number">15</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 返回 15</span>
<span class="hljs-variable">$value2</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>);  <span class="hljs-comment">// 返回 10</span>
<span class="hljs-variable">$value3</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-number">25</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 返回 20</span>
</code></pre>
<p>小趣闻：很久以前我就写过一个自定义的 clamp 函数，当作项目里的工具函数来用。</p>
<h3 data-id="heading-2">使用命名参数的 clamp()</h3>
<p><code>clamp()</code> 配合命名参数会更直观，而且还能重新排序参数。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$brightness</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-attr">min</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">value</span>: <span class="hljs-variable">$brightness</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>);
</code></pre>
<h3 data-id="heading-3">真实场景用法</h3>
<p>下面是一些 <code>clamp()</code> 的实用场景。</p>
<h4 data-id="heading-4">用户输入：把百分比限制在 0 到 100</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$percentage</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$percentage</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>);
</code></pre>
<h4 data-id="heading-5">UI 滑块：把音量限制在 0 到 10</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$volume</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$volume</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
</code></pre>
<h4 data-id="heading-6">分页：把页码限制在第一页与最后一页之间</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$page</span> = <span class="hljs-title function_ invoke__">clamp</span>((<span class="hljs-keyword">int</span>)<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'page'</span>] ?? <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">$totalPages</span>);
</code></pre>
<h4 data-id="heading-7">限流：避免突发请求数超过上限</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$requests</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$requests</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$maxBurst</span>);
</code></pre>
<h4 data-id="heading-8">日期：确保预订日期在允许窗口内</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$date</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeImmutable</span>(<span class="hljs-variable">$input</span>);
<span class="hljs-variable">$start</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeImmutable</span>(<span class="hljs-string">'2025-08-15'</span>);
<span class="hljs-variable">$end</span>   = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeImmutable</span>(<span class="hljs-string">'2025-09-15'</span>);
<span class="hljs-variable">$clamped</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$date</span>, <span class="hljs-variable">$start</span>, <span class="hljs-variable">$end</span>); <span class="hljs-comment">// 会按情况返回 start/end/date</span>
</code></pre>
<h4 data-id="heading-9">几何：把角度限制在 0 到 90</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$angle</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$angle</span>, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
</code></pre>
<h4 data-id="heading-10">字符串（按字典序）：把标签限制在 “c” 到 “g”</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$tag</span> = <span class="hljs-title function_ invoke__">clamp</span>(<span class="hljs-variable">$tag</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"g"</span>);
</code></pre>
<h3 data-id="heading-11">总结</h3>
<p>PHP 8.6 的 <code>clamp()</code> 函数虽然简单，但非常实用：它能帮你用一种更干净、清晰的方式对值进行边界约束。</p>
<p>无论你在处理用户输入、配置、UI 参数，还是任何需要把值限制在某个区间的场景，<code>clamp()</code> 都能让代码更直观。</p>
<p>想了解更多，可以阅读关于 <code>clamp()</code> 的 RFC。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[字符串匹配算法]]></title>    <link>https://juejin.cn/post/7583577045578989594</link>    <guid>https://juejin.cn/post/7583577045578989594</guid>    <pubDate>2025-12-15T00:11:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583577045578989594" data-draft-id="7582896213855584271" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 字符串匹配算法"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-15T00:11:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             字符串匹配算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:11:24.000Z" title="Mon Dec 15 2025 00:11:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Rabin-Karp算法</h2>
<p>Rabin-Karp算法是一种<strong>基于哈希函数的字符串匹配算法</strong>，由 Michael O. Rabin 和 Richard M. Karp 于1987年提出，核心思想是用<strong>哈希函数</strong>将模式串和文本串中的子串转换为数值进行比较，避免大量不必要的字符比较。这个算法特别适合<strong>多模式串匹配场景</strong>，时间复杂度平均为O(n+m)，n是文本串长度，m是模式串长度。</p>
<p>Rabin-Karp算法的关键在于使用<strong>滚动哈希函数</strong>（Rolling Hash），它可以在常数时间内计算出滑动窗口的新哈希值，保证算法在大多数情况下的高效性。</p>
<h3 data-id="heading-1">算法步骤</h3>
<ol>
<li>计算模式串的哈希值</li>
<li>计算文本串中长度为m的第一个子串的哈希值（m为模式串长度）</li>
<li>在文本串上滑动窗口，对于每个位置：
<ul>
<li>使用滚动哈希技术高效计算当前窗口的哈希值</li>
<li>如果哈希值与模式串相等，则进行字符逐一比较以避免哈希冲突</li>
<li>如果完全匹配，则找到一个匹配位置</li>
</ul>
</li>
<li>重复步骤3，直到处理完整个文本串</li>
</ol>
<p>核心特性</p>
<ul>
<li><strong>基于哈希比较</strong>：通过哈希值比较代替直接字符比较</li>
<li><strong>滚动哈希</strong>：O(1)时间复杂度计算下一窗口的哈希值</li>
<li><strong>时间复杂度</strong>：平均情况O(n+m)，最坏情况O(n*m)</li>
<li><strong>空间复杂度</strong>：O(1)，只需常数额外空间</li>
<li><strong>适用范围</strong>：单模式和多模式串匹配场景，特别是多模式匹配</li>
</ul>
<h3 data-id="heading-2">基础实现</h3>
<p>接下来大家一起看下Rabin-Karp算法的部分主流语言实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabinKarp</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">PRIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">101</span>; <span class="hljs-comment">// 哈希计算使用的质数</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text, String pattern)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        
        <span class="hljs-keyword">if</span> (m &gt; n) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 计算哈希乘数，等于d^(m-1) % PRIME，用于滚动哈希计算</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; m - <span class="hljs-number">1</span>; i++) {
            h = (h * <span class="hljs-number">256</span>) % PRIME;
        }
        
        <span class="hljs-comment">// 计算模式串和第一个窗口的哈希值</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">patternHash</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">textHash</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; m; i++) {
            patternHash = (<span class="hljs-number">256</span> * patternHash + pattern.charAt(i)) % PRIME;
            textHash = (<span class="hljs-number">256</span> * textHash + text.charAt(i)) % PRIME;
        }
        
        <span class="hljs-comment">// 滑动窗口，比较哈希值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - m; i++) {
            <span class="hljs-comment">// 哈希值相等时，检查是否真正匹配</span>
            <span class="hljs-keyword">if</span> (patternHash == textHash) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m; j++) {
                    <span class="hljs-keyword">if</span> (text.charAt(i + j) != pattern.charAt(j)) {
                        match = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
                <span class="hljs-keyword">if</span> (match) {
                    <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到匹配</span>
                }
            }
            
            <span class="hljs-comment">// 计算下一个窗口的哈希值</span>
            <span class="hljs-keyword">if</span> (i &lt; n - m) {
                textHash = (<span class="hljs-number">256</span> * (textHash - text.charAt(i) * h) + text.charAt(i + m)) % PRIME;
                <span class="hljs-comment">// 处理负数哈希值</span>
                <span class="hljs-keyword">if</span> (textHash &lt; <span class="hljs-number">0</span>) {
                    textHash += PRIME;
                }
            }
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到匹配</span>
    }
    
    <span class="hljs-comment">// 打印结果</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABCABABDABACDABABCABAB"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABCABAB"</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> search(text, pattern);
        <span class="hljs-keyword">if</span> (position == -<span class="hljs-number">1</span>) {
            System.out.println(<span class="hljs-string">"未找到匹配"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"模式串在位置 "</span> + position + <span class="hljs-string">" 处匹配"</span>);
            System.out.println(text);
            <span class="hljs-comment">// 打印指示匹配位置的指针</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; position; i++) {
                System.out.print(<span class="hljs-string">" "</span>);
            }
            System.out.println(pattern);
        }
    }
}
</code></pre>
<h3 data-id="heading-3">优化：使用更好的哈希函数</h3>
<p>比如使用更复杂的哈希函数来减少冲突</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImprovedRabinKarp</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">PRIME1</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000007</span>; <span class="hljs-comment">// 第一个哈希的质数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">PRIME2</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000009</span>; <span class="hljs-comment">// 第二个哈希的质数</span>
    
    <span class="hljs-comment">// 使用双哈希来减少冲突</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text, String pattern)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        
        <span class="hljs-keyword">if</span> (m &gt; n) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 计算哈希乘数</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">h1</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">h2</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; m - <span class="hljs-number">1</span>; i++) {
            h1 = (h1 * <span class="hljs-number">256</span>) % PRIME1;
            h2 = (h2 * <span class="hljs-number">256</span>) % PRIME2;
        }
        
        <span class="hljs-comment">// 计算模式串和第一个窗口的哈希值</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">patternHash1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">patternHash2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">textHash1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">textHash2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; m; i++) {
            patternHash1 = (<span class="hljs-number">256</span> * patternHash1 + pattern.charAt(i)) % PRIME1;
            patternHash2 = (<span class="hljs-number">256</span> * patternHash2 + pattern.charAt(i)) % PRIME2;
            textHash1 = (<span class="hljs-number">256</span> * textHash1 + text.charAt(i)) % PRIME1;
            textHash2 = (<span class="hljs-number">256</span> * textHash2 + text.charAt(i)) % PRIME2;
        }
        
        <span class="hljs-comment">// 滑动窗口，比较哈希值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - m; i++) {
            <span class="hljs-comment">// 两个哈希都相等时，再进行字符比较</span>
            <span class="hljs-keyword">if</span> (patternHash1 == textHash1 &amp;&amp; patternHash2 == textHash2) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m; j++) {
                    <span class="hljs-keyword">if</span> (text.charAt(i + j) != pattern.charAt(j)) {
                        match = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
                <span class="hljs-keyword">if</span> (match) {
                    <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到匹配</span>
                }
            }
            
            <span class="hljs-comment">// 计算下一个窗口的哈希值</span>
            <span class="hljs-keyword">if</span> (i &lt; n - m) {
                textHash1 = (<span class="hljs-number">256</span> * (textHash1 - text.charAt(i) * h1) + text.charAt(i + m)) % PRIME1;
                textHash2 = (<span class="hljs-number">256</span> * (textHash2 - text.charAt(i) * h2) + text.charAt(i + m)) % PRIME2;
                
                <span class="hljs-comment">// 处理负数哈希值</span>
                <span class="hljs-keyword">if</span> (textHash1 &lt; <span class="hljs-number">0</span>) textHash1 += PRIME1;
                <span class="hljs-keyword">if</span> (textHash2 &lt; <span class="hljs-number">0</span>) textHash2 += PRIME2;
            }
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-4">优点</h3>
<ul>
<li>平均情况下时间复杂度为O(n+m)，接近线性时间</li>
<li>在多模式匹配场景下效率高</li>
<li>可以通过预处理模式串提高效率</li>
<li>滚动哈希计算使得算法高效移动窗口</li>
<li>实现相对简单，原理容易理解</li>
</ul>
<h3 data-id="heading-5">缺点</h3>
<ul>
<li>哈希冲突可能导致额外的字符比较</li>
<li>最坏情况下的时间复杂度为O(n*m)</li>
<li>哈希函数的选择对算法性能影响很大</li>
<li>需要注意数值溢出问题</li>
<li>对于短模式串和文本串，预处理开销可能抵消算法优势</li>
</ul>
<h3 data-id="heading-6">应用场景</h3>
<p>1）文档相似度检测和抄袭检测
2）网络安全中的特征码匹配
3）多模式字符串搜索引擎
4）编译器中的词法分析器</p>
<h3 data-id="heading-7">扩展：Rabin-Karp指纹算法</h3>
<p>Rabin-Karp算法的一个变种应用于文件相似度比较</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabinKarpFingerprint</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-variable">PRIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000007</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">WINDOW_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>; <span class="hljs-comment">// 指纹窗口大小</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;Long&gt; <span class="hljs-title function_">generateFingerprints</span><span class="hljs-params">(String text)</span> {
        Set&lt;Long&gt; fingerprints = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        
        <span class="hljs-keyword">if</span> (n &lt; WINDOW_SIZE) {
            fingerprints.add(calculateHash(text, n));
            <span class="hljs-keyword">return</span> fingerprints;
        }
        
        <span class="hljs-comment">// 计算第一个窗口的哈希值</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">textHash</span> <span class="hljs-operator">=</span> calculateHash(text, WINDOW_SIZE);
        fingerprints.add(textHash);
        
        <span class="hljs-comment">// 计算哈希乘数</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; WINDOW_SIZE - <span class="hljs-number">1</span>; i++) {
            h = (h * <span class="hljs-number">256</span>) % PRIME;
        }
        
        <span class="hljs-comment">// 滑动窗口，计算所有长度为WINDOW_SIZE的子串哈希值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - WINDOW_SIZE - <span class="hljs-number">1</span>; i++) {
            textHash = (<span class="hljs-number">256</span> * (textHash - text.charAt(i) * h) + text.charAt(i + WINDOW_SIZE)) % PRIME;
            <span class="hljs-keyword">if</span> (textHash &lt; <span class="hljs-number">0</span>) {
                textHash += PRIME;
            }
            fingerprints.add(textHash);
        }
        
        <span class="hljs-keyword">return</span> fingerprints;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateSimilarity</span><span class="hljs-params">(String text1, String text2)</span> {
        Set&lt;Long&gt; fingerprints1 = generateFingerprints(text1);
        Set&lt;Long&gt; fingerprints2 = generateFingerprints(text2);
        
        <span class="hljs-comment">// 计算交集大小</span>
        Set&lt;Long&gt; intersection = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(fingerprints1);
        intersection.retainAll(fingerprints2);
        
        <span class="hljs-comment">// 计算并集大小</span>
        Set&lt;Long&gt; union = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(fingerprints1);
        union.addAll(fingerprints2);
        
        <span class="hljs-comment">// 杰卡德相似度系数</span>
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) intersection.size() / union.size();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">calculateHash</span><span class="hljs-params">(String str, <span class="hljs-type">int</span> length)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++) {
            hash = (<span class="hljs-number">256</span> * hash + str.charAt(i)) % PRIME;
        }
        <span class="hljs-keyword">return</span> hash;
    }
}
</code></pre>
<h3 data-id="heading-8">扩展：子字符串哈希</h3>
<p>一些编程竞赛里也使用Rabin-Karp思想进行高效的子字符串查询</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubstringHash</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">PRIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000000007</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BASE</span> <span class="hljs-operator">=</span> <span class="hljs-number">256</span>;
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span>[] hash; <span class="hljs-comment">// 前缀哈希值</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span>[] pow;  <span class="hljs-comment">// BASE的幂</span>
    <span class="hljs-keyword">private</span> String s;    <span class="hljs-comment">// 源字符串</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SubstringHash</span><span class="hljs-params">(String s)</span> {
        <span class="hljs-built_in">this</span>.s = s;
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> s.length();
        hash = <span class="hljs-keyword">new</span> <span class="hljs-title class_">long</span>[n + <span class="hljs-number">1</span>];
        pow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">long</span>[n + <span class="hljs-number">1</span>];
        
        <span class="hljs-comment">// 预计算BASE的幂</span>
        pow[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= n; i++) {
            pow[i] = (pow[i - <span class="hljs-number">1</span>] * BASE) % PRIME;
        }
        
        <span class="hljs-comment">// 计算所有前缀的哈希值</span>
        hash[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; i++) {
            hash[i + <span class="hljs-number">1</span>] = (hash[i] * BASE + s.charAt(i)) % PRIME;
        }
    }
    
    <span class="hljs-comment">// 计算子串s[l..r]的哈希值（0-indexed）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">substringHash</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r)</span> {
        <span class="hljs-comment">// 获取s[0...r]的哈希值，减去s[0...l-1]的哈希值（需要进行适当调整）</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (hash[r + <span class="hljs-number">1</span>] - (hash[l] * pow[r - l + <span class="hljs-number">1</span>]) % PRIME) % PRIME;
        <span class="hljs-keyword">if</span> (result &lt; <span class="hljs-number">0</span>) {
            result += PRIME;
        }
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">// 检查两个子串是否相同</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">areSubstringsEqual</span><span class="hljs-params">(<span class="hljs-type">int</span> l1, <span class="hljs-type">int</span> r1, <span class="hljs-type">int</span> l2, <span class="hljs-type">int</span> r2)</span> {
        <span class="hljs-keyword">if</span> (r1 - l1 != r2 - l2) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 长度不同</span>
        }
        <span class="hljs-keyword">return</span> substringHash(l1, r1) == substringHash(l2, r2);
    }
}
</code></pre>
<h3 data-id="heading-9">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 实现 strStr()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-dna-sequences%2F" target="_blank" title="https://leetcode.cn/problems/repeated-dna-sequences/" ref="nofollow noopener noreferrer">187. 重复的DNA序列</a> - 利用Rabin-Karp滚动哈希思想解决</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-duplicate-substring%2F" target="_blank" title="https://leetcode.cn/problems/longest-duplicate-substring/" ref="nofollow noopener noreferrer">1044. 最长重复子串</a> - 结合二分查找和Rabin-Karp算法</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fstrings-differ-by-one-character%2F" target="_blank" title="https://leetcode.cn/problems/strings-differ-by-one-character/" ref="nofollow noopener noreferrer">1554. 只有一个不同字符的字符串</a></li>
</ul>
<p>Rabin-Karp算法巧妙结合哈希计算和滚动窗口技术，在字符串匹配领域提供了一种高效的解决方案，特别适合多模式匹配和大规模文本处理场景。</p>
<h2 data-id="heading-10">Boyer-Moore算法</h2>
<p>Boyer-Moore算法是一种高效的字符串匹配算法，由 Robert S. Boyer和J Strother Moore 设计于1977年。它<strong>从右向左比较</strong>字符，并利用两个启发式规则（坏字符规则和好后缀规则）在不匹配情况下实现较大跳跃，减少比较次数。Boyer-Moore算法在实际应用中大部分情况下<strong>比朴素算法和KMP算法更高效</strong>。</p>
<h3 data-id="heading-11">算法步骤</h3>
<ol>
<li>预处理模式串，构建坏字符表和好后缀表</li>
<li>将模式串对齐到文本串的开始位置</li>
<li>从模式串的最右侧字符开始比较，从右向左进行匹配</li>
<li>如果发生不匹配，通过以下规则计算跳转距离：
<ul>
<li>坏字符规则：根据不匹配字符在模式串中的最右位置决定跳转距离</li>
<li>好后缀规则：根据已匹配部分在模式串中的重复情况决定跳转距离</li>
</ul>
</li>
<li>选择两个规则中的最大跳转距离，移动模式串</li>
<li>重复步骤3-5，直到找到匹配或到达文本串末尾</li>
</ol>
<p>核心特性：</p>
<ul>
<li><strong>从右向左比较</strong>：与大多数字符串匹配算法不同，从模式串的末尾开始比较</li>
<li><strong>双规则跳转</strong>：利用坏字符规则和好后缀规则计算跳转距离</li>
<li><strong>时间复杂度</strong>：最坏情况O(m*n)，m是模式串长度，n是文本串长度；平均情况接近O(n/m)</li>
<li><strong>空间复杂度</strong>：O(k+m)，其中k是字符集大小，m是模式串长度</li>
<li><strong>适用范围</strong>：特别适合长模式串和大字符集场景</li>
</ul>
<h3 data-id="heading-12">基础实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BoyerMoore</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> R; <span class="hljs-comment">// 字符集大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] badChar; <span class="hljs-comment">// 坏字符表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] goodSuffix; <span class="hljs-comment">// 好后缀表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] borderPos; <span class="hljs-comment">// 边界位置表</span>
    <span class="hljs-keyword">private</span> String pattern; <span class="hljs-comment">// 模式串</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BoyerMoore</span><span class="hljs-params">(String pattern)</span> {
        <span class="hljs-built_in">this</span>.R = <span class="hljs-number">256</span>; <span class="hljs-comment">// ASCII字符集</span>
        <span class="hljs-built_in">this</span>.pattern = pattern;
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 初始化坏字符表</span>
        badChar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[R];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; c &lt; R; c++) {
            badChar[c] = -<span class="hljs-number">1</span>; <span class="hljs-comment">// 初始化为-1</span>
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m; j++) {
            badChar[pattern.charAt(j)] = j; <span class="hljs-comment">// 记录每个字符最右出现位置</span>
        }
        
        <span class="hljs-comment">// 初始化好后缀表和边界位置表</span>
        goodSuffix = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[m];
        borderPos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[m];
        processSuffixes();
    }
    
    <span class="hljs-comment">// 预处理好后缀表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSuffixes</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> m, j = m + <span class="hljs-number">1</span>;
        borderPos[i] = j;
        
        <span class="hljs-comment">// 计算边界位置</span>
        <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">while</span> (j &lt;= m &amp;&amp; pattern.charAt(i - <span class="hljs-number">1</span>) != pattern.charAt(j - <span class="hljs-number">1</span>)) {
                <span class="hljs-keyword">if</span> (goodSuffix[j] == <span class="hljs-number">0</span>) {
                    goodSuffix[j] = j - i;
                }
                j = borderPos[j];
            }
            i--; j--;
            borderPos[i] = j;
        }
        
        <span class="hljs-comment">// 计算好后缀表</span>
        j = borderPos[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt;= m; i++) {
            <span class="hljs-keyword">if</span> (goodSuffix[i] == <span class="hljs-number">0</span>) {
                goodSuffix[i] = j;
            }
            <span class="hljs-keyword">if</span> (i == j) {
                j = borderPos[j];
            }
        }
    }
    
    <span class="hljs-comment">// 搜索文本串中的匹配</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-type">int</span> skip;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - m; i += skip) {
            skip = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> m - <span class="hljs-number">1</span>; j &gt;= <span class="hljs-number">0</span>; j--) {
                <span class="hljs-keyword">if</span> (pattern.charAt(j) != text.charAt(i + j)) {
                    <span class="hljs-comment">// 坏字符规则</span>
                    skip = Math.max(<span class="hljs-number">1</span>, j - badChar[text.charAt(i + j)]);
                    <span class="hljs-comment">// 好后缀规则</span>
                    <span class="hljs-keyword">if</span> (j &lt; m - <span class="hljs-number">1</span>) {
                        skip = Math.max(skip, goodSuffix[j + <span class="hljs-number">1</span>]);
                    }
                    <span class="hljs-keyword">break</span>;
                }
            }
            <span class="hljs-keyword">if</span> (skip == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到匹配</span>
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 没有找到匹配</span>
    }
    
    <span class="hljs-comment">// 测试</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"HERE IS A SIMPLE EXAMPLE"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">"EXAMPLE"</span>;
        
        <span class="hljs-type">BoyerMoore</span> <span class="hljs-variable">bm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoyerMoore</span>(pattern);
        <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> bm.search(text);
        
        <span class="hljs-keyword">if</span> (position == -<span class="hljs-number">1</span>) {
            System.out.println(<span class="hljs-string">"未找到匹配"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"模式串在位置 "</span> + position + <span class="hljs-string">" 处匹配"</span>);
            System.out.println(text);
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; position; i++) {
                System.out.print(<span class="hljs-string">" "</span>);
            }
            System.out.println(pattern);
        }
    }
}
</code></pre>
<h3 data-id="heading-13">优化策略</h3>
<h4 data-id="heading-14">简化好后缀表构建</h4>
<p>对于一些应用场景，可以只使用坏字符规则，简化算法实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimplifiedBoyerMoore</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> R; <span class="hljs-comment">// 字符集大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] badChar; <span class="hljs-comment">// 坏字符表</span>
    <span class="hljs-keyword">private</span> String pattern; <span class="hljs-comment">// 模式串</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimplifiedBoyerMoore</span><span class="hljs-params">(String pattern)</span> {
        <span class="hljs-built_in">this</span>.R = <span class="hljs-number">256</span>; <span class="hljs-comment">// ASCII字符集</span>
        <span class="hljs-built_in">this</span>.pattern = pattern;
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 初始化坏字符表</span>
        badChar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[R];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; c &lt; R; c++) {
            badChar[c] = -<span class="hljs-number">1</span>; <span class="hljs-comment">// 初始化为-1</span>
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m; j++) {
            badChar[pattern.charAt(j)] = j; <span class="hljs-comment">// 记录每个字符最右出现位置</span>
        }
    }
    
    <span class="hljs-comment">// 搜索文本串中的匹配</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-type">int</span> skip;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - m; i += skip) {
            skip = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> m - <span class="hljs-number">1</span>; j &gt;= <span class="hljs-number">0</span>; j--) {
                <span class="hljs-keyword">if</span> (pattern.charAt(j) != text.charAt(i + j)) {
                    <span class="hljs-comment">// 仅使用坏字符规则</span>
                    skip = Math.max(<span class="hljs-number">1</span>, j - badChar[text.charAt(i + j)]);
                    <span class="hljs-keyword">break</span>;
                }
            }
            <span class="hljs-keyword">if</span> (skip == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到匹配</span>
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 没有找到匹配</span>
    }
}
</code></pre>
<h4 data-id="heading-15">缓存预计算结果</h4>
<p>针对需要重复搜索同一模式串的场景，可以预计算并缓存结果</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedBoyerMoore</span> {
    <span class="hljs-keyword">private</span> Map&lt;String, BoyerMoore&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text, String pattern)</span> {
        <span class="hljs-comment">// 检查缓存中是否有预计算的Boyer-Moore对象</span>
        <span class="hljs-type">BoyerMoore</span> <span class="hljs-variable">bm</span> <span class="hljs-operator">=</span> cache.get(pattern);
        <span class="hljs-keyword">if</span> (bm == <span class="hljs-literal">null</span>) {
            bm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoyerMoore</span>(pattern);
            cache.put(pattern, bm);
        }
        
        <span class="hljs-keyword">return</span> bm.search(text);
    }
}
</code></pre>
<h3 data-id="heading-16">优点</h3>
<ul>
<li>在实际应用中，大部分场景比KMP和朴素算法更高效</li>
<li>最好情况下可以跳过大量文本，实现亚线性时间复杂度</li>
<li>对于长模式串和大字符集特别有效</li>
<li>预处理跟模式串有关，与文本串长度无关</li>
</ul>
<h3 data-id="heading-17">缺点</h3>
<ul>
<li>预处理复杂，特别是好后缀表的构建</li>
<li>需要额外空间存储坏字符表和好后缀表</li>
<li>最坏情况下时间复杂度仍为O(m*n)</li>
<li>对于短模式串，预处理开销可能抵消算法优势</li>
<li>好后缀规则的实现较复杂，容易出错</li>
</ul>
<h3 data-id="heading-18">应用场景</h3>
<p>1）文本编辑器的查找功能
2）网络安全中的特征码匹配
3）自然语言处理中的关键词检索
4）大规模文本数据处理</p>
<h3 data-id="heading-19">扩展：Horspool算法</h3>
<p>Horspool算法是Boyer-Moore的简化版本，只使用坏字符规则，但是对坏字符表进行了修改</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Horspool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> R; <span class="hljs-comment">// 字符集大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] badChar; <span class="hljs-comment">// 坏字符表</span>
    <span class="hljs-keyword">private</span> String pattern; <span class="hljs-comment">// 模式串</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Horspool</span><span class="hljs-params">(String pattern)</span> {
        <span class="hljs-built_in">this</span>.R = <span class="hljs-number">256</span>; <span class="hljs-comment">// ASCII字符集</span>
        <span class="hljs-built_in">this</span>.pattern = pattern;
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 初始化坏字符表</span>
        badChar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[R];
        <span class="hljs-comment">// 所有字符默认移动模式串长度</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; c &lt; R; c++) {
            badChar[c] = m;
        }
        <span class="hljs-comment">// 模式串中的字符（除了最后一个）设置为对应值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m - <span class="hljs-number">1</span>; j++) {
            badChar[pattern.charAt(j)] = m - <span class="hljs-number">1</span> - j;
        }
    }
    
    <span class="hljs-comment">// 搜索文本串中的匹配</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (m &gt; n) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> m - <span class="hljs-number">1</span>; <span class="hljs-comment">// 从模式串最后一个字符对齐开始</span>
        <span class="hljs-keyword">while</span> (i &lt; n) {
            <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">while</span> (k &lt; m &amp;&amp; pattern.charAt(m - <span class="hljs-number">1</span> - k) == text.charAt(i - k)) {
                k++;
            }
            
            <span class="hljs-keyword">if</span> (k == m) {
                <span class="hljs-keyword">return</span> i - m + <span class="hljs-number">1</span>; <span class="hljs-comment">// 找到匹配</span>
            }
            
            <span class="hljs-comment">// 使用坏字符规则移动</span>
            i += badChar[text.charAt(i)];
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 没有找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-20">扩展：Sunday算法</h3>
<p>Sunday算法是另一种Boyer-Moore的变种，它关注的是文本串中模式串后面的字符</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sunday</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> R; <span class="hljs-comment">// 字符集大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] shift; <span class="hljs-comment">// 移动表</span>
    <span class="hljs-keyword">private</span> String pattern; <span class="hljs-comment">// 模式串</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Sunday</span><span class="hljs-params">(String pattern)</span> {
        <span class="hljs-built_in">this</span>.R = <span class="hljs-number">256</span>; <span class="hljs-comment">// ASCII字符集</span>
        <span class="hljs-built_in">this</span>.pattern = pattern;
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 初始化移动表</span>
        shift = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[R];
        <span class="hljs-comment">// 所有字符默认移动模式串长度+1</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; c &lt; R; c++) {
            shift[c] = m + <span class="hljs-number">1</span>;
        }
        <span class="hljs-comment">// 模式串中的字符设置为对应值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; m; j++) {
            shift[pattern.charAt(j)] = m - j;
        }
    }
    
    <span class="hljs-comment">// 搜索文本串中的匹配</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (m &gt; n) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 从文本串开始位置</span>
        <span class="hljs-keyword">while</span> (i &lt;= n - m) {
            <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">while</span> (j &lt; m &amp;&amp; pattern.charAt(j) == text.charAt(i + j)) {
                j++;
            }
            
            <span class="hljs-keyword">if</span> (j == m) {
                <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到匹配</span>
            }
            
            <span class="hljs-comment">// 下一个位置超出文本串长度，返回-1</span>
            <span class="hljs-keyword">if</span> (i + m &gt;= n) {
                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
            }
            
            <span class="hljs-comment">// 使用Sunday算法的移动规则</span>
            i += shift[text.charAt(i + m)];
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 没有找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-21">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 实现strStr()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-substring-pattern%2F" target="_blank" title="https://leetcode.cn/problems/repeated-substring-pattern/" ref="nofollow noopener noreferrer">459. 重复的子字符串</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-string-match%2F" target="_blank" title="https://leetcode.cn/problems/repeated-string-match/" ref="nofollow noopener noreferrer">686. 重复叠加字符串匹配</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-happy-prefix%2F" target="_blank" title="https://leetcode.cn/problems/longest-happy-prefix/" ref="nofollow noopener noreferrer">1392. 最长快乐前缀</a></li>
</ul>
<h2 data-id="heading-22">KMP算法</h2>
<p>KMP（Knuth-Morris-Pratt）算法是一种高效的字符串匹配算法，核心思想是<strong>利用已经部分匹配的信息，避免重复比较</strong>，在文本串中快速查找模式串。KMP算法特别适合<strong>处理长文本和重复性高的模式串</strong>，时间复杂度是O(m+n)，m是模式串长度，n是文本串长度。</p>
<p>KMP算法的关键在于构建一个部分匹配表（也叫失败函数或者next数组），这个表记录了当匹配失败时，模式串指针应该回退到的位置，让算法跳过已知不可能匹配的位置，提高匹配效率。</p>
<h3 data-id="heading-23">算法步骤</h3>
<p>KMP算法主要分为两个阶段：</p>
<ol>
<li><strong>预处理阶段</strong>：计算模式串的部分匹配表（next数组）
<ul>
<li>构建一个数组，记录每个位置的最长相等前后缀长度</li>
<li>该数组用于在匹配失败时确定模式串指针的回退位置</li>
</ul>
</li>
<li><strong>匹配阶段</strong>：使用部分匹配表在文本串中查找模式串
<ul>
<li>从左到右同时遍历文本串和模式串</li>
<li>当字符不匹配时，根据next数组回退模式串指针</li>
<li>当模式串完全匹配时，记录匹配位置并继续查找其他匹配</li>
</ul>
</li>
</ol>
<p>核心特性：</p>
<ul>
<li><strong>线性时间复杂度</strong>：O(m+n)，其中m是模式串长度，n是文本串长度</li>
<li><strong>高效利用历史信息</strong>：通过预处理避免了重复比较</li>
<li><strong>只需一次遍历文本串</strong>：文本串指针不会回退</li>
<li><strong>空间复杂度</strong>：O(m)，仅需存储模式串的部分匹配表</li>
<li><strong>适用场景</strong>：特别适合长文本和具有重复性的模式串</li>
</ul>
<h3 data-id="heading-24">基础实现</h3>
<h4 data-id="heading-25">暴力解法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NaiveStringMatcher</span> {
    
    <span class="hljs-comment">/**
     * 朴素字符串匹配算法
     * <span class="hljs-doctag">@param</span> text 文本串
     * <span class="hljs-doctag">@param</span> pattern 模式串
     * <span class="hljs-doctag">@return</span> 匹配成功则返回模式串在文本串中的起始位置，否则返回-1
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">naiveSearch</span><span class="hljs-params">(String text, String pattern)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 特殊情况处理</span>
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (n &lt; m) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        
        <span class="hljs-comment">// 尝试所有可能的匹配位置</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= n - m; i++) {
            <span class="hljs-type">int</span> j;
            
            <span class="hljs-comment">// 从当前位置开始比较模式串和文本串</span>
            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; m; j++) {
                <span class="hljs-keyword">if</span> (text.charAt(i + j) != pattern.charAt(j)) {
                    <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 发现不匹配字符，终止内层循环</span>
                }
            }
            
            <span class="hljs-comment">// 如果j等于m，说明模式串完全匹配</span>
            <span class="hljs-keyword">if</span> (j == m) {
                <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 返回匹配位置</span>
            }
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到匹配</span>
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABDABACDABABCABAB"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABCABAB"</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> naiveSearch(text, pattern);
        
        <span class="hljs-keyword">if</span> (position == -<span class="hljs-number">1</span>) {
            System.out.println(<span class="hljs-string">"未找到匹配"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"模式串在位置 "</span> + position + <span class="hljs-string">" 处匹配"</span>);
        }
    }
}
</code></pre>
<p>上述实现暴力枚举所有可能的匹配位置，逐一比较文本串与模式串的每个字符，直到找到完全匹配或确定不存在匹配</p>
<h4 data-id="heading-26">KMP算法的实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KMP</span> {
    <span class="hljs-comment">// 构建部分匹配表（next数组）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] buildNext(String pattern) {
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        <span class="hljs-type">int</span>[] next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[m];
        next[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">// 第一个字符的最长相等前后缀长度为0</span>
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, j = <span class="hljs-number">0</span>; i &lt; m; i++) {
            <span class="hljs-comment">// 当前字符不匹配，回退j</span>
            <span class="hljs-keyword">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; pattern.charAt(i) != pattern.charAt(j)) {
                j = next[j - <span class="hljs-number">1</span>];
            }
            
            <span class="hljs-comment">// 当前字符匹配，j向前移动</span>
            <span class="hljs-keyword">if</span> (pattern.charAt(i) == pattern.charAt(j)) {
                j++;
            }
            
            <span class="hljs-comment">// 记录当前位置的最长相等前后缀长度</span>
            next[i] = j;
        }
        
        <span class="hljs-keyword">return</span> next;
    }
    
    <span class="hljs-comment">// KMP搜索算法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kmpSearch</span><span class="hljs-params">(String text, String pattern)</span> {
        <span class="hljs-keyword">if</span> (pattern == <span class="hljs-literal">null</span> || pattern.length() == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-keyword">if</span> (text == <span class="hljs-literal">null</span> || text.length() &lt; pattern.length()) {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 构建next数组</span>
        <span class="hljs-type">int</span>[] next = buildNext(pattern);
        
        <span class="hljs-comment">// 进行匹配</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; n; i++) {
            <span class="hljs-comment">// 当前字符不匹配，根据next数组回退j</span>
            <span class="hljs-keyword">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; text.charAt(i) != pattern.charAt(j)) {
                j = next[j - <span class="hljs-number">1</span>];
            }
            
            <span class="hljs-comment">// 当前字符匹配，j向前移动</span>
            <span class="hljs-keyword">if</span> (text.charAt(i) == pattern.charAt(j)) {
                j++;
            }
            
            <span class="hljs-comment">// 完全匹配，返回起始索引</span>
            <span class="hljs-keyword">if</span> (j == m) {
                <span class="hljs-keyword">return</span> i - m + <span class="hljs-number">1</span>;
            }
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 未找到匹配</span>
    }
    
    <span class="hljs-comment">// 查找所有匹配位置</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Integer&gt; <span class="hljs-title function_">kmpSearchAll</span><span class="hljs-params">(String text, String pattern)</span> {
        List&lt;Integer&gt; positions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">if</span> (pattern == <span class="hljs-literal">null</span> || pattern.length() == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> positions;
        }
        
        <span class="hljs-keyword">if</span> (text == <span class="hljs-literal">null</span> || text.length() &lt; pattern.length()) {
            <span class="hljs-keyword">return</span> positions;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
        
        <span class="hljs-comment">// 构建next数组</span>
        <span class="hljs-type">int</span>[] next = buildNext(pattern);
        
        <span class="hljs-comment">// 进行匹配</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; n; i++) {
            <span class="hljs-comment">// 当前字符不匹配，回退j</span>
            <span class="hljs-keyword">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; text.charAt(i) != pattern.charAt(j)) {
                j = next[j - <span class="hljs-number">1</span>];
            }
            
            <span class="hljs-comment">// 当前字符匹配，j向前移动</span>
            <span class="hljs-keyword">if</span> (text.charAt(i) == pattern.charAt(j)) {
                j++;
            }
            
            <span class="hljs-comment">// 完全匹配，记录位置并继续匹配</span>
            <span class="hljs-keyword">if</span> (j == m) {
                positions.add(i - m + <span class="hljs-number">1</span>);
                <span class="hljs-comment">// 回退j以寻找下一个匹配</span>
                j = next[j - <span class="hljs-number">1</span>];
            }
        }
        
        <span class="hljs-keyword">return</span> positions;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABDABACDABABCABAB"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ABABCABAB"</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> kmpSearch(text, pattern);
        List&lt;Integer&gt; allPos = kmpSearchAll(text, pattern);
        
        System.out.println(<span class="hljs-string">"文本: "</span> + text);
        System.out.println(<span class="hljs-string">"模式: "</span> + pattern);
        System.out.println(<span class="hljs-string">"首次匹配位置: "</span> + (pos != -<span class="hljs-number">1</span> ? pos : <span class="hljs-string">"未找到"</span>));
        System.out.println(<span class="hljs-string">"所有匹配位置: "</span> + allPos);
        
        <span class="hljs-comment">// 打印next数组，帮助理解</span>
        <span class="hljs-type">int</span>[] next = buildNext(pattern);
        System.out.print(<span class="hljs-string">"next数组: "</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> val : next) {
            System.out.print(val + <span class="hljs-string">" "</span>);
        }
        System.out.println();
    }
}
</code></pre>
<p>在上述代码中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 当前字符不匹配，回退j</span>
<span class="hljs-keyword">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; text.charAt(i) != pattern.charAt(j)) {
    j = next[j - <span class="hljs-number">1</span>];
}
</code></pre>
<p>是 KMP 算法的核心，在匹配失败时根据预先计算的next数组来确定模式串指针的回退位置。</p>
<h3 data-id="heading-27">优化</h3>
<p>优化后的 next 数组</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化next数组，避免匹配失败后回退到同样会失败的位置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] buildOptimizedNext(String pattern) {
    <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
    <span class="hljs-type">int</span>[] next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[m];
    next[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, j = <span class="hljs-number">0</span>; i &lt; m; i++) {
        <span class="hljs-keyword">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; pattern.charAt(i) != pattern.charAt(j)) {
            j = next[j - <span class="hljs-number">1</span>];
        }
        
        <span class="hljs-keyword">if</span> (pattern.charAt(i) == pattern.charAt(j)) {
            j++;
        }
        
        <span class="hljs-comment">// 当前位置匹配失败时，如果回退位置的字符与当前位置相同，则继续回退</span>
        <span class="hljs-keyword">if</span> (i + <span class="hljs-number">1</span> &lt; m &amp;&amp; pattern.charAt(i + <span class="hljs-number">1</span>) == pattern.charAt(j)) {
            next[i] = next[j - <span class="hljs-number">1</span>];
        } <span class="hljs-keyword">else</span> {
            next[i] = j;
        }
    }
    
    <span class="hljs-keyword">return</span> next;
}
</code></pre>
<p>预处理减少分支实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 预处理字符映射，减少字符比较的分支</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kmpSearchOptimized</span><span class="hljs-params">(String text, String pattern)</span> {
    <span class="hljs-keyword">if</span> (pattern == <span class="hljs-literal">null</span> || pattern.length() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-keyword">if</span> (text == <span class="hljs-literal">null</span> || text.length() &lt; pattern.length()) {
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
    
    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> text.length();
    <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> pattern.length();
    
    <span class="hljs-comment">// 使用数组映射来加速字符比较（假设字符集为ASCII）</span>
    <span class="hljs-comment">// 为每个模式字符的每个位置创建一个状态转移表</span>
    <span class="hljs-type">int</span>[][] dfa = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">256</span>][m];
    
    <span class="hljs-comment">// 初始化第一个字符的DFA</span>
    dfa[pattern.charAt(<span class="hljs-number">0</span>)][<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">X</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, j = <span class="hljs-number">1</span>; j &lt; m; j++) {
        <span class="hljs-comment">// 复制匹配失败情况下的值</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; c &lt; <span class="hljs-number">256</span>; c++) {
            dfa[c][j] = dfa[c][X];
        }
        <span class="hljs-comment">// 设置匹配成功情况下的值</span>
        dfa[pattern.charAt(j)][j] = j + <span class="hljs-number">1</span>;
        <span class="hljs-comment">// 更新重启状态</span>
        X = dfa[pattern.charAt(j)][X];
    }
    
    <span class="hljs-comment">// 模式匹配</span>
    <span class="hljs-type">int</span> i, j;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; n &amp;&amp; j &lt; m; i++) {
        j = dfa[text.charAt(i)][j];
    }
    
    <span class="hljs-keyword">if</span> (j == m) {
        <span class="hljs-keyword">return</span> i - m; <span class="hljs-comment">// 找到匹配</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;    <span class="hljs-comment">// 未找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-28">优点</h3>
<ul>
<li>时间复杂度为O(m+n)，优于朴素的字符串匹配算法(暴力解法)</li>
<li>文本串只需扫描一次，不会回退</li>
<li>对于包含重复模式的字符串会高效</li>
<li>预处理模式串，可以多次用于不同的文本串</li>
<li>能快速跳过已知不会匹配的位置</li>
</ul>
<h3 data-id="heading-29">缺点</h3>
<ul>
<li>需要额外的空间存储next数组</li>
<li>构建next数组的逻辑较为复杂，不易理解</li>
<li>在模式串较短或无重复模式时，相比简单算法优势不明显</li>
<li>实现时容易出错，特别是处理边界情况</li>
</ul>
<h3 data-id="heading-30">应用场景</h3>
<p>1）生物信息学中的DNA序列匹配
2）网络入侵检测系统中的模式匹配
3）搜索引擎的关键词匹配
4）数据压缩算法中的模式识别</p>
<h3 data-id="heading-31">扩展：多模式字符串匹配</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Aho-Corasick算法 - KMP的多模式扩展</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AhoCorasick</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrieNode</span> {
        TrieNode[] children = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>[<span class="hljs-number">256</span>];
        TrieNode fail;
        List&lt;Integer&gt; patternIndices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">TrieNode</span><span class="hljs-params">()</span> {
            fail = <span class="hljs-literal">null</span>;
        }
    }
    
    <span class="hljs-keyword">private</span> TrieNode root;
    <span class="hljs-keyword">private</span> String[] patterns;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AhoCorasick</span><span class="hljs-params">(String[] patterns)</span> {
        <span class="hljs-built_in">this</span>.patterns = patterns;
        buildTrie();
        buildFailureLinks();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildTrie</span><span class="hljs-params">()</span> {
        root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; patterns.length; i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> patterns[i];
            <span class="hljs-type">TrieNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> root;
            
            <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> c : pattern.toCharArray()) {
                <span class="hljs-keyword">if</span> (node.children[c] == <span class="hljs-literal">null</span>) {
                    node.children[c] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>();
                }
                node = node.children[c];
            }
            
            node.patternIndices.add(i);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildFailureLinks</span><span class="hljs-params">()</span> {
        Queue&lt;TrieNode&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 初始化根节点的子节点</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++) {
            <span class="hljs-keyword">if</span> (root.children[i] != <span class="hljs-literal">null</span>) {
                root.children[i].fail = root;
                queue.offer(root.children[i]);
            } <span class="hljs-keyword">else</span> {
                root.children[i] = root;
            }
        }
        
        <span class="hljs-comment">// BFS构建失败链接</span>
        <span class="hljs-keyword">while</span> (!queue.isEmpty()) {
            <span class="hljs-type">TrieNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> queue.poll();
            
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++) {
                <span class="hljs-keyword">if</span> (node.children[i] != <span class="hljs-literal">null</span>) {
                    <span class="hljs-type">TrieNode</span> <span class="hljs-variable">failNode</span> <span class="hljs-operator">=</span> node.fail;
                    
                    <span class="hljs-keyword">while</span> (failNode != root &amp;&amp; failNode.children[i] == <span class="hljs-literal">null</span>) {
                        failNode = failNode.fail;
                    }
                    
                    failNode = failNode.children[i];
                    node.children[i].fail = failNode;
                    
                    <span class="hljs-comment">// 合并匹配结果</span>
                    node.children[i].patternIndices.addAll(failNode.patternIndices);
                    
                    queue.offer(node.children[i]);
                }
            }
        }
    }
    
    <span class="hljs-keyword">public</span> List&lt;Pair&lt;Integer, Integer&gt;&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(String text)</span> {
        List&lt;Pair&lt;Integer, Integer&gt;&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">TrieNode</span> <span class="hljs-variable">currentState</span> <span class="hljs-operator">=</span> root;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
            <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> text.charAt(i);
            
            <span class="hljs-keyword">while</span> (currentState != root &amp;&amp; currentState.children[c] == <span class="hljs-literal">null</span>) {
                currentState = currentState.fail;
            }
            
            currentState = currentState.children[c];
            
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> patternIndex : currentState.patternIndices) {
                <span class="hljs-type">int</span> <span class="hljs-variable">endPos</span> <span class="hljs-operator">=</span> i;
                <span class="hljs-type">int</span> <span class="hljs-variable">startPos</span> <span class="hljs-operator">=</span> endPos - patterns[patternIndex].length() + <span class="hljs-number">1</span>;
                results.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Pair</span>&lt;&gt;(patternIndex, startPos));
            }
        }
        
        <span class="hljs-keyword">return</span> results;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Pair</span>&lt;K, V&gt; {
        K first;
        V second;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Pair</span><span class="hljs-params">(K first, V second)</span> {
            <span class="hljs-built_in">this</span>.first = first;
            <span class="hljs-built_in">this</span>.second = second;
        }
    }
}
</code></pre>
<h3 data-id="heading-32">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 找出字符串中第一个匹配项的下标</a> - 标准的字符串匹配问题</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fshortest-palindrome%2F" target="_blank" title="https://leetcode.cn/problems/shortest-palindrome/" ref="nofollow noopener noreferrer">214. 最短回文串</a> - 可以使用KMP算法的next数组思想解决</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-substring-pattern%2F" target="_blank" title="https://leetcode.cn/problems/repeated-substring-pattern/" ref="nofollow noopener noreferrer">459. 重复的子字符串</a> - 使用KMP的next数组判断字符串是否由重复子串构成</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-happy-prefix%2F" target="_blank" title="https://leetcode.cn/problems/longest-happy-prefix/" ref="nofollow noopener noreferrer">1392. 最长快乐前缀</a></li>
</ul>
<p>KMP算法是字符串处理中的经典算法，用来解决字符串匹配问题，理解它对提升算法设计能力还是很有帮助的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%]]></title>    <link>https://juejin.cn/post/7583325900294766592</link>    <guid>https://juejin.cn/post/7583325900294766592</guid>    <pubDate>2025-12-15T00:17:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583325900294766592" data-draft-id="7583507286317481984" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-15T00:17:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:17:15.000Z" title="Mon Dec 15 2025 00:17:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>ES2023（ECMAScript 2023）是 JavaScript 语言的最新版本，带来了多项实用且强大的新特性。这些特性不仅提升了开发效率，还优化了代码的可读性和性能。本文将深入解析其中 7 个最重要的新特性，尤其是第 5 个特性，它能够显著减少代码量，让开发更加高效。无论你是前端开发者还是全栈工程师，掌握这些特性都将为你的项目带来质的飞跃。</p>
<hr/>
<h3 data-id="heading-2">1. Array.prototype.findLast() 和 findLastIndex()</h3>
<p>ES2023 为数组新增了两个方法：<code>findLast()</code> 和 <code>findLastIndex()</code>。它们的作用是从数组的末尾开始查找元素，而不是传统的从开头查找。</p>
<h4 data-id="heading-3">使用场景</h4>
<p>假设有一个数组 <code>[1, 2, 3, 4, 5, 2]</code>，你想找到最后一个值为 <code>2</code> 的元素或其索引。在 ES2023 之前，你需要手动逆序遍历数组或使用 <code>Array.reverse()</code>，现在可以直接调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>];
<span class="hljs-keyword">const</span> lastTwo = arr.<span class="hljs-title function_">findLast</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item === <span class="hljs-number">2</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-keyword">const</span> lastTwoIndex = arr.<span class="hljs-title function_">findLastIndex</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item === <span class="hljs-number">2</span>); <span class="hljs-comment">// 5</span>
</code></pre>
<h4 data-id="heading-4"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>避免手动逆序遍历</strong>：简化了从后向前查找的逻辑。</li>
<li><strong>性能优化</strong>：无需创建反转数组的副本（<code>reverse()</code>会修改原数组）。</li>
</ul>
<hr/>
<h3 data-id="heading-5">2. Hashbang Grammar（Shebang）支持</h3>
<p>ES2023 正式支持 Hashbang（即 <code>#!</code>）语法，使得 JavaScript 文件可以直接作为脚本运行。</p>
<h4 data-id="heading-6"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello from a Node.js script!"</span>);
</code></pre>
<h4 data-id="heading-7"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>标准化脚本执行</strong>：让 JavaScript CLI工具的开发更加规范化。</li>
<li><strong>跨平台兼容性</strong>：Unix/Linux系统可以直接识别并执行带有Shebang的脚本。</li>
</ul>
<hr/>
<h3 data-id="heading-8">3. Symbols as WeakMap Keys</h3>
<p>ES2023允许将<code>Symbol</code>作为<code>WeakMap</code>的键值，这为元编程和内存管理提供了更多可能性。</p>
<h4 data-id="heading-9"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> weakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
<span class="hljs-keyword">const</span> key = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'privateData'</span>);
weakMap.<span class="hljs-title function_">set</span>(key, { <span class="hljs-attr">secret</span>: <span class="hljs-string">'123'</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(weakMap.<span class="hljs-title function_">get</span>(key)); <span class="hljs-comment">// { secret: '123' }</span>
</code></pre>
<h4 data-id="heading-10"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>隐私保护</strong>：Symbol作为键可以防止外部直接访问数据。</li>
<li><strong>内存管理</strong>：WeakMap不会阻止垃圾回收器回收键对象的内存。</li>
</ul>
<hr/>
<h3 data-id="heading-11">4. Array.prototype.toReversed(), toSorted(), toSpliced(), and with()</h3>
<p>ES2023新增了四个非破坏性数组方法，它们不会修改原数组，而是返回一个新的数组副本。</p>






























<table><thead><tr><th>方法</th><th>作用</th><th>传统方式对比</th></tr></thead><tbody><tr><td><code>toReversed()</code></td><td>返回逆序数组</td><td><code>[...arr].reverse()</code></td></tr><tr><td><code>toSorted()</code></td><td>返回排序后的数组</td><td><code>[...arr].sort()</code></td></tr><tr><td><code>toSpliced(start, deleteCount, ...items)</code></td><td>返回拼接后的数组</td><td>手动复制并操作</td></tr><tr><td><code>with(index, value)</code></td><td>替换指定位置的元素并返回新数组</td><td>手动复制并赋值</td></tr></tbody></table>
<h4 data-id="heading-12"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, —<span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> sorted = arr.<span class="hljs-title function_">toSorted</span>(); <span class="hljs-comment">// [—5, 1, 2]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1, 2,—5] （原数组不变）</span>
</code></pre>
<h4 data-id="heading-13"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>不可变性支持</strong>：函数式编程中更安全地操作数据。</li>
<li><strong>减少错误</strong>：避免意外修改原数组的问题。</li>
</ul>
<hr/>
<h3 data-id="heading-14">5. #5: Records &amp; Tuples Proposal (Stage 2) ——代码量减少50%的关键！</h3>
<p>这是本文的重磅特性！虽然它目前处于 Stage 2（尚未正式纳入ES2023），但已经可以通过Babel或TypeScript尝鲜使用。它引入了两个新的数据结构：<strong>Record（不可变对象）和Tuple（不可变数组）</strong>。</p>
<h4 data-id="heading-15"><strong>核心优势</strong></h4>
<ul>
<li><strong>深度不可变</strong>:  数据一旦创建就无法修改。</li>
<li><strong>结构共享</strong>:  类似Immer.js的性能优化。</li>
<li><strong>值类型比较</strong>:  可以直接用 <code>===</code>比较内容是否相同。</li>
</ul>
<h4 data-id="heading-16"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Record（类似对象）</span>
<span class="hljs-keyword">const</span> record = #{ <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>,<span class="hljs-attr">y</span>: <span class="hljs-number">2</span> };
<span class="hljs-comment">// Tuple（类似数组）</span>
<span class="hljs-keyword">const</span> tuple = #[<span class="hljs-number">1</span>,<span class="hljs-string">"hello"</span>,<span class="hljs-literal">true</span>];
</code></pre>
<h4 data-id="heading-17"><strong>实际应用</strong></h4>
<p>假设你有一个函数需要比较两个配置对象是否相同：</p>
<h5 data-id="heading-18"><strong>传统方式</strong></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isEqual</span>(<span class="hljs-params">a,b</span>){
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(a)===<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(b);
}
</code></pre>
<h5 data-id="heading-19"><strong>Records &amp; Tuples方式</strong></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isEqual</span>(<span class="hljs-params">a,b</span>){
    <span class="hljs-keyword">return</span> a===b;
}
</code></pre>
<p>不仅如此，React组件的props比较、Redux的状态管理等场景都可以大幅简化！</p>
<h5 data-id="heading-20"> 为什么能减少50%代码量？</h5>
<ol>
<li> 不再需要深拷贝/深比较工具函数（如lodash.isEqual）。</li>
<li> 不需要Immutable.js这样的第三方库。</li>
<li> 简化React的shouldComponentUpdate逻辑。</li>
</ol>
<hr/>
<h3 data-id="heading-21">6. Error Cause Chains (Error实例新增cause属性)</h3>
<p>ES2023允许在抛出错误时链式传递根本原因。</p>
<h4 data-id="heading-22"> 示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span>{
    <span class="hljs-title function_">connectToDatabase</span>();
}<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Failed to initialize app"</span>,{ <span class="hljs-attr">cause</span>:err });
}
</code></pre>
<p>捕获时可以访问完整的错误链：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span>{
    <span class="hljs-title function_">initApp</span>();
}<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">cause</span>);<span class="hljs-comment">//原始数据库错误</span>
}
</code></pre>
<h4 data-id="heading-23"> 为什么重要？</h4>
<ul>
<li> 更好的错误调试体验。</li>
<li> 保持完整的错误上下文。</li>
</ul>
<hr/>
<h3 data-id="heading-24">7. Array Grouping (Stage 3提案)</h3>
<p>虽然不是正式标准的一部分，但Chrome已经实现了这个功能。</p>
<p>通过groupBy方法可以轻松实现SQL式的分组操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> inventory=[
    {<span class="hljs-attr">name</span>:<span class="hljs-string">"asparagus"</span>,<span class="hljs-attr">type</span>:<span class="hljs-string">"vegetables"</span>},
    {<span class="hljs-attr">name</span>:<span class="hljs-string">"bananas"</span>,<span class="hljs-attr">type</span>:<span class="hljs-string">"fruit"</span>},
];
<span class="hljs-keyword">const</span> result=inventory.<span class="hljs-title function_">groupBy</span>(<span class="hljs-function">(<span class="hljs-params">{type}</span>)=&gt;</span>type);
<span class="hljs-comment">/*结果:
{
vegetables:[...],
fruit:[...]
}
*/</span>
</code></pre>
<p>对比传统方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//以前需要reduce实现分组...</span>
</code></pre>
<hr/>
<p>##总结</p>
<p>ES2023的新特性覆盖了从数据结构到错误处理等多个方面：</p>
<p>✔️ findLast()让逆向查找更简单(20行→1行)<br/>
✔️ Records/Tuples可能改变我们处理不可变数据的方式(100行→50行)<br/>
✔️ Error Cause让错误处理更专业</p>
<p>建议你现在就尝试第5个特性——虽然还不是正式标准，但它代表了JavaScript未来的发展方向！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型如何分辨 “狼” 和 “狗” —— 词向量的训练过程]]></title>    <link>https://juejin.cn/post/7583260493851525161</link>    <guid>https://juejin.cn/post/7583260493851525161</guid>    <pubDate>2025-12-15T00:19:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493851525161" data-draft-id="7583168260797169704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型如何分辨 “狼” 和 “狗” —— 词向量的训练过程"/> <meta itemprop="keywords" content="人工智能,LLM,Python"/> <meta itemprop="datePublished" content="2025-12-15T00:19:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="印刻君"/> <meta itemprop="url" content="https://juejin.cn/user/572216818014568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型如何分辨 “狼” 和 “狗” —— 词向量的训练过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/572216818014568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    印刻君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:19:25.000Z" title="Mon Dec 15 2025 00:19:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没有想过, 大模型世界里只有数字, 它是怎么知道 “狼” 和 “狗” 差异明显, “狗” 和 “犬” 意思相近的呢?</p>
<p>今天我们不谈复杂的句子理解, 只聚焦语言最基础的单元: 单个词.</p>
<p>我是印刻君, 一位探索 AI 的前端程序员, 关注我, 让 AI 知识有温度, 技术落地有深度.</p>
<p>计算机不认识文字, 只认识数字. 所以, 第一步是把文字变成数字. 最直接的方法, 就是给每个词 (Token) 分配一个唯一编号, 这就是 <strong>Token ID</strong>.</p>
<blockquote>
<p>严格来说, Token 是介于二者之间的 "子词", 但这不影响核心逻辑.</p>
<p>相关细节, 可以阅读我的另一篇文章: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlTSQfqPzxhPw9k-TDkf3zg" target="_blank" title="https://mp.weixin.qq.com/s/lTSQfqPzxhPw9k-TDkf3zg" ref="nofollow noopener noreferrer">Token 到底怎么"变"的? 大模型分词的核心逻辑</a></p>
</blockquote>
<p>以中文轻量级模型 <code>BAAI/bge-small-zh</code> 为例:</p>





























<table><thead><tr><th>Token</th><th>Token ID</th></tr></thead><tbody><tr><td>犬</td><td>4305</td></tr><tr><td>...</td><td>...</td></tr><tr><td>狗</td><td>4318</td></tr><tr><td>...</td><td>...</td></tr><tr><td>狼</td><td>4331</td></tr></tbody></table>
<p>单看编号, “狼” 和 “狗” 相差 13, “狗” 和 “犬” 也相差 13 —— 从数字上看二者关系完全对等. 但我们都知道, “狼” 很凶猛, “狗” 很忠诚, “犬” 则是 “狗” 的同义词.</p>
<p>这暴露了 Token ID 的本质缺陷: <strong>Token ID 只是一个代号, 它本身不包含任何语义信息</strong>.</p>
<p>就像图书馆的图片编号, 你能靠它知道一本书的位置, 却不能靠它知道书的内容.</p>
<p>大模型想理解语言, 必须找到一种让数字承载意义的方法, 而这个方法就是 —— <strong>词向量</strong>.</p>
<h2 data-id="heading-0">一、什么是词向量?</h2>
<p>简单来说, <strong>词向量是一串多维度的数字序列 (向量), 每个维度对应语义的一个抽象特征, 合起来就是词语在语义空间中的 “坐标”</strong>.</p>
<blockquote>
<p>关于向量, 可以阅读我的另一篇文章: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FThGXnwta1kFgbpqlKozO3A" target="_blank" title="https://mp.weixin.qq.com/s/ThGXnwta1kFgbpqlKozO3A" ref="nofollow noopener noreferrer">不再费脑，写给爱好者的 AI 向量 (Vector) 入门课</a></p>
</blockquote>
<p>它不再是单个数字, 而是一长串数字. 比如, 在 <code>BAAI/bge-small-zh</code> 中, “狗” 被表示为 512 维的向量, 前几个维度的数值如下:</p>
<pre><code class="hljs language-python" lang="python">[
  <span class="hljs-number">0.039581298828125</span>,
  -<span class="hljs-number">0.004741668701171875</span>,
  <span class="hljs-number">0.0285797119140625</span>,
  -<span class="hljs-number">0.03558349609375</span>,
  -<span class="hljs-number">0.03662109375</span>,
  <span class="hljs-comment"># ... 省略剩余 507 个维度</span>
]
</code></pre>
<p>这个高维语义空间有两个神奇的特性:</p>
<ul>
<li><strong>语义相近, 坐标相近</strong>: 狼” 和 “狗” 的距离较远, “狗” 和 “犬” 的距离极近;</li>
<li><strong>向量运算模拟语义关系</strong>: 最经典的例子就是: <code>vector('国王') - vector('男人') + vector('女人') ≈ vector('女王')</code>, 完全符合人类的语义认知.</li>
</ul>
<p>这是怎么实现的呢? 这些 “坐标” 不是人类手动设计的, 而是计算机从海量文本中 “自学” 而来的 —— 核心方法就是玩一场超大规模的 “完形填空游戏”.</p>
<h2 data-id="heading-1">二、学习的秘密: 分布假说与神经网络</h2>
<p>计算机能学会词向量, 核心支撑有两个：一是语言学的 “分布假说”, 二是作为 “学习工具” 的神经网络.</p>
<h3 data-id="heading-2">2.1 分布假说: 词的含义由上下文决定</h3>
<p>这是词向量技术的思想源头, 语言学家早在几十年前就提出: 一个词的含义, 由它周围经常出现的词决定.</p>
<p>比如 “狼” 常出现在 “草原”、“群居”、“凶猛” 旁边, “狗” 常出现在 “宠物”、“忠诚”、“汪汪” 旁边, 这些上下文差异, 最终会体现在词向量的坐标上.</p>
<h3 data-id="heading-3">2.2 神经网络: 学习语义的 “数字大脑”</h3>
<p>要让计算机理解分布假说, 需要一个能处理复杂规律的 “大脑”—— 神经网络. 它的基本单元是<strong>神经元</strong>, 可以理解为一个微小的信息处理站</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7350cc79ac74406b9d13dc21afbf1258~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766362764&amp;x-signature=qV%2BjL16BNGNcHcT5nUtm0OaLIsI%3D" alt="" loading="lazy"/></p>
<ul>
<li>x1, x2, x3 是 "输入", 接收来自其他神经元的信号;</li>
<li>w1, w2, w3 是每条输入的 "权重 (重要性系数)", 比如 w3 大, 说明这个神经元更关注 x3 的信号;</li>
<li>中间的圆圈是神经元本身</li>
</ul>
<p>这个神经元只做两件事:</p>
<ul>
<li><strong>加权求和</strong>: 把每个输入乘以对应的权重, 然后加起来. 即 x1w1 + x2w2 + x3w3.;</li>
<li><strong>激活</strong>: 对加权求和做非线性转换.</li>
</ul>
<p>这里的<strong>非线性</strong>是关键 —— 如果没有激活函数, 无论多少层神经网络, 都等价于简单的线性计算（输出 = a * 输入 + b）, 永远学不会语言的复杂规律.</p>
<blockquote>
<p><strong>【语言是非线性的】</strong></p>
<p>比如 “单身狗” 这个词, 如果按照线性的理解, 它应该是 “单身” + “狗”, 也就是没有伴侣的狗. 但它的真实意思是指“单身的人”, 这种语义的 “化学反应”, 只有非线性系统才能捕捉.</p>
<p>常见的两种激活函数, 一个是 Sigmoid, 一个是 ReLU.</p>
</blockquote>
<p>当大量神经元通过权重连接成网络, 就像一张巨大的 “信息交通网”:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44236032270d407ebba2764297f0202b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766362764&amp;x-signature=rYnzPZR9GDXqPJOhUtaoDwS0x7M%3D" alt="" loading="lazy"/></p>
<ul>
<li>神经元是 “路口”, 负责信息的中转和计算;</li>
<li>权重是 “道路”, 权重高是 “高速公路”, 信息传递快; 权重低是 “乡间小道”, 信息传递慢.</li>
</ul>
<p>训练模型的过程, 本质就是调整这张 “交通网” 的道路宽窄 (权重), 让信息流动符合语言规律 —— 而权重就是模型的 “知识”, 所有学到的语义规则, 最终都以数字形式存储在权重矩阵里.</p>
<h2 data-id="heading-4">三、训练之旅：从混沌到有序的 “猜词游戏”</h2>
<p>有了 “大脑” 和 “学习原理”, 接下来就是核心的训练过程 —— 让模型玩亿万次 “完形填空”, 从完全无知的 “文盲” 变成懂语义的 “语言大师”. 整个过程分为四个阶段：</p>
<h3 data-id="heading-5">3.1 随机初始化</h3>
<p>训练开始前, 神经网络的所有权重、词向量表中每个词的坐标, 都是随机赋值的. 此时在多维的语义空间里, 词语的位置完全混乱: “好” 可能离 “石头” 很近, 离 “棒” 很远, 没有任何语义规律.</p>
<p>之所以选择随机初始化, 是为了打破 “对称性”—— 如果所有参数初始值相同, 后续调整时所有参数会同步变化, 模型永远学不会不同词语的特征差异.</p>
<h3 data-id="heading-6">3.2 疯狂做题（前向传播)</h3>
<p>模型开始处理海量文本, 但不会一次性读完, 而是用 “滑动窗口” 技巧: 想象模型拿着一个固定长度的框，沿着句子逐格滑动, 每次只聚焦局部上下文, 生成一道 “完形填空” 题</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c92ca8d091e94a9f963345ae683abc1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766362764&amp;x-signature=HZq5wqbVAdupyN0E%2FYjSCc1rC84%3D" alt="" loading="lazy"/></p>
<p>比如句子 “今天天气很好, 我们去公园”, 滑动窗口会生成 “今天天气真___”、“天气真___, 我们” 等题目. 模型将上下文词语的随机向量输入神经网络 (前向传播), 最终输出对空缺词的 “猜测”—— 此时的猜测完全是随机的, 正确率极低.</p>
<h3 data-id="heading-7">3.3 评分裁判 (Softmax)</h3>
<p>模型不会只给出一个答案，而是给词表中所有词打 “原始分数”. 这时需要 Softmax 函数充当 “裁判”，把分数转换成概率</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><msub><mi>z</mi><mi>i</mi></msub></msup><mrow><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></msubsup><msup><mi>e</mi><msub><mi>z</mi><mi>j</mi></msub></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">P(y_i) = \frac{e^{z_i}}{\sum_{j=1}^{K} e^{z_j}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.6629em;vertical-align:-0.7519em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.911em;"><span style="top:-2.5703em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8852em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-2.8971em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4603em;"><span/></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"/><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.779em;"><span style="top:-2.9714em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:-0.044em;margin-right:0.1em;"><span class="pstrut" style="height:2.6595em;"/><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5092em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:-0.044em;margin-right:0.1em;"><span class="pstrut" style="height:2.6595em;"/><span class="mord mathnormal mtight">i</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3147em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p>它的核心作用有两个:</p>
<ol>
<li><strong>放大差距</strong>: 通过指数函数 e<sup>x</sup>, 让分数高的词, 转换的概率也高, 放大了高分词的优势 (赢家通吃);</li>
<li><strong>归一化</strong>: 所有词的概率加起来等于 1</li>
</ol>
<h3 data-id="heading-8">3.4 纠错反馈 (反向传播与梯度下降)</h3>
<p>这是训练最关键的一步: 我们告诉模型 “正确答案是‘好’”, 模型的预测与正确答案的差距就是 “损失值”.</p>
<p>接下来, 反向传播算法会从输出层往输入层回溯, 计算每个权重对这次错误的 “责任” (梯度); 然后用梯度下降算法微调权重:</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>新权重</mtext><mo>=</mo><mtext>旧权重</mtext><mo>−</mo><mtext>学习率</mtext><mo>∗</mo><mtext>梯度</mtext></mrow><annotation encoding="application/x-tex">新权重 = 旧权重 - 学习率 * 梯度</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">新权重</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">旧权重</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">学习率</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">梯度</span></span></span></span></span></p>
<p>于是, 算法会严厉地告诉模型: "猜错了！所有指向错误答案 '石头' 的连接都弱一点, 所有指向正确答案 '好' 的连接都强一点. "</p>
<h2 data-id="heading-9">四、涌现的奇迹: 语义规律自发生成</h2>
<p>经过亿万次 “刷题-纠错”, 奇迹发生了: 原本混乱的语义空间, 被塑造成符合人类认知的样子:</p>
<p>计算机脑中那张原本随机的 "词向量地图", 被慢慢塑造成了我们所期望的样子:</p>
<ul>
<li>近义词（好 / 棒 / 优秀）因为常出现在相似上下文, 坐标逐渐靠近;</li>
<li>语义关系（国王 - 男人 + 女人≈女王）自然而然形成</li>
</ul>
<p>这就是人工智能领域的 “涌现”—— 没有人为设计任何语义规则, 仅仅通过简单的局部反馈 (猜词、纠错), 宏观上就自发形成了高度有序的语义结构</p>
<h2 data-id="heading-10">五、黑盒与炼丹: 无法解读的维度</h2>
<p>尽管词向量能精准表达语义, 但我们盯着 “狗” 的向量 <code>[0.039581298828125, -0.004741668701171875, ...]</code> 时，却无法给每个维度下定义.</p>
<p>第一维是 “宠物” 吗? 第二维是 “忠诚” 吗? 可以说 “是”, 也可以说都不是 —— 每个维度都是多个抽象特征的混合体.</p>
<p>这是因为神经网络为了最小化预测错误, 会自动找到最高效的坐标系, 这个坐标系适合模型计算, 却完全不符合人类的理解习惯. 这也是深度学习被称为 “黑盒”、调参被戏称为 “炼丹” 的核心原因.</p>
<h2 data-id="heading-11">六、总结: 从 “教规则” 到 “找规律” 的范式革命</h2>
<p>词向量的诞生, 代表了人工智能理解语言的核心思想转变:</p>
<ul>
<li>过去, 我们试图把人类知识<strong>翻译</strong>成规则教给计算机.</li>
<li>现在, 我们设计简单的<strong>游戏规则</strong>（猜词）和<strong>反馈机制</strong>（反向传播）, 让计算机从海量数据中自己发现语义规律.</li>
</ul>
<p>那些最初毫无意义的随机数字, 在亿万次训练的 “锻造” 下, 最终变成了承载人类语言意义的精密 “坐标”, 而这就是词向量.</p>
<p>回到文章开头的问题, 大模型如何分辨 “狼” 与 “狗”. AI 没有被灌输任何关于 “狼” “狗” “犬” 的具体规则, 是靠数据驱动的方式, 在高维空间里为这些词语找到了符合人类认知的坐标.</p>
<p>即便这些坐标的每一个维度都无法被人类精准定义. 但这恰恰是其强大之处.</p>
<p>AI 没有被人类的认知边界束缚，而是找到了最适合自身理解语言的方式.</p>
<p>我是印刻君, 一位探索 AI 的前端程序员, 关注我, 让 AI 知识有温度, 技术落地有深度.</p>
<blockquote>
<p><strong>补充说明</strong>: 现代 LLM（如 GPT）的训练过程比这更复杂, 词向量层是与整个模型一起端到端训练的. 但将词向量理解为猜词任务的"副产品", 但将词向量理解为猜词任务的"副产品", 仍然是理解其本质的有效方式.</p>
</blockquote>
<h2 data-id="heading-12">附录: 查看 “狼” “狗” “犬” 的词向量</h2>
<p>如果你想直观看到一个词在模型中的 “数字形态”, 可以运行以下 Python 代码, 打印 <code>BAAI/bge-small-zh</code> 模型中 “狼” “狗” “犬” 的 Token ID 和词向量:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer, AutoModel

model_name = <span class="hljs-string">"BAAI/bge-small-zh"</span>
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModel.from_pretrained(model_name)
model.<span class="hljs-built_in">eval</span>()

target_text = <span class="hljs-string">"狼"</span>

inputs = tokenizer(
    target_text,
    return_tensors=<span class="hljs-string">"pt"</span>,
    add_special_tokens=<span class="hljs-literal">False</span>
)

token_ids = inputs[<span class="hljs-string">"input_ids"</span>][<span class="hljs-number">0</span>]
tokens = tokenizer.convert_ids_to_tokens(token_ids)

embedding_layer = model.get_input_embeddings()
token_embeddings = embedding_layer(token_ids)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询文本: <span class="hljs-subst">{target_text}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)

<span class="hljs-keyword">for</span> idx, (token, token_id) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(tokens, token_ids)):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n【Token <span class="hljs-subst">{idx+<span class="hljs-number">1</span>}</span>】"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"字符/Token: <span class="hljs-subst">{token}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Token ID: <span class="hljs-subst">{token_id.item()}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"词向量（前10维）: <span class="hljs-subst">{token_embeddings[idx][:<span class="hljs-number">10</span>].tolist()}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"词向量维度: <span class="hljs-subst">{token_embeddings[idx].shape[<span class="hljs-number">0</span>]}</span>"</span>)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JWorker——一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制]]></title>    <link>https://juejin.cn/post/7583260493851557929</link>    <guid>https://juejin.cn/post/7583260493851557929</guid>    <pubDate>2025-12-15T00:29:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493851557929" data-draft-id="7583260493851263017" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JWorker——一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,TypeScript"/> <meta itemprop="datePublished" content="2025-12-15T00:29:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江澎涌"/> <meta itemprop="url" content="https://juejin.cn/user/1820446986338504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JWorker——一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1820446986338504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江澎涌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:29:27.000Z" title="Mon Dec 15 2025 00:29:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">零、JWorker</h2>
<p><strong>JWorker 是一套简单易用的基于鸿蒙 Worker 的双向 RPC 通讯机制。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6fda4257dbe4aac9ecae9d1b97bb4b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766363366&amp;x-signature=Qyt8awOG6G6qKBSbJqBTWZ06YV8%3D" alt="structure.png" loading="lazy"/></p>
<p>传统的 Worker 通讯基于事件监听和消息传递，缺乏原生的 <code>Promise/async-await</code> 支持，导致逻辑割裂。<strong>JWorker 通过双向 RPC 机制，让主 Worker 可以 await 子 Worker 的执行结果，子 Worker 也可以 await 主 Worker 的响应，将跨 Worker 通讯简化为像调用本地异步函数，消除回调嵌套，保持代码线性流畅。</strong></p>
<h2 data-id="heading-1">一、安装</h2>
<p>运行 <code>ohpm install jworker</code> 安装 JWorker 库</p>
<h2 data-id="heading-2">二、常规使用</h2>
<p>JWorker 是基于鸿蒙 Worker 封装的一套 RPC 通讯机制，所以在正式使用之前需要先添加和配置 Worker 的 ets 文件。可以按照<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fworker-introduction" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/worker-introduction" ref="nofollow noopener noreferrer">鸿蒙官方 Worker</a> 的使用文档进行添加配置，这里就不再赘述。</p>
<blockquote>
<p>“常规使用” 示例完整代码 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJWorker%2Ftree%2Fmain%2Fsample%2Fsrc%2Fmain%2Fets%2Fworker%2Fsimple" target="_blank" title="https://github.com/zincPower/JWorker/tree/main/sample/src/main/ets/worker/simple" ref="nofollow noopener noreferrer">传送门</a></p>
</blockquote>
<h3 data-id="heading-3">1、创建 JWorker</h3>
<p><strong>主 Worker 中</strong>使用 <code>createJWorker(workerPath: string)</code> 创建 <code>JWorker</code> 实例，然后调用 <code>JWorker.start()</code> 启动 <code>JWorker</code> 。 完整代码如下：</p>
<blockquote>
<p><code>JWorker.start()</code> 内部会启动 Worker 文件，并关联消息接收、退出接收等回调。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 将 Worker 的文件路径传给 createJWorker 方法，会返回 JWorker 实例</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/simple/SimpleWorker.ets"</span>)
<span class="hljs-comment">// 启动 JWorker</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>.<span class="hljs-title function_">start</span>()
</code></pre>
<p><strong>子 Worker 中</strong>使用 <code>initJWorker()</code> 获取 <code>SubWorker</code> 实例。完整代码如下：</p>
<blockquote>
<p><code>initJWorker()</code> 内部会让 <code>SubWorker</code> 关联子 Worker 的消息接收等回调。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> worker = <span class="hljs-title function_">initJWorker</span>()
</code></pre>
<h3 data-id="heading-4">2、双向 RPC 通讯</h3>
<p><strong>JWorker 的通讯是基于 Channel</strong> ，所以主子 Worker 的通讯需要先添加<strong>相同名称的 Channel</strong>。</p>
<p><strong>主 Worker</strong> 通过 <code>JWorker.addChannel(channelName: string, channel: Channel)</code> 方法进行添加通讯 Channel 。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 创建通讯渠道 MainSimpleChannel ，需要继承 Channel </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainSimpleChannel</span>()
<span class="hljs-comment">// 添加渠道名为 “SimpleWorkerChannel” 的通讯 Channel </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"SimpleWorkerChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span>)
</code></pre>
<p><strong>子 Worker</strong> 通过 <code>JWorkerChannel(channelName: string, channel: Channel)</code> 方法进行添加通讯 Channel 。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 添加渠道名为 “SimpleWorkerChannel” 的通讯 Channel</span>
<span class="hljs-comment">// 同样 SubSimpleChannel 也需要继承 Channel</span>
<span class="hljs-title class_">JWorkerChannel</span>(<span class="hljs-string">"SimpleWorkerChannel"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SubSimpleChannel</span>(worker))
</code></pre>
<p><strong>主 Worker 和子 Worker 通过相同的渠道名称建立通讯通道</strong>，<code>MainSimpleChannel</code> 和 <code>SubSimpleChannel</code> 通讯规则如下：</p>
<ul>
<li>通过 <code>handleMessage(methodName: string, data: any): Promise&lt;any&gt;</code> 接收对方的调用消息，返回值会返回到调用点；</li>
<li>通过 <code>send(methodName: string, data?: any, transfer?: ArrayBuffer[]) =&gt; Promise&lt;any&gt;</code> 可以主动调用对方方法并携带参数，对方处理完的返回值会以 <code>Promise&lt;any&gt;</code> 类型返回到调用点。</li>
</ul>
<p><strong>主 Worker 调用子 Worker 的逻辑</strong>，通过注册的 <code>simpleWorkerChannel</code> 调用 <code>send</code> 方法发送即可。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ============== 主 Worker 中进行发送 ==============</span>
<span class="hljs-keyword">const</span> user = {
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"jiangpengyong"</span>,
  <span class="hljs-string">"year"</span>: <span class="hljs-number">1994</span>,
  <span class="hljs-string">"height"</span>: <span class="hljs-number">170.0</span>,
  <span class="hljs-string">"address"</span>: {
    <span class="hljs-string">"country"</span>: <span class="hljs-string">"China"</span>,
    <span class="hljs-string">"province"</span>: <span class="hljs-string">"GuangDong"</span>,
    <span class="hljs-string">"city"</span>: <span class="hljs-string">"Guangzhou"</span>,
  },
} <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>
<span class="hljs-comment">// 第一个参数为调用方法名称，第二个参数为调用方法的参数</span>
<span class="hljs-comment">// response 为子 Worker 处理的结果</span>
<span class="hljs-keyword">const</span> response = (<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span>?.<span class="hljs-title function_">send</span>(<span class="hljs-string">"sayHello"</span>, user)) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Any</span>
<span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【发送有处理的消息】子 Worker 回复 response=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(response)}</span>`</span>)

<span class="hljs-comment">// ============== 子 Worker 中进行接收处理 ==============</span>
<span class="hljs-comment">// 通过 SubSimpleChannel 接收调用方法名称和参数，处理后返回结果</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubSimpleChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-comment">// 处理主 Worker 调用的 “sayHello” 方法，将 data 转为 User 类型并获取对应数据，返回一个 string 结果</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">"sayHello"</span>: {
        <span class="hljs-keyword">const</span> user = data <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${user.name}</span>. I'm replying to you from the sub-worker.`</span>
      }
      <span class="hljs-comment">// 省略其他方法</span>
    }
  }
}

<span class="hljs-comment">// ============== 最终会在 Log 中看到以下输出 ==============</span>
<span class="hljs-comment">// 【发送有处理的消息】子 Worker 回复 response="Hello, jiangpengyong. I'm replying to you from the sub-worker."</span>
</code></pre>
<p><strong>子 Worker 调用主 Worker 的逻辑</strong>，也是同样的流程，通过注册的 <code>SubSimpleChannel</code> 调用 <code>send</code> 方法发送即可。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ============== 子 Worker 调用主 Worker 的逻辑 ==============</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubSimpleChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"getUserDes"</span>: {
        <span class="hljs-comment">// 调用主 Worker 的 “getUserInfo” 方法，此处没有携带参数，会返回 User 类型</span>
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">send</span>(<span class="hljs-string">"getUserInfo"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">`name: <span class="hljs-subst">${user.name}</span>, height: <span class="hljs-subst">${user.height}</span>`</span>
      }
      <span class="hljs-comment">// 省略其他逻辑</span>
    }
  }
}

<span class="hljs-comment">// ============== 主 Worker 处理逻辑 ==============</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainSimpleChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-comment">// 接收到子 Worker 的请求处理，处理完之后返回数据</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">"getUserInfo"</span>: {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-string">"name"</span>: <span class="hljs-string">"江澎涌"</span>,
          <span class="hljs-string">"year"</span>: <span class="hljs-number">1994</span>,
          <span class="hljs-string">"height"</span>: <span class="hljs-number">170.0</span>,
          <span class="hljs-string">"address"</span>: {
            <span class="hljs-string">"country"</span>: <span class="hljs-string">"中国"</span>,
            <span class="hljs-string">"province"</span>: <span class="hljs-string">"广东"</span>,
            <span class="hljs-string">"city"</span>: <span class="hljs-string">"普宁"</span>,
          },
        } <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>
      }
    }
  }
}
</code></pre>
<blockquote>
<p>Channel 中包含了 <code>send(methodName: string, data?: any, transfer?: ArrayBuffer[]) =&gt; Promise&lt;any&gt;</code> 方法，可以在 “ Channel 内部主动调用” 或是 “外部代码通过 Channel 实例主动调用”，<code>await</code> 数据返回即可。</p>
</blockquote>
<h3 data-id="heading-5">3、传递 ArrayBuffer 数据</h3>
<p>Worker 在传递 ArrayBuffer 时，为了不拷贝 ArrayBuffer 数据，可以考虑将 ArrayBuffer 使用权移交给对方，JWorker 也同样提供这一能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff8632ddf2f4a149f4f8424f42dcaf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766363366&amp;x-signature=%2Fyu2vdb5l5doeJvIPBjnqr4DdW0%3D" alt="transfer_data.png" loading="lazy"/></p>
<p>上图则是一个完整的移交 ArrayBuffer 使用权的全流程</p>
<p><strong>调用点传递 ArrayBuffer 类型数据</strong></p>
<p>无论是 “主 Worker 主动调用子 Worker 方法”，还是 “子 Worker 主动调用主 Worker 方法”，都是使用 Channel 的 <code>send</code> 方法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">send</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">any</span>, transfer?: <span class="hljs-title class_">ArrayBuffer</span>[]) =&gt; <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;
</code></pre>
<p><code>send</code> 的第三个参数 <code>transfer</code> 持有第二个参数 <code>data</code> 中需要移交使用权的 ArrayBuffer 对象，JWorker 会负责移交使用权。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ============== 发送方代码（此处为主 Worker ） ==============</span>
<span class="hljs-keyword">const</span> uint8Array = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>).<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(<span class="hljs-string">"image1.jpeg"</span>)
<span class="hljs-keyword">const</span> arrayBuffer = uint8Array.<span class="hljs-property">buffer</span>
<span class="hljs-comment">// 此处将 arrayBuffer 使用权移交给子 Worker ，所以将 arrayBuffer 放置到了第三个参数</span>
<span class="hljs-comment">// 值得注意，移交后的 arrayBuffer ，主 Worker 不可再使用，否则会报错</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span>.<span class="hljs-title function_">send</span>(<span class="hljs-string">"cropImage"</span>, arrayBuffer, [arrayBuffer]) <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span> | <span class="hljs-literal">undefined</span>

<span class="hljs-comment">// ============== 接收方代码（此处为子 Worker ） ==============</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubSimpleChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"cropImage"</span>: {
        <span class="hljs-comment">// 接收 ArrayBuffer 的代码没有特别的要求，和接收普通类型的逻辑一样，只需要转为对应的类型进行处理即可</span>
        <span class="hljs-keyword">const</span> arrayBuffer = data <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span>
        <span class="hljs-keyword">const</span> cropPixelMap = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cropImage</span>(arrayBuffer)
        <span class="hljs-keyword">const</span> cropArrayBuffer = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PixelMapConverter</span>.<span class="hljs-title function_">pixelMapToArrayBuffer</span>(cropPixelMap)
        <span class="hljs-comment">// 省略其他逻辑</span>
      }
    }
  }
}
</code></pre>
<p><strong>返回值传递 ArrayBuffer 类型数据</strong></p>
<p>在处理完逻辑后，返回数据给调用方，此时存在返回数据携带 ArrayBuffer 类型数据的场景。为此 JWorker 提供了 <code>TransferData</code> 类型，支持该场景的数据传递，具体操作如下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ============== 继续上面的代码 ==============</span>
<span class="hljs-comment">// ============== 接收方代码（此处为子 Worker ） ==============</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubSimpleChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"cropImage"</span>: {
        <span class="hljs-comment">// 省略重复代码</span>
        <span class="hljs-comment">// 返回值如果需要移交 ArrayBuffer 使用权，则使用 TransferData 类进行包裹</span>
        <span class="hljs-comment">// 第一个参数为返回数据，第二个参数为需要移交使用权的 ArrayBuffer 列表</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransferData</span>(cropArrayBuffer, [cropArrayBuffer])
      }
    }
  }
}

<span class="hljs-comment">// ============== 发送方代码（此处为主 Worker ） ==============</span>
<span class="hljs-comment">// 调用点接收到的数据类型是已经去掉 TransferData 包裹的真实数据</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span>.<span class="hljs-title function_">send</span>(<span class="hljs-string">"cropImage"</span>, arrayBuffer, [arrayBuffer]) <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span> | <span class="hljs-literal">undefined</span>
<span class="hljs-keyword">if</span> (response) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cropPixelMap</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PixelMapConverter</span>.<span class="hljs-title function_">arrayBufferToPixelMap</span>(response)
}
</code></pre>
<h3 data-id="heading-6">4、关闭 JWorker</h3>
<p>在 JWorker 中提供了两种关闭 Worker 的方式，分别为 <strong>主 Worker 进行关闭</strong> 和 <strong>子 Worker 进行关闭</strong> 。<strong>推荐使用子 Worker 进行关闭</strong>，因为项目可以更好控制子 Worker 的生命周期和释放相应资源。</p>
<p><strong>主 Worker 进行关闭</strong></p>
<p>通过调用 <code>JWorker</code> 实例的 <code>release()</code> 方法进行释放。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 创建 JWorker 对象</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/simple/SimpleWorker.ets"</span>)
<span class="hljs-comment">// 进行开启 JWorker 、添加 Channel 等操作</span>

<span class="hljs-comment">// 关闭 JWorker</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>?.<span class="hljs-title function_">release</span>()
</code></pre>
<p><strong>子 Worker 进行关闭</strong></p>
<p>通过调用 <code>SubWorker</code> 对象的 <code>release()</code> 方法进行释放。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 在子 Worker 中构建 subWorker</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-title function_">initJWorker</span>()
<span class="hljs-comment">// 添加需要的 Channel 操作</span>

<span class="hljs-comment">// 在需要释放的时候调用</span>
<span class="hljs-comment">// 1、可以将 worker 传递给 Channel ，Channel 内部可以根据需要进行调用释放</span>
<span class="hljs-comment">// 2、可以全局持有，在需要的时候进行释放</span>
worker.<span class="hljs-title function_">release</span>()
</code></pre>
<h3 data-id="heading-7">5、值得注意</h3>
<p>如果 <code>JWorker</code> 对象未开启（即未调用 <code>JWorker.start()</code> 方法或已关闭），此时使用添加在该 JWorker 的 Channel 进行发送消息会立马得到一个 <code>undefined</code> 数据。</p>
<p>如果通过 <code>JWorker</code> 的 Channel 发送了消息，在未得到回复前对该 <code>JWorker</code> 进行关闭，则会让调用点立马得到一个 <code>undefined</code> 数据。</p>
<p><strong>所以为了程序的健壮，调用点的类型转换最好增加对 <code>undefined</code> 的判断。</strong></p>
<h2 data-id="heading-8">三、多个 Worker</h2>
<h3 data-id="heading-9">1、项目主 Worker 开多个子 Worker</h3>
<p><code>JWorker</code> 项目支持开启多个 Worker ，使用 <code>createJWorker(workerPath: string)</code> 方法传入不同的路径，管理好返回 <code>JWorker</code> 对象即可。</p>
<blockquote>
<p>“项目主 Worker 开多个子 Worker” 示例完整代码 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJWorker%2Ftree%2Fmain%2Fsample%2Fsrc%2Fmain%2Fets%2Fworker%2Fmainmultiworker" target="_blank" title="https://github.com/zincPower/JWorker/tree/main/sample/src/main/ets/worker/mainmultiworker" ref="nofollow noopener noreferrer">传送门</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85be0b25cb7b4c16989ea08b3dfa2509~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766363366&amp;x-signature=F0Jnyg6FHA6jqIfXeHuoKfyNGXI%3D" alt="main_multi_worker.png" loading="lazy"/></p>
<p>假设项目需要构建上图的使用场景，可以通过以下代码创建 <code>JWorker</code> 实例。</p>
<ul>
<li>可以使用不同的 Worker ets 文件，也可以使用同一个 Worker ets 文件可以开启多个 <code>JWorker</code> 实例。</li>
<li>通过管理好 <code>JWorker</code> 实例，添加渠道后进行各自 Worker 通讯。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// worker0 和 worker1、worker2 使用不同的 Worker ets 文件进行开启不同的 JWorker 实例</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker0</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/simple/SimpleWorker.ets"</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker0</span>.<span class="hljs-title function_">start</span>()
<span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainSimpleChannel</span>()
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker0</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"SimpleWorkerChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">simpleWorkerChannel</span>)

<span class="hljs-comment">// worker1 和 worker2 使用相同的 Worker ets 文件进行开启不同的 JWorker 实例 </span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker1</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/mainmultiworker/MainMultiWorker.ets"</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker1Channel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainMultiChannel</span>()
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker1</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"multiChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker1Channel</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker1</span>.<span class="hljs-title function_">start</span>()

<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker2</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/mainmultiworker/MainMultiWorker.ets"</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker2Channel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainMultiChannel</span>()
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker2</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"multiChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker2Channel</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">worker2</span>.<span class="hljs-title function_">start</span>()
</code></pre>
<h3 data-id="heading-10">2、子 Worker 开多个子 Worker</h3>
<p><code>JWorker</code> 同样支持在子 Worker 中开启多个 <code>JWorker</code> ，可以进行如下图所示的创建和管理。</p>
<blockquote>
<p>“子 Worker 开多个子 Worker” 示例完整代码 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJWorker%2Ftree%2Fmain%2Fsample%2Fsrc%2Fmain%2Fets%2Fworker%2Fsubmultiworker" target="_blank" title="https://github.com/zincPower/JWorker/tree/main/sample/src/main/ets/worker/submultiworker" ref="nofollow noopener noreferrer">传送门</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ad99bd5488f42b38fe7133536e5fa0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766363366&amp;x-signature=Y4omM%2BPnwoOrW9nj4ZB7yfIFuWI%3D" alt="sub_multi_worker.png" loading="lazy"/></p>
<p>可以在子 Worker 需要创建子 Worker 的地方调用 <code>createJWorker</code> 方法创建 <code>JWorker</code> ，然后进行启动和添加相应 Channel 进行通讯。<strong>使用方式和之前的完全相同。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParentSubChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-comment">// 省略其他逻辑</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">worker: SubWorker</span>) {
    <span class="hljs-comment">// 省略其他逻辑</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startChildrenWorker</span>()
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">startChildrenWorker</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建三个 JWorker 并开启，添加对应 Channel </span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1</span> == <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/submultiworker/ChildWorker.ets"</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1Channel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChildMainChannel</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"childChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1Channel</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1</span>.<span class="hljs-title function_">start</span>()
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2</span> == <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/submultiworker/ChildWorker.ets"</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2Channel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChildMainChannel</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"childChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2Channel</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2</span>.<span class="hljs-title function_">start</span>()
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3</span> == <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3</span> = <span class="hljs-title function_">createJWorker</span>(<span class="hljs-string">"sample/ets/worker/submultiworker/ChildWorker.ets"</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3Channel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChildMainChannel</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3</span>.<span class="hljs-title function_">addChannel</span>(<span class="hljs-string">"childChannel"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3Channel</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3</span>.<span class="hljs-title function_">start</span>()
    }
  }
}
</code></pre>
<p><strong>值得注意</strong></p>
<p>这种情况下需要控制好 Worker 的关闭顺序，应该让项目的主 Worker 通知子 Worker 进行关闭他创建的子 Worker ，然后在关闭自身。具体操作如下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 项目主 Worker 调用子 Worker 的 exit 方法</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">workerChannel</span>?.<span class="hljs-title function_">send</span>(<span class="hljs-string">"exit"</span>)

<span class="hljs-comment">// 子 Worker 接收到主 Worker 的 “exit” 调用，则调用子 Worker 创建的子 Worker 的 “exit” 方法进行退出，并等待所有的子 Worker 处理完再退出自身</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParentSubChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-comment">// 省略其他逻辑</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-params">methodName: <span class="hljs-built_in">string</span>, data: Any</span>) {
    <span class="hljs-keyword">switch</span> (methodName) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"exit"</span>: {
        <span class="hljs-comment">// 等待所有子 Worker 退出完成</span>
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1Channel</span>?.<span class="hljs-title function_">send</span>(<span class="hljs-string">"exit"</span>), <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2Channel</span>?.<span class="hljs-title function_">send</span>(<span class="hljs-string">"exit"</span>), <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3Channel</span>?.<span class="hljs-title function_">send</span>(<span class="hljs-string">"exit"</span>)])
        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">"【exit】"</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>?.<span class="hljs-title function_">release</span>()
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker1Channel</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker2Channel</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">childWorker3Channel</span> = <span class="hljs-literal">undefined</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
      }
      <span class="hljs-attr">default</span>: {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
      }
    }
  }
}

<span class="hljs-comment">// 子 Worker 的子 Worker 接收到 “exit” 的调用，退出自身</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChildSubChannel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Channel</span> {
  <span class="hljs-comment">// 省略其他逻辑</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-params">methodName: <span class="hljs-built_in">string</span>, data: Any</span>) {
    <span class="hljs-keyword">if</span> (methodName == <span class="hljs-string">"exit"</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">worker</span>.<span class="hljs-title function_">release</span>()
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
  }
}
</code></pre>
<h2 data-id="heading-11">四、作者博客</h2>
<p>掘金：<a href="https://juejin.im/user/5c3033ef51882524ec3a88ba/posts" target="_blank" title="https://juejin.im/user/5c3033ef51882524ec3a88ba/posts">juejin.im/user/5c3033…</a></p>
<p>csdn：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_37625173" target="_blank" title="https://blog.csdn.net/weixin_37625173" ref="nofollow noopener noreferrer">blog.csdn.net/weixin_3762…</a></p>
<p>公众号：微信搜索 "江澎涌"</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter-使用EventBus实现组件间数据通信]]></title>    <link>https://juejin.cn/post/7583226204036513833</link>    <guid>https://juejin.cn/post/7583226204036513833</guid>    <pubDate>2025-12-15T00:40:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583226204036513833" data-draft-id="7581117416811544619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" flutter-使用EventBus实现组件间数据通信"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-15T00:40:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             flutter-使用EventBus实现组件间数据通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:40:53.000Z" title="Mon Dec 15 2025 00:40:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">1. 效果预览</h2>
<p>在 Flutter 应用开发中，组件间的通信是一个常见且重要的需求。当涉及到父子组件之间复杂的交互时，使用事件总线（Event Bus）可以有效地实现解耦和灵活的消息传递。本文将通过一段具体的代码，详细介绍如何在 Flutter 中利用事件总线实现父子组件之间的通信。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebfa70468af644018b55aeea80cdbdde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766364053&amp;x-signature=lY2mGdzxw4VH3CvdYz6bcOCybFU%3D" alt="效果预览" loading="lazy"/></p>
<h2 data-id="heading-1">2. 安装插件</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">event_bus:</span> <span class="hljs-string">^2.0.0</span>
</code></pre>
<p>创建eventBus.dart文件，写入以下内容：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:event_bus/event_bus.dart'</span>;

EventBus eventBus = EventBus();

<span class="hljs-comment">/// <span class="markdown">通知测试</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BusNotificationTest</span> </span>{
  <span class="hljs-built_in">int</span> index;
  BusNotificationTest(<span class="hljs-keyword">this</span>.index);
}
</code></pre>
<h2 data-id="heading-2">3. 结构分析</h2>
<p>这段代码展示了如何在 Flutter 中通过事件总线实现父子组件之间的通信，具体功能为：在父组件EventBusParentPage中，用户点击按钮后，会触发一个通知事件，子组件EventBusChildPage监听该事件，并根据事件携带的信息改变自身的背景颜色。</p>
<ol>
<li>父组件：EventBusParentPage</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">事件Bus通知父类</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusParentPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> EventBusParentPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  EventBusParentPageState createState() =&gt; EventBusParentPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusParentPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">EventBusParentPage</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">颜色索引</span></span>
  <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>;

  <span class="hljs-comment">/// <span class="markdown">通知变色</span></span>
  <span class="hljs-keyword">void</span> handleColorChange() {
    index++;
    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">2</span>) {
      index = <span class="hljs-number">0</span>;
    }
    eventBus.fire(BusNotificationTest(index));
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        Expanded(
            child: Container(
                alignment: Alignment.center,
                decoration: <span class="hljs-keyword">const</span> BoxDecoration(color: Colors.white),
                child: TextButton(
                    onPressed: handleColorChange,
                    child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'点击变色'</span>,
                        style: TextStyle(color: Colors.black, fontSize: <span class="hljs-number">20</span>))))),
        <span class="hljs-keyword">const</span> EventBusChildPage()
      ],
    );
  }
}
</code></pre>
<ul>
<li>组件定义：
<ul>
<li>EventBusParentPage是一个有状态组件，通过createState方法返回EventBusParentPageState实例，用于管理组件状态和构建 UI。</li>
</ul>
</li>
<li>状态变量：
<ul>
<li>index：一个整型变量，用于记录颜色索引，初始值为 0。这个索引将决定子组件最终显示的颜色。</li>
</ul>
</li>
<li>事件处理方法：
<ul>
<li>handleColorChange：当用户点击父组件中的按钮时，该方法被调用。它首先将index值增加 1，如果index超过 2，则重置为 0。然后，通过事件总线eventBus触发一个BusNotificationTest类型的事件，并将当前的index值作为参数传递给该事件。这里的eventBus应该是在全局或合适的作用域中定义的事件总线实例，BusNotificationTest则是一个自定义的事件类，用于携带数据（这里是颜色索引）。</li>
</ul>
</li>
<li>构建 UI：
<ul>
<li>在build方法中，父组件构建了一个垂直方向的Column布局。</li>
<li>第一个子组件是一个Expanded包裹的Container，其中包含一个TextButton。按钮的文本为 “点击变色”，当按钮被点击时，会调用handleColorChange方法。Container的背景颜色设置为白色。</li>
<li>第二个子组件是EventBusChildPage，这是需要接收事件通知的子组件，通过const关键字创建，意味着它是一个不可变的组件实例。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>子组件：EventBusChildPage</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">事件Bus通知子类</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusChildPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> EventBusChildPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  EventBusChildPageState createState() =&gt; EventBusChildPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusChildPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">EventBusChildPage</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">颜色列表</span></span>
  <span class="hljs-built_in">List</span>&lt;Color&gt; colorList = [Colors.red, Colors.yellow, Colors.blue];

  <span class="hljs-comment">/// <span class="markdown">刷新监听</span></span>
  <span class="hljs-keyword">late</span> StreamSubscription&lt;BusNotificationTest&gt; eventBusExample;

  <span class="hljs-comment">/// <span class="markdown">背景颜色</span></span>
  <span class="hljs-keyword">late</span> Color bgColor;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    bgColor = colorList[<span class="hljs-number">0</span>];
    <span class="hljs-comment">// 监听颜色索引变化</span>
    eventBusExample = eventBus.<span class="hljs-keyword">on</span>&lt;BusNotificationTest&gt;().listen((event) {
      setState(() {
        bgColor = colorList[event.index];
      });
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    eventBusExample.cancel();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> SizedBox(
        width: MediaQuery.of(context).size.width,
        height: MediaQuery.of(context).size.height / <span class="hljs-number">2</span>,
        child: Container(color: bgColor, child: <span class="hljs-keyword">null</span>));
  }
}
</code></pre>
<ul>
<li>组件定义：
<ul>
<li>EventBusChildPage同样是一个有状态组件，其createState方法返回EventBusChildPageState实例。</li>
</ul>
</li>
<li>状态变量
<ul>
<li>colorList：一个包含三种颜色（红色、黄色、蓝色）的列表，用于存储可供选择的背景颜色。</li>
<li>eventBusExample：一个StreamSubscription类型的变量，用于订阅事件总线eventBus上的BusNotificationTest类型的事件。这里使用late关键字声明，意味着在initState方法中会对其进行初始化。</li>
<li>bgColor：用于存储子组件当前的背景颜色，初始值为colorList中的第一个颜色（红色），同样使用late关键字声明，在initState方法中初始化。</li>
</ul>
</li>
<li>生命周期方法：
<ul>
<li>initState：在组件插入到 Widget 树时调用。首先调用父类的initState方法，然后初始化bgColor为colorList中的第一个颜色。接着，通过eventBus.on().listen方法，订阅事件总线上的BusNotificationTest事件。当接收到该事件时，会执行回调函数，在回调函数中，通过setState方法更新bgColor为colorList中对应索引的颜色。这里的event.index就是父组件触发事件时传递过来的颜色索引。</li>
<li>dispose：当组件从 Widget 树中移除时调用。在这个方法中，调用eventBusExample.cancel()取消对事件总线的订阅，防止内存泄漏，然后调用父类的dispose方法。</li>
</ul>
</li>
<li>构建 UI：
<ul>
<li>在build方法中，子组件构建了一个SizedBox，其宽度为屏幕宽度，高度为屏幕高度的一半。在SizedBox内部是一个Container，其背景颜色由bgColor决定。当bgColor因接收到事件通知而改变时，Container的背景颜色也会相应改变，从而实现了根据父组件通知动态更新子组件 UI 的效果。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">3. 总结</h2>
<p>通过上述代码，我们清晰地看到了如何在 Flutter 中利用事件总线实现父子组件之间的通信。父组件通过触发事件并携带相关数据，子组件通过订阅事件总线并根据接收到的事件数据更新自身状态和 UI。</p>
<p>这种方式有效地解耦了父子组件之间的直接依赖关系，提高了代码的可维护性和扩展性。在实际项目中，当存在多个组件之间复杂的交互时，事件总线是一种非常强大且灵活的解决方案。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7582808491582619684" target="_blank" title="https://juejin.cn/post/7582808491582619684">Flutter输入框TextField的属性与实战用法全面解析+示例</a></li>
<li><a href="https://juejin.cn/post/7581693431740448831" target="_blank" title="https://juejin.cn/post/7581693431740448831">Flutter自定义日历table_calendar完全指南+案例</a></li>
<li><a href="https://juejin.cn/post/7580389111921786943" target="_blank" title="https://juejin.cn/post/7580389111921786943">flutter-屏幕自适应插件flutter_screenutil教程全指南</a></li>
<li><a href="https://juejin.cn/post/7579101504289882166" target="_blank" title="https://juejin.cn/post/7579101504289882166">flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等</a></li>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 中的 ViewModel 作用域管理 —— 新手指南]]></title>    <link>https://juejin.cn/post/7583845695178801158</link>    <guid>https://juejin.cn/post/7583845695178801158</guid>    <pubDate>2025-12-15T00:56:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583845695178801158" data-draft-id="7581423932612493352" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 中的 ViewModel 作用域管理 —— 新手指南"/> <meta itemprop="keywords" content="Kotlin,Android Jetpack,Android"/> <meta itemprop="datePublished" content="2025-12-15T00:56:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 中的 ViewModel 作用域管理 —— 新手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:56:48.000Z" title="Mon Dec 15 2025 00:56:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 基本 ViewModel 使用</h2>
<h4 data-id="heading-1">1.1 最简单的 ViewModel 获取</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SimpleScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> viewModel: MyViewModel = viewModel()
    <span class="hljs-comment">// 使用 viewModel</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _state = mutableStateOf(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">val</span> state = _state.asStateFlow()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> {
        _state.value++
    }
}
</code></pre>
<h4 data-id="heading-2">1.2 带参数的 ViewModel</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ScreenWithParam</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">val</span> viewModel: UserViewModel = viewModel(
        factory = <span class="hljs-keyword">object</span> : ViewModelProvider.Factory {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T {
                <span class="hljs-keyword">return</span> UserViewModel(userId) <span class="hljs-keyword">as</span> T
            }
        }
    )
}
</code></pre>
<h2 data-id="heading-3">二、 ViewModel 作用域策略</h2>
<h4 data-id="heading-4">2.1 不同层级的作用域</h4>
<h5 data-id="heading-5">Activity 级作用域</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ActivityScopedViewModel</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> activity = LocalContext.current <span class="hljs-keyword">as</span> ComponentActivity
    <span class="hljs-keyword">val</span> viewModel: SharedViewModel = viewModel(
        viewModelStoreOwner = activity
    )
}
</code></pre>
<h5 data-id="heading-6">Navigation 图级作用域</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">NavGraphScopedViewModel</span><span class="hljs-params">(navController: <span class="hljs-type">NavHostController</span>)</span></span> {
    <span class="hljs-comment">// 使用 navigation 图作为作用域</span>
    <span class="hljs-keyword">val</span> viewModel: GraphViewModel = hiltViewModel() <span class="hljs-comment">// 使用 Hilt</span>
    <span class="hljs-comment">// 或者</span>
    <span class="hljs-keyword">val</span> viewModel: GraphViewModel = viewModel(
        viewModelStoreOwner = navController
            .currentBackStackEntryAsState().value
            ?.destination
            ?.parent
            ?.let { navController.getBackStackEntry(it.id) }
    )
}
</code></pre>
<h5 data-id="heading-7">Destination 级作用域（默认）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ScreenWithViewModel</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 默认作用域是当前的 Composable（通常是 NavDestination）</span>
    <span class="hljs-keyword">val</span> viewModel: ScreenViewModel = viewModel()
}
</code></pre>
<h4 data-id="heading-8">2.2 自定义作用域</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建自定义的 ViewModelStoreOwner</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomScope</span> : <span class="hljs-type">ViewModelStoreOwner</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModelStore = ViewModelStore()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewModelStore</span><span class="hljs-params">()</span></span>: ViewModelStore = viewModelStore
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
        viewModelStore.clear()
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberCustomScope</span><span class="hljs-params">()</span></span>: CustomScope {
    <span class="hljs-keyword">return</span> remember { CustomScope() }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CustomScopedScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> customScope = rememberCustomScope()
    <span class="hljs-keyword">val</span> viewModel: CustomViewModel = viewModel(
        viewModelStoreOwner = customScope
    )
}
</code></pre>
<h2 data-id="heading-9">三、 高级作用域管理</h2>
<h4 data-id="heading-10">3.1 使用 Navigation Compose 的作用域</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Navigation 设置</span>
NavHost(navController, startDestination = <span class="hljs-string">"home"</span>) {
    navigation(startDestination = <span class="hljs-string">"list"</span>, route = <span class="hljs-string">"users"</span>) {
        composable(<span class="hljs-string">"list"</span>) {
            <span class="hljs-comment">// 这个 ViewModel 在 users 图内共享</span>
            <span class="hljs-keyword">val</span> sharedViewModel: UsersSharedViewModel = hiltViewModel()
            UserListScreen(sharedViewModel)
        }
        composable(<span class="hljs-string">"detail/{userId}"</span>) {
            <span class="hljs-comment">// 可以访问同一个 UsersSharedViewModel</span>
            <span class="hljs-keyword">val</span> sharedViewModel: UsersSharedViewModel = hiltViewModel()
            UserDetailScreen(sharedViewModel)
        }
    }
    
    composable(<span class="hljs-string">"settings"</span>) {
        <span class="hljs-comment">// 不同的作用域，不同的 ViewModel 实例</span>
        <span class="hljs-keyword">val</span> settingsViewModel: SettingsViewModel = hiltViewModel()
        SettingsScreen(settingsViewModel)
    }
}
</code></pre>
<h4 data-id="heading-11">3.2 嵌套 Navigation 的作用域管理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">NestedNavigationExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> navController = rememberNavController()
    
    NavHost(navController, startDestination = <span class="hljs-string">"main"</span>) {
        navigation(
            startDestination = <span class="hljs-string">"dashboard"</span>,
            route = <span class="hljs-string">"main"</span>
        ) {
            composable(<span class="hljs-string">"dashboard"</span>) {
                <span class="hljs-comment">// 作用域：main 图</span>
                <span class="hljs-keyword">val</span> mainViewModel: MainViewModel = hiltViewModel()
                DashboardScreen(mainViewModel)
            }
        }
        
        navigation(
            startDestination = <span class="hljs-string">"profile"</span>,
            route = <span class="hljs-string">"user"</span>
        ) {
            composable(<span class="hljs-string">"profile"</span>) {
                <span class="hljs-comment">// 作用域：user 图（与 main 图隔离）</span>
                <span class="hljs-keyword">val</span> userViewModel: UserViewModel = hiltViewModel()
                ProfileScreen(userViewModel)
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-12">四、 精确的生命周期控制</h2>
<h4 data-id="heading-13">4.1 手动管理 ViewModel 生命周期</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ManualLifecycleControl</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-keyword">val</span> lifecycleOwner = LocalLifecycleOwner.current
    
    <span class="hljs-comment">// 使用 remember 和 DisposableEffect 精确控制</span>
    <span class="hljs-keyword">val</span> viewModel = remember {
        ViewModelProvider(
            ViewModelStore(),
            ViewModelProvider.NewInstanceFactory()
        ).<span class="hljs-keyword">get</span>(ManualViewModel::<span class="hljs-keyword">class</span>.java)
    }
    
    DisposableEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-comment">// 连接生命周期</span>
        lifecycleOwner.lifecycle.addObserver(viewModel)
        
        onDispose {
            <span class="hljs-comment">// 清理资源</span>
            lifecycleOwner.lifecycle.removeObserver(viewModel)
            viewModel.onCleared()
        }
    }
}
</code></pre>
<h4 data-id="heading-14">4.2 使用 ViewModel 清理策略</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ManagedViewModel</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> scope: CoroutineScope
) : ViewModel() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow(UiState())
    <span class="hljs-keyword">val</span> uiState = _uiState.asStateFlow()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> job: Job? = <span class="hljs-literal">null</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span> {
        job?.cancel()
        job = scope.launch {
            <span class="hljs-comment">// 加载数据</span>
            _uiState.value = UiState(loading = <span class="hljs-literal">true</span>)
            delay(<span class="hljs-number">1000</span>)
            _uiState.value = UiState(<span class="hljs-keyword">data</span> = <span class="hljs-string">"Loaded"</span>)
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCleared</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCleared()
        job?.cancel()
        <span class="hljs-comment">// 清理其他资源</span>
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberManagedViewModel</span><span class="hljs-params">()</span></span>: ManagedViewModel {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">val</span> viewModelStoreOwner = checkNotNull(LocalViewModelStoreOwner.current) {
        <span class="hljs-string">"No ViewModelStoreOwner was provided via LocalViewModelStoreOwner"</span>
    }
    
    <span class="hljs-keyword">return</span> remember {
        ViewModelProvider(
            viewModelStoreOwner,
            <span class="hljs-keyword">object</span> : ViewModelProvider.Factory {
                <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : ViewModel&gt;</span> <span class="hljs-title">create</span><span class="hljs-params">(modelClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T {
                    <span class="hljs-keyword">return</span> ManagedViewModel(scope) <span class="hljs-keyword">as</span> T
                }
            }
        ).<span class="hljs-keyword">get</span>(ManagedViewModel::<span class="hljs-keyword">class</span>.java)
    }
}
</code></pre>
<h2 data-id="heading-15">五、 状态保存与恢复</h2>
<h4 data-id="heading-16">5.1 使用 SavedStateHandle</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StatefulViewModel</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> savedStateHandle: SavedStateHandle
) : ViewModel() {
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> COUNTER_KEY = <span class="hljs-string">"counter"</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> TEXT_KEY = <span class="hljs-string">"text"</span>
    }
    
    <span class="hljs-keyword">var</span> counter <span class="hljs-keyword">by</span> savedStateHandle.saveable { mutableIntStateOf(<span class="hljs-number">0</span>) }
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>
    
    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> savedStateHandle.saveable { mutableStateOf(<span class="hljs-string">""</span>) }
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> {
        counter++
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateText</span><span class="hljs-params">(newText: <span class="hljs-type">String</span>)</span></span> {
        text = newText
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StatefulScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> viewModel: StatefulViewModel = viewModel()
    <span class="hljs-comment">// 状态会在配置更改时自动保存</span>
}
</code></pre>
<h4 data-id="heading-17">5.2 自定义状态保存</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ComplexViewModel</span>(
    savedStateHandle: SavedStateHandle
) : ViewModel() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow(ComplexState())
    <span class="hljs-keyword">val</span> uiState = _uiState.asStateFlow()
    
    <span class="hljs-keyword">init</span> {
        <span class="hljs-comment">// 从 SavedStateHandle 恢复</span>
        savedStateHandle.<span class="hljs-keyword">get</span>&lt;ComplexState&gt;(<span class="hljs-string">"complex_state"</span>)?.let {
            _uiState.value = it
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateState</span><span class="hljs-params">(newState: <span class="hljs-type">ComplexState</span>)</span></span> {
        _uiState.value = newState
        <span class="hljs-comment">// 可以在这里手动保存到 SavedStateHandle</span>
    }
    
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"FunctionName"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> SavedStateHandle.<span class="hljs-title">saveComplexState</span><span class="hljs-params">(state: <span class="hljs-type">ComplexState</span>)</span></span> {
        <span class="hljs-keyword">this</span>[<span class="hljs-string">"complex_state"</span>] = state
    }
}
</code></pre>
<h2 data-id="heading-18">六、 最佳实践和模式</h2>
<h4 data-id="heading-19">6.1 ViewModel 提供者模式</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> VM : ViewModel&gt;</span> <span class="hljs-title">scopedViewModel</span><span class="hljs-params">(
    scope: <span class="hljs-type">ViewModelScope</span> = ViewModelScope.Screen,
    key: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>,
    factory: <span class="hljs-type">ViewModelProvider</span>.<span class="hljs-type">Factory</span>? = <span class="hljs-literal">null</span>
)</span></span>: VM {
    <span class="hljs-keyword">val</span> owner = <span class="hljs-keyword">when</span> (scope) {
        ViewModelScope.Activity -&gt; {
            LocalContext.current <span class="hljs-keyword">as</span> ComponentActivity
        }
        ViewModelScope.NavGraph -&gt; {
            <span class="hljs-keyword">val</span> navController = LocalNavController.current
            navController.currentBackStackEntryAsState().value
                ?.destination
                ?.parent
                ?.let { navController.getBackStackEntry(it.id) }
                ?: LocalViewModelStoreOwner.current
        }
        ViewModelScope.Screen -&gt; LocalViewModelStoreOwner.current
        ViewModelScope.Custom -&gt; {
            <span class="hljs-comment">// 使用自定义作用域</span>
            LocalCustomScope.current
        }
    }
    
    <span class="hljs-keyword">return</span> viewModel(
        viewModelStoreOwner = checkNotNull(owner),
        key = key,
        factory = factory
    )
}

<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModelScope</span> {
    Activity, NavGraph, Screen, Custom
}
</code></pre>
<h4 data-id="heading-20">6.2 依赖注入集成</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 Hilt 进行依赖注入</span>
<span class="hljs-meta">@HiltViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectedViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: UserRepository,
    savedStateHandle: SavedStateHandle
) : ViewModel() {
    <span class="hljs-comment">// ViewModel 逻辑</span>
}

<span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {
            MyApp()
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// Hilt 自动处理作用域和依赖</span>
    <span class="hljs-keyword">val</span> viewModel: InjectedViewModel = hiltViewModel()
}
</code></pre>
<h2 data-id="heading-21">七、 测试策略</h2>
<h4 data-id="heading-22">7.1 测试不同作用域的 ViewModel</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModelScopeTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testScreenScopedViewModel</span><span class="hljs-params">()</span></span> = runTest {
        <span class="hljs-comment">// 测试屏幕作用域的 ViewModel</span>
        <span class="hljs-keyword">val</span> owner = ViewModelStoreOwner { ViewModelStore() }
        <span class="hljs-keyword">val</span> viewModel = TestViewModel(owner)
        
        <span class="hljs-comment">// 验证行为</span>
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testActivityScopedViewModel</span><span class="hljs-params">()</span></span> = runTest {
        <span class="hljs-comment">// 测试 Activity 作用域</span>
        <span class="hljs-keyword">val</span> activity = Robolectric.buildActivity(ComponentActivity::<span class="hljs-keyword">class</span>.java).<span class="hljs-keyword">get</span>()
        <span class="hljs-keyword">val</span> viewModel = ViewModelProvider(activity).<span class="hljs-keyword">get</span>(TestViewModel::<span class="hljs-keyword">class</span>.java)
        
        <span class="hljs-comment">// 验证跨屏幕的状态保持</span>
    }
}
</code></pre>
<h4 data-id="heading-23">7.2 Mocking 作用域</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TestScreen</span><span class="hljs-params">(
    testViewModel: <span class="hljs-type">TestViewModel</span> = mockViewModel()</span></span>
) {
    <span class="hljs-comment">// 在测试中注入 mock ViewModel</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">mockViewModel</span><span class="hljs-params">()</span></span>: TestViewModel {
    <span class="hljs-keyword">return</span> mockk&lt;TestViewModel&gt; {
        every { uiState } returns MutableStateFlow(TestUiState())
    }
}
</code></pre>
<h2 data-id="heading-24">总结</h2>
<ol>
<li>
<p><strong>默认作用域</strong>：在 Compose 中，<code>viewModel()</code> 默认使用当前 <code>LocalViewModelStoreOwner</code>，通常是 NavDestination。</p>
</li>
<li>
<p><strong>作用域选择</strong>：</p>
<ul>
<li>屏幕级：默认，适合单个屏幕</li>
<li>导航图级：适合共享相关屏幕间的状态</li>
<li>Activity 级：适合全局共享状态</li>
</ul>
</li>
<li>
<p><strong>生命周期控制</strong>：</p>
<ul>
<li>使用 <code>DisposableEffect</code> 进行精确控制</li>
<li>利用 <code>SavedStateHandle</code> 进行状态持久化</li>
<li>在 <code>onCleared()</code> 中清理资源</li>
</ul>
</li>
<li>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>根据状态共享需求选择合适的作用域</li>
<li>使用依赖注入（如 Hilt）简化管理</li>
<li>为不同场景设计测试策略</li>
</ul>
</li>
</ol>
<p>通过合理使用 ViewModel 作用域，可以有效地管理状态的生命周期，避免内存泄漏，并确保状态在正确的上下文中共享和隔离。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别静态PPT！拖入文档，一键生成动态视频PPT，1分钟学会！PPT秒变高级！（附保姆级教程）]]></title>    <link>https://juejin.cn/post/7583260493851590697</link>    <guid>https://juejin.cn/post/7583260493851590697</guid>    <pubDate>2025-12-15T00:58:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493851590697" data-draft-id="7583226204036562985" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别静态PPT！拖入文档，一键生成动态视频PPT，1分钟学会！PPT秒变高级！（附保姆级教程）"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-15T00:58:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员X小鹿"/> <meta itemprop="url" content="https://juejin.cn/user/2928754709505608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别静态PPT！拖入文档，一键生成动态视频PPT，1分钟学会！PPT秒变高级！（附保姆级教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754709505608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员X小鹿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:58:27.000Z" title="Mon Dec 15 2025 00:58:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是X小鹿。</p>
<p>之前分享过不少可以用 AI 来生成 PPT 的工具，比如 Kimi、豆包、千问、扣子空间、天工（Skywork）、Manus、Genspark 等等。</p>
<p>这些工具，都可以根据我们上传的文档，来自动生成 PPT。</p>
<p>前几天在刷视频的时候，刷到了一款可以生成「<strong>动态视频 PPT</strong>」的 AI 工具。</p>
<p>看着效果还挺酷炫的，趁着周末，来试一下效果。下面的视频 PPT 就是用这个 AI 工具一键生成的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c1c3945517343f290684af5f0b85b9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=GPx1UpNyyEiJV4aA9NwBQnUw1co%3D" alt="截屏2025-12-15 08.55.35.png" loading="lazy"/></p>
<p>（视频效果见<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FUQiCst8rTHkUUjOcj8UjSQ" target="_blank" title="https://mp.weixin.qq.com/s/UQiCst8rTHkUUjOcj8UjSQ" ref="nofollow noopener noreferrer">原文</a>）</p>
<p>上面的视频，是一次性生成的效果，没有做任何编辑。</p>
<p>整体效果挺酷炫，而且它还给这个视频 PPT 添加了背景音乐。（ps：转场时有时文字会出现变形）</p>
<p>不过它也提供了「图片编辑」和「视频编辑」，可以继续修改。</p>
<p>这个工具大家肯定都用过，就是「纳米AI」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/234a573964684872a05d0bd4ac1d377c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=H7qQ8CMojzElyNthOw5eOsjOQko%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">动态视频 PPT 生成</h2>
<p>纳米AI最近增加了一个「视频PPT」的功能。（省流：非免费功能，生成需要消耗纳米）</p>
<p>操作很简单，点进去后，只需要<code>拖入文件</code>、<code>设置 PPT 风格</code>、<code>页数</code>、<code>类型选视频</code>，就能生成动态视频 PPT 了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/786a262510544d0aa900812bda1ce996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=meRMI0oADxvBL%2F%2FESCuJTtpOntw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-1">PPT 风格</h3>
<p>纳米AI的「视频PPT」，目前支持了几十种 PPT 风格，也支持自定义风格。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbf2d675fd044f93abd12a1f17c57423~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=mbf%2FmrzbVbX%2FjVdaGqhrhmyoNPs%3D" alt="图片" loading="lazy"/></p>
<p>文章开头的视频，用的就是歸藏老师的「玻璃渐变卡片」风格。前段时间还在歸藏老师的公众号文章里看到了，没想到可以直接在纳米AI里使用，还不错。</p>
<p>除了玻璃渐变卡片风格外，纳米AI还提供了适合于「文旅宣传」、「企业宣传」的 PPT 风格。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a0ddccd8e49449180f696ab9bac4778~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=ZR3AFoFosBfa1u%2FjJGQ3Mvwy%2BXc%3D" alt="图片" loading="lazy"/></p>
<p>还有很多卡通 IP 形象的风格，比如哆啦A梦、火影忍者、柯南、奥特曼、灌篮高手、七龙珠等等。</p>
<p>这种风格用在教育领域，比如课堂演示、做课件等，都还不错。卡通风格，小朋友们更容易接受。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0da566ca106a434298448647c8a211c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=Qx%2BXlwmmaZMteax0mAOroUBZBYc%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/951cecd7ca8c40c5b59d8f1cd10537bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=TVL%2F4OSTDFeoaSU4athKsET53MI%3D" alt="图片" loading="lazy"/></p>
<p>这些案例在「推荐作品」里都可以查看，也可以「一键做同款」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f8ab3ecd321491481da24a1151ed1b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=Q9wCqEgEHL%2FL6VqeeaUuIXhpah0%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">编辑</h3>
<p>如果对生成的视频 PPT 不满意，还可以继续「编辑图片」或「编辑视频」：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f4c16c5cfef4ce8b28ed5ea0ee0d949~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=4wd1D%2FisTEtHGFq2FhMqLadhiFU%3D" alt="图片" loading="lazy"/></p>
<p><strong>图片编辑器：</strong></p>
<p>这里提供了每张图片的提示词。</p>
<p>可以重新生成图片，也可以局部重绘、编辑元素等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e31a05c690514aa4a24110a7b289577a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=xNwEgDgVzJNQf64%2BaLvDrPfmvdA%3D" alt="图片" loading="lazy"/></p>
<p><strong>视频编辑器：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c5c9c50f71a41ba9d7079cea0110ebd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=D%2B2K75QnzlJbeME%2Bd00Q7B3VAQw%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c0859ff69fe4eb19726452b07e91354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=CZbKnE2KgFp93j1HUZzUHWtf%2BpE%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/157376a43d0f451595ebaca3005fe08c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=QTTo1gTA5yv0Y8X9cnW4b7h21A8%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">写在最后</h2>
<p>相对于以往的大多数 AI 工具只能生成静态 PPT，纳米AI生成的动态视频 PPT，给人一种耳目一新的感觉。</p>
<p>不管是用于项目汇报，还是企业宣传、课堂教学，都是可以的。</p>
<p>最后来总结一下吧。</p>
<p><strong>纳米<strong><strong>AI</strong></strong>的「视频PPT」功能，只需要拖入文件，设置风格、页数，它就能自动总结文档重点，然后调用各个 AI 大模型和工具，来生成图片、视频、背景音乐，最后拼接成一个动态的视频 PPT。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56a24c0e51634c8d9c3ca37d85ce2d7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=D1cXhGNfGA6HafjiMwGnztSS7CM%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88884782e13f46e58f22375840caa44e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=nfd5RnIwR9icQPdMlUoYwyTfbCo%3D" alt="图片" loading="lazy"/></p>
<p>整个过程不需要我们操作，全部由纳米AI自动完成，就很方便。</p>
<p>不过比较明显的问题是，转场时的文字会变形。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07c6a1a800ed482f956a6052bb854158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=emITWBoywDHyR3C9JKyNXLXUZSk%3D" alt="图片" loading="lazy"/></p>
<p>生成的时长也相对较长。15 页的 PPT，耗时 25 分钟。</p>
<p>不过因为毕竟期间需要生成多个视频，还需要视频拼接、给视频添加 BGM 等操作，所以相比于生成静态 PPT 的一些 AI 工具来说，纳米AI生成的视频 PPT 时间较长，这也是可以理解的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33673a6c328642e59c081cc447fb0cfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766365107&amp;x-signature=96agzzzNJDuOMzm161erOJDwXoE%3D" alt="图片" loading="lazy"/></p>
<p>另外，纳米AI的这个「视频PPT」功能不是免费的功能，生成需要消耗纳米。（文章开头的视频，15 页的 PPT，一共消耗了 340 纳米）</p>
<p>最后附上纳米AI的网址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.n.cn%2F" target="_blank" title="https://www.n.cn/" ref="nofollow noopener noreferrer">www.n.cn/</a></p>
<p>以上就是今天的分享，有需要的可以尝试一下。</p>
<hr/>
<blockquote>
<p>我是<a href="https://juejin.cn/user/2928754709505608/posts" title="https://juejin.cn/user/2928754709505608/posts" target="_blank">程序员X小鹿</a>，前互联网大厂程序员，也是一名 AIGC 爱好者，持续分享更多好用的 AI 工具，欢迎一起交流~</p>
</blockquote>
<p><strong>推荐阅读</strong></p>
<p><a href="https://juejin.cn/post/7454501732203610131" title="https://juejin.cn/post/7454501732203610131" target="_blank">2024年终AI工具汇总：9大AI领域，70+精选AI工具，全都在这了！(建议收藏)</a></p>
<p>更多 AI 工具见<a href="https://juejin.cn/column/7284164153576947724" title="https://juejin.cn/column/7284164153576947724" target="_blank">【AI工具】</a>专栏，持续更新中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 官方正式解决 WebView 在 iOS 26 上有点击问题]]></title>    <link>https://juejin.cn/post/7583577045578907674</link>    <guid>https://juejin.cn/post/7583577045578907674</guid>    <pubDate>2025-12-14T23:10:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583577045578907674" data-draft-id="7583567658253746202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 官方正式解决 WebView 在 iOS 26 上有点击问题"/> <meta itemprop="keywords" content="Flutter,Android,前端"/> <meta itemprop="datePublished" content="2025-12-14T23:10:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 官方正式解决 WebView 在 iOS 26 上有点击问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T23:10:15.000Z" title="Sun Dec 14 2025 23:10:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上个月和大家聊到了 <a href="https://juejin.cn/post/7571306072423448618" target="_blank" title="https://juejin.cn/post/7571306072423448618">《为什么你的 Flutter WebView 在 iOS 26 上有点击问题？》</a> ，源头是因为 <strong>WKWebView（WebKit）内部的手势识别器与 Flutter 在 Engine 里用于“阻止/延迟”手势的 recognizer 之间的冲突</strong>，因为 Flutter 和 UIKit 都各自有手势识别系统（GestureRecognizer），为了防止互相抢事件，Flutter engine 在 iOS 上加入了一个“<strong>delaying gesture recognizer</strong>”（延迟识别器），这也最终导致了 iOS 26 上的 bug ：</p>
<blockquote>
<p>在 Flutter 弹窗和 WKWebView 一起出来的时候，要么点不动，要么触摸会穿透到下面的 WebView 。</p>
</blockquote>
<p>而在提供了之前部分场景有效的临时解决方案之后，Flutter 官方也提出了几个对应的可行性重构方案，具体可见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1ag4drAdJsR7y-rQZkqJWc6tOQ4qCbflQSGyoxsSC6MM%2F" target="_blank" title="https://docs.google.com/document/d/1ag4drAdJsR7y-rQZkqJWc6tOQ4qCbflQSGyoxsSC6MM/" ref="nofollow noopener noreferrer">docs.google.com/document/d/…</a> ，而现在方案三最终确定并 LGTM ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf106d6c2e68440aadd91028a5e76d83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=5mnL8b0GDAhEBWyWVIAa%2BtBlHNQ%3D" alt="" loading="lazy"/></p>
<p>回顾整个问题里程，主要有两点：</p>
<ul>
<li>现有的 “<strong>gesture recognizer approach</strong>” （依赖自定义 <code>UIGestureRecognizer</code> + <code>shouldRequireFailureOfGestureRecognizer</code>）存在局限：无法阻止 <code>UIView</code> / JS 的底层 touch 回调（例如 WebView 的 <code>touchstart</code>），并且会和 WebView  的内部识别器冲突（这个导致了 iOS 的平台 bug），从而让一直以来的 hack 实现（如 remove/re-add recognizer）不生效：</li>
</ul>
<blockquote>
<p>因为 JS的 <code>touchstart</code> 在 <code>touchesBegan</code> 当帧同步触发，Flutter 没法在 touchesBegan 前屏蔽掉事件。</p>
</blockquote>
<ul>
<li>以前为了解决 Google Maps 的 “dangling touchesBegan” 问题，引入了 <code>WaitUntilTouchesEnded</code> 策略，这是个权宜之计但并不理想，本质也是一种延迟机制：</li>
</ul>
<blockquote>
<p>因为当时 Flutter 没有能力在 <code>touchesBegan</code> 之前阻止触摸的到达，只能用 gesture recognizer 阻断，而这就导致了 Google Maps 在 <code>touchesBegan</code> 之后，后续 <code>touchesEnded</code>  会变成  recognizer fails 从而不会收到 <code>touchesEnded</code>，而这就是 <code>WaitUntilTouchesEnded</code> 诞生的背景，<code>WaitUntilTouchesEnded</code> 的目的就是避免 Google Maps 在中途被强制 fail，导致内部手势状态机 fails。</p>
</blockquote>
<p><strong>其实这一切的原因都是已经“异步协同”，所以现在修复开始改为“同步”</strong>，也就是 Flutter Engine + iOS embedder 新增了 “同步 hitTest 回调” 能力 ：</p>
<ul>
<li>iOS embedder 增加了可拦截 hitTest 的 <code>UIView</code></li>
<li>Engine 与 Dart Framework 通过 FFI 实现“同步回调”</li>
</ul>
<p>具体来说就是，首先是 Dart Framework 层，这里新增手势拦截策略 API (<code>UiKitView</code>)，在 <code>UiKitView</code> 组件中新增了 <code>gestureRecognizersBlockingPolicy</code>  参数，让开发者可以为每个 PlatformView 单独配置手势拦截行为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbb90ae37fb447619445926d8d838a35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=eUYSZiz1UGYGAYfqMybnHyt8lhs%3D" alt="" loading="lazy"/></p>



































<table><thead><tr><th><strong>策略名称</strong></th><th><strong>拦截时机</strong></th><th><strong>使用技术</strong></th><th><strong>解决核心问题</strong></th></tr></thead><tbody><tr><td><strong><code>touchBlockingOnly</code></strong></td><td><strong>最快 (HitTest 阶段)</strong></td><td>iOS <code>hitTest</code> 重写</td><td><strong>修复 iOS 18+/26 WebView/AdMob 无法点击</strong></td></tr><tr><td><code>eager</code></td><td>快 (手势竞争胜出时)</td><td>阻塞手势识别器</td><td>(旧默认值，现已不推荐)</td></tr><tr><td><code>waitUntilTouchesEnded</code></td><td>慢 (手指抬起后)</td><td>阻塞手势识别器</td><td>过去修复 Google Maps 状态卡死问题</td></tr><tr><td><code>fallbackToPluginDefault</code></td><td>(取决于插件设定)</td><td>(取决于插件设定)</td><td>保持旧插件兼容性</td></tr></tbody></table>
<blockquote>
<p>新机制让开发者可以在 Dart 代码中直接指定 PlatformView 的手势拦截策略，而不是依赖全局配置或原生代码，根据不同场景配置不同的拦截处理机制，而 <code>touchBlockingOnly</code>  就是全新的支持。</p>
</blockquote>
<p>例如针对 AdMob 或 WebView 在 iOS 18+/26 上的点击穿透问题，现在开发者可以强制使用 <code>touchBlockingOnly</code> 策略，从而绕过有问题的 <code>gesture recognizer</code> 机制。</p>
<blockquote>
<p>另外也提供了 <code>fallbackToPluginDefault</code>，确保不修改代码的情况下维持原有插件的行为。</p>
</blockquote>
<p>接着就是在 Dart Framework 层实现了 Hit Test 逻辑，用于响应 Engine 发起的命中测试请求，判断点击位置是否落在 PlatformView 上：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2531bb5a6ae243ca9626c27fe2f162e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=U0v5i8fo3VTkix79%2BKMUvmptGQY%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>当用户点击屏幕时，Flutter 通过 Render Tree 判断该位置最上层是否是 PlatformView，如果是被 Flutter 组件（如下拉菜单）遮挡，<code>firstHit</code> 就不会是 <code>NativeHitTestTarget</code>，从而拦截触摸。</p>
</blockquote>
<p>然后就是  Engine / Bridge 层的通信，这部分主要负责将 iOS 原生的同步调用桥接到 Dart 环境，这里提供了一个同步的 Dart 入口点 <code>_platformViewShouldAcceptTouch</code>，从而让 iOS 原生的 <code>hitTest</code> 方法可以阻塞等待 Dart 的判断结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f0eec9293754efe89dcde8a8bafffed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=63PpnsrT64aY9Sb95qJu78AlGa8%3D" alt="" loading="lazy"/></p>
<p>之后就是  iOS Engine 层重写了 <code>hitTest</code> 方法，这也是本次修复的核心，通过重写 PlatformView 的 <code>hitTest</code> 方法，在通过响应链传递触摸事件之前，先询问 Flutter Framework 是否应该拦截该事件：</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">- (UIView*)hitTest:(CGPoint)point withEvent:(UIEvent*)event {
  if (_blockingPolicy == FlutterPlatformViewGestureRecognizersBlockingPolicyTouchBlockingOnly) { //
    // ... (获取 flutterViewController)
    
    CGPoint pointInFlutterView = [self convertPoint:point toView:self.flutterViewController.view];
    
    // 询问 Framework 是否应该接收此触摸
    if (![self.flutterViewController
            platformViewShouldAcceptTouchAtTouchBeganLocation:pointInFlutterView]) { //
      // 如果 Framework 说 "不" (例如点击了 Flutter 遮罩)，返回 self (拦截触摸)
      return self;
    }
  }

  // 如果 Framework 说 "是"，调用 super，让事件传递给 WKWebView
  return [super hitTest:point withEvent:event];
}
</code></pre>
<p>而对应的就是，如果策略是 <code>TouchBlockingOnly</code>，则不再添加容易导致冲突的 <code>delayingRecognizer</code> :</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7118fbbcc2964e9caafc43690292d137~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=%2BMBOqRuhEMsQNYLrGOT4KZesGLw%3D" alt="" loading="lazy"/></p>
<p>也就是，现在会先通过 <code>hitTest</code> 预先判断，避免了使用 <code>UIGestureRecognizerDelegate</code> 带来的复杂性和 iOS 18+ 上的 Bug，而当 <code>platformViewShouldAcceptTouch</code> 返回 <code>NO</code> 时，<code>FlutterTouchInterceptingView</code> 自身会吞掉事件，底层的 WebView 就不会收到错误的点击，从而修复了点击穿透或链接无法点击的问题。</p>
<h2 data-id="heading-0">最后</h2>
<p>可以看到，本次调整数据较大的底层变动，所以牵动的模块也比较多，这也是为什么这个 PR 一直拖到现在才合并的原因，因为需要考虑和测试的因素很多：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1657bf9b16e14e05972030076f76de7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766358614&amp;x-signature=4JV7LN4r0e5hrmhpcKM2cJW9Ycw%3D" alt="" loading="lazy"/></p>
<p>而对于开发者来说，如果要引用修复，最好是通过增加对应的  <code>gestureBlockingPolicy</code> 参数来支持配置，只针对有问题的场景使用  <code>touchBlockingOnly</code> ，因为这怎么说也是一个底层大变更，会不会有新的问题还不好说。</p>
<h2 data-id="heading-1">参考链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F179659" target="_blank" title="https://github.com/flutter/flutter/pull/179659" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F175099" target="_blank" title="https://github.com/flutter/flutter/issues/175099" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>