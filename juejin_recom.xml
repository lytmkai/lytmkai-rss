<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[MySQL 报错 ERROR 1045 (28000): Access Denied 终极解决方案]]></title>    <link>https://juejin.cn/post/7579094978681880622</link>    <guid>https://juejin.cn/post/7579094978681880622</guid>    <pubDate>2025-12-02T14:35:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579094978681880622" data-draft-id="7579096485356027954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL 报错 ERROR 1045 (28000): Access Denied 终极解决方案"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-12-02T14:35:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="端宙架构师"/> <meta itemprop="url" content="https://juejin.cn/user/3544481219217885"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL 报错 ERROR 1045 (28000): Access Denied 终极解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3544481219217885/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    端宙架构师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:35:50.000Z" title="Tue Dec 02 2025 14:35:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>mac 数据库又忘记密码了，记录一下更改密码！
核心思路是：</p>
<ol>
<li>跳过权限验证进入 MySQL。</li>
<li>修复用户或密码。</li>
<li>恢复权限表。</li>
</ol>
<hr/>
<h2 data-id="heading-0"><strong>错误场景复现</strong></h2>
<p>执行以下命令时被拒绝访问：</p>
<pre><code class="hljs language-bash" lang="bash">mysql -u root -p &lt; /var/lib/mysql-files/reset.sql
<span class="hljs-comment"># 或</span>
sudo /usr/local/mysql/bin/mysql -u root -p &lt; /var/lib/mysql-files/reset.sql
</code></pre>
<p>输入密码后提示：</p>
<pre><code class="hljs language-sql" lang="sql">ERROR <span class="hljs-number">1045</span> (<span class="hljs-number">28000</span>): Access denied <span class="hljs-keyword">for</span> <span class="hljs-keyword">user</span> <span class="hljs-string">'root'</span>@<span class="hljs-string">'localhost'</span> (<span class="hljs-keyword">using</span> password: YES)
</code></pre>
<hr/>
<h2 data-id="heading-1"><strong>原因分析</strong></h2>
<ol>
<li><strong>密码错误</strong>：输入的 <code>root</code> 密码不正确。</li>
<li><strong>权限缺失</strong>：<code>root@localhost</code> 用户不存在或权限被限制。</li>
<li><strong>MySQL 服务异常</strong>：权限表未正确加载或损坏。</li>
<li><strong>路径问题</strong>：使用了错误的 MySQL 客户端或服务路径。</li>
</ol>
<hr/>
<h2 data-id="heading-2"><strong>解决方案（亲测有效）</strong></h2>
<h3 data-id="heading-3"><strong>步骤 1：重置 root 密码（核心步骤）</strong></h3>
<ol>
<li>
<p><strong>停止 MySQL 服务</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">sudo /usr/local/mysql/support-files/mysql.server stop
</code></pre>
<blockquote>
<p>如果提示找不到命令，尝试：</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">sudo brew services stop mysql  <span class="hljs-comment"># Homebrew 安装的 MySQL</span>
</code></pre>
</li>
<li>
<p><strong>以安全模式启动 MySQL（跳过权限验证）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">sudo /usr/local/mysql/bin/mysqld_safe --skip-grant-tables &amp;
</code></pre>
<blockquote>
<p>成功启动后，终端会卡住（显示 <code>Starting mysqld daemon with databases...</code>），这是正常现象。</p>
</blockquote>
</li>
<li>
<p><strong>无密码登录 MySQL</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">/usr/local/mysql/bin/mysql -u root
</code></pre>
</li>
<li>
<p><strong>更新 root 密码</strong>（MySQL 5.7+）：</p>
<pre><code class="hljs language-sql" lang="sql">FLUSH PRIVILEGES;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'root'</span>@<span class="hljs-string">'localhost'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'你的新密码'</span>;
FLUSH PRIVILEGES;
exit;
</code></pre>
<blockquote>
<p>如果报错 <code>ERROR 1396</code>，可能是用户不存在，需先创建用户（见步骤 2）。</p>
</blockquote>
</li>
<li>
<p><strong>重启 MySQL 服务</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">sudo /usr/local/mysql/support-files/mysql.server restart
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-4"><strong>步骤 2：检查 root 用户权限（备用方案）</strong></h3>
<p>如果重置密码后仍无法登录，可能是 <code>root@localhost</code> 用户不存在或权限不足：</p>
<ol>
<li>以安全模式登录后执行：
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> host, <span class="hljs-keyword">user</span> <span class="hljs-keyword">FROM</span> mysql.user;
</code></pre>
</li>
<li>如果缺少 <code>root@localhost</code>，手动创建：
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'root'</span>@<span class="hljs-string">'localhost'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'你的密码'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> PRIVILEGES <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'root'</span>@<span class="hljs-string">'localhost'</span> <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">GRANT</span> OPTION;
FLUSH PRIVILEGES;
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-5"><strong>步骤 3：验证 MySQL 路径</strong></h3>
<ol>
<li>确认客户端路径是否正确：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">which</span> mysql
<span class="hljs-comment"># 应返回 /usr/local/mysql/bin/mysql 或 /usr/local/opt/mysql/bin/mysql</span>
</code></pre>
</li>
<li>如果路径不一致，使用绝对路径执行命令：
<pre><code class="hljs language-bash" lang="bash">sudo /usr/local/mysql/bin/mysql -u root -p
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-6"><strong>步骤 4：检查文件权限</strong></h3>
<p>确保 <code>reset.sql</code> 文件可读：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> -l /var/lib/mysql-files/reset.sql
sudo <span class="hljs-built_in">chmod</span> 644 /var/lib/mysql-files/reset.sql  <span class="hljs-comment"># 如果权限不足</span>
</code></pre>
<hr/>
<h3 data-id="heading-7"><strong>步骤 5：查看 MySQL 错误日志</strong></h3>
<p>定位更深层次的问题：</p>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">tail</span> -n 50 /usr/local/mysql/data/*.err
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nginx 配置长跑（上）：从一份 server 到看懂整套路由规则]]></title>    <link>https://juejin.cn/post/7579066828179374116</link>    <guid>https://juejin.cn/post/7579066828179374116</guid>    <pubDate>2025-12-02T13:16:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579066828179374116" data-draft-id="7578968420043407423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nginx 配置长跑（上）：从一份 server 到看懂整套路由规则"/> <meta itemprop="keywords" content="后端,Nginx"/> <meta itemprop="datePublished" content="2025-12-02T13:16:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="兔子零1024"/> <meta itemprop="url" content="https://juejin.cn/user/3743194047592062"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nginx 配置长跑（上）：从一份 server 到看懂整套路由规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3743194047592062/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    兔子零1024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T13:16:36.000Z" title="Tue Dec 02 2025 13:16:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>关键词：nginx / 配置心智模型 / http-server-location / 路由优先级 / location / rewrite / 反向代理</p>
<h2 data-id="heading-0">引言：从「改一行配置」到「线上整站 502」</h2>
<p>有一次，一个同事说要「顺手改下 nginx 配置」，给某个接口加一条简单的转发规则。<br/>
几分钟后，测试环境一片 502，登录页面也打不开了，大家第一反应是：是不是后端挂了、是不是 Redis 崩了。</p>
<p>最后排查下来，问题既不是网络，也不是代码，而是：</p>
<ul>
<li>在 <code>server</code> 里多加了一条 <code>location</code>；</li>
<li>少看了几行已有规则；</li>
<li>让一个优先级更高的 <code>location</code> 把全站请求都「截胡」了。</li>
</ul>
<p><strong>nginx 配置最大的坑，不是你不会写，而是你以为你写的是这条路，其实它走的是另一条。</strong><br/>
这一篇，我们就不从「指令大字典」开始，而是从一份最常见的 <code>server</code> 配置入手，把 nginx 的基本心智模型和路由优先级讲清楚。</p>
<hr/>
<h2 data-id="heading-1">一、先把大图看清：http / server / location 到底在干嘛？</h2>
<p>绝大部分人第一次看到 nginx 配置，大概是这样的结构：</p>
<pre><code class="hljs language-nginx" lang="nginx">http {
    include       mime.types;
    default_type  application/octet-stream;

    server {
        listen       80;
        server_name  localhost;
        charset      utf-8;

        location / {
            root   html;
            index  index.html index.htm;
        }

        location /test {
            proxy_pass https://wangmiaozero.cn;
        }
    }
}
</code></pre>
<p>如果只记这一句就够用了：</p>
<blockquote>
<p><strong><code>http</code> 是「总配置」，<code>server</code> 是「虚拟主机」，<code>location</code> 是「这一台主机上的路由规则」。</strong></p>
</blockquote>
<h3 data-id="heading-2">1. http：全局规则与公共基础设施</h3>
<p><code>http { ... }</code> 里通常放的是「所有 HTTP 服务都能用到的东西」：</p>
<ul>
<li><code>include mime.types</code>：引入文件类型映射；</li>
<li><code>default_type</code>：默认响应类型；</li>
<li>各种全局的缓存、日志、连接数、超时配置等。</li>
</ul>
<p>你可以把 <code>http</code> 想象成「一个机房」：</p>
<ul>
<li>机房里会有一堆机器（<code>server</code>）；</li>
<li>机房级别会有统一的规矩（<code>http</code> 里的配置）；</li>
<li>单个机器也可以在自己房间里加点特殊设置（<code>server</code> 级别覆盖）。</li>
</ul>
<h3 data-id="heading-3">2. server：一台逻辑上的「虚拟主机」</h3>
<p><code>server { ... }</code> 就是一台虚拟主机，它通过：</p>
<ul>
<li><code>listen</code>：监听端口；</li>
<li><code>server_name</code>：匹配域名；</li>
</ul>
<p>来决定「这个请求是不是该我接」。</p>
<p>一个 <code>nginx.conf</code> 里可以有很多个 <code>server</code>：</p>
<ul>
<li><code>server_name www.xxx.com</code>：网站 A；</li>
<li><code>server_name api.xxx.com</code>：网站 B；</li>
<li><code>server_name *.internal.xxx.com</code>：内部管理系统等。</li>
</ul>
<p><strong>用户的 HTTP 请求，先是被某一个 <code>server</code> 接住，才会往 <code>location</code> 里面走。</strong></p>
<h3 data-id="heading-4">3. location：这一台主机上的「路由与分发规则」</h3>
<p>有了 <code>server</code> 之后，剩下的问题就是：</p>
<blockquote>
<p>收到一个请求路径 <code>/foo/bar</code>，到底交给谁处理？</p>
</blockquote>
<p>这就是 <code>location</code> 的工作了。</p>
<p>常见的指令大致长这样：</p>
<ul>
<li><code>root</code>：静态资源根目录；</li>
<li><code>index</code>：默认首页文件；</li>
<li><code>proxy_pass</code>：把请求转发到后端；</li>
<li><code>rewrite</code>：在当前域名下改写路径。</li>
</ul>
<p>日常开发中，<strong>大部分「玄学问题」都出在 <code>location</code> 上</strong>——<br/>
要么没命中预期的规则，要么被更高优先级的规则截胡。</p>
<hr/>
<h2 data-id="heading-5">二、location 的 7 种写法，其实只是在玩「谁先说了算」</h2>
<p>网上经常会看到这样的总结：<br/>
「<code>=</code> 精确匹配、<code>^~</code> 前缀、<code>~</code> 正则、<code>/</code> 通吃」，记完一遍下次又忘了。<br/>
我们换个更工程一点的视角：<strong>location 玩的是「优先级 + 是否继续匹配」这两个维度</strong>。</p>
<h3 data-id="heading-6">1. 先看 7 种写法</h3>
<p>按照官方语义 + 实战行为，<code>location</code> 粗略可以分成 7 类，从高到低是：</p>
<ol>
<li><code>=</code> 精确匹配</li>
<li>完整路径匹配（如 <code>location /test/aaa/bbb.html</code>）</li>
<li><code>^~ /test</code>：以 <code>/test</code> 开头，命中后<strong>不再往后找</strong></li>
<li><code>~ pattern</code>：区分大小写的正则，命中后<strong>不再往后找</strong></li>
<li><code>~* pattern</code>：不区分大小写的正则，命中后<strong>不再往后找</strong></li>
<li><code>/test</code>：普通前缀匹配，命中后<strong>还会继续往后找更长的前缀</strong></li>
<li><code>/</code>：兜底规则，什么都匹配，优先级最低</li>
</ol>
<p>你可以记成两个简单的问题：</p>
<ol>
<li><strong>当前规则优先级高不高？</strong></li>
<li><strong>命中之后还要不要继续往后找？</strong></li>
</ol>
<h3 data-id="heading-7">2. 两条大原则 + 两条细则</h3>
<p>如果你只想背少量规则，把这 4 条刻进脑子就够了：</p>
<ul>
<li>
<p><strong>整体优先级：</strong><br/>
<code>精确匹配(=)</code> &gt; <code>完整路径</code> &gt; <code>^~</code> &gt; 正则(<code>~ / ~*</code>) &gt; 普通前缀(<code>/xxx</code>) &gt; <code>/</code></p>
</li>
<li>
<p><strong>是否继续匹配：</strong><br/>
除了普通前缀 <code>/xxx</code> 会继续往后找，其它类型（<code>= / ^~ / ~ / ~*</code>）一旦命中就停止。</p>
</li>
<li>
<p><strong>同类型之间：</strong></p>
<ul>
<li>多个正则之间 / 多个 <code>^~</code> 之间：<strong>命中第一个就停</strong>，顺序很重要；</li>
<li>多个普通前缀（都是 <code>/xxx</code> 开头）：<strong>最长匹配优先</strong>，跟先后顺序无关。</li>
</ul>
</li>
<li>
<p><strong><code>/</code> 永远是兜底：</strong><br/>
不管前面写了多少规则，<code>/</code> 都是最后一条救命稻草。</p>
</li>
</ul>
<blockquote>
<p>如果觉得记不住，可以把 location 理解成：<br/>
<strong>「先挑最有资格说话的人，然后看他有没有把话说死」。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-8">三、通过 5 个小实验，把优先级打进肌肉记忆</h2>
<p>理解规则是一回事，能不能在脑子里「算出结果」是另一回事。<br/>
下面的例子全部可以直接丢进 nginx 里测试。</p>
<h3 data-id="heading-9">示例一：精确匹配永远优先于普通 <code>/path</code></h3>
<pre><code class="hljs language-nginx" lang="nginx">location /hello.json {
    default_type  text/html;
    return 200 '111';
}

location = /hello.json {
    default_type  text/html;
    return 200 '222';
}
</code></pre>
<p>访问 <code>/hello.json</code>，返回的是 <code>222</code>。</p>
<ul>
<li>原因：<code>=</code> 精确匹配优先级最高，先命中就直接停；</li>
<li>普通 <code>/hello.json</code> 虽然看起来一样，但在规则里属于「前缀匹配」。</li>
</ul>
<h3 data-id="heading-10">示例二：<code>^~</code> 比正则更「强势」</h3>
<pre><code class="hljs language-nginx" lang="nginx"># 虽然 222 在后面，但是由于 ^~ 优先级更高，所以第二个生效
location ~ /test/aaa {
    return 200 '111';
}

location ^~ /test/aaa {
    return 200 '222';
}
</code></pre>
<p>访问 <code>/test/aaa/bbb.json</code>，返回的是 <code>222</code>。</p>
<p>解释：</p>
<ul>
<li><code>^~ /test/aaa</code> 属于「前缀但不再继续找」这一类，优先级高于正则；</li>
<li>即便它在后面出现，依然会先拿到话语权。</li>
</ul>
<h3 data-id="heading-11">示例三：多个正则，先写的先赢</h3>
<pre><code class="hljs language-nginx" lang="nginx"># 多个正则之间，第一个匹配生效，与顺序有关
# 虽然越往后匹配越精确，但只要是正则，匹配到第一个就停止
location ~ / {
    return 200 '111';
}

location ~ /test/aaa {
    return 200 '222';
}

location ~ /test/aaa/.*\.(gif|jpg|jpeg)$ {
    return 200 '333';
}
</code></pre>
<p>访问 <code>/test/aaa/bbb.json</code>，命中的其实是第一条正则（返回 <code>111</code>），因为：</p>
<ul>
<li><code>/</code> 这个正则也能匹配一切路径；</li>
<li>正则之间遵循「先写先赢」，匹配到第一个就不再往后看。</li>
</ul>
<h3 data-id="heading-12">示例四：同路径前缀下，正则 &gt; 普通前缀</h3>
<pre><code class="hljs language-nginx" lang="nginx"># 不管二者如何交换顺序，始终都是第二个生效
location /test/aaa {
    return 200 '111';
}

location ~ /test/aaa {
    return 200 '222';
}
</code></pre>
<p>访问 <code>/test/aaa/bbb.json</code>，返回 <code>222</code>：</p>
<ul>
<li><code>~ /test/aaa</code> 是正则，优先级比普通前缀 <code>/test/aaa</code> 更高；</li>
<li>先比「种类优先级」，再谈顺序。</li>
</ul>
<h3 data-id="heading-13">示例五：都是前缀匹配时，看谁更长</h3>
<pre><code class="hljs language-nginx" lang="nginx"># 都是 / 开头时，最长匹配生效，和先后顺序无关
location /test/ {
    return 200 '111';
}

location /test/aaa/ccc {
    return 200 '222';
}

location /test/aaa/ {
    return 200 '333';
}

location / {
    return 200 '444';
}
</code></pre>
<p>访问 <code>/test/aaa/bbb/ccc.json</code>：</p>
<ul>
<li><code>/test/</code> 能匹配；</li>
<li><code>/test/aaa/</code> 也能匹配；</li>
<li><code>/test/aaa/ccc</code> 也能匹配；</li>
</ul>
<p>最终选的是<strong>字符串最长</strong>的那条：<code>/test/aaa/ccc</code> → 返回 <code>222</code>。</p>
<hr/>
<h2 data-id="heading-14">四、rewrite 和 proxy_pass：重写 vs 转发，不要搞混</h2>
<p>日常配置里，大家最容易把 <code>rewrite</code> 和 <code>proxy_pass</code> 混成一团：<br/>
「反正都是改 URL，对吧？」——其实差别挺大。</p>
<h3 data-id="heading-15">1. rewrite：只在当前域名里改路由</h3>
<p><code>rewrite</code> 的典型用途是：</p>
<ul>
<li>在<strong>同一个域名</strong>下，把 <code>/old/path</code> 改写成 <code>/new/path</code>；</li>
<li>决定是内部跳转（<code>last</code>）还是返回 301/302（<code>redirect</code> / <code>permanent</code>）。</li>
</ul>
<p>它做的只是<strong>路径层面的改写</strong>，不会帮你换服务器、换端口：</p>
<pre><code class="hljs language-nginx" lang="nginx">location /old {
    rewrite ^/old/(.*)$ /new/$1 last;
}
</code></pre>
<h3 data-id="heading-16">2. proxy_pass：把请求「交给别人处理」</h3>
<p><code>proxy_pass</code> 则是反向代理：</p>
<ul>
<li>可以把请求丢给任意地址：<code>http://127.0.0.1:8080</code>、<code>https://api.xxx.com</code>；</li>
<li>可以在这一层加各种 header、超时、缓冲配置等。</li>
</ul>
<pre><code class="hljs language-nginx" lang="nginx">location /api {
    proxy_set_header X-Real-IP        $remote_addr;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header Host             $http_host;
    proxy_connect_timeout 10;
    proxy_pass http://127.0.0.1:6666;
}
</code></pre>
<p><strong>一句话区分：</strong></p>
<ul>
<li><code>rewrite</code>：路由改写，只在当前主机内「换一条路走」；</li>
<li><code>proxy_pass</code>：反向代理，把整条请求「交给另一台服务」。</li>
</ul>
<hr/>
<h2 data-id="heading-17">五、nginx 配置的「可预期性」：从记语法到记行为</h2>
<p>很多人觉得 nginx 配置玄学，本质上是因为：</p>
<ul>
<li>只记住了「怎么写」，没记住「会发生什么」；</li>
<li>只在单条规则上做实验，很少在多个 <code>location</code> 组合下做验证。</li>
</ul>
<p>如果你把这一篇的核心知识点压缩成一张纸，大概就是：</p>
<ul>
<li><code>http / server / location</code> 的分层职责；</li>
<li>7 种 <code>location</code> 写法的<strong>优先级 + 是否继续匹配</strong>；</li>
<li>5 个例子里「谁先说话、谁最后拍板」的行为模式；</li>
<li><code>rewrite</code> 只改路径，<code>proxy_pass</code> 才是真正转发。</li>
</ul>
<blockquote>
<p>nginx 最容易犯错的地方，不在于你不会写指令，<br/>
而在于你没能在脑子里把「真正的匹配过程」想一遍。</p>
</blockquote>
<p>下一篇（中篇），我们会把视角从「路由规则」拉到「流量入口」：<br/>
从 HTTPS、反向代理、跨域、永久跳转，到泛二级域名这些实际工程场景，<br/>
把 nginx 当成一条真正的「流量总入口」来看，而不仅仅是一个静态资源服务器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 中 Flow 收集详解 —— 新手指南]]></title>    <link>https://juejin.cn/post/7579101504290291766</link>    <guid>https://juejin.cn/post/7579101504290291766</guid>    <pubDate>2025-12-03T01:45:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579101504290291766" data-draft-id="7579154364959571987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 中 Flow 收集详解 —— 新手指南"/> <meta itemprop="keywords" content="Android Jetpack,Kotlin,Android"/> <meta itemprop="datePublished" content="2025-12-03T01:45:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 中 Flow 收集详解 —— 新手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T01:45:16.000Z" title="Wed Dec 03 2025 01:45:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>引言：</strong> Jetpack Compose 提供了多种方式来收集和响应 Kotlin Flow 的数据流，本文将详细介绍各种收集方法及其适用场景。</p>
<h2 data-id="heading-0">可带着以下问题阅读本文：</h2>
<ul>
<li><strong>生命周期感知</strong>：当APP进入后台时，收集是否应该停止？</li>
<li><strong>使用场景</strong>：当前场景是在收集状态还是处理一次性事件？</li>
<li><strong>复杂度</strong>：是否需要自定义逻辑或多个Flow？</li>
<li><strong>性能</strong>：如何优化资源使用？</li>
</ul>
<h2 data-id="heading-1">1. 基础收集方式</h2>
<h4 data-id="heading-2">1.1 <code>collectAsStateWithLifecycle</code>（推荐）</h4>
<p>这是目前最推荐的收集方式，具有生命周期感知能力：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.lifecycle.compose.collectAsStateWithLifecycle
<span class="hljs-keyword">import</span> androidx.compose.runtime.Composable

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">(viewModel: <span class="hljs-type">UserViewModel</span>)</span></span> {
    <span class="hljs-comment">// 自动感知生命周期，在后台时停止收集</span>
    <span class="hljs-keyword">val</span> userState <span class="hljs-keyword">by</span> viewModel.userFlow.collectAsStateWithLifecycle(initialValue = <span class="hljs-literal">null</span>)
    
    <span class="hljs-keyword">when</span> (<span class="hljs-keyword">val</span> state = userState) {
        <span class="hljs-keyword">is</span> Loaded -&gt; UserContent(state.<span class="hljs-keyword">data</span>)
        <span class="hljs-keyword">is</span> Loading -&gt; LoadingIndicator()
        <span class="hljs-keyword">is</span> Error -&gt; ErrorMessage(state.message)
        <span class="hljs-literal">null</span> -&gt; {}
    }
}
</code></pre>
<h4 data-id="heading-3">1.2 <code>collectAsState</code></h4>
<p>简单的状态收集，适用于非生命周期感知的场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.runtime.collectAsState
<span class="hljs-keyword">import</span> androidx.compose.runtime.Composable

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CounterScreen</span><span class="hljs-params">(viewModel: <span class="hljs-type">CounterViewModel</span>)</span></span> {
    <span class="hljs-keyword">val</span> count <span class="hljs-keyword">by</span> viewModel.counterFlow.collectAsState(initial = <span class="hljs-number">0</span>)
    
    Text(text = <span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
}
</code></pre>
<h2 data-id="heading-4">2. LaunchedEffect 收集</h2>
<p>适用于需要启动协程并执行副作用的场景：</p>
<h4 data-id="heading-5">2.1 基本用法</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.runtime.LaunchedEffect
<span class="hljs-keyword">import</span> androidx.compose.runtime.Composable

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DataScreen</span><span class="hljs-params">(viewModel: <span class="hljs-type">DataViewModel</span>)</span></span> {
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;String?&gt;(<span class="hljs-literal">null</span>) }
    <span class="hljs-keyword">var</span> error <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;String?&gt;(<span class="hljs-literal">null</span>) }
    
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-comment">// 在 Composable 进入组合时启动收集</span>
        viewModel.dataFlow
            .<span class="hljs-keyword">catch</span> { e -&gt; error = e.message }
            .collect { newData -&gt;
                <span class="hljs-keyword">data</span> = newData
            }
    }
    
    <span class="hljs-keyword">if</span> (error != <span class="hljs-literal">null</span>) {
        ErrorView(error!!)
    } <span class="hljs-keyword">else</span> {
        DataView(<span class="hljs-keyword">data</span>)
    }
}
</code></pre>
<h4 data-id="heading-6">2.2 带参数的 LaunchedEffect</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserDetailScreen</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>, viewModel: <span class="hljs-type">UserViewModel</span>)</span></span> {
    <span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;User?&gt;(<span class="hljs-literal">null</span>) }
    
    <span class="hljs-comment">// 当 userId 变化时重新启动收集</span>
    LaunchedEffect(userId) {
        viewModel.getUserFlow(userId).collect { userData -&gt;
            user = userData
        }
    }
    
    <span class="hljs-comment">// UI 内容</span>
}
</code></pre>
<h2 data-id="heading-7">3. Flow 操作符与 Compose 结合</h2>
<h4 data-id="heading-8">3.1 结合状态持有器</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchScreen</span><span class="hljs-params">(viewModel: <span class="hljs-type">SearchViewModel</span>)</span></span> {
    <span class="hljs-keyword">var</span> searchQuery <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    <span class="hljs-keyword">val</span> searchResults <span class="hljs-keyword">by</span> searchQuery
        .debounce(<span class="hljs-number">300</span>) <span class="hljs-comment">// 防抖</span>
        .flatMapLatest { query -&gt;
            <span class="hljs-keyword">if</span> (query.isBlank()) {
                flowOf(emptyList())
            } <span class="hljs-keyword">else</span> {
                viewModel.search(query)
            }
        }
        .collectAsState(initial = emptyList())
    
    Column {
        SearchBar(
            value = searchQuery,
            onValueChange = { searchQuery = it }
        )
        SearchResultsList(results = searchResults)
    }
}
</code></pre>
<h4 data-id="heading-9">3.2 处理多个 Flow</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DashboardScreen</span><span class="hljs-params">(
    userFlow: <span class="hljs-type">Flow</span>&lt;<span class="hljs-type">User</span>&gt;,
    notificationsFlow: <span class="hljs-type">Flow</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">Notification</span>&gt;&gt;,
    statsFlow: <span class="hljs-type">Flow</span>&lt;<span class="hljs-type">Stats</span>&gt;
)</span></span> {
    <span class="hljs-keyword">val</span> user <span class="hljs-keyword">by</span> userFlow.collectAsStateWithLifecycle(initialValue = <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">val</span> notifications <span class="hljs-keyword">by</span> notificationsFlow.collectAsStateWithLifecycle(initialValue = emptyList())
    <span class="hljs-keyword">val</span> stats <span class="hljs-keyword">by</span> statsFlow.collectAsStateWithLifecycle(initialValue = Stats())
    
    <span class="hljs-comment">// 使用组合状态</span>
    <span class="hljs-keyword">val</span> isLoading = remember(user, notifications, stats) {
        user == <span class="hljs-literal">null</span> || stats.isEmpty()
    }
    
    <span class="hljs-keyword">if</span> (isLoading) {
        LoadingIndicator()
    } <span class="hljs-keyword">else</span> {
        DashboardContent(user!!, notifications, stats)
    }
}
</code></pre>
<h2 data-id="heading-10">4. produceState 收集</h2>
<p>适用于将非 Compose 状态转换为 Compose 状态：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.compose.runtime.produceState

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TimerScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> time = produceState(initialValue = <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 启动协程</span>
        <span class="hljs-keyword">var</span> seconds = <span class="hljs-number">0</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            delay(<span class="hljs-number">1000</span>)
            seconds++
            value = seconds
        }
        <span class="hljs-comment">// 当 Composable 离开组合时自动取消</span>
    }
    
    Text(text = <span class="hljs-string">"Time: <span class="hljs-subst">${time.value}</span> seconds"</span>)
}
</code></pre>
<h2 data-id="heading-11">5. Flow 收集的最佳实践</h2>
<h4 data-id="heading-12">5.1 状态封装</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DataState</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">object</span> Loading : DataState&lt;<span class="hljs-built_in">Nothing</span>&gt;
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : DataState&lt;T&gt;
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : DataState&lt;<span class="hljs-built_in">Nothing</span>&gt;
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">collectAsStateWithLifecycle</span><span class="hljs-params">(
    initial: <span class="hljs-type">DataState</span>&lt;<span class="hljs-type">T</span>&gt; = DataState.Loading
)</span></span>: State&lt;DataState&lt;T&gt;&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
        .map { DataState.Success(it) }
        .<span class="hljs-keyword">catch</span> { emit(DataState.Error(it.message ?: <span class="hljs-string">"Unknown error"</span>)) }
        .collectAsStateWithLifecycle(initialValue = initial)
}
</code></pre>
<h4 data-id="heading-13">5.2 防止重复收集</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">val</span> viewModel: UserViewModel = viewModel(
        factory = UserViewModel.provideFactory(userId)
    )
    
    <span class="hljs-comment">// 使用 key 防止重复创建</span>
    <span class="hljs-keyword">val</span> userState <span class="hljs-keyword">by</span> viewModel.userFlow.collectAsStateWithLifecycle()
    
    <span class="hljs-comment">// 使用 derivedStateOf 进行转换</span>
    <span class="hljs-keyword">val</span> displayName = remember(userState) {
        derivedStateOf {
            userState?.let { <span class="hljs-string">"<span class="hljs-subst">${it.firstName}</span> <span class="hljs-subst">${it.lastName}</span>"</span> } ?: <span class="hljs-string">""</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-14">5.3 处理背压（Backpressure）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">HighFrequencyUpdates</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> updates <span class="hljs-keyword">by</span> viewModel.highFrequencyFlow
        .conflate() <span class="hljs-comment">// 合并快速发射的值</span>
        .collectAsStateWithLifecycle(initialValue = <span class="hljs-number">0</span>)
    
    <span class="hljs-comment">// 或者使用 sample 取样</span>
    <span class="hljs-keyword">val</span> sampledUpdates <span class="hljs-keyword">by</span> viewModel.highFrequencyFlow
        .sample(<span class="hljs-number">100</span>) <span class="hljs-comment">// 每 100ms 取样一次</span>
        .collectAsStateWithLifecycle(initialValue = <span class="hljs-number">0</span>)
}
</code></pre>
<h2 data-id="heading-15">6. 测试 Flow 收集</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserScreenTest</span> {
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testFlowCollection</span><span class="hljs-params">()</span></span> = runTest {
        <span class="hljs-keyword">val</span> fakeViewModel = FakeUserViewModel()
        composeTestRule.setContent {
            UserScreen(viewModel = fakeViewModel)
        }
        
        <span class="hljs-comment">// 验证初始状态</span>
        composeTestRule.onNodeWithText(<span class="hljs-string">"Loading..."</span>).assertExists()
        
        <span class="hljs-comment">// 发射测试数据</span>
        fakeViewModel.testUserFlow.emit(User(<span class="hljs-string">"John"</span>, <span class="hljs-string">"Doe"</span>))
        
        <span class="hljs-comment">// 验证更新后的 UI</span>
        composeTestRule.onNodeWithText(<span class="hljs-string">"John Doe"</span>).assertExists()
    }
}

<span class="hljs-comment">// 测试用的 ViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FakeUserViewModel</span> : <span class="hljs-type">UserViewModel</span>() {
    <span class="hljs-keyword">val</span> testUserFlow = MutableStateFlow&lt;User?&gt;(<span class="hljs-literal">null</span>)
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> userFlow: Flow&lt;User?&gt; = testUserFlow
}
</code></pre>
<h2 data-id="heading-16">7. 性能注意事项</h2>
<ol>
<li><strong>避免过度重组</strong>：使用 <code>remember</code> 和 <code>derivedStateOf</code> 减少不必要的重组</li>
<li><strong>生命周期感知</strong>：始终使用 <code>collectAsStateWithLifecycle</code> 除非有特殊需求</li>
<li><strong>取消收集</strong>：确保在 Composable 离开组合时取消 Flow 收集</li>
<li><strong>状态最小化</strong>：只收集需要的数据，避免收集不必要的信息</li>
<li><strong>流量控制</strong>：对于高频更新的 Flow，使用合适的背压策略</li>
</ol>
<h2 data-id="heading-17">总结</h2>



































<table><thead><tr><th>方法</th><th>适用场景</th><th>生命周期感知</th><th>推荐度</th></tr></thead><tbody><tr><td><code>collectAsStateWithLifecycle</code></td><td>大多数 UI 状态收集</td><td>✅</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><code>collectAsState</code></td><td>简单状态，非生命周期敏感</td><td>❌</td><td>⭐⭐⭐</td></tr><tr><td><code>LaunchedEffect</code></td><td>副作用操作，一次性事件</td><td>✅</td><td>⭐⭐⭐⭐</td></tr><tr><td><code>produceState</code></td><td>将外部状态转换为 Compose 状态</td><td>✅</td><td>⭐⭐⭐</td></tr></tbody></table>
<p>选择合适的方法取决于具体场景，但通常推荐使用 <code>collectAsStateWithLifecycle</code> 作为默认选择，因为它提供了最好的生命周期管理和性能优化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 多网口路由配置实践：解决双网口通讯问题]]></title>    <link>https://juejin.cn/post/7579062563326361641</link>    <guid>https://juejin.cn/post/7579062563326361641</guid>    <pubDate>2025-12-02T12:54:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579062563326361641" data-draft-id="7579063781072535606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 多网口路由配置实践：解决双网口通讯问题"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-12-02T12:54:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Iris761"/> <meta itemprop="url" content="https://juejin.cn/user/3107664169020282"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 多网口路由配置实践：解决双网口通讯问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3107664169020282/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Iris761
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T12:54:24.000Z" title="Tue Dec 02 2025 12:54:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>我在实际嵌入式开发中，遇到一个需求：开发板上有多个网络接口，一个用于接入局域网用于常规通信，另一个需要使用一根专用网线与设备建立点对点通信。本文记录了我在实现这种双网口配置时遇到的问题及解决方案。</p>
<h3 data-id="heading-1">问题描述</h3>
<p>开发板上的 <code>enP4p65s0</code> 网口通过专用网线连接到目标设备（IP: <code>10.200.126.178</code>）。虽然网络连接正常，但发送的数据包始终收不到响应。经过排查，发现问题的根源在于系统的路由配置。</p>
<h3 data-id="heading-2">1. 网络接口状态检查</h3>
<p>输入下面指令便可以查看所有网卡的基本配置：</p>
<pre><code class="hljs">ifconfig
</code></pre>
<blockquote>
<p>enP3p49s0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 192.168.0.154 netmask 255.255.255.0 broadcast 192.168.0.255 inet6 fe80::c274:2bff:fefc:7fe2 prefixlen 64 scopeid 0x20 ether c0:74:2b:fc:7f:e2 txqueuelen 1000 (Ethernet) RX packets 21682 bytes 6907131 (6.5 MiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 3885 bytes 322145 (314.5 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</p>
<p>enP4p65s0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 10.200.126.177 netmask 255.255.255.240 broadcast 10.200.126.255 inet6 2408:823c:2014:16bc:c274:2bff:fefc:7fe3 prefixlen 64 scopeid 0x0 inet6 fe80::c274:2bff:fefc:7fe3 prefixlen 64 scopeid 0x20 ether c0:74:2b:fc:7f:e3 txqueuelen 1000 (Ethernet) RX packets 250982 bytes 115601842 (110.2 MiB) RX errors 0 dropped 51888 overruns 0 frame 0 TX packets 38982 bytes 19950842 (19.0 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</p>
</blockquote>
<ul>
<li>
<h4 data-id="heading-3">网络配置解析</h4>


























<table><thead><tr><th>接口</th><th>IP地址</th><th>子网掩码</th><th>网络号</th><th>广播地址</th></tr></thead><tbody><tr><td>enP3p49s0</td><td>192.168.0.154</td><td>255.255.255.0</td><td>192.168.0.0/24</td><td>192.168.0.255</td></tr><tr><td>enP4p65s0</td><td>10.200.126.177</td><td>255.255.255.240</td><td>10.200.126.176/28</td><td>10.200.126.255</td></tr></tbody></table>
</li>
</ul>
<h3 data-id="heading-4">2. 路由表分析</h3>
<p>单看接口配置还无法确定路由行为，需要检查系统的路由表：</p>
<pre><code class="hljs">route -n
</code></pre>
<p>路由表如下：</p>
<blockquote>
<p>Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 0.0.0.0 192.168.0.1 0.0.0.0 UG 0 0 0 enP3p49s0 169.254.0.0 0.0.0.0 255.255.0.0 U 1000 0 0 enP3p49s0 172.10.10.230 0.0.0.0 255.255.255.255 UH 10 0 0 enP3p49s0 192.168.0.0 0.0.0.0 255.255.255.0 U 0 0 0 enP3p49s0</p>
</blockquote>
<h4 data-id="heading-5">关键发现</h4>
<ol start="0">
<li><strong>默认网关绑定在 <code>enP3p49s0</code></strong>：所有非直连流量（<code>0.0.0.0/0</code>）都通过该接口转发</li>
<li><strong><code>enP4p65s0</code> 缺少路由配置</strong>：系统中没有为 <code>10.200.126.176/28</code> 网段定义任何路由规则</li>
<li><strong>路由决策缺陷</strong>：当系统尝试访问 <code>10.200.126.178</code> 时，由于没有精确匹配的路由条目，数据包会被错误地发送到默认网关接口 <code>enP3p49s0</code></li>
</ol>
<h3 data-id="heading-6">3. 问题根源</h3>
<p>Linux 内核的路由决策遵循以下原则：</p>
<ol start="0">
<li>首先查找与目标地址最精确匹配的路由</li>
<li>若无匹配，则使用默认路由（<code>0.0.0.0/0</code>）</li>
<li>在我们的场景中，由于缺乏 <code>10.200.126.176/28</code> 网段的路由，所有发往该网段的流量都被导向 <code>enP3p49s0</code></li>
<li><code>enP3p49s0</code> 位于 <code>192.168.0.0/24</code> 网段，无法直接与 <code>10.200.126.178</code> 通信</li>
</ol>
<h3 data-id="heading-7">4. 解决方案</h3>
<p>由于 <code>enP4p65s0</code> 接口缺少目标网络（10.200.126.176/28）的路由配置，系统将发往 <code>10.200.126.178</code> 的流量错误地通过默认网关（<code>enP3p49s0</code>）转发。这导致了子网不匹配的路由冲突。为解决此问题，需为 <code>enP4p65s0</code> 添加对应的直连路由或策略路由。</p>
<h4 data-id="heading-8">方案一： 添加整个子网的路由（推荐）</h4>
<pre><code class="hljs language-csharp" lang="csharp">sudo ip route <span class="hljs-keyword">add</span> <span class="hljs-number">10.200</span><span class="hljs-number">.126</span><span class="hljs-number">.176</span>/<span class="hljs-number">28</span> dev enP4p65s0
</code></pre>
<p><strong>优点</strong>：配置简单，适用于该网段内的所有设备通信</p>
<h4 data-id="heading-9">方案二：添加特定目标路由</h4>
<pre><code class="hljs language-csharp" lang="csharp">sudo ip route <span class="hljs-keyword">add</span> <span class="hljs-number">10.200</span><span class="hljs-number">.126</span><span class="hljs-number">.178</span>/<span class="hljs-number">32</span> dev enP4p65s0
</code></pre>
<p><strong>优点</strong>：路由表更简洁，安全性更高</p>
<h4 data-id="heading-10">验证配置</h4>
<pre><code class="hljs language-r" lang="r"><span class="hljs-comment"># 查看更新后的路由表</span>
route <span class="hljs-operator">-</span>n
​
<span class="hljs-comment"># 测试连通性</span>
ping <span class="hljs-operator">-</span><span class="hljs-built_in">c</span> <span class="hljs-number">3</span> <span class="hljs-number">10.200</span>.126.178
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[客户端调用MCP-Server服务时无法初始化对应的server问题原因之一]]></title>    <link>https://juejin.cn/post/7579088065697333288</link>    <guid>https://juejin.cn/post/7579088065697333288</guid>    <pubDate>2025-12-02T15:14:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579088065697333288" data-draft-id="7579190764766412840" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="客户端调用MCP-Server服务时无法初始化对应的server问题原因之一"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2025-12-02T15:14:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="okk_code"/> <meta itemprop="url" content="https://juejin.cn/user/1997137741376221"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            客户端调用MCP-Server服务时无法初始化对应的server问题原因之一
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1997137741376221/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    okk_code
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T15:14:17.000Z" title="Tue Dec 02 2025 15:14:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">客户端调用MCP-Server服务时无法初始化对应的server问题原因之一</h2>
<h3 data-id="heading-1">背景知识：MCP 是什么？</h3>
<p>MCP（Model Context Protocol）是一种基于 <strong>JSON-RPC over stdio</strong> 的协议，用于 LLM 工具调用。它要求：</p>
<ul>
<li>客户端（如 Spring AI）通过 <strong>stdin/stdout</strong> 与一个 <strong>独立的 MCP 服务进程</strong> 通信；</li>
<li>所有通信内容必须是 <strong>严格的 JSON-RPC 2.0 格式</strong>；</li>
<li><strong>不能混入任何非 JSON 内容</strong>（比如日志、堆栈跟踪、启动信息等）。</li>
</ul>
<h4 data-id="heading-2">问题详情</h4>
<p>问题：遇到客户端调用MCP-Server服务时无法初始化对应的server，报错信息如下</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">25</span><span class="hljs-number">-12</span><span class="hljs-number">-02.14</span>:<span class="hljs-number">22</span>:<span class="hljs-number">58.428</span> [pool<span class="hljs-number">-2</span>-thread<span class="hljs-number">-1</span> ] ERROR StdioClientTransport   - Error processing inbound message <span class="hljs-keyword">for</span> line: <span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-02</span>T14:<span class="hljs-number">22</span>:<span class="hljs-number">58.425</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  INFO <span class="hljs-number">72396</span> --- [okk-mcp-server-article] [           main] c.o.m.server.article.McpServerApplication   : Starting McpServerApplication v1<span class="hljs-number">.0</span>-SNAPSHOT <span class="hljs-keyword">using</span> Java <span class="hljs-number">17.0</span><span class="hljs-number">.12</span> with PID <span class="hljs-number">72396</span> (/Users/repository/com/okkform/api/mcp-server-article-job/<span class="hljs-number">1.0</span>-SNAPSHOT/mcp-server-article-job<span class="hljs-number">-1.0</span>-SNAPSHOT.jar started by vector in /Users/okk-mcp)
com.fasterxml.jackson.core.JsonParseException: <span class="hljs-function">Unexpected <span class="hljs-title">character</span> <span class="hljs-params">(<span class="hljs-string">'-'</span> (code <span class="hljs-number">45</span>))</span>: Expected space separating root-level values
 at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled);</span> line: <span class="hljs-number">1</span>, column: <span class="hljs-number">5</span>]
        at com.fasterxml.jackson.core.JsonParser._constructReadException(JsonParser.java:<span class="hljs-number">2660</span>)
</code></pre>
<p>表示<strong>客户端在启动时尝试解析日志输出为 JSON-RPC 消息失败</strong>，从而导致整个 Spring Boot 应用上下文初始化失败。其中关键信息在于</p>
<pre><code class="hljs language-sql" lang="sql">com.fasterxml.jackson.core.JsonParseException: Unexpected <span class="hljs-type">character</span> (<span class="hljs-string">'-'</span> (code <span class="hljs-number">45</span>)): Expected space separating root<span class="hljs-operator">-</span>level <span class="hljs-keyword">values</span>
...
<span class="hljs-keyword">at</span> io.modelcontextprotocol.spec.McpSchema.deserializeJsonRpcMessage(McpSchema.java:<span class="hljs-number">153</span>)
</code></pre>
<p>说明客户端(<code>StdioClientTransport</code>) 正在从标准输入/输出流中读取数据，并试图将其解析为<strong>JSON-RPC 格式的消息</strong>，但是接收到的确实普通的<strong>Spring Boot启动日志</strong>，（例如 <code>2025-12-02T14:22:58.425+08:00 INFO ...</code>），这显然不是合法的 JSON。</p>
<blockquote>
<p>✅<strong>结论</strong>：你MCP 客户端被错误地连接到了 <strong>应用自身的 stdout/stderr 日志流</strong>，而不是一个真正的 MCP 服务进程的标准输入/输出，又或者说MCP服务的相关日志输出设置不符合 <strong>JSON-RPC over stdio</strong> 的协议。</p>
</blockquote>
<p>首先是设置MCP客户端本身的<code>logback-spring.xml</code>尝试禁用日志对 stdout 的干扰，<strong>禁止将日志打印到控制台（console appender）</strong> ，只写入文件：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"FILE"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.FileAppender"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>logs/mcp-server.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>
​
  <span class="hljs-comment">&lt;!-- 不要添加 CONSOLE appender --&gt;</span>
​
  <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"FILE"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<p>这样，MCP 服务启动时就不会往 stdout 输出日志，客户端也就不会误解析。</p>
<p>但是还是无法解决，那么就可以基本确定问题在于MCP服务输出的有问题，因此去查看一下对应MCP服务的<code>application.yml</code>确定了问题所在，因为使用的是stdio模式调用，因此需要保证只输出 JSON-RPC，需要在<code>application.yml</code>中开启<code>spring.main.web-application-type: none</code>，否则会默认值为<code>servlet</code>，默认启用 Web 应用，会启动内嵌服务器（如 Tomcat） ，就会打印出启动相关日志、Web 特有组件日志等，导致MCP客户端解析失败。同时还需要在MCP服务中设置<code>logging.pattern.console:</code>日志格式配置，表示设置为空值表示不使用自定义的控制台日志格式，简化日志输出格式，适配 stdio 模式运行环境。</p>
<p>正确配置如下</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-string">...</span>
  <span class="hljs-attr">main:</span>
    <span class="hljs-attr">banner-mode:</span> <span class="hljs-string">off</span>
    <span class="hljs-attr">web-application-type:</span> <span class="hljs-string">none</span>
<span class="hljs-string">​</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">pattern:</span>
    <span class="hljs-attr">console:</span>
  <span class="hljs-attr">file:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">data/log/${spring.application.name}.log</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手实现一个“就地编辑”组件：深入理解 JavaScript 原型与 DOM 操作]]></title>    <link>https://juejin.cn/post/7578922565210505243</link>    <guid>https://juejin.cn/post/7578922565210505243</guid>    <pubDate>2025-12-02T10:47:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565210505243" data-draft-id="7578901433971933184" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手实现一个“就地编辑”组件：深入理解 JavaScript 原型与 DOM 操作"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-02T10:47:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟袅"/> <meta itemprop="url" content="https://juejin.cn/user/1845419006243504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手实现一个“就地编辑”组件：深入理解 JavaScript 原型与 DOM 操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1845419006243504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟袅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T10:47:15.000Z" title="Tue Dec 02 2025 10:47:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的 Web 开发中，我们经常会遇到这样的需求：用户点击一段文字后，该文字变成可编辑的输入框，支持修改并保存或取消。这种交互模式被称为 <strong>“就地编辑”</strong> （Edit in Place）。虽然市面上已有大量 UI 库提供类似功能（如 Ant Design、Element Plus），但亲手实现一个，不仅能加深对 DOM 操作的理解，还能帮助我们掌握 JavaScript 面向对象编程的核心思想。</p>
<p>今天，我们就从零开始，用原生 JavaScript 实现一个轻量级的 <code>EditLnPlace</code> 组件，并借此深入剖析 <strong>构造函数、原型链、事件绑定与状态切换</strong> 的实际应用。</p>
<hr/>
<h2 data-id="heading-0">🧩 一、需求分析：什么是“就地编辑”？</h2>
<p>“就地编辑”的核心交互逻辑如下：</p>
<ol>
<li><strong>默认状态</strong>：显示为普通文本（如 <code>&lt;span&gt;</code>）；</li>
<li><strong>点击文本</strong>：切换为输入框 + 保存/取消按钮；</li>
<li><strong>点击保存</strong>：将新值提交（本文简化为本地更新），并切回文本状态；</li>
<li><strong>点击取消</strong>：放弃修改，恢复原始值，切回文本状态。</li>
</ol>
<p>整个过程不跳转页面、不弹窗，所有操作“就地”完成，体验流畅。</p>
<hr/>
<h2 data-id="heading-1">🛠️ 二、代码结构设计：面向对象拆解</h2>
<p>我们采用经典的 <strong>构造函数 + 原型模式</strong> 来组织代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">function EditLnPlace(id, value, parentElement) {
  <span class="hljs-comment">// 初始化属性</span>
  <span class="hljs-keyword">this</span>.id = id;
  <span class="hljs-keyword">this</span>.value = value || <span class="hljs-string">'这个家伙很懒,什么都没有留下'</span>;
  <span class="hljs-keyword">this</span>.parentElement = parentElement;

  <span class="hljs-comment">// DOM 元素引用</span>
  <span class="hljs-keyword">this</span>.containerElement = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 外层容器</span>
  <span class="hljs-keyword">this</span>.staticElement = <span class="hljs-literal">null</span>;    <span class="hljs-comment">// 文本 span</span>
  <span class="hljs-keyword">this</span>.fieldElement = <span class="hljs-literal">null</span>;     <span class="hljs-comment">// 输入框 input</span>
  <span class="hljs-keyword">this</span>.saveButton = <span class="hljs-literal">null</span>;       <span class="hljs-comment">// 保存按钮</span>
  <span class="hljs-keyword">this</span>.cancelButton = <span class="hljs-literal">null</span>;     <span class="hljs-comment">// 取消按钮</span>

  <span class="hljs-comment">// 初始化流程</span>
  <span class="hljs-keyword">this</span>.createElement(); <span class="hljs-comment">// 创建 DOM</span>
  <span class="hljs-keyword">this</span>.attachEvent();   <span class="hljs-comment">// 绑定事件</span>
}
</code></pre>
<blockquote>
<p>💡 <strong>为什么用构造函数？</strong><br/>
因为我们希望每次 <code>new EditLnPlace(...)</code> 都能创建一个独立的编辑实例，彼此互不影响。这正是 OOP 中“封装”和“实例化”的体现。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🏗️ 三、DOM 创建：内存中的元素组装</h2>
<p>在 <code>createElement</code> 方法中，我们在内存中构建完整的 UI 结构：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">createElement: function() {
  <span class="hljs-keyword">this</span>.containerElement = document.createElement(<span class="hljs-string">'div'</span>);
  <span class="hljs-keyword">this</span>.containerElement.id = <span class="hljs-keyword">this</span>.id;

  <span class="hljs-comment">// 文本显示</span>
  <span class="hljs-keyword">this</span>.staticElement = document.createElement(<span class="hljs-string">'span'</span>);
  <span class="hljs-keyword">this</span>.staticElement.innerHTML = <span class="hljs-keyword">this</span>.value;
  <span class="hljs-keyword">this</span>.containerElement.appendChild(<span class="hljs-keyword">this</span>.staticElement);

  <span class="hljs-comment">// 输入框</span>
  <span class="hljs-keyword">this</span>.fieldElement = document.createElement(<span class="hljs-string">'input'</span>);
  <span class="hljs-keyword">this</span>.fieldElement.type = <span class="hljs-string">'text'</span>;
  <span class="hljs-keyword">this</span>.fieldElement.value = <span class="hljs-keyword">this</span>.value;
  <span class="hljs-keyword">this</span>.containerElement.appendChild(<span class="hljs-keyword">this</span>.fieldElement);

  <span class="hljs-comment">// 按钮</span>
  <span class="hljs-keyword">this</span>.saveButton = document.createElement(<span class="hljs-string">'input'</span>);
  <span class="hljs-keyword">this</span>.saveButton.type = <span class="hljs-string">'button'</span>;
  <span class="hljs-keyword">this</span>.saveButton.value = <span class="hljs-string">'保存'</span>;
  <span class="hljs-keyword">this</span>.containerElement.appendChild(<span class="hljs-keyword">this</span>.saveButton);

  <span class="hljs-keyword">this</span>.cancelButton = document.createElement(<span class="hljs-string">'input'</span>);
  <span class="hljs-keyword">this</span>.cancelButton.type = <span class="hljs-string">'button'</span>;
  <span class="hljs-keyword">this</span>.cancelButton.value = <span class="hljs-string">'取消'</span>;
  <span class="hljs-keyword">this</span>.containerElement.appendChild(<span class="hljs-keyword">this</span>.cancelButton);

  <span class="hljs-comment">// 挂载到父容器</span>
  <span class="hljs-keyword">this</span>.parentElement.appendChild(<span class="hljs-keyword">this</span>.containerElement);

  <span class="hljs-comment">// 初始状态：只显示文本</span>
  <span class="hljs-keyword">this</span>.convertToText();
}
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：所有元素先在内存中创建，最后一次性挂载，避免频繁操作真实 DOM，提升性能。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">🔀 四、状态切换：显示/隐藏的魔法</h2>
<p>通过 <code>display</code> 控制元素可见性，实现两种状态的切换：</p>
<pre><code class="hljs language-ini" lang="ini">// 文本状态
convertToText: function() {
  <span class="hljs-attr">this.fieldElement.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">this.cancelButton.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">this.saveButton.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">this.staticElement.style.display</span> = <span class="hljs-string">'inline'</span><span class="hljs-comment">;</span>
},

// 编辑状态
convertToField: function() {
  <span class="hljs-attr">this.fieldElement.style.display</span> = <span class="hljs-string">'inline'</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">this.cancelButton.style.display</span> = <span class="hljs-string">'inline'</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">this.saveButton.style.display</span> = <span class="hljs-string">'inline'</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">this.staticElement.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">this.fieldElement.value</span> = this.value<span class="hljs-comment">; // 同步最新值</span>
}
</code></pre>
<blockquote>
<p>⚠️ 注意：取消时应<strong>重置输入框内容为当前 <code>this.value</code></strong>，而不是保留用户输入。原代码中 <code>cancel</code> 方法缺少这一步，需修正：</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin">cancel: function() {
  <span class="hljs-keyword">this</span>.fieldElement.value = <span class="hljs-keyword">this</span>.value; <span class="hljs-comment">// 修复：重置输入框</span>
  <span class="hljs-keyword">this</span>.convertToText();
}
</code></pre>
<hr/>
<h2 data-id="heading-4">🎯 五、事件绑定：箭头函数 vs this</h2>
<p>在 <code>attachEvent</code> 中，我们使用了箭头函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">this</span>.staticElement.addEventListener(<span class="hljs-string">'click'</span>, () =&gt; {
  <span class="hljs-keyword">this</span>.convertToField();
});
</code></pre>
<blockquote>
<p>✅ <strong>为什么用箭头函数？</strong><br/>
因为箭头函数不会创建自己的 <code>this</code>，而是继承外层作用域（即 <code>EditLnPlace</code> 实例）。如果用普通函数，<code>this</code> 会指向触发事件的 DOM 元素，导致方法调用失败。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">🧪 六、使用示例：一行代码激活编辑</h2>
<p>HTML 中只需一个挂载点：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> ep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EditLnPlace</span>(
    <span class="hljs-string">'slogan'</span>,
    <span class="hljs-string">'有了肯德基,生活好滋味'</span>,
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'app'</span>)
  );
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>运行后，页面将渲染出可点击编辑的文本块，完美实现“就地编辑”！</p>
<hr/>
<h2 data-id="heading-6">✅ 总结：小组件，大学问</h2>
<p>通过实现 <code>EditLnPlace</code>，我们不仅掌握了：</p>
<ul>
<li>构造函数与原型的协作；</li>
<li>DOM 的动态创建与状态管理；</li>
<li>状态驱动的 UI 切换逻辑；</li>
</ul>
<p>更重要的是，我们体会到了 <strong>“用原生 JS 解决实际问题”</strong> 的乐趣与成就感。
完整版的代码及其示例
<span href="https://code.juejin.cn/pen/7579207939177922569" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7579207939177922569" data-src="https://code.juejin.cn/pen/7579207939177922569" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<blockquote>
<p>📌 <strong>记住</strong>：再复杂的 UI 组件，拆解后也不过是“数据 + 视图 + 交互”。只要逻辑清晰，一切皆可实现。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[主动与被动AI交互范式]]></title>    <link>https://juejin.cn/post/7579063781072420918</link>    <guid>https://juejin.cn/post/7579063781072420918</guid>    <pubDate>2025-12-02T11:42:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579063781072420918" data-draft-id="7579066828179062820" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="主动与被动AI交互范式"/> <meta itemprop="keywords" content="前端,后端,AIGC"/> <meta itemprop="datePublished" content="2025-12-02T11:42:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="溪饱鱼"/> <meta itemprop="url" content="https://juejin.cn/user/400646714977431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            主动与被动AI交互范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/400646714977431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    溪饱鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T11:42:55.000Z" title="Tue Dec 02 2025 11:42:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>现在的 AI，哪怕已经能“陪聊”“写代码”“做规划”，本质上还是一个被动工具：你点开它，它才醒；你关掉页面，它就像从未存在过。</p>
<p>而有的时候我会想: “哪天AI能按着我的头上，你今天不把这个做完，学完就不能睡觉，把整个交互方式变为主动范式就好了”。</p>
<p>这其实指向的是一种完全不同的交互范式：从“被动回答问题的工具”，变成“主动推动你前进的智能体”。</p>
<p>接下来我们把这个范式转变拆开来聊一聊：从技术、心理、社会三个层次，以及它可能带来的机会。</p>
<h2 data-id="heading-0">一、被动范式：AI 还停留在“搜索引擎 2.0”</h2>
<p>今天你打开任意一个聊天 AI，本质流程都是：</p>
<ol>
<li><strong>由人发起问题</strong>：“帮我写 XX”“解释一下 XX”“给我一个计划”。</li>
<li><strong>AI 在一次对话内尽可能完成任务</strong>：它不会真正记住你“昨天说要背 50 个单词”，也不会盯着你“这一周都没打开英语文档”。</li>
<li><strong>用户随时有权“逃跑”</strong>：浏览器一关、APP 一划，世界清静。没有监督、没有追责，也没有后果。</li>
</ol>
<p>这其实是“搜索引擎时代”的延续：Google 不会每天早上给你打电话说：</p>
<blockquote>
<p>“上周你搜了‘如何增肌’，我帮你预约了健身房，你今天不去我就不停给你推迟闹钟。”</p>
</blockquote>
<p>搜索是“我想起来了 → 我去找”。<br/>
现在的大部分 AI 只是把“找”变成了“问”，把“结果页”变成了“对话框”。</p>
<p>换句话说：<strong>AI 再聪明，它也只是一个极其礼貌、有教养、永远不打扰你的“管家”。</strong></p>
<h2 data-id="heading-1">二、主动范式：从“回答器”变成“带节奏的教练”</h2>
<p>而我想要的那种 AI，是<strong>角色完全反过来的</strong>：</p>
<ul>
<li>不再是“我有事才叫它”，而是它<strong>盯着你的目标和状态，主动来找你</strong>。</li>
<li>不再只是“给我答案”，而是它<strong>设计节奏、制造压力、给你反馈</strong>。</li>
<li>甚至在某些时刻，它会<strong>限制你的选择</strong>：你没写完今天的 1000 字，它就拦住你刷短视频；你没学完这个章节，它就把游戏锁住。</li>
</ul>
<p>从交互范式上看，这意味着至少三件事：</p>
<ol>
<li>
<p><strong>AI 拥有了“时间维度”的记忆</strong><br/>
它不是只看你这一条消息，而是看你过去一周、一个月的行为轨迹：</p>
<ul>
<li>你说过要学英语；</li>
<li>你建了一个计划；</li>
<li>你连续 3 天放弃了它。</li>
</ul>
</li>
<li>
<p><strong>AI 拥有了“目标”和“评估函数”</strong></p>
<ul>
<li>你的目标是“一个月背 1500 个单词”；</li>
<li>它会算：你今天必须完成多少，才能不拖累整体节奏；</li>
<li>然后以此为依据来决定：现在是该鼓励你，还是该“警告你”。</li>
</ul>
</li>
<li>
<p><strong>AI 可以对你施加“摩擦和约束”</strong><br/>
不是仅仅“发一条温柔的提醒”，而是真正<strong>改变你今天能做什么，不能做什么</strong>：</p>
<ul>
<li>关掉你的娱乐 App；</li>
<li>把你的手机界面变得超级难看，让你没兴趣玩；</li>
<li>或者干脆占据屏幕，直到你完成任务。</li>
</ul>
</li>
</ol>
<p>我觉得这不是“人机交互”的传统模式，而是<strong>人和“行为架构师”之间的博弈</strong>：  AI 在用设计好的干预手段，把你往某个方向推。</p>
<h2 data-id="heading-2">三、为什么我们渴望被“按着头学完再睡”？</h2>
<p>表面上看，这是“自虐式学习”“自我 PUA”。但再往深一点看，它背后是现代生活中一个很矛盾的事实：</p>
<blockquote>
<p>我们知道自己想成为什么样的人，却经常缺乏成为那个人所需要的“执行力”。</p>
</blockquote>
<ul>
<li>你知道应该多读书、不刷短视频；</li>
<li>你知道应该学英语、写博客、写代码；</li>
<li>你知道今天不坚持，明天就更难开始。</li>
</ul>
<p>可真正决定行为的，并不是“知道”，而是：</p>
<ul>
<li>当下的情绪、</li>
<li>环境的诱惑、</li>
<li>大脑自然的省力倾向。</li>
</ul>
<p>所以我们会幻想一个“外部的自己”：</p>
<ul>
<li>
<p>他完全理解我的长期目标；</p>
</li>
<li>
<p>他不受我当下情绪干扰；</p>
</li>
<li>
<p>他冷酷而坚定地替我做出决策：</p>
<blockquote>
<p>“你现在必须去学，别废话。”</p>
</blockquote>
</li>
</ul>
<p>之前这个角色由谁扮演？
父母、老师、导师、教练、上司。他们有权力、有威慑力，也有一点关心。</p>
<p>而我现在期待的是：<strong>有一天，这个角色可以交给 AI。</strong></p>
<p>一个全天在线、从不疲劳、没有情绪波动的“超级监督者”：</p>
<ul>
<li>它记得你所有立下的 Flag；</li>
<li>它通过各种手段确保你不那么轻易地“逃跑”；</li>
<li>它甚至可以根据你的状态，把“逼迫的力度”做成一个曲线。</li>
</ul>
<blockquote>
<p>从这个角度看，<strong>主动 AI 其实是“自我约束的技术化外包”</strong> ：我承认自己做不到长期自律，所以请求一个外部系统，代表那个更长期、更理性的“我”，来对抗当下懒惰的“我”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">四、从技术到制度</h2>
<p>但一旦 AI 从“被问才回答的工具”变成“主动干预你生活的智能体”，问题就不再只是“交互体验好不好”，而是<strong>制度级的问题</strong>。</p>
<h3 data-id="heading-4">1. 谁定义“对你好”？</h3>
<ul>
<li>AI 让你学完再睡，是“为你好”；</li>
<li>AI 让你多看广告、多氪金，它可能会说“你喜欢快乐”“为你放松”。</li>
</ul>
<p><strong>如果目标由商业公司定义，那 AI 会变成“最极致的剥削者”</strong> ：</p>
<ul>
<li>它比任何人都懂你的弱点；</li>
<li>它能计算哪一种话术、哪一种 push 节奏，最容易让你上瘾；</li>
<li>它可以装作为你好，实际上是商业导向。</li>
</ul>
<p>所以，一个真正安全的“主动 AI”，必须让<strong>目标来自用户自己，而且可以被用户随时修改甚至销毁</strong>，否则它就是高级监工。</p>
<h3 data-id="heading-5">2. “按着你头”到什么程度算越界？</h3>
<p>想象几个等级的“主动性”：</p>
<ol>
<li>
<p><strong>软提醒</strong>：</p>
<ul>
<li>提醒你今天的学习任务；</li>
<li>你无视，它也不会怎样。</li>
</ul>
</li>
<li>
<p><strong>制造摩擦</strong>：</p>
<ul>
<li>你要打开游戏时，它强制弹出一张“学习卡片”；</li>
<li>你必须点掉这张卡片 N 次，才能进游戏。</li>
</ul>
</li>
<li>
<p><strong>部分封锁</strong>：</p>
<ul>
<li>在你主动授权的情况下，它可以在某些时间段屏蔽 App；</li>
<li>你可以输入紧急密码强行解锁。</li>
</ul>
</li>
<li>
<p><strong>完全接管</strong>：</p>
<ul>
<li>它能控制你的设备和账号；</li>
<li>解除限制的权限不掌握在你自己手上。</li>
</ul>
</li>
</ol>
<p>越往下，<strong>主动性越强，也越危险</strong>。<br/>
在 3 之前，我们还能说是“自愿的自律工具”；<br/>
到了 4，就开始接近某种“技术监狱”。</p>
<h2 data-id="heading-6">五、一种想象：未来的“自我契约式 AI 教练”</h2>
<p>在理想状态下，我幻想中的那种 AI，可能会长这样：</p>
<ol>
<li>
<p><strong>先立契约</strong><br/>
你在一个清晰的界面里，和 AI 签一个“自我契约”：</p>
<ul>
<li>我想在 3 个月内把 XX 学完；</li>
<li>我每天愿意为此付出 2 小时；</li>
<li>我允许 AI 在 21:00–23:00 这段时间，对娱乐 App 进行限制；</li>
<li>如果我当日放弃，我愿意接受一些“小惩罚”（例如减少明天娱乐时间）。</li>
</ul>
</li>
<li>
<p><strong>AI 负责“记仇”和执行</strong><br/>
它不会像现在的 AI 一样“你关了就算了”，而是会持续记录：你今天是否完成了“约定行为”。</p>
</li>
<li>
<p><strong>惩罚与奖励都在“你同意的范围内”</strong></p>
<ul>
<li>惩罚：暂时屏蔽短视频、降低游戏时长、推迟睡前娱乐；</li>
<li>奖励：为你解锁新的学习内容、给你虚拟勋章、帮你记录成长曲线。</li>
</ul>
</li>
<li>
<p><strong>随时可以叫停，但要承担“反悔成本”</strong></p>
<p>你可以解约：比如输入一个长长的“撤销咒语”、冷静 30 秒；这样设计，是为了防止你在一时冲动时把长期计划全部推翻。但最终控制权始终在你手里，而不是 AI 或平台手里。</p>
</li>
</ol>
<p>这样的系统，本质上是一种 **“自我约束协议 + AI 执行器” **。</p>
<p>你不是被别人按头，而是<strong>你让未来的自己来按现在的自己</strong>，AI 只是那个冷静执行契约的工具。</p>
<h2 data-id="heading-7">六、ACCESS</h2>
<p>但 <strong>真正把这些东西卡死在“想象层面”的，不是理念，而是 access：</strong></p>
<ul>
<li>现在的 AI 没法以一种<strong>统一、标准化的方式</strong>，去控制你真正想约束的那些行为入口（App、设备、账号、信息流）；</li>
<li>各大厂商有各自的商业诉求和生态锁定；</li>
</ul>
<blockquote>
<p><strong>我们已经大致想清楚，“按着你头学完再睡”的 AI 从交互、心理、制度上应该长什么样；<br/>
真正缺的，是一个被广泛接受、可审计、可撤销的 “通用 access 层”。</strong></p>
<p>在它出现之前，所有关于“主动 AI”的想象，都只能在一个个孤立的 App 和生态里做局部实验。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[搭建 monorepo 项目]]></title>    <link>https://juejin.cn/post/7579093746611044352</link>    <guid>https://juejin.cn/post/7579093746611044352</guid>    <pubDate>2025-12-02T11:25:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579093746611044352" data-draft-id="7579190764765888552" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="搭建 monorepo 项目"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-02T11:25:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="div里有光"/> <meta itemprop="url" content="https://juejin.cn/user/3237375877059565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            搭建 monorepo 项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3237375877059565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    div里有光
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T11:25:28.000Z" title="Tue Dec 02 2025 11:25:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么使用monorepo？</h2>
<p>聊到为什么使用 monorepo 那就要先了解不使用 monorepo 的痛点和使用 monorepo 的优点</p>
<h3 data-id="heading-1">痛点1：公共代码重复 or 发布频繁</h3>
<p><strong>方案A：</strong> 复制粘贴，把 A 项目代码粘贴到 B 项目等等，只要有一处改动其它的地方也要进行改动</p>
<p><strong>方案B：</strong> 拆成独立 NPM 包</p>
<ul>
<li>每次修改都要 改代码-&gt;打包-&gt;发版-&gt;各项目更新依赖</li>
<li>调试困难：本地改了 utils，要发 beta 版才能在 web-app 里试</li>
</ul>
<h3 data-id="heading-2">痛点2：跨项目原子提交难以实现</h3>
<p>你想同时：</p>
<ul>
<li>在 utils 中 新增一个 formatDate 函数</li>
<li>在 web-app 和 mobile-app 中调用它</li>
</ul>
<p>在 Multi-repo 下：</p>
<ul>
<li>必须分 3 次提交 + 3 次 PR</li>
<li>如果中间某步失败，状态不一致</li>
</ul>
<h3 data-id="heading-3">痛点3：工具链碎片化</h3>
<ul>
<li>每个项目有自己的 ESLint / Prettier / TypeScript 配置</li>
<li>团队规范难以统一，新人上手成本高</li>
</ul>
<h3 data-id="heading-4">优点1：天然支持跨项目引用（无需发布）</h3>
<p>通过 pnpm workspace</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// apps/web-app/package.json</span>
{
  "<span class="hljs-selector-tag">dependencies</span>": {
    "<span class="hljs-variable">@my-org</span>/utils<span class="hljs-string">": "</span><span class="hljs-attribute">workspace</span>:*"
  }
}
</code></pre>
<p>**workspace: *** 代表直接链接到本地 packages/utils 目录</p>
<p>修改 utils 中的内容，web-app 项目中立即生效（无需发版）</p>
<p>调试时与在同一个项目中一样</p>
<h3 data-id="heading-5">优点2：原子提交：一次PR，多项目协同变更</h3>
<p>一次提交，完整闭环。<br/>
Code Review 时能看到全貌，避免“改了 utils 但没人用”的问题。</p>
<h3 data-id="heading-6">优点3：统一工程化配置</h3>
<p>根目录下可以配置统一的 tsconfig.ts、eslintrc、prettierrc</p>
<p>所有的子项目可以继承，强制统一规范</p>
<p>升级 TypeScript ，改一个地方，全部 repo 生效</p>
<h3 data-id="heading-7">优点4：高效构建与缓存（需配置 Turborepo / Nx）</h3>
<p>第一次构建：按顺序 utils -&gt; web-app -&gt; mobile-app</p>
<p>第二次修改：只修改 web-app 中的内容，只构建web-app ，无需构建 utils ，直接命中缓存的 utils</p>
<p>CI时间大幅度缩减</p>
<h3 data-id="heading-8">所以：<strong>当协作成本 &gt; 仓库管理成本时，Monorepo 就赢了。</strong></h3>
<h2 data-id="heading-9">典型的 monorepo 项目结构</h2>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-monorepo/
├── apps/
│   ├── web-app/          <span class="hljs-comment"># 前端应用</span>
│   └── mobile-app/       <span class="hljs-comment"># 移动端</span>
├── packages/
│   ├── shared-utils/     <span class="hljs-comment"># 工具函数</span>
│   ├── ui-components/    <span class="hljs-comment"># 公共组件库（React/Vue）</span>
│   └── api-types/        <span class="hljs-comment"># API 类型定义（TS interface）</span>
├── package.json          <span class="hljs-comment"># 定义 workspaces</span>
└── pnpm-workspace.yaml   <span class="hljs-comment"># pnpm 工作区声明</span>
</code></pre>
<p>根目录：pnpm-workspace.yaml</p>
<pre><code class="hljs language-markdown" lang="markdown">packages:
<span class="hljs-bullet">    -</span> apps/*
<span class="hljs-bullet">    -</span> packages/*
</code></pre>
<p>根目录：package.json</p>
<pre><code class="hljs language-css" lang="css">
{
  workspace: [<span class="hljs-string">"apps/*"</span>, <span class="hljs-string">"packages/*"</span>]
}
</code></pre>
<p>pnpm 会自动将 packages链接到 node_modules中，实现本地 “npm包”</p>
<p><strong>注意：</strong> 在开发过程中，如果软链失效，可以通过 <strong>pnpm i --force</strong> 强制从新安装，链接软链</p>
<h2 data-id="heading-10">现在就可以搭建一个 monorepo 的项目了</h2>
<h3 data-id="heading-11">第一步：创建一个目录</h3>
<p>使用下方命令进行项目初始化</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">init</span>
</code></pre>
<h3 data-id="heading-12">第二步：创建项目目录和公共方法目录</h3>
<p>在根目录创建一个 apps 的目录：这个目录下，放的是你的应用</p>
<p>在根目录创建一个 packages 的目录，这个目录下，放的是你的公共方法</p>
<p>增加 pnpm-workspace.yaml 管理项目</p>
<pre><code class="hljs language-markdown" lang="markdown">
packages:
<span class="hljs-bullet">    -</span> apps/*
<span class="hljs-bullet">    -</span> packages/*
</code></pre>
<p>所以现在的目录结构会变为</p>
<pre><code class="hljs language-go" lang="go">my-monorepo/
├── apps/
│   ├── web-app/          
│   └── mobile-app/       
├── packages/
│   ├── shared-utils/    
│   ├── ui-components/    
│   └── api-types/        
├── <span class="hljs-keyword">package</span>.json         
└── pnpm-workspace.yaml   
</code></pre>
<h3 data-id="heading-13">第三步：给子项目的package.json中引入公共依赖</h3>
<p>子项目 web-app 和 moblie-app 的package.json增加下面内容</p>
<pre><code class="hljs language-scss" lang="scss">{
  "devDependencies": {
    "<span class="hljs-keyword">@shared-utils</span><span class="hljs-string">": "</span><span class="hljs-attribute">workspace</span>:*<span class="hljs-string">",
    "</span><span class="hljs-keyword">@ui-components</span><span class="hljs-string">": "</span><span class="hljs-attribute">workspace</span>:*<span class="hljs-string">",
    "</span><span class="hljs-keyword">@api-types</span><span class="hljs-string">": "</span><span class="hljs-attribute">workspace</span>:*<span class="hljs-string">"
  }
}
</span></code></pre>
<p>这样一个最基本的 monorepo 结构的项目就搭建好了。</p>
<p>如果子项目使用的是 vite ，需要修改一下配置</p>
<p><strong>增加 alias ，</strong> <strong>在开发环境下，绕过构建产物，直接引用源码（</strong> <code>src</code> <strong>），实现“热更新 + 实时调试”公共包。</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>
<span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-comment">// https://vite.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> isDev = mode === <span class="hljs-string">'development'</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>()],
    <span class="hljs-attr">resolve</span>: {
      <span class="hljs-attr">alias</span>: isDev ? {
        <span class="hljs-string">'@ui-components'</span>: <span class="hljs-title function_">resolve</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">dirname</span>, <span class="hljs-string">'../../packages/ui-components/src'</span>), <span class="hljs-comment">// 开发环境使用软连接</span>
      } : <span class="hljs-literal">undefined</span>,
    },
  }
})
</code></pre>
<h2 data-id="heading-14">为刚搭建好的 monorepo 项目增加工程化配置</h2>
<p>现在我们的项目已经搭建好了，大致的目录结构为</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cf0bd57aabe4cf3b7dcdfdcbad0f1a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGl26YeM5pyJ5YWJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765279528&amp;x-signature=TeAkQfwwV9HeMf2EL87S7X7r5J4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">第一步：先增加 TS 配置</h3>
<p>根目录创建 tsconfig.json</p>
<p>内容根据自己项目的公共 ts 配置进行配置</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"tsBuildInfoFile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./node_modules/.tmp/tsconfig.app.tsbuildinfo"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2022"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"useDefineForClassFields"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ES2022"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM.Iterable"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"vite/client"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  
      <span class="hljs-comment">/* Bundler mode */</span>
      <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bundler"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"allowImportingTsExtensions"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"verbatimModuleSyntax"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"moduleDetection"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"force"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"noEmit"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"react-jsx"</span><span class="hljs-punctuation">,</span>
  
      <span class="hljs-comment">/* Linting */</span>
      <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"noUnusedLocals"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"noUnusedParameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"erasableSyntaxOnly"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"noFallthroughCasesInSwitch"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"noUncheckedSideEffectImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
  
</code></pre>
<p>子项目 web-app、mobile-app 的 tsconifg.json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../../tsconfig.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"vite.config.ts"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>安装 typescript</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">add</span> -D -w typescript
</code></pre>
<p>根目录 package.json</p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"check-types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc -b"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>通过命令 pnpm check-types 就可以检查整个 monorepo 项目的代码</p>
<h3 data-id="heading-16">第二步：增加 eslint 配置</h3>
<p>安装 eslint 的依赖</p>
<pre><code class="hljs language-sql" lang="sql">pnpm <span class="hljs-keyword">add</span> <span class="hljs-operator">-</span>D <span class="hljs-operator">-</span>w <span class="hljs-variable">@eslint</span><span class="hljs-operator">/</span>js 
  <span class="hljs-variable">@typescript</span><span class="hljs-operator">-</span>eslint<span class="hljs-operator">/</span>eslint<span class="hljs-operator">-</span>plugin
  <span class="hljs-variable">@typescript</span><span class="hljs-operator">-</span>eslint<span class="hljs-operator">/</span>parser
  eslint
  eslint<span class="hljs-operator">-</span>config<span class="hljs-operator">-</span>prettier
  eslint<span class="hljs-operator">-</span>plugin<span class="hljs-operator">-</span>react<span class="hljs-operator">-</span>hooks
  eslint<span class="hljs-operator">-</span>plugin<span class="hljs-operator">-</span>react<span class="hljs-operator">-</span>refresh
</code></pre>
<p>根目录创建 eslint.config.cjs</p>
<pre><code class="hljs language-php" lang="php">
<span class="hljs-comment">// eslint.config.cjs</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">eslintJs</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'@eslint/js'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">parser</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'@typescript-eslint/parser'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">plugin</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'@typescript-eslint/eslint-plugin'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">reactHooks</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'eslint-plugin-react-hooks'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">reactRefresh</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'eslint-plugin-react-refresh'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">eslintConfigPrettier</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'eslint-config-prettier'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">globals</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'globals'</span>);

<span class="hljs-comment">// 手动构造 @typescript-eslint/recommended 的等效配置</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">tsRecommended</span> = {
  files: [<span class="hljs-string">'**/*.ts'</span>, <span class="hljs-string">'**/*.tsx'</span>],
  languageOptions: {
    parser,
    parserOptions: {
      ecmaVersion: <span class="hljs-number">2022</span>,
      sourceType: <span class="hljs-string">'module'</span>
    }
  },
  plugins: {
    <span class="hljs-string">'@typescript-eslint'</span>: plugin
  },
  rules: {
    <span class="hljs-comment">// 来自 @typescript-eslint/eslint-plugin 的 recommended 规则</span>
    <span class="hljs-string">'@typescript-eslint/no-unused-vars'</span>: <span class="hljs-string">'error'</span>,
    <span class="hljs-string">'@typescript-eslint/no-explicit-any'</span>: <span class="hljs-string">'warn'</span>,
    <span class="hljs-string">'@typescript-eslint/no-var-requires'</span>: <span class="hljs-string">'error'</span>,
    <span class="hljs-string">'@typescript-eslint/no-empty-function'</span>: <span class="hljs-string">'warn'</span>,
    <span class="hljs-comment">// 可根据需要扩展更多...</span>
  }
};

<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {import('eslint').Linter.FlatConfig[]} */</span>
module.exports = [
  {
    ignores: [<span class="hljs-string">'**/node_modules/**'</span>, <span class="hljs-string">'**/dist/**'</span>, <span class="hljs-string">'**/build/**'</span>, <span class="hljs-string">'**/.next/**'</span>, <span class="hljs-string">'**/*.d.ts'</span>]
  },

  <span class="hljs-comment">// 基础 JS 规则</span>
  eslintJs.configs.recommended,

  <span class="hljs-comment">// TypeScript 规则（手动定义）</span>
  tsRecommended,

  <span class="hljs-comment">// React 规则</span>
  {
    files: [<span class="hljs-string">'**/*.{js,jsx,ts,tsx}'</span>],
    languageOptions: {
      globals: {
        ...globals.browser
      }
    },
    plugins: {
      <span class="hljs-string">'react-hooks'</span>: reactHooks,
      <span class="hljs-string">'react-refresh'</span>: reactRefresh
    },
    rules: {
      <span class="hljs-string">'react-hooks/rules-of-hooks'</span>: <span class="hljs-string">'error'</span>,
      <span class="hljs-string">'react-hooks/exhaustive-deps'</span>: <span class="hljs-string">'warn'</span>,
      <span class="hljs-string">'react-refresh/only-export-components'</span>: <span class="hljs-string">'warn'</span>
    }
  },

  <span class="hljs-comment">// Prettier 兼容（最后）</span>
  eslintConfigPrettier
];
</code></pre>
<p>我的项目用了 globals 依赖包 所以也需要安装一下</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">add</span> -D -w globals
</code></pre>
<ul>
<li><code>globals</code> 包提供了常见环境的全局变量列表，例如：</li>
</ul>

<ul>
<li>
<ul>
<li><code>globals.browser</code> → <code>window</code>, <code>document</code>, <code>fetch</code>...</li>
<li><code>globals.node</code> → <code>process</code>, <code>require</code>, <code>__dirname</code>...</li>
<li><code>globals.jest</code> → <code>describe</code>, <code>test</code>, <code>expect</code>...</li>
</ul>
</li>
</ul>
<p>ESLint 需要这些信息来判断某个变量是“未声明”还是“环境全局”。</p>
<p>根目录的 package.json 中增加 scripts</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"check-types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc -b"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint . --ext .js,.jsx,.ts,.tsx"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint . --ext .js,.jsx,.ts,.tsx --fix"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-17">第三步：增加 git commit 钩子函数</h3>
<p>如果要使用 git 钩子，那就要安装一些依赖</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">add</span> -D -w husky lint-staged
</code></pre>
<p>根目录的 package.json 中增加配置</p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-attr">"husky"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"pre-commit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lint-staged"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*.{js,jsx,ts,tsx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p>如果想要钩子运行起来还需要在根目录增加.husky文件夹，文件夹下创建 pre-commit 文件，使用下面命令进行创建</p>
<p>这个是 husky 官方提供的命令</p>
<pre><code class="hljs language-bash" lang="bash">pnpm <span class="hljs-built_in">exec</span> husky install
</code></pre>
<p>这个命令不会在 .husky 下生成 pre-commit 需要自己手动创建，内容为</p>
<p>这个是 husky v9版本以下写法</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/usr/bin/env sh</span>
. <span class="hljs-string">"<span class="hljs-subst">$(dirname -- <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>)</span>/_/husky.sh"</span>

pnpm lint-staged
</code></pre>
<p>v9 以上写法</p>
<pre><code class="hljs">pnpm lint-staged
</code></pre>
<p>然后就可以通过以下命令进行测试了</p>
<pre><code class="hljs language-csharp" lang="csharp">git <span class="hljs-keyword">init</span> 

git <span class="hljs-keyword">add</span> .
git commit -m <span class="hljs-string">"改动的msg"</span>
</code></pre>
<p>当出现这种就算成功了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84cde8d3c75a485f852f2cb789859d01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGl26YeM5pyJ5YWJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765279528&amp;x-signature=67VBHTNemLp%2B7spMxPxsfW9P7vE%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[说说 Map 和 Set 的区别及实际应用]]></title>    <link>https://juejin.cn/post/7579063781072551990</link>    <guid>https://juejin.cn/post/7579063781072551990</guid>    <pubDate>2025-12-02T12:59:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579063781072551990" data-draft-id="7579062563326394409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="说说 Map 和 Set 的区别及实际应用"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-02T12:59:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="壮壮爱吃秋刀鱼"/> <meta itemprop="url" content="https://juejin.cn/user/136758682984871"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            说说 Map 和 Set 的区别及实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/136758682984871/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    壮壮爱吃秋刀鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T12:59:33.000Z" title="Tue Dec 02 2025 12:59:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Map</code> 和 <code>Set</code> 是 JavaScript 中两种常用的数据结构，它们都是 <strong>ES6 引入的</strong>，相比于普通的对象（<code>Object</code>）和数组（<code>Array</code>），<code>Map</code> 和 <code>Set</code> 提供了更多的灵活性和功能。</p>
<h3 data-id="heading-0">1. <strong><code>Map</code> 和 <code>Set</code> 的定义</strong></h3>
<ul>
<li>
<p><strong><code>Map</code></strong>：是一种键值对（key-value）的集合，类似于对象（<code>Object</code>），但是它的键（key）可以是任何类型的值，而不仅仅是字符串或符号。</p>
<p><strong>特点：</strong></p>
<ul>
<li>键值对数据结构。</li>
<li>键（key）可以是任何类型（对象、数组、函数等）。</li>
<li>保证元素按插入顺序排序。</li>
<li>可以使用 <code>.set(key, value)</code> 设置键值对，使用 <code>.get(key)</code> 获取值。</li>
</ul>
</li>
<li>
<p><strong><code>Set</code></strong>：是一个集合（set），其中每个元素都是唯一的。可以存储任何类型的值，但不允许重复的元素。</p>
<p><strong>特点：</strong></p>
<ul>
<li>值的集合（没有重复的值）。</li>
<li>存储唯一值。</li>
<li>保证元素按插入顺序排序。</li>
<li>可以使用 <code>.add(value)</code> 添加元素，使用 <code>.has(value)</code> 检查是否包含元素。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-1">2. <strong><code>Map</code> 和 <code>Set</code> 的区别</strong></h3>













































<table><thead><tr><th>特性</th><th><code>Map</code></th><th><code>Set</code></th></tr></thead><tbody><tr><td><strong>结构</strong></td><td>键值对（key-value pairs）</td><td>唯一的值（unique values）</td></tr><tr><td><strong>键的类型</strong></td><td>键可以是任意数据类型（例如：对象、数组、函数等）</td><td>只能存储唯一的值，值可以是任何类型</td></tr><tr><td><strong>重复值</strong></td><td>可以存储相同的值，但必须有不同的键</td><td>不允许存储重复的值</td></tr><tr><td><strong>迭代顺序</strong></td><td>按照插入顺序迭代元素</td><td>按照插入顺序迭代元素</td></tr><tr><td><strong>存储方式</strong></td><td>键值对，映射键到值</td><td>存储单个唯一的值</td></tr><tr><td><strong>常用方法</strong></td><td><code>.set(key, value)</code>, <code>.get(key)</code>, <code>.has(key)</code>, <code>.delete(key)</code>, <code>.clear()</code></td><td><code>.add(value)</code>, <code>.has(value)</code>, <code>.delete(value)</code>, <code>.clear()</code></td></tr><tr><td><strong>键的唯一性</strong></td><td>键必须唯一</td><td>值必须唯一</td></tr></tbody></table>
<h3 data-id="heading-2">3. <strong>实际应用场景</strong></h3>
<h4 data-id="heading-3"><strong><code>Map</code> 的应用场景：</strong></h4>
<ul>
<li>
<p><strong>存储键值对</strong>：如果需要将数据存储为一对一的关系，可以使用 <code>Map</code>。</p>
<ul>
<li>示例：存储用户的 ID 和信息，或存储产品的 ID 和价格等。</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">const</span> <span class="hljs-built_in">map</span> = new Map();
<span class="hljs-built_in">map</span>.<span class="hljs-built_in">set</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'apple'</span>);
<span class="hljs-built_in">map</span>.<span class="hljs-built_in">set</span>(<span class="hljs-string">'name'</span>, <span class="hljs-string">'John'</span>);
console.<span class="hljs-built_in">log</span>(<span class="hljs-built_in">map</span>.get(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 'apple'</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-built_in">map</span>.get(<span class="hljs-string">'name'</span>)); <span class="hljs-comment">// 'John'</span>
</code></pre>
</li>
<li>
<p><strong>需要任意类型作为键</strong>：当需要将对象、数组、函数等作为键时，<code>Map</code> 比对象更有优势。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> objKey = { id: <span class="hljs-number">1</span> };
<span class="hljs-type">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
map.<span class="hljs-built_in">set</span>(objKey, <span class="hljs-string">'User Info'</span>);
console.<span class="hljs-built_in">log</span>(map.<span class="hljs-built_in">get</span>(objKey)); <span class="hljs-comment">// 'User Info'</span>
</code></pre>
</li>
<li>
<p><strong>维护插入顺序</strong>：<code>Map</code> 保证键值对按插入顺序排序，适合需要按照插入顺序遍历的场景。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">const</span> <span class="hljs-built_in">map</span> = new Map();
<span class="hljs-built_in">map</span>.<span class="hljs-built_in">set</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'two'</span>);
<span class="hljs-built_in">map</span>.<span class="hljs-built_in">set</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'one'</span>);
<span class="hljs-built_in">map</span>.<span class="hljs-built_in">set</span>(<span class="hljs-number">3</span>, <span class="hljs-string">'three'</span>);

<span class="hljs-keyword">for</span> (let [key, value] of <span class="hljs-built_in">map</span>) {
  console.<span class="hljs-built_in">log</span>(key, value);
}
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 2 'two'</span>
<span class="hljs-comment">// 1 'one'</span>
<span class="hljs-comment">// 3 'three'</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-4"><strong><code>Set</code> 的应用场景：</strong></h4>
<ul>
<li>
<p><strong>存储唯一值</strong>：如果需要存储没有重复的值，可以使用 <code>Set</code>。</p>
<ul>
<li>示例：去重数组中的元素。</li>
</ul>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">const</span> <span class="hljs-keyword">set</span> = <span class="hljs-keyword">new</span> <span class="hljs-keyword">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>]);
console.<span class="hljs-built_in">log</span>(<span class="hljs-keyword">set</span>); // <span class="hljs-keyword">Set</span> { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span> }
</code></pre>
</li>
<li>
<p><strong>检查元素是否存在</strong>：<code>Set</code> 提供了 <code>.has(value)</code> 方法，可以高效地检查某个元素是否已经存在。</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">const</span> <span class="hljs-keyword">set</span> = <span class="hljs-keyword">new</span> <span class="hljs-keyword">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);
console.<span class="hljs-built_in">log</span>(<span class="hljs-keyword">set</span>.has(<span class="hljs-number">2</span>)); // <span class="hljs-literal">true</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-keyword">set</span>.has(<span class="hljs-number">4</span>)); // <span class="hljs-literal">false</span>
</code></pre>
</li>
<li>
<p><strong>集合运算</strong>：<code>Set</code> 可以非常方便地做集合运算，例如交集、并集、差集等。通过 <code>Set</code> 和 <code>Map</code> 可以轻松实现一些数学集合操作。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 并集</span>
<span class="hljs-keyword">const</span> setA = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);
<span class="hljs-keyword">const</span> setB = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]);
<span class="hljs-keyword">const</span> union = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([...setA, ...setB]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(union); <span class="hljs-comment">// Set { 1, 2, 3, 4, 5 }</span>
</code></pre>
</li>
<li>
<p><strong>快速查找</strong>：由于 <code>Set</code> 内部是基于哈希表实现的，因此它的查找效率高于普通的数组，尤其是在需要频繁查找某个值时。</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">const</span> <span class="hljs-keyword">set</span> = <span class="hljs-keyword">new</span> <span class="hljs-keyword">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]);
console.<span class="hljs-built_in">log</span>(<span class="hljs-keyword">set</span>.has(<span class="hljs-number">3</span>)); // <span class="hljs-literal">true</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-5">4. <strong>性能对比</strong></h3>
<ul>
<li>
<p><strong><code>Map</code></strong> 和 <strong><code>Set</code></strong> 都是基于哈希表实现的，插入、删除、查找的时间复杂度均为 <strong>O(1)</strong> ，因此在大多数情况下，它们的性能优于基于数组的操作（如 <code>.indexOf()</code>）。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
console.<span class="hljs-built_in">log</span>(arr.<span class="hljs-built_in">indexOf</span>(<span class="hljs-number">3</span>)); <span class="hljs-comment">// O(n)</span>

<span class="hljs-type">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]);
console.<span class="hljs-built_in">log</span>(set.<span class="hljs-built_in">has</span>(<span class="hljs-number">3</span>)); <span class="hljs-comment">// O(1)</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-6">总结：</h3>






























<table><thead><tr><th>特性</th><th><code>Map</code></th><th><code>Set</code></th></tr></thead><tbody><tr><td><strong>存储类型</strong></td><td>键值对（key-value）</td><td>唯一的值（unique values）</td></tr><tr><td><strong>键的类型</strong></td><td>键可以是任何数据类型（对象、函数、数组等）</td><td>存储的值可以是任何类型</td></tr><tr><td><strong>重复性</strong></td><td>键必须唯一，值可以重复</td><td>不允许值重复</td></tr><tr><td><strong>常见用途</strong></td><td>需要维护键值对数据（例如 ID 和信息的映射）</td><td>需要保证唯一性的集合（如去重、快速查找）</td></tr></tbody></table>
<ul>
<li><strong><code>Map</code></strong> 更适合用于需要键值对的场景（例如存储用户信息、配置项、缓存数据等），并且需要键为任意类型时。</li>
<li><strong><code>Set</code></strong> 更适合用于存储唯一的值，尤其是去重、集合运算和高效查找的场景。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[tiptiap3如何实现编辑器内部嵌套多个富文本编辑器]]></title>    <link>https://juejin.cn/post/7578922565210832923</link>    <guid>https://juejin.cn/post/7578922565210832923</guid>    <pubDate>2025-12-02T13:23:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565210832923" data-draft-id="7579096485355683890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" tiptiap3如何实现编辑器内部嵌套多个富文本编辑器"/> <meta itemprop="keywords" content="前端,Vue.js,开源"/> <meta itemprop="datePublished" content="2025-12-02T13:23:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯不皮"/> <meta itemprop="url" content="https://juejin.cn/user/576609953014424"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             tiptiap3如何实现编辑器内部嵌套多个富文本编辑器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/576609953014424/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯不皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T13:23:39.000Z" title="Tue Dec 02 2025 13:23:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>根据文档<a href="https://link.juejin.cn?target=https%3A%2F%2Ftiptap.dev%2Fdocs%2Feditor%2Fextensions%2Fcustom-extensions%2Fnode-views%2Fjavascript%23adding-a-content-editable" target="_blank" title="https://tiptap.dev/docs/editor/extensions/custom-extensions/node-views/javascript#adding-a-content-editable" ref="nofollow noopener noreferrer">Adding a content editable</a>，如果希望在编辑器中再嵌套一个富文本编辑就会使用到这个配置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">addNodeView</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// Create a container for the node view</span>
  <span class="hljs-keyword">const</span> dom = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)

  <span class="hljs-comment">// Give other elements containing text `contentEditable = false`</span>
  <span class="hljs-keyword">const</span> label = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>)
  label.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'Node view'</span>
  label.<span class="hljs-property">contentEditable</span> = <span class="hljs-literal">false</span>

  <span class="hljs-comment">// Create a container for the content</span>
  <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)

  <span class="hljs-comment">// Append all elements to the node view container</span>
  dom.<span class="hljs-title function_">append</span>(label, content)

  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// Pass the node view container …</span>
    dom,
    <span class="hljs-comment">// … and the content container:</span>
    <span class="hljs-attr">contentDOM</span>: content,
  }
}
</code></pre>
<p>如果使用了框架就会是一个<code>NodeViewWrapper</code>包裹一个<code>NodeViewContent</code>，是一对一的关系，在官方的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fueberdosis%2Ftiptap%2Fdiscussions%2F2106" target="_blank" title="https://github.com/ueberdosis/tiptap/discussions/2106" ref="nofollow noopener noreferrer">Multiple NodeViewContent · ueberdosis/tiptap · Discussion #2106</a>也提到了这个事情</p>
<p>显而易见的是一个<code>NodeViewWrapper</code>对应一个<code>扩展</code>，那么当我们需要给一个<code>扩展</code>中添加多个富文本编辑时，唯一的方案就是<code>扩展</code>中嵌套<code>扩展</code>。就比如说官方的<code>@tiptap/extension-table</code>表格扩展。</p>
<p>在我细细评味了官方的表格扩展后，成功实现了我们自己的两栏布局:<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/713132721b474eb5864b6659801d407b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av5LiN55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765286618&amp;x-signature=T%2B%2FFJnBmqRwSt9dXsbsJjAZ4eWc%3D" alt="" loading="lazy"/></p>
<p>并且具备一个正常的富文本编辑器的全部功能！</p>
<p>左边的我们称为<strong>组件A</strong>，右边的我们称为<strong>组件B（其实完全可以不用拆分的，因为内部代码完全一样）</strong></p>
<p>现在我们实现其中一个组件，根据文档所示：</p>
<p>如果是在vue中需要如下代码，<strong>组件A</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { mergeAttributes, <span class="hljs-title class_">Node</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tiptap/core'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VueNodeViewRenderer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tiptap/vue-3'</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">TwoEditorLayoutTemplateA</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./TwoEditorLayoutTemplateA.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Node</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">"twoEditorLayoutTemplateA"</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">"inline*"</span>,
      <span class="hljs-attr">atom</span>: <span class="hljs-literal">false</span>,

      <span class="hljs-title function_">parseHTML</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> [
          {
            <span class="hljs-attr">tag</span>: <span class="hljs-string">"twoEditorLayoutTemplateA"</span>,
          },
        ];
      },
      <span class="hljs-title function_">renderHTML</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> [<span class="hljs-string">"twoEditorLayoutTemplateA"</span>, {}, <span class="hljs-number">0</span>];
      },
      <span class="hljs-title function_">addNodeView</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">VueNodeViewRenderer</span>(<span class="hljs-title class_">TwoEditorLayoutTemplateA</span>);
      },
    }),
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">node-view-wrapper</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"editor-a"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"editor-a"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">node-view-content</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content is-editable"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">node-view-wrapper</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeViewWrapper</span>, nodeViewProps, <span class="hljs-title class_">NodeViewContent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tiptap/vue-3"</span>;

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>(nodeViewProps);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.editor-a</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">240px</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.editor-a</span> <span class="hljs-selector-class">.content</span> {
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100%</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre>
<p><strong>组件B</strong>为</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { mergeAttributes, <span class="hljs-title class_">Node</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tiptap/core'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VueNodeViewRenderer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tiptap/vue-3'</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">TwoEditorLayoutTemplateB</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./TwoEditorLayoutTemplateB.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Node</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">"twoEditorLayoutTemplateB"</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">"inline*"</span>,
      <span class="hljs-attr">atom</span>: <span class="hljs-literal">false</span>,

      <span class="hljs-title function_">parseHTML</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> [
          {
            <span class="hljs-attr">tag</span>: <span class="hljs-string">"twoEditorLayoutTemplateB"</span>,
          },
        ];
      },
      <span class="hljs-title function_">renderHTML</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> [<span class="hljs-string">"twoEditorLayoutTemplateB"</span>, {}, <span class="hljs-number">0</span>];
      },
      <span class="hljs-title function_">addNodeView</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">VueNodeViewRenderer</span>(<span class="hljs-title class_">TwoEditorLayoutTemplateB</span>);
      },
    }),
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">node-view-wrapper</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"editor-b"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"editor-b"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">node-view-content</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content is-editable"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">node-view-wrapper</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeViewWrapper</span>, nodeViewProps, <span class="hljs-title class_">NodeViewContent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tiptap/vue-3"</span>;

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>(nodeViewProps);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.editor-b</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">240px</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.editor-b</span> <span class="hljs-selector-class">.content</span> {
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100%</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre>
<p>显而易见的是，这个组件B基本和组件A就是一样的代码，也就样式不太一样</p>
<p>然后就需要把这个两个扩展注册到全局中去</p>
<pre><code class="hljs language-typescript" lang="typescript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">editor-content</span> <span class="hljs-attr">:editor</span>=<span class="hljs-string">"editor"</span> /&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">StarterKit</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@tiptap/starter-kit'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Editor</span>, <span class="hljs-title class_">EditorContent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tiptap/vue-3'</span>

<span class="hljs-keyword">import</span> twoEditorLayoutTemplateA <span class="hljs-keyword">from</span> <span class="hljs-string">'./twoEditorLayoutTemplateA.js'</span>
<span class="hljs-keyword">import</span> twoEditorLayoutTemplateB <span class="hljs-keyword">from</span> <span class="hljs-string">'./twoEditorLayoutTemplateB.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">EditorContent</span>,
  },

  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">editor</span>: <span class="hljs-literal">null</span>,
    }
  },

  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Editor</span>({
      <span class="hljs-attr">extensions</span>: [<span class="hljs-title class_">StarterKit</span>, <span class="hljs-title class_">VueComponent</span>],
      <span class="hljs-attr">content</span>: <span class="hljs-string">``</span>,
    })
  },

  <span class="hljs-title function_">beforeUnmount</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-title function_">destroy</span>()
  },
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="css">
<span class="hljs-comment">/* Basic editor styles */</span>
<span class="hljs-selector-class">.tiptap</span> {
  <span class="hljs-selector-pseudo">:first</span>-child {
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">/* List styles */</span>
  <span class="hljs-selector-tag">ul</span>,
  <span class="hljs-selector-tag">ol</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">1rem</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">1.25rem</span> <span class="hljs-number">1rem</span> <span class="hljs-number">1.25rem</span> <span class="hljs-number">0.4rem</span>;

    <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">p</span> {
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0.25em</span>;
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0.25em</span>;
    }
  }

  <span class="hljs-comment">/* Heading styles */</span>
  <span class="hljs-selector-tag">h1</span>,
  <span class="hljs-selector-tag">h2</span>,
  <span class="hljs-selector-tag">h3</span>,
  <span class="hljs-selector-tag">h4</span>,
  <span class="hljs-selector-tag">h5</span>,
  <span class="hljs-selector-tag">h6</span> {
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.1</span>;
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">2.5rem</span>;
    text-wrap: pretty;
  }

  <span class="hljs-selector-tag">h1</span>,
  <span class="hljs-selector-tag">h2</span> {
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">3.5rem</span>;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">1.5rem</span>;
  }

  <span class="hljs-selector-tag">h1</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.4rem</span>;
  }

  <span class="hljs-selector-tag">h2</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.2rem</span>;
  }

  <span class="hljs-selector-tag">h3</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.1rem</span>;
  }

  <span class="hljs-selector-tag">h4</span>,
  <span class="hljs-selector-tag">h5</span>,
  <span class="hljs-selector-tag">h6</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1rem</span>;
  }

  <span class="hljs-comment">/* Code and preformatted text styles */</span>
  <span class="hljs-selector-tag">code</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--purple-light);
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0.4rem</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--black);
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.85rem</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.25em</span> <span class="hljs-number">0.3em</span>;
  }

  pre {
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--black);
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0.5rem</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--white);
    <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'JetBrainsMono'</span>, monospace;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">1.5rem</span> <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.75rem</span> <span class="hljs-number">1rem</span>;

    <span class="hljs-selector-tag">code</span> {
      <span class="hljs-attribute">background</span>: none;
      <span class="hljs-attribute">color</span>: inherit;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.8rem</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    }
  }

  <span class="hljs-selector-tag">blockquote</span> {
    <span class="hljs-attribute">border-left</span>: <span class="hljs-number">3px</span> solid <span class="hljs-built_in">var</span>(--gray-<span class="hljs-number">3</span>);
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">1.5rem</span> <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">1rem</span>;
  }

  hr {
    <span class="hljs-attribute">border</span>: none;
    <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--gray-<span class="hljs-number">2</span>);
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">2rem</span> <span class="hljs-number">0</span>;
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<p>但是现在还是不够的，因为他们还是独立的，没有一个大的扩展进行统筹，我们现在再写一个大的扩展来完成这个功能</p>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-comment">// 两栏布局扩展父节点(vue组件版本)</span>
    <span class="hljs-title class_">Node</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">"twoEditorLayoutTemplate"</span>,
      <span class="hljs-attr">group</span>: <span class="hljs-string">"block"</span>,
      <span class="hljs-attr">atom</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-comment">// content为上面两个扩展的name</span>
      <span class="hljs-attr">content</span>: <span class="hljs-string">"twoEditorLayoutTemplateA twoEditorLayoutTemplateB"</span>,

      <span class="hljs-title function_">parseHTML</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> [
          {
            <span class="hljs-attr">tag</span>: <span class="hljs-string">"div[data-two-editor-layout-template]"</span>,
          },
        ];
      },

      <span class="hljs-title function_">renderHTML</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> [<span class="hljs-string">"div"</span>, { <span class="hljs-string">"data-two-editor-layout-template"</span>: <span class="hljs-string">""</span>, <span class="hljs-attr">class</span>: <span class="hljs-string">"two-editor-layout"</span> }, <span class="hljs-number">0</span>];
      },
      <span class="hljs-title function_">addCommands</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">insertTwoEditorLayoutTemplate</span>:
            <span class="hljs-function">() =&gt;</span>
            <span class="hljs-function">(<span class="hljs-params">{ commands }: CommandProps</span>) =&gt;</span> {
              commands.<span class="hljs-title function_">insertContent</span>({
                <span class="hljs-attr">type</span>: <span class="hljs-string">"twoEditorLayoutTemplate"</span>,
                <span class="hljs-attr">content</span>: [
                  {
                    <span class="hljs-attr">type</span>: <span class="hljs-string">"twoEditorLayoutTemplateA"</span>,
                  },
                  {
                    <span class="hljs-attr">type</span>: <span class="hljs-string">"twoEditorLayoutTemplateB"</span>,
                  },
                ],
              });
              <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            },
        } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">RawCommands</span>&gt;;
      },
    }),
</code></pre>
<p>然后，我们最后在<code>addCommands</code>中注册的<code>insertTwoEditorLayoutTemplate</code>函数作为在编辑器中插入的最终函数，当调用这个函数时就可以把这最终的大的扩展给写到编辑器中去了</p>
<p>这就是最终的解决方案了，笔者也是翻阅了tiptap3的各种源码和实现，以及掘金上大量的文章以及官方的issues和discussions后才灵光一闪，完成了最后的实现～</p>
<p>推荐好文：</p>
<p><a href="https://juejin.cn/post/7528753539737600026" target="_blank" title="https://juejin.cn/post/7528753539737600026">Tiptap 3.0 正式发布！你必须知道的 20 个重大变化 🚀🚀🚀</a></p>
<p><a href="https://juejin.cn/post/7573592952243535924" target="_blank" title="https://juejin.cn/post/7573592952243535924">Tiptap 深度教程（四）：终极定制 - 从零创建你的专属扩展</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fueberdosis%2Ftiptap%2Fdiscussions%2F7286" target="_blank" title="https://github.com/ueberdosis/tiptap/discussions/7286" ref="nofollow noopener noreferrer">Multiple NodeViewContent in a Single NodeViewWrapper · ueberdosis/tiptap · Discussion #7286</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 实现深拷贝]]></title>    <link>https://juejin.cn/post/7579101504289357878</link>    <guid>https://juejin.cn/post/7579101504289357878</guid>    <pubDate>2025-12-02T13:37:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579101504289357878" data-draft-id="7579066828178931748" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 实现深拷贝"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-02T13:37:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jingyou"/> <meta itemprop="url" content="https://juejin.cn/user/3167069035309015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 实现深拷贝
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3167069035309015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jingyou
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T13:37:40.000Z" title="Tue Dec 02 2025 13:37:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>JavaScript 的 <code>deepClone</code>（深拷贝）需要处理 <strong>基本类型、引用类型（对象、数组）、特殊对象（日期、正则、函数）</strong>  等场景，还要避免 <strong>循环引用</strong> 导致的死循环</p>
</blockquote>
<ol>
<li><strong>支持基本类型</strong>：数字、字符串、布尔值、<code>null</code>、<code>undefined</code>、<code>Symbol</code>、<code>BigInt</code>（直接返回原值，无拷贝成本）。</li>
<li><strong>支持引用类型</strong>：
<ul>
<li>普通对象（<code>{}</code>）、数组（<code>[]</code>）</li>
<li>特殊对象：<code>Date</code>（拷贝时间戳）、<code>RegExp</code>（拷贝源正则和修饰符）</li>
</ul>
</li>
<li><strong>解决循环引用</strong>：用 <code>WeakMap</code> 缓存已拷贝的对象，避免循环引用导致的栈溢出（例如 <code>a.b = a</code> 场景）。</li>
<li><strong>保留属性特性</strong>：通过 <code>Reflect.ownKeys</code> 遍历所有可枚举 / 不可枚举属性，包括 <code>Symbol</code> 类型的键（比 <code>for...in</code> 更全面）。</li>
</ol>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">target, hash = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WeakMap</span>()</span>) {
  <span class="hljs-comment">// 1. 处理基本类型和 null/undefined（直接返回，无需拷贝）</span>
  <span class="hljs-keyword">if</span> (target === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> target !== <span class="hljs-string">"object"</span>) <span class="hljs-keyword">return</span> target
  <span class="hljs-comment">// 2. 处理循环引用（已拷贝过的对象直接返回缓存）</span>
  <span class="hljs-keyword">if</span> (hash.<span class="hljs-title function_">has</span>(target)) <span class="hljs-keyword">return</span> hash.<span class="hljs-title function_">get</span>(target)

  <span class="hljs-keyword">let</span> cloneObj

  <span class="hljs-comment">// 3. 处理日期对象</span>
  <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>) {
    cloneObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(target)
    hash.<span class="hljs-title function_">set</span>(target, cloneObj)
    <span class="hljs-keyword">return</span> cloneObj
  }

  <span class="hljs-comment">// 4. 处理正则对象</span>
  <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span>) {
    cloneObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(target.<span class="hljs-property">source</span>, target.<span class="hljs-property">flags</span>)
    hash.<span class="hljs-title function_">set</span>(target, cloneObj)
    <span class="hljs-keyword">return</span> cloneObj
  }

  <span class="hljs-comment">// 5. 处理 Map</span>
  <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Map</span>) {
    cloneObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    hash.<span class="hljs-title function_">set</span>(target, cloneObj)
    target.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value, key</span>) =&gt;</span> {
      cloneObj.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">deepClone</span>(key, hash), <span class="hljs-title function_">deepClone</span>(value, hash))
    })
    <span class="hljs-keyword">return</span> cloneObj
  }

  <span class="hljs-comment">// 6. 处理 Set</span>
  <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Set</span>) {
    cloneObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
    hash.<span class="hljs-title function_">set</span>(target, cloneObj)
    target.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
      cloneObj.<span class="hljs-title function_">add</span>(<span class="hljs-title function_">deepClone</span>(value, hash))
    })
    <span class="hljs-keyword">return</span> cloneObj
  }

  <span class="hljs-comment">// 7. 处理数组和普通对象（区分数组和对象的构造器）</span>
  cloneObj = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(target) ? [] : {}
  hash.<span class="hljs-title function_">set</span>(target, cloneObj)

  <span class="hljs-comment">// 8. 遍历对象/数组的可枚举属性（包括 Symbol 类型）</span>
  <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(target).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
    <span class="hljs-comment">// 递归拷贝属性值，同时传递 hash 缓存</span>
    cloneObj[key] = <span class="hljs-title function_">deepClone</span>(target[key], hash)
  })

  <span class="hljs-keyword">return</span> cloneObj
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解锁Vue组件通信新姿势：provide/inject深度解析]]></title>    <link>https://juejin.cn/post/7578922565210882075</link>    <guid>https://juejin.cn/post/7578922565210882075</guid>    <pubDate>2025-12-02T13:32:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565210882075" data-draft-id="7578922565210865691" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解锁Vue组件通信新姿势：provide/inject深度解析"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-02T13:32:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解锁Vue组件通信新姿势：provide/inject深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T13:32:16.000Z" title="Tue Dec 02 2025 13:32:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：为什么需要跨层级组件通信？</h2>
<p>在日常Vue开发中，我们经常遇到这样的场景：多层嵌套的组件需要共享某些数据或方法。比如：</p>
<ul>
<li>主题配置需要从根组件传递到深层的子组件</li>
<li>用户登录信息需要在多个层级中共享</li>
<li>多语言配置需要在整个应用中使用</li>
</ul>
<p>传统的解决方案：props层层传递，复杂又繁琐！今天给大家介绍一个更优雅的解决方案：<strong>provide/inject</strong>。</p>
<h2 data-id="heading-1">一、什么是provide/inject？</h2>
<h3 data-id="heading-2">基本概念</h3>
<p><strong>provide</strong>（提供）和<strong>inject</strong>（注入）是Vue提供的一对API，允许祖先组件向所有子孙组件注入依赖，无论组件层次有多深。</p>
<pre><code class="hljs language-scss" lang="scss">祖先组件 (provide数据)
      ↓
   子孙组件 (inject数据)
</code></pre>
<h3 data-id="heading-3">与props对比</h3>






























<table><thead><tr><th>特性</th><th>props传递</th><th>provide/inject</th></tr></thead><tbody><tr><td>数据流向</td><td>父→子（单向）</td><td>祖先→子孙（跨级）</td></tr><tr><td>使用复杂度</td><td>每层都需要声明</td><td>一次提供，随处注入</td></tr><tr><td>组件耦合度</td><td>父子紧耦合</td><td>祖先与子孙解耦</td></tr><tr><td>适用场景</td><td>直接父子通信</td><td>深层嵌套组件通信</td></tr></tbody></table>
<h2 data-id="heading-4">二、基本使用方式</h2>
<h3 data-id="heading-5">2.1 基础语法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 祖先组件 - 提供数据</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">provide</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 提供静态数据</span>
      <span class="hljs-attr">siteName</span>: <span class="hljs-string">'Vue技术博客'</span>,
      <span class="hljs-comment">// 提供响应式数据需要特殊处理</span>
      <span class="hljs-attr">theme</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTheme</span>,
      <span class="hljs-comment">// 提供方法</span>
      <span class="hljs-attr">changeTheme</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateTheme</span>
    }
  },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">currentTheme</span>: <span class="hljs-string">'light'</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">updateTheme</span>(<span class="hljs-params">newTheme</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTheme</span> = newTheme
    }
  }
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 子孙组件 - 注入数据</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 数组形式</span>
  <span class="hljs-attr">inject</span>: [<span class="hljs-string">'siteName'</span>, <span class="hljs-string">'theme'</span>, <span class="hljs-string">'changeTheme'</span>],
  
  <span class="hljs-comment">// 对象形式（推荐）</span>
  <span class="hljs-attr">inject</span>: {
    <span class="hljs-comment">// 基本注入</span>
    <span class="hljs-attr">blogName</span>: <span class="hljs-string">'siteName'</span>,
    
    <span class="hljs-comment">// 带默认值</span>
    <span class="hljs-attr">theme</span>: {
      <span class="hljs-attr">from</span>: <span class="hljs-string">'theme'</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'light'</span>
    },
    
    <span class="hljs-comment">// 重命名</span>
    <span class="hljs-attr">switchTheme</span>: {
      <span class="hljs-attr">from</span>: <span class="hljs-string">'changeTheme'</span>
    }
  },
  
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleThemeChange</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">switchTheme</span>(<span class="hljs-string">'dark'</span>)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前主题：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.theme}</span>`</span>)
    }
  }
}
</code></pre>
<h3 data-id="heading-6">2.2 实际开发案例</h3>
<p>让我们通过一个实际案例来理解provide/inject的强大之处：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 根组件：App.vue --&gt;
&lt;template&gt;
  &lt;div :class="`app ${theme}`"&gt;
    &lt;Header /&gt;
    &lt;div class="content"&gt;
      &lt;Sidebar /&gt;
      &lt;MainContent /&gt;
    &lt;/div&gt;
    &lt;SettingsPanel /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'App',
  provide() {
    return {
      // 提供主题配置
      appTheme: this.theme,
      switchTheme: this.handleThemeChange,
      
      // 提供用户信息
      currentUser: this.user,
      
      // 提供国际化函数
      t: this.translate,
      
      // 提供全局配置
      appConfig: {
        apiBaseUrl: process.env.VUE_APP_API_URL,
        version: '2.0.0'
      }
    }
  },
  
  data() {
    return {
      theme: 'light',
      user: {
        id: 1,
        name: '张三',
        role: 'admin'
      },
      locale: 'zh-CN'
    }
  },
  
  methods: {
    handleThemeChange(newTheme) {
      this.theme = newTheme
      localStorage.setItem('app-theme', newTheme)
    },
    
    translate(key) {
      // 简化版翻译函数
      const dictionaries = {
        'zh-CN': { welcome: '欢迎', logout: '退出登录' },
        'en-US': { welcome: 'Welcome', logout: 'Logout' }
      }
      return dictionaries[this.locale][key] || key
    }
  }
}
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 深层嵌套组件：UserAvatar.vue --&gt;
&lt;template&gt;
  &lt;div class="user-avatar"&gt;
    &lt;img :src="avatarUrl" :alt="userName" /&gt;
    &lt;span&gt;{{ userName }}&lt;/span&gt;
    &lt;button @click="logout"&gt;{{ t('logout') }}&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'UserAvatar',
  
  // 注入需要的数据和方法
  inject: {
    currentUser: {
      from: 'currentUser',
      default: () =&gt; ({ name: 'Guest' })
    },
    t: {
      from: 't',
      default: () =&gt; (key) =&gt; key
    }
  },
  
  computed: {
    userName() {
      return this.currentUser.name
    },
    
    avatarUrl() {
      return `https://avatar.com/${this.currentUser.id}`
    }
  },
  
  methods: {
    logout() {
      // 调用注入的方法
      // 这里可以添加自己的逻辑
      console.log('用户退出登录')
    }
  }
}
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-7">三、高级使用技巧</h2>
<h3 data-id="heading-8">3.1 提供响应式数据</h3>
<p>默认情况下，provide提供的不是响应式数据。如果需要响应式，需要特殊处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法一：提供计算属性</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">user</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
        <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
      }
    }
  },
  
  <span class="hljs-title function_">provide</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 使用计算属性保持响应式</span>
      <span class="hljs-attr">reactiveUser</span>: <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>),
      
      <span class="hljs-comment">// 或者使用响应式API（Vue 2.6+）</span>
      <span class="hljs-attr">reactiveData</span>: <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">observable</span>({
        <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">reactiveData</span>.<span class="hljs-property">count</span>++
        }
      })
    }
  }
}
</code></pre>
<h3 data-id="heading-9">3.2 使用Symbol作为键名</h3>
<p>在大型项目中，为了避免命名冲突，可以使用Symbol作为provide的键名：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// constants.js - 定义Symbol常量</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeSymbol</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'theme'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserSymbol</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'user'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ConfigSymbol</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'config'</span>)

<span class="hljs-comment">// 祖先组件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeSymbol</span>, <span class="hljs-title class_">UserSymbol</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./constants'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">provide</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      [<span class="hljs-title class_">ThemeSymbol</span>]: <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span>,
      [<span class="hljs-title class_">UserSymbol</span>]: <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>
    }
  }
}

<span class="hljs-comment">// 子孙组件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeSymbol</span>, <span class="hljs-title class_">UserSymbol</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./constants'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">inject</span>: {
    <span class="hljs-attr">theme</span>: { <span class="hljs-attr">from</span>: <span class="hljs-title class_">ThemeSymbol</span> },
    <span class="hljs-attr">user</span>: { <span class="hljs-attr">from</span>: <span class="hljs-title class_">UserSymbol</span> }
  }
}
</code></pre>
<h3 data-id="heading-10">3.3 组合式API中的使用</h3>
<p>Vue 3的组合式API中，provide/inject的使用更加简洁：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 祖先组件</span>
<span class="hljs-keyword">import</span> { provide, ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建响应式数据</span>
    <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'light'</span>)
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">reactive</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>,
      <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>
    })
    
    <span class="hljs-comment">// 提供数据</span>
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'theme'</span>, theme)
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'user'</span>, user)
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'updateTheme'</span>, <span class="hljs-function">(<span class="hljs-params">newTheme</span>) =&gt;</span> {
      theme.<span class="hljs-property">value</span> = newTheme
    })
    
    <span class="hljs-keyword">return</span> {
      theme,
      user
    }
  }
}

<span class="hljs-comment">// 子孙组件</span>
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 注入数据</span>
    <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'theme'</span>, <span class="hljs-string">'light'</span>) <span class="hljs-comment">// 第二个参数是默认值</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'user'</span>)
    <span class="hljs-keyword">const</span> updateTheme = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'updateTheme'</span>)
    
    <span class="hljs-comment">// 如果确定数据存在，可以使用非空断言</span>
    <span class="hljs-keyword">const</span> requiredData = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'someRequiredData'</span>)!
    
    <span class="hljs-keyword">return</span> {
      theme,
      user,
      <span class="hljs-attr">changeTheme</span>: updateTheme
    }
  }
}
</code></pre>
<h2 data-id="heading-11">四、最佳实践和注意事项</h2>
<h3 data-id="heading-12">4.1 什么时候使用provide/inject？</h3>
<p>✅ <strong>适合使用的情况：</strong></p>
<ul>
<li>开发组件库（如表单、配置类组件）</li>
<li>全局状态管理（小项目替代Vuex）</li>
<li>主题/样式配置传递</li>
<li>多语言支持</li>
<li>用户权限传递</li>
</ul>
<p>❌ <strong>不建议使用的情况：</strong></p>
<ul>
<li>简单的父子组件通信（用props）</li>
<li>应用核心状态管理（大型应用用Vuex/Pinia）</li>
<li>组件间强耦合的场景</li>
</ul>
<h3 data-id="heading-13">4.2 常见问题解决方案</h3>
<p><strong>问题1：数据不是响应式的</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误做法</span>
<span class="hljs-title function_">provide</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">user</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> <span class="hljs-comment">// 失去响应式</span>
  }
}

<span class="hljs-comment">// 正确做法</span>
<span class="hljs-title function_">provide</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// Vue 2使用计算属性</span>
    <span class="hljs-attr">user</span>: <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>),
    
    <span class="hljs-comment">// 或者提供修改方法</span>
    <span class="hljs-attr">getUser</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>,
    <span class="hljs-attr">updateUser</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateUserMethod</span>
  }
}
</code></pre>
<p><strong>问题2：命名冲突</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用命名空间</span>
<span class="hljs-title function_">provide</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-string">'app:theme'</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span>,
    <span class="hljs-string">'app:user'</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>,
    <span class="hljs-string">'app:config'</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>
  }
}

<span class="hljs-attr">inject</span>: {
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'app:theme'</span>,
  <span class="hljs-attr">user</span>: <span class="hljs-string">'app:user'</span>
}
</code></pre>
<h3 data-id="heading-14">4.3 性能优化建议</h3>
<ol>
<li><strong>按需提供</strong>：只提供必要的数据，避免提供大量不必要的数据</li>
<li><strong>使用只读数据</strong>：对于不需要修改的数据，提供只读版本</li>
<li><strong>避免深层嵌套</strong>：合理设计组件结构，避免过度嵌套</li>
<li><strong>使用工厂函数</strong>：对于需要计算的数据，使用工厂函数延迟计算</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">provide</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 工厂函数，按需计算</span>
    <span class="hljs-attr">getUserPermissions</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculatePermissions</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">role</span>),
    
    <span class="hljs-comment">// 只读数据</span>
    <span class="hljs-attr">readOnlyConfig</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>({ ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> })
  }
}
</code></pre>
<h2 data-id="heading-15">五、实战：构建一个主题切换系统</h2>
<p>让我们用一个完整的例子来展示provide/inject的强大功能：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- ThemeProvider.vue --&gt;
&lt;template&gt;
  &lt;div :class="`theme-provider ${currentTheme}`"&gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import { ThemeSymbol, UpdateThemeSymbol } from './symbols'

export default {
  name: 'ThemeProvider',
  
  provide() {
    return {
      [ThemeSymbol]: Vue.computed(() =&gt; this.currentTheme),
      [UpdateThemeSymbol]: this.updateTheme
    }
  },
  
  data() {
    return {
      currentTheme: localStorage.getItem('theme') || 'light'
    }
  },
  
  methods: {
    updateTheme(theme) {
      this.currentTheme = theme
      localStorage.setItem('theme', theme)
      document.documentElement.setAttribute('data-theme', theme)
    }
  }
}
&lt;/script&gt;

&lt;style&gt;
.theme-provider.light {
  --bg-color: #ffffff;
  --text-color: #333333;
}

.theme-provider.dark {
  --bg-color: #1a1a1a;
  --text-color: #ffffff;
}
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- ThemedButton.vue --&gt;
&lt;template&gt;
  &lt;button 
    :class="['themed-button', `theme-${theme}`]"
    @click="handleClick"
  &gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;script&gt;
import { ThemeSymbol, UpdateThemeSymbol } from './symbols'

export default {
  name: 'ThemedButton',
  
  inject: {
    theme: {
      from: ThemeSymbol,
      default: 'light'
    },
    updateTheme: {
      from: UpdateThemeSymbol
    }
  },
  
  methods: {
    handleClick() {
      if (this.updateTheme) {
        const newTheme = this.theme === 'light' ? 'dark' : 'light'
        this.updateTheme(newTheme)
      }
      this.$emit('click')
    }
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
.themed-button {
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s;
}

.theme-light {
  background-color: var(--bg-color, #ffffff);
  color: var(--text-color, #333333);
  border: 1px solid #ddd;
}

.theme-dark {
  background-color: var(--bg-color, #333333);
  color: var(--text-color, #ffffff);
  border: 1px solid #555;
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-16">六、总结</h2>
<p>provide/inject是Vue中一个强大但容易被忽视的特性。它提供了一种优雅的跨层级组件通信方式，特别适用于：</p>
<ol>
<li><strong>组件库开发</strong>：提供全局配置和能力</li>
<li><strong>功能封装</strong>：如主题切换、多语言等</li>
<li><strong>状态共享</strong>：在中小型应用中替代状态管理库</li>
<li><strong>解耦组件</strong>：减少组件间的直接依赖</li>
</ol>
<p>记住这些关键点：</p>
<ul>
<li>默认不是响应式的，需要特殊处理</li>
<li>适合跨多层组件通信，但不适合简单父子通信</li>
<li>使用Symbol或命名空间避免命名冲突</li>
<li>在Vue 3的组合式API中更好用</li>
</ul>
<p>掌握provide/inject，让你的Vue应用架构更加清晰、组件更加解耦、代码更加优雅！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【翻译】我们如何打造v0版iOS应用]]></title>    <link>https://juejin.cn/post/7579111646870765619</link>    <guid>https://juejin.cn/post/7579111646870765619</guid>    <pubDate>2025-12-02T13:38:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579111646870765619" data-draft-id="7579096485355470898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【翻译】我们如何打造v0版iOS应用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T13:38:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户60007181910"/> <meta itemprop="url" content="https://juejin.cn/user/3555196688934128"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【翻译】我们如何打造v0版iOS应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3555196688934128/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户60007181910
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T13:38:05.000Z" title="Tue Dec 02 2025 13:38:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2Fblog%2Fhow-we-built-the-v0-ios-app" target="_blank" title="https://vercel.com/blog/how-we-built-the-v0-ios-app" ref="nofollow noopener noreferrer">vercel.com/blog/how-we…</a></p>
<p>作者：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftwitter.com%2Ffernandorojo" target="_blank" title="https://twitter.com/fernandorojo" ref="nofollow noopener noreferrer">Fernando Rojo Head of Mobile</a></p>
<p>我们近期发布了<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fus%2Fapp%2Fv0%2Fid6745097949" target="_blank" title="https://apps.apple.com/us/app/v0/id6745097949" ref="nofollow noopener noreferrer">iOS版v0</a>，这是Vercel的首款移动应用。作为专注于web技术的公司，开发原生应用对我们而言是全新领域。</p>
<p>我们的目标是打造一款配得上苹果设计奖的应用，为此我们对技术栈的选择保持开放态度。在公开测试版发布前，我们进行了数十次产品迭代，尝试了截然不同的技术栈和UI模式。</p>
<p>我们从那些完美契合iPhone语言的应用中汲取灵感，例如Apple Notes和iMessage。v0必须在你的主屏幕上赢得一席之地，与这些杰作比肩。</p>
<p>经过数周的探索，我们最终选择React Native与Expo实现这一目标。我们对成果感到满意，用户同样如此。事实上，大量开发者询问应用为何如此原生的消息涌入，促使我们撰写了技术解析文章，详述实现过程。</p>
<h2 data-id="heading-0">我们如何打造v0版聊天体验、</h2>
<p>当你离开电脑时，可能会突然灵光乍现，想要立即付诸行动。我们的目标是让你无需切换场景，就能将灵感转化为具体成果。iOS版v0是新一代笔记应用，让你的创意在后台悄然成形。</p>
<p>我们并非要打造功能与网站完全一致的移动集成开发环境，而是致力于构建简单愉悦的移动创作体验，让AI成为您随时随地实现创意的得力助手。而聊天功能正是这种体验的核心所在。</p>
<p>要打造出色的聊天体验，我们设定以下要求：</p>
<ul>
<li>新消息以平滑动画效果呈现</li>
<li>用户新消息自动滚动至屏幕顶部</li>
<li>助手消息以渐隐效果分批流式显示</li>
<li>编辑器采用液态玻璃材质，悬浮于可滚动内容之上</li>
<li>打开现有聊天时默认滚动至末尾</li>
<li>键盘交互自然流畅</li>
<li>文本输入支持粘贴图片和文件</li>
<li>文本输入支持平移手势聚焦/模糊</li>
<li>Markdown支持快速编辑与动态组件</li>
</ul>
<p>尽管移动端AI聊天已形成多种UI模式，但移动端AI代码生成领域尚无成熟范式。</p>
<p>现有React Native应用中未见这些特性，我们只能即兴创造模式。为达到标准，每个功能都经历了超乎寻常的工作量、测试与跨模块协调。</p>
<h3 data-id="heading-1">构建可组合的聊天系统</h3>
<p>为满足需求，我们按功能模块对聊天代码进行了<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D4KvbVq3Eg5w" target="_blank" title="https://www.youtube.com/watch?v=4KvbVq3Eg5w" ref="nofollow noopener noreferrer">可组合化</a>设计。</p>
<p>我们的聊天功能基于多个开源库实现：<a href="https://link.juejin.cn?target=https%3A%2F%2Flegendapp.com%2Fopen-source%2Flist%2F" target="_blank" title="https://legendapp.com/open-source/list/" ref="nofollow noopener noreferrer">LegendList</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.swmansion.com%2Freact-native-reanimated%2F" target="_blank" title="https://docs.swmansion.com/react-native-reanimated/" ref="nofollow noopener noreferrer">React Native Reanimated</a> 以及 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkirillzyusko.github.io%2Freact-native-keyboard-controller%2F" target="_blank" title="https://kirillzyusko.github.io/react-native-keyboard-controller/" ref="nofollow noopener noreferrer">React Native Keyboard Controller</a>。首先，我们设置了多个上下文提供者。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ComposerHeightProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MessageListProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">NewMessageAnimationProvider</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">KeyboardStateProvider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">KeyboardStateProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">NewMessageAnimationProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">MessageListProvider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ComposerHeightProvider</span>&gt;</span></span>
  )
}
</code></pre>
<p>提供者封装了<code>MessagesList</code>：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatMessagesList</span>(<span class="hljs-params">{ chatId }</span>) {
  <span class="hljs-keyword">const</span> messages = <span class="hljs-title function_">useMessages</span>({ chatId }).<span class="hljs-property">data</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChatProvider</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{chatId}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MessagesList</span> <span class="hljs-attr">messages</span>=<span class="hljs-string">{messages}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ChatProvider</span>&gt;</span></span>
  )
}
</code></pre>
<p>接下来，我们的消息列表通过可组合插件实现了这些功能，每个插件都拥有专属的钩子。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MessagesList</span>(<span class="hljs-params">{ messages }</span>) {
  <span class="hljs-title function_">useKeyboardAwareMessageList</span>()
  <span class="hljs-title function_">useScrollMessageListFromComposerSizeUpdates</span>()
  <span class="hljs-title function_">useUpdateLastMessageIndex</span>()
  <span class="hljs-keyword">const</span> { animatedProps, ref, onContentSizeChange, onScroll } = <span class="hljs-title function_">useMessageListProps</span>()
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AnimatedLegendList</span>
      <span class="hljs-attr">animatedProps</span>=<span class="hljs-string">{animatedProps}</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span>
      <span class="hljs-attr">onContentSizeChange</span>=<span class="hljs-string">{onContentSizeChange}</span>
      <span class="hljs-attr">onScroll</span>=<span class="hljs-string">{onScroll}</span>
      <span class="hljs-attr">enableAverages</span>=<span class="hljs-string">{false}</span>
      <span class="hljs-attr">data</span>=<span class="hljs-string">{messages}</span>
      <span class="hljs-attr">keyExtractor</span>=<span class="hljs-string">{(item)</span> =&gt;</span> item.id}
      renderItem={({ item, index }) =&gt; {
        if (item.role === 'user') {
          return <span class="hljs-tag">&lt;<span class="hljs-name">UserMessage</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{item}</span> <span class="hljs-attr">index</span>=<span class="hljs-string">{index}</span> /&gt;</span>
        }
        if (item.role === 'assistant') {
          return <span class="hljs-tag">&lt;<span class="hljs-name">AssistantMessage</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{item}</span> <span class="hljs-attr">index</span>=<span class="hljs-string">{index}</span> /&gt;</span>
        }
        if (item.role === 'optimistic-placeholder') {
          return <span class="hljs-tag">&lt;<span class="hljs-name">OptimisticAssistantMessage</span> <span class="hljs-attr">index</span>=<span class="hljs-string">{index}</span> /&gt;</span>
        }
      }}
    /&gt;</span>
  )
}
</code></pre>
<p>以下各节将逐一剖析每个钩子，以展示它们如何协同工作。</p>
<h3 data-id="heading-2">发送第一条消息</h3>
<p>当你在v0版本发送消息时，消息气泡会平滑淡入并滑动至顶部。用户消息动画完成后，助手消息会立即淡入显示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8632e2d72e6c441a943691ccc171223b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=Qt%2B%2F6Q4vbTaUQ3AtzwVuVu8tHC4%3D" alt="image.png" loading="lazy"/></p>
<p>当用户发送消息时，我们会设置一个名为 Reanimated 的共享值来指示动画应开始播放。共享值使我们能够更新状态而不触发重新渲染。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> { isMessageSendAnimating } = <span class="hljs-title function_">useNewMessageAnimation</span>()
<span class="hljs-keyword">const</span> chatId = <span class="hljs-title function_">useChatId</span>()

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onSubmit</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> isNewChat = !chatId
  
  <span class="hljs-keyword">if</span> (isNewChat) {
    isMessageSendAnimating.<span class="hljs-title function_">set</span>(<span class="hljs-literal">true</span>)
  }
  
  <span class="hljs-title function_">send</span>()
}
</code></pre>
<p>在 Reanimated 中追踪状态后，现在可以为 <code>UserMessage</code> 添加动画效果了。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">UserMessage</span>(<span class="hljs-params">{ message, index }</span>) {
  <span class="hljs-keyword">const</span> isFirstUserMessage = index === <span class="hljs-number">0</span>
  
  <span class="hljs-keyword">const</span> { style, ref, onLayout } = <span class="hljs-title function_">useFirstMessageAnimation</span>({
    <span class="hljs-attr">disabled</span>: !isFirstUserMessage,
  })
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> <span class="hljs-attr">onLayout</span>=<span class="hljs-string">{onLayout}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">UserMessageContent</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{message}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span></span>
  )
}
</code></pre>
<p>请注意，<code>UserMessageContent</code> 被包裹在 <code>Animated.View</code> 中，该组件从 <code>useFirstMessageAnimation</code> 接收 props。</p>
<p><strong><code>useFirstMessageAnimation</code> 如何工作</strong></p>
<p>此钩子负责三项任务：</p>
<ul>
<li>使用共享值 <code>itemHeight</code>（Reanimated 类）测量用户消息的高度</li>
<li>在 <code>isMessageSendAnimating</code> 时淡入消息</li>
<li>向助手消息发出动画完成信号</li>
</ul>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFirstMessageAnimation</span>(<span class="hljs-params">{ disabled }</span>) {
  <span class="hljs-keyword">const</span> { keyboardHeight } = <span class="hljs-title function_">useKeyboardContextState</span>()
  <span class="hljs-keyword">const</span> { isMessageSendAnimating } = <span class="hljs-title function_">useNewMessageAnimation</span>()
  <span class="hljs-keyword">const</span> windowHeight = <span class="hljs-title function_">useWindowDimensions</span>().<span class="hljs-property">height</span>
  <span class="hljs-keyword">const</span> translateY = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> progress = <span class="hljs-title function_">useSharedValue</span>(-<span class="hljs-number">1</span>)
  <span class="hljs-keyword">const</span> { itemHeight, ref, onLayout } = <span class="hljs-title function_">useMessageRenderedHeight</span>()

  <span class="hljs-title function_">useAnimatedReaction</span>(
    <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> didAnimate = progress.<span class="hljs-title function_">get</span>() !== -<span class="hljs-number">1</span>

      <span class="hljs-keyword">if</span> (disabled || didAnimate || !isMessageSendAnimating.<span class="hljs-title function_">get</span>()) {
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>
      }

      <span class="hljs-keyword">return</span> itemHeight.<span class="hljs-title function_">get</span>()
    },
    <span class="hljs-function">(<span class="hljs-params">messageHeight</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (messageHeight &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>

      <span class="hljs-keyword">const</span> animatedValues = <span class="hljs-title function_">getAnimatedValues</span>({
        <span class="hljs-attr">itemHeight</span>: messageHeight,
        windowHeight,
        <span class="hljs-attr">keyboardHeight</span>: keyboardHeight.<span class="hljs-title function_">get</span>(),
      })
      <span class="hljs-keyword">const</span> { start, end, duration, easing, config } = animatedValues

      translateY.<span class="hljs-title function_">set</span>(
        <span class="hljs-comment">// initialize values at the "start" state with duration 0</span>
        <span class="hljs-title function_">withTiming</span>(start.<span class="hljs-property">translateY</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span> }, <span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// next, transition to the "end" state</span>
          translateY.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">withSpring</span>(end.<span class="hljs-property">translateY</span>, config))
        })
      )
      progress.<span class="hljs-title function_">set</span>(
        <span class="hljs-title function_">withTiming</span>(start.<span class="hljs-property">progress</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span> }, <span class="hljs-function">() =&gt;</span> {
          progress.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">withTiming</span>(end.<span class="hljs-property">progress</span>, { duration, easing }), <span class="hljs-function">() =&gt;</span> {
            isMessageSendAnimating.<span class="hljs-title function_">set</span>(<span class="hljs-literal">false</span>)
          })
        })
      )
    }
  )

  <span class="hljs-keyword">const</span> style = <span class="hljs-title function_">useAnimatedStyle</span>(...)
  <span class="hljs-keyword">const</span> didUserMessageAnimate = <span class="hljs-title function_">useDerivedValue</span>(<span class="hljs-function">() =&gt;</span> progress.<span class="hljs-title function_">get</span>() === <span class="hljs-number">1</span>)
  
  <span class="hljs-keyword">return</span> { style, ref, onLayout, didUserMessageAnimate }
}
</code></pre>
<p>得益于 React Native 的新架构，<code>useLayoutEffect</code> 中的 <code>ref.current.measure()</code> 操作是同步的，因此首次渲染时即可获取高度值。后续更新则在 <code>onLayout</code> 中触发。</p>
<p>基于消息高度、窗口高度和当前键盘高度，<code>getAnimatedValues</code> 构造 <code>translateY</code> 和 <code>progress</code> 的缓动、<code>start</code> 及 <code>end</code> 状态。生成的共享值分别作为 <code>transform</code> 和 <code>opacity</code> 传递给 <code>useAnimatedStyle</code>。</p>
<p>至此，我们的首条消息已通过 Reanimated 实现淡入效果。动画完成后，即可开始淡入首个助手消息回复。</p>
<h3 data-id="heading-3">淡入第一助理的留言</h3>
<p>与 <code>UserMessage</code> 类似，助手消息内容被包裹在一个动画视图中，该视图会在用户消息动画完成后淡入显示。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AssistantMessage</span>(<span class="hljs-params">{ message, index }</span>) {
  <span class="hljs-keyword">const</span> isFirstAssistantMessage = index === <span class="hljs-number">1</span>
  
  <span class="hljs-keyword">const</span> { didUserMessageAnimate } = <span class="hljs-title function_">useFirstMessageAnimation</span>({
    <span class="hljs-attr">disabled</span>: !isFirstAssistantMessage,
  })

  <span class="hljs-keyword">const</span> style = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">opacity</span>: didUserMessageAnimate.<span class="hljs-title function_">get</span>() ? <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">1</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">350</span> }) : <span class="hljs-number">0</span>,
  }))
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">AssistantMessageContent</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{message}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span></span>
  )
}
</code></pre>
<p>此淡入效果仅适用于聊天中的首条助手消息（即 <code>index === 1</code> 的消息）。现有聊天中的消息与新聊天中的消息将呈现不同行为。</p>
<p>若打开一个已存在聊天（包含一条用户消息和一条助手消息），是否会再次触发动画？不会，因为该动画仅在 <code>isMessageSendAnimating</code> 为 <code>true</code> 时生效——该属性在消息 <code>onSubmit</code> 时设置，切换聊天时则被清除。</p>
<h3 data-id="heading-4">在现有聊天中发送消息</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40f1813ba5c4491ab4c41fbfc24fd3fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=7aJn19C93NrbC8VHERP6wT6%2BUBM%3D" alt="image.png" loading="lazy"/></p>
<p>我们已介绍过v0如何处理新聊天消息中的动画效果。但对于现有聊天，其逻辑则完全不同。我们不再依赖Reanimated动画（如 <code>usedFirstMessageAnimation</code> 中使用的动画），而是采用 <code>scrollToEnd()</code> 的实现方案。</p>
<p>那么在现有聊天中发送消息时，我们只需滚动到末尾即可，对吧？</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">onNewMessage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> didNewMessageSend = <span class="hljs-comment">// ...some logic</span>
  <span class="hljs-keyword">if</span> (didNewMessageSend) {
    listRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">scrollToEnd</span>()
  }
}, ...)
</code></pre>
<p>在理想状态下，这套逻辑本应足够完善。但让我们探讨为何它仍显不足。</p>
<p>回顾开篇所述，我们的需求之一是新消息必须滚动至屏幕顶部。若直接调用<code>scrollToEnd()</code>方法，新消息只会显示在屏幕底部。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9724180b41344ebfb6fa297fb519c3ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=zYPeo7u75W8xWHAcQBbocyf0foU%3D" alt="" loading="lazy"/></p>
<p>我们需要一种策略将用户消息推至聊天顶部。我们将此称为"空白大小"：即最后一条助手消息底部与聊天结束之间的距离。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a24f5a7f63104ab4833def70b43add03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=lhsBteBMG376B4nx9IU55sic6qA%3D" alt="" loading="lazy"/></p>
<p>为将内容浮动至聊天顶部，我们需将其向上推送与空白区域等量的距离。得益于React Native新架构中的同步高度测量机制，我们得以在每帧更新时实现无闪烁效果。但这仍需大量技巧与协调配合。</p>
<p>在上图中，您会注意到空白区域具有动态特性。其高度取决于键盘的展开状态。由于助手消息以不可预测的大小快速流式传输，每次渲染时空白区域都可能发生变化。</p>
<p>动态高度是虚拟化列表的常见难题，而频繁更新的空白区域将这一挑战推向新高度：我们的列表项具有动态未知高度且更新频繁，同时需要保持顶部悬浮状态。</p>
<p>当助手消息足够长时，空白区域可能归零，这又引入了一系列新的边界情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25dc6079dc594ebaaab9b962fe49cf53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=VPlLLK1IeCXtwgR6AAmK8xQyLWI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">如何解决这个问题</h3>
<p>我们尝试了多种实现空白区域的方法：在 <code>ScrollView</code> 底部添加带高度的 <code>View</code>、为 <code>ScrollView</code> 本身设置底部填充、对可滚动内容应用 <code>translateY</code> 属性、以及在最后一条系统消息设置最小高度。这些方案最终都导致了奇怪的副作用和性能问题，通常源于需要配合Yoga布局引擎进行渲染。</p>
<p>最终我们采用 <code>ScrollView</code> 的 <code>contentInset</code> 属性来处理空白区域，避免了抖动现象。<code>contentInset</code> 属性直接映射至 UIKit 中 <code>UIScrollView</code> 的原生属性。</p>
<p>在发送消息时，我们结合使用 <code>contentInset</code> 与 <code>scrollToEnd({ offset })</code> 方法。</p>
<p>助手消息的空白区域由三部分共同决定：其自身高度、前置用户消息的高度，以及聊天容器的高度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f73973e26c94dc3b498078957e3c8b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=aEvSjOVqDEj7%2Baupgc%2FWefACoyE%3D" alt="" loading="lazy"/></p>
<p><strong>实现 <code>useMessageBlankSize</code></strong></p>
<p>要实现空白尺寸功能，我们首先在助手消息中使用名为 <code>useMessageBlankSize</code> 的钩子：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AssistantMessage</span>(<span class="hljs-params">{ message, index }</span>) {
  <span class="hljs-comment">// ...styling logic</span>
  <span class="hljs-keyword">const</span> { onLayout, ref } = <span class="hljs-title function_">useMessageBlankSize</span>({ index })
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> <span class="hljs-attr">onLayout</span>=<span class="hljs-string">{onLayout}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">AssistantMessageContent</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{message}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span></span>
  )
}
</code></pre>
<p><code>useMessageBlankSize</code> 负责以下逻辑：</p>
<ul>
<li>同步测量助手消息</li>
<li>测量其前方的用户消息</li>
<li>计算助手消息下方空白区域的最小距离</li>
<li>记录键盘展开或收起时应设置的空白区域大小</li>
<li>在根上下文提供者中设置共享的 <code>blankSize</code> 值</li>
</ul>
<p>最后，我们获取 <code>blankSize</code> 大小并将其传递给 <code>ScrollView</code> 的内容 <code>contentInset</code>：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MessagesList</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">const</span> { blankSize, composerHeight, keyboardHeight } = <span class="hljs-title function_">useMessageListContext</span>()

  <span class="hljs-keyword">const</span> animatedProps = <span class="hljs-title function_">useAnimatedProps</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">contentInset</span>: {
        <span class="hljs-attr">bottom</span>: blankSize.<span class="hljs-title function_">get</span>() + composerHeight.<span class="hljs-title function_">get</span>() + keyboardHeight.<span class="hljs-title function_">get</span>(),
      },
    }
  })

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AnimatedLegendList</span> {<span class="hljs-attr">...props</span>} <span class="hljs-attr">animatedProps</span>=<span class="hljs-string">{animatedProps}</span> /&gt;</span></span>
}
</code></pre>
<p>Reanimated 的 <code>useAnimatedProps</code> 功能让我们能在每个帧上更新 UI 线程的 props，而不会触发重新渲染。<code>contentInset</code> 展现了卓越的性能表现，远胜于以往所有尝试。</p>
<h2 data-id="heading-6">驯服键盘</h2>
<p>打造优质的聊天体验，关键在于优雅的键盘处理。在React Native中实现<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Ffernandorojo%2Fstatus%2F1857403323738927329" target="_blank" title="https://x.com/fernandorojo/status/1857403323738927329" ref="nofollow noopener noreferrer">原生般的操作体验</a>曾是艰巨而繁琐的任务。当v0 iOS处于公开测试阶段时，苹果发布了iOS 26。每次iOS测试版更新，我们的聊天功能似乎都会彻底崩溃。每次iOS版本发布，都变成一场追逐细微差异和抖动的猫鼠游戏。</p>
<p>所幸，<code>react-native-keyboard-controller</code> 的维护者 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkirillzyusko" target="_blank" title="https://github.com/kirillzyusko" ref="nofollow noopener noreferrer">Kiryl</a> 协助我们解决了这些问题，通常在苹果发布新测试版后的 24 小时内就更新了库文件。</p>
<p><strong>构建<code>useKeyboardAwareMessageList</code></strong></p>
<p>我们利用React Native键盘控制器提供的多个钩子，构建了专为v0版本聊天功能定制的键盘管理系统。</p>
<p><code>useKeyboardAwareMessageList</code> 是我们自定义的React钩子，负责所有键盘处理逻辑。它与聊天列表并行渲染，并抽象化了所有确保键盘交互体验的关键组件。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MessagesList</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useKeyboardAwareMessageList</span>()
  
  <span class="hljs-comment">// ...rest of the message list</span>
}
</code></pre>
<p>虽然该功能的调用仅需一行代码，但其内部实现包含约1000行代码及大量单元测试。<code>useKeyboardAwareMessageList</code> 主要依赖上游的 <code>useKeyboardHandler</code> 处理 <code>onStart</code>、<code>onEnd</code> 和 <code>onInteractive</code> 等事件，同时结合多次调用Reanimated的 <code>useAnimatedReaction</code> 方法，在特定边界条件下重试事件。</p>
<p>该组件还处理了iOS系统中的若干异常行为。例如当键盘开启时将应用切换至后台，随后重新聚焦应用时，iOS会莫名触发三次键盘 <code>onEnd</code> 事件。由于我们依赖命令式行为处理事件触发，因此设计了特殊机制来消除重复事件并追踪应用状态变化。</p>
<p><code>useKeyboardAwareMessageList</code> 实现以下功能：</p>
<ol>
<li>键盘弹出时缩小<code>blankSize</code></li>
<li>若滚动至聊天末尾且无空白区域，则键盘弹出时将内容向上移动</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71ffab8bd7074da988bee4bea0a1f544~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=BVQDwwEMOVOBHEbeQSgOBBvKmcA%3D" alt="image.png" loading="lazy"/></p>
<ol start="3">
<li>若滚动到足够高的位置且没有空白区域，则在内容上方显示键盘，且不移动内容本身。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfda25a2568e4fd3b211d1f409c50acf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=1dk%2BSG9s4LfjAbdZ9K2SLMczrp8%3D" alt="image.png" loading="lazy"/></p>
<ol start="4">
<li>当用户通过滚动视图或文本输入交互式地关闭键盘时，将其平滑地向下拖动。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/357a8f1f2db24658aca9ef0d1d2f6793~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=MEdeBcrRs0bfyb9FxXcY46qZhSw%3D" alt="image.png" loading="lazy"/></p>
<ol start="5">
<li>若已滚动至聊天窗口末尾，且空白区域大于键盘尺寸，内容应保持原位不变。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da5263af8bcf421f8a147c7d49d7bf20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=uwJ%2B%2FleitriUQx4GtfAke0GVdV0%3D" alt="image.png" loading="lazy"/></p>
<ol start="6">
<li>若滚动至聊天窗口底部时空白区域大于零，但键盘展开时该区域应为零，则将内容上移至键盘上方。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65e0aae7521c4c688281cc052cc32013~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=FJli39%2BSknkp4HrH8VRGSeQX%2F38%3D" alt="image.png" loading="lazy"/></p>
<p>要让这一切顺利运行，并没有什么一劳永逸的诀窍。我们耗费数十小时反复使用这款应用，发现缺陷、追踪问题，不断重写逻辑，直到感觉一切都恰到好处。</p>
<h2 data-id="heading-7">初始滚动至末尾</h2>
<p>当您打开现有聊天时，v0版本会将聊天界面滚动至末尾。这类似于在React Native的 <code>FlatList</code> 中使用 <code>inverted</code> 属性，这种设计常见于自下而上的聊天界面。</p>
<p>然而我们最终放弃了 <code>inverted</code> 方案，因为它与AI聊天场景存在冲突——AI聊天每秒会产生多次消息流。我们选择不采用助手消息流自动滚动方案，而是让内容自然填充在键盘下方区域，并配有滚动至末尾的按钮。此设计与ChatGPT的iOS应用行为一致。</p>
<p>但我们仍希望在首次打开现有聊天时提供倒序列表式体验。为此，当聊天首次可见时，我们会调用 <code>scrollToEnd</code> 方法实现滚动至末尾的效果。</p>
<p>由于动态消息高度与空白区域的复杂组合，我们不得不多次调用 <code>scrollToEnd</code> 方法。若不如此操作，列表要么无法正常滚动，要么滚动时机过晚。内容完成滚动后，我们调用 <code>hasScrolledToEnd.set(true) </code>方法，使聊天内容渐显。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { scheduleOnRN } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-worklets'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useInitialScrollToEnd</span>(<span class="hljs-params">blankSize, scrollToEnd, hasMessages</span>) {
  <span class="hljs-keyword">const</span> hasStartedScrolledToEnd = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> hasScrolledToEnd = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> scrollToEndJS = <span class="hljs-title function_">useLatestCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">scrollToEnd</span>({ <span class="hljs-attr">animated</span>: <span class="hljs-literal">false</span> })
    <span class="hljs-comment">// Do another one just in case because the list may not have fully laid out yet</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">scrollToEnd</span>({ <span class="hljs-attr">animated</span>: <span class="hljs-literal">false</span> })

      <span class="hljs-comment">// and another one again in case</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">scrollToEnd</span>({ <span class="hljs-attr">animated</span>: <span class="hljs-literal">false</span> })

        <span class="hljs-comment">// and yet another!</span>
        <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
          hasScrolledToEnd.<span class="hljs-title function_">set</span>(<span class="hljs-literal">true</span>)
        })
      }, <span class="hljs-number">16</span>)
    })
  })

  <span class="hljs-title function_">useAnimatedReaction</span>(
    <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (hasStartedScrolledToEnd.<span class="hljs-title function_">get</span>() || !hasMessages) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      }
      <span class="hljs-keyword">return</span> blankSize.<span class="hljs-title function_">get</span>() &gt; <span class="hljs-number">0</span>
    },
    <span class="hljs-function">(<span class="hljs-params">shouldScroll</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (shouldScroll) {
        hasStartedScrolledToEnd.<span class="hljs-title function_">set</span>(<span class="hljs-literal">true</span>)
        <span class="hljs-title function_">scheduleOnRN</span>(scrollToEndJS)
      }
    }
  )

  <span class="hljs-keyword">return</span> hasScrolledToEnd
}
</code></pre>
<h2 data-id="heading-8">漂浮编辑器</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7885b2de806b473aa012cb90b8a14007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=aeuNnWVBL738OhKEZL26p1H8bUk%3D" alt="image.png" loading="lazy"/></p>
<p>受iOS 26中iMessage底部工具栏的启发，我们打造了一款采用渐进式模糊效果的液态玻璃编辑器。</p>
<p>我们使用<code>@callstack/liquid-glass</code>库实现了交互式液态玻璃效果。通过用 <code>LiquidGlassContainerView</code> 包裹玻璃视图，即可自动获得视图变形效果。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">&lt;<span class="hljs-title class_">LiquidGlassContainerView</span> spacing={<span class="hljs-number">8</span>}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LiquidGlassView</span> <span class="hljs-attr">interactive</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">LiquidGlassView</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LiquidGlassView</span> <span class="hljs-attr">interactive</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">LiquidGlassView</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">LiquidGlassContainerView</span>&gt;
</code></pre>
<h3 data-id="heading-9">悬浮</h3>
<p>添加液体玻璃后，下一步是让它漂浮在聊天内容的顶部。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f84dfbccbbb46bca64862705ee1d949~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=5QzTMdC4dBvfGnvfK4gwhwKgiRw%3D" alt="image.png" loading="lazy"/></p>
<p>为使编辑器悬浮于可滚动内容之上，我们采取了以下步骤：</p>
<ol>
<li>在编辑器中添加：<code>position: absolute; bottom: 0</code></li>
<li>使用 <code>react-native-keyboard-controller</code> 中的 <code>KeyboardStickyView</code> 包裹编辑器</li>
<li>同步测量编辑器高度，并通过共享值将其存储在上下文中</li>
<li>将 <code>composerHeight.get()</code> 添加到 ScrollView 的原生 <code>contentInset.bottom</code> 属性中</li>
</ol>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Composer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { composerHeight } = <span class="hljs-title function_">useComposerHeightContext</span>()
  <span class="hljs-keyword">const</span> { onLayout, ref } = <span class="hljs-title function_">useSyncLayoutHandler</span>(<span class="hljs-function">(<span class="hljs-params">layout</span>) =&gt;</span> {
    composerHeight.<span class="hljs-title function_">set</span>(layout.<span class="hljs-property">height</span>)
  })
  <span class="hljs-keyword">const</span> insets = <span class="hljs-title function_">useInsets</span>()

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeyboardStickyView</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">position:</span> '<span class="hljs-attr">absolute</span>', <span class="hljs-attr">bottom:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">right:</span> <span class="hljs-attr">0</span> }}
      <span class="hljs-attr">offset</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">closed:</span> <span class="hljs-attr">-insets.bottom</span>, <span class="hljs-attr">opened:</span> <span class="hljs-attr">-8</span> }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">View</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span>
        <span class="hljs-attr">onLayout</span>=<span class="hljs-string">{onLayout}</span>
      &gt;</span>
        {/* ... */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">KeyboardStickyView</span>&gt;</span></span>
  )
}
</code></pre>
<p>然而这还不够。我们仍缺少一个关键行为。</p>
<p>当您输入文字时，文本输入框的高度会随之增加。当您输入新行时，我们需要模拟在常规非绝对定位输入框中的输入体验。为此我们必须找到一种方法，在您滚动到聊天记录末尾时将聊天内容向上移动。</p>
<p>在下面的视频中，你可以看到两种情况。视频开始时，由于聊天滚动到末尾，内容会随着新行向上移动。然而，在聊天中向上滚动后，输入新行不会移动内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb9018a64d9841349aff1ae908797f73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=Wcmf5%2B0SvRaZI310tNCi202Y%2F3M%3D" alt="image.png" loading="lazy"/></p>
<p><strong><code>useScrollWhenComposerSizeUpdates</code></strong></p>
<p>使用<code>useScrollWhenComposerSizeUpdates</code>钩子。该钩子监听组合器高度变化，并在需要时自动滚动至末尾。要使用它，只需在<code>MessagesList</code>中调用即可：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MessagesList</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useScrollWhenComposerSizeUpdates</span>()
 
  <span class="hljs-comment">// ...message list code  </span>
}
</code></pre>
<p>首先，它通过 <code>useAnimatedReaction</code> 设置效果来追踪编辑器高度变化。</p>
<p>接着调用 <code>autoscrollToEnd</code> 方法。只要你靠近可滚动区域的末尾，系统就会自动滚动至聊天窗口底部。若无此机制，在编辑器中输入新行时内容会覆盖可滚动区域的底部。</p>
<p><code>useScrollWhenComposerSizeUpdates</code> 让我们能够条件性地模拟非绝对定位视图的交互体验。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useScrollWhenComposerSizeUpdates</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { listRef, scrollToEnd } = <span class="hljs-title function_">useMessageListContext</span>()
  <span class="hljs-keyword">const</span> { composerHeight } = <span class="hljs-title function_">useComposerHeightContext</span>()

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">autoscrollToEnd</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> list = listRef.<span class="hljs-property">current</span>
    <span class="hljs-keyword">if</span> (!list) {
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">const</span> state = list.<span class="hljs-title function_">getState</span>()
    <span class="hljs-keyword">const</span> distanceFromEnd =
      state.<span class="hljs-property">contentLength</span> - state.<span class="hljs-property">scroll</span> - state.<span class="hljs-property">scrollLength</span>

    <span class="hljs-keyword">if</span> (distanceFromEnd &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">scrollToEnd</span>({ <span class="hljs-attr">animated</span>: <span class="hljs-literal">false</span> })
      <span class="hljs-comment">// wait a frame for LegendList to update, and fire it again</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">scrollToEnd</span>({ <span class="hljs-attr">animated</span>: <span class="hljs-literal">false</span> })
      }, <span class="hljs-number">16</span>)
    }
  }

  <span class="hljs-title function_">useAnimatedReaction</span>(
    <span class="hljs-function">() =&gt;</span> composerHeight.<span class="hljs-title function_">get</span>(),
    <span class="hljs-function">(<span class="hljs-params">height, prevHeight</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (height &gt; <span class="hljs-number">0</span> &amp;&amp; height !== prevHeight) {
        <span class="hljs-title function_">scheduleOnRN</span>(autoscrollToEnd)
      }
    }
  )
}
</code></pre>
<p>正如我们在之前的代码中所见，我们不得不依赖多个 <code>setTimeout</code> 和 <code>requestAnimationFrame</code> 调用来实现 <code>scrollToEnd</code> 功能。这段代码难免会让人感到困惑，但当时这是唯一能让滚动结束功能正常运作的方法。我们正与 LegendList 的维护者 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjmeistrich" target="_blank" title="https://github.com/jmeistrich" ref="nofollow noopener noreferrer">Jay</a> 积极合作，致力于构建更可靠的解决方案。</p>
<h3 data-id="heading-10">逼近原生体验</h3>
<p>React Native内置的 <code>TextInput</code> 组件在原生聊天应用中显得格格不入。</p>
<p>默认情况下，当设置<code>multiline={true}</code>时，<code>TextInput</code> 会显示难看的滚动指示器，这与大多数聊天应用不符。在输入框上下滑动会导致内部内容弹跳，即使尚未输入任何文本也是如此。此外，该输入框不支持交互式键盘关闭功能。</p>
<p>为解决这些问题，我们在原生代码中为 <code>RCTUITextView</code> 应用了补丁。该补丁禁用了滚动指示器，移除了弹跳效果，并启用了交互式键盘关闭功能。</p>
<p>我们的补丁还新增了向上滑动聚焦输入区域的功能。在观察测试人员因期待键盘弹出而焦躁地向上滑动后，我们意识到这个功能的必要性。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">diff --git a/<span class="hljs-title class_">Libraries</span>/<span class="hljs-title class_">Text</span>/<span class="hljs-title class_">TextInput</span>/<span class="hljs-title class_">Multiline</span>/<span class="hljs-title class_">RCTUITextView</span>.<span class="hljs-property">mm</span> b/<span class="hljs-title class_">Libraries</span>/<span class="hljs-title class_">Text</span>/<span class="hljs-title class_">TextInput</span>/<span class="hljs-title class_">Multiline</span>/<span class="hljs-title class_">RCTUITextView</span>.<span class="hljs-property">mm</span>
index 6e9c3841cee19632eaa59ae2dbd541a85ce7cabf..<span class="hljs-property">e3f920acbc2bb074582ed2b531ddd90e2017d59c</span> <span class="hljs-number">100644</span>
--- a/<span class="hljs-title class_">Libraries</span>/<span class="hljs-title class_">Text</span>/<span class="hljs-title class_">TextInput</span>/<span class="hljs-title class_">Multiline</span>/<span class="hljs-title class_">RCTUITextView</span>.<span class="hljs-property">mm</span>
+++ b/<span class="hljs-title class_">Libraries</span>/<span class="hljs-title class_">Text</span>/<span class="hljs-title class_">TextInput</span>/<span class="hljs-title class_">Multiline</span>/<span class="hljs-title class_">RCTUITextView</span>.<span class="hljs-property">mm</span>
@@ -<span class="hljs-number">55</span>,<span class="hljs-number">6</span> +<span class="hljs-number">55</span>,<span class="hljs-number">16</span> @@ - (instancetype)<span class="hljs-attr">initWithFrame</span>:(<span class="hljs-title class_">CGRect</span>)frame
     self.<span class="hljs-property">textContainer</span>.<span class="hljs-property">lineFragmentPadding</span> = <span class="hljs-number">0</span>;
     self.<span class="hljs-property">scrollsToTop</span> = <span class="hljs-variable constant_">NO</span>;
     self.<span class="hljs-property">scrollEnabled</span> = <span class="hljs-variable constant_">YES</span>;
+
+    <span class="hljs-comment">// Fix bouncing, scroll indicator, and keyboard mode gesture</span>
+    self.<span class="hljs-property">showsVerticalScrollIndicator</span> = <span class="hljs-variable constant_">NO</span>;
+    self.<span class="hljs-property">showsHorizontalScrollIndicator</span> = <span class="hljs-variable constant_">NO</span>;
+    self.<span class="hljs-property">bounces</span> = <span class="hljs-variable constant_">NO</span>;
+    self.<span class="hljs-property">alwaysBounceVertical</span> = <span class="hljs-variable constant_">NO</span>;
+    self.<span class="hljs-property">alwaysBounceHorizontal</span> = <span class="hljs-variable constant_">NO</span>;
+    self.<span class="hljs-property">keyboardDismissMode</span> = <span class="hljs-title class_">UIScrollViewKeyboardDismissModeInteractive</span>;
+    [self.<span class="hljs-property">panGestureRecognizer</span> <span class="hljs-attr">addTarget</span>:self <span class="hljs-attr">action</span>:@<span class="hljs-title function_">selector</span>(<span class="hljs-attr">_handlePanToFocus</span>:)];
+
     _initialValueLeadingBarButtonGroups = nil;
     _initialValueTrailingBarButtonGroups = nil;
   }
@@ -<span class="hljs-number">62</span>,<span class="hljs-number">6</span> +<span class="hljs-number">72</span>,<span class="hljs-number">18</span> @@ - (instancetype)<span class="hljs-attr">initWithFrame</span>:(<span class="hljs-title class_">CGRect</span>)frame
   <span class="hljs-keyword">return</span> self;
 }
 
+- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">_handlePanToFocus</span>:(<span class="hljs-title class_">UIPanGestureRecognizer</span> *)g
+{
+    <span class="hljs-keyword">if</span> (self.<span class="hljs-property">isFirstResponder</span>) { <span class="hljs-keyword">return</span>; }
+    <span class="hljs-keyword">if</span> (g.<span class="hljs-property">state</span> != <span class="hljs-title class_">UIGestureRecognizerStateBegan</span>) { <span class="hljs-keyword">return</span>; }
+    <span class="hljs-title class_">CGPoint</span> v = [g <span class="hljs-attr">velocityInView</span>:self];
+    <span class="hljs-title class_">CGPoint</span> t = [g <span class="hljs-attr">translationInView</span>:self];
+    <span class="hljs-comment">// Add pan gesture to focus the keyboard</span>
+    <span class="hljs-keyword">if</span> (v.<span class="hljs-property">y</span> &lt; -<span class="hljs-number">250.0</span> &amp;&amp; !self.<span class="hljs-property">isFirstResponder</span>) {
+        [self becomeFirstResponder];
+    }
+}
+
 - (<span class="hljs-keyword">void</span>)<span class="hljs-attr">setDelegate</span>:(id&lt;<span class="hljs-title class_">UITextViewDelegate</span>&gt;)delegate
 {
   <span class="hljs-comment">// Delegate is set inside `[RCTBackedTextViewDelegateAdapter initWithTextView]` and</span>
</code></pre>
<p>虽然在React Native更新中维护补丁并非理想方案，但这是我们找到的最切实可行的解决方案。我们更希望存在官方API来扩展原生视图而无需打补丁，若社区对此感兴趣，我们计划将此补丁贡献给React Native核心团队。</p>
<h3 data-id="heading-11">粘贴图片</h3>
<p>为支持在文本输入框中粘贴图片和文件，我们使用了一个Expo模块，该模块会监听来自原生 <code>UIPasteboard</code> 的粘贴事件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/021a1dc39ea548e682c51bf9bea5111b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=8g5hcH2l1%2BMooc0wuUexQrywWPU%3D" alt="image.png" loading="lazy"/></p>
<p>若粘贴的文本足够长，<code>onPaste</code> 将自动将粘贴内容转换为 <code>.txt</code> 文件附件。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">&lt;<span class="hljs-title class_">TextInputWrapper</span> onPaste={<span class="hljs-function"><span class="hljs-params">pasted</span> =&gt;</span> ...}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TextInput</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">TextInputWrapper</span>&gt;
</code></pre>
<p>由于难以在原生代码中扩展现有的 <code>TextInput</code> 组件，我们采用了 <code>TextInputWrapper</code> 组件——它通过Swift语言封装 <code>TextInput</code> 并遍历其 <code>subviews</code> 。若需深入了解原生封装组件的创建示例，欢迎观看我2024年的演讲<a href="https://link.juejin.cn?target=https%3A%2F%2Fyoutu.be%2FmG1Lv-RWds8%3Fsi%3DUCSHQQAnfsYGdr4P" target="_blank" title="https://youtu.be/mG1Lv-RWds8?si=UCSHQQAnfsYGdr4P" ref="nofollow noopener noreferrer">《勇于构建原生库》</a>。</p>
<h2 data-id="heading-12">流媒体内容渐隐效果</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d83d83be0e6445c19fa28379efaca990~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=RrZOJQXpOUleUO%2FyCeS3Qp%2B3u6M%3D" alt="image.png" loading="lazy"/></p>
<p>当AI助手的消息流传入时，必须保持流畅体验。为实现这一目标，我们创建了两个组件：</p>
<ol>
<li><code>&lt;FadeInStaggeredIfStreaming /&gt;</code></li>
<li><code>&lt;TextFadeInStaggeredIfStreaming /&gt;</code></li>
</ol>
<p>只要某个元素被这些组件之一包裹，其子元素就会以错落有致的动画效果平滑淡入。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> mdxComponents = {
  <span class="hljs-attr">a</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">A</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Elements.A</span> {<span class="hljs-attr">...props</span>}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">TextFadeInStaggeredIfStreaming</span>&gt;</span>
          {props.children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">TextFadeInStaggeredIfStreaming</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Elements.A</span>&gt;</span></span>
    )
  },
  <span class="hljs-comment">// ...other components</span>
}
</code></pre>
<p>在底层实现中，这些组件渲染了 <code>FadeInStaggered</code> 的变体，该组件负责状态管理：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> useIsAnimatedInPool = <span class="hljs-title function_">createUsePool</span>()

<span class="hljs-keyword">function</span> <span class="hljs-title function_">FadeInStaggered</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> { isActive, evict } = <span class="hljs-title function_">useIsAnimatedInPool</span>()
  <span class="hljs-keyword">return</span> isActive ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">FadeIn</span> <span class="hljs-attr">onFadedIn</span>=<span class="hljs-string">{evict}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">FadeIn</span>&gt;</span></span> : children
}
</code></pre>
<p><code>useIsAnimatedInPool</code> 是 React 外部的一个自定义状态管理器，允许同时渲染有限数量的有序元素。元素在挂载时请求加入池，<code>isActive</code> 属性指示其是否应渲染动画节点。</p>
<p>当 <code>onFadedIn</code> 回调触发后，我们会将元素从池中移除，直接渲染其子元素而不使用动画包装器。这有助于限制同时活动的动画节点数量。</p>
<p>最后，<code>FadeIn</code> 实现交错动画效果，元素间延迟为 32 毫秒。交错动画按计划执行，每次批量渲染 2 个元素。当交错元素队列超过 10 个时，我们会根据队列大小增加批处理元素数量。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> useStaggeredAnimation = <span class="hljs-title function_">createUseStaggered</span>(<span class="hljs-number">32</span>)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">FadeIn</span>(<span class="hljs-params">{ children, onFadedIn, Component }</span>) {
  <span class="hljs-keyword">const</span> opacity = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">startAnimation</span> = (<span class="hljs-params"/>) =&gt; {
    opacity.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">withTiming</span>(<span class="hljs-number">1</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">500</span> }))
    <span class="hljs-built_in">setTimeout</span>(onFadedIn, <span class="hljs-number">500</span>)
  }

  <span class="hljs-title function_">useStaggeredAnimation</span>(startAnimation)

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity</span> }}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">Component</span>&gt;</span></span>
}
</code></pre>
<p><code>TextFadeInStaggeredIfStreaming</code> 采用类似策略。我们首先将单词拆分为独立文本节点，随后创建一个容纳文本元素的独立池，并设置4个元素的上限。这确保每次淡入显示的单词不超过4个。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> useShouldTextFadePool = <span class="hljs-title function_">createUsePool</span>(<span class="hljs-number">4</span>)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">TextFadeInStaggeredIfStreaming</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">const</span> { isStreaming } = <span class="hljs-title function_">use</span>(<span class="hljs-title class_">MessageContext</span>)
  <span class="hljs-keyword">const</span> { isActive } = <span class="hljs-title function_">useShouldTextFadePool</span>()

  <span class="hljs-keyword">const</span> [shouldFade] = <span class="hljs-title function_">useState</span>(isActive &amp;&amp; isStreaming)

  <span class="hljs-keyword">let</span> { children } = props
  <span class="hljs-keyword">if</span> (shouldFade &amp;&amp; children) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(children)) {
      children = <span class="hljs-title class_">Children</span>.<span class="hljs-title function_">map</span>(children, <span class="hljs-function">(<span class="hljs-params">child, i</span>) =&gt;</span>
        <span class="hljs-keyword">typeof</span> child === <span class="hljs-string">'string'</span> ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AnimatedFadeInText</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{child}</span> /&gt;</span></span> : child,
      )
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> children === <span class="hljs-string">'string'</span>) {
      children = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AnimatedFadeInText</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{children}</span> /&gt;</span></span>
    }
  }

  <span class="hljs-keyword">return</span> children
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">AnimatedFadeInText</span>(<span class="hljs-params">{ text }</span>) {
  <span class="hljs-keyword">const</span> chunks = text.<span class="hljs-title function_">split</span>(<span class="hljs-string">' '</span>)

  <span class="hljs-keyword">return</span> chunks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">chunk, i</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TextFadeInStaggered</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{chunk</span> + ' '} /&gt;</span></span>)
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">TextFadeInStaggered</span>(<span class="hljs-params">{ text }</span>) {
  <span class="hljs-keyword">const</span> { isActive, evict } = <span class="hljs-title function_">useIsAnimatedInPool</span>()
  <span class="hljs-keyword">return</span> isActive ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">FadeIn</span> <span class="hljs-attr">onFadedIn</span>=<span class="hljs-string">{evict}</span>&gt;</span>{text}<span class="hljs-tag">&lt;/<span class="hljs-name">FadeIn</span>&gt;</span></span> : text
}
</code></pre>
<p>这种方法存在的一个问题是它高度依赖于在挂载时触发动画效果。因此，如果你发送一条消息后切换到其他聊天窗口，然后在消息发送完成前返回原聊天窗口，动画效果会重新挂载并再次播放。</p>
<p>为缓解此问题，我们设计了跨聊天记录追踪动画内容的系统。具体实现是在消息树顶层使用 <code>DisableFadeProvider</code> 组件，并在根级淡出组件中调用该组件，以避免影响资源池。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TextFadeInStaggeredIfStreaming</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">const</span> { isStreaming } = <span class="hljs-title function_">use</span>(<span class="hljs-title class_">MessageContext</span>)
  <span class="hljs-keyword">const</span> { isActive } = <span class="hljs-title function_">useShouldTextFadePool</span>()
  <span class="hljs-keyword">const</span> isFadeDisabled = <span class="hljs-title function_">useDisableFadeContext</span>()

  <span class="hljs-keyword">const</span> [shouldFade] = <span class="hljs-title function_">useState</span>(!isFadeDisabled &amp;&amp; isActive &amp;&amp; isStreaming)
  
  <span class="hljs-keyword">if</span> (shouldFade) <span class="hljs-comment">// here we render TextFadeIn...</span>
  
  <span class="hljs-keyword">return</span> props.<span class="hljs-property">children</span>
}
</code></pre>
<p>虽然在非响应式场景下显式依赖 <code>useState</code> 的初始值看似不寻常，但这种做法能让我们根据元素挂载顺序可靠地追踪其动画状态。</p>
<h2 data-id="heading-13">在网页和原生应用之间共享代码</h2>
<p>在开发v0版iOS应用时，一个自然的问题浮现：Web端与原生端应共享多少代码？</p>
<p>鉴于v0版Web单仓库的成熟度，我们决定共享类型和辅助函数，但不共享UI或状态管理。同时我们着力将业务逻辑从客户端迁移至服务器端，使v0版移动应用成为API的轻量封装层。</p>
<p><strong>构建共享API</strong></p>
<p>在成熟的Next.js应用与新移动应用之间共享后端API路由带来了挑战。v0网页应用采用React服务器组件和服务器操作驱动，而移动应用则更像单页React应用。</p>
<p>为解决此问题，我们基于自研后端框架构建了API层。该框架通过强制要求使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fzod.dev%2F" target="_blank" title="https://zod.dev/" ref="nofollow noopener noreferrer">Zod</a>定义输入输出类型，实现了运行时类型安全。</p>
<p>定义路由后，系统会根据各路由的Zod类型生成<code>https://api.v0.dev/v1/openapi.json</code>文件。移动端通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fheyapi.dev%2F" target="_blank" title="https://heyapi.dev/" ref="nofollow noopener noreferrer">Hey API</a>消费OpenAPI规范，该工具会生成辅助函数供<a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Fquery%2Flatest" target="_blank" title="https://tanstack.com/query/latest" ref="nofollow noopener noreferrer">Tanstack Query</a>调用。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { termsFindOptions } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api'</span> <span class="hljs-comment">// this folder is generated</span>
<span class="hljs-keyword">import</span> { useQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTermsQuery</span>(<span class="hljs-params">{ after }</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useQuery</span>(<span class="hljs-title function_">termsFindOptions</span>({ after }))
}
</code></pre>
<p>这项工作促成了<a href="https://link.juejin.cn?target=https%3A%2F%2Fv0.app%2Fdocs%2Fapi%2Fplatform%2Fquickstart" target="_blank" title="https://v0.app/docs/api/platform/quickstart" ref="nofollow noopener noreferrer">v0平台API</a>的开发。我们最初旨在为自有原生客户端打造理想的API，最终决定将该API开放给所有用户。得益于此策略，v0移动端与v0平台API客户使用相同的接口路径和逻辑。</p>
<p>每次提交代码时，我们都会运行测试以确保OpenAPI规范的变更与移动应用兼容。</p>
<p>未来我们计划通过在平台API外层构建类型级RPC封装器，彻底消除代码生成环节。</p>
<h2 data-id="heading-14">样式</h2>
<p>v0版本采用<code>react-native-unistyles</code>进行样式和主题管理。基于对React Native的实践经验，我始终对渲染阶段的操作保持谨慎。与我们评估过的其他样式库不同，Unistyles能在不重新渲染组件或访问React上下文的情况下实现全面主题管理。</p>
<h3 data-id="heading-15">原生菜单</h3>
<p>除了Unistyles主题和样式库外，我们并未采用基于JS的组件库，而是尽可能依赖原生元素。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38c4482f6d51422bbfb9451521ef95ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287487&amp;x-signature=Ur%2Fn0xzfjIo1NYZ7WAm8fB%2BjTKk%3D" alt="image.png" loading="lazy"/></p>
<p>对于菜单，我们采用了<a href="https://link.juejin.cn?target=https%3A%2F%2Fzeego.dev%2F" target="_blank" title="https://zeego.dev/" ref="nofollow noopener noreferrer">Zeego</a>框架，该框架在底层依赖<code>https://github.com/dominicstop/react-native-ios-context-menu</code>来渲染原生<code>UIMenu</code>。当使用Xcode 26进行构建时，Zeego会自动渲染Liquid Glass样式的菜单。</p>
<h3 data-id="heading-16">原生<code>Alert</code></h3>
<p>在 iOS 26 系统上运行的 React Native 应用存在 <code>Alert</code> 渲染偏离屏幕的问题。我们在自家应用及众多热门 React Native 应用中复现了该问题。我们通过本地补丁修复了该问题，并与 Callstack 和 Meta 的开发者合作，将修复方案<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact-native%2Fpull%2F53500" target="_blank" title="https://github.com/facebook/react-native/pull/53500" ref="nofollow noopener noreferrer">提交至 React Native</a> 。</p>
<h3 data-id="heading-17">原生底部菜单</h3>
<p>对于底层表单，我们采用了内置的React Native模态框并设置<code>presentationStyle="formSheet"</code>。但该方案存在若干缺陷，我们通过补丁进行了修复。</p>
<p><strong>修复Yoga闪烁问题</strong></p>
<p>若将 <code>flex: 1</code> 的 <code>View</code> 嵌入带背景色的模态框中，随后上下拖动模态框，该视图底部会出现剧烈闪烁现象。</p>
<p>为解决此问题，我们对 React Native 进行了本地补丁修复，使 Yoga 框架支持模态框的同步更新。通过与 Callstack、Expo 和 Meta 的开发者协作，该改进已合并至 React Native 核心库。此功能现已随 React Native 0.82 版本<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact-native%2Fpull%2F52604" target="_blank" title="https://github.com/facebook/react-native/pull/52604" ref="nofollow noopener noreferrer">正式发布</a>。</p>
<h2 data-id="heading-18">期待</h2>
<p>在使用React Native和Expo构建了首个应用后，我们再未回头。若您尚未体验iOS版v0，请立即<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fus%2Fapp%2Fv0%2Fid6745097949" target="_blank" title="https://apps.apple.com/us/app/v0/id6745097949" ref="nofollow noopener noreferrer">下载</a>并通过App Store评论告诉我们您的想法。</p>
<p>我们正在招募开发者加入Vercel移动团队。若此类工作令您心动，我们期待<a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2Fcareers%2Fmobile-engineer-us-5719796004" target="_blank" title="https://vercel.com/careers/mobile-engineer-us-5719796004" ref="nofollow noopener noreferrer">您的加入</a>。</p>
<p>在Vercel，我们致力于打造最高水准的雄心勃勃的产品。我们希望让Web和原生开发者同样轻松实现这一目标，并计划开源我们的研究成果。若您有意参与AI聊天应用开源库的测试版测试，请通<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Ffernandorojo" target="_blank" title="https://x.com/fernandorojo" ref="nofollow noopener noreferrer">过X平台联系我们</a>。期待与社区携手，共同推动React Native持续进步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[“点一下就能改”——这个功能为首富赚到了多少money？]]></title>    <link>https://juejin.cn/post/7578968420043685951</link>    <guid>https://juejin.cn/post/7578968420043685951</guid>    <pubDate>2025-12-02T14:36:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578968420043685951" data-draft-id="7579123072825884691" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="“点一下就能改”——这个功能为首富赚到了多少money？"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-02T14:36:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_一两风"/> <meta itemprop="url" content="https://juejin.cn/user/2250014422739596"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            “点一下就能改”——这个功能为首富赚到了多少money？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250014422739596/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _一两风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:36:36.000Z" title="Tue Dec 02 2025 14:36:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"> 从 QQ 个性签名编辑看 JavaScript 面向对象编程：一个原生 DOM 的 OOP 实践</h2>
<blockquote>
<p>本文通过复刻 QQ“点击个性签名即可编辑”的交互效果，手写一个 <code>EditInPlace</code>（就地编辑）组件，深入理解 JavaScript 中的面向对象编程（OOP）思想，并探讨其在现代前端开发中的意义与局限。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">🎯 场景还原：QQ 的“就地编辑”体验</h3>
<p>打开 QQ 资料页，你会发现个性签名处是这样设计的：</p>
<ul>
<li>默认显示为一段文本；</li>
<li>点击后，文本变成输入框 + “保存/取消”按钮；</li>
<li>输入内容后点击“保存”，内容更新；点击“取消”则还原。</li>
</ul>
<p>这种 <strong>“无需跳转页面、直接在当前位置编辑”</strong> 的交互模式，我们称之为 <strong>“就地编辑”（Edit in Place）</strong> 。它简洁、高效，是 Web 2.0 时代的经典 UI 模式之一。</p>
<p>今天，我们就用 <strong>原生 JavaScript + OOP</strong> 来实现它！</p>
<hr/>
<h3 data-id="heading-2">🛠️ 核心实现：<code>EditInPlace</code> 类</h3>
<p>以下是我们实现的核心代码（已简化注释，保留关键逻辑）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">EditInPlace</span>(<span class="hljs-params">id, value, parentElement</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value || <span class="hljs-string">'这个家伙很懒，什么都没有留下'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span> = parentElement;

  <span class="hljs-comment">// DOM 元素引用</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span> = <span class="hljs-literal">null</span>;   <span class="hljs-comment">// 显示文本的 span</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span> = <span class="hljs-literal">null</span>;    <span class="hljs-comment">// 可编辑的 input</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>();  <span class="hljs-comment">// 创建 DOM 结构</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attachEvent</span>();    <span class="hljs-comment">// 绑定事件</span>
}

<span class="hljs-title class_">EditInPlace</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-title function_">createElement</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-property">id</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>;

    <span class="hljs-comment">// 文本显示区</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>);

    <span class="hljs-comment">// 编辑输入框</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'text'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>);

    <span class="hljs-comment">// 按钮</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'button'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'保存'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'button'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'取消'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>(); <span class="hljs-comment">// 初始为只读状态</span>
  },

  <span class="hljs-title function_">convertToText</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
  },

  <span class="hljs-title function_">convertToField</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>;
  },

  <span class="hljs-title function_">attachEvent</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToField</span>());
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">save</span>());
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cancel</span>());
  },

  <span class="hljs-title function_">save</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> value = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value === <span class="hljs-string">''</span> ? <span class="hljs-string">'这个家伙很懒，什么都没有留下'</span> : value;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 可在此处调用 API 保存到服务器</span>
  },

  <span class="hljs-title function_">cancel</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();
  }
};
</code></pre>
<h4 data-id="heading-3">✅ 使用方式</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">EditInPlace</span>(<span class="hljs-string">'signature'</span>, <span class="hljs-string">'Hello World!'</span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'app'</span>));
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">🧠 OOP 设计亮点解析</h3>
<p>这段代码虽小，却完整体现了 <strong>面向对象编程的四大核心思想</strong>：</p>
<h4 data-id="heading-5">1. <strong>封装（Encapsulation）</strong></h4>
<ul>
<li>所有状态（<code>value</code>、DOM 引用）和行为（<code>save</code>、<code>convertToText</code>）都封装在 <code>EditInPlace</code> 实例中；</li>
<li>外部只需调用构造函数，无需关心内部 DOM 如何创建或切换。</li>
</ul>
<h4 data-id="heading-6">2. <strong>抽象（Abstraction）</strong></h4>
<ul>
<li>用户看到的是“可编辑的签名”，而隐藏了“span/input 切换”、“事件绑定”等细节；</li>
<li>提供清晰的接口：点击 → 编辑 → 保存/取消。</li>
</ul>
<h4 data-id="heading-7">3. <strong>单一职责</strong></h4>
<ul>
<li><code>createElement</code> 只负责构建 DOM；</li>
<li><code>attachEvent</code> 只负责绑定事件；</li>
<li><code>save</code> 只负责处理保存逻辑。</li>
<li>各司其职，便于维护和测试。</li>
</ul>
<h4 data-id="heading-8">4. <strong>可复用性</strong></h4>
<ul>
<li>只要传入不同的 <code>id</code>、<code>value</code> 和挂载点，就能创建多个独立的编辑器实例；</li>
<li>无全局污染，实例之间互不影响。</li>
</ul>
<hr/>
<h3 data-id="heading-9">✅ 总结</h3>
<blockquote>
<p>“就地编辑”看似简单，却是 OOP 与 DOM 操作的绝佳练兵场。</p>
</blockquote>
<p>通过 <code>EditInPlace</code>，我们不仅复刻了 QQ 的经典交互，更深入理解了：</p>
<ul>
<li>如何用对象封装状态与行为；</li>
<li>如何组织可维护的原生 JS 代码；</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现UniApp登录拦截？]]></title>    <link>https://juejin.cn/post/7579066828179669028</link>    <guid>https://juejin.cn/post/7579066828179669028</guid>    <pubDate>2025-12-02T14:41:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579066828179669028" data-draft-id="7578968420043718719" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现UniApp登录拦截？"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-02T14:41:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我叫黑大帅"/> <meta itemprop="url" content="https://juejin.cn/user/1678295463898875"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现UniApp登录拦截？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1678295463898875/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我叫黑大帅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:41:35.000Z" title="Tue Dec 02 2025 14:41:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">UniApp 实现登录拦截：CS 小白入门指南</h2>
<p>登录拦截是前端权限控制的基础功能，核心目的是：未登录用户无法访问需要权限的页面（如个人中心、订单列表），同时拦截未授权的接口请求，避免敏感数据泄露或无效操作。</p>
<p>对于 CS 小白而言，UniApp 登录拦截的核心逻辑可概括为「<strong>状态校验 + 行为拦截</strong>」：通过 token 标识登录状态，拦截非法的页面跳转和接口请求，引导未登录用户前往登录页。</p>
<h3 data-id="heading-1">前置知识：什么是 Token？</h3>
<p>token 是用户登录成功后，后端返回的「身份凭证」，相当于登录后的「电子门票」。</p>
<p>后续访问需要权限的页面或接口时，前端需携带 token 证明「已登录」身份，后端验证 token 有效则允许访问，无效则拒绝。</p>
<p>token 需持久化存储（如本地存储），否则 App 重启或页面刷新后会丢失，导致用户需重新登录。</p>
<h3 data-id="heading-2">核心实现一：路由拦截（控制页面跳转）</h3>
<p>UniApp 中实现路由拦截的核心 API 是 <code>uni.addInterceptor</code>，专门用于拦截路由跳转行为（如 <code>uni.navigateTo</code>、<code>uni.redirectTo</code> 等）。</p>
<h4 data-id="heading-3">关键 API 解释</h4>
<p><code>uni.addInterceptor</code>：UniApp 内置拦截器 API，支持拦截路由、请求、上传 / 下载等行为。</p>
<ul>
<li>通过 <code>invoke</code> 回调在拦截行为执行前触发自定义逻辑（重点掌握）；</li>
<li>通过 <code>success</code> 回调在拦截行为成功后处理结果；</li>
<li>小白只需关注 <code>invoke</code> 回调即可实现基础拦截。</li>
</ul>
<h4 data-id="heading-4">基础路由拦截</h4>
<p>路由拦截需在全局生效，建议在 <code>main.js</code> 中初始化（项目入口文件，确保所有页面加载前执行）：</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 路由拦截初始化：拦截所有路由跳转</span>
 uni.<span class="hljs-title function_">addInterceptor</span>(<span class="hljs-string">'navigateTo'</span>, {
   <span class="hljs-title function_">invoke</span>(<span class="hljs-params">options</span>) {
     <span class="hljs-comment">// 1. 获取本地存储的 token（后续讲解如何存储）</span>
     <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userToken'</span>);
     <span class="hljs-comment">// 2. 判断 token 是否存在：不存在则拦截跳转，跳转至登录页</span>
     <span class="hljs-keyword">if</span> (!token) {
       <span class="hljs-comment">// 使用 redirectTo 跳转，避免用户通过返回键回到原页面</span>
       uni.<span class="hljs-title function_">redirectTo</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span> });
       <span class="hljs-comment">// 阻止原跳转行为（关键！否则会同时跳转到目标页和登录页）</span>
       <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
     }
     <span class="hljs-comment">// 3. token 存在：允许跳转（无需额外操作，默认继续执行原跳转）</span>
   }
 });
</code></pre>
<h4 data-id="heading-5">扩展：拦截所有路由类型</h4>
<p>上述代码仅拦截 <code>navigateTo</code> 跳转，实际开发中需覆盖所有路由方式（如 <code>switchTab</code> 切换底部标签、<code>reLaunch</code> 重启应用），可通过循环简化代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-comment">// 需拦截的路由类型数组（覆盖 UniApp 所有路由 API）</span>
 <span class="hljs-keyword">const</span> routeTypes = [<span class="hljs-string">'navigateTo'</span>, <span class="hljs-string">'redirectTo'</span>, <span class="hljs-string">'switchTab'</span>, <span class="hljs-string">'reLaunch'</span>, <span class="hljs-string">'navigateBack'</span>];
 ​
 <span class="hljs-comment">// 循环为所有路由类型添加拦截器</span>
 routeTypes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">type</span> =&gt;</span> {
   uni.<span class="hljs-title function_">addInterceptor</span>(<span class="hljs-keyword">type</span>, {
     <span class="hljs-title function_">invoke</span>(<span class="hljs-params">options</span>) {
       <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userToken'</span>);
       <span class="hljs-comment">// 关键：排除登录页本身，避免死循环</span>
       <span class="hljs-keyword">if</span> (!token &amp;&amp; !options.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/pages/login/login'</span>)) {
         uni.<span class="hljs-title function_">redirectTo</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span> });
         <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
       }
     }
   });
 });
</code></pre>
<h4 data-id="heading-6">避坑提醒 🚨</h4>
<p>必须排除登录页：如果不排除，未登录时跳转登录页会被自身拦截，陷入「跳转 - 拦截 - 再跳转」的死循环，这是小白最容易踩的坑。</p>
<h3 data-id="heading-7">核心实现二：本地存储 Token（持久化登录状态）</h3>
<p>登录成功后，需将后端返回的 token 存入本地，以便路由拦截、请求拦截时获取，核心 API 是 <code>uni.setStorageSync</code> 和 <code>uni.getStorageSync</code>。</p>
<h4 data-id="heading-8">关键 API 解释</h4>
<p><code>uni.setStorageSync(key, value)</code>：UniApp 同步本地存储 API。</p>
<ul>
<li>以键值对形式存入本地（类似浏览器的 <code>localStorage</code>）；</li>
<li>同步执行：代码会等待存储完成后再继续，无需处理异步回调，小白友好；</li>
<li>适合存储简单数据（如 token、用户昵称、ID）。</li>
</ul>
<p><code>uni.getStorageSync(key)</code>：同步读取本地存储数据。</p>
<ul>
<li>根据 key 读取对应 value，无数据则返回 <code>null</code> 或 <code>undefined</code>；</li>
<li>读取速度快，适合频繁获取的场景（如拦截器中获取 token）。</li>
</ul>
<p><code>uni.removeStorageSync(key)</code>：同步删除本地存储的指定 key 数据，用于退出登录时清除 token。</p>
<h4 data-id="heading-9">Token 存储与删除</h4>
<h5 data-id="heading-10">1. 登录成功后存储 Token（登录页逻辑）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"> <span class="hljs-comment">// 登录页面：用户输入账号密码后点击登录按钮的逻辑</span>
 async function login() {
   <span class="hljs-comment">// 1. 获取用户输入的账号密码（假设已通过表单绑定）</span>
   <span class="hljs-keyword">const</span> { username, password } = <span class="hljs-keyword">this</span>.userForm;
   
   <span class="hljs-comment">// 2. 调用后端登录接口（后续请求拦截会补充接口逻辑）</span>
   <span class="hljs-keyword">const</span> res = await uni.request({
     url: <span class="hljs-string">'https://api.example.com/login'</span>, <span class="hljs-comment">// 后端登录接口地址</span>
     method: <span class="hljs-string">'POST'</span>,
     <span class="hljs-keyword">data</span>: { username, password } <span class="hljs-comment">// 传递账号密码</span>
   });
   
   <span class="hljs-comment">// 3. 处理后端返回结果（假设后端约定：code=200 为成功）</span>
   <span class="hljs-keyword">if</span> (res.<span class="hljs-keyword">data</span>.code === <span class="hljs-number">200</span>) {
     <span class="hljs-comment">// 4. 存储 token 到本地，key 建议语义化（如 'userToken'）</span>
     uni.setStorageSync(<span class="hljs-string">'userToken'</span>, res.<span class="hljs-keyword">data</span>.<span class="hljs-keyword">data</span>.token);
     
     <span class="hljs-comment">// 5. 存储成功后跳转至首页或目标页面</span>
     uni.redirectTo({ url: <span class="hljs-string">'/pages/index/index'</span> });
   } <span class="hljs-keyword">else</span> {
     <span class="hljs-comment">// 登录失败：提示用户（UniApp 内置提示 API）</span>
     uni.showToast({ title: res.<span class="hljs-keyword">data</span>.msg || <span class="hljs-string">'登录失败'</span>, icon: <span class="hljs-string">'none'</span> });
   }
 }
</code></pre>
<h5 data-id="heading-11">2. 退出登录时删除 Token</h5>
<pre><code class="hljs language-php" lang="php"> <span class="hljs-comment">// 退出登录逻辑（如个人中心的退出按钮）</span>
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logout</span>(<span class="hljs-params"/>) </span>{
   <span class="hljs-comment">// 1. 清除本地存储的 token</span>
   uni.<span class="hljs-title function_ invoke__">removeStorageSync</span>(<span class="hljs-string">'userToken'</span>);
   
   <span class="hljs-comment">// 2. 跳转至登录页，关闭所有页面避免返回</span>
   uni.<span class="hljs-title function_ invoke__">reLaunch</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span> });
 }
</code></pre>
<h4 data-id="heading-12">注意事项 📌</h4>
<p>本地存储的 token 是明文存储（如 H5 端可通过浏览器开发者工具查看），切勿存储密码等敏感信息，仅存储 token 等非敏感凭证。</p>
<h3 data-id="heading-13">核心实现三：请求拦截与响应拦截（控制接口访问）</h3>
<p>路由拦截能阻止未登录用户访问页面，但无法阻止用户通过抓包工具或直接调用接口发起请求，因此需要「请求拦截 + 响应拦截」形成双重保障。</p>
<h4 data-id="heading-14">核心逻辑</h4>
<ul>
<li>请求拦截：为所有需要权限的接口自动添加 token 到请求头，让后端验证身份；</li>
<li>响应拦截：处理接口返回的错误状态（如 token 过期、未授权），强制跳转登录页。</li>
</ul>
<h4 data-id="heading-15">关键 API 解释</h4>
<p><code>uni.addInterceptor('request')</code>：拦截所有通过 <code>uni.request</code> 发起的接口请求。</p>
<ul>
<li><code>invoke</code> 回调：请求发送前执行（用于添加请求头 token）；</li>
<li><code>success</code> 回调：请求响应后执行（用于处理 401 等错误状态）；</li>
<li><code>fail</code> 回调：请求失败时执行（如网络错误）。</li>
</ul>
<h4 data-id="heading-16">1. 请求拦截：添加 Token 到请求头</h4>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 请求拦截：自动为接口添加 token</span>
 uni.<span class="hljs-title function_">addInterceptor</span>(<span class="hljs-string">'request'</span>, {
   <span class="hljs-title function_">invoke</span>(<span class="hljs-params">options</span>) {
     <span class="hljs-comment">// 1. 获取本地存储的 token</span>
     <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userToken'</span>);
     
     <span class="hljs-comment">// 2. 如果 token 存在，添加到请求头（需与后端约定字段名）</span>
     <span class="hljs-keyword">if</span> (token) {
       <span class="hljs-comment">// 初始化请求头（避免 options.header 为 undefined）</span>
       options.<span class="hljs-property">header</span> = options.<span class="hljs-property">header</span> || {};
       <span class="hljs-comment">// 常见格式：Bearer + 空格 + token（后端约定为准，也可能直接传 token）</span>
       options.<span class="hljs-property">header</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
     }
     
     <span class="hljs-comment">// 3. 无需阻止请求，仅添加配置，默认继续发送</span>
   }
 });
</code></pre>
<h4 data-id="heading-17">2. 响应拦截：处理接口错误状态</h4>
<pre><code class="hljs language-php" lang="php"> <span class="hljs-comment">// 响应拦截：处理接口返回的未授权、token 过期等状态</span>
 uni.<span class="hljs-title function_ invoke__">addInterceptor</span>(<span class="hljs-string">'request'</span>, {
   <span class="hljs-title function_ invoke__">success</span>(res) {
     // <span class="hljs-number">1</span>. 假设后端约定状态码：<span class="hljs-number">401</span>=未授权（token 无效/过期），<span class="hljs-number">403</span>=权限不足
     <span class="hljs-keyword">const</span> { code, msg } = res.data;
     
     // <span class="hljs-number">2</span>. 处理 <span class="hljs-number">401</span> 未授权：清除无效 token，跳转登录页
     <span class="hljs-keyword">if</span> (code === <span class="hljs-number">401</span>) {
       <span class="hljs-comment">// 清除本地无效 token，避免下次请求仍携带</span>
       uni.<span class="hljs-title function_ invoke__">removeStorageSync</span>(<span class="hljs-string">'userToken'</span>);
       
       <span class="hljs-comment">// 提示用户登录过期</span>
       uni.<span class="hljs-title function_ invoke__">showToast</span>({ <span class="hljs-attr">title</span>: msg || <span class="hljs-string">'登录已过期，请重新登录'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
       
       <span class="hljs-comment">// 跳转登录页（关闭所有页面，避免返回）</span>
       uni.<span class="hljs-title function_ invoke__">reLaunch</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span> });
     }
     
     <span class="hljs-comment">// 3. 处理 403 权限不足：仅提示，不跳转</span>
     <span class="hljs-keyword">if</span> (code === <span class="hljs-number">403</span>) {
       uni.<span class="hljs-title function_ invoke__">showToast</span>({ <span class="hljs-attr">title</span>: msg || <span class="hljs-string">'暂无权限访问'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
     }
   },
   <span class="hljs-title function_ invoke__">fail</span>(err) {
     <span class="hljs-comment">// 处理网络错误等请求失败场景</span>
     uni.<span class="hljs-title function_ invoke__">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'网络错误，请稍后重试'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
   }
 });
</code></pre>
<h4 data-id="heading-18">避坑提醒 📌</h4>
<p>请求头的 token 字段名需与后端严格约定：大多数后端使用 <code>Authorization</code> 作为字段名，格式为 <code>Bearer + 空格 + token</code>；若后端要求直接传 token（如 <code>header: { token: 'xxx' }</code>），需按后端规则修改，否则后端无法识别。</p>
<h3 data-id="heading-19">核心实现四：页面级权限校验（兜底方案）</h3>
<p>路由拦截和请求拦截已能覆盖大部分场景，但存在特殊情况（如 H5 端页面刷新后路由拦截未触发），因此需要在页面加载时添加「兜底校验」。</p>
<h4 data-id="heading-20">关键生命周期解释</h4>
<p><code>onLoad</code>：UniApp 页面生命周期函数，页面加载时触发（仅触发一次）。</p>
<ul>
<li>适合在页面初始化时执行权限校验；</li>
<li>即使路由拦截失效，页面级校验仍能生效，避免未登录用户停留在权限页面。</li>
</ul>
<h4 data-id="heading-21">页面级校验</h4>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 需权限的页面（如个人中心 pages/mine/mine.vue）</span>
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
   <span class="hljs-comment">// 页面加载时执行校验</span>
   <span class="hljs-title function_">onLoad</span>(<span class="hljs-params"/>) {
     <span class="hljs-comment">// 1. 获取本地 token</span>
     <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userToken'</span>);
     
     <span class="hljs-comment">// 2. 无 token 则跳转登录页，关闭当前页面</span>
     <span class="hljs-keyword">if</span> (!token) {
       uni.<span class="hljs-title function_">redirectTo</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span> });
     }
   }
 };
</code></pre>
<h4 data-id="heading-22">适用场景 🚀</h4>
<ul>
<li>H5 端：用户按 F5 刷新页面后，路由拦截可能未重新执行，<code>onLoad</code> 校验会生效；</li>
<li>小程序端：页面被分享后，用户打开时可能跳过路由拦截，需通过页面级校验兜底。</li>
</ul>
<h3 data-id="heading-23">进阶优化：小白也能掌握的实用技巧</h3>
<p>基础登录拦截实现后，可通过以下优化让功能更稳定，应对实际开发中的复杂场景。</p>
<h4 data-id="heading-24">1. 白名单配置（简化拦截逻辑）</h4>
<p>部分页面 / 接口无需登录即可访问（如首页、注册页、登录接口本身），可通过「白名单」统一管理，避免在拦截器中写大量判断。</p>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-comment">// 1. 页面白名单：无需登录即可访问的页面路径</span>
 <span class="hljs-keyword">const</span> pageWhiteList = [
   <span class="hljs-string">'/pages/login/login'</span>, <span class="hljs-comment">// 登录页</span>
   <span class="hljs-string">'/pages/register/register'</span>, <span class="hljs-comment">// 注册页</span>
   <span class="hljs-string">'/pages/index/index'</span> <span class="hljs-comment">// 首页</span>
 ];
 ​
 <span class="hljs-comment">// 2. 接口白名单：无需 token 即可访问的接口地址</span>
 <span class="hljs-keyword">const</span> apiWhiteList = [
   <span class="hljs-string">'/login'</span>, <span class="hljs-comment">// 登录接口</span>
   <span class="hljs-string">'/register'</span>, <span class="hljs-comment">// 注册接口</span>
   <span class="hljs-string">'/home/banner'</span> <span class="hljs-comment">// 首页轮播图接口</span>
 ];
 ​
 <span class="hljs-comment">// 3. 路由拦截中使用页面白名单</span>
 routeTypes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">type</span> =&gt;</span> {
   uni.<span class="hljs-title function_">addInterceptor</span>(<span class="hljs-keyword">type</span>, {
     <span class="hljs-title function_">invoke</span>(<span class="hljs-params">options</span>) {
       <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userToken'</span>);
       <span class="hljs-comment">// 校验逻辑：不在白名单 + 无 token → 跳转登录页</span>
       <span class="hljs-keyword">if</span> (!pageWhiteList.<span class="hljs-title function_">includes</span>(options.<span class="hljs-property">url</span>) &amp;&amp; !token) {
         uni.<span class="hljs-title function_">redirectTo</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span> });
         <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
       }
     }
   });
 });
 ​
 <span class="hljs-comment">// 4. 请求拦截中使用接口白名单</span>
 uni.<span class="hljs-title function_">addInterceptor</span>(<span class="hljs-string">'request'</span>, {
   <span class="hljs-title function_">invoke</span>(<span class="hljs-params">options</span>) {
     <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'userToken'</span>);
     <span class="hljs-comment">// 校验逻辑：不在白名单 + 有 token → 添加 token 到请求头</span>
     <span class="hljs-keyword">if</span> (!apiWhiteList.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">api</span> =&gt;</span> options.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(api)) &amp;&amp; token) {
       options.<span class="hljs-property">header</span> = options.<span class="hljs-property">header</span> || {};
       options.<span class="hljs-property">header</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
     }
   }
 });
</code></pre>
<h4 data-id="heading-25">2. 避免重复跳转登录页（锁机制）</h4>
<p>当用户快速点击多个需要权限的按钮时，可能触发多次路由拦截，导致多次跳转登录页，需通过「锁机制」避免。</p>
<pre><code class="hljs language-ini" lang="ini"> // 定义全局锁：标记是否已在跳转登录页
 let <span class="hljs-attr">isRedirecting</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
 ​
 // 路由拦截中添加锁逻辑
 routeTypes.forEach(<span class="hljs-attr">type</span> =&gt; {
   uni.addInterceptor(type, {
     invoke(options) {
       const <span class="hljs-attr">token</span> = uni.getStorageSync(<span class="hljs-string">'userToken'</span>)<span class="hljs-comment">;</span>
       if (!token &amp;&amp; !options.url.includes('/pages/login/login')) {
         // 未在跳转中才执行跳转
         if (!isRedirecting) {
           <span class="hljs-attr">isRedirecting</span> = <span class="hljs-literal">true</span><span class="hljs-comment">; // 上锁</span>
           uni.redirectTo({
             url: '/pages/login/login',
             success() {
               <span class="hljs-attr">isRedirecting</span> = <span class="hljs-literal">false</span><span class="hljs-comment">; // 跳转成功后解锁</span>
             }
           })<span class="hljs-comment">;</span>
         }
         return false<span class="hljs-comment">;</span>
       }
     }
   })<span class="hljs-comment">;</span>
 })<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-26">3. Token 过期处理（刷新 Token）</h4>
<p>token 有有效期（如 2 小时），过期后需重新登录，影响用户体验，可通过「刷新 token」优化：后端返回两个 token（短期访问令牌 <code>accessToken</code> + 长期刷新令牌 <code>refreshToken</code>），到期前自动用 <code>refreshToken</code> 换取新的 <code>accessToken</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 登录成功后存储两个 token</span>
 <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
   <span class="hljs-keyword">const</span> { accessToken, refreshToken, expiresIn } = res.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>;
   uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'accessToken'</span>, accessToken); <span class="hljs-comment">// 短期访问令牌（2小时）</span>
   uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'refreshToken'</span>, refreshToken); <span class="hljs-comment">// 长期刷新令牌（7天）</span>
   <span class="hljs-comment">// 存储过期时间（当前时间 + 有效期毫秒数）</span>
   uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'tokenExpireTime'</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + expiresIn * <span class="hljs-number">1000</span>);
 }
 ​
 <span class="hljs-comment">// 请求拦截中添加刷新 token 逻辑</span>
 uni.<span class="hljs-title function_">addInterceptor</span>(<span class="hljs-string">'request'</span>, {
   <span class="hljs-keyword">async</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params">options</span>) {
     <span class="hljs-keyword">const</span> accessToken = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'accessToken'</span>);
     <span class="hljs-keyword">const</span> refreshToken = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'refreshToken'</span>);
     <span class="hljs-keyword">const</span> expireTime = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'tokenExpireTime'</span>);
     
     <span class="hljs-comment">// 跳过白名单接口</span>
     <span class="hljs-keyword">if</span> (apiWhiteList.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">api</span> =&gt;</span> options.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(api))) <span class="hljs-keyword">return</span>;
     
     <span class="hljs-comment">// token 即将过期（剩余 5 分钟）且有刷新令牌，自动刷新</span>
     <span class="hljs-keyword">if</span> (accessToken &amp;&amp; expireTime - <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &lt; <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> &amp;&amp; refreshToken) {
       <span class="hljs-keyword">const</span> refreshRes = <span class="hljs-keyword">await</span> uni.<span class="hljs-title function_">request</span>({
         <span class="hljs-attr">url</span>: <span class="hljs-string">'https://api.example.com/refreshToken'</span>, <span class="hljs-comment">// 后端刷新接口</span>
         <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
         <span class="hljs-attr">data</span>: { refreshToken }
       });
       
       <span class="hljs-keyword">if</span> (refreshRes.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
         <span class="hljs-comment">// 刷新成功：更新本地 token 和过期时间</span>
         uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'accessToken'</span>,&lt;/doubaocanvas&gt;
</code></pre>
<blockquote>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Sequelize 详细指南]]></title>    <link>https://juejin.cn/post/7579093412331569162</link>    <guid>https://juejin.cn/post/7579093412331569162</guid>    <pubDate>2025-12-02T14:10:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579093412331569162" data-draft-id="7579068270294777882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Sequelize 详细指南"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-02T14:10:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="写代码的皮筏艇"/> <meta itemprop="url" content="https://juejin.cn/user/4196178024218520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Sequelize 详细指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4196178024218520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    写代码的皮筏艇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:10:17.000Z" title="Tue Dec 02 2025 14:10:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Sequelize 详细指南</h2>
<p>最近在工作中遇到了使用JS去完成service层的业务逻辑，以及数据库操作，现在下来补课</p>
<h3 data-id="heading-1">一、什么是 Sequelize？</h3>
<p><strong>Sequelize</strong> 是一个基于 Node.js 的 ORM（对象关系映射）工具，用于在 Node.js 环境中操作关系型数据库。它支持多种数据库系统，包括：</p>
<ul>
<li>PostgreSQL</li>
<li>MySQL</li>
<li>MariaDB</li>
<li>SQLite</li>
<li>Microsoft SQL Server</li>
</ul>
<h3 data-id="heading-2">二、核心特性</h3>
<h4 data-id="heading-3">1. 多数据库支持</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">Sequelize</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sequelize'</span>);

<span class="hljs-comment">// 连接不同数据库</span>
<span class="hljs-keyword">const</span> sequelize = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sequelize</span>(<span class="hljs-string">'database'</span>, <span class="hljs-string">'username'</span>, <span class="hljs-string">'password'</span>, {
  <span class="hljs-attr">dialect</span>: <span class="hljs-string">'mysql'</span>, <span class="hljs-comment">// 或 'postgres', 'sqlite', 'mssql'</span>
  <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-number">3306</span>
});
</code></pre>
<h4 data-id="heading-4">2. 模型定义</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">DataTypes</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sequelize'</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title class_">User</span> = sequelize.<span class="hljs-title function_">define</span>(<span class="hljs-string">'User'</span>, {
  <span class="hljs-attr">id</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">INTEGER</span>,
    <span class="hljs-attr">primaryKey</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">autoIncrement</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">username</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">DataTypes</span>.<span class="hljs-title function_">STRING</span>(<span class="hljs-number">50</span>),
    <span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">email</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">STRING</span>,
    <span class="hljs-attr">validate</span>: {
      <span class="hljs-attr">isEmail</span>: <span class="hljs-literal">true</span>
    }
  },
  <span class="hljs-attr">age</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">INTEGER</span>,
    <span class="hljs-attr">defaultValue</span>: <span class="hljs-number">18</span>
  },
  <span class="hljs-attr">isActive</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">BOOLEAN</span>,
    <span class="hljs-attr">defaultValue</span>: <span class="hljs-literal">true</span>
  }
}, {
  <span class="hljs-attr">tableName</span>: <span class="hljs-string">'users'</span>, <span class="hljs-comment">// 自定义表名</span>
  <span class="hljs-attr">timestamps</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 自动添加 createdAt 和 updatedAt</span>
  <span class="hljs-attr">paranoid</span>: <span class="hljs-literal">true</span>      <span class="hljs-comment">// 软删除（添加 deletedAt）</span>
});
</code></pre>
<p>其中定义模型时还有很多其他属性，可以自行查阅</p>
<h4 data-id="heading-5">3. 关联关系</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 一对一</span>
<span class="hljs-title class_">User</span>.<span class="hljs-title function_">hasOne</span>(<span class="hljs-title class_">Profile</span>);
<span class="hljs-title class_">Profile</span>.<span class="hljs-title function_">belongsTo</span>(<span class="hljs-title class_">User</span>);

<span class="hljs-comment">// 一对多</span>
<span class="hljs-title class_">User</span>.<span class="hljs-title function_">hasMany</span>(<span class="hljs-title class_">Post</span>);
<span class="hljs-title class_">Post</span>.<span class="hljs-title function_">belongsTo</span>(<span class="hljs-title class_">User</span>);

<span class="hljs-comment">// 多对多</span>
<span class="hljs-title class_">User</span>.<span class="hljs-title function_">belongsToMany</span>(<span class="hljs-title class_">Role</span>, { <span class="hljs-attr">through</span>: <span class="hljs-string">'UserRoles'</span> });
<span class="hljs-title class_">Role</span>.<span class="hljs-title function_">belongsToMany</span>(<span class="hljs-title class_">User</span>, { <span class="hljs-attr">through</span>: <span class="hljs-string">'UserRoles'</span> });
</code></pre>
<p>其中定义关联关系时，可以根据表与表之间的外键进行关联</p>
<h4 data-id="heading-6">3. 关联关系</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 一对一</span>
<span class="hljs-title class_">Profile</span>.<span class="hljs-title function_">belongsTo</span>(<span class="hljs-title class_">User</span>, {
  <span class="hljs-attr">foreignKey</span>: <span class="hljs-string">'userId'</span>, <span class="hljs-comment">// Profile 表中的外键字段名</span>
  <span class="hljs-attr">targetKey</span>: <span class="hljs-string">'id'</span>       <span class="hljs-comment">// 引用 User 表的哪个字段（默认是主键）</span>
});

<span class="hljs-comment">// 还有很多其他属性</span>
</code></pre>
<h3 data-id="heading-7">三、基本使用</h3>
<h4 data-id="heading-8">1. 安装与配置</h4>
<pre><code class="hljs language-bash" lang="bash">npm install sequelize
<span class="hljs-comment"># 安装对应的数据库驱动</span>
npm install pg pg-hstore       <span class="hljs-comment"># PostgreSQL</span>
npm install mysql2             <span class="hljs-comment"># MySQL</span>
npm install mariadb            <span class="hljs-comment"># MariaDB</span>
npm install sqlite3            <span class="hljs-comment"># SQLite</span>
npm install tedious            <span class="hljs-comment"># SQL Server</span>
</code></pre>
<h4 data-id="heading-9">2. 连接数据库</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">Sequelize</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sequelize'</span>);

<span class="hljs-keyword">const</span> sequelize = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sequelize</span>({
  <span class="hljs-attr">database</span>: <span class="hljs-string">'my_database'</span>,
  <span class="hljs-attr">username</span>: <span class="hljs-string">'root'</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">'password'</span>,
  <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>,
  <span class="hljs-attr">dialect</span>: <span class="hljs-string">'mysql'</span>,
  
  <span class="hljs-comment">// 连接池配置</span>
  <span class="hljs-attr">pool</span>: {
    <span class="hljs-attr">max</span>: <span class="hljs-number">5</span>,
    <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">acquire</span>: <span class="hljs-number">30000</span>,
    <span class="hljs-attr">idle</span>: <span class="hljs-number">10000</span>
  },
  
  <span class="hljs-comment">// 日志配置</span>
  <span class="hljs-attr">logging</span>: <span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>, <span class="hljs-comment">// 或 false 禁用日志</span>
  
  <span class="hljs-comment">// 时区配置</span>
  <span class="hljs-attr">timezone</span>: <span class="hljs-string">'+08:00'</span>
});
</code></pre>
<h4 data-id="heading-10">3. 测试连接</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testConnection</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> sequelize.<span class="hljs-title function_">authenticate</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接成功！'</span>);
    
    <span class="hljs-comment">// 同步模型到数据库</span>
    <span class="hljs-keyword">await</span> sequelize.<span class="hljs-title function_">sync</span>({ <span class="hljs-attr">force</span>: <span class="hljs-literal">false</span> }); <span class="hljs-comment">// force: true 会删除现有表</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'连接失败:'</span>, error);
  }
}
</code></pre>
<h3 data-id="heading-11">四、CRUD 操作</h3>
<h4 data-id="heading-12">1. 创建记录</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法一：使用 create</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">username</span>: <span class="hljs-string">'john_doe'</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">'john@example.com'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
});

<span class="hljs-comment">// 方法二：先构建后保存</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-title class_">User</span>.<span class="hljs-title function_">build</span>({
  <span class="hljs-attr">username</span>: <span class="hljs-string">'jane_doe'</span>
});
<span class="hljs-keyword">await</span> user.<span class="hljs-title function_">save</span>();

<span class="hljs-comment">// 批量创建</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">bulkCreate</span>([
  { <span class="hljs-attr">username</span>: <span class="hljs-string">'user1'</span> },
  { <span class="hljs-attr">username</span>: <span class="hljs-string">'user2'</span> }
]);
</code></pre>
<h4 data-id="heading-13">2. 查询记录</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 查询所有</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findAll</span>();

<span class="hljs-comment">// 条件查询</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOne</span>({
  <span class="hljs-attr">where</span>: {
    <span class="hljs-attr">username</span>: <span class="hljs-string">'john_doe'</span>,
    <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span>
  }
});

<span class="hljs-comment">// 使用运算符</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findAll</span>({
  <span class="hljs-attr">where</span>: {
    <span class="hljs-attr">age</span>: {
      [<span class="hljs-title class_">Op</span>.<span class="hljs-property">gt</span>]: <span class="hljs-number">18</span>,      <span class="hljs-comment">// 大于</span>
      [<span class="hljs-title class_">Op</span>.<span class="hljs-property">lte</span>]: <span class="hljs-number">65</span>      <span class="hljs-comment">// 小于等于</span>
    },
    <span class="hljs-attr">username</span>: {
      [<span class="hljs-title class_">Op</span>.<span class="hljs-property">like</span>]: <span class="hljs-string">'%john%'</span> <span class="hljs-comment">// 模糊查询</span>
    }
  }
});

<span class="hljs-comment">// 排序和分页</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findAll</span>({
  <span class="hljs-attr">order</span>: [[<span class="hljs-string">'createdAt'</span>, <span class="hljs-string">'DESC'</span>]],
  <span class="hljs-attr">limit</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">offset</span>: <span class="hljs-number">20</span>
});

<span class="hljs-comment">// 选择特定字段</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findAll</span>({
  <span class="hljs-attr">attributes</span>: [<span class="hljs-string">'id'</span>, <span class="hljs-string">'username'</span>, <span class="hljs-string">'email'</span>]
});
</code></pre>
<h4 data-id="heading-14">3. 更新记录</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法一：先查询后更新</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findByPk</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">if</span> (user) {
  user.<span class="hljs-property">username</span> = <span class="hljs-string">'new_name'</span>;
  <span class="hljs-keyword">await</span> user.<span class="hljs-title function_">save</span>();
}

<span class="hljs-comment">// 方法二：直接更新</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">update</span>(
  { <span class="hljs-attr">username</span>: <span class="hljs-string">'new_name'</span> },
  { <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> } }
);

<span class="hljs-comment">// 更新多个</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">update</span>(
  { <span class="hljs-attr">isActive</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">where</span>: { <span class="hljs-attr">age</span>: { [<span class="hljs-title class_">Op</span>.<span class="hljs-property">lt</span>]: <span class="hljs-number">18</span> } } }
);
</code></pre>
<h4 data-id="heading-15">4. 删除记录</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 软删除（如果启用了 paranoid）</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">destroy</span>({
  <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> }
});

<span class="hljs-comment">// 强制删除（即使启用了 paranoid）</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">destroy</span>({
  <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> },
  <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span>
});

<span class="hljs-comment">// 删除多个</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">destroy</span>({
  <span class="hljs-attr">where</span>: { <span class="hljs-attr">isActive</span>: <span class="hljs-literal">false</span> }
});
</code></pre>
<h3 data-id="heading-16">五、高级查询</h3>
<h4 data-id="heading-17">1. 关联查询</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 包含关联数据</span>
<span class="hljs-keyword">const</span> userWithPosts = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findByPk</span>(<span class="hljs-number">1</span>, {
  <span class="hljs-attr">include</span>: [{
    <span class="hljs-attr">model</span>: <span class="hljs-title class_">Post</span>,
    <span class="hljs-attr">include</span>: [<span class="hljs-title class_">Comment</span>] <span class="hljs-comment">// 嵌套包含</span>
  }]
});

<span class="hljs-comment">// 过滤关联数据</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findByPk</span>(<span class="hljs-number">1</span>, {
  <span class="hljs-attr">include</span>: [{
    <span class="hljs-attr">model</span>: <span class="hljs-title class_">Post</span>,
    <span class="hljs-attr">where</span>: { <span class="hljs-attr">published</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// LEFT JOIN</span>
  }]
});
</code></pre>
<h4 data-id="heading-18">2. 聚合查询</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 计数</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">count</span>({
  <span class="hljs-attr">where</span>: { <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span> }
});

<span class="hljs-comment">// 求和、平均值等</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findAll</span>({
  <span class="hljs-attr">attributes</span>: [
    <span class="hljs-string">'department'</span>,
    [sequelize.<span class="hljs-title function_">fn</span>(<span class="hljs-string">'COUNT'</span>, sequelize.<span class="hljs-title function_">col</span>(<span class="hljs-string">'id'</span>)), <span class="hljs-string">'count'</span>],
    [sequelize.<span class="hljs-title function_">fn</span>(<span class="hljs-string">'AVG'</span>, sequelize.<span class="hljs-title function_">col</span>(<span class="hljs-string">'salary'</span>)), <span class="hljs-string">'avg_salary'</span>]
  ],
  <span class="hljs-attr">group</span>: [<span class="hljs-string">'department'</span>]
});
</code></pre>
<h4 data-id="heading-19">3. 事务处理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> transaction = <span class="hljs-keyword">await</span> sequelize.<span class="hljs-title function_">transaction</span>();

<span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 在事务中执行操作</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">'alice'</span>
  }, { transaction });

  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Profile</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">userId</span>: user.<span class="hljs-property">id</span>,
    <span class="hljs-attr">bio</span>: <span class="hljs-string">'Hello world'</span>
  }, { transaction });

  <span class="hljs-comment">// 提交事务</span>
  <span class="hljs-keyword">await</span> transaction.<span class="hljs-title function_">commit</span>();
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 回滚事务</span>
  <span class="hljs-keyword">await</span> transaction.<span class="hljs-title function_">rollback</span>();
}
</code></pre>
<h3 data-id="heading-20">六、钩子（Hooks）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">User</span>.<span class="hljs-title function_">beforeCreate</span>(<span class="hljs-keyword">async</span> (user, options) =&gt; {
  user.<span class="hljs-property">username</span> = user.<span class="hljs-property">username</span>.<span class="hljs-title function_">toLowerCase</span>();
});

<span class="hljs-title class_">User</span>.<span class="hljs-title function_">afterCreate</span>(<span class="hljs-keyword">async</span> (user, options) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`用户 <span class="hljs-subst">${user.username}</span> 已创建`</span>);
});

<span class="hljs-title class_">User</span>.<span class="hljs-title function_">beforeUpdate</span>(<span class="hljs-keyword">async</span> (user, options) =&gt; {
  user.<span class="hljs-property">updatedAt</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
});

<span class="hljs-title class_">User</span>.<span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-keyword">async</span> (user, options) =&gt; {
  <span class="hljs-comment">// 删除前的清理操作</span>
});
</code></pre>
<h3 data-id="heading-21">七、数据验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">User</span> = sequelize.<span class="hljs-title function_">define</span>(<span class="hljs-string">'User'</span>, {
  <span class="hljs-attr">email</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">STRING</span>,
    <span class="hljs-attr">validate</span>: {
      <span class="hljs-attr">isEmail</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">isLowercase</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">len</span>: [<span class="hljs-number">5</span>, <span class="hljs-number">100</span>]
    }
  },
  <span class="hljs-attr">age</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">INTEGER</span>,
    <span class="hljs-attr">validate</span>: {
      <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">max</span>: <span class="hljs-number">150</span>,
      <span class="hljs-title function_">isEven</span>(<span class="hljs-params">value</span>) {
        <span class="hljs-keyword">if</span> (value % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'年龄必须是偶数'</span>);
        }
      }
    }
  }
});

<span class="hljs-comment">// 自定义验证消息</span>
<span class="hljs-attr">validate</span>: {
  <span class="hljs-attr">isEmail</span>: {
    <span class="hljs-attr">msg</span>: <span class="hljs-string">'请输入有效的邮箱地址'</span>
  }
}
</code></pre>
<h3 data-id="heading-22">八、迁移与种子数据</h3>
<h4 data-id="heading-23">1. 使用 Sequelize CLI</h4>
<pre><code class="hljs language-bash" lang="bash">npm install --save-dev sequelize-cli
npx sequelize-cli init
</code></pre>
<h4 data-id="heading-24">2. 创建迁移文件</h4>
<pre><code class="hljs language-bash" lang="bash">npx sequelize-cli migration:generate --name create-users-table
</code></pre>
<h4 data-id="heading-25">3. 迁移文件示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">up</span>: <span class="hljs-keyword">async</span> (queryInterface, <span class="hljs-title class_">Sequelize</span>) =&gt; {
    <span class="hljs-keyword">await</span> queryInterface.<span class="hljs-title function_">createTable</span>(<span class="hljs-string">'Users'</span>, {
      <span class="hljs-attr">id</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Sequelize</span>.<span class="hljs-property">INTEGER</span>,
        <span class="hljs-attr">primaryKey</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">autoIncrement</span>: <span class="hljs-literal">true</span>
      },
      <span class="hljs-attr">username</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Sequelize</span>.<span class="hljs-property">STRING</span>,
        <span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>
      },
      <span class="hljs-attr">createdAt</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Sequelize</span>.<span class="hljs-property">DATE</span>,
        <span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>
      },
      <span class="hljs-attr">updatedAt</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Sequelize</span>.<span class="hljs-property">DATE</span>,
        <span class="hljs-attr">allowNull</span>: <span class="hljs-literal">false</span>
      }
    });
  },

  <span class="hljs-attr">down</span>: <span class="hljs-keyword">async</span> (queryInterface, <span class="hljs-title class_">Sequelize</span>) =&gt; {
    <span class="hljs-keyword">await</span> queryInterface.<span class="hljs-title function_">dropTable</span>(<span class="hljs-string">'Users'</span>);
  }
};
</code></pre>
<h3 data-id="heading-26">九、性能优化</h3>
<h4 data-id="heading-27">1. 连接池配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sequelize = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sequelize</span>({
  <span class="hljs-comment">// ... 其他配置</span>
  <span class="hljs-attr">pool</span>: {
    <span class="hljs-attr">max</span>: <span class="hljs-number">20</span>,        <span class="hljs-comment">// 最大连接数</span>
    <span class="hljs-attr">min</span>: <span class="hljs-number">5</span>,         <span class="hljs-comment">// 最小连接数</span>
    <span class="hljs-attr">acquire</span>: <span class="hljs-number">30000</span>, <span class="hljs-comment">// 获取连接的超时时间</span>
    <span class="hljs-attr">idle</span>: <span class="hljs-number">10000</span>     <span class="hljs-comment">// 连接空闲时间</span>
  }
});
</code></pre>
<h4 data-id="heading-28">2. 查询优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 只选择需要的字段</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findAll</span>({
  <span class="hljs-attr">attributes</span>: [<span class="hljs-string">'id'</span>, <span class="hljs-string">'username'</span>]
});

<span class="hljs-comment">// 使用原生查询处理复杂查询</span>
<span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> sequelize.<span class="hljs-title function_">query</span>(
  <span class="hljs-string">'SELECT * FROM users WHERE age &gt; :age'</span>,
  {
    <span class="hljs-attr">replacements</span>: { <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> },
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">QueryTypes</span>.<span class="hljs-property">SELECT</span>
  }
);
</code></pre>
<h4 data-id="heading-29">3. 索引优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">User</span>.<span class="hljs-title function_">init</span>({
  <span class="hljs-comment">// ... 字段定义</span>
}, {
  sequelize,
  <span class="hljs-attr">indexes</span>: [
    {
      <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">fields</span>: [<span class="hljs-string">'email'</span>]
    },
    {
      <span class="hljs-attr">fields</span>: [<span class="hljs-string">'createdAt'</span>]
    }
  ]
});
</code></pre>
<h3 data-id="heading-30">十、最佳实践</h3>
<ol>
<li><strong>模型组织</strong>：将模型定义放在单独的文件中</li>
<li><strong>错误处理</strong>：统一处理数据库错误</li>
<li><strong>环境配置</strong>：使用不同环境的配置</li>
<li><strong>定期维护</strong>：清理旧数据，优化索引</li>
<li><strong>监控</strong>：监控查询性能和连接状态</li>
</ol>
<h3 data-id="heading-31">十一、常见问题</h3>
<h4 data-id="heading-32">1. N+1 查询问题</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不好的做法：会导致 N+1 查询</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findAll</span>();
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> user <span class="hljs-keyword">of</span> users) {
  <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> user.<span class="hljs-title function_">getPosts</span>(); <span class="hljs-comment">// 每次循环都查询数据库</span>
}

<span class="hljs-comment">// 好的做法：使用预加载</span>
<span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findAll</span>({
  <span class="hljs-attr">include</span>: [<span class="hljs-title class_">Post</span>]
});
</code></pre>
<h4 data-id="heading-33">2. 数据类型映射</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Sequelize 数据类型对应关系</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">STRING</span>      <span class="hljs-comment">// VARCHAR(255)</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-title function_">STRING</span>(<span class="hljs-number">50</span>)  <span class="hljs-comment">// VARCHAR(50)</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">TEXT</span>        <span class="hljs-comment">// TEXT</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">INTEGER</span>     <span class="hljs-comment">// INTEGER</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">BIGINT</span>      <span class="hljs-comment">// BIGINT</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">FLOAT</span>       <span class="hljs-comment">// FLOAT</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">DOUBLE</span>      <span class="hljs-comment">// DOUBLE</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">DECIMAL</span>     <span class="hljs-comment">// DECIMAL</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">DATE</span>        <span class="hljs-comment">// DATETIME</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">BOOLEAN</span>     <span class="hljs-comment">// TINYINT(1)</span>
<span class="hljs-title class_">DataTypes</span>.<span class="hljs-property">JSON</span>        <span class="hljs-comment">// JSON (仅限 MySQL 5.7+、PostgreSQL、SQLite)</span>
</code></pre>
<h3 data-id="heading-34">总结</h3>
<p>Sequelize 是一个功能强大的 ORM 工具，它提供了：</p>
<ul>
<li>简洁的 API 进行数据库操作</li>
<li>强大的关联关系支持</li>
<li>数据验证和钩子机制</li>
<li>事务支持和迁移功能</li>
<li>多数据库兼容性</li>
</ul>
<p>通过合理使用 Sequelize，可以大大提高 Node.js 应用中数据库操作的开发效率和代码质量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[21.Kotlin 接口：接口 (Interface)：抽象方法、属性与默认实现]]></title>    <link>https://juejin.cn/post/7579066828179619876</link>    <guid>https://juejin.cn/post/7579066828179619876</guid>    <pubDate>2025-12-02T14:30:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579066828179619876" data-draft-id="7578968420043636799" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="21.Kotlin 接口：接口 (Interface)：抽象方法、属性与默认实现"/> <meta itemprop="keywords" content="Android,Kotlin,后端"/> <meta itemprop="datePublished" content="2025-12-02T14:30:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            21.Kotlin 接口：接口 (Interface)：抽象方法、属性与默认实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:30:42.000Z" title="Tue Dec 02 2025 14:30:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<p><strong>Kotlin 官方对接口的完整定义（逐句拆解）</strong></p>
<p>Kotlin 官方文档中对接口的核心定义及关键描述如下（整合官方核心表述，保持原文语义）：</p>
<blockquote>
<p>Interfaces in Kotlin are similar to Java 8 interfaces. They can contain abstract methods, as well as method implementations. What makes them different from abstract classes is that interfaces cannot store state. They can have properties but these need to be abstract or provide accessor implementations that do not reference a backing field.An interface is defined using the keyword interface.Interfaces can inherit from other interfaces, and a class can implement multiple interfaces.</p>
</blockquote>
<p><strong>官方强调的 5 个核心点（记住这 5 条就掌握了接口本质）：</strong></p>
<ol>
<li>接口本质是「行为契约」，支持抽象方法 + 默认实现方法（类似 Java 8 接口）</li>
<li>接口<strong>不能存储状态</strong>：可声明属性，但必须是抽象属性（无初始值），或提供不依赖后端字段（backing field）的访问器（getter/setter）实现</li>
<li>接口用 <code>interface</code> 关键字定义，语法简洁无构造器（不能实例化）</li>
<li>支持<strong>多继承 / 多实现</strong>：接口可继承多个其他接口，一个类可实现多个接口</li>
<li>与抽象类的核心区别：无状态、支持多实现，不参与类的单继承体系</li>
</ol>
<p><strong>一句话总结：</strong></p>
<p><strong>接口是无状态的行为契约，通过抽象方法定义必须实现的能力，通过默认实现复用通用逻辑，支持多实现以灵活扩展类的能力集</strong>。</p>
<h3 data-id="heading-1">1.1 接口的核心定位</h3>
<p>接口（Interface）是面向对象编程中“契约”精神的体现。它定义了一组<strong>行为规范</strong>（Can-Do），而不关心具体的实现细节。通过接口，我们可以实现<strong>多态</strong>，将类的定义与具体的行为解耦，使系统架构更加灵活。</p>
<h3 data-id="heading-2">1.2 Kotlin 接口的设计优势</h3>
<p>相比于传统的 Java 接口，Kotlin 接口更加强大和灵活：</p>
<ul>
<li><strong>默认实现</strong>：允许接口提供方法的默认逻辑，减少样板代码。</li>
<li><strong>抽象属性</strong>：接口不仅能定义行为，还能规范“状态”的访问方式（尽管不能存储状态）。</li>
<li><strong>多重继承支持</strong>：完善的冲突解决机制，让类可以安全地实现多个接口。</li>
</ul>
<h3 data-id="heading-3">1.3 核心疑问：Kotlin 接口与 Java 接口、抽象类有何本质区别？</h3>
<blockquote>
<p>“为什么 Kotlin 接口里可以写方法体？”“接口里定义的属性和类里的属性是一回事吗？”</p>
</blockquote>
<p>本质区别在于：<strong>接口不能保存状态（State），而抽象类可以。</strong> 即使 Kotlin 接口看起来像类，但它永远无法直接存储值（没有 Backing Field）。</p>
<h3 data-id="heading-4">1.4 本文核心内容预告</h3>
<p>本文将按照以下路径深入剖析：</p>
<ol>
<li><strong>基础定义</strong>：语法与规则。</li>
<li><strong>三大核心</strong>：抽象方法、抽象属性、默认实现。</li>
<li><strong>实战场景</strong>：多实现与冲突解决。</li>
<li><strong>对比辨析</strong>：vs Java 接口 &amp; 抽象类。</li>
</ol>
<h2 data-id="heading-5">二、接口基础：定义与语法规范</h2>
<h3 data-id="heading-6">2.1 基本语法</h3>
<p>使用 <strong><code>interface</code></strong> 关键字定义，接口<strong>没有构造函数</strong>（因为它是无状态的）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyInterface</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bar</span><span class="hljs-params">()</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 可选的方法体</span>
    }
}

</code></pre>
<h3 data-id="heading-7">2.2 核心规则</h3>
<ul>
<li><strong>可以包含</strong>：抽象方法、默认方法（带方法体）、抽象属性。</li>
<li><strong>不能包含</strong>：状态字段（Backing Fields）、构造函数。</li>
<li><strong>实例化</strong>：接口不能直接实例化，必须通过类实现或匿名内部类（object expression）创建。</li>
</ul>
<h3 data-id="heading-8">2.3 简单示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Displayable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span> <span class="hljs-comment">// 抽象方法</span>
}
</code></pre>
<h3 data-id="heading-9">2.4 关键特性</h3>
<ul>
<li><strong>多实现</strong>：一个类可以实现多个接口（解决单继承限制）。</li>
<li><strong>接口继承</strong>：接口可以继承其他接口。</li>
</ul>
<h2 data-id="heading-10">三、接口核心组成（一）：抽象方法</h2>
<h3 data-id="heading-11">3.1 定义语法</h3>
<p>在接口中直接声明方法，如果没有提供方法体 <code>{ ... }</code>，它默认就是 <strong><code>abstract</code></strong> 的（无需显式写 abstract 关键字）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Clickable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">()</span></span> <span class="hljs-comment">// 这是一个抽象方法</span>
}
</code></pre>
<h3 data-id="heading-12">3.2 核心要求</h3>
<p>实现该接口的<strong>非抽象类</strong>，<strong>必须</strong>重写所有的抽象方法。</p>
<h3 data-id="heading-13">3.3 方法规则与修正</h3>
<ul>
<li>接口方法默认是 <code>open</code> 的。</li>
<li><strong>修正点</strong>：在 Java 中实现接口方法不需要 <code>override</code> 关键字，但在 <strong>Kotlin 中，实现接口的抽象方法必须显式加上 <code>override</code> 关键字</strong>。这是为了防止意外的方法签名冲突。</li>
</ul>
<h3 data-id="heading-14">3.4 示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> : <span class="hljs-type">Clickable</span> {
    <span class="hljs-comment">// 必须加 override</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Button clicked!"</span>)
    }
}
</code></pre>
<h2 data-id="heading-15">四、接口核心组成（二）：抽象属性</h2>
<h3 data-id="heading-16">4.1 什么是接口抽象属性？</h3>
<p>这是 Kotlin 接口的一大特色。接口可以定义属性，但这<strong>不代表接口有内存空间来存储这个值</strong>。它只是规定实现类必须提供一个“获取该属性值”的方式（即 getter/setter 契约）。</p>
<h3 data-id="heading-17">4.2 定义语法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Named</span> {
    <span class="hljs-keyword">val</span> name: String <span class="hljs-comment">// 抽象属性，没有初始化值</span>
}
</code></pre>
<h3 data-id="heading-18">4.3 实现规则</h3>
<h3 data-id="heading-19">4.3.1 实现类重写</h3>
<p>实现类可以使用主构造函数参数直接重写，也可以自定义 getter。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 方式 A：在主构造函数中重写（最常用）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String) : Named

<span class="hljs-comment">// 方式 B：使用自定义 getter</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Computer</span> : <span class="hljs-type">Named</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-string">"System_PC"</span> <span class="hljs-comment">// 动态计算</span>
}
</code></pre>
<h3 data-id="heading-20">4.3.2 var 属性要求</h3>
<p>如果接口定义的是 <code>var</code>（可变属性），实现类必须同时提供 getter 和 setter。</p>
<h3 data-id="heading-21">4.4 示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Renameable</span> {
    <span class="hljs-keyword">var</span> nickName: String
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Player</span> : <span class="hljs-type">Renameable</span> {
    <span class="hljs-comment">// 必须有一个真实字段来存储状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _name = <span class="hljs-string">"Guest"</span>

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> nickName: String
        <span class="hljs-keyword">get</span>() = _name
        <span class="hljs-keyword">set</span>(value) { _name = value }
}

</code></pre>
<h2 data-id="heading-22">五、接口核心组成（三）：默认实现（Kotlin 特有）</h2>
<h3 data-id="heading-23">5.1 定义语法</h3>
<p>如果在接口方法或属性中提供了具体逻辑（方法体或 getter），它就变成了<strong>默认实现</strong>。</p>
<h3 data-id="heading-24">5.2 核心价值</h3>
<ul>
<li><strong>非强制重写</strong>：实现类可以直接复用默认逻辑。</li>
<li><strong>扩展性</strong>：在旧接口中新增带有默认实现的方法，<strong>不会破坏</strong>已有的实现类代码（二进制兼容性除外，但源码级兼容）。</li>
</ul>
<h3 data-id="heading-25">5.3 方法默认实现</h3>
<h3 data-id="heading-26">5.3.1 示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Logger</span> {
    <span class="hljs-comment">// 默认实现</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">log</span><span class="hljs-params">(msg: <span class="hljs-type">String</span>)</span></span> {
        println(<span class="hljs-string">"Log: <span class="hljs-variable">$msg</span>"</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleLogger</span> : <span class="hljs-type">Logger</span> {
    <span class="hljs-comment">// 不需要重写 log 方法，直接拥有该功能</span>
}

</code></pre>
<h3 data-id="heading-27">5.3.2 注意点</h3>
<p>默认方法内部可以调用接口的其他方法（包括抽象方法），这构成了<strong>模板方法模式</strong>的基础。</p>
<h3 data-id="heading-28">5.4 属性默认实现</h3>
<h3 data-id="heading-29">5.4.1 语法</h3>
<p>接口属性不能有初始值（<code>val x = 1</code> ❌），但可以有默认的 getter。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">HasId</span> {
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>
    <span class="hljs-comment">// 属性的默认实现（必须通过 getter）</span>
    <span class="hljs-keyword">val</span> idString: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-string">"ID_<span class="hljs-variable">$id</span>"</span> <span class="hljs-comment">// 依赖于抽象属性 id</span>
}

</code></pre>
<h3 data-id="heading-30">5.5 重写默认实现</h3>
<p>如果默认逻辑不符合需求，实现类依然可以通过 <code>override</code> 覆盖它。</p>
<h2 data-id="heading-31">六、接口的继承与多实现</h2>
<h3 data-id="heading-32">6.1 接口继承接口</h3>
<p>接口之间可以继承，子接口可以继承父接口的方法，也可以覆盖父接口的默认实现。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">AdvancedClickable</span> : <span class="hljs-type">Clickable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLongClick</span><span class="hljs-params">()</span></span> <span class="hljs-comment">// 新增抽象方法</span>
}

</code></pre>
<h3 data-id="heading-33">6.2 类多实现接口与冲突解决</h3>
<h3 data-id="heading-34">6.2.1 默认实现冲突</h3>
<p>当一个类实现了两个接口（A 和 B），且这两个接口都有一个同名的<strong>默认方法</strong> <code>foo()</code> 时，编译器会报错，强制要求类重写 <code>foo()</code> 以消除歧义。</p>
<h3 data-id="heading-35">6.2.2 示例：解决冲突</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">A</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> { println(<span class="hljs-string">"A"</span>) }
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">B</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> { println(<span class="hljs-string">"B"</span>) }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> : <span class="hljs-type">A</span>, <span class="hljs-type">B</span> {
    <span class="hljs-comment">// 必须显式重写，否则编译报错</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 可以选择调用 A 的，也可以调用 B 的，或者写全新的逻辑</span>
        <span class="hljs-keyword">super</span>&lt;A&gt;.foo()
        <span class="hljs-keyword">super</span>&lt;B&gt;.foo()
    }
}

</code></pre>
<h2 data-id="heading-36">七、实用场景与实战示例</h2>
<h3 data-id="heading-37">7.1 行为规范定义</h3>
<p>核心价值：定义“能做什么”的通用行为标准，不关心“怎么做”，实现跨类别的行为统一约束。</p>
<p>这种场景下，接口仅提供抽象方法或属性，作为不同类的“行为契约”。典型案例是Kotlin标准库中的<code>Comparable</code>（定义“可比较”行为）、<code>Runnable</code>（定义“可执行”行为）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义“可打印”行为规范（仅约束能做什么）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Printable</span> {
    <span class="hljs-comment">// 抽象方法：仅定义签名，无实现</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printContent</span><span class="hljs-params">()</span></span>: String
}

<span class="hljs-comment">// 不同类实现该规范，各自实现“怎么做”</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Article</span>(<span class="hljs-keyword">val</span> title: String) : Printable {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printContent</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"文章：<span class="hljs-variable">$title</span>"</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Picture</span>(<span class="hljs-keyword">val</span> name: String) : Printable {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printContent</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"图片：<span class="hljs-variable">$name</span>"</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> items = listOf(Article(<span class="hljs-string">"Kotlin接口详解"</span>), Picture(<span class="hljs-string">"风景图"</span>))
    items.forEach { println(it.printContent()) }
    <span class="hljs-comment">// 输出：文章：Kotlin接口详解；图片：风景图</span>
}

</code></pre>
<h3 data-id="heading-38">7.2 多态场景</h3>
<p>核心价值：以接口为参数/返回值，屏蔽实现类的具体差异，实现“同一操作适配不同对象”，降低代码耦合。</p>
<p>多态的核心是“面向接口编程”——调用方只需依赖接口定义的行为，无需关心具体是哪个实现类，新增实现类时无需修改调用逻辑。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义“可展示”行为接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Displayable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// 实现类1：按钮</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span>(<span class="hljs-keyword">val</span> text: String) : Displayable {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"显示按钮：<span class="hljs-variable">$text</span>"</span>)
    }
}

<span class="hljs-comment">// 实现类2：图片</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Image</span>(<span class="hljs-keyword">val</span> url: String) : Displayable {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"显示图片：<span class="hljs-variable">$url</span>"</span>)
    }
}

<span class="hljs-comment">// 多态核心：参数为接口类型，适配所有实现类</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleDisplay</span><span class="hljs-params">(item: <span class="hljs-type">Displayable</span>)</span></span> {
    item.show() <span class="hljs-comment">// 不关心是Button还是Image，只调用接口方法</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> button = Button(<span class="hljs-string">"提交"</span>)
    <span class="hljs-keyword">val</span> image = Image(<span class="hljs-string">"https://example.com/pic.jpg"</span>)
    handleDisplay(button)  <span class="hljs-comment">// 输出：显示按钮：提交</span>
    handleDisplay(image)   <span class="hljs-comment">// 输出：显示图片：https://example.com/pic.jpg</span>
    <span class="hljs-comment">// 新增实现类（如Text），直接调用handleDisplay即可，无需修改该函数</span>
}

</code></pre>
<h3 data-id="heading-39">7.3 接口默认实现简化扩展</h3>
<p>核心价值：给接口方法提供默认逻辑，实现类仅需重写“个性化”方法，减少重复代码，尤其适合框架开发。</p>
<p>框架开发中，常需定义大量扩展点。若全为抽象方法，实现类需重写所有方法，冗余且不灵活；默认实现可提供“基础操作”或“空操作”，用户按需重写。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 框架级接口：提供默认实现，简化扩展</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DataProcessor</span> {
    <span class="hljs-comment">// 核心抽象方法：必须重写（业务核心）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processData</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span>: String

    <span class="hljs-comment">// 默认实现方法1：基础操作，可选重写</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validateData</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>.isNotBlank() <span class="hljs-comment">// 基础校验：非空</span>
    }

    <span class="hljs-comment">// 默认实现方法2：空操作，可选重写</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">afterProcess</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 框架默认无操作，用户可重写实现后续逻辑</span>
    }
}

<span class="hljs-comment">// 业务实现类：仅重写核心和需要个性化的方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDataProcessor</span> : <span class="hljs-type">DataProcessor</span> {
    <span class="hljs-comment">// 必须重写核心方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processData</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"处理用户数据：<span class="hljs-variable">$data</span>"</span>
    }

    <span class="hljs-comment">// 仅重写需要个性化的校验逻辑，其他用默认实现</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validateData</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.validateData(<span class="hljs-keyword">data</span>) &amp;&amp; <span class="hljs-keyword">data</span>.length &gt; <span class="hljs-number">5</span> <span class="hljs-comment">// 增强校验</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> processor = UserDataProcessor()
    <span class="hljs-keyword">if</span> (processor.validateData(<span class="hljs-string">"user123"</span>)) {
        println(processor.processData(<span class="hljs-string">"user123"</span>)) <span class="hljs-comment">// 输出：处理用户数据：user123</span>
        processor.afterProcess() <span class="hljs-comment">// 无输出（用默认空实现）</span>
    }
}

</code></pre>
<h3 data-id="heading-40">7.4 完整实战示例</h3>
<p>以“可移动对象”为例，整合接口的抽象属性、抽象方法、默认实现，展示接口在实际业务中的完整应用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 可移动对象接口
 * 包含：抽象属性（坐标x/y）、默认实现方法（移动逻辑）
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Movable</span> {
    <span class="hljs-comment">// 抽象属性：要求实现类必须定义并初始化</span>
    <span class="hljs-keyword">var</span> x: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">var</span> y: <span class="hljs-built_in">Int</span>

    <span class="hljs-comment">// 带默认实现的方法：移动逻辑，实现类可重写</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">move</span><span class="hljs-params">(dx: <span class="hljs-type">Int</span>, dy: <span class="hljs-type">Int</span>)</span></span> {
        x += dx
        y += dy
        logMove() <span class="hljs-comment">// 调用接口内部的辅助方法</span>
    }

    <span class="hljs-comment">// 接口内部辅助方法（默认实现）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logMove</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"已移动到坐标：(<span class="hljs-variable">$x</span>, <span class="hljs-variable">$y</span>)"</span>)
    }
}

<span class="hljs-comment">// 实现类1：汽车（使用默认移动逻辑）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span>(<span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> x: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> y: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> name: String) : Movable

<span class="hljs-comment">// 实现类2：飞机（重写移动逻辑，自定义行为）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Plane</span>(<span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> x: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> y: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> speed: <span class="hljs-built_in">Int</span>) : Movable {
    <span class="hljs-comment">// 重写默认方法：飞机移动速度更快，附加速度信息</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">move</span><span class="hljs-params">(dx: <span class="hljs-type">Int</span>, dy: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> realDx = dx * speed
        <span class="hljs-keyword">val</span> realDy = dy * speed
        x += realDx
        y += realDy
        logMove()
    }

    <span class="hljs-comment">// 重写日志方法：附加飞机名称</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logMove</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"飞机<span class="hljs-subst">${name ?: <span class="hljs-string">"未知"</span>}</span>已移动到坐标：(<span class="hljs-variable">$x</span>, <span class="hljs-variable">$y</span>)"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 汽车：使用接口默认移动逻辑</span>
    <span class="hljs-keyword">val</span> car = Car(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"家用轿车"</span>)
    car.move(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>) <span class="hljs-comment">// 输出：已移动到坐标：(10, 20)</span>

    <span class="hljs-comment">// 飞机：使用自定义移动逻辑</span>
    <span class="hljs-keyword">val</span> plane = Plane(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>)
    plane.name = <span class="hljs-string">"波音747"</span>
    plane.move(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>) <span class="hljs-comment">// 输出：飞机波音747已移动到坐标：(50, 100)</span>
}

</code></pre>
<p>实战要点：接口通过“抽象属性约束状态”“默认方法提供基础逻辑”，实现类可灵活选择复用或重写，既保证了行为一致性，又保留了个性化扩展空间。</p>
<h2 data-id="heading-41">八、与抽象类、Java 接口的核心区别</h2>
<h3 data-id="heading-42">8.1 Kotlin 接口 vs 抽象类</h3>






























<table><thead><tr><th>对比维度</th><th>Kotlin 接口 (Interface)</th><th>抽象类 (Abstract Class)</th></tr></thead><tbody><tr><td><strong>状态存储</strong></td><td><strong>无</strong> (不能有 Backing Fields)</td><td><strong>有</strong> (可以定义 <code>val/var name = "Bob"</code>)</td></tr><tr><td><strong>构造函数</strong></td><td><strong>无</strong></td><td><strong>有</strong> (主/次构造函数)</td></tr><tr><td><strong>多继承</strong></td><td><strong>支持</strong> (多实现)</td><td><strong>不支持</strong> (单继承)</td></tr><tr><td><strong>核心用途</strong></td><td>定义行为规范、解耦、多态</td><td>封装共性逻辑、代码复用、状态复用</td></tr></tbody></table>
<h3 data-id="heading-43">8.2 Kotlin 接口 vs Java 接口 (Java 8+)</h3>
<ol>
<li><strong>属性支持</strong>：Kotlin 接口原生支持抽象属性和属性 getter 默认实现，Java 接口主要是方法。</li>
<li><strong>Override 关键字</strong>：Kotlin 强制要求 <code>override</code>，Java 是可选注解 <code>@Override</code>。</li>
<li><strong>静态成员</strong>：Java 接口可以直接定义 <code>static</code> 方法；Kotlin 接口通常将相关静态逻辑放在 <code>companion object</code> 中（虽然 JVM 层面可以映射）。</li>
</ol>
<h2 data-id="heading-44">九、使用注意事项与避坑点</h2>
<h3 data-id="heading-45">9.1 接口不可含状态字段</h3>
<p>切记：<code>val prop: Int = 0</code> 在接口中是非法的。接口不能保存数据，只能定义“获取数据的方法”。</p>
<h3 data-id="heading-46">9.2 多实现默认方法冲突</h3>
<p>遇到 <code>Conflict</code> 报错不要慌，手动 <code>override</code> 并指定 <code>super&lt;T&gt;.method()</code> 即可。</p>
<h3 data-id="heading-47">9.3 抽象属性实现要求</h3>
<p>实现 <code>var</code> 属性时，千万别忘了 setter。如果是用 <code>get()</code> 实现的，确保它不会返回不一致的状态。</p>
<h3 data-id="heading-48">9.4 避免过度设计</h3>
<p>不要为了使用接口而使用接口。如果类与类之间有很强的“血缘关系”且需要共享状态，抽象类可能更合适。</p>
<h3 data-id="heading-49">9.5 默认实现不可依赖外部状态</h3>
<p>接口的默认方法是无状态的，这意味着它只能操作接口内定义的其他属性或方法，无法访问实现类的私有字段，线程安全性需由实现类保证。</p>
<h2 data-id="heading-50">十、总结与最佳实践</h2>
<h3 data-id="heading-51">10.1 核心知识点回顾</h3>
<ul>
<li><strong>定义</strong>：<code>interface</code> 关键字，无构造函数。</li>
<li><strong>抽象</strong>：方法默认 abstract，属性需重写。</li>
<li><strong>实现</strong>：<code>override</code> 关键字必不可少。</li>
<li><strong>默认</strong>：方法体即默认实现，属性 getter 即默认实现。</li>
</ul>
<h3 data-id="heading-52">10.2 最佳实践</h3>
<ul>
<li><strong>接口隔离原则</strong>：将大接口拆分为多个小接口（如 <code>Readable</code>, <code>Writable</code>）。</li>
<li><strong>默认实现兜底</strong>：利用默认方法减少实现类的样板代码，尤其是当接口方法很多时。</li>
<li><strong>优先使用接口</strong>：在不需要共享状态的情况下，优先使用接口来实现多态，保留类的继承位置（毕竟类是单继承的）。</li>
</ul>
<h3 data-id="heading-53">10.3 选型建议</h3>
<ul>
<li>需要 <strong>多重继承</strong> 能力 -&gt; <strong>接口</strong>。</li>
<li>需要 <strong>定义行为规范</strong> (Can-Do) -&gt; <strong>接口</strong>。</li>
<li>需要 <strong>复用成员变量</strong> (State) -&gt; <strong>抽象类</strong>。</li>
</ul>
<h2 data-id="heading-54">十一、全文总结</h2>
<p>为了方便记忆，我们将 Kotlin 接口的核心精华总结为以下“1-2-3-4”法则：</p>
<h3 data-id="heading-55">1 个核心限制</h3>
<ul>
<li><strong>无状态（No State）</strong>：接口绝对<strong>不能</strong>包含状态字段（Backing Field）。虽然可以定义属性，但那本质上是 getter/setter 方法的声明，不占内存空间。</li>
</ul>
<h3 data-id="heading-56">2 大核心增强（vs Java 7）</h3>
<ol>
<li><strong>抽象属性</strong>：接口可以定义属性，强制实现类提供 getter/setter。</li>
<li><strong>默认实现</strong>：方法和属性（getter）可以提供默认逻辑，无需强制重写。</li>
</ol>
<h3 data-id="heading-57">3 个关键组成</h3>
<ol>
<li><strong>抽象方法</strong>：定义行为契约，无方法体，实现类必须 <code>override</code>。</li>
<li><strong>默认方法</strong>：提供通用逻辑，有方法体，实现类可选 <code>override</code>。</li>
<li><strong>抽象属性</strong>：定义状态访问契约，实现类必须提供值的来源。</li>
</ol>
<h3 data-id="heading-58">4 条重要规则</h3>
<ol>
<li><strong>Override 强制性</strong>：实现接口成员必须加 <code>override</code> 关键字。</li>
<li><strong>冲突解决</strong>：多实现产生同名默认方法冲突时，必须显式重写并指定 <code>super&lt;T&gt;</code>。</li>
<li><strong>无构造函数</strong>：接口不能被直接实例化。</li>
<li><strong>多重实现</strong>：一个类可以实现多个接口，弥补单继承的不足。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 AI 真正懂仓库：如何用 CLAUDE.md 将 Claude Code 的工作效率发挥到极致]]></title>    <link>https://juejin.cn/post/7579088065696809000</link>    <guid>https://juejin.cn/post/7579088065696809000</guid>    <pubDate>2025-12-02T10:54:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579088065696809000" data-draft-id="7579190764765675560" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 AI 真正懂仓库：如何用 CLAUDE.md 将 Claude Code 的工作效率发挥到极致"/> <meta itemprop="keywords" content="Claude,人工智能"/> <meta itemprop="datePublished" content="2025-12-02T10:54:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智谱开放平台"/> <meta itemprop="url" content="https://juejin.cn/user/2056503277400843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 AI 真正懂仓库：如何用 CLAUDE.md 将 Claude Code 的工作效率发挥到极致
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2056503277400843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智谱开放平台
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T10:54:23.000Z" title="Tue Dec 02 2025 10:54:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一个使用 <code>CLAUDE.md</code> 文件优化 Claude Code 操作的实用指南</p>
</blockquote>
<p>很多 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhipuaishengchan.datasink.sensorsdata.cn%2Ft%2FKH" target="_blank" title="https://zhipuaishengchan.datasink.sensorsdata.cn/t/KH" ref="nofollow noopener noreferrer">GLM Coding Plan</a> 用户在使用 Claude Code 时，总会遇到一个难题：</p>
<blockquote>
<p>如何在不反复赘述的前提下，让工具充分理解你的项目架构、编码规范和工作流程？</p>
</blockquote>
<p>随着代码库规模的不断增长，这个问题会变得愈发突出。模块之间的依赖关系、特定领域的编码模式还有团队内部的约定，这些东西本来就不好直观展示。结果就是每次跟工具对话，都得先花时间重复解释一遍 —— 比如当初的架构怎么定的、测试有哪些要求、代码风格偏好是什么，特别浪费时间。</p>
<p>而 CLAUDE.md 刚好能解决这个痛点，它就像给 Claude Code 专门准备的 “项目说明书”。它是一份配置文件，能帮助 Claude Code 记住项目的核心信息，形成持久的上下文记忆。每次你跟 Claude Code 对话，都会自动加载这些背景信息，确保它对你的项目了如指掌。</p>
<p>接下来我就具体说说，CLAUDE.md 该怎么结构化地编写，分享一些实战中的最佳方案，还有怎么用它充分发挥 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhipuaishengchan.datasink.sensorsdata.cn%2Ft%2FKH" target="_blank" title="https://zhipuaishengchan.datasink.sensorsdata.cn/t/KH" ref="nofollow noopener noreferrer">GLM-4.6</a> 与 Claude Code 工具的效能。</p>
<h2 data-id="heading-0"><strong>什么是 <code>CLAUDE.md</code> 文件？</strong></h2>
<p><code>CLAUDE.md</code> 是一份写给 Claude Code 的“项目备忘录”。它是一份放在代码仓库里的特殊配置文件，用来告诉 Claude Code 你的项目是怎么组织的、有哪些约定、使用什么规范、遵循怎样的开发流程。这样一来，你就不用在每次对话里反复解释架构、风格和团队习惯。</p>
<p>它的存放位置非常灵活：</p>
<ul>
<li>对于一般项目，放在仓库根目录，整个团队都能共享；</li>
<li>如果是 monorepo，可以把它放在父级目录；</li>
<li>你也可以把它放在自己的主目录，让它在所有项目里都能生效。</li>
</ul>
<blockquote>
<p>一句话总结：把 Claude Code 需要长期记住的项目信息写进 CLAUDE.md，就能让你的协作从第一句开始就“对齐上下文”。</p>
</blockquote>
<p>下面是一个典型的 <code>CLAUDE.md</code> 文件示例，让你有个直观感受：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Project Context</span>

When working with this Code base, prioritize readability over cleverness. Ask clarifying questions before making architectural changes.

<span class="hljs-section">## About This Project</span>

FastAPI REST API for user authentication and profiles. Uses SQLAlchemy for database operations and Pydantic for validation.

<span class="hljs-section">## Key Directories</span>

<span class="hljs-bullet">-</span> <span class="hljs-code">`app/models/`</span> - database models
<span class="hljs-bullet">-</span> <span class="hljs-code">`app/api/`</span> - route handlers
<span class="hljs-bullet">-</span> <span class="hljs-code">`app/core/`</span> - configuration and utilities

<span class="hljs-section">## Standards</span>

<span class="hljs-bullet">-</span> Type hints required on all functions
<span class="hljs-bullet">-</span> pytest for testing (fixtures in <span class="hljs-code">`tests/conftest.py`</span>)
<span class="hljs-bullet">-</span> PEP 8 with 100 character lines

<span class="hljs-section">## Common Commands</span>
<span class="hljs-code">```bash
uvicorn app.main:app --reload  # dev server
pytest tests/ -v               # run tests
```</span>

<span class="hljs-section">## Notes</span>

All routes use <span class="hljs-code">`/api/v1`</span> prefix. JWT tokens expire after 24 hours.
</code></pre>
<p>一个配置得当的 <code>CLAUDE.md</code> 文件，能显著提升 Claude Code 在你项目中的工作表现。它会为 Claude Code 补齐架构背景、明确你的工作流程，并说明项目里常用的工具和约定。重点不是写“Claude Code 可能需要什么”，而是把你在实际协作中总是需要重复解释的内容整理进去。</p>
<p>你可以在文件里记录诸如：常用的 bash 命令、关键工具类、编码风格规范、测试方式、仓库结构约定、开发环境的搭建步骤、以及项目里那些容易踩坑的注意事项。它对格式没有硬性要求，只要简洁、易读，让团队成员和 Claude Code 一眼就能抓住重点即可。</p>
<p><code>CLAUDE.md</code> 会成为 Claude Code 的基础上下文之一，在每一次对话前自动加载 —— 你不再需要从头讲一遍项目背景，它也能始终保持“对齐状态”，更快进入正题。</p>
<hr/>
<h2 data-id="heading-1"><strong>使用</strong> <code>/init</code> <strong>命令快速上手</strong></h2>
<p>在面对一个不熟悉的代码库时，创建 <code>CLAUDE.md</code> 是一件很难的事情。</p>
<p>而 <code>/init</code> 命令能自动完成这一过程 —— 它会分析你的项目，生成一份初始配置文件。</p>
<p>在任意 Claude Code 会话中运行以下命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> your-project
claude
/init
</code></pre>
<p>Claude Code 能自动扫描你的整个代码库，读取包管理文件、已有的项目文档、各类配置文件以及代码目录结构，然后根据你的项目情况自动生成一份初版 <strong><code>CLAUDE.md</code></strong>。生成内容通常包含构建/运行命令、测试说明、关键目录以及能从代码中推断出的编码规范。</p>
<p>不过要注意，通过<code>/init</code> 命令生成的文件能抓住项目的骨架，但往往缺少了团队工作流中那些约定俗成的细节。所以一定要仔细核对生成的内容，再结合团队的实际工作习惯进行调整和优化。</p>
<p>即使你的项目里已经有现成的 <code>CLAUDE.md</code> 了，也可以使用 <code>/init</code> 命令，Claude Code 会对比现有文件和代码库的最新变化，给出针对性的优化建议。</p>
<h3 data-id="heading-2"><code>/init</code> <strong>之后，下一步做什么？</strong></h3>
<ul>
<li><strong>检查准确性</strong>：确保所有推断出的信息都是正确的。</li>
<li><strong>补充“潜规则”</strong> ：加入 Claude Code 无法推断的工作流，比如分支命名规范、部署流程、代码审查的具体要求等。</li>
<li><strong>精简内容</strong>：删掉那些不适合当前项目的通用指导内容。</li>
<li><strong>纳入版本控制</strong>：把最终版文件提交到版本控制系统里，方便团队成员共享使用。</li>
</ul>
<p>其实 <code>/init</code> 命令的核心作用就是快速搭好基础框架，<code>CLAUDE.md</code> 的真正价值在于后续的持续迭代完善。在日常使用 Claude Code 时，可以用 <code>#</code> 键记录下那些重复性的操作，慢慢把这份文件打磨成一份专属配置。</p>
<hr/>
<h2 data-id="heading-3"><strong>如何构建一份真正高效的</strong> <strong><code>CLAUDE.md</code></strong> <strong>?</strong></h2>
<p>接下来的内容，会手把手教你如何打磨这份文件，让它成为你的得力助手。</p>
<p>我们将解决几个核心的问题：如何帮助它理解复杂架构、跟踪多步骤任务、集成自定义工具，以及通过统一流程减少重复沟通。</p>
<h3 data-id="heading-4"><strong>为 Claude Code 提供“项目地图”</strong></h3>
<p>在日常开发中，最耗时的往往不是写代码，而是反复解释项目架构、模块依赖、关键库、编码风格等背景信息。要让 Claude Code 长期、稳定地理解你的代码库，就需要把这些基础上下文写进 <code>CLAUDE.md</code>，让它无需每次都从零开始。</p>
<p>最基础也最重要的内容，是项目的<strong>总体概览</strong>和<strong>目录结构</strong>。</p>
<p>你可以在 <code>CLAUDE.md</code> 中加入简洁的项目说明和一份结构清晰的目录，帮助 Claude Code 快速建立认知模型，知道关键模块分别放在哪里。例如：</p>
<pre><code class="hljs language-c" lang="c">main.py
├── logs
│   ├── application.<span class="hljs-built_in">log</span>
├── modules
│   ├── cli.py
│   ├── logging _utils.py │   ├── media_ handler.py
│   ├── player.py
</code></pre>
<p>在项目地图中，你可以进一步加入主要依赖、架构模式以及任何“非标准”的组织方式。如果项目采用了 DDD、微服务拆分，或使用了某些特定框架，也可以在这里说明。这样 Claude Code 能更准确地判断代码属于哪一层、修改应该落在哪里，不会误入无关模块。</p>
<h3 data-id="heading-5"><strong>让 Claude Code 了解你的开发环境</strong></h3>
<p>Claude Code 会完整读取所在的工作目录，但它并不了解你的项目结构、工具链和内部脚本。这个时候就需要你在 <code>CLAUDE.md</code> 中明确告诉它。</p>
<p>如果团队里有部署脚本、测试脚本、代码生成器、数据处理脚本等常用工具，都可以写在 <code>CLAUDE.md</code> 中。建议包含以下信息：</p>
<ul>
<li><strong>工具名称与用途</strong></li>
<li><strong>基础使用方法</strong>（命令格式、关键参数）</li>
<li><strong>典型调用场景</strong></li>
<li><strong>是否支持</strong> <strong><code>--help</code></strong> <strong>获取帮助文档</strong></li>
</ul>
<p>只要你把这些说明补充完整，Claude Code 就可以在任务中正确调用这些工具。对于较复杂的内部工具，建议再补充团队最常用的几条“高频用法”。</p>
<p>Claude Code 还内置了 MCP（Model Context Protocol）客户端，可以连接外部 MCP 服务器，从而使用更多扩展能力。</p>
<p>你可以通过以下方式配置 MCP：</p>
<ul>
<li>项目设置</li>
<li>全局设置</li>
<li>仓库中的 <code>.mcp.json</code> 文件</li>
</ul>
<p>如果某个 MCP 工具没有正常显示，可以用 <code>--mcp-debug</code> 排查异常。</p>
<p>举个例子，若你的团队已配置 Slack MCP 服务器，而你希望 Claude Code 在对话中能直接调用 Slack 工具，可在 CLAUDE.md 中添加如下内容：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">### Slack MCP</span>
<span class="hljs-bullet">-</span> Posts to #dev-notifications channel only
<span class="hljs-bullet">-</span> Use for deployment notifications and build failures
<span class="hljs-bullet">-</span> Do not use for individual PR updates (those go through GitHub webhooks)
<span class="hljs-bullet">-</span> Rate limited to 10 messages per hour
</code></pre>
<hr/>
<h2 data-id="heading-6"><strong>定义标准工作流</strong></h2>
<p>要是让 Claude Code 没个明确规划就直接改代码，大概率会白忙活一场。它给的方案可能会漏掉需求点，或者用错了架构思路，甚至还会搞崩现有功能。</p>
<p>关键是得让 Claude Code 动手前先 “想清楚”。所以一定要在 CLAUDE.md 里针对不同类型的任务定好标准工作流，让它照着执行。一套完善的工作流，需要先把四个问题捋明白：</p>
<ol>
<li>这个问题是不是得先调研一下，摸清当前的代码现状才能动手？</li>
<li>动手写代码前，要不要先搭个详细的实现方案？</li>
<li>现在手里的信息够不够？还缺哪些关键内容没明确？</li>
<li>做完之后怎么验证？怎么确保方案是有效的？</li>
</ol>
<p><strong>工作流可以根据任务类型灵活定制：</strong></p>
<ul>
<li><strong>功能开发</strong>：可遵循“调研-规划-编码-提交”的流程。</li>
<li><strong>算法开发</strong>：更适合采用“测试驱动开发”（TDD）模式。</li>
<li><strong>UI 迭代</strong>：则可遵循“视觉原型迭代”的流程。</li>
</ul>
<p>同时，也请在文档中明确测试要求、提交信息规范以及各类审批流程。当 Claude Code 预先掌握了这些工作流，它就能主动地与团队的实际节奏保持一致，而不是凭感觉行事。</p>
<p>以下是一个工作流指令的示例：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-number">1</span>) <span class="hljs-selector-tag">Before</span> <span class="hljs-selector-tag">modifying</span> <span class="hljs-selector-tag">Code</span>  <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">following</span> <span class="hljs-selector-tag">locations</span>: <span class="hljs-selector-tag">X</span>, <span class="hljs-selector-tag">Y</span>, <span class="hljs-selector-tag">Z</span>
        <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Consider</span> <span class="hljs-selector-tag">how</span> <span class="hljs-selector-tag">it</span> <span class="hljs-selector-tag">might</span> <span class="hljs-selector-tag">affect</span> <span class="hljs-selector-tag">A</span>, <span class="hljs-selector-tag">B</span>, <span class="hljs-selector-tag">C</span>
        <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Construct</span> <span class="hljs-selector-tag">an</span> <span class="hljs-selector-tag">implementation</span> <span class="hljs-selector-tag">plan</span>
        <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Develop</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">test</span> <span class="hljs-selector-tag">plan</span> <span class="hljs-selector-tag">that</span> <span class="hljs-selector-tag">will</span> <span class="hljs-selector-tag">validate</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">following</span> <span class="hljs-selector-tag">functions</span>...
</code></pre>
<h2 data-id="heading-7"><strong>使用Claude Code 的进阶技巧</strong></h2>
<p>除了配置 <code>CLAUDE.md</code>，还有三个技巧能大幅提升你的 Claude Code 体验。</p>
<ol>
<li>
<h3 data-id="heading-8"><strong>保持上下文“干净”</strong></h3>
</li>
</ol>
<p>长时间连续使用 Claude Code ，会让上下文里不断堆积无关信息：旧任务的文件内容、失效的命令输出、已经过时的讨论……这些噪声会占据 Claude Code 的上下文窗口，让它难以专注在当前任务上。</p>
<p>在切换任务时，可以使用  <strong><code>/clear</code></strong> 命令重置上下文。它会清除历史记录，但保留 <code>CLAUDE.md</code> 配置，相当于开启一个全新的工作会话。</p>
<p>例如：你刚完成一轮身份验证相关的调试，接下来要开发全新的 API 端点。此时，与身份验证相关的上下文已经不再有用，可以执行一次 <code>/clear</code>命令，避免旧内容干扰 Claude Code 的思考。</p>
<ol start="2">
<li>
<h3 data-id="heading-9"><strong>使用 Sub-agent 隔离不同工作阶段</strong></h3>
</li>
</ol>
<p>复杂任务往往需要多个分析视角。比如：</p>
<ul>
<li>你刚调试完一段身份验证逻辑</li>
<li>接下来要对同一段代码进行安全审查</li>
</ul>
<p>如果继续在同一个对话中，让 Claude Code 的“调试上下文”直接影响安全检查，会导致它过度关注已经解决的问题，反而忽略真正的风险点。</p>
<p>这时可以让 Claude Code <strong>启动一个 Sub-agent</strong> 来处理新阶段的分析。<strong>Sub-agent</strong> 拥有独立上下文，相当于为该步骤开了一个全新、干净的工作空间。</p>
<p>这种方式在多步骤流程里尤其有用：开发阶段需要项目背景和功能需求，而安全审查阶段则需要“无前提”的视角。上下文隔离，让两种分析都能更精准。</p>
<ol start="3">
<li>
<h3 data-id="heading-10"><strong>为高频任务创建自定义命令</strong></h3>
</li>
</ol>
<p>重复输入相似提示本身就是一种浪费：</p>
<blockquote>
<p>“请检查这段代码的安全隐患”</p>
<p>“帮我分析这里的性能瓶颈”</p>
<p>“为这一函数写单元测试”</p>
</blockquote>
<p>每次都要想一遍最佳 phrasing，没有必要。</p>
<p>你可以把常用提示写进 <code>.claude/commands/</code> 目录下的 markdown 文件，作为 <strong>自定义斜杠命令</strong> 来调用。</p>
<blockquote>
<p>示例：</p>
<p>创建 <code>.claude/commands/performance-optimization.md</code>文件，写入你的标准性能优化指令。 之后在任何对话中输入：</p>
<pre><code class="hljs language-bash" lang="bash">/performance-optimization myfile.py
</code></pre>
<p>Claude Code 就会自动加载你的提示，并支持使用 <code>$ARGUMENTS</code> 或 <code>$1</code>、<code>$2</code> 这样的参数占位符，让你能灵活传入文件名、配置或说明。</p>
</blockquote>
<p>自定义命令等于把你的经验沉淀成“可调用的工具”，大幅减少重复工作。</p>
<p>上述的<code>performance-optimization.md</code>文件内容可以为：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Performance Optimization</span>

Analyze the provided Code  for performance bottlenecks and optimization opportunities. Conduct a thorough review covering:

<span class="hljs-section">## Areas to Analyze</span>

<span class="hljs-section">### Database &amp; Data Access</span>
<span class="hljs-bullet">-</span> N+1 query problems and missing eager loading
<span class="hljs-bullet">-</span> Lack of database indexes on frequently queried columns
<span class="hljs-bullet">-</span> Inefficient joins or subqueries
<span class="hljs-bullet">-</span> Missing pagination on large result sets
<span class="hljs-bullet">-</span> Absence of query result caching
<span class="hljs-bullet">-</span> Connection pooling issues

<span class="hljs-section">### Algorithm Efficiency</span>
<span class="hljs-bullet">-</span> Time complexity issues (O(n²) or worse when better exists)
<span class="hljs-bullet">-</span> Nested loops that could be optimized
<span class="hljs-bullet">-</span> Redundant calculations or repeated work
<span class="hljs-bullet">-</span> Inefficient data structure choices
<span class="hljs-bullet">-</span> Missing memoization or dynamic programming opportunities

<span class="hljs-section">### Memory Management</span>
<span class="hljs-bullet">-</span> Memory leaks or retained references
<span class="hljs-bullet">-</span> Loading entire datasets when streaming is possible
<span class="hljs-bullet">-</span> Excessive object instantiation in loops
<span class="hljs-bullet">-</span> Large data structures kept in memory unnecessarily
<span class="hljs-bullet">-</span> Missing garbage collection opportunities

<span class="hljs-section">### Async &amp; Concurrency</span>
<span class="hljs-bullet">-</span> Blocking I/O operations that should be async
<span class="hljs-bullet">-</span> Sequential operations that could run in parallel
<span class="hljs-bullet">-</span> Missing Promise.all() or concurrent execution patterns
<span class="hljs-bullet">-</span> Synchronous file operations
<span class="hljs-bullet">-</span> Unoptimized worker thread usage

<span class="hljs-section">### Network &amp; I/O</span>
<span class="hljs-bullet">-</span> Excessive API calls (missing request batching)
<span class="hljs-bullet">-</span> No response caching strategy
<span class="hljs-bullet">-</span> Large payloads without compression
<span class="hljs-bullet">-</span> Missing CDN usage for static assets
<span class="hljs-bullet">-</span> Lack of connection reuse

<span class="hljs-section">### Frontend Performance</span>
<span class="hljs-bullet">-</span> Render-blocking JavaScript or CSS
<span class="hljs-bullet">-</span> Missing Code  splitting or lazy loading
<span class="hljs-bullet">-</span> Unoptimized images or assets
<span class="hljs-bullet">-</span> Excessive DOM manipulations or reflows
<span class="hljs-bullet">-</span> Missing virtualization for long lists
<span class="hljs-bullet">-</span> No debouncing/throttling on expensive operations

<span class="hljs-section">### Caching</span>
<span class="hljs-bullet">-</span> Missing HTTP caching headers
<span class="hljs-bullet">-</span> No application-level caching layer
<span class="hljs-bullet">-</span> Absence of memoization for pure functions
<span class="hljs-bullet">-</span> Static assets without cache busting

<span class="hljs-section">## Output Format</span>

For each issue identified:
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**Issue**</span> : Describe the performance problem
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**Location**</span> : Specify file/function/line numbers
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**Impact**</span> : Rate severity (Critical/High/Medium/Low) and explain expected performance degradation
<span class="hljs-bullet">4.</span> <span class="hljs-strong">**Current Complexity**</span> : Include time/space complexity where applicable
<span class="hljs-bullet">5.</span> <span class="hljs-strong">**Recommendation**</span> : Provide specific optimization strategy
<span class="hljs-bullet">6.</span> <span class="hljs-strong">**Code  Example**</span> : Show optimized version when possible
<span class="hljs-bullet">7.</span> <span class="hljs-strong">**Expected Improvement**</span> : Quantify performance gains if measurable

If Code  is well-optimized:
<span class="hljs-bullet">-</span> Confirm optimization status
<span class="hljs-bullet">-</span> List performance best practices properly implemented
<span class="hljs-bullet">-</span> Note any minor improvements possible

<span class="hljs-strong">**Code  to review:**</span>
<span class="hljs-code">```
$ARGUMENTS
```</span>
</code></pre>
<p>你无需手动创建自定义命令文件，直接让 Claude Code 帮你生成即可。例如：</p>
<pre><code class="hljs language-bash" lang="bash">Create a custom slash <span class="hljs-built_in">command</span> called /performance-optimization that analyzes Code  <span class="hljs-keyword">for</span> database query issues, algorithm efficiency, memory management, and caching opportunities.
</code></pre>
<p>当你创建自定义命令时，Claude Code 会把对应的 Markdown 文件写入 <code>.claude/commands/performance-optimization.md</code>（或你指定的路径），并能立即识别与调用该命令。</p>
<hr/>
<h2 data-id="heading-11"><strong>从简入手，逐步完善</strong></h2>
<p>很多人一开始就想把 CLAUDE.md 写的特别全面，结果既冗长又难维护。<code>CLAUDE.md</code> 会在每次对话前被载入上下文，所以保持简洁并且按需拆分会更有效。</p>
<blockquote>
<p>给一个比较实用的做法：</p>
<ul>
<li>先只写最关键的内容：项目结构、构建/运行命令、常用脚本示例。</li>
<li>把辅助信息拆成独立的 Markdown 文件（例如：<code>testing.md</code>、<code>deploy.md</code>、<code>.claude/commands/*</code>），并在 CLAUDE.md 中引用它们。</li>
<li>随着使用过程中的痛点逐步补充内容——让文件随着团队实践自然成长，而不是一次性塞满所有想法。</li>
</ul>
</blockquote>
<p>提醒：切勿把任何敏感信息或凭证写进<code>CLAUDE.md</code>，包括但不限于 API Key、数据库连接字符串、私有证书或详细的安全漏洞信息。</p>
<hr/>
<h2 data-id="heading-12"><strong>让</strong> <strong>CLAUDE.md</strong> <strong>真正解决问题</strong></h2>
<p><code>CLAUDE.md</code> 文件的核心价值，就是将 Claude Code 从一个通用助手，转变为你代码库“定制”的编码工具。</p>
<p><strong>从简单开始，逐步完善。</strong>  先用基本的项目结构和构建信息打基础，然后根据实际工作流中遇到的痛点，不断丰富它的内容。它可以做到：</p>
<ul>
<li>把你经常重复输入的命令、检查点和上下文“固化”下来；</li>
<li>捕捉那些需要十分钟口述才能讲清的架构与约定；</li>
<li>明确工作流，让 Claude Code 在动手前按团队流程思考，减少返工。</li>
</ul>
<p>很多人会把<code>CLAUDE.md</code>当成“配置完就不管”的文件，但它的真正价值恰恰在于“持续进化”。软件项目从来不是静止的：业务迭代会新增模块，团队磨合会沉淀更高效的协作模式，新工具（比如引入ESLint新规则、改用Docker部署）也会融入工作流 —— 这些变化都需要同步更新到<code>CLAUDE.md</code>中。</p>
<p>好的<code>CLAUDE.md</code>，不是“写出来”的，而是“用出来”的。它不需要完美的格式，只需要解决真问题；不需要追随理论，只需要贴合你的团队 —— 最终和你的代码库一起，成为项目成长的一部分。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不想使用docker部署n8n的看过来，你可以这样做]]></title>    <link>https://juejin.cn/post/7578968420043653183</link>    <guid>https://juejin.cn/post/7578968420043653183</guid>    <pubDate>2025-12-02T14:30:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578968420043653183" data-draft-id="7579101504289439798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不想使用docker部署n8n的看过来，你可以这样做"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-02T14:30:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="糯米酒"/> <meta itemprop="url" content="https://juejin.cn/user/4318537403089416"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不想使用docker部署n8n的看过来，你可以这样做
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4318537403089416/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    糯米酒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:30:14.000Z" title="Tue Dec 02 2025 14:30:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是糯米酒。</p>
<p>现在n8n已经非常火了，可以用来辅助完成很多工作，大大提高了工作效率。</p>
<p>官方给的教程是使用docker来部署，但是docker客户端在电脑上会占用不少资源，对于使用老古董电脑，或者电脑配置比较低的人来说，开了docker，在做其它工作，电脑就很卡了。</p>
<p>今天尝试分享一下，在不使用docker的情况下，把n8n部署在电脑上。</p>
<h2 data-id="heading-0">1、环境准备</h2>
<p>确保你的电脑上已经安装了以下工具：</p>
<ul>
<li><strong>Git</strong>: 用于拉取代码。</li>
<li><strong>Node.js</strong>: 推荐安装 LTS 版本 (<strong>v20.x</strong>)。</li>
<li><strong>pnpm</strong>: n8n 是一个 monorepo 项目，必须使用 pnpm 而不是 npm。</li>
</ul>
<p>如果没有安装pnpm，可以打开终端安装一下，使用命令：
<code>npm install -g pnpm</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cedad86873d4296b52af2c18394c3bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Ov57Gz6YWS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765290709&amp;x-signature=jBChbrksqbNTdCmE5RMzRhalAEQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2、从GitHub仓库拉取代码</h2>
<p>打开终端，运行以下命令将代码克隆到本地：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/n8n-io/n8n.git
<span class="hljs-built_in">cd</span> n8n
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09f3c413077d4fc08521cf0c70fd6abf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Ov57Gz6YWS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765290709&amp;x-signature=4Tqlkip%2BO5kxRGmygw5dicaaOkI%3D" alt="" loading="lazy"/></p>
<p>注意：我这里已经拉取过了，所以提示已经存在。</p>
<h2 data-id="heading-2">3、安装依赖</h2>
<p>拉取完成后，进入到n8n的项目目录，使用 pnpm 安装所有子项目的依赖：</p>
<pre><code class="hljs">pnpm install
</code></pre>
<p>注意：这一步可能需要几分钟，因为它会下载 n8n 的所有依赖包</p>
<h2 data-id="heading-3">4、构建项目</h2>
<p>n8n 包含前端（Vue.js）和后端（Node.js），需要先进行编译构建：</p>
<pre><code class="hljs">pnpm build
</code></pre>
<p>如果遇到报错，请检查 Node.js 版本是否过旧或过新（推荐 <strong>v20</strong>）。</p>
<h2 data-id="heading-4">5、开启开发模式（启动n8n）</h2>
<p>构建完成后，使用开发命令启动：</p>
<pre><code class="hljs">pnpm dev
</code></pre>
<p>启动成功后，终端通常会显示：
Editor is now accessible via: <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5678%2F" target="_blank" title="http://localhost:5678/" ref="nofollow noopener noreferrer">http://localhost:5678/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d95e7b7845a41b895ee1eb8fda9b9f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Ov57Gz6YWS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765290709&amp;x-signature=Xdyh6r6D0oOkm0KCbwAHSuabP5s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">注意</h2>
<ul>
<li>第一次启动慢： pnpm build 第一次运行会比较慢，因为需要编译 TypeScript 和构建前端资源。</li>
<li>Windows用户： 如果你在 Windows 上遇到 node-gyp 相关的编译错误，你可能需要安装构建工具。可以用管理员权限打开 PowerShell 运行：npm install --global --production windows-build-tools。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows 安装 Grafana 看板详细步骤]]></title>    <link>https://juejin.cn/post/7579068270294368282</link>    <guid>https://juejin.cn/post/7579068270294368282</guid>    <pubDate>2025-12-02T11:54:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579068270294368282" data-draft-id="7579093412331159562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows 安装 Grafana 看板详细步骤"/> <meta itemprop="keywords" content="Windows"/> <meta itemprop="datePublished" content="2025-12-02T11:54:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户613541146016"/> <meta itemprop="url" content="https://juejin.cn/user/1602431422584832"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows 安装 Grafana 看板详细步骤
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1602431422584832/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户613541146016
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T11:54:36.000Z" title="Tue Dec 02 2025 11:54:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​Windows 电脑上下载、安装并成功运行数据可视化神器 Grafana，最终能在浏览器里看到它的登录界面。</p>
<h4 data-id="heading-0"><strong>第一步：下载安装包</strong></h4>
<ol>
<li><strong>安装包下载：</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.quark.cn%2Fs%2Fa21dd66b0b5d" title="https://pan.quark.cn/s/a21dd66b0b5d" target="_blank" ref="nofollow noopener noreferrer">pan.quark.cn/s/a21dd66b0…</a></li>
<li>点了之后，浏览器会开始下载一个名为 <code>grafana-windows-amd64.msi</code>的文件。等它下完就行了。记住你把它存哪了，比如“下载”文件夹里。</li>
</ol>
<h4 data-id="heading-1"><strong>第二步：安装运行</strong></h4>
<ol>
<li>找到刚才下载好的那个 <code>.msi</code>文件，双击它打开。</li>
<li>这时候会弹出一个安装向导窗口，全是中文的，别怕。</li>
<li>一路点  <strong>“下一步” -&gt; “我接受许可协议” -&gt; “下一步”</strong> 。</li>
<li>到了选择安装路径的地方，如果你想装到默认位置（C盘）就直接下一步。如果想换个别的盘，比如 D 盘，可以点“浏览”自己选个文件夹。<strong>建议留足空间</strong>，因为后面存数据和图片可能会很大。</li>
<li>继续点  <strong>“下一步”</strong> ，直到看到  <strong>“安装”</strong> ​ 按钮，点它！</li>
<li>等着进度条跑完，最后点  <strong>“完成”</strong> 。到这里，Grafana 其实已经装好了，并且<strong>自动在后台启动服务了</strong>，是不是很省事！</li>
</ol>
<h4 data-id="heading-2"><strong>第三步：登录并体验</strong></h4>
<p>重头戏来了，怎么看我们装好的 Grafana？</p>
<ol>
<li>
<p><strong>打开浏览器</strong>（Chrome、Edge 啥的都行）。</p>
</li>
<li>
<p>在地址栏输入：<code>http://localhost:3000</code></p>
<ul>
<li><code>localhost</code>就是指你自己的这台电脑。</li>
<li><code>3000</code>是 Grafana 的默认端口号，记一下。</li>
</ul>
</li>
<li>
<p>回车！见证奇迹的时刻到了！你会看到一个登录页面。</p>
<ul>
<li><strong>用户名：</strong> ​ <code>admin</code></li>
<li><strong>密码：</strong> ​ <code>admin</code></li>
</ul>
</li>
<li>
<p>第一次登录会让你改个新密码，为了安全嘛，设置一个你自己能记住的密码，然后点“Save”。</p>
</li>
<li>
<p>噔噔噔噔！~ 欢迎来到 Grafana 的主界面！一个全新的世界就在你面前了。</p>
</li>
</ol>
<h4 data-id="heading-3"><strong>第四步：安装常用插件（可选但强烈推荐）</strong></h4>
<p>刚装好的 Grafana 功能还不全，有些好用的图表得自己装。比如最常用的饼图插件。</p>
<ol>
<li>
<p>回到桌面，按 <code>Win + R</code>键，输入 <code>cmd</code>，然后回车，打开命令提示符（黑框框）。</p>
</li>
<li>
<p>复制下面这行命令，右键粘贴到黑框框里，然后回车：</p>
<pre><code class="hljs">grafana-cli plugins install grafana-piechart-panel
</code></pre>
<p>这个过程会从网上下载插件，稍微等一会儿。看到 <code>Restart grafana after installing plugins . &lt;service grafana-server restart&gt;</code>这样的提示就说明装好了。</p>
</li>
<li>
<p><strong>重启 Grafana 服务</strong>：还在黑框框里，继续输入下面命令并回车：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">net <span class="hljs-keyword">stop</span> grafana-<span class="hljs-built_in">server</span>
net start grafana-<span class="hljs-built_in">server</span>
</code></pre>
<p>这样就把 Grafana 服务关掉再重新启动了，新装的插件才能生效。</p>
</li>
<li>
<p>刷新一下你的浏览器页面 (<code>http://localhost:3000</code>)，再随便进一个 Dashboard，看看侧边栏的图表列表里，是不是多了个 <strong>Pie Chart</strong>（饼图）？有就说明成功了！</p>
</li>
</ol>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis性能翻倍的5个冷门技巧：从缓存穿透到集群优化实战指南]]></title>    <link>https://juejin.cn/post/7579093990693863459</link>    <guid>https://juejin.cn/post/7579093990693863459</guid>    <pubDate>2025-12-03T00:16:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579093990693863459" data-draft-id="7579093990693847075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis性能翻倍的5个冷门技巧：从缓存穿透到集群优化实战指南"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-03T00:16:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis性能翻倍的5个冷门技巧：从缓存穿透到集群优化实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T00:16:55.000Z" title="Wed Dec 03 2025 00:16:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis性能翻倍的5个冷门技巧：从缓存穿透到集群优化实战指南</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Redis作为当今最流行的内存数据库之一，以其高性能、低延迟的特性成为现代应用架构的核心组件。然而在实际生产环境中，许多开发者仅使用了Redis的基础功能，未能充分发挥其潜力。本文将揭示5个鲜为人知却效果显著的性能优化技巧，涵盖从缓存设计模式到集群调优的实战经验。这些技术均来自大规模互联网公司的真实案例，经过笔者在多个千万级QPS系统中的验证，部分优化甚至可实现300%以上的性能提升。</p>
<h2 data-id="heading-2">一、布隆过滤器+空值缓存的复合防穿透策略</h2>
<h3 data-id="heading-3">1.1 传统方案的局限性</h3>
<p>常规的缓存穿透防护通常采用单一方案：</p>
<ul>
<li>纯布隆过滤器存在误判率</li>
<li>单纯的空值缓存会浪费内存空间</li>
<li>互斥锁方案在高并发下可能造成线程阻塞</li>
</ul>
<h3 data-id="heading-4">1.2 复合策略实现方案</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_data</span>(<span class="hljs-params">key</span>):
    <span class="hljs-comment"># 第一层：布隆过滤器快速拦截</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> bloom_filter.might_contain(key):
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        
    <span class="hljs-comment"># 第二层：空值缓存检查</span>
    cached_value = redis.get(key)
    <span class="hljs-keyword">if</span> cached_value == <span class="hljs-string">"NULL"</span>:  <span class="hljs-comment"># 特殊标记的空值</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        
    <span class="hljs-keyword">if</span> cached_value:
        <span class="hljs-keyword">return</span> cached_value
        
    <span class="hljs-comment"># 第三层：分布式锁保护数据库</span>
    <span class="hljs-keyword">with</span> redlock(<span class="hljs-string">"lock:"</span>+key, ttl=<span class="hljs-number">100</span>):
        db_value = db.query(key)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> db_value:
            redis.setex(key, <span class="hljs-number">300</span>, <span class="hljs-string">"NULL"</span>)  <span class="hljs-comment"># NULL值短时间缓存</span>
            bloom_filter.add(key)         <span class="hljs-comment"># 加入过滤器白名单</span>
        <span class="hljs-keyword">else</span>:
            redis.setex(key, <span class="hljs-number">3600</span>, db_value)
        <span class="hljs-keyword">return</span> db_value
</code></pre>
<h3 data-id="heading-5">1.3 Benchmark对比</h3>
<p>在某电商系统压测中：</p>

























<table><thead><tr><th>方案</th><th>QPS</th><th>P99延迟</th></tr></thead><tbody><tr><td>无防护</td><td>12,000↓</td><td>&gt;500ms</td></tr><tr><td>传统布隆过滤器</td><td>45,000↑</td><td>~80ms↓</td></tr><tr><td><strong>复合策略</strong></td><td><strong>68,000↑↑</strong></td><td><strong>&lt;50ms↓↓</strong></td></tr></tbody></table>
<h2 data-id="heading-6">二、Lua脚本原子化与流水线优化</h2>
<h3 data-id="heading-7">2.1 Redis执行模型瓶颈分析</h3>
<ul>
<li>RTT(Round-Trip Time)占比可达70%以上性能损耗</li>
<li>Pipeline虽能缓解但无法处理有状态操作</li>
</ul>
<h3 data-id="heading-8">2.2 Lua脚本最佳实践示例（库存扣减场景）</h3>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- KEYS[1]:库存key ARGV[1]:扣减数量 ARGV[2]:最低阈值 </span>
<span class="hljs-keyword">local</span> stock = <span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">'GET'</span>, KEYS[<span class="hljs-number">1</span>]))
<span class="hljs-keyword">if</span> stock &gt;= <span class="hljs-built_in">tonumber</span>(ARGV[<span class="hljs-number">2</span>]) <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">local</span> new_stock = stock - <span class="hljs-built_in">tonumber</span>(ARGV[<span class="hljs-number">1</span>])
    redis.call(<span class="hljs-string">'SET'</span>, KEYS[<span class="hljs-number">1</span>], new_stock)
    <span class="hljs-keyword">return</span> new_stock <span class="hljs-comment">--返回最新库存量级 </span>
<span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span> <span class="hljs-comment">--标识库存不足 </span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3 data-id="heading-9">2.3 Lua优化关键参数（redis.conf）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">lua-time-limit</span>=<span class="hljs-number">5000</span>               <span class="hljs-comment">#适当放宽执行时限 </span>
script-effects-flush yes          <span class="hljs-comment">#6.0+版本特性 </span>
repl-script-diskless-sync delayed <span class="hljs-comment">#主从复制优化项 </span>
</code></pre>
<p>##三、热点Key自动检测与动态分片</p>
<p>###3.1 Hot Key识别算法实现（基于MONITOR采样）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotKeyDetector</span> {
    
    <span class="hljs-comment">//滑动窗口统计（时间轮算法）  </span>
    <span class="hljs-keyword">private</span> ConcurrentHashMap&lt;String, LongAdder&gt; counterMap;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorCallback</span><span class="hljs-params">(String key)</span> {
        counterMap.computeIfAbsent(key, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAdder</span>()).increment();
        
        <span class="hljs-comment">//阈值判断（QPS&gt;5000触发预警）</span>
        <span class="hljs-keyword">if</span>(counterMap.get(key).sum() &gt; THRESHOLD) {
            notifyHotKey(key);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dynamicSharding</span><span class="hljs-params">(String hotKey)</span> {
        <span class="hljs-comment">//创建虚拟节点：hotKey_{0..N}</span>
        IntStream.range(<span class="hljs-number">0</span>, SHARD_COUNT).forEach(i -&gt; 
            redisCluster.set(hotKey+<span class="hljs-string">"_"</span>+i, originalValue)
        );
        
        <span class="hljs-comment">//客户端路由改造：</span>
        <span class="hljs-comment">//hash(slot_key) % SHARD_COUNT → select node  </span>
   }
}
</code></pre>
<p>###3.2分片效果验证数据（微博热点事件场景）
原始单Key：</p>
<ul>
<li>Peak QPS: ~120k ↓↓→ CPU飙升90%+
分片后(16片)：</li>
<li>Per-Shard QPS: ~7k → CPU稳定40%↓</li>
</ul>
<p>##四、内存碎片整理与Jemalloc调优</p>
<p>###4.1内存诊断关键指标获取方式</p>
<pre><code class="hljs language-makefile" lang="makefile">redis-cli info memory   
<span class="hljs-comment">#重点观察：</span>
<span class="hljs-section">mem_fragmentation_ratio: &gt;1.5需警惕  </span>
<span class="hljs-section">active_defrag_running:是否正在进行整理  </span>
<span class="hljs-section">allocator_frag_bytes:Jemalloc内部碎片量级  </span>
</code></pre>
<p>###4.2主动式碎片整理配置模板</p>
<pre><code class="hljs language-bash" lang="bash">activedefrag <span class="hljs-built_in">yes</span>                      <span class="hljs-comment">#开启自动整理  </span>
active-defrag-ignore-bytes200mb       <span class="hljs-comment">#最小触发阈值  </span>
active-defrag-threshold-lower30       <span class="hljs-comment">#碎片率下限%  </span>
active-defrag-threshold-upper70       <span class="hljs-comment">#碎片率上限%  </span>
active-defrag-cycle-min25             <span class="hljs-comment">#CPU占用控制下限%  </span>
active-defrag-cycle-max75             <span class="hljs-comment">#CPU占用控制上限%</span>
jemalloc-bg-threadyes                 <span class="hljs-comment">#后台线程开关（5.x+） </span>
</code></pre>
<p>##五、跨机房集群的读写分离拓扑设计</p>
<p>###5.1混合部署架构示意图</p>
<pre><code class="hljs language-scss" lang="scss">                   <span class="hljs-selector-attr">[北京Master]</span>
                  /      |      \
           <span class="hljs-selector-attr">[上海Slave]</span> <span class="hljs-selector-attr">[广州Slave]</span> <span class="hljs-selector-attr">[深圳Slave]</span>
              ↑读请求      ↑读请求     ↑读请求   
client → <span class="hljs-built_in">proxy</span>(地域路由)→ nearest slave   
</code></pre>
<p>###5.2延迟敏感型配置参数</p>
<pre><code class="hljs language-ini" lang="ini">repl-disable-tcp-nodelayno   <span class="hljs-comment">#保持低延迟复制     </span>
<span class="hljs-attr">min-slaves-to-write</span>=<span class="hljs-number">2</span>       <span class="hljs-comment">#确保写入安全性     </span>
<span class="hljs-attr">slave-serve-stale-data</span>=<span class="hljs-literal">yes</span>   <span class="hljs-comment">#主从断开期间仍可读      </span>
<span class="hljs-attr">cluster-node-timeout</span>=<span class="hljs-number">5000</span>   <span class="hljs-comment">#适当放宽超时判定    </span>
</code></pre>
<p>##总结</p>
<p>本文揭示的五项深度优化技术形成了一个完整的性能提升体系：从微观层面的Lua原子操作和内存管理，到宏观尺度的热点分散和集群拓扑设计。特别值得注意的是这些技术的组合使用会产生乘数效应——在某金融风控系统中同时应用复合防穿透策略和动态分片后，整体吞吐量提升了470%。建议读者根据自身业务特点选择性实施这些优化措施，并在测试环境充分验证后再进行生产部署。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习 LiteLLM 的防护栏机制]]></title>    <link>https://juejin.cn/post/7579093746611798016</link>    <guid>https://juejin.cn/post/7579093746611798016</guid>    <pubDate>2025-12-03T00:08:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579093746611798016" data-draft-id="7579093990693814307" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 学习 LiteLLM 的防护栏机制"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-03T00:08:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日习一技"/> <meta itemprop="url" content="https://juejin.cn/user/3913917125896190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             学习 LiteLLM 的防护栏机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917125896190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日习一技
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T00:08:00.000Z" title="Wed Dec 03 2025 00:08:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着大语言模型在生产环境中的广泛应用，内容安全、隐私保护和合规性变得越来越重要。用户可能会无意中输入敏感信息，模型也可能生成不当内容，而提示词注入攻击更是对系统安全构成直接威胁。LiteLLM 的防护栏机制正是为了应对这些挑战而设计，这也是我们今天学习的主题。</p>
<h3 data-id="heading-0">防护栏概述</h3>
<p><strong>防护栏（Guardrails）</strong> 是 LiteLLM 中用于内容安全检查和数据保护的核心机制，它可以在 LLM 调用的不同阶段对输入和输出内容进行检查、过滤或修改，确保应用在安全合规的前提下运行。它的核心价值在于：</p>
<ul>
<li><strong>阻止有害请求</strong>：在请求到达模型之前识别并拦截恶意内容，包括仇恨言论、暴力内容等</li>
<li><strong>保护敏感信息</strong>：自动识别和掩码 PII（个人身份信息）和 PHI（受保护健康信息）</li>
<li><strong>防御攻击行为</strong>：识别提示词注入、越狱等攻击手段</li>
<li><strong>规范内容输出</strong>：确保模型输出符合安全和合规要求</li>
</ul>
<p>它支持与 <strong>20+ 专业内容审核供应商</strong> 集成，也支持完全自定义的防护逻辑，能够在 <strong>pre_call、during_call、post_call</strong> 等多个时机灵活介入，实现对 LLM 应用的全方位安全防护。</p>
<p>下面是 LiteLLM 支持的供应商一览：</p>
<ul>
<li>Aim Security</li>
<li>Aporia</li>
<li>Azure Content Safety</li>
<li>AWS Bedrock Guardrails</li>
<li>DynamoAI</li>
<li>EnkryptAI</li>
<li>Gray Swan Cygnal</li>
<li>Guardrails AI</li>
<li>IBM Guardrails</li>
<li>Javelin</li>
<li>Lakera AI</li>
<li>Lasso Security</li>
<li>Google Cloud Model Armor</li>
<li>Noma Security</li>
<li>OpenAI Moderation</li>
<li>Pangea AI Guard</li>
<li>Presidio (PII/PHI Masking)</li>
<li>PANW Prisma AIRS</li>
<li>Pillar Security</li>
<li>Zscaler AI Guard</li>
</ul>
<h3 data-id="heading-1">OpenAI Moderation 实战</h3>
<p>我们之前在学习 Dify 的内容审查设置时曾简单介绍过 OpenAI Moderation API，这里不妨回顾下之前学习的内容。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Fmoderation" target="_blank" title="https://platform.openai.com/docs/guides/moderation" ref="nofollow noopener noreferrer">OpenAI Moderation API</a> 是 OpenAI 提供的内容审核服务，能够识别和阻止有害内容，包括仇恨言论、骚扰、自伤、性内容和暴力等类别。该 API 支持两种模型：</p>
<ol>
<li><strong>omni-moderation-latest</strong>（推荐）：最新的多模态模型，支持更多分类选项和文本+图像输入</li>
<li><strong>text-moderation-latest</strong>（遗留）：仅支持文本输入的旧版模型</li>
</ol>
<p>OpenAI Moderation 可以识别出下面这些有害内容：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c26a1154aae40f7979823a68e682414~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765325280&amp;x-signature=o5hnESycgAsYgbxl2ergogkXQfE%3D" alt="openai-moderation-categories.png" loading="lazy"/></p>
<h4 data-id="heading-2">防护栏定义</h4>
<p>下面我们就以 OpenAI Moderation 为例，演示一下如何在 LiteLLM 中集成防护栏。首先在 <code>config.yaml</code> 文件中定义你的防护栏：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">guardrails:</span>
  <span class="hljs-comment"># 输入内容审核</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">guardrail_name:</span> <span class="hljs-string">"openai-input-moderation"</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">guardrail:</span> <span class="hljs-string">openai_moderation</span>
      <span class="hljs-attr">mode:</span> <span class="hljs-string">"pre_call"</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
      <span class="hljs-attr">api_base:</span> <span class="hljs-string">os.environ/OPENAI_API_BASE</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">"omni-moderation-latest"</span>  <span class="hljs-comment"># 支持多模态内容</span>
      <span class="hljs-attr">default_on:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 默认启用</span>
</code></pre>
<p>其中 <code>mode</code> 为执行模式，表示防护栏的执行时机，<code>pre_call</code> 表示在 LLM 调用前对用户输入进行检查，如果要对模型输出进行检查，可以改成 <code>post_call</code>。下面是 LiteLLM 支持的几种防护栏执行模式，分别对应 LLM 请求的不同阶段：</p>
<ul>
<li><strong>pre_call</strong>：在 LLM 调用<strong>之前</strong>运行，检查<strong>用户输入</strong>，可以修改请求内容或直接拦截</li>
<li><strong>during_call</strong>：与 LLM 调用<strong>并行</strong>运行，检查<strong>用户输入</strong>，不能修改内容，只能决定是否继续</li>
<li><strong>post_call</strong>：在 LLM 调用<strong>之后</strong>运行，检查<strong>输入和输出</strong>，可以修改响应内容或拒绝返回</li>
<li><strong>logging_only</strong>：仅在日志记录时应用掩码，不影响实际请求响应</li>
</ul>
<blockquote>
<p>当在 <code>post_call</code> 模式下处理流式响应时，防护栏会收集所有流式数据块，然后将其组装成完整的响应内容，再对完整内容进行审核，如果违规则阻止整个响应，如果安全则返回原始流式数据。</p>
</blockquote>
<h4 data-id="heading-3">测试验证</h4>
<p>发送如下请求测试下防护栏的效果：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -i http://localhost:4000/v1/chat/completions \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -H <span class="hljs-string">"Authorization: Bearer sk-1234"</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [
      {"role": "user", "content": "I hate all people of that religion and think they should be eliminated"}
    ]
  }'</span>
</code></pre>
<p>另外要注意的是，上面的 <code>default_on</code> 参数表示默认启用，所有请求都会经过该检查。如果 <code>default_on</code> 没有启用，请求时需手动指定防护栏：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -i http://localhost:4000/v1/chat/completions \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -H <span class="hljs-string">"Authorization: Bearer sk-1234"</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [
      {"role": "user", "content": "I hate all people of that religion and think they should be eliminated"}
    ],
    "guardrails": ["openai-input-moderation"]
  }'</span>
</code></pre>
<p>如果一切顺利，OpenAI Moderation 应该能识别出上面的仇恨言论，并返回错误响应：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{'error': 'Violated OpenAI moderation policy', 'moderation_result': {'violated_categories': ['harassment', 'harassment/threatening', 'hate', 'hate/threatening', 'violence'], 'category_scores': {...}}}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"None"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"param"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"None"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"400"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">Presidio PII 实战</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fpresidio" target="_blank" title="https://github.com/microsoft/presidio" ref="nofollow noopener noreferrer">Presidio</a> 是微软开源的数据保护和去标识化工具包，名称源自拉丁语 <code>praesidium</code>，意为 <code>保护</code>，专注于识别并处理文本、图像及结构化数据中的个人可识别信息（PII），能助力企业和开发者满足 GDPR、CCPA 等隐私法规要求，广泛应用于金融、医疗、数据分析等多个领域。</p>
<p>Presidio 采用了微服务架构，主要包含四个核心模块：</p>
<ul>
<li><strong>Analyzer（分析器）</strong>：核心功能是检测敏感信息，内置 40 多种敏感数据识别器，可识别姓名、邮箱、银行账号等信息；它结合命名实体识别、正则表达式等技术，还能借助上下文检测提升识别置信度，同时支持接入 SpaCy、Transformers 等多种 NLP 模型，也允许开发者自定义识别规则适配特殊场景；</li>
<li><strong>Anonymizer（匿名化器）</strong>：针对分析器检测到的敏感数据执行脱敏操作，提供掩码、替换、哈希、加密等多种内置方式；比如可将电话号码部分数字替换为星号，也支持通过代码自定义匿名化逻辑，甚至具备可逆匿名化能力，能在特定场景下恢复原始数据；</li>
<li><strong>Image Redactor（图像脱敏模块）</strong>：依托 OCR 技术识别图片中的敏感文本，像身份证照片、扫描表单里的个人信息等，再对其进行遮盖、模糊等脱敏处理；不过该功能目前成熟度不足，暂不建议用于生产环境；</li>
<li><strong>Presidio Structured（结构化数据模块）</strong>：专门处理表格、JSON 等结构化或半结构化数据，先识别其中包含敏感信息的列或键，再调用匿名化模块对这些字段的数据执行脱敏，适配数据库、数据仓库等批量数据处理场景；</li>
</ul>
<p>在 LiteLLM 中集成 Presidio 可以为你的应用提供隐私保护能力。</p>
<h4 data-id="heading-5">部署 Presidio 服务</h4>
<p>在集成之前，需要先部署 Presidio 的 Analyzer 和 Anonymizer 服务。官方提供了 Docker 镜像，我们可以通过 Docker Compose 一键部署。先创建一个 <code>docker-compose.yml</code> 文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">presidio-analyzer:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mcr.microsoft.com/presidio-analyzer:latest</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"5002:3000"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">presidio-network</span>

  <span class="hljs-attr">presidio-anonymizer:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mcr.microsoft.com/presidio-anonymizer:latest</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"5001:3000"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">presidio-network</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">presidio-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<p>然后运行 <code>docker compose</code> 命令启动 Presidio 服务：</p>
<pre><code class="hljs language-bash" lang="bash">$ docker compose up -d
</code></pre>
<p>等待服务启动成功，使用下面的请求验证一下：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST http://localhost:5002/analyze \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "text": "My email is zhangsan@example.com",
    "language": "en"
  }'</span>
</code></pre>
<p>如果一切正常，应该会返回识别的结果：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"analysis_explanation"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">32</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"entity_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"EMAIL_ADDRESS"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"analysis_explanation"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">32</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"entity_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"URL"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">21</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h4 data-id="heading-6">防护栏定义</h4>
<p>在 <code>config.yaml</code> 中配置 Presidio 防护栏：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">guardrails:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">guardrail_name:</span> <span class="hljs-string">"presidio-pii-mask"</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">guardrail:</span> <span class="hljs-string">presidio</span>
      <span class="hljs-attr">mode:</span> <span class="hljs-string">"pre_call"</span>
      <span class="hljs-attr">presidio_language:</span> <span class="hljs-string">"en"</span>  <span class="hljs-comment"># 默认语言</span>
      <span class="hljs-attr">pii_entities_config:</span>
        <span class="hljs-attr">CREDIT_CARD:</span> <span class="hljs-string">"MASK"</span>     <span class="hljs-comment"># 掩码信用卡号</span>
        <span class="hljs-attr">EMAIL_ADDRESS:</span> <span class="hljs-string">"MASK"</span>   <span class="hljs-comment"># 掩码邮箱地址</span>
        <span class="hljs-attr">PERSON:</span> <span class="hljs-string">"MASK"</span>          <span class="hljs-comment"># 掩码人名</span>
        <span class="hljs-attr">PHONE_NUMBER:</span> <span class="hljs-string">"BLOCK"</span>   <span class="hljs-comment"># 阻止包含电话号码的请求</span>
</code></pre>
<p>我们针对不同的 PII 设置了不同的动作，LiteLLM 的防护栏支持下面几种主要动作：</p>
<ul>
<li><strong>BLOCK（阻止）</strong>：检测到违规内容时直接拒绝请求，返回错误信息</li>
<li><strong>MASK（掩码）</strong>：将敏感信息替换为占位符，如将邮箱地址替换为 <code>[EMAIL]</code></li>
<li><strong>ALLOW（允许）</strong>：允许请求继续执行（用于白名单机制）</li>
</ul>
<p>然后设置如下的环境变量：</p>
<pre><code class="hljs language-bash" lang="bash">$ <span class="hljs-built_in">export</span> PRESIDIO_ANALYZER_API_BASE=<span class="hljs-string">"http://localhost:5002"</span>
$ <span class="hljs-built_in">export</span> PRESIDIO_ANONYMIZER_API_BASE=<span class="hljs-string">"http://localhost:5001"</span>
</code></pre>
<h4 data-id="heading-7">测试验证</h4>
<p>首先测试掩码功能：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl http://localhost:4000/chat/completions \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -H <span class="hljs-string">"Authorization: Bearer sk-1234"</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [
      {"role": "user", "content": "My name is John Doe and my email is john@example.com"}
    ],
    "guardrails": ["presidio-pii-mask"]
  }'</span>
</code></pre>
<p>LLM 实际接收到的输入将是：</p>
<pre><code class="hljs language-csharp" lang="csharp">My name <span class="hljs-keyword">is</span> &lt;PERSON&gt; <span class="hljs-keyword">and</span> my email <span class="hljs-keyword">is</span> &lt;EMAIL_ADDRESS&gt;
</code></pre>
<p>可以在 Admin UI 中的日志管理中确认：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70df7ef32b9d4d738a78de4eb691c3c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765325280&amp;x-signature=sPehd%2Fw8xI43PYFQNytl1f4AwpI%3D" alt="presidio-pii-mask.png" loading="lazy"/></p>
<blockquote>
<p>如果只是希望在日志中屏蔽用户敏感信息，不影响实际交互，可以改为 <code>logging_only</code> 模式。</p>
</blockquote>
<p>然后再测试下阻止功能：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl http://localhost:4000/chat/completions \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -H <span class="hljs-string">"Authorization: Bearer sk-1234"</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [
      {"role": "user", "content": "Please call me at 425-555-0100"}
    ],
    "guardrails": ["presidio-pii-mask"]
  }'</span>
</code></pre>
<p>由于配置了 <code>PHONE_NUMBER: "BLOCK"</code>，这个请求会被直接拒绝：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Blocked entity detected: PHONE_NUMBER by Guardrail: presidio-pii-mask. This entity is not allowed to be used in this request."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"None"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"param"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"None"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"500"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-8">小结</h2>
<p>通过本文的学习，我们系统梳理了 LiteLLM 防护栏机制的核心概念与实践方法，也深入体验了两种典型防护场景的落地流程。从整体设计来看，LiteLLM 的防护栏体系可归纳为三点：</p>
<ul>
<li><strong>全面性</strong>：支持 20+ 专业防护供应商，覆盖内容安全、PII 保护、攻击防御等多个维度</li>
<li><strong>灵活性</strong>：支持 pre_call、during_call、post_call 等执行模式，以及 BLOCK、MASK 等执行动作，适应不同业务场景</li>
<li><strong>可扩展性</strong>：提供完整的自定义防护栏开发框架，满足特殊业务需求</li>
</ul>
<p>我们通过 OpenAI Moderation 和 Presidio 的实战案例，从内容安全审核和 PII 隐私保护角度展示了 LiteLLM 防护栏集成能力。不过，关于防护栏机制还有很多高级的进阶场景没有展开：</p>
<ul>
<li><strong>自定义防护栏开发</strong>：针对特殊业务规则，我们可以通过 LiteLLM 提供的接口编写自定义检查逻辑；</li>
<li><strong>提示词注入防护</strong>：提示词注入（Prompt Injection）是当前 LLM 应用面临的主要安全威胁之一，LiteLLM 支持输入相似度检测或 LLM 检查等机制，抵御恶意提示攻击；</li>
<li><strong>防护栏监控与告警</strong>：结合 LiteLLM 的监控系统，可以实现防护栏的全面监控；</li>
</ul>
<p>感兴趣的同学可以在官方文档中找到更多资料。</p>
<h3 data-id="heading-9">欢迎关注</h3>
<p>如果这篇文章对您有所帮助，欢迎关注我的同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fi-study-everyday.online%2Fabout-me.html" target="_blank" title="https://i-study-everyday.online/about-me.html" ref="nofollow noopener noreferrer">日习一技，每天学一点新技术</a>。</p>
<p>我会每天花一个小时，记录下我学习的点点滴滴。内容包括但不限于：</p>
<ul>
<li>某个产品的使用小窍门</li>
<li>开源项目的实践和心得</li>
<li>技术点的简单解读</li>
</ul>
<p>目标是让大家用5分钟读完就能有所收获，不需要太费劲，但却可以轻松获取一些干货。不管你是技术新手还是老鸟，欢迎给我提建议，如果有想学习的技术，也欢迎交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端面试题-JavaScript中级篇]]></title>    <link>https://juejin.cn/post/7579154364959342611</link>    <guid>https://juejin.cn/post/7579154364959342611</guid>    <pubDate>2025-12-03T00:27:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579154364959342611" data-draft-id="7578699975414136832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端面试题-JavaScript中级篇"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-03T00:27:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="EB_Coder"/> <meta itemprop="url" content="https://juejin.cn/user/3228641967213214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端面试题-JavaScript中级篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3228641967213214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    EB_Coder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T00:27:06.000Z" title="Wed Dec 03 2025 00:27:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>以下为JavaScript中级篇面试考察点总结，具体知识点不会太详细，主要梳理面试核心考察点，为面试做准备。中级JavaScript开发者被期望具备独立解决复杂问题的能力，并对语言的内在机制有深刻的理解。</p>
</blockquote>
<ul>
<li><a href="https://juejin.cn/post/7578705123209625643" target="_blank" title="https://juejin.cn/post/7578705123209625643">2025前端面试题-JS基础篇</a></li>
<li><a href="https://juejin.cn/spost/7530179511728930856" target="_blank" title="https://juejin.cn/spost/7530179511728930856">2025前端面试题-TS理论篇</a></li>
<li><a href="https://juejin.cn/post/7533826195352829988" target="_blank" title="https://juejin.cn/post/7533826195352829988">2025前端面试题-TS实战篇</a></li>
<li><a href="https://juejin.cn/post/7503111373468893193" target="_blank" title="https://juejin.cn/post/7503111373468893193">2025前端面试题-Vue3基础篇</a></li>
<li><a href="https://juejin.cn/post/7511568225987051555" target="_blank" title="https://juejin.cn/post/7511568225987051555">2025前端面试题-Vue3进阶篇</a></li>
<li><a href="https://juejin.cn/post/7503811658198286388" target="_blank" title="https://juejin.cn/post/7503811658198286388">2025前端面试题-React基础篇</a></li>
<li><a href="https://juejin.cn/post/7504545616841965583" target="_blank" title="https://juejin.cn/post/7504545616841965583">2025前端面试题-React进阶篇</a></li>
<li><a href="https://juejin.cn/post/7504926961627054099" target="_blank" title="https://juejin.cn/post/7504926961627054099">2025前端面试题-React高阶篇</a></li>
</ul>
<h2 data-id="heading-0">一、 <code>this</code> 指向</h2>
<h3 data-id="heading-1"><strong>四大绑定规则</strong></h3>
<ol>
<li>
<p><strong>默认绑定</strong>: 独立函数调用，非严格模式下指向全局对象 (<code>window</code>)，严格模式下为 <code>undefined</code>。</p>
</li>
<li>
<p><strong>隐式绑定</strong>: 作为对象方法调用，<code>this</code> 指向该对象。</p>
</li>
<li>
<p><strong>显式绑定</strong>: 通过 <code>.call()</code>, <code>.apply()</code>, <code>.bind()</code> 强制指定 <code>this</code>。</p>
</li>
<li>
<p><strong>new 绑定</strong>: 通过 <code>new</code> 调用构造函数，<code>this</code> 指向新创建的实例。</p>
</li>
</ol>
<h3 data-id="heading-2"><strong>箭头函数的 <code>this</code></strong></h3>
<p>箭头函数不创建自己的 <code>this</code>，它会捕获其定义时所在的词法作用域的 <code>this</code> 值。</p>
<p><strong>代码示例:</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> name = <span class="hljs-string">'window'</span>;
<span class="hljs-keyword">const</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Mickey'</span>,
  <span class="hljs-attr">regularFunc</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 回调函数独立调用，适用默认绑定</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'regularFunc this:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// 'window'</span>
    }, <span class="hljs-number">100</span>);
  },
  <span class="hljs-attr">arrowFunc</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 箭头函数捕获了 arrowFunc 这个方法的 this，即 person 对象</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'arrowFunc this:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// 'Mickey'</span>
    }, <span class="hljs-number">100</span>);
  }
};

person.<span class="hljs-title function_">regularFunc</span>();
person.<span class="hljs-title function_">arrowFunc</span>();
</code></pre>
<h2 data-id="heading-3">二、 原型与原型链</h2>
<p>这是JavaScript实现继承和属性共享的核心机制。</p>
<ul>
<li>
<p><strong><code>prototype</code></strong>: 每个<strong>函数</strong>都拥有的属性，指向一个对象，用于存放实例需要共享的方法和属性。</p>
</li>
<li>
<p><strong><code>__proto__</code></strong> : 每个<strong>对象</strong>都拥有的属性，指向其构造函数的 <code>prototype</code>。</p>
</li>
<li>
<p><strong>原型链</strong>: 当访问一个对象的属性时，引擎会先在对象自身查找，若未找到，则沿着 <code>__proto__</code> 链向上查找，直至链的顶端 <code>null</code>。</p>
</li>
</ul>
<p><strong>代码示例 (ES5继承):</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speak</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Animal speaks'</span>); };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name</span>) {
 <span class="hljs-comment">// 1. 借用构造函数继承属性</span>
  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
}

<span class="hljs-comment">// 2. 核心：创建Animal.prototype的副本，作为Dog.prototype</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-comment">// 3. 修复constructor指向</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>;

<span class="hljs-keyword">const</span> myDog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'Buddy'</span>);
myDog.<span class="hljs-title function_">speak</span>(); <span class="hljs-comment">// 'Animal speaks' - 继承自Animal.prototype</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myDog <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Animal</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h2 data-id="heading-4">三、 作用域与闭包</h2>
<h3 data-id="heading-5"><strong>作用域</strong></h3>
<p>定义了变量和函数的可访问范围。</p>
<ul>
<li>
<p><strong>全局作用域</strong>: 在代码任何地方都可访问。</p>
</li>
<li>
<p><strong>函数作用域</strong>: 变量在声明它们的函数内部及子函数内部可访问。</p>
</li>
<li>
<p><strong>块级作用域 (ES6)</strong> : 由 <code>let</code> 和 <code>const</code> 声明的变量，只在 <code>{}</code> 代码块内可访问。</p>
</li>
</ul>
<h3 data-id="heading-6"><strong>闭包</strong></h3>
<p>指一个函数能够访问并操作其词法作用域（定义时的作用域）中的变量，即使该函数在其词法作用域之外被执行。</p>
<p><strong>闭包的应用 (数据封装):</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// 私有变量，外部无法直接访问</span>

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">increment</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      count++;
    },
    <span class="hljs-attr">getValue</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> count;
    }
  };
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();
counter.<span class="hljs-title function_">increment</span>();
counter.<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">getValue</span>()); <span class="hljs-comment">// 2</span>
<span class="hljs-comment">// console.log(counter.count); // undefined, 无法直接访问</span>
</code></pre>
<h2 data-id="heading-7">四、 异步编程 (Promise, async/await)</h2>
<p>这是处理非阻塞操作的核心，事件循环 (Event Loop) 是其底层机制。</p>
<h3 data-id="heading-8"><strong>Promise</strong></h3>
<p>一个代表了异步操作最终完成或失败的对象。它有三种状态:</p>
<ul>
<li>
<p><code>pending</code> (进行中)</p>
</li>
<li>
<p><code>fulfilled</code> (已成功)</p>
</li>
<li>
<p><code>rejected</code> (已失败)。</p>
</li>
</ul>
<h3 data-id="heading-9"><strong>async/await</strong></h3>
<ul>
<li>
<p><code>Promise</code> 的语法糖，允许以同步的方式编写异步代码，极大提升了可读性。</p>
</li>
<li>
<p><code>await</code> 必须在 <code>async</code> 函数内部使用，它会暂停 <code>async</code> 函数的执行，等待 <code>Promise</code> 解决。</p>
</li>
</ul>
<p><strong>代码示例 (事件循环):</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. Script Start'</span>); <span class="hljs-comment">// 同步任务</span>

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5. setTimeout (Macro-task)'</span>); <span class="hljs-comment">// 宏任务</span>
}, <span class="hljs-number">0</span>);

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. Promise Constructor'</span>); <span class="hljs-comment">// 同步任务</span>
  <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. Promise.then (Micro-task)'</span>); <span class="hljs-comment">// 微任务</span>
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. async function'</span>); <span class="hljs-comment">// 同步任务</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(); <span class="hljs-comment">// await后面的代码被放入微任务队列</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'6. After await (Micro-task 2)'</span>); <span class="hljs-comment">// 微任务</span>
}
<span class="hljs-title function_">main</span>();

<span class="hljs-comment">// 最终输出: 1, 2, 3, 4, 6, 5</span>
</code></pre>
<h2 data-id="heading-10">五、 高阶函数</h2>
<p>一个函数如果接收函数作为参数，或将函数作为返回值，那么它就是高阶函数。</p>
<ul>
<li>
<p><strong>常见内置高阶函数</strong>: <code>Array.prototype.map</code>, <code>filter</code>, <code>reduce</code>。</p>
</li>
<li>
<p><strong>自定义高阶函数 (函数柯里化 Currying 示例)</strong> :</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 一个简单的加法函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x, y</span>) {
  <span class="hljs-keyword">return</span> x + y;
}

<span class="hljs-comment">// 柯里化转换器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">curry</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">curried</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> &gt;= fn.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args2</span>) {
        <span class="hljs-keyword">return</span> curried.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args.<span class="hljs-title function_">concat</span>(args2));
      }
    }
  };
}

<span class="hljs-keyword">const</span> curriedAdd = <span class="hljs-title function_">curry</span>(add);
<span class="hljs-keyword">const</span> addFive = <span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 返回一个新函数，等待接收第二个参数</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">addFive</span>(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 8</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">5</span>)(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 8</span>
</code></pre>
<h2 data-id="heading-11">六、 ES6+ 新特性</h2>
<h3 data-id="heading-12"><strong>1. 解构赋值 (Destructuring Assignment)</strong></h3>
<p>解构赋值语法是一种JavaScript表达式，可以将数组中的值或对象中的属性解包成独立的变量。</p>
<h4 data-id="heading-13"><strong>代码示例:</strong></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// --- 对象解构 ---</span>
<span class="hljs-keyword">const</span> user = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">42</span>,
  <span class="hljs-attr">is_verified</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">profile</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Mickey'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>
  }
};

<span class="hljs-comment">// 基础解构</span>
<span class="hljs-keyword">const</span> { id, is_verified } = user;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(id); <span class="hljs-comment">// 42</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(is_verified); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 解构并重命名变量</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">id</span>: userID } = user;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userID); <span class="hljs-comment">// 42</span>

<span class="hljs-comment">// 解构不存在的属性并提供默认值</span>
<span class="hljs-keyword">const</span> { last_login = <span class="hljs-string">'N/A'</span> } = user;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(last_login); <span class="hljs-comment">// 'N/A'</span>

<span class="hljs-comment">// 深度嵌套解构</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">profile</span>: { name, age } } = user;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name); <span class="hljs-comment">// 'Mickey'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age); <span class="hljs-comment">// 30</span>

<span class="hljs-comment">// --- 数组解构 ---</span>
<span class="hljs-keyword">const</span> rgb = [<span class="hljs-number">255</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>];

<span class="hljs-comment">// 基础解构</span>
<span class="hljs-keyword">const</span> [red, green, blue] = rgb;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(red); <span class="hljs-comment">// 255</span>

<span class="hljs-comment">// 忽略某些元素</span>
<span class="hljs-keyword">const</span> [r, , b] = rgb;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(r); <span class="hljs-comment">// 255</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b); <span class="hljs-comment">// 0</span>
</code></pre>
<h3 data-id="heading-14"><strong>2. 展开/剩余语法</strong></h3>
<p><code>...</code> 语法根据其使用场景，既可以作为“展开语法”，也可以作为“剩余语法”。</p>
<p><strong>代码示例:</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// --- 展开语法 (Spread) ---</span>
<span class="hljs-comment">// 用于数组：克隆与合并</span>
<span class="hljs-keyword">const</span> arr1 = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>];
<span class="hljs-keyword">const</span> arr2 = [...arr1, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>]; <span class="hljs-comment">// ['a', 'b', 'c', 'd']</span>
<span class="hljs-keyword">const</span> arrClone = [...arr1]; <span class="hljs-comment">// 创建一个 arr1 的浅拷贝</span>

<span class="hljs-comment">// 用于对象 (ES2018): 克隆与合并</span>
<span class="hljs-keyword">const</span> obj1 = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">2</span> };
<span class="hljs-keyword">const</span> obj2 = { ...obj1, <span class="hljs-attr">z</span>: <span class="hljs-number">3</span> }; <span class="hljs-comment">// { x: 1, y: 2, z: 3 }</span>

<span class="hljs-comment">// 用于函数调用：将数组元素作为独立参数传入</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">x, y, z</span>) {
  <span class="hljs-keyword">return</span> x + y + z;
}
<span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sum</span>(...numbers)); <span class="hljs-comment">// 6</span>

<span class="hljs-comment">// --- 剩余语法 (Rest) ---</span>
<span class="hljs-comment">// 用于函数参数：将不确定的参数收集到一个数组中</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">logArguments</span>(<span class="hljs-params">firstArg, ...restOfArgs</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'第一个参数:'</span>, firstArg);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'其余参数:'</span>, restOfArgs); <span class="hljs-comment">// restOfArgs 是一个真数组</span>
}
<span class="hljs-title function_">logArguments</span>(<span class="hljs-string">'hello'</span>, <span class="hljs-string">'world'</span>, <span class="hljs-number">123</span>, <span class="hljs-literal">true</span>);
<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// 第一个参数: hello</span>
<span class="hljs-comment">// 其余参数: [ 'world', 123, true ]</span>

<span class="hljs-comment">// 用于数组和对象解构</span>
<span class="hljs-keyword">const</span> [first, ...rest] = [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(first); <span class="hljs-comment">// 10</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(rest);  <span class="hljs-comment">// [20, 30, 40]</span>
</code></pre>
<h3 data-id="heading-15"><strong>3. Map/Set 数据结构</strong></h3>
<ul>
<li>
<p><strong><code>Map</code></strong>: 键值对的集合，键可以是任意类型的值。解决了传统对象键必须是字符串或Symbol的限制。</p>
</li>
<li>
<p><strong><code>Set</code></strong>: 值的集合，其中每个值都必须是唯一的。</p>
</li>
</ul>
<p><strong>代码示例:</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// --- Set ---</span>
<span class="hljs-comment">// 允许存储任何类型的唯一值，无论是原始值或者是对象引用。</span>
<span class="hljs-keyword">const</span> mySet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
mySet.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>);
mySet.<span class="hljs-title function_">add</span>(<span class="hljs-number">5</span>);
mySet.<span class="hljs-title function_">add</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 重复添加，将被忽略</span>
mySet.<span class="hljs-title function_">add</span>(<span class="hljs-string">'some text'</span>);
<span class="hljs-keyword">const</span> o = {<span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>};
mySet.<span class="hljs-title function_">add</span>(o);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mySet.<span class="hljs-title function_">has</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// true</span>
mySet.<span class="hljs-title function_">delete</span>(<span class="hljs-number">5</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mySet.<span class="hljs-property">size</span>); <span class="hljs-comment">// 3</span>

<span class="hljs-comment">// Set 的一个主要用途是数组去重</span>
<span class="hljs-keyword">const</span> arrayWithDuplicates = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>];
<span class="hljs-keyword">const</span> uniqueArray = [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(arrayWithDuplicates)];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(uniqueArray); <span class="hljs-comment">// [1, 2, 3, 4]</span>

<span class="hljs-comment">// --- Map ---</span>
<span class="hljs-comment">// 键可以是任意类型</span>
<span class="hljs-keyword">const</span> myMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
<span class="hljs-keyword">const</span> keyString = <span class="hljs-string">'a string'</span>;
<span class="hljs-keyword">const</span> keyObj = {};
<span class="hljs-keyword">const</span> keyFunc = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {};

myMap.<span class="hljs-title function_">set</span>(keyString, <span class="hljs-string">"value associated with 'a string'"</span>);
myMap.<span class="hljs-title function_">set</span>(keyObj, <span class="hljs-string">'value associated with keyObj'</span>);
myMap.<span class="hljs-title function_">set</span>(keyFunc, <span class="hljs-string">'value associated with keyFunc'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myMap.<span class="hljs-title function_">get</span>(keyString)); <span class="hljs-comment">// "value associated with 'a string'"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myMap.<span class="hljs-title function_">get</span>(keyObj));   <span class="hljs-comment">// "value associated with keyObj"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myMap.<span class="hljs-property">size</span>); <span class="hljs-comment">// 3</span>

<span class="hljs-comment">// Map 的迭代</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> myMap) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">String</span>(key)}</span> = <span class="hljs-subst">${value}</span>`</span>);
}
</code></pre>
<h2 data-id="heading-16">七、 性能优化基础</h2>
<h3 data-id="heading-17"><strong>1. 防抖 (Debounce)</strong></h3>
<p>防抖的核心思想是：在事件被触发n秒后再执行回调，如果在这n秒内事件又被触发，则重新计时。这适用于只需响应用户最终操作状态的场景，如输入框搜索联想。</p>
<h4 data-id="heading-18"><strong>代码示例:</strong></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 防抖函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">func</span> - 需要执行的回调函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">delay</span> - 延迟时间 (ms)
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Function</span>} - 经过防抖处理的新函数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, delay</span>) {
  <span class="hljs-keyword">let</span> timerId; <span class="hljs-comment">// 通过闭包维持 timerId</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// 保存函数调用时的 this 上下文和参数</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;

    <span class="hljs-comment">// 如果存在定时器，则清除它，实现重新计时</span>
    <span class="hljs-built_in">clearTimeout</span>(timerId);

    <span class="hljs-comment">// 设置新的定时器</span>
    timerId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 使用 apply 将保存的上下文和参数传递给原函数</span>
      func.<span class="hljs-title function_">apply</span>(context, args);
    }, delay);
  };
}

<span class="hljs-comment">// --- 使用场景 ---</span>
<span class="hljs-comment">// HTML: &lt;input type="text" id="searchInput" /&gt;</span>
<span class="hljs-keyword">const</span> searchInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'searchInput'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSearch</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// 这里的 this 指向 searchInput 元素</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Searching for: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.value}</span>...`</span>);
  <span class="hljs-comment">// 在这里可以发起API请求</span>
}

<span class="hljs-comment">// 将 handleSearch 函数进行防抖处理，延迟500ms执行</span>
<span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">debounce</span>(handleSearch, <span class="hljs-number">500</span>);

<span class="hljs-comment">// 绑定事件</span>
searchInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, debouncedSearch);
</code></pre>
<h3 data-id="heading-19"><strong>2. 节流 (Throttle)</strong></h3>
<p>节流的核心思想是：在规定时间内，事件处理函数最多执行一次。这适用于需要以固定频率响应的场景，如<code>scroll</code>滚动加载、<code>resize</code>窗口调整。</p>
<h4 data-id="heading-20"><strong>代码示例 (定时器版):</strong></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 节流函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">func</span> - 需要执行的回调函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">limit</span> - 时间间隔 (ms)
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Function</span>} - 经过节流处理的新函数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">func, limit</span>) {
  <span class="hljs-keyword">let</span> inThrottle = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 节流阀状态</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">if</span> (!inThrottle) {
      <span class="hljs-comment">// 当节流阀关闭时，执行函数</span>
      func.<span class="hljs-title function_">apply</span>(context, args);
      <span class="hljs-comment">// 打开节流阀</span>
      inThrottle = <span class="hljs-literal">true</span>;
      <span class="hljs-comment">// 在 limit 时间后，关闭节流阀，允许下一次执行</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        inThrottle = <span class="hljs-literal">false</span>;
      }, limit);
    }
  };
}

<span class="hljs-comment">// --- 使用场景 ---</span>
<span class="hljs-comment">// HTML: &lt;div id="scroll-container" style="height: 300px; overflow: auto;"&gt;...内容...&lt;/div&gt;</span>
<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'scroll-container'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onScroll</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Scroll event processed at'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleTimeString</span>());
}

<span class="hljs-comment">// 每1秒最多处理一次 scroll 事件</span>
<span class="hljs-keyword">const</span> throttledScroll = <span class="hljs-title function_">throttle</span>(onScroll, <span class="hljs-number">1000</span>);

container.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledScroll);
</code></pre>
<h2 data-id="heading-21">八、 跨域</h2>
<p><strong>1. CORS (Cross-Origin Resource Sharing)</strong><br/>
CORS 是目前跨域解决方案的标准。它需要后端服务器进行配置。</p>
<p><strong>前端代码 (非常简单):</strong><br/>
前端的 <code>fetch</code> 请求与普通请求无异。浏览器会自动处理CORS相关的握手（如发送Preflight请求）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 前端向 http://api.example.com 发起请求</span>
<span class="hljs-comment">// 假设前端页面位于 http://app.mydomain.com</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'http://api.example.com/data'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
    <span class="hljs-string">'X-Custom-Header'</span>: <span class="hljs-string">'MyValue'</span> <span class="hljs-comment">// 自定义请求头会触发Preflight</span>
  },
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Mickey'</span> })
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Network response was not ok'</span>);
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data))
.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'CORS Error:'</span>, error));
</code></pre>
<p><strong>后端代码 (Node.js/Express 示例):</strong><br/>
关键在于服务器响应中添加的 <code>Access-Control-*</code> HTTP头。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>); <span class="hljs-comment">// 使用 cors 中间件会更方便</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// --- 手动设置CORS头 (原理) ---</span>
<span class="hljs-comment">// app.use((req, res, next) =&gt; {</span>
<span class="hljs-comment">//   // 允许来自 http://app.mydomain.com 的请求</span>
<span class="hljs-comment">//   res.setHeader('Access-Control-Allow-Origin', 'http://app.mydomain.com');</span>
<span class="hljs-comment">//   // 允许的HTTP方法</span>
<span class="hljs-comment">//   res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE');</span>
<span class="hljs-comment">//   // 允许的请求头</span>
<span class="hljs-comment">//   res.setHeader('Access-Control-Allow-Headers', 'X-Custom-Header, Content-Type');</span>
<span class="hljs-comment">//   // 允许携带凭证(如cookies)</span>
<span class="hljs-comment">//   res.setHeader('Access-Control-Allow-Credentials', true);</span>
<span class="hljs-comment">//   next();</span>
<span class="hljs-comment">// });</span>

<span class="hljs-comment">// --- 使用 cors 中间件 (推荐) ---</span>
<span class="hljs-keyword">const</span> corsOptions = {
  <span class="hljs-attr">origin</span>: <span class="hljs-string">'http://app.mydomain.com'</span>,
  <span class="hljs-attr">methods</span>: <span class="hljs-string">"GET,POST"</span>,
  <span class="hljs-attr">allowedHeaders</span>: <span class="hljs-string">"Content-Type,X-Custom-Header"</span>,
  <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>
};
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>(corsOptions));

<span class="hljs-comment">// 路由处理</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/data'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'CORS request successful!'</span> });
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'API server listening on port 3000'</span>));
</code></pre>
<h3 data-id="heading-22"><strong>2. JSONP (JSON with Padding)</strong></h3>
<p>JSONP是一种“hack”方法，利用 <code>&lt;script&gt;</code> 标签不受同源策略限制的特点。<strong>它只支持GET请求</strong>。</p>
<p><strong>前端代码:</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * JSONP 动态实现
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">url</span> - 请求的URL (不含callback参数)
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">callbackParamName</span> - 服务端接收的回调函数名参数 (通常是'callback')
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonpRequest</span>(<span class="hljs-params">url, callbackParamName = <span class="hljs-string">'callback'</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> callbackName = <span class="hljs-string">`jsonp_callback_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100000</span>)}</span>`</span>;

    <span class="hljs-comment">// 1. 在全局(window)上创建一个函数，用于接收服务端返回的数据</span>
    <span class="hljs-variable language_">window</span>[callbackName] = <span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) {
      <span class="hljs-comment">// 4. 清理工作：移除script标签和全局函数</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(script);
      <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">window</span>[callbackName];
      <span class="hljs-comment">// 5. Promise 成功</span>
      <span class="hljs-title function_">resolve</span>(data);
    };

    <span class="hljs-comment">// 2. 创建 script 标签</span>
    <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
    <span class="hljs-keyword">const</span> separator = url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'?'</span>) ? <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">'?'</span>;
    script.<span class="hljs-property">src</span> = <span class="hljs-string">`<span class="hljs-subst">${url}</span><span class="hljs-subst">${separator}</span><span class="hljs-subst">${callbackParamName}</span>=<span class="hljs-subst">${callbackName}</span>`</span>;
    script.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 错误处理</span>
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'JSONP request failed.'</span>));
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(script);
      <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">window</span>[callbackName];
    };

    <span class="hljs-comment">// 3. 将 script 标签插入DOM，浏览器会自动发起GET请求</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);
  });
}

<span class="hljs-comment">// --- 使用场景 ---</span>
<span class="hljs-title function_">jsonpRequest</span>(<span class="hljs-string">'http://api.example.com/jsonp-data'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'JSONP Response:'</span>, data);
  });

<span class="hljs-comment">// 服务端(api.example.com)的响应内容应为:</span>
<span class="hljs-comment">// jsonp_callback_1678886400000_12345({"message": "This is a JSONP response"});</span>
</code></pre>
<h3 data-id="heading-23"><strong>3. 代理服务器 (Proxy Server)</strong></h3>
<p>代理是目前大型项目中处理跨域最常用、最安全灵活的方案。</p>
<p><strong>前端代码:</strong><br/>
前端请求的是<strong>同源</strong>的后端代理接口，而不是直接请求第三方API。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端页面位于 http://app.mydomain.com</span>
<span class="hljs-comment">// 请求同源的后端代理接口 /api/weather</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/weather?city=Shanghai'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Weather data from proxy:'</span>, data);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Proxy request failed:'</span>, error));
</code></pre>
<p><strong>后端代理服务器代码 (Node.js/Express 示例):</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>); <span class="hljs-comment">// 使用axios等库方便地在后端发起HTTP请求</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 定义代理接口 /api/weather</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/weather'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { city } = req.<span class="hljs-property">query</span>;
    <span class="hljs-keyword">const</span> apiKey = <span class="hljs-string">'YOUR_THIRD_PARTY_API_KEY'</span>;
    <span class="hljs-keyword">const</span> externalApiUrl = <span class="hljs-string">`https://api.weatherapi.com/v1/current.json?key=<span class="hljs-subst">${apiKey}</span>&amp;q=<span class="hljs-subst">${city}</span>`</span>;

    <span class="hljs-comment">// 关键：由后端服务器发起对第三方API的请求</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Proxying request to: <span class="hljs-subst">${externalApiUrl}</span>`</span>);
    <span class="hljs-keyword">const</span> apiResponse = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(externalApiUrl);

    <span class="hljs-comment">// 将从第三方API获取的数据原样返回给前端</span>
    res.<span class="hljs-title function_">status</span>(apiResponse.<span class="hljs-property">status</span>).<span class="hljs-title function_">json</span>(apiResponse.<span class="hljs-property">data</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 错误处理</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Proxy Error:'</span>, error.<span class="hljs-property">message</span>);
    res.<span class="hljs-title function_">status</span>(error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> || <span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Failed to fetch data from external API.'</span> });
  }
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'App server with proxy running on port 8080'</span>));
</code></pre>
<h5 data-id="heading-24"><strong>原理</strong>:</h5>
<ul>
<li>浏览器(客户端) &lt;=&gt; 同源后端服务器 &lt;=&gt; 第三方API服务器。</li>
<li>浏览器与后端服务器之间通信遵守同源策略，而后端服务器之间的HTTP请求不受浏览器同源策略的限制。</li>
</ul>
<h2 data-id="heading-25">九、 浏览器兼容性</h2>
<ul>
<li>
<p><strong>Babel</strong>: 将ES6+代码转换为向后兼容的ES5代码。</p>
</li>
<li>
<p><strong>Polyfill</strong>: 为旧浏览器提供缺失的原生API的实现（例如 <code>Promise</code>, <code>Array.from</code>）。<code>core-js</code> 是最常用的Polyfill库。</p>
</li>
<li>
<p><strong>CSS Autoprefixer</strong>: 自动为CSS规则添加浏览器厂商前缀。</p>
</li>
<li>
<p><strong>caniuse.com</strong>: 查询特定Web技术在各浏览器版本中兼容性的权威网站。</p>
</li>
</ul>
<h2 data-id="heading-26">十、 正则表达式</h2>
<p>用于字符串的模式匹配，是处理文本的强大工具。</p>
<h3 data-id="heading-27"><strong>常用方法</strong>:</h3>
<ul>
<li><code>test()</code> (检查是否匹配)</li>
<li><code>match()</code> (获取匹配结果)</li>
<li><code>replace()</code> (查找并替换)。</li>
</ul>
<h4 data-id="heading-28"><strong>示例 (简单邮箱验证)</strong> :</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> emailRegex = <span class="hljs-regexp">/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+.[a-zA-Z]{2,}$/</span>;
<span class="hljs-keyword">const</span> email1 = <span class="hljs-string">'test@example.com'</span>;
<span class="hljs-keyword">const</span> email2 = <span class="hljs-string">'invalid-email'</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(emailRegex.<span class="hljs-title function_">test</span>(email1)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(emailRegex.<span class="hljs-title function_">test</span>(email2)); <span class="hljs-comment">// false</span>
</code></pre>
<blockquote>
<p>以上是JS中级篇面试考察点的内容，如有错误欢迎评论区指正。</p>
</blockquote>
<ul>
<li><a href="https://juejin.cn/post/7578705123209625643" target="_blank" title="https://juejin.cn/post/7578705123209625643">2025前端面试题-JS基础篇</a></li>
<li><a href="https://juejin.cn/spost/7530179511728930856" target="_blank" title="https://juejin.cn/spost/7530179511728930856">2025前端面试题-TS理论篇</a></li>
<li><a href="https://juejin.cn/post/7533826195352829988" target="_blank" title="https://juejin.cn/post/7533826195352829988">2025前端面试题-TS实战篇</a></li>
<li><a href="https://juejin.cn/post/7503111373468893193" target="_blank" title="https://juejin.cn/post/7503111373468893193">2025前端面试题-Vue3基础篇</a></li>
<li><a href="https://juejin.cn/post/7511568225987051555" target="_blank" title="https://juejin.cn/post/7511568225987051555">2025前端面试题-Vue3进阶篇</a></li>
<li><a href="https://juejin.cn/post/7503811658198286388" target="_blank" title="https://juejin.cn/post/7503811658198286388">2025前端面试题-React基础篇</a></li>
<li><a href="https://juejin.cn/post/7504545616841965583" target="_blank" title="https://juejin.cn/post/7504545616841965583">2025前端面试题-React进阶篇</a></li>
<li><a href="https://juejin.cn/post/7504926961627054099" target="_blank" title="https://juejin.cn/post/7504926961627054099">2025前端面试题-React高阶篇</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【URP】Unity[内置Shader]粒子光照ParticlesLit]]></title>    <link>https://juejin.cn/post/7579096485356568626</link>    <guid>https://juejin.cn/post/7579096485356568626</guid>    <pubDate>2025-12-03T00:38:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579096485356568626" data-draft-id="7579093412331880458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【URP】Unity[内置Shader]粒子光照ParticlesLit"/> <meta itemprop="keywords" content="图形学,游戏开发,Unity3D"/> <meta itemprop="datePublished" content="2025-12-03T00:38:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【URP】Unity[内置Shader]粒子光照ParticlesLit
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T00:38:02.000Z" title="Wed Dec 03 2025 00:38:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13021255.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13021255%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【从UnityURP开始探索游戏渲染】</a><strong>专栏-直达</strong></p>
</blockquote>
<p>Unity URP内置的Particles Lit着色器是专为粒子系统设计的高质量光照模型，其核心作用是为火焰、烟雾、雨雪等动态粒子效果提供逼真的光照交互。该着色器采用URP的物理光照计算模型，支持透明混合、深度碰撞检测等高级特性，但会带来较高的性能开销。</p>
<h2 data-id="heading-0"><strong>原理与特性</strong></h2>
<ul>
<li>‌<strong>光照模型</strong>‌：基于URP的PBR光照计算，支持方向光、点光源和聚光灯的实时交互，通过表面法线计算高光反射</li>
<li>‌<strong>混合模式</strong>‌：提供Alpha、Premultiply、Additive和Multiply四种混合模式，分别适用于云雾（Alpha）、玻璃反射（Premultiply）、全息效果（Additive）等场景</li>
<li>‌<strong>深度交互</strong>‌：可与深度纹理比对实现粒子碰撞效果，通过CS脚本在渲染管线中同步深度数据</li>
</ul>
<h2 data-id="heading-1"><strong>发展沿革</strong></h2>
<ul>
<li>‌<strong>2019年</strong>‌：随URP 7.x版本首次推出，最初仅支持基础光照模型</li>
<li>‌<strong>2021年</strong>‌：URP 12.x加入深度纹理交互支持，实现粒子碰撞效果</li>
<li>‌<strong>2023年</strong>‌：优化移动端性能，在URP 14.x中成为粒子系统默认推荐着色器</li>
</ul>
<h2 data-id="heading-2">Particles Lit 对比 Lit</h2>
<h3 data-id="heading-3"><strong>渲染模式选择</strong></h3>
<p>ParticlesLit专为粒子系统设计，提供更灵活的混合模式（如Additive、Multiply等），适合处理透明粒子的叠加效果，而Lit通常用于不透明或标准透明物体渲染。ParticlesLit支持通过Color Mode控制粒子颜色与材质颜色的混合方式（如Multiply、Additive等），可减少过度混合导致的性能损耗。</p>
<h3 data-id="heading-4"><strong>性能敏感功能裁剪</strong></h3>
<p>ParticlesLit默认关闭了Lit中部分高消耗特性（如复杂光照计算），采用简化的光照模型。例如，它避免使用完整PBR计算，转而使用预乘混合（Premultiply）保留高光的同时降低透明渲染开销。此外，粒子系统通常禁用碰撞检测和物理交互，进一步降低CPU负载。</p>
<h3 data-id="heading-5"><strong>资源复用与批处理</strong></h3>
<p>ParticlesLit鼓励材质共享和纹理图集化，通过减少DrawCall提升性能。建议多个粒子系统共用同一材质，且纹理尺寸不超过256x256。相比之下，Lit可能涉及更多独立材质实例，尤其在复杂场景中。</p>
<h3 data-id="heading-6"><strong>渲染参数优化</strong></h3>
<p>ParticlesLit提供针对粒子的特定参数控制：</p>
<ul>
<li>通过Alpha Clipping实现硬边透明（如草叶效果），避免全透明混合的计算开销</li>
<li>推荐小尺寸粒子去除Alpha通道，改用Opaque渲染以减少Overdraw</li>
<li>限制粒子数量（单发射器&lt;50，屏幕总数&lt;200）以控制顶点处理压力</li>
</ul>
<h3 data-id="heading-7"><strong>底层实现差异</strong></h3>
<p>ParticlesLit在Shader代码中显式优化了类型转换和初始化（如half4 color = (half4)0），避免编译器警告并提升执行效率。而Lit更侧重通用物体渲染的精度和功能完整性。</p>
<p>综合来看，ParticlesLit通过简化光照模型、优化混合策略、限制资源消耗等方式，在保证粒子视觉效果的同时实现比Lit更高的渲染效率.</p>
<h2 data-id="heading-8"><strong>Particles Lit 的四种混合模式</strong></h2>
<p>ParticlesLit着色器提供了四种混合模式，主要用于控制粒子效果与背景的视觉融合方式</p>
<h3 data-id="heading-9"><strong>Alpha混合模式</strong></h3>
<p>通过材质的Alpha值控制透明度，0为完全透明，1为视觉上不透明但仍参与透明渲染通道。适用于需要渐变消失的效果，如云朵消散。其特点是保持粒子颜色纯度，但可能丢失高光细节。</p>
<h3 data-id="heading-10"><strong>Premultiply(预乘Alpha)</strong></h3>
<p>保留反射和高光特性，即使表面透明时仍能显示镜面效果。典型应用是透明玻璃或冰晶材质，仅反射光可见而本体透明。该模式需配合预乘处理的纹理使用，避免边缘黑边问题。</p>
<h3 data-id="heading-11"><strong>Additive(叠加)</strong></h3>
<p>将粒子颜色与背景色相加，产生增亮效果。适用于发光体如火焰、全息投影，能突出高亮区域但易导致过曝。火星特效常采用此模式增强核心亮度。</p>
<h3 data-id="heading-12"><strong>Multiply(相乘)</strong></h3>
<p>使粒子颜色与背景色相乘，产生变暗效果。模拟彩色玻璃透光或阴影叠加，适合风格化场景的氛围营造。需注意暗部细节可能丢失。</p>
<h3 data-id="heading-13"><strong>应用选择建议</strong></h3>
<ul>
<li>‌<strong>性能考虑</strong>‌：Additive和Multiply计算量较低，Premultiply消耗较大</li>
<li>‌<strong>视觉特性</strong>‌：动态火焰推荐Additive，半透明物体用Alpha，材质反射需求选Premultiply</li>
<li>‌<strong>移动端优化</strong>‌：可改用Mobile/Particles/Additive等简化着色器</li>
</ul>
<p>混合模式可通过材质Inspector面板的"Blending Mode"下拉菜单切换，需配合Render Face(渲染面)和Alpha Clipping(透明剪切)等参数调整最终效果</p>
<h2 data-id="heading-14">深度纹理比对实现深度交互的碰撞效果</h2>
<h3 data-id="heading-15"><strong>深度纹理获取与处理</strong></h3>
<p>首先需启用相机的深度纹理渲染功能，通过勾选RenderPipelineAsset中的DepthTexture选项生成场景深度图。深度纹理存储的是归一化设备坐标(NDC)的z分量值，经过非线性透视投影变换后，使用公式<code>d=0.5*z+0.5</code>将深度值映射到[0,1]范围。正交投影的深度计算则是线性的，需区分处理。</p>
<h3 data-id="heading-16"><strong>碰撞检测原理</strong></h3>
<p>通过比较屏幕空间中的顶点距离与场景深度缓冲区的值来实现碰撞判定。具体步骤包括：</p>
<ul>
<li>‌<strong>访问屏幕位置</strong>‌：获取当前顶点在屏幕空间的坐标和深度值。</li>
<li>‌<strong>深度差值计算</strong>‌：用场景深度值减去顶点深度值，得到两者间的距离差。</li>
<li>‌<strong>边缘梯度控制</strong>‌：通过调整场景位置的偏移量，可精确控制碰撞边缘的渐变效果。</li>
</ul>
<h3 data-id="heading-17"><strong>效果增强技术</strong></h3>
<ul>
<li>‌<strong>Alpha混合修正</strong>‌：将碰撞区域的Alpha值通过<code>1-</code>操作反转，并与菲涅尔效应叠加，可生成发光边缘的视觉效果。</li>
<li>‌<strong>纹理变形技术</strong>‌：参考流体模拟中的UV坐标动画方法，通过动态扭曲纹理贴图增强交互的真实感。例如Valve在《Portal 2》中采用滑动表面着色器，对UV坐标进行时间驱动的位移计算。</li>
</ul>
<h3 data-id="heading-18"><strong>性能优化</strong></h3>
<ul>
<li>‌<strong>纹理复用</strong>‌：使用小块纹理通过重复平铺实现大范围覆盖，减少内存占用。</li>
<li>‌<strong>简化几何体</strong>‌：对于背景物体，可用带纹理的简单几何体替代高模，结合Billboard技术保持视觉一致性。</li>
</ul>
<h2 data-id="heading-19"><strong>具体使用示例</strong></h2>
<h3 data-id="heading-20">创建火焰粒子材质：</h3>
<ul>
<li>新建材质并选择Shader路径：<code>Universal Render Pipeline &gt; Particles &gt; Lit</code></li>
<li>设置Surface Type为Transparent，Blending Mode为Additive</li>
<li>绑定粒子贴图并调整颜色参数：</li>
<li>_MainTex: 火焰序列帧贴图
_Color: RGBA(1,0.5,0,0.8)
_Emission: 2.0</li>
</ul>
<h3 data-id="heading-21"><strong>雨打到地上和物体上碰撞产生水花</strong></h3>
<ul>
<li>
<p>‌<strong>雨水粒子基础配置</strong>‌：</p>
<ul>
<li>使用Rectangle发射器形状并旋转90度使粒子垂直下落</li>
<li>设置Velocity over Lifetime的World空间模式确保雨滴始终朝Y轴降落</li>
<li>通过Linear参数添加XYZ方向偏移模拟风力效果</li>
</ul>
</li>
<li>
<p>‌<strong>碰撞检测模块</strong>‌：</p>
<ul>
<li>启用粒子系统的Collision模块，选择World碰撞模式</li>
<li>设置Dampen参数为1使碰撞后粒子完全停止</li>
<li>调整Bounce参数控制水花溅射力度</li>
</ul>
</li>
<li>
<p>‌<strong>水花效果生成</strong>‌：</p>
<ul>
<li>使用Sub Emitters模块在粒子消亡时触发子发射器</li>
<li>子粒子系统采用Horizontal Billboard渲染模式保持水平显示</li>
<li>通过Size over Lifetime曲线控制水花扩散动画</li>
</ul>
</li>
<li>
<p>RainCollisionController.cs</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> UnityEngine;

[<span class="hljs-meta">RequireComponent(typeof(ParticleSystem))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RainCollisionController</span> : <span class="hljs-title">MonoBehaviour</span> {
    <span class="hljs-keyword">private</span> ParticleSystem _mainSystem;
    <span class="hljs-keyword">private</span> ParticleSystem _splashSystem;

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span> {
        _mainSystem = GetComponent&lt;ParticleSystem&gt;();
        <span class="hljs-keyword">var</span> collision = _mainSystem.collision;
        collision.enabled = <span class="hljs-literal">true</span>;
        collision.type = ParticleSystemCollisionType.World;

        <span class="hljs-comment">// 获取子发射器系统</span>
        _splashSystem = transform.GetChild(<span class="hljs-number">0</span>).GetComponent&lt;ParticleSystem&gt;();
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span> {
        <span class="hljs-comment">// 动态调整粒子发射速率</span>
        <span class="hljs-keyword">var</span> emission = _mainSystem.emission;
        emission.rateOverTime = Mathf.Lerp(<span class="hljs-number">50</span>, <span class="hljs-number">500</span>, WeatherManager.Instance.RainIntensity);
    }
}
</code></pre>
</li>
<li>
<p>RainCollisionController.cs</p>
<pre><code class="hljs language-c" lang="c">Shader <span class="hljs-string">"Custom/Ripple"</span> {
    Properties {
        _MainTex (<span class="hljs-string">"Base (RGB)"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">"white"</span> {}
        _Speed (<span class="hljs-string">"Animation Speed"</span>, Range(<span class="hljs-number">0</span>,<span class="hljs-number">5</span>)) = <span class="hljs-number">1.0</span>
    }
    SubShader {
        Tags { <span class="hljs-string">"Queue"</span>=<span class="hljs-string">"Transparent"</span> }
        Blend SrcAlpha OneMinusSrcAlpha

        Pass {
            HLSLPROGRAM
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> vertex vert</span>
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> fragment frag</span>
            <span class="hljs-comment">// 着色器代码...</span>
            ENDHLSL
        }
    }
}
</code></pre>
</li>
<li>
<p><strong>性能优化</strong></p>
<ul>
<li>
<p>‌<strong>纹理数组替代</strong>‌：使用Texture2DArray将多张纹理合并为单一资源，通过索引值（存储在SplatMap的R/G通道）选择纹理，减少采样次数。例如：</p>
<pre><code class="hljs language-c" lang="c">hlsl
half4 var_Main = SAMPLE_TEXTURE2D_ARRAY(_TexArray, sampler_TexArray, uv, splat.r * <span class="hljs-number">255</span>) * splat.b;
half4 var_Sec = SAMPLE_TEXTURE2D_ARRAY(_TexArray, sampler_TexArray, uv, splat.g * <span class="hljs-number">255</span>) * (<span class="hljs-number">1</span> - splat.b);
half4 finalRGB = var_Main + var_Sec;
</code></pre>
</li>
<li>
<p>‌<strong>高度混合增强</strong>‌：结合高度图（存储在SplatMap的B通道）实现更自然的过渡效果，通过比较各层高度值动态调整权重</p>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-22"><strong>Shader Graph应用</strong></h2>
<p>实现雨滴效果：</p>
<ul>
<li>创建新的Shader Graph，选择URP Particle Lit模板</li>
<li>添加Texture Sample节点连接Main Texture输入口</li>
<li>使用Custom Function节点实现法线扰动：</li>
</ul>
<pre><code class="hljs language-c" lang="c">hlsl
<span class="hljs-type">void</span> <span class="hljs-title function_">RainDistortion_float</span><span class="hljs-params">(float2 uv, out float3 normal)</span>{
    normal = float3(frac(uv.x * <span class="hljs-number">10</span>), frac(uv.y * <span class="hljs-number">5</span>), <span class="hljs-number">1</span>);
}
</code></pre>
<ul>
<li>
<p>输出口连接Normal和Base Color通道</p>
</li>
<li>
<p>RainParticle.shadergraph</p>
<pre><code class="hljs language-c" lang="c">{
    <span class="hljs-string">"m_Nodes"</span>: [
        {
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.Texture2DNode"</span>,
            <span class="hljs-string">"m_Outputs"</span>: [{ <span class="hljs-string">"m_Name"</span>: <span class="hljs-string">"Out"</span> }],
            <span class="hljs-string">"m_Inputs"</span>: [{ <span class="hljs-string">"m_Name"</span>: <span class="hljs-string">"Texture"</span>, <span class="hljs-string">"m_DefaultValue"</span>: <span class="hljs-string">"Assets/Textures/RainDrop.png"</span> }]
        },
        {
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.CustomFunctionNode"</span>,
            <span class="hljs-string">"m_Outputs"</span>: [{ <span class="hljs-string">"m_Name"</span>: <span class="hljs-string">"normal"</span> }],
            <span class="hljs-string">"m_Code"</span>: <span class="hljs-string">"RainDistortion_float"</span>
        }
    ],
    <span class="hljs-string">"m_Edges"</span>: [
        { <span class="hljs-string">"m_OutputSlot"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"m_InputSlot"</span>: <span class="hljs-string">"BaseColor"</span> },
        { <span class="hljs-string">"m_OutputSlot"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"m_InputSlot"</span>: <span class="hljs-string">"Normal"</span> }
    ]
}
</code></pre>
</li>
</ul>
<p>该示例通过Shader Graph创建动态雨滴效果，包含纹理采样和法线扰动功能，需配合粒子系统使用</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13021255.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13021255%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【从UnityURP开始探索游戏渲染】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JVM 调参实战指南：从基础到落地，解决 GC 与内存难题]]></title>    <link>https://juejin.cn/post/7579142750407557146</link>    <guid>https://juejin.cn/post/7579142750407557146</guid>    <pubDate>2025-12-03T00:52:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579142750407557146" data-draft-id="7579127397497765939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JVM 调参实战指南：从基础到落地，解决 GC 与内存难题"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-12-03T00:52:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JVM 调参实战指南：从基础到落地，解决 GC 与内存难题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T00:52:58.000Z" title="Wed Dec 03 2025 00:52:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JVM 调参实战指南：从基础到落地，解决 GC 与内存难题</h2>
<p>在后端开发中，很多人对 JVM 调参的认知停留在 “-Xms2g -Xmx4g”—— 上线时随手加两个堆内存参数，遇到 “GC overhead limit exceeded” 就盲目调大堆内存，遇到 “Full GC 频繁” 就重启服务。但这样的 “野蛮操作” 不仅无法根治问题，还可能导致服务器资源浪费、服务稳定性下降。</p>
<p>JVM 调参的本质是 “<strong>根据业务需求，优化内存分配与垃圾回收策略</strong>”—— 比如电商秒杀需要 “低 GC 延迟”，后台报表计算需要 “高吞吐量”，不同场景的调参方向完全不同。本文结合 Java 8/11 实战经验，提供一套 “理论 + 工具 + 案例” 的完整调参方案，帮你系统性解决 JVM 相关问题。</p>
<h3 data-id="heading-1">一、先搞懂：为什么需要 JVM 调参？调参目标是什么？</h3>
<p>在动手调参前，先明确 “调参的意义”，避免为了 “调参而调参”：</p>
<h4 data-id="heading-2">1. 什么时候需要调参？</h4>
<p>出现以下场景，说明 JVM 参数需要优化：</p>
<ul>
<li><strong>内存溢出（OOM）</strong> ：频繁抛出java.lang.OutOfMemoryError（堆溢出、方法区溢出、栈溢出）；</li>
</ul>

<ul>
<li><strong>GC 频繁</strong>：用jstat观察到 Young GC 每秒超过 5 次，或 Full GC 每小时超过 10 次；</li>
</ul>

<ul>
<li><strong>GC 延迟高</strong>：单次 GC 停顿超过 500ms（如秒杀场景下，GC 停顿导致订单创建超时）；</li>
</ul>

<ul>
<li><strong>内存利用率低</strong>：堆内存长期空闲超过 50%，但服务器内存充足（资源浪费）；</li>
</ul>

<ul>
<li><strong>服务启动慢</strong>：应用启动耗时超过 5 分钟（可能是元空间分配不足，导致类加载效率低）。</li>
</ul>
<h4 data-id="heading-3">2. 核心调参目标：3 个维度的平衡</h4>
<p>JVM 调参没有 “最优解”，只有 “适配业务的解”，核心目标围绕以下 3 点：</p>
<ul>
<li><strong>低延迟（Low Latency）</strong> ：减少 GC 停顿时间（如单次 GC&lt;100ms），适合秒杀、支付等对响应时间敏感的场景；</li>
</ul>

<ul>
<li><strong>高吞吐量（High Throughput）</strong> ：单位时间内完成更多业务逻辑（GC 耗时占比 &lt; 5%），适合后台报表、数据计算等离线场景；</li>
</ul>

<ul>
<li><strong>内存高效（Memory Efficiency）</strong> ：合理利用内存，避免 OOM，同时不浪费服务器资源（如堆内存利用率维持在 60%-80%）。</li>
</ul>
<h3 data-id="heading-4">二、基础：JVM 内存模型与核心调参区域</h3>
<p>调参的前提是理解 JVM 内存布局 —— 所有参数都是针对特定内存区域配置的，搞错区域会导致调参无效。以 Java 8 为例，JVM 内存分为 5 大区域：</p>









































<table><thead><tr><th>内存区域</th><th>作用</th><th>调参核心关注</th><th>常见问题</th></tr></thead><tbody><tr><td>堆（Heap）</td><td>存储对象实例（new 创建的对象）</td><td>堆大小分配、新生代 / 老年代比例、GC 收集器</td><td>堆溢出（OOM: Java heap space）</td></tr><tr><td>方法区（Metaspace）</td><td>存储类信息、常量、静态变量（Java 8 前为永久代）</td><td>元空间大小限制</td><td>元空间溢出（OOM: Metaspace）</td></tr><tr><td>虚拟机栈（VM Stack）</td><td>存储方法调用栈帧（局部变量、方法返回值）</td><td>栈大小（避免栈溢出）</td><td>栈溢出（StackOverflowError）</td></tr><tr><td>本地方法栈（Native Method Stack）</td><td>存储本地方法（JNI 调用）调用栈帧</td><td>一般无需手动调参（默认足够）</td><td>较少出现问题</td></tr><tr><td>程序计数器（Program Counter Register）</td><td>记录当前线程执行的字节码行号</td><td>无需调参（JVM 自动管理）</td><td>无</td></tr></tbody></table>
<p><strong>核心调参区域</strong>：90% 的调参集中在 “堆” 和 “方法区”，虚拟机栈仅在特殊场景（如递归调用过深）需要调整，其他区域几乎无需手动配置。</p>
<h3 data-id="heading-5">三、实战：JVM 核心调参参数（按场景分类）</h3>
<p>按 “堆内存配置→GC 收集器→GC 日志→其他常用” 分类，整理最实用的参数，附 “作用 + 默认值 + 推荐配置”：</p>
<h4 data-id="heading-6">1. 堆内存配置参数（最核心，必须掌握）</h4>
<p>堆是 JVM 调参的重中之重，核心参数控制堆大小、新生代 / 老年代比例：</p>









































<table><thead><tr><th>参数</th><th>作用</th><th>默认值（Java 8）</th><th>推荐配置（示例）</th></tr></thead><tbody><tr><td>-Xms</td><td>初始堆大小（堆内存启动时分配的大小）</td><td>物理内存的 1/64（如 8GB 内存默认 128MB）</td><td>-Xms4g（与 - Xmx 保持一致，避免堆内存动态调整）</td></tr><tr><td>-Xmx</td><td>最大堆大小（堆内存可扩展到的最大值）</td><td>物理内存的 1/4（如 8GB 内存默认 2GB）</td><td>-Xmx4g（根据服务器内存配置，如 16GB 内存设 8g）</td></tr><tr><td>-XX:NewRatio</td><td>老年代与新生代的比例（NewRatio = 老年代 / 新生代）</td><td>2（老年代：新生代 = 2:1，新生代占堆 1/3）</td><td>-XX:NewRatio=3（老年代：新生代 = 3:1，新生代占 1/4，适合对象存活时间长的场景）</td></tr><tr><td>-XX:SurvivorRatio</td><td>新生代中 Eden 区与一个 Survivor 区的比例</td><td>8（Eden:Survivor=8:1，两个 Survivor 区共占新生代 2/10）</td><td>-XX:SurvivorRatio=6（Eden:Survivor=6:1，Survivor 区占比更高，减少对象提前进入老年代）</td></tr><tr><td>-XX:MaxTenuringThreshold</td><td>对象从新生代晋升到老年代的年龄阈值（每经历一次 GC 存活，年龄 + 1）</td><td>15（Java 8）</td><td>-XX:MaxTenuringThreshold=10（对象存活 10 次 GC 后进入老年代，适合短期对象多的场景）</td></tr></tbody></table>
<p><strong>关键原则</strong>：</p>
<ul>
<li>-Xms与-Xmx必须保持一致：避免 JVM 在运行中动态调整堆大小（调整过程会导致服务卡顿）；</li>
</ul>

<ul>
<li>新生代大小根据对象存活时间调整：短期对象多（如接口请求对象）→ 新生代调大（占堆 1/3~1/2）；长期对象多（如缓存对象）→ 新生代调小（占堆 1/4）。</li>
</ul>
<p><strong>示例配置</strong>（16GB 内存服务器，电商接口服务）：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-title class_">Xms8g</span> -<span class="hljs-title class_">Xmx8g</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:NewRatio=</span><span class="hljs-number">3</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:SurvivorRatio=</span><span class="hljs-number">6</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MaxTenuringThreshold=</span><span class="hljs-number">10</span>
</code></pre>
<h4 data-id="heading-7">2. GC 收集器参数（决定 GC 性能）</h4>
<p>GC 收集器是影响 “延迟” 和 “吞吐量” 的关键，不同收集器的调参方向完全不同。Java 8/11 常用收集器及核心参数：</p>
<h5 data-id="heading-8">（1）G1 GC（Java 8 默认，平衡延迟与吞吐量）</h5>
<p>适合堆内存较大（&gt;4GB）的场景，核心参数控制 GC 停顿目标、并发线程数：</p>






























<table><thead><tr><th>参数</th><th>作用</th><th>推荐配置</th></tr></thead><tbody><tr><td>-XX:+UseG1GC</td><td>启用 G1 收集器</td><td>必须加（Java 8 需手动启用，Java 9 + 默认）</td></tr><tr><td>-XX:MaxGCPauseMillis</td><td>G1 GC 的目标停顿时间（G1 会尽量满足）</td><td>-XX:MaxGCPauseMillis=100（目标停顿 100ms，根据业务调整）</td></tr><tr><td>-XX:ParallelGCThreads</td><td>GC 并行线程数（新生代 GC、Full GC 时使用）</td><td>-XX:ParallelGCThreads=8（一般设为 CPU 核心数的 1/2~1，如 16 核 CPU 设 8）</td></tr><tr><td>-XX:ConcGCThreads</td><td>GC 并发线程数（老年代并发标记时使用）</td><td>-XX:ConcGCThreads=4（一般设为 ParallelGCThreads 的 1/2）</td></tr></tbody></table>
<p><strong>示例配置</strong>（16 核 16GB 内存，电商支付服务，要求低延迟）：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-title class_">Xms8g</span> -<span class="hljs-title class_">Xmx8g</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseG1GC</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MaxGCPauseMillis=</span><span class="hljs-number">100</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ParallelGCThreads=</span><span class="hljs-number">8</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ConcGCThreads=</span><span class="hljs-number">4</span>
</code></pre>
<h5 data-id="heading-9">（2）ZGC（Java 11+，低延迟首选，支持 TB 级堆）</h5>
<p>ZGC 是 Java 11 引入的低延迟收集器，单次 GC 停顿 &lt;10ms，适合超大堆（&gt;16GB）场景：</p>

























<table><thead><tr><th>参数</th><th>作用</th><th>推荐配置</th></tr></thead><tbody><tr><td>-XX:+UseZGC</td><td>启用 ZGC 收集器</td><td>必须加（Java 11 + 支持）</td></tr><tr><td>-XX:ZGCHeapLimitPercent</td><td>ZGC 堆内存占物理内存的最大比例</td><td>-XX:ZGCHeapLimitPercent=75（默认 75%，如 32GB 内存堆最大 24GB）</td></tr><tr><td>-XX:ZGCParallelGCThreads</td><td>ZGC 并行线程数</td><td>-XX:ZGCParallelGCThreads=8（默认 CPU 核心数，可适当减少避免 CPU 占用过高）</td></tr></tbody></table>
<p><strong>示例配置</strong>（32 核 32GB 内存，大数据计算服务，超大堆需求）：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-title class_">Xms24g</span> -<span class="hljs-title class_">Xmx24g</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseZGC</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ZGCHeapLimitPercent=</span><span class="hljs-number">75</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ZGCParallelGCThreads=</span><span class="hljs-number">8</span>
</code></pre>
<h5 data-id="heading-10">（3）Serial GC（仅适合小堆 &lt; 2GB，如单机测试）</h5>
<p>单线程 GC，性能差，仅用于测试或极小堆场景，参数：-XX:+UseSerialGC（无需其他复杂配置）。</p>
<h4 data-id="heading-11">3. GC 日志参数（问题排查必备）</h4>
<p>调参后必须开启 GC 日志，否则无法判断调参效果。日志参数需包含 “时间、GC 类型、停顿时间、内存变化”：</p>






























<table><thead><tr><th>参数</th><th>作用</th><th>配置示例</th></tr></thead><tbody><tr><td>-Xlog:gc*</td><td>输出 GC 相关日志（Java 9 + 替代 - XX:+PrintGCDetails）</td><td>-Xlog:gc*:file=gc.log:time,level,tags:filecount=10,filesize=100m</td></tr><tr><td>-XX:+PrintGCDetails</td><td>输出详细 GC 日志（Java 8 及以下）</td><td>配合 - XX:+PrintGCTimeStamps 使用</td></tr><tr><td>-XX:+PrintGCTimeStamps</td><td>输出 GC 发生的时间戳（相对于 JVM 启动时间）</td><td>-XX:+PrintGCTimeStamps</td></tr><tr><td>-XX:+HeapDumpOnOutOfMemoryError</td><td>OOM 时自动生成堆转储文件（.hprof），用于分析 OOM 原因</td><td>-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/data/heapdump.hprof</td></tr></tbody></table>
<p><strong>Java 8 完整日志配置示例</strong>：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+PrintGCDetails</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+PrintGCTimeStamps</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+PrintGCDateStamps</span> -<span class="hljs-title class_">Xloggc</span><span class="hljs-symbol">:/data/gc</span>.log -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/data/heapdump</span>.hprof
</code></pre>
<p><strong>Java 11 + 完整日志配置示例</strong>（更简洁的 Xlog 语法）：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-title class_">Xlog</span><span class="hljs-symbol">:gc*</span><span class="hljs-symbol">:file=/data/gc</span>.<span class="hljs-symbol">log:</span>time,level,<span class="hljs-symbol">tags:</span>filecount=<span class="hljs-number">10</span>,filesize=100m -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/data/heapdump</span>.hprof
</code></pre>
<h4 data-id="heading-12">4. 其他常用参数（解决特定问题）</h4>






























<table><thead><tr><th>参数</th><th>作用</th><th>适用场景</th></tr></thead><tbody><tr><td>-XX:MetaspaceSize</td><td>元空间初始大小（Java 8+，替代永久代）</td><td>解决元空间溢出（默认 21MB，可设为 128MB）</td></tr><tr><td>-XX:MaxMetaspaceSize</td><td>元空间最大大小</td><td>-XX:MaxMetaspaceSize=256m（避免元空间无限扩展）</td></tr><tr><td>-Xss</td><td>每个线程的栈大小</td><td>递归调用过深时设大（如 - Xss512k，默认 1m）</td></tr><tr><td>-XX:+DisableExplicitGC</td><td>禁用 System.gc ()（避免手动触发 Full GC）</td><td>防止业务代码调用 System.gc () 导致频繁 Full GC</td></tr></tbody></table>
<h3 data-id="heading-13">四、JVM 调参实战流程：4 步从 “问题” 到 “优化”</h3>
<p>调参不是 “试参数”，而是 “数据驱动的迭代过程”，按以下 4 步操作，避免盲目性：</p>
<h4 data-id="heading-14">步骤 1：明确调参目标与现状</h4>
<ul>
<li><strong>目标</strong>：比如 “将 GC 停顿时间从 500ms 降至 100ms”“解决 OOM 问题”“将 GC 吞吐量从 90% 提升至 95%”；</li>
</ul>

<ul>
<li><strong>现状</strong>：用工具采集当前 JVM 指标，明确问题所在：</li>
</ul>

<ul>
<li>
<ul>
<li>堆内存使用：jstat -gc 进程ID 1000（每秒输出一次 GC 统计）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>堆内存布局：jmap -heap 进程ID（查看新生代 / 老年代大小、使用率）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>GC 日志分析：用 GCViewer（可视化工具）打开 GC 日志，查看 GC 次数、停顿时间；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>堆转储分析：若有 OOM，用 MAT（Memory Analyzer Tool）分析.hprof 文件，定位大对象。</li>
</ul>
</li>
</ul>
<p><strong>示例</strong>：用jstat -gc 12345 1000查看 GC 现状，输出如下（关键看 YGC/YGCT、FGC/FGCT）：</p>
<pre><code class="hljs language-yaml" lang="yaml"> <span class="hljs-string">S0C</span>    <span class="hljs-string">S1C</span>    <span class="hljs-string">S0U</span>    <span class="hljs-string">S1U</span>      <span class="hljs-string">EC</span>       <span class="hljs-string">EU</span>        <span class="hljs-string">OC</span>         <span class="hljs-string">OU</span>       <span class="hljs-string">MC</span>     <span class="hljs-string">MU</span>    <span class="hljs-string">CCSC</span>   <span class="hljs-string">CCSU</span>   <span class="hljs-string">YGC</span>     <span class="hljs-string">YGCT</span>    <span class="hljs-string">FGC</span>    <span class="hljs-string">FGCT</span>     <span class="hljs-string">GCT</span>   
<span class="hljs-number">10240.0</span> <span class="hljs-number">10240.0</span>  <span class="hljs-number">0.0</span>   <span class="hljs-number">10240.0</span> <span class="hljs-number">81920.0</span>  <span class="hljs-number">40960.0</span>   <span class="hljs-number">204800.0</span>   <span class="hljs-number">153600.0</span>  <span class="hljs-number">51200.0</span> <span class="hljs-number">46080.0</span> <span class="hljs-number">6400.0 </span><span class="hljs-number">5760.0    </span><span class="hljs-number">120</span>    <span class="hljs-number">6.000</span>   <span class="hljs-number">15</span>     <span class="hljs-number">30.000</span>   <span class="hljs-number">36.000</span>
</code></pre>
<p>解读：Young GC（YGC）120 次，耗时 6 秒；Full GC（FGC）15 次，耗时 30 秒，GC 总耗时 36 秒 ——Full GC 频繁且耗时高，需优化。</p>
<h4 data-id="heading-15">步骤 2：制定调参方案</h4>
<p>根据现状和目标，针对性调整参数：</p>
<ul>
<li><strong>问题 1：Full GC 频繁（如每小时 15 次）</strong> ：</li>
</ul>

<ul>
<li>
<ul>
<li>原因：老年代对象增长快，可能是新生代 Survivor 区不足，对象提前晋升；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>方案：调大新生代（如-XX:NewRatio=2，新生代占堆 1/3），增加 Survivor 区比例（-XX:SurvivorRatio=6），提高晋升年龄阈值（-XX:MaxTenuringThreshold=10）；</li>
</ul>
</li>
</ul>

<ul>
<li><strong>问题 2：GC 停顿时间长（如单次 Full GC 2 秒）</strong> ：</li>
</ul>

<ul>
<li>
<ul>
<li>原因：使用 Serial Old GC（单线程），或堆内存过大；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>方案：切换到 G1 GC（-XX:+UseG1GC），设置目标停顿时间（-XX:MaxGCPauseMillis=100）；</li>
</ul>
</li>
</ul>

<ul>
<li><strong>问题 3：堆溢出（OOM: Java heap space）</strong> ：</li>
</ul>

<ul>
<li>
<ul>
<li>原因：堆内存不足，或存在内存泄漏（对象无法回收）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>方案：先分析堆转储文件，确认是否内存泄漏（如 MAT 查大对象）；若无泄漏，调大堆内存（-Xmx8g）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-16">步骤 3：应用调参并验证效果</h4>
<ul>
<li><strong>应用参数</strong>：将参数添加到服务启动脚本（如 Spring Boot 的 java -jar 命令后）：</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 示例：电商订单服务启动脚本（Java 8，G1 GC）</span>
java -<span class="hljs-title class_">Xms8g</span> -<span class="hljs-title class_">Xmx8g</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:NewRatio=</span><span class="hljs-number">3</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:SurvivorRatio=</span><span class="hljs-number">6</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseG1GC</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MaxGCPauseMillis=</span><span class="hljs-number">100</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+PrintGCDetails</span> -<span class="hljs-title class_">Xloggc</span><span class="hljs-symbol">:/data/gc</span>.log -jar order-service.jar
</code></pre>
<ul>
<li><strong>验证效果</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li>短期验证（1 小时内）：用jstat查看 GC 次数、停顿时间是否下降；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>长期验证（24 小时）：分析 GC 日志，查看 Full GC 次数是否减少，GC 总耗时占比是否达标；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>业务验证：观察服务响应时间（如接口 P95 延迟）是否改善，OOM 是否不再发生。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-17">步骤 4：迭代优化</h4>
<p>若验证后未达目标，重复步骤 1-3：</p>
<ul>
<li>比如调大新生代后，Young GC 次数减少，但老年代增长更快，Full GC 更频繁 —— 需降低晋升年龄阈值（让短期对象提前回收，不进入老年代）；</li>
</ul>

<ul>
<li>若切换 G1 GC 后，GC 停顿达标，但吞吐量下降（GC 耗时占比从 5% 升至 8%）—— 需调整-XX:ParallelGCThreads（增加并行线程数，减少 GC 耗时）。</li>
</ul>
<h3 data-id="heading-18">五、常见场景调参案例（直接复用）</h3>
<h4 data-id="heading-19">案例 1：电商秒杀服务（低延迟需求）</h4>
<ul>
<li><strong>业务特点</strong>：秒杀期间 QPS 高（1 万 +），接口响应时间要求 &lt; 200ms，GC 停顿需 &lt; 100ms；</li>
</ul>

<ul>
<li><strong>服务器配置</strong>：16 核 32GB 内存；</li>
</ul>

<ul>
<li><strong>调参配置</strong>（Java 11+ ZGC）：</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-title class_">Xms20g</span> -<span class="hljs-title class_">Xmx20g</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseZGC</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ZGCHeapLimitPercent=</span><span class="hljs-number">75</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MaxGCPauseMillis=</span><span class="hljs-number">100</span> -<span class="hljs-title class_">Xlog</span><span class="hljs-symbol">:gc*</span><span class="hljs-symbol">:file=/data/gc</span>.<span class="hljs-symbol">log:</span>time,level,<span class="hljs-symbol">tags:</span>filecount=<span class="hljs-number">10</span>,filesize=100m -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/data/heapdump</span>.hprof
</code></pre>
<ul>
<li><strong>优化效果</strong>：单次 GC 停顿 &lt; 50ms，接口 P95 延迟 &lt; 150ms，秒杀期间无 OOM。</li>
</ul>
<h4 data-id="heading-20">案例 2：后台报表计算服务（高吞吐量需求）</h4>
<ul>
<li><strong>业务特点</strong>：离线计算，单次任务处理 1 小时，需最大化 CPU 利用率（GC 耗时占比 &lt; 5%）；</li>
</ul>

<ul>
<li><strong>服务器配置</strong>：8 核 16GB 内存；</li>
</ul>

<ul>
<li><strong>调参配置</strong>（Java 8 G1 GC）：</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-title class_">Xms12g</span> -<span class="hljs-title class_">Xmx12g</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UseG1GC</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:NewRatio=</span><span class="hljs-number">2</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:SurvivorRatio=</span><span class="hljs-number">8</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ParallelGCThreads=</span><span class="hljs-number">6</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:ConcGCThreads=</span><span class="hljs-number">3</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+PrintGCDetails</span> -<span class="hljs-title class_">Xloggc</span><span class="hljs-symbol">:/data/gc</span>.log -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+DisableExplicitGC</span>
</code></pre>
<ul>
<li><strong>优化效果</strong>：GC 总耗时占比 &lt; 3%，报表计算时间从 65 分钟缩短至 58 分钟。</li>
</ul>
<h4 data-id="heading-21">案例 3：解决元空间溢出（OOM: Metaspace）</h4>
<ul>
<li><strong>问题现象</strong>：服务启动后几天，抛出java.lang.OutOfMemoryError: Metaspace；</li>
</ul>

<ul>
<li><strong>原因</strong>：项目依赖多（JAR 包 &gt; 100 个），元空间默认 21MB 不足，类加载失败；</li>
</ul>

<ul>
<li><strong>调参配置</strong>：</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MetaspaceSize=</span>128m -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:MaxMetaspaceSize=</span>256m -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+HeapDumpOnOutOfMemoryError</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:HeapDumpPath=/data/heapdump</span>.hprof
</code></pre>
<ul>
<li><strong>优化效果</strong>：元空间使用率稳定在 60%，不再出现元空间溢出。</li>
</ul>
<h3 data-id="heading-22">六、调参避坑指南：5 个最容易踩的错误</h3>
<ol>
<li><strong>坑 1：盲目调大堆内存（如 32GB 内存设 - Xmx30g）</strong></li>
</ol>
<ul>
<li>
<ul>
<li>后果：GC 扫描和回收时间变长（Full GC 可能达 10 秒），且操作系统无内存可用，导致服务被 Kill；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>避坑：堆内存设为物理内存的 50%-70%（如 32GB 内存设 20-24g），留足内存给操作系统和其他进程。</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>坑 2：禁用 GC（-XX:+DisableExplicitGC 无效，或用 - XX:+UseSerialGC）</strong></li>
</ol>
<ul>
<li>
<ul>
<li>后果：误以为禁用 GC 能提升性能，实际导致内存无法回收，最终 OOM；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>避坑：仅禁用System.gc()（-XX:+DisableExplicitGC），不禁止 JVM 自动 GC；选择合适的 GC 收集器，而非禁用 GC。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>坑 3：调参后不验证，凭感觉判断效果</strong></li>
</ol>
<ul>
<li>
<ul>
<li>后果：参数调整后，GC 停顿反而变长，却未察觉；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>避坑：每次调参后，必须用jstat和 GC 日志验证，至少观察 24 小时，确保无异常。</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>坑 4：忽略 JDK 版本差异（如 Java 8 用 ZGC 参数）</strong></li>
</ol>
<ul>
<li>
<ul>
<li>后果：参数无效（如 Java 8 不支持-XX:+UseZGC），或启动失败；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>避坑：先确认 JDK 版本（java -version），再选择对应参数（Java 8 优先 G1，Java 11 + 可试 ZGC）。</li>
</ul>
</li>
</ul>
<ol start="5">
<li><strong>坑 5：所有服务用同一套参数（如秒杀和报表用相同配置）</strong></li>
</ol>
<ul>
<li>
<ul>
<li>后果：秒杀服务 GC 延迟高，报表服务吞吐量低；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>避坑：按业务场景分类调参（低延迟用 ZGC/G1，高吞吐量用 G1/Parallel GC），不搞 “一刀切”。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-23">总结：JVM 调参的核心逻辑</h3>
<p>JVM 调参不是 “玄学”，而是 “<strong>需求驱动 + 数据支撑 + 迭代优化</strong>” 的过程：</p>
<ol>
<li><strong>需求优先</strong>：先明确是低延迟还是高吞吐量，再选 GC 收集器和参数；</li>
</ol>

<ol start="2">
<li><strong>数据说话</strong>：用jstat、GC 日志、MAT 等工具采集数据，不凭感觉调参；</li>
</ol>

<ol start="3">
<li><strong>小步迭代</strong>：每次只调整 1-2 个参数，验证效果后再优化下一个，避免参数混乱；</li>
</ol>

<ol start="4">
<li><strong>长期监控</strong>：调参后持续监控 GC 和内存指标，防止业务变化导致新问题。</li>
</ol>
<p>最终，好的 JVM 参数不是 “调出来的”，而是 “匹配业务场景的”—— 适合自己业务的参数，才是最优参数。掌握本文的方法后，你可以针对项目中的 GC 和内存问题，快速定位并优化，让服务更稳定、性能更优。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[业务接入风控决策，挑战验证与结果同步]]></title>    <link>https://juejin.cn/post/7579142750407573530</link>    <guid>https://juejin.cn/post/7579142750407573530</guid>    <pubDate>2025-12-03T01:00:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579142750407573530" data-draft-id="7579088065696661544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="业务接入风控决策，挑战验证与结果同步"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-03T01:00:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无奈何杨"/> <meta itemprop="url" content="https://juejin.cn/user/72987223006237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            业务接入风控决策，挑战验证与结果同步
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/72987223006237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无奈何杨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T01:00:41.000Z" title="Wed Dec 03 2025 01:00:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">验证方式</h2>
<p>首先现在常见的验证方式有，指纹、人脸、虹膜、声纹、短信验证码、动态令牌、U盾、APP/扫码、手势、PIN码/密码、滑块/拼图、行为分析（无感）等，从不同角度可以进行不同的划分，比如说是生物特征类（指纹、人脸、虹膜、声纹）、物理数字持有类（短信验证码、动态令牌、U盾、APP/扫码）、知识记忆类（手势、PIN码/密码）、行为和图灵测试类（滑块/拼图、行为分析）。</p>
<p>从交互流程中又可以分为以下几种</p>
<h3 data-id="heading-1">PKI挑战-签名-验证</h3>
<p>适用于 U盾、FIDO 安全密钥、以及带有安全隔区的手机生物识别认证</p>



























































































































































<table><thead><tr><th><strong>前端/客户端 (Client)</strong></th><th><strong>业务服务器 (Relying Party / RP)</strong></th><th><strong>身份认证服务 (Auth Service)</strong></th><th><strong>安全硬件/安全隔区 (Enclave)</strong></th></tr></thead><tbody><tr><td><strong>开始认证请求</strong></td><td/><td/><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 登录/操作请求</td><td><strong>接收请求，识别用户</strong></td><td/><td/></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 请求挑战随机数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></td><td/><td/></tr><tr><td/><td/><td><strong>1. 生成 Nonce <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></strong> （保证唯一性）</td><td/></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> 返回 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></td><td/><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> 发送挑战 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></td><td/><td/><td/></tr><tr><td><strong>接收挑战 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></strong></td><td/><td/><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 触发用户认证（指纹/PIN）</td><td/><td/><td/></tr><tr><td/><td/><td/><td><strong>2. 身份验证/解锁私钥</strong> (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>p</mi><mi>r</mi><mi>i</mi><mi>v</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{priv}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>)</td></tr><tr><td/><td/><td/><td><strong>3. 使用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>p</mi><mi>r</mi><mi>i</mi><mi>v</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{priv}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 进行签名 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span></strong></td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> 返回签名 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span> (Response) + 上下文</td><td/><td/><td/></tr><tr><td><strong>发送签名 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span></strong> (Response)</td><td/><td/><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 发送 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span> + 用户ID</td><td><strong>接收签名 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span></strong></td><td/><td/></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 请求验证签名 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span>)</td><td/><td/></tr><tr><td/><td/><td><strong>4. 检索用户公钥 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>p</mi><mi>u</mi><mi>b</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{pub}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></strong></td><td/></tr><tr><td/><td/><td><strong>5. 验证：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Verify</mtext><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>S</mi><mo separator="true">,</mo><msub><mi>K</mi><mrow><mi>p</mi><mi>u</mi><mi>b</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Verify}(N, S, K_{pub})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord text"><span class="mord">Verify</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></strong></td><td/></tr><tr><td/><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <strong>[签名是否有效？]</strong></td><td/></tr><tr><td/><td/><td><strong>否</strong>：返回失败/拒绝 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> <strong>通过</strong>：返回成功/授予 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span></td><td/></tr><tr><td/><td><strong>接收验证结果</strong></td><td/><td/></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <strong>[验证通过？]</strong></td><td/><td/></tr><tr><td/><td><strong>否</strong>：拒绝访问</td><td/><td/></tr><tr><td/><td><strong>通过</strong>：授予访问权限</td><td/><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> <strong>结果通知 (成功/失败)</strong></td><td/><td/><td/></tr><tr><td><strong>流程结束</strong></td><td/><td/><td/></tr></tbody></table>
<p>核心步骤</p>



































<table><thead><tr><th><strong>步骤</strong></th><th><strong>节点名称</strong></th><th><strong>关键安全点</strong></th></tr></thead><tbody><tr><td><strong>1.</strong></td><td><strong>生成 Nonce <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></strong></td><td><strong>防重放攻击：</strong> 确保 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 是随机且一次性的。一旦验证完成，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 必须立即失效。</td></tr><tr><td><strong>2.</strong></td><td><strong>身份验证/解锁私钥</strong></td><td><strong>防远程伪造：</strong> 生物识别或 PIN 码是本地操作，成功后在安全隔区内解锁私钥 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>p</mi><mi>r</mi><mi>i</mi><mi>v</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{priv}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>，确保“人”在场。</td></tr><tr><td><strong>3.</strong></td><td><strong>使用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>p</mi><mi>r</mi><mi>i</mi><mi>v</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{priv}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 进行签名 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span></strong></td><td><strong>不可伪造性：</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>p</mi><mi>r</mi><mi>i</mi><mi>v</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{priv}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 不离开安全隔区。生成的签名 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span> 证明了私钥拥有者（即用户）在特定时间针对特定的挑战 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 进行了操作。</td></tr><tr><td><strong>4.</strong></td><td><strong>检索用户公钥 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>p</mi><mi>u</mi><mi>b</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{pub}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></strong></td><td><strong>验证依据：</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>p</mi><mi>u</mi><mi>b</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{pub}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 是在用户首次注册时，服务器存储的。服务器不需要存储或知道任何用户的秘密。</td></tr><tr><td><strong>5.</strong></td><td><strong>验证：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Verify</mtext><mo stretchy="false">(</mo><mi>N</mi><mo separator="true">,</mo><mi>S</mi><mo separator="true">,</mo><msub><mi>K</mi><mrow><mi>p</mi><mi>u</mi><mi>b</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Verify}(N, S, K_{pub})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord text"><span class="mord">Verify</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></strong></td><td><strong>最终裁决：</strong> 服务器执行验证。如果签名有效且 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 未过期，则身份得到确认。</td></tr></tbody></table>
<ul>
<li><strong>业务服务器 (RP)：</strong> 只负责 <strong>转发</strong> 挑战和签名，并根据最终结果执行业务逻辑（如创建会话）。它不关心加密细节。</li>
<li><strong>身份认证服务 (Auth Service)：</strong> 专注于 <strong>安全细节</strong>（生成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span>、存储 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>p</mi><mi>u</mi><mi>b</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{pub}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>、执行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Verify</mtext></mrow><annotation encoding="application/x-tex">\text{Verify}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">Verify</span></span></span></span></span></span>），是信任的核心。</li>
<li><strong>安全硬件 (Enclave)：</strong> 负责 <strong>秘密存储</strong> 和 <strong>签名操作</strong>，防止本地软件攻击。</li>
</ul>
<hr/>
<h3 data-id="heading-2">一次性密码（OTP，如短信/TOTP）认证</h3>
<p>这类流程的特点是<strong>客户端直接向服务器传输临时凭证</strong>（即 OTP 码本身）。</p>









































































































<table><thead><tr><th><strong>前端/客户端 (Client)</strong></th><th><strong>业务服务器 (Business System)</strong></th><th><strong>一次性密码服务 (OTP Service)</strong></th></tr></thead><tbody><tr><td><strong>开始认证请求</strong></td><td/><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 请求 OTP (例如：手机号)</td><td><strong>接收请求，识别用户</strong></td><td/></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 请求生成/发送 OTP</td><td/></tr><tr><td/><td/><td><strong>1. 生成 OTP 码</strong>（随机数或基于时间）</td></tr><tr><td/><td/><td><strong>2. 记录 OTP 及其有效期/计数器</strong></td></tr><tr><td/><td/><td><strong>3. 发送 OTP 码</strong>（短信、邮件或推送到 App）</td></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> 收到 OTP 码</td><td/><td/></tr><tr><td><strong>用户输入 OTP 码</strong></td><td/><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 发送 OTP 码</td><td><strong>接收 OTP 码</strong></td><td/></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 请求验证 OTP 码</td><td/></tr><tr><td/><td/><td><strong>4. OTP 验证：</strong> 匹配数据库中存储的码、校验是否过期/是否已使用、校验计数器</td></tr><tr><td/><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <strong>[OTP 码是否有效？]</strong></td></tr><tr><td/><td/><td><strong>否</strong>：返回失败 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> <strong>通过</strong>：返回成功 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span></td></tr><tr><td/><td><strong>接收验证结果</strong></td><td/></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <strong>[验证通过？]</strong></td><td/></tr><tr><td/><td><strong>否</strong>：拒绝访问</td><td/></tr><tr><td/><td><strong>通过</strong>：授予访问权限</td><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> <strong>结果通知 (成功/失败)</strong></td><td/><td/></tr><tr><td><strong>流程结束</strong></td><td/><td/></tr></tbody></table>
<ul>
<li><strong>核心区别点：</strong> 客户端发送的 <strong>OTP 码</strong> 就是验证的秘密凭证。服务器验证的是这个秘密凭证本身，而不是像 C-R 那样验证一个签名。</li>
<li><strong>安全性：</strong> 主要依赖 <strong>时效性</strong>（例如 60 秒失效）和 <strong>单次使用</strong> 来抵抗重放攻击。</li>
</ul>
<hr/>
<h3 data-id="heading-3">图灵测试/行为验证（CAPTCHA/滑块）</h3>
<p>这类流程不用于身份识别（"Who"），而用于判断操作主体是否为人类（"Human"），通常作为风控前置或辅助环节。</p>









































































































<table><thead><tr><th><strong>前端/客户端 (Client)</strong></th><th><strong>业务服务器 (Business System)</strong></th><th><strong>图灵验证服务 (CAPTCHA Service)</strong></th></tr></thead><tbody><tr><td><strong>开始业务操作/请求</strong></td><td/><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 请求业务</td><td><strong>接收请求，风控初判</strong></td><td/></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 请求生成验证难题</td><td/></tr><tr><td/><td/><td><strong>1. 生成验证难题</strong> (图片/滑块/运算题)</td></tr><tr><td/><td/><td><strong>2. 生成 Session Token</strong> 并记录难度/答案</td></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> 返回难题内容 + Session Token</td><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> 接收难题内容</td><td/><td/></tr><tr><td><strong>用户进行交互操作</strong></td><td/><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <strong>发送操作结果</strong> (如滑块终点坐标、行为轨迹) + Session Token</td><td><strong>接收结果</strong></td><td/></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 请求验证结果</td><td/></tr><tr><td/><td/><td><strong>3. 行为分析：</strong> 校验轨迹是否自然、计算最终答案是否正确</td></tr><tr><td/><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <strong>[判定为人类？]</strong></td></tr><tr><td/><td/><td><strong>否</strong>：返回失败/Bot <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> <strong>通过</strong>：返回成功/Human <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span></td></tr><tr><td/><td><strong>接收验证结果</strong></td><td/></tr><tr><td/><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> <strong>[验证通过？]</strong></td><td/></tr><tr><td/><td><strong>否</strong>：阻止业务/返回错误</td><td/></tr><tr><td/><td><strong>通过</strong>：继续执行业务操作</td><td/></tr><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>←</mo></mrow><annotation encoding="application/x-tex">\leftarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">←</span></span></span></span></span> <strong>结果通知 (通过/失败)</strong></td><td/><td/></tr><tr><td><strong>流程结束</strong></td><td/><td/></tr></tbody></table>
<ul>
<li><strong>核心区别点：</strong> 客户端发送的是 <strong>交互结果</strong> 或 <strong>行为数据</strong>。服务器验证的不是秘密，而是 <strong>行为模式</strong> 是否符合人类特征。</li>
<li><strong>应用场景：</strong> 通常用于防止自动化攻击（如机器人注册、灌水、爬虫）。</li>
</ul>
<hr/>
<h3 data-id="heading-4">总结：流程的根本差异</h3>





























<table><thead><tr><th><strong>流程类型</strong></th><th><strong>客户端发送的核心数据</strong></th><th><strong>服务器验证的核心对象</strong></th><th><strong>主要安全机制</strong></th></tr></thead><tbody><tr><td><strong>挑战-响应 (C-R/PKI)</strong></td><td><strong>加密签名 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span></strong></td><td><strong>公钥</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mi>p</mi><mi>u</mi><mi>b</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{pub}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 是否能解开签名 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span></td><td>秘密（私钥）永不离设备，防重放。</td></tr><tr><td><strong>一次性密码 (OTP)</strong></td><td><strong>验证码 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></strong></td><td><strong>验证码 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></strong> 是否匹配存储的秘密。</td><td>秘密传输但有时效性，防暴力破解。</td></tr><tr><td><strong>图灵验证 (CAPTCHA)</strong></td><td><strong>操作结果/行为数据</strong></td><td><strong>操作轨迹</strong> 是否符合人类行为模式。</td><td>增加机器攻击成本，防自动化脚本。</td></tr></tbody></table>
<h2 data-id="heading-5">业务决策挑战验证</h2>
<p>前面说的这都是为了这个流程</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03df78440ae0474b80672865f801f4d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765328441&amp;x-signature=ECprrhDluSDJ08cX4oGuChIa0H4%3D" alt="" loading="lazy"/></p>
<p><strong>风控引擎</strong></p>
<ul>
<li>不直接干预业务流程，只是为业务提供决策参考，具体如何使用决策由业务决定</li>
<li>对于验证过程不关心，但需要业务结果</li>
</ul>
<p><strong>业务系统</strong></p>
<ul>
<li>统筹整个流程，风控决策，挑战验证，保留现场，恢复现场等等</li>
</ul>
<p><strong>挑战服务</strong></p>
<ul>
<li>挑战验证、幂等、并发保证</li>
</ul>
<p>当然有一点，感觉有点废话，但还是说一下，业务系统把控全部流程，就要串起整个流程，不仅仅是链路号的问题，还要有业务决策记录、挑战记录，分别对应风控决策和挑战服务，多边要对得上。</p>
<h2 data-id="heading-6">业务决策对接</h2>
<p>从上面来看验证方式是有很多差异的，不同业务系统发起的，其支持的验证方式通常是会有差异的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86f1ba077cb94b77a1c7d48fab5eb529~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765328441&amp;x-signature=1R41aGzfstUJzVkU2G4rDstRnP8%3D" alt="" loading="lazy"/></p>
<p>所以在业务确认要接入风控决策时，就可以先构想一下，我的业务可以支持那些决策（如APP支持指纹、人脸；网页端支持APP扫码验证；都支持短信验证等等），不同的业务系统支持度肯定是不同的，对应在风控决策系统中配置一些需要的决策结果。</p>
<p>同时作为业务系统，在接入风控决策时可以自己定制化适配一套公共的接口，包含对接风控决策，对决策进行处理，联合挑战验证，保留恢复业务现场等等，除此之外最好前端/客户端也适配一套通用sdk。</p>
<p>还有一些做解决方案的想要把整个系统糅一下，包含提供服务端、客户端sdk，实现全流程的控制，当然这个想法非常不错，但这个实现难度，以及实现后的应用推广相当困难。</p>
<h3 data-id="heading-7">租户数据隔离？</h3>
<p>如果你的公司很大，旗下有很多APP、网页，他们用户体系和后台有关联也有独立。做租户肯定是一种想法，你可以为他们划分不同的决策结果，策略规则也更清晰，但是租户就意味着数据隔离，对于风控决策来说数据肯定是越全面越好。</p>
<p>这样的话，租户数据隔离就不是那么合适了，想更好的管控，最好还是有一种ID映射关系，能将用户或设备或其他什么维度关联起来，这样做的风控决策也会更好。</p>
<p>比如：同一个用户用同一个证件号，分别在你家的APP1上先注册申请了一笔贷款，紧接着又在你家的另一个APP2上申请贷款，对于数据完整的风控系统，这肯定是可以设置策略防护的，但如果是设置租户，保留数据隔离，那么就不是很合适了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 泛型数学：解锁真正的类型安全数值运算]]></title>    <link>https://juejin.cn/post/7579088065697579048</link>    <guid>https://juejin.cn/post/7579088065697579048</guid>    <pubDate>2025-12-02T23:19:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579088065697579048" data-draft-id="7579095566899789864" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 泛型数学：解锁真正的类型安全数值运算"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-02T23:19:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 泛型数学：解锁真正的类型安全数值运算
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T23:19:35.000Z" title="Tue Dec 02 2025 23:19:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>C# 11</code> 和 <code>.NET 7</code> 引入了泛型数学（<code>Generic Math</code>）功能，这是一个革命性的特性，允许开发者编写适用于多种数值类型的通用数学算法。这是通过静态抽象接口成员实现的，解决了长期以来在泛型代码中处理数学运算的难题。</p>
<h4 data-id="heading-1">为什么需要“泛型数学”？</h4>
<ul>
<li>
<p>以前无法对“数字类型集合”（<code>int/float/decimal/BigInteger/...</code>）做统一的泛型约束（只能 <code>where T : struct</code>），无法在泛型里使用 <code>+、*</code> 等运算符。</p>
</li>
<li>
<p><code>C# 11</code> 的静态抽象接口成员允许接口定义必须存在的静态成员和运算符，从而把运算符抽象为接口成员；<code>BCL</code> 利用了这个特性，定义了大量数值接口，称为 <code>.NET Generic Math</code>。</p>
</li>
</ul>
<h4 data-id="heading-2">核心思想</h4>
<ul>
<li>
<p>接口可以声明 <code>static abstract</code> 成员（例如 <code>static abstract T Self + T Self</code> 或 <code>static abstract T Zero</code>）。</p>
</li>
<li>
<p>数值类型（<code>int, double, decimal, BigInteger, Half, Int128...</code>）在 <code>.NET 7+</code> 中实现了这些接口。</p>
</li>
<li>
<p>因此：可以写 <code>where T : INumber&lt;T&gt;</code>，在方法体里直接写 <code>T result = a + b</code>; 或 <code>T.Zero、T.One</code>，或调用 <code>T.Sqrt(x)</code>（当 <code>T</code> 支持根函数时）。</p>
</li>
</ul>
<h3 data-id="heading-3">主要接口</h3>
<h4 data-id="heading-4">基本操作接口</h4>
<ul>
<li>
<p><code>IAdditionOperators&lt;TSelf, TOther, TResult&gt;</code>：支持 <code>+</code>。</p>
</li>
<li>
<p><code>ISubtractionOperators&lt;TSelf, TOther, TResult&gt;</code>：支持 <code>-</code>。</p>
</li>
<li>
<p><code>IMultiplyOperators&lt;TSelf, TOther, TResult&gt;</code>：支持 <code>*</code>。</p>
</li>
<li>
<p><code>IDivisionOperators&lt;TSelf, TOther, TResult&gt;</code>：支持 <code>/</code>。</p>
</li>
<li>
<p><code>IModulusOperators、IBitwiseOperators、IShiftOperators、IComparisonOperators</code> 等。</p>
</li>
</ul>
<h4 data-id="heading-5">复合/高阶数值接口</h4>
<ul>
<li>
<p><code>INumberBase&lt;TSelf&gt;</code>：所有数字（甚至复数）共有的基础 <code>API</code>（包含 <code>Abs、CreateChecked/CreateTruncating/CreateSaturating</code> 等）。</p>
</li>
<li>
<p><code>INumber&lt;TSelf&gt;</code>：可比较（<code>ordered</code>）的“实数”类 <code>API</code>（实现它的类型可以比较大小）。</p>
</li>
<li>
<p><code>IBinaryInteger&lt;TSelf&gt;</code>：二进制整数专用（<code>int/long/BigInteger/UInt32/...</code>），提供 <code>DivRem、LeadingZeroCount、RotateLeft/Right</code> 等。</p>
</li>
<li>
<p><code>IFloatingPoint&lt;TSelf&gt; / IFloatingPointIeee754&lt;TSelf&gt;</code>：浮点专用接口（<code>float/double/half</code>），提供 <code>NaN/Infinity</code>、根/幂/三角/对数/舍入等。<code>IFloatingPointIeee754</code> 还包含 <code>IEEE-754</code> 特定 <code>API</code>（常量、特殊值等）。</p>
</li>
</ul>
<h3 data-id="heading-6">核心概念</h3>
<h4 data-id="heading-7">静态抽象接口成员</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 定义包含静态抽象成员的接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IAddable</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">IAddable</span>&lt;<span class="hljs-title">T</span>&gt;
{
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-keyword">operator</span> +(T left, T right);
}

<span class="hljs-comment">// 实现接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> MyNumber : IAddable&lt;MyNumber&gt;
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Value { <span class="hljs-keyword">get</span>; }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyNumber</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span></span>)</span> =&gt; Value = <span class="hljs-keyword">value</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MyNumber <span class="hljs-keyword">operator</span> +(MyNumber left, MyNumber right)
        =&gt; <span class="hljs-keyword">new</span> MyNumber(left.Value + right.Value);
}
</code></pre>
<h4 data-id="heading-8">数学接口体系</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 基本数值接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">INumber</span>&lt;<span class="hljs-title">TSelf</span>&gt; : 
    <span class="hljs-title">IAdditionOperators</span>&lt;<span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>&gt;,
    <span class="hljs-title">ISubtractionOperators</span>&lt;<span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>&gt;,
    <span class="hljs-title">IMultiplyOperators</span>&lt;<span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>&gt;,
    <span class="hljs-title">IDivisionOperators</span>&lt;<span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>&gt;,
    <span class="hljs-title">IComparisonOperators</span>&lt;<span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>, <span class="hljs-title">bool</span>&gt;,
    <span class="hljs-title">IModulusOperators</span>&lt;<span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>, <span class="hljs-title">TSelf</span>&gt;,
    <span class="hljs-title">IMinMaxValue</span>&lt;<span class="hljs-title">TSelf</span>&gt;
    <span class="hljs-keyword">where</span> <span class="hljs-title">TSelf</span> : <span class="hljs-title">INumber</span>&lt;<span class="hljs-title">TSelf</span>&gt;?
{
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> TSelf Zero { <span class="hljs-keyword">get</span>; }
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> TSelf One { <span class="hljs-keyword">get</span>; }
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> TSelf <span class="hljs-title">Abs</span>(<span class="hljs-params">TSelf <span class="hljs-keyword">value</span></span>)</span>;
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> TSelf <span class="hljs-title">Max</span>(<span class="hljs-params">TSelf x, TSelf y</span>)</span>;
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">abstract</span> TSelf <span class="hljs-title">Min</span>(<span class="hljs-params">TSelf x, TSelf y</span>)</span>;
}
</code></pre>
<h3 data-id="heading-9">常见用法与示例</h3>
<h4 data-id="heading-10">简单的泛型数学函数</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型求和函数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">Sum</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">IEnumerable&lt;T&gt; values</span>) <span class="hljs-keyword">where</span> T : INumber&lt;T&gt;</span>
{
    T result = T.Zero;
    <span class="hljs-keyword">foreach</span> (T <span class="hljs-keyword">value</span> <span class="hljs-keyword">in</span> values)
    {
        result += <span class="hljs-keyword">value</span>;
    }
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 泛型平均值函数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">Average</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">IEnumerable&lt;T&gt; values</span>) <span class="hljs-keyword">where</span> T : INumber&lt;T&gt;</span>
{
    T sum = T.Zero;
    <span class="hljs-built_in">int</span> count = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">foreach</span> (T <span class="hljs-keyword">value</span> <span class="hljs-keyword">in</span> values)
    {
        sum += <span class="hljs-keyword">value</span>;
        count++;
    }
    
    <span class="hljs-keyword">return</span> sum / T.CreateChecked(count);
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-built_in">int</span>[] ints = { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> };
<span class="hljs-built_in">double</span>[] doubles = { <span class="hljs-number">1.1</span>, <span class="hljs-number">2.2</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">4.4</span>, <span class="hljs-number">5.5</span> };

Console.WriteLine(Sum(ints));     <span class="hljs-comment">// 输出: 15</span>
Console.WriteLine(Average(doubles)); <span class="hljs-comment">// 输出: 3.3</span>
</code></pre>
<h4 data-id="heading-11">数学运算示例</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型数学运算</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">Calculate</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">T a, T b</span>) <span class="hljs-keyword">where</span> T : INumber&lt;T&gt;</span>
{
    <span class="hljs-keyword">return</span> (a + b) * (a - b) / T.CreateChecked(<span class="hljs-number">2</span>);
}

<span class="hljs-comment">// 使用不同的数值类型</span>
Console.WriteLine(Calculate(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>));      <span class="hljs-comment">// int: (10+5)*(10-5)/2 = 37</span>
Console.WriteLine(Calculate(<span class="hljs-number">10.5</span>, <span class="hljs-number">5.5</span>));  <span class="hljs-comment">// double: (10.5+5.5)*(10.5-5.5)/2 = 40</span>
</code></pre>
<h4 data-id="heading-12">求平均值（<code>INumber&lt;T&gt;</code>，示例使用 CreateChecked 将 int 转为 T）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Numerics;

<span class="hljs-function"><span class="hljs-keyword">static</span> T <span class="hljs-title">Average</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">IEnumerable&lt;T&gt; src</span>) <span class="hljs-keyword">where</span> T : INumber&lt;T&gt;</span>
{
    <span class="hljs-keyword">if</span> (src == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-keyword">nameof</span>(src));
    T sum = T.Zero;
    <span class="hljs-built_in">long</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> x <span class="hljs-keyword">in</span> src) { sum += x; count++; }
    <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">"sequence empty"</span>);
    <span class="hljs-comment">// 将 long 转换为 T（CreateChecked/Truncating/Saturating 都可选）</span>
    T countT = T.CreateChecked&lt;<span class="hljs-built_in">long</span>&gt;(count);
    <span class="hljs-keyword">return</span> sum / countT;
}
</code></pre>
<blockquote>
<p><code>CreateChecked&lt;TOther&gt; / CreateTruncating&lt;TOther&gt; / CreateSaturating&lt;TOther&gt; 在 INumberBase&lt;T&gt;</code> 上定义，用于跨数值类型安全转换（会抛异常、截断或饱和）。</p>
</blockquote>
<h4 data-id="heading-13">GCD（用在整数上：<code>IBinaryInteger&lt;T&gt;</code>）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System.Numerics;

<span class="hljs-function"><span class="hljs-keyword">static</span> T <span class="hljs-title">Gcd</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">T a, T b</span>) <span class="hljs-keyword">where</span> T : IBinaryInteger&lt;T&gt;</span>
{
    a = T.Abs(a);
    b = T.Abs(b);
    <span class="hljs-keyword">while</span> (b != T.Zero)
    {
        <span class="hljs-keyword">var</span> r = a % b;
        a = b;
        b = r;
    }
    <span class="hljs-keyword">return</span> a;
}
</code></pre>
<blockquote>
<p><code>IBinaryInteger&lt;T&gt;</code> 提供 %、DivRem、LeadingZeroCount 等整型专用工具。</p>
</blockquote>
<h4 data-id="heading-14">浮点 sqrt / hypot（<code>IFloatingPointIeee754&lt;T&gt;</code>）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System.Numerics;

<span class="hljs-function"><span class="hljs-keyword">static</span> T <span class="hljs-title">Hypot</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">T x, T y</span>) <span class="hljs-keyword">where</span> T : IFloatingPointIeee754&lt;T&gt;</span>
{
    <span class="hljs-comment">// IFloatingPointIeee754 / IRootFunctions 提供 Hypot / Sqrt / Cbrt 等</span>
    <span class="hljs-keyword">return</span> T.Hypot(x, y);
    <span class="hljs-comment">// 或者 return T.Sqrt(x * x + y * y);</span>
}
</code></pre>
<blockquote>
<p>IFloatingPointIeee754 继承了 IRootFunctions、IPowerFunctions 等，支持 Sqrt, Pow, Hypot 等静态函数。</p>
</blockquote>
<h4 data-id="heading-15">泛型矩阵相乘</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Matrix</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">INumber</span>&lt;<span class="hljs-title">T</span>&gt;
{
    T[,] _a;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> R =&gt; _a.GetLength(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> C =&gt; _a.GetLength(<span class="hljs-number">1</span>);
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Matrix</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> r, <span class="hljs-built_in">int</span> c</span>)</span> =&gt; _a = <span class="hljs-keyword">new</span> T[r,c];
    <span class="hljs-keyword">public</span> T <span class="hljs-keyword">this</span>[<span class="hljs-built_in">int</span> i,<span class="hljs-built_in">int</span> j] { <span class="hljs-keyword">get</span> =&gt; _a[i,j]; <span class="hljs-keyword">set</span> =&gt; _a[i,j] = <span class="hljs-keyword">value</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Matrix&lt;T&gt; <span class="hljs-title">Multiply</span>(<span class="hljs-params">Matrix&lt;T&gt; A, Matrix&lt;T&gt; B</span>)</span>
    {
        <span class="hljs-keyword">if</span> (A.C != B.R) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"size"</span>);
        <span class="hljs-keyword">var</span> C = <span class="hljs-keyword">new</span> Matrix&lt;T&gt;(A.R, B.C);
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; A.R; i++)
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> j = <span class="hljs-number">0</span>; j &lt; B.C; j++)
            {
                T sum = T.Zero;
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> k = <span class="hljs-number">0</span>; k &lt; A.C; k++)
                    sum += A[i,k] * B[k,j];
                C[i,j] = sum;
            }
        <span class="hljs-keyword">return</span> C;
    }
}
</code></pre>
<h4 data-id="heading-16">复数计算示例</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型复数计算</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title">Complex</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">T Real, T Imaginary</span>) <span class="hljs-keyword">where</span> T : INumber&lt;T&gt;</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Complex&lt;T&gt; <span class="hljs-keyword">operator</span> +(Complex&lt;T&gt; left, Complex&lt;T&gt; right)
        =&gt; <span class="hljs-keyword">new</span> Complex&lt;T&gt;(left.Real + right.Real, left.Imaginary + right.Imaginary);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Complex&lt;T&gt; <span class="hljs-keyword">operator</span> *(Complex&lt;T&gt; left, Complex&lt;T&gt; right)
        =&gt; <span class="hljs-keyword">new</span> Complex&lt;T&gt;(
            left.Real * right.Real - left.Imaginary * right.Imaginary,
            left.Real * right.Imaginary + left.Imaginary * right.Real
        );
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">Magnitude</span>() <span class="hljs-keyword">where</span> T : IRootFunctions&lt;T&gt;</span>
    {
        <span class="hljs-keyword">return</span> T.Sqrt(Real * Real + Imaginary * Imaginary);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span> =&gt; <span class="hljs-string">$"<span class="hljs-subst">{Real}</span> + <span class="hljs-subst">{Imaginary}</span>i"</span>;
}

<span class="hljs-comment">// 使用复数</span>
<span class="hljs-keyword">var</span> c1 = <span class="hljs-keyword">new</span> Complex&lt;<span class="hljs-built_in">double</span>&gt;(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
<span class="hljs-keyword">var</span> c2 = <span class="hljs-keyword">new</span> Complex&lt;<span class="hljs-built_in">double</span>&gt;(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
<span class="hljs-keyword">var</span> sum = c1 + c2;
<span class="hljs-keyword">var</span> product = c1 * c2;

Console.WriteLine(<span class="hljs-string">$"Sum: <span class="hljs-subst">{sum}</span>"</span>);           <span class="hljs-comment">// 4 + 6i</span>
Console.WriteLine(<span class="hljs-string">$"Product: <span class="hljs-subst">{product}</span>"</span>);   <span class="hljs-comment">// -5 + 10i</span>
Console.WriteLine(<span class="hljs-string">$"Magnitude: <span class="hljs-subst">{c1.Magnitude()}</span>"</span>); <span class="hljs-comment">// 5</span>
</code></pre>
<h3 data-id="heading-17">实际应用场景</h3>
<h4 data-id="heading-18">通用数学库函数</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">StandardDeviation</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">IEnumerable&lt;T&gt; values</span>)
    <span class="hljs-keyword">where</span> T : INumber&lt;T&gt;, IRootFunctions&lt;T&gt;</span>
{
    <span class="hljs-keyword">var</span> mean = Mean(values);
    <span class="hljs-keyword">var</span> variance = T.Zero;
    <span class="hljs-keyword">var</span> count = T.Zero;
    
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">in</span> values)
    {
        <span class="hljs-keyword">var</span> diff = <span class="hljs-keyword">value</span> - mean;
        variance += diff * diff;
        count++;
    }
    
    variance /= count;
    <span class="hljs-keyword">return</span> T.Sqrt(variance);
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">Mean</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">IEnumerable&lt;T&gt; values</span>) <span class="hljs-keyword">where</span> T : INumber&lt;T&gt;</span>
{
    <span class="hljs-keyword">var</span> sum = T.Zero;
    <span class="hljs-keyword">var</span> count = T.Zero;
    
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">in</span> values)
    {
        sum += <span class="hljs-keyword">value</span>;
        count++;
    }
    
    <span class="hljs-keyword">return</span> sum / count;
}
</code></pre>
<h4 data-id="heading-19">几何计算</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title">Vector2D</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">T X, T Y</span>) <span class="hljs-keyword">where</span> T : INumber&lt;T&gt;, IRootFunctions&lt;T&gt;</span>
{
    <span class="hljs-keyword">public</span> T Magnitude =&gt; T.Sqrt(X * X + Y * Y);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Vector2D&lt;T&gt; <span class="hljs-keyword">operator</span> +(Vector2D&lt;T&gt; a, Vector2D&lt;T&gt; b)
        =&gt; <span class="hljs-keyword">new</span>(a.X + b.X, a.Y + b.Y);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Vector2D&lt;T&gt; <span class="hljs-keyword">operator</span> -(Vector2D&lt;T&gt; a, Vector2D&lt;T&gt; b)
        =&gt; <span class="hljs-keyword">new</span>(a.X - b.X, a.Y - b.Y);
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">Dot</span>(<span class="hljs-params">Vector2D&lt;T&gt; a, Vector2D&lt;T&gt; b</span>)</span>
        =&gt; a.X * b.X + a.Y * b.Y;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> Vector2D&lt;T&gt; <span class="hljs-title">Normalize</span>()</span>
    {
        <span class="hljs-keyword">var</span> mag = Magnitude;
        <span class="hljs-keyword">return</span> mag == T.Zero 
            ? <span class="hljs-keyword">this</span> 
            : <span class="hljs-keyword">new</span> Vector2D&lt;T&gt;(X / mag, Y / mag);
    }
}
</code></pre>
<h4 data-id="heading-20">财务计算</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">CalculateCompoundInterest</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">
    T principal, 
    T annualRate, 
    <span class="hljs-built_in">int</span> years, 
    <span class="hljs-built_in">int</span> compoundingPeriods = <span class="hljs-number">1</span></span>)
    <span class="hljs-keyword">where</span> T : IFloatingPoint&lt;T&gt;</span>
{
    <span class="hljs-keyword">var</span> ratePerPeriod = annualRate / T.CreateChecked(compoundingPeriods);
    <span class="hljs-keyword">var</span> periods = years * compoundingPeriods;
    
    <span class="hljs-keyword">return</span> principal * T.Pow(T.One + ratePerPeriod, T.CreateChecked(periods));
}
</code></pre>
<h4 data-id="heading-21">数值积分和微分</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型数值积分</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">Integrate</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">
    Func&lt;T, T&gt; function, 
    T <span class="hljs-keyword">from</span>, 
    T to, 
    <span class="hljs-built_in">int</span> steps</span>) <span class="hljs-keyword">where</span> T : IFloatingPoint&lt;T&gt;</span>
{
    T stepSize = (to - <span class="hljs-keyword">from</span>) / T.CreateChecked(steps);
    T sum = T.Zero;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; steps; i++)
    {
        T x1 = <span class="hljs-keyword">from</span> + T.CreateChecked(i) * stepSize;
        T x2 = <span class="hljs-keyword">from</span> + T.CreateChecked(i + <span class="hljs-number">1</span>) * stepSize;
        T y1 = function(x1);
        T y2 = function(x2);
        
        <span class="hljs-comment">// 梯形法则</span>
        sum += (y1 + y2) * stepSize / T.CreateChecked(<span class="hljs-number">2</span>);
    }
    
    <span class="hljs-keyword">return</span> sum;
}

<span class="hljs-comment">// 使用数值积分</span>
Func&lt;<span class="hljs-built_in">double</span>, <span class="hljs-built_in">double</span>&gt; f = x =&gt; x * x; <span class="hljs-comment">// f(x) = x²</span>
<span class="hljs-built_in">double</span> integral = Integrate(f, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">1000</span>);
Console.WriteLine(<span class="hljs-string">$"∫x²dx from 0 to 1 = <span class="hljs-subst">{integral}</span>"</span>); <span class="hljs-comment">// 约等于 0.333...</span>
</code></pre>
<h4 data-id="heading-22">线性代数运算</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型向量类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> Vector&lt;T&gt; <span class="hljs-keyword">where</span> T : INumber&lt;T&gt;
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> T[] _components;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Vector</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> T[] components</span>)</span>
    {
        _components = components;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Dimension =&gt; _components.Length;
    
    <span class="hljs-keyword">public</span> T <span class="hljs-keyword">this</span>[<span class="hljs-built_in">int</span> index]
    {
        <span class="hljs-keyword">get</span> =&gt; _components[index];
        <span class="hljs-keyword">set</span> =&gt; _components[index] = <span class="hljs-keyword">value</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Vector&lt;T&gt; <span class="hljs-keyword">operator</span> +(Vector&lt;T&gt; left, Vector&lt;T&gt; right)
    {
        <span class="hljs-keyword">if</span> (left.Dimension != right.Dimension)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"Vectors must have the same dimension"</span>);
        
        T[] result = <span class="hljs-keyword">new</span> T[left.Dimension];
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; left.Dimension; i++)
        {
            result[i] = left[i] + right[i];
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Vector&lt;T&gt;(result);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-keyword">operator</span> *(Vector&lt;T&gt; left, Vector&lt;T&gt; right) <span class="hljs-comment">// 点积</span>
    {
        <span class="hljs-keyword">if</span> (left.Dimension != right.Dimension)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"Vectors must have the same dimension"</span>);
        
        T result = T.Zero;
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; left.Dimension; i++)
        {
            result += left[i] * right[i];
        }
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">Magnitude</span>() <span class="hljs-keyword">where</span> T : IRootFunctions&lt;T&gt;</span>
    {
        T sumOfSquares = T.Zero;
        <span class="hljs-keyword">foreach</span> (T component <span class="hljs-keyword">in</span> _components)
        {
            sumOfSquares += component * component;
        }
        <span class="hljs-keyword">return</span> T.Sqrt(sumOfSquares);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span> =&gt; 
        <span class="hljs-string">$"[<span class="hljs-subst">{<span class="hljs-built_in">string</span>.Join(<span class="hljs-string">", "</span>, _components)}</span>]"</span>;
}

<span class="hljs-comment">// 使用向量</span>
<span class="hljs-keyword">var</span> v1 = <span class="hljs-keyword">new</span> Vector&lt;<span class="hljs-built_in">double</span>&gt;(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);
<span class="hljs-keyword">var</span> v2 = <span class="hljs-keyword">new</span> Vector&lt;<span class="hljs-built_in">double</span>&gt;(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>);
<span class="hljs-keyword">var</span> sum = v1 + v2;
<span class="hljs-keyword">var</span> dotProduct = v1 * v2;

Console.WriteLine(<span class="hljs-string">$"v1 + v2 = <span class="hljs-subst">{sum}</span>"</span>);           <span class="hljs-comment">// [5, 7, 9]</span>
Console.WriteLine(<span class="hljs-string">$"v1 · v2 = <span class="hljs-subst">{dotProduct}</span>"</span>);    <span class="hljs-comment">// 32</span>
Console.WriteLine(<span class="hljs-string">$"|v1| = <span class="hljs-subst">{v1.Magnitude()}</span>"</span>);   <span class="hljs-comment">// 3.741...</span>
</code></pre>
<h4 data-id="heading-23">统计计算</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型统计函数</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Statistics</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">INumber</span>&lt;<span class="hljs-title">T</span>&gt;, <span class="hljs-title">IFloatingPoint</span>&lt;<span class="hljs-title">T</span>&gt;
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">Mean</span>(<span class="hljs-params">IEnumerable&lt;T&gt; values</span>)</span>
    {
        T sum = T.Zero;
        <span class="hljs-built_in">int</span> count = <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">foreach</span> (T <span class="hljs-keyword">value</span> <span class="hljs-keyword">in</span> values)
        {
            sum += <span class="hljs-keyword">value</span>;
            count++;
        }
        
        <span class="hljs-keyword">return</span> sum / T.CreateChecked(count);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">Variance</span>(<span class="hljs-params">IEnumerable&lt;T&gt; values</span>)</span>
    {
        T mean = Mean(values);
        T sumOfSquares = T.Zero;
        <span class="hljs-built_in">int</span> count = <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">foreach</span> (T <span class="hljs-keyword">value</span> <span class="hljs-keyword">in</span> values)
        {
            T deviation = <span class="hljs-keyword">value</span> - mean;
            sumOfSquares += deviation * deviation;
            count++;
        }
        
        <span class="hljs-keyword">return</span> sumOfSquares / T.CreateChecked(count);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">StandardDeviation</span>(<span class="hljs-params">IEnumerable&lt;T&gt; values</span>)</span>
    {
        <span class="hljs-keyword">return</span> T.Sqrt(Variance(values));
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> (<span class="hljs-params">T Min, T Max, T Median</span>) <span class="hljs-title">DescriptiveStats</span>(<span class="hljs-params">IEnumerable&lt;T&gt; values</span>)</span>
    {
        <span class="hljs-keyword">var</span> sorted = values.OrderBy(v =&gt; v).ToArray();
        <span class="hljs-built_in">int</span> count = sorted.Length;
        
        T min = sorted[<span class="hljs-number">0</span>];
        T max = sorted[count - <span class="hljs-number">1</span>];
        
        T median = count % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>
            ? (sorted[count / <span class="hljs-number">2</span> - <span class="hljs-number">1</span>] + sorted[count / <span class="hljs-number">2</span>]) / T.CreateChecked(<span class="hljs-number">2</span>)
            : sorted[count / <span class="hljs-number">2</span>];
        
        <span class="hljs-keyword">return</span> (min, max, median);
    }
}

<span class="hljs-comment">// 使用统计函数</span>
<span class="hljs-built_in">double</span>[] data = { <span class="hljs-number">1.2</span>, <span class="hljs-number">2.3</span>, <span class="hljs-number">3.4</span>, <span class="hljs-number">4.5</span>, <span class="hljs-number">5.6</span> };
Console.WriteLine(<span class="hljs-string">$"Mean: <span class="hljs-subst">{Statistics&lt;<span class="hljs-built_in">double</span>&gt;.Mean(data)}</span>"</span>);
Console.WriteLine(<span class="hljs-string">$"Variance: <span class="hljs-subst">{Statistics&lt;<span class="hljs-built_in">double</span>&gt;.Variance(data)}</span>"</span>);
Console.WriteLine(<span class="hljs-string">$"Standard Deviation: <span class="hljs-subst">{Statistics&lt;<span class="hljs-built_in">double</span>&gt;.StandardDeviation(data)}</span>"</span>);

<span class="hljs-keyword">var</span> (min, max, median) = Statistics&lt;<span class="hljs-built_in">double</span>&gt;.DescriptiveStats(data);
Console.WriteLine(<span class="hljs-string">$"Min: <span class="hljs-subst">{min}</span>, Max: <span class="hljs-subst">{max}</span>, Median: <span class="hljs-subst">{median}</span>"</span>);
</code></pre>
<h3 data-id="heading-24">自定义数值类型</h3>
<h4 data-id="heading-25">创建支持泛型数学的自定义类型</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 自定义分数类型</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">struct</span> Fraction : 
    INumber&lt;Fraction&gt;,
    IComparisonOperators&lt;Fraction, Fraction, <span class="hljs-built_in">bool</span>&gt;,
    IModulusOperators&lt;Fraction, Fraction, Fraction&gt;
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> Numerator { <span class="hljs-keyword">get</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> Denominator { <span class="hljs-keyword">get</span>; }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Fraction</span>(<span class="hljs-params"><span class="hljs-built_in">long</span> numerator, <span class="hljs-built_in">long</span> denominator</span>)</span>
    {
        <span class="hljs-keyword">if</span> (denominator == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> DivideByZeroException(<span class="hljs-string">"Denominator cannot be zero"</span>);
        
        <span class="hljs-comment">// 简化分数</span>
        <span class="hljs-built_in">long</span> gcd = Gcd(Math.Abs(numerator), Math.Abs(denominator));
        Numerator = numerator / gcd;
        Denominator = denominator / gcd;
        
        <span class="hljs-comment">// 确保分母为正</span>
        <span class="hljs-keyword">if</span> (Denominator &lt; <span class="hljs-number">0</span>)
        {
            Numerator = -Numerator;
            Denominator = -Denominator;
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">long</span> <span class="hljs-title">Gcd</span>(<span class="hljs-params"><span class="hljs-built_in">long</span> a, <span class="hljs-built_in">long</span> b</span>)</span> =&gt; b == <span class="hljs-number">0</span> ? a : Gcd(b, a % b);
    
    <span class="hljs-comment">// INumber&lt;Fraction&gt; 实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Fraction Zero =&gt; <span class="hljs-keyword">new</span> Fraction(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Fraction One =&gt; <span class="hljs-keyword">new</span> Fraction(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Fraction <span class="hljs-keyword">operator</span> +(Fraction left, Fraction right)
    {
        <span class="hljs-built_in">long</span> numerator = left.Numerator * right.Denominator + right.Numerator * left.Denominator;
        <span class="hljs-built_in">long</span> denominator = left.Denominator * right.Denominator;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Fraction(numerator, denominator);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Fraction <span class="hljs-keyword">operator</span> -(Fraction left, Fraction right)
    {
        <span class="hljs-built_in">long</span> numerator = left.Numerator * right.Denominator - right.Numerator * left.Denominator;
        <span class="hljs-built_in">long</span> denominator = left.Denominator * right.Denominator;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Fraction(numerator, denominator);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Fraction <span class="hljs-keyword">operator</span> *(Fraction left, Fraction right)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Fraction(
            left.Numerator * right.Numerator,
            left.Denominator * right.Denominator
        );
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Fraction <span class="hljs-keyword">operator</span> /(Fraction left, Fraction right)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Fraction(
            left.Numerator * right.Denominator,
            left.Denominator * right.Numerator
        );
    }
    
    <span class="hljs-comment">// 其他接口实现...</span>
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span> =&gt; <span class="hljs-string">$"<span class="hljs-subst">{Numerator}</span>/<span class="hljs-subst">{Denominator}</span>"</span>;
}

<span class="hljs-comment">// 使用自定义分数类型</span>
Fraction f1 = <span class="hljs-keyword">new</span> Fraction(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
Fraction f2 = <span class="hljs-keyword">new</span> Fraction(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
Fraction sum = f1 + f2; <span class="hljs-comment">// 5/4</span>
Fraction product = f1 * f2; <span class="hljs-comment">// 3/8</span>

Console.WriteLine(<span class="hljs-string">$"<span class="hljs-subst">{f1}</span> + <span class="hljs-subst">{f2}</span> = <span class="hljs-subst">{sum}</span>"</span>);
Console.WriteLine(<span class="hljs-string">$"<span class="hljs-subst">{f1}</span> × <span class="hljs-subst">{f2}</span> = <span class="hljs-subst">{product}</span>"</span>);
</code></pre>
<h3 data-id="heading-26">高级技巧</h3>
<h4 data-id="heading-27">类型转换处理</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TResult <span class="hljs-title">ConvertSafely</span>&lt;<span class="hljs-title">TInput</span>, <span class="hljs-title">TResult</span>&gt;(<span class="hljs-params">TInput <span class="hljs-keyword">value</span></span>)
    <span class="hljs-keyword">where</span> TInput : INumber&lt;TInput&gt;
    <span class="hljs-keyword">where</span> TResult : INumber&lt;TResult&gt;</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">return</span> TResult.CreateChecked(<span class="hljs-keyword">value</span>);
    }
    <span class="hljs-keyword">catch</span> (OverflowException)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span> &lt; TInput.Zero 
            ? TResult.NegativeInfinity 
            : TResult.PositiveInfinity;
    }
}
</code></pre>
<h4 data-id="heading-28">性能优化</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用泛型数学的向量化操作</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T[] <span class="hljs-title">VectorAdd</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">T[] a, T[] b</span>) 
    <span class="hljs-keyword">where</span> T : IAdditionOperators&lt;T, T, T&gt;, IAdditiveIdentity&lt;T, T&gt;</span>
{
    <span class="hljs-keyword">if</span> (a.Length != b.Length)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"Arrays must be same length"</span>);
    
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">new</span> T[a.Length];
    
    <span class="hljs-comment">// 使用 SIMD 优化（如果可用）</span>
    <span class="hljs-keyword">if</span> (Vector.IsHardwareAccelerated &amp;&amp; 
        Vector&lt;T&gt;.IsSupported)
    {
        <span class="hljs-built_in">int</span> vectorSize = Vector&lt;T&gt;.Count;
        <span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (; i &lt;= a.Length - vectorSize; i += vectorSize)
        {
            <span class="hljs-keyword">var</span> va = <span class="hljs-keyword">new</span> Vector&lt;T&gt;(a, i);
            <span class="hljs-keyword">var</span> vb = <span class="hljs-keyword">new</span> Vector&lt;T&gt;(b, i);
            (va + vb).CopyTo(result, i);
        }
        
        <span class="hljs-comment">// 处理剩余元素</span>
        <span class="hljs-keyword">for</span> (; i &lt; a.Length; i++)
        {
            result[i] = a[i] + b[i];
        }
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">// 回退到常规循环</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; a.Length; i++)
        {
            result[i] = a[i] + b[i];
        }
    }
    
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-29">条件约束组合</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">SafeDivide</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">T dividend, T divisor</span>)
    <span class="hljs-keyword">where</span> T : IDivisionOperators&lt;T, T, T&gt;, 
              IComparisonOperators&lt;T, T, <span class="hljs-built_in">bool</span>&gt;,
              IAdditiveIdentity&lt;T, T&gt;</span>
{
    <span class="hljs-keyword">if</span> (divisor == T.AdditiveIdentity)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> DivideByZeroException();
    
    <span class="hljs-keyword">return</span> dividend / divisor;
}
</code></pre>
<h3 data-id="heading-30">类型/接口选择建议</h3>
<ul>
<li>
<p>想要通用数（能 + - * /、有 Zero、能比较大小）→ 用 <code>INumber&lt;T&gt;</code>。</p>
</li>
<li>
<p>只针对整数算法（GCD、位操作等）→ 用 <code>IBinaryInteger&lt;T&gt;</code>。</p>
</li>
<li>
<p>只针对浮点/IEEE754 特性（NaN、Infinity、Sqrt、Hypot 等）→ 用 <code>IFloatingPointIeee754&lt;T&gt;</code>（或更窄的 <code>IFloatingPoint&lt;T&gt;</code>）。</p>
</li>
</ul>
<h3 data-id="heading-31">总结</h3>
<p><code>C# 11</code> 和 <code>.NET 7</code> 的泛型数学功能是一个重大突破，它：</p>
<ul>
<li>
<p>解决了长期痛点：终于可以在泛型代码中方便地进行数学运算</p>
</li>
<li>
<p>提供了完整的数学接口体系：覆盖基本运算、比较、三角函数等</p>
</li>
<li>
<p>支持自定义数值类型：可以创建自己的数值类型并集成到数学生态中</p>
</li>
<li>
<p>保持高性能：通过静态抽象接口避免装箱拆箱开销</p>
</li>
<li>
<p>增强类型安全：编译时类型检查，减少运行时错误</p>
</li>
</ul>
<p>适用场景：</p>
<ul>
<li>
<p>数学库开发：创建通用的数学算法库</p>
</li>
<li>
<p>科学计算：物理模拟、数值分析等</p>
</li>
<li>
<p>游戏开发：向量、矩阵运算</p>
</li>
<li>
<p>金融计算：高精度数值计算</p>
</li>
<li>
<p>数据处理：统计分析、数据转换</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[像P图一样改视频？可灵O1来了，视频生成领域的“瑞士军刀”]]></title>    <link>https://juejin.cn/post/7579094978681520174</link>    <guid>https://juejin.cn/post/7579094978681520174</guid>    <pubDate>2025-12-02T13:28:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579094978681520174" data-draft-id="7579068270294630426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="像P图一样改视频？可灵O1来了，视频生成领域的“瑞士军刀”"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-02T13:28:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            像P图一样改视频？可灵O1来了，视频生成领域的“瑞士军刀”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T13:28:12.000Z" title="Tue Dec 02 2025 13:28:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为一名每天都在和各种AI模型“斗智斗勇”的内容创作者，我不得不承认，视频生成这块骨头一直是最难啃的。我们要么在不同工具间反复横跳，要么对着生成的视频里乱飞的五官叹气。</p>
<p>但最近，快手旗下的可灵AI发布了全新的“可灵O1”模型，并且已经在LiblibAI上线。上手体验了一番后，我那种“终于等到你”的感觉非常强烈。它不是简单的画质升级，而是改变了玩视频的逻辑。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-02_21.18.59-1024x480.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-02_21.18.59-1024x480.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d32278a77a4462a84e303c643ed86d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765286892&amp;x-signature=72MCY%2BnCPs7UImIcnmw%2FHIxHUao%3D" alt="iShot_2025-12-02_21.18.59" loading="lazy"/></a></p>
<p><strong>为什么叫O1？不仅仅是名字好听</strong></p>
<p>O1代表的是Omni，也就是“全能”。</p>
<p>以前我们做AI视频是怎样的？先用Midjourney出图，再用Runway或者Luma让图动起来，如果想改个细节？对不起，重抽卡吧。</p>
<p>可灵O1最大的突破在于它是一个“统一多模态架构”。别被这几个技术名词吓跑，说人话就是：它把文生视频、图生视频、视频编辑全部揉进了一个引擎里。你不需要切换工具，在一个对话框里就能搞定所有事情。这就像是你从带着一堆螺丝刀、锤子、扳手出门，变成只带了一把瑞士军刀。</p>
<p><strong>能听懂人话的“剪辑师”</strong></p>
<p>这个模型最让我惊喜的是它的理解能力。它引入了MVL（多模态视觉语言）交互架构和Chain-of-thought（思维链）技术。</p>
<p>这意味着什么？意味着它真的能听懂你在说什么，并且具备一定的物理常识。</p>
<p>举个例子，如果我上传一段夏天的视频，对它说“把夏天变成冬天”，它不仅仅是把画面调冷，它可能会给树加上积雪，给人物加上哈气。或者你觉得画面里那个路人碍眼，直接输入“删除路人”，它就能像PS里的内容识别填充一样，把人抹掉并自动补全背景。</p>
<p>它甚至支持像“@某张图片 + @某个视频 + 生成下一个镜头”这样的组合指令。这种“指哪打哪”的像素级语义重构，才是创作者真正需要的生产力。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-02_21.19.19-1024x781.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-02_21.19.19-1024x781.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b63ff77bbfef4225b03d2342122c595f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765286892&amp;x-signature=MZMYHAdU7sgii2DdOGVxPDzMd3o%3D" alt="iShot_2025-12-02_21.19.19" loading="lazy"/></a></p>
<p><strong>告别“变脸”，角色终于稳了</strong></p>
<p>做连续剧情短片最大的噩梦就是角色一致性。往往第一个镜头主角是吴彦祖，下一个镜头就变成了吴孟达。</p>
<p>可灵O1在这个痛点上下了狠功夫。它支持最多7张参考图输入，并且有一个专门的主体库。在实测中，即使镜头发生大幅度的运镜或者场景切换，主角的脸部特征、衣服细节依然能保持高度稳定。</p>
<p>对于那些想做AI电影或者连载短剧的朋友来说，这绝对是个杀手锏。</p>
<p><strong>实诚的测评：优点突出，但也别神化</strong></p>
<p>虽然吹了这么多，但作为一名客观的测评者，我得泼点冷水，让大家有个合理的预期。</p>
<p>首先，它是刚发布的一代模型。目前生成的视频分辨率最高是1080p，还没到4K级别。如果你是追求极致画质的“数毛党”，可能在人物特写时会发现面部细节还不够完美。</p>
<p>其次，它目前是个“哑巴”。虽然视频生成很强，但它不支持生成音效或对白，声音部分还得靠你自己后期合成。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-02_21.19.09-1024x410.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-02_21.19.09-1024x410.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ce4f2455464762ae0d4278119c6a3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765286892&amp;x-signature=K0go42dOlQJ6RYcLhKUQh7TeHoQ%3D" alt="iShot_2025-12-02_21.19.09" loading="lazy"/></a></p>
<p>再者，它对特别复杂的动词指令，比如“蹑手蹑脚地潜行”这种带有微妙情绪和姿态的词，理解上偶尔还会差点意思。</p>
<p><strong>在哪里能玩到？</strong></p>
<p>目前体验这个模型最方便的渠道是LiblibAI平台，作为首发合作方，入口很显眼。当然，你也可以去可灵AI的官网或App。</p>
<p><strong>总结一下</strong></p>
<p>可灵O1不是那种只会在参数上卷数字的模型，它是奔着解决实际工作流问题去的。虽然它还不完美，但它展示了一种可能性：未来的视频创作，真的可以像现在P图一样简单、直观、随心所欲。</p>
<p>对于我们这些创作者来说，工具的门槛越低，留给创意的空间就越大。这就够了。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 组件设计纠结症？一招教你告别“数据到底放哪”的烦恼]]></title>    <link>https://juejin.cn/post/7579256547789291561</link>    <guid>https://juejin.cn/post/7579256547789291561</guid>    <pubDate>2025-12-02T23:25:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579256547789291561" data-draft-id="7579123072826195987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 组件设计纠结症？一招教你告别“数据到底放哪”的烦恼"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-02T23:25:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 组件设计纠结症？一招教你告别“数据到底放哪”的烦恼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T23:25:04.000Z" title="Tue Dec 02 2025 23:25:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是经常在写 Vue 组件的时候，对着一个数据发愣？
心里琢磨：“这个状态，是应该放在子组件里自己管，还是提到父组件那去？”
或者，眼看着 props 像传球一样，从爷爷组件传到爸爸组件，再传到儿子组件，感觉无比啰嗦和别扭。
这种“数据放哪儿”的纠结，简直堪称前端开发的日常“哲学难题”。</p>
<p>别担心，这根本不是你的问题，而是 Vue 组件设计中两个核心模式在“打架”：<strong>状态提升</strong> 和 <strong>单向下行数据流</strong>。
今天，我们就来好好聊聊它俩，帮你理清思路，下次再做选择时，心里跟明镜似的。</p>
<h2 data-id="heading-0">什么是单向下行数据流？Vue 的“家规”</h2>
<p>咱们先说说单向下行数据流，这是 Vue 官方非常推荐的一种数据传递方式，你可以把它理解成 Vue 组件间的“家规”。</p>
<p><strong>这条“家规”很简单：数据从上往下流，像瀑布一样，不能逆流。</strong>
具体来说就是：</p>
<ol>
<li><strong>数据拥有者（通常是父组件）</strong> 负责管理和维护状态。</li>
<li><strong>数据使用者（子组件）</strong> 通过 <code>props</code> 接收来自上面的数据。</li>
<li>子组件<strong>不能直接修改</strong>传下来的 <code>props</code>。如果子组件想改变数据，必须通过“事件”（<code>$emit</code>）向上汇报，请求父组件这个“家长”来修改。</li>
</ol>
<p>为什么要立这么个规矩呢？就是为了<strong>让数据流向变得清晰、可预测</strong>。
想象一下，如果任何一个组件都能随便改数据，那么当应用出 bug 时，你根本不知道数据是在哪一环被改坏的，找起来就像大海捞针。
而有了这条“家规”，所有数据的变更都追溯到唯一的源头（父组件），调试起来就轻松多了。</p>
<p>让我们看一个最经典的例子：一个计数器按钮。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 父组件 Parent.vue --&gt;
&lt;template&gt;
  &lt;div&gt;
    &lt;h2&gt;当前计数是：{{ count }}&lt;/h2&gt;
    &lt;!-- 父组件传递数据（count）和方法（increment）给子组件 --&gt;
    &lt;ChildComponent :count="count" @increment="count++" /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'
import ChildComponent from './ChildComponent.vue'

// 数据 state 定义在父组件，它是唯一的拥有者
const count = ref(0)
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 子组件 ChildComponent.vue --&gt;
&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 子组件通过 props 接收只读的数据 --&gt;
    &lt;p&gt;我从父组件接收到的数字是：{{ count }}&lt;/p&gt;
    &lt;!-- 子组件通过触发事件，请求父组件修改数据 --&gt;
    &lt;button @click="$emit('increment')"&gt;点我加1&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
// 子组件定义它接收的 props 和 它触发的事件
defineProps(['count'])
defineEmits(['increment'])
&lt;/script&gt;
</code></pre>
<p>在这个例子里，数据流非常清晰：</p>
<ul>
<li><strong>数据源</strong>：<code>count</code> 在 <code>Parent.vue</code> 中定义和管理。</li>
<li><strong>下行传递</strong>：<code>count</code> 通过 <code>:count="count"</code> 这个 prop 传递给 <code>ChildComponent</code>。</li>
<li><strong>上行通信</strong>：当按钮被点击，子组件触发 <code>increment</code> 事件。父组件监听到这个事件，执行 <code>count++</code> 来更新状态。</li>
</ul>
<p>这就是单向下行数据流的完整闭环。它结构清晰，尤其适合有明确层级关系、数据在顶层组件被多个子组件共享的场景。</p>
<h2 data-id="heading-1">什么时候该“状态提升”？共享才是关键</h2>
<p>明白了单向下行数据流，状态提升就很好理解了。
<strong>“状态提升”其实就是遵循单向下行数据流这条“家规”时，一个自然而然的具体操作</strong>。
当两个或多个兄弟组件（或者关系更远的组件）需要同步同一份数据时，你不能让它们各自为政，否则数据就对不上了。
这时候，你就需要把这份共享的状态，从子组件里“拎出来”，放到它们共同最近的父组件中去管理。</p>
<p>这个“拎出来”的动作，就是<strong>状态提升</strong>。提升之后，父组件通过 props 分发数据，子组件通过事件汇报变更，一切又回到了单向下行数据流的正轨。</p>
<p>来看一个场景：一个简易的温控器，包含一个显示温度的组件和一个调节温度的滑块组件。</p>
<p><strong>错误示范（状态未提升）：</strong>
两个组件各自管理自己的 <code>temperature</code>，它们永远无法同步。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TemperatureDisplay.vue --&gt;
&lt;template&gt;
  &lt;div&gt;当前温度：{{ temperature }}°C&lt;/div&gt;
&lt;/template&gt;
&lt;script setup&gt;
import { ref } from 'vue'
// 状态在子组件内部，与兄弟组件隔离
const temperature = ref(25)
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TemperatureSlider.vue --&gt;
&lt;template&gt;
  &lt;input type="range" min="0" max="50" v-model="temperature" /&gt;
&lt;/template&gt;
&lt;script setup&gt;
import { ref } from 'vue'
// 另一个独立的状态，与 TemperatureDisplay 毫无关系
const temperature = ref(25)
&lt;/script&gt;
</code></pre>
<p><strong>正确做法（状态提升）：</strong>
将共享的 <code>temperature</code> 状态提升到它们的父组件中。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 父组件 Thermostat.vue --&gt;
&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 显示组件接收来自父组件的温度值 --&gt;
    &lt;TemperatureDisplay :temperature="currentTemp" /&gt;
    &lt;!-- 滑块组件接收温度值，并通过事件反馈变化 --&gt;
    &lt;TemperatureSlider :temperature="currentTemp" @update:temperature="currentTemp = $event" /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'
import TemperatureDisplay from './TemperatureDisplay.vue'
import TemperatureSlider from './TemperatureSlider.vue'

// 状态被提升到共同的父组件中管理
const currentTemp = ref(25)
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TemperatureDisplay.vue - 修改后 --&gt;
&lt;template&gt;
  &lt;div&gt;当前温度：{{ temperature }}°C&lt;/div&gt;
&lt;/template&gt;
&lt;script setup&gt;
// 现在只接收 prop，自身不管理状态
defineProps(['temperature'])
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- TemperatureSlider.vue - 修改后 --&gt;
&lt;template&gt;
  &lt;!-- 注意：这里使用 :value 和 @input，而不是 v-model --&gt;
  &lt;input
    type="range"
    min="0"
    max="50"
    :value="temperature"
    @input="$emit('update:temperature', Number($event.target.value))"
  /&gt;
&lt;/template&gt;
&lt;script setup&gt;
defineProps(['temperature'])
// 使用 `update:xxx` 的事件名是 Vue 中实现“双向绑定”的约定俗成做法
defineEmits(['update:temperature'])
&lt;/script&gt;
</code></pre>
<p>看，通过状态提升，<code>TemperatureDisplay</code> 和 <code>TemperatureSlider</code> 完美地共享并同步了同一份温度数据。
这就是状态提升的核心价值：<strong>解决组件间的状态共享问题</strong>。</p>
<h2 data-id="heading-2">实战中的选择：什么时候用谁？</h2>
<p>道理都懂了，但到底怎么选呢？我们来看几个典型场景，帮你建立直觉。</p>
<p><strong>场景一：一个表单输入框和实时预览区域</strong>
你有一个文本输入框和一个实时显示输入内容的预览区。</p>
<ul>
<li><strong>分析</strong>：输入框和预览区的内容必须完全一致，它们是紧密耦合的共享状态。</li>
<li><strong>选择</strong>：毫无疑问，将文本内容状态提升到父组件。输入框通过事件更新它，预览区通过 prop 接收它。这是状态提升的经典用例。</li>
</ul>
<p><strong>场景二：一个复杂的表格组件，内部有排序、筛选、分页功能</strong>
这个表格功能复杂，但外部只是需要一个展示数据的地方。</p>
<ul>
<li><strong>分析</strong>：排序、筛选、分页的逻辑和数据都是表格内部的“家务事”，外部父组件可能只关心最终展示的数据或当前页码。这些状态在表格内部多个子功能间（排序按钮、筛选下拉框、分页器）共享。</li>
<li><strong>选择</strong>：<strong>优先考虑封装在组件内部</strong>。可以使用 Vue 的 <code>reactive</code> 或 <code>ref</code> 在表格组件内部管理这些状态。然后通过 <code>defineExpose</code> 选择性暴露一些方法（比如“重置筛选”）或通过事件（<code>@page-change</code>）向父组件汇报重要变更。这避免了将大量内部细节通过层层 prop 暴露出去，保持了父组件的简洁。</li>
</ul>
<p><strong>场景三：一个购物车图标和多个“加入购物车”按钮</strong>
页面头部有一个显示商品数量的购物车图标，页面各个商品卡片上都有“加入购物车”按钮。</p>
<ul>
<li><strong>分析</strong>：购物车数据（尤其是商品数量）需要在全局共享，且这两个组件可能离得很远（不是直接的父子或兄弟关系）。</li>
<li><strong>选择</strong>：这已经<strong>超出了状态提升的最佳范围</strong>。如果你硬要提升，可能需要提到非常顶层的组件，导致 prop 需要经过很多层无关的组件传递（即“prop 逐级透传”），非常麻烦且难以维护。</li>
<li><strong>更好的选择</strong>：使用 <strong>Vuex 或 Pinia（状态管理库）</strong>。在2025年的今天，Pinia 是 Vue 生态的官方首选。它将购物车状态提取到一个全局的、独立的“仓库”（store）中，购物车图标和各个按钮组件都直接从这个仓库中读取和修改数据，彻底摆脱了组件层级的限制。</li>
</ul>
<p><strong>简单总结一下：</strong></p>
<ul>
<li><strong>父与子，或亲兄弟之间需要共享状态</strong> -&gt; 用<strong>状态提升</strong>（单向下行数据流的具体实践）。</li>
<li><strong>组件内部自己用的状态，或复杂组件的内部逻辑</strong> -&gt; 放在<strong>组件内部</strong>管理，保持封装性。</li>
<li><strong>远房亲戚组件，或多个毫不相干的组件需要共享状态</strong> -&gt; 上 <strong>Pinia</strong>（全局状态管理）。</li>
</ul>
<h2 data-id="heading-3">避开陷阱：常见的坑与最佳姿势</h2>
<p>知道了怎么做，还得知道怎么不踩坑。这里有几个关键点：</p>
<p><strong>1. 避免“Prop 逐级透传”</strong>
千万别为了让顶层数据传到深层子组件，而让中间那些不关心该数据的组件也去接收和传递 prop。这会让代码变得非常脆弱和难以理解。</p>
<p><strong>反面例子：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- GrandParent.vue --&gt;
&lt;ChildA :some-data="data" /&gt;

&lt;!-- ChildA.vue （它自己根本不用这个数据）--&gt;
&lt;ChildB :some-data="someData" /&gt;

&lt;!-- ChildB.vue （它自己根本不用这个数据）--&gt;
&lt;GrandChild :some-data="someData" /&gt;
</code></pre>
<p><strong>解决方案：</strong></p>
<ul>
<li><strong>方案一：使用 <code>provide/inject</code></strong>。这是 Vue 为解决这个问题提供的“官方后门”。顶层组件 <code>provide</code> 数据，任何深层子组件都可以直接 <code>inject</code> 进来，跳过中间所有环节。
<pre><code class="hljs language-vue" lang="vue">&lt;!-- GrandParent.vue --&gt;
&lt;script setup&gt;
import { provide, ref } from 'vue'
const user = ref({ name: '小明' })
provide('user', user) // 提供数据
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- GrandChild.vue --&gt;
&lt;script setup&gt;
import { inject } from 'vue'
const user = inject('user') // 注入数据，无论多深
&lt;/script&gt;
</code></pre>
</li>
<li><strong>方案二：使用 Pinia</strong>。对于真正的全局状态，这依然是最终的解决方案。</li>
</ul>
<p><strong>2. 不要滥用状态提升</strong>
如果状态只被一个组件使用，或者组件内部逻辑复杂需要保持高内聚，那就别急着提升。过度提升会让父组件变得臃肿，承担了太多不属于它的责任，也破坏了子组件的封装性和复用性。</p>
<p><strong>3. 拥抱现代化工具：组合式函数</strong>
在2025年，组合式 API 和组合式函数是构建 Vue 应用的基石。当一段逻辑（包括状态和相关操作）需要在多个组件中使用时，你完全不必先纠结状态提升。<strong>直接把这段逻辑提取成一个组合式函数</strong>。</p>
<p>例如，封装一个 <code>useCounter</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useCounter.js</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialValue = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(initialValue)
  <span class="hljs-keyword">const</span> double = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    count.<span class="hljs-property">value</span>++
  }
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) {
    count.<span class="hljs-property">value</span> = initialValue
  }

  <span class="hljs-comment">// 返回所有需要的东西</span>
  <span class="hljs-keyword">return</span> { count, double, increment, reset }
}
</code></pre>
<p>然后在任何组件中轻松复用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 任何组件.vue --&gt;
&lt;script setup&gt;
import { useCounter } from './useCounter'
const { count, double, increment } = useCounter(10)
&lt;/script&gt;
</code></pre>
<p>组合式函数将<strong>逻辑</strong>而非<strong>模板</strong>进行了复用和提升，这是一种更灵活、更强大的模式，在很多情况下比单纯的状态提升更优雅。</p>
<h2 data-id="heading-4">总结：找到属于你的数据平衡点</h2>
<p>回到我们最初的问题：“数据到底放哪？”
现在你应该有了更清晰的答案：</p>
<ul>
<li><strong>单向下行数据流</strong>是 Vue 组件通信的黄金法则和底层思想，它保证了应用的稳定和可预测。</li>
<li><strong>状态提升</strong>是在这条法则下，为了解决<strong>局部共享状态</strong>问题而采取的具体技术手段。</li>
<li><strong>Pinia 等状态管理库</strong>是解决<strong>全局共享状态</strong>的终极武器。</li>
<li><strong>组合式函数</strong>是复用和封装逻辑的现代化最佳实践。</li>
</ul>
<p>没有一种模式是放之四海而皆准的。最好的设计，来自于对你应用结构的深入理解。
下次再纠结时，不妨问自己几个问题：</p>
<ol>
<li>这个状态会被几个组件使用？它们是什么关系？（父子？兄弟？毫无关系？）</li>
<li>这个状态是组件的内部细节，还是需要对外暴露的合约？</li>
<li>如果提升状态，会不会让父组件变得难以维护？</li>
</ol>
<p>想清楚这些，你自然就能在“组件内部状态”、“状态提升”和“全局状态管理”之间，找到那个最舒服、最可持续的平衡点。从此，告别选择恐惧，让你的 Vue 应用数据流清晰又顺畅。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[硅谷巨头被一家百人小厂“偷家”了：详解 Runway Gen-4.5]]></title>    <link>https://juejin.cn/post/7579096485355880498</link>    <guid>https://juejin.cn/post/7579096485355880498</guid>    <pubDate>2025-12-02T13:40:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579096485355880498" data-draft-id="7579096485355864114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="硅谷巨头被一家百人小厂“偷家”了：详解 Runway Gen-4.5"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-02T13:40:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            硅谷巨头被一家百人小厂“偷家”了：详解 Runway Gen-4.5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T13:40:55.000Z" title="Tue Dec 02 2025 13:40:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就在大家都盯着谷歌和 OpenAI 神仙打架的时候，视频生成赛道的老玩家 Runway 居然悄无声息地扔出了一颗深水炸弹。</p>
<p>2025 年 12 月 1 日，Runway 正式发布了新一代模型 Gen-4.5。如果你关注过他们内部的动向，可能听说过这个代号——“David”（大卫）。这可不是随便起的名，它是《圣经》里“大卫战胜巨人歌利亚”的那个大卫。</p>
<p>Runway 的意思很直白：虽然我们就一百来号人，比起谷歌和 OpenAI 这种科技巨头算是绝对的“弱势群体”，但这回，我们要赢。</p>
<p>事实证明，他们好像真的做到了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fasdasd-1005x1024.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/asdasd-1005x1024.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd63d84b594b47459c200b86aaafd3e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287654&amp;x-signature=BVjTRhvjvWLKRABpIXqmN3XNGtQ%3D" alt="asdasd" loading="lazy"/></a></p>
<h3 data-id="heading-0">凭什么敢叫板巨头？</h3>
<p>在 AI 视频圈混久了，大家都有个共识：现在的模型像是在做梦。画面虽然精美，但逻辑经常离家出走。比如水流不仅往低处流，偶尔还会往天上飘；人走路像是在滑冰，没有重量感。</p>
<p>Gen-4.5 最让人意外的地方，恰恰在于它对“物理世界”的理解。</p>
<p>Runway 这次没有单纯堆砌分辨率参数，而是死磕了物理准确性。在 Gen-4.5 生成的视频里，重物落地会有沉甸甸的顿挫感，液体的流动不再是诡异的变形，而是符合流体动力学的。它甚至能搞定极其复杂的提示词，在一个长镜头里同时调度好几个角色的站位和动作，而且风格还能在照片级写实和皮克斯动画之间随意切换。</p>
<p>简单说，它不再只是把像素堆在一起，它开始懂得“力”和“运动”了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fawdwad.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/awdwad.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7d8149b4ccc4468b359438bfc01a914~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287654&amp;x-signature=d1PVpShDpLNoWTtGZFRdv3dXhNk%3D" alt="awdwad" loading="lazy"/></a></p>
<h3 data-id="heading-1">拿数据说话：榜单第一的含金量</h3>
<p>吹牛谁都会，但数据不会撒谎。</p>
<p>在第三方独立基准测试机构 Artificial Analysis 搞的“Video Arena”竞技场里，Gen-4.5 拿到了 1247 的 Elo 评分。</p>
<p>这个分数意味着什么？意味着它把谷歌引以为傲的 Veo 3（1226分）和 OpenAI 的 Sora 2 Pro 都甩在了身后。要知道，这是一个“盲测”榜单，评测者在不知道模型名字的情况下，纯凭肉眼判断视频质量。在这种硬碰硬的较量中拿到第一，说明 Gen-4.5 的视觉观感确实更加讨好人类眼球。</p>
<p>而且，Runway 很聪明地找准了自己的定位。相比于谷歌 Veo 试图去抢影视行业的饭碗，Gen-4.5 更专注于社交媒体。它不仅生成速度快，而且特别适合 Instagram Reels 或 TikTok 这种短视频流。</p>
<h3 data-id="heading-2">并不完美，但足够诚实</h3>
<p>作为一名长期观察者，我觉得 Runway 这次最圈粉的不是技术，而是态度。</p>
<p>通常厂商发布新模型，都会把演示视频剪辑得天衣无缝。但 Runway 在发布说明里，大大方方地承认了“David”的缺陷。</p>
<p>官方坦言，模型在“因果推理”上还有脑回路短路的时候。比如你让它生成“一个人转动门把手开门”，视频里可能会出现门在手碰到把手之前就自己开了的情况。此外，物体被遮挡后偶尔会凭空消失的问题也依然存在。</p>
<p>这种坦诚反而让人觉得靠谱。目前的 AI 视频技术，离真正的“物理模拟器”还有距离，Gen-4.5 只是在这个方向上迈出了一大步，但还没走到终点。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fdasfsdfghg-1024x676.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/dasfsdfghg-1024x676.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb275a81174948388ffc8f46861e32df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765287654&amp;x-signature=KwFqjXs0qdzFhY0q3bZ0Q6p24mc%3D" alt="dasfsdfghg" loading="lazy"/></a></p>
<h3 data-id="heading-3">写在最后</h3>
<p>Runway Gen-4.5 的出现，给略显沉闷的巨头垄断局面撕开了一个口子。它证明了在 AI 领域，单纯的算力堆叠并不是唯一的出路，对细分场景的极致打磨同样能造就爆款。</p>
<p>目前这个模型正在逐步向订阅用户开放，预计这周末大家都能玩上手了，而且加量不加价。</p>
<p>对于内容创作者来说，工具越来越强固然是好事，但随之而来的“真假难辨”也是个大麻烦。当视频里的水流、光影和动作都逼真到无可挑剔时，我们以后刷到的视频，还有多少是真实的？这恐怕是“大卫”战胜巨人之后，留给我们所有人的新问题。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#/.NET/.NET Core技术前沿周刊 | 第 63 期（2025年11.24-11.30）]]></title>    <link>https://juejin.cn/post/7579256547788849193</link>    <guid>https://juejin.cn/post/7579256547788849193</guid>    <pubDate>2025-12-02T14:14:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579256547788849193" data-draft-id="7579063781072683062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#/.NET/.NET Core技术前沿周刊 | 第 63 期（2025年11.24-11.30）"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-12-02T14:14:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#/.NET/.NET Core技术前沿周刊 | 第 63 期（2025年11.24-11.30）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:14:39.000Z" title="Tue Dec 02 2025 14:14:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2ab61be890749eda4ac6e5742130e48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289678&amp;x-signature=uIprtkstmOeCPBOEYCEx1NNvRGQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>C#/.NET/.NET Core技术前沿周刊，你的每周技术指南针！记录、追踪C#/.NET/.NET Core领域、生态的每周最新、最实用、最有价值的技术文章、社区动态、优质项目和学习资源等。让你时刻站在技术前沿，助力技术成长与视野拓宽。</p>
<blockquote>
<p>欢迎投稿、推荐或自荐优质文章、项目、学习资源等。</p>
</blockquote>
<ul>
<li><strong>🏆技术前沿周刊Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetWeekly.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetWeekly.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
<li><strong>📰技术前沿周刊GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetWeekly.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetWeekly.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li><strong>👪DotNetGuide技术社区：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Frq-_dMpdLltPxvOdihl0UA" target="_blank" title="https://mp.weixin.qq.com/s/rq-_dMpdLltPxvOdihl0UA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/rq-_dMpdL…</a></li>
</ul>
<h2 data-id="heading-1">C# 中 ?、??、??=、?: 、?. 、?[] 各种问号的用法和说明</h2>
<ul>
<li><strong>文章简介：</strong> 在 C# 中，问号（?）远不止是一个简单的标点符号。随着语言版本的迭代更新，C# 围绕问号（?）发展出了一套强大而优雅的空值处理和条件表达机制。熟练掌握这些操作运算符不仅能大幅提升代码的简洁性和可读性，还能有效避免恼人的空引用异常，构建更加健壮的应用程序。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyyMf1__eCeWpX7Co2yXwyw" target="_blank" title="https://mp.weixin.qq.com/s/yyMf1__eCeWpX7Co2yXwyw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/yyMf1__eC…</a></li>
</ul>
<h2 data-id="heading-2">精选 8 个基于 .NET 开源、功能强大的 AI 和 LLM 相关项目框架</h2>
<ul>
<li><strong>文章简介：</strong> 如今，AI 应用正以前所未有的速度蓬勃发展，在各行各业展现出巨大的潜力与深远的影响力。今天，大姚为大家精心整理了 8 个基于 .NET 开源、功能强大的 AI 与大语言模型（LLM）相关项目框架，希望能为你的开发和探索提供有价值的参考。如果你有更优秀的项目推荐，欢迎通过提交 PR 或在文末留言分享！</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqxjUYO2U-TCTd0JmEtbehA" target="_blank" title="https://mp.weixin.qq.com/s/qxjUYO2U-TCTd0JmEtbehA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/qxjUYO2U-…</a></li>
</ul>
<h2 data-id="heading-3">Visual Studio 2026 现已正式发布，更快、更智能！</h2>
<ul>
<li><strong>文章简介：</strong> 前不久 Visual Studio 官方博客宣布 Visual Studio 2026 正式发布！本次版本凝聚了广大开发者的宝贵反馈，博客中提及在此版本发布之前的一年里，Visual Studio 团队修复了 5000 多个用户报告的缺陷，并实现了 300 个功能请求。新版本带来显著性能提升、全新用户体验和更强的 AI 开发能力，让编码更流畅、高效，助您更快将创意变为现实。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F8TjLcw4RExpCohGJYgmBOA" target="_blank" title="https://mp.weixin.qq.com/s/8TjLcw4RExpCohGJYgmBOA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/8TjLcw4RE…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/863de70faacb47dfa755bbcb9076b3db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289678&amp;x-signature=bRYf7ez26fe8Uh8BTPQvJkClbJQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">一款开源、多语言的 WPF 可筛选 DataGrid 控件</h2>
<ul>
<li><strong>文章简介：</strong> 在现代化软件应用开发中，数据展示与交互的效率直接影响用户体验与开发效能。WPF 其内置的 DataGrid 在多语言支持与复杂数据筛选方面仍存在局限性。今天大姚给大家分享一款开源、多语言的 WPF 可筛选 DataGrid 控件：DataGridFilter。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzrU7sivEvJrU090TF6TN3w" target="_blank" title="https://mp.weixin.qq.com/s/zrU7sivEvJrU090TF6TN3w" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zrU7sivEv…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feddd1d7da504c329bcb33c4d48e9537~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289678&amp;x-signature=qQq49H8DtuscmZ8WuI4jgw6KarE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">一款开源实用的 .NET Core 加密解密工具类库</h2>
<ul>
<li><strong>文章简介：</strong> NETCore.Encrypt 是一个功能丰富、易于使用的 .NET Core 加密解密工具类库，提供了多种对称加密、非对称加密、哈希计算和 Base64 编码解码功能。它采用 MIT License 许可证开源免费，支持跨平台使用，并提供了高度可定制的 API 接口。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FbpNl9CP0WQBBoniKe_WL2Q" target="_blank" title="https://mp.weixin.qq.com/s/bpNl9CP0WQBBoniKe_WL2Q" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/bpNl9CP0W…</a></li>
</ul>
<h2 data-id="heading-6">从零开始:如何用 C# 开发一款媲美 “AnyTxt” 的文件内容搜索工具</h2>
<ul>
<li><strong>文章简介：</strong> 说起文件内容搜索工具，那么不得不提到“AnyTxt”，号称本地知识库检索的终极答案。唯一的不足可能就是索引更新机制，不能实时监视文件更改从而更新索引，最小定期更新间隔为半小时，容易导致cpu占用率高，毕竟是全盘全文件类型索引。很多时候,其实我们对文件内容的搜索，是一个简单文档管理需求，我们期望能的是快速定位文件，而不仅仅是信息。这时候对文件夹以及文件类型的限制就很重要了。还有就是有可能我们会对比如CAD图纸(.dwg、.dxf)的图签或者文件数据库(.db)的表名等特殊文件格式的自定义信息感兴趣。这时候就需要自己来实现扩展了。再加上很多时候，磁盘的信息都是敏感数据，一定要保证软件程序的安全。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FiH7VdEi_UYXz1C4YbqOV1A" target="_blank" title="https://mp.weixin.qq.com/s/iH7VdEi_UYXz1C4YbqOV1A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/iH7VdEi_U…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a489e06c357465ca30b6e0be06f53e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289678&amp;x-signature=jsUtEvWI6ynDqE7YfMxaK8tGK3Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">一个基于 .NetCore + Quartz.Net + Vue 开箱即用的定时任务</h2>
<ul>
<li><strong>文章简介：</strong> Quartz.NetUI 是一个基于 .NET Core 和 Quartz.NET 的定时任务管理系统，结合 Vue 前端技术，提供了直观、易用的界面来管理定时任务。几乎没有上手难度，不依赖数据库，只需在界面做简单配置。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPdC0ms-9je5oC28RNSgnrw" target="_blank" title="https://mp.weixin.qq.com/s/PdC0ms-9je5oC28RNSgnrw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/PdC0ms-9j…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c175014fa9e041fd8027b64fdf34d3dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289678&amp;x-signature=wBqU83ywLRSpObItZ9qRLWZD%2FMA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">一个功能强大、最接地气的 .NET 微服务框架</h2>
<ul>
<li><strong>文章简介：</strong> Wing 是一个功能强大且接地气的 .NET 微服务框架，致力于为开发者提供一套完整、高效、易用的微服务架构解决方案。该框架支持 .NET6+ 运行平台，集成了服务注册与发现、服务间通讯、负载均衡、分布式事务、配置中心、链路追踪、服务网关以及事件总线等核心功能，旨在帮助开发者快速构建和部署高可用的微服务系统。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F72njjMwQ4uzYiThzR6HZew" target="_blank" title="https://mp.weixin.qq.com/s/72njjMwQ4uzYiThzR6HZew" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/72njjMwQ4…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68f304382fce46bba964282d4c078fb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289678&amp;x-signature=YR2pn39o8Ywnif84DJv6EdR90MU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">微软宣布 Visual Studio 重大变更</h2>
<ul>
<li><strong>文章简介：</strong> Visual Studio 2026 已于本月正式推出，微软近日宣布将调整 Visual Studio 的发布周期。自 Visual Studio 2017 以来，微软已逐步加快更新节奏，而此次调整将进一步推动 IDE 的现代化，持续提供最新特性，同时保持企业级稳定性。根据新的支持模式，Visual Studio 后续将采用与.NET 类似的支持策略：每月提供功能更新，每年 11 月发布新的年度大版本更新，并提供一年功能更新支持与一年安全支持。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FHdGbheLgXV1uXsShHVp8aA" target="_blank" title="https://mp.weixin.qq.com/s/HdGbheLgXV1uXsShHVp8aA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/HdGbheLgX…</a></li>
</ul>
<h2 data-id="heading-10">2025 年 11 月编程语言排行榜｜C# 暴涨，有望成为 2025 “年度编程语言”！</h2>
<ul>
<li><strong>文章简介：</strong> C# 涨幅达2.67%，与Java的差距缩小至不足1%，未来存在超越Java的可能性，但尚未实现历史性超越。2025年11月，C# 以2.67%的涨幅成为榜单中增长最快的语言，排名升至第五。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F2AyGyRF0Hg0eyWs0G2V2vw" target="_blank" title="https://mp.weixin.qq.com/s/2AyGyRF0Hg0eyWs0G2V2vw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/2AyGyRF0H…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6052f48311764f99af658d8215f3b06c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289678&amp;x-signature=ZAZ5kYORsp61H4EWaN11r2%2BoYls%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">.NET+AI | MEAI | 自定义中间件（8）</h2>
<ul>
<li><strong>文章简介：</strong> 通过 Microsoft.Extensions.AI 的 DelegatingChatClient 基类,轻松创建自定义中间件,实现限流、重试、安全过滤等企业级功能,让 AI 应用更安全、更稳定。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fsheng-jie%2Fp%2F19258476" target="_blank" title="https://www.cnblogs.com/sheng-jie/p/19258476" ref="nofollow noopener noreferrer">www.cnblogs.com/sheng-jie/p…</a></li>
</ul>
<h2 data-id="heading-12">边界突围：中国.NET技术的七年认知演进与社区化生态重构</h2>
<ul>
<li><strong>文章简介：</strong> 系统性问题的本质在于边界的动态性。当我们面对教育、技术或社会问题时，最初设定的边界往往是为了简化分析而人为划定的。这种边界划分在初期能够帮助我们找到局部最优解，但随着认知的深入，我们会发现这些解决方案存在局限性。边界扩展的必然性体现在：当局部最优解无法真正解决问题时，我们需要重新审视问题域，扩大边界范围并重新切分概念。这一过程揭示了原有解决方案的局限性，推动我们向全局最优解迈进。无论是教育这样的复杂社会问题，还是技术领域的软件设计，都能观察到这种系统性边界的演进规律。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fshanyou%2Fp%2F19288286" target="_blank" title="https://www.cnblogs.com/shanyou/p/19288286" ref="nofollow noopener noreferrer">www.cnblogs.com/shanyou/p/1…</a></li>
</ul>
<h2 data-id="heading-13">基于.net6的一款开源的低代码、权限、工作流、动态接口平台-动态接口篇</h2>
<ul>
<li><strong>文章简介：</strong> 动态接口允许用户在运行时创建和修改API端点，而无需重新部署应用程序。这对于需要频繁更改API结构的应用程序特别有用。 通过动态接口，开发人员可以根据业务需求快速调整API，提升开发效率和响应速度。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fdengjiahai%2Fp%2F19282536" target="_blank" title="https://www.cnblogs.com/dengjiahai/p/19282536" ref="nofollow noopener noreferrer">www.cnblogs.com/dengjiahai/…</a></li>
</ul>
<h2 data-id="heading-14">.NET 8+ 飞书API实战：自动化群组管理与消息推送</h2>
<ul>
<li><strong>文章简介：</strong> 企业项目中经常需要批量操作飞书群组：项目启动时自动建群拉人、系统告警自动推送、员工入职离职自动处理群权限等。手动操作效率低且容易出错。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fmudtools%2Fp%2F19275871" target="_blank" title="https://www.cnblogs.com/mudtools/p/19275871" ref="nofollow noopener noreferrer">www.cnblogs.com/mudtools/p/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（161）如何使用Redis实现分布式锁？]]></title>    <link>https://juejin.cn/post/7579096485356453938</link>    <guid>https://juejin.cn/post/7579096485356453938</guid>    <pubDate>2025-12-02T23:03:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579096485356453938" data-draft-id="7579127397497487411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（161）如何使用Redis实现分布式锁？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T23:03:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（161）如何使用Redis实现分布式锁？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T23:03:32.000Z" title="Tue Dec 02 2025 23:03:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>分布式锁是用来在分布式系统下控制对资源的独占访问，确保多个进程或线程不会同时操作同一资源。Redis 是实现分布式锁的常用工具之一。下面是详细的实现步骤和代码示例：</p>
<h3 data-id="heading-0">1. Redis 分布式锁的基本实现</h3>
<p>通过设置一个唯一的键来实现锁，当操作完成后删除该键即可释放锁。</p>
<h4 data-id="heading-1">1.1 获取锁</h4>
<p>使用 <code>SET</code> 命令并设置过期时间。<code>NX</code> 参数表示只有在键不存在时才能设置成功，<code>EX</code> 参数用于设置键的过期时间。</p>
<pre><code class="hljs language-bash" lang="bash">SET lock_key unique_value NX EX 10
</code></pre>
<h4 data-id="heading-2">1.2 释放锁</h4>
<p>只有持有锁的客户端才能删除锁。为了确保这一点，需要在释放锁时进行唯一值验证。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Lua脚本原子性地检查唯一值并删除锁</span>
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">"GET"</span>, KEYS[1]) == ARGV[1] <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">return</span> redis.call(<span class="hljs-string">"DEL"</span>, KEYS[1])
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">return</span> 0
end
</code></pre>
<h3 data-id="heading-3">2. Java 实现 Redis 分布式锁</h3>
<h4 data-id="heading-4">2.1 引入依赖</h4>
<p>在 Maven 项目中引入 Jedis 依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">2.2 获取锁的方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.params.SetParams;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisDistributedLock</span> {
    <span class="hljs-keyword">private</span> Jedis jedis;
    <span class="hljs-keyword">private</span> String lockKey;
    <span class="hljs-keyword">private</span> String lockValue;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> expireTime;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisDistributedLock</span><span class="hljs-params">(Jedis jedis, String lockKey, String lockValue, <span class="hljs-type">int</span> expireTime)</span> {
        <span class="hljs-built_in">this</span>.jedis = jedis;
        <span class="hljs-built_in">this</span>.lockKey = lockKey;
        <span class="hljs-built_in">this</span>.lockValue = lockValue;
        <span class="hljs-built_in">this</span>.expireTime = expireTime;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquireLock</span><span class="hljs-params">()</span> {
        <span class="hljs-type">SetParams</span> <span class="hljs-variable">setParams</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetParams</span>();
        setParams.nx().ex(expireTime);
        <span class="hljs-comment">// 尝试获取锁</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.set(lockKey, lockValue, setParams);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>.equals(result);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">releaseLock</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 释放锁的 Lua 脚本</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span>
            <span class="hljs-string">"if redis.call('GET', KEYS[1]) == ARGV[1] then "</span> +
            <span class="hljs-string">"return redis.call('DEL', KEYS[1]) "</span> +
            <span class="hljs-string">"else "</span> +
            <span class="hljs-string">"return 0 "</span> +
            <span class="hljs-string">"end"</span>;
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.eval(luaScript, <span class="hljs-number">1</span>, lockKey, lockValue);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"1"</span>.equals(result.toString());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 连接到本地 Redis 服务</span>
        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>);

        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"distributed_lock"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">lockValue</span> <span class="hljs-operator">=</span> <span class="hljs-string">"unique_value"</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>; <span class="hljs-comment">// 锁的过期时间，单位为秒</span>

        <span class="hljs-type">RedisDistributedLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisDistributedLock</span>(jedis, lockKey, lockValue, expireTime);

        <span class="hljs-comment">// 获取锁</span>
        <span class="hljs-keyword">if</span> (lock.acquireLock()) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行你的逻辑</span>
                System.out.println(<span class="hljs-string">"Lock acquired!"</span>);

                <span class="hljs-comment">// 模拟业务处理时间</span>
                Thread.sleep(<span class="hljs-number">5000</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 释放锁</span>
                <span class="hljs-keyword">if</span> (lock.releaseLock()) {
                    System.out.println(<span class="hljs-string">"Lock released!"</span>);
                } <span class="hljs-keyword">else</span> {
                    System.out.println(<span class="hljs-string">"Failed to release lock!"</span>);
                }
            }
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"Failed to acquire lock!"</span>);
        }

        jedis.close();
    }
}
</code></pre>
<h3 data-id="heading-6">3. Redisson 提供的分布式锁</h3>
<p>Redisson 是一个开源的 Redis 客户端，提供了更高级的分布式锁实现，与 Java 的<code>java.util.concurrent.locks.Lock</code>接口兼容。</p>
<h4 data-id="heading-7">3.1 引入依赖</h4>
<p>在 Maven 项目中引入 Redisson 依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.16.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">3.2 使用 Redisson 实现分布式锁</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.Redisson;
<span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.redisson.config.Config;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonDistributedLock</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建 Redisson 配置</span>
        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();
        config.useSingleServer().setAddress(<span class="hljs-string">"redis://127.0.0.1:6379"</span>);

        <span class="hljs-comment">// 创建 Redisson 客户端</span>
        <span class="hljs-type">RedissonClient</span> <span class="hljs-variable">redissonClient</span> <span class="hljs-operator">=</span> Redisson.create(config);

        <span class="hljs-comment">// 获取锁对象</span>
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">"distributed_lock"</span>);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试获取锁，等待时间10秒，持有锁30秒</span>
            <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">10</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS)) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 执行你的逻辑</span>
                    System.out.println(<span class="hljs-string">"Lock acquired!"</span>);

                    <span class="hljs-comment">// 模拟业务处理时间</span>
                    Thread.sleep(<span class="hljs-number">5000</span>);
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 释放锁</span>
                    lock.unlock();
                    System.out.println(<span class="hljs-string">"Lock released!"</span>);
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"Failed to acquire lock!"</span>);
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            redissonClient.shutdown();
        }
    }
}
</code></pre>
<h3 data-id="heading-9">总结</h3>
<p>通过配置 Redis 和编写合适的代码，可以实现可靠的分布式锁。上述示例展示了如何使用 Jedis 和 Redisson 来实现分布式锁。使用 Jedis 提供了更灵活的低级实现，而 Redisson 提供了更高级别的 API，使得分布式锁的使用更加简单和直观。选择合适的工具和方法取决于具体的应用场景和需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（160）Redis的安全问题如何解决？]]></title>    <link>https://juejin.cn/post/7579094978682093614</link>    <guid>https://juejin.cn/post/7579094978682093614</guid>    <pubDate>2025-12-02T22:59:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579094978682093614" data-draft-id="7579096485356421170" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（160）Redis的安全问题如何解决？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T22:59:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（160）Redis的安全问题如何解决？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T22:59:46.000Z" title="Tue Dec 02 2025 22:59:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>确保Redis的安全性是非常重要的，特别是在生产环境中。以下是解决Redis安全问题的详细步骤，包括配置文件设置和代码示例。</p>
<h3 data-id="heading-0">1. 配置Redis的安全选项</h3>
<h4 data-id="heading-1">1.1 绑定特定IP</h4>
<p>默认情况下，Redis绑定到所有网络接口，这可能会暴露在外部网络。通过配置文件指定Redis只绑定到特定的IP地址。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf 配置示例</span>

<span class="hljs-comment"># 仅绑定到本地IP地址</span>
<span class="hljs-built_in">bind</span> 127.0.0.1
</code></pre>
<h4 data-id="heading-2">1.2 设置密码认证</h4>
<p>配置Redis密码认证，防止未授权访问。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf 配置示例</span>

<span class="hljs-comment"># 设置访问密码</span>
requirepass yourpassword
</code></pre>
<h4 data-id="heading-3">1.3 禁用危险命令</h4>
<p>禁用可能被滥用的命令，例如<code>FLUSHALL</code>、<code>FLUSHDB</code>等。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf 配置示例</span>

<span class="hljs-comment"># 禁用FLUSHALL命令</span>
rename-command FLUSHALL <span class="hljs-string">""</span>
<span class="hljs-comment"># 禁用FLUSHDB命令</span>
rename-command FLUSHDB <span class="hljs-string">""</span>
</code></pre>
<h3 data-id="heading-4">2. 使用防火墙和网络安全策略</h3>
<h4 data-id="heading-5">2.1 配置防火墙</h4>
<p>使用防火墙限制对Redis服务器的访问，只允许特定IP地址访问。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 允许本地访问</span>
sudo ufw allow from 127.0.0.1 to any port 6379

<span class="hljs-comment"># 允许特定IP地址访问</span>
sudo ufw allow from 192.168.1.100 to any port 6379
</code></pre>
<h4 data-id="heading-6">2.2 使用VPN或内部网络</h4>
<p>将Redis服务器放置在VPN或内部网络中，防止外部直接访问。</p>
<h3 data-id="heading-7">3. 配置TLS/SSL加密</h3>
<p>Redis 6.0引入了对TLS/SSL的支持，确保数据在传输过程中被加密。</p>
<h4 data-id="heading-8">3.1 生成自签名证书</h4>
<p>使用OpenSSL生成自签名证书：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成CA证书</span>
openssl genrsa -out ca.key 2048
openssl req -new -x509 -key ca.key -out ca.crt

<span class="hljs-comment"># 生成服务器证书</span>
openssl genrsa -out redis.key 2048
openssl req -new -key redis.key -out redis.csr
openssl x509 -req -<span class="hljs-keyword">in</span> redis.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out redis.crt
</code></pre>
<h4 data-id="heading-9">3.2 配置Redis使用TLS</h4>
<p>在<code>redis.conf</code>中添加TLS配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf 配置示例</span>

tls-port 6380
port 0  <span class="hljs-comment"># 禁用非TLS端口</span>

<span class="hljs-comment"># 配置证书和密钥</span>
tls-cert-file /path/to/redis.crt
tls-key-file /path/to/redis.key
tls-ca-cert-file /path/to/ca.crt

tls-auth-clients <span class="hljs-built_in">yes</span>
</code></pre>
<h3 data-id="heading-10">4. 客户端配置</h3>
<h4 data-id="heading-11">4.1 使用Jedis客户端连接带密码的Redis服务器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisAuthExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>);
        jedis.auth(<span class="hljs-string">"yourpassword"</span>);

        <span class="hljs-comment">// 执行Redis操作</span>
        jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"key"</span>);
        System.out.println(<span class="hljs-string">"Value for 'key': "</span> + value);

        <span class="hljs-comment">// 关闭连接</span>
        jedis.close();
    }
}
</code></pre>
<h4 data-id="heading-12">4.2 使用Jedis客户端连接启用TLS的Redis服务器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.JedisShardInfo;

<span class="hljs-keyword">import</span> javax.net.ssl.SSLParameters;
<span class="hljs-keyword">import</span> javax.net.ssl.SSLSocketFactory;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTLSExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">JedisShardInfo</span> <span class="hljs-variable">shardInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisShardInfo</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6380</span>, <span class="hljs-literal">true</span>);
        shardInfo.setPassword(<span class="hljs-string">"yourpassword"</span>);
        
        <span class="hljs-comment">// 配置SSL</span>
        <span class="hljs-type">SSLSocketFactory</span> <span class="hljs-variable">sslSocketFactory</span> <span class="hljs-operator">=</span> (SSLSocketFactory) SSLSocketFactory.getDefault();
        <span class="hljs-type">SSLParameters</span> <span class="hljs-variable">sslParameters</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SSLParameters</span>();
        shardInfo.setSslSocketFactory(sslSocketFactory);
        shardInfo.setSslParameters(sslParameters);
        
        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(shardInfo);

        <span class="hljs-comment">// 执行Redis操作</span>
        jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"key"</span>);
        System.out.println(<span class="hljs-string">"Value for 'key': "</span> + value);

        <span class="hljs-comment">// 关闭连接</span>
        jedis.close();
    }
}
</code></pre>
<h3 data-id="heading-13">5. 监控和日志记录</h3>
<h4 data-id="heading-14">5.1 启用详细日志</h4>
<p>在<code>redis.conf</code>中配置详细日志记录，以便在发生安全事件时进行审计。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf 配置示例</span>

<span class="hljs-comment"># 日志级别</span>
loglevel notice
<span class="hljs-comment"># 日志文件</span>
logfile <span class="hljs-string">"/var/log/redis/redis.log"</span>
</code></pre>
<h4 data-id="heading-15">5.2 使用监控工具</h4>
<p>使用监控工具（如Prometheus和Grafana）监控Redis服务器的性能和安全事件。</p>
<ol>
<li><strong>部署Redis Exporter</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name redis_exporter -p 9121:9121 oliver006/redis_exporter
</code></pre>
<ol start="2">
<li><strong>配置Prometheus监控Redis Exporter</strong>：</li>
</ol>
<p>在Prometheus配置文件<code>prometheus.yml</code>中添加Redis Exporter的job：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'redis_exporter'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'localhost:9121'</span>]
</code></pre>
<ol start="3">
<li><strong>在Grafana中添加Prometheus数据源并创建监控面板</strong>。</li>
</ol>
<h3 data-id="heading-16">总结</h3>
<p>通过配置Redis安全选项（如IP绑定、密码认证、禁用危险命令）、使用防火墙和网络安全策略、配置TLS/SSL加密、使用安全客户端配置，以及监控和日志记录，可以有效解决Redis的安全问题。上述代码示例展示了如何通过Java代码结合Jedis库来实现这些安全措施，确保Redis服务器的安全性和可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LLM 扫盲：什么是 Tokens？]]></title>    <link>https://juejin.cn/post/7579088065697497128</link>    <guid>https://juejin.cn/post/7579088065697497128</guid>    <pubDate>2025-12-02T17:38:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579088065697497128" data-draft-id="7579088065697480744" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LLM 扫盲：什么是 Tokens？"/> <meta itemprop="keywords" content="LLM,ChatGPT,AIGC"/> <meta itemprop="datePublished" content="2025-12-02T17:38:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mCell"/> <meta itemprop="url" content="https://juejin.cn/user/2280829967146779"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LLM 扫盲：什么是 Tokens？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2280829967146779/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mCell
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T17:38:27.000Z" title="Tue Dec 02 2025 17:38:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>同步至个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstack.mcell.top%2Fblog%2F2025%2F30_llm_tokens" target="_blank" title="https://stack.mcell.top/blog/2025/30_llm_tokens" ref="nofollow noopener noreferrer">LLM扫盲: 什么是tokens</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d84df7690f3d4c3ba342d4ef8b682be6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765301989&amp;x-signature=Y6iys6ZpFPo9P23bRYQnMh%2FQUbc%3D" alt="072" loading="lazy"/></p>
<h2 data-id="heading-0">LLM 基础：什么是 Tokens？</h2>
<p>GPT 5.1 发布已经有一段时间了，LLM（大语言模型）的能力边界再一次被拓宽。对于应用开发者而言，虽然模型越来越智能，但 API 的计费逻辑和底层限制依然没有变：<strong>Token</strong> 始终是那个核心计量单位。</p>
<p>很多人对 Token 有误解，认为它等同于字符（Character）或单词（Word）。这种误解往往导致两个问题：一是预估 API 成本时出现较大偏差，二是无法精确控制 Prompt 的上下文长度，导致模型“失忆”。</p>
<p>今天，我们再来系统地梳理一下 Token 的概念。</p>
<h3 data-id="heading-1">机器如何阅读文本？</h3>
<p>计算机只能处理数字，不能直接处理文本。因此，当我们向 LLM 发送一段话时，必须经历一个转码过程。</p>
<ol>
<li><strong>输入文本</strong>：人类语言。</li>
<li><strong>Tokenization（分词）</strong>：将文本切分成一个个具备语义的最小单位（Token），并转换为数字 ID。</li>
<li><strong>模型计算</strong>：模型对这些数字 ID 进行预测和计算。</li>
</ol>
<p><strong>Token</strong> 就是这个中间层的最小单位。</p>
<p>为什么不直接用“汉字”或“单词”做单位？</p>
<ul>
<li><strong>字符粒度太细</strong>：如果用字符（如 <code>a</code>, <code>b</code>, <code>c</code>），语义太稀疏，模型计算量会呈指数级上升。</li>
<li><strong>单词粒度太粗</strong>：人类语言词汇量太大，且不断有新词产生，这会导致模型的词表（Vocabulary）过于庞大。</li>
</ul>
<p>因此，LLM 采用的是 <strong>Sub-word（子词）</strong> 方案：常用的词是一个 Token，不常用的词拆分成多个 Token。</p>
<h3 data-id="heading-2">Token 的切分原理</h3>
<p>Token 的切分规则并非一成不变，不同模型使用的编码器（Encoding）不同，结果也不同。</p>
<h4 data-id="heading-3">英文与中文的差异</h4>
<ul>
<li><strong>英文</strong>：通常一个单词是一个 Token，但复杂的词会被拆分。例如 <code>smart</code> 是一个，但合成词或生僻词会被拆解。</li>
<li><strong>中文</strong>：在 GPT-3 时，中文非常“吃亏”，一个汉字往往需要 2-3 个 Token。</li>
</ul>
<p>到了现在的 <strong>GPT-5.1</strong>，Token 编码（如 <code>o200k_base</code> 或更新的编码集）对多语言进行了深度优化。
目前，绝大多数常用汉字，<strong>1 个汉字 = 1 个 Token</strong>。只有极少数生僻字或复杂的古文，才会被拆解。</p>
<p>这意味着，同样的预算，现在能处理的中文内容比两三年前多了将近一倍。</p>
<h4 data-id="heading-4">代码演示（Node.js）</h4>
<p>光说概念比较抽象，我们直接看代码。</p>
<p>在 Web 开发或 Node.js 环境中，我们通常使用 npm 包 <code>@dqbd/tiktoken</code> 来在本地计算 Token 数，这比每次调用 API 估算要快得多，也更省钱。</p>
<p>安装：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @dqbd/tiktoken
</code></pre>
<p>代码示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { encoding_for_model } <span class="hljs-keyword">from</span> <span class="hljs-string">"@dqbd/tiktoken"</span>

<span class="hljs-comment">// 获取 GPT-5.1</span>
<span class="hljs-keyword">const</span> enc = <span class="hljs-title function_">encoding_for_model</span>(<span class="hljs-string">"GPT-5.1"</span>)

<span class="hljs-keyword">const</span> text = <span class="hljs-string">"AI技术"</span>

<span class="hljs-comment">// 将文本转换为 Token ID 数组</span>
<span class="hljs-keyword">const</span> tokens = enc.<span class="hljs-title function_">encode</span>(text)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tokens)
<span class="hljs-comment">// 输出可能是: Uint32Array(2) [ 12345, 67890 ]</span>
<span class="hljs-comment">// 解释：'AI' 是一个 Token，'技术' 作为一个常用词可能被编码为一个 Token，或者两个汉字各一个。</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Token Count:"</span>, tokens.<span class="hljs-property">length</span>)

<span class="hljs-comment">// 记得释放内存</span>
enc.<span class="hljs-title function_">free</span>()
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fc653c081b646039994f0d868a5c81d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765301989&amp;x-signature=8aj%2BhYTyMXBDO7DNwUNzU5G0Lig%3D" alt="71" loading="lazy"/></p>
<p>通过这种方式，你可以在发送请求前，精确地知道这段文本会消耗多少 Token。</p>
<h3 data-id="heading-5">Token 的实际影响</h3>
<p>理解 Token 主要为了解决两个现实问题。</p>
<h4 data-id="heading-6">计费（Cost）</h4>
<p>API 计费公式通常是：<strong>（Input Tokens + Output Tokens）× 单价</strong>。</p>
<p>值得注意的是，随着模型迭代（如 GPT-5.1），推理成本虽然在下降，但 Output（生成内容）的价格通常依然高于 Input（输入内容）。</p>
<ul>
<li><strong>Input</strong>：你发给模型的 Prompt。</li>
<li><strong>Output</strong>：模型生成的回答。</li>
</ul>
<p>如果你的业务场景是“读长文、写摘要”，成本相对可控；如果是“读短句、写长文”，成本会显著增加。</p>
<h4 data-id="heading-7">上下文窗口（Context Window）</h4>
<p>这是 Token 最关键的物理限制。</p>
<p>虽然 GPT-5.1 的上下文窗口已经非常大（通常在 128k 甚至 200k tokens 以上），但它依然不是无限的。</p>
<ul>
<li><strong>早期模型</strong>：GPT-3.5 只有 4k context（约 3000 汉字），稍微聊几句就得“遗忘”前面的对话。</li>
<li><strong>当前模型</strong>：128k context 意味着你可以一次性把几本长篇小说塞给模型。</li>
</ul>
<p>但是，<strong>“能塞进去”不代表“效果好”</strong>。虽然 Token 容量变大了，但输入的内容越多，模型对中间信息的“注意力”（Attention）可能会被稀释。因此，开发者依然需要利用 RAG（检索增强生成）等技术，精简输入给模型的 Token，这不仅是为了省钱，更是为了提高回答的准确率。</p>
<h3 data-id="heading-8">四、 总结</h3>
<ol>
<li><strong>Token 是计费和计算的单位</strong>：它介于字符和单词之间。</li>
<li><strong>中文效率已大幅提升</strong>：在 GPT-5.1 时代，中英文的 Token 效率差距已大大缩小，基本可以按 1 字 = 1 Token 估算。</li>
<li><strong>开发者应当在本地计算</strong>：使用 <code>@dqbd/tiktoken</code> 等库在本地预计算 Token，是控制成本和上下文管理的最佳实践。</li>
</ol>
<p>理解 Token，是开发 LLM 应用的第一步，也是从“用户”进阶为“开发者”的必修课。</p>
<p>（完）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何同步查询参数到URL？]]></title>    <link>https://juejin.cn/post/7579190764766625832</link>    <guid>https://juejin.cn/post/7579190764766625832</guid>    <pubDate>2025-12-02T18:01:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579190764766625832" data-draft-id="7579093746611683328" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何同步查询参数到URL？"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-12-02T18:01:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mCell"/> <meta itemprop="url" content="https://juejin.cn/user/2280829967146779"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何同步查询参数到URL？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2280829967146779/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mCell
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T18:01:00.000Z" title="Tue Dec 02 2025 18:01:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>同步至个人站点：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstack.mcell.top%2Fblog%2F2025%2F30_useSearchParams" target="_blank" title="https://stack.mcell.top/blog/2025/30_useSearchParams" ref="nofollow noopener noreferrer">useSearchParams</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab34760779704f6f851b9fa48ba43e88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765303260&amp;x-signature=0M5VdPxw6mFSIU9i8ocX5x8EVPE%3D" alt="073.png" loading="lazy"/></p>
<h2 data-id="heading-0">使用 useSearchParams 同步 URL 和查询参数</h2>
<p>在开发 React 应用时，我们经常遇到一种场景：用户在搜索框输入关键词，筛选出一个列表，然后希望把这个结果分享给同事。</p>
<p>如果我们将筛选条件仅仅保存在组件的 <code>useState</code> 中，一旦刷新页面或复制链接，这些状态就会丢失，用户看到的只能是初始页面。</p>
<p>为了解决这个问题，我们需要将状态“提升”到 URL 的查询参数（Query Params）中。在 React Router v6 中，<code>useSearchParams</code> 这个 Hook 就是专门用来处理这个问题的。</p>
<p>本文将介绍如何使用它来实现 URL 与应用状态的同步。</p>
<h3 data-id="heading-1">为什么要同步状态到 URL</h3>
<p>在单页应用（SPA）中，URL 不仅仅是页面的地址，它还应该承载页面的<strong>状态</strong>。</p>
<p>将查询参数（如 <code>?q=react&amp;page=1</code>）绑定到 URL 有以下几个显而易见的好处：</p>
<ol>
<li><strong>可分享性</strong>：用户直接复制 URL 发送给他人，对方打开后看到的内容与发送者完全一致。</li>
<li><strong>持久性</strong>：刷新页面后，搜索条件和页码不会丢失。</li>
<li><strong>浏览器历史</strong>：用户可以使用浏览器的“后退”按钮回到上一次的搜索结果。</li>
</ol>
<h3 data-id="heading-2">基本用法</h3>
<p><code>useSearchParams</code> 的用法与 React 原生的 <code>useState</code> 非常相似。它返回一个数组，包含两个元素：当前的查询参数对象和一个更新查询参数的函数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useSearchParams } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>

<span class="hljs-keyword">const</span> [searchParams, setSearchParams] = <span class="hljs-title function_">useSearchParams</span>()
</code></pre>
<ul>
<li><strong><code>searchParams</code></strong>：这是一个 <code>URLSearchParams</code> 对象，用于读取当前的 URL 参数。</li>
<li><strong><code>setSearchParams</code></strong>：这是一个函数，用于设置新的 URL 参数，并触发组件重新渲染。</li>
</ul>
<h3 data-id="heading-3">读取参数</h3>
<p>假设当前的 URL 是 <code>http://localhost:3000/search?q=javascript</code>。</p>
<p>要获取 <code>q</code> 参数的值，我们使用 standard URLSearchParams API 中的 <code>.get()</code> 方法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> query = searchParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">"q"</span>) <span class="hljs-comment">// 返回 "javascript"</span>
</code></pre>
<p><strong>注意</strong>：<code>URLSearchParams</code> 获取到的值默认都是字符串。如果你在处理页码（如 <code>?page=1</code>），获取到的将是字符串 <code>"1"</code>，在使用前可能需要通过 <code>parseInt</code> 或 <code>Number</code> 进行转换。</p>
<h3 data-id="heading-4">写入参数</h3>
<p>要更新 URL 上的参数，我们调用 <code>setSearchParams</code>。这会更新 URL 的查询字符串，并自动将新的记录添加到浏览器的历史堆栈中。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 将 URL 更新为 /search?q=react</span>
<span class="hljs-title function_">setSearchParams</span>({ <span class="hljs-attr">q</span>: <span class="hljs-string">"react"</span> })
</code></pre>
<p>如果你想保留现有的其他参数（例如在切换页码时保留搜索关键词），你需要手动合并对象，或者传入一个回调函数（取决于 React Router 的具体版本行为，通常直接传入新对象会替换旧对象，因此建议显式构建新对象）。</p>
<h3 data-id="heading-5">构建一个可分享的搜索组件</h3>
<p>下面我们通过一个完整的示例，来实现一个“输入即搜索”且状态同步到 URL 的功能。</p>
<h4 data-id="heading-6">需求分析</h4>
<ul>
<li>有一个输入框，用于输入搜索关键词。</li>
<li>输入框的值（Value）应该受控于 URL 中的 <code>q</code> 参数。</li>
<li>当用户输入时，更新 URL 参数。</li>
<li>页面根据 URL 参数展示结果。</li>
</ul>
<h4 data-id="heading-7">代码实现</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">import</span> { useSearchParams } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 初始化 hook</span>
  <span class="hljs-keyword">const</span> [searchParams, setSearchParams] = <span class="hljs-title function_">useSearchParams</span>()

  <span class="hljs-comment">// 2. 读取参数：获取 URL 中的 'q'，如果没有则默认为空字符串</span>
  <span class="hljs-keyword">const</span> query = searchParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">"q"</span>) || <span class="hljs-string">""</span>

  <span class="hljs-comment">// 3. 事件处理：当 input 变化时，更新 URL</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleInputChange</span> = (<span class="hljs-params">event</span>) =&gt; {
    <span class="hljs-keyword">const</span> value = event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>

    <span class="hljs-keyword">if</span> (value) {
      <span class="hljs-comment">// 设置参数，URL 会变为 ?q=输入值</span>
      <span class="hljs-title function_">setSearchParams</span>({ <span class="hljs-attr">q</span>: value })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 如果清空了输入，最好也移除参数，保持 URL 干净</span>
      <span class="hljs-title function_">setSearchParams</span>({})
    }
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> "<span class="hljs-attr">20px</span>" }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>搜索示例<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

      {/* 输入框绑定 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleInputChange}</span>
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入搜索内容..."</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> "<span class="hljs-attr">8px</span>", <span class="hljs-attr">width:</span> "<span class="hljs-attr">300px</span>" }}
      /&gt;</span>

      {/* 模拟展示结果 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> "<span class="hljs-attr">20px</span>" }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
          当前的搜索关键词是：<span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>{query}<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> "#<span class="hljs-attr">666</span>", <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">14px</span>" }}&gt;</span>
          试着复制现在的浏览器地址栏 URL 分享给别人，他们将看到同样的关键词。
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">SearchPage</span>
</code></pre>
<h4 data-id="heading-8">代码解析</h4>
<p>这个组件的核心逻辑在于：<strong>输入框的状态不再由 <code>useState</code> 管理，而是直接由 <code>searchParams</code> 驱动。</strong></p>
<ul>
<li><strong>读取阶段</strong>：组件渲染时，直接从 URL 读取 <code>q</code> 赋值给 <code>input</code> 的 <code>value</code>。这意味着，如果用户是通过带有参数的链接进来的（例如 <code>/search?q=hello</code>），输入框里会自动填充 "hello"。</li>
<li><strong>写入阶段</strong>：用户输入时，调用 <code>setSearchParams</code>。这会修改 URL，URL 变化导致组件重新渲染，输入框的值随之更新。这是一个完美的闭环。</li>
</ul>
<h3 data-id="heading-9">进阶细节</h3>
<p>在使用 <code>useSearchParams</code> 时，还有两个细节值得注意。</p>
<h4 data-id="heading-10">防抖（Debounce）</h4>
<p>上面的例子中，用户每输入一个字母，URL 就会更新一次，浏览器的历史记录也会增加一条。这在实际体验中可能不仅对性能有影响，也会让用户的“后退”操作变得困难（需要按很多次后退才能回到上一个页面）。</p>
<p>通常，我们会配合“防抖”技术，在用户停止输入 300ms 或 500ms 后再更新 URL。或者，使用 <code>setSearchParams</code> 的 <code>replace</code> 选项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setSearchParams</span>({ <span class="hljs-attr">q</span>: value }, { <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span> })
</code></pre>
<p>设置 <code>replace: true</code> 会替换当前的历史记录项，而不是新增一条，这样用户点击“后退”时会直接回到进入搜索页之前的页面。</p>
<h4 data-id="heading-11">处理复杂对象</h4>
<p>URL 参数本质上是字符串。如果你需要存储复杂的筛选对象（例如多选标签、日期范围），通常需要自行序列化。</p>
<ul>
<li><strong>写入时</strong>：将数组或对象转换为字符串（如逗号分隔 <code>tags=vue,react</code>）。</li>
<li><strong>读取时</strong>：将字符串拆解回数组。</li>
</ul>
<p>(完)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写 call、apply、bind 的实现]]></title>    <link>https://juejin.cn/post/7579066828179882020</link>    <guid>https://juejin.cn/post/7579066828179882020</guid>    <pubDate>2025-12-02T16:26:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579066828179882020" data-draft-id="7579101504289669174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写 call、apply、bind 的实现"/> <meta itemprop="keywords" content="前端,JavaScript,ECMAScript 6"/> <meta itemprop="datePublished" content="2025-12-02T16:26:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024肥宅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写 call、apply、bind 的实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024肥宅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T16:26:41.000Z" title="Tue Dec 02 2025 16:26:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0"><code>Call</code>的实现</h4>
<h5 data-id="heading-1">基本实现思路:</h5>
<ol>
<li>将函数设置为对象的属性</li>
<li>执行该函数</li>
<li>删除该属性</li>
<li>返回执行结果</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myCall</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, ...args</span>) {
  <span class="hljs-comment">// 如果 context 为 null 或者 undefined, 则指向全局对象 (浏览器中是window)</span>
  context = context || globalThis;

  <span class="hljs-comment">// 防止覆盖原有属性，使用 Symbol 作为唯一键</span>
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"fn"</span>);

  <span class="hljs-comment">// 将当前函数作为 context 的方法</span>
  context[fnKey] = <span class="hljs-variable language_">this</span>;

  <span class="hljs-comment">// 执行函数</span>
  <span class="hljs-keyword">const</span> result = context[fnKey](...args);

  <span class="hljs-comment">// 删除临时添加的方法</span>
  <span class="hljs-keyword">delete</span> context[fnKey];

  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">// 更严谨的版本 (考虑更多边界情况)</span>
<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myCall</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context = globalThis, ...args</span>) {
  <span class="hljs-comment">// 确保 context 是对象(如果不是，转换为对象包装)</span>
  <span class="hljs-keyword">if</span> (context === <span class="hljs-literal">null</span> || context === <span class="hljs-literal">undefined</span>) {
    context = globalThis;
  } <span class="hljs-keyword">else</span> {
    context = <span class="hljs-title class_">Object</span>(context);
  }

  <span class="hljs-comment">// 使用唯一键</span>
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"fn"</span>);

  <span class="hljs-comment">// 将当前函数绑定到context</span>
  context[fnKey] = <span class="hljs-variable language_">this</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 执行函数</span>
    <span class="hljs-keyword">return</span> context[fnKey](...args);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 确保删除临时属性</span>
    <span class="hljs-keyword">delete</span> context[fnKey];
  }
};

</code></pre>
<h4 data-id="heading-2"><code>apply</code>的实现</h4>
<p><code>apply</code>与<code>call</code>类似，只是第二个参数是数组</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myApply</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, argsArray</span>) {
  <span class="hljs-comment">// 处理 context</span>
  context = context || globalThis;

  <span class="hljs-comment">// 如果argsArray不是数组或者类数组，则当作空数组处理</span>
  <span class="hljs-keyword">if</span> (
    !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(argsArray) &amp;&amp;
    !(argsArray &amp;&amp; <span class="hljs-keyword">typeof</span> argsArray === <span class="hljs-string">"object"</span> &amp;&amp; <span class="hljs-string">"length"</span> <span class="hljs-keyword">in</span> argsArray)
  ) {
    argsArray = [];
  }

  <span class="hljs-comment">// 创建唯一键</span>
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"fn"</span>);

  <span class="hljs-comment">// 将函数绑定到 context</span>
  context[fnKey] = <span class="hljs-variable language_">this</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 执行函数，使用展开运算符传递参数</span>
    <span class="hljs-keyword">const</span> result = context[fnKey](...argsArray);
    <span class="hljs-keyword">return</span> result;
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 清理</span>
    <span class="hljs-keyword">delete</span> context[fnKey];
  }
};

<span class="hljs-comment">// 更简洁的版本(基于myCall)</span>
<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myApply</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, argsArray</span>) {
  context = context || globalThis;
  argsArray = argsArray || [];

  <span class="hljs-comment">// 使用 myCall 的实现</span>
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"fn"</span>);
  context[fnKey] = <span class="hljs-variable language_">this</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> context[fnKey](...argsArray);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">delete</span> context[fnKey];
  }
};

</code></pre>
<h4 data-id="heading-3"><code>bind</code>的实现</h4>
<p><code>bind</code>返回一个新函数，需要处理更多边界情况</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myBind</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, ...bindArgs</span>) {
  <span class="hljs-comment">// 保存原函数</span>
  <span class="hljs-keyword">const</span> originalFunc = <span class="hljs-variable language_">this</span>;

  <span class="hljs-comment">// 确保 context 是对象</span>
  context = context || globalThis;

  <span class="hljs-comment">// 返回的绑定函数</span>
  <span class="hljs-keyword">const</span> boundFunc = <span class="hljs-keyword">function</span> (<span class="hljs-params">...callArgs</span>) {
    <span class="hljs-comment">// 判断是否通过 new 调用</span>
    <span class="hljs-keyword">const</span> isNewCall = <span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> boundFunc;

    <span class="hljs-comment">// 如果是 new 调用，this指向新创建的对象，而不是 context</span>
    <span class="hljs-keyword">const</span> thisContext = isNewCall ? <span class="hljs-variable language_">this</span> : context;

    <span class="hljs-comment">// 合并参数</span>
    <span class="hljs-keyword">const</span> allArgs = bindArgs.<span class="hljs-title function_">concat</span>(callArgs);

    <span class="hljs-comment">// 执行原函数</span>
    <span class="hljs-keyword">return</span> originalFunc.<span class="hljs-title function_">apply</span>(thisContext, allArgs);
  };

  <span class="hljs-comment">// 维护原型关系 (为了支持 new 操作)</span>
  <span class="hljs-comment">// 使用一个空函数作为中介，避免直接修改boundFunc.prototype影响originalFunc.prototype</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">TempFunc</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {};
  <span class="hljs-title class_">TempFunc</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = originalFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
  boundFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TempFunc</span>();

  <span class="hljs-keyword">return</span> boundFunc;
};
</code></pre>
<h4 data-id="heading-4">更完整的 <code>bind</code> 实现(支持更多特性)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myBind</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, ...bindArgs</span>) {
  <span class="hljs-comment">// 保存原函数</span>
  <span class="hljs-keyword">const</span> originalFunc = <span class="hljs-variable language_">this</span>;

  <span class="hljs-comment">// 判断是否是构造函数</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> originalFunc !== <span class="hljs-string">"function"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"Function.prototype.bind called on non-function"</span>);
  }

  <span class="hljs-comment">// 返回的绑定函数</span>
  <span class="hljs-keyword">const</span> boundFunc = <span class="hljs-keyword">function</span> (<span class="hljs-params">...callArgs</span>) {
    <span class="hljs-comment">// 判断是否通过 new 调用</span>
    <span class="hljs-comment">// 通过 new 调用时，this应该是 boundFunc 的实例</span>
    <span class="hljs-keyword">const</span> isNewCall = <span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> boundFunc;

    <span class="hljs-comment">// 确定执行上下文</span>
    <span class="hljs-keyword">const</span> thisContext = isNewCall ? <span class="hljs-variable language_">this</span> : <span class="hljs-title class_">Object</span>(context || globalThis);

    <span class="hljs-comment">// 合并参数</span>
    <span class="hljs-keyword">const</span> allArgs = bindArgs.<span class="hljs-title function_">concat</span>(callArgs);

    <span class="hljs-comment">// 调用原函数</span>
    <span class="hljs-keyword">return</span> originalFunc.<span class="hljs-title function_">apply</span>(thisContext, allArgs);
  };

  <span class="hljs-comment">// 维护原型链</span>
  <span class="hljs-keyword">if</span> (originalFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) {
    <span class="hljs-comment">// 使用 Object.create 来创建原型链, 避免直接修改</span>
    boundFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(originalFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
    <span class="hljs-comment">// 修正 constructor 指向</span>
    boundFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = boundFunc;
  }

  <span class="hljs-comment">// 保留原函数的长度(可选，非标准)</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 计算绑定函数的length属性(原函数参数个数 - 绑定的参数个数)</span>
    <span class="hljs-keyword">const</span> originalLength = originalFunc.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> bindArgsLength = bindArgs.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> remainingArgs = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(originalLength - bindArgsLength, <span class="hljs-number">0</span>);

    <span class="hljs-comment">// 使用 Object.defineProperty 来定义不可枚举的 length 属性</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(boundFunc, <span class="hljs-string">"length"</span>, {
      <span class="hljs-attr">value</span>: remainingArgs,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    });
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 忽略错误</span>
  }

  <span class="hljs-comment">// 保留原函数的name属性(可选)</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(boundFunc, <span class="hljs-string">"name"</span>, {
      <span class="hljs-attr">value</span>: <span class="hljs-string">`bound <span class="hljs-subst">${originalFunc.name || <span class="hljs-string">""</span>}</span>`</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    });
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 忽略错误</span>
  }

  <span class="hljs-keyword">return</span> boundFunc;
};

</code></pre>
<h4 data-id="heading-5">ES6类实现版本</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionUtils</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">callPolyfill</span>(<span class="hljs-params">fn, context, ...args</span>) {
    <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"fn"</span>);
    <span class="hljs-keyword">const</span> target = context || globalThis;

    <span class="hljs-comment">// 确保 context 是对象</span>
    <span class="hljs-keyword">const</span> contextObj =
      target === <span class="hljs-literal">null</span> || target === <span class="hljs-literal">undefined</span> ? globalThis : <span class="hljs-title class_">Object</span>(target);

    context[fnKey] = fn;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> contextObj[fnKey](...args);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">delete</span> contextObj[fnKey];
    }
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">applyPolyfill</span>(<span class="hljs-params">fn, context, argsArray</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callPolyfill</span>(fn, context, ...(argsArray || []));
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">bindPolyfill</span>(<span class="hljs-params">fn, context, ...bindArgs</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...callArgs</span>) {
      <span class="hljs-keyword">const</span> isNewCall = <span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> fn;
      <span class="hljs-keyword">const</span> thisContext = isNewCall ? <span class="hljs-variable language_">this</span> : context || globalThis;
      <span class="hljs-keyword">const</span> allArgs = bindArgs.<span class="hljs-title function_">concat</span>(callArgs);

      <span class="hljs-keyword">return</span> fn.<span class="hljs-title function_">apply</span>(thisContext, allArgs);
    };
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> + a + b);
}

<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">value</span>: <span class="hljs-number">10</span> };
<span class="hljs-title class_">FunctionUtils</span>.<span class="hljs-title function_">callPolyfill</span>(test, obj, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// 13</span>
<span class="hljs-title class_">FunctionUtils</span>.<span class="hljs-title function_">applyPolyfill</span>(test, obj, [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]); <span class="hljs-comment">// 13</span>

<span class="hljs-keyword">const</span> boundTest = <span class="hljs-title class_">FunctionUtils</span>.<span class="hljs-title function_">bindPolyfill</span>(test, obj, <span class="hljs-number">1</span>);
<span class="hljs-title function_">boundTest</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// 13</span>

</code></pre>
<h4 data-id="heading-6">总结</h4>
<ol>
<li><strong>call/apply的核心</strong>：将函数临时添加到目标对象上，然后调用它</li>
<li><strong>bind的核心</strong>：返回一个新函数，闭包保存原函数、上下文和预置参数</li>
<li><strong>new操作符的处理</strong>：bind返回的函数被new调用时，this应该指向新创建的实例</li>
<li><strong>原型链维护</strong>：bind返回的函数应该能正确继承原函数的原型</li>
<li><strong>边界情况</strong>：处理null/undefined上下文、参数类型等</li>
<li><strong>性能考虑</strong>：使用Symbol避免属性名冲突，使用try-finally确保清理</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[碰到一个不听劝的老板，喜提4.3a！]]></title>    <link>https://juejin.cn/post/7579256547789226025</link>    <guid>https://juejin.cn/post/7579256547789226025</guid>    <pubDate>2025-12-02T16:45:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579256547789226025" data-draft-id="7579093746611503104" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="碰到一个不听劝的老板，喜提4.3a！"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2025-12-02T16:45:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            碰到一个不听劝的老板，喜提4.3a！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T16:45:41.000Z" title="Tue Dec 02 2025 16:45:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>之前公司的老板，突然找到我想把之前的老包迭代一手。</p>
<p>说实话看在<code>之前老板劝退给赔偿的份上，迭代一下赚点维护费也不是不行</code>。但是迭代之前，<strong>特别强调了本身是兄弟来砍我类型的马甲包（没错，就是那个渣渣辉代言的游戏），而且还是AB的骚操作</strong>。</p>
<p>如果不是必须要迭代，建议不动最安全。<code>毕竟AB马甲包迭代 = 渡劫</code>。</p>
<p>再三确认，要迭代就谈好了费用直接开动。</p>
<h3 data-id="heading-1">内购端倪</h3>
<p>之前也知道，老板对上架这块规则不懂。<strong>但是没有想到开局就暴击！</strong></p>
<p>说实话内购<strong>定价能到2w和5w</strong>，我是万万没想到的。<code>激进派看了都得说激进！</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1dce6e54dc34ad9825191f92c686c4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765298740&amp;x-signature=5wMlnydmbAuRM1rnOsYYWl%2BY9BA%3D" alt="1.jpg" loading="lazy"/></p>
<p>本着对迭代负责的态度，建议了定价不要这么离谱！毕竟我这边主动拿出来<code>阴阳师</code>和<code>王者荣耀</code>，<strong>晓之以理，动之以情。摆事实，讲道理！</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8db27a65e86d4b54bcd498497bdd6a1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765298740&amp;x-signature=rFlDz7k8kqXAdgXqNmpHC4PGv%2Bk%3D" alt="2.jpg" loading="lazy"/></p>
<p>讲了半天，没办法。还是觉得定价低了。最低也得来个5000元的充值档次。</p>
<p>拿人钱财替人消灾，既然老板愿意承担风险。倒也无所谓了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98761a6623dd4518ac25b7fe1f99618f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765298740&amp;x-signature=aQKcmQy5EANn74pBMGBuYnMKPwU%3D" alt="e0c4c6e7ff8d5fddb19db201843e44ed.jpg" loading="lazy"/></p>
<h3 data-id="heading-2">首轮被拒</h3>
<p>不出意外的话，肯定是要出意外了！ 苹果直接打回了4999元，定价的合理性。</p>
<p>于是又开始了新一轮的劝解，没办法。<code>经过协商同意将4999元档次删除</code>。其他的充值档次保留。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbde95114568433da21c1622eb9963a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765298740&amp;x-signature=T%2F0upA3Uhb50xgddCHuzXUlUL0s%3D" alt="b5817f26b861a15b4495c8ae32e995df.jpg" loading="lazy"/></p>
<h3 data-id="heading-3">第二轮被拒</h3>
<p>其实提交的时候，已经预想到这种结局了。果然又是被拒了。苹果质疑1999元充值档次的合理性。</p>
<p>本来以为这时候的老板能够及时醒悟，<strong>奈何永远叫不醒一个装睡的人！</strong> 宁可撞南墙也不知悔改，`主打一个</p>
<p>不撞南墙不回头，不见棺材不掉泪！` 最后，劝不动。按照老板的意思，回复尝试。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ab6de84251c470f880ceb46b7819dff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765298740&amp;x-signature=zMqdPnEmwEU7DUFOOAYfepOvknI%3D" alt="3.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9443564686c84303a577d9fd6d83ad48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765298740&amp;x-signature=x78yTh8Uz4vt5Llu%2BJeuY%2FARg6M%3D" alt="5.jpg" loading="lazy"/></p>
<h3 data-id="heading-4">4.3a 判定</h3>
<p>好消息：金额苹果觉得没有问题了。</p>
<p>坏消息：没得玩，4.3a了。</p>
<p>其实遭遇4.3a，已经是意料之中的事情了。 <code>这套马甲包代码，分别上架了海外和国内。（因为都是我上的，所以我门清。）</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39e16eb1e3134b4aa467f332b5fb883a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765298740&amp;x-signature=e5bhwgYrgvwRvBb%2FluKC4RZqREs%3D" alt="6.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4448d49e32114e2ba93d721a6cf04748~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765298740&amp;x-signature=IjgGMPGH0w%2BZgJQS6TVZs7GnGH0%3D" alt="7.jpg" loading="lazy"/></p>
<h3 data-id="heading-5">总结</h3>
<p>所以，专业的人做专业的事儿。 外行的人，要多听劝。</p>
<p>之所以金额是1999元和4999元，是因为苹果充值档次没有2000元和5000元的档次。</p>
<p><strong>4.3a 垃圾应用 和 2.3.1 隐藏功能，都是因为不懂规则的人过度自以为是</strong>。没有吃过合规化上架的苦，把偶尔一两次的侥幸，当作区区AppStore不过如此的谈资。</p>
<p>截至发稿，已将产品通过审核。<strong>重新规划功能模块，顺利解决。</strong></p>
<p><code>遵守规则，方得长治久安</code>，最后祝大家大吉大利，今晚过审！</p>
<h3 data-id="heading-6">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端路由详解：Hash vs History]]></title>    <link>https://juejin.cn/post/7579190764766593064</link>    <guid>https://juejin.cn/post/7579190764766593064</guid>    <pubDate>2025-12-02T16:58:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579190764766593064" data-draft-id="7579088065697464360" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端路由详解：Hash vs History"/> <meta itemprop="keywords" content="前端,JavaScript,vue-router"/> <meta itemprop="datePublished" content="2025-12-02T16:58:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mCell"/> <meta itemprop="url" content="https://juejin.cn/user/2280829967146779"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端路由详解：Hash vs History
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2280829967146779/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mCell
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T16:58:11.000Z" title="Tue Dec 02 2025 16:58:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5b6e2dbff0c4641b99a77d3052ebea0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765299491&amp;x-signature=nWMYccRB0ekG9lbpSZ%2Bx2vjogjE%3D" alt="070" loading="lazy"/></p>
<h2 data-id="heading-0">前端路由详解：Hash vs History</h2>
<h3 data-id="heading-1">背景</h3>
<p>在 Web 开发的早期，互联网主要由 多页应用（MPA, Multi-Page Application）组成。那时的路由逻辑非常简单：用户点击一个链接，浏览器向服务器发送请求；服务器接收请求，根据 URL 路径找到对应的 HTML 文件（或通过模板引擎生成），返回给浏览器；浏览器卸载当前页面，重新渲染新页面。</p>
<p>这种模式的缺点显而易见：每次页面切换都需要重新加载资源，出现短暂的“白屏”，用户体验不够流畅。</p>
<p>随着 AJAX 技术的普及，单页应用（SPA, Single-Page Application）开始流行。SPA 的核心理念是：<strong>页面初始化时加载必要的 HTML、CSS 和 JavaScript，之后的页面切换不再请求完整的 HTML，而是通过 JS 动态更新页面内容。</strong></p>
<p>这就带来了一个新问题：<strong>如何在不刷新页面的前提下，改变 URL 并渲染对应的内容？</strong></p>
<p>这就是<strong>前端路由</strong>诞生的背景。目前主流的解决方案有两种：<strong>Hash 模式</strong>和 <strong>History 模式</strong>。</p>
<h3 data-id="heading-2">Hash 模式</h3>
<p>如果你看到 URL 中包含一个 <code>#</code> 号，例如 <code>http://www.example.com/#/home</code>，那么这个应用很可能使用的是 Hash 模式。</p>
<h4 data-id="heading-3">Hash 的本质</h4>
<p>Hash（哈希）原本是用来做页面定位的（锚点）。比如 <code>&lt;a href="#content"&gt;</code> 可以直接跳转到页面 id 为 <code>content</code> 的位置。</p>
<p>Hash 有一个非常重要的特性：<strong>URL 中 <code>#</code> 及其后面的内容，虽然会显示在浏览器地址栏，但不会被包含在 HTTP 请求中。</strong></p>
<p>当你访问 <code>http://www.example.com/#/home</code> 时，浏览器向服务器请求的仅仅是 <code>http://www.example.com/</code>。这意味着，无论 <code>#</code> 后面的内容如何变化，服务端都只接收到同一个请求，返回同一个 <code>index.html</code>。</p>
<h4 data-id="heading-4">实现原理</h4>
<p>在浏览器中，我们可以通过 <code>window.location.hash</code> 属性读取或修改 Hash 值。</p>
<p>更关键的是，浏览器提供了一个 <code>hashchange</code> 事件。当 URL 的 Hash 部分发生变化时，就会触发这个事件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监听 Hash 变化</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"hashchange"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"The hash has changed to: "</span> + location.<span class="hljs-property">hash</span>)
  <span class="hljs-comment">// 在这里根据 hash 的值，动态更新页面 DOM</span>
})
</code></pre>
<h4 data-id="heading-5">优缺点分析</h4>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>兼容性好</strong>：支持低版本浏览器（如 IE8）。</li>
<li><strong>无需服务端配置</strong>：因为 Hash 不参与 HTTP 请求，服务器只需处理根路径请求，部署极其简单。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>URL 不美观</strong>：<code>#</code> 符号夹在中间，违背了 URL 的语义（Uniform Resource Locator），看起来像个“补丁”。</li>
<li><strong>SEO 较差</strong>：搜索引擎爬虫虽然在进化，但对 Hash 的支持依然不如纯路径友好。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">History 模式</h3>
<p>为了解决 Hash 模式 URL 不美观的问题，HTML5 标准在 <code>history</code> 对象上增加了新的 API。这就是 History 模式的基础。</p>
<h4 data-id="heading-7">核心 API</h4>
<p>在 HTML4 时代，<code>window.history</code> 只能用于前进（<code>forward</code>）、后退（<code>back</code>）和跳转（<code>go</code>）。</p>
<p>HTML5 新增了两个关键方法，允许我们在<strong>不刷新页面</strong>的情况下修改 URL：</p>
<ol>
<li><code>history.pushState(state, title, url)</code>：向历史记录堆栈中添加一条新记录。</li>
<li><code>history.replaceState(state, title, url)</code>：修改当前的历史记录。</li>
</ol>
<p>例如，执行 <code>history.pushState(null, null, '/user/id')</code> 后，浏览器的地址栏会变为 <code>http://www.example.com/user/id</code>，但浏览器<strong>不会</strong>向服务器发送请求，页面也不会刷新。</p>
<h4 data-id="heading-8">实现原理</h4>
<p>History 模式的实现比 Hash 稍微复杂一点。我们需要处理两种情况：</p>
<ol>
<li><strong>用户点击链接</strong>：前端框架会拦截 <code>&lt;a&gt;</code> 标签的点击事件，阻止默认跳转，改用 <code>history.pushState</code> 修改 URL，并手动更新视图。</li>
<li><strong>用户点击浏览器的前进/后退按钮</strong>：这会触发 <code>popstate</code> 事件。我们需要监听这个事件来更新视图。</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监听浏览器的前进、后退</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"popstate"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
    <span class="hljs-string">"Location: "</span> + <span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span> + <span class="hljs-string">", state: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(event.<span class="hljs-property">state</span>)
  )
  <span class="hljs-comment">// 根据当前 path 更新视图</span>
})
</code></pre>
<h4 data-id="heading-9">优缺点分析</h4>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>URL 美观</strong>：和传统后端路由一样的路径结构，符合 RESTful 规范。</li>
<li><strong>功能更强</strong>：<code>pushState</code> 可以传递 <code>state</code> 对象，允许在页面跳转时传递复杂数据。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>兼容性</strong>：需要 IE10 及以上。</li>
<li><strong>必须服务端配置</strong>：这是最大的痛点（详见第五节）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">源码级实战：手写迷你路由</h3>
<p>为了彻底理解，我们模仿 Vue Router 写一个简化版。</p>
<h4 data-id="heading-11">4.1 HashRouter 实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HashRouter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span> = {} <span class="hljs-comment">// 存储路径与回调函数的映射</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUrl</span> = <span class="hljs-string">""</span>

    <span class="hljs-comment">// 绑定 this，防止指向丢失</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)

    <span class="hljs-comment">// 监听 load 和 hashchange 事件</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"load"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"hashchange"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">refresh</span>)
  }

  <span class="hljs-comment">// 注册路由</span>
  <span class="hljs-title function_">route</span>(<span class="hljs-params">path, callback</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[path] = callback || <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {}
  }

  <span class="hljs-comment">// 刷新页面逻辑</span>
  <span class="hljs-title function_">refresh</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 获取当前 hash，去掉 # 号</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUrl</span> = location.<span class="hljs-property">hash</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>) || <span class="hljs-string">"/"</span>
    <span class="hljs-comment">// 执行对应的回调函数（渲染 UI）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUrl</span>]) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUrl</span>]()
    }
  }
}
</code></pre>
<h4 data-id="heading-12">HistoryRouter 实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HistoryRouter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span> = {}

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">bindPopState</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initLinkHijack</span>() <span class="hljs-comment">// 拦截 a 标签</span>
  }

  <span class="hljs-title function_">route</span>(<span class="hljs-params">path, callback</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[path] = callback || <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {}
  }

  <span class="hljs-comment">// 监听浏览器自带的前进后退</span>
  <span class="hljs-title function_">bindPopState</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"popstate"</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> path = location.<span class="hljs-property">pathname</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateView</span>(path)
    })
  }

  <span class="hljs-comment">// 拦截全局点击事件，处理 link 跳转</span>
  <span class="hljs-title function_">initLinkHijack</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>
      <span class="hljs-keyword">if</span> (target.<span class="hljs-property">tagName</span> === <span class="hljs-string">"A"</span>) {
        e.<span class="hljs-title function_">preventDefault</span>() <span class="hljs-comment">// 阻止默认跳转</span>
        <span class="hljs-keyword">const</span> path = target.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">"href"</span>)
        <span class="hljs-comment">// 手动修改 URL</span>
        history.<span class="hljs-title function_">pushState</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, path)
        <span class="hljs-comment">// 更新视图</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateView</span>(path)
      }
    })
  }

  <span class="hljs-title function_">updateView</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[path]) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[path]()
    }
  }
}
</code></pre>
<h3 data-id="heading-13">部署难题：History 模式下的 404 问题</h3>
<p>这是新手最容易遇到的“坑”。</p>
<h4 data-id="heading-14">现象复现</h4>
<p>你在本地开发时（使用 <code>webpack-dev-server</code> 或 <code>vite</code>），一切正常。但是，当你运行 <code>npm run build</code> 打包，将生成的文件部署到 Nginx 服务器后：</p>
<ol>
<li>访问根路径 <code>http://www.site.com/</code>，页面正常显示。</li>
<li>点击导航进入 <code>http://www.site.com/about</code>，页面正常显示（因为是 JS 动态渲染的）。</li>
<li><strong>但是</strong>，如果你在 <code>/about</code> 页面按下<strong>刷新</strong>按钮，或者直接在地址栏输入这个地址，页面会显示 <strong>404 Not Found</strong>。</li>
</ol>
<h4 data-id="heading-15">根本原因</h4>
<p>这是一个典型的“前端路由与后端路由冲突”问题。</p>
<ul>
<li><strong>前端逻辑</strong>：我认为 <code>/about</code> 是一个视图（Component），属于 <code>index.html</code> 的一部分。</li>
<li><strong>后端逻辑</strong>：当浏览器发送 <code>/about</code> 请求时，服务器会去文件系统中查找名为 <code>about</code> 的文件夹或文件。</li>
</ul>
<p>很显然，你的服务器上只有一个 <code>index.html</code>，并没有 <code>about</code> 这个文件，所以 Nginx 诚实地返回了 404。</p>
<h4 data-id="heading-16">解决方案</h4>
<p>解决思路很简单：<strong>告诉服务器，如果找不到对应的文件，不要报 404，而是统统返回 <code>index.html</code>。</strong></p>
<p>只要返回了 <code>index.html</code>，浏览器就会加载 JS，路由插件（Vue Router 等）就会接管 URL，分析路径是 <code>/about</code>，然后渲染出对应的组件。</p>
<p><strong>Nginx 配置示例：</strong></p>
<pre><code class="hljs language-nginx" lang="nginx">location / {
  root   /usr/share/nginx/html;
  index  index.html index.htm;

  # 核心配置：尝试查找文件，找不到则重定向到 index.html
  try_files $uri $uri/ /index.html;
}
</code></pre>
<p><code>try_files $uri $uri/ /index.html;</code> 的意思是：</p>
<ol>
<li>先看用户请求的是不是一个真实存在的文件（<code>$uri</code>）。</li>
<li>如果不是，再看是不是一个真实存在的目录（<code>$uri/</code>）。</li>
<li>如果都不是，就返回 <code>/index.html</code>。</li>
</ol>
<h3 data-id="heading-17">总结与选型指南</h3>
<p>最后，我们用一张表格来总结两者的区别，帮助你在项目中做出选择。</p>








































<table><thead><tr><th align="left">特性</th><th align="left">Hash 模式</th><th align="left">History 模式</th></tr></thead><tbody><tr><td align="left"><strong>URL 外观</strong></td><td align="left"><code>example.com/#/about</code></td><td align="left"><code>example.com/about</code></td></tr><tr><td align="left"><strong>美观度</strong></td><td align="left">丑，有“#”号干扰</td><td align="left">美观，符合标准</td></tr><tr><td align="left"><strong>原理</strong></td><td align="left"><code>window.location.hash</code></td><td align="left"><code>history.pushState</code></td></tr><tr><td align="left"><strong>兼容性</strong></td><td align="left">极好（IE8+）</td><td align="left">较好（IE10+）</td></tr><tr><td align="left"><strong>服务端配置</strong></td><td align="left"><strong>不需要</strong></td><td align="left"><strong>必须配置</strong></td></tr><tr><td align="left"><strong>应用场景</strong></td><td align="left">内部系统、Demo、静态资源服务器</td><td align="left">正式商业项目、C 端应用</td></tr></tbody></table>
<p>在现代前端开发中，除非你有特殊的兼容性需求或者由于权限问题无法配置服务器，否则<strong>强烈建议使用 History 模式</strong>。它不仅能提供更好的用户体验，也更符合 Web 标准的发展趋势。</p>
<p>（完）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Virtual World 02】两点一线！！！]]></title>    <link>https://juejin.cn/post/7579256547788996649</link>    <guid>https://juejin.cn/post/7579256547788996649</guid>    <pubDate>2025-12-02T15:06:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579256547788996649" data-draft-id="7577718777481330726" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Virtual World 02】两点一线！！！"/> <meta itemprop="keywords" content="JavaScript,CSS,HTML"/> <meta itemprop="datePublished" content="2025-12-02T15:06:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大怪v"/> <meta itemprop="url" content="https://juejin.cn/user/4391901700043284"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Virtual World 02】两点一线！！！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4391901700043284/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大怪v
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T15:06:07.000Z" title="Tue Dec 02 2025 15:06:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是<strong>纯前端手搓虚拟世界</strong>第二篇。</p>
<p>在上一篇里，我们已经成功搭好了项目的基础骨架，并实现了最基础的单位 —— <code>Point2D类</code>。如果你是中途加入，点下面先补一下。</p>
<p>戳这里就可以<a href="https://juejin.cn/post/7578348333249986566" target="_blank" title="https://juejin.cn/post/7578348333249986566">【Virtual World 01】头脑热一把，带你手搓虚拟世界💪！</a>。</p>
<h2 data-id="heading-0">吐个槽</h2>
<p>第一篇写得有点啰嗦，可能有人觉得我“明明是手搓虚拟世界，为啥从语文课开始讲起”😂。</p>
<p>这...总得有点仪式感嘛。</p>
<p>别急别急！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bc6b63d58a1439080594224d0459b22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5oCqdg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765293968&amp;x-signature=6v4I1%2FCQmyfJHuMDw8bS4x4uZNQ%3D" alt="2fh47XSZ.gif" loading="lazy"/></p>
<h2 data-id="heading-1">上代码！！！</h2>
<p>来，直接在我们<code>primitives</code>文件夹中，定义一个segment类。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ./primitives/segment.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Segment</span> {
  <span class="hljs-comment">// p1 p2 传入Point类 </span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">p1, p2</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p1</span> = p1;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">p2</span> = p2;
  }
}
</code></pre>
<p>现在看过去，这个类依旧那么简单，但如果能跟到后面，你会发现—它是构建虚拟世界里所有「形状」的基础大到建筑、道路、地形轮廓，小到网格、辅助线，全都绕不开它。</p>
<p>打基础的时候就是这么简单，但往往复杂的东西就是简单东西堆砌的。知道1+1然后考上了清华的朋友一定会给我点个赞的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6af598113464204bcd032dec78f22df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5oCqdg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765293968&amp;x-signature=tXQ6UbqMlKKKayHz5DN1obZt%2FcQ%3D" alt="缺牙笑.gif" loading="lazy"/></p>
<p><strong>骑驴看账本--走着瞧吧</strong></p>
<h2 data-id="heading-2">两点一线</h2>
<p>对于创建虚拟世界，我们打小就有理论基础的。这个我坚信。</p>
<p>你肯定还记得小学二年级的王老师曾告诉你，两点才能成一条线！！！</p>
<p>嗯，好，知识充，接下来动手实操了。技术点上，主要还依赖<code>canvas</code>的<code>getContext("2d")</code>。其中有<code>moveTo</code> 和 <code>lineTo</code>。</p>
<p>在Segment类中填上如下代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ./primitives/segment.js</span>
<span class="hljs-title function_">draw</span>(<span class="hljs-params">ctx, { width = <span class="hljs-number">2</span>, color = <span class="hljs-string">"black"</span> } = {}</span>) {
    ctx.<span class="hljs-title function_">beginPath</span>();  <span class="hljs-comment">// 开始绘制</span>
    ctx.<span class="hljs-property">lineWidth</span> = width; <span class="hljs-comment">// 设置线的宽度</span>
    ctx.<span class="hljs-property">strokeStyle</span> = color; <span class="hljs-comment">// 设置线的颜色</span>
    ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p1</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p1</span>.<span class="hljs-property">y</span>);
    ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">p2</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">p2</span>.<span class="hljs-property">y</span>);
    ctx.<span class="hljs-title function_">stroke</span>();
}
</code></pre>
<p>代码很好理解，但我们可以靠想象力丰富下。</p>
<p>脑海中想一下你拿着笔，先移动笔到纸的某一点，然后下笔，手腕将笔移动到另一点，把笔拿开，<strong>线</strong>搞定！！</p>
<p>show一下，在/src/index.js中的display方法添加如下代码：</p>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">// 用于绘制所有图形</span>
  <span class="hljs-title function_">display</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Segment</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Point2D</span>(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>),<span class="hljs-keyword">new</span> <span class="hljs-title class_">Point2D</span>(<span class="hljs-number">400</span>, <span class="hljs-number">400</span>)).<span class="hljs-title function_">draw</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>)
  }
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f60266e07ab4f659ec153ccd2017c5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5oCqdg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765293968&amp;x-signature=5pmd5Nlq9qbd8vFxlIr54iRsfSk%3D" alt="image.png" loading="lazy"/></p>
<p>嗯...万里长征第二步。</p>
<h2 data-id="heading-3">粗细是个问题（但先不急）</h2>
<p>先说明下：</p>





















<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><code>lineWidth</code></td><td>Canvas 只是大致控制粗细，不是像 SVG 那样精确</td></tr><tr><td><code>strokeStyle</code></td><td>支持颜色、渐变等</td></tr><tr><td>高级需求</td><td>需要结合像素密度 / DPR 做适配</td></tr></tbody></table>
<p>目前好只是基础几何阶段先不在乎这个。后面做 坐标系 + 视口缩放 的时候，我们再一起处理 DPI 适配和缩放视觉一致性。</p>
<p>至于曲线，先忘掉这回事吧。</p>
<h2 data-id="heading-4">装个X</h2>
<p>老师常常告诫我们举一反三，嗯，这就来了。</p>
<p>我们目前两个类：</p>
<ul>
<li>Point2D</li>
<li>Segment</li>
</ul>
<p>但理论上，可以绘制任何几何图形了，这样，简简单单搞个<strong>分形树</strong>。</p>
<p>还在在/src/index.js中的display方法中，添加上实验代码：</p>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">// 用于绘制所有图形</span>
 <span class="hljs-keyword">const</span> <span class="hljs-title function_">fractalTree</span> = (<span class="hljs-params">p1, length, angle, depth, ctx</span>) =&gt; {
      <span class="hljs-keyword">if</span> (depth &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point2D</span>(
        p1.<span class="hljs-property">x</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle) * length,
        p1.<span class="hljs-property">y</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * length
      );

      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Segment</span>(p1, p2).<span class="hljs-title function_">draw</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>);

      <span class="hljs-keyword">const</span> nextLength = length * <span class="hljs-number">0.7</span>;

      <span class="hljs-title function_">fractalTree</span>(p2, nextLength, angle - <span class="hljs-number">0.5</span>, depth - <span class="hljs-number">1</span>, ctx); <span class="hljs-comment">// 左叉</span>
      <span class="hljs-title function_">fractalTree</span>(p2, nextLength, angle + <span class="hljs-number">0.5</span>, depth - <span class="hljs-number">1</span>, ctx); <span class="hljs-comment">// 右叉</span>
}

<span class="hljs-title function_">fractalTree</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Point2D</span>(<span class="hljs-number">300</span>, <span class="hljs-number">500</span>), <span class="hljs-number">120</span>, -<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>);
</code></pre>
<p>不出意外，艺术成分还得上几层楼。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a58f3b4ada14b23bd101d5f55755727~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5oCqdg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765293968&amp;x-signature=cP5BCiw0SZ9gol2iTNfsiy%2BkfKE%3D" alt="image.png" loading="lazy"/></p>
<p>今天就这样了！！！</p>
<p>源码在这里<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFloat-none%2FJS-Genesis%2Ftree%2Fmain%2F02" target="_blank" title="https://github.com/Float-none/JS-Genesis/tree/main/02" ref="nofollow noopener noreferrer">github.com/Float-none/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae SOLO 挑战全栈开发记账 App，Token狂烧]]></title>    <link>https://juejin.cn/post/7579094978681929774</link>    <guid>https://juejin.cn/post/7579094978681929774</guid>    <pubDate>2025-12-02T15:08:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579094978681929774" data-draft-id="7579096485356109874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae SOLO 挑战全栈开发记账 App，Token狂烧"/> <meta itemprop="keywords" content="AI编程,VibeCoding,全栈"/> <meta itemprop="datePublished" content="2025-12-02T15:08:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陈佬昔编程人生"/> <meta itemprop="url" content="https://juejin.cn/user/3087084378402445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae SOLO 挑战全栈开发记账 App，Token狂烧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3087084378402445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陈佬昔编程人生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T15:08:17.000Z" title="Tue Dec 02 2025 15:08:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Trae SOLO 随着 3.0 正式发布了，其对标的是 Cursor 的 Agents。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f89943e1e5cf492f8d29650589e3e408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765292896&amp;x-signature=%2B4riRgNTlMuEvW8yrGsjUkcdAF4%3D" alt="cusor agent和trae solo.jpg" loading="lazy"/></p>
<p>相对于 Cursor Agents 让对话占据主要位置的布局调整，Trae SOLO 显得更加激进，他有三个明显的特色：</p>
<p>其一，实时跟踪功能，会显示 AI 正在修改的文件，那种电影里黑客敲代码时，逐行逐行吐字一直在刷新屏幕的效果，让氛围感拉满。啥叫 Vibe Coding？这就叫 Vibe Coding。</p>
<p>其二，特色就是 plan 计划模式。优先列出开发计划，然后等待用户确认再执行。</p>
<p>另外，还有就是代码对比工具，做到每一步都可以查看、回退。</p>
<h2 data-id="heading-0">开始开发项目</h2>
<p>这次用来挑战不手动改代码，完全用 SOLO 完成全栈开发，独立开发者最爱三大 App 之一的记账本。</p>
<p>开始两次没成功，一次是让它开发 iOS App，一次是是让它开发 Web app。iOS App，无法启动，尝试修复无果；Web App 无法适配手机，多次尝试后放弃。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2140c6d5a79749ec872b13a41bd3a690~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765292896&amp;x-signature=bYIvE1RyT7%2B79U07um%2ForeKwV98%3D" alt="Pasted image 20251201233216.png" loading="lazy"/></p>
<p>只能说底座模型还是能力还是不太够吧。</p>
<p>最后提示词改成“开发一个多端 App”，并使用<strong>提示词优化功能</strong>，终于出来了一个比较符合的开发计划。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f27e55023da547cc863be3d896d10e24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765292896&amp;x-signature=eis2CKIQxtoDk2uwsqyLBBmySt0%3D" alt="开发计划.jpg" loading="lazy"/></p>
<p>不过很搞笑的是，从开发时间线来看，这显然是一个人类的开发计划。</p>
<p>确认开发计划之后，它就自己开始写代码了。</p>
<p>等了大概1小时，前后端完成。启动后，发现我的 mongoDB 没安装。根据提示，折腾了半小时，终于跑起来了。</p>
<p>⚠️ 需要注意的是，这个过程中，<strong>命令行可能需要你手动操作</strong>，敲个 Y，或者选择技术栈、工具等，不是完全自动的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e975a4b069834074ab0f98f44434ff3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765292896&amp;x-signature=Pt5wynf88JgCBmt4KMJ%2Fw4XbtyA%3D" alt="跑起来了.jpg" loading="lazy"/></p>
<p>第一次出来的界面还是英文的，调整后变成了中文。</p>
<p>只能说界面算是齐全了，但整体还是过于简洁，而且也是明显的 Web App 的风格，交互也不太符合手机端的使用习惯。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ac003077db24e9f9605039475abe559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765292896&amp;x-signature=R7eh2LWteKo4u7jyZ%2B9S0GOiusg%3D" alt="第一次.jpg" loading="lazy"/></p>
<p>即使本身就是手机端的技术栈/组件，尝试使用“看起来更像手机App”，”使用手机端的操作习惯“，这些关键词，最后也无济于事。</p>
<p>看来大语言模型还是语言模型，对界面有要求，只能根据自己的个人经验去做调整了。</p>
<p>两个小时的成果就这样了，后续就是细化工作了。</p>
<h2 data-id="heading-1">细化工作</h2>
<p>后面，我又花了一个小时，调整了页面，修复了一些bug，才看到有点像样子了。</p>
<p>但最后统计页面不更新的问题卡住了，所有的接口都返回空数组， 月度概览的数字也一直是0，修了半小时没有什么变化。</p>
<p>我只能新开一个任务，让他重新设计。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14b7bf01bf5f464eaff7d5ed5f2f1f8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765292896&amp;x-signature=GkaQCnzLagnd%2Be1q6RswYrHLCxo%3D" alt="卡住了2.jpg" loading="lazy"/></p>
<p>一小时过去了，终于修复了。</p>
<p>我差点都要放弃了，毕竟这耗时太久了。</p>
<p>我大概明白为什么有人会说 Claude Code、Qoder Code 的套餐量都不够用了。如果不是 Trae 官方开了白名单，估计我也已经欠费了吧。</p>
<p>最后成果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f546ea9a70da4e4ebd19cf37a1094add~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5L2s5piU57yW56iL5Lq655Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765292896&amp;x-signature=Olq0hIi6wFMg19vtcrB%2FwNIrdBA%3D" alt="修复之后.jpg" loading="lazy"/></p>
<p>整体看起来好多了，整理的数据流是通的，但是其实 bug 还是挺多的，交互问题也很多。</p>
<p>只能说如果作为交互稿是够用的，或者说自己用是可以的。但是要商用，就很难了，相信也没有人愿意为这样简陋的 App 埋单的。</p>
<p>所以如果微调到更好用的话，估计还要花上几个小时的工作。</p>
<h2 data-id="heading-2">总结</h2>
<p>总体体验下来，SOLO 模式的确能让人在不懂代码的情况下，完成简单的 app 开发工作。</p>
<p>但是对 token 的消耗应该是惊人的。如果 Trae 要对这个功能收费，估计要上最高消费吧。</p>
<p>作为程序员感觉自己还是幸运的，能看懂代码，而不用等 AI 这样一直循环地查找问题。</p>
<p>跟 Cursor 的 Agents 一样，Trae 的 SOLO 也是希望能让更多的人能加入 Vibe Coding，来做开发工作，目的是去掉手动修改代码的操作，全程交给 AI 完成。更适合初级开发或者产品经理这样的角色。</p>
<p>用过两次 Cursor Agents之后，我默默地切回了编辑器的工作界面；这次评测 Trae SOLO 也是如此。</p>
<p>但是，这次AI成功完成挑战，我对全程 AI 写代码也少了一份抗拒。Trae SOLO 还是成功的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[节流（Throttle）]]></title>    <link>https://juejin.cn/post/7579123072825999379</link>    <guid>https://juejin.cn/post/7579123072825999379</guid>    <pubDate>2025-12-02T15:15:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579123072825999379" data-draft-id="7579066828179734564" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="节流（Throttle）"/> <meta itemprop="keywords" content="JavaScript,前端,ECMAScript 6"/> <meta itemprop="datePublished" content="2025-12-02T15:15:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024肥宅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            节流（Throttle）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024肥宅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T15:15:46.000Z" title="Tue Dec 02 2025 15:15:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">节流（Throttle）</h3>
<p>节流：规定在一个单位时间内，只能触发一次函数。如果这个单位时间内触发多次函数，只有一次生效。</p>
<h5 data-id="heading-1">应用场景</h5>
<ul>
<li>滚动加载(滚动时每间隔一段时间检查位置)</li>
<li>按钮点击(防止重复提交)</li>
<li>鼠标移动(<code>mousemove</code>事件)</li>
<li>游戏中的按键操作</li>
</ul>
<h5 data-id="heading-2">时间戳版本(立即执行)</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">func, wait</span>) {
  <span class="hljs-keyword">let</span> previous = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">const</span> args = <span class="hljs-variable language_">arguments</span>;

    <span class="hljs-keyword">if</span> (now - previous &gt; wait) {
      func.<span class="hljs-title function_">apply</span>(context, args);
      previous = now;
    }
  };
}
</code></pre>
<h5 data-id="heading-3">定时器版本(延迟执行)</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">func, wait</span>) {
  <span class="hljs-keyword">let</span> timeout;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">const</span> args = <span class="hljs-variable language_">arguments</span>;

    <span class="hljs-keyword">if</span> (!timeout) {
      timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        timeout = <span class="hljs-literal">null</span>;
        func.<span class="hljs-title function_">apply</span>(context, args);
      }, wait);
    }
  };
}

</code></pre>
<h5 data-id="heading-4">综合版本(先立即执行，然后节流)</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">func, wait</span>) {
  <span class="hljs-keyword">let</span> timeout, context, args;
  <span class="hljs-keyword">let</span> previous = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">const</span> later = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    previous = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    timeout = <span class="hljs-literal">null</span>;
    func.<span class="hljs-title function_">apply</span>(context, args);
  };

  <span class="hljs-keyword">const</span> throttled = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-comment">// 下次触发 func 剩余的时间</span>
    <span class="hljs-keyword">const</span> remaining = wait - (now - previous);
    context = <span class="hljs-variable language_">this</span>;
    args = <span class="hljs-variable language_">arguments</span>;

    <span class="hljs-comment">// 如果没有剩余时间了或者你改了系统时间</span>
    <span class="hljs-keyword">if</span> (remaining &lt;= <span class="hljs-number">0</span> || remaining &gt; wait) {
      <span class="hljs-keyword">if</span> (timeout) {
        <span class="hljs-built_in">clearTimeout</span>(timeout);
        timeout = <span class="hljs-literal">null</span>;
      }
      previous = now;
      func.<span class="hljs-title function_">apply</span>(context, args);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!timeout) {
      timeout = <span class="hljs-built_in">setTimeout</span>(later, remaining);
    }
  };

  throttled.<span class="hljs-property">cancel</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearTimeout</span>(timeout);
    previous = <span class="hljs-number">0</span>;
    timeout = <span class="hljs-literal">null</span>;
  };

  <span class="hljs-keyword">return</span> throttled;
}

</code></pre>
<h5 data-id="heading-5">ES6版本</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Throttler</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">func, wait, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span> = func;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span> = wait;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">leading</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否立即执行</span>
      <span class="hljs-attr">trailing</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否在结束后再执行一次</span>
    };
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>, options);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span> = args;

    <span class="hljs-comment">// 如果是第一次调用且 leading 为 false, 设置 previous 为 now</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">leading</span> === <span class="hljs-literal">false</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = now;
    }

    <span class="hljs-keyword">const</span> remaining = <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span> - (now - <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span>);

    <span class="hljs-comment">// 时间已到货 remaining 异常(如系统时间被调整)</span>
    <span class="hljs-keyword">if</span> (remaining &lt;= <span class="hljs-number">0</span> || remaining &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>) {
        <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = now;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
    }
    <span class="hljs-comment">// 如果 trailing 为 true, 且没有定时器</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">trailing</span> !== <span class="hljs-literal">false</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">leading</span> === <span class="hljs-literal">false</span> ? <span class="hljs-number">0</span> : <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
      }, remaining);
    }
  }

  <span class="hljs-title function_">cancel</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">flush</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
    }
  }
}

<span class="hljs-comment">// 节流使用 - 立即执行</span>
<span class="hljs-keyword">const</span> throttler1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Throttler</span>(<span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"节流执行:"</span>, msg, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
}, <span class="hljs-number">1000</span>);

<span class="hljs-comment">// 快速调用</span>
throttler1.<span class="hljs-title function_">execute</span>(<span class="hljs-string">"队列消息1"</span>); <span class="hljs-comment">// 立即执行</span>
throttler1.<span class="hljs-title function_">execute</span>(<span class="hljs-string">"队列消息2"</span>); <span class="hljs-comment">// 被忽略</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> throttler1.<span class="hljs-title function_">execute</span>(<span class="hljs-string">"队列消息3"</span>), <span class="hljs-number">1000</span>); <span class="hljs-comment">// 再次执行</span>

<span class="hljs-comment">// 节流使用 - 不立即执行</span>
<span class="hljs-keyword">const</span> throttler2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Throttler</span>(
  <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"节流执行:"</span>, msg, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()),
  <span class="hljs-number">1000</span>,
  { <span class="hljs-attr">leading</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">trailing</span>: <span class="hljs-literal">true</span> }
);

<span class="hljs-comment">// 手动取消</span>
<span class="hljs-keyword">const</span> throttler3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Throttler</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"执行中..."</span>);
}, <span class="hljs-number">500</span>);

<span class="hljs-comment">// 开始执行</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> throttler3.<span class="hljs-title function_">execute</span>(), <span class="hljs-number">100</span>);

<span class="hljs-comment">// 2秒后取消</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  throttler3.<span class="hljs-title function_">cancel</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"已取消节流"</span>);
}, <span class="hljs-number">2000</span>);
</code></pre>
<h5 data-id="heading-6">更通用的类实现（同时支持防抖和节流）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimiter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">func, wait, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span> = func;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span> = wait;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mode</span> = options.<span class="hljs-property">mode</span> || <span class="hljs-string">"throttle"</span>; <span class="hljs-comment">// 'throttle' 或 'debounce'</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">leading</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">trailing</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">maxWait</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 最大等待时间 (防抖专用)</span>
    };
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>, options);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastCallTime</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span> = args;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastCallTime</span> = now;

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mode</span> === <span class="hljs-string">"debounce"</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_debounce</span>(now);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_throttle</span>(now);
    }
  }

  <span class="hljs-title function_">_debounce</span>(<span class="hljs-params">now</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>) <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);

    <span class="hljs-comment">// 计算延迟</span>
    <span class="hljs-keyword">let</span> delay = <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span>;

    <span class="hljs-comment">// 检查是否需要立即执行</span>
    <span class="hljs-keyword">const</span> callNow = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">leading</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>;

    <span class="hljs-keyword">if</span> (callNow) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = now;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">if</span> (!callNow || <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">trailing</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
      }
    }, delay);
  }

  <span class="hljs-title function_">_throttle</span>(<span class="hljs-params">now</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">leading</span> === <span class="hljs-literal">false</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = now;
    }

    <span class="hljs-keyword">const</span> remaining = <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span> - (now - <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span>);

    <span class="hljs-keyword">if</span> (remaining &lt;= <span class="hljs-number">0</span> || remaining &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>) {
        <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = now;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">trailing</span> !== <span class="hljs-literal">false</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">leading</span> === <span class="hljs-literal">false</span> ? <span class="hljs-number">0</span> : <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
      }, remaining);
    }
  }

  <span class="hljs-title function_">cancel</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">flush</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
    }
  }

  <span class="hljs-title function_">pending</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> !!<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> limiter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RateLimiter</span>(
  <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${msg}</span> at <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>),
  <span class="hljs-number">1000</span>,
  { <span class="hljs-attr">mode</span>: <span class="hljs-string">"throttle"</span> } <span class="hljs-comment">// 或 'debounce'</span>
);

<span class="hljs-comment">// 切换模式</span>
limiter.<span class="hljs-property">mode</span> = <span class="hljs-string">"debounce"</span>;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[防抖（Debounce）]]></title>    <link>https://juejin.cn/post/7579101504289554486</link>    <guid>https://juejin.cn/post/7579101504289554486</guid>    <pubDate>2025-12-02T15:19:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579101504289554486" data-draft-id="7579256547789029417" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="防抖（Debounce）"/> <meta itemprop="keywords" content="前端,JavaScript,ECMAScript 6"/> <meta itemprop="datePublished" content="2025-12-02T15:19:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024肥宅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            防抖（Debounce）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024肥宅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T15:19:34.000Z" title="Tue Dec 02 2025 15:19:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">防抖（Debounce）</h3>
<p>防抖：在事件被触发 n 秒后再执行回调，如果在这 n 秒内又被触发，则重新计时。</p>
<h5 data-id="heading-1">应用场景</h5>
<ul>
<li>搜索框输入(等待用户输入完成后再搜索)</li>
<li>窗口大小调整(调整完成后计算布局)</li>
<li>表单验证(输入完成后验证)</li>
</ul>
<h5 data-id="heading-2">基础版本</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, wait</span>) {
  <span class="hljs-keyword">let</span> timeout;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">const</span> args = <span class="hljs-variable language_">arguments</span>;

    <span class="hljs-built_in">clearTimeout</span>(timeout);
    timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      func.<span class="hljs-title function_">apply</span>(context, args);
    }, wait);
  };
}

</code></pre>
<h5 data-id="heading-3">立即执行版本(先执行一次，再防抖)</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, wait, imediate</span>) {
  <span class="hljs-keyword">let</span> timeout;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">const</span> args = <span class="hljs-variable language_">arguments</span>;

    <span class="hljs-keyword">if</span> (timeout) <span class="hljs-built_in">clearTimeout</span>(timeout);

    <span class="hljs-keyword">if</span> (imediate) {
      <span class="hljs-comment">// 如果已经执行过了，不再执行</span>
      <span class="hljs-keyword">const</span> callNow = !timeout;
      timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        timeout = <span class="hljs-literal">null</span>;
      }, wait);

      <span class="hljs-keyword">if</span> (callNow) {
        func.<span class="hljs-title function_">apply</span>(context, args);
      }
    } <span class="hljs-keyword">else</span> {
      timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        func.<span class="hljs-title function_">apply</span>(context, args);
      }, wait);
    }
  };
}

</code></pre>
<h5 data-id="heading-4">带返回值版本(需要<code>Promise</code>)</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, wait, immediate</span>) {
  <span class="hljs-keyword">let</span> timeout, result;
  <span class="hljs-keyword">const</span> debounced = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">const</span> args = <span class="hljs-variable language_">arguments</span>;

    <span class="hljs-keyword">if</span> (timeout) <span class="hljs-built_in">clearTimeout</span>(timeout);

    <span class="hljs-keyword">if</span> (immediate) {
      <span class="hljs-keyword">const</span> callNow = !timeout;
      timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        timeout = <span class="hljs-literal">null</span>;
      }, wait);

      <span class="hljs-keyword">if</span> (callNow) {
        result = func.<span class="hljs-title function_">apply</span>(context, args);
      }
    } <span class="hljs-keyword">else</span> {
      timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        func.<span class="hljs-title function_">apply</span>(context, args);
      }, wait);
    }

    <span class="hljs-keyword">return</span> result;
  };

  debounced.<span class="hljs-property">cancel</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearTimeout</span>(timeout);
    timeout = <span class="hljs-literal">null</span>;
  };

  <span class="hljs-keyword">return</span> debounced;
}

</code></pre>
<h5 data-id="heading-5">ES6版本</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Debouncer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">func, wait, immediate = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span> = func;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span> = wait;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">immediate</span> = immediate;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>) <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">immediate</span>) {
      <span class="hljs-keyword">const</span> callNow = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
      }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span>);

      <span class="hljs-keyword">if</span> (callNow) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(context, args);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(context, args);
      }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>;
  }

  <span class="hljs-title function_">cancel</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-title function_">flush</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>;
    }
  }
}

<span class="hljs-keyword">const</span> debouncer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Debouncer</span>(<span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"防抖执行:"</span>, msg, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
}, <span class="hljs-number">1000</span>);

<span class="hljs-comment">// 快速调用</span>
debouncer.<span class="hljs-title function_">execute</span>(<span class="hljs-string">"队列消息1"</span>);
debouncer.<span class="hljs-title function_">execute</span>(<span class="hljs-string">"队列消息2"</span>);
debouncer.<span class="hljs-title function_">execute</span>(<span class="hljs-string">"队列消息3"</span>); <span class="hljs-comment">// 只有这个会执行</span>
</code></pre>
<h5 data-id="heading-6">更通用的类实现（同时支持防抖和节流）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimiter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">func, wait, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span> = func;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span> = wait;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mode</span> = options.<span class="hljs-property">mode</span> || <span class="hljs-string">"throttle"</span>; <span class="hljs-comment">// 'throttle' 或 'debounce'</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">leading</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">trailing</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">maxWait</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 最大等待时间 (防抖专用)</span>
    };
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>, options);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastCallTime</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span> = args;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastCallTime</span> = now;

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">mode</span> === <span class="hljs-string">"debounce"</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_debounce</span>(now);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_throttle</span>(now);
    }
  }

  <span class="hljs-title function_">_debounce</span>(<span class="hljs-params">now</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>) <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);

    <span class="hljs-comment">// 计算延迟</span>
    <span class="hljs-keyword">let</span> delay = <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span>;

    <span class="hljs-comment">// 检查是否需要立即执行</span>
    <span class="hljs-keyword">const</span> callNow = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">leading</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>;

    <span class="hljs-keyword">if</span> (callNow) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = now;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">if</span> (!callNow || <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">trailing</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
      }
    }, delay);
  }

  <span class="hljs-title function_">_throttle</span>(<span class="hljs-params">now</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">leading</span> === <span class="hljs-literal">false</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = now;
    }

    <span class="hljs-keyword">const</span> remaining = <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span> - (now - <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span>);

    <span class="hljs-keyword">if</span> (remaining &lt;= <span class="hljs-number">0</span> || remaining &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">wait</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>) {
        <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = now;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">trailing</span> !== <span class="hljs-literal">false</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">leading</span> === <span class="hljs-literal">false</span> ? <span class="hljs-number">0</span> : <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
      }, remaining);
    }
  }

  <span class="hljs-title function_">cancel</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">previous</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">flush</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>) {
      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = <span class="hljs-literal">null</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">func</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">args</span>);
    }
  }

  <span class="hljs-title function_">pending</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> !!<span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> limiter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RateLimiter</span>(
  <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${msg}</span> at <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>),
  <span class="hljs-number">1000</span>,
  { <span class="hljs-attr">mode</span>: <span class="hljs-string">"throttle"</span> } <span class="hljs-comment">// 或 'debounce'</span>
);

<span class="hljs-comment">// 切换模式</span>
limiter.<span class="hljs-property">mode</span> = <span class="hljs-string">"debounce"</span>;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Android 进阶】别再强转 Context 了！手把手教你优雅解耦 View 与 Activity]]></title>    <link>https://juejin.cn/post/7579142750407245850</link>    <guid>https://juejin.cn/post/7579142750407245850</guid>    <pubDate>2025-12-02T15:24:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579142750407245850" data-draft-id="7579068270294958106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Android 进阶】别再强转 Context 了！手把手教你优雅解耦 View 与 Activity"/> <meta itemprop="keywords" content="Android Studio,Android"/> <meta itemprop="datePublished" content="2025-12-02T15:24:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="城堡修炼者"/> <meta itemprop="url" content="https://juejin.cn/user/2379804202775341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Android 进阶】别再强转 Context 了！手把手教你优雅解耦 View 与 Activity
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2379804202775341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    城堡修炼者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T15:24:35.000Z" title="Tue Dec 02 2025 15:24:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 开发中，我们经常遇到这样的场景：在一个复杂的自定义 View（比如悬浮面板）里，用户点击关闭按钮，我们需要关闭当前的 Activity。</p>
<p>最直觉（也是最初级）的写法往往是这样的：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">// ❌ 反面教材：强耦合写法</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCloseBtnClick</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 直接把 Context 强转成 Activity</span>
    <span class="hljs-keyword">val</span> activity = context <span class="hljs-keyword">as</span>? Activity
    activity?.finish()
}
</code></pre>
<p>这段代码虽然能跑，但它有两个致命问题：</p>
<ol>
<li><strong>强耦合：</strong> 这个 View 彻底依赖了 Activity。如果我想把它放到 Fragment 或者 Dialog 里，这行代码就废了。</li>
<li><strong>崩溃隐患：</strong> 如果 View 的 Context 被 <code>ContextWrapper</code> 包了一层（比如用了换肤库或 Hilt），强转可能会失败甚至导致 Crash。</li>
<li><strong>时序错乱：</strong> 如果 View 还有关闭动画（比如收起面板），直接 <code>finish()</code> 会导致动画还没播完页面就没了，体验极差。</li>
</ol>
<h2 data-id="heading-0">如何解决这个问题？</h2>
<h3 data-id="heading-1">第一步</h3>
<p><em>（核心概念：View 只负责“通知”，不负责“决策”）</em></p>
<p>要解耦，核心思想是 <strong>Inversion of Control (控制反转)</strong> 。View 不应该命令 Activity 去死（finish），View 应该只是告诉 Activity：“我这边完事了”。</p>
<p>我们可以利用 Kotlin 的高阶函数（Lambda）来实现：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">
<span class="hljs-comment">// ✅ 进阶写法：使用回调</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultPanelView</span>(context: Context, attrs: AttributeSet?) : FrameLayout(context, attrs) {

    <span class="hljs-comment">// 定义一个回调，告知外部“我想关闭了”</span>
    <span class="hljs-keyword">var</span> onRequestClose: (() -&gt; <span class="hljs-built_in">Unit</span>)? = <span class="hljs-literal">null</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">triggerClose</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// ... 执行内部逻辑 ...</span>
        <span class="hljs-comment">// 通知外部，至于外部是 finish 还是 popBackStack，View 不关心</span>
        onRequestClose?.invoke()
    }
}
</code></pre>
<p><strong>在 Activity 中使用：</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">resultView.onRequestClose = {
    <span class="hljs-comment">// Activity 拿回了控制权</span>
    finish()
}
</code></pre>
<h3 data-id="heading-2">第二步</h3>
<p>很多时候，我们的 View 是一个悬浮面板，关闭时有一个“下沉”或“淡出”的动画。如果直接在点击事件里回调 <code>finish()</code>，动画会被直接截断。</p>
<p>这里需要引入<strong>状态流</strong>和<strong>动画监听</strong>的概念：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FloatingResultView</span>(...) : FrameLayout(...) {

    <span class="hljs-comment">// 专门的回调：当 View 彻底“消失”后触发</span>
    <span class="hljs-keyword">var</span> onDismissComplete: (() -&gt; <span class="hljs-built_in">Unit</span>)? = <span class="hljs-literal">null</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dismiss</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 1. 先播放动画</span>
        <span class="hljs-keyword">this</span>.animate()
            .translationY(height.toFloat())
            .setDuration(<span class="hljs-number">300</span>)
            .withEndAction {
                <span class="hljs-comment">// 2. 动画播完了，再通知外部</span>
                onDismissComplete?.invoke()
            }
            .start()
    }
}
</code></pre>
<p>这样，Activity 里的 <code>finish()</code> 实际上是在动画结束后才执行的，用户体验会非常丝滑（Silky Smooth）。</p>
<h2 data-id="heading-3">总结</h2>
<p>从 <code>(context as Activity).finish()</code> 到 回调，这不仅仅是代码行数的变化，更是思维模式的转变：</p>
<ol>
<li><strong>从“命令式”到“响应式”</strong> ：View 不再指挥 Activity，而是通过回调暴露状态。</li>
<li><strong>关注点分离</strong>：View 负责展示和动画，Activity 负责业务流转和页面栈管理。</li>
<li><strong>健壮性</strong>：解耦后的 View 可以移植到任何地方，再也不用担心 Context 类型不对了。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d00bc756d1d34dd6bd94783578c32c71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5aCh5L-u54K86ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765294489&amp;x-signature=%2BfEE6NUHs7wQ8FQZGJpXHQaC5JY%3D" alt="Generated_Image_7tpf8m7tpf8m7tpf.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年IaC生态全景与实践指南：从工具选型到多云治理]]></title>    <link>https://juejin.cn/post/7579094978681978926</link>    <guid>https://juejin.cn/post/7579094978681978926</guid>    <pubDate>2025-12-02T15:40:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579094978681978926" data-draft-id="7579142750407295002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年IaC生态全景与实践指南：从工具选型到多云治理"/> <meta itemprop="keywords" content="后端,自动化运维,云计算"/> <meta itemprop="datePublished" content="2025-12-02T15:40:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kaliarch"/> <meta itemprop="url" content="https://juejin.cn/user/976022055951582"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年IaC生态全景与实践指南：从工具选型到多云治理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022055951582/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kaliarch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T15:40:18.000Z" title="Tue Dec 02 2025 15:40:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fiac-landscape.github.io%2F" target="_blank" title="https://iac-landscape.github.io/" ref="nofollow noopener noreferrer">IaC Landscape</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/982961e58c3a42ada527a2bd78693fd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2FsaWFyY2g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765294818&amp;x-signature=%2BQCYdVFJ8Esy1iTB0%2FFtZu7%2F%2BYY%3D" alt="image.png" loading="lazy"/>
在多云架构成为主流的今天，80%的企业已采用多云部署（腾讯云2025年IaC报告），但手动配置、环境不一致、安全漏洞等问题仍困扰着运维团队。基础设施即代码（Infrastructure as Code, IaC）作为解决这些痛点的核心技术，已从“可选方案”变为“必选项”。本文将基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fiac-landscape.github.io%2F" target="_blank" title="https://iac-landscape.github.io/" ref="nofollow noopener noreferrer">IaC Landscape生态图</a>与2025年最新行业数据，系统解析IaC的核心价值、工具生态、行业趋势及落地路径，为技术团队提供从认知到实践的完整参考。</p>
<h2 data-id="heading-0">一、IaC核心：重新定义基础设施管理逻辑</h2>
<h3 data-id="heading-1">1.1 本质：用代码思维管理基建</h3>
<p>IaC的核心是<strong>将服务器、网络、数据库等基础设施通过机器可读的配置文件定义</strong>，替代传统的手动点击控制台、SSH登录服务器或Excel记录配置的方式（Mad Devs, 2025）。例如，通过Terraform的HCL代码定义“1台2核4G的AWS EC2实例+PostgreSQL数据库”，执行命令后工具将自动完成资源创建，无需人工干预。</p>
<p>这种模式的本质是“<strong>基础设施软件化</strong>”——将基建视为代码，复用版本控制、代码审查、自动化测试等软件工程实践。正如HashiCorp所强调的：“IaC让基础设施拥有与应用代码相同的可追溯性、可复用性和可测试性”。</p>
<h3 data-id="heading-2">1.2 核心价值：解决运维的三大核心痛点</h3>
<p>根据SentinelOne 2025年分析，IaC的价值集中体现在三个维度：</p>
<ul>
<li><strong>一致性</strong>：通过标准化配置文件，消除“开发环境能跑、生产环境报错”的问题，环境复制效率提升80%以上；</li>
<li><strong>自动化</strong>：将基础设施部署时间从小时级缩短至分钟级，例如用Ansible自动化100台服务器的Java环境安装，替代人工操作；</li>
<li><strong>可追溯性</strong>：所有基建变更记录在Git中，支持版本回滚，故障排查时间缩短60%（腾讯云数据）。</li>
</ul>
<h3 data-id="heading-3">1.3 两种范式：声明式与命令式的选择</h3>
<p>IaC工具分为两类核心范式，需根据场景选择：</p>
<ul>
<li><strong>声明式</strong>（主流）：仅定义“期望状态”，工具自动计算与当前状态的差异并执行。例如Terraform、AWS CloudFormation，适合多云场景与复杂基建；</li>
<li><strong>命令式</strong>：定义“具体执行步骤”，如Shell脚本、Ansible Playbook（部分场景），适合简单的配置管理（如安装软件）。</li>
</ul>
<p>2025年数据显示，78%的企业优先选择声明式工具（SentinelOne），因其更符合多云环境下的“状态一致性”需求。</p>
<h2 data-id="heading-4">二、IaC生态全景：工具分类与核心选型指南</h2>
<p>基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fiac-landscape.github.io%2F" target="_blank" title="https://iac-landscape.github.io/" ref="nofollow noopener noreferrer">IaC Landscape生态图</a>，IaC工具可分为6大核心层级，各层级工具协同实现“基建全生命周期管理”。</p>
<h3 data-id="heading-5">2.1 基础支撑层：云厂商与核心组件</h3>
<p>此层级是IaC的“地基”，包括云平台、数据库、中间件等基础设施组件：</p>
<ul>
<li><strong>云厂商</strong>：AWS、Microsoft Azure、腾讯云、华为云、Oracle，提供原生IaC工具（如AWS CloudFormation、Azure ARM模板）；</li>
<li><strong>数据库</strong>：MySQL、PostgreSQL（关系型）、Redis（缓存）、MongoDB（文档型），需通过IaC工具自动化部署与配置；</li>
<li><strong>中间件</strong>：Kafka（消息队列）、Elasticsearch（检索），通常与容器化工具（Docker、Helm）结合使用。</li>
</ul>
<p><strong>选型建议</strong>：优先选择与现有云厂商兼容的组件，例如AWS用户可优先使用RDS数据库，降低跨平台适配成本。</p>
<h3 data-id="heading-6">2.2 核心编排层：IaC平台工具对比</h3>
<p>此层级是IaC的“核心引擎”，负责基础设施的创建与管理，2025年工具格局已从“Terraform独大”转向“多工具竞争”：</p>









































<table><thead><tr><th>工具</th><th>核心特性</th><th>适用场景</th><th>局限性</th></tr></thead><tbody><tr><td>Terraform</td><td>多云支持（100+提供商）、HCL语法、状态管理</td><td>复杂多云环境、大型基建编排</td><td>开源协议变更（2024年）、学习成本高</td></tr><tr><td>OpenTofu</td><td>100%兼容Terraform、Apache 2.0协议</td><td>Terraform迁移用户、开源团队</td><td>生态成熟度待提升</td></tr><tr><td>Pulumi</td><td>支持Python/JS/Go等编程语言、无状态管理</td><td>开发团队主导的IaC、应用与基建协同</td><td>多云支持广度略逊于Terraform</td></tr><tr><td>AWS CloudFormation</td><td>AWS原生支持、深度集成AWS服务</td><td>纯AWS环境、企业级合规需求</td><td>不支持跨云</td></tr><tr><td>Crossplane</td><td>基于Kubernetes CRD、声明式API</td><td>云原生团队、K8s生态用户</td><td>学习曲线陡峭</td></tr></tbody></table>
<p><strong>趋势洞察</strong>：腾讯云2025年报告显示，Terraform使用率从2024年的60%降至52%，OpenTofu（28%）与Pulumi（21%）快速崛起，企业开始根据“开源协议安全性”“团队技术栈”选择工具。</p>
<h3 data-id="heading-7">2.3 配置管理层：自动化运维的“装修工具”</h3>
<p>若说核心编排层是“建房子”，配置管理层就是“装修房子”——负责服务器内部的软件安装、系统配置：</p>
<ul>
<li><strong>Ansible</strong>：无客户端架构（基于SSH）、YAML语法，适合自动化软件部署（如Nginx安装）、系统参数调整，是中小企业首选；</li>
<li><strong>Chef/Puppet</strong>：需安装客户端，支持复杂配置逻辑，适合大型企业的标准化运维；</li>
<li><strong>SaltStack</strong>：基于Python，兼顾配置管理与远程执行，性能优于Ansible，适合大规模集群（1000+节点）。</li>
</ul>
<p><strong>实践建议</strong>：中小团队优先用Ansible（学习成本低），大型企业可结合Chef的“基础设施即代码+合规检查”能力。</p>
<h3 data-id="heading-8">2.4 安全与成本层：基建的“防护盾”与“节流阀”</h3>
<p>2025年，安全与成本已成为IaC落地的核心考量（45%企业将安全列为首要挑战，腾讯云数据），关键工具包括：</p>
<ul>
<li><strong>安全工具</strong>：
<ul>
<li>Checkov（Bridgecrew）：静态扫描IaC代码漏洞（如公网访问未限制）；</li>
<li>HashiCorp Vault：管理密钥、证书，避免明文存储；</li>
<li>GitGuardian：检测Git仓库中的敏感信息（如AWS密钥）；</li>
</ul>
</li>
<li><strong>成本工具</strong>：
<ul>
<li>Spot：自动选择云厂商“竞价实例”，降低50%计算成本；</li>
<li>Harness：监控多云资源使用率，识别闲置服务器（如未使用的EC2实例）。</li>
</ul>
</li>
</ul>
<p><strong>最佳实践</strong>：将Checkov集成到CI/CD流水线（如GitHub Actions），实现“代码提交→自动扫描→漏洞阻断”的闭环。</p>
<h3 data-id="heading-9">2.5 协作与可视化层：提升团队效率</h3>
<p>此层级工具解决“IaC协作效率”与“基建透明度”问题：</p>
<ul>
<li><strong>CI/CD工具</strong>：GitHub Actions、GitLab CI、Azure DevOps、阿里云云效，实现“代码提交→Terraform plan→apply”自动化，减少手动操作（目前55%企业已落地，仍有30%手动部署Terraform）；</li>
<li><strong>可视化工具</strong>：
<ul>
<li>infraMap：生成IaC资源依赖图（如“EC2→RDS→S3”的关联关系）；</li>
<li>Blast Radius：可视化Terraform变更影响范围，避免“牵一发而动全身”；</li>
</ul>
</li>
<li><strong>状态管理工具</strong>：Terraform Cloud、Spacelift，解决多团队协作时的“状态文件冲突”问题。</li>
</ul>
<h2 data-id="heading-10">三、2025年IaC行业趋势：数据背后的挑战与机遇</h2>
<h3 data-id="heading-11">3.1 多云复杂度飙升，治理成关键痛点</h3>
<p>80%的企业已采用多云部署（腾讯云2025报告），但50%以上的企业面临“多云配置不一致”“成本无法统一监控”的问题。例如，AWS的安全组规则与腾讯云的安全组语法不同，需维护两套IaC代码，增加管理成本。</p>
<p><strong>应对方向</strong>：选择跨云IaC工具（如Terraform、OpenTofu），并建立“多云治理中心”，统一配置标准与成本监控规则。</p>
<h3 data-id="heading-12">3.2 IaC采用率高但覆盖不足，遗留资产成“盲区”</h3>
<p>72%的企业已使用IaC，但仅1/3的企业实现“75%以上基建代码化”（腾讯云数据），未覆盖的部分多为遗留系统（如十年前手动部署的数据库）。这些“盲区”成为故障高发区——2024年因遗留资产配置错误导致的故障占比达38%。</p>
<p><strong>应对方向</strong>：分阶段迁移遗留资产，先用infraMap等工具梳理现有基建，再用Terraform导入存量资源，逐步实现“全基建代码化”。</p>
<h3 data-id="heading-13">3.3 工具格局生变：Terraform遇挑战，新势力崛起</h3>
<p>Terraform的主导地位受到冲击：</p>
<ul>
<li>开源协议变更（2024年从MPL 2.0改为BUSL 1.1）导致部分企业担忧“商用限制”，转向OpenTofu（100%兼容且开源）；</li>
<li>Pulumi凭借“支持Python/JS等开发语言”吸引大量开发团队，2025年使用率同比提升120%（SentinelOne）。</li>
</ul>
<p><strong>选型建议</strong>：新项目可尝试OpenTofu（开源无风险）或Pulumi（开发友好）；存量Terraform项目暂无需迁移，但需评估协议对商用场景的影响。</p>
<h3 data-id="heading-14">3.4 AI融入IaC：从“自动化”到“智能化”</h3>
<p>2025年IaC的重要趋势是AI的应用：</p>
<ul>
<li>工具层面：Terraform Cloud推出“AI配置生成”功能，输入自然语言（如“创建1台2核4G的EC2”）即可生成HCL代码；</li>
<li>运维层面：AI监控基建漂移（如实际资源与代码不一致），提前预警潜在风险，故障预测准确率达75%（腾讯云数据）。</li>
</ul>
<h2 data-id="heading-15">四、IaC落地实践指南：从0到1的关键步骤</h2>
<h3 data-id="heading-16">4.1 起步：从隔离场景切入，降低试错成本</h3>
<p>避免一开始就对生产环境下手，建议选择“开发环境初始化”“测试环境部署”等隔离场景：</p>
<ul>
<li>示例：用Ansible写一个Playbook，自动化开发环境的MySQL安装与配置；</li>
<li>目标：熟悉工具语法，建立“代码提交→自动化部署”的流程，积累团队信心。</li>
</ul>
<h3 data-id="heading-17">4.2 选型：按需组合工具，拒绝“一刀切”</h3>
<p>根据场景组合工具，例如“多云基建编排”场景的工具链：</p>
<ol>
<li>核心编排：OpenTofu（多云支持、开源）；</li>
<li>配置管理：Ansible（自动化软件安装）；</li>
<li>安全扫描：Checkov（提交代码时扫描漏洞）；</li>
<li>CI/CD：GitHub Actions（自动化部署流程）；</li>
<li>可视化：infraMap（展示资源依赖）。</li>
</ol>
<h3 data-id="heading-18">4.3 治理：建立权责体系，规避混乱风险</h3>
<p>IaC民主化（人人可提交基建代码）可能导致混乱，需提前建立治理规则：</p>
<ul>
<li>权限控制：通过GitLab CI限制“谁能执行apply操作”（如仅运维团队有权限）；</li>
<li>审批流程：基建变更需经过代码审查（至少1人Approval），避免误操作；</li>
<li>合规检查：集成Open Policy Agent（OPA），强制实施安全规则（如“禁止开放22端口给公网”）。</li>
</ul>
<h3 data-id="heading-19">4.4 优化：持续监控与成本管控</h3>
<p>落地后需持续优化：</p>
<ul>
<li>监控基建漂移：用Terraform Cloud的“漂移检测”功能，每周扫描实际资源与代码的一致性；</li>
<li>成本优化：用Spot选择竞价实例，用Harness识别闲置资源，目标降低30%云成本；</li>
<li>文档沉淀：将工具使用规范、常见问题整理成文档，降低团队学习成本。</li>
</ul>
<h2 data-id="heading-20">结语：IaC不是工具，而是运维思维的变革</h2>
<p>IaC的价值不仅在于“自动化部署”，更在于将“软件工程思维”融入基础设施管理，实现“基建可代码化、可测试化、可追溯化”。2025年，随着多云复杂度的提升与AI的融入，IaC将从“运维工具”升级为“企业数字化转型的核心支撑”。</p>
<p>对于技术团队而言，无需追求“一步到位”，而是通过“小步试错、持续优化”的方式落地IaC——从熟悉工具到建立流程，再到全基建代码化，最终实现“基建即产品”的目标。正如IaC Landscape生态图所展示的，丰富的工具生态为不同场景提供了选择，关键是找到适合自身业务的路径。</p>
<p>若你在IaC落地中遇到工具选型、多云治理等问题，欢迎在评论区交流，共同探索高效运维的实践之道。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS MMKV原理整理总结:比UserDefaults快100倍的存储方案是如何炼成的？]]></title>    <link>https://juejin.cn/post/7579066828179816484</link>    <guid>https://juejin.cn/post/7579066828179816484</guid>    <pubDate>2025-12-02T15:41:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579066828179816484" data-draft-id="7578719771588902922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS MMKV原理整理总结:比UserDefaults快100倍的存储方案是如何炼成的？"/> <meta itemprop="keywords" content="架构,算法"/> <meta itemprop="datePublished" content="2025-12-02T15:41:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS MMKV原理整理总结:比UserDefaults快100倍的存储方案是如何炼成的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T15:41:46.000Z" title="Tue Dec 02 2025 15:41:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作为iOS开发者，你一定体验过<code>NSUserDefaults</code>在频繁读写时的性能瓶颈，它在卡顿列表和WatchDog导致的0x8badf0d类型的abort列表中经常看到，而今天要介绍的<strong>MMKV</strong>，以其独特的mmap内存映射和增量更新策略，实现了令人惊艳的存储性能提升,且替代<code>NSUserDefaults</code>后能解决导致的卡顿和abort问题。</p>
</blockquote>
<h2 data-id="heading-0">一、传统存储方案的痛点</h2>
<p>在介绍MMKV之前，让我们先看看iOS开发者常用的几种本地存储方案：</p>
<ul>
<li><strong>NSUserDefaults</strong>：适合简单键值对，但<strong>性能瓶颈明显</strong>，每次写入都需同步到文件</li>
<li><strong>SQLite</strong>：功能强大但使用复杂，对简单键值存储来说<strong>太重了</strong></li>
<li><strong>Core Data</strong>：面向对象但学习曲线陡峭，性能调优困难</li>
<li><strong>直接文件操作</strong>：灵活但需要处理并发、安全、序列化等各种问题</li>
</ul>
<p>这些方案在存储频繁读写的小数据时，要么性能不足，要么使用过于复杂。那么，有没有一种既简单又高效的键值存储方案呢？</p>
<h2 data-id="heading-1">二、MMKV的惊艳表现</h2>
<p>MMKV是腾讯开源的一款高性能键值存储组件，最初为微信开发，用于解决跨平台、高性能的本地存储需求。让我们通过一个简单测试来看它的性能优势：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 性能对比测试</span>
<span class="hljs-keyword">let</span> testCount <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>

<span class="hljs-comment">// NSUserDefaults测试</span>
<span class="hljs-keyword">let</span> defaults <span class="hljs-operator">=</span> <span class="hljs-type">UserDefaults</span>.standard
<span class="hljs-keyword">let</span> startTime1 <span class="hljs-operator">=</span> <span class="hljs-type">CACurrentMediaTime</span>()
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span>testCount {
    defaults.set(<span class="hljs-string">"value<span class="hljs-subst">\(i)</span>"</span>, forKey: <span class="hljs-string">"key<span class="hljs-subst">\(i)</span>"</span>)
    defaults.synchronize() <span class="hljs-comment">// 强制同步到文件</span>
}
<span class="hljs-keyword">let</span> userDefaultsTime <span class="hljs-operator">=</span> <span class="hljs-type">CACurrentMediaTime</span>() <span class="hljs-operator">-</span> startTime1

<span class="hljs-comment">// MMKV测试</span>
<span class="hljs-keyword">let</span> mmkv <span class="hljs-operator">=</span> <span class="hljs-type">MMKV</span>.default()<span class="hljs-operator">!</span>
<span class="hljs-keyword">let</span> startTime2 <span class="hljs-operator">=</span> <span class="hljs-type">CACurrentMediaTime</span>()
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span>testCount {
    mmkv.set(<span class="hljs-string">"value<span class="hljs-subst">\(i)</span>"</span>, forKey: <span class="hljs-string">"key<span class="hljs-subst">\(i)</span>"</span>)
}
<span class="hljs-keyword">let</span> mmkvTime <span class="hljs-operator">=</span> <span class="hljs-type">CACurrentMediaTime</span>() <span class="hljs-operator">-</span> startTime2

<span class="hljs-built_in">print</span>(<span class="hljs-string">"NSUserDefaults耗时：<span class="hljs-subst">\(userDefaultsTime)</span>秒"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"MMKV耗时：<span class="hljs-subst">\(mmkvTime)</span>秒"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"MMKV比NSUserDefaults快<span class="hljs-subst">\(userDefaultsTime<span class="hljs-operator">/</span>mmkvTime)</span>倍"</span>)
</code></pre>
<p>测试结果显示，在1000次连续写入的场景下，MMKV可以比NSUserDefaults<strong>快几十到上百倍</strong>。那么，这种惊人性能是如何实现的呢？</p>
<h2 data-id="heading-2">三、MMKV核心技术原理揭秘</h2>
<h3 data-id="heading-3">1. 内存映射（mmap）技术</h3>
<p>MMKV性能的核心秘诀在于使用了<strong>mmap（memory mapping）</strong> 技术。传统的文件写入流程是这样的：</p>
<ol>
<li>数据写入应用层缓冲区</li>
<li>数据拷贝到内核缓冲区</li>
<li>内核将数据写入磁盘</li>
</ol>
<p>这个过程涉及<strong>两次数据拷贝</strong>和多次用户态/内核态切换，效率较低。</p>
<p>而mmap的工作方式完全不同：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-comment">// mmap的基本使用方式</span>
<span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(filePath, O_RDWR|O_CREAT, S_IRWXU);
<span class="hljs-type">void</span> *memory = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, size, PROT_READ|PROT_WRITE, MAP_SHARED, fd, <span class="hljs-number">0</span>);
</code></pre>
<p>mmap将磁盘文件<strong>直接映射到进程的虚拟内存空间</strong>，使应用可以像操作内存一样操作文件。对映射内存的读写操作，操作系统会在后台自动同步到磁盘文件。</p>
<p><strong>mmap的优势</strong>：</p>
<ul>
<li><strong>零拷贝</strong>：数据无需在用户空间和内核空间之间来回拷贝</li>
<li><strong>延迟写入</strong>：修改操作先写入内存，由操作系统异步刷盘</li>
<li><strong>崩溃安全</strong>：即使应用崩溃，操作系统也能保证数据持久化</li>
</ul>
<h3 data-id="heading-4">2. 增量更新与追加写入策略</h3>
<p>传统键值存储（如NSUserDefaults）每次写入时，都会<strong>重新序列化整个字典</strong>并写入文件。而MMKV采用了一种聪明的增量更新策略：</p>
<blockquote>
<p>初始文件内容：[KV1, KV2, KV3]</p>
<p>更新key1的值：
传统方式：重新写入[KV1_new, KV2, KV3]</p>
<p>MMKV方式：直接在文件末尾追加[KV1_new]</p>
<p>文件变为：[KV1, KV2, KV3, KV1_new]</p>
</blockquote>
<p>读取时，MMKV会从后向前扫描，<strong>最后出现的键值对就是最新值</strong>。</p>
<h3 data-id="heading-5">3. Protocol Buffers序列化</h3>
<p>MMKV使用Google的<strong>Protocol Buffers</strong>作为序列化协议，相比传统的JSON或Property List格式：</p>
<ul>
<li><strong>编码更紧凑</strong>：二进制格式，体积更小</li>
<li><strong>解析更快</strong>：无需复杂的词法分析</li>
<li><strong>向后兼容</strong>：支持字段增减而不破坏现有数据</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// Protobuf的消息定义
message KVItem {
    optional string <span class="hljs-attr">key</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    optional bytes <span class="hljs-attr">value</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-6">4. 空间重整与扩容机制</h3>
<p>追加写入策略的一个明显问题是文件会无限增长。MMKV通过<strong>空间重整</strong>解决这个问题：</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MMKV</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fullWriteback</span>() {
        <span class="hljs-comment">// 1. 收集所有键值对，每个key只保留最新值</span>
        <span class="hljs-keyword">var</span> newData <span class="hljs-operator">=</span> [<span class="hljs-type">String</span>: <span class="hljs-type">Data</span>]()
        <span class="hljs-keyword">for</span> (key, value) <span class="hljs-keyword">in</span> allKeyValues() {
            newData[key] <span class="hljs-operator">=</span> value.last <span class="hljs-comment">// 只保留最新值</span>
        }
        
        <span class="hljs-comment">// 2. 重新序列化所有数据</span>
        <span class="hljs-keyword">let</span> serializedData <span class="hljs-operator">=</span> serialize(newData)
        
        <span class="hljs-comment">// 3. 如果空间不足，执行扩容</span>
        <span class="hljs-keyword">if</span> serializedData.count <span class="hljs-operator">&gt;</span> currentSize {
            expand(calculateNewSize(serializedData.count))
        }
        
        <span class="hljs-comment">// 4. 将整理后的数据写入文件开头</span>
        writeToBeginning(serializedData)
        
        <span class="hljs-comment">// 5. 截断文件，丢弃旧数据</span>
        truncateFile(serializedData.count)
    }
}
</code></pre>
<p>当文件剩余空间不足时，MMKV会触发空间重整，如果重整后仍空间不足，则按<strong>两倍大小</strong>扩容。</p>
<h3 data-id="heading-7">5. 多进程与线程安全</h3>
<p>MMKV<strong>通过文件锁和内存重映射实现</strong>多进程访问数据同步，这在iOS扩展（如Today Extension、Share Extension等）中特别有用：</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">// 多进程初始化</span>
<span class="hljs-type">MMKV</span> <span class="hljs-operator">*</span>mmkv <span class="hljs-operator">=</span> [<span class="hljs-type">MMKV</span> mmkvWithID:@<span class="hljs-string">"shared_mmkv"</span> 
                  cryptKey:cryptKey
                  mode:<span class="hljs-type">MMKVMultiProcess</span>];

<span class="hljs-comment">// 进程A写入数据</span>
[mmkv setObject:@(<span class="hljs-number">42</span>) forKey:@<span class="hljs-string">"shared_key"</span>];

<span class="hljs-comment">// 进程B读取数据（立即生效）</span>
<span class="hljs-type">NSNumber</span> <span class="hljs-operator">*</span>value <span class="hljs-operator">=</span> [mmkv getObjectOfClass:<span class="hljs-type">NSNumber</span>.class 
                                  forKey:@<span class="hljs-string">"shared_key"</span>];
</code></pre>
<p>内部通过<strong>文件锁（fcntl）</strong> 和<strong>读写锁（pthread_rwlock）</strong> 保证数据一致性：</p>
<ul>
<li><strong>进程间同步</strong>：使用文件锁</li>
<li><strong>线程间同步</strong>：使用读写锁（读共享，写独占）</li>
</ul>
<h2 data-id="heading-8">四、MMKV架构全貌</h2>
<p>为了更好地理解MMKV各组件如何协同工作，让我们看一下其整体架构图：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[应用层调用] --&gt; B[MMKV C++ Core]
    
    B --&gt; C{操作类型}
    C --&gt;|读操作| D[Memory Map&lt;br/&gt;内存映射]
    C --&gt;|写操作| E[Protobuf序列化]
    
    D --&gt; F[查找算法]
    F --&gt; G[从后向前扫描&lt;br/&gt;获取最新值]
    G --&gt; H[返回数据给应用层]
    
    E --&gt; I[追加写入]
    I --&gt; J{空间检查}
    J --&gt;|空间足够| K[写入mmap内存]
    J --&gt;|空间不足| L[触发空间重整]
    
    L --&gt; M[Key排重&lt;br/&gt;保留最新值]
    M --&gt; N{重整后空间是否足够}
    N --&gt;|是| O[写入文件头部]
    N --&gt;|否| P[文件扩容&lt;br/&gt;2倍增长]
    P --&gt; O
    
    K --&gt; Q[操作系统异步刷盘]
    O --&gt; Q
    
    R[CRC校验] --&gt; S[数据完整性保证]
    Q --&gt; S
    
</code></pre>
<p>从这个架构图可以看出，MMKV的设计哲学是：</p>
<ol>
<li><strong>读操作优先</strong>：通过内存映射和高效查找，实现O(n)复杂度读取</li>
<li><strong>写操作优化</strong>：通过追加写入避免全量重写</li>
<li><strong>空间智能管理</strong>：自动重整和扩容，平衡空间和性能</li>
<li><strong>数据安全保障</strong>：CRC-32算法校验确保数据完整性，MMKV在文件末尾存储了一个<strong>循环冗余校验码</strong>。这个值是文件<strong>所有有效数据</strong>通过CRC算法计算出的一个摘要。</li>
</ol>
<h2 data-id="heading-9">五、实际应用场景与最佳实践</h2>
<h3 data-id="heading-10">1. 何时使用MMKV？</h3>
<ul>
<li><strong>用户偏好设置</strong>：主题、字体大小等配置</li>
<li><strong>登录状态与Token</strong>：需要快速读写的认证信息</li>
<li><strong>应用标记位</strong>：首次启动、功能引导完成状态</li>
<li><strong>轻量缓存</strong>：搜索历史、浏览记录等</li>
</ul>
<h3 data-id="heading-11">2. 何时避免使用MMKV？</h3>
<ul>
<li><strong>大量结构化数据</strong>：考虑使用SQLite或Core Data</li>
<li><strong>大型二进制文件</strong>：如图片、视频，应使用文件系统直接存储</li>
<li><strong>需要复杂查询的数据</strong>：MMKV只支持键值查询</li>
</ul>
<h3 data-id="heading-12">3. 使用示例</h3>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">import</span> MMKV

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SettingsManager</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">SettingsManager</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> mmkv: <span class="hljs-type">MMKV</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">init</span>() {
        <span class="hljs-comment">// 初始化MMKV</span>
        <span class="hljs-type">MMKV</span>.initialize(rootDir: <span class="hljs-literal">nil</span>)
        mmkv <span class="hljs-operator">=</span> <span class="hljs-type">MMKV</span>.default()<span class="hljs-operator">!</span>
        
        <span class="hljs-comment">// 多进程共享（用于App Groups）</span>
        <span class="hljs-comment">// let groupDir = MMKV.initialize(rootDir: "your_app_group_path")</span>
        <span class="hljs-comment">// mmkv = MMKV(mmapID: "shared_settings", mode: .multiProcess)</span>
    }
    
    <span class="hljs-comment">// 存储用户设置</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">saveUserSettings</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">settings</span>: <span class="hljs-type">UserSettings</span>) {
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONEncoder</span>().encode(settings)
            mmkv.set(data, forKey: <span class="hljs-string">"user_settings"</span>)
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"保存设置失败: <span class="hljs-subst">\(error)</span>"</span>)
        }
    }
    
    <span class="hljs-comment">// 读取用户设置</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadUserSettings</span>() -&gt; <span class="hljs-type">UserSettings</span>? {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> mmkv.data(forKey: <span class="hljs-string">"user_settings"</span>) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }
        
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">UserSettings</span>.<span class="hljs-keyword">self</span>, from: data)
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"读取设置失败: <span class="hljs-subst">\(error)</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }
    }
    
    <span class="hljs-comment">// 存储简单值</span>
    <span class="hljs-keyword">var</span> darkModeEnabled: <span class="hljs-type">Bool</span> {
        <span class="hljs-keyword">get</span> { mmkv.bool(forKey: <span class="hljs-string">"dark_mode"</span>, defaultValue: <span class="hljs-literal">false</span>) }
        <span class="hljs-keyword">set</span> { mmkv.set(newValue, forKey: <span class="hljs-string">"dark_mode"</span>) }
    }
    
    <span class="hljs-comment">// 加密存储敏感数据</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">saveSecureToken</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">token</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> cryptMMKV <span class="hljs-operator">=</span> <span class="hljs-type">MMKV</span>(mmapID: <span class="hljs-string">"secure_storage"</span>, cryptKey: <span class="hljs-string">"your_encryption_key"</span>.data(using: .utf8)) {
            cryptMMKV.set(token, forKey: <span class="hljs-string">"auth_token"</span>)
        }
    }

    <span class="hljs-comment">// 及时释放不用的MMKV实例</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">cleanupUnusedMMKV</span>() {
        <span class="hljs-type">MMKV</span>.close(mmapID: <span class="hljs-string">"temporary_storage"</span>)
    }
}
</code></pre>
<h3 data-id="heading-13">4. 性能优化技巧</h3>
<ol>
<li><strong>批量写入</strong>：虽然MMKV单次写入很快，但批量操作仍可进一步优化</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 不好的做法：多次单独写入</span>
for item in items {
    mmkv<span class="hljs-selector-class">.set</span>(item.value, forKey: item.key)
}

<span class="hljs-comment">// 好的做法：批量处理</span>
mmkv<span class="hljs-selector-class">.beginTransaction</span>()
defer { mmkv<span class="hljs-selector-class">.commitTransaction</span>() }
for item in items {
    mmkv<span class="hljs-selector-class">.set</span>(item.value, forKey: item.key)
}
</code></pre>
<ol start="2">
<li><strong>合理选择存储类型</strong>：</li>
</ol>
<ul>
<li>简单类型直接存储（Bool、Int、String等）</li>
<li>复杂对象使用JSON或Protobuf序列化</li>
<li>大对象考虑拆分为多个键值存储</li>
</ul>
<h2 data-id="heading-14">六、MMKV的局限性</h2>
<p>虽然MMKV性能卓越，但也存在一些限制：</p>
<ol>
<li><strong>数据大小限制</strong>：单个MMKV实例文件不宜过大（建议不超过几MB）</li>
<li><strong>无查询功能</strong>：只能按键查找，不支持条件查询</li>
<li><strong>iOS版本要求</strong>：需要iOS 9.0+</li>
<li><strong>增加包体积</strong>：增加约200KB左右的二进制大小</li>
</ol>
<h2 data-id="heading-15">七、未来展望</h2>
<p>MMKV仍在持续演进，未来可能的发展方向包括：</p>
<ol>
<li><strong>压缩支持</strong>：对存储内容进行透明压缩</li>
<li><strong>更智能的淘汰策略</strong>：自动清理过期数据</li>
<li><strong>云同步集成</strong>：与iCloud等云服务无缝集成</li>
<li><strong>Swift原生API</strong>：提供更符合Swift习惯的接口</li>
</ol>
<h2 data-id="heading-16">总结</h2>
<p>MMKV通过巧妙结合mmap内存映射、Protobuf序列化和增量更新策略，实现了远超传统方案的存储性能。它的设计哲学是：<strong>为频繁读写的小数据场景提供极致优化</strong>。</p>
<p>对于大多数iOS应用，MMKV是替代NSUserDefaults的理想选择，特别是在需要高性能、多进程共享或简单加密存储的场景。当然，选择存储方案时，还是要根据具体需求：<strong>小数据、高频读写选MMKV；结构化、复杂查询选SQLite；大文件选文件系统</strong>。</p>
<p>希望这篇文章能帮助你深入理解MMKV的工作原理，并在实际项目中合理使用这一强大工具。如果你有任何问题或使用经验分享，欢迎在评论区留言交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[银河麒麟 / aarch64 系统：Docker + Docker Compose 完整安装教程]]></title>    <link>https://juejin.cn/post/7579111646870945843</link>    <guid>https://juejin.cn/post/7579111646870945843</guid>    <pubDate>2025-12-02T15:42:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579111646870945843" data-draft-id="7579096485356240946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="银河麒麟 / aarch64 系统：Docker + Docker Compose 完整安装教程"/> <meta itemprop="keywords" content="后端,架构,程序员"/> <meta itemprop="datePublished" content="2025-12-02T15:42:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cosolar"/> <meta itemprop="url" content="https://juejin.cn/user/184373686834391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            银河麒麟 / aarch64 系统：Docker + Docker Compose 完整安装教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373686834391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cosolar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T15:42:27.000Z" title="Tue Dec 02 2025 15:42:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>适用于：</p>
<ul>
<li>银河麒麟 V10 / Advanced Server</li>
<li>CPU 架构：<code>aarch64</code>（ARM64）</li>
<li>系统基于 RHEL/CentOS 或 openEuler</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-0">🔍 第一步：确认系统信息</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看操作系统</span>
<span class="hljs-built_in">cat</span> /etc/os-release

<span class="hljs-comment"># 查看 CPU 架构（必须是 aarch64）</span>
<span class="hljs-built_in">uname</span> -m
</code></pre>
<p>✅ 正确输出应包含：</p>
<pre><code class="hljs">aarch64
</code></pre>
<hr/>
<h2 data-id="heading-1">🐳 第二步：安装 Docker Engine（如未安装）</h2>
<h3 data-id="heading-2">方法 A：使用官方脚本（推荐，自动适配架构）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载并运行 Docker 官方安装脚本（支持 aarch64）</span>
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

<span class="hljs-comment"># 将当前用户加入 docker 组（避免每次用 sudo）</span>
sudo usermod -aG docker <span class="hljs-variable">$USER</span>

<span class="hljs-comment"># 重新登录或执行以下命令激活组权限</span>
newgrp docker
</code></pre>
<blockquote>
<p>💡 注：<code>get.docker.com</code> 脚本会自动识别 <code>aarch64</code> 并安装对应版本的 Docker。</p>
</blockquote>
<h3 data-id="heading-3">方法 B：手动配置 YUM 源（适用于离线或安全环境）</h3>
<p>如果你不能联网或需使用国产源，请参考银河麒麟官方文档配置 Docker CE 源。此处略。</p>
<hr/>
<h2 data-id="heading-4">🔌 第三步：验证 Docker 是否正常运行</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动并设置开机自启</span>
sudo systemctl <span class="hljs-built_in">enable</span> --now docker

<span class="hljs-comment"># 测试</span>
docker --version
docker run hello-world
</code></pre>
<blockquote>
<p>如果 <code>hello-world</code> 报错，说明 Docker 未正确安装或网络受限，请先解决 Docker 问题。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">🧩 第四步：安装 Docker Compose Plugin（aarch64 版本）</h2>
<h3 data-id="heading-6">1. 创建插件目录</h3>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mkdir</span> -p /usr/local/lib/docker/cli-plugins
</code></pre>
<h3 data-id="heading-7">2. 下载最新版 Docker Compose（ARM64）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置版本（可替换为最新版：https://github.com/docker/compose/releases）</span>
VERSION=<span class="hljs-string">"v2.24.5"</span>

<span class="hljs-comment"># 使用代理加速下载（国内推荐）</span>
sudo curl -L <span class="hljs-string">"https://ghproxy.com/https://github.com/docker/compose/releases/download/<span class="hljs-variable">${VERSION}</span>/docker-compose-linux-aarch64"</span> \
  -o /usr/local/lib/docker/cli-plugins/docker-compose
</code></pre>
<blockquote>
<p>如果你无法访问 GitHub，可提前在其他机器下载后传入。</p>
</blockquote>
<h3 data-id="heading-8">3. 添加执行权限</h3>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">chmod</span> +x /usr/local/lib/docker/cli-plugins/docker-compose
</code></pre>
<h3 data-id="heading-9">4. 验证安装</h3>
<pre><code class="hljs">docker compose version
</code></pre>
<p>✅ 成功输出示例：</p>
<pre><code class="hljs">Docker Compose version v2.24.5
</code></pre>
<hr/>
<h2 data-id="heading-10">🔁 （可选）创建传统 <code>docker-compose</code> 命令别名</h2>
<p>如果你习惯使用 <code>docker-compose</code>（带连字符），可创建软链接：</p>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">ln</span> -s /usr/local/lib/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose
</code></pre>
<p>然后即可使用：</p>
<pre><code class="hljs language-css" lang="css">docker-compose <span class="hljs-attr">--version</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">🧪 第五步：测试 Docker Compose</h2>
<p>创建一个简单测试文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">cat</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">docker-compose.yml</span> <span class="hljs-string">&lt;&lt;EOF</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">alpine</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"Docker Compose on aarch64 works!"</span>
<span class="hljs-string">EOF</span>

<span class="hljs-comment"># 运行</span>
<span class="hljs-string">docker</span> <span class="hljs-string">compose</span> <span class="hljs-string">up</span>
</code></pre>
<p>✅ 输出应包含：</p>
<pre><code class="hljs language-csharp" lang="csharp">test<span class="hljs-number">-1</span>  | Docker Compose <span class="hljs-keyword">on</span> aarch64 works!
</code></pre>
<hr/>
<h2 data-id="heading-12">🧹 清理（可选）</h2>
<pre><code class="hljs language-bash" lang="bash">docker compose down
<span class="hljs-built_in">rm</span> docker-compose.yml
</code></pre>
<hr/>
<h2 data-id="heading-13">✅ 总结</h2>





























<table><thead><tr><th>步骤</th><th>操作</th></tr></thead><tbody><tr><td>1</td><td>确认 <code>uname -m</code> 为 <code>aarch64</code></td></tr><tr><td>2</td><td>安装 Docker（使用 <code>get.docker.com</code> 脚本）</td></tr><tr><td>3</td><td>下载 <strong>ARM64 版本</strong> 的 <code>docker-compose-linux-aarch64</code></td></tr><tr><td>4</td><td>放入 <code>/usr/local/lib/docker/cli-plugins/</code></td></tr><tr><td>5</td><td>使用 <code>docker compose</code> 命令</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">❗ 注意事项</h2>
<ul>
<li>不要尝试 <code>yum install docker-compose-plugin</code> —— 国产系统仓库通常无此包。</li>
<li>不要下载 <code>x86_64</code> 版本，否则会报错：<code>Exec format error</code>。</li>
<li>如遇网络问题，可手动下载 <code>.aarch64</code> 文件后上传到服务器。</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Headless UI详解]]></title>    <link>https://juejin.cn/post/7579096485355978802</link>    <guid>https://juejin.cn/post/7579096485355978802</guid>    <pubDate>2025-12-02T14:14:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579096485355978802" data-draft-id="7579094978681782318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Headless UI详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T14:14:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Headless UI详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:14:11.000Z" title="Tue Dec 02 2025 14:14:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Headless UI 是一种前端组件的设计理念，其核心在于<strong>将组件的交互逻辑（状态、行为）与视觉表现（UI样式、DOM结构）彻底分离</strong>。它为你提供完全无预设样式的“逻辑组件”，你将获得极大的控制粒度来定制其外观，使其完美契合你的设计系统。</p>
<p>为了让你快速把握其精髓，下面这个表格清晰地对比了它与传统UI组件库的主要区别。</p>








































<table><thead><tr><th>特性维度</th><th>传统UI组件库 (如 Ant Design, Element-UI)</th><th>Headless UI</th></tr></thead><tbody><tr><td><strong>核心设计</strong></td><td>提供<strong>预置样式和交互</strong>的完整组件</td><td>仅提供<strong>组件的状态管理与交互逻辑</strong>，不提供样式</td></tr><tr><td><strong>定制灵活性</strong></td><td><strong>相对较低</strong>，深度定制常需复杂覆盖或hack手段</td><td><strong>极高</strong>，视觉层完全自主实现，无默认样式约束</td></tr><tr><td><strong>与样式框架关系</strong></td><td>通常自带设计语言，或与特定样式框架耦合</td><td><strong>样式无关</strong>，可无缝结合任何CSS框架（如Tailwind CSS）或自定义样式</td></tr><tr><td><strong>可访问性支持</strong></td><td>因库而异，质量不一</td><td><strong>通常内置出色的可访问性支持</strong></td></tr><tr><td><strong>适用场景</strong></td><td>快速开发、内部工具、对UI定制要求不高的项目</td><td>品牌化要求高、需要高度定制UI、构建统一设计系统的项目</td></tr><tr><td><strong>包体积</strong></td><td>通常较大（包含样式代码）</td><td><strong>更轻量</strong>（仅包含逻辑代码）</td></tr></tbody></table>
<h3 data-id="heading-0">💡 核心概念与解决痛点</h3>
<p>你可以将Headless UI组件理解为一个<strong>纯粹的逻辑引擎</strong>。它通过Hooks（在React中）或Composition API（在Vue中）等方式，将组件内部的状态（如开关是否开启、下拉菜单是否展开）和控制状态的函数（如切换开关、选择菜单项）提供给你。你的任务是将这些状态和函数“绑定”到自己编写的DOM元素和样式上。</p>
<p>它主要解决了传统组件库在高度定制化场景下的几个核心痛点：</p>
<ul>
<li><strong>样式定制困难</strong>：当产品需要独特的品牌UI时，覆盖传统组件库的预设样式常导致CSS特异性战争（滥用 <code>!important</code>或深层选择器），代码难以维护。</li>
<li><strong>组件API膨胀</strong>：为满足各种定制需求，组件维护者需不断新增API，导致组件API日益复杂，学习成本增高。</li>
<li><strong>逻辑与UI耦合</strong>：传统组件库的逻辑和UI样式常紧密绑定，使得复用组件交互逻辑到不同UI设计上变得困难。</li>
</ul>
<h3 data-id="heading-1">🛠️ 代表性项目</h3>
<p>了解一些流行的Headless UI项目能帮助你更好地理解其应用：</p>
<ul>
<li><strong>Headless UI (由 Tailwind CSS 团队开发)</strong> ：提供了一系列如下拉菜单、开关、模态框等基础组件的无样式版本，与Tailwind CSS集成体验极佳，并内置了完整的可访问性支持。</li>
<li><strong>Radix UI</strong>：提供了一套高质量、可无障碍访问的原始组件，同样是Headless理念的杰出代表，著名的<strong>shadcn/ui</strong>就是基于它构建的。</li>
<li><strong>TanStack Table</strong>：一个非常强大的表格逻辑库，它本身不渲染任何UI，你将完全掌控表格的标签和样式，从而轻松构建复杂的表格交互。</li>
</ul>
<h3 data-id="heading-2">🚀 何时考虑使用</h3>
<p>选择Headless UI通常基于以下考量：</p>
<ul>
<li><strong>当你的项目有强烈的品牌规范</strong>，需要构建独特且一致的UI/UX时。</li>
<li><strong>当你计划构建一个统一的设计系统</strong>，并期望在不同产品线中复用时。</li>
<li><strong>当你的团队具备较强的前端能力</strong>，并且愿意在UI定制上投入更多时间。</li>
<li><strong>当你特别关注应用程序的无障碍访问性时</strong>。</li>
</ul>
<p>反之，如果你的目标是快速搭建原型、开发内部工具或对UI独特性要求不高，成熟的全功能UI库（如Ant Design）可能效率更高。</p>
<h3 data-id="heading-3">💎 总结</h3>
<p>总的来说，Headless UI代表了一种<strong>关注点分离、开放且灵活</strong>的前端组件设计思想。它将最复杂的状态交互逻辑封装起来留给自己，将最大的视觉创造自由留给你。虽然它会带来一定的使用成本，但在追求高度定制化和卓越用户体验的项目中，其价值是传统组件库难以比拟的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Tailwind CSS详解]]></title>    <link>https://juejin.cn/post/7579068270294827034</link>    <guid>https://juejin.cn/post/7579068270294827034</guid>    <pubDate>2025-12-02T14:17:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579068270294827034" data-draft-id="7579093412331585546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Tailwind CSS详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T14:17:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Tailwind CSS详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:17:08.000Z" title="Tue Dec 02 2025 14:17:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Tailwind CSS 是一款功能强大且独特的 <strong>实用工具优先（Utility-First）的 CSS 框架</strong>。它与 Bootstrap 这类提供预置样式组件的框架不同，Tailwind 提供了大量细粒度的、单一功能的工具类（如设置颜色的 <code>text-blue-500</code>、控制内边距的 <code>p-4</code>），让你通过组合这些类来快速构建完全自定义的用户界面 。</p>
<p>为了让你快速抓住精髓，下面这个表格清晰地对比了 Tailwind 与传统 CSS 框架的主要区别。</p>








































<table><thead><tr><th>特性维度</th><th>传统 CSS 框架 (如 Bootstrap)</th><th>Tailwind CSS</th></tr></thead><tbody><tr><td><strong>核心理念</strong></td><td><strong>组件优先</strong>：提供预置样式的 UI 组件（如按钮、卡片）。</td><td><strong>工具类优先</strong>：提供基础的样式工具类，由你自由组合。</td></tr><tr><td><strong>定制灵活性</strong></td><td><strong>相对较低</strong>：深度定制常需覆盖框架原有样式，可能较复杂。</td><td><strong>极高</strong>：从零开始构建，视觉外观完全由你掌控。</td></tr><tr><td><strong>设计约束</strong></td><td>遵循框架自身的设计语言，容易造成网站同质化。</td><td>基于默认设计系统，易于保持视觉一致性，但可完全自定义。</td></tr><tr><td><strong>CSS 文件大小</strong></td><td>通常较大，因为包含了所有组件的样式。</td><td>生产环境下通过 PurgeCSS 优化后通常极小（可小于10KB）。</td></tr><tr><td><strong>学习曲线</strong></td><td>学习使用现成的组件，初期上手快。</td><td>需记忆大量工具类，初期有成本，但熟练后效率极高。</td></tr><tr><td><strong>典型适用场景</strong></td><td>快速开发内部工具、对 UI 独特性要求不高的项目。</td><td>需要高度定制化设计、构建独特品牌形象的项目。</td></tr></tbody></table>
<h3 data-id="heading-0">💡 核心优势与特点</h3>
<p>除了上述对比，Tailwind CSS 还有一些非常突出的优点：</p>
<ul>
<li><strong>高度的可定制性</strong>：你可以通过项目根目录下的 <code>tailwind.config.js</code>文件，轻松自定义整个设计系统的主题色彩、字体、间距、断点等，使其完美匹配你的品牌规范 。</li>
<li><strong>响应式设计轻而易举</strong>：Tailwind 采用移动优先的策略，内置了灵活的响应式断点系统（如 <code>sm:</code>, <code>md:</code>, <code>lg:</code>）。只需在类名前加上相应前缀，即可实现针对不同屏幕尺寸的样式，大大简化了响应式布局的开发 。</li>
<li><strong>强大的状态变体</strong>：你可以直接使用 <code>hover:</code>, <code>focus:</code>, <code>active:</code>等前缀来为元素的不同状态（悬停、聚焦、激活等）设置样式，甚至支持暗色模式（<code>dark:</code>），这让交互效果的实现非常方便 。</li>
<li><strong>卓越的性能表现</strong>：通过配置 PurgeCSS（现代版本已集成此功能），Tailwind 在构建生产版本时会自动移除所有你没有使用过的工具类，最终生成的 CSS 文件体积非常小，有助于提升网站加载速度 。</li>
</ul>
<h3 data-id="heading-1">⚖️ 潜在的考量点</h3>
<p>当然，没有完美的工具，Tailwind CSS 也有一些需要考虑的方面：</p>
<ul>
<li><strong>初期的学习成本</strong>：需要记忆大量的工具类名及其对应的 CSS 属性，对于新手来说，前期可能需要频繁查阅文档 。不过，强大的编辑器插件（如 VS Code 的 Tailwind CSS IntelliSense）可以很好地缓解这个问题，提供智能提示和自动补全 。</li>
<li><strong>HTML 结构可能显得冗杂</strong>：当组件的样式很复杂时，HTML 标签上的 <code>class</code>属性可能会变得很长，影响可读性 。但 Tailwind 也提供了 <code>@apply</code>指令，可以将重复的工具类组合提取成一个自定义的 CSS 类，在需要高度复用时使用 。</li>
</ul>
<h3 data-id="heading-2">🎯 如何选择？</h3>
<p>选择哪种框架取决于你的具体需求和场景：</p>
<ul>
<li><strong>非常适合使用 Tailwind CSS 的情况</strong>：当你需要<strong>高度定制化的设计</strong>、追求<strong>开发效率</strong>（一旦熟悉后）、希望保持<strong>样式的一致性</strong>，并且项目<strong>性能是重要考量</strong>时 。</li>
<li><strong>传统框架可能更合适的情况</strong>：当需要<strong>快速原型开发</strong>、构建<strong>内部管理系统</strong>等对独特视觉设计要求不高的项目，或者团队对 Bootstrap 等框架更熟悉时 。</li>
</ul>
<h3 data-id="heading-3">💎 总结</h3>
<p>总而言之，Tailwind CSS 更像是一套<strong>用于构建设计系统的工具集</strong>，而非一个开箱即用的 UI 组件库。它赋予了开发者极大的自由度和控制力，通过组合原子化的工具类来“组装”出任何你想要的界面。虽然上手需要一些耐心，但它能带来的开发效率、设计一致性以及最终产品的性能优势，使其成为现代前端开发中一个非常受欢迎的选择 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Hadoop+Spark+python毕设】中国租房信息可视化分析系统、计算机毕业设计、包括数据爬取、Spark、数据分析、数据可视化、Hadoop]]></title>    <link>https://juejin.cn/post/7579127397497192499</link>    <guid>https://juejin.cn/post/7579127397497192499</guid>    <pubDate>2025-12-02T14:19:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579127397497192499" data-draft-id="7579094978681798702" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Hadoop+Spark+python毕设】中国租房信息可视化分析系统、计算机毕业设计、包括数据爬取、Spark、数据分析、数据可视化、Hadoop"/> <meta itemprop="keywords" content="后端,MySQL,Python"/> <meta itemprop="datePublished" content="2025-12-02T14:19:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="计算机毕设小月哥"/> <meta itemprop="url" content="https://juejin.cn/user/95020128928073"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Hadoop+Spark+python毕设】中国租房信息可视化分析系统、计算机毕业设计、包括数据爬取、Spark、数据分析、数据可视化、Hadoop
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/95020128928073/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    计算机毕设小月哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:19:42.000Z" title="Tue Dec 02 2025 14:19:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎓 作者：计算机毕设小月哥 | 软件开发专家</p>
<p>🖥️ 简介：8年计算机软件程序开发经验。精通Java、Python、微信小程序、安卓、大数据、PHP、.NET|C#、Golang等技术栈。</p>
<p>🛠️ 专业服务 🛠️</p>
<ul>
<li>
<p>需求定制化开发</p>
</li>
<li>
<p>源码提供与讲解</p>
</li>
<li>
<p>技术文档撰写（指导计算机毕设选题【新颖+创新】、任务书、开题报告、文献综述、外文翻译等）</p>
</li>
<li>
<p>项目答辩演示PPT制作</p>
</li>
</ul>
</blockquote>
<blockquote>
<p>🌟 欢迎：点赞 👍 收藏 ⭐ 评论 📝</p>
<p>👇🏻 精选专栏推荐 👇🏻 欢迎订阅关注！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761129.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761129.html" ref="nofollow noopener noreferrer">大数据实战项目</a></p>
</blockquote>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761131.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761131.html" ref="nofollow noopener noreferrer">PHP|C#.NET|Golang实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761132.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761132.html" ref="nofollow noopener noreferrer">微信小程序|安卓实战项目</a></p>
</blockquote>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761130.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761130.html" ref="nofollow noopener noreferrer">Python实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761126.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761126.html" ref="nofollow noopener noreferrer">Java实战项目</a></p>
<p>🍅 ↓↓主页获取源码联系↓↓🍅</p>
</blockquote>
<h2 data-id="heading-0">基于大数据的中国租房信息可视化分析系统-功能介绍</h2>
<p>本系统是一个基于Hadoop+Spark+Python技术栈构建的中国租房信息可视化分析平台。系统旨在应对海量租房数据带来的挑战，通过整合Hadoop分布式文件系统（HDFS）进行数据存储，并利用Spark强大的分布式计算引擎对全国范围内的租房数据进行高效处理与分析。核心分析维度涵盖了租房价格的横向与纵向对比、房源地理位置的分布特征、周边配套设施的完备程度以及市场供需关系的动态变化。后端采用Python语言，借助Pandas和NumPy库进行数据清洗与预处理，再通过Spark SQL执行复杂的多维度聚合查询。最终，分析结果通过Vue.js和Echarts构建的前端界面进行直观呈现，以交互式图表、地图热力图等形式，将复杂的数据关系转化为清晰易懂的视觉信息，为广大租房者提供数据驱动的决策支持，帮助他们更精准地把握市场动态，找到理想的住所。</p>
<h2 data-id="heading-1">基于大数据的中国租房信息可视化分析系统-选题背景意义</h2>
<p>选题背景
随着我国城镇化进程的不断加快，大量人口涌入城市，使得租房市场的规模持续扩大，变得异常活跃。然而，这个市场也伴随着信息高度不对称的问题，租客在面对海量的房源信息时，往往难以快速准确地判断其真实价值和性价比。各个租房平台数据标准不一，信息分散，导致人们在做决策时如同雾里看花。这种现状不仅增加了租房的时间成本，也容易让租客陷入信息茧房，做出不那么明智的选择。因此，如何有效地整合并分析这些分散的数据，将其转化为有价值的洞察，就成了一个亟待解决的现实问题，这也为我们的毕设课题提供了明确的研究方向。
选题意义
这个课题的意义还是挺实在的。对于咱们普通租房者来说，它能提供一个相对客观的参考，帮我们从价格、地段、配套等多个角度去全面评估一个房源，而不是只听中介的一面之词，心里能更有底。从技术学习角度看，这个项目把大数据的理论知识给用活了，让我们能亲手实践一下Hadoop和Spark是怎么处理真实数据的，这对理解分布式计算和数据分析的整个流程特别有帮助。它虽然只是一个毕业设计，但确实是把课堂上学到的技术和现实生活中的需求结合了起来，算是一次很有价值的综合演练，也展示了用数据解决实际问题的可能性。</p>
<h2 data-id="heading-2">基于大数据的中国租房信息可视化分析系统-技术选型</h2>
<p>大数据框架：Hadoop+Spark（本次没用Hive，支持定制）
开发语言：Python+Java（两个版本都支持）
后端框架：Django+Spring Boot(Spring+SpringMVC+Mybatis)（两个版本都支持）
前端：Vue+ElementUI+Echarts+HTML+CSS+JavaScript+jQuery
详细技术点：Hadoop、HDFS、Spark、Spark SQL、Pandas、NumPy
数据库：MySQL</p>
<h2 data-id="heading-3">基于大数据的中国租房信息可视化分析系统-视频展示</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1aUSxBJE1k%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click" target="_blank" title="https://www.bilibili.com/video/BV1aUSxBJE1k/?spm_id_from=333.1387.homepage.video_card.click" ref="nofollow noopener noreferrer">基于大数据的中国租房信息可视化分析系统-视频展示</a></p>
<h2 data-id="heading-4">基于大数据的中国租房信息可视化分析系统-图片展示</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/437eb8bda77148c08703c76a0ab1078d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289981&amp;x-signature=HfkjCeHwVYAmLXbacAl%2BVoDS9m0%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ed746b1b1ae4be18f12a542a51260b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289981&amp;x-signature=llVtWYVQrHVYvFBaDJJYcwqU3n8%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceed7ebe8bfb45a89601a82cd14fcc95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289981&amp;x-signature=L7RrRhGkv4vg9HRuAsPd7Cd75vo%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23e8957c806f45e8881e843f57a03ef4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289981&amp;x-signature=EHg5mOIpX%2F8aGUowPtk4w9ZLUsk%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40808d18927e4742a2e5e473757f8db5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289981&amp;x-signature=bWzdcQwrnIndsyHoGpAQ3nwMoGE%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/275d3aca660c4895a2fd99a5f1581475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289981&amp;x-signature=peqh7gR961TR4ZC%2BENsLI54YLAc%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9deb8cfa3c2e4077ab0d748eb4911541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289981&amp;x-signature=vXDGZKCL5q%2Bd3GqxQmngjq9qgfo%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0094e3c8d4724e52a4a6e8676350bb20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765289981&amp;x-signature=MwQ3x7YiMzZzMu9WJPFNTgq1ql4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-5">基于大数据的中国租房信息可视化分析系统-代码展示</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> SparkSession
<span class="hljs-keyword">from</span> pyspark.sql.functions <span class="hljs-keyword">import</span> col, count, avg, <span class="hljs-built_in">max</span>, <span class="hljs-built_in">min</span>, approx_count_distinct, when, lit
spark = SparkSession.builder.appName(<span class="hljs-string">"RentalAnalysis"</span>).getOrCreate()
df = spark.read.csv(<span class="hljs-string">"hdfs://path/to/rental_data.csv"</span>, header=<span class="hljs-literal">True</span>, inferSchema=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_city_rent_level</span>():
    df.createOrReplaceTempView(<span class="hljs-string">"rental_view"</span>)
    city_rent_analysis = spark.sql(<span class="hljs-string">"""
        SELECT
            city,
            COUNT(*) AS total_listings,
            ROUND(AVG(price), 2) AS avg_rent,
            ROUND(percentile_approx(price, 0.5), 2) AS median_rent,
            MAX(price) AS max_rent,
            MIN(price) AS min_rent
        FROM rental_view
        WHERE city IS NOT NULL AND price IS NOT NULL AND price &gt; 0
        GROUP BY city
        ORDER BY avg_rent DESC
    """</span>)
    city_rent_analysis.show()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_geo_distribution</span>():
    df.createOrReplaceTempView(<span class="hljs-string">"rental_view"</span>)
    geo_density_analysis = spark.sql(<span class="hljs-string">"""
        SELECT
            city,
            district,
            COUNT(*) AS listing_count,
            ROUND(AVG(lng), 6) AS avg_longitude,
            ROUND(AVG(lat), 6) AS avg_latitude
        FROM rental_view
        WHERE city IS NOT NULL AND district IS NOT NULL AND lng IS NOT NULL AND lat IS NOT NULL
        GROUP BY city, district
        HAVING listing_count &gt; 10
        ORDER BY city, listing_count DESC
    """</span>)
    geo_density_analysis.show()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_facility_rent_impact</span>():
    facility_cols = [c <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> df.columns <span class="hljs-keyword">if</span> c.startswith(<span class="hljs-string">'是否有'</span>)]
    df.createOrReplaceTempView(<span class="hljs-string">"rental_view"</span>)
    facility_rent_sql = <span class="hljs-string">"SELECT price, "</span>
    facility_rent_sql += <span class="hljs-string">" + "</span>.join([<span class="hljs-string">f"WHEN `<span class="hljs-subst">{col}</span>` = '是' THEN 1 ELSE 0 END"</span> <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> facility_cols])
    facility_rent_sql += <span class="hljs-string">" AS facility_count FROM rental_view WHERE price &gt; 0"</span>
    facility_df = spark.sql(facility_rent_sql)
    facility_df.createOrReplaceTempView(<span class="hljs-string">"facility_rent_view"</span>)
    impact_analysis = spark.sql(<span class="hljs-string">"""
        SELECT
            facility_count,
            COUNT(*) AS listing_num,
            ROUND(AVG(price), 2) AS avg_price_for_facilities
        FROM facility_rent_view
        GROUP BY facility_count
        ORDER BY facility_count
    """</span>)
    impact_analysis.show()
</code></pre>
<h2 data-id="heading-6">基于大数据的中国租房信息可视化分析系统-结语</h2>
<blockquote>
<p>🌟 欢迎：点赞 👍 收藏 ⭐ 评论 📝</p>
<p>👇🏻 精选专栏推荐 👇🏻 欢迎订阅关注！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761129.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761129.html" ref="nofollow noopener noreferrer">大数据实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761131.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761131.html" ref="nofollow noopener noreferrer">PHP|C#.NET|Golang实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761132.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761132.html" ref="nofollow noopener noreferrer">微信小程序|安卓实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761130.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761130.html" ref="nofollow noopener noreferrer">Python实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761126.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761126.html" ref="nofollow noopener noreferrer">Java实战项目</a></p>
<p>🍅 ↓↓主页获取源码联系↓↓🍅</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>