<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[你真的知道npm是什么吗？]]></title>    <link>https://juejin.cn/post/7596962772145258511</link>    <guid>https://juejin.cn/post/7596962772145258511</guid>    <pubDate>2026-01-20T05:20:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596962772145258511" data-draft-id="7596989416760655907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你真的知道npm是什么吗？"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2026-01-20T05:20:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不想秃头的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2754702534251820"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你真的知道npm是什么吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2754702534251820/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不想秃头的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:20:37.000Z" title="Tue Jan 20 2026 05:20:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为前端开发者，<code>npm</code> (Node Package Manager) 是我们日常开发中绕不开的工具 —— 从初始化项目、安装依赖，到发布自己的包，它贯穿了前端工程化的全流程。但很多开发者只停留在 <code>npm install</code> 的层面，对其核心原理和高级用法知之甚少。这篇文章将从基础到进阶，全方位拆解 npm，让你真正吃透这个工具。</p>
<h2 data-id="heading-0">一、npm 是什么？</h2>
<p><code>npm</code> 是 Node.js 的官方包管理工具，核心作用有三个：</p>
<ol>
<li><strong>包管理</strong>：安装、卸载、更新第三方依赖包（如 Vue、React、axios 等）；</li>
<li><strong>项目管理</strong>：通过 <code>package.json</code> 管理项目的元信息（名称、版本、脚本、依赖等）；</li>
<li><strong>脚本运行</strong>：执行自定义的命令脚本（如 <code>npm run dev</code>、<code>npm run build</code>）。</li>
</ol>
<blockquote>
<p>补充：npm 随 Node.js 一起安装，安装 Node.js 后即可使用（验证：终端输入 <code>npm -v</code> 查看版本）。</p>
</blockquote>
<h2 data-id="heading-1">二、npm 核心基础操作</h2>
<h3 data-id="heading-2">2.1 初始化项目（npm init）</h3>
<p>创建 <code>package.json</code>（项目核心配置文件）是使用 npm 的第一步：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 交互式初始化（手动输入项目信息）</span>
npm init

<span class="hljs-comment"># 快速初始化（所有选项默认，推荐日常使用）</span>
npm init -y
</code></pre>
<p>执行后会生成 <code>package.json</code> 文件，核心字段说明：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-project"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 项目名称（小写、无空格）</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 版本号（遵循语义化版本规范）</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 项目描述</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 入口文件</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 自定义脚本</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 生产环境依赖</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span> <span class="hljs-comment">// 开发环境依赖</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">2.2 安装依赖（npm install）</h3>
<p>这是最常用的命令，核心用法分三类：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装单个包（生产环境，写入 dependencies）</span>
npm install axios
<span class="hljs-comment"># 简写：npm i axios</span>

<span class="hljs-comment"># 2. 安装到开发环境（写入 devDependencies）</span>
npm install webpack --save-dev
<span class="hljs-comment"># 简写：npm i webpack -D</span>

<span class="hljs-comment"># 3. 安装指定版本</span>
npm install vue@3.4.0

<span class="hljs-comment"># 4. 安装全局包（如脚手架、工具类）</span>
npm install @vue/cli -g

<span class="hljs-comment"># 5. 安装 package.json 中所有依赖</span>
npm install
</code></pre>
<h3 data-id="heading-4">2.3 卸载 / 更新依赖</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 卸载依赖</span>
npm uninstall axios
<span class="hljs-comment"># 简写：npm un axios</span>

<span class="hljs-comment"># 更新依赖</span>
npm update axios

<span class="hljs-comment"># 查看可更新的依赖</span>
npm outdated
</code></pre>
<h3 data-id="heading-5">2.4 运行自定义脚本（npm run）</h3>
<p>在 <code>package.json</code> 的 <code>scripts</code> 字段中定义脚本，通过 <code>npm run &lt;脚本名&gt;</code> 执行：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jest"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash">npm run dev   <span class="hljs-comment"># 启动开发服务</span>
npm run build <span class="hljs-comment"># 打包构建</span>
npm run <span class="hljs-built_in">test</span>  <span class="hljs-comment"># 执行测试</span>
</code></pre>
<blockquote>
<p>小技巧：<code>start</code>、<code>test</code> 等内置脚本可省略 <code>run</code>，直接 <code>npm start</code>、<code>npm test</code>。</p>
</blockquote>
<h2 data-id="heading-6">三、npm 核心概念解析</h2>
<h3 data-id="heading-7">3.1 依赖类型：dependencies vs devDependencies</h3>




















<table><thead><tr><th>类型</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td>dependencies</td><td>生产环境依赖（项目运行必需）</td><td>axios、vue、react</td></tr><tr><td>devDependencies</td><td>开发环境依赖（仅开发 / 构建时使用）</td><td>webpack、vite、eslint</td></tr></tbody></table>
<p><strong>核心区别</strong>：执行 <code>npm install --production</code> 时，只会安装 <code>dependencies</code> 中的依赖（生产环境部署常用）。</p>
<h3 data-id="heading-8">3.2 package-lock.json 的作用</h3>
<p>很多开发者会疑惑：为什么安装依赖后会生成 <code>package-lock.json</code>？</p>
<ul>
<li><strong>锁定版本</strong>：记录每个依赖的精确版本、下载地址、依赖树，确保不同环境安装的依赖版本完全一致；</li>
<li><strong>加速安装</strong>：后续安装时无需重新解析依赖树，直接从 <code>package-lock.json</code> 读取，速度更快；</li>
<li><strong>注意</strong>：<code>package-lock.json</code> 需提交到 Git 仓库，不要手动修改！</li>
</ul>
<h3 data-id="heading-9">3.3 语义化版本（SemVer）</h3>
<p>npm 依赖版本遵循「语义化版本规范」，格式为：<code>主版本.次版本.补丁版本</code>（如 <code>3.4.2</code>）：</p>
<ul>
<li><strong>主版本（MAJOR）</strong> ：不兼容的 API 变更（如 2.0.0 → 3.0.0）；</li>
<li><strong>次版本（MINOR）</strong> ：兼容的功能新增（如 3.3.0 → 3.4.0）；</li>
<li><strong>补丁版本（PATCH）</strong> ：兼容的 bug 修复（如 3.4.1 → 3.4.2）。</li>
</ul>
<p>版本号前的符号含义（package.json 中常见）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.4.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 允许次版本和补丁更新（3.4.0 → 3.9.9）</span>
    <span class="hljs-attr">"axios"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"~1.6.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 仅允许补丁更新（1.6.0 → 1.6.9）</span>
    <span class="hljs-attr">"lodash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*"</span> <span class="hljs-comment">// 任意版本</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-10">四、npm 高级用法</h2>
<h3 data-id="heading-11">4.1 查看包信息</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看包的详细信息（版本、依赖、文档地址等）</span>
npm info axios

<span class="hljs-comment"># 查看当前项目已安装的依赖</span>
npm list
<span class="hljs-comment"># 只看顶层依赖（更清晰）</span>
npm list --depth=0

<span class="hljs-comment"># 查看全局安装的包</span>
npm list -g --depth=0
</code></pre>
<h3 data-id="heading-12">4.2 发布自己的 npm 包</h3>
<p>如果你想分享自己的工具包到 npm 仓库，步骤如下：</p>
<ol>
<li>
<p><strong>注册 npm 账号</strong>：官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2F" target="_blank" title="https://www.npmjs.com/" ref="nofollow noopener noreferrer">npmjs.com</a> 注册，或终端执行 <code>npm adduser</code>；</p>
</li>
<li>
<p><strong>初始化包</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> my-utils &amp;&amp; <span class="hljs-built_in">cd</span> my-utils
npm init -y
</code></pre>
</li>
<li>
<p><strong>编写代码</strong>：创建核心文件（如 <code>index.js</code>）；</p>
</li>
<li>
<p><strong>发布包</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">npm login <span class="hljs-comment"># 登录账号（需输入用户名、密码、邮箱）</span>
npm publish <span class="hljs-comment"># 发布（首次发布需确保包名未被占用）</span>
</code></pre>
</li>
</ol>
<blockquote>
<p>注意：发布前需检查 <code>.npmignore</code> 文件（排除不需要发布的文件，如 node_modules、测试文件）。</p>
</blockquote>
<h3 data-id="heading-13">4.3 更换 npm 镜像源</h3>
<p>默认 npm 源在国外，下载速度慢，可切换到国内镜像（如淘宝源）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 临时切换（单次生效）</span>
npm install axios --registry=https://registry.npmmirror.com

<span class="hljs-comment"># 永久切换</span>
npm config <span class="hljs-built_in">set</span> registry https://registry.npmmirror.com

<span class="hljs-comment"># 查看当前源</span>
npm config get registry

<span class="hljs-comment"># 切回官方源</span>
npm config <span class="hljs-built_in">set</span> registry https://registry.npmjs.org/
</code></pre>
<blockquote>
<p>推荐工具：<code>nrm</code>（npm 源管理工具），可快速切换多个源：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash">npm install nrm -g
nrm use taobao <span class="hljs-comment"># 切换到淘宝源</span>
nrm <span class="hljs-built_in">ls</span> <span class="hljs-comment"># 查看所有可用源</span>
</code></pre>
</blockquote>
<h3 data-id="heading-14">4.4 清理缓存</h3>
<p>如果安装依赖时出现异常，可清理 npm 缓存：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看缓存路径</span>
npm config get cache

<span class="hljs-comment"># 清理缓存</span>
npm cache clean --force
</code></pre>
<h2 data-id="heading-15">五、常见问题与解决方案</h2>
<h3 data-id="heading-16">问题 1：安装依赖时报错 <code>EACCES: permission denied</code></h3>
<p>原因：权限不足（全局安装时常见）。解决方案：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方案1：使用 sudo（不推荐）</span>
sudo npm install -g @vue/cli

<span class="hljs-comment"># 方案2：修改 npm 全局目录权限（推荐）</span>
<span class="hljs-built_in">mkdir</span> ~/.npm-global
npm config <span class="hljs-built_in">set</span> prefix <span class="hljs-string">'~/.npm-global'</span>
<span class="hljs-comment"># 然后将 ~/.npm-global/bin 添加到系统环境变量</span>
</code></pre>
<h3 data-id="heading-17">问题 2：依赖安装成功但项目运行报错</h3>
<p>原因：依赖版本不兼容，或 <code>package-lock.json</code> 锁定的版本有问题。解决方案：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除 node_modules 和 package-lock.json</span>
<span class="hljs-built_in">rm</span> -rf node_modules package-lock.json

<span class="hljs-comment"># 重新安装</span>
npm install
</code></pre>
<h3 data-id="heading-18">问题 3：全局安装的包无法执行</h3>
<p>原因：全局包的安装路径未加入系统环境变量。解决方案：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 查看全局包路径</span>
npm config get prefix

<span class="hljs-comment"># 将该路径下的 bin 目录添加到系统环境变量（如 ~/.npm-global/bin）</span>
</code></pre>
<h2 data-id="heading-19">总结</h2>
<ol>
<li><code>npm</code> 是 Node.js 标配的包管理工具，核心用于依赖管理和脚本运行，<code>package.json</code> 是项目的核心配置文件；</li>
<li>掌握 <code>npm init</code>/<code>npm install</code>/<code>npm run</code> 等基础命令是前端开发的必备技能，区分 <code>dependencies</code> 和 <code>devDependencies</code> 能规范项目依赖；</li>
<li><code>package-lock.json</code> 用于锁定依赖版本，保证多环境一致性，高级用法（换源、发布包、清理缓存）能解决日常开发中的大部分问题。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Lodash 源码解读与原理分析 - 数组那些事儿]]></title>    <link>https://juejin.cn/post/7597056049690411046</link>    <guid>https://juejin.cn/post/7597056049690411046</guid>    <pubDate>2026-01-20T05:26:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597056049690411046" data-draft-id="7596241980870262818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Lodash 源码解读与原理分析 - 数组那些事儿"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T05:26:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Anita_Sun"/> <meta itemprop="url" content="https://juejin.cn/user/1811635884786839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Lodash 源码解读与原理分析 - 数组那些事儿
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1811635884786839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Anita_Sun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:26:18.000Z" title="Tue Jan 20 2026 05:26:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Lodash 作为前端开发的核心工具库，其数组函数之所以能兼顾高性能与高鲁棒性，并非简单封装原生 API，而是从<strong>算法选型、内存管理、执行效率、边界兼容</strong>四个维度进行系统性优化。本文先拆解贯穿所有数组函数的通用优化策略，再逐一分析核心函数的实现细节，完整揭示 Lodash 高性能的底层逻辑。</p>
<h2 data-id="heading-0">一、Lodash 数组函数的通用性能优化策略</h2>
<p>Lodash 所有数组函数都遵循一套统一的优化范式，这些范式是其高性能的核心基石，具体包含 8 个核心方向：</p>
<h3 data-id="heading-1">1. 边界检查与早期返回：避免无效计算</h3>
<p><strong>核心逻辑</strong>：函数执行初期就对空值、无效输入、边界场景做判断，直接返回结果，避免进入核心逻辑的无效遍历 / 计算。<strong>实现方式</strong>：</p>
<ul>
<li>
<p>优先校验 <code>array</code> 是否为 <code>null/undefined</code>，安全获取数组长度（<code>var length = array == null ? 0 : array.length</code>）；</p>
</li>
<li>
<p>对空数组、无效参数（如 <code>size &lt; 1</code>、<code>depth &lt; 0</code>）直接返回空数组 / 原数组，不执行后续逻辑；</p>
</li>
<li>
<p>对非数组 / 类数组输入，直接返回空数组或原值，避免属性访问报错。</p>
<p><strong>价值</strong>：减少无效的循环、函数调用、内存分配，提升函数冷启动速度，同时增强鲁棒性。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 通用边界检查模板</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">baseFunction</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 安全获取长度：处理null/undefined</span>
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 早期返回：空数组直接返回结果</span>
  <span class="hljs-keyword">if</span> (!length) {
    <span class="hljs-keyword">return</span> [];
  }
  <span class="hljs-comment">// 核心逻辑（省略）</span>
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-2">2. 内存预分配：避免动态扩容的性能损耗</h3>
<p><strong>核心逻辑</strong>：对可预知长度的结果数组，提前分配内存空间，替代 <code>push</code> 动态扩容的方式。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>通过计算目标长度（如分块数 <code>nativeCeil(length / size)</code>、切片长度 <code>end - start</code>）创建固定长度数组；</li>
<li>用索引赋值替代 <code>push</code>，避免数组长度翻倍扩容的内存重分配；</li>
<li>仅在长度不可预知时（如过滤类函数）使用 <code>push</code>，但仍通过双指针优化填充效率。</li>
</ul>
<p><strong>价值</strong>：减少 JavaScript 引擎的内存重分配和垃圾回收（GC）压力，大数组场景下性能提升 20%-30%。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// chunk 中的内存预分配</span>
<span class="hljs-keyword">var</span> result = <span class="hljs-title class_">Array</span>(<span class="hljs-title function_">nativeCeil</span>(length / size)); <span class="hljs-comment">// 预分配分块结果数组</span>
<span class="hljs-comment">// baseSlice 中的内存预分配</span>
<span class="hljs-keyword">var</span> result = <span class="hljs-title class_">Array</span>(length); <span class="hljs-comment">// 预分配切片结果数组</span>
</code></pre>
<h3 data-id="heading-3">3. 算法分层选型：按数据规模选择最优算法</h3>
<p><strong>核心逻辑</strong>：根据数组长度、有序性、数据类型选择不同算法，平衡「初始化开销」和「遍历效率」。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>有序数组：使用二分查找（时间复杂度 O (log n)）替代线性查找（O (n)），如 <code>sortedIndex</code>；</li>
<li>大数组（≥200）：使用 Set/SetCache 缓存（查找 O (1)）替代数组查找（O (n)），如 <code>uniq</code>；</li>
<li>小数组（&lt;200）：使用普通数组查找，避免 Set 初始化的额外开销；</li>
<li>多数组操作（如交集、差集）：基于最短数组遍历，减少迭代次数。</li>
</ul>
<p><strong>价值</strong>：不同数据规模下都能达到最优执行效率，大数组场景性能提升 5-50 倍。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// uniq 中的分层策略</span>
<span class="hljs-keyword">if</span> (length &gt;= <span class="hljs-variable constant_">LARGE_ARRAY_SIZE</span>) { <span class="hljs-comment">// LARGE_ARRAY_SIZE = 200</span>
  <span class="hljs-keyword">var</span> set = iteratee ? <span class="hljs-literal">null</span> : <span class="hljs-title function_">createSet</span>(array); <span class="hljs-comment">// 大数组用Set</span>
  <span class="hljs-keyword">if</span> (set) <span class="hljs-keyword">return</span> <span class="hljs-title function_">setToArray</span>(set);
} <span class="hljs-keyword">else</span> {
  seen = iteratee ? [] : result; <span class="hljs-comment">// 小数组用普通数组</span>
}
</code></pre>
<h3 data-id="heading-4">4. 位运算优化：替代算术运算提升执行速度</h3>
<p><strong>核心逻辑</strong>：用位运算替代 <code>Math.floor</code>、正负判断、整数转换等算术运算，利用 CPU 直接执行的特性提升效率。<strong>实现方式</strong>：</p>
<ul>
<li>计算中间索引：<code>var mid = (low + high) &gt;&gt;&gt; 1</code>（替代 <code>Math.floor((low+high)/2)</code>）；</li>
<li>确保正整数：<code>start &gt;&gt;&gt;= 0</code>（替代 <code>Math.max(start, 0)</code>）；</li>
<li>计算长度：<code>length = (end - start) &gt;&gt;&gt; 0</code>（避免负数，替代 <code>Math.max(end - start, 0)</code>）。</li>
</ul>
<p><strong>价值</strong>：位运算比算术运算快 10%-20%，且能避免浮点运算、整数溢出问题。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// sortedIndex 中的位运算优化</span>
<span class="hljs-keyword">var</span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number">1</span>; <span class="hljs-comment">// 无浮点、无溢出的中间索引计算</span>
</code></pre>
<h3 data-id="heading-5">5. 循环优化：最小化迭代器开销</h3>
<p><strong>核心逻辑</strong>：通过 <code>while</code> 循环 + 双指针替代 <code>for</code> 循环，减少迭代过程中的变量声明、属性访问、冗余计算。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>优先使用 <code>while</code> 循环：缓存数组长度（仅计算 1 次），避免每次迭代访问 <code>array.length</code>；</li>
<li>前置自增（<code>++index</code>）：替代后置自增（<code>index++</code>），减少临时变量存储；</li>
<li>双指针遍历：用两个指针分别遍历原数组（<code>index</code>）和填充结果数组（<code>resIndex</code>），减少长度计算；</li>
<li>短路循环：通过 <code>continue outer</code> 跳过无效迭代，减少比较次数。</li>
</ul>
<p><strong>价值</strong>：循环开销降低 10%-30%，高频遍历场景效果显著。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// compact 中的 while 循环 + 双指针</span>
<span class="hljs-keyword">var</span> index = -<span class="hljs-number">1</span>, resIndex = <span class="hljs-number">0</span>;
<span class="hljs-keyword">while</span> (++index &lt; length) { <span class="hljs-comment">// 前置自增，仅比较变量</span>
  <span class="hljs-keyword">var</span> value = array[index];
  <span class="hljs-keyword">if</span> (value) {
    result[resIndex++] = value; <span class="hljs-comment">// 双指针填充</span>
  }
}
</code></pre>
<h3 data-id="heading-6">6. 缓存机制：将 O (n) 查找降为 O (1)</h3>
<p><strong>核心逻辑</strong>：对频繁查找的场景，用缓存结构存储已遍历值，避免重复遍历比较。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>大数组场景：使用 <code>SetCache</code>（Lodash 封装的 Set 兼容版）缓存已遍历值，查找时间复杂度 O (1)；</li>
<li>小数组场景：复用结果数组作为缓存，减少额外内存分配；</li>
<li>多数组操作：缓存第一个数组的所有值，后续数组仅做查找对比。</li>
</ul>
<p><strong>价值</strong>：查找效率提升一个数量级，大数组去重 / 交集场景性能提升数倍。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// baseUniq 中的缓存机制</span>
seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetCache</span>; <span class="hljs-comment">// O(1) 查找缓存</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-title function_">includes</span>(seen, computed, comparator)) { <span class="hljs-comment">// 缓存查找</span>
  seen.<span class="hljs-title function_">push</span>(computed);
  result.<span class="hljs-title function_">push</span>(value);
}
</code></pre>
<h3 data-id="heading-7">7. 原生方法复用：利用引擎底层优化</h3>
<p><strong>核心逻辑</strong>：对浏览器已高度优化的原生方法，直接封装复用，避免手写逻辑的性能损耗。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>复用 <code>Array.prototype.push</code>/<code>reverse</code>/<code>slice</code> 等原生方法，如 <code>nativeReverse.call(array)</code>；</li>
<li>封装原生方法为内部函数（如 <code>arrayPush</code> 封装 <code>push</code>），统一兼容处理；</li>
<li>仅在原生方法有缺陷时（如 <code>indexOf</code> 不支持 NaN）手写替代逻辑。</li>
</ul>
<p><strong>价值</strong>：原生方法由浏览器引擎用 C++ 实现，执行效率远高于手写 JavaScript 逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// reverse 中的原生方法复用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-keyword">return</span> array == <span class="hljs-literal">null</span> ? array : nativeReverse.<span class="hljs-title function_">call</span>(array);
}
</code></pre>
<h3 data-id="heading-8">8. 迭代器归一化：兼顾易用性与性能</h3>
<p><strong>核心逻辑</strong>：将函数、对象、字符串等多种迭代器格式统一为标准函数，避免多次类型判断。</p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>通过 <code>getIteratee</code> 将 <code>predicate</code> 转换为标准迭代函数（支持 <code>_.filter(array, {active: true})</code> 等易用写法）；</li>
<li>迭代器仅初始化一次，复用在整个循环中，避免每次迭代都做类型判断；</li>
<li>统一迭代器参数（<code>value, index, array</code>），保证逻辑一致性。</li>
</ul>
<p><strong>价值</strong>：在不损失性能的前提下，提升 API 易用性，减少用户手写转换逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// remove 中的迭代器归一化</span>
predicate = <span class="hljs-title function_">getIteratee</span>(predicate, <span class="hljs-number">3</span>); <span class="hljs-comment">// 统一为标准函数</span>
<span class="hljs-keyword">while</span> (++index &lt; length) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">predicate</span>(value, index, array)) { <span class="hljs-comment">// 复用迭代器</span>
    <span class="hljs-comment">// 逻辑处理</span>
  }
}
</code></pre>
<h2 data-id="heading-9">二、Lodash 核心数组函数的实现与优化细节</h2>
<p>基于上述通用策略，Lodash 为不同场景的数组函数设计了针对性的优化方案，以下是核心函数的完整实现与解析：</p>
<h3 data-id="heading-10">1. 基础操作函数：易用性与效率的平衡</h3>
<h4 data-id="heading-11"><code>_.chunk</code>：数组分块的内存优化典范</h4>
<p><strong>功能</strong>：将数组分割为指定大小的二维数组，空数组 / 无效参数返回空数组。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">chunk</span>(<span class="hljs-params">array, size, guard</span>) {
  <span class="hljs-comment">// 1. 边界兼容：处理参数异常（防误传、未传size）</span>
  <span class="hljs-keyword">if</span> ((guard ? <span class="hljs-title function_">isIterateeCall</span>(array, size, guard) : size === <span class="hljs-literal">undefined</span>)) {
    size = <span class="hljs-number">1</span>; <span class="hljs-comment">// 默认分块大小为1</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 转为整数并确保最小值为0（避免负数分块）</span>
    size = <span class="hljs-title function_">nativeMax</span>(<span class="hljs-title function_">toInteger</span>(size), <span class="hljs-number">0</span>);
  }

  <span class="hljs-comment">// 2. 安全获取长度 + 早期返回：空数组/无效size直接返回</span>
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (!length || size &lt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> [];
  }

  <span class="hljs-comment">// 3. 内存预分配：计算分块数并创建固定长度数组</span>
  <span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>,
      resIndex = <span class="hljs-number">0</span>,
      result = <span class="hljs-title class_">Array</span>(<span class="hljs-title function_">nativeCeil</span>(length / size)); <span class="hljs-comment">// 向上取整确定分块数</span>

  <span class="hljs-comment">// 4. 循环优化：while循环 + 指针更新，减少迭代开销</span>
  <span class="hljs-keyword">while</span> (index &lt; length) {
    <span class="hljs-comment">// 复用baseSlice切片，同时更新索引（index += size）</span>
    result[resIndex++] = <span class="hljs-title function_">baseSlice</span>(array, index, (index += size));
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>分块数预计算：通过 <code>nativeCeil(length / size)</code> 精准预分配结果数组长度；</li>
<li>索引联动更新：<code>index += size</code> 一次操作完成指针移动，避免重复计算；</li>
<li>底层逻辑复用：基于 <code>baseSlice</code> 实现切片，避免重复造轮子。</li>
</ul>
<h4 data-id="heading-12"><code>_.compact</code>：假值过滤的极致简洁</h4>
<p><strong>功能</strong>：移除数组中的假值（false、null、0、""、undefined、NaN），返回新数组。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">compact</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 1. 安全初始化：处理null/undefined，缓存长度</span>
  <span class="hljs-keyword">var</span> index = -<span class="hljs-number">1</span>,
      length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>,
      resIndex = <span class="hljs-number">0</span>,
      result = [];

  <span class="hljs-comment">// 2. 循环优化：while + 双指针，减少属性访问</span>
  <span class="hljs-keyword">while</span> (++index &lt; length) {
    <span class="hljs-keyword">var</span> value = array[index];
    <span class="hljs-comment">// 3. 快速判空：直接判断值，比Boolean(value)更高效</span>
    <span class="hljs-keyword">if</span> (value) {
      result[resIndex++] = value; <span class="hljs-comment">// 双指针填充，避免push扩容</span>
    }
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>快速假值判断：<code>if (value)</code> 直接校验，省去 <code>Boolean()</code> 函数调用开销；</li>
<li>双指针填充：<code>resIndex</code> 独立控制结果数组索引，避免 <code>result.length</code> 访问。</li>
</ul>
<h4 data-id="heading-13"><code>_.concat</code>：多参数拼接的灵活实现</h4>
<p><strong>功能</strong>：拼接多个数组 / 值，返回新数组，支持类数组、单值输入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">concat</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 早期返回：无参数直接返回空数组</span>
  <span class="hljs-keyword">var</span> length = <span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (!length) {
    <span class="hljs-keyword">return</span> [];
  }

  <span class="hljs-comment">// 2. 参数预处理：批量处理arguments，避免多次类数组操作</span>
  <span class="hljs-keyword">var</span> args = <span class="hljs-title class_">Array</span>(length - <span class="hljs-number">1</span>),
      array = <span class="hljs-variable language_">arguments</span>[<span class="hljs-number">0</span>],
      index = length;

  <span class="hljs-comment">// 反向遍历：高效将arguments转为数组</span>
  <span class="hljs-keyword">while</span> (index--) {
    args[index - <span class="hljs-number">1</span>] = <span class="hljs-variable language_">arguments</span>[index];
  }

  <span class="hljs-comment">// 3. 核心逻辑：原生复用 + 扁平化控制</span>
  <span class="hljs-comment">// - isArray判断：数组拷贝，非数组转为数组</span>
  <span class="hljs-comment">// - baseFlatten：仅扁平化1层，平衡灵活性与性能</span>
  <span class="hljs-comment">// - arrayPush：封装原生push，利用引擎优化</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">arrayPush</span>(
    <span class="hljs-title function_">isArray</span>(array) ? <span class="hljs-title function_">copyArray</span>(array) : [array],
    <span class="hljs-title function_">baseFlatten</span>(args, <span class="hljs-number">1</span>)
  );
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>反向遍历参数：<code>while (index--)</code> 高效处理 <code>arguments</code>，避免 <code>Array.from</code> 开销；</li>
<li>扁平化控制：仅扁平化 1 层，避免过度遍历，同时兼容多参数输入。</li>
</ul>
<h3 data-id="heading-14">2. 查找与索引函数：算法层面的性能突破</h3>
<h4 data-id="heading-15"><code>_.findIndex</code>：条件查找的精准控制</h4>
<p><strong>功能</strong>：查找第一个满足条件的元素索引，支持起始位置，无匹配返回 -1。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">findIndex</span>(<span class="hljs-params">array, predicate, fromIndex</span>) {
  <span class="hljs-comment">// 1. 安全获取长度 + 早期返回：空数组直接返回-1</span>
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (!length) {
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">// 2. 起始索引校准：处理负数、非数字索引</span>
  <span class="hljs-keyword">var</span> index = fromIndex == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-title function_">toInteger</span>(fromIndex);
  <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 负数索引转为合法正索引，最小为0</span>
    index = <span class="hljs-title function_">nativeMax</span>(length + index, <span class="hljs-number">0</span>);
  }

  <span class="hljs-comment">// 3. 迭代器归一化 + 底层复用：</span>
  <span class="hljs-comment">// - getIteratee：统一迭代器格式（函数/对象/字符串）</span>
  <span class="hljs-comment">// - baseFindIndex：封装核心查找，支持正序/倒序复用</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseFindIndex</span>(array, <span class="hljs-title function_">getIteratee</span>(predicate, <span class="hljs-number">3</span>), index);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>起始位置校准：自动处理负数索引，无需用户手动转换；</li>
<li>底层逻辑抽象：<code>baseFindIndex</code> 同时支撑 <code>findIndex</code>/<code>findLastIndex</code>，避免重复代码。</li>
</ul>
<h4 data-id="heading-16"><code>_.sortedIndex</code>：有序数组的二分查找</h4>
<p><strong>功能</strong>：在有序数组中查找值的插入位置，保证数组有序性，仅支持数字 / 可比较类型。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 对外简化接口</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sortedIndex</span>(<span class="hljs-params">array, value</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseSortedIndex</span>(array, value);
}

<span class="hljs-comment">// 底层核心实现</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">baseSortedIndex</span>(<span class="hljs-params">array, value, retHighest</span>) {
  <span class="hljs-comment">// 1. 初始化二分边界：处理null/undefined</span>
  <span class="hljs-keyword">var</span> low = <span class="hljs-number">0</span>,
      high = array == <span class="hljs-literal">null</span> ? low : array.<span class="hljs-property">length</span>;

  <span class="hljs-comment">// 2. 数字类型特化：跳过无效值，提升效率</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value == <span class="hljs-string">'number'</span> &amp;&amp; value === value &amp;&amp; high &lt;= <span class="hljs-variable constant_">HALF_MAX_ARRAY_LENGTH</span>) {
    <span class="hljs-comment">// 3. 二分查找核心：位运算优化 + 短路判断</span>
    <span class="hljs-keyword">while</span> (low &lt; high) {
      <span class="hljs-comment">// 位运算计算中间索引：无浮点、无溢出</span>
      <span class="hljs-keyword">var</span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number">1</span>,
          computed = array[mid];

      <span class="hljs-comment">// 短路判断：跳过Symbol/null，快速比较</span>
      <span class="hljs-keyword">if</span> (computed !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-title function_">isSymbol</span>(computed) &amp;&amp;
          (retHighest ? (computed &lt;= value) : (computed &lt; value))) {
        low = mid + <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标在右半部分</span>
      } <span class="hljs-keyword">else</span> {
        high = mid; <span class="hljs-comment">// 目标在左半部分</span>
      }
    }
    <span class="hljs-keyword">return</span> high;
  }

  <span class="hljs-comment">// 非数字/超大数组：通用实现兜底</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseSortedIndexBy</span>(array, value, identity, retHighest);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>二分查找选型：时间复杂度 O (log n)，大数组比线性查找快 5-10 倍；</li>
<li>数字特化处理：跳过 Symbol/null 等无效值，减少判断开销；</li>
<li>长度限制：<code>HALF_MAX_ARRAY_LENGTH</code> 避免超大数组的性能问题。</li>
</ul>
<h4 data-id="heading-17"><code>_.indexOf</code>：值查找的兼容性优化</h4>
<p><strong>功能</strong>：查找值的第一个索引，支持起始位置，兼容 NaN 查找。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">indexOf</span>(<span class="hljs-params">array, value, fromIndex</span>) {
  <span class="hljs-comment">// 1. 安全获取长度 + 早期返回：空数组直接返回-1</span>
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (!length) {
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">// 2. 起始索引校准：处理负数、非数字</span>
  <span class="hljs-keyword">var</span> index = fromIndex == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-title function_">toInteger</span>(fromIndex);
  <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) {
    index = <span class="hljs-title function_">nativeMax</span>(length + index, <span class="hljs-number">0</span>);
  }

  <span class="hljs-comment">// 3. 底层复用：兼容NaN（原生indexOf不支持）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseIndexOf</span>(array, value, index);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>NaN 兼容：<code>baseIndexOf</code> 专门处理 NaN 查找，弥补原生 API 缺陷；</li>
<li>索引校准：自动处理负数起始位置，提升易用性。</li>
</ul>
<h3 data-id="heading-18">3. 修改与操作函数：原地 / 非原地的平衡</h3>
<h4 data-id="heading-19"><code>_.pullAll</code>（支撑 <code>_.pull</code>）：原地移除指定值</h4>
<p><strong>功能</strong>：从原数组中移除指定值，直接修改原数组，返回修改后的数组。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">pullAll</span>(<span class="hljs-params">array, values</span>) {
  <span class="hljs-comment">// 1. 早期返回：空数组/空值列表直接返回原数组</span>
  <span class="hljs-keyword">if</span> (!(array &amp;&amp; array.<span class="hljs-property">length</span> &amp;&amp; values &amp;&amp; values.<span class="hljs-property">length</span>)) {
    <span class="hljs-keyword">return</span> array;
  }

  <span class="hljs-comment">// 2. 批量处理：调用底层逻辑，避免多次遍历</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">basePullAll</span>(array, values);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>原地修改：直接操作原数组，减少新数组创建的内存开销；</li>
<li>批量处理：一次性移除多个值，避免多次遍历数组。</li>
</ul>
<h4 data-id="heading-20"><code>_.remove</code>：条件移除的高效实现</h4>
<p><strong>功能</strong>：移除满足条件的元素，返回被移除的数组，原数组被修改。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">array, predicate</span>) {
  <span class="hljs-comment">// 1. 初始化 + 早期返回：空数组返回空结果</span>
  <span class="hljs-keyword">var</span> result = [];
  <span class="hljs-keyword">if</span> (!(array &amp;&amp; array.<span class="hljs-property">length</span>)) {
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">// 2. 缓存长度 + 迭代器归一化</span>
  <span class="hljs-keyword">var</span> index = -<span class="hljs-number">1</span>,
      indexes = [],
      length = array.<span class="hljs-property">length</span>;
  predicate = <span class="hljs-title function_">getIteratee</span>(predicate, <span class="hljs-number">3</span>);

  <span class="hljs-comment">// 3. 双数组记录：先收集索引/值，避免边遍历边删除的索引错乱</span>
  <span class="hljs-keyword">while</span> (++index &lt; length) {
    <span class="hljs-keyword">var</span> value = array[index];
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">predicate</span>(value, index, array)) {
      result.<span class="hljs-title function_">push</span>(value); <span class="hljs-comment">// 收集被移除值</span>
      indexes.<span class="hljs-title function_">push</span>(index); <span class="hljs-comment">// 收集被移除索引</span>
    }
  }

  <span class="hljs-comment">// 4. 批量移除：一次性处理所有索引，减少数组重排次数</span>
  <span class="hljs-title function_">basePullAt</span>(array, indexes);
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>双数组记录：先收集后移除，避免边遍历边删除导致的元素漏判；</li>
<li>批量移除：<code>basePullAt</code> 一次性处理索引，减少数组元素移动的开销。</li>
</ul>
<h4 data-id="heading-21"><code>_.reverse</code>：原生能力的安全封装</h4>
<p><strong>功能</strong>：反转数组，直接修改原数组，兼容 <code>null/undefined</code> 输入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 1. 安全兼容：null/undefined直接返回，避免报错</span>
  <span class="hljs-comment">// 2. 原生复用：调用浏览器优化的reverse方法</span>
  <span class="hljs-keyword">return</span> array == <span class="hljs-literal">null</span> ? array : nativeReverse.<span class="hljs-title function_">call</span>(array);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>原生方法复用：直接调用 <code>Array.prototype.reverse</code>，利用引擎 C++ 实现的高性能；</li>
<li>无额外开销：仅做安全判断，无多余计算。</li>
</ul>
<h3 data-id="heading-22">4. 集合操作函数：数据结构驱动的性能提升</h3>
<h4 data-id="heading-23"><code>_.uniq</code>：数组去重的分层优化</h4>
<p><strong>功能</strong>：数组去重，返回新数组，兼容 NaN、0/-0 等特殊值。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 对外简化接口</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">uniq</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 早期返回：空数组/非数组直接返回空数组</span>
  <span class="hljs-keyword">return</span> (array &amp;&amp; array.<span class="hljs-property">length</span>) ? <span class="hljs-title function_">baseUniq</span>(array) : [];
}

<span class="hljs-comment">// 底层核心去重</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">baseUniq</span>(<span class="hljs-params">array, iteratee, comparator</span>) {
  <span class="hljs-comment">// 1. 初始化变量：缓存长度，默认查找函数</span>
  <span class="hljs-keyword">var</span> index = -<span class="hljs-number">1</span>,
      includes = arrayIncludes,
      length = array.<span class="hljs-property">length</span>,
      isCommon = <span class="hljs-literal">true</span>,
      result = [],
      seen = result;

  <span class="hljs-comment">// 2. 比较器处理：自定义比较器切换查找逻辑</span>
  <span class="hljs-keyword">if</span> (comparator) {
    isCommon = <span class="hljs-literal">false</span>;
    includes = arrayIncludesWith;
  }
  <span class="hljs-comment">// 3. 分层策略：大数组用Set，小数组用普通数组</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (length &gt;= <span class="hljs-variable constant_">LARGE_ARRAY_SIZE</span>) { <span class="hljs-comment">// LARGE_ARRAY_SIZE = 200</span>
    <span class="hljs-comment">// 无迭代器时直接用Set（最快）</span>
    <span class="hljs-keyword">var</span> set = iteratee ? <span class="hljs-literal">null</span> : <span class="hljs-title function_">createSet</span>(array);
    <span class="hljs-keyword">if</span> (set) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">setToArray</span>(set);
    }
    isCommon = <span class="hljs-literal">false</span>;
    includes = cacheHas;
    seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetCache</span>; <span class="hljs-comment">// O(1) 查找缓存</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 小数组：复用结果数组作为缓存</span>
    seen = iteratee ? [] : result;
  }

  <span class="hljs-comment">// 4. 核心遍历：短路逻辑 + 特殊值处理</span>
  <span class="hljs-attr">outer</span>:
  <span class="hljs-keyword">while</span> (++index &lt; length) {
    <span class="hljs-keyword">var</span> value = array[index],
        computed = iteratee ? <span class="hljs-title function_">iteratee</span>(value) : value;

    <span class="hljs-comment">// 特殊值处理：0和-0视为相同</span>
    value = (comparator || value !== <span class="hljs-number">0</span>) ? value : <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 普通场景：反向遍历缓存，减少比较次数</span>
    <span class="hljs-keyword">if</span> (isCommon &amp;&amp; computed === computed) {
      <span class="hljs-keyword">var</span> seenIndex = seen.<span class="hljs-property">length</span>;
      <span class="hljs-keyword">while</span> (seenIndex--) {
        <span class="hljs-keyword">if</span> (seen[seenIndex] === computed) {
          <span class="hljs-keyword">continue</span> outer; <span class="hljs-comment">// 短路：跳过重复值</span>
        }
      }
      <span class="hljs-keyword">if</span> (iteratee) {
        seen.<span class="hljs-title function_">push</span>(computed);
      }
      result.<span class="hljs-title function_">push</span>(value);
    }
    <span class="hljs-comment">// 非普通场景/NaN：缓存查找</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">includes</span>(seen, computed, comparator)) {
      <span class="hljs-keyword">if</span> (seen !== result) {
        seen.<span class="hljs-title function_">push</span>(computed);
      }
      result.<span class="hljs-title function_">push</span>(value);
    }
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>分层去重：200 为阈值，平衡 Set 初始化开销和查找效率；</li>
<li>特殊值兼容：处理 NaN、0/-0，弥补原生 Set 的部分缺陷；</li>
<li>反向遍历缓存：减少缓存比较次数，提升小数组去重效率。</li>
</ul>
<h4 data-id="heading-24"><code>_.intersection</code>：多数组交集的缓存优化</h4>
<p><strong>功能</strong>：计算多个数组的交集，返回新数组，仅保留所有数组都包含的元素。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> intersection = <span class="hljs-title function_">baseRest</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">arrays</span>) {
  <span class="hljs-comment">// 1. 参数归一化：转为数组/类数组，过滤无效输入</span>
  <span class="hljs-keyword">var</span> mapped = <span class="hljs-title function_">arrayMap</span>(arrays, castArrayLikeObject);
  
  <span class="hljs-comment">// 2. 早期返回：无有效输入返回空数组</span>
  <span class="hljs-keyword">return</span> (mapped.<span class="hljs-property">length</span> &amp;&amp; mapped[<span class="hljs-number">0</span>] === arrays[<span class="hljs-number">0</span>])
    ? <span class="hljs-title function_">baseIntersection</span>(mapped)
    : [];
});
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>最短数组优先：基于最短数组遍历，减少迭代次数；</li>
<li>缓存复用：对大数组创建 SetCache，查找效率从 O (n) 降为 O (1)；</li>
<li>参数归一化：统一处理类数组，提升兼容性。</li>
</ul>
<h4 data-id="heading-25"><code>_.xor</code>：对称差集的高效计算</h4>
<p><strong>功能</strong>：计算多个数组的对称差集，返回仅出现在一个数组中的元素。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> xor = <span class="hljs-title function_">baseRest</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">arrays</span>) {
  <span class="hljs-comment">// 1. 过滤无效输入：仅保留数组/类数组</span>
  <span class="hljs-comment">// 2. 底层复用：基于baseDifference实现，避免重复逻辑</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseXor</span>(<span class="hljs-title function_">arrayFilter</span>(arrays, isArrayLikeObject));
});
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>差集复用：基于 <code>baseDifference</code> 实现核心逻辑，减少代码冗余；</li>
<li>批量计算：一次性处理所有输入，减少中间数组创建。</li>
</ul>
<h3 data-id="heading-26">5. 其他高频函数：细节处的性能打磨</h3>
<h4 data-id="heading-27"><code>_.head</code>/<code>_.last</code>：首尾元素的直接访问</h4>
<p><strong>功能</strong>：快速获取数组第一个 / 最后一个元素，兼容空数组、非数组输入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 获取第一个元素</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">head</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 直接访问：无函数调用开销，空数组返回undefined</span>
  <span class="hljs-keyword">return</span> (array &amp;&amp; array.<span class="hljs-property">length</span>) ? array[<span class="hljs-number">0</span>] : <span class="hljs-literal">undefined</span>;
}

<span class="hljs-comment">// 获取最后一个元素</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">last</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 安全获取长度：处理null/undefined</span>
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 直接访问：避免slice(-1)[0]的额外开销</span>
  <span class="hljs-keyword">return</span> length ? array[length - <span class="hljs-number">1</span>] : <span class="hljs-literal">undefined</span>;
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>直接索引访问：比 <code>array.slice(0,1)[0]</code> 快数倍，无额外内存分配；</li>
<li>无冗余计算：仅做必要的长度判断，无循环 / 函数调用。</li>
</ul>
<h4 data-id="heading-28"><code>_.flatten</code>/<code>_.flattenDepth</code>：数组扁平化的深度控制</h4>
<p><strong>功能</strong>：将嵌套数组扁平化为一维（<code>flatten</code>）或指定深度（<code>flattenDepth</code>），返回新数组。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 扁平化1层（默认）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">flatten</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 早期返回：空数组直接返回，否则调用底层逻辑（深度1）</span>
  <span class="hljs-keyword">return</span> length ? <span class="hljs-title function_">baseFlatten</span>(array, <span class="hljs-number">1</span>) : [];
}

<span class="hljs-comment">// 支持指定深度</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">flattenDepth</span>(<span class="hljs-params">array, depth</span>) {
  <span class="hljs-keyword">var</span> length = array == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : array.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">if</span> (!length) {
    <span class="hljs-keyword">return</span> [];
  }
  <span class="hljs-comment">// 深度校准：未传depth默认1，转为整数确保合法</span>
  depth = depth === <span class="hljs-literal">undefined</span> ? <span class="hljs-number">1</span> : <span class="hljs-title function_">toInteger</span>(depth);
  <span class="hljs-comment">// 底层复用：迭代实现，避免递归栈溢出</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">baseFlatten</span>(array, depth);
}
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>深度控制：避免过度扁平化，减少无效遍历；</li>
<li>迭代代替递归：<code>baseFlatten</code> 用迭代实现，避免深层嵌套导致的栈溢出；</li>
<li>类型校验：仅扁平化数组 / 类数组，跳过普通对象。</li>
</ul>
<h4 data-id="heading-29"><code>_.without</code>：排除指定值的差集实现</h4>
<p><strong>功能</strong>：创建排除指定值的新数组，原数组不变，支持多值排除。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> without = <span class="hljs-title function_">baseRest</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">array, values</span>) {
  <span class="hljs-comment">// 1. 类型校验：仅处理数组/类数组，否则返回空数组</span>
  <span class="hljs-comment">// 2. 底层复用：基于baseDifference实现差集计算</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">isArrayLikeObject</span>(array)
    ? <span class="hljs-title function_">baseDifference</span>(array, values)
    : [];
});
</code></pre>
<p><strong>专属优化点</strong>：</p>
<ul>
<li>差集复用：直接使用 <code>baseDifference</code> 核心逻辑，避免重复代码；</li>
<li>可变参数：通过 <code>baseRest</code> 支持多值输入，提升易用性；</li>
<li>非破坏性：返回新数组，不修改原数组，兼顾不可变需求。</li>
</ul>
<h2 data-id="heading-30">三、核心总结</h2>
<p>Lodash 数组函数的高性能，是「通用优化策略 + 场景化定制」的双重结果，核心关键点可总结为：</p>
<ol>
<li><strong>性能分层设计</strong>：根据数组大小、有序性选择算法（二分 / Set / 线性），避免「一刀切」的低效；</li>
<li><strong>内存效率优先</strong>：预分配内存、原地修改、缓存复用，减少 GC 压力和内存重分配；</li>
<li><strong>细节极致打磨</strong>：位运算、while 循环、快速判空等小优化，叠加后产生显著效果；</li>
<li><strong>兼容与性能平衡</strong>：在鲁棒性（兼容 null/NaN/ 负数索引）和性能之间找到最优解，不牺牲易用性。</li>
</ol>
<p>这些优化思路不仅适用于数组操作，更是前端高性能编程的通用准则 —— 掌握这些逻辑，既能更高效地使用 Lodash，也能在手写代码时写出兼具性能与鲁棒性的逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零打造专业级前端 SDK (三)：健壮性与离线存储]]></title>    <link>https://juejin.cn/post/7596990822127534118</link>    <guid>https://juejin.cn/post/7596990822127534118</guid>    <pubDate>2026-01-20T05:32:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596990822127534118" data-draft-id="7597083743555616811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零打造专业级前端 SDK (三)：健壮性与离线存储"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-01-20T05:32:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个有故事的男同学"/> <meta itemprop="url" content="https://juejin.cn/user/3984285867966951"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零打造专业级前端 SDK (三)：健壮性与离线存储
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3984285867966951/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个有故事的男同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:32:52.000Z" title="Tue Jan 20 2026 05:32:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body ::selection{color:#fff;background-color:#ed7373}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:.6em;margin-top:1.5em;padding-bottom:4px;color:#ed7373}.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5,.markdown-body h6{font-size:14px}.markdown-body p{line-height:inherit;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border-top:1px solid #dfe1e6;margin:33px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:rgba(239,198,221,.2666666667);color:#7b164f;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==") 10px 10px no-repeat;background-size:40px;background-color:#fdf8f8}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#fdf8f8}.markdown-body a{position:relative;text-decoration:underline;text-decoration-color:#ffd4d4;color:#ed7373;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAAAXNSR0IArs4c6QAAD1lJREFUeF7tnV122zgShQHJG5gT9/OkV2J7JR3voI/U707eI5/eQeyVRFlJa56nc2YDFjkHEulWHP3g5xZYAK5eku6QYOFWfSwUAJLW8EcFqMBJBSy1oQJU4LQCBITRQQXOKEBAGB5UgIAwBqhAnALMIHG68axGFCAgjTia3YxTgIDE6cazGlGAgDTiaHYzTgECEqcbz2pEAQLSiKPZzTgFCEicbjyrEQUISCOOZjfjFCAgcbrxrEYUICCNOJrdjFOAgMTpxrMaUYCANOJodjNOAQISpxvPakQBAtKIo9nNOAUISJxuPKsRBQhII45GdfN/v//+/l9//rlBtae9HQKi3UOZ7ft7sfhgjfm3sfa9u3RvzHtrjPv77r8PfpvemB0o1v3Z95tuNvt29fKyqQkgApI5ADVebgeFtTfGmA8I+3pj1rbv17Ouey4dFgKCiIgC2/i+WDwYax0QbzMDtDcjLC67/PL58xraeIbGCEgGkTVd4vty+QWVKUL75WCZb7f3JWUVAhLq5UKPHzLGRyXmP822208lgEJAlESMlBlDfeGyhsafelAIiMawAdjkpmO38/kXa8wtoDnRJvq+v79+fHwSvUhk4wQkUjjNp/33jz9uZ33/VbONP9nW9x/fPT5+0mYzAdHmkUR7lNUaob1RN+QiIKEuVHz838vl1xKGVOck1DbTRUAUB7yvaSXVG5592sy22zsNs1wExNNjWg+rEI5XqWfb7a9TQ0JAtEa+h101wzF0f/JMQkA8AlHjIQ3AMco+KSQERGP0X7CpITj2Skw4BUxACgOkOThG/0wECQEpCJBm4Rh81Fl7l3tHMAEpBJCJ4Hjq+/7bvOt229THGSVny8vV1W6b/Kzrbnprb088VAVXN/fMFgGBuxDfYE443L4oB0TM9OqwxcVtjJR7xiTzUIuA4OMZ2mI2OICBN+wgfpACJWcWISDQcMY2lgMOt7XjerW6w1q+b03sqUUgzJf6TUAuKTTRv+eAI8f0qdSwK1cWISATAXDusjngyDkj5PrTzedu+z2uNsmURQiIMkBqg2OUVwKSHFmEgCgCpFY4xCDJkEUIiBJAaodjlBlZuEtOMIz2EhAFgLQCxxtIIG9YkR5mEZCJAWkNjldIlsu/EEW79AsfCMiEgLQKx8EaCSKLPL1bre6l3EhApJS90G7LcKCziOQwi4BMAAjh+GGlPTmLSK7pEJDMgBCOfwRHvb9Lsg4hIBkBIRw/i/0dUawLrocQkEyAEI7jQoPeNi9WqBOQDIAQjtMig16uTUAyxLHIJQjHeVkRdYjkijoziAgW+0YJx2VxEYAYYzbvVqtfL18t/AgCEq6Z1xmEw0um3U2km8/dqnrS791qJRLLIo0m9bSCkwmHvxNBgDCD+Es+7ZGEI0x/DrHC9Cr6aMIR7j7ELBaL9HDds59BOOIkB33wh9O8cfLnOYtwxOsM+egPV9LjHSB9JuFIU/j7ctmntSD7cmvOYiV6B3IHPGOD5E7VxK4nnw4q0A03Kya7QqYBwpGmK6j+MFJrIK53zCCRPgZtsjt59Zozh+s0aP3DNSW2BkJAIuFATE2eu3TtcLi+w24wggU6AYkABDVuPnXpFuAAZg8jrReHWAGQIB177LLSzg7oqtih4Dcsig6vmEECw0CyKG8BDic3VEPh4RUBCQAENePSaubY1R2LxYOxNvklDa8aEpCACBY+FLKgdcTGZjLHYvHBWuu+PoX6iQ+vmEE8XQW/8w3XJRyeDjhymOTi4OHlWKRf8JFUYU444uGQXvsgIAG+kcgesXAM6y83/fAhGtv36242+5b708i+8kmtF+XKHhxiTZA9YuDwCLSn2Xb7KebLtL7BHnqch82hTY7HZ6k9xotxiHXGTejsEQXHcvnVGnPrEU2b2XZ7pwESQTjEFwbf6kxAzgGCeOvf2H7ElGQMoDmHH8ekk4RD8snBU2FAQE4oAy7Og594S7p+BIweGeriIZJw5CzMWaRfdDV0UStqzByTPX7oVt9/nHXdc64hV41wsEjPMLyKqTucWZAtGZkyiTAc2esOZpBMs1cpY2bIW89dP4UhkYZj6pqKNcgRWFBb2lO+fAQDxBiTYse5e4k0HMaY4NrNY/QcdAgBOSJX8vjf3biNWV+vVndB3jg4GPZA0b5N+BSwNByp+sXqzmleD+UQgMTWHqN5AgEIg0TAtrdemTxzjAYxgxzLIMul23X6wYOlU4dEzVy9bQw5zNq1DahHpOGYuuZgBvGI+uQZJEAgOjOHWsjB+t7DbK9DUgIQkVnPGZmadb0ECDyIGeR4Bkl6mRnS0WhIYsf2LcLhQoOACACCfk8T+Dnu4BetJa3qe9yxkTcUj8sFHUJAjgPiPugSO6yB1B9vzUJCEppFBLPHprP2Xut2fWaQE/eSxOJYBJDR1ETbXnscUosk12THdVYPBwE5AUhiQIgCAswk3tO+As/ji2oUNIa6cDCHWOBp3tDhS4wzUZD4ZhEkIDn0idH01DkEBAyIaw5dpB9zHqgu8FqQgw3rEncXIAPft60qAXF32JRt3qnBJ7X36a1TUwPX926O2Pbiey3fwM11XBWADGsFv5n9o6m72SfnkJ2Iff98/fj4FCJo6mpxrmnLVJCdJj4wp+pRKhxVFOmeBXXwSw2S7s6glXQfqJPs3N0/+nufG0jCdbyGcT59neKYYjNIxKfPvGdtnCM8wTvpM587M8LhgOGPVwDHTAz4wofQQaqNIgGJgGOvX8CdPXVYEXKtFOcm2+k5zHI2hmx7yTXMTNHO59ziAEne9uAJCeChqaCM5eOsY8cA7PSqQw6vPWSt13rvjV1PnbXPmlfHQ7QuChBEMIQUjAnj7uCMFeI09GxW7N1+54+uuxkmRf4z77p1yuxhigZS5xYDCAKOUUTfdQrELFGOoVZqvRQLiFRQamq3CECQcPhObY5OSs4iATNFsYGRamMNxXSsdpfOUw8IGg4nSMgdE5JFhCEhIJfCPP7fVQOCmKE5Ik3wRrnUABxtkLpTJ9vnOXERH2blnqkWECE4ot42gsoiodnLN6wAmwm91kJ87anpOJWAABa/Tvso8m6ZfJf+xyLo9G/ytPduCqr/+O7x8VNNgY3qizpAROEwJnh4NQodskh20TnAgITUaEB7Lva9sANUAZI6XXlB++Q7N3KohdqKgrApZNKisPhONlcNIMJwBM1cnVMVEZDIWgShGwrW5GhU2IAKQBBOPqct+g4JqUcAwxpI/ZHpAS+Fse9l0qSARG869Ora/iA0HK7NmJ2tP5kMAASUzaLrsgA3FHvopICUljkOvZwKCQJcRCYL2ZtWbJQnGD4ZICXDMeo93MHdO3yD36Hlux/slG8hs1ec4r2IziSAgIYGJzuHuDtfVG44IGr6FzG8An1gNKdWvppqOi47ILA73wkVp3B4ICTJY37gDSbZFk3BLGFLVkBQsy6nhJgCjtEWn5oEMd6HagjIZBJBqanNbIBAHXtEwSnhODRn2EP2MPy/sTaBPWWHrN20aKYJiLe2ZANEcguJVkenvp/rrbOQcEz13XHNMByzLQsgktlDKxzoQADWHXvTOLzyclEWQMB3vteOtQKHxNZ/bi/x4kP+AzpS2YNw+Dn46FHMHt7iiWcQiexBOLz9e+xATu0GyCcKiMSaB+EI8O6xQ5k9ggQUBQSxV+iwN4QjyLfMHslyCX7EE157NHLnkyjIxziRemkEIA7VNiGWQcDTkk28VEAUjgI/XqOBGjFAgMV5E0WlJBxcFIxHTQQQ5PCqhbpDGo7ZdntX2ztz40M+7EwRQICzV9VnD2E4RJ6oDAuxso8WAQRVf9S+2isNB4vydDhlAFku+3TT4t9hBbi2eBPScBhjmpjYkHaUXkAqntaVhgPx3Il04JXSPhwQVIFe6/CKcJSCxt5OrYBUWZwTjrLgEAEEMYNV4xCBcJQHhwggoECoqsAEaXIywmq8oWjBCT7EgkzxVlSgEw4toR5nBwGJ083rLMLhJZPqg/CALJdfjDHubYPxvwoyCOGId7+mM+GAgAKj6BoEpAFrDgWkqASk5KKTcCiIaqAJcEBanuYlHMDIVNIUHJBWV9IJh5KIBpsBB8TZB/gssSlpJyrhAEelouakAPkr5psZb3QpolAnHIqiWcAUEUBQj9tq37BIOAQiUlmTMoAsFh+stW49JO2neD2EcKS5tpSzRQBBzGSNAmrMIoSjlPBOt1MEkKFQR9Qh6t5CTjjSg66kFiQBSd9yMiqpZKhFOEoKbYytYoAgh1muq1MPtQgHJuBKa0UMEOgwa6/qZqr3OxGO0sIaZ68sIIvFg7H2I87c/JBAnm85I0DJ+86AflXblCggAlkkayZBreec8j7hUMvFq2HygOCzyM54ya0obj/Zdj7/Yo25lXIh4ZBSFtuuOCBCWWQPiTHr+XZ7j3zvrHS9Mdp9vVrdYV3J1iQUyAOIUBY5EORptt1+SgFlAMN933z8trmE3juoCYeItCKNZgFEMoscquKCz/b9etZ1zz6wDFDcmP1QShQMZg6R+BVvNBsgw7qIWzwUD8RBtU1vzMb93Q5/DkH63u5tyGXH63CQmUM8nuEXyAbILovID7XgAiEa5LAKoeI0bWQFpEVICMc0gY26anZActUjKIFS2iEcKerpOHcSQIbn1r/mrgNySk44cqotd61JAHHdqRkSwiEXsLlbngwQ19EJZrbE9SUc4hJnvcCkgFQHiZLnVrJGUOUXmxyQUV/pjYHSfmzhc9XSGmpsXw0gBU8Bbzpr73/5/Hmt0cG0KU0BVYAcQOLeDp91pTtGRtYbMaqVdY46QMa6xPb9g+R282Q3sd5IlrCEBlQCMgqndJariDc+lhB8JdioGpDXAn7/IjrxregXHJa8pb6EgKCNPypQBCATg0IwGqamKEB+GHp13U1v7a3Q1vWnvu+/XT8+PjUcG+z6/lGJ8n+uVhmK+nHmK2QGzD0zsnZAzLtu7fOgVfmKsQe+ClQByLHOur1eL1dXO1Bs170C089mm6uXl92DVITBN0zaPa5aQNp1KXuOVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFTg//8JNVC78ovQAAAAAElFTkSuQmCC");background-size:100%}.markdown-body a:active,.markdown-body a:hover{opacity:.66}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #ed7373;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#ed7373}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#fdf2f2}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #ed7373;background-color:#fdf2f2}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ed7373}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{appearance:none;-webkit-appearance:none;-moz-appearance:none;outline:none;width:16px;height:16px;border-radius:2px;background-color:transparent;box-shadow:inset 0 0 0 1px rgba(28,31,35,.3490196078);vertical-align:middle;margin:0;transform:translateY(-2px)}.markdown-body input[type=checkbox]:checked{background-color:#ed7373;background-image:url("data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjFlbSIgaGVpZ2h0PSIxZW0iIGFyaWEtaGlkZGVuPSJ0cnVlIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTE3LjQxMSA3LjMwOGExLjUgMS41IDAgMDEuMjggMi4xMDNsLTYuNSA4LjVhMS41IDEuNSAwIDAxLTIuMzc1LjAxbC0zLjUtNC41YTEuNSAxLjUgMCAxMTIuMzY4LTEuODQybDIuMzA2IDIuOTY1IDUuMzE4LTYuOTU1YTEuNSAxLjUgMCAwMTIuMTAzLS4yOHoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=");box-shadow:inset 0 0 0 1px #ed7373}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">从零打造专业级前端 SDK (三)：健壮性与离线存储</h2>
<p><strong>前言</strong>：在<a href="https://juejin.cn/post/7583983152324411418" target="_blank" title="https://juejin.cn/post/7583983152324411418">上一篇</a>中，我们实现了多种网络发送策略，让 SDK 能够把数据发出去。但真实的网络环境是不可靠的——弱网、断网、高频触发都是常态。今天，我们要给 SDK 穿上一层"防弹衣"，打造一个<strong>永不丢单</strong>的健壮系统。</p>
<h3 data-id="heading-1">1. 痛点：脆弱的直接发送</h3>
<p>如果我们只是简单地调用 <code>fetch</code>，会遇到两个致命问题：</p>
<ol>
<li><strong>流量风暴</strong>：用户快速滑动列表，瞬间产生几十个请求，服务器压力山大。</li>
<li><strong>数据丢失</strong>：用户在地下停车场点击"支付"，因无网络导致请求失败，关键转化数据丢失。</li>
</ol>
<p>为了解决这些问题，我们需要引入两个核心机制：<strong>消息队列 (Queue)</strong> 和 <strong>离线存储 (Store)</strong> 。</p>
<h3 data-id="heading-2">2. 消息队列：削峰填谷</h3>
<p>我们不能来一个发一个，而是要"攒一攒"再发。这叫<strong>批处理 (Batching)</strong> 。</p>
<h4 data-id="heading-3">2.1 智能调度器 (Scheduler)</h4>
<p>我们创建一个 <code>Scheduler</code> 类来管理队列。它支持两种优先级：</p>
<ul>
<li><strong>immediate (高)</strong> ：支付、关键点击 -&gt; 立即发送。</li>
<li><strong>batch (低)</strong> ：曝光、滚动 -&gt; 攒够 10 条或 3 秒后发送。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// src/core/Scheduler.ts</span>
export <span class="hljs-keyword">class</span> <span class="hljs-title class_">Scheduler</span> {
  <span class="hljs-keyword">private</span> queue: TrackerEvent[] = [];
  <span class="hljs-keyword">private</span> timer: number | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  addEvent(event: TrackerEvent, priority: <span class="hljs-string">'immediate'</span> | <span class="hljs-string">'batch'</span> = <span class="hljs-string">'batch'</span>) {
    <span class="hljs-keyword">this</span>.queue.push(event);

    <span class="hljs-comment">// 1. 高优先级：立即发送 (队列里所有数据)</span>
    <span class="hljs-keyword">if</span> (priority === <span class="hljs-string">'immediate'</span>) {
      <span class="hljs-keyword">this</span>.flush();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 低优先级：启动定时器 (3秒兜底)</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.timer) {
      <span class="hljs-keyword">this</span>.timer = window.setTimeout(() =&gt; <span class="hljs-keyword">this</span>.flush(), <span class="hljs-number">3000</span>);
    }

    <span class="hljs-comment">// 3. 队列满了：立即发送 (10条阈值)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.queue.length &gt;= <span class="hljs-number">10</span>) {
      <span class="hljs-keyword">this</span>.flush();
    }
  }
}
</code></pre>
<h3 data-id="heading-4">3. 离线存储：IndexedDB 兜底</h3>
<p>当 <code>flush()</code> 发送失败时，数据不能丢，必须存起来。</p>
<h4 data-id="heading-5">3.1 为什么选 IndexedDB？</h4>


























<table><thead><tr><th>方案</th><th>容量</th><th>性能</th><th>结构化</th><th>结论</th></tr></thead><tbody><tr><td>localStorage</td><td>5MB</td><td>同步(卡顿)</td><td>仅字符串</td><td>❌ 仅适合玩具</td></tr><tr><td><strong>IndexedDB</strong></td><td><strong>&gt;250MB</strong></td><td><strong>异步</strong></td><td><strong>支持对象</strong></td><td>✅ 生产级首选</td></tr></tbody></table>
<h4 data-id="heading-6">3.2 仓库实现 (Store)</h4>
<p>我们封装一个轻量级的 <code>Store</code> 类，屏蔽 IndexedDB 的复杂 API。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/Store.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Store</span> {
  <span class="hljs-comment">// 发送失败时调用：存入数据库</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">events: TrackerEvent[]</span>) {
    <span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDB</span>();
    <span class="hljs-keyword">const</span> tx = db.<span class="hljs-title function_">transaction</span>(<span class="hljs-string">'events'</span>, <span class="hljs-string">'readwrite'</span>);
    events.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> tx.<span class="hljs-property">store</span>.<span class="hljs-title function_">add</span>(e));
  }

  <span class="hljs-comment">// 网络恢复时调用：取出所有数据</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAll</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// ...读取逻辑</span>
  }
}
</code></pre>
<h3 data-id="heading-7">4. 闭环：自动重试机制</h3>
<p>最精彩的部分来了。我们在 <code>Scheduler</code> 中监听浏览器的 <code>online</code> 事件，实现<strong>全自动恢复</strong>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src/core/Scheduler.ts</span>
<span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 监听网络恢复</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'online'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🌐 网络已恢复，正在重发积压数据...'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">retryFailedEvents</span>();
  });
}

<span class="hljs-keyword">async</span> <span class="hljs-title function_">retryFailedEvents</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 从 Store 取出所有积压数据</span>
  <span class="hljs-keyword">const</span> events = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">getAll</span>();
  <span class="hljs-keyword">if</span> (events.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 2. 尝试重发</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">sender</span>.<span class="hljs-title function_">send</span>(events);
    <span class="hljs-comment">// 3. 发送成功，清空 Store</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">clear</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ 重发成功！'</span>);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 4. 依然失败？没事，数据还在 Store 里，下次再试</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ 重发失败，等待下一次机会'</span>);
  }
}
</code></pre>
<h3 data-id="heading-8">5. 总结</h3>
<p>通过本篇的改造，我们的 SDK 进化了：</p>
<ul>
<li><strong>性能</strong>：请求数减少 90%（批处理）。</li>
<li><strong>可靠</strong>：弱网/断网环境下数据不丢失（离线存储）。</li>
</ul>
<p>现在，我们的 SDK 已经具备了商业级产品的核心素质。</p>
<p><strong>下一篇</strong>，我们将探讨如何让 SDK 走出浏览器，适配 <strong>Node.js</strong>、<strong>小程序</strong> 等多种运行时环境，实现真正的<strong>跨平台架构</strong>。</p>
<hr/>
<p><em>本文代码已开源，欢迎 Star</em> <em>⭐</em> <em>️</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 工程化（五）：企业级脚手架的设计与落地]]></title>    <link>https://juejin.cn/post/7596890557547298862</link>    <guid>https://juejin.cn/post/7596890557547298862</guid>    <pubDate>2026-01-20T05:37:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596890557547298862" data-draft-id="7596983314806833202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 工程化（五）：企业级脚手架的设计与落地"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T05:37:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 工程化（五）：企业级脚手架的设计与落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:37:58.000Z" title="Tue Jan 20 2026 05:37:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>很多团队都有一个“规范文档”，它通常静静地躺在 Wiki 的角落里，只有新员工入职的第一天会被打开，然后迅速被遗忘。</p>
<p><strong>依靠文档约束人性的规范，注定是失败的。</strong></p>
<p>在架构师的眼里，规范不应该是一个文档，而应该是一个<strong>产品</strong>——一个通过脚手架（CLI）和预设包（Presets）交付给开发者的“黑盒子”。开发者不需要知道 ESLint 的 <code>ecmaVersion</code> 是多少，也不需要纠结 Prettier 的 <code>semi</code> 是 true 还是 false，他们只需要打开盒子，直接开始工作。</p>
<p>本篇我们将探讨如何从“配置工程师”进化为“规范制定者”，通过工程化手段把标准“装进盒子里”，让错误根本无法发生。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fae9659af3e8490783668bfdb1fc1b5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492278&amp;x-signature=Pgk9MJ3vH3Bie8muCE6%2Fj3II9ws%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 熵增定律：为什么 Copy-Paste 是万恶之源？</h2>
<p>在没有脚手架体系的团队，新项目的建立通常源于一句：“你去把那个老项目的配置拷贝一份过来。”</p>
<p>这种“细胞分裂”式的工程创建方式，导致了严重的 <strong>配置熵增</strong>：</p>
<ol>
<li><strong>版本分裂：</strong> 项目 A 用的是 ESLint v7，项目 B 拷贝过去后升级到了 v8，项目 C 又拷贝了 A... 最终团队维护着 5 个版本的 Lint 规则。</li>
<li><strong>规则漂移：</strong> 张三觉得 <code>no-console</code> 很烦，在项目 B 里关掉了；李四觉得分号很丑，在项目 C 里去掉了。半年后，这两个项目的代码风格就像出自两个物种。</li>
<li><strong>基建升级灾难：</strong> 当架构师决定“我们需要在所有项目里引入 Commitlint”时，他发现他需要修改 100 个仓库的 <code>package.json</code>。这不仅是体力活，更是巨大的风险。</li>
</ol>
<p><strong>架构原则一：不要让开发者直接维护配置文件。配置文件应当作为依赖包被引入。</strong></p>
<hr/>
<h2 data-id="heading-1">二、 核心策略：Configuration as Dependency</h2>
<p>要解决上述问题，必须把配置从“项目内的文件”变成“npm 包”。</p>
<h3 data-id="heading-2">2.1 也就是 Shared Config</h3>
<p>在 Monorepo 或 npm 私有库中，我们需要维护一套核心的规范包：</p>
<ul>
<li><code>@company/eslint-config-react</code></li>
<li><code>@company/prettier-config</code></li>
<li><code>@company/tsconfig</code></li>
</ul>
<p>在业务项目中，<code>.eslintrc.js</code> 应该只有一行代码：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">module.exports</span> = {
  extends: <span class="hljs-section">['@company/eslint-config-react']</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-3">2.2 拥抱 ESLint Flat Config (Config System 的革命)</h3>
<p>2024 年以后的架构设计，必须正视 <strong>ESLint Flat Config (eslint.config.js)</strong> 的存在。 旧的 <code>.eslintrc</code> 级联系统极其复杂，导致 <code>extends</code> 覆盖逻辑经常失效。Flat Config 将配置视为一个<strong>扁平的对象数组</strong>，使得配置的组合、覆盖和共享变得符合直觉（就像合并数组一样简单）。</p>
<p><strong>架构师的职责</strong>，就是提前踩平 Flat Config 的坑，把它封装成一个开箱即用的 Plugin，屏蔽掉底层复杂的 Plugin 加载逻辑。</p>
<hr/>
<h2 data-id="heading-4">三、 门神：Husky 与 Git Hooks 的强制执行</h2>
<p>有了规范包，怎么保证开发者一定会遵守？靠自觉是不够的，必须有**“暴力”拦截**。</p>
<h3 data-id="heading-5">3.1 提交时的最后一道防线</h3>
<p>利用 <code>husky</code> + <code>lint-staged</code>，我们实现了“增量检查”。 不要试图在 commit 时检查全量代码，那会让 <code>git commit</code> 慢得像 <code>npm install</code>。只检查<strong>暂存区（Staged）</strong> 的文件，是工程体验和代码质量的最佳平衡点。</p>
<h3 data-id="heading-6">3.2 Commit Message 的标准化</h3>
<p>为什么提交信息也需要规范？ 如果你想做自动化发版（Automated Release）、自动生成 Changelog，那么 Commit Message 就必须符合 <strong>Conventional Commits</strong> 规范。</p>
<ul>
<li><code>feat: add login</code> -&gt; 触发 Minor 版本更新</li>
<li><code>fix: bug in style</code> -&gt; 触发 Patch 版本更新</li>
</ul>
<p>通过 <code>commitlint</code> 拦截乱写的提交信息，是通往自动化运维（DevOps）的必经之路。</p>
<hr/>
<h2 data-id="heading-7">四、 交付载体：脚手架（CLI）的架构设计</h2>
<p>当规范包和 Lint 工具都准备好了，我们需要一个载体把它们送达给开发者。这就是 <strong>CLI（Command Line Interface）</strong> 。</p>
<h3 data-id="heading-8">4.1 现代脚手架的技术选型</h3>
<p>别再用 Yeoman 了，也别只会 <code>git clone</code>。现代脚手架（如 <code>create-vite</code>, <code>create-next-app</code>）的架构已经非常成熟：</p>
<ul>
<li><strong>交互层：</strong> <code>prompts</code> (比 Inquirer 更轻量)</li>
<li><strong>参数解析：</strong> <code>cac</code> (比 Commander 更现代)</li>
<li><strong>模板引擎：</strong> 实际上，现代趋势是 <strong>去模板引擎化</strong>。直接拷贝预设好的文件夹结构（Template），然后修改个别文件（package.json name）。这种方式比 EJS 渲染更直观，维护成本更低。</li>
</ul>
<h3 data-id="heading-9">4.2 Preset 模式 vs Generator 模式</h3>
<ul>
<li><strong>Generator 模式（重逻辑）：</strong> 询问你“要不要 Router？”“要不要 Pinia？”，然后通过代码动态生成文件。维护成本高，容易出错。</li>
<li><strong>Preset 模式（重模板）：</strong> 维护几个标准的模板仓库（Template Repo），CLI 的作用仅仅是下载对应模板。 <strong>推荐架构：</strong> 对于企业内部，<strong>Preset 模式</strong> 更优。架构组维护 <code>template-react-admin</code>、<code>template-h5-activity</code> 等标准模板库，CLI 负责拉取和初始化。这实现了“模板与工具解耦”。</li>
</ul>
<hr/>
<h2 data-id="heading-10">五、 落地与治理：从技术到政治</h2>
<p>写出一个 CLI 很容易，让几百号人愿意用很难。这就是架构的<strong>政治属性</strong>。</p>
<h3 data-id="heading-11">5.1 存量治理的艺术</h3>
<p>对于老项目，不要试图“一刀切”地加上最严格的 ESLint 规则。那会导致满屏红线，开发者的第一反应就是 <code>/* eslint-disable */</code> 或者直接卸载插件。</p>
<p><strong>策略：</strong> 提供 <code>lint-fix</code> 脚本，并引入 <strong>"Warning First"</strong> 策略。先将新规则设为 Warning，给团队 1-2 个迭代的缓冲期，再逐步收紧为 Error。</p>
<h3 data-id="heading-12">5.2 零配置（Zero-Config）的幻觉</h3>
<p>大家都在吹捧“零配置”，但企业级架构 <strong>不能零配置</strong>。 你需要暴露必要的扩展点（Hooks）。比如，脚手架生成的 Webpack 配置，必须允许业务项目通过 <code>chainWebpack</code> 或 <code>mergeConfig</code> 进行覆盖。 <strong>架构师的智慧在于：提供完美的默认值，但保留修改的权利。</strong></p>
<hr/>
<h2 data-id="heading-13">结语：标准化的终极形态</h2>
<p>一个优秀的前端工程体系，应该让开发者感觉不到“规范”的存在。 当你 <code>git commit</code> 时，格式自动被格式化了；当你 <code>git push</code> 时，代码质量自动被检查了；当你初始化项目时，最佳实践已经自动就位了。</p>
<p>把标准装进盒子里，把自由还给开发者。</p>
<blockquote>
<p><strong>Next Step:</strong> 单个项目的规范治理虽然复杂，但还在可控范围内。如果我们将视角拉高，面对包含几十个子项目的 <strong>Monorepo（大仓）</strong> ，这些规范该如何复用？构建流程又该如何编排？ 下一节，我们将迎来工程化的“大结局”—— <strong>《第六篇：宏观——大仓时代：Monorepo 架构的工程实践与工具链选择》</strong> 。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Moshi 处理 Null 值并使用默认值的开脑洞解决方案]]></title>    <link>https://juejin.cn/post/7597083743555977259</link>    <guid>https://juejin.cn/post/7597083743555977259</guid>    <pubDate>2026-01-20T05:44:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083743555977259" data-draft-id="7596966040922161158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Moshi 处理 Null 值并使用默认值的开脑洞解决方案"/> <meta itemprop="keywords" content="APP,Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-20T05:44:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="limuyang2"/> <meta itemprop="url" content="https://juejin.cn/user/4283353029684126"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Moshi 处理 Null 值并使用默认值的开脑洞解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353029684126/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    limuyang2
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:44:23.000Z" title="Tue Jan 20 2026 05:44:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先看问题</h2>
<p>对于<code>Json</code>中的<code>Null</code>值，常规处理的方式给对象加一个<code>?</code>号。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"str"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"i"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"5"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>(
    <span class="hljs-keyword">val</span> str: String? = <span class="hljs-string">"abc"</span>, <span class="hljs-comment">// 必须加问号，否则会崩溃</span>
    <span class="hljs-keyword">val</span> i: <span class="hljs-built_in">Int</span> = <span class="hljs-number">1</span>,
)
</code></pre>
<p>这样就会有个问题，<code>str</code>会被赋值为<code>null</code>。</p>
<p>但是我们期望<code>null</code>值的时候，使用<code>abc</code>这个默认值，做不到。除非后台不返回这个<code>str</code>这个字段，就会使用默认值。</p>
<h2 data-id="heading-1">激烈讨论过程</h2>
<p>对于<code>null</code>这个问题的理解，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsquare%2Fmoshi%2Fissues%2F843" target="_blank" title="https://github.com/square/moshi/issues/843" ref="nofollow noopener noreferrer">Moshi Github</a>上有着非常激烈的讨论。</p>
<p>总结下来就是：官方认为，后台返回 <code>null</code>，是业务的一种形式，代表这个业务不存在。我们应该在团队合作中，约定一个规范的<code>Json</code>格式行为，而不是无脑区兜底<code>null</code>值。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">官方最终的解释：
It has one answer <span class="hljs-keyword">in</span> Moshi and <span class="hljs-keyword">this</span> <span class="hljs-keyword">is</span> Moshi<span class="hljs-string">'s opinion :).  
答案只有一个，那就是 Moshi 的看法:)。
</span></code></pre>
<p>好好好，<code>Moshi</code>团队你有你的看法。但是……但是，理想是很美好，我也想规范，但是现实不允许，先不说后台大哥好不好说话，就说历史API接口，没人敢动、也没人想动。</p>
<h2 data-id="heading-2">解决方案</h2>
<p>在<code>Github</code>的讨论中，不乏各种各样的解决方案，比如<code>JakeWharton</code>大神给出的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsquare%2Fmoshi%2Fissues%2F1809" target="_blank" title="https://github.com/square/moshi/issues/1809" ref="nofollow noopener noreferrer">自定义注解解决方案</a></p>
<p>这用起来很难，我不可能每个字段都去加吧。。。。。</p>
<p>在最后的回复，我看到了一个大开脑洞的方案，太巧妙了。</p>
<p><strong>自定义<code>JsonReader</code>，当读取到 <code>null</code> 的字段，直接忽略掉，欺骗上面的人，说这个字段不存在，上面的人就会用默认数值构造函数</strong>。太鸡贼了。无需用什么自定义注解，无痛切入现在的项目。</p>
<h4 data-id="heading-3">首先自定义 <code>DefaultIfNullFactory</code></h4>
<p>用于向<code>moshi</code>注册解析器，常规步骤，不多解析。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultIfNullFactory</span> : <span class="hljs-type">JsonAdapter.Factory</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(
        type: <span class="hljs-type">Type</span>,
        annotations: <span class="hljs-type">MutableSet</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">Annotation</span>&gt;,
        moshi: <span class="hljs-type">Moshi</span>
    )</span></span>: JsonAdapter&lt;*&gt;? {
        <span class="hljs-keyword">if</span> (annotations.isNotEmpty()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

        <span class="hljs-comment">// 基础数据类型忽略，moshi自己处理，就是直接是 基础数据类型的json：例如“1”，“true”</span>
        <span class="hljs-keyword">if</span> (type === String::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Boolean</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Byte</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Char</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Double</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Float</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Int</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Long</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Short</span>::<span class="hljs-keyword">class</span>.javaPrimitiveType) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Boolean</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Byte</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Char</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Double</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Float</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Int</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Long</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-built_in">Short</span>::<span class="hljs-keyword">class</span>.java) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>

        <span class="hljs-keyword">val</span> delegate = moshi.nextAdapter&lt;Any&gt;(<span class="hljs-keyword">this</span>, type, annotations)

        <span class="hljs-comment">// 对象类型的走我们自己的，例如打括号包起来的："{}"</span>
        <span class="hljs-keyword">return</span> SkipNullsAdapter(delegate)
    }
}
</code></pre>
<p><code>SkipNullsAdapter</code> 也没啥说的</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkipNullsAdapter</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> delegate: JsonAdapter&lt;Any&gt;
) : JsonAdapter&lt;Any&gt;() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fromJson</span><span class="hljs-params">(reader: <span class="hljs-type">JsonReader</span>)</span></span>: Any? {
        <span class="hljs-comment">// 如果是对象结构，才包装 reader 跳过 null</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (reader.peek() == JsonReader.Token.BEGIN_OBJECT) {
            <span class="hljs-comment">// 使用自己的 reader</span>
            delegate.fromJson(JsonReaderSkipNullValuesWrapper(reader))
        } <span class="hljs-keyword">else</span> {
            delegate.fromJson(reader)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toJson</span><span class="hljs-params">(writer: <span class="hljs-type">JsonWriter</span>, value: <span class="hljs-type">Any</span>?)</span></span> {
        delegate.toJson(writer, value)
    }
}
</code></pre>
<h4 data-id="heading-4">欺骗的艺术来了</h4>
<p>自己新建一个这个<code>com.squareup.moshi</code>包名（路径名）下，因为<code>JsonReader</code> 不允许外部继承。我们需要假装自己是它包里的类。</p>
<p>然后自定义一个<code>JsonReaderSkipNullValuesWrapper</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonReaderSkipNullValuesWrapper</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> wrapped: JsonReader
) : JsonReader() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> ignoreSkipName = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> ignoreSkipValue = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">close</span><span class="hljs-params">()</span></span> {
        wrapped.close()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">beginArray</span><span class="hljs-params">()</span></span> {
        wrapped.beginArray()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endArray</span><span class="hljs-params">()</span></span> {
        wrapped.endArray()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">beginObject</span><span class="hljs-params">()</span></span> {
        wrapped.beginObject()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endObject</span><span class="hljs-params">()</span></span> {
        wrapped.endObject()
        ignoreSkipName = <span class="hljs-literal">false</span>
        ignoreSkipValue = <span class="hljs-literal">false</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hasNext</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> wrapped.hasNext()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">peek</span><span class="hljs-params">()</span></span>: Token {
        <span class="hljs-keyword">return</span> wrapped.peek()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextName</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> wrapped.nextName()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">selectName</span><span class="hljs-params">(options: <span class="hljs-type">Options</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">val</span> index = wrapped.selectName(options)
        <span class="hljs-comment">// 这里进行欺骗，返回-1表示没有这个字段</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span> &amp;&amp; wrapped.peek() == Token.NULL) {
            wrapped.skipValue()
            ignoreSkipName = <span class="hljs-literal">true</span>
            ignoreSkipValue = <span class="hljs-literal">true</span>
            -<span class="hljs-number">1</span>
        } <span class="hljs-keyword">else</span> {
            index
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">skipName</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (ignoreSkipName) {
            ignoreSkipName = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">return</span>
        }
        wrapped.skipName()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextString</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> wrapped.nextString()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">selectString</span><span class="hljs-params">(options: <span class="hljs-type">Options</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> wrapped.selectString(options)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextBoolean</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> wrapped.nextBoolean()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any?&gt;</span> <span class="hljs-title">nextNull</span><span class="hljs-params">()</span></span>: T? {
        <span class="hljs-keyword">return</span> wrapped.nextNull()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextDouble</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Double</span> {
        <span class="hljs-keyword">return</span> wrapped.nextDouble()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextLong</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Long</span> {
        <span class="hljs-keyword">return</span> wrapped.nextLong()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextInt</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> wrapped.nextInt()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextSource</span><span class="hljs-params">()</span></span>: BufferedSource {
        <span class="hljs-keyword">return</span> wrapped.nextSource()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">skipValue</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (ignoreSkipValue) {
            ignoreSkipValue = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">return</span>
        }
        wrapped.skipValue()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">peekJson</span><span class="hljs-params">()</span></span>: JsonReader {
        <span class="hljs-keyword">return</span> wrapped.peekJson()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">promoteNameToValue</span><span class="hljs-params">()</span></span> {
        wrapped.promoteNameToValue()
    }
}
</code></pre>
<h4 data-id="heading-5">使用</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> moshi = Moshi.Builder()
    .add(DefaultIfNullFactory()) <span class="hljs-comment">// 注册进来</span>
    .build()
</code></pre>
<h4 data-id="heading-6">结果验证</h4>
<p>Json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"list"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"str"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"i"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"5"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>data class</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>(
    <span class="hljs-keyword">val</span> list: List&lt;<span class="hljs-built_in">Int</span>&gt;? = <span class="hljs-literal">null</span>, <span class="hljs-comment">// 如果想保持为null，就加上 ? 问号</span>

    <span class="hljs-keyword">val</span> str: String = <span class="hljs-string">"abc"</span>, <span class="hljs-comment">// 不想要 null，就不要加问号</span>

    <span class="hljs-keyword">val</span> i: <span class="hljs-built_in">Int</span> = <span class="hljs-number">1</span>,
)
</code></pre>
<p>输出</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Test(list=<span class="hljs-literal">null</span>, str=abc, i=<span class="hljs-number">5</span>)
</code></pre>
<p>解释下（AI生成的，我改了改。但是我觉得解释的足够清楚了）</p>
<h3 data-id="heading-7">工作原理</h3>
<p>这个类最核心的魔法发生在 <code>selectName()</code> 方法中：</p>
<ul>
<li>
<ol>
<li>它首先调用被包装的 <code>JsonReader</code> 的 <code>selectName()</code> 方法来查找下一个字段。</li>
</ol>
</li>
<li>
<ol start="2">
<li>如果找到了一个匹配的字段 (<code>index &gt;= 0</code>)，它会立刻用 <code>peek()</code> 方法查看该字段的值。</li>
</ol>
</li>
<li>
<ol start="3">
<li><strong>如果值是 <code>Token.NULL</code></strong>:</li>
</ol>
<ul>
<li>a. 它会立即调用 <code>skipValue()</code> 来消耗掉这个 <code>null</code> 值。</li>
<li>b. 然后它设置内部的 <code>ignoreSkipName</code> 和 <code>ignoreSkipValue</code> 标志位为 <code>true</code>。</li>
<li>c. 最后，它向调用者（KSP Adapter）<strong>谎称</strong>没有找到这个字段，返回 <code>-1</code>。</li>
</ul>
</li>
<li>
<ol start="4">
<li>KSP生成的Adapter收到<code>-1</code>后，会认为这是一个未知字段，并进入其 <code>case -1</code> 分支，该分支会尝试调用 <code>skipName()</code> 和 <code>skipValue()</code>，并使用属性的默认值。</li>
</ol>
</li>
<li>
<ol start="5">
<li>我们重写的 <code>skipName()</code> 和 <code>skipValue()</code> 方法会检查对应的 <code>ignore...</code> 标志位。如果为<code>true</code>，它们会消耗掉这个标志位并直接返回，从而“屏蔽”了KSP Adapter多余的跳过操作，避免了在错误的流位置上操作而导致的异常。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-8">结果</h3>
<p>通过上述流程，值为<code>null</code>的字段被巧妙地从解析流中移除。这使得Moshi的后续处理逻辑会认为该字段在JSON中“缺失”。</p>
<p>Kotlin 的 data class 中对应的非空属性 必须 要提供默认值（例如 <code>val name: String = ""</code>），Moshi会使用这个默认值。如果没有默认值会导致异常。</p>
<h3 data-id="heading-9">状态管理</h3>
<ul>
<li><code>ignoreSkipName</code> 和 <code>ignoreSkipValue</code> 是处理这种“欺骗”行为所必需的状态，它们确保了在 <code>selectName</code> 手动跳过一个键值对后，能够正确地拦截并忽略掉Adapter后续的、多余的 <code>skip</code> 调用。</li>
<li>在 <code>endObject()</code> 方法中，这些状态被强制重置。这是一个防御性措施，确保在一个对象解析作用域结束时，所有临时状态都被清理干净，防止状态泄露并污染到外层对象的解析。</li>
</ul>
<h2 data-id="heading-10">Bingo</h2>
<p>巧妙的思路</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不只是图片：深入理解 GIS 栅格数据本质与 GDAL 读写实战]]></title>    <link>https://juejin.cn/post/7597009443084664847</link>    <guid>https://juejin.cn/post/7597009443084664847</guid>    <pubDate>2026-01-20T05:43:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597009443084664847" data-draft-id="7596993862534250496" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不只是图片：深入理解 GIS 栅格数据本质与 GDAL 读写实战"/> <meta itemprop="keywords" content="GIS"/> <meta itemprop="datePublished" content="2026-01-20T05:43:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不只是图片：深入理解 GIS 栅格数据本质与 GDAL 读写实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:43:30.000Z" title="Tue Jan 20 2026 05:43:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>GIS 栅格数据只是一张普通图片吗？其实它可以是高程、降雨量、土地类型，甚至是二维空间信号。本文节选自新书<a href="https://link.juejin.cn?target=https%3A%2F%2Fitem.jd.com%2F14603137.html" target="_blank" title="https://item.jd.com/14603137.html" ref="nofollow noopener noreferrer">《GIS基础原理与技术实践》</a>第5章，带你穿透表象，掌握栅格数据的本质与 GDAL 开发核心技能。</p>
</blockquote>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/2bf65f3153b943e4a60f5c4aabfbb020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=RjeBNUMjDGjCHkUBCMD4gwx1TSg%3D" alt="GIS基础原理与技术实践" loading="lazy"/></p>
<h2 data-id="heading-0">第5章 地理空间数据之栅格</h2>
<h3 data-id="heading-1">导言</h3>
<p>在上一章节中，我们对地理空间数据进行了初步的介绍，并详细的论述了其表现形式之一的矢量数据。而在本章中，我们会详细论述地理空间数据的另外一种表现形式，也就是栅格数据。矢量和栅格是GIS地理空间数据最基础的两种数据类型，是一定需要理解和掌握的。</p>
<h3 data-id="heading-2">5.1 栅格数据的深入认识</h3>
<p>通过第4.1节中的介绍，我们对栅格数据有了一个初步的认识：栅格是地理空间连续实体的表达。接下来在本节中，我们会进一步探索栅格的技术细节，加深对栅格数据的理解。</p>
<h4 data-id="heading-3">5.1.1 离散还是连续</h4>
<p>记得笔者有一次跟同事争论，图像数据（也就是栅格数据）到底是离散的还是连续的？当时笔者还是个GIS菜鸟，认为图像是离散的。从前面介绍的知识来说，很显然栅格是地理的连续表达。与矢量只能知道具体的要素的坐标不同，我们可以很容易获取每一个栅格单元具体的地理坐标，体现了数据的连续性。然而，当我们把一张图像放大，我们很容易会看到一个个具体的栅格单元，如下图5.1所示：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/66df1775a12f4ec083c19658bbeee4c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=iNDunJFXMWUUT1xa0iKpQBk83R8%3D" alt="图5.1 放大后的栅格单元" loading="lazy"/></p>
<p>这些栅格单元中突变的颜色表明，栅格数据并不是我们想象的那样单纯的具有连续性。栅格数据对地理空间的表达总是会受制于采样频率，最直观的体现就是分辨率。如同现实中显示器一样，分辨率越高意味着像素的数目越多，显示效果就越精细。但是无论多精细，其实都是由离散的栅格单元在二维平面上连续铺盖成的格网组成的。如此说来，笔者在菜鸟时期认为栅格数据是离散的，可以说还是具有一定的正确性的，尽管是误打误撞。离散还是连续，并不是绝对的，关键还在于是如何看待和认知：</p>
<ul>
<li>在宏观意义上，栅格数据毫无疑问是连续的，这是区别与矢量数据的根本特性。只要是在栅格数据的范围之内，就可以获取任意位置的地理对象值。</li>
<li>在微观意义上，栅格数据也可以认为是离散的。受制于数据表达的载体，总会在一个无法细分的尺度上，用一个离散的栅格单元来代表一定连续范围内的地理对象值。</li>
</ul>
<p>栅格数据关于离散还是连续的讨论，我们在后面还会涉及到。</p>
<h4 data-id="heading-4">5.1.2 栅格的表现形式</h4>
<p>我们在4.1节中介绍过，栅格数据的一种具体表现形式就是我们经常见到的图片（有时称为图像，或者影像）。但是认为图片就是栅格，这种理解并不全面，栅格数据的内涵要丰富得多。</p>
<p>我们最常见的图片是24位真彩色图片，因为每个像素都由红绿蓝（RGB）3种颜色值混合而成，而每个波段的颜色值都由而一个8位整型表示。这样，真彩色图片能表示的颜色就有 256 X 256 X 256 = 16777216 种不同颜色，这恰好大于人类能识别1000万种颜色的限制。另外，出于数据叠加显示等目的，还会将第4个波段设置成透明度。其实透明度并不是一个颜色值，其是当前颜色值与背景颜色值的混合。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/686ca87b725242ce9dabea21ae821523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=y%2BULYpFurEznnpUhZgWBHbWJsoo%3D" alt="图5.2 国家天地图上的真彩色数字影像图" loading="lazy"/></p>
<p>在遥感领域，很多传感器并不是只能接受红绿蓝这三种可见光的波段，一些不可见的波段也可以接收到（比如红外波段），这主要取决于传感器的波长分辨率。因此，第4个波段也不一定就是透明度，而是其光谱的反射值或者辐射值。甚至于可以存在4个以上的波段。光谱的反射值也不一定就是8位整型，用于遥感探测的传感器要敏感的多，因此每个波段的光谱反射值是16位、32位甚至64位数值都是有可能的。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/61bdc944b0b949b8adbd7d574f974dca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=bEY%2BtNYyF3oggwySehck0uDFRcM%3D" alt="图5.3 遥感影像中的不可见光波段" loading="lazy"/></p>
<p>栅格数据中格网单元的取值可以是可见光的颜色，也可以是遥感获取的具体探测值。那么，存放其他类型的数据是可以的吗?当然也是可以的，比如我们可以在栅格数据中储存高程值，就可以表达地形，成为栅格形式的DEM（Digital Elevation Model，数字高程模型）数据。这一点我们会在后续的地形章节中专门论述它。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/5faaa1d52b7a404baadfa17030be3c5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=Zm7weBUTcHs4oZTH1SLuvd5le2w%3D" alt="图5.4 SRTM（Shuttle Radar Topography Mission，航天飞机雷达地形测量）地形数据晕渲图" loading="lazy"/></p>
<p>既然栅格单元可以存放高程，那么存放一些诸如表达降雨量，污染浓度这样的测量值，或者土地类型这样的分类值也是可以的——此类数据就是与业务紧密关联的专题栅格数据，具有很大的实用价值，可以在其基础之上进行专题分析，例如利用降雨量专题数据进行淹没分析。当然，专题栅格数据如果需要进行可视化的话，就需要进行转换。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/66788c88dd274e7ab005745cdda5f8ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=Noeti6Ueyotbh8828U0ECYwZqB0%3D" alt="图5.5 国家天地图上的人口密度专题图" loading="lazy"/></p>
<p>栅格数据（图像）还可以看成是信号。在常规的认知中，我们通常认为信号是随时间t变化的一种东西，比如电磁波或者声波。实际上，栅格数据（图像）可以认为是一个沿着空间分布、随着X空间轴和Y空间轴变化的二维信号。有这一点认知非常重要，因为很多栅格数据处理的算法都需要借助于信号的理论，比如我们后续会介绍的滤波。</p>
<p>最后，在数学中可以认为栅格数据就是一个很大的矩阵，可以进行复杂的矩阵运算。很多运算数据都可以转换成矩阵，从而被转换成图片格式来保存，这也与我们认知的常规图片不同。</p>
<h4 data-id="heading-5">5.1.3 正射还是透视</h4>
<p>以GIS中最常用的地图来说，我们至少有这样一个认识：地图上每一段相同距离所代表的实际距离都相等。如果不具备这样的特性，地图就不可能辅助我们进行导航等空间位置上的决策。在GIS中，大部分栅格数据就是这种具备相同比例尺的光学影像数据，它好像是很多道平行的光线同时反射到摄像机成像生成的，所以通常被称为数字正射影像图（DOM，Digital Orthophoto Map）。</p>
<p>但是在现实中，理想的正射成像模型几乎不存在，大多数摄像机都是透视成像模型，其生成的图像最大的特点就是近大远小，并且投影的光线会聚于一点。这也是真实的人眼成像的特点。其实，数字正射影像图就是通过透视成像模型的图片做几何纠正生成的，这一点在GIS的关联学科《摄影测量学》中有详细的介绍。如下图5.6所示为正射成像模型和透视成像模型示意图：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/3cde9d566ada4f4c96c337bee200ced3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=%2BlsjJEVy108ohq5kIu1tEqSQemE%3D" alt="图5.6 正射成像模型和透视成像模型" loading="lazy"/></p>
<p>正射还是透视只是图像的生成的两种不同的方式，并不会影响图像或者栅格数据本身的性质。在GIS中的栅格数据大多数指的是数字正射影像图，能够使用专业的GIS方法进行处理，这是常规的基于透视成像模型的图片所不具备的。</p>
<h3 data-id="heading-6">5.2 栅格数据开发基础</h3>
<h4 data-id="heading-7">5.2.1 栅格数据读取</h4>
<p>与矢量数据一样，可以使用第三方开源库GDAL来实现栅格数据的基础开发。GDAL提供了市面上绝大多数常见栅格数据的支持，并将其抽象成一个数据集对象。读取栅格数据的示例如下例5.1所示：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 例5.1 使用GDAL读取栅格数据</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gdal_priv.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">GDALAllRegister</span>();

  string srcFile = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  srcFile = srcFile + <span class="hljs-string">"/../Data/Raster/berry_ali_2011127_crop_geo.tif"</span>;

  GDALDataset* img = (GDALDataset*)<span class="hljs-built_in">GDALOpen</span>(srcFile.<span class="hljs-built_in">c_str</span>(), GA_ReadOnly);
  <span class="hljs-keyword">if</span> (!img) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  }

  <span class="hljs-type">int</span> imgWidth = img-&gt;<span class="hljs-built_in">GetRasterXSize</span>();   <span class="hljs-comment">//图像宽度</span>
  <span class="hljs-type">int</span> imgHeight = img-&gt;<span class="hljs-built_in">GetRasterYSize</span>();  <span class="hljs-comment">//图像高度</span>
  <span class="hljs-type">int</span> bandNum = img-&gt;<span class="hljs-built_in">GetRasterCount</span>();    <span class="hljs-comment">//波段数</span>
  <span class="hljs-type">int</span> depth = <span class="hljs-built_in">GDALGetDataTypeSize</span>(img-&gt;<span class="hljs-built_in">GetRasterBand</span>(<span class="hljs-number">1</span>)-&gt;<span class="hljs-built_in">GetRasterDataType</span>()) / <span class="hljs-number">8</span>;  <span class="hljs-comment">//图像深度</span>

  cout &lt;&lt; <span class="hljs-string">"宽度："</span> &lt;&lt; imgWidth &lt;&lt; <span class="hljs-string">'\n'</span>;
  cout &lt;&lt; <span class="hljs-string">"高度："</span> &lt;&lt; imgHeight &lt;&lt; <span class="hljs-string">'\n'</span>;
  cout &lt;&lt; <span class="hljs-string">"波段数："</span> &lt;&lt; bandNum &lt;&lt; <span class="hljs-string">'\n'</span>;
  cout &lt;&lt; <span class="hljs-string">"深度："</span> &lt;&lt; depth &lt;&lt; <span class="hljs-string">'\n'</span>;

  <span class="hljs-built_in">GDALClose</span>(img);
  img = <span class="hljs-literal">nullptr</span>;
}
</code></pre>
<p>在这个示例中，从栅格数据文件中创建了一个数据集对象，并且获取了影像的宽度、高度和波段数（通道数）和深度。深度有点难以理解，指的是栅格存储数据类型的字节数。常规的影像数据都采用8位无符号整型进行存储，因此深度都为1。
本例运行结果如下：</p>
<pre><code class="hljs language-bash" lang="bash">宽度：4000
高度：7200
波段数：4
深度：1
</code></pre>
<h4 data-id="heading-8">5.2.2 栅格数据创建</h4>
<p>另一方面，也可以根据一个数据集对象创建栅格数据文件，也就是栅格数据的写出操作。与第4.4.2节中创建矢量的步骤类似，同样通过GDAL的数据驱动GDALDriver，传入数据类型的名称来创建对应格式的栅格文件，如下例5.2所示，创建了一个tif格式的栅格数据：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 例5.2 使用GDAL创建栅格数据</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gdal_priv.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">GDALAllRegister</span>();  <span class="hljs-comment">//注册格式</span>

  string dstFile = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  dstFile = dstFile + <span class="hljs-string">"/../Data/Raster/dst.tif"</span>;

  GDALDriver* pDriver =
      <span class="hljs-built_in">GetGDALDriverManager</span>()-&gt;<span class="hljs-built_in">GetDriverByName</span>(<span class="hljs-string">"GTiff"</span>);  <span class="hljs-comment">//图像驱动</span>
  <span class="hljs-type">char</span>** ppszOptions = <span class="hljs-literal">NULL</span>;
  ppszOptions =
      <span class="hljs-built_in">CSLSetNameValue</span>(ppszOptions, <span class="hljs-string">"BIGTIFF"</span>, <span class="hljs-string">"IF_NEEDED"</span>);  <span class="hljs-comment">//配置图像信息</span>

  <span class="hljs-type">int</span> imgWidth = <span class="hljs-number">256</span>;
  <span class="hljs-type">int</span> imgHeight = <span class="hljs-number">256</span>;
  <span class="hljs-type">int</span> bandNum = <span class="hljs-number">3</span>;
  GDALDataset* dst = pDriver-&gt;<span class="hljs-built_in">Create</span>(dstFile.<span class="hljs-built_in">c_str</span>(), imgWidth, imgHeight,
                                     bandNum, GDT_Byte, ppszOptions);
  <span class="hljs-keyword">if</span> (!dst) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Can't Write Image!"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  }

  <span class="hljs-built_in">GDALClose</span>(dst); 
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>上例中我们创建了一个宽256，高256，波段数3，byte类型（8位，深度1）的栅格数据文件：</p>
<pre><code class="hljs language-cpp" lang="cpp">GDALDriver* pDriver =
      <span class="hljs-built_in">GetGDALDriverManager</span>()-&gt;<span class="hljs-built_in">GetDriverByName</span>(<span class="hljs-string">"GTiff"</span>);  <span class="hljs-comment">//图像驱动</span>
  <span class="hljs-comment">//...</span>
  GDALDataset* dst = pDriver-&gt;<span class="hljs-built_in">Create</span>(dstFile.<span class="hljs-built_in">c_str</span>(), imgWidth, imgHeight,
                                     bandNum, GDT_Byte, ppszOptions);
</code></pre>
<p>数据类型的名称“GTIFF”是GDAL定义的驱动名，表示创建的数据集对象是一个tif格式的栅格数据文件。一些常用栅格数据格式在GDAL中数据驱动如下表5.1所示：</p>


































<table><thead><tr><th>名称</th><th>全称</th></tr></thead><tbody><tr><td>JPEG</td><td>JPEG JFIF File Format</td></tr><tr><td>PNG</td><td>Portable Network Graphics</td></tr><tr><td>BMP</td><td>Microsoft Windows Device Independent Bitmap</td></tr><tr><td>GTiff</td><td>GeoTIFF File Format</td></tr><tr><td>HFA</td><td>Erdas Imagine .img</td></tr><tr><td>ENVI</td><td>ENVI .hdr Labelled Raster</td></tr></tbody></table>
<p>其中，JPEG、PNG和BMP就是我们经常见到的图像数据格式；GTiff（GeoTIFF）、HFA（Erdas Imagine .img）和ENVI（ENVI .hdr Labelled Raster）则是专业的GIS栅格数据。前者通用性更强，能被常规的图片软件所识别；而后者专业性更高，一些栅格数据的特性常规图像数据无法支持（例如存在数据量大小限制），因此只能使用专业GIS栅格数据，一般情况仅被GIS相关的软件支持。</p>
<p>另一点值得注意的是，在创建特定数据集对象时，可以根据特定格式的需求进行配置：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">char</span>** ppszOptions = <span class="hljs-literal">NULL</span>;
  ppszOptions =
      <span class="hljs-built_in">CSLSetNameValue</span>(ppszOptions, <span class="hljs-string">"BIGTIFF"</span>, <span class="hljs-string">"IF_NEEDED"</span>);  <span class="hljs-comment">//配置图像信息</span>
  <span class="hljs-comment">//...</span>
  GDALDataset* dst = pDriver-&gt;<span class="hljs-built_in">Create</span>(dstFile.<span class="hljs-built_in">c_str</span>(), imgWidth, imgHeight,
                                     bandNum, GDT_Byte, ppszOptions);
</code></pre>
<p>这里配置参数的意思是，在需要的时候使用“BIGTIFF”格式而不是“TIFF”，以避免当栅格数据文件的大小超过4G的时候会创建失败。</p>
<p>最后，在创建数据集完成之后，不要忘了关闭数据集：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-built_in">GDALClose</span>(dst);
</code></pre>
<p>此时创建的数据集文件就是一张黑色的栅格图片（因为关闭后默认填充0像素值），如下图5.7所示：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/3e0cfa70419a44479c4a90a01144a6b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1768974156&amp;x-orig-sign=E7fN5YXx2DcfOM1dfNxHJhtF6%2B0%3D" alt="图5.7 创建的栅格数据集文件" loading="lazy"/></p>
<hr/>
<p>本文节选自作者新书《GIS基础原理与技术实践》第5章。书中系统讲解 GIS 核心理论与多语言实战，适合开发者与高校师生。</p>
<p>📚 <strong>配套资源开源</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffafa1899%2FGISBasic" target="_blank" title="https://github.com/fafa1899/GISBasic" ref="nofollow noopener noreferrer">GitHub</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fcharlee44%2FGISBasic" target="_blank" title="https://gitcode.com/charlee44/GISBasic" ref="nofollow noopener noreferrer">GitCode</a></p>
<p>🛒 <strong>支持正版</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitem.jd.com%2F14603137.html" target="_blank" title="https://item.jd.com/14603137.html" ref="nofollow noopener noreferrer">京东</a>｜<a href="https://link.juejin.cn?target=https%3A%2F%2Fproduct.dangdang.com%2F29988568.html" target="_blank" title="https://product.dangdang.com/29988568.html" ref="nofollow noopener noreferrer">当当</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用瑞士风格哈希表实现更快的 ES|QL 统计]]></title>    <link>https://juejin.cn/post/7597058281435578422</link>    <guid>https://juejin.cn/post/7597058281435578422</guid>    <pubDate>2026-01-20T05:36:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597058281435578422" data-draft-id="7597058281435562038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用瑞士风格哈希表实现更快的 ES|QL 统计"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2026-01-20T05:36:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用瑞士风格哈希表实现更快的 ES|QL 统计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:36:47.000Z" title="Tue Jan 20 2026 05:36:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fchris-hegarty" title="https://www.elastic.co/search-labs/author/chris-hegarty" target="_blank" ref="nofollow noopener noreferrer">Chris Hegarty</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fmatthew-alp" title="https://www.elastic.co/search-labs/author/matthew-alp" target="_blank" ref="nofollow noopener noreferrer">Matthew Alp</a> 及 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fnik-everet" title="https://www.elastic.co/search-labs/author/nik-everet" target="_blank" ref="nofollow noopener noreferrer">Nik Everet</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47135a0cbada4492945bae87c6e48bb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492207&amp;x-signature=GmMkIkhcYw5h2wbGxmRtoIBnt6M%3D" alt="" loading="lazy"/></p>
<p>瑞士风格启发的哈希和 SIMD 友好的设计如何在 Elasticsearch Query Language ( ES|QL ) 中提供稳定且可衡量的性能提升。</p>
<p>动手使用 Elasticsearch：深入我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch-labs%3Ftab%3Dreadme-ov-file" title="https://github.com/elastic/elasticsearch-labs?tab=readme-ov-file" target="_blank" ref="nofollow noopener noreferrer">示例 notebooks</a>，开始<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Fcloud-trial-overview" title="https://www.elastic.co/cloud/cloud-trial-overview" target="_blank" ref="nofollow noopener noreferrer">免费 cloud trial</a>，或现在在你的<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143747798" title="https://elasticstack.blog.csdn.net/article/details/143747798" target="_blank" ref="nofollow noopener noreferrer">本地机器</a>上试用 Elastic。</p>
<hr/>
<p>我们最近将 Elasticsearch 的哈希表实现的关键部分替换为瑞士风格设计，并在均匀、高基数的工作负载上观察到构建和迭代时间提高了 2–3 倍。结果是更低的延迟、更高的吞吐量，以及 Elasticsearch Query Language ( <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fquery-filter%2Flanguages%2Fesql" title="https://www.elastic.co/docs/explore-analyze/query-filter/languages/esql" target="_blank" ref="nofollow noopener noreferrer">ES|QL</a> ) 统计和分析操作更可预测的性能。</p>
<h2 data-id="heading-0">为什么这很重要</h2>
<p>大多数典型的分析工作流最终归结为对数据进行分组。无论是计算每个 host 的平均字节数、统计每个用户的事件，还是跨维度聚合指标，核心操作都是相同的 —— 将 keys 映射到组并更新运行中的 aggregates。</p>
<p>在小规模下，几乎任何合理的哈希表都能正常工作。在大规模下（数亿文档和数百万个不同组），细节开始重要。负载因子、探测策略、内存布局和缓存行为可能决定性能是线性的还是满是缓存未命中的墙。</p>
<p>Elasticsearch 多年来一直支持这些工作负载，但我们始终在寻找现代化核心算法的机会。因此，我们评估了一种受瑞士表启发的新方法，并将其应用于 ES|QL 计算统计的方式。</p>
<h2 data-id="heading-1">瑞士表到底是什么？</h2>
<p>瑞士表是一类现代哈希表，由 Google 的 SwissTable 推广，后来被 Abseil 和其他库采用。</p>
<p>传统哈希表在追踪指针或加载 keys 时花费大量时间，结果却发现不匹配。瑞士表的定义特征是能够使用一个小型驻缓存数组结构来拒绝大多数探测，该结构与 keys 和 values 分开存储，称为 control bytes，从而显著减少内存流量。</p>
<p>每个控制 byte 表示一个 slot，在我们的例子中编码两件事：该 slot 是否为空，以及从 hash 派生的短 fingerprint。这些控制 bytes 在内存中连续排列，通常以 16 个为一组，非常适合<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FSingle_instruction%2C_multiple_data" title="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data" target="_blank" ref="nofollow noopener noreferrer">单指令多数据</a> (SIMD) 处理。</p>
<p>瑞士表不是一次探测一个 slot，而是使用向量指令扫描整个 control-byte 块。在一次操作中，CPU 将进入的 key 的 fingerprint 与 16 个 slots 比较，并过滤掉空条目。只有少数通过此快速路径的候选项需要加载和比较实际 keys。</p>
<p>这种设计用少量额外的元数据换取更好的缓存局部性和更少的随机加载。随着表的增长和探测链的延长，这些特性变得越来越有价值。</p>
<h2 data-id="heading-2">SIMD是核心</h2>
<p>真正的主角是 SIMD。</p>
<p>控制 bytes 不仅紧凑，而且专门设计为可以使用向量指令处理。一次 SIMD 比较可以同时检查 16 个 fingerprints，将原本的循环变成少量的宽操作。例如：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d0aea68632e4f7fbeeac3ae3a0fc6c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492207&amp;x-signature=C5iZLHj0XVIoSIuvHzaLJUciE%2FE%3D" alt="" loading="lazy"/></p>
<p>在实践中，这意味着：</p>
<ul>
<li>更少的分支</li>
<li>更短的探测链</li>
<li>更少从 key 和 value 内存的加载</li>
<li>CPU 执行单元的利用率大幅提高</li>
</ul>
<p>大多数查找从未超过控制-byte 扫描阶段。当查找超过时，剩余工作集中且可预测。这正是现代 CPU 擅长处理的工作负载类型。</p>
<h2 data-id="heading-3">SIMD底层原理</h2>
<p>对于喜欢深入了解底层的读者，以下是将新 key 插入表时发生的情况。我们使用 Panama Vector API 和 128 位向量，因此可以并行处理 16 个控制 bytes。</p>
<p>下面的代码片段显示了在带 AVX-512 的 Intel Rocket Lake 上生成的代码。虽然指令反映了该环境，但设计并不依赖于 AVX-512。在其他平台上使用等效指令（例如 AVX2、SSE 或 NEON）也会生成相同的高层向量操作。</p>
<pre><code class="hljs language-ini" lang="ini">`

1.  <span class="hljs-comment">; Load 16 control bytes from the control block</span>
2.  vmovdqu xmm0, XMMWORD PTR <span class="hljs-section">[r9+r10*1+0x10]</span>

4.  <span class="hljs-comment">; Broadcast the 7-bit fingerprint of the new key across the vector</span>
5.  vpbroadcastb xmm1, r11d

7.  <span class="hljs-comment">; Compare all 16 control bytes to the new fingerprint</span>
8.  vpcmpeqb k7, xmm0, xmm1
9.  kmovq rbx, k7

11.  <span class="hljs-comment">; Check if any matches were found</span>
12.  test rbx, rbx
13.  jne &lt;handle_match&gt;

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>每条指令在插入过程中都有明确作用：</p>
<ul>
<li>vmovdqu：将 16 个连续的控制 bytes 加载到 128 位 xmm0 寄存器中</li>
<li>vpbroadcastb：将新 key 的 7 位 fingerprint 在 xmm1 寄存器的所有通道中复制</li>
<li>vpcmpeqb：将每个控制 byte 与广播的 fingerprint 比较，生成潜在匹配的掩码</li>
<li>kmovq + test：将掩码移动到通用寄存器，并快速检查是否存在匹配</li>
</ul>
<p>最后，使用更宽的寄存器和相应指令在我们的基准测试中未显示出明显的性能提升。</p>
<h2 data-id="heading-4">ES|QL中的集成</h2>
<p>在 Elasticsearch 中采用瑞士风格哈希并不是直接替换。ES|QL 对内存计算、安全性以及与其他计算引擎的集成有严格要求。</p>
<p>我们将新的哈希表与 Elasticsearch 的内存管理紧密集成，包括页面回收器和 circuit breaker 计数，确保分配保持可见且受限。Elasticsearch 的聚合数据密集存储，并按 group ID 索引，使内存布局紧凑、迭代快速，同时通过允许随机访问实现某些性能优化。</p>
<p>对于可变长度的字节 keys，我们将完整 hash 与 group ID 一起缓存。这避免了在探测过程中重新计算昂贵的 hash 码，并通过将相关元数据靠近存放来提高缓存局部性。在 rehash 过程中，我们可以依赖缓存的 hash 和控制 bytes，而无需检查值本身，从而保持调整大小成本低。</p>
<p>我们实现中的一个重要简化是条目从不删除。这消除了 tombstones（标记以前占用的 slots）的需求，使空 slot 保持真正空闲，进一步改善探测行为并保持控制-byte 扫描高效。</p>
<p>结果是一个自然适应 Elasticsearch 执行模型的设计，同时保留了瑞士表吸引人的性能特性。</p>
<h2 data-id="heading-5">性能如何？</h2>
<p>在小基数下，瑞士表的性能大致与现有实现相当。这是预期的：当表较小时，缓存效应影响较小，几乎没有需要优化的探测。</p>
<p>随着基数增加，情况会迅速变化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a46e11f040f1404fb6d9f683a9cb9a5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492207&amp;x-signature=BvJxcOO0Udk6bjDMI%2FX9X21jFLY%3D" alt="" loading="lazy"/></p>
<p>上方的热图显示了不同 key 大小（8、32、64 和 128 bytes）在基数从 1,000 到 10,000,000 组下的时间提升因子。随着基数增加，提升因子稳步上升，在均匀分布下可达到 2–3 倍。</p>
<p>这一趋势正是设计所预测的。传统哈希表中基数越高，探测链越长，而瑞士风格探测则继续在 SIMD 友好的控制-byte 块中解决大多数查找。</p>
<h2 data-id="heading-6">缓存行为说明一切</h2>
<p>为了更好理解速度提升，我们在 Linux perf 下运行相同的 JMH <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch%2Fpull%2F139343%2Ffiles%23diff-d0e0cc91a7495bf36b2d44eacce95f5185d01879e5f6c38089ac7a89aad17da7" title="https://github.com/elastic/elasticsearch/pull/139343/files#diff-d0e0cc91a7495bf36b2d44eacce95f5185d01879e5f6c38089ac7a89aad17da7" target="_blank" ref="nofollow noopener noreferrer">基准测试</a>，并捕获缓存和 TLB 统计数据。</p>
<p>与原实现相比，瑞士版本总体缓存引用减少约 60%。最后一级缓存（LLC）加载下降超过 4 倍，LLC 加载未命中下降超过 6 倍。由于 LLC 未命中通常直接转化为主内存访问，仅这一减少就解释了端到端性能提升的大部分。</p>
<p>靠近 CPU 层面，我们看到 L1 数据缓存未命中减少，数据 TLB 未命中几乎减少 6 倍，显示出更紧密的空间局部性和更可预测的内存访问模式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5be1f742b284fc7a4aaf489263fe372~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492207&amp;x-signature=YYzCMoYJvLBF1aVa1kHd2tnM6SI%3D" alt="" loading="lazy"/></p>
<p>这就是 SIMD 友好控制 bytes 的实际收益。大多数探测通过扫描紧凑、驻缓存的结构即可解决，而无需反复从分散的内存位置加载 keys 和 values。访问的内存越少，未命中越少，未命中越少，查询就越快。</p>
<h2 data-id="heading-7">总结</h2>
<p>通过采用瑞士风格哈希表设计，并充分利用 SIMD 友好探测，我们在高基数 ES|QL 统计工作负载上实现了 2–3 倍的加速，同时性能更加稳定且可预测。</p>
<p>这项工作强调了现代 CPU 感知数据结构如何释放可观的性能增益，即使是针对哈希表等已被广泛研究的问题。这里还有更多探索空间，例如额外的基本类型特化，以及在其他高基数路径（如 joins）中的应用，这些都只是持续现代化 Elasticsearch 内部的更广泛努力的一部分。</p>
<p>如果你对细节感兴趣或想跟踪这项工作，可以查看 Github 上的这个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch%2Fpull%2F139343" title="https://github.com/elastic/elasticsearch/pull/139343" target="_blank" ref="nofollow noopener noreferrer">pull request</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch%2Fissues%2F138799" title="https://github.com/elastic/elasticsearch/issues/138799" target="_blank" ref="nofollow noopener noreferrer">meta issue</a>。</p>
<p>祝哈希愉快！</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fesql-swiss-hash-stats" title="https://www.elastic.co/search-labs/blog/esql-swiss-hash-stats" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript函数指南]]></title>    <link>https://juejin.cn/post/7596991930984628275</link>    <guid>https://juejin.cn/post/7596991930984628275</guid>    <pubDate>2026-01-20T05:38:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596991930984628275" data-draft-id="7596998306380595250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript函数指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T05:38:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript函数指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:38:52.000Z" title="Tue Jan 20 2026 05:38:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 TypeScript 中，函数不再是简单的代码块，而是具有精确类型约束的可组合单元。本文将深入讲解 TypeScript 函数，掌握从基础声明到多态模式的完整知识体系。</p>
</blockquote>
<h2 data-id="heading-0">函数声明与调用</h2>
<h3 data-id="heading-1">函数声明</h3>
<p>在之前的文章中，我们介绍过 <code>函数（Function）</code> 也是 TypeScript 中的数据类型的一种，在 TypeScript 中，函数是这样的：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
	<span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<blockquote>
<p>注：上述代码只是为了完整的函数声明展示，实际开发中，我们只会显式声明函数的参数（上述例子中的 a 和 b）；而返回类型是不用显式声明的，毕竟 TypeScript 能自己推导的事，没必要人为再操作一次。</p>
</blockquote>
<p>在 TypeScript 中，支持以下五种函数声明方式。</p>
<h4 data-id="heading-2">普通具名函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) {
	<span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<h4 data-id="heading-3">函数表达式</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> greet = <span class="hljs-keyword">function</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
};
</code></pre>
<h4 data-id="heading-4">箭头函数</h4>
<ul>
<li>简单的箭头函数语法：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> greet = (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
};
</code></pre>
<ul>
<li>箭头函数的简写形式：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">greet</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt; <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
</code></pre>
<h4 data-id="heading-5">类方法声明</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
    <span class="hljs-comment">// 实例方法</span>
    <span class="hljs-title function_">add</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-keyword">return</span> x + y;
    }
    
    <span class="hljs-comment">// 静态方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-keyword">return</span> x * y;
    }
    
    <span class="hljs-comment">// 可选方法</span>
    optionalMethod?(<span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span>;
}
</code></pre>
<h4 data-id="heading-6">构造函数声明</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
        <span class="hljs-keyword">public</span> name: <span class="hljs-built_in">string</span>,
        <span class="hljs-keyword">public</span> age: <span class="hljs-built_in">number</span>,
        <span class="hljs-keyword">private</span> id?: <span class="hljs-built_in">string</span>
    </span>) {}
}

<span class="hljs-comment">// 构造签名类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserConstructor</span> = <span class="hljs-keyword">new</span> (<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>) =&gt; <span class="hljs-title class_">User</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">Ctor: UserConstructor, name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ctor</span>(name, age);
}
</code></pre>
<h2 data-id="heading-7">函数重载</h2>
<p>在本节开始之前，先看一条定理：</p>
<pre><code class="hljs language-bash" lang="bash">不能基于 TypeScript 来重载一个函数。
</code></pre>
<p>这句话到底是什么意思呢？我们来看一个简单的示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>, b:<span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a:<span class="hljs-built_in">string</span>, b:<span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p>上述示例代码会报错：<code>函数实现重复</code> ，即我们不能通过类似Java、C++ 等语言形式，通过参数类型不同来实现函数重载。那么，在 TypeScript 中，我们应该如何操作呢？</p>
<ul>
<li>为一个函数提供多个声明，但只有一个实现：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">string</span>, b: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>, b: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">"number"</span> &amp;&amp; <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">"number"</span>) {
    <span class="hljs-keyword">return</span> a + b; <span class="hljs-comment">// 数字相加</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">"string"</span> &amp;&amp; <span class="hljs-keyword">typeof</span> b === <span class="hljs-string">"string"</span>) {
    <span class="hljs-keyword">return</span> a + b; <span class="hljs-comment">// 字符串拼接</span>
  }
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"参数必须同时为number或string"</span>);
}
</code></pre>
<p>上述代码中，前两个 add 函数的声明，只提供类型信息，当 TypeScript 生成 JavaScript 时，它们会自动移除，只留下实现。</p>
<blockquote>
<p>上述代码只是一个简单的重载示例，本身是存在缺陷的，上述情况下，我们应优先选择条件类型，而不是重载声明。</p>
</blockquote>
<h2 data-id="heading-8">多态函数与泛型</h2>
<h3 data-id="heading-9">什么是多态</h3>
<p><strong>多态</strong> 顾名思义，意味着"多种形态"。在 TypeScript 中，多态主要通过泛型实现，它允许我们编写可以处理多种类型的代码，同时保持类型安全。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 非多态版本：为每种类型写一个函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">identityString</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">identityNumber</span>(<span class="hljs-params">value: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">identityBoolean</span>(<span class="hljs-params">value: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// 多态版本：一个函数处理所有类型</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// 可以处理任意类型</span>
<span class="hljs-title function_">identity</span>(<span class="hljs-string">"hello"</span>);   <span class="hljs-comment">// string</span>
<span class="hljs-title function_">identity</span>(<span class="hljs-number">42</span>);        <span class="hljs-comment">// number</span>
<span class="hljs-title function_">identity</span>(<span class="hljs-literal">true</span>);      <span class="hljs-comment">// boolean</span>
<span class="hljs-title function_">identity</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// number[]</span>
</code></pre>
<h3 data-id="heading-10">什么是泛型</h3>
<p><strong>泛型</strong> 是类型系统中的类型参数，它允许我们在定义函数、接口、类时声明类型变量，在使用时再指定具体类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 泛型就像函数的参数，但是针对类型</span>
<span class="hljs-comment">// 普通函数参数：在调用时传递值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> x + y;
}

<span class="hljs-comment">// 泛型函数：在调用时传递类型</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// T 是类型参数，就像 value 是值参数</span>
</code></pre>
<h3 data-id="heading-11">何时使用泛型？</h3>
<h4 data-id="heading-12">当需要保持输入输出类型一致时</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 示例1：身份函数</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// 示例2：数组包装</span>
<span class="hljs-keyword">function</span> wrapInArray&lt;T&gt;(<span class="hljs-attr">value</span>: T): T[] {
    <span class="hljs-keyword">return</span> [value];
}

<span class="hljs-comment">// 示例3：交换函数</span>
<span class="hljs-keyword">function</span> swap&lt;T, U&gt;(<span class="hljs-attr">pair</span>: [T, U]): [U, T] {
    <span class="hljs-keyword">return</span> [pair[<span class="hljs-number">1</span>], pair[<span class="hljs-number">0</span>]];
}

<span class="hljs-keyword">const</span> swapped = <span class="hljs-title function_">swap</span>([<span class="hljs-number">1</span>, <span class="hljs-string">"hello"</span>]); <span class="hljs-comment">// ["hello", 1]</span>
</code></pre>
<h4 data-id="heading-13">当函数逻辑与具体类型无关时</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 处理数组的函数，不关心数组元素的类型</span>
<span class="hljs-keyword">function</span> getLast&lt;T&gt;(<span class="hljs-attr">array</span>: T[]): T | <span class="hljs-literal">undefined</span> {
    <span class="hljs-keyword">return</span> array[array.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
}

<span class="hljs-comment">// 映射函数，转换逻辑由调用者提供</span>
<span class="hljs-keyword">function</span> mapArray&lt;T, U&gt;(
    <span class="hljs-attr">array</span>: T[],
    <span class="hljs-attr">mapper</span>: <span class="hljs-function">(<span class="hljs-params">item: T, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> U
): U[] {
    <span class="hljs-keyword">return</span> array.<span class="hljs-title function_">map</span>(mapper);
}

<span class="hljs-comment">// 过滤函数</span>
<span class="hljs-keyword">function</span> filterArray&lt;T&gt;(
    <span class="hljs-attr">array</span>: T[],
    <span class="hljs-attr">predicate</span>: <span class="hljs-function">(<span class="hljs-params">item: T</span>) =&gt;</span> <span class="hljs-built_in">boolean</span>
): T[] {
    <span class="hljs-keyword">return</span> array.<span class="hljs-title function_">filter</span>(predicate);
}
</code></pre>
<h4 data-id="heading-14">当需要类型约束时</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 约束类型参数必须具有特定属性</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HasLength</span> {
    <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">function</span> logLength&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HasLength</span>&gt;(<span class="hljs-attr">item</span>: T): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Length: <span class="hljs-subst">${item.length}</span>`</span>);
}

<span class="hljs-title function_">logLength</span>(<span class="hljs-string">"hello"</span>);      <span class="hljs-comment">// ✅ string有length属性</span>
<span class="hljs-title function_">logLength</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);    <span class="hljs-comment">// ✅ 数组有length属性</span>
<span class="hljs-title function_">logLength</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5</span> }); <span class="hljs-comment">// ✅ 对象有length属性</span>
<span class="hljs-comment">// logLength(42);        // ❌ number没有length属性</span>
</code></pre>
<h3 data-id="heading-15">泛型声明的位置与时机</h3>
<h4 data-id="heading-16">在函数中声明泛型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 单个泛型参数</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// 多个泛型参数</span>
<span class="hljs-keyword">function</span> pair&lt;T, U&gt;(<span class="hljs-attr">first</span>: T, <span class="hljs-attr">second</span>: U): [T, U] {
    <span class="hljs-keyword">return</span> [first, second];
}

<span class="hljs-comment">// 带约束的泛型</span>
<span class="hljs-keyword">function</span> getProperty&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">obj</span>: T, <span class="hljs-attr">key</span>: K): T[K] {
    <span class="hljs-keyword">return</span> obj[key];
}

<span class="hljs-comment">// 默认类型参数（TypeScript 2.3+）</span>
<span class="hljs-keyword">function</span> createArray&lt;T = <span class="hljs-built_in">string</span>&gt;(<span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">value</span>: T): T[] {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>(length).<span class="hljs-title function_">fill</span>(value);
}
</code></pre>
<h4 data-id="heading-17">在接口中声明泛型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 泛型接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Container</span>&lt;T&gt; {
    <span class="hljs-attr">value</span>: T;
    <span class="hljs-title function_">getValue</span>(): T;
    <span class="hljs-title function_">setValue</span>(<span class="hljs-attr">value</span>: T): <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// 实现泛型接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberContainer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Container</span>&lt;<span class="hljs-built_in">number</span>&gt; {
    <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
    
    <span class="hljs-title function_">getValue</span>(): <span class="hljs-built_in">number</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    }
    
    <span class="hljs-title function_">setValue</span>(<span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;
    }
}

<span class="hljs-comment">// 泛型接口作为函数参数</span>
<span class="hljs-keyword">function</span> processContainer&lt;T&gt;(<span class="hljs-attr">container</span>: <span class="hljs-title class_">Container</span>&lt;T&gt;): T {
    <span class="hljs-keyword">return</span> container.<span class="hljs-title function_">getValue</span>();
}
</code></pre>
<h4 data-id="heading-18">在类型别名中声明泛型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 泛型类型别名</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Nullable</span>&lt;T&gt; = T | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyRecord</span>&lt;K <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, V&gt; = { <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> K]: V };
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Callback</span>&lt;T&gt; = <span class="hljs-function">(<span class="hljs-params">value: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-comment">// 使用泛型类型别名</span>
<span class="hljs-keyword">function</span> processValue&lt;T&gt;(<span class="hljs-attr">value</span>: T, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;T&gt;): <span class="hljs-built_in">void</span> {
    <span class="hljs-title function_">callback</span>(value);
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">names</span>: <span class="hljs-title class_">Nullable</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-string">"Alice"</span> || <span class="hljs-literal">null</span>;
</code></pre>
<h4 data-id="heading-19">在类中声明泛型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 泛型类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Repository</span>&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> }&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">items</span>: T[] = [];
    
    <span class="hljs-title function_">add</span>(<span class="hljs-attr">item</span>: T): <span class="hljs-built_in">void</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">push</span>(item);
    }
    
    <span class="hljs-title function_">findById</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>): T | <span class="hljs-literal">undefined</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === id);
    }
    
    <span class="hljs-title function_">getAll</span>(): T[] {
        <span class="hljs-keyword">return</span> [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>];
    }
}

<span class="hljs-comment">// 使用泛型类</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">const</span> userRepo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Repository</span>&lt;<span class="hljs-title class_">User</span>&gt;();
userRepo.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"alice@example.com"</span> });
<span class="hljs-keyword">const</span> user = userRepo.<span class="hljs-title function_">findById</span>(<span class="hljs-number">1</span>);
</code></pre>
<h3 data-id="heading-20">泛型类型推导</h3>
<p>TypeScript 具有强大的类型推导能力，大多数情况下我们不需要显式指定泛型类型。</p>
<h4 data-id="heading-21">自动类型推导</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// TypeScript会自动推导泛型类型</span>
<span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-comment">// 编译器推断T为string</span>
<span class="hljs-keyword">const</span> result1 = <span class="hljs-title function_">identity</span>(<span class="hljs-string">"hello"</span>);

<span class="hljs-comment">// 编译器推断T为number</span>
<span class="hljs-keyword">const</span> result2 = <span class="hljs-title function_">identity</span>(<span class="hljs-number">42</span>);

<span class="hljs-comment">// 编译器推断T为boolean</span>
<span class="hljs-keyword">const</span> result3 = <span class="hljs-title function_">identity</span>(<span class="hljs-literal">true</span>);

<span class="hljs-comment">// 编译器推断T为number[]</span>
<span class="hljs-keyword">const</span> result4 = <span class="hljs-title function_">identity</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);
</code></pre>
<h4 data-id="heading-22">部分类型推导</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 多个泛型参数时，可以部分推导</span>
<span class="hljs-keyword">function</span> mapArray&lt;T, U&gt;(
    <span class="hljs-attr">array</span>: T[],
    <span class="hljs-attr">mapper</span>: <span class="hljs-function">(<span class="hljs-params">item: T</span>) =&gt;</span> U
): U[] {
    <span class="hljs-keyword">return</span> array.<span class="hljs-title function_">map</span>(mapper);
}

<span class="hljs-comment">// 自动推导T为number，U为string</span>
<span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> strings = <span class="hljs-title function_">mapArray</span>(numbers, <span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n.<span class="hljs-title function_">toString</span>());
<span class="hljs-comment">// strings类型为string[]</span>
</code></pre>
<h4 data-id="heading-23">推导失败的情况</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 情况1：空数组无法推导元素类型</span>
<span class="hljs-keyword">function</span> firstElement&lt;T&gt;(<span class="hljs-attr">arr</span>: T[]): T | <span class="hljs-literal">undefined</span> {
    <span class="hljs-keyword">return</span> arr[<span class="hljs-number">0</span>];
}

<span class="hljs-keyword">const</span> empty = <span class="hljs-title function_">firstElement</span>([]); <span class="hljs-comment">// T被推导为unknown</span>
<span class="hljs-comment">// 解决方法：显式指定类型</span>
<span class="hljs-keyword">const</span> empty2 = firstElement&lt;<span class="hljs-built_in">number</span>&gt;([]); <span class="hljs-comment">// T为number</span>

<span class="hljs-comment">// 情况2：泛型约束太宽</span>
<span class="hljs-keyword">function</span> process&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>&gt;(<span class="hljs-attr">value</span>: T): T {
    <span class="hljs-keyword">return</span> value;
}

<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">process</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// T被推导为"hello"而不是string</span>
<span class="hljs-comment">// 解决方法：使用类型断言</span>
<span class="hljs-keyword">const</span> result2 = process&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// T为string</span>
</code></pre>
<h3 data-id="heading-24">泛型约束</h3>
<h4 data-id="heading-25">基础约束</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 约束T必须是某种类型</span>
<span class="hljs-keyword">function</span> logLength&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span> }&gt;(<span class="hljs-attr">item</span>: T): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item.<span class="hljs-property">length</span>);
}

<span class="hljs-title function_">logLength</span>(<span class="hljs-string">"hello"</span>);      <span class="hljs-comment">// ✅</span>
<span class="hljs-title function_">logLength</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);    <span class="hljs-comment">// ✅</span>
<span class="hljs-title function_">logLength</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5</span> }); <span class="hljs-comment">// ✅</span>
<span class="hljs-comment">// logLength(42);        // ❌</span>

<span class="hljs-comment">// 约束多个类型参数之间的关系</span>
<span class="hljs-keyword">function</span> getProperty&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">obj</span>: T, <span class="hljs-attr">key</span>: K): T[K] {
    <span class="hljs-keyword">return</span> obj[key];
}

<span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> };
<span class="hljs-title function_">getProperty</span>(user, <span class="hljs-string">"name"</span>); <span class="hljs-comment">// ✅</span>
<span class="hljs-comment">// getProperty(user, "email"); // ❌</span>
</code></pre>
<h4 data-id="heading-26">使用类型参数约束</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 一个类型参数约束另一个</span>
<span class="hljs-keyword">function</span> assign&lt;T <span class="hljs-keyword">extends</span> U, U&gt;(<span class="hljs-attr">target</span>: T, <span class="hljs-attr">source</span>: U): T {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(target, source);
}

<span class="hljs-keyword">const</span> target = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
<span class="hljs-keyword">const</span> source = { <span class="hljs-attr">b</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">4</span> };
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">assign</span>(target, source); <span class="hljs-comment">// { a: 1, b: 3, c: 4 }</span>

<span class="hljs-comment">// 约束类型参数为构造器</span>
<span class="hljs-keyword">function</span> createInstance&lt;T&gt;(
    <span class="hljs-title class_">Constructor</span>: <span class="hljs-keyword">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; T,
    ...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]
): T {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Constructor</span>(...args);
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> name: <span class="hljs-built_in">string</span></span>) {}
}

<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">createInstance</span>(<span class="hljs-title class_">User</span>, <span class="hljs-string">"Alice"</span>); <span class="hljs-comment">// User实例</span>
</code></pre>
<h2 data-id="heading-27">结语</h2>
<p>本文详细介绍了TypeScript中的函数使用指南，包括函数声明与调用、函数重载、多态函数与泛型的概念，对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 项目中使用 @antfu/eslint-config 完整指南]]></title>    <link>https://juejin.cn/post/7597056049690574886</link>    <guid>https://juejin.cn/post/7597056049690574886</guid>    <pubDate>2026-01-20T05:46:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597056049690574886" data-draft-id="7597056049690525734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 项目中使用 @antfu/eslint-config 完整指南"/> <meta itemprop="keywords" content="Vue.js,ESLint"/> <meta itemprop="datePublished" content="2026-01-20T05:46:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="实习生小黄"/> <meta itemprop="url" content="https://juejin.cn/user/3246201392868637"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 项目中使用 @antfu/eslint-config 完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3246201392868637/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    实习生小黄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:46:18.000Z" title="Tue Jan 20 2026 05:46:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在现代前端开发中，代码质量和一致性是项目成功的关键因素。ESLint 作为 JavaScript/TypeScript 代码检查工具，能够帮助开发者发现潜在问题、统一代码风格。<code>@antfu/eslint-config</code> 是由 Anthony Fu 维护的一套开箱即用的 ESLint 配置，特别针对 Vue 3、TypeScript 和现代 JavaScript 项目进行了优化。</p>
<p>本文档基于实际项目经验，详细介绍了如何在 Vue3 + TypeScript + Vite 项目中正确配置和使用 <code>@antfu/eslint-config</code>，并记录了常见问题的解决方案。</p>
<h2 data-id="heading-1">目的</h2>
<p>本文档旨在帮助开发者：</p>
<ul>
<li>快速在 Vue3 项目中集成 <code>@antfu/eslint-config</code></li>
<li>理解配置选项的含义和作用</li>
<li>解决常见的解析错误和配置问题</li>
<li>掌握最佳实践和注意事项</li>
</ul>
<h2 data-id="heading-2">配置</h2>
<h3 data-id="heading-3">1. 安装依赖</h3>
<p>首先，确保你的项目已经安装了必要的依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D @antfu/eslint-config eslint
</code></pre>
<p>或者使用 npm/yarn：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -D @antfu/eslint-config eslint
<span class="hljs-comment"># 或</span>
yarn add -D @antfu/eslint-config eslint
</code></pre>
<h3 data-id="heading-4">2. 创建配置文件</h3>
<p>在项目根目录创建 <code>eslint.config.mjs</code> 文件（注意：必须使用 <code>.mjs</code> 扩展名，因为 ESLint 9.x 使用扁平配置格式，且需要 ES 模块语法）。</p>
<p><strong>重要提示</strong>：即使 <code>package.json</code> 中设置了 <code>"type": "module"</code>，ESLint 仍需要明确的 <code>.mjs</code> 扩展名来正确解析 ES 模块语法。</p>
<h3 data-id="heading-5">3. 基础配置示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.mjs</span>
<span class="hljs-keyword">import</span> antfu <span class="hljs-keyword">from</span> <span class="hljs-string">'@antfu/eslint-config'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">antfu</span>({
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,        <span class="hljs-comment">// 启用 Vue 3 支持</span>
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用 TypeScript 支持（重要！）</span>
  
  <span class="hljs-attr">rules</span>: {
    <span class="hljs-comment">// 自定义规则配置</span>
    xxx
  },
})
</code></pre>
<h3 data-id="heading-6">4. 配置选项说明</h3>
<h4 data-id="heading-7">核心选项</h4>
<ul>
<li><strong><code>vue: true</code></strong>：启用 Vue 3 文件支持，自动配置 Vue 相关的 ESLint 规则</li>
<li><strong><code>typescript: true</code></strong>：启用 TypeScript 支持，这是处理 TypeScript 语法的关键配置</li>
</ul>
<h3 data-id="heading-8">5. package.json 脚本配置</h3>
<p>在 <code>package.json</code> 中添加 lint 脚本：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint ."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint . --fix"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-9">遇到的问题</h2>
<h3 data-id="heading-10">问题 1：配置文件解析错误</h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-go" lang="go">Parsing <span class="hljs-type">error</span>: Unexpected token
</code></pre>
<p><strong>问题描述</strong>：</p>
<ul>
<li>使用 <code>.js</code> 扩展名创建配置文件时，ESLint 无法正确解析 ES 模块语法（<code>import/export</code>）</li>
<li>即使 <code>package.json</code> 中设置了 <code>"type": "module"</code>，某些工具仍需要明确的 <code>.mjs</code> 扩展名</li>
</ul>
<p><strong>解决方案</strong>：
将配置文件重命名为 <code>eslint.config.mjs</code>，确保使用 <code>.mjs</code> 扩展名。</p>
<h3 data-id="heading-11">问题 2：TypeScript 嵌套泛型解析错误</h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-go" lang="go">Parsing <span class="hljs-type">error</span>: Unexpected token &gt;&gt;
</code></pre>
<p><strong>问题代码示例</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> allUsersMap = ref&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-title class_">UserInfo</span>&gt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
</code></pre>
<p><strong>问题描述</strong>：</p>
<ul>
<li>当配置中只启用了 <code>vue: true</code> 而没有启用 <code>typescript: true</code> 时</li>
<li>ESLint 无法正确解析嵌套泛型语法（如 <code>ref&lt;Map&lt;number, UserInfo&gt;&gt;</code>）</li>
<li><code>&gt;&gt;</code> 被误解析为 JavaScript 的右移运算符，而不是泛型闭合符号</li>
</ul>
<p><strong>根本原因</strong>：</p>
<ul>
<li>没有显式启用 TypeScript 支持时，TypeScript 解析器可能无法正确处理复杂的泛型语法</li>
<li>这与 GitHub Issue #578 中描述的问题类似：当文件被添加到 <code>ignoresTypeAware</code> 时，会回退到普通 JavaScript 解析器，无法理解 TypeScript 语法</li>
</ul>
<h2 data-id="heading-12">解决方案</h2>
<h3 data-id="heading-13">解决方案 1：配置文件扩展名问题</h3>
<p><strong>步骤</strong>：</p>
<ol>
<li>删除 <code>eslint.config.js</code>（如果存在）</li>
<li>创建 <code>eslint.config.mjs</code> 文件</li>
<li>使用 ES 模块语法编写配置</li>
</ol>
<p><strong>完整示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.mjs</span>
<span class="hljs-keyword">import</span> antfu <span class="hljs-keyword">from</span> <span class="hljs-string">'@antfu/eslint-config'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">antfu</span>({
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,
})
</code></pre>
<h3 data-id="heading-14">解决方案 2：TypeScript 解析错误</h3>
<p><strong>关键步骤</strong>：在配置中显式启用 TypeScript 支持</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.mjs</span>
<span class="hljs-keyword">import</span> antfu <span class="hljs-keyword">from</span> <span class="hljs-string">'@antfu/eslint-config'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">antfu</span>({
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// ⚠️ 必须显式启用！</span>
  
  <span class="hljs-attr">rules</span>: {
    <span class="hljs-comment">// 自定义规则</span>
  },
})
</code></pre>
<p><strong>为什么需要显式启用？</strong></p>
<ol>
<li><strong>默认行为不确定</strong>：虽然 <code>@antfu/eslint-config</code> 可能在某些情况下自动检测 TypeScript，但在处理复杂语法（如嵌套泛型）时可能失效</li>
<li><strong>Vue 文件特殊性</strong>：Vue 单文件组件（<code>.vue</code>）中的 <code>&lt;script setup&gt;</code> 使用 TypeScript 时，需要明确的配置来启用 TypeScript 解析器</li>
<li><strong>避免解析器回退</strong>：显式配置确保文件不会被错误地使用 JavaScript 解析器处理</li>
</ol>
<h3 data-id="heading-15">解决方案 3：完整的推荐配置</h3>
<p>基于实际项目经验，推荐以下配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.mjs</span>
<span class="hljs-keyword">import</span> antfu <span class="hljs-keyword">from</span> <span class="hljs-string">'@antfu/eslint-config'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">antfu</span>({
  <span class="hljs-comment">// 核心功能</span>
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,
  
  <span class="hljs-comment">// 自定义规则</span>
  <span class="hljs-attr">rules</span>: {
  },
})
</code></pre>
<h2 data-id="heading-16">总结</h2>
<h3 data-id="heading-17">关键要点</h3>
<ol>
<li>
<p><strong>文件扩展名很重要</strong>：必须使用 <code>eslint.config.mjs</code> 而不是 <code>.js</code>，确保 ESLint 能正确解析 ES 模块语法</p>
</li>
<li>
<p><strong>显式启用 TypeScript</strong>：即使项目使用 TypeScript，也要在配置中显式设置 <code>typescript: true</code>，特别是处理复杂泛型语法时</p>
</li>
<li>
<p><strong>理解解析器机制</strong>：当 TypeScript 解析器未正确启用时，文件可能回退到 JavaScript 解析器，导致无法理解 TypeScript 语法</p>
</li>
<li>
<p><strong>遵循最佳实践</strong>：</p>
<ul>
<li>始终同时启用 <code>vue: true</code> 和 <code>typescript: true</code></li>
<li>根据项目需求自定义规则</li>
<li>定期更新 <code>@antfu/eslint-config</code> 到最新版本</li>
</ul>
</li>
</ol>
<h3 data-id="heading-18">常见错误对照表</h3>

























<table><thead><tr><th>错误信息</th><th>可能原因</th><th>解决方案</th></tr></thead><tbody><tr><td><code>Parsing error: Unexpected token</code></td><td>配置文件扩展名错误</td><td>使用 <code>.mjs</code> 扩展名</td></tr><tr><td><code>Parsing error: Unexpected token &gt;&gt;</code></td><td>未启用 TypeScript 支持</td><td>添加 <code>typescript: true</code></td></tr><tr><td><code>Parsing error: Unexpected token :</code></td><td>文件被添加到 <code>ignoresTypeAware</code></td><td>移除相关配置或显式添加到 <code>filesTypeAware</code></td></tr></tbody></table>
<h3 data-id="heading-19">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Feslint-config" target="_blank" title="https://github.com/antfu/eslint-config" ref="nofollow noopener noreferrer">@antfu/eslint-config</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feslint.org%2Fdocs%2Flatest%2Fuse%2Fconfigure%2Fconfiguration-files-new" target="_blank" title="https://eslint.org/docs/latest/use/configure/configuration-files-new" ref="nofollow noopener noreferrer">ESLint 扁平配置文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Feslint-config%2Fissues%2F578" target="_blank" title="https://github.com/antfu/eslint-config/issues/578" ref="nofollow noopener noreferrer">GitHub Issue #578</a> - TypeScript 解析相关问题</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一站式了解Spring AI Alibaba的Memory机制]]></title>    <link>https://juejin.cn/post/7596990822127566886</link>    <guid>https://juejin.cn/post/7596990822127566886</guid>    <pubDate>2026-01-20T05:47:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596990822127566886" data-draft-id="7596990822127026214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一站式了解Spring AI Alibaba的Memory机制"/> <meta itemprop="keywords" content="后端,人工智能,架构"/> <meta itemprop="datePublished" content="2026-01-20T05:47:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一站式了解Spring AI Alibaba的Memory机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:47:57.000Z" title="Tue Jan 20 2026 05:47:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>我相信大家在平时一定使用过网页对话chatbot，国产的有deepseek、Qwen等，国外的有ChatGPT、Gemini、Grok等。在我们使用的期间，我们会发现这些chatbot会记住我们这次对话的上下文，甚至之前的对话的某些信息，如果你们对为什么LLM能记住我们的信息感兴趣，那么接着往下看吧！</p>
<h2 data-id="heading-1">错误纠正</h2>
<p>很多人不了解大模型或者不了解大模型应用开发的，就常常认为大模型底层就是会有记忆机制的，即内置Memory。这种想法是错误的，大模型底层并没有记忆机制，而是stateless(无状态)。</p>
<p>1.基础大模型（如 Qwen）的行为(LLM)</p>
<ul>
<li>默认情况下，大语言模型（包括 Qwen 系列）是<strong>无状态的</strong>：每次请求都是独立的，模型不会自动记住你之前的对话内容。</li>
<li>如果你在一次对话中发送多轮消息（例如通过 API 的 <code>messages</code> 字段传入历史），那是由<strong>调用方</strong>（即你的应用）负责维护对话历史，而不是模型自己存储。</li>
</ul>
<p>2.Memory 机制是应用层的功能</p>
<ul>
<li>“Memory”通常是指在构建智能体（Agent）或对话系统时，为了实现上下文记忆、长期记忆、用户偏好记录等功能而<strong>额外引入的模块</strong>。</li>
<li>例如，在 LangChain、LlamaIndex 或阿里云百炼平台中，开发者可以配置短期记忆（如最近几轮对话）或长期记忆（如向量数据库存储的历史信息），并在每次生成回复前将相关记忆注入 prompt。</li>
<li>这种 Memory 管理是由<strong>应用框架或开发者代码</strong>实现的，不是模型原生能力。</li>
</ul>
<h2 data-id="heading-2">Memory</h2>
<p>那么像chatbot这些大模型应用，是如何维持记忆呢？那么维护记忆万一超过了模型能承受的上下文，怎么办？</p>
<p>要了解这些问题，我们首先得搞懂，<strong>什么是Memory</strong>。</p>
<p>Memory分为短期记忆和长期记忆，接下来我们分别说说，尽量简单易懂。</p>
<h3 data-id="heading-3">短期Memory</h3>
<p>短期记忆（Short-term Memory）</p>
<ul>
<li>
<p><strong>定义</strong>：指在<strong>单次对话会话（session）中</strong>保留的上下文信息。</p>
</li>
<li>
<p><strong>典型实现</strong>：将用户与系统单次会话中的最近几轮的对话历史（prompt + response）作为上下文，一起输入给大模型。</p>
</li>
<li>
<p>特点：</p>
<ul>
<li>仅在当前会话有效；</li>
<li>会话结束后通常被丢弃（除非主动保存）；</li>
<li>受限于模型的上下文长度（如 Qwen-Max 支持 32768 tokens）；</li>
<li>是实现多轮对话连贯性的基础。</li>
</ul>
</li>
<li>
<p>例子：</p>
<blockquote>
<p>用户：我叫小明。 助手：你好，小明！ 用户：我今年多大？ → 助手能回答，是因为“我叫小明”这句还在短期记忆（即对话历史）中</p>
</blockquote>
</li>
</ul>
<p>短期记忆一般大模型应用都会自动开启的，但是每个应用对短期记忆的策略都会不一样，所以体验上也不一样。</p>
<h3 data-id="heading-4">长期Memory</h3>
<p>长期记忆（Long-term Memory）</p>
<ul>
<li>
<p><strong>定义</strong>：跨越<strong>多个会话</strong>、持久化存储的用户信息或交互历史。</p>
</li>
<li>
<p>典型实现：</p>
<ul>
<li>将关键信息（如用户偏好、身份、历史任务）提取后存入数据库或向量库；</li>
<li>下次对话时通过检索（Retrieval）机制召回相关内容，并注入到 prompt 中。</li>
</ul>
</li>
<li>
<p>特点：</p>
<ul>
<li>需要显式设计（如使用向量数据库 + embedding 检索）；</li>
<li>不是所有系统都默认开启；</li>
<li>涉及隐私和数据安全，通常需用户授权；</li>
<li>属于高级功能，常见于智能体（Agent）或个性化助手。</li>
</ul>
</li>
<li>
<p>例子：</p>
<blockquote>
<p>上周用户说：“我喜欢喝美式咖啡。” 一周后再次对话，系统说：“今天还想来一杯美式吗？” → 这说明系统通过长期记忆记住了偏好。</p>
</blockquote>
</li>
</ul>
<p>以Gemini为例子，你可以在这里添加想让Gemini记住你的相关信息，或者在某次对话中直接prompt让其记住也是可以的。这样就是长期Memory，每次Gemini都会在某些情景下触发相关的长期记忆，策略不同，输出也会不同</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb3439edfb8d46f1a93120640aff551c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492876&amp;x-signature=2IM1STkkuLy7QVhx6EVKAuLUWiM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">SAA的Memory机制</h2>
<p>ok，现在回归正题，来讲讲SAA的Memory机制，如果还有想有更深的了解的兄弟可以先去看看这两篇文章，再回来应该能更好的理解</p>
<p>1.Spring AI vs Spring AI Alibaba</p>
<p><a href="https://juejin.cn/post/7596181746062508059" target="_blank" title="https://juejin.cn/post/7596181746062508059">juejin.cn/post/759618…</a></p>
<p>2.逃出结构化思维：从向量，向量数据库到RAG</p>
<p><a href="https://juejin.cn/post/7587074669818134554" target="_blank" title="https://juejin.cn/post/7587074669818134554">juejin.cn/post/758707…</a></p>
<p>SAA本质上是一个AI应用开发框架，可以开发agent，multi-agent和工作流等等，那么必然需要使用底层LLM，然而我们前面已经说过了LLM实际上是无状态的，那么LLM应用的相关记忆必定是由我们上层应用来开发和管理的。</p>
<p>即如果你使用的是 <strong>Qwen 的 API（如 dashscope）</strong> ，你需要自己维护对话历史并作为输入传入。</p>
<h3 data-id="heading-6">SAA的Memory机制的架构</h3>
<p>下面是SAA实现两种Memory的架构图,其中左下角的箭头(指向ModelHook)应该放置到中间的，画错了就将就看吧</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18a0e499cf7e49fea80e248203b7e7f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492876&amp;x-signature=8R8dwVnosD%2BXP9YQwGV3Pq6f%2FQE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">维护短期记忆</h3>
<h4 data-id="heading-8">如何添加短期记忆</h4>
<p>在 Spring AI Alibaba 中，要向 Agent 添加短期记忆（会话级持久化），你需要在创建 Agent 时指定 <code>checkpointer</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.checkpoint.savers.RedisSaver;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;

<span class="hljs-comment">// 配置 Redis checkpointer</span>
<span class="hljs-type">RedisSaver</span> <span class="hljs-variable">redisSaver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisSaver</span>(redissonClient);

<span class="hljs-type">ReactAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReactAgent.builder()
    .name(<span class="hljs-string">"my_agent"</span>)
    .model(chatModel)
    .tools(getUserInfoTool)
    .saver(redisSaver)
    .build();
    
<span class="hljs-comment">// 使用 thread_id 维护对话上下文  </span>
<span class="hljs-type">RunnableConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RunnableConfig.builder()  
    .threadId(<span class="hljs-string">"1"</span>) <span class="hljs-comment">// threadId 指定会话 ID  </span>
    .build();  
  
agent.call(<span class="hljs-string">"你好！我叫 Bob。"</span>, config);
</code></pre>
<h4 data-id="heading-9">扩展短期记忆</h4>
<p>我们还可以修改和管理记忆。
默认情况下，Agent 使用状态通过 <code>messages</code> 键管理短期记忆，特别是对话历史。</p>
<p>你可以通过在工具或 Hook 中访问和修改状态来扩展记忆功能</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.agent.hook.ModelHook;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.agent.hook.HookPosition;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.OverAllState;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.RunnableConfig;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.Message;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-comment">// 在 Hook 中访问和修改状态</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomMemoryHook</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ModelHook</span> {

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"custom_memory"</span>;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> HookPosition[] getHookPositions() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HookPosition</span>[]{HookPosition.BEFORE_MODEL};
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> CompletableFuture&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">beforeModel</span><span class="hljs-params">(OverAllState state, RunnableConfig config)</span> {
    <span class="hljs-comment">// 访问消息历史</span>
    Optional&lt;Object&gt; messagesOpt = state.value(<span class="hljs-string">"messages"</span>);
    <span class="hljs-keyword">if</span> (messagesOpt.isPresent()) {
        List&lt;Message&gt; messages = (List&lt;Message&gt;) messagesOpt.get();
    <span class="hljs-comment">// 处理消息...</span>
}

    <span class="hljs-comment">// 添加自定义状态</span>
    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Map.of(
        <span class="hljs-string">"user_id"</span>, <span class="hljs-string">"user_123"</span>,
        <span class="hljs-string">"preferences"</span>, Map.of(<span class="hljs-string">"theme"</span>, <span class="hljs-string">"dark"</span>)
    ));
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> CompletableFuture&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">afterModel</span><span class="hljs-params">(OverAllState state, RunnableConfig config)</span> {
    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Map.of());
    }
}
</code></pre>
<h4 data-id="heading-10">管理短期记忆</h4>
<p>一个会话中，如果用户一直对话，整个会话的上下文就会越来越长，最后就会超过该大模型所能承受的上下文限制。</p>
<p>保留所有对话历史是实现短期记忆最常见的形式。但较长的对话对历史可能会导致大模型 LLM 上下文窗口超限，导致上下文丢失或报错。</p>
<p>即使你在使用的大模型上下文长度足够大，大多数模型在处理较长上下文时的表现仍然很差。因为很多模型会被过时或偏离主题的内容"分散注意力"。同时，过长的上下文，还会带来响应时间变长、Token 成本增加等问题。</p>
<p>在 Spring AI ALibaba 中，ReactAgent 使用 messages 记录和传递上下文，其中包括指令（SystemMessage）和输入（UserMessage）。在 ReactAgent 中，消息（Message）在用户输入和模型响应之间交替，导致消息列表随着时间的推移变得越来越长。由于上下文窗口有限，许多应用程序可以从使用技术来移除或"忘记"过时信息中受益，即 “上下文工程”。</p>
<p>作为后端，我们通常采取以下几种策略来模拟“记忆”：</p>
<ul>
<li><strong>Sliding Window（滑动窗口）：</strong> 只保留最近的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 轮对话，丢弃最早的记录。</li>
<li><strong>Summary Memory（摘要记忆）：</strong> 当对话过长时，调用大模型对之前的对话做一个简短总结，后续只带上这个 <code>Summary</code>。</li>
<li><strong>Vector Database（向量数据库/RAG）：</strong> 将历史对话存入向量库（如 Milvus, Pinecone）。当用户提问时，通过语义搜索检索出最相关的历史片段（Top-K），塞进 Context 传给模型。</li>
</ul>
<h3 data-id="heading-11">维护长期记忆</h3>
<h4 data-id="heading-12">长期记忆的检索过程</h4>
<p>对于后端开发人员来说，长期记忆的检索过程其实就是一个标准的 <strong>“语义检索 + RAG (Retrieval-Augmented Generation)”</strong> 工作流。</p>
<p>你可以把它类比为：<strong>全文搜索（Elasticsearch）的升级版</strong>。不同于关键词匹配，<strong>它是基于“意思”来匹配</strong>。</p>
<hr/>
<p>整个过程可以分为 <strong>“存入”</strong> 和 <strong>“检索”</strong> 两个阶段：</p>
<h5 data-id="heading-13">1. 存入阶段（写入/索引）</h5>
<p>当一段对话结束或产生新的知识时：</p>
<ol>
<li><strong>切片 (Chunking)</strong> ：将长文本切分成合适的大小（例如 512 tokens）。</li>
<li><strong>向量化 (Embedding)</strong> ：调用 Embedding 模型（如 OpenAI 的 <code>text-embedding-3-small</code>）将文本转为高维向量（如 1536 维的浮点数数组）。</li>
<li><strong>入库</strong>：将向量和原始文本、Metadata（如 <code>user_id</code>, <code>timestamp</code>）存入向量数据库（Redis Vector Search, Milvus, 或 Pinecone）。</li>
</ol>
<h5 data-id="heading-14">2. 检索阶段（读取/召回）</h5>
<p>当用户提出一个新问题，系统需要“回想起”以前的事情：</p>
<ul>
<li>
<p>Step A: 问题向量化</p>
<p>将用户的提问（Query）同样通过 Embedding 模型转为一个向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{query}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">ery</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。</p>
</li>
<li>
<p>Step B: 向量空间搜索 (ANN Search)</p>
<p>在数据库中寻找与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{query}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">ery</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 距离最近（相似度最高）的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> 个向量。通常使用余弦相似度 (Cosine Similarity) 计算：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>similarity</mtext><mo>=</mo><mfrac><mrow><mi>A</mi><mo>⋅</mo><mi>B</mi></mrow><mrow><mi mathvariant="normal">∥</mi><mi>A</mi><mi mathvariant="normal">∥</mi><mi mathvariant="normal">∥</mi><mi>B</mi><mi mathvariant="normal">∥</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{similarity} = \frac{A \cdot B}{\|A\| \|B\|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">similarity</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3923em;vertical-align:-0.52em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∥</span><span class="mord mathnormal mtight">A</span><span class="mord mtight">∥∥</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mord mtight">∥</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mbin mtight">⋅</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
</li>
<li>
<p>Step C: 召回与过滤</p>
<p>数据库返回最匹配的原始文本片段。作为后端，你通常会在这里根据 user_id 做 Metadata Filter，确保 A 用户的提问不会检索到 B 用户的记忆。</p>
</li>
<li>
<p>Step D: 上下文注入 (Context Injection)</p>
<p>将检索出来的“记忆片段”拼接到当前的 Prompt 中。</p>
</li>
</ul>
<h4 data-id="heading-15">SAA的长期记忆存储</h4>
<p>Spring AI Alibaba 将长期记忆以 JSON 文档的形式存储在 Store 中。</p>
<p>每个记忆都在自定义的 <code>namespace</code>（类似于文件夹）下组织，并使用唯一的 <code>key</code>（类似于文件名）。命名空间通常包含用户或组织 ID 或其他标签，以便更容易地组织信息。</p>
<p>这种结构支持记忆的层次化组织。通过内容过滤器支持跨命名空间搜索。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.store.stores.MemoryStore;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.store.StoreItem;

<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-comment">// MemoryStore 将数据保存到内存字典中。在生产环境中请使用基于数据库的存储实现</span>
<span class="hljs-type">MemoryStore</span> <span class="hljs-variable">store</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryStore</span>();

<span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"my-user"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-string">"chitchat"</span>;
List&lt;String&gt; namespace = List.of(userId, applicationContext);

<span class="hljs-comment">// 保存记忆</span>
Map&lt;String, Object&gt; memoryData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
memoryData.put(<span class="hljs-string">"rules"</span>, List.of(
    <span class="hljs-string">"用户喜欢简短直接的语言"</span>,
    <span class="hljs-string">"用户只说中文和Java"</span>
));
memoryData.put(<span class="hljs-string">"my-key"</span>, <span class="hljs-string">"my-value"</span>);

<span class="hljs-type">StoreItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> StoreItem.of(namespace, <span class="hljs-string">"a-memory"</span>, memoryData);
store.putItem(item);

<span class="hljs-comment">// 通过ID获取记忆</span>
Optional&lt;StoreItem&gt; retrievedItem = store.getItem(namespace, <span class="hljs-string">"a-memory"</span>);

<span class="hljs-comment">// 在此命名空间内搜索记忆，通过内容等价性过滤，按向量相似度排序</span>
List&lt;StoreItem&gt; items = store.searchItems(
    namespace,
    Map.of(<span class="hljs-string">"my-key"</span>, <span class="hljs-string">"my-value"</span>)
);
</code></pre>
<h4 data-id="heading-16">SAA的长期记忆管理</h4>
<p>SAA还可以进行对长期记忆的管理，我们可以使用 ModelHook 在模型调用前后自动加载和保存长期记忆。</p>
<p>同时，我们也可以在tool里面进行读取和写入长期记忆。</p>
<p>长期记忆的写入和召回等核心流程就如上面说到的一样，这里由于篇幅就不详细赘述。</p>
<h2 data-id="heading-17">总结</h2>
<p>本文讨论了Memory的概念，两种不同记忆机制的区别以及SAA如何处理不同记忆。</p>
<p>但是大模型应用开发Memory是门学问，也不可能一文能讲清楚所有场景该怎么做，比如短期记忆和长期记忆混合该怎么使用，那就等着读者去探索了。</p>
<p>如果你感觉这篇入门文章给你带来了不错的体感，那就给我点赞+收藏+关注吧❤️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS人机交互新范式：当ToB系统开始“思考”，我们该设计什么样的界面？]]></title>    <link>https://juejin.cn/post/7597083743555960875</link>    <guid>https://juejin.cn/post/7597083743555960875</guid>    <pubDate>2026-01-20T05:39:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083743555960875" data-draft-id="7597083949833207814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS人机交互新范式：当ToB系统开始“思考”，我们该设计什么样的界面？"/> <meta itemprop="keywords" content="HarmonyOS,Agent"/> <meta itemprop="datePublished" content="2026-01-20T05:39:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木斯佳"/> <meta itemprop="url" content="https://juejin.cn/user/783265144769623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS人机交互新范式：当ToB系统开始“思考”，我们该设计什么样的界面？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/783265144769623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木斯佳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:39:26.000Z" title="Tue Jan 20 2026 05:39:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>软件不再是你找功能，而是功能主动理解你。这不是AI的革命，这是交互设计本应有的样子。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60672891fa094018a6d3c91a5708b74d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=wRCbrnPV9qvX8HBcNUSGpZApQcw%3D" alt="image.png" loading="lazy"/></p>
<p>上周在医院门诊大厅，我看到一个特别的“白大褂”——医疗数字人“灵童”。它眨着大眼睛，耐心地为患者家属解答各种问题。家属只需自然地说出需求，灵童就能理解意图，快速给出科室指引、专家排班信息，甚至能调出相关的健康知识卡片。</p>
<p>这不是科幻电影，这是青岛市妇女儿童医院真实的智慧服务场景，由泽瑞集团提供全链路私有化部署的医疗数字人解决方案。</p>
<p>看着家属们自然地与灵童对话，我突然意识到：这才应该是企业软件的交互方式——不是用户去适应复杂的菜单结构，而是系统主动理解用户意图，提供恰到好处的服务。</p>
<h2 data-id="heading-0">不是AI要改变什么，而是我们本就该这样工作</h2>
<p>最近团队在落地几个Agent项目，和产品、设计、后端一起开会时，大家问得最多的问题是：“Agent到底能做什么不一样的事情？”</p>
<p>我的回答是：它不做“不一样”的事情，而是让事情“以对的方式”发生。
让我用医疗场景举个例子。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4a7064a68e84837af8311218f62a758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=pgdBA2rDkxKytQXzjuGmSVD61Is%3D" alt="在这里插入图片描述" loading="lazy"/>
<strong>传统的医院系统逻辑</strong>：家属要知道“去哪里”——导诊台；要记住“怎么问”——科室名称要准确；要明白“流程”——先登记还是先挂号。</p>
<p><strong>数字人的逻辑</strong>：家属只需要说“孩子咳嗽三天了，应该看哪个科”。
系统自己会判断：这需要分析症状关键词→匹配对应专科→查看专家排班→提供就诊建议。整个过程在自然对话中完成，用户不需要记住复杂的科室分类，不需要提前学习系统用法，只需要说出需求。</p>
<p>这不就是我们一直想要的“智能化”吗？</p>
<h2 data-id="heading-1">界面不是消失了，而是变得更“聪明”</h2>
<p>有人担心：Agent会不会让精心设计的页面变得无用？
恰恰相反。好的Agent不是替代界面，而是让界面“活”起来。
第一版的智能柜成功上线让我们备受鼓舞，我们快速迭代了小程序侧进行了上线。在方案预研中，我发现<strong>鸿蒙生态</strong>天然的适配<strong>RICH 设计范式</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b2d167806ab47fd8a3870f9a72fc133~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=bQ3YrbzaMjo9rVBAoWCaqvxIIss%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>鸿蒙的<strong>多窗口交互</strong>，折叠屏展开态、平板等大屏幕设备，具有多任务并行和效率型任务处理的先天优势。
系统提供了悬浮窗、分屏、画中画三种多窗口交互，为用户在大屏幕设备上的多任务并行、便捷的临时任务处理提供更佳的使用体验。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27e8bd9dcf3f45c486dcae11ae7c91d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=qU3LNx%2FntGK0SmzRig26jbXu%2Bd4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>想象一下这种体验：</p>
<ol>
<li>家属询问：“半夜小孩发烧到39.5度，需要马上看急诊吗？”</li>
<li>系统理解：这是急症咨询场景，需要调用发热处理流程、急诊等待时间、医生建议</li>
<li>界面响应：左侧显示发热处理指引卡片，中间展示当前急诊等候人数，右侧提供线上咨询快速入口</li>
<li>家属可以：查看详细指引，预约急诊时段。</li>
</ol>
<p>界面元素依然存在，但它们的<strong>出现时机、组合方式、信息呈现</strong>都根据用户的<strong>紧急程度</strong>和<strong>具体需求</strong>动态决定。</p>
<p>这就是“混合渲染”——不是全盘推倒重来，而是让静态的页面框架，搭载动态的医疗<strong>服务卡片</strong>和<strong>交互</strong>组件。</p>
<h2 data-id="heading-2">鸿蒙开发者的新角色：从“页面建造者”到“交互架构师”</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e43e56e36c24eb98a117d86221b190f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=YpqlQbgE8I0cgKCUOFL9Cxg%2F0Vc%3D" alt="图例来自蚂蚁开源项目" loading="lazy"/>
（图例来自蚂蚁开源项目）</p>
<p>这种变化对鸿蒙开发者意味着什么？
在借鉴吸收了RICH 设计范式后，昨天的我还需要纠结这个按钮的border-radius是6px还是8px，今天的我需要思考的是：<strong>这个组件如何向AI描述自己？</strong></p>
<p>在鸿蒙生态中，我们的组件开发范式正在经历深刻的变革。这种变化不仅仅是API设计的不同，更是组件从"被动渲染"到"主动服务"的思维转变。</p>
<h4 data-id="heading-3">传统鸿蒙组件开发</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// ArkTS中传统的日期选择器组件</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">DatePickerComponent</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">selectedDate</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'2024-01-01'</span>
  
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">DatePicker</span>({
      <span class="hljs-attr">start</span>: <span class="hljs-string">'2020-01-01'</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-string">'2030-12-31'</span>,
      <span class="hljs-attr">selected</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>
    })
    .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value: DatePickerResult</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span> = <span class="hljs-string">`<span class="hljs-subst">${value.year}</span>-<span class="hljs-subst">${value.month}</span>-<span class="hljs-subst">${value.day}</span>`</span>
      <span class="hljs-comment">// 这里需要手动触发所有关联组件的更新</span>
      <span class="hljs-title function_">postUpdateEvent</span>(<span class="hljs-string">'dateChanged'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedDate</span>)
    })
  }
}
</code></pre>
<h4 data-id="heading-4">使用RICH 设计模式开发鸿蒙组件</h4>
<ol>
<li>语义自描述</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-meta">@SmartComponent</span>({
  <span class="hljs-attr">semantic</span>: <span class="hljs-string">"用药提醒时间设置器"</span>,
  <span class="hljs-attr">medicalContext</span>: {
    <span class="hljs-attr">supports</span>: [<span class="hljs-string">'medication_schedule'</span>, <span class="hljs-string">'dosage_timing'</span>],
    <span class="hljs-attr">constraints</span>: [<span class="hljs-string">'must_align_with_meal'</span>, <span class="hljs-string">'no_overlapping_meds'</span>]
  }
})
</code></pre>
<ol start="2">
<li>自动能力发现</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 组件自动声明其能力</span>
<span class="hljs-meta">@Capability</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'medical_timeline_integration'</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">'可自动集成到患者病程时间轴'</span>,
  <span class="hljs-attr">api</span>: <span class="hljs-title class_">MedicalTimelineAPI</span>
})
</code></pre>
<ol start="3">
<li>上下文感知</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">ContextAwareComponent</span> {
  <span class="hljs-meta">@Prop</span>
  <span class="hljs-meta">@MedicalContext</span>({
    <span class="hljs-attr">patientAge</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">currentDiagnosis</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">medicationList</span>: <span class="hljs-literal">true</span>
  })
  <span class="hljs-attr">medicalContext</span>: <span class="hljs-title class_">MedicalContextData</span>
  
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 根据患者年龄自动调整界面</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">medicalContext</span>.<span class="hljs-property">patientAge</span> &lt; <span class="hljs-number">12</span>) {
      <span class="hljs-comment">// 儿童友好的界面</span>
      <span class="hljs-title class_">ChildFriendlyDatePicker</span>()
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 成人标准界面</span>
      <span class="hljs-title class_">StandardDatePicker</span>()
    }
  }
}
</code></pre>
<ol start="4">
<li>工作流自动化</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-meta">@WorkflowIntegration</span>({
  <span class="hljs-attr">trigger</span>: <span class="hljs-string">'appointment_scheduled'</span>,
  <span class="hljs-attr">actions</span>: [
    <span class="hljs-string">'update_doctor_calendar'</span>,
    <span class="hljs-string">'generate_patient_reminder'</span>,
    <span class="hljs-string">'prepare_medical_records'</span>
  ]
})
</code></pre>
<p>我们的工作重心，正在从**“如何把页面画好”<strong>，转向</strong>“如何让系统理解每个组件的用途”**。</p>
<h2 data-id="heading-5">设计模式演进：新的问题需要新的解决方案（鸿蒙6新特性应用）</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffc1496c604c4ace9b3ed747f5eb51a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=9J6iPShGGch9bajDDZw5oVzFSBU%3D" alt="image.png" loading="lazy"/></p>
<p>在真实的医疗Agent项目中，我们遇到了很多传统B端设计没遇到过的问题。</p>
<h4 data-id="heading-6">问题一：AI“过度自信”怎么办？</h4>
<p>家属说“肚子疼”，AI直接建议“立即手术”——显然会造成恐慌。</p>
<p>我们的方案：医疗场景的分级响应机制。</p>
<ul>
<li>高危症状（胸痛、意识丧失）立即转人工+警报</li>
<li>中危症状（高烧、持续呕吐）提供紧急处理建议+医生连接</li>
<li>低危症状（轻微咳嗽、皮疹）给予家庭护理指导</li>
</ul>
<h4 data-id="heading-7">问题二：用户描述模糊怎么办？</h4>
<p>“我不舒服”——这太宽泛了。</p>
<p>我们的方案：结构化问诊引导。</p>
<ul>
<li>第一步：症状分类（疼痛类、发热类、消化类等）</li>
<li>第二步：细节追问（“哪个部位疼？持续多久了？”）</li>
<li>第三步：提供可视化部位选择器（点击身体图标记疼痛点）</li>
</ul>
<blockquote>
<p>附加价值配合鸿蒙6跨设备感知协同：不只是数据，更是“情境”</p>
</blockquote>
<pre><code class="hljs language-csharp" lang="csharp">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title">fuseDeviceData</span>()</span> {
    <span class="hljs-comment">// 智能融合来自不同设备的数据</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 从手表获取：心率、血氧、体温趋势</span>
      vitalSigns: <span class="hljs-keyword">this</span>.multiDeviceHealthData.watch?.vitalSigns,
      
      <span class="hljs-comment">// 从手环获取：活动量、睡眠质量</span>
      activity: <span class="hljs-keyword">this</span>.multiDeviceHealthData.band?.dailyActivity,
      
      <span class="hljs-comment">// 从环境设备获取：室内温度、湿度</span>
      environment: <span class="hljs-keyword">this</span>.multiDeviceHealthData.thermometer?.roomCondition,
      
      <span class="hljs-comment">// 鸿蒙6特性：意图感知</span>
      <span class="hljs-comment">// 自动识别用户是在做饭时、运动后还是睡眠中不适</span>
      situationalIntent: <span class="hljs-keyword">await</span> IntentsKit.recognizeSituationalIntent()
    }
  }
</code></pre>
<h4 data-id="heading-8">问题三：医疗建议需要个性化怎么办？</h4>
<p>同样的症状，儿童和老人的处理方式完全不同。</p>
<p>我们的方案：上下文感知+个性化适配。</p>
<ul>
<li>自动识别患者年龄段</li>
<li>结合过往病史（如有权限）</li>
<li>提供差异化的处理建议</li>
<li>明确标注“建议仅供参考，请及时就医”</li>
</ul>
<blockquote>
<p>Intent Kit 意图识别分发+小艺对话，让问题更精准，“肚子疼”变得立体</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">CrossDeviceSymptomAnalysis</span> {
  <span class="hljs-comment">// 鸿蒙6：跨设备传感器智能融合</span>
  <span class="hljs-meta">@CrossDeviceSensorContext</span>({
    <span class="hljs-comment">// 同时感知手机、手表、环境设备</span>
    <span class="hljs-attr">devices</span>: [<span class="hljs-string">'huawei_watch'</span>, <span class="hljs-string">'harmony_band'</span>, <span class="hljs-string">'smart_thermometer'</span>],
    <span class="hljs-comment">// 智能聚合策略：医疗优先</span>
    <span class="hljs-attr">fusionPolicy</span>: <span class="hljs-string">'medical_emergency'</span>,
    <span class="hljs-comment">// 实时同步，延迟&lt;100ms</span>
    <span class="hljs-attr">syncMode</span>: <span class="hljs-string">'realtime'</span>
  })
  <span class="hljs-attr">multiDeviceHealthData</span>: <span class="hljs-title class_">HealthData</span>
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onSymptomReported</span>(<span class="hljs-params">symptom: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// 1. 融合多设备数据进行精准评估</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fuseDeviceData</span>()
    
    <span class="hljs-comment">// 2. 通过Intent Kit分发给最合适的处理节点</span>
    <span class="hljs-keyword">const</span> intentResult = <span class="hljs-keyword">await</span> <span class="hljs-title class_">IntentsKit</span>.<span class="hljs-title function_">dispatch</span>({
      <span class="hljs-attr">intent</span>: <span class="hljs-string">'medical_triage'</span>,
      <span class="hljs-attr">params</span>: {
        <span class="hljs-attr">symptom</span>: symptom,
        <span class="hljs-attr">context</span>: context,
        <span class="hljs-comment">// 附加设备感知数据</span>
        <span class="hljs-attr">crossDeviceData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">multiDeviceHealthData</span>
      },
      <span class="hljs-comment">// 分发策略：基于紧急程度</span>
      <span class="hljs-attr">strategy</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateEmergencyStrategy</span>(context)
    })
    
    <span class="hljs-keyword">return</span> intentResult
  }
}
</code></pre>
<h2 data-id="heading-9">那些不会变的东西：GUI为什么依然重要</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39126ec34e954797a99bd44019aaf5d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=zBrNZxC132WHhnJJgvLmoywaan8%3D" alt="image.png" loading="lazy"/></p>
<p>在大家都热衷讨论自然语言交互时，我想泼一点冷水：GUI不会死，也死不了。
原因很简单：有些交互，用图形就是比用语言高效。</p>
<p>试想一下：</p>
<ul>
<li>在设计工具里微调一个元素的间距：拖拽对齐线 vs “把这个元素向左移动2像素，不对，是1.8像素”</li>
<li>在表格里筛选数据：点击表头下拉 vs “筛选出状态为进行中、优先级为高、创建时间在最近一周的任务”</li>
<li>在地图上规划路径：拖动路径点 vs “把第三个途经点调整到经度X纬度Y的位置”</li>
</ul>
<p>GUI的优势在于：所见即所得，直接操作，实时反馈。
而Agent的价值在于：处理那些需要思考、推理、跨域协作的复杂任务。</p>
<p>两者的关系不是替代，而是互补。</p>
<h2 data-id="heading-10">所以，未来的B端界面要如何设计？</h2>
<p>在人工智能领域，意图通常被定义为用户希望达成的目标，如查询天气情况、办理银行业务、预约服务等。这些意图并不总是直接表达出来，而是隐含在用户的言行之中。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7d9855597ae4cbd895fc40a08132120~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5pav5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492365&amp;x-signature=8A%2Fiyt49nm3pu%2F7%2FGfYpJwQaYgU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我脑海中浮现的画面是这样的：
一个干净的工作台：没有密密麻麻的菜单，只有几个核心数据看板。
一个随时待命的助手：角落里的对话入口，你可以打字，也可以语音。
一组灵活的能力组件：不是固定的页面，而是可以根据任务动态组合的卡片、图表、表单。</p>
<p>当你需要完成一个任务时：</p>
<ol>
<li>向助手描述你的目标</li>
<li>系统理解意图，组装合适的组件</li>
<li>你在生成的界面上微调、确认</li>
<li>系统记住你的偏好，下次做得更好
这听起来像是科幻，但其实技术已经基本就位。缺的不是能力，而是我们作为设计者和开发者的想象力。</li>
</ol>
<h2 data-id="heading-11">写在最后</h2>
<p>最近在推动Agent项目落地时，我最常说的一句话是：“别只想着技术能做什么，多想想用户应该怎么工作。”</p>
<p>Agent不是炫技的工具，它应该是缩短想法与结果之间距离的桥梁。</p>
<p>作为前端，我们正站在一个奇妙的转折点上。过去我们关心像素、关心动画、关心性能，这些依然重要。但现在，我们更需要关心：</p>
<ul>
<li>如何让组件变得“可被理解”？</li>
<li>如何设计“人机协作”的交互流程？</li>
<li>如何平衡“自动决策”和“人工控制”？
这不是AI的胜利，这是交互设计理念的回归——让技术适应人，而不是让人适应技术。</li>
</ul>
<p>也许很快，我们就能告别那个需要记住“点击这里、跳转那里、配置这个”的时代。取而代之的，是一个你说“我需要…”，系统回答“好的，已经准备好了”的时代。</p>
<p>那一天到来时，今天的我们，正在为它铺路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[掌握核心方法论，打造高质量业务仪表板]]></title>    <link>https://juejin.cn/post/7597009443084697615</link>    <guid>https://juejin.cn/post/7597009443084697615</guid>    <pubDate>2026-01-20T05:47:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597009443084697615" data-draft-id="7596962344046051368" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="掌握核心方法论，打造高质量业务仪表板"/> <meta itemprop="keywords" content="数据可视化,数据分析"/> <meta itemprop="datePublished" content="2026-01-20T05:47:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            掌握核心方法论，打造高质量业务仪表板
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:47:48.000Z" title="Tue Jan 20 2026 05:47:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在数字化运维与业务监控的实践中，仪表板（Dashboard）与汽车的仪表盘同等重要，它不仅是数据可视化的载体，更是团队快速定位问题、洞察数据趋势的核心工具。观测云在平台中内置了大量通用组件、云服务的仪表板模板。但如果你希望从零开始构建个性化的仪表板，又或者对自己绘制的仪表板不够满意，那么这篇文章将教授你几个小技巧，帮助你有效提升仪表板的质量。</p>
<h2 data-id="heading-1">观测云简介</h2>
<p>观测云是一个统一实时监测平台，它提供全面的系统可观测性解决方案，帮助用户快速实现对云平台、云原生、应用及业务的监控需求。观测云的核心功能包括：基础设施监测，日志采集和分析，用户访问监测（RUM），应用性能监测（APM），服务可用性监测（拨测），安全监测，智能监控等等。这款产品能够帮助工程师全面了解端到端的用户体验追踪，了解应用服务的每一次调用，以及全面监控云时代的基础设施。此外，观测云还具备快速发现系统安全风险的能力，为数字化时代提供安全保障。更多信息可以访问观测云官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.guance.com%2F" target="_blank" title="https://www.guance.com/" ref="nofollow noopener noreferrer">www.guance.com</a></p>
<h2 data-id="heading-2">基础仪表板的绘制</h2>
<p>让我们进入到观测云，创建一个属于您自己的仪表板。首先，你需要找到仪表板的入口「场景」-「仪表板」，点击「新建仪表板」-「新建空白仪表板」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/333759108314492781504b30b087a7e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=3Z6UX6zpaZrvGxxHjraDyPovW2Y%3D" alt="" loading="lazy"/></p>
<p>其次，可以从侧滑窗口中选择适合展示数据的图表类型，拖拽到左边的空白画布中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e465e05ce9f54854851e9dca5edfb8a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=6HGYT346IzEFuSSfCbAK8MYEHoQ%3D" alt="" loading="lazy"/></p>
<p>以常用的「时序图」为例，拖动到画布中即可打开「新建图表」弹窗，此时通过数据筛选控件来选择需要展示的指标。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a21b52c47adb4e11879bc8e3a0378e1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=wr7a%2BtFEmgDoMppQYxLWWIgyOwo%3D" alt="" loading="lazy"/></p>
<p>如图所示，我们已经展示了一条指标曲线，它代表的含义为：指标集为 cpu，指标名为 usage_total，按照 host 进行分组并统计 Avg 平均值，只显示 host=DESKTOP-F9E75IG 的值（过滤条件），点击右下角的保存即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a2b2e619b3d493b80fb47635311938a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=uS7E3PUhbfXV3fODmjJtYpFBdQ0%3D" alt="" loading="lazy"/></p>
<p>此时你已经完成了第一张图表的制作，通过一张张图表的叠加，你很快能得到一个完整的仪表板，不过它看上去有些简陋，我们需要更多技巧对仪表板的美观程度和易读性进行优化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2eb025dff914578aa348519416a733b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=5HHVeRsAVq65SkQp0JGVRjqqEdI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">仪表板的优化</h2>
<h3 data-id="heading-4">新增标题和描述</h3>
<p>恰当的标题能让用户第一时间知道图表展示的指标及其含义，而图表的描述能够起到有效补充说明。我个人的习惯是将图表名设置为指标的英文名，然后在「描述」中补充该指标的中文含义。如下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e1643f12d1a48e5a1c80064d2acd07c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=bUsHBdkRvpPgyqOrnRUIjG7I0Us%3D" alt="" loading="lazy"/></p>
<p>保存生效的效果如下，图表左上角将展示标题，而鼠标 hover 到帮助按钮上则会悬浮显示描述。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5450112709c24704a8d0549cf2598f0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=8iF25S3ZKVcRD7MU2ouy8f17oPc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">数据单位</h3>
<p>一部分指标在采集到观测云后没有单位，因此在绘制仪表板时需要注意补充单位。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f57d23f8106409f922c4698966cc308~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=FVBTeD5tXUZIXKLCrQG5ageY0rw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">别名</h3>
<p>图表的曲线会显示对象的名称，并且对象名称会随着分组条件的增多而变得复杂。例如下图，由于添加了 namespace，pod_name 等多个分组条件，对象名称显得很长，很不直观。好在我们可以通过配置「别名」来简化对象名称的显示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b26a5c176fef4807994a71d4f9a3fd78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=E9zW9d%2BzBkZ44eQeVCCLpcG53PY%3D" alt="" loading="lazy"/></p>
<p>在图表配置的「别名」处，我们选择对应的指标序列，并用 {{}} 将分组条件包起来作为变量，例如下图中的分组条件 pod_name 就写为 {{pod_name}} ，效果如下所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ac47208e167414384a0d4f0bfe706c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=lHIH81E4jN4PdtJVmuo8HSKubGA%3D" alt="" loading="lazy"/></p>
<p>我们也支持用多个变量作为别名，写法为 {{分组条件1}}-{{分组条件2}} ，例如 {{namespace}}--{{pod_name}} ，效果如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a8d36ae462c4b109ce3e18880a854d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=lNO8iRNQNrh7oCrDX9O7jlnN0e8%3D" alt="" loading="lazy"/></p>
<p>现在，曲线上显示的对象名称已经比原始的名称简洁、清晰了很多。</p>
<h3 data-id="heading-7">图例</h3>
<p>图表默认没有带上图例，除非将鼠标 hover 上去，否则无法看到什么颜色的曲线代表哪一个对象，如下图的左侧所示。而「图例」则可以将对象的名称和统计值显示到图表中，如下图的右侧所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e24fbebf7004b0690b0a44431439f75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=pfwJaWJCEBLOJV5rvCyCsmOaWqI%3D" alt="" loading="lazy"/></p>
<p>添加图例的方式如下，可选择将图例放置在图表的底部或者右侧，并显示单个或者统计值，将 Avg、Max、Last 一起显示出来是个不错的选择。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/194005883ea24e1bb80d69b557cb8bdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=PFI6B8b1r3h6ZqvXBT%2Bg76gE6nc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">分组</h3>
<p>当仪表板中需要展示很多张图表时，使用「分组」来将不同含义的图表分门别类地归类就十分有必要了，这会让仪表板的显示更具有条理，用户能通过分组快速找到自己关注的图表，如下图所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d34343b951b4f009a4f292523bea172~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=Y92o59KNIg2%2BQyYSbMqANvAeeTg%3D" alt="" loading="lazy"/></p>
<p>给仪表板添加分组时，只需要在侧滑菜单中找到「分组」这个图表类型，拖动到左侧画布即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48e594d566ad4e18948682a6e3db20f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=OTGnYR6w5xPLmjNETtknbwgjFiQ%3D" alt="" loading="lazy"/></p>
<p>取一个有意义的分组名称，选择一个与众不同的颜色，保存即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/088f87d5ce8d40ce830909a43886ce2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=oofi9Hx0EZvdBL%2FtUCThOSGC0RY%3D" alt="" loading="lazy"/></p>
<p>下图即为新创建的分组，后续添加的图表即可拖动到该分组下。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20f0d13389614f5a99a3855ff7606645~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=DTJaKXPMwL4S%2Fc9EUHVovfN1rAk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">锁定时间</h3>
<p>如果你希望每次进入到仪表板，都查看到固定时间区间（例如最近1天）的数据，应该如何实现呢？</p>
<p>我们很容易注意到仪表板的时间控件，可以在这里固定整个仪表板的时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffa6c2d835334037854d86a1c3304ca6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=4CMQ%2FXzce%2FoY8wVb5kkrEv2Gf4g%3D" alt="" loading="lazy"/></p>
<p>如果需要将单个图表的时间进行固定，而其他图表的时间则跟随仪表板的时间控件，也很好实现。我们进入单个图表的编辑窗口，打开「高级配置」，将时间锁定为指定区间即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07fa1057949d41cf8a73762c734568a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=I0ysME8tOEOhy2vcm72BA1njiqI%3D" alt="" loading="lazy"/></p>
<p>配置完成后，这个图表的右上角会出现你锁定的时间区间，该时间不受仪表板整体的时间区间控制，如下图所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5bbbaacdfc548488732afc90da229f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=ivIHeaUaR1y9qVgWmJfMmyPOOXo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">视图变量</h3>
<p>视图变量允许用户通过下拉菜单来选择特定对象的监控数据，从而根据自身需求动态筛选和分析数据。如下图所示，该仪表板包括了 Cluster、Namespace 和 Node 三个视图变量，用户可以进行自由筛选。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d4aa45b10d24c20b1e3edfbb19be8ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=en%2BwcDHIQ6AoxsxE8yMxnxNvxYY%3D" alt="" loading="lazy"/></p>
<p>我们首先添加一个简单的视图变量，需求是通过选择 host_ip 来过滤单台主机的数据。在仪表板中点击「添加视图变量」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51ce9c1998ce48ab8b737a27e3bc2e18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=xt5vh0WB0VmBUFuSMe1us2QUavA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26c451a1950e4ffc9f7231657a36f19c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=MuZZ0wvXNQ42fFkOEcKZtaSCOmg%3D" alt="" loading="lazy"/></p>
<p>host_ip 是 cpu 相关指标数据的一个标签，因此我们从指标类型- CPU指标集里面选择 host_ip 作为视图变量的来源，然后将「变量名」和「显示名」都与之保持一致，保存窗口即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe7a7d7399f643689e2574427ace0e76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=PG%2BWMQKOjzgJrUUBGfuJgxCJ984%3D" alt="" loading="lazy"/></p>
<p>此时返回仪表板，就会看到刚才添加的 host_ip 视图变量，从下拉菜单中可以筛选主机 IP。如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d89c3eede6749ad8e62b235b9246cb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=9QLCCB3HxMwmUpIfPCRIZnLI1E4%3D" alt="" loading="lazy"/></p>
<p>你可能会发现筛选结果之后，对下方的图表没有任何作用，因为我们还需要在图表中的过滤条件配置变量，使仪表板的额视图变量与图表的过滤条件进行联动。再次进入图表编辑界面，添加一个过滤条件，字段选择为 host_ip，值选择「视图变量」，如下图所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32ad9f728a484df1a190f83891124235~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=u9jBN9aTbI2OAaCHQB58p5CVJkc%3D" alt="" loading="lazy"/></p>
<p>返回仪表板，这时仪表板的视图变量 host_ip 就可以与图表中的监控对象 host_ip 进行联动了。我们可以通过下拉菜单来筛选不同的主机，从而观察不同主机的监控指标。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d90efe78305463a9fdc62582cdea9e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=JNN8g6qeLTBfhGDQJeO%2FVak2qjU%3D" alt="" loading="lazy"/></p>
<p>如果是有多个视图变量，且视图变量之间有依赖关系，例如我们针对 Pod 的监控是首先选择 namespace，再选 Pod，那我们又应该如何配置呢？这就要用到「级联」的写法，让我们来再来回顾一下刚才本章开头的那张图片。选择 Cluster 后，Namespace 的值随 Cluster 的取值而联动，Node 的值又随 Namespace 的取值而联动。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a6753aec12b41f1b5e8ed14b8822c2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=mQJ8K96GjuDZM8f0zZ2gR1AsfdM%3D" alt="" loading="lazy"/></p>
<p>我们研究一下这组视图变量的写法，不难发现规律是在 show_tag_value 函数的后面跟随了一个 {key=value} 的过滤条件，其固定写法为 {key='#{value}'} ，key 和 value 都取自上一级的变量名，表示该变量随上一级变量的值而联动。如下图所示，当用户在界面上选择了 cluster_name_k8s 的值后，该值就会传入 namespace 作为过滤条件，从而实现变量联动。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b8397ef9b94924be46b7db52f41ccd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=myFRqvQBdnurRS13DvGL1GK8x2A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90a5fd34ead44e6e844333dae5274dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492868&amp;x-signature=LfWOXyZqqrUNKsPgGZZiAtBB710%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">小结</h2>
<p>通过上面的几个小技巧，相信你已经跃跃欲试将自己的仪表板更上一层楼了。在得到令自己满意的仪表板后，你可以选择将仪表板开放给团队、配置为定时报告、投放到大屏幕、关联到日志或链路查看器中，又或者在接收到告警时一键查看这张仪表板。我们非常期待你通过仪表板来向你的团队/客户呈现数据的价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年度稀土掘金影响力榜单如约而至！]]></title>    <link>https://juejin.cn/post/7589823928413241370</link>    <guid>https://juejin.cn/post/7589823928413241370</guid>    <pubDate>2025-12-31T07:57:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589823928413241370" data-draft-id="7589578614583132186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年度稀土掘金影响力榜单如约而至！"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-31T07:57:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年度稀土掘金影响力榜单如约而至！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194374926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-31T07:57:38.000Z" title="Wed Dec 31 2025 07:57:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3,871
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">稀土掘金社区2025年度影响力榜单正式公布</h2>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d84e196bd63448db7cedc4f98be0bc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768983079&amp;x-signature=tci%2B%2BO58Guui6sHmsaiPJZ7GrEU%3D" alt="1303-734主视觉 (1) (3).jpg" width="100%" loading="lazy"/>
<p>时光向前，2025年即将落下句点。回首这一程，幸而有伴 —— 每一次深夜的打磨，每一段真诚的分享，每一回评论区里的倾力相助，都为技术探索的漫漫长路，点亮了一盏盏暖灯。</p>
<p>感谢这一年里，将实操经验凝注于代码、把深度思考落笔成文字的创作者。是每一个具体的 “你”，让稀土掘金始终活力满满。</p>
<p>今天，我们以这份榜单，记录那些值得被看见的光芒。它们来自团队扎实的沉淀，来自创作者持久的热情，也来自那些真正帮助过许多人的走心好文。</p>
<p><strong>榜单地址</strong>：<a href="https://aicoding.juejin.cn/pens/7589935553110835252" target="_blank" title="https://aicoding.juejin.cn/pens/7589935553110835252">aicoding.juejin.cn/pens/758993…</a></p>
<h2 data-id="heading-1">2025年度优秀创作者 | The Best 10 Creative Writers of 2025</h2>
<blockquote>
<p>他们是社区里的“解惑人”，把复杂讲得简单，把枯燥变得生动。他们的文字，曾陪伴无数掘友走出技术探索的迷茫时刻。</p>
</blockquote>

















































<table><thead><tr><th>站内昵称</th><th>个人主页</th></tr></thead><tbody><tr><td>Moment</td><td><a href="https://juejin.cn/user/3782764966460398" target="_blank" title="https://juejin.cn/user/3782764966460398">juejin.cn/user/378276…</a></td></tr><tr><td>ConardLi</td><td><a href="https://juejin.cn/user/3949101466785709" target="_blank" title="https://juejin.cn/user/3949101466785709">juejin.cn/user/394910…</a></td></tr><tr><td>何贤</td><td><a href="https://juejin.cn/user/277499952247869" target="_blank" title="https://juejin.cn/user/277499952247869">juejin.cn/user/277499…</a></td></tr><tr><td>洛卡卡了</td><td><a href="https://juejin.cn/user/888839672963544" target="_blank" title="https://juejin.cn/user/888839672963544">juejin.cn/user/888839…</a></td></tr><tr><td>why技术</td><td><a href="https://juejin.cn/user/3702810893364350" target="_blank" title="https://juejin.cn/user/3702810893364350">juejin.cn/user/370281…</a></td></tr><tr><td>恋猫de小郭</td><td><a href="https://juejin.cn/user/817692379985752" target="_blank" title="https://juejin.cn/user/817692379985752">juejin.cn/user/817692…</a></td></tr><tr><td>苏三说技术</td><td><a href="https://juejin.cn/user/465848661970824" target="_blank" title="https://juejin.cn/user/465848661970824">juejin.cn/user/465848…</a></td></tr><tr><td>coder_pig</td><td><a href="https://juejin.cn/user/4142615541321928" target="_blank" title="https://juejin.cn/user/4142615541321928">juejin.cn/user/414261…</a></td></tr><tr><td>张风捷特烈</td><td><a href="https://juejin.cn/user/149189281194766" target="_blank" title="https://juejin.cn/user/149189281194766">juejin.cn/user/149189…</a></td></tr><tr><td>德莱厄斯</td><td><a href="https://juejin.cn/user/3919115686512942" target="_blank" title="https://juejin.cn/user/3919115686512942">juejin.cn/user/391911…</a></td></tr></tbody></table>
<h2 data-id="heading-2">2025年度影响力团队 -The Most Influential Teams of 2025</h2>
<blockquote>
<p>他们以团队的力量，把一线实践沉淀成可复用的经验，如一张张清晰的技术地图，帮助不少同行找到了方向。</p>
</blockquote>

















































<table><thead><tr><th>团队名称</th><th>团队主页</th></tr></thead><tbody><tr><td>DevUI团队</td><td><a href="https://juejin.cn/user/712139267650141" target="_blank" title="https://juejin.cn/user/712139267650141">juejin.cn/user/712139…</a></td></tr><tr><td>vivo互联网技术</td><td><a href="https://juejin.cn/user/993614243303053" target="_blank" title="https://juejin.cn/user/993614243303053">juejin.cn/user/993614…</a></td></tr><tr><td>得物技术</td><td><a href="https://juejin.cn/user/2392954206960247" target="_blank" title="https://juejin.cn/user/2392954206960247">juejin.cn/user/239295…</a></td></tr><tr><td>古茗前端团队</td><td><a href="https://juejin.cn/user/3233040624266695" target="_blank" title="https://juejin.cn/user/3233040624266695">juejin.cn/user/323304…</a></td></tr><tr><td>货拉拉技术</td><td><a href="https://juejin.cn/user/1768489241815070" target="_blank" title="https://juejin.cn/user/1768489241815070">juejin.cn/user/176848…</a></td></tr><tr><td>京东零售技术</td><td><a href="https://juejin.cn/user/4233576972293643" target="_blank" title="https://juejin.cn/user/4233576972293643">juejin.cn/user/423357…</a></td></tr><tr><td>奇舞精选</td><td><a href="https://juejin.cn/user/4388906147515367" target="_blank" title="https://juejin.cn/user/4388906147515367">juejin.cn/user/438890…</a></td></tr><tr><td>37手游后端团队</td><td><a href="https://juejin.cn/user/1548527766871239" target="_blank" title="https://juejin.cn/user/1548527766871239">juejin.cn/user/154852…</a></td></tr><tr><td>哔哩哔哩技术</td><td><a href="https://juejin.cn/user/3030701626893405" target="_blank" title="https://juejin.cn/user/3030701626893405">juejin.cn/user/303070…</a></td></tr><tr><td>转转技术团队</td><td><a href="https://juejin.cn/user/606586148237431" target="_blank" title="https://juejin.cn/user/606586148237431">juejin.cn/user/606586…</a></td></tr></tbody></table>
<h2 data-id="heading-3">2025年度爆款好文 | High hits articles in 2025</h2>
<blockquote>
<p>这20篇文章，是从海量分享中脱颖而出的“年度之选”。它们或视角新颖、或剖析深入、或实战性强，在各自领域内获得了认可，成了许多掘友收藏或推荐的那一篇。</p>
</blockquote>



























































































































































<table><thead><tr><th>文章标题</th><th>文章链接</th><th>所属作者</th><th/></tr></thead><tbody><tr><td/><td><strong>前端</strong></td><td/><td/></tr><tr><td>《40岁老前端2025年上半年都学了什么？》</td><td><a href="https://juejin.cn/post/7524548909530005540" target="_blank" title="https://juejin.cn/post/7524548909530005540">juejin.cn/post/752454…</a></td><td>张鑫旭</td><td/></tr><tr><td>《前端仔如何在公司搭建 AI Review 系统》</td><td><a href="https://juejin.cn/post/7532596434031149106" target="_blank" title="https://juejin.cn/post/7532596434031149106">juejin.cn/post/753259…</a></td><td>唐某人丶</td><td/></tr><tr><td>《因为写了一个前端脚手架，这个月的KPI 打满了！！！》</td><td><a href="https://juejin.cn/post/7457936514791292938" target="_blank" title="https://juejin.cn/post/7457936514791292938">juejin.cn/post/745793…</a></td><td>赵小川</td><td/></tr><tr><td>《因网速太慢我把20M+的字体压缩到了几KB》</td><td><a href="https://juejin.cn/post/7490337281866317836" target="_blank" title="https://juejin.cn/post/7490337281866317836">juejin.cn/post/749033…</a></td><td>古茗前端团队</td><td/></tr><tr><td>《历经4个月，基于 Tiptap 和 NestJs 打造一款 AI 驱动的智能文档协作平台 🚀🚀🚀》</td><td><a href="https://juejin.cn/post/7553165143376134195" target="_blank" title="https://juejin.cn/post/7553165143376134195">juejin.cn/post/755316…</a></td><td>Moment</td><td/></tr><tr><td/><td><strong>后端</strong></td><td/><td/></tr><tr><td>《MCP 很火，来看看我们直接给后台管理系统上一个 MCP？》</td><td><a href="https://juejin.cn/post/7481491253499969575" target="_blank" title="https://juejin.cn/post/7481491253499969575">juejin.cn/post/748149…</a></td><td>Hamm</td><td/></tr><tr><td>《还在用WebSocket实现即时通讯？试试MQTT吧，真香！》</td><td><a href="https://juejin.cn/post/7539351775044862003" target="_blank" title="https://juejin.cn/post/7539351775044862003">juejin.cn/post/753935…</a></td><td>MacroZheng</td><td/></tr><tr><td>《我做了套小红书一键发布系统，运营小姐姐说她不想离开我了》</td><td><a href="https://juejin.cn/post/7552489208804491316" target="_blank" title="https://juejin.cn/post/7552489208804491316">juejin.cn/post/755248…</a></td><td>洛卡卡了</td><td/></tr><tr><td>《Java 实现责任链模式 + 策略模式：优雅处理多级请求的方式》</td><td><a href="https://juejin.cn/post/7457366224823124003" target="_blank" title="https://juejin.cn/post/7457366224823124003">juejin.cn/post/745736…</a></td><td>后端出路在何方</td><td/></tr><tr><td>《CompletableFuture还能这么玩》</td><td><a href="https://juejin.cn/post/7455561985378598951" target="_blank" title="https://juejin.cn/post/7455561985378598951">juejin.cn/post/745556…</a></td><td>一只叫煤球的猫</td><td/></tr><tr><td/><td><strong>移动端</strong></td><td/><td/></tr><tr><td>《2025 跨平台框架更新和发布对比，这是你没看过的全新版本》</td><td><a href="https://juejin.cn/post/7505578411492474915" target="_blank" title="https://juejin.cn/post/7505578411492474915">juejin.cn/post/750557…</a></td><td>恋猫de小郭</td><td/></tr><tr><td>《月下载 40 万次的框架是怎么练成的？》</td><td><a href="https://juejin.cn/post/7547408384585629711" target="_blank" title="https://juejin.cn/post/7547408384585629711">juejin.cn/post/754740…</a></td><td>Android轮子哥</td><td/></tr><tr><td>《[targetSDK升级为35] 恶心的EdgeToEdge适配 (v7)》</td><td><a href="https://juejin.cn/post/7497170890083762213" target="_blank" title="https://juejin.cn/post/7497170890083762213">juejin.cn/post/749717…</a></td><td>snwrking</td><td/></tr><tr><td>《gson很好，但我劝你在Kotlin上使用kotlinx.serialization》</td><td><a href="https://juejin.cn/post/7459298439811219496" target="_blank" title="https://juejin.cn/post/7459298439811219496">juejin.cn/post/745929…</a></td><td>沈剑心</td><td/></tr><tr><td>《开箱即食Flutter通用脚手架》</td><td><a href="https://juejin.cn/post/7482789772362317864" target="_blank" title="https://juejin.cn/post/7482789772362317864">juejin.cn/post/748278…</a></td><td>SunshineBrother</td><td/></tr><tr><td/><td><strong>人工智能</strong></td><td/><td/></tr><tr><td>《一天 AI 搓出痛风伴侣 H5 程序，前后端+部署通吃，还接入了大模型接口（万字总结）》</td><td><a href="https://juejin.cn/post/7517496354244067339" target="_blank" title="https://juejin.cn/post/7517496354244067339">juejin.cn/post/751749…</a></td><td>志辉AI编程</td><td/></tr><tr><td>《AI 应用开发入门：前端也可以学习 AI》</td><td><a href="https://juejin.cn/post/7517197769247391756" target="_blank" title="https://juejin.cn/post/7517197769247391756">juejin.cn/post/751719…</a></td><td>唐某人丶</td><td/></tr><tr><td>《如何把你的 DeePseek-R1 微调为某个领域的专家？》</td><td><a href="https://juejin.cn/post/7473309339294695460" target="_blank" title="https://juejin.cn/post/7473309339294695460">juejin.cn/post/747330…</a></td><td>ConardLi</td><td/></tr><tr><td>《3天，1人，从0到付费产品：AI时代个人开发者的生存指南》</td><td><a href="https://juejin.cn/post/7577653509862654002" target="_blank" title="https://juejin.cn/post/7577653509862654002">juejin.cn/post/757765…</a></td><td>HiStewie</td><td/></tr><tr><td>《全网最细，一文带你弄懂 MCP 的核心原理！》</td><td><a href="https://juejin.cn/post/7493455615244959794" target="_blank" title="https://juejin.cn/post/7493455615244959794">juejin.cn/post/749345…</a></td><td>ConardLi</td><td/></tr></tbody></table>
<h2 data-id="heading-4">好的社区，是人与人相互照亮</h2>
<p>这份榜单，与其说是评选，不如说是一次郑重的致谢。谢谢所有分享者，也谢谢每一位静静学习、默默点赞、热心评论的掘友。</p>
<p>技术之路，日常而长远。2026年，愿你继续在这里写下自己的章节，发出自己的光。我们相信，每一个人的微小光芒，终将汇聚成行业的星辰。</p>
<p>*注：以上排名不分先后，随机排序。本榜单依据<strong>2025年1月1日至12月21日</strong>期间的数据综合评定，涵盖文章质量、互动热度、创作者影响力、分类分布及评审团意见等多维度，最终解释权归稀土掘金所有。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Meta ShapeR ：基于随机拍摄视频的 3D 物体生成，未来的 XR 和机器人基建支持]]></title>    <link>https://juejin.cn/post/7597083949833797638</link>    <guid>https://juejin.cn/post/7597083949833797638</guid>    <pubDate>2026-01-20T05:54:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083949833797638" data-draft-id="7597168034616672275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Meta ShapeR ：基于随机拍摄视频的 3D 物体生成，未来的 XR 和机器人基建支持"/> <meta itemprop="keywords" content="前端,Android,AI编程"/> <meta itemprop="datePublished" content="2026-01-20T05:54:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Meta ShapeR ：基于随机拍摄视频的 3D 物体生成，未来的 XR 和机器人基建支持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:54:37.000Z" title="Tue Jan 20 2026 05:54:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日 Meta 突然开源了它的 ShapeR 项目，ShapeR 可以利用基于对象多模态数据的 Rectified Flow Transformer，将普通图像序列转换为完整的度量场景重建，说人话就是：</p>
<blockquote>
<p><strong>从随手拍的视频/多张照片里，把真实物体恢复成可用 3D 模型（Mesh）</strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bf8a838b0144e5cb01212204e0b7fcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=YWca4hlM0a3iISD5%2F4znADH1yfY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c77a685673244eb8a3204ebd16bfb06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=8kPoF0npRJmznj65h4m4saegDsQ%3D" alt="" loading="lazy"/></p>
<p>简单来说就是，你可以拿着手机绕着一个物体拍一圈（图片序列 / 视频帧序列），ShapeR 会结合：</p>
<ul>
<li>SLAM 得到的稀疏点云 + 相机位姿</li>
<li>物体检测/实例分割得到的对象实例</li>
<li>VLM 生成的文本 caption（描述物体），把这些多模态条件喂给生成模型，最后得到<strong>物体的 metric 3D mesh（带真实尺度）</strong></li>
</ul>
<p>看到这么多名词是不是有点懵？这些概念性的东西我们需要简单聊聊：</p>
<h4 data-id="heading-0">SLAM</h4>
<p>这个是 ShapeR 的地基核心，<strong>SLAM (Simultaneous Localization and Mapping) 其实就是用算法解决摄像头在陌生化环境的定位和建图</strong>，实现定位的时候建图，建图的时候定位的支持，简单来说就是：</p>
<ul>
<li>摄像头采集数据</li>
<li>通过画面比对计算移动距离</li>
<li>通过算法来修正误差</li>
<li>通过回环检测来解决漂移和消除误差</li>
</ul>
<p>用人话来说就是：<strong>用 SLAM 可以得到 “摄影师的足迹”和“物体的骨架”</strong> ，具体来自：</p>
<ul>
<li><strong>相机位姿</strong>：相当于记录了你拿着手机绕着物体走动时，每一步具体站在哪里，手机镜头朝向哪里（比如：向左走了 1 米，镜头向下倾斜 30 度）<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07e11b19046145d08d65f222dbe03f26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=i0fvm9RdxnTLJf%2B6xatDJBEzD4A%3D" alt="" loading="lazy"/></li>
<li><strong>稀疏点云</strong>：相当于你在物体上撒了一把荧光粉，SLAM 并不试图重建整个物体表面，它只抓取最明显的特征点（比如桌角、杯子的把手尖），看起来稀稀拉拉像个幽灵，<strong>但它锁定了物体的真实尺寸和空间位置</strong><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd9100dafc1b41ae80c88949d430c2f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=kUOZqIoj32CQffKPcJbDtWT6wvc%3D" alt="" loading="lazy"/></li>
</ul>
<p>SLAM 之所以能做到这一点，核心依赖于<strong>几何学的三角测量和概率学的误差优化</strong>，简单来说：</p>
<ul>
<li>
<p>当你拿着手机移动时（比如向右移动了 10 厘米），SLAM 会对比前后两帧画面：</p>
<ul>
<li><strong>A点（比如桌上的杯子）</strong> 在画面里移动了 100 个像素 -&gt; 推算：<strong>它离我很近</strong></li>
<li><strong>B点（窗外的树）</strong> 在画面里只移动了 2 个像素 -&gt; 推算：<strong>它离我很远</strong></li>
</ul>
<p>通过这种<strong>视差</strong>，配合手机摄像头移动的距离（IMU 传感器提供），算法就能画出一个个三角形，通过几何公式算出每个特征点在三维空间中的精确坐标，这在室内导航 BLE 测距离也会有类似的三角测量用法</p>
</li>
<li>
<p>SLAM 并不是真的知道自己移动了多少米，它最聪明的地方在于不追求一步到位，而是不断“猜”和“改”，通过假设和推算不断去修正误差</p>
</li>
<li>
<p>最后有个回环检测，比如误差越来越大，但是当你绕了一圈回到原点时，摄像头拍到了之前的场景，比对之后会发，这个画面和之前 5 分钟的画面重合，那么它会把过去 5 分钟积累的所有位置偏差强制拉回</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1da6cb9389054a41a99c4f697cfcd92e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=gCdLba23K51c9fDQlw8IHBX4GQo%3D" alt="" loading="lazy"/></p>
<p>这就是 SLAM 的简单概念，实际上这也是移动开发里的 ARCore 和 ARkit 的基础概念之一，同时对于机器人、无人机或者 XR ，SLAM 也是非常重要的基础，如果用人话来说就是，<strong>SLAM 是把硬件数据（IMU 的加速度、摄像头的像素变化）转化为了几何约束</strong>：</p>
<ul>
<li><strong>眼睛（Camera）</strong> ：提供角度信息（我知道杯子在那个方向）</li>
<li><strong>前庭（IMU）</strong> ：提供尺度信息（我感觉我向前冲了 1 米）</li>
<li><strong>大脑（Algorithm）</strong> ：通过几何公式把角度和尺度结合，算出距离，再通过记忆（回环检测）修正走过的路</li>
</ul>
<h4 data-id="heading-1">物体检测 / 实例分割</h4>
<p><strong>物体检测 / 实例分割（Object Detection / Instance Segmentation）简单说就是 “自动抠图”和“聚光灯”</strong> ：</p>
<ul>
<li>你拍的是整个房间，但你只想重建桌上的那个茶壶</li>
<li>这就需要一个算法，能自动在乱糟糟的背景里把茶壶给“圈出来”（画个框），甚至精确到把茶壶的每一个像素都涂上颜色，把背景剔除掉，这就是把茶壶从环境里“抠”出来</li>
</ul>
<p>具体到实现上就是：</p>
<ul>
<li><strong>物体检测 (Detection)</strong> ：输出一个 Bounding Box（边界框），告诉系统物体大概在哪（比如 <code>[x1, y1, x2, y2]</code>）</li>
<li><strong>实例分割 (Instance Segmentation)</strong> ：输出一个 Binary Mask（二值掩码），在这个掩码图里，属于茶壶的像素是 1，背景是 0</li>
</ul>
<p>ShapeR 是 Object-Centric（以物体为中心）的，它需要这些 Mask 来告诉生成模型：“只准重建这个茶壶，不要把后面的墙壁和下面的桌子也算进去了”</p>
<h4 data-id="heading-2">VML</h4>
<p>最后是 VLM (Visual Language Model generated Captions) 生成的文本 Caption，通俗理解来说就是“给 AI 的命题作文”：</p>
<ul>
<li>虽然有了照片，但生成模型有时候比较“笨”，它可能看不清照片里的细节（比如模糊了，或者被挡住了）</li>
<li>这时，就需要一个专门懂图片的 AI（VLM，类似 GPT-4V），让它看一眼照片，然后写一段话：“这是一个红色的复古木质椅子，椅背有雕花，坐垫是天鹅绒材质。”</li>
</ul>
<p>也就是针对图形增加一点文本表述，提供更准确的语义，照片提供了“几何外观”，文本提供了“概念理解”，防止照片里因为反光或遮挡导致细节丢失时，模型可以根据这段文本描述，利用其训练库里关于“复古木质椅子”的知识，合理地“脑补”出看不清的细节。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef9a57854e7b4713a225406133b8f56c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=k29TVlcFmssyyZzp4AHwGSmr8Bc%3D" alt="" loading="lazy"/></p>
<p>所以 ShapeR 基本概念就是通过这三者完成建模：</p>
<ul>
<li>SLAM 提供骨架和尺子：“雕像必须这么高，膝盖必须在这里，不能乱动。”（保证准确度）</li>
<li>实例分割提供一个轮廓剪影：“只能在这个范围内雕刻，别把旁边的花瓶也雕进去了。”（保证独立性）</li>
<li>VLM Caption 提供附录：“这可是个由桃花心木做的 18 世纪风格椅子，纹理要细腻。”（保证细节和合理性）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4df52317da414eafa5533f00b8dd09ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=DmJqqGWt6tF4zyIm4gUuzF58WrU%3D" alt="" loading="lazy"/></p>
<p>那么从前面的概念也可以看出来，ShapeR 的特点是：<strong>它不是直接重建一个整体 NeRF / TSDF 场景块，而是先检测场景中的多个对象 ，然后对每个对象单独重建 mesh ，最后再组装成场景</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eb8da197bd041e0a2acefe3b59e59ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=2hq4its6ZBU5Ch%2Fb9L92EI7N6bo%3D" alt="" loading="lazy"/></p>
<p>所以在 ShapeR 里，你可以：</p>
<ul>
<li>单独拿出某个物体（比如椅子/桌子）</li>
</ul>

<ul>
<li>替换/移动/重新摆放</li>
</ul>

<ul>
<li>导出到 DCC/引擎里编辑（Blender/Unity/Unreal）</li>
</ul>
<blockquote>
<p>换个概念简单理解，以前你只能得到一个 PNG，现在你可以得到一个 PSD</p>
</blockquote>
<p>那你可能会说，它有什么作用？实际上它的作用还挺丰富，比如：</p>
<ul>
<li>AR 场景理解 / 虚拟摆放</li>
<li>机器人避障、navigation</li>
<li>具身 AI 的数据集构建（真实物体 mesh + 尺度）</li>
</ul>
<p>ShapeR 可以把“现实物体”的视频快速转成结构化的 3D 资产（mesh 级别），当然，事实上 ShapeR 不是“直接吃视频就出 3D”，它吃的是 <strong>预处理后的 per-object 数据包（pkl）</strong> ，里面包含：</p>
<ul>
<li>物体的稀疏 metric point cloud（来自 SLAM / SfM）</li>
<li>带位姿的多视图图像（posed images）</li>
<li>物体的 caption 文本描述</li>
<li>物体的 2D/3D 实例信息（用于从场景里拆出物体）</li>
</ul>
<p><strong>所以 ShapeR 的核心难点确实不在模型推理本身，而在于数据准备</strong> ，目前 ShapeR 的代码库明确指出，它的前提是假设数据已经通过 <strong>Aria MPS (Machine Perception Services)</strong> 流水线处理过。</p>
<p>所以不得不说，官方宣传的“随手拍”很美好，但是实际上并不是想象中那么简单，在他们提供的场景下：</p>
<ul>
<li><strong>录制设备</strong>：Meta 内部的 <strong>Project Aria 眼镜</strong>（智能眼镜）</li>
<li><strong>数据准备</strong>：使用 【Aria MPS 服务】+ 【3D 实例检测】 + 【VLM caption】将眼镜录制的数据转换为上述的 <code>.pkl</code> 格式</li>
</ul>
<blockquote>
<p>这里的 Aria MPS 是闭源的服务，MPS 内部使用的 SLAM（定位与地图构建）、3D 重建、手部追踪等核心算法，暂时只面向 Project Aria Research Kit（ARK）研究合作伙伴开放。</p>
</blockquote>
<p>目前官方已经发布 <strong>ShapeR Evaluation Dataset</strong>，里面每个样本就是推理要用的 <code>.pkl</code>（包含点云、multi-view 图像、相机参数/位姿、caption、GT mesh 等），如果只是想测试，可以下载他们的 evaluation dataset（HuggingFace 上的 <code>facebook/ShapeR-Evaluation</code>，项目页也有 Data 链接），直接跑推理：</p>
<pre><code class="hljs language-css" lang="css">python infer_shape<span class="hljs-selector-class">.py</span> <span class="hljs-attr">--input_pkl</span> &lt;sample<span class="hljs-selector-class">.pkl</span>&gt; <span class="hljs-attr">--config</span> balance <span class="hljs-attr">--output_dir</span> output
</code></pre>
<p><strong>所以，如果你不是合作伙伴，没有 Project Aria 眼镜，那么你只能用它已有的数据集玩玩</strong>，从项目看，大概率这会是一个服务收费的项目。</p>
<p>那我们有没有机会自己玩一下呢？也是有的，ShapeR 特意提供了一个 <code>explore_data.ipynb</code> 来解释这个 pkl 的结构：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0f0024353d7447ca63afbb8c3be2d9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=ZrDPeRznBJSsxNDyivrZWrLmQA0%3D" alt="" loading="lazy"/></p>
<p>只是自己做数据这个过程就相当麻烦了，你需要的路径就会复杂很多，并且也不确定是否可以走的通，我们需要使用 ARKit/ARCore 采集数据（录 RGB 帧 + 时间戳 + IMU + 相机内参，最好还有 VIO/轨迹），比如用 iPhone 的 Stray Scanner 数据采集的 App，它能记录 <strong>video + depth（ LiDAR）+ ARKit 的 VIO（里程计/位姿）</strong> 。</p>
<blockquote>
<p>当然，Stray Scanner 导出的数据格式不能直接支持 ShapeR 要求的输入格式（单一结构化 <code>.pkl</code>），所以需要转为它支持的格式，这个目前需要自己参考项目数据结构去变更，工作量巨大。</p>
</blockquote>
<p>另外，官方也提供了一个叫 <code>MapAnything </code>的“通用、前馈式 metric 3D 重建模型”，可以从输入图像（ShapeR 甚至可以从<strong>单目图像</strong>生成度量三维形状，而无需重新训练）直接回归<strong>带度量尺度的几何和相机信息</strong>，所以也可以作为 ShapeR “替代 MPS 的 metric points 生成器” 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfe2d68bed2c4401a2e758daeaca33c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769493277&amp;x-signature=Bw4EumOYd0pGci5bjt21MMvEPdQ%3D" alt="" loading="lazy"/></p>
<p>所以，一般来说，我们只能期待后续有更完善的转换工具，或者社区第三方的工具支持，这才是真的可以做到随手建模，甚至实时运算的效果，但是这个路线，不管对于智能眼镜，XR 场景还是机器人的导航能力，都是一个非常不错的尝试方向。</p>
<p>最后总结一下，<strong>ShapeR 的核心就是即使数据不全不干净，也可以脑补出完整模型，并且具备精准的尺寸和独立的模型与坐标</strong>。</p>
<p>ShapeR 不是为了替代 Gaussian Splatting 做场景漫游的，它的目标是：当你戴着 AR 眼镜（或拿着手机）扫过房间时，它能把你看到的每一个具体的物体（杯子、椅子、键盘）瞬间变成一个个独立的、有真实尺寸的、完整的 3D 模型，哪怕你只是匆匆扫了一眼。</p>
<p><strong>这就是为什么 Meta 如此重视它，因为这是大概率通往下一代空间计算理解物理世界的关键技术</strong>。</p>
<h2 data-id="heading-3">参考链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebookresearch%2FShapeR" target="_blank" title="https://github.com/facebookresearch/ShapeR" ref="nofollow noopener noreferrer">github.com/facebookres…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零实现企业级 UUID 生成器：兼容性、降级策略与 RFC 4122 标准实践]]></title>    <link>https://juejin.cn/post/7596342523968028681</link>    <guid>https://juejin.cn/post/7596342523968028681</guid>    <pubDate>2026-01-19T03:38:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596342523968028681" data-draft-id="7596698363933966386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零实现企业级 UUID 生成器：兼容性、降级策略与 RFC 4122 标准实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-19T03:38:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="细雨_吟啸且徐行"/> <meta itemprop="url" content="https://juejin.cn/user/3529879274664043"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零实现企业级 UUID 生成器：兼容性、降级策略与 RFC 4122 标准实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3529879274664043/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    细雨_吟啸且徐行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T03:38:46.000Z" title="Mon Jan 19 2026 03:38:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零实现生产级 UUID 生成器：兼容性、降级策略与 RFC 4122 标准实践</h2>
<blockquote>
<p>在现代前端开发中，UUID 生成看似简单，但要实现一个<strong>生产级、高兼容性、符合标准</strong>的 UUID 生成器却并不容易。本文将深入解析一个企业级 UUID 生成器的实现，探讨其三层降级策略、兼容性处理和 RFC 4122 标准实现。</p>
</blockquote>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li><a href="#%E5%89%8D%E8%A8%80" title="#%E5%89%8D%E8%A8%80">前言：为什么需要自己实现 UUID 生成器？</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0" title="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0">核心实现：三层降级策略</a></li>
<li><a href="#%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82" title="#%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82">技术细节深度解析</a></li>
<li><a href="#%E5%85%BC%E5%AE%B9%E6%80%A7%E5%A4%84%E7%90%86" title="#%E5%85%BC%E5%AE%B9%E6%80%A7%E5%A4%84%E7%90%86">兼容性处理的艺术</a></li>
<li><a href="#rfc-4122-%E6%A0%87%E5%87%86" title="#rfc-4122-%E6%A0%87%E5%87%86">RFC 4122 v4 标准实现</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" title="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化与最佳实践</a></li>
<li><a href="#%E6%80%BB%E7%BB%93" title="#%E6%80%BB%E7%BB%93">总结与思考</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">前言：为什么需要自己实现 UUID 生成器？</h3>
<p>在现代浏览器中，我们可以直接使用 <code>crypto.randomUUID()</code> 来生成 UUID。但现实情况是：</p>
<ul>
<li><strong>兼容性问题</strong>：<code>crypto.randomUUID()</code> 需要 Chrome 92+、Safari 15.4+，大量旧版浏览器不支持</li>
<li><strong>企业级需求</strong>：需要支持 IE11、旧版移动浏览器等场景</li>
<li><strong>标准合规</strong>：生成的 UUID 必须符合 RFC 4122 v4 标准</li>
<li><strong>可靠性要求</strong>：即使在高并发、异常环境下也要能正常工作</li>
</ul>
<p>因此，我们需要一个<strong>具备完善降级策略</strong>的 UUID 生成器。</p>
<hr/>
<h3 data-id="heading-3">核心实现：三层降级策略</h3>
<p>我们的 UUID 生成器采用了<strong>三层降级策略</strong>，确保在任何环境下都能正常工作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> generateUUID = (<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 辅助函数：字节转十六进制（兼容 padStart）</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">hex</span>(<span class="hljs-params">buffer, start, end</span>) {
    <span class="hljs-keyword">let</span> str = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = start; i &lt; end; i++) {
      <span class="hljs-keyword">const</span> byte = buffer[i];
      <span class="hljs-keyword">const</span> hexStr = byte.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>);
      <span class="hljs-comment">// 兼容旧浏览器，不使用 padStart</span>
      str += hexStr.<span class="hljs-property">length</span> === <span class="hljs-number">1</span> ? <span class="hljs-string">'0'</span> + hexStr : hexStr;
    }
    <span class="hljs-keyword">return</span> str;
  }

  <span class="hljs-comment">// 兜底方案：基于时间戳和随机数生成 UUID 格式字符串</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">fallbackUUID</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> random1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
    <span class="hljs-keyword">const</span> random2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
    <span class="hljs-keyword">const</span> random3 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
    <span class="hljs-keyword">const</span> random4 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
    
    <span class="hljs-comment">// 格式：xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx (总共36个字符)</span>
    <span class="hljs-comment">// 标准UUID格式：8-4-4-4-12</span>
    <span class="hljs-keyword">return</span> (
      (<span class="hljs-string">'00000000'</span> + (timestamp &amp; <span class="hljs-number">0xffffffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">8</span>) +  <span class="hljs-comment">// 8字符</span>
      <span class="hljs-string">'-'</span> +
      (<span class="hljs-string">'0000'</span> + ((timestamp &gt;&gt; <span class="hljs-number">32</span>) &amp; <span class="hljs-number">0xffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>) +  <span class="hljs-comment">// 4字符</span>
      <span class="hljs-string">'-4'</span> +
      (<span class="hljs-string">'000'</span> + (random1 &amp; <span class="hljs-number">0xfff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">3</span>) +              <span class="hljs-comment">// 3字符，加上'4'共4字符</span>
      <span class="hljs-string">'-'</span> +
      (<span class="hljs-string">'8'</span> + (random2 &amp; <span class="hljs-number">0x3fff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>) +                <span class="hljs-comment">// 4字符</span>
      <span class="hljs-string">'-'</span> +
      (<span class="hljs-string">'00000000'</span> + (random3 &amp; <span class="hljs-number">0xffffffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">8</span>) +     <span class="hljs-comment">// 8字符</span>
      (<span class="hljs-string">'0000'</span> + (random4 &amp; <span class="hljs-number">0xffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>)               <span class="hljs-comment">// 4字符，共12字符</span>
    );
  }

  <span class="hljs-comment">// 优先使用原生实现</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crypto !== <span class="hljs-string">'undefined'</span> &amp;&amp; crypto.<span class="hljs-property">randomUUID</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">randomUUID</span>();
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 如果 crypto.randomUUID 抛出异常，降级到备用方案</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fallbackUUID</span>();
      }
    };
  }

  <span class="hljs-comment">// 降级方案：基于 RFC 4122 v4 的强化实现</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 初始化高质量随机数生成器</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">getRandomValues</span> = (<span class="hljs-params">buffer</span>) =&gt; {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crypto !== <span class="hljs-string">'undefined'</span> &amp;&amp; crypto.<span class="hljs-property">getRandomValues</span>) {
            <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">getRandomValues</span>(buffer);
          }
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-comment">// crypto.getRandomValues 可能抛出异常，继续降级</span>
        }
        
        <span class="hljs-comment">// 终极降级：混合时间戳的 Math.random</span>
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
          <span class="hljs-comment">// 安全获取 performance.now()，如果不存在则使用 0</span>
          <span class="hljs-keyword">const</span> perfNow = (<span class="hljs-keyword">typeof</span> performance !== <span class="hljs-string">'undefined'</span> &amp;&amp; performance.<span class="hljs-property">now</span>) 
            ? performance.<span class="hljs-title function_">now</span>() 
            : <span class="hljs-number">0</span>;
          
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; buffer.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-comment">// 混合时间戳熵增强随机性</span>
            <span class="hljs-keyword">const</span> timeEntropy = (now + perfNow) % <span class="hljs-number">1e9</span> / <span class="hljs-number">1e9</span>;
            buffer[i] = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span> + timeEntropy) % <span class="hljs-number">256</span> | <span class="hljs-number">0</span>;
          }
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-comment">// 如果时间戳方法也失败，使用纯 Math.random</span>
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; buffer.<span class="hljs-property">length</span>; i++) {
            buffer[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">256</span>);
          }
        }
        <span class="hljs-keyword">return</span> buffer;
      };

      <span class="hljs-comment">// 检查 Uint8Array 支持</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Uint8Array</span> === <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fallbackUUID</span>();
      }

      <span class="hljs-comment">// 生成 16 字节随机数据 (128位)</span>
      <span class="hljs-keyword">const</span> rnds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">16</span>);
      <span class="hljs-title function_">getRandomValues</span>(rnds);
      
      <span class="hljs-comment">// 应用 RFC 4122 v4 规则 (设置版本和变体)</span>
      rnds[<span class="hljs-number">6</span>] = (rnds[<span class="hljs-number">6</span>] &amp; <span class="hljs-number">0x0f</span>) | <span class="hljs-number">0x40</span>; <span class="hljs-comment">// 版本 4</span>
      rnds[<span class="hljs-number">8</span>] = (rnds[<span class="hljs-number">8</span>] &amp; <span class="hljs-number">0x3f</span>) | <span class="hljs-number">0x80</span>; <span class="hljs-comment">// 变体 10</span>

      <span class="hljs-comment">// 转换为 UUID 格式字符串</span>
      <span class="hljs-keyword">return</span> (
        <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>) + <span class="hljs-string">'-'</span> +
        <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>) + <span class="hljs-string">'-'</span> +
        <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>) + <span class="hljs-string">'-'</span> +
        <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>) + <span class="hljs-string">'-'</span> +
        <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">10</span>, <span class="hljs-number">16</span>)
      );
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 所有方法都失败时，返回兜底 UUID</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fallbackUUID</span>();
    }
  };
})();
</code></pre>
<h4 data-id="heading-4">降级策略流程图</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────┐
│   crypto<span class="hljs-selector-class">.randomUUID</span>()    │ ← 第一层：现代浏览器（Chrome <span class="hljs-number">92</span>+, Safari <span class="hljs-number">15.4</span>+）
└───────────┬─────────────┘
            │ 失败/不支持
            ▼
┌─────────────────────────┐
│ crypto<span class="hljs-selector-class">.getRandomValues</span>() │ ← 第二层：中等浏览器（IE11+, 大部分现代浏览器）
│   + RFC <span class="hljs-number">4122</span> v4 实现     │
└───────────┬─────────────┘
            │ 失败/不支持
            ▼
┌─────────────────────────┐
│ Math<span class="hljs-selector-class">.random</span>() + 时间戳   │ ← 第三层：兜底方案（任何环境都能工作）
│   + 性能增强             │
└─────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-5">技术细节深度解析</h3>
<h4 data-id="heading-6">1. IIFE 模式：运行时环境检测优化</h4>
<p>使用 <strong>IIFE（立即执行函数表达式）</strong> 模式，在模块加载时只检测一次运行环境，而不是每次调用都检测：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> generateUUID = (<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 这里的代码只在模块加载时执行一次</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crypto !== <span class="hljs-string">'undefined'</span> &amp;&amp; crypto.<span class="hljs-property">randomUUID</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> crypto.<span class="hljs-title function_">randomUUID</span>(); <span class="hljs-comment">// 返回优化后的函数</span>
  }
  <span class="hljs-comment">// ...</span>
})();
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 避免重复的环境检测</li>
<li>✅ 运行时性能最优</li>
<li>✅ 代码更清晰</li>
</ul>
<h4 data-id="heading-7">2. 兼容性处理：手动实现十六进制转换</h4>
<p>现代浏览器可以使用 <code>padStart()</code> 来补零，但为了兼容旧浏览器，我们手动实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hex</span>(<span class="hljs-params">buffer, start, end</span>) {
  <span class="hljs-keyword">let</span> str = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = start; i &lt; end; i++) {
    <span class="hljs-keyword">const</span> byte = buffer[i];
    <span class="hljs-keyword">const</span> hexStr = byte.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>);
    <span class="hljs-comment">// 兼容旧浏览器，不使用 padStart</span>
    str += hexStr.<span class="hljs-property">length</span> === <span class="hljs-number">1</span> ? <span class="hljs-string">'0'</span> + hexStr : hexStr;
  }
  <span class="hljs-keyword">return</span> str;
}
</code></pre>
<p><strong>为什么这样做？</strong></p>
<ul>
<li><code>padStart()</code> 需要 ES2017 支持（IE11 不支持）</li>
<li>手动实现兼容性更好，代码量也很少</li>
</ul>
<h4 data-id="heading-8">3. RFC 4122 v4 标准实现</h4>
<p>UUID v4 要求：</p>
<ul>
<li><strong>版本位</strong>：第 13 个字符必须是 <code>4</code></li>
<li><strong>变体位</strong>：第 17 个字符必须是 <code>8</code>、<code>9</code>、<code>a</code> 或 <code>b</code></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 生成 16 字节随机数据 (128位)</span>
<span class="hljs-keyword">const</span> rnds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">16</span>);
<span class="hljs-title function_">getRandomValues</span>(rnds);

<span class="hljs-comment">// 应用 RFC 4122 v4 规则</span>
rnds[<span class="hljs-number">6</span>] = (rnds[<span class="hljs-number">6</span>] &amp; <span class="hljs-number">0x0f</span>) | <span class="hljs-number">0x40</span>; <span class="hljs-comment">// 版本 4：设置第 7 字节的高 4 位为 0100</span>
rnds[<span class="hljs-number">8</span>] = (rnds[<span class="hljs-number">8</span>] &amp; <span class="hljs-number">0x3f</span>) | <span class="hljs-number">0x80</span>; <span class="hljs-comment">// 变体 10：设置第 9 字节的高 2 位为 10</span>

<span class="hljs-comment">// 转换为 UUID 格式字符串：xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx</span>
<span class="hljs-keyword">return</span> (
  <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>) + <span class="hljs-string">'-'</span> +   <span class="hljs-comment">// 8 字符</span>
  <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>) + <span class="hljs-string">'-'</span> +   <span class="hljs-comment">// 4 字符</span>
  <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>) + <span class="hljs-string">'-'</span> +   <span class="hljs-comment">// 4 字符（包含版本位 4）</span>
  <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>) + <span class="hljs-string">'-'</span> +  <span class="hljs-comment">// 4 字符（包含变体位）</span>
  <span class="hljs-title function_">hex</span>(rnds, <span class="hljs-number">10</span>, <span class="hljs-number">16</span>)         <span class="hljs-comment">// 12 字符</span>
);
</code></pre>
<p><strong>位运算解析</strong>：</p>
<ul>
<li><code>rnds[6] &amp; 0x0f</code>：保留低 4 位</li>
<li><code>| 0x40</code>：设置高 4 位为 <code>0100</code>（版本 4）</li>
<li><code>rnds[8] &amp; 0x3f</code>：保留低 6 位</li>
<li><code>| 0x80</code>：设置高 2 位为 <code>10</code>（变体标识）</li>
</ul>
<hr/>
<h3 data-id="heading-9">兼容性处理的艺术</h3>
<h4 data-id="heading-10">1. 渐进式降级：从最佳到兜底</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getRandomValues</span> = (<span class="hljs-params">buffer</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 优先：使用 Web Crypto API</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crypto !== <span class="hljs-string">'undefined'</span> &amp;&amp; crypto.<span class="hljs-property">getRandomValues</span>) {
      <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">getRandomValues</span>(buffer);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// crypto.getRandomValues 可能抛出异常，继续降级</span>
  }
  
  <span class="hljs-comment">// 降级：混合时间戳增强随机性</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> perfNow = (<span class="hljs-keyword">typeof</span> performance !== <span class="hljs-string">'undefined'</span> &amp;&amp; performance.<span class="hljs-property">now</span>) 
      ? performance.<span class="hljs-title function_">now</span>() 
      : <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; buffer.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 混合时间戳熵增强随机性</span>
      <span class="hljs-keyword">const</span> timeEntropy = (now + perfNow) % <span class="hljs-number">1e9</span> / <span class="hljs-number">1e9</span>;
      buffer[i] = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span> + timeEntropy) % <span class="hljs-number">256</span> | <span class="hljs-number">0</span>;
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 终极降级：纯 Math.random</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; buffer.<span class="hljs-property">length</span>; i++) {
      buffer[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">256</span>);
    }
  }
  <span class="hljs-keyword">return</span> buffer;
};
</code></pre>
<h4 data-id="heading-11">2. 兜底方案：基于时间戳的 UUID</h4>
<p>当所有现代 API 都不可用时，使用时间戳 + 随机数生成 UUID 格式字符串：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fallbackUUID</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">const</span> random1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
  <span class="hljs-keyword">const</span> random2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
  <span class="hljs-keyword">const</span> random3 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
  <span class="hljs-keyword">const</span> random4 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0x100000000</span>);
  
  <span class="hljs-comment">// 格式：xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx</span>
  <span class="hljs-keyword">return</span> (
    (<span class="hljs-string">'00000000'</span> + (timestamp &amp; <span class="hljs-number">0xffffffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">8</span>) +
    <span class="hljs-string">'-'</span> +
    (<span class="hljs-string">'0000'</span> + ((timestamp &gt;&gt; <span class="hljs-number">32</span>) &amp; <span class="hljs-number">0xffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>) +
    <span class="hljs-string">'-4'</span> + <span class="hljs-comment">// 版本位</span>
    (<span class="hljs-string">'000'</span> + (random1 &amp; <span class="hljs-number">0xfff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">3</span>) +
    <span class="hljs-string">'-'</span> +
    (<span class="hljs-string">'8'</span> + (random2 &amp; <span class="hljs-number">0x3fff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>) + <span class="hljs-comment">// 变体位</span>
    <span class="hljs-string">'-'</span> +
    (<span class="hljs-string">'00000000'</span> + (random3 &amp; <span class="hljs-number">0xffffffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">8</span>) +
    (<span class="hljs-string">'0000'</span> + (random4 &amp; <span class="hljs-number">0xffff</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">4</span>)
  );
}
</code></pre>
<p><strong>注意</strong>：虽然这个方案在极端环境下也能工作，但随机性不如 <code>crypto.getRandomValues()</code>，不建议在生产环境长期使用。</p>
<hr/>
<h3 data-id="heading-12">RFC 4122 v4 标准实现</h3>
<h4 data-id="heading-13">UUID 格式说明</h4>
<p>标准 UUID v4 格式：<code>xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx</code></p>
<ul>
<li><strong>x</strong>：十六进制数字（0-9, a-f）</li>
<li><strong>4</strong>：版本号（固定）</li>
<li><strong>y</strong>：变体标识（8, 9, a, b 之一）</li>
</ul>
<h4 data-id="heading-14">版本位和变体位的设置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 字节数组索引对应关系：</span>
<span class="hljs-comment">// [0-3]   [4-5]   [6-7]   [8-9]   [10-15]</span>
<span class="hljs-comment">//  8位     4位     4位     4位      12位</span>

rnds[<span class="hljs-number">6</span>] = (rnds[<span class="hljs-number">6</span>] &amp; <span class="hljs-number">0x0f</span>) | <span class="hljs-number">0x40</span>; 
<span class="hljs-comment">// 第 7 字节：保留低 4 位，设置高 4 位为 0100（版本 4）</span>

rnds[<span class="hljs-number">8</span>] = (rnds[<span class="hljs-number">8</span>] &amp; <span class="hljs-number">0x3f</span>) | <span class="hljs-number">0x80</span>; 
<span class="hljs-comment">// 第 9 字节：保留低 6 位，设置高 2 位为 10（变体标识）</span>
</code></pre>
<p><strong>为什么是 <code>0x40</code> 和 <code>0x80</code>？</strong></p>
<ul>
<li><code>0x40</code> = <code>0100 0000</code>（二进制），设置版本位为 4</li>
<li><code>0x80</code> = <code>1000 0000</code>（二进制），设置变体位为 10</li>
</ul>
<hr/>
<h3 data-id="heading-15">性能优化与最佳实践</h3>
<h4 data-id="heading-16">1. 避免重复检测</h4>
<p>使用 IIFE 模式，在模块加载时检测一次环境，运行时直接调用优化后的函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不好的做法：每次调用都检测</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateUUID</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (crypto.<span class="hljs-property">randomUUID</span>) {
    <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">randomUUID</span>();
  }
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ✅ 好的做法：只检测一次</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> generateUUID = (<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (crypto.<span class="hljs-property">randomUUID</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> crypto.<span class="hljs-title function_">randomUUID</span>(); <span class="hljs-comment">// 返回优化后的函数</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">/* 降级实现 */</span> };
})();
</code></pre>
<h4 data-id="heading-17">2. 错误处理策略</h4>
<p>多层 try-catch 确保即使某个 API 抛出异常，也能降级到下一层：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">randomUUID</span>();
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fallbackUUID</span>(); <span class="hljs-comment">// 降级</span>
}
</code></pre>
<h4 data-id="heading-18">3. 类型检查优化</h4>
<p>使用 <code>typeof</code> 检查而不是直接访问，避免在旧环境中抛出 <code>ReferenceError</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 安全的方式</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> crypto !== <span class="hljs-string">'undefined'</span> &amp;&amp; crypto.<span class="hljs-property">randomUUID</span>) {
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ❌ 不安全的方式（旧浏览器可能报错）</span>
<span class="hljs-keyword">if</span> (crypto.<span class="hljs-property">randomUUID</span>) {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-19">总结与思考</h3>
<h4 data-id="heading-20">核心亮点</h4>
<ol>
<li><strong>三层降级策略</strong>：从现代 API 到兜底方案，确保任何环境都能工作</li>
<li><strong>标准合规</strong>：完全符合 RFC 4122 v4 标准</li>
<li><strong>兼容性优先</strong>：不使用现代 API（如 <code>padStart</code>），手动实现兼容性更好的版本</li>
<li><strong>性能优化</strong>：使用 IIFE 模式，避免重复检测</li>
<li><strong>错误处理</strong>：完善的异常捕获机制</li>
</ol>
<h4 data-id="heading-21">适用场景</h4>
<ul>
<li>✅ 需要支持旧版浏览器的企业级项目</li>
<li>✅ 对 UUID 标准有严格要求的生产环境</li>
<li>✅ 需要高可靠性的分布式系统</li>
<li>✅ 前端 SDK 或工具库开发</li>
</ul>
<h4 data-id="heading-22">进一步优化建议</h4>
<ol>
<li><strong>添加单元测试</strong>：确保各种环境下的正确性</li>
<li><strong>性能基准测试</strong>：对比不同实现的性能</li>
<li><strong>添加 TypeScript 类型定义</strong>：提升开发体验</li>
<li><strong>考虑使用 Web Workers</strong>：在高频调用场景下避免阻塞主线程</li>
</ol>
<h4 data-id="heading-23">写在最后</h4>
<p>实现一个<strong>看似简单</strong>的功能，往往需要考虑到：</p>
<ul>
<li>🔍 <strong>兼容性</strong>：支持各种浏览器环境</li>
<li>🛡️ <strong>可靠性</strong>：完善的错误处理和降级策略</li>
<li>📏 <strong>标准性</strong>：符合行业标准规范</li>
<li>⚡ <strong>性能</strong>：避免不必要的开销</li>
</ul>
<p>这就是<strong>工程化思维</strong>的体现：不仅要实现功能，更要实现<strong>高质量、可维护、可扩展</strong>的代码。</p>
<hr/>
<h3 data-id="heading-24">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc4122" target="_blank" title="https://tools.ietf.org/html/rfc4122" ref="nofollow noopener noreferrer">RFC 4122 - UUID 标准规范</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FCrypto%2FrandomUUID" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Crypto/randomUUID" ref="nofollow noopener noreferrer">MDN - crypto.randomUUID()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FCrypto%2FgetRandomValues" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Crypto/getRandomValues" ref="nofollow noopener noreferrer">MDN - crypto.getRandomValues()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcaniuse.com%2Fmdn-api_crypto_randomuuid" target="_blank" title="https://caniuse.com/mdn-api_crypto_randomuuid" ref="nofollow noopener noreferrer">Can I Use - crypto.randomUUID</a></li>
</ul>
<hr/>
<p><strong>如果这篇文章对你有帮助，欢迎点赞、收藏、转发！</strong> 🚀</p>
<p><strong>关注我，获取更多前端技术深度解析！</strong> 💡</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[图文]手把手教你Antigravity反代，全程不用敲代码，小白也能看懂的保姆教程]]></title>    <link>https://juejin.cn/post/7596768867231760403</link>    <guid>https://juejin.cn/post/7596768867231760403</guid>    <pubDate>2026-01-19T05:43:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596768867231760403" data-draft-id="7596768867231727635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[图文]手把手教你Antigravity反代，全程不用敲代码，小白也能看懂的保姆教程"/> <meta itemprop="keywords" content="程序员,人工智能"/> <meta itemprop="datePublished" content="2026-01-19T05:43:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洪哥等风来"/> <meta itemprop="url" content="https://juejin.cn/user/3562073402390749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [图文]手把手教你Antigravity反代，全程不用敲代码，小白也能看懂的保姆教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073402390749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洪哥等风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T05:43:41.000Z" title="Mon Jan 19 2026 05:43:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>视频版配套教程可以跳转：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1vvitBfEKv" target="_blank" title="https://www.bilibili.com/video/BV1vvitBfEKv" ref="nofollow noopener noreferrer">《手把手教你Antigravity反代，全程不用敲代码，小白也能看懂的保姆教程》</a></p>
<h2 data-id="heading-0">一、安装/升级 反代工具CLIProxyAPI</h2>
<h4 data-id="heading-1">Windows</h4>
<p>直接下载最新的文件，解压后就能使用，如果有更新，也是从这个链接中查找就行。</p>
<p>比如写文章时的最新版为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frouter-for-me%2FCLIProxyAPI%2Freleases%2Fdownload%2Fv6.6.84%2FCLIProxyAPI_6.6.84_windows_amd64.zip" target="_blank" title="https://github.com/router-for-me/CLIProxyAPI/releases/download/v6.6.84/CLIProxyAPI_6.6.84_windows_amd64.zip" ref="nofollow noopener noreferrer">CLIProxyAPI_6.6.84_windows_amd64.zip</a></p>
<pre><code class="hljs language-bash" lang="bash">https://github.com/router-for-me/CLIProxyAPI/releases
</code></pre>
<p>本教程中我解压到了<code>D:\Tools\CLIProxyAPI_6.6.84_windows_amd64</code> 目录下，你可以解压到自己需要的目录，路径要全英文的，并且不能有空格。</p>
<h4 data-id="heading-2">Ubuntu/Linux</h4>
<p>使用一键脚本安装或升级，都用这个命令就行</p>
<pre><code class="hljs language-ruby" lang="ruby">curl -fsSL <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/raw.githubusercontent.com/brokechubb</span><span class="hljs-regexp">/cliproxyapi-installer/refs</span><span class="hljs-regexp">/heads/master</span><span class="hljs-regexp">/cliproxyapi-installer | bash
</span></code></pre>
<h4 data-id="heading-3">MacOS</h4>
<p>使用brew安装命令</p>
<pre><code class="hljs">brew install cliproxyapi
</code></pre>
<p>后续升级命令</p>
<pre><code class="hljs">brew upgrade cliproxyapi
</code></pre>
<h2 data-id="heading-4">二、修改配置文件，启用后台管理</h2>
<h4 data-id="heading-5">Windows</h4>
<p>安装目录下把<code>config.example.yaml</code>复制一份，复制的改名为<code>config.yaml</code>，然后修改里面的内容。</p>
<h4 data-id="heading-6">Ubuntu/Linux</h4>
<p>家(Home)目录下找<code>cliproxyapi/config.yaml</code>，即<code>~/cliproxyapi/config.yaml</code>，然后修改里面的内容。</p>
<h4 data-id="heading-7">MacOS</h4>
<p><code>/opt/homebrew/etc</code>目录下找<code>cliproxyapi.conf</code>，即绝对路径为：<code>/opt/homebrew/etc/cliproxyapi.conf</code>，然后修改里面的内容。</p>
<h4 data-id="heading-8">修改文件如下内容(登录密码最好改成你自己的，我这里设置的是my-password)</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">allow-remote: <span class="hljs-literal">true</span>
secret-<span class="hljs-keyword">key</span>: <span class="hljs-string">"my-password"</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/171f47b3de934915afe0f80d0ea5c1af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=DGOsCTQfNAuK1We7%2FphReonJsdk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-9">三、 启动CLIProxyAPI， 并登录网页后台查看：</h2>
<h4 data-id="heading-10">Windows</h4>
<p>进入到刚才解压后的目录下直接exe执行就可以了，比如我刚才安装到了<code>D:\Tools\CLIProxyAPI_6.6.84_windows_amd64</code> 下。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6352f72f4d794adf8a72680cd87f254a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=PhJUBfn%2B%2FAaNS2e0%2FFQzNp0QxKc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-11">Ubuntu/Linux</h4>
<p>进入到<code>~/cliproxyapi/</code>目录后，启动。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ~/cliproxyapi/
./cli-proxy-api 
</code></pre>
<h4 data-id="heading-12">MacOS</h4>
<p>不需要进入任何目录，直接启动即可。</p>
<pre><code class="hljs">brew services restart cliproxyapi
</code></pre>
<h4 data-id="heading-13">登录网页后台</h4>
<p>注意地址，本机的直接访问右边这个地址就行，首次登录密码是刚才设置的 my-password ：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8317%2Fmanagement.html" target="_blank" title="http://localhost:8317/management.html" ref="nofollow noopener noreferrer">http://localhost:8317/management.html</a>
服务器的话要填服务器的地址或域名，比如你部署到了服务器的ip是<code>1.2.3.4</code>，则访问：<code>http://1.2.3.4:8317/management.html</code>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2368c977d9ec48cfad976acb8ac36745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=YMFqu1rwLrS%2BjFv%2BhjXItqrKCvo%3D" alt="在这里插入图片描述" loading="lazy"/>
登录后台成功后，可以看到仪表盘。建议把使用统计打开，这样后面用模型我能能看到用了多少的Tokens。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cbbd7aa6769415786f449309109f0fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=HXFvhPNOaQ6Dco4zeUpaeg9W%2BDQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-14">四、从网页登录Antigravity，成功后拷贝网址:</h2>
<p>按照图示登录Antigravity，并等待自动认证成功，认证成功后登录网页会自动关闭。
如果登录界面没有自动关闭(如图)，需要你手动把登录成功的网址复制粘贴回来，然后手动点击<code>提交回调URL</code>。
如果还登录不上，可以尝试重启机器，然后别的软件先别开，这时打开反代服务 + 开启TUN魔法 + 挂到美国IP，再登录下试试。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a17cb14eb97a43f5934f29b6b5bbfeee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=uBv7cl1CLA6jzehTJES5SuOS2qY%3D" alt="在这里插入图片描述" loading="lazy"/>
你还可以登录Gemini CLI ，这样就有更多的Gemini额度了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c214da7e5757472fac911141e01037d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=zVra4LgibS%2FCj66JF69fQL10Qm4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>登录认证成功后，后台就能看到认证信息了。我这里即反代了Antigravity，也反代了Gemini CLI, 如图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74532cfa2b6944ef97e05a2c48537d0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=OBPVBkXlbW%2BjKx0bl8%2Fmf6Lm9WY%3D" alt="在这里插入图片描述" loading="lazy"/>
反代出来的模型，可以在<code>中心信息</code>中查看到。后面使用模型时，需要来这里复制模型名，不能随便写模型名。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/000fe28e26a942408f0a328fdee3978b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=Uo%2Fq60k10bt2KrzpV35Z9PfPR4A%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-15">五、Claude Code中使用</h2>
<h4 data-id="heading-16">从网页后台获取api key，配置claude</h4>
<p>注意<code>your-api-key-1</code>要配置成网页后台中的真正的api key，我这里演示的是默认的。
模型的名称也要从网页后台拷贝，不要自己手写。
base url 填写为 <code>"http://localhost:8317"</code>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90e6d33b083946459e7c6f517664bce7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769406221&amp;x-signature=KWK2W1L0l%2BH3QG8beNCAY%2FmuiOo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"ANTHROPIC_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:8317"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_AUTH_TOKEN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-api-key-1"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_DEFAULT_OPUS_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-claude-opus-4-5-thinking"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_DEFAULT_SONNET_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-claude-sonnet-4-5-thinking"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_DEFAULT_HAIKU_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-claude-sonnet-4-5"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-claude-opus-4-5-thinking"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ANTHROPIC_SMALL_FAST_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-claude-sonnet-4-5-thinking"</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<h2 data-id="heading-17">六、其它OpenAI兼容接口中使用</h2>
<p>注意！base url 要改为： <code>http://localhost:8317/v1</code>
api key 和模型名和刚才一样，从网页后台复制就行了。
vscode中可以通过<code>oai</code>插件(<code>OAI Compatible Provider for Copilot</code>)来添加到copilot中。</p>
<h2 data-id="heading-18">Q&amp;A</h2>
<h3 data-id="heading-19">Q1：有没有被封号的风险？</h3>
<p>我在各个社区中还没看到有被封的(仅针对个人用户)。不过仍不建议用自己的大号搞，因为确实逆向了有风险，建议用小号搞吧。</p>
<h3 data-id="heading-20">Q2：需要Google AI会员吗?</h3>
<p>免费版的每周都有额度，但是额度很少，可以先试一下，把流程跑通了。付费会员或教育优惠会员，都是每5小时刷新额度，自己用一般是足够的，并且Gemin Pro\Gemini Flash\Claude这三组额度是独立的。
然后可以考虑某鱼上买个成品号，关键字:<code>geminipro一年</code>，20左右(不知道最近涨价没)。</p>
<h3 data-id="heading-21">Q3：我高强度使用，5小时额度不够怎么办啊？</h3>
<p>最快速的是把谷歌的Gemini CLI工具也反代了，这个工具中只有Gemini系列的模型，并且额度和Antigravity中的不互通，是独立的。</p>
<p>其次有个被社区称为<code>升天</code>的方法：其实就是家庭组，Pro账号可以邀请最多5个人进入家庭(算上自己共6人)。家庭里每个账号的Antigravity和Gemini CLI的额度是独立的，所以可以创建几个小号，来组建家庭后把小号也反代了。</p>
<p>最后，还是那句话，不建议用自己的主号这么搞，最好拿某鱼买的号来搞。</p>
<h3 data-id="heading-22">Q4：API KEY(API 密钥)是怎么生成的，从哪里拿？</h3>
<p>API KEY在我们安装时，配置文件中会默认携带2个，你可以从网页上直接编辑-复制后使用。也可以在网页上把这两个KEY修改掉，或者自己新建后使用。</p>
<h3 data-id="heading-23">Q5：OAI插件是什么？</h3>
<p>OAI插件是搭配vscode copilot使用的，因为官方的copilot不支持自定义的模型和地址，所以需要这个插件来实现。</p>
<h3 data-id="heading-24">Q6：OAI安装后没有右下角的 Ready显示怎么办？</h3>
<p>首次安装后可以按 <code>Ctrl</code> + <code>Shift</code> + <code>P</code>，然后输入<code>oai</code>关键字，点击<code>Open Configuration UI</code>进入。</p>
<h3 data-id="heading-25">Q7：OAI配置好了地址和模型，从copilot中访问失败怎么办？</h3>
<p>大概率是地址配置错误，记得OpenAI格式的请求都需要加上<code>/v1</code>后缀，比如<code>http://10.126.12.162:8317/v1</code>。</p>
<h3 data-id="heading-26">Q8: Windows上第二天就不能用了，访问不到模型了？</h3>
<p>可能是关机了，或CLIProxyAPI被关掉了，然后反代的登录信息就失效了，下次开机或启动后，还需要重新登陆以下。
如果是在服务器上部署的，并且一直执行，是不会失效的，因为CLIProxyAPI会周期性的去刷新下登录信息，保持一直登陆的状态。</p>
<h3 data-id="heading-27">Q9: 能用Nano Banana Pro画图吗？</h3>
<p>可以的，接入自己的画图工具就行了。有限额，但具体多少我不太清楚了。
比如群友有使用CherryStudio的：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cherry-ai.com%2Fdownload" target="_blank" title="https://www.cherry-ai.com/download" ref="nofollow noopener noreferrer">www.cherry-ai.com/download</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Huobao Drama 开源短剧生成平台：从剧本到视频]]></title>    <link>https://juejin.cn/post/7596790037097201727</link>    <guid>https://juejin.cn/post/7596790037097201727</guid>    <pubDate>2026-01-19T03:32:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596790037097201727" data-draft-id="7596639774266834986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Huobao Drama 开源短剧生成平台：从剧本到视频"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-19T03:32:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ahubbub"/> <meta itemprop="url" content="https://juejin.cn/user/2999123451061160"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Huobao Drama 开源短剧生成平台：从剧本到视频
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123451061160/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ahubbub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T03:32:03.000Z" title="Mon Jan 19 2026 03:32:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Huobao Drama 开源短剧生成平台：从剧本到视频</h2>
<h2 data-id="heading-1">Huobao Drama</h2>
<p>一句话简介：一个基于 Go + Vue3 的全栈 AI 短剧自动化生产平台，覆盖“剧本解析 → 角色/分镜生成 → 视频合成”的一站式流程。</p>
<p>适用场景（可选）：</p>
<ul>
<li>想快速验证“短剧生成工作流”的产品/技术原型（偏全链路演示）</li>
<li>需要一个可自建的 AI 素材/分镜/视频任务管理后台（本地存储 + SQLite）</li>
<li>自己有模型/聚合 API（OpenAI 兼容/火山/本地 Ollama 等），希望接到可用的 Web 界面里跑通</li>
</ul>
<h2 data-id="heading-2">二、开源协议</h2>
<ul>
<li>CC BY-NC-SA 4.0（署名-非商业性使用-相同方式共享），以仓库 <code>LICENSE</code> 为准</li>
<li>备注：该协议限制商业用途；如需商业使用，README/许可证中给了作者联系方式（以仓库信息为准）</li>
</ul>
<h2 data-id="heading-3">三、界面展示</h2>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img4@main/2026/01/19/1768792890091-d6d4508e-d9cc-456c-88ff-87c5792660c3.png" alt="主界面" loading="lazy"/></p>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img2@main/2026/01/19/1768792987694-530000b6-2996-4819-a4f4-990f9a8b0b27.png" alt="项目界面" loading="lazy"/></p>
<h2 data-id="heading-4">四、功能概述</h2>
<h3 data-id="heading-5">1）角色管理</h3>
<ul>
<li>是什么：对短剧角色形象进行生成与管理</li>
<li>怎么做：
<ul>
<li>支持 AI 生成角色形象</li>
<li>支持批量生成</li>
<li>支持角色图片上传与管理</li>
</ul>
</li>
<li>注意事项（可选）：
<ul>
<li>图片生成依赖外部 AI 服务（默认 Provider 在配置中可选，但具体 Key 一般在 Web 界面配置；以仓库文档为准）</li>
<li>生成图片的存储默认走本地存储目录（见 <code>configs/config.yaml</code> 的 <code>storage</code>）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">2）分镜制作（脚本/镜头/图片）</h3>
<ul>
<li>是什么：从剧本/描述拆解出分镜，并为分镜生成图片</li>
<li>怎么做：
<ul>
<li>自动生成分镜脚本</li>
<li>场景描述与镜头设计</li>
<li>分镜图片生成（文生图）</li>
<li>帧类型选择：首帧/关键帧/尾帧/分镜板</li>
</ul>
</li>
<li>注意事项（可选）：
<ul>
<li>仍然依赖外部文生图服务；如果你用的是本地模型，需确认接口是否 OpenAI 兼容，并保证容器/宿主机网络可达（见 <code>DOCKER_HOST_ACCESS.md</code>）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">3）视频生成（图生视频 + 合成剪辑）</h3>
<ul>
<li>是什么：把分镜图转成分镜视频，并进行合成/转场</li>
<li>怎么做：
<ul>
<li>图生视频自动生成</li>
<li>视频合成与剪辑</li>
<li>转场效果</li>
</ul>
</li>
<li>外部依赖必须说明：
<ul>
<li>FFmpeg：项目明确要求 <code>FFmpeg 4.0+</code>，用于视频处理（本地跑需要自己安装；Docker 镜像里已安装 <code>ffmpeg</code>，见 <code>Dockerfile</code>）</li>
<li>视频生成模型/服务：配置中的 <code>ai.default_video_provider</code> 默认为 <code>doubao</code>（火山相关能力），具体调用方式与 Key 配置以仓库实现/界面为准</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">4）资源管理与任务追踪</h3>
<ul>
<li>是什么：统一管理生成的素材，并跟踪任务进度</li>
<li>怎么做：
<ul>
<li>素材库统一管理</li>
<li>本地存储支持</li>
<li>资源导入导出</li>
<li>任务进度追踪</li>
</ul>
</li>
<li>注意事项（可选）：
<ul>
<li>数据库存储默认使用 SQLite（见 <code>configs/config.example.yaml</code>）</li>
<li>静态资源访问基于 <code>storage.base_url</code> 拼接（默认 <code>http://localhost:5678/static</code>），反代/换域名时要一起调整</li>
</ul>
</li>
</ul>
<h2 data-id="heading-9">五、技术选型</h2>
<ul>
<li>后端：<code>Go 1.23+ · Gin · GORM · SQLite(含 modernc.org/sqlite) · Zap · Viper</code></li>
<li>前端：<code>Vue 3.4+ · TypeScript · Vite 5 · Element Plus · TailwindCSS · Pinia · Vue Router · vue-i18n · Axios</code></li>
<li>数据：<code>SQLite</code>（默认），配置里也出现 <code>gorm.io/driver/mysql</code> 依赖（是否启用 MySQL 以代码/文档为准）</li>
<li>可观测/日志：<code>Zap</code>（仓库依赖显示）</li>
<li>容器化：<code>Docker 多阶段构建（Node 20 + Go 1.23-alpine + alpine runtime） · docker-compose</code></li>
<li>媒体处理：<code>FFmpeg</code>（必需）</li>
</ul>
<h2 data-id="heading-10">六、如何使用</h2>
<blockquote>
<p>运行前准备（所有方式通用）</p>
</blockquote>
<ul>
<li>如果你本机手动运行（非 Docker）：先安装 <code>ffmpeg</code>，并确保 <code>ffmpeg -version</code> 可用</li>
<li>AI 能力需要配置供应商与 Key：配置文件里仅指定默认 provider，具体 API Key 通常在 Web 界面里配置（以实际界面/仓库文档为准）</li>
<li>默认端口：
<ul>
<li>后端/API：<code>5678</code></li>
<li>前端开发服务器：<code>3012</code>（仅开发模式，见 <code>web/vite.config.ts</code>）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11">方式一：Docker</h3>
<p>仓库 README 给了两种 Docker 跑法：Docker Hub 直接跑，或本地构建后跑。这里按 README 原样整理可复制命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 直接运行（Docker Hub）</span>
docker run -d \
  --name huobao-drama \
  -p 5678:5678 \
  -v $(<span class="hljs-built_in">pwd</span>)/data:/app/data \
  --restart unless-stopped \
  huobao/huobao-drama:latest
</code></pre>
<ul>
<li>数据目录与挂载路径：
<ul>
<li>宿主机：<code>$(pwd)/data</code></li>
<li>容器内：<code>/app/data</code>（SQLite DB + storage 都在这下面，具体以运行后生成内容为准）</li>
</ul>
</li>
<li>访问：
<ul>
<li><code>http://localhost:5678</code></li>
</ul>
</li>
<li>重要说明（Linux）：
<ul>
<li>如果容器内要访问宿主机的 Ollama/本地模型，需加：<code>--add-host=host.docker.internal:host-gateway</code>（详见 <code>DOCKER_HOST_ACCESS.md</code>）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12">方式二：Docker Compose（推荐）</h3>
<p>项目自带 <code>docker-compose.yml</code>（包含 healthcheck、命名卷、extra_hosts），最省事：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动</span>
docker-compose up -d

<span class="hljs-comment"># 看日志</span>
docker-compose logs -f

<span class="hljs-comment"># 停止</span>
docker-compose down
</code></pre>
<ul>
<li>默认端口：<code>5678:5678</code></li>
<li>数据持久化：使用命名卷 <code>huobao-data:/app/data</code>（见 <code>docker-compose.yml</code>）</li>
<li>自定义配置文件：
<ul>
<li>compose 里预留了挂载（默认注释掉）：<code>./configs/config.yaml:/app/configs/config.yaml:ro</code></li>
<li>你需要先准备 <code>configs/config.yaml</code>（可从示例复制）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">方式三：手动构建（前端/后端）</h3>
<h4 data-id="heading-14">1）拉代码 + 准备配置</h4>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/chatfire-AI/huobao-drama.git
<span class="hljs-built_in">cd</span> huobao-drama

<span class="hljs-built_in">cp</span> configs/config.example.yaml configs/config.yaml
</code></pre>
<p><code>configs/config.yaml</code> 关键项（示例来自仓库，敏感信息不在这里）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">5678</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"0.0.0.0"</span>
  <span class="hljs-attr">cors_origins:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"http://localhost:3012"</span>

<span class="hljs-attr">database:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"sqlite"</span>
  <span class="hljs-attr">path:</span> <span class="hljs-string">"./data/drama_generator.db"</span>

<span class="hljs-attr">storage:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"local"</span>
  <span class="hljs-attr">local_path:</span> <span class="hljs-string">"./data/storage"</span>
  <span class="hljs-attr">base_url:</span> <span class="hljs-string">"http://localhost:5678/static"</span>

<span class="hljs-attr">ai:</span>
  <span class="hljs-attr">default_text_provider:</span> <span class="hljs-string">"openai"</span>
  <span class="hljs-attr">default_image_provider:</span> <span class="hljs-string">"openai"</span>
  <span class="hljs-attr">default_video_provider:</span> <span class="hljs-string">"doubao"</span>
</code></pre>
<h4 data-id="heading-15">2）开发模式（前后端分离，热更新）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 终端 1：后端</span>
go mod download
go run main.go
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 终端 2：前端</span>
<span class="hljs-built_in">cd</span> web
npm install
npm run dev
</code></pre>
<ul>
<li>前端：<code>http://localhost:3012</code></li>
<li>后端：<code>http://localhost:5678</code></li>
<li>代理规则：前端会把 <code>/api</code> 转发到 <code>http://localhost:5678</code>（见 <code>web/vite.config.ts</code>）</li>
</ul>
<h4 data-id="heading-16">3）单服务模式（后端同时提供前端静态文件）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> web
npm install
npm run build
<span class="hljs-built_in">cd</span> ..

go run main.go
</code></pre>
<ul>
<li>访问：<code>http://localhost:5678</code></li>
</ul>
<h2 data-id="heading-17">七、二次开发注意事项</h2>
<ul>
<li>环境依赖版本（从仓库文件推断）：
<ul>
<li>Go：<code>1.23+</code>（见 <code>go.mod</code>）</li>
<li>Node.js：README 写 <code>18+</code>；<code>Dockerfile</code> 使用 <code>node:20-alpine</code>（本地用 18/20 通常都可，最终以你依赖安装结果为准）</li>
<li>FFmpeg：<code>4.0+</code>（必需）</li>
</ul>
</li>
<li>本地开发启动方式：
<ul>
<li>后端：<code>go run main.go</code></li>
<li>前端：<code>npm run dev</code>（默认 <code>3012</code>），并代理 <code>/api -&gt; 5678</code></li>
</ul>
</li>
<li>常见问题
<ul>
<li>SQLite 只读/写权限：生产机用 systemd 部署时，确保运行用户对 <code>data/</code> 目录与 DB 文件都有写权限；否则可能出现 <code>attempt to write a readonly database</code>（README 给了排查与修复命令）</li>
<li>Docker 访问宿主机模型：统一用 <code>http://host.docker.internal:&lt;port&gt;/v1</code>，Linux 下需要 <code>host-gateway</code> 映射（见 <code>DOCKER_HOST_ACCESS.md</code> 与 <code>docker-compose.yml</code> 的 <code>extra_hosts</code>）</li>
<li>跨域/前端连不上后端：检查 <code>configs/config.yaml</code> 的 <code>server.cors_origins</code> 是否包含你的前端地址；开发模式代理在 <code>web/vite.config.ts</code></li>
</ul>
</li>
</ul>
<h2 data-id="heading-18">八、目录结构与主要文件</h2>
<pre><code class="hljs language-text" lang="text">huobao-drama/
├── main.go                    # 后端入口
├── go.mod                     # Go 依赖与版本（Go 1.23）
├── Dockerfile                 # 多阶段构建（前端 build + 后端 build + runtime 含 ffmpeg）
├── docker-compose.yml         # Compose 一键启动（含 healthcheck/volume/extra_hosts）
├── configs/
│   └── config.example.yaml    # 配置示例（复制为 config.yaml 使用）
├── api/                       # API 层（Gin HTTP，按 README 的分层说明）
├── application/               # 应用服务层（业务编排）
├── domain/                    # 领域层（模型/领域逻辑）
├── infrastructure/            # 基础设施层（DB/外部服务等）
├── migrations/                # 迁移相关（README 说明首次启动会自动建表）
├── pkg/                       # 通用包/工具代码
└── web/                       # 前端（Vue3 + Vite）
    ├── package.json           # 前端依赖与脚本
    └── vite.config.ts         # dev server(3012) + /api 代理到 5678
</code></pre>
<h2 data-id="heading-19">九、源码地址</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchatfire-AI%2Fhuobao-drama" target="_blank" title="https://github.com/chatfire-AI/huobao-drama" ref="nofollow noopener noreferrer">github.com/chatfire-AI…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 又迎大坑修改？iOS 26 键盘变化可能带来大量底层改动]]></title>    <link>https://juejin.cn/post/7596245612558319625</link>    <guid>https://juejin.cn/post/7596245612558319625</guid>    <pubDate>2026-01-18T23:21:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596245612558319625" data-draft-id="7596181746083217458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 又迎大坑修改？iOS 26 键盘变化可能带来大量底层改动"/> <meta itemprop="keywords" content="Flutter,Android,前端"/> <meta itemprop="datePublished" content="2026-01-18T23:21:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 又迎大坑修改？iOS 26 键盘变化可能带来大量底层改动
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-18T23:21:16.000Z" title="Sun Jan 18 2026 23:21:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>又是一个小问题可能带来的大改动，感觉官方在评估的时候，有点过分细节了。</p>
<p>这个问题来自去年底的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F179482" target="_blank" title="https://github.com/flutter/flutter/issues/179482" ref="nofollow noopener noreferrer">#179482</a> issue ，Flutter 在 iOS 26 上，某些场景会因为出现半透明键盘，而页面底下本来应该被键盘遮挡的 Widget，由于默认没有被绘制，从而出现键盘背景颜色 UI 异常：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/960cf9e2a42f407dac6a4eb5aafe6af4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=tRkOay%2Fo%2BALX8RVRE3sgp2I%2F%2FXM%3D" alt="" loading="lazy"/></p>
<p>虽然问题看起来是一个圆角问题，但是实际上这是 <strong>iOS 26 系统键盘增加了“半透明”后带来的问题，Flutter 在键盘后面那一层在某些场景下没有正确渲染内容</strong>，导致键盘半透明区域透出来的不是底下 BottomSheet 的真实内容，而是一整块黑色区域。</p>
<blockquote>
<p>issue 提到问题，问题最明显的场景主要出现在 iOS 26 的 <code>showModalBottomSheet()</code> 下。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69a144886c414be3b6e47305a8eb2acd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=D13kmUfKTbIaHLDDcKlqxIe5nXY%3D" alt="" loading="lazy"/></p>
<p>为什么会这样？首先就是你的 App 目前是否使用了最新 Xcode 26 ，以及在 <code>Info.plist</code> 里有没有使用 <code>UIDesignRequiresCompatibility = YES</code> 让 App <strong>继续使用旧的系统设计风格</strong> ：</p>









<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d228c8699cf84bb7a40ff83d84e7d548~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=qA5pgOEtDcAkTEiihO8DTVksfMs%3D" alt="8b13916c1c0c6339201a1a9f3e797b2e" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77ea0a6de3c74a58a4eebc509e328332~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=BLnidBWTHY2VKPJ3kDfQnTPmRJ4%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55ea18421a364e35b2dfb93338160e34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=rrzTcCREi89B%2F%2FLdsGeVaGADK90%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56450582bb204f08887af218bc556a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=dZkfJVjFgJuQ8cPCDJ9lDt9rnAU%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>通过上面前两张图我们可以看到，iOS 26 正常情况下，系统键盘其实是会出现半透明效果并且具备圆角，虽然透明效果不是特别明显，但是对比后两张图里，可以看到微信和淘宝还是保留着原本的 iOS 18 的直角效果。</p>
<blockquote>
<p>如果还是保留原本风格，其实并不会遇到这个问题。</p>
</blockquote>
<p><strong>所以这个 issue 首先是需要在 Xcode 26 下，并且没有关闭 Liquid Glass 适配的情况下才会遇到</strong>，当然，就算是 iOS 26 场景，一般情况下也不会有什么大问题，比如下图直接在界面内使用一个 <code>TextField</code> ，其实并不会有明显问题：</p>







<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dc21612af4240d792024f59e73534fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=ZczUpzI2%2F4yzJxo7DkHRXWaRdLw%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ebc5e2b57044e39b7a5c0358a303dbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=aT7%2Fhqerqj%2FB%2BOCOg%2BfZbNhCiWM%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>问题还是主要出现在类似 <code>showModalBottomSheet</code> 的场景，特别是在背景色透明的时候，虽然我们设置了 <code>backgroundColor: Colors.transparent</code> ，<strong>但是在 Flutter 里，某些时候 UI 并不会“在键盘背后继续画”</strong> ，因为在 iOS 26 之前，Flutter（以及很多跨平台框架）都默认：</p>
<blockquote>
<p><strong>系统键盘 = 完全不透明的遮挡物</strong>，所以 Flutter 的 pipeline 会认为键盘区域背后不需要特殊关注。</p>
</blockquote>







<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18616ed0571f43e7bbc53eac69fde608~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=RSAJeipogB69tt4c2w2XPajWu8c%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0cf32020255458f9b4da867f2d3ea05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=P1LvlwLkchu2HRQk3wpGKNPbTA0%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>实际上类似同样的问题，在 RN 里也是存在，甚至对于 CMP 来说也是存在不一样的问题，所以对于 CMP 来说，才会有 <a href="https://juejin.cn/post/7594863660280496147" target="_blank" title="https://juejin.cn/post/7594863660280496147">1.10 Interop views 新特性 Overlay </a>，用于支持 UIKit 的半透明/blur 可以采样到 Skia 的内容的实验性 API ：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be381af627b044068bca9e81d400132d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=YwDwvtgqLyR2YtSryfsbcVnjHS8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9faa62b4480d4184bf03025906f70b1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=w7sBOdkCPbhguDnuslJt8UcB72A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3131730714474d318e3b6c550948efac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=dKBLX9k4AepYwBhEf%2BPUrJam3MY%3D" alt="" loading="lazy"/></p>
<p><strong>所以这个问题实际上的本质不是圆角</strong>，比如我把 <code>showModalBottomSheet</code> 背景改成红色，此时你可以看到键盘是可以采集到背景色的，甚至我把 <code>Container</code> 也改成红色，你也看不出来异常：</p>







<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e1f833111e2401cab0380dd3f811a70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=6wRGZG8BkYY%2FZZ%2BOF5ljf%2BLdBvg%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d460ae0c2bb841579d3917c03855cce4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=bNYm2ONTVFM2Zait%2F5P2P14v2o4%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p><strong>所以问题更多出现在透明色上</strong>，随着 <code>showModalBottomSheet</code> 弹出并带有透明色的时候，由于 Flutter 认为被键盘这挡住的下层 Widget 并不需要绘制，所以导致系统键盘采集不到对应的像素点，从而出现了一开始的黑色背景。</p>
<p>所以其实这个 Bug 如果想临时解决，只需要在 <code>Info.plist</code> 里配置 <code>UIDesignRequiresCompatibility = YES</code> 就可以了，只是此时 App UI 会是 iOS 18 的风格：</p>







<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f4baaf1f0c4451da02bf7dbb4b5a8d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=YgKhzcxCFx8gvExY5AN9MhXse08%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d23e4a28d914858ba80b485a8f84345~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=2jBsVD1XGRDa5aMtDaeaxGKF2qM%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>如果再对比抖音和 Github App ，就可以看到 iOS 26 新键盘风格对于整体应用的风格影响还是挺大的，所以不少 App 目前会选择通过关闭适配拖延时间。</p>







<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8960ebb99a104882930870eb0fcf45a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=7AA5kH6iN%2FlkIojKaU4Zy5EpJAE%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97a572ed7869455495d4bf665f42a773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=VzEuqPTXpH9eXu7qZH88fSR1zG8%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>那为什么会说，这个 Bug 会导致整个底层生态的重构？<strong>因为 iOS 26 改变了“系统键盘会完全遮挡 App 内容”这一长期不变的底层假设</strong>，而 Flutter 的渲染 / 布局 / Insets / 事件系统，几乎全都建立在旧假设之上，这套逻辑几乎渗透在：</p>
<ul>
<li><code>RenderObject</code> 的 <code>layout</code></li>
<li><code>Scaffold</code> / <code>BottomSheet</code> / <code>Navigator</code></li>
<li><code>MediaQuery</code></li>
<li><code>TextInputPlugin</code></li>
<li>Engine 中的 view hierarchy</li>
<li>···</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62cbb41513d24b9dabf73ec4acd1f25f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=K6pyjNg8LraIRnLVWOWzzrxIQyM%3D" alt="" loading="lazy"/></p>
<p>也就是如果想完全适配这个新场景（多层嵌套下还提供键盘场景的透明支持），一旦需要完全支持“键盘下内容需要绘制”，就要系统性重构多个核心层，例如</p>
<p>：</p>
<h4 data-id="heading-0">Framework 层（Dart）</h4>
<ul>
<li>
<p><code>MediaQuery.viewInsets</code></p>
<ul>
<li>现在代表“不可见区域”</li>
<li>未来要不要拆成多个：<code>coveredInsets</code> 、<code>obscuredInsets</code> 、<code>visualInsets</code></li>
</ul>
</li>
<li>
<p>Scaffold / BottomSheet</p>
<ul>
<li>是否仍然自动 resize？</li>
<li>还是只做布局、不做裁剪？</li>
</ul>
</li>
<li>
<p>Clip 行为</p>
<ul>
<li>现在大量 widget 默认不 clip</li>
</ul>
</li>
</ul>
<h4 data-id="heading-1">Engine 层（iOS embedder）</h4>
<ul>
<li>
<p>FlutterView / UIView hierarchy</p>
</li>
<li>
<p>CALayer 合成顺序</p>
</li>
<li>
<p>系统 keyboard window vs Flutter window</p>
</li>
<li>
<p>是否需要：</p>
<ul>
<li>在被遮挡区域继续 raster</li>
<li>或改变 backing store 策略</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2">输入系统 &amp; Hit Test</h4>
<ul>
<li>
<p>键盘下的 widget：</p>
<ul>
<li>画出来了</li>
<li>但不能响应触摸</li>
</ul>
</li>
<li>
<p>Flutter 目前的 hit-test 假设：</p>
<ul>
<li>“看得见 = 可点”</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">插件 &amp; 三方生态</h4>
<ul>
<li>
<p>各种：</p>
<ul>
<li>bottom sheet 插件</li>
<li>keyboard avoiding 插件</li>
<li>聊天 UI</li>
</ul>
</li>
<li>
<p>各种涉及“手搓” viewInsets 的场景</p>
</li>
</ul>
<p><strong>所以这个“语义场景”如果发生比变化，那么涉及的将是大量底层改动，甚至一些性能指标都会需要调整，从长远来看，这还会是一个 iOS 平台特有的差异化适配场景，并且引入大量 bread change</strong>。</p>
<h2 data-id="heading-4">最后</h2>
<p>最后总结下，<strong>正常大家使用输入框输入文本内容不会有什么问题</strong>，甚至如果你用 Dialog 场景也不会有什么问题，甚至你看下方最后一张图片，在 dialog 下的键盘依然可以正常透视工作：</p>








<table><thead><tr><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fef0d4e649f4c47b6f6468f3459bb65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=hosWMv7q%2Bh11e2iDmmU0s29C3Pw%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84aa4bb724704c11a5d1ae4d0d3e756d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=F8HbVJ2rHQcJ2szaECmfdca3qFk%3D" alt="" loading="lazy"/></th><th><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1541015615bd4d74a0422ce80d396b00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=tYfeB7HDMenshvpeLNRL6sd82f4%3D" alt="" loading="lazy"/></th></tr></thead></table>
<p>所以问题主要还是存在于 <code>BottomSheet</code> 这种场景，因为 <code>BottomSheet</code> 默认行为是认为底部对齐，高度有限，所以对于 <code>BottomSheet</code> 会认为底部高度区域在键盘下不渲染，所以导致最后采集不到像素出现黑色。</p>
<p><strong>针对问题其实可以选择配置 <code>UIDesignRequiresCompatibility = YES</code> 来解决，或者替换为 Dialog 来绕过场景</strong>，但是如果要等官方修复这个场景，可能会需要等待评估是否真的有必要大规模底层改动。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0500f298cdf24bb19b88afb7dc876a1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769383275&amp;x-signature=tTi4RnJsW0Np0X5mNPeIlRXt5Y8%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>从我的角度看，这完全没必要，毕竟真这么修改，带来的就是生态的大量 break change。</p>
</blockquote>
<h2 data-id="heading-5">参考链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F179482" target="_blank" title="https://github.com/flutter/flutter/issues/179482" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从0开发大模型之实现Agent（Bash 到 SKILL）]]></title>    <link>https://juejin.cn/post/7596478936387108906</link>    <guid>https://juejin.cn/post/7596478936387108906</guid>    <pubDate>2026-01-19T01:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596478936387108906" data-draft-id="7596583214597799955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从0开发大模型之实现Agent（Bash 到 SKILL）"/> <meta itemprop="keywords" content="AIGC,Agent"/> <meta itemprop="datePublished" content="2026-01-19T01:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="周末程序猿"/> <meta itemprop="url" content="https://juejin.cn/user/3245414056989757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从0开发大模型之实现Agent（Bash 到 SKILL）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414056989757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    周末程序猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T01:15:04.000Z" title="Mon Jan 19 2026 01:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>从《learn-claude-code》受到启发，于是参考源代码写了这篇文章：如何实现从0开始构建Agent？</p>
<h2 data-id="heading-0">1. 前提</h2>
<h3 data-id="heading-1">1.1 <code>AI Agent</code> 构成</h3>
<ul>
<li>模型：为智能体的推理和决策提供动力的LLM，决定了智能体的下限。</li>
<li>工具：智能体可用于采取行动的外部函数或API。</li>
<li>指令：定义智能体行为的明确指导方针和安全策略。</li>
</ul>
<p>三者构成了 <code>AI Agent</code> 的下限和上限，模型越强，对于指令和工具的调度能力更准确，但是从工程学的角度来考虑，较弱的模型通过对工具和指令的结合，一样能制造功能强大的 <code>Agent</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12286f8d23a14c38b82124d9b07bd04c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=gUoYcWwmYUGcRmAMo3p4w%2Bb0XWQ%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 <code>Tool Calling</code></h3>
<p>由于 <code>Anthropic Tool Calling</code> 协议现在大部分模型已经支持，并且非常成熟，所以本文默认都通过传入 <code>TOOLS</code> 来让大模型调用的工具，样例如下：</p>
<pre><code class="hljs language-bash" lang="bash">{
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"my_function_name"</span>, <span class="hljs-comment"># The name of the function</span>
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"The description of my function"</span>, <span class="hljs-comment"># Describe the function so Claude knows when and how to use it.</span>
    <span class="hljs-string">"input_schema"</span>: { <span class="hljs-comment"># input schema describes the format and the type of parameters Claude needs to generate to use the function</span>
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>, <span class="hljs-comment"># format of the generated Claude response</span>
        <span class="hljs-string">"properties"</span>: { <span class="hljs-comment"># properties defines the input parameters of the function</span>
            <span class="hljs-string">"query"</span>: { <span class="hljs-comment"># the function expects a query parameter</span>
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"The search query to perform."</span>, <span class="hljs-comment"># describes the parameter to Claude</span>
            },
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"query"</span>], <span class="hljs-comment"># define which parameters are required</span>
    },
}
</code></pre>
<p><strong>给模型传入 <code>TOOLS</code> 参数，LLM API 返回如下：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool_use"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"toolu_01A09q90qw90lq917835123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my_function_name"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Latest developments in quantum computing"</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">1.3 简单的 v0:Shell 到复杂 v4:Skills</h3>
<p>前面提到 <code>AI Agent</code> 构成包括工具和指令，那么从最简的工具开始，到最后复杂的指令，<code>Agent</code> 的核心原理：<code>感知 -&gt; 认知 -&gt; 执行 -&gt; 反馈 -&gt; 感知 ...</code>，然后循环执行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fab5c05059340eeb16b8de339c92ee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=GjgWZLcpsrreZ%2F3vgQWbAcpKAuc%3D" alt="图片" loading="lazy"/></p>
<p>基于这个核心原理，我们从最简的 Shell 构建，规划如下：</p>
<ul>
<li>v0: Shell 是基础的工具</li>
<li>v1: 模型即代理</li>
<li>v2: 结构化规划与 Todo</li>
<li>v3: 子代理</li>
<li>v4: Skills</li>
</ul>
<h2 data-id="heading-4">2. v0: Shell 是基础的工具</h2>
<p>Shell 在计算机是最常用的，所有的操作系统中都有类似 Bash 脚本的功能，那么基于脚本定义一系列工具如下：</p>





















<table><thead><tr><th>工具</th><th>对应 Bash 命令示例</th></tr></thead><tbody><tr><td>读文件</td><td><code>cat file.txt</code>, <code>head -n 20 file.py</code>, <code>grep "TODO" -n -r .</code></td></tr><tr><td>写文件</td><td><code>echo '...' &gt; file</code>, <code>cat &lt;&lt; 'EOF' &gt; main.py</code></td></tr><tr><td>搜索/导航</td><td><code>find . -name "*.py"</code>, <code>ls -R</code>, <code>rg "keyword" .</code></td></tr></tbody></table>
<h3 data-id="heading-5">2.1 架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/801c7b436d394dfb9ac81f115bf43380~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=aBscv%2BlTLTBO7p1WrdhZz%2FePAGs%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>逻辑核心只有一个循环：<strong>模型 → 工具调用 → 工具结果 → 模型</strong></li>
<li>不额外引入 Task/Plan/Registry 等抽象，全部由「自然语言 + Bash + 递归」实现</li>
</ul>
<p><strong>不足：</strong></p>
<ul>
<li>工程化的安全边界（如路径沙盒、命令白名单）</li>
<li>更丰富的可观测性（结构化日志、任务树可视化）</li>
<li>人类语义层面的「角色」区分（计划者/执行者/审阅者）</li>
</ul>
<p>在这个极简版本中，我们遵循的架构设计，只保留<strong>最小完成闭环</strong>所需的要素。</p>
<p><strong>一个工具就够了</strong><br/>
Bash 本身就是工具的「元工具」：其他一切工具都可以通过 Bash 间接调用（curl、git、python、docker 等）。</p>
<p><strong>递归 = 层级结构</strong><br/>
无需实现复杂的 Task/Plan 抽象；只要允许「调用自己」，层级结构自然涌现。</p>
<p><strong>进程 = 上下文隔离</strong><br/>
不需要额外的「会话 ID」或「上下文容器」：操作系统的进程模型天然提供隔离。</p>
<p><strong>提示词 = 行为约束</strong><br/>
系统提示词定义了当前 Agent 的「角色 + 责任边界」，决定了它如何使用 Bash 能力。</p>
<p><strong>核心循环</strong></p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-built_in">response</span> = model(messages, tools)
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">response</span>.stop_reason != <span class="hljs-string">"tool_use"</span>:
        return <span class="hljs-built_in">response</span>.text
    results = <span class="hljs-keyword">execute</span>(<span class="hljs-built_in">response</span>.tool_calls)
    messages.append(results)
</code></pre>
<h3 data-id="heading-6">2.2 完整代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">from</span> llm_factory <span class="hljs-keyword">import</span> LLMFactory, LLMChatAdapter
<span class="hljs-keyword">from</span> util.mylog <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> run_bash, BASH_TOOLS

<span class="hljs-comment"># 初始化 API 客户端</span>
<span class="hljs-comment"># 使用 LLMFactory 创建 LLM 实例</span>
llm = LLMFactory.create(
    model_type=<span class="hljs-string">"openai"</span>,
    model_name=<span class="hljs-string">"deepseek-v3.2"</span>, <span class="hljs-comment"># 使用支持的模型</span>
    temperature=<span class="hljs-number">0.0</span>,
    max_tokens=<span class="hljs-number">8192</span>
)
client = LLMChatAdapter(llm)

<span class="hljs-comment"># 系统提示词</span>
SYSTEM = <span class="hljs-string">f"""你是一个位于 <span class="hljs-subst">{os.getcwd()}</span> 的 CLI 代理，系统为 <span class="hljs-subst">{sys.platform}</span>。使用 bash 命令解决问题。

## 规则：
- 优先使用工具而不是文字描述。先行动，后简要解释。
- 读取文件：cat, grep, find, rg, ls, head, tail
- 写入文件：echo '...' &gt; file, sed -i, 或 cat &lt;&lt; 'EOF' &gt; file
- 避免危险操作，如 rm -rf等删除或者清理文件, 或格式化挂载点，或对系统文件进行写操作

## 要求
- 不使用其他工具，仅使用 bash 命令或者 shell 脚本
- 子代理可以通过生成 shell 代码执行
- 如果当前任务超过 bash 的处理范围，则终止不处理
"""</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_bash_commands</span>(<span class="hljs-params">text</span>):
    <span class="hljs-string">"""从 LLM 响应中提取 bash 命令"""</span>
    <span class="hljs-keyword">import</span> re
    pattern = <span class="hljs-string">r'```bash\n(.*?)\n```'</span>
    matches = re.findall(pattern, text, re.DOTALL)
    <span class="hljs-keyword">return</span> [cmd.strip() <span class="hljs-keyword">for</span> cmd <span class="hljs-keyword">in</span> matches <span class="hljs-keyword">if</span> cmd.strip()]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">prompt, history=<span class="hljs-literal">None</span>, max_steps=<span class="hljs-number">10</span></span>):
    <span class="hljs-keyword">if</span> history isNone:
        history = []
    
    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    has_system = <span class="hljs-built_in">any</span>(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history)
    ifnot has_system:
         <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
         history.insert(<span class="hljs-number">0</span>, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM})

    history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt})

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        <span class="hljs-comment"># 1. 调用模型（传递 tools 参数）</span>
        <span class="hljs-comment"># 使用 chat_with_tools 接口，支持 function calling</span>
        response = client.chat_with_tools(
            prompt=prompt,
            messages=history,
            tools=BASH_TOOLS
        )
        <span class="hljs-keyword">if</span> step == <span class="hljs-number">1</span>:
            prompt = <span class="hljs-string">'继续'</span>

        <span class="hljs-comment"># 2. 解析响应内容</span>
        assistant_text = []
        tool_calls = []
        
        logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步响应: <span class="hljs-subst">{response}</span>"</span>)

        <span class="hljs-comment"># chat_with_tools 返回的是 Response 对象，包含 content 列表</span>
        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">getattr</span>(block, <span class="hljs-string">"type"</span>, <span class="hljs-string">""</span>) == <span class="hljs-string">"text"</span>:
                assistant_text.append(block.text)
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">getattr</span>(block, <span class="hljs-string">"type"</span>, <span class="hljs-string">""</span>) == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        <span class="hljs-comment"># 记录助手文本回复</span>
        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        <span class="hljs-keyword">if</span> full_text:
            logger.info(<span class="hljs-string">f"助手: <span class="hljs-subst">{full_text}</span>"</span>)
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        <span class="hljs-keyword">elif</span> tool_calls:
            <span class="hljs-comment"># 如果只有工具调用没有文本，添加一个占位文本到历史，保持对话连贯</span>
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"(Executing tools...)"</span>})
        
        <span class="hljs-comment"># 3. 如果没有工具调用，直接返回内容</span>
        ifnot tool_calls:
            logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">if</span> response.stop_reason == <span class="hljs-string">"end_turn"</span>:
                <span class="hljs-keyword">return</span> full_text
            <span class="hljs-comment"># 如果异常结束，也返回</span>
            <span class="hljs-keyword">return</span> full_text o<span class="hljs-string">r"(No response)"</span>

        <span class="hljs-comment"># 4. 执行工具</span>
        logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步工具调用: <span class="hljs-subst">{tool_calls}</span>"</span>)
        all_outputs = []
        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            <span class="hljs-keyword">if</span> tc.name == <span class="hljs-string">"bash"</span>:
                cmd = tc.<span class="hljs-built_in">input</span>.get(<span class="hljs-string">"command"</span>)
                <span class="hljs-keyword">if</span> cmd:
                    logger.info(<span class="hljs-string">f"[使用工具] <span class="hljs-subst">{cmd}</span>"</span>)  <span class="hljs-comment"># 黄色显示命令</span>
                    output = run_bash(cmd)
                    all_outputs.append(<span class="hljs-string">f"$ <span class="hljs-subst">{cmd}</span>\n<span class="hljs-subst">{output}</span>"</span>)
                    <span class="hljs-comment"># 如果输出太长则截断打印</span>
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">200</span>:
                        logger.info(<span class="hljs-string">f"输出: <span class="hljs-subst">{output[:<span class="hljs-number">200</span>]}</span>... (已截断)"</span>)
                    <span class="hljs-keyword">else</span>:
                        logger.info(<span class="hljs-string">f"输出: <span class="hljs-subst">{output}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                logger.warning(<span class="hljs-string">f"Unknown tool: <span class="hljs-subst">{tc.name}</span>"</span>)
        
        <span class="hljs-comment"># 5. 将命令执行结果添加到历史记录中</span>
        <span class="hljs-keyword">if</span> all_outputs:
            combined_output = <span class="hljs-string">"\n"</span>.join(all_outputs)
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理。"</span>})
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 有工具调用但没产生输出（可能是解析失败或空命令）</span>
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Error: Tool call failed or produced no output."</span>})

    <span class="hljs-keyword">return</span><span class="hljs-string">"达到最大执行步数限制，停止执行。"</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:
        logger.info(chat(sys.argv[<span class="hljs-number">1</span>]))
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 交互模式</span>
        logger.info(<span class="hljs-string">"Bash 代理已启动。输入 'exit' 退出。"</span>)
        history = []
        whileTrue:
            <span class="hljs-keyword">try</span>:
                user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"&gt; "</span>)
                <span class="hljs-keyword">if</span> user_input.lower() <span class="hljs-keyword">in</span> [<span class="hljs-string">'exit'</span>, <span class="hljs-string">'quit'</span>]:
                    <span class="hljs-keyword">break</span>
                chat(user_input, history)
            <span class="hljs-keyword">except</span> KeyboardInterrupt:
                logger.info(<span class="hljs-string">"\n正在退出..."</span>)
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logger.info(<span class="hljs-string">f"\n错误: <span class="hljs-subst">{e}</span>"</span>)
                traceback.print_exc()
</code></pre>
<h2 data-id="heading-7">3.1 v1: 模型即代理</h2>
<p><code>Agent</code> 的核心就是自主决策，只需要人工给定目标+约束规则，让大模型自主决策怎么调用工具，怎么遵循规则，这样才能做到通用性。</p>
<p><strong>传统助手模式：</strong></p>
<pre><code class="hljs language-rust" lang="rust">用户 <span class="hljs-punctuation">-&gt;</span> 模型 <span class="hljs-punctuation">-&gt;</span> 文本回复
</code></pre>
<p><strong><code>Agent</code> 系统模式：</strong></p>
<pre><code class="hljs language-rust" lang="rust">用户 <span class="hljs-punctuation">-&gt;</span> 模型 <span class="hljs-punctuation">-&gt;</span> [工具 <span class="hljs-punctuation">-&gt;</span> 结果]* <span class="hljs-punctuation">-&gt;</span> 回复
                     ^_________|
</code></pre>
<p><code>*</code> 模型<strong>可以反复</strong>调用工具，直到它认为任务完成为止，把「聊天机器人」升级为「自主代理」。</p>
<p>Claude Code 之类系统可能挂了 <code>10～20</code> 个工具，但对于一个「本地代码助手」，<strong>4 个就够覆盖 80–90% 的场景</strong>：</p>






























<table><thead><tr><th>工具</th><th>用途</th><th>示例能力</th></tr></thead><tbody><tr><td><code>bash</code></td><td>运行命令</td><td><code>npm install</code>, <code>git status</code>, <code>pytest</code>, <code>ls</code></td></tr><tr><td><code>read_file</code></td><td>读取文件内容</td><td>查看 <code>src/index.ts</code> 的具体实现</td></tr><tr><td><code>write_file</code></td><td>创建/覆盖文件</td><td>创建 <code>README.md</code>、生成新模块</td></tr><tr><td><code>edit_file</code></td><td>精确修改片段</td><td>在一个函数内插入日志、重构一个方法</td></tr></tbody></table>
<p>有了这 4 个工具，模型就是可以完成如下事情：</p>
<ul>
<li><strong>探索代码库</strong>：<code>bash: find, ls, tree, rg/grep</code></li>
<li><strong>理解代码</strong>：<code>read_file</code> 查看具体文件内容</li>
<li><strong>做出修改</strong>：</li>
<li>
<ul>
<li>新建/完全重写：<code>write_file</code></li>
<li>小范围精修：<code>edit_file</code></li>
</ul>
</li>
<li><strong>运行和验证</strong>：<code>bash: python, npm test, make, pytest, go test ...</code></li>
</ul>
<h3 data-id="heading-8">3.2 架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0d38fb337f142c48c7316f333d2ad99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=Ipa7RBS10wM4C4%2Bl%2BnBnVtoEnZ8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>模型是决策者：何时调用工具、调用哪些工具、以什么顺序、何时停止，都由模型决定。</li>
<li>代码只做两件事：</li>
<li>
<ol>
<li>提供一组工具（带清晰的输入 schema 和语义）</li>
<li>驱动「模型 → 工具 → 结果 → 模型」的循环</li>
</ol>
</li>
</ul>
<p><code>agent_loop</code> 正是 v1 的核心：</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-built_in">response</span> = model(messages, tools)

    # 打印文本输出
    <span class="hljs-keyword">if</span> no tool_use:
        return

    results = <span class="hljs-keyword">execute</span>(<span class="hljs-built_in">response</span>.tool_calls)
    messages.append(<span class="hljs-built_in">response</span>)
    messages.append(results)
</code></pre>
<p><strong>模型控制循环</strong><br/>
只要 <code>stop_reason == "tool_use"</code>，说明模型还在「思考 + 操作」，没准备给出最终答案。<br/>
一旦 <code>stop_reason != "tool_use"</code>，模型就认为任务完成，返回最终文本。</p>
<p><strong>工具结果成为上下文</strong><br/>
工具执行结果以 <code>"user"</code> 消息的形式追加回对话，模型下次调用时就能「看到」自己刚刚操作的结果。</p>
<p><strong>记忆自动累积</strong><br/>
所有对话内容、工具调用、结果都放在 <code>messages</code> 里，模型自然拥有整个任务的上下文。</p>
<p><strong>代码逻辑极薄</strong><br/>
你几乎看不到复杂状态机、计划器、子任务调度器——这些都交给模型的「思考 + 工具调用策略」来涌现。</p>
<h3 data-id="heading-9">3.3 为什么这样设计?</h3>
<p><strong>1. 简单</strong></p>
<ul>
<li>没有显式状态机</li>
<li>没有 planner/parser 模块</li>
<li>没有自定义框架</li>
</ul>
<p>只有：<code>messages</code>、<code>tools</code>、<code>while True</code>。</p>
<p><strong>2. 模型负责思考</strong></p>
<ul>
<li>哪个工具：bash / read / write / edit？</li>
<li>什么顺序：先看文件？先找入口？再修改？再跑测试？</li>
<li>何时停止：任务是否已经完成？</li>
</ul>
<p>全都交给模型，用自然语言和工具 schema 引导，而不是手动写死流程。</p>
<p><strong>3. 透明可观测</strong></p>
<ul>
<li>每个工具调用都显式出现在 <code>messages</code> 中 (<code>tool_use</code> + <code>tool_result</code>)</li>
<li>你可以把 <code>messages</code> 持久化，恢复整个过程、调试行为</li>
</ul>
<p><strong>4. 可扩展性强</strong></p>
<p>添加新工具的成本非常低：</p>
<ol>
<li>实现一个 Python 函数（例如 <code>tool_http_request</code>）。</li>
<li>在 <code>TOOLS</code> 列表中增加一个带 JSON schema 的条目。</li>
<li>在 <code>execute_tool</code> 中分发到对应函数。</li>
</ol>
<p>无需改 Agent 循环，循环 <code>Agent</code> 核心调度方式。</p>
<h3 data-id="heading-10">3.4 完整代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">from</span> llm_factory <span class="hljs-keyword">import</span> LLMFactory, LLMChatAdapter
<span class="hljs-keyword">from</span> util.mylog <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> execute_base_tools, BASIC_TOOLS

<span class="hljs-comment"># 初始化 API 客户端</span>
<span class="hljs-comment"># 使用 LLMFactory 创建 LLM 实例</span>
llm = LLMFactory.create(
    model_type=<span class="hljs-string">"openai"</span>,
    model_name=<span class="hljs-string">"deepseek-v3.2"</span>, <span class="hljs-comment"># 使用支持的模型</span>
    temperature=<span class="hljs-number">0.0</span>,
    max_tokens=<span class="hljs-number">8192</span>
)
client = LLMChatAdapter(llm)
WORKDIR = Path.cwd()

SYSTEM = <span class="hljs-string">f"""你是一个位于 <span class="hljs-subst">{WORKDIR}</span> 的编码代理，系统为 <span class="hljs-subst">{sys.platform}</span>。

## 执行流程
简要思考 -&gt; 使用工具（使用 TOOLS） -&gt; 报告结果。

## 规则
- 优先使用工具而不是文字描述。先行动，不要只是解释。  
- 永远不要臆造文件路径。如果不确定，先使用 bash ls/find 确认。  
- 做最小的修改。不要过度设计。  
- 完成后，总结变更内容。  

## 要求：
- 循环尽量简单，不要复杂。  
"""</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, args: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    result = execute_base_tools(name, args)
    <span class="hljs-keyword">if</span> result isnotNone:
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span><span class="hljs-string">f"Unknown tool: <span class="hljs-subst">{name}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_loop</span>(<span class="hljs-params">prompt, history=<span class="hljs-literal">None</span>, max_steps=<span class="hljs-number">10</span></span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-keyword">if</span> history isNone:
        history = []
    
    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    has_system = <span class="hljs-built_in">any</span>(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history)
    ifnot has_system:
        <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
        history.insert(<span class="hljs-number">0</span>, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM})

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        response = client.chat_with_tools(
            prompt=prompt,
            messages=history,
            tools=BASIC_TOOLS,
        )

        assistant_text = []
        tool_calls = []
        
        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">getattr</span>(block, <span class="hljs-string">"type"</span>, <span class="hljs-string">""</span>) == <span class="hljs-string">"text"</span>:
                assistant_text.append(block.text)
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">getattr</span>(block, <span class="hljs-string">"type"</span>, <span class="hljs-string">""</span>) == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)
        
        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
            logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">return</span> history

        results = []
        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            logger.info(<span class="hljs-string">f"\n&gt; [使用工具] <span class="hljs-subst">{tc.name}</span> 第 <span class="hljs-subst">{step}</span> 步调用工具: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>"</span>)
            output = execute_tool(tc.name, tc.<span class="hljs-built_in">input</span>)
            preview = output[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">200</span><span class="hljs-keyword">else</span> output
            logger.info(<span class="hljs-string">f"  [使用工具] <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{preview}</span>"</span>)
            results.append(<span class="hljs-string">f"工具 <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{output}</span>"</span>)

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        combined_output = <span class="hljs-string">"\n"</span>.join(results)
        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理"</span>})

    logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步达到最大执行步数限制，停止执行。"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    logger.info(<span class="hljs-string">f"Mini Claude Code v1 - <span class="hljs-subst">{WORKDIR}</span>"</span>)
    logger.info(<span class="hljs-string">"Type 'exit' to quit.\n"</span>)

    history = []
    whileTrue:
        <span class="hljs-keyword">try</span>:
            user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"You: "</span>).strip()
        <span class="hljs-keyword">except</span> (EOFError, KeyboardInterrupt):
            <span class="hljs-keyword">break</span>

        ifnot user_input <span class="hljs-keyword">or</span> user_input.lower() <span class="hljs-keyword">in</span> (<span class="hljs-string">"exit"</span>, <span class="hljs-string">"quit"</span>, <span class="hljs-string">"q"</span>):
            <span class="hljs-keyword">break</span>

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_input})
        <span class="hljs-keyword">try</span>:
            agent_loop(<span class="hljs-string">''</span>, history, max_steps=<span class="hljs-number">10</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>)
            traceback.print_exc()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-11">4 v2: 结构化规划与 Todo</h2>
<p>v1 已经能正常工作，但在复杂任务上，它容易<strong>失去方向</strong>：</p>
<ul>
<li>在不同子任务之间来回跳转</li>
<li>很难记住已经做了什么、未做什么</li>
<li>难以向用户呈现清晰的进度</li>
</ul>
<p>v2 我们只需要做一个 Plan：<strong>Todo 工具</strong>（增加少量状态管理与提示逻辑），就能实现 "计划（使用 TodoWrite） -&gt; 使用工具行动（使用 TOOLS）"。</p>
<p>在 v1 的工具列表基础上，v2 新增 <code>TodoManager</code> 管理和 <code>TodoWrite</code> 工具。</p>
<h3 data-id="heading-12">4.1 TodoManager：带约束的任务列表</h3>
<p>核心是一个带约束的列表管理器：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoManager</span>:
    <span class="hljs-string">"""
    管理具有强制约束的结构化任务列表。

    关键设计决策：
    --------------------
    1. 最多 20 项：防止模型创建无尽的列表
    2. 一个进行中：强制专注 - 一次只能做一件事
    3. 必填字段：每个项目需要 content, status 和 activeForm

    activeForm 字段值得解释：
    - 它是正在发生的事情的现在时形式
    - 当 status 为 "in_progress" 时显示
    - 示例：content="Add tests", activeForm="Adding unit tests..."

    这提供了代理正在做什么的实时可见性。
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.items = []

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, items: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        验证并更新任务列表。

        模型每次发送一个完整的列表。我们验证它，
        存储它，并返回一个模型将看到的渲染视图。

        验证规则：
        - 每个项目必须有：content, status, activeForm
        - Status 必须是：pending | in_progress | completed
        - 一次只能有 ONE 个项目处于 in_progress 状态
        - 最多允许 20 个项目

        Returns:
            任务列表的渲染文本视图
        """</span>
        validated = []
        in_progress_count = <span class="hljs-number">0</span>

        <span class="hljs-keyword">for</span> i, item <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(items):
            <span class="hljs-comment"># Extract and validate fields</span>
            content = <span class="hljs-built_in">str</span>(item.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)).strip()
            status = <span class="hljs-built_in">str</span>(item.get(<span class="hljs-string">"status"</span>, <span class="hljs-string">"pending"</span>)).lower()
            active_form = <span class="hljs-built_in">str</span>(item.get(<span class="hljs-string">"activeForm"</span>, <span class="hljs-string">""</span>)).strip()

            <span class="hljs-comment"># Validation checks</span>
            ifnot content:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Item <span class="hljs-subst">{i}</span>: content required"</span>)
            <span class="hljs-keyword">if</span> status notin (<span class="hljs-string">"pending"</span>, <span class="hljs-string">"in_progress"</span>, <span class="hljs-string">"completed"</span>):
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Item <span class="hljs-subst">{i}</span>: invalid status '<span class="hljs-subst">{status}</span>'"</span>)
            ifnot active_form:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Item <span class="hljs-subst">{i}</span>: activeForm required"</span>)

            <span class="hljs-keyword">if</span> status == <span class="hljs-string">"in_progress"</span>:
                in_progress_count += <span class="hljs-number">1</span>

            validated.append({
                <span class="hljs-string">"content"</span>: content,
                <span class="hljs-string">"status"</span>: status,
                <span class="hljs-string">"activeForm"</span>: active_form
            })

        <span class="hljs-comment"># Enforce constraints</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(validated) &gt; <span class="hljs-number">20</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Max 20 todos allowed"</span>)
        <span class="hljs-keyword">if</span> in_progress_count &gt; <span class="hljs-number">1</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Only one task can be in_progress at a time"</span>)

        self.items = validated
        <span class="hljs-keyword">return</span> self.render()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        将任务列表渲染为人类可读的文本。

        格式：
            [x] 已完成任务
            [&gt;] 进行中任务 &lt;- 正在做某事...
            [ ] 待办任务

            (2/3 completed)

        这个渲染后的文本是模型作为工具结果看到的内容。
        然后它可以根据当前状态更新列表。
        """</span>
        ifnot self.items:
            <span class="hljs-keyword">return</span><span class="hljs-string">"No todos."</span>

        lines = []
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.items:
            <span class="hljs-keyword">if</span> item[<span class="hljs-string">"status"</span>] == <span class="hljs-string">"completed"</span>:
                lines.append(<span class="hljs-string">f"[x] <span class="hljs-subst">{item[<span class="hljs-string">'content'</span>]}</span>"</span>)
            <span class="hljs-keyword">elif</span> item[<span class="hljs-string">"status"</span>] == <span class="hljs-string">"in_progress"</span>:
                lines.append(<span class="hljs-string">f"[&gt;] <span class="hljs-subst">{item[<span class="hljs-string">'content'</span>]}</span> &lt;- <span class="hljs-subst">{item[<span class="hljs-string">'activeForm'</span>]}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                lines.append(<span class="hljs-string">f"[ ] <span class="hljs-subst">{item[<span class="hljs-string">'content'</span>]}</span>"</span>)

        completed = <span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> self.items <span class="hljs-keyword">if</span> t[<span class="hljs-string">"status"</span>] == <span class="hljs-string">"completed"</span>)
        lines.append(<span class="hljs-string">f"\n(<span class="hljs-subst">{completed}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.items)}</span> completed)"</span>)

        <span class="hljs-keyword">return</span><span class="hljs-string">"\n"</span>.join(lines)
</code></pre>
<p>这里的约束是有意设计的「规则」：</p>

































<table><thead><tr><th>规则</th><th>原因</th></tr></thead><tbody><tr><td>最多 20 条</td><td>防止模型把 todo 当成无限备忘录</td></tr><tr><td>必须有 <code>content</code></td><td>保证每条任务有明确描述</td></tr><tr><td>必须有 <code>status</code></td><td>让任务进度可追踪</td></tr><tr><td>必须有 <code>activeForm</code></td><td>帮助描述“当前正在做的具体动作”</td></tr><tr><td>只能一个 <code>in_progress</code></td><td>强制模型一次只专注一个任务</td></tr><tr><td>内容不能重复</td><td>防止模型无意义地复制条目</td></tr></tbody></table>
<p>这些约束<strong>同时限制了行为空间，又增强了可控性和可观察性</strong>。</p>
<h3 data-id="heading-13">4.2 Todo 工具的执行与反馈</h3>
<p>在 Agent 端的实现中：</p>
<pre><code class="hljs language-python" lang="python">todo_manager = TodoManager()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">name, args</span>):
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"TodoWrite"</span>:
        <span class="hljs-keyword">try</span>:
            todo_manager.update(args[<span class="hljs-string">"items"</span>])
            <span class="hljs-comment"># 返回给模型看的文本形式，模型可以据此继续思考和更新</span>
            <span class="hljs-keyword">return</span> todo_manager.summary_text()
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"[TodoWrite error] <span class="hljs-subst">{e}</span>"</span>

    <span class="hljs-comment"># 其他工具: bash / read_file / write_file / edit_file...</span>
    ...
</code></pre>
<p>以一次调用为例：</p>
<p><strong>模型调用 <code>TodoWrite</code> 输入：</strong></p>
<pre><code class="hljs language-css" lang="css">{
    "items": [
        {
            "<span class="hljs-attribute">content</span>": <span class="hljs-string">"重构认证模块"</span>,
            <span class="hljs-string">"status"</span>: <span class="hljs-string">"completed"</span>,
            <span class="hljs-string">"activeForm"</span>: <span class="hljs-string">"重构已完成"</span>
        },
        {
            "<span class="hljs-attribute">content</span>": <span class="hljs-string">"添加单元测试"</span>,
            <span class="hljs-string">"status"</span>: <span class="hljs-string">"in_progress"</span>,
            <span class="hljs-string">"activeForm"</span>: <span class="hljs-string">"正在为认证模块编写单元测试"</span>
        },
        {
            "<span class="hljs-attribute">content</span>": <span class="hljs-string">"更新文档"</span>,
            <span class="hljs-string">"status"</span>: <span class="hljs-string">"pending"</span>,
            <span class="hljs-string">"activeForm"</span>: <span class="hljs-string">"准备在完成测试后更新文档"</span>
        }
    ]
}
</code></pre>
<p><strong>工具返回给模型的文本（作为 <code>tool_result</code>）：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[x]</span> 重构认证模块  (重构已完成)
<span class="hljs-selector-attr">[&gt;]</span> 添加单元测试  (正在为认证模块编写单元测试)
<span class="hljs-selector-attr">[ ]</span> 更新文档      (准备在完成测试后更新文档)
(<span class="hljs-number">1</span>/<span class="hljs-number">3</span> 已完成)
</code></pre>
<p>模型在下一轮调用时，就能「看到自己刚刚整理的计划」，并基于这个结构化状态决定接下来要做什么。</p>
<h3 data-id="heading-14">4.3 系统提示词：软约束鼓励使用 Todo</h3>
<p>Todo 的使用不是强制性的，而是通过 <strong>软提醒</strong> 进行引导：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">INITIAL_REMINDER</span> = <span class="hljs-string">"&lt;reminder&gt;对于多步骤任务，请使用 TodoWrite 工具创建和维护一个清晰的 todo 列表。&lt;/reminder&gt;"</span>
<span class="hljs-attr">NAG_REMINDER</span> = <span class="hljs-string">"&lt;reminder&gt;已经超过 10 轮未更新 todo，请检查是否需要补充或更新 TodoWrite。&lt;/reminder&gt;"</span>
</code></pre>
<ul>
<li>在对话的合适位置，注入一段额外文本（通常作为 system 或额外的 user 内容），让模型意识到应该使用 Todo 工具。</li>
<li>这些提醒<strong>不是一个单独工具调用</strong>，也<strong>不需要模型回复</strong>，只是一个“背景提示”。</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-css" lang="css">while True:
    ...

    if first_message:
        content.<span class="hljs-built_in">append</span>(INITIAL_REMINDER)
        first_message = False
    elif rounds_without_todo &gt; max_steps:
        content.<span class="hljs-built_in">append</span>(NAG_REMINDER)

    content.<span class="hljs-built_in">append</span>(f<span class="hljs-string">"输入：{user_input}"</span>)
    history.<span class="hljs-built_in">append</span>({"role": <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n"</span>.<span class="hljs-built_in">join</span>(content)})

    try:
        <span class="hljs-built_in">agent_loop</span>(<span class="hljs-string">''</span>, history, max_steps=max_steps)
    except Exception as e:
        logger.<span class="hljs-built_in">error</span>(f<span class="hljs-string">"Error: {e}"</span>)
        traceback.<span class="hljs-built_in">print_exc</span>()
</code></pre>
<p><strong>效果：</strong></p>
<ul>
<li>模型被“温柔地提醒”：对于多步骤任务，Todo 是推荐做法。</li>
<li>如果模型长期不更新 Todo（比如执行了很多工具调用），会收到 “该更新计划了” 的提示。</li>
</ul>
<h3 data-id="heading-15">4.4 架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62f70228be2d427880f5405a69bd61f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=TsK1IsLbDDIDvM%2BYsmNJExXr40k%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p><strong>显式规划让 Agent 更可靠，而 Todo 是实现显式规划的最小结构单元。</strong><br/>
<strong>结构既是约束，也是能力放大的脚手架。</strong></p>
</blockquote>
<ul>
<li>约束：</li>
<li>
<ul>
<li>限制条目数、状态字段、唯一进行中</li>
<li>要求完整列表，而非局部 patch</li>
</ul>
</li>
<li>赋能：</li>
<li>
<ul>
<li>提供了<strong>可见的计划</strong>（用户、模型都能看到）</li>
<li>提供了<strong>进度追踪</strong>和<strong>当前焦点</strong>的清晰标记</li>
<li>为后续的总结、回顾提供结构</li>
</ul>
</li>
</ul>
<p>类似的模式在 Agent 设计中普遍存在：</p>
<ul>
<li><code>max_tokens</code> 约束 → 赋能了响应可控与流式体验</li>
<li>工具 JSON Schema 约束 → 赋能了结构化调用和验证</li>
<li>Todo 约束 → 赋能了复杂任务的可靠完成和可解释性</li>
</ul>
<p>好的约束不是阻碍，而是让能力更稳定、更可控的支架。</p>
<h3 data-id="heading-16">4.5 完整代码</h3>
<p>v2 是在 v1 基础上的<strong>增量扩展</strong>，不改变核心 Agent 循环：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> llm_factory <span class="hljs-keyword">import</span> LLMFactory, LLMChatAdapter
<span class="hljs-keyword">from</span> util.mylog <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> execute_base_tools, TodoManager, BASE_TOOLS

<span class="hljs-comment"># 初始化 API 客户端</span>
<span class="hljs-comment"># 使用 LLMFactory 创建 LLM 实例</span>
llm = LLMFactory.create(
    model_type=<span class="hljs-string">"openai"</span>,
    model_name=<span class="hljs-string">"deepseek-v3.2"</span>, <span class="hljs-comment"># 使用支持的模型</span>
    temperature=<span class="hljs-number">0.0</span>,
    max_tokens=<span class="hljs-number">8192</span>
)
client = LLMChatAdapter(llm)
WORKDIR = Path.cwd()
TODO = TodoManager()

SYSTEM = <span class="hljs-string">f"""你是一个位于 <span class="hljs-subst">{WORKDIR}</span> 的编码代理，系统为 <span class="hljs-subst">{sys.platform}</span>。

## 执行流程
计划（使用 TodoWrite） -&gt; 使用工具行动（使用 TOOLS） -&gt; 更新任务列表 -&gt; 报告。

## 规则
- 使用 TodoWrite 跟踪多步骤任务
- 开始前将任务标记为 in_progress，完成后标记为 completed
- 优先使用工具而不是文字描述。先行动，不要只是解释。
- 完成后，总结变更内容。"""</span>

<span class="hljs-comment"># 在对话开始时显示</span>
INITIAL_REMINDER = <span class="hljs-string">"&lt;reminder&gt;使用 TodoWrite 处理多步骤任务。&lt;/reminder&gt;"</span>

<span class="hljs-comment"># 如果模型在一段时间内没有更新任务列表，则显示此提醒</span>
NAG_REMINDER = <span class="hljs-string">"&lt;reminder&gt;超过 10 轮未更新任务列表。请更新任务列表。&lt;/reminder&gt;"</span>

max_steps = <span class="hljs-number">20</span>
rounds_without_todo = <span class="hljs-number">0</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_todo</span>(<span class="hljs-params">items: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">return</span> TODO.update(items)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span><span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, args: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Dispatch tool call to implementation."""</span>
    result = execute_base_tools(name, args)
    <span class="hljs-keyword">if</span> result isnotNone:
        <span class="hljs-keyword">return</span> result

    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"TodoWrite"</span>:
        <span class="hljs-keyword">return</span> run_todo(args[<span class="hljs-string">"items"</span>])

    <span class="hljs-keyword">return</span><span class="hljs-string">f"Unknown tool: <span class="hljs-subst">{name}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_loop</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">str</span>, history: <span class="hljs-built_in">list</span> = [], max_steps: <span class="hljs-built_in">int</span> = max_steps</span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-keyword">global</span> rounds_without_todo

    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    has_system = <span class="hljs-built_in">any</span>(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history)
    ifnot has_system:
        <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
        history.insert(<span class="hljs-number">0</span>, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM})

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        response = client.chat_with_tools(
            prompt=prompt,
            messages=history,
            tools=BASE_TOOLS,
        )

        assistant_text = []
        tool_calls = []

        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(block, <span class="hljs-string">"text"</span>):
                assistant_text.append(block.text)
                logger.info(block.text)
            <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
            logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">return</span> history

        results = []
        used_todo = <span class="hljs-literal">False</span>

        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            logger.info(<span class="hljs-string">f"\n&gt; [使用工具] <span class="hljs-subst">{tc.name}</span> 第 <span class="hljs-subst">{step}</span> 步调用: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>"</span>)
            output = execute_tool(tc.name, tc.<span class="hljs-built_in">input</span>)
            preview = output[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">200</span><span class="hljs-keyword">else</span> output
            logger.info(<span class="hljs-string">f" [使用工具] <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{preview}</span>"</span>)
            results.append(<span class="hljs-string">f"工具 <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{output}</span>"</span>)
            <span class="hljs-keyword">if</span> tc.name == <span class="hljs-string">"TodoWrite"</span>:
                used_todo = <span class="hljs-literal">True</span>

        <span class="hljs-keyword">if</span> used_todo:
            rounds_without_todo = <span class="hljs-number">0</span>
        <span class="hljs-keyword">else</span>:
            rounds_without_todo += <span class="hljs-number">1</span>

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        combined_output = <span class="hljs-string">"\n"</span>.join(results)
        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理"</span>})

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">global</span> rounds_without_todo

    logger.info(<span class="hljs-string">f"Mini Claude Code v2 (with Todos) - <span class="hljs-subst">{WORKDIR}</span>"</span>)
    logger.info(<span class="hljs-string">"Type 'exit' to quit.\n"</span>)

    history = []
    first_message = <span class="hljs-literal">True</span>

    whileTrue:
        <span class="hljs-keyword">try</span>:
            user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"You: "</span>).strip()
        <span class="hljs-keyword">except</span> (EOFError, KeyboardInterrupt):
            <span class="hljs-keyword">break</span>

        ifnot user_input <span class="hljs-keyword">or</span> user_input.lower() <span class="hljs-keyword">in</span> (<span class="hljs-string">"exit"</span>, <span class="hljs-string">"quit"</span>, <span class="hljs-string">"q"</span>):
            <span class="hljs-keyword">break</span>

        content = []

        <span class="hljs-keyword">if</span> first_message:
            content.append(INITIAL_REMINDER)
            first_message = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">elif</span> rounds_without_todo &gt; max_steps:
            content.append(NAG_REMINDER)

        content.append(<span class="hljs-string">f"输入：<span class="hljs-subst">{user_input}</span>"</span>)
        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n"</span>.join(content)})

        <span class="hljs-keyword">try</span>:
            agent_loop(<span class="hljs-string">''</span>, history, max_steps=max_steps)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>)
            traceback.print_exc()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-17">5 v3: 子代理</h2>
<p>v2 已经有了 Todo 规划，但对于更大的任务，比如：“先探索代码库，再重构认证，然后补测试和文档”</p>
<p>单一 <code>Agent</code> 很容易撞上<strong>上下文污染与角色混乱</strong>：</p>
<ul>
<li>探索阶段读了 20 个文件，把大量细节塞进上下文</li>
<li>重构时，又在同一个上下文里继续对话</li>
<li>模型很难在「海量历史」中保持聚焦和角色清晰</li>
</ul>
<p>v3 添加了一个新工具：<strong>SubTask</strong>，它可以生成带有隔离上下文的「子代理」，每个子代理专注完成一个子任务。</p>
<h3 data-id="heading-18">5.1 问题：单 Agent 的上下文污染</h3>
<p>在 v2 中，大型任务的历史会变成这样：</p>
<pre><code class="hljs language-bash" lang="bash">主 Agent 历史：
  [探索中...] <span class="hljs-built_in">cat</span> src/auth/login.py -&gt; 500 行
  [探索中...] <span class="hljs-built_in">cat</span> src/auth/session.py -&gt; 300 行
  [探索中...] <span class="hljs-built_in">cat</span> src/models/user.py -&gt; 400 行
  ...
  （15+ 个文件内容）
  [现在重构...] <span class="hljs-string">"等等，login.py 里具体是什么来着？"</span>
</code></pre>
<p>模型需要在「聊天记录 + N 个文件内容 + Todo 列表」的混合上下文里继续工作，容易：</p>
<ul>
<li>失焦：在旧文件和新任务之间来回跳跃</li>
<li>浪费上下文：很多信息是阶段性的，只用于探索</li>
<li>难以区分角色：探索 vs 规划 vs 实现</li>
</ul>
<p>解决方案：<strong>把不同阶段委托给不同的子代理</strong>。</p>
<h3 data-id="heading-19">5.2 思路：用子代理隔离阶段</h3>
<p>把「探索 → 规划 → 实现」拆成三个子代理，每个子代理在一个干净的上下文里工作：</p>
<pre><code class="hljs language-rust" lang="rust">主 Agent 历史：
  [Task: explore] 探索代码库
    <span class="hljs-punctuation">-&gt;</span> 子代理( explore )：读取 <span class="hljs-number">20</span> 个文件
    <span class="hljs-punctuation">-&gt;</span> 返回摘要: <span class="hljs-string">"认证在 src/auth/，数据库在 src/models/..."</span>
  [Task: plan] 设计 JWT 迁移方案
    <span class="hljs-punctuation">-&gt;</span> 子代理( plan )：分析结构，输出步骤
    <span class="hljs-punctuation">-&gt;</span> 返回总结: <span class="hljs-string">"1. 添加 jwt 库 2. 创建 token 工具..."</span>
  [Task: code] 实现 JWT 重构
    <span class="hljs-punctuation">-&gt;</span> 子代理( code )：编辑文件、运行测试
    <span class="hljs-punctuation">-&gt;</span> 返回结果: <span class="hljs-string">"创建 jwt_utils.py，修改 login.py ..."</span>
  [主 Agent] 汇总更改并向用户汇报
</code></pre>
<p>对于主 Agent 来说：</p>
<ul>
<li>存的是<strong>子代理摘要</strong>，而不是全部细节</li>
<li>每个子代理内部使用和 v1/v2 相同的工具循环，但上下文是隔离的</li>
</ul>
<h3 data-id="heading-20">5.3 代理类型注册表：给不同子代理不同「角色 + 权限」</h3>
<p>通过一个简单的注册表定义不同类型代理：</p>
<pre><code class="hljs language-makefile" lang="makefile">AGENT_TYPES = {
    <span class="hljs-string">"explore"</span>: {
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"只读，用于搜索和分析代码结构"</span>,
        <span class="hljs-string">"tools"</span>: [<span class="hljs-string">"bash"</span>, <span class="hljs-string">"read_file"</span>],  <span class="hljs-comment"># 不能写</span>
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"你是一个探索子代理，只负责搜索和分析项目代码。不要修改任何文件。返回简洁、结构化的摘要。"</span>
    },
    <span class="hljs-string">"code"</span>: {
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"完整读写能力，用于实现变更"</span>,
        <span class="hljs-string">"tools"</span>: <span class="hljs-string">"*"</span>,  <span class="hljs-comment"># 所有工具（但通常不含 Task，避免递归）</span>
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"你是一个代码实现子代理，负责根据要求修改代码并跑测试。要高效、谨慎，做完后总结改动。"</span>
    },
    <span class="hljs-string">"plan"</span>: {
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"规划与分析，不做修改"</span>,
        <span class="hljs-string">"tools"</span>: [<span class="hljs-string">"bash"</span>, <span class="hljs-string">"read_file"</span>],  <span class="hljs-comment"># 只读</span>
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"你是一个规划子代理，负责分析现有代码并输出编号计划。不要编辑文件，只提出可执行方案。"</span>
    }
}
</code></pre>
<p>这样可以明确区分：</p>
<ul>
<li>explore：只看不写</li>
<li>plan：只看不写，专注输出计划</li>
<li>code：可以改动代码并跑测试</li>
</ul>
<p>模型在主 Agent 中，通过 Task 工具选择 <code>agent_type</code>，从而决定<strong>派出什么「橘色」的子代理</strong>。</p>
<h3 data-id="heading-21">5.4 Task: 定义 schema + 控制每种子代理的能力边界</h3>
<h4 data-id="heading-22">5.4.1 定义 schema</h4>
<pre><code class="hljs language-makefile" lang="makefile">TASK_TOOL = {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Task"</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"创建一个聚焦的子任务，并用指定类型的子代理在隔离上下文中执行它。"</span>,
    <span class="hljs-string">"input_schema"</span>: {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
            <span class="hljs-string">"description"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"子任务的短名称（3-5 个词），用来在日志/进度条中显示。"</span>
            },
            <span class="hljs-string">"prompt"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"详细的自然语言指令，子代理看到的用户任务描述。"</span>
            },
            <span class="hljs-string">"agent_type"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"enum"</span>: [<span class="hljs-string">"explore"</span>, <span class="hljs-string">"code"</span>, <span class="hljs-string">"plan"</span>],
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"子代理的类型（决定工具与系统提示）。"</span>
            }
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"description"</span>, <span class="hljs-string">"prompt"</span>, <span class="hljs-string">"agent_type"</span>],
    },
}
</code></pre>
<p>主 Agent 调用 Task 时，大致会传：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"探索认证代码"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prompt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"找到所有与用户登录和认证相关的文件，阅读后给出结构化摘要。"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"agent_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explore"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Task 工具会启动一个子代理，子代理跑完整个 v1/v2 的工具循环，最后返回一段<strong>总结文本</strong>给主 Agent。</p>
<h4 data-id="heading-23">5.4.2 控制每种子代理的能力边界</h4>
<p><code>get_tools_for_agent</code> 的实现决定了每种子代理可以用哪些工具：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">def <span class="hljs-title">get_tools_for_agent</span><span class="hljs-params">(agent_type)</span>:
    allowed =</span> AGENT_TYPES[agent_type][<span class="hljs-string">"tools"</span>]
    <span class="hljs-keyword">if</span> allowed == <span class="hljs-string">"*"</span>:
        <span class="hljs-meta"># code 子代理：拥有所有基础工具（不包含 Task 避免递归）</span>
        <span class="hljs-keyword">return</span> [t <span class="hljs-keyword">for</span> t in BASE_TOOLS <span class="hljs-keyword">if</span> t[<span class="hljs-string">"name"</span>] != <span class="hljs-string">"Task"</span>]
    <span class="hljs-keyword">else</span>:
        <span class="hljs-meta"># explore / plan 子代理：只给指定子集</span>
        <span class="hljs-keyword">return</span> [
            t <span class="hljs-keyword">for</span> t in BASE_TOOLS
            <span class="hljs-keyword">if</span> t[<span class="hljs-string">"name"</span>] in allowed <span class="hljs-keyword">and</span> t[<span class="hljs-string">"name"</span>] != <span class="hljs-string">"Task"</span>
        ]
</code></pre>
<p>默认策略（可根据需要微调）：</p>
<ul>
<li><code>explore</code>：只读 -&gt; <code>bash + read_file</code></li>
<li><code>plan</code>：只读 -&gt; <code>bash + read_file</code></li>
<li><code>code</code>：读写/执行 -&gt; <code>bash + read_file + write_file + edit_file + TodoWrite</code>（但不含 Task）</li>
</ul>
<h3 data-id="heading-24">5.5 对比 v2 与 v3</h3>
<ul>
<li>探索/规划子代理不可能意外修改文件</li>
<li>code 子代理可以对当前子任务做完整修改与验证</li>
<li>主 Agent 负责「宏观协调」，子代理负责「局部执行」</li>
</ul>








































<table><thead><tr><th>功能</th><th>v2</th><th>v3</th></tr></thead><tbody><tr><td>上下文形态</td><td>单一上下文，不断增长</td><td>主 Agent + 多个子代理，各自隔离</td></tr><tr><td>探索行为</td><td>直接在主 Agent 中执行</td><td>通过 explore 子代理执行并总结</td></tr><tr><td>规划行为</td><td>使用 Todo + 主 Agent 自己规划</td><td>可选 plan 子代理生成更结构化的计划</td></tr><tr><td>代码修改</td><td>主 Agent 直接改</td><td>code 子代理在专用上下文中改</td></tr><tr><td>并行潜力</td><td>理论可以，但逻辑复杂</td><td>子代理天然支持并行（演示版未实现并发调度）</td></tr><tr><td/><td/><td/></tr></tbody></table>
<p>核心循环仍然是：</p>
<pre><code class="hljs language-css" lang="css">while True:
    resp = <span class="hljs-built_in">model</span>(messages, tools)
    if resp.stop_reason != <span class="hljs-string">"tool_use"</span>:
        return resp
    results = <span class="hljs-built_in">execute</span>(resp.tool_calls)
    messages.<span class="hljs-built_in">append</span>(resp)
    messages.<span class="hljs-built_in">append</span>(results)
</code></pre>
<p>v3 只是让这个循环<strong>在多个上下文中同时存在</strong>（主 Agent + 子代理），并通过 Task 工具协调这些循环。</p>
<h3 data-id="heading-25">5.6 模式：分而治之 + 上下文隔离</h3>
<p>抽象出来就是：</p>
<pre><code class="hljs language-css" lang="css">复杂任务
  └─ 主 Agent（协调者）
       ├─ 子代理 <span class="hljs-selector-tag">A</span> (explore) -&gt; 返回「结构摘要」
       ├─ 子代理 <span class="hljs-selector-tag">B</span> (plan)    -&gt; 返回「任务计划」
       └─ 子代理 C (<span class="hljs-selector-tag">code</span>)    -&gt; 返回「实现结果」
</code></pre>
<p>所有 Agent（主 + 子）的内部结构都是同一个：</p>
<ul>
<li>有工具</li>
<li>有系统提示词</li>
<li>有 <code>while True</code> 工具循环</li>
</ul>
<p>只是<strong>上下文不同、工具集不同、角色Prompt不同</strong>。</p>
<h3 data-id="heading-26">5.7 详细代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> llm_factory <span class="hljs-keyword">import</span> LLMFactory, LLMChatAdapter
<span class="hljs-keyword">from</span> util.mylog <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> execute_base_tools, TodoManager, get_agent_descriptions, BASE_TOOLS, SUBAGENT_ALL_TOOLS, AGENT_TYPES

<span class="hljs-comment"># 初始化 API 客户端</span>
<span class="hljs-comment"># 使用 LLMFactory 创建 LLM 实例</span>
llm = LLMFactory.create(
    model_type=<span class="hljs-string">"openai"</span>,
    model_name=<span class="hljs-string">"deepseek-v3.2"</span>, <span class="hljs-comment"># 使用支持的模型</span>
    temperature=<span class="hljs-number">0.0</span>,
    max_tokens=<span class="hljs-number">8192</span>
)
client = LLMChatAdapter(llm)
WORKDIR = Path.cwd()

TODO = TodoManager()

SYSTEM = <span class="hljs-string">f"""你是一个位于 <span class="hljs-subst">{WORKDIR}</span> 的编码代理，系统为 <span class="hljs-subst">{sys.platform}</span>。

## 执行流程
计划（使用 TodoWrite）-&gt; 使用工具行动 -&gt; 执行子代理工具 -&gt; 报告。

你可以为复杂的子任务生成子代理：
<span class="hljs-subst">{get_agent_descriptions()}</span>

## 规则
- 对需要集中探索或实现的子任务使用 Task 工具
- 使用 TodoWrite 跟踪多步骤工作
- 优先使用工具而不是文字描述。先行动，不要只是解释。
- 完成后，总结变更内容。"""</span>

max_steps = <span class="hljs-number">20</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tools_for_agent</span>(<span class="hljs-params">agent_type: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">list</span>:
    allowed = AGENT_TYPES.get(agent_type, {}).get(<span class="hljs-string">"tools"</span>, <span class="hljs-string">"*"</span>)

    <span class="hljs-keyword">if</span> allowed == <span class="hljs-string">"*"</span>:
        <span class="hljs-keyword">return</span> BASE_TOOLS  <span class="hljs-comment"># All base tools, but NOT Task (no recursion in demo)</span>

    <span class="hljs-keyword">return</span> [t <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> BASE_TOOLS <span class="hljs-keyword">if</span> t[<span class="hljs-string">"name"</span>] <span class="hljs-keyword">in</span> allowed]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_task</span>(<span class="hljs-params">description: <span class="hljs-built_in">str</span>, prompt: <span class="hljs-built_in">str</span>, agent_type: <span class="hljs-built_in">str</span>, max_steps: <span class="hljs-built_in">int</span> = max_steps</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    在隔离的上下文中执行子代理任务。

    这是子代理机制的核心：

    1. 创建隔离的消息历史（关键：没有父级上下文！）
    2. 使用特定于代理的系统提示词
    3. 根据代理类型过滤可用工具
    4. 运行与主代理相同的查询循环
    5. 仅返回最终文本（不是中间细节）

    父代理只看到总结，保持其上下文干净。

    进度显示：
    ----------------
    运行时，我们会显示：
      [explore] find auth files ... 5 tools, 3.2s

    这在不污染主对话的情况下提供了可见性。
    """</span>
    <span class="hljs-keyword">if</span> agent_type notin AGENT_TYPES:
        <span class="hljs-keyword">return</span><span class="hljs-string">f"Error: Unknown agent type '<span class="hljs-subst">{agent_type}</span>'"</span>

    config = AGENT_TYPES[agent_type]

    sub_system = <span class="hljs-string">f"""你是一个位于 <span class="hljs-subst">{WORKDIR}</span> 的 <span class="hljs-subst">{agent_type}</span> 子代理，系统为 <span class="hljs-subst">{sys.platform}</span>。

<span class="hljs-subst">{config[<span class="hljs-string">"prompt"</span>]}</span>

完成任务并返回清晰、简洁的总结。"""</span>

    sub_tools = get_tools_for_agent(agent_type)
    sub_messages = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: sub_system}, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}]

    logger.info(<span class="hljs-string">f"      [子代理][<span class="hljs-subst">{agent_type}</span>] <span class="hljs-subst">{description}</span>"</span>)
    start = time.time()
    tool_count = <span class="hljs-number">0</span>

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        response = client.chat_with_tools(
            prompt=<span class="hljs-string">''</span>,
            messages=sub_messages,
            tools=sub_tools,
        )

        assistant_text = []
        tool_calls = []

        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(block, <span class="hljs-string">"text"</span>):
                assistant_text.append(block.text)
                logger.info(<span class="hljs-string">f"      [子代理][<span class="hljs-subst">{agent_type}</span>] <span class="hljs-subst">{block.text}</span>"</span>)
            <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            logger.info(<span class="hljs-string">f"      [子代理][<span class="hljs-subst">{agent_type}</span>] 第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">break</span>

        results = []

        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            tool_count += <span class="hljs-number">1</span>
            output = execute_tool(tc.name, tc.<span class="hljs-built_in">input</span>)
            results.append(<span class="hljs-string">f"      [子代理][<span class="hljs-subst">{agent_type}</span>] 工具 <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{output}</span>"</span>)
            elapsed = time.time() - start
            sys.stdout.write(
                <span class="hljs-string">f"\r      [子代理][<span class="hljs-subst">{agent_type}</span>] <span class="hljs-subst">{description}</span> ... <span class="hljs-subst">{tool_count}</span> tools, <span class="hljs-subst">{elapsed:<span class="hljs-number">.1</span>f}</span>s\n"</span>
            )
            sys.stdout.flush()

        sub_messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        combined_output = <span class="hljs-string">"\n"</span>.join(results)
        sub_messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"子代理执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理"</span>})

    elapsed = time.time() - start
    sys.stdout.write(
        <span class="hljs-string">f"\r      [子代理][<span class="hljs-subst">{agent_type}</span>] <span class="hljs-subst">{description}</span> - done (<span class="hljs-subst">{tool_count}</span> tools, <span class="hljs-subst">{elapsed:<span class="hljs-number">.1</span>f}</span>s)\n"</span>
    )

    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(block, <span class="hljs-string">"text"</span>):
            <span class="hljs-keyword">return</span> full_text

    <span class="hljs-keyword">return</span><span class="hljs-string">"(subagent returned no text)"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, args: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    result = execute_base_tools(name, args)
    <span class="hljs-keyword">if</span> result isnotNone:
        <span class="hljs-keyword">return</span> result

    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"TodoWrite"</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> TODO.update(args[<span class="hljs-string">"items"</span>])
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span><span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>

    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"Task"</span>:
        <span class="hljs-keyword">return</span> run_task(args[<span class="hljs-string">"description"</span>], args[<span class="hljs-string">"prompt"</span>], args[<span class="hljs-string">"agent_type"</span>])

    <span class="hljs-keyword">return</span><span class="hljs-string">f"Unknown tool: <span class="hljs-subst">{name}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_loop</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">str</span>, history: <span class="hljs-built_in">list</span>, max_steps: <span class="hljs-built_in">int</span> = max_steps</span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    has_system = <span class="hljs-built_in">any</span>(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history)
    ifnot has_system:
        <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
        history.insert(<span class="hljs-number">0</span>, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM})

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        response = client.chat_with_tools(
            prompt=prompt,
            messages=history,
            tools=SUBAGENT_ALL_TOOLS,
        )

        assistant_text = []
        tool_calls = []

        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(block, <span class="hljs-string">"text"</span>):
                assistant_text.append(block.text)
                logger.info(block.text)
            <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
            logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">return</span> history

        results = []
        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            <span class="hljs-keyword">if</span> tc.name == <span class="hljs-string">"Task"</span>:
                logger.info(<span class="hljs-string">f"\n&gt; [使用工具] Task 第 <span class="hljs-subst">{step}</span> 步调用: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>.get(<span class="hljs-string">'description'</span>, <span class="hljs-string">'subtask'</span>)}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                logger.info(<span class="hljs-string">f"\n&gt; [使用工具] <span class="hljs-subst">{tc.name}</span> 第 <span class="hljs-subst">{step}</span> 步调用: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>"</span>)

            logger.info(<span class="hljs-string">f"  输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>"</span>)
            output = execute_tool(tc.name, tc.<span class="hljs-built_in">input</span>)
            <span class="hljs-keyword">if</span> tc.name != <span class="hljs-string">"Task"</span>:
                preview = output[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">200</span><span class="hljs-keyword">else</span> output
                logger.info(<span class="hljs-string">f"  [使用工具] <span class="hljs-subst">{tc.name}</span>, 返回: <span class="hljs-subst">{preview}</span>"</span>)
                
            results.append(<span class="hljs-string">f"工具 <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{output}</span>"</span>)

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        combined_output = <span class="hljs-string">"\n"</span>.join(results)
        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理"</span>})

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    logger.info(<span class="hljs-string">f"Mini Claude Code v3 (with Subagents) - <span class="hljs-subst">{WORKDIR}</span>"</span>)
    logger.info(<span class="hljs-string">f"Agent types: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(AGENT_TYPES.keys())}</span>"</span>)
    logger.info(<span class="hljs-string">"Type 'exit' to quit.\n"</span>)

    history = []

    whileTrue:
        <span class="hljs-keyword">try</span>:
            user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"You: "</span>).strip()
        <span class="hljs-keyword">except</span> (EOFError, KeyboardInterrupt):
            <span class="hljs-keyword">break</span>

        ifnot user_input <span class="hljs-keyword">or</span> user_input.lower() <span class="hljs-keyword">in</span> (<span class="hljs-string">"exit"</span>, <span class="hljs-string">"quit"</span>, <span class="hljs-string">"q"</span>):
            <span class="hljs-keyword">break</span>

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_input})

        <span class="hljs-keyword">try</span>:
            agent_loop(<span class="hljs-string">''</span>, history, max_steps=max_steps)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>)
            traceback.print_exc()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-27">6 v4: Skills</h2>
<p>Skills 是知识包，不是工具本身，Skills 机制体现了一个深刻的范式转变：<strong>知识外化 (Knowledge Externalization)</strong>。</p>
<p><strong>传统方式：知识内化于参数</strong></p>
<p>传统 AI 系统中，大部分知识被封装在模型参数里：</p>
<ul>
<li>你看不到里面有什么</li>
<li>你不能精确编辑其中某一部分</li>
<li>很难在不同系统之间精确复用</li>
</ul>
<p>想让模型学会新技能，一般流程是：</p>
<ul>
<li>收集大量相关训练数据</li>
<li>准备/租用分布式训练集群</li>
<li>运行复杂的微调流程（LoRA / 全量微调等）</li>
<li>部署一个新模型版本，并维护兼容性</li>
</ul>
<p>知识被锁死在神经网络的权重矩阵中，对用户来说基本是<strong>不可见、不可编辑、不可精确复用</strong>的。</p>
<p><strong>新范式：知识外化为文档</strong></p>
<p>有了「代码执行 + 文件系统」的范式后，知识可以逐层外化：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                         知识存储层级                              │
│                                                                 │
│  Model Parameters → Context Window → File System → Skill Library│
│       (内化)            (运行时)        (持久化)       (结构化)     │
│                                                                 │
│  ←───────── 训练修改 ──────────→  ←──── 自然语言/文本编辑 ────→     │
│     需要集群、数据、专业知识              任何人都能参与               │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>关键变化：</strong></p>
<ul>
<li>过去：<strong>修改行为 = 修改参数</strong> → 需要训练 → 需要 GPU 集群 + 数据 + ML 技能</li>
<li>现在：<strong>修改行为 = 修改 SKILL.md</strong> → 就像写文档 → 任何人都可以做</li>
</ul>
<p>这类似于给 base model 外挂一个「可热插拔的知识模块」，但你不需要对模型做任何参数级别的改动。</p>
<h3 data-id="heading-28">6.1 为什么 <code>SKill</code> 这种工程范式很重要</h3>
<p><strong>民主化</strong><br/>
不再需要 ML 专业知识就能「定制模型行为」。写 Markdown 文档即可。<br/>
<strong>透明性</strong><br/>
知识存在于人类可读的 SKILL.md 中，可审计、可理解、可讨论。<br/>
<strong>复用性</strong><br/>
一个 Skill 编写一次，可以在任何兼容的 Agent 框架中加载使用。<br/>
<strong>版本控制</strong><br/>
用 Git 管理 Skill 变更：支持协作、Code Review 和回滚。<br/>
<strong>在线学习</strong><br/>
模型在更大的上下文窗口中**即时「学习」**技能内容，无需离线训练。</p>
<p>Skills 正好处在一个「可以工程化的范式」中：</p>
<ul>
<li>持久化存储（文件系统）</li>
<li>按需加载（只在需要时注入）</li>
<li>人类可编辑（Markdown 文档）</li>
</ul>
<h3 data-id="heading-29">6.2 v3 做了结构与上下文，v4 解决「知识从哪来」的问题</h3>
<p>v3 引入了子代理机制，让 <code>Agent</code> 可以：</p>
<ul>
<li>分阶段处理任务（explore / plan / code）</li>
<li>每个阶段在各自的上下文中运行</li>
</ul>
<p>但还有一个更深的问题：<strong>模型怎么知道「做这件事的正确方法」？</strong><br/>
这些不是「工具」，而是<strong>领域知识 / 专业技能</strong>，Tools 决定模型「能做什么」，Skills 决定模型「知道怎么做」。</p>
<p><strong>工具 vs 技能</strong></p>




















<table><thead><tr><th>概念</th><th>定义</th><th>例子</th></tr></thead><tbody><tr><td>Tool</td><td>模型能<strong>做什么</strong></td><td>bash, read_file, http, etc.</td></tr><tr><td>Skill</td><td>模型<strong>知道怎么做</strong></td><td>PDF 处理、MCP 构建、代码审查</td></tr></tbody></table>
<ul>
<li>Tool 是动作层面的能力（能执行什么操作）。</li>
<li>Skill 是策略/知识层面的积累（做这件事的正确方法、最佳实践）。</li>
</ul>
<p><strong>控制上下文</strong><br/>
为了控制上下文开销，Skill 被分成三层：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Layer 1:</span> <span class="hljs-string">元数据</span> <span class="hljs-string">(始终加载，极小)</span>    <span class="hljs-string">~100</span> <span class="hljs-string">tokens/skill</span>
         <span class="hljs-string">└─</span> <span class="hljs-string">name</span> <span class="hljs-string">+</span> <span class="hljs-string">description</span> <span class="hljs-string">（用于检索/展示）</span>

<span class="hljs-attr">Layer 2:</span> <span class="hljs-string">SKILL.md</span> <span class="hljs-string">正文</span> <span class="hljs-string">(触发时加载)</span> <span class="hljs-string">~2k</span> <span class="hljs-string">tokens</span> <span class="hljs-string">级别</span>
         <span class="hljs-string">└─</span> <span class="hljs-string">详细指南、分步骤说明、示例等</span>

<span class="hljs-attr">Layer 3:</span> <span class="hljs-string">资源文件</span> <span class="hljs-string">(必要时再查)</span>      <span class="hljs-string">无硬限制</span>
         <span class="hljs-string">└─</span> <span class="hljs-string">scripts/,</span> <span class="hljs-string">references/,</span> <span class="hljs-string">assets/</span> <span class="hljs-string">等</span>
</code></pre>
<p>这样可以做到：</p>
<ul>
<li>平时只把轻量的「技能列表/描述」放进 prompt（或系统提示）。</li>
<li>当模型「决定使用某个 Skill」时，再通过工具调用真正加载 SKILL.md 正文。</li>
<li>如果正文还引用了脚本/示例，可以按需再用普通文件工具读取。</li>
</ul>
<h3 data-id="heading-30">6.3 Skill 目录结构与 SKILL.md 标准</h3>
<p><strong>Skill 目录结构</strong></p>
<pre><code class="hljs language-bash" lang="bash">skills/
├── pdf/
│   └── SKILL.md          <span class="hljs-comment"># 必需</span>
├── mcp-builder/
│   ├── SKILL.md
│   └── references/       <span class="hljs-comment"># 可选（额外资料）</span>
└── code-review/
    ├── SKILL.md
    └── scripts/          <span class="hljs-comment"># 可选（示例脚本/模板）</span>
</code></pre>
<p><code>SKILL.md</code> 采用「YAML 前置 + Markdown 正文」格式：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">pdf</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">处理</span> <span class="hljs-string">PDF</span> <span class="hljs-string">文件。用于读取、创建或合并</span> <span class="hljs-string">PDF。</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">**Skill</span> <span class="hljs-string">工具定义**</span>

<span class="hljs-string">```python</span>
<span class="hljs-string">SKILL_TOOL</span> <span class="hljs-string">=</span> {
    <span class="hljs-attr">"name":</span> <span class="hljs-string">"Skill"</span>,
    <span class="hljs-attr">"description":</span> <span class="hljs-string">"加载一个技能的文档，以获得领域知识和最佳实践。"</span>,
    <span class="hljs-attr">"input_schema":</span> {
        <span class="hljs-attr">"type":</span> <span class="hljs-string">"object"</span>,
        <span class="hljs-attr">"properties":</span> {
            <span class="hljs-attr">"skill":</span> {
                <span class="hljs-attr">"type":</span> <span class="hljs-string">"string"</span>,
                <span class="hljs-attr">"description":</span> <span class="hljs-string">"要加载的 skill 名称，例如 'pdf'、'mcp-builder'。"</span>
            }
        },
        <span class="hljs-attr">"required":</span> [<span class="hljs-string">"skill"</span>],
    },
}
</code></pre>
<h3 data-id="heading-31">6.4 Skill 工具执行逻辑：缓存友好式注入</h3>
<p>关键点：<strong>Skill 内容作为 tool_result 追加到 messages 末尾</strong>，而不是修改 system prompt 或历史前缀。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_skill</span>(<span class="hljs-params">skill_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">try</span>:
        content = skill_loader.get_skill_content(skill_name)
    <span class="hljs-keyword">except</span> KeyError:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"[Skill error] Skill '<span class="hljs-subst">{skill_name}</span>' not found."</span>

    <span class="hljs-comment"># 完整 Skill 内容作为 tool_result 返回</span>
    <span class="hljs-comment"># 包在一个标签里，方便模型识别</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"""&lt;skill-loaded name="<span class="hljs-subst">{skill_name}</span>"&gt;
<span class="hljs-subst">{content}</span>
&lt;/skill-loaded&gt;

Now follow the instructions and best practices described in this skill."""</span>
</code></pre>
<p>在统一的 <code>execute_tool</code> 中：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">def <span class="hljs-title">execute_tool</span><span class="hljs-params">(name, args)</span>:
    if name =</span>= <span class="hljs-string">"Skill"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">run_skill</span>(args[<span class="hljs-string">"skill"</span>])

    # 其他工具: bash / read_file / write_file / edit_file / TodoWrite / <span class="hljs-built_in">Task</span>...
    ...
</code></pre>
<p>在 <code>agent_loop</code> 中不需要任何结构性变化，只要像处理其他工具那样处理 <code>Skill</code> 即可：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_loop</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">str</span>, history: <span class="hljs-built_in">list</span>, max_steps: <span class="hljs-built_in">int</span> = max_steps</span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    has_system = <span class="hljs-built_in">any</span>(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span><span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> history)
    ifnot has_system:
        <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
        history.insert(<span class="hljs-number">0</span>, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM})

    step = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> step &lt; max_steps:
        step += <span class="hljs-number">1</span>
        response = client.chat_with_tools(
            prompt=prompt,
            messages=history,
            tools=ALL_TOOLS,
        )

        assistant_text = []
        tool_calls = []

        <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(block, <span class="hljs-string">"text"</span>):
                assistant_text.append(block.text)
                logger.info(block.text)
            <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        full_text = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
            logger.info(<span class="hljs-string">f"第 <span class="hljs-subst">{step}</span> 步结束，无工具调用"</span>)
            <span class="hljs-keyword">return</span> history

        results = []
        <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> tool_calls:
            <span class="hljs-keyword">if</span> tc.name == <span class="hljs-string">"Task"</span>:
                logger.info(<span class="hljs-string">f"\n&gt; [使用工具] Task 第 <span class="hljs-subst">{step}</span> 步调用: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>.get(<span class="hljs-string">'description'</span>, <span class="hljs-string">'subtask'</span>)}</span>"</span>)
            <span class="hljs-keyword">elif</span> tc.name == <span class="hljs-string">"Skill"</span>:
                logger.info(<span class="hljs-string">f"\n&gt; [使用工具] 第 <span class="hljs-subst">{step}</span> 步调用 Loading skill: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>.get(<span class="hljs-string">'skill'</span>, <span class="hljs-string">'?'</span>)}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                logger.info(<span class="hljs-string">f"\n&gt; [使用工具] <span class="hljs-subst">{tc.name}</span> 第 <span class="hljs-subst">{step}</span> 步调用: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>"</span>)

            output = execute_tool(tc.name, tc.<span class="hljs-built_in">input</span>)

            <span class="hljs-keyword">if</span> tc.name == <span class="hljs-string">"Skill"</span>:
                logger.info(<span class="hljs-string">f"  Skill loaded (<span class="hljs-subst">{<span class="hljs-built_in">len</span>(output)}</span> chars)"</span>)
            <span class="hljs-keyword">elif</span> tc.name != <span class="hljs-string">"Task"</span>:
                preview = output[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">200</span><span class="hljs-keyword">else</span> output
                logger.info(<span class="hljs-string">f"  [使用工具] <span class="hljs-subst">{tc.name}</span>, 返回: <span class="hljs-subst">{preview}</span>"</span>)

            results.append(<span class="hljs-string">f"工具 <span class="hljs-subst">{tc.name}</span>, 输入: <span class="hljs-subst">{tc.<span class="hljs-built_in">input</span>}</span>, 返回: <span class="hljs-subst">{output}</span>"</span>)

        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_text})
        combined_output = <span class="hljs-string">"\n"</span>.join(results)
        history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"执行结果：\n<span class="hljs-subst">{combined_output}</span>\n\n请继续处理"</span>})
</code></pre>
<p>这样：</p>
<ul>
<li>Skill 内容出现在对话末尾的 <code>tool_result</code> 文本里</li>
<li>前缀（system + 之前 history）完全不变 → <strong>prompt cache 可以完全复用</strong></li>
<li>下次请求时，只需对新增的 Skill 内容和新问题部分做计算</li>
</ul>
<h3 data-id="heading-32">6.5 设计哲学：从「训练 AI」到「教育 AI」</h3>
<blockquote>
<p><strong>知识被提升为一等公民资源。</strong></p>
</blockquote>
<p>传统观点把 Agent 看作「调用工具的模型」——模型负责决策，工具负责执行，但这隐含一个前提：模型已经知道「如何使用这些工具解决问题」。</p>
<p>Skills 机制把<strong>领域知识</strong>从模型参数中剥离，做了一件事：</p>
<ul>
<li>过去：要教模型新技能 → 收集数据 + 训练</li>
<li>现在：要教模型新技能 → 写/编辑 SKILL.md 文档</li>
</ul>
<p>这是一种从「训练 AI」到「教育 AI」的转变：</p>
<ul>
<li>技术上：从参数微调 → 上下文注入</li>
<li>组织上：从 ML 团队独占 → 任何工程师/领域专家都能参与</li>
<li>工程上：从黑盒权重 → 白盒文档（可审计、可 review）</li>
</ul>
<h3 data-id="heading-33">6.6 架构图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46f9bc03162e415d8beba3a2d03b8a6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGo5pyr56iL5bqP54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769390104&amp;x-signature=9S69O3vMDpxgvZQEgihwPi2vIlc%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-34">6.7 详细代码</h3>
<pre><code class="hljs language-ini" lang="ini">import re
import sys
import time
import traceback
from pathlib import Path
from llm_factory import LLMFactory, LLMChatAdapter
from util.mylog import logger
from utils import execute_base_tools, TodoManager, AGENT_TYPES, get_agent_descriptions, SUBAGENT_ALL_TOOLS, BASE_TOOLS

<span class="hljs-comment"># 初始化 API 客户端</span>
<span class="hljs-comment"># 使用 LLMFactory 创建 LLM 实例</span>
<span class="hljs-attr">llm</span> = LLMFactory.create(
    <span class="hljs-attr">model_type</span>=<span class="hljs-string">"openai"</span>,
    <span class="hljs-attr">model_name</span>=<span class="hljs-string">"deepseek-v3.2"</span>, <span class="hljs-comment"># 使用支持的模型</span>
    <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
    <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">8192</span>
)
<span class="hljs-attr">client</span> = LLMChatAdapter(llm)
<span class="hljs-attr">WORKDIR</span> = Path.cwd()
<span class="hljs-attr">SKILLS_DIR</span> = WORKDIR / <span class="hljs-string">"skills"</span>

class SkillLoader:
    """
    从 SKILL.md 文件加载和管理技能。

    技能是一个包含以下内容的文件夹：
    - SKILL.md (必须): YAML frontmatter + markdown 说明
    - scripts/ (可选): 模型可以运行的辅助脚本
    - references/ (可选): 额外的文档
    - assets/ (可选): 模板，输出文件
    """

    def __init__(self, skills_dir: Path):
        <span class="hljs-attr">self.skills_dir</span> = skills_dir
        <span class="hljs-attr">self.skills</span> = {}
        self.load_skills()

    def parse_skill_md(self, path: Path) -&gt; dict:
        <span class="hljs-attr">content</span> = path.read_text()

        <span class="hljs-comment"># Match YAML frontmatter between --- markers</span>
        <span class="hljs-attr">match</span> = re.match(r<span class="hljs-string">"^---\s*\n(.*?)\n---\s*\n(.*)$"</span>, content, re.DOTALL)
        ifnot match:
            returnNone

        frontmatter, <span class="hljs-attr">body</span> = match.groups()

        <span class="hljs-comment"># Parse YAML-like frontmatter (simple key: value)</span>
        <span class="hljs-attr">metadata</span> = {}
        for line in frontmatter.strip().split("\n"):
            if":"in line:
                key, <span class="hljs-attr">value</span> = line.split(<span class="hljs-string">":"</span>, <span class="hljs-number">1</span>)
                metadata<span class="hljs-section">[key.strip()]</span> = value.strip().strip(""'")

        <span class="hljs-comment"># Require name and description</span>
        if"name"notin metadata or"description"notin metadata:
            returnNone

        return {
            "name": metadata<span class="hljs-section">["name"]</span>,
            "description": metadata<span class="hljs-section">["description"]</span>,
            "body": body.strip(),
            "path": path,
            "dir": path.parent,
        }

    def load_skills(self):
        ifnot self.skills_dir.exists():
            return

        for skill_dir in self.skills_dir.iterdir():
            ifnot skill_dir.is_dir():
                continue

            <span class="hljs-attr">skill_md</span> = skill_dir / <span class="hljs-string">"SKILL.md"</span>
            ifnot skill_md.exists():
                continue

            <span class="hljs-attr">skill</span> = self.parse_skill_md(skill_md)
            if skill:
                self.skills<span class="hljs-section">[skill["name"]]</span> = skill

    def get_descriptions(self) -&gt; str:
        ifnot self.skills:
            return"(no skills available)"

        return"\n".join(
            f"- {name}: {skill<span class="hljs-section">['description']</span>}"
            for name, skill in self.skills.items()
        )

    def get_skill_content(self, name: str) -&gt; str:
        if name notin self.skills:
            returnNone

        <span class="hljs-attr">skill</span> = self.skills[name]
        <span class="hljs-attr">content</span> = f<span class="hljs-string">"# Skill: {skill['name']}\n\n{skill['body']}"</span>

        <span class="hljs-attr">resources</span> = []
        for folder, label in <span class="hljs-section">[
            ("scripts", "Scripts"),
            ("references", "References"),
            ("assets", "Assets")
        ]</span>:
            <span class="hljs-attr">folder_path</span> = skill[<span class="hljs-string">"dir"</span>] / folder
            if folder_path.exists():
                <span class="hljs-attr">files</span> = list(folder_path.glob(<span class="hljs-string">"*"</span>))
                if files:
                    resources.append(f"{label}: {', '.join(f.name for f in files)}")

        if resources:
            content += f"\n\n**Available resources in {skill<span class="hljs-section">['dir']</span>}:**\n"
            content += "\n".join(f"- {r}"for r in resources)

        return content

    def list_skills(self) -&gt; list:
        return list(self.skills.keys())


<span class="hljs-attr">SKILLS</span> = SkillLoader(SKILLS_DIR)
<span class="hljs-attr">TODO</span> = TodoManager()

<span class="hljs-attr">SYSTEM</span> = f<span class="hljs-string">"""你是一个位于 {WORKDIR} 的编码代理，系统为 {sys.platform}。

## 执行流程
计划（使用 TodoWrite） -&gt; 使用工具行动 -&gt; 报告。

**可用技能**（当任务匹配时使用 Skill 工具调用）：
{SKILLS.get_descriptions()}

**可用子代理**（对于需要集中注意力的子任务，使用 Task 工具调用）：
{get_agent_descriptions()}

规则：
- 当任务匹配技能描述时，**立即**使用 Skill 工具
- 对需要集中探索或实现的子任务使用 Task 工具
- 使用 TodoWrite 跟踪多步骤工作
- 优先使用工具而不是文字描述。先行动，不要只是解释。
- 完成后，总结变更内容。"""</span>

<span class="hljs-comment"># NEW in v4: Skill tool</span>
<span class="hljs-attr">SKILL_TOOL</span> = {
    "name": "Skill",
    "description": f"""Load a skill to gain specialized knowledge for a task.

Available skills:
{SKILLS.get_descriptions()}

When to use:
- IMMEDIATELY when user task matches a skill description
- Before attempting domain-specific work (PDF, MCP, etc.)

The skill content will be injected into the conversation, giving you
detailed instructions and access to resources.""",
    "input_schema": {
        "type": "object",
        "properties": {
            "skill": {
                "type": "string",
                "description": "Name of the skill to load"
            }
        },
        "required": <span class="hljs-section">["skill"]</span>,
    },
}

<span class="hljs-attr">ALL_TOOLS</span> = SUBAGENT_ALL_TOOLS + [SKILL_TOOL]
<span class="hljs-attr">max_steps</span> = <span class="hljs-number">50</span>

def get_tools_for_agent(agent_type: str) -&gt; list:
    <span class="hljs-attr">allowed</span> = AGENT_TYPES.get(agent_type, {}).get(<span class="hljs-string">"tools"</span>, <span class="hljs-string">"*"</span>)

    if <span class="hljs-attr">allowed</span> == <span class="hljs-string">"*"</span>:
        return BASE_TOOLS  <span class="hljs-comment"># All base tools, but NOT Task (no recursion in demo)</span>

    return <span class="hljs-section">[t for t in BASE_TOOLS if t["name"]</span> in allowed]

def run_subagent_task(description: str, prompt: str, agent_type: str, max_steps: <span class="hljs-attr">int</span> = max_steps) -&gt; str:
    if agent_type notin AGENT_TYPES:
        returnf"Error: Unknown agent type '{agent_type}'"

    <span class="hljs-attr">config</span> = AGENT_TYPES[agent_type]

    <span class="hljs-attr">sub_system</span> = f<span class="hljs-string">"""你是一个位于 {WORKDIR} 的 {agent_type} 子代理，系统为 {sys.platform}。

{config["prompt"]}

完成任务并返回清晰、简洁的总结。"""</span>

    <span class="hljs-attr">sub_tools</span> = get_tools_for_agent(agent_type)
    <span class="hljs-attr">sub_messages</span> = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: sub_system}, {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}]

    logger.info(f"      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> {description}")
    <span class="hljs-attr">start</span> = time.time()
    <span class="hljs-attr">tool_count</span> = <span class="hljs-number">0</span>

    <span class="hljs-attr">step</span> = <span class="hljs-number">0</span>
    while step &lt; max_steps:
        step += 1
        <span class="hljs-attr">response</span> = client.chat_with_tools(
            <span class="hljs-attr">prompt</span>=<span class="hljs-string">''</span>,
            <span class="hljs-attr">messages</span>=sub_messages,
            <span class="hljs-attr">tools</span>=sub_tools,
        )

        <span class="hljs-attr">assistant_text</span> = []
        <span class="hljs-attr">tool_calls</span> = []

        for block in response.content:
            if hasattr(block, "text"):
                assistant_text.append(block.text)
                logger.info(f"      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> {block.text}")
            if <span class="hljs-attr">block.type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        <span class="hljs-attr">full_text</span> = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            logger.info(f"      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> 第 {step} 步结束，无工具调用")
            break

        <span class="hljs-attr">results</span> = []

        for tc in tool_calls:
            tool_count += 1
            <span class="hljs-attr">output</span> = execute_tool(tc.name, tc.input)
            results.append(f"      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> 工具 {tc.name}, 输入: {tc.input}, 返回: {output}")
            <span class="hljs-attr">elapsed</span> = time.time() - start
            sys.stdout.write(
                f"\r      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> {description} ... {tool_count} tools, {elapsed:.1f}s\n"
            )
            sys.stdout.flush()

        sub_messages.append({"role": "assistant", "content": full_text})
        <span class="hljs-attr">combined_output</span> = <span class="hljs-string">"\n"</span>.join(results)
        sub_messages.append({"role": "user", "content": f"子代理执行结果：\n{combined_output}\n\n请继续处理"})

    <span class="hljs-attr">elapsed</span> = time.time() - start
    sys.stdout.write(
        f"\r      <span class="hljs-section">[子代理]</span><span class="hljs-section">[{agent_type}]</span> {description} - done ({tool_count} tools, {elapsed:.1f}s)\n"
    )

    for block in response.content:
        if hasattr(block, "text"):
            return full_text

    return"(subagent returned no text)"

def run_skill(skill_name: str) -&gt; str:
    """
    加载一项技能并将其注入到对话中。

    这是关键机制：
    1. 获取技能内容（SKILL.md 正文 + 资源提示）
    2. 将其包装在 &lt;skill-loaded&gt; 标签中返回
    3. 模型作为 tool_result（用户消息）接收此内容
    4. 模型现在"知道"如何执行任务

    为什么使用 tool_result 而不是系统提示词？
    - 系统提示词更改会使缓存失效（成本增加 20-50 倍）
    - 工具结果追加到末尾（前缀不变，缓存命中）

    这就是生产系统保持成本效益的方式。
    """
    <span class="hljs-attr">content</span> = SKILLS.get_skill_content(skill_name)

    if content isNone:
        <span class="hljs-attr">available</span> = <span class="hljs-string">", "</span>.join(SKILLS.list_skills()) or<span class="hljs-string">"none"</span>
        returnf"Error: Unknown skill '{skill_name}'. Available: {available}"

    <span class="hljs-comment"># Wrap in tags so model knows it's skill content</span>
    returnf"""&lt;skill-loaded <span class="hljs-attr">name</span>=<span class="hljs-string">"{skill_name}"</span>&gt;
{content}
&lt;/skill-loaded&gt;

Follow the instructions in the skill above to complete the user's task."""

def execute_tool(name: str, args: dict) -&gt; str:
    <span class="hljs-attr">result</span> = execute_base_tools(name, args)
    if result isnotNone:
        return result

    if <span class="hljs-attr">name</span> == <span class="hljs-string">"TodoWrite"</span>:
        try:
            return TODO.update(args<span class="hljs-section">["items"]</span>)
        except Exception as e:
            returnf"Error: {e}"

    if <span class="hljs-attr">name</span> == <span class="hljs-string">"Task"</span>:
        try:
            return run_subagent_task(args<span class="hljs-section">["description"]</span>, args<span class="hljs-section">["prompt"]</span>, args<span class="hljs-section">["agent_type"]</span>)
        except Exception as e:
            returnf"Error: {e}"

    if <span class="hljs-attr">name</span> == <span class="hljs-string">"Skill"</span>:
        try:
            return run_skill(args<span class="hljs-section">["skill"]</span>)
        except Exception as e:
            returnf"Error: {e}"

    returnf"Unknown tool: {name}"

def agent_loop(prompt: str, history: list, max_steps: <span class="hljs-attr">int</span> = max_steps) -&gt; list:
    <span class="hljs-comment"># 检查历史记录中是否已有系统提示词（作为系统消息）</span>
    <span class="hljs-attr">has_system</span> = any(msg.get(<span class="hljs-string">"role"</span>) == <span class="hljs-string">"system"</span>for msg in history)
    ifnot has_system:
        <span class="hljs-comment"># 在开头添加系统提示词作为系统消息</span>
        history.insert(0, {"role": "system", "content": SYSTEM})

    <span class="hljs-attr">step</span> = <span class="hljs-number">0</span>
    while step &lt; max_steps:
        step += 1
        <span class="hljs-attr">response</span> = client.chat_with_tools(
            <span class="hljs-attr">prompt</span>=prompt,
            <span class="hljs-attr">messages</span>=history,
            <span class="hljs-attr">tools</span>=ALL_TOOLS,
        )

        <span class="hljs-attr">assistant_text</span> = []
        <span class="hljs-attr">tool_calls</span> = []

        for block in response.content:
            if hasattr(block, "text"):
                assistant_text.append(block.text)
                logger.info(block.text)
            if <span class="hljs-attr">block.type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_calls.append(block)

        <span class="hljs-attr">full_text</span> = <span class="hljs-string">"\n"</span>.join(assistant_text)
        ifnot tool_calls:
            history.append({"role": "assistant", "content": full_text})
            logger.info(f"第 {step} 步结束，无工具调用")
            return history

        <span class="hljs-attr">results</span> = []
        for tc in tool_calls:
            if <span class="hljs-attr">tc.name</span> == <span class="hljs-string">"Task"</span>:
                logger.info(f"\n&gt; <span class="hljs-section">[使用工具]</span> Task 第 {step} 步调用: {tc.input.get('description', 'subtask')}")
            elif <span class="hljs-attr">tc.name</span> == <span class="hljs-string">"Skill"</span>:
                logger.info(f"\n&gt; <span class="hljs-section">[使用工具]</span> 第 {step} 步调用 Loading skill: {tc.input.get('skill', '?')}")
            else:
                logger.info(f"\n&gt; <span class="hljs-section">[使用工具]</span> {tc.name} 第 {step} 步调用: {tc.input}")

            <span class="hljs-attr">output</span> = execute_tool(tc.name, tc.input)

            if <span class="hljs-attr">tc.name</span> == <span class="hljs-string">"Skill"</span>:
                logger.info(f"  Skill loaded ({len(output)} chars)")
            elif tc.name != "Task":
                <span class="hljs-attr">preview</span> = output[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span>if len(output) &gt; <span class="hljs-number">200</span>else output
                logger.info(f"  <span class="hljs-section">[使用工具]</span> {tc.name}, 返回: {preview}")

            results.append(f"工具 {tc.name}, 输入: {tc.input}, 返回: {output}")

        history.append({"role": "assistant", "content": full_text})
        <span class="hljs-attr">combined_output</span> = <span class="hljs-string">"\n"</span>.join(results)
        history.append({"role": "user", "content": f"执行结果：\n{combined_output}\n\n请继续处理"})

def main():
    logger.info(f"Mini Claude Code v4 (with Skills) - {WORKDIR}")
    logger.info(f"Skills: {', '.join(SKILLS.list_skills()) or 'none'}")
    logger.info(f"Agent types: {', '.join(AGENT_TYPES.keys())}")
    logger.info("Type 'exit' to quit.\n")

    <span class="hljs-attr">history</span> = []

    whileTrue:
        try:
            <span class="hljs-attr">user_input</span> = input(<span class="hljs-string">"You: "</span>).strip()
        except (EOFError, KeyboardInterrupt):
            break

        ifnot user_input or user_input.lower() in ("exit", "quit", "q"):
            break

        history.append({"role": "user", "content": user_input})

        try:
            agent_loop('', history, <span class="hljs-attr">max_steps</span>=max_steps)
        except Exception as e:
            logger.error(f"Error: {e}")
            traceback.print_exc()

if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-35">7 总结</h2>
<p>本文通过使用 <code>deepseek-v3.2</code> 最常用的模型，通过不断规则+工具，实现最小版本的 <code>Claude Code</code>（后续功能继续完善中），代码开源地址：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/linkxzhou</span><span class="hljs-regexp">/mylib/tree</span><span class="hljs-regexp">/master/llm</span><span class="hljs-regexp">/llmapi/miniagent</span>
</code></pre>
<h2 data-id="heading-36">参考</h2>
<p>（1）<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FshareAI-lab%2Flearn-claude-code" target="_blank" title="https://github.com/shareAI-lab/learn-claude-code" ref="nofollow noopener noreferrer">github.com/shareAI-lab…</a><br/>
（2）<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flinkxzhou%2FSimpleExcalidraw" target="_blank" title="https://github.com/linkxzhou/SimpleExcalidraw" ref="nofollow noopener noreferrer">github.com/linkxzhou/S…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[断网、弱网、关页都不怕：前端日志上报怎么做到不丢包]]></title>    <link>https://juejin.cn/post/7596247009815412762</link>    <guid>https://juejin.cn/post/7596247009815412762</guid>    <pubDate>2026-01-19T06:22:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596247009815412762" data-draft-id="7595842144906936370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="断网、弱网、关页都不怕：前端日志上报怎么做到不丢包"/> <meta itemprop="keywords" content="前端,JavaScript,监控"/> <meta itemprop="datePublished" content="2026-01-19T06:22:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不一样的少年_"/> <meta itemprop="url" content="https://juejin.cn/user/3035079961218551"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            断网、弱网、关页都不怕：前端日志上报怎么做到不丢包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035079961218551/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不一样的少年_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T06:22:27.000Z" title="Mon Jan 19 2026 06:22:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    35
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>系列回顾（性能·错误·埋点三部曲）：<a href="https://juejin.cn/column/7581619505585209395" target="_blank" title="https://juejin.cn/column/7581619505585209395">不做工具人｜从 0 到 1 手搓前端监控 SDK</a></p>
<p>在前三篇文章中，我们搞定了性能、行为和错误的采集。但有掘友在评论区灵魂发问：<strong>“数据是抓到了，
发不出去有啥用？进电梯断网了咋办？页面关太快请求被掐了咋办？”</strong></p>
<p>今天这篇，我们就来聊聊<strong>如何上报数据</strong>？</p>
<ul>
<li>用什么方式上报最稳、最省事?</li>
<li>什么时候上报最合适?</li>
<li>遇到断网/弱网/关页怎么兜底?</li>
</ul>
</blockquote>
<h2 data-id="heading-0">一、上报方式与策略：如何选出最优解？</h2>
<p>我们平时上报数据主要有三种方式：<strong>Image（图片请求）</strong>、<strong>sendBeacon</strong> 和 <strong>XHR/Fetch</strong>。</p>
<h3 data-id="heading-1"><strong>1. 三种上报方式详解</strong></h3>
<h4 data-id="heading-2"><strong>1. GIF/Image</strong></h4>
<p>这招就是利用图片请求（<code>new Image().src</code>）来传数据。</p>
<ul>
<li>
<p><strong>原理很简单</strong>：把要上报的数据拼在 URL 后面（如 <code>https://log.demo.com/gif?id=123</code>），浏览器发起请求，服务器解析参数拿到数据，然后返回一张 1×1 的透明GIF图（体积小、看不见），浏览器收到后触发 <code>onload</code> 回调即完成上报。</p>
</li>
<li>
<p><strong>特点</strong>：天然支持跨域，<strong>绝无“预检”请求</strong>（因为是简单请求）。</p>
</li>
<li>
<p><strong>局限</strong>：只能发 GET 请求，URL 长度有限（通常 &lt; 2KB），无法携带大数据。</p>
</li>
</ul>
<h4 data-id="heading-3"><strong>2. sendBeacon</strong></h4>
<ul>
<li>
<p><strong>原理</strong>：<code>navigator.sendBeacon(url, data)</code>。浏览器会将数据放入后台队列，<strong>即使页面关闭了，浏览器也会尽力发送</strong>。</p>
</li>
<li>
<p><strong>特点</strong>：异步非阻塞（不卡主线程），且<strong>可靠性极高</strong>。</p>
</li>
<li>
<p><strong>局限</strong>：数据量有限（约 64KB），且无法自定义复杂的请求头。</p>
</li>
</ul>
<h4 data-id="heading-4"><strong>3. XHR / Fetch</strong></h4>
<p>普通的网络请求。</p>
<ul>
<li>
<p><strong>原理</strong>：使用 <code>XMLHttpRequest</code> 或 <code>fetch</code> 发送 POST 请求。</p>
</li>
<li>
<p><strong>特点</strong>：<strong>容量极大</strong>（几兆都没问题），适合发送录屏、长堆栈。</p>
</li>
<li>
<p><strong>局限</strong>：跨域时通常会触发 <code>OPTIONS</code> 预检（成本高），且页面关闭时请求容易被掐断（fetch需配合 <code>keepalive</code>）。</p>
</li>
</ul>
<p><code>注</code>: 所谓的预检，就是浏览器在发送<strong>跨域且非简单请求</strong>前，先偷偷发个 <code>OPTIONS</code> 问服务器：“大佬，我能发这个请求吗？”。只要你用了自定义 Header 或 <code>application/json</code> 就会触发。这会导致请求量直接翻倍，在弱网下多一次往返就多一分失败的风险。</p>
<h3 data-id="heading-5"><strong>2. 策略篇：如何组合使用？</strong></h3>
<p>怎么选并不是随意决定的，而是为了解决两个核心痛点：</p>
<ol>
<li>
<p><strong>成本问题（CORS 预检）</strong>：所谓的预检，就是浏览器在发送<strong>跨域且非简单请求</strong>前，先偷偷发个 <code>OPTIONS</code> 问服务器：“大佬，我能发这个请求吗？”。</p>
<ul>
<li><strong>什么时候触发？</strong> 只要你用了自定义 Header（如 <code>X-Token</code>）或者 <code>Content-Type: application/json</code>，就会触发。</li>
<li><strong>后果是啥？</strong> 请求量直接翻倍，弱网下成功率腰斩。</li>
<li><strong>避坑指南</strong>：这也是为什么很多监控SDK通常都故意使用 <code>text/plain</code> 来发送 JSON 数据。虽然数据格式是 JSON，但告诉浏览器“这是纯文本”，就能骗过预检，直接发送！</li>
</ul>
</li>
<li>
<p><strong>存活问题（页面卸载）</strong>：用户关闭页面时，浏览器通常会直接掐断挂起的异步请求，导致“临终遗言”发不出去。</p>
</li>
</ol>
<p>基于这两个维度，我们将三种方式排个序，也就形成了我们的<strong>降级策略</strong>：</p>
<h3 data-id="heading-6"><strong>1. 首选方案：sendBeacon（六边形战士）</strong></h3>
<p><strong>这是现代浏览器的首选方案</strong>。</p>
<ul>
<li><strong>优势</strong>：专为监控设计，<strong>页面关闭了也能发</strong>（浏览器将其放入后台队列）。</li>
<li><strong>特点</strong>：容量适中（~64KB），且通常不触发预检，完美平衡了“存活”与“成本”。</li>
<li><strong>适用</strong>：绝大多数监控事件。</li>
</ul>
<h3 data-id="heading-7"><strong>2. 降级方案：GIF/Image（老牌救星）</strong></h3>
<p><strong>当 <code>sendBeacon</code> 不可用（如 IE）或数据极小的时候用它。</strong></p>
<ul>
<li><strong>优势</strong>：<strong>天然跨域，绝无预检</strong>。利用 <code>new Image().src</code> 发起请求，服务器返回一张 1x1 透明图即可。</li>
<li><strong>特点</strong>：兼容性无敌，但数据量受 URL 长度限制（~2KB），且页面关闭时发送成功率低。</li>
<li><strong>适用</strong>：PV、点击、心跳等轻量指标。</li>
</ul>
<h3 data-id="heading-8"><strong>3. 兜底方案：XHR / Fetch</strong></h3>
<p><strong>只有前两招搞不定时（数据量太大）才用它。</strong></p>
<ul>
<li><strong>优势</strong>：容量极大，适合传录屏、大段错误堆栈。</li>
<li><strong>劣势</strong>：跨域麻烦（需配 CORS），有预检成本。</li>
<li><strong>注意</strong>：使用 Fetch 时务必加 <code>keepalive: true</code>，告诉浏览器“就算页面关了也别杀我”，尽量提升卸载时的成功率。</li>
</ul>
<h3 data-id="heading-9"><strong>选型对比表</strong></h3>





































<table><thead><tr><th align="left">方案</th><th align="left">跨域/预检</th><th align="left">卸载可靠性</th><th align="left">数据容量</th><th align="left">核心优势</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left"><strong>sendBeacon</strong></td><td align="left">支持 / <strong>无预检</strong></td><td align="left"><strong>高</strong></td><td align="left">中 (~64KB)</td><td align="left"><strong>关页也能发</strong>，不占主线程</td><td align="left"><strong>首选</strong>，大多数监控事件</td></tr><tr><td align="left"><strong>GIF/Image</strong></td><td align="left">支持 / <strong>无预检</strong></td><td align="left">低</td><td align="left">小 (~2KB)</td><td align="left">兼容性强，无预检</td><td align="left">降级方案，PV/点击/心跳</td></tr><tr><td align="left"><strong>XHR/Fetch</strong></td><td align="left">需 CORS / 有</td><td align="left">低</td><td align="left"><strong>大</strong></td><td align="left">能传大数据</td><td align="left">错误堆栈、录屏</td></tr></tbody></table>
<hr/>
<p><strong>总结我们的代码套路（降级策略）：</strong></p>
<ol>
<li><strong>小包（&lt; 2KB，单条事件）</strong>：优先 <code>sendBeacon</code>；若不支持，再走 <code>Image</code> GET（附 <code>_ts</code> 防缓存）。</li>
<li><strong>中包（≤ 64KB）</strong>：<code>sendBeacon</code> 为首选；若不支持，回退到 <code>Fetch/XHR</code>，<code>Content-Type: text/plain</code> + <code>keepalive: true</code>。</li>
<li><strong>大包（&gt; 64KB）</strong>：<code>Fetch/XHR</code> 承载，必要时拆包分批发送。</li>
</ol>
<p>下面是封装好的 <code>transport</code>上报函数，直接拿去用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">REPORT_URL</span> = <span class="hljs-string">'https://log.your-domain.com/collect'</span>; 
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_URL_LENGTH</span> = <span class="hljs-number">2048</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_BEACON_BYTES</span> = <span class="hljs-number">64</span> * <span class="hljs-number">1024</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">byteLen</span>(<span class="hljs-params">s</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>().<span class="hljs-title function_">encode</span>(s).<span class="hljs-property">length</span>;
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> s.<span class="hljs-property">length</span>;
  }
}

<span class="hljs-comment">/**
 * 通用上报函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object|Array</span>} <span class="hljs-variable">data</span> - 上报数据
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;void&gt;</span>} - 成功 resolve，失败 reject
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">transport</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> isArray = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(data);
  <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 1. 优先尝试 sendBeacon</span>
    <span class="hljs-comment">// 注意：sendBeacon 是同步入队，返回 true 仅代表入队成功，不一定是发送成功</span>
    <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">sendBeacon</span> &amp;&amp; <span class="hljs-title function_">byteLen</span>(json) &lt;= <span class="hljs-variable constant_">MAX_BEACON_BYTES</span>) {
      <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([json], { <span class="hljs-attr">type</span>: <span class="hljs-string">'text/plain'</span> });
      <span class="hljs-comment">// 如果入队成功，直接 resolve（乐观策略）</span>
      <span class="hljs-keyword">if</span> (navigator.<span class="hljs-title function_">sendBeacon</span>(<span class="hljs-variable constant_">REPORT_URL</span>, blob)) {
        <span class="hljs-title function_">resolve</span>();
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-comment">// 如果入队失败（如队列已满），不 reject，而是继续往下走降级方案</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[Beacon] 入队失败，尝试降级...'</span>);
    }

    <span class="hljs-comment">// 2. 单条小数据尝试 Image (GET)</span>
    <span class="hljs-keyword">if</span> (!isArray) {
      <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(data);
      params.<span class="hljs-title function_">append</span>(<span class="hljs-string">'_ts'</span>, <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()));
      <span class="hljs-keyword">const</span> qs = params.<span class="hljs-title function_">toString</span>();
      <span class="hljs-keyword">const</span> sep = <span class="hljs-variable constant_">REPORT_URL</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'?'</span>) ? <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">'?'</span>;
      
      <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">REPORT_URL</span>.<span class="hljs-property">length</span> + sep.<span class="hljs-property">length</span> + qs.<span class="hljs-property">length</span> &lt; <span class="hljs-variable constant_">MAX_URL_LENGTH</span>) {
        <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
        img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(); <span class="hljs-comment">// 成功</span>
        img.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Image 上报失败'</span>)); <span class="hljs-comment">// 失败</span>
        img.<span class="hljs-property">src</span> = <span class="hljs-variable constant_">REPORT_URL</span> + sep + qs;
        <span class="hljs-keyword">return</span>;
      }
    }

    <span class="hljs-comment">// 3. 兜底方案：Fetch &gt; XHR</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span>) {
      <span class="hljs-title function_">fetch</span>(<span class="hljs-variable constant_">REPORT_URL</span>, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span> },
        <span class="hljs-attr">body</span>: json,
        <span class="hljs-attr">keepalive</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 关键：允许页面关闭后继续发送</span>
      })
        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (res.<span class="hljs-property">ok</span>) <span class="hljs-title function_">resolve</span>();
          <span class="hljs-keyword">else</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Fetch 失败: <span class="hljs-subst">${res.status}</span>`</span>));
        })
        .<span class="hljs-title function_">catch</span>(reject);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// IE 兼容</span>
      <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
      xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-variable constant_">REPORT_URL</span>, <span class="hljs-literal">true</span>);
      xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain'</span>);
      xhr.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) <span class="hljs-title function_">resolve</span>();
        <span class="hljs-keyword">else</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`XHR 失败: <span class="hljs-subst">${xhr.status}</span>`</span>));
      };
      xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'XHR 网络错误'</span>));
      xhr.<span class="hljs-title function_">send</span>(json);
    }
  });
}
</code></pre>
<h2 data-id="heading-10">二、上报时机：不阻塞主线程干扰业务，断网了也不丢数据</h2>
<h3 data-id="heading-11">1. 调度层：区分优先级，关键时刻不等待</h3>
<p>不是所有数据都适合“攒着发”。我们需要根据重要程度将日志分为两类：</p>
<ul>
<li>
<p><strong>即时上报（Immediate）</strong>：收集到立即上报。</p>
<ul>
<li><strong>场景</strong>：JS 报错阻断了流程、用户点击了“支付”按钮、接口返回 500 等。</li>
<li><strong>原因</strong>：这些数据对实时性要求极高，或者关系到监控系统的报警（比如线上白屏了，你得马上知道），不能因为攒着发而耽误了。</li>
</ul>
</li>
<li>
<p><strong>批量上报（Batch）</strong>：攒一波再发。</p>
<ul>
<li><strong>场景</strong>：用户点击、滚动、性能指标、API 成功日志。这类数据量大但实时性要求低</li>
<li><strong>策略</strong>：<strong>“量”与“时”双重触发（竞态关系）</strong>。比如：攒够 10 条立马发（防止堆积太多），或者每隔 5 秒发一次（防止数量不够一直不发）。</li>
</ul>
</li>
</ul>
<p>代码怎么写？其实就是一个简单的<strong>双保险调度器</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> queue = [];
<span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">QUEUE_MAX</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">QUEUE_WAIT</span> = <span class="hljs-number">5000</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flush</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (!queue.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-comment">// 1. 把当前队列的数据复制出来</span>
  <span class="hljs-keyword">const</span> batch = queue.<span class="hljs-title function_">slice</span>();
  
  <span class="hljs-comment">// 2. 清空队列与定时器</span>
  queue.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">clearTimeout</span>(timer);
  timer = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 3. 利用空闲时间发送（性能优化点）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'requestIdleCallback'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
    <span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">transport</span>(batch), { <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span> });
  } <span class="hljs-keyword">else</span> {
     <span class="hljs-comment">// 降级兼容</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">transport</span>(batch), <span class="hljs-number">0</span>);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">report</span>(<span class="hljs-params">log, immediate = <span class="hljs-literal">false</span></span>) {
  <span class="hljs-comment">// 1. 紧急情况：绕过队列，直接发</span>
  <span class="hljs-keyword">if</span> (immediate) {
    <span class="hljs-title function_">transport</span>(log);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 2. 普通情况：进入队列（如 点击、PV）</span>
  queue.<span class="hljs-title function_">push</span>({ ...log, <span class="hljs-attr">ts</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() });
  
  <span class="hljs-comment">// 3. 检查触发条件（双重保险）</span>
  <span class="hljs-keyword">if</span> (queue.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable constant_">QUEUE_MAX</span>) {
    <span class="hljs-title function_">flush</span>();
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!timer) {
    timer = <span class="hljs-built_in">setTimeout</span>(flush, <span class="hljs-variable constant_">QUEUE_WAIT</span>);
  }
}

<span class="hljs-comment">// 4. 临终兜底：页面关闭/隐藏时，强制把剩下的都发走</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> === <span class="hljs-string">'hidden'</span>) <span class="hljs-title function_">flush</span>();
});
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'pagehide'</span>, flush);
</code></pre>
<p><strong>整体思路：队列暂存 + 多重触发</strong></p>
<p>我们用一个数组（<code>queue</code>）来暂存日志，然后通过 <strong>“量够了”、“时间到了”或“页面要关了”</strong> 这三个时机来触发发送，确保既不积压也不频繁打扰服务器。</p>
<p><strong>性能优化：闲时优先</strong></p>
<p>发送时，我们首选 <code>requestIdleCallback</code>。告诉浏览器你先忙你的（渲染、响应点击），等你有空了再帮我发监控数据</p>
<ul>
<li>这样能最大限度减少对业务主线程的阻塞，让用户感觉不到监控的存在。</li>
<li>当然，如果浏览器不支持这个 API，我们再降级用 <code>setTimeout</code> 兜底。</li>
</ul>
<h3 data-id="heading-12">2. 容灾层：断网了，日志怎么办？</h3>
<p>如果在电梯里断网了或者弱网环境下，请求发不出去怎么办？日志丢了怎么办。
我们的策略是 <strong>“先记在本子上，等有网了再补交作业”</strong>：</p>
<ol>
<li><strong>断网时</strong>：把日志存到 <code>localStorage</code> 里（注意设置上限，别把用户浏览器撑爆了，可用IndexedDB优化）。</li>
<li><strong>连网时</strong>：监听 <code>online</code> 事件，把存的日志拿出来，<strong>分批</strong>发给服务器（别一次性全发过去，容易把后端打挂）。</li>
</ol>
<p><strong>具体怎么判断有没有网呢？</strong></p>
<p>通常我们用 navigator.onLine 来看。如果返回值是 false ，那肯定是没网，直接存本地。</p>
<p>但坑就坑在，这玩意儿有时候会 “撒谎” —— 比如连上了酒店 WiFi 但没登录，或者宽带欠费了。这时候它虽然显示 true （在线），但其实根本上不了网。</p>
<p>所以咱们得留一手：
哪怕它说“在线”，我们也先试着上报一下。 要是报错了发不出去，别管三七二十一，先把这条日志存本地保底（千万别丢数据），然后再去 Ping 一下看看到底是不是真断网了 ，顺便更新一下网络状态。这样最稳。</p>
<h4 data-id="heading-13"><strong>1. 网络状态的检测</strong></h4>
<p>NetworkManager这个模块专门负责盯着网络，它很聪明，只有在发送日志失败的时候才会去复核网络真伪。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">NetworkManager</span> = {
  <span class="hljs-attr">online</span>: navigator.<span class="hljs-property">onLine</span>,
  
  <span class="hljs-comment">// 初始化：盯着系统的 online/offline 事件</span>
  <span class="hljs-title function_">init</span>(<span class="hljs-params">onBackOnline</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'online'</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-comment">// 别高兴太早，先看看是不是真的能上网</span>
      <span class="hljs-keyword">const</span> realWait = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">verify</span>();
      <span class="hljs-keyword">if</span> (realWait) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">online</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-title function_">onBackOnline</span>(); <span class="hljs-comment">// 真的回网了，赶紧补传！</span>
      }
    });
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'offline'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">online</span> = <span class="hljs-literal">false</span>);
  },

  <span class="hljs-comment">// “测谎仪”：发个 HEAD 请求看看</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 请求个 favicon 或者 1x1 图片，只要响应了说明网通了</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/favicon.ico'</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">'HEAD'</span>, <span class="hljs-attr">cache</span>: <span class="hljs-string">'no-store'</span> });
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
};
</code></pre>
<h4 data-id="heading-14">2. 核心上报：能发就发，不行就存本地</h4>
<p>上报函数现在变得非常有弹性。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">reportData</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-comment">// 1. 如果明确知道没网，直接存本地 (省一次请求)</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">NetworkManager</span>.<span class="hljs-property">online</span>) {
    <span class="hljs-title function_">saveToLocal</span>(data);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 2. 尝试发送</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">transport</span>(data);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'上报请求失败:'</span>, err);
    
    <span class="hljs-comment">// 3. 不管是因为断网、超时、还是服务器挂了</span>
    <span class="hljs-comment">// 只要没成功，第一件事就是存本地！保证这条日志不丢！</span>
    <span class="hljs-title function_">saveToLocal</span>(data);

    <span class="hljs-comment">// 4. 然后再来诊断网络，决定后续策略</span>
    <span class="hljs-comment">// 只有当是网络层面的错误（如 fetch throw Error）才去怀疑网络</span>
    <span class="hljs-comment">// 如果是 500 错误，其实网是通的，不用 forceOffline</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isNetworkError</span>(err)) {
       <span class="hljs-comment">// 5. Ping 确认</span>
        <span class="hljs-title class_">NetworkManager</span>.<span class="hljs-title function_">verify</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-title class_">NetworkManager</span>.<span class="hljs-property">online</span> = res);
    }
  }
}

<span class="hljs-comment">/**
 * 判断是否为网络层面的错误
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isNetworkError</span>(<span class="hljs-params">err</span>) {
  <span class="hljs-comment">// 原生 fetch 的网络错误通常是 TypeError: Failed to fetch</span>
  <span class="hljs-comment">// 如果是使用 Axios，则可以通过 !err.response 来判断</span>
  <span class="hljs-keyword">return</span> err <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">TypeError</span> || (err.<span class="hljs-property">request</span> &amp;&amp; !err.<span class="hljs-property">response</span>);
}

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">RETRY_KEY</span> = <span class="hljs-string">'RETRY_LOGS'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">RETRY_MAX_ITEMS</span> = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveToLocal</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> raws = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">RETRY_KEY</span>);
  <span class="hljs-keyword">const</span> logs = raws ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(raws) : [];
  logs.<span class="hljs-title function_">push</span>(data);
  <span class="hljs-keyword">if</span> (logs.<span class="hljs-property">length</span> &gt; <span class="hljs-variable constant_">RETRY_MAX_ITEMS</span>) {
    logs.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, logs.<span class="hljs-property">length</span> - <span class="hljs-variable constant_">RETRY_MAX_ITEMS</span>);
  }
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">RETRY_KEY</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(logs));
}
</code></pre>
<h4 data-id="heading-15"><strong>3. 补传逻辑：别把服务器干崩了</strong></h4>
<p>等到网络恢复，本地攒了一堆“欠账”，千万别一股脑儿全发过去（万一本地存了 500 条，一次全发会把服务器打爆的）。</p>
<p>我们要<strong>有节奏</strong>地补传：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">flushLogs</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> logs = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'RETRY_LOGS'</span>) || <span class="hljs-string">'[]'</span>);
  <span class="hljs-keyword">if</span> (!logs.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[回血] 发现 <span class="hljs-subst">${logs.length}</span> 条欠账，开始补传...`</span>);

  <span class="hljs-keyword">while</span> (logs.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 1. 每次只取 5 条，小碎步走</span>
    <span class="hljs-keyword">const</span> batch = logs.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 2. 调用上报中心</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">transport</span>(batch); 
      
      <span class="hljs-comment">// 3. 只有成功了，才把这 5 条从 logs 里剔除</span>
      logs.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">RETRY_LOGS</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(logs));
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-comment">// 4. 如果失败了（断网或服务器挂了）</span>
      <span class="hljs-comment">// 此时 logs 里面还保留着那 5 条数据，所以不用担心丢失</span>
      <span class="hljs-comment">// 记录一下状态，直接跳出循环，等下次 NetworkManager 唤醒</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'补传中途失败，保留剩余欠账'</span>);
      <span class="hljs-keyword">break</span>; 
    }
    
    <span class="hljs-comment">// 2. 歇半秒钟，给正常业务请求让个道</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(r, <span class="hljs-number">500</span>));
  }
}
</code></pre>
<h2 data-id="heading-16">三、总结与实战建议</h2>
<p>监控上报这事儿看着不难，其实门道不少。要在<strong>数据不丢</strong>和<strong>不打扰用户</strong>之间找平衡，咱们得来一套“组合拳”：</p>
<ol>
<li><strong>上报方式</strong>：<strong>sendBeacon 为主，Image 为辅，XHR/Fetch 兜底</strong>。利用 <code>sendBeacon</code> 的特性解决页面卸载时的丢包问题，利用 <code>Image</code> 解决跨域预检的成本问题。</li>
<li><strong>上报时机</strong>：<strong>闲时上报 + 批量打包</strong>。利用 <code>requestIdleCallback</code> 不占用主线程，通过队列机制减少 HTTP 请求频次。</li>
<li><strong>断网处理</strong>：<strong>本地缓存 + 网络侦测</strong>。断网时将数据持久化到 LocalStorage，待网络恢复后分批补传，确保“一条都不丢”。</li>
</ol>
<p><strong>最后，给开发者的 3 个避坑小贴士：</strong></p>
<ul>
<li><strong>不要迷信 <code>navigator.onLine</code></strong>：它只能判断有没有连接到局域网，不能判断是否真的能上网。一定要配合实际的请求探测。</li>
<li><strong>控制补传节奏</strong>：网络恢复后，千万别一次性把积压的几百条日志全发出去，这属于“DDoS 攻击”自家服务器。要分批、甚至加随机延迟发送。</li>
<li><strong>隐私与合规</strong>：上报数据前，务必对敏感信息（如 Token、用户手机号）进行脱敏处理，这是红线。</li>
</ul>
<p>如果你有更好的思路，欢迎在评论区交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[征程 6 H/P 工具链 QAT 精度调优]]></title>    <link>https://juejin.cn/post/7596983314806865970</link>    <guid>https://juejin.cn/post/7596983314806865970</guid>    <pubDate>2026-01-20T04:08:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596983314806865970" data-draft-id="7596890557547118638" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="征程 6 H/P 工具链 QAT 精度调优"/> <meta itemprop="keywords" content="算法,自动驾驶"/> <meta itemprop="datePublished" content="2026-01-20T04:08:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            征程 6 H/P 工具链 QAT 精度调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:08:13.000Z" title="Tue Jan 20 2026 04:08:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、QAT 调优流程</h2>
<p><strong>流程总览：</strong></p>
<blockquote>
<p>针对征程 6H/P 的硬件特性，以 int8+int16+fp16 的混合精度量化为主要调优配置，会增加较多的 fp16 设置来优化量化精度</p>
</blockquote>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=YTkwY2NjYTc2NDM3Y2VhZmY2NzQ1ZjMwZTVkMWNlYThfZndxWlIxd1ZMdDBYWGZIN0NhWXhZV0lZNjRIUlc0Q3lfVG9rZW46UXBDbmJmQmROb2xvRkN4dFp5cWNBdExQblVnXzE3Njg4ODAzMjI6MTc2ODg4MzkyMl9WNA" alt="" loading="lazy"/></p>
<p>注意：</p>
<p>征程 6H/P 上会用到更多 fp16 高精度和 GEMM 类算子双 int16 等的配置，为了配置方式更加简单灵活，QAT 量化工具提供了一套新的 qconfig 量化配置模板，具体使用方式和注意事项参考：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13112" target="_blank" title="https://developer.horizon.auto/blog/13112" ref="nofollow noopener noreferrer">【地平线 J6 工具链入门教程】QAT 新版 qconfig 量化模板使用教程</a></p>
<p><strong>调优原则：</strong></p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ZThlNGZmMTliZDc2MGMwZmVkYmQwNmEwOTcwZTM1NjVfNUttTzRwbXF4cjhWM0EzMnVUR3VhdGV2SERpenhLblhfVG9rZW46QXFoamI5bUpwb2VhNEN4dWVNNGM4Q1I1bk5jXzE3Njg4ODAzMjI6MTc2ODg4MzkyMl9WNA" alt="" loading="lazy"/></p>
<p>如上是一个标准的对称量化公式，产生误差的地方主要有：</p>
<ol>
<li>round 产生的舍入误差。例如：当采用 int8 量化，scale 为 0.0078 时，浮点数值 0.0157 对应的定点值为 round（0.0157 / 0.0078） = round（2.0128） = 2，浮点数值 0.0185 对应的定点值为 round（0.0185 / 0.0078） = round（2.3718） = 2，两者均产生了舍入误差，且由于舍入误差的存在，两者的定点值一致。 对于舍入误差，可以使用更小的 scale，这样可以使得单个定点值对应的浮点值范围变小。由于直接减小 scale 会导致截断误差，所以常用的方法是使用更高的精度类型，比如：将 int8 换成 int16，由于定点值范围变大， scale 将减小。</li>
<li>clamp 产生的截断误差。当 qmax * scale 无法覆盖需要量化的数值范围时，可能产生较大截断误差。例如：当采用 int8 量化，scale 为 0.0078 时，qmax * scale = 127 * 0.0078 = 0.9906，大于 0.9906 的值对应的定点值将被截断到 127。 对于截断误差，可以使用更大的 scale。scale 一般是由量化工具使用统计方法得到，scale 偏小的原因是校准数据不够全，校准方法不对，导致 scale 统计的不合理。比如：某一输入的理论范围为 [-1， 1]，但校准或 qat 过程中，没有观测到最大值为 1 或最小值为 -1 的样本或观测到此类样本的次数太少。应该增加此类数据或者根据数值范围，手动设置固定 scale。在截断误差不大的情况下，可以调整校准参数，通过不同的校准方法和超参缓解截断误差。</li>
</ol>
<p>因此，QAT 量化精度调优以减少上述两种误差为基本原则，下文将针对 QAT 每个阶段做调优介绍：</p>
<p>注意：</p>
<p>征程 6H/P 平台的浮点模型量化友好设计以及 QAT 模型改造等内容和征程 6E/M 一致，仍可参考该文章对应章节：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13132" target="_blank" title="https://developer.horizon.auto/blog/13132" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度调优</a></p>
<h3 data-id="heading-1">1.1 模型检查</h3>
<p>完成模型改造和量化配置后，调用 Prepare 接口时会对模型做算子支持和量化配置上的检查，这些检查一定程度上反映了模型量化存在的问题。对于不支持的算子将以报错的形式提醒用户，一般有两种情况：</p>
<ol>
<li>未正确进行模型的量化改造。Prepare 过程中 QAT 量化工具会对模型进行 trace 来获取完整的计算图，在这个过程中会完成算子替换等的优化，对于这些已替换的算子，输入输出类型如果是 torch.tensor 而非经过 QuantStub 转化后的 qtensor，则会触发不支持算子的报错，表现为 <code>xxx is not implemented for QTensor</code>；</li>
<li>确实存在不支持的算子。工具链已支持业界大量的常用算子，但对于部分非常见算子的不支持情况，需考虑进行算子替换或者作为算子需求向工具链团队导入。</li>
</ol>
<p>Prepare 运行成功后会在当前目录下自动保存模型检查文件 <code>model_check_result.txt</code> 和 <code>fx_graph.txt</code>，建议参考下列解读顺序：</p>
<ol>
<li>算子融合检查。算子融合作为 QAT 量化工具的标准优化手段，常见的融合组合为 Conv+ReLU+BN 和 Conv+Add 等，未融合的算子会在 txt 文件中给出，未按预期融合的算子可能是因为共享没有融合成功或者是 QAT 量化工具的融合逻辑变更（针对新版 qconfig 量化模板 enable_optimize=True 情况，见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13112" target="_blank" title="https://developer.horizon.auto/blog/13112" ref="nofollow noopener noreferrer">【地平线 J6 工具链入门教程】QAT 新版 qconfig 量化模板使用教程</a>），需要检查代码，确认未融合的情况是否符合预期：</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain"># 示例：未融合的Conv+Add算子
Fusable modules are listed below:
name       type------  -------------------------
model.view_transformation.input_proj.0.0(shared) 
&lt;class'horizon_plugin_pytorch.nn.qat.conv2d.Conv2d'&gt;
model.view_transformation._generated_add_0        
&lt;class'horizon_plugin_pytorch.nn.qat.functional_modules.FloatFunctional'&gt;
</code></pre>
<p>未融合的算子对模型性能会有一定影响，对于精度的影响需视量化敏感度具体分析，一般来说，Conv/Linear+ReLU+BN 可能会因为算子复用导致未融合，此时建议手动修改融合；在 OE 3.5.0 以及之后版本使用新 qconfig 模板下，Conv+Add 默认不会融合，可不修改</p>
<ol start="2">
<li>共享模块检查。一个 module 只有一组量化参数，多次使用将会共享同一组量化参数，多次数据分布差异较大时，会产生较大误差：</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain"># 示例：该共享模块被调用8次
Each module called times:
name      called times
---------  --------------   
...
model.map_head.sparse_head.decoder.gen_sineembed_for_position.div.reciprocal                          
8
</code></pre>
<p>called times &gt; 1 的模块可能有很多个，全部改写成非共享是一劳永逸的。对于修改简单且精度影响大的共享算子如 QuantStub，强烈建议取消共享；对于 DeQuantStub 算子，共享不会对模型精度产生影响，但是会影响 Debug 结果的分析，也建议取消共享，修改方式参考征程 6E/M“模型改造”章节。</p>
<p>例如下面的共享模块，量化表示的最大值为 128 * 0.0446799 ≈ 5.719，在第一次使用中，输出范围明显小于 [-5.719， 5.719]，误差较小， 第二次使用中，输出范围超出 [-5.719， 5.719]，数值被截断，产生了较大误差。两次数值范围的差异也造成了统计出的 scale 不准确，因此该共享模块必须修改</p>
<pre><code class="hljs language-Plain" lang="Plain">+-+-+-+-+-+-+--+-+-+-+-+|   | mod_name | base_op_type   | analy_op_type  | shape  | quant_dtype |  qscale |base_model_min | analy_model_min | base_model_max |   analy_model_max ||-+-+--+-+-+-+-+-+-+-+-+...| 1227 | model.map_head.sparse_head.decoder.gen_sineembed_for_position.div | horizon_plugin_pytorch.nn.div.Div  | horizon_plugin_pytorch.nn.qat.functional_modules.FloatFunctional.mul  | torch.Size([1, 1600, 128])| qint8  |  0.0446799 | 0.0002146 | 0.0000000 | 4.5935526 |  4.5567998 |...| 1520 | model.map_head.sparse_head.decoder.gen_sineembed_for_position.div | horizon_plugin_pytorch.nn.div.Div  | horizon_plugin_pytorch.nn.qat.functional_modules.FloatFunctional.mul | torch.Size([1, 1600, 128]) | qint8 |  0.0446799 | 0.0000000 | 0.0000000 |  6.2831225 |  5.7190272 |...
</code></pre>
<p>上面共享算子的修改方式可以参考：</p>
<pre><code class="hljs language-Plain" lang="Plain">class Model(nn.Module):def __init__(self, ) -&gt; None:super().__init__()...
        self.steps = 2for step in range(self.steps):setattr(self, f'div{step}', FloatFunctional())def forward(self, data):...for step in range(self.steps):
            data = getattr(self, f'div{step}').div(x)...
</code></pre>
<p>对于不带权重的 function 类算子都可以参考上面的拆分方式，但是也存在部分共享算子或模块带有权重参数拆分起来比较复杂，是否需要拆分建议先根据量化敏感度进行分析。带有权重参数算子拆分时需要复制权重，拆分方式可以参考：</p>
<pre><code class="hljs language-Plain" lang="Plain">class Model(nn.Module):def __init__(self, ) -&gt; None:super().__init__()...
        self.steps = 3
        self.conv0 = nn.Conv2d(...)
        shared_weight = self.conv0.weight
        shared_bias = self.conv0.bias
        for step in range(1, self.steps):setattr(self, f'conv{step}', nn.Conv2d(...))getattr(self, f'conv{step}').weight = shared_weight
            getattr(self, f'conv{step}').bias = shared_bias
  
    def forward(self, data):...for step in range(self.steps):
            data = getattr(self, f'conv{step}')(x)...
</code></pre>
<p>上述共享算子修改生效后，在 <code>model_check_result.txt</code> 文件中可见到无该算子共享相关的信息：</p>
<pre><code class="hljs language-Plain" lang="Plain"># 修改生效后下面信息将不再显示
Modules below are used multi times:
name      called times
------  --------------
xxxxx                2
</code></pre>
<p>此外，未调用的模块也会在文件中体现，<code>called times</code> 为 0，当 Calibration/QAT/模型导出出现 miss_key 时，可以检查模型中是否有模块未被 trace。</p>
<ol start="3">
<li>量化配置检查。txt 文件中会给出模型量化精度的统计信息：</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain"># 算子输入量化精度统计input dtype statistics:+---+--+--+--+| module type                                                                |   torch.float32 |   qint8 |   qint16 ||---+---+--+--+| &lt;class 'horizon_plugin_pytorch.nn.qat.stubs.QuantStub'&gt;                    |             290 |      15 |        0 || &lt;class 'horizon_plugin_pytorch.nn.qat.linear.Linear'&gt;                      |               5 |     117 |        9 || &lt;class 'horizon_plugin_pytorch.nn.qat.stubs.DeQuantStub'&gt;                  |               0 |       8 |        0 |...# 算子输出量化精度统计
output dtype statistics:+---+--+--+--+| module type                                                                |   torch.float32 |   qint8 |   qint16 ||---+--+--+--+| &lt;class 'horizon_plugin_pytorch.nn.qat.stubs.QuantStub'&gt;                    |               0 |     123 |      182 |...# 使用fp16量化精度的算子，量化精度统计+---+--+--+--+--+| module type                                                                |   torch.float32 |   qint8 |   qint16 |   torch.float16 ||-----+--+--+--+--|| &lt;class 'horizon_plugin_pytorch.nn.qat.stubs.QuantStub'&gt;                    |              34 |       0 |        0 |               0 || &lt;class 'torch.nn.modules.padding.ZeroPad2d'&gt;                               |               0 |      11 |        0 |               0 || &lt;class 'horizon_plugin_pytorch.nn.qat.functional_modules.FloatFunctional'&gt; |              48 |      14 |        9 |              50 |...
</code></pre>
<p>重点检查的信息有：</p>
<ul>
<li><code>&lt;class 'horizon_plugin_pytorch.nn.qat.stubs.QuantStub'&gt;</code> 的 input dtype 应为 <code>torch.float32</code>，对于 <code>qint8</code> 或者 <code>qint16</code> 的 input dtype，一般是冗余的 QuantStub 算子可以改掉，不会对精度产生影响但可能会对部署模型性能有影响（算子数量）</li>
<li>正常来说模型中的算子不应出现 <code>torch.float32</code> 的输入精度（除下文 c 情况），如上图的 <code>&lt;class 'horizon_plugin_pytorch.nn.qat.linear.Linear'&gt;</code>，需要检查是否漏插 <code>QuantStub</code> 未转定点，未转定点的算子在导出部署模型时会 cpu 计算从而影响模型性能。对于模型中的一些浮点常量 tensor，工具已支持自动插入 <code>QuantStub</code> 转定点，建议获取最新版本</li>
<li>对于 GEMM 类算子（Conv/Matmul/Linear）作为模型输出时支持高精度输出（征程 6E/M 支持 int32 输出，征程 6B/H/P 支持浮点输出），体现到这里则是 <code>&lt;class 'horizon_plugin_pytorch.nn.qat.stubs.DeQuantStub'&gt;</code> 的 input dtype 应为 <code>torch.float16</code> 或 <code>torch.float32</code>，对于 <code>qint8</code> 或 <code>qint16</code> 输入的 <code>DeQuantStub</code> 需要检查是否符合高精度输出的条件，符合条件但未高精度输出的需修改。此外对于下面左图的结构，也建议优化为右图结构来保证高精度输出的优化</li>
</ul>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NTk5YTA4YzdhOGVkNzJkMGQ4MGE5ZWMzMjRlMmE5NmVfSmdBVU95N1ZkQktYd3BsZktXaEhUS3o4VHlNamZlTVlfVG9rZW46RGZEb2Jka2dzbzBPclN4bVl2WWNZTWlRbldBXzE3Njg4ODAzMjI6MTc2ODg4MzkyMl9WNA" alt="" loading="lazy"/></p>
<ul>
<li>qint8 和 qint16 算子的占比，可以协助判断是否配置全 int16 生效；torch.float16 算子的占比，可以协助判断是否配置 fp16 生效</li>
</ul>
<p>txt 文件同时会给出逐层的量化配置信息：</p>
<pre><code class="hljs language-Plain" lang="Plain"># 激活逐层qconfig
Each layer out qconfig:+--+--+--+--+--+--+| Module Name| Module Type | Input dtype | out dtype | ch_axis | observer ||--+--+--+--+--+---|# 固定scale| quant | &lt;class 'horizon_plugin_pytorch.nn.qat.stubs.QuantStub'&gt;                    | [torch.float32] | ['qint16']| -1  | FixedScaleObserver(scale=tensor([3.0518e-05], device='cuda:0'),zero_point=tensor([0], device='cuda:0')) |# QAT训练激活scale更新| mod2.1.attn.q | &lt;class 'horizon_plugin_pytorch.nn.qat.conv2d.Conv2d'&gt;  | ['qint16']  | ['qint16'] | -1 | MinMaxObserver(averaging_constant=0.01) |# QAT训练激活scale不更新| mod2.1.FFN.out_conv.1.0| &lt;class 'horizon_plugin_pytorch.nn.qat.conv2d.Conv2d'&gt; | ['qint16']| ['qint16']| -1| MinMaxObserver(averaging_constant=0)  |# 激活fp16 qconfig| bev_fusion.multi_view_cross_attn.32.global_cross_window_attn._generated_add_2[add]| &lt;class 'horizon_plugin_pytorch.nn.qat.functional_modules.FloatFunctional'&gt; | [torch.float16, torch.float32]                     | [torch.float16] | FakeCast(dtype=torch.float16, min_val=-0.0009765625, max_val=0.0009765625)  | |# 权重逐层qconfig
Weight qconfig:+-----+----+-----+------+---+| Module Name | Module Type | weight dtype|ch_axis|observer ||---+-------+----+----+---|| mod1.0 | &lt;class 'horizon_plugin_pytorch.nn.qat.conv2d.Conv2d'&gt; |qint8 | 0 | MinMaxObserver(averaging_constant=0.01) |
</code></pre>
<p>重点检查的信息有：</p>
<ul>
<li>每层算子的输入输出 dtype、权重的 dtype，是否符合量化配置；若和量化配置不符合，比如配置了 int16，但是算子显示为 int8，则需要关注下算子回退信息，例如在旧模板下 Conv+Add 融合时 Conv 不支持 int16 输入，会导致前序算子输出回退到 int8。新的 qconfig 量化配置模板下算子回退过程需查看 qconfig_changelogs.txt，详细参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13112" target="_blank" title="https://developer.horizon.auto/blog/13112" ref="nofollow noopener noreferrer">developer.horizon.auto/blog/13112</a></li>
<li>配置了 fix scale 的算子，是否正确显示 FixedScaleObserver 信息，scale 值是否正确</li>
<li>逐层算子的 observer 是否正确：权重默认 MinMaxObserver，QAT 校准时激活默认 MSEObserver，QAT 训练时激活默认 MinMaxObserver</li>
<li>若为 QAT 训练阶段且配置了固定校准的激活 scale，查看 averaging_constant，判断是否生效，生效为 averaging_constant=0（即不更新 scale），默认为 0.01（更新 scale）</li>
</ul>
<p>对于 <code>fx_graph.txt</code>，可以从中获取到模型中 op/module 的上下游调用关系，例如当存在算子 <code>called times</code> 为 0 未被调用的情况，可以通过 Graph 定位到上下文算子从而定位未被调用的原因（通常因为在 init 函数中定义了但在 forward 中没有调用，也可能存在逻辑判断或循环次数变化的情况）；此外当出现导出的部署模型（bc 模型）精度异常，也可以通过 Graph 信息来排查是否是导出计算图改变导致的</p>
<pre><code class="hljs language-Plain" lang="Plain"># 模型Graph图结构信息
Graph:
opcode       name        target            args           kwargs
----         -----       -------           -------        -------
placeholder    input_0    input_0              ()         {}
call_module    quant       quant            (input_0,)     {}
call_module  traj_decoder_src_proj_0_0  traj_decoder_src_proj.0.0                                             (quant,)  {}
call_function  scope_end    &lt;function Tracer.scope_end at 0x7f4477d7dc60&gt;   ('traj_decoder_src_proj.0',) {}
call_function  __get__    &lt;method-wrapper '__get__' of getset_descriptor object at 0x7f460922b800&gt;  (traj_decoder_src_proj_0_0,) {}
call_function  __getitem__       &lt;slot wrapper '__getitem__' of 'torch.Size' objects&gt;     (__get__, 0)   {}
call_function  __getitem___1      &lt;slot wrapper '__getitem__' of 'torch.Size' objects&gt;   (__get__, 1)  {}
call_function  __getitem___2     &lt;slot wrapper '__getitem__' of 'torch.Size' objects&gt;   (__get__, 2)   {}
call_function  __getitem___3      &lt;slot wrapper '__getitem__' of 'torch.Size' objects&gt;   (__get__, 3) {}
call_function  permute     &lt;method 'permute' of 'torch._C.TensorBase' objects&gt;   (traj_decoder_src_proj_0_0, 0, 2, 3, 1)  {}...
</code></pre>
<p>重点关注的 Graph 信息：</p>
<ul>
<li><code>opcode</code> 为算子调用类型</li>
<li><code>name</code> 为当前算子名称，需注意和 <code>model_check_result.txt</code> 中的 <code>module.submodule</code> 名称区别</li>
<li><code>target</code> 为算子输出</li>
<li><code>args</code> 为算子输入</li>
</ul>
<h3 data-id="heading-2">1.2 QAT 校准</h3>
<h4 data-id="heading-3">1.2.1 int8+int16+fp16 混合精度调优</h4>
<blockquote>
<p>如果模型中吸收了前后处理的相关算子和操作，这部分默认需要 fp16 精度进行量化</p>
</blockquote>
<p>对于 int8+int16+fp16 混合精度而言，主要的量化配置如下（配置方式参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13112" target="_blank" title="https://developer.horizon.auto/blog/13112" ref="nofollow noopener noreferrer">【地平线 J6 工具链入门教程】QAT 新版 qconfig 量化模板使用教程</a>）：</p>
<ul>
<li>基础配置： TAE 算子（Conv/Matmul/Linear）双 int8、其他算子 fp16</li>
<li>精度优化配置： TAE 算子（Conv/Matmul/Linear）单 int16（部分双 int16）、其他算子 fp16</li>
<li>精度上限配置： TAE 算子（Conv/Matmul/Linear）双 int16、其他算子 fp16</li>
<li>性能上限配置： 全局 int8，建议仅在测试模型最优性能（精度无保证）或作为高精度耗时优化的对比参考时配置</li>
</ul>
<p>同样的对于较难量化的模型而言，初始应使用精度上限配置，在这个配置下解决量化流程可能的问题，优化量化风险较大的算子/模块，往往通过 Debug 工具进行定位，但在使用 Debug 工具较难定位到量化瓶颈时，可以使用分步量化的小技巧（参考本文最后章节"调优技巧"），也即对选中算子取消量化后对比精度，如定位到前后处理的算子/模块产生明显掉点，建议从模型中剥离；定位到模型中算子/模块，可以使用设置 fix_scale 和拆分共享模块等方式，或者从量化友好角度修改浮点模型（参考征程 6E/M 量化调优对应章节：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13132" target="_blank" title="https://developer.horizon.auto/blog/13132" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度调优</a>）</p>
<p>精度上限配置下的模型较难满足部署侧的延时要求，因此解决掉上述的量化瓶颈后需要回归到基础配置。在基础配置上通过敏感度的分析结果，增加 TAE 的 int16 算子，也就是精度优化配置。在基础配置和精度优化配置下精度达标的模型，视延时情况可能需要进一步做性能优化，主要方向为：</p>
<ol>
<li>基础配置下，回退 fp16 性能瓶颈算子到低精度 int8</li>
<li>精度优化配置下，回退双 int16 的 TAE 算子到单 int16，回退 fp16 性能瓶颈算子到低精度 int8</li>
</ol>
<p>精度优化配置下如果 int16 算子比例已超出部署预期但精度仍有一定差距，则可以考虑回退部分 int16 算子后尝试 QAT 训练；基础配置下精度表现距离浮点差距较小（<code>量化精度/浮点精度 &gt; 90%</code>，经验值），直接尝试 QAT 训练，在 <code>量化精度/浮点精度 &gt;= 95%</code>（经验值）的情况下，建议优先尝试固定校准激活 scale 的 QAT 训练（仅调整权重感知量化误差）</p>
<p>对于不同精度配置下的 QAT 校准，都有一些校准超参可以调整，需要用户结合具体模型去做调参优化，其中主要的参数有校准数据的 batch size、校准的 steps，详细的参数参考：</p>
<ol>
<li>基础调优手段：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fplugin%2Fuser_guide%2Fprecision_tuning.html%23calibration" target="_blank" title="https://docs.oe.horizon.auto/guide/plugin/user_guide/precision_tuning.html#calibration" ref="nofollow noopener noreferrer">调优指南_基础调优手段</a></li>
<li>高级调优手段：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fplugin%2Fuser_guide%2Fprecision_tuning.html%23calibration-1" target="_blank" title="https://docs.oe.horizon.auto/guide/plugin/user_guide/precision_tuning.html#calibration-1" ref="nofollow noopener noreferrer">调优指南_高级调优手段</a></li>
</ol>
<p>由于征程 6H/P 平台使用了较多浮点 FP16 精度，该精度下数值范围超限场景有以下常见的优化方法和优缺点总结：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ed34b77baab4e5c8e3a263def883ae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw5bmz57q_5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486893&amp;x-signature=e1GXEwkjTnUs1dAoQo85Vh%2F0fZ4%3D" alt="image.png" loading="lazy"/></p>
<p>总结：</p>
<p>int8+int16+fp16 混合精度调优的重点应放在 TAE 双 int16+ 其他算子 fp16 的调优上，这里需要把使用问题，量化不友好模块等等各种千奇百怪的问题都解决，看到模型的精度上限，然后根据模型部署的性能要求进行 TAE int8 和 int16 混合精度的调优，最后对非 TAE 算子进行 int8+fp16 混合精度的调优，最终达成部署精度和部署性能的平衡。</p>
<h4 data-id="heading-4">1.2.2 Debug 产出物解读</h4>
<p>征程 6H/P 平台 Debug 产出物的解读和征程 6E/M 一致，仍可参考该文章对应章节：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13132" target="_blank" title="https://developer.horizon.auto/blog/13132" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度调优</a></p>
<h6 data-id="heading-5">Badcase 调优</h6>
<p>对于实车或回灌反馈的可视化 badcase，利用 Debug 工具的调优流程为：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmY5MGIxMzk0ZTY0NWFiYzMyMTdhMzEzOTc4YzgzNzVfUGRNZ3RCNjVJdURRNlVoQThCdmlNWlM3QjdPYjZORXBfVG9rZW46Ujd2amJxUWJGb2phbEx4TmNZYmN5c2VwbmllXzE3Njg4ODAzMjI6MTc2ODg4MzkyMl9WNA" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">1.3 QAT 训练</h3>
<p>大部分模型仅通过 QAT 校准就可以获得较好的量化精度，对于部分较难调优的模型，以及还需要继续优化误差类指标的模型，通常校准设置的高精度比例导致延时超过部署上限，但精度仍无法达标，这种情况可以尝试 QAT 训练来获得满足预期性能-精度平衡的量化模型。</p>
<p>根据前文所述，在 QAT 校准 <code>量化精度/浮点精度 &gt;= 95%（经验值）</code> 的情况下，充分利用校准阶段较好的激活量化参数，优先尝试固定校准激活 scale 的 QAT 训练（仅调整权重感知量化误差），设置方式具体参考征程 6E/M 精度调优的“模型改造”章节：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13132" target="_blank" title="https://developer.horizon.auto/blog/13132" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度调优</a></p>
<p>参考浮点训练，QAT 训练在大部分配置保持和浮点训练一致的基础上，也涉及到部分超参的调整来提升量化训练的精度，例如 QAT 的学习率、weight_decay、迭代次数等，详细的参数调整策略参考：</p>
<ol>
<li>基础调优手段：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fplugin%2Fuser_guide%2Fprecision_tuning.html%23qat" target="_blank" title="https://docs.oe.horizon.auto/guide/plugin/user_guide/precision_tuning.html#qat" ref="nofollow noopener noreferrer">调优指南_基础调优手段</a></li>
<li>高级调优手段：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fplugin%2Fuser_guide%2Fprecision_tuning.html%23qat-1" target="_blank" title="https://docs.oe.horizon.auto/guide/plugin/user_guide/precision_tuning.html#qat-1" ref="nofollow noopener noreferrer">调优指南_高级调优手段</a></li>
</ol>
<p>浮点和 QAT 训练中都涉及到对 BN 的状态控制，在浮点训练中可能会采用 FreezeBN fine-tune 的方式来提升模型精度，在多任务训练中也会采用 FreezeBN 的技巧。因此在 QAT 训练中，提供了 FuseBN 和 WithBN 两种训练方式：</p>
<ol>
<li>FuseBN 即在 Prepare 后，QAT 训练前将 BN 的 weight 和 bias 吸收到 Conv 的 weight 和 bias 中，在训练过程中不再单独更新，这一吸收过程是无损的。FuseBN 也是 QAT 默认的训练方式。</li>
<li>WithBN 则是在 QAT 训练阶段保持 Conv+BN 不融合，带着 BN 进行训练，BN 的参数单独更新，在训练结束后转成部署模型时再做融合。浮点训练阶段如果采用了 FreezeBN 的训练方式，QAT 训练时需设置 WithBN 来对齐浮点训练方式，设置方式如下：</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain">from horizon_plugin_pytorch.qat_mode import QATMode, set_qat_mode
set_qat_mode(QATMode.WithBN)
</code></pre>
<p>通过观察 QAT 训练过程的 Loss 变化来初步判断 QAT 训练的量化效果，一般来说和浮点最后的 Loss 结果越接近越好，Loss 过大可能难以收敛，Loss 过小可能影响泛化性，对于异常的 Loss 建议的优化手段：</p>
<ol>
<li>异常 INF 和 NAN 的 Loss 值，或者初始 Loss 极大且无收敛迹象，按如下顺序排查：
<ol>
<li>去掉 prepare 模型的步骤，用 qat pipeline finetune 浮点模型，排除训练 pipeline 的问题，Loss 如果仍异常，需要检查训练链路的配置如优化器 optimizer 和 lr_updater 等</li>
<li>保持当前 QAT 训练配置，只关闭伪量化节点后观察训练的 Loss 现象，理论上和浮点有微小差异</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain">from horizon_plugin_pytorch.quantization import set_fake_quantize, FakeQuantState
...
set_fake_quantize(qat_model, FakeQuantState._FLOAT)
train(qat_model, qat_dataloader)
</code></pre>
<ol start="2">
<li>在排查完链路问题后出现初始 Loss 较大，有收敛迹象但收敛较慢，这种情况可以尝试调整学习率，延长 QAT 迭代次数，因为 QAT 训练本质上是对已收敛浮点模型的 fine-tune，本身存在一定的随机性，用较大的学习率可以快速波动到一个理想精度（依赖一些中间权重的评测）</li>
<li>对于少数模型，QAT 训练以及尝试了多次超参调整后精度仍无法达标，建议回归 QAT 校准阶段增加少量高精度算子（增加 GEMM 类算子 int16，以及其他算子增加 FP16）、回归浮点结构检查是否还存在量化不友好的结构如使用了大量 GeLU 等（参考征程 6E/M 精度调优对应章节<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13132" target="_blank" title="https://developer.horizon.auto/blog/13132" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度调优</a>）</li>
</ol>
<h4 data-id="heading-7">1.3.1 QAT 训练效率</h4>
<p>由于 QAT 训练过程需要感知模型量化所带来的损失，因此模型中会被插入必要的量化相关的节点：数据观测节点 Observer 和伪量化节点 FakeQuant。数据观测节点会不断统计模型中数据的数值范围，伪量化节点会根据量化公式对数据做模拟量化和反量化，两者都会存在开销，此外就是 QAT 工具内部会对部分算子例如 LN 层做拆分算子的实现，因此相同配置下的 QAT 训练效率是会略低于浮点训练效率，具体还和模型参数规模、算子数量等有关。</p>
<p>对于用户可明显感知到的 QAT 训练效率降低，建议的优化手段有：</p>
<ol>
<li>使用 QAT 工具提供的算子，这些算子优化了训练效率，例如 MultiScaleDeformableAttention（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fplugin%2Fplugin_api_reference%2Fhorizon_operator%2Fhorizon_plugin_pytorch_nn_MultiScaleDeformableAttention.html" target="_blank" title="https://docs.oe.horizon.auto/guide/plugin/plugin_api_reference/horizon_operator/horizon_plugin_pytorch_nn_MultiScaleDeformableAttention.html" ref="nofollow noopener noreferrer">参考手册</a> ）</li>
<li>更新到最新的 horizon-plugin-pytorch 版本，新版本会有持续的 bug fix 和新特性优化，如模型中某些结构或者算子训练耗时增加明显，可以向工具链团队导入</li>
</ol>
<h3 data-id="heading-8">1.4. 模型导出部署</h3>
<p>完成 QAT 精度调优后得到的模型仍是 PyTorch 模型，需要使用简单易用的接口来一步步导出编译成部署模型：<code>PyTorch模型 -&gt; export -&gt; convert-&gt; compile</code></p>
<blockquote>
<p>export 得到 qat.bc； convert 得到 quantized.bc； compile 得到 hbm</p>
</blockquote>
<p>由于导出生成物中计算差异的存在，对于每个生成物需简单验证其精度，可通过单张可视化或 mini 数据集，过程中如存在精度掉点，请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13149" target="_blank" title="https://developer.horizon.auto/blog/13149" ref="nofollow noopener noreferrer">【地平线 J6 工具链进阶教程】J6 E/M 工具链 QAT 精度一致性问题分析流程</a></p>
<h2 data-id="heading-9">二.调优技巧</h2>
<h3 data-id="heading-10">2.1 分部量化</h3>
<p>下面这种方式仅适用于 Calib 阶段，QAT 阶段因为模型已经适应了量化误差，关闭伪量化精度无法保证</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/955e4490db1e4319b48f2895eb21d48b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw5bmz57q_5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486893&amp;x-signature=AdzUU9SAbS1b%2FwfOf2rwzxTVvFw%3D" alt="aW1nX3YzXzAybmlfYjMwYjgwODYtOWFmNS00MmJmLTllMWYtMjVhNWMwNDE4MWRn.jpg" loading="lazy"/></p>
<pre><code class="hljs language-Plain" lang="Plain">from horizon_plugin_pytorch.utils.quant_switch import GlobalFakeQuantSwitch 
class Model(nn.Module):     
    def _init_(...):     
    def forward(self, x):         
        x = self.quant(x)         
        x = self.backbone(x)         
        x = self.neck(x)         
        GlobalFakeQuantSwitch.disable() # 使伪量化失效         # --------- float32 ---------         ​
        x = self.head(x)         
  
  

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python基础知识速刷]]></title>    <link>https://juejin.cn/post/7596955804260925490</link>    <guid>https://juejin.cn/post/7596955804260925490</guid>    <pubDate>2026-01-20T04:09:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596955804260925490" data-draft-id="7138936146792284190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python基础知识速刷"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-20T04:09:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="茫茫此生何所求"/> <meta itemprop="url" content="https://juejin.cn/user/465848663552974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python基础知识速刷
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848663552974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    茫茫此生何所求
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:09:09.000Z" title="Tue Jan 20 2026 04:09:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">import</h2>
<ul>
<li>import modulename 导入整个模块</li>
<li>from modulename import xx 从某个模块导入部分内容</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> keyword
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv,path
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> *
</code></pre>
<h2 data-id="heading-1">保留字</h2>
<p>python提供了keyword库，可以查看所有的保留字</p>
<pre><code class="hljs language-scss" lang="scss">import keyword
<span class="hljs-built_in">print</span>(keyword.kwlist)

<span class="hljs-selector-attr">[<span class="hljs-string">'False'</span>, <span class="hljs-string">'None'</span>, <span class="hljs-string">'True'</span>, <span class="hljs-string">'__peg_parser__'</span>, <span class="hljs-string">'and'</span>, <span class="hljs-string">'as'</span>, <span class="hljs-string">'assert'</span>, <span class="hljs-string">'async'</span>, <span class="hljs-string">'await'</span>, <span class="hljs-string">'break'</span>, <span class="hljs-string">'class'</span>, <span class="hljs-string">'continue'</span>, <span class="hljs-string">'def'</span>, <span class="hljs-string">'del'</span>, <span class="hljs-string">'elif'</span>, <span class="hljs-string">'else'</span>, <span class="hljs-string">'except'</span>, <span class="hljs-string">'finally'</span>, <span class="hljs-string">'for'</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'global'</span>, <span class="hljs-string">'if'</span>, <span class="hljs-string">'import'</span>, <span class="hljs-string">'in'</span>, <span class="hljs-string">'is'</span>, <span class="hljs-string">'lambda'</span>, <span class="hljs-string">'nonlocal'</span>, <span class="hljs-string">'not'</span>, <span class="hljs-string">'or'</span>, <span class="hljs-string">'pass'</span>, <span class="hljs-string">'raise'</span>, <span class="hljs-string">'return'</span>, <span class="hljs-string">'try'</span>, <span class="hljs-string">'while'</span>, <span class="hljs-string">'with'</span>, <span class="hljs-string">'yield'</span>]</span>
</code></pre>
<h2 data-id="heading-2">注释</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 单行注释 </span>

<span class="hljs-string">''' 
多行注释1
'''</span> 

<span class="hljs-string">""" 
多行注释2
"""</span>
</code></pre>
<h2 data-id="heading-3">行与缩进</h2>
<p>代码块使用缩进控制，而不是{}，缩进格数保持一致</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">if</span> xx:
    <span class="hljs-built_in">print</span> (<span class="hljs-string">"Answer"</span>)
    <span class="hljs-built_in">print</span> (<span class="hljs-string">"True"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span> (<span class="hljs-string">"Answer"</span>)
  <span class="hljs-built_in">print</span> (<span class="hljs-string">"False"</span>)    <span class="hljs-comment"># 缩进格数与上面不一致，运行错误</span>
</code></pre>
<h2 data-id="heading-4">多行语句</h2>
<p>一条语句如果太长，可以写成多行，行末用 \ 连接</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">y</span> = <span class="hljs-number">1</span> + \
    2 + \
    3
</code></pre>
<p>如果是[] {} ()三种括号，不用\连接，直接回车换行</p>
<h2 data-id="heading-5">控制台打印</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello, World!"</span>)
</code></pre>
<h2 data-id="heading-6">单行多语句</h2>
<p>在同一行写多条语句，用分好;隔开</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = <span class="hljs-number">1</span><span class="hljs-comment">; y = 2; z = '22'</span>
</code></pre>
<h2 data-id="heading-7">变量</h2>
<ul>
<li>变量不需要声明。每个变量在使用前都必须赋值，变量赋值以后该变量才会被创建</li>
<li>变量没有类型</li>
<li>等号（=）用来给变量赋值,等号（=）运算符左边是一个变量名,等号（=）运算符右边是存储在变量中的值</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
<span class="hljs-attr">y</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
<span class="hljs-attr">z</span> = <span class="hljs-string">'22'</span>
</code></pre>
<p>声明多个变量及赋值</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = y = z = <span class="hljs-number">1</span>
a,b,<span class="hljs-attr">c</span> = <span class="hljs-number">1</span>,<span class="hljs-string">'2'</span>,<span class="hljs-number">1.0</span>
</code></pre>
<p>del 删除对象引用</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = y = z = <span class="hljs-number">1</span>
del x,y
</code></pre>
<h2 data-id="heading-8">数据类型</h2>
<p>Python3 的六个标准数据类型中：</p>
<ul>
<li>不可变数据（3 个）：
<ul>
<li>Number（数字）</li>
<li>String（字符串）</li>
<li>Tuple（元组）；</li>
</ul>
</li>
<li>可变数据（3 个）：
<ul>
<li>List（列表）</li>
<li>Dictionary（字典）</li>
<li>Set（集合）。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-9">数字类型</h2>
<p>python中数字有四种类型：整数、布尔型、浮点数和复数</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = <span class="hljs-number">1</span>
<span class="hljs-attr">y</span> = <span class="hljs-number">1.0</span>
<span class="hljs-attr">z</span> = <span class="hljs-literal">True</span>  <span class="hljs-comment"># False,bool 是 int 的子类，True 和 False 可以和数字相加， True==1、False==0 会返回 **True**，但可以通过 is 来判断类型。</span>
<span class="hljs-attr">w</span> = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>j
</code></pre>
<p>数值运算</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>+<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>-<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>*<span class="hljs-number">3</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>/<span class="hljs-number">2</span>)  #  <span class="hljs-number">0.5</span>除法，得到小数
<span class="hljs-built_in">print</span>(<span class="hljs-number">1</span>//<span class="hljs-number">2</span>)  # <span class="hljs-number">0</span>   除法，取整，不四舍五入
<span class="hljs-built_in">print</span>(<span class="hljs-number">5%</span><span class="hljs-number">2</span>)  # <span class="hljs-number">1</span>  取余
<span class="hljs-built_in">print</span>(<span class="hljs-number">2</span>**<span class="hljs-number">3</span>)  # <span class="hljs-number">8</span>   指数
</code></pre>
<h2 data-id="heading-10">字符串类型</h2>
<p>中单引号 ' 和双引号 " 使用完全相同，但是要成对儿使用。
python中没有字符类型，单个字符也是字符串</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = <span class="hljs-string">'a'</span>
<span class="hljs-attr">y</span> = <span class="hljs-string">"b"</span>
<span class="hljs-attr">z</span> = x + y   <span class="hljs-comment"># ab，字符串连接</span>
<span class="hljs-attr">w</span> = x * <span class="hljs-number">3</span>   <span class="hljs-comment"># aaa，*表示重复几次</span>
</code></pre>
<p>字符串访问，索引：</p>
<ul>
<li>正向索引,从0开始  ：0,1,2,3,...,n-1</li>
<li>反向索引，从-1开始：-n,...,-4,-3,-2,-1</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">str</span> = <span class="hljs-string">'123456789'</span>

<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>)  <span class="hljs-comment"># 输出字符串</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>[<span class="hljs-number">0</span>:-<span class="hljs-number">1</span>])  <span class="hljs-comment"># 输出第一个到倒数第二个的所有字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>[<span class="hljs-number">0</span>])  <span class="hljs-comment"># 输出字符串第一个字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>[<span class="hljs-number">2</span>:<span class="hljs-number">5</span>])  <span class="hljs-comment"># 输出从第三个开始到第五个的字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>[<span class="hljs-number">2</span>:])  <span class="hljs-comment"># 输出从第三个开始后的所有字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>[<span class="hljs-number">1</span>:<span class="hljs-number">5</span>:<span class="hljs-number">2</span>])  <span class="hljs-comment"># 输出从第二个开始到第五个且每隔一个的字符（步长为2）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span> * <span class="hljs-number">2</span>)  <span class="hljs-comment"># 输出字符串两次</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'1'</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'1'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>)

</code></pre>
<p>转义字符</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">'hello\nrunoob'</span>)  <span class="hljs-comment"># 使用反斜杠()+n转义特殊字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">r'hello\nrunoob'</span>)  <span class="hljs-comment"># 在字符串前面添加一个 r，表示原始字符串，不会发生转义</span>

输出：
hello
runoob
hello\nrunoob
</code></pre>
<p>字符串格式化</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">print</span> (<span class="hljs-string">"我叫 %s 今年 %d 岁!"</span> % (<span class="hljs-string">'小明'</span>, <span class="hljs-number">10</span>))  <span class="hljs-comment"># 字符串格式化 </span>
</code></pre>
<ul>
<li>%c  格式化字符及其ASCII码</li>
<li>%s  格式化字符串</li>
<li>%d  格式化整数</li>
<li>%u  格式化无符号整型</li>
<li>%o  格式化无符号八进制数</li>
<li>%x  格式化无符号十六进制数</li>
<li>%X  格式化无符号十六进制数（大写）</li>
<li>%f  格式化浮点数字，可指定小数点后的精度</li>
<li>%e  用科学计数法格式化浮点数</li>
<li>%E  作用同%e，用科学计数法格式化浮点数</li>
<li>%g  %f和%e的简写</li>
<li>%G  %f 和 %E 的简写</li>
<li>%p  用十六进制数格式化变量的地址</li>
</ul>
<p>f-string</p>
<p>格式化字符串以 f 开头，后面跟着字符串，字符串中的表达式用大括号 {} 包起来，它会将变量或表达式计算后的值替换进去</p>
<pre><code class="hljs language-python" lang="python">name = <span class="hljs-string">"zhangs"</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"hello <span class="hljs-subst">{name}</span>"</span>)
</code></pre>
<p>字符串方法：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">name</span> = "<span class="hljs-selector-tag">ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>  "
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">capitalize</span>())  <span class="hljs-selector-id">#Ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cabc</span>,字符串第一个字符大写
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">center</span>(<span class="hljs-number">20</span>,<span class="hljs-string">"*"</span>))  #***<span class="hljs-selector-tag">ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>  ****,返回一个指定的宽度<span class="hljs-selector-tag">width</span>局中的字符串，第二个参数是填充的字符，不传默认空格
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">count</span>(<span class="hljs-string">"a"</span>,<span class="hljs-number">1</span>,<span class="hljs-number">7</span>))  <span class="hljs-selector-id">#1</span>,返回指定字符在字符串中出现的次数，第二三个参数用于指定范围
<span class="hljs-selector-tag">encode_name</span> = <span class="hljs-selector-tag">name</span><span class="hljs-selector-class">.encode</span>(<span class="hljs-string">"UTF-8"</span>)  #编码<span class="hljs-selector-tag">utf-8</span>
<span class="hljs-selector-tag">print</span>(encode_name)  # <span class="hljs-selector-tag">b</span>'<span class="hljs-selector-tag">ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>  '
<span class="hljs-selector-tag">print</span>(encode_name.<span class="hljs-built_in">decode</span>(<span class="hljs-string">"UTF-8"</span>,<span class="hljs-string">"strict"</span>))  <span class="hljs-selector-id">#ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>   用于解码
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">endswith</span>(<span class="hljs-string">"c"</span>,<span class="hljs-number">2</span>,<span class="hljs-number">7</span>))  <span class="hljs-selector-id">#False</span>  指定范围内，检测是否以指定字符结尾
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">startswith</span>(<span class="hljs-string">"c"</span>,<span class="hljs-number">2</span>,<span class="hljs-number">7</span>))  <span class="hljs-selector-id">#False</span>  检查字符串是否是以指定子字符串 <span class="hljs-selector-tag">substr</span> 开头，是则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>。如果<span class="hljs-selector-tag">beg</span> 和 <span class="hljs-selector-tag">end</span> 指定值，则在指定范围内检查。
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">expandtabs</span>(<span class="hljs-number">8</span>))  <span class="hljs-selector-id">#ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>  把字符串 <span class="hljs-selector-tag">string</span> 中的 <span class="hljs-selector-tag">tab</span> 符号转为空格，<span class="hljs-selector-tag">tab</span> 符号默认的空格数是 <span class="hljs-number">8</span> 。
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">find</span>(<span class="hljs-string">"c"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>))  <span class="hljs-selector-id">#3</span>  检测 <span class="hljs-selector-tag">str</span> 是否包含在字符串中，如果指定范围 <span class="hljs-selector-tag">beg</span> 和 <span class="hljs-selector-tag">end</span> ，则检查是否包含在指定范围内，如果包含返回开始的索引值，否则返回<span class="hljs-selector-tag">-1</span>
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">rfind</span>(<span class="hljs-string">"c"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>))  <span class="hljs-selector-id">#3</span>  类似于 <span class="hljs-selector-tag">find</span>()函数，不过是从右边开始查找.

<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">index</span>(<span class="hljs-string">"c"</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>))  <span class="hljs-selector-id">#3</span>  跟<span class="hljs-selector-tag">find</span>()方法一样，只不过如果<span class="hljs-selector-tag">str</span>不在字符串中会报一个异常。
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">rindex</span>(<span class="hljs-string">"c"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>))  <span class="hljs-selector-id">#7</span>  类似于 <span class="hljs-selector-tag">index</span>()，不过是从右边开始.
<span class="hljs-selector-tag">name1</span> = "<span class="hljs-number">124</span><span class="hljs-selector-tag">abc</span>"
<span class="hljs-selector-tag">print</span>(name1.<span class="hljs-built_in">isalnum</span>())  <span class="hljs-selector-id">#True</span>  如果字符串至少有一个字符并且所有字符都是字母或数字则返 回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>
<span class="hljs-selector-tag">name2</span> = "<span class="hljs-number">124</span>中问"
<span class="hljs-selector-tag">print</span>(name2.<span class="hljs-built_in">isalpha</span>())  <span class="hljs-selector-id">#False</span>  如果字符串至少有一个字符并且所有字符都是字母或中文字则返回 <span class="hljs-selector-tag">True</span>, 否则返回 <span class="hljs-selector-tag">False</span>
<span class="hljs-selector-tag">name3</span> = "<span class="hljs-number">124</span>"
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">isdigit</span>())  <span class="hljs-selector-id">#False</span>  如果字符串只包含数字则返回 <span class="hljs-selector-tag">True</span> 否则返回 <span class="hljs-selector-tag">False</span>..
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">islower</span>())  <span class="hljs-selector-id">#False</span>   如果字符串中包含至少一个区分大小写的字符，并且所有这些(区分大小写的)字符都是小写，则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">isnumeric</span>())  <span class="hljs-selector-id">#False</span>   如果字符串中只包含数字字符，则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>
<span class="hljs-selector-tag">name4</span> = "    "
<span class="hljs-selector-tag">print</span>(name4.<span class="hljs-built_in">isspace</span>())  <span class="hljs-selector-id">#True</span>  如果字符串中只包含空白，则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>.
<span class="hljs-selector-tag">name5</span> = "<span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">Is</span> <span class="hljs-selector-tag">Title</span>"
<span class="hljs-selector-tag">print</span>(name5.<span class="hljs-built_in">istitle</span>())  <span class="hljs-selector-id">#True</span>  如果字符串中所有的单词拼写首字母是否为大写，且其他字母为小写则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>.
<span class="hljs-selector-tag">name10</span> = "<span class="hljs-selector-tag">this</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">title</span>"
<span class="hljs-selector-tag">print</span>(name10.<span class="hljs-built_in">title</span>())  <span class="hljs-selector-id">#This</span> <span class="hljs-selector-tag">Is</span> <span class="hljs-selector-tag">Title</span>  返回"标题化"的字符串,就是说所有单词都是以大写开始，其余字母均为小写(见 <span class="hljs-built_in">istitle</span>())
<span class="hljs-selector-tag">name6</span> = "<span class="hljs-selector-tag">LISI</span>"
<span class="hljs-selector-tag">print</span>(name6.<span class="hljs-built_in">isupper</span>())  <span class="hljs-selector-id">#True</span>  如果字符串中包含至少一个区分大小写的字符，并且所有这些(区分大小写的)字符都是大写，则返回 <span class="hljs-selector-tag">True</span>，否则返回 <span class="hljs-selector-tag">False</span>
<span class="hljs-selector-tag">s1</span> = "<span class="hljs-selector-tag">-</span>"
<span class="hljs-selector-tag">s2</span> = ""
<span class="hljs-selector-tag">seq</span> = (<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>)  # 字符串序列
<span class="hljs-selector-tag">print</span>(s1.<span class="hljs-built_in">join</span>(seq))  # <span class="hljs-selector-tag">a</span><span class="hljs-selector-tag">-b-c-d</span>,返回通过指定字符连接序列中元素后生成的新字符串。
<span class="hljs-selector-tag">print</span>(s2.<span class="hljs-built_in">join</span>(seq))  # <span class="hljs-selector-tag">abcd</span>

<span class="hljs-selector-tag">print</span>(<span class="hljs-built_in">len</span>(name))  <span class="hljs-selector-id">#13</span>  返回字符串长度
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">ljust</span>(<span class="hljs-number">20</span>,<span class="hljs-string">"*"</span>))  <span class="hljs-selector-id">#ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>  *******    返回一个原字符串左对齐,并使用空格填充至指定长度的新字符串。如果指定的长度小于原字符串的长度则返回原字符串。
<span class="hljs-selector-tag">print</span>(name.<span class="hljs-built_in">rjust</span>(<span class="hljs-number">20</span>, <span class="hljs-string">"*"</span>))  #*******<span class="hljs-selector-tag">ab</span> <span class="hljs-selector-tag">cab</span> <span class="hljs-selector-tag">cABC</span>    返回一个原字符串右对齐,并使用<span class="hljs-selector-tag">fillchar</span>(默认空格）填充至长度 width 的新字符串
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">zfill</span>(<span class="hljs-number">20</span>))  #<span class="hljs-number">0000000</span>ab cab cABC    返回长度为 width 的字符串，原字符串右对齐，前面填充<span class="hljs-number">0</span>
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">lower</span>())  #ab cab cabc   返回将字符串中所有大写字符转换为小写后生成的字符串。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">upper</span>())  #AB CAB CABC   返回将字符串中所有小写字符转换为大写后生成的字符串。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">swapcase</span>())  #AB CAB Cabc   将字符串中大写转换为小写，小写转换为大写
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">lstrip</span>(<span class="hljs-string">" "</span>))  #ab cab cABC  截掉字符串左边的空格或指定字符。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">rstrip</span>(<span class="hljs-string">" "</span>))  #ab cab cABC  删除字符串末尾的空格或指定字符。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">strip</span>(<span class="hljs-string">" "</span>))   #ab cab cABC  在字符串上执行 <span class="hljs-built_in">lstrip</span>()和 <span class="hljs-built_in">rstrip</span>()
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">max</span>(name))  #c返回字符串中最大的字母
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">min</span>(name))  #   返回字符串中最小的字母
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">replace</span>(<span class="hljs-string">"a"</span>,<span class="hljs-string">"z"</span>,<span class="hljs-number">4</span>))  #zb czb cABC   把 将字符串中的 old 替换成 new,如果 max 指定，则替换不超过 max 次。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">split</span>(<span class="hljs-string">" "</span>,<span class="hljs-number">3</span>))  #[<span class="hljs-string">'ab'</span>, <span class="hljs-string">'cab'</span>, <span class="hljs-string">'cABC'</span>, <span class="hljs-string">' '</span>]  以 str 为分隔符截取字符串，如果 num 有指定值，则仅截取 num+<span class="hljs-number">1</span> 个子字符串
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">splitlines</span>())  #[<span class="hljs-string">'ab cab cABC  '</span>]  按照行(<span class="hljs-string">'\r'</span>, <span class="hljs-string">'\r\n'</span>, \n')分隔，返回一个包含各行作为元素的列表，如果参数 keepends 为 False，不包含换行符，如果为 True，则保留换行符。

intab = <span class="hljs-string">"aeiou"</span>
outtab = <span class="hljs-string">"12345"</span>
trantab = str.<span class="hljs-built_in">maketrans</span>(intab, outtab)  # 制作翻译表
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">translate</span>(trantab))  #<span class="hljs-number">1</span>b c1b cABC    返回翻译后的字符串,若给出了 delete 参数，则将原来的bytes中的属于delete的字符删除，剩下的字符要按照table中给出的映射来进行映射 。
<span class="hljs-built_in">print</span>(name.<span class="hljs-built_in">isdecimal</span>())  #False   检查字符串是否只包含十进制字符，如果是返回 true，否则返回 false。
</code></pre>
<h2 data-id="heading-11">列表List</h2>
<p>索引：</p>
<ul>
<li>正向索引,从0开始  ：0,1,2,3,...,n-1</li>
<li>反向索引，从-1开始：-n,...,-4,-3,-2,-1</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>(list)  # 输出完整列表
<span class="hljs-built_in">print</span>(list[<span class="hljs-number">0</span>])  # 输出列表第一个元素
<span class="hljs-built_in">print</span>(list[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>])  # 从第二个开始输出到第三个元素
<span class="hljs-built_in">print</span>(list[<span class="hljs-number">2</span>:])  # 输出从第三个元素开始的所有元素
<span class="hljs-built_in">print</span>(list2 * <span class="hljs-number">3</span>)  # 输出三次列表
<span class="hljs-built_in">print</span>(list + list2)  # 连接列表

输出：
<span class="hljs-selector-attr">[1, 2.3, <span class="hljs-string">'abc'</span>, <span class="hljs-string">'hello'</span>, 4.3j]</span>
<span class="hljs-number">1</span>
<span class="hljs-selector-attr">[2.3, <span class="hljs-string">'abc'</span>]</span>
<span class="hljs-selector-attr">[<span class="hljs-string">'abc'</span>, <span class="hljs-string">'hello'</span>, 4.3j]</span>
<span class="hljs-selector-attr">[<span class="hljs-string">'xxx'</span>, <span class="hljs-string">'yyy'</span>, <span class="hljs-string">'xxx'</span>, <span class="hljs-string">'yyy'</span>, <span class="hljs-string">'xxx'</span>, <span class="hljs-string">'yyy'</span>]</span>
<span class="hljs-selector-attr">[1, 2.3, <span class="hljs-string">'abc'</span>, <span class="hljs-string">'hello'</span>, 4.3j, <span class="hljs-string">'xxx'</span>, <span class="hljs-string">'yyy'</span>]</span>
</code></pre>
<p>列表函数：</p>
<ul>
<li>append  末尾添加元素</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list1 = <span class="hljs-selector-attr">[<span class="hljs-string">"aaa"</span>,<span class="hljs-string">"bbb"</span>,<span class="hljs-string">"ccc"</span>,<span class="hljs-string">"ddd"</span>,<span class="hljs-string">"eee"</span>,<span class="hljs-string">"fff"</span>]</span>
list1<span class="hljs-selector-class">.append</span>("ggg")   
<span class="hljs-built_in">print</span>(list1)   #<span class="hljs-selector-attr">[<span class="hljs-string">'aaa'</span>, <span class="hljs-string">'bbb'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'eee'</span>, <span class="hljs-string">'fff'</span>, <span class="hljs-string">'ggg'</span>]</span>  
</code></pre>
<ul>
<li>del  删除指定index的元素</li>
</ul>

<pre><code class="hljs language-css" lang="css">list2 = <span class="hljs-selector-attr">[<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"ddd"</span>, <span class="hljs-string">"eee"</span>, <span class="hljs-string">"fff"</span>]</span>
<span class="hljs-selector-tag">del</span> list2<span class="hljs-selector-attr">[2]</span>     
print(list2    #<span class="hljs-selector-attr">[<span class="hljs-string">'aaa'</span>, <span class="hljs-string">'bbb'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'eee'</span>, <span class="hljs-string">'fff'</span>]</span> 
</code></pre>
<ul>
<li>remove  移除列表中某个值的第一个匹配项</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list3 = <span class="hljs-selector-attr">[<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"ddd"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"fff"</span>]</span>
list3<span class="hljs-selector-class">.remove</span>("ccc")    
<span class="hljs-built_in">print</span>(list3)    #<span class="hljs-selector-attr">[<span class="hljs-string">'aaa'</span>, <span class="hljs-string">'bbb'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'fff'</span>]</span> 
</code></pre>
<ul>
<li>len  列表长度</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list4</span> = [<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"ddd"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"fff"</span>]
print(len(list4))  <span class="hljs-comment">#6   </span>
</code></pre>
<ul>
<li>加号 + 连接两个列表</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list5 = <span class="hljs-selector-attr">[<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>]</span>
list6 = <span class="hljs-selector-attr">[<span class="hljs-string">"ddd"</span>, <span class="hljs-string">"ccc"</span>, <span class="hljs-string">"fff"</span>]</span>
<span class="hljs-built_in">print</span>(list5+list6)  #<span class="hljs-selector-attr">[<span class="hljs-string">'aaa'</span>, <span class="hljs-string">'bbb'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'fff'</span>]</span>   
</code></pre>
<ul>
<li>乘号 * 内容重复指定次数</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list7 = <span class="hljs-selector-attr">[<span class="hljs-string">"ddd"</span>, <span class="hljs-string">"ccc"</span>]</span>
<span class="hljs-built_in">print</span>(list7 * <span class="hljs-number">4</span>)  #<span class="hljs-selector-attr">[<span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>, <span class="hljs-string">'ddd'</span>, <span class="hljs-string">'ccc'</span>]</span>   
</code></pre>
<ul>
<li>in 是否包含元素</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">list17 = [<span class="hljs-string">"ddd"</span>, <span class="hljs-string">"ccc"</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">"ddd"</span> <span class="hljs-keyword">in</span> list17)  <span class="hljs-comment">#True  </span>
</code></pre>
<ul>
<li>for 迭代遍历</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> list7:  
    <span class="hljs-built_in">print</span>(x)
</code></pre>
<ul>
<li>eq  比较两个列的元素是否一一相等</li>
</ul>

<pre><code class="hljs language-perl" lang="perl">a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]
b = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
c = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-keyword">print</span>(<span class="hljs-string">"operator.eq(a,b): "</span>, operator.e<span class="hljs-string">q(a, b)</span>)  <span class="hljs-comment">#False   </span>
<span class="hljs-keyword">print</span>(<span class="hljs-string">"operator.eq(c,b): "</span>, operator.e<span class="hljs-string">q(c, b)</span>)  <span class="hljs-comment">#True</span>
</code></pre>
<ul>
<li>max  min  返回列表中最大、最小的元素</li>
</ul>

<pre><code class="hljs language-python" lang="python">list8 = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">max</span>(list8))  <span class="hljs-comment">#7   返回列表中最大的元素</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">min</span>(list8))  <span class="hljs-comment">#1   返回列表中最小的元素</span>
</code></pre>
<ul>
<li>list(tuple)  元组转为列表</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">tuple1 = (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>)
<span class="hljs-built_in">print</span>(list(tuple1))   #<span class="hljs-selector-attr">[1, 2, 4, 5, 6]</span>   
</code></pre>
<ul>
<li>count  统计指定元素出现的次数</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list9</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>]
print(list9.count(1))   <span class="hljs-comment">#3   </span>
</code></pre>
<ul>
<li>extend  将指定的元组、集合，扩展到列表末</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"># 列表
language = <span class="hljs-selector-attr">[<span class="hljs-string">'French'</span>, <span class="hljs-string">'English'</span>, <span class="hljs-string">'German'</span>]</span>
# 元组
language_tuple = ('Spanish', 'Portuguese')
# 集合
language_set = {'Chinese', 'Japanese'}
# 添加元组元素到列表末尾
language<span class="hljs-selector-class">.extend</span>(language_tuple)   #扩展元组
<span class="hljs-built_in">print</span>('新列表: ', language)   #<span class="hljs-selector-attr">[<span class="hljs-string">'French'</span>, <span class="hljs-string">'English'</span>, <span class="hljs-string">'German'</span>, <span class="hljs-string">'Spanish'</span>, <span class="hljs-string">'Portuguese'</span>]</span>
# 添加集合元素到列表末尾
language<span class="hljs-selector-class">.extend</span>(language_set)  #扩展集合
<span class="hljs-built_in">print</span>('新列表: ', language)  # <span class="hljs-selector-attr">[<span class="hljs-string">'French'</span>, <span class="hljs-string">'English'</span>, <span class="hljs-string">'German'</span>, <span class="hljs-string">'Spanish'</span>, <span class="hljs-string">'Portuguese'</span>, <span class="hljs-string">'Japanese'</span>, <span class="hljs-string">'Chinese'</span>]</span>
</code></pre>
<ul>
<li>index   从列表中找出某个值第一个匹配项的索引位置</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list10</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>]
print(list10.index(3,2,6))  <span class="hljs-comment">#2   从列表中找出某个值第一个匹配项的索引位置</span>
</code></pre>
<ul>
<li>insert  在指定索引处插入元素</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list11 = <span class="hljs-selector-attr">[1, 2, 3, 1, 5, 1, 7]</span>
list11<span class="hljs-selector-class">.insert</span>(<span class="hljs-number">2</span>,<span class="hljs-number">99</span>)  #<span class="hljs-selector-attr">[1, 2, 99, 3, 1, 5, 1, 7]</span>   在指定索引处插入元素
<span class="hljs-built_in">print</span>(list11)
</code></pre>
<ul>
<li>pop 移除列表中的一个元素（默认最后一个元素），并且返回该元素的值</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list11 = <span class="hljs-selector-attr">[1, 2, 99，3, 1, 5, 1, 7]</span>
list11<span class="hljs-selector-class">.pop</span>(-<span class="hljs-number">2</span>)  #
<span class="hljs-built_in">print</span>(list11)   # <span class="hljs-selector-attr">[1, 2, 99, 3, 1, 5,  7]</span> 
</code></pre>
<ul>
<li>reverse  列表翻转</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">list12 = <span class="hljs-selector-attr">[1, 2, 3, 4, 5, 6, 7]</span>
list12<span class="hljs-selector-class">.reverse</span>()
<span class="hljs-built_in">print</span>(list12)  #<span class="hljs-selector-attr">[7, 6, 5, 4, 3, 2, 1]</span>    列表翻转

</code></pre>
<ul>
<li>sort  对列表元素排序</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list13</span> = [ <span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>,<span class="hljs-number">8</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>]
list13.sort()  <span class="hljs-comment">#[1, 2, 3, 3, 3, 4, 5, 8]   对列表元素排序</span>
print(list13)

<span class="hljs-comment"># 获取列表的第二个元素</span>
def takeSecond(elem):
    return elem<span class="hljs-section">[1]</span>
<span class="hljs-comment"># 列表</span>
<span class="hljs-attr">list14</span> = [(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), (<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), (<span class="hljs-number">4</span>, <span class="hljs-number">1</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)]
<span class="hljs-comment"># 指定第二个元素排序  reverse升序还是降序，True降序  False升序</span>
list14.sort(<span class="hljs-attr">key</span>=takeSecond,reverse=<span class="hljs-literal">True</span>)    <span class="hljs-comment">#  [(3, 4), (1, 3), (2, 2), (4, 1)]</span>
<span class="hljs-comment"># 输出类别</span>
print('排序列表：', list14)
</code></pre>
<ul>
<li>clear 清空列表</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list15 = <span class="hljs-selector-attr">[(2, 2), (3, 4), (4, 1), (1, 3)]</span>
list15<span class="hljs-selector-class">.clear</span>()  #清空列表
<span class="hljs-built_in">print</span>(list15)   # <span class="hljs-selector-attr">[]</span>
</code></pre>
<ul>
<li>copy 复制列表元素</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list16</span> = [(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), (<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), (<span class="hljs-number">4</span>, <span class="hljs-number">1</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)]
<span class="hljs-attr">list17</span> = list16.copy()  <span class="hljs-comment">#[(2, 2), (3, 4), (4, 1), (1, 3)]    </span>
print(list17)
</code></pre>
<h2 data-id="heading-12">元组</h2>
<ul>
<li>元祖与列表类似，列表用[],元祖用（）</li>
<li>元组元素不能修改，即,不能进行<code>tuple[1]=34的操作</code>,列表可以<code>list[1]=22</code></li>
</ul>
<p>索引：</p>
<ul>
<li>正向索引,从0开始  ：0,1,2,3,...,n-1</li>
<li>反向索引，从-1开始：-n,...,-4,-3,-2,-1</li>
</ul>
<p>元组常用函数：</p>
<ul>
<li>创建元组</li>
</ul>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tuple</span> = (<span class="hljs-string">'aa'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">3</span>j)  <span class="hljs-comment"># 创建元组  方式1</span>
<span class="hljs-attr">tuple2</span> = (<span class="hljs-number">123</span>, <span class="hljs-string">'bb'</span>)  <span class="hljs-comment"># 创建元组  方式2</span>
<span class="hljs-attr">tuple3</span> = <span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>  <span class="hljs-comment"># 创建元组   方式3</span>
<span class="hljs-attr">tuple4</span> = ()    <span class="hljs-comment"># 空元组</span>
<span class="hljs-attr">tuple5</span> = (<span class="hljs-number">20</span>,) <span class="hljs-comment"># 一个元素，需要在元素后添加逗号</span>
<span class="hljs-attr">tuple6</span> = tuple + tuple2  <span class="hljs-comment"># 使用两个现有元组创建一个新元组</span>

</code></pre>
<ul>
<li>元组元素访问</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-built_in">tuple</span>)  <span class="hljs-comment"># 输出完整元组</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">tuple</span>[<span class="hljs-number">0</span>])  <span class="hljs-comment"># 输出元组的第一个元素</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">tuple</span>[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>])  <span class="hljs-comment"># 输出从第二个元素开始到第三个元素</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">tuple</span>[<span class="hljs-number">2</span>:])  <span class="hljs-comment"># 输出从第三个元素开始的所有元素</span>


输出：
(<span class="hljs-string">'aa'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">3j</span>)
aa
(<span class="hljs-number">1</span>, <span class="hljs-number">2.0</span>)
(<span class="hljs-number">2.0</span>, <span class="hljs-number">3j</span>)
</code></pre>
<ul>
<li>del  删除元组</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">tup = ('a', 'b', <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(tup)
<span class="hljs-selector-tag">del</span> tup
# <span class="hljs-built_in">print</span>("删除后的元组 tup : ")
# <span class="hljs-built_in">print</span>(tup)  # 元组删除后，再打印会报错
</code></pre>
<ul>
<li>len  元组内元素个数</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tup1</span> = (<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
print(len(tup1))  <span class="hljs-comment">#4</span>
</code></pre>
<ul>
<li>加号 +  将两个元组连接，建成一个新的元组</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tup2</span> = (<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>)
<span class="hljs-attr">tup3</span> = (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
print(tup2 + tup3)  <span class="hljs-comment">#('a', 'b', 1, 2)</span>
</code></pre>
<ul>
<li>乘号 *  元组内元素重复指定次数</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">tup4 = (<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(tup4 * <span class="hljs-number">3</span>)  # (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
</code></pre>
<ul>
<li>in 判断元素是否包含在元组中</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tup5</span> = (<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
print(1 in tup5)  <span class="hljs-comment"># True</span>
</code></pre>
<ul>
<li>for  元组遍历</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tup6</span> = (<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
for x in tup6 :
    print(x)
</code></pre>
<ul>
<li>max min 返回元组中最大、最小元素</li>
</ul>

<pre><code class="hljs language-python" lang="python">tup7 = (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">max</span>(tup7))  <span class="hljs-comment">#4</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">min</span>(tup7))  <span class="hljs-comment">#1</span>
</code></pre>
<ul>
<li>tuple(list) 将list转为元组</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">list8 = <span class="hljs-selector-attr">[1,2,3,4,5]</span>
<span class="hljs-built_in">print</span>(tuple(list8))  #(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)
</code></pre>
<h2 data-id="heading-13">Set集合</h2>
<ul>
<li>创建集合</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">site1</span> = ()  <span class="hljs-comment"># 创建空集合</span>
<span class="hljs-attr">site2</span> = set(<span class="hljs-string">"a"</span>)  <span class="hljs-comment">#方式1：创建一个集合</span>
<span class="hljs-attr">sites</span> = {<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'f'</span>}  <span class="hljs-comment">#方式二：创建一个集合</span>
<span class="hljs-comment">#set2 = {} #错误，这是一个字典</span>
<span class="hljs-attr">set3</span> = set()  <span class="hljs-comment">#创建一个空集合</span>
<span class="hljs-attr">set0</span> = set((<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>))  <span class="hljs-comment">#用元组创建一个set</span>
</code></pre>
<ul>
<li>去除重复</li>
</ul>

<pre><code class="hljs language-go" lang="go">set4 = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>}
<span class="hljs-built_in">print</span>(set4)  # {<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>}
</code></pre>
<ul>
<li>add 添加</li>
</ul>

<pre><code class="hljs language-go" lang="go">set5 = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
set5.add(<span class="hljs-string">"d"</span>)
<span class="hljs-built_in">print</span>(set5)  # {<span class="hljs-string">'a'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>}
</code></pre>
<ul>
<li>update更新,可以是列表、元组、字典</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set5</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">list</span> = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]
<span class="hljs-attr">tup</span> = (<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)
<span class="hljs-attr">dict</span> = {<span class="hljs-string">'key1'</span>:<span class="hljs-string">'value1'</span>}
set5.update(list)
set5.update(tup)
set5.update(dict)  <span class="hljs-comment"># 字典取key</span>
print(set5)  <span class="hljs-comment"># {1, 2, 3, 4, 'a', 'key1', 'c', 'b'}</span>
</code></pre>
<p>*</p>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># remove 移除元素</span>
set6 = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
set6.remove(<span class="hljs-string">"a"</span>)  <span class="hljs-comment"># 不存在会报错</span>
set6.discard(<span class="hljs-string">"d"</span>)  <span class="hljs-comment"># 不存在不会报错</span>
set6.pop()  <span class="hljs-comment"># 随机删除一个元素</span>
<span class="hljs-built_in">print</span>(set6)  <span class="hljs-comment"># {'c'}</span>
</code></pre>
<ul>
<li>clear 集合清空</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set8</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
set8.clear()  <span class="hljs-comment"># 集合清空</span>
print(set8)  <span class="hljs-comment"># set()</span>
</code></pre>
<ul>
<li>len 集合长度</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set7</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
print(len(set7))  <span class="hljs-comment"># 3</span>
</code></pre>
<ul>
<li>集合间运算</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 成员测试</span>
<span class="hljs-keyword">if</span> <span class="hljs-string">'a'</span> <span class="hljs-keyword">in</span> sites:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'hello'</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'hi'</span>)

<span class="hljs-comment"># set可以进行集合运算</span>
a = <span class="hljs-built_in">set</span>(<span class="hljs-string">'abcd'</span>)
b = <span class="hljs-built_in">set</span>(<span class="hljs-string">'cdef'</span>)

<span class="hljs-built_in">print</span>(a)
<span class="hljs-built_in">print</span>(a - b)  <span class="hljs-comment"># a 和 b 的差集</span>
<span class="hljs-built_in">print</span>(a | b)  <span class="hljs-comment"># a 和 b 的并集</span>
<span class="hljs-built_in">print</span>(a &amp; b)  <span class="hljs-comment"># a 和 b 的交集</span>
<span class="hljs-built_in">print</span>(a ^ b)  <span class="hljs-comment"># a 和 b 中不同时存在的元素</span>
</code></pre>
<ul>
<li>in 判断元素是否在集合中</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">set9 = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-built_in">print</span>(<span class="hljs-string">"a"</span> <span class="hljs-keyword">in</span> set9)  <span class="hljs-comment"># True</span>
</code></pre>
<ul>
<li>difference() 返回多个集合的差集，自身集合没变化</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set10</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set11</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
print(set10.difference(set11))  <span class="hljs-comment"># {'a'}</span>
</code></pre>
<ul>
<li>difference_update() 移除集合中的元素，该元素在指定的集合也存在。改变了自身集合</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set12</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set13</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
set12.difference_update(set13)
print(set12)   <span class="hljs-comment"># {'a'}</span>
</code></pre>
<ul>
<li>intersection()  返回集合的交集</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set14</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set15</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
print(set14.intersection(set15))   <span class="hljs-comment"># {'b', 'c'}</span>
</code></pre>
<ul>
<li>intersection_update() 返回集合的交集</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set16</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set17</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
set16.intersection_update(set17)
print(set16)  <span class="hljs-comment"># {'b', 'c'}</span>
</code></pre>
<ul>
<li>isdisjoint() 两个集合,如果没有相同元素返回 True，有至少一个相同元素返回 False。</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set18</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set19</span> = {<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>}
print(set18.isdisjoint(set19))  <span class="hljs-comment"># True</span>
</code></pre>
<ul>
<li>issubset() 判断指定集合是否为该方法参数集合的子集</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set20</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set21</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
print(set20.issubset(set21))  <span class="hljs-comment"># False</span>
</code></pre>
<ul>
<li>issuperset() 判断该方法的参数集合是否为指定集合的子集</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set22</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set23</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
print(set22.issuperset(set23))  <span class="hljs-comment"># True</span>
</code></pre>
<ul>
<li>symmetric_difference() 返回两个集合中不重复的元素集合。</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set24</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set25</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
print(set24.symmetric_difference(set25))  <span class="hljs-comment"># {'d', 'a'}</span>
</code></pre>
<ul>
<li>symmetric_difference_update()  移除当前集合中在另外一个指定集合相同的元素，并将另外一个指定集合中不同的元素插入到当前集合中。</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set26</span> = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
<span class="hljs-attr">set27</span> = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
set26.symmetric_difference_update(set27)
print(set26)  <span class="hljs-comment"># {'d', 'a'}</span>
</code></pre>
<ul>
<li>union() 返回两个集合的并集</li>
</ul>

<pre><code class="hljs language-c" lang="c">set28 = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
set29 = {<span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>}
print(set28.<span class="hljs-keyword">union</span>(set29))  #{<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'c'</span>}
</code></pre>
<h2 data-id="heading-14">字典</h2>
<ul>
<li>创建字典</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dict</span> = {}  <span class="hljs-comment">#使用{}创建一个空字典</span>
<span class="hljs-attr">emptyDict2</span> = dict()   <span class="hljs-comment">#使用内建函数 dict() 创建字典</span>
<span class="hljs-attr">dict2</span> = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}  <span class="hljs-comment">#使用{}创建一个有值的字典</span>
</code></pre>
<ul>
<li>dict()可以直接将键值对儿转为字典</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-built_in">dict</span>([(<span class="hljs-string">'Runoob'</span>, <span class="hljs-number">1</span>), (<span class="hljs-string">'Google'</span>, <span class="hljs-number">2</span>), (<span class="hljs-string">'Taobao'</span>, <span class="hljs-number">3</span>)])

输出：
{<span class="hljs-string">'Runoob'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'Google'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'Taobao'</span>: <span class="hljs-number">3</span>}
</code></pre>
<ul>
<li>字典访问</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">dict</span>[<span class="hljs-string">'a'</span>] = <span class="hljs-string">"b"</span>
<span class="hljs-built_in">dict</span>[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">dict</span>[<span class="hljs-string">'a'</span>])  <span class="hljs-comment"># 输出键为 'one' 的值</span>
<span class="hljs-comment"># print(dict[2])  # 输出键为 2 的值 ,找不到，报错</span>
<span class="hljs-built_in">print</span>(dict2)  <span class="hljs-comment"># 输出完整的字典</span>

输出：
b
{<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
</code></pre>
<ul>
<li>del 删除字典的key</li>
</ul>

<pre><code class="hljs language-css" lang="css">dict2 = {'key1': <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
<span class="hljs-selector-tag">del</span> dict2<span class="hljs-selector-attr">[<span class="hljs-string">'key1'</span>]</span>
print(dict2)  #{'key2': <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
</code></pre>
<ul>
<li>del 删除字典</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dict3</span> = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
del dict3
<span class="hljs-comment"># print(dict3)  #已删除，打印报错</span>
</code></pre>
<ul>
<li>clear  字典清空</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dict4</span> = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict4.clear()
print(dict4)  <span class="hljs-comment">#{}</span>
</code></pre>
<ul>
<li>len  字典内键值对儿个数</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dict5</span> = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
print(len(dict5))  <span class="hljs-comment">#3</span>
</code></pre>
<ul>
<li>str  字典转为字符串</li>
</ul>

<pre><code class="hljs language-go" lang="go">dict6 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
<span class="hljs-built_in">print</span>(str(dict6))  #字符串：{<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
</code></pre>
<ul>
<li>copy 返回一个字典的浅复制</li>
</ul>

<pre><code class="hljs language-go" lang="go">dict7 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict8 = dict7.<span class="hljs-built_in">copy</span>()
<span class="hljs-built_in">print</span>(str(dict8))  #{<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
</code></pre>
<ul>
<li>fromkeys 创建一个新字典，以序列seq中元素做字典的键，val为字典所有键对应的初始值</li>
</ul>

<pre><code class="hljs language-sql" lang="sql">keys <span class="hljs-operator">=</span> (<span class="hljs-string">'name'</span>, <span class="hljs-string">'age'</span>, <span class="hljs-string">'sex'</span>)
<span class="hljs-keyword">values</span> <span class="hljs-operator">=</span> "value"
dict9 <span class="hljs-operator">=</span> dict.fromkeys(keys, <span class="hljs-keyword">values</span>)
print(dict9)  #{<span class="hljs-string">'name'</span>: <span class="hljs-string">'value'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-string">'value'</span>, <span class="hljs-string">'sex'</span>: <span class="hljs-string">'value'</span>}
</code></pre>
<ul>
<li>字典遍历</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">dict2 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: 1, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>} 
<span class="hljs-built_in">print</span>(dict2.keys())  <span class="hljs-comment"># 输出所有键，是个List</span>
<span class="hljs-built_in">print</span>(dict2.values())  <span class="hljs-comment"># 输出所有值，是个List</span>

输出：
dict_keys([<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>, <span class="hljs-string">'key3'</span>])
dict_values([<span class="hljs-string">'value1'</span>, 1, <span class="hljs-string">'value3'</span>])
</code></pre>
<ul>
<li>for、keys、values，字典遍历</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">dict10 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: 1, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
<span class="hljs-built_in">print</span>(dict10.get(<span class="hljs-string">"key1"</span>))    <span class="hljs-comment">#value1</span>

dict11 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: 1, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
<span class="hljs-built_in">print</span>(<span class="hljs-string">"key1"</span> <span class="hljs-keyword">in</span> dict11)  <span class="hljs-comment">#True</span>

dict12 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: 1, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
<span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> dict12.items():
    <span class="hljs-built_in">print</span>(entry)
    
<span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> dict12.items():
    <span class="hljs-built_in">print</span>(k, v)
    
<span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> dict12.keys():
    <span class="hljs-built_in">print</span>(key)

<span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> dict12.values():
    <span class="hljs-built_in">print</span>(value)
</code></pre>
<ul>
<li>setdefault  和get()类似, 但如果键不存在于字典中，将会添加键并将值设为default</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">dict13 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: 1, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict13.setdefault(<span class="hljs-string">"key4"</span>,44)
<span class="hljs-built_in">print</span>(dict13.get(<span class="hljs-string">"key4"</span>))  <span class="hljs-comment">#44</span>
</code></pre>
<ul>
<li>update 把字典dict15的键/值对更新到dict14里，存在更新，不存在添加</li>
</ul>

<pre><code class="hljs language-go" lang="go">dict14 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict15 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1111'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'key4'</span>: <span class="hljs-string">'value444'</span>}
dict14.update(dict15)
<span class="hljs-built_in">print</span>(dict14)  #{<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1111'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>, <span class="hljs-string">'key4'</span>: <span class="hljs-string">'value444'</span>}
</code></pre>
<ul>
<li>pop 删除字典 key（键）所对应的值，返回被删除的值</li>
</ul>

<pre><code class="hljs language-go" lang="go">dict16 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict16.pop(<span class="hljs-string">"key1"</span>)
<span class="hljs-built_in">print</span>(dict16)  #{<span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
</code></pre>
<ul>
<li>popitem 返回并删除字典中的最后一对键和值</li>
</ul>

<pre><code class="hljs language-go" lang="go">dict17 = {<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>, <span class="hljs-string">'key3'</span>: <span class="hljs-string">'value3'</span>}
dict17.popitem()
<span class="hljs-built_in">print</span>(dict17)  #{<span class="hljs-string">'key1'</span>: <span class="hljs-string">'value1'</span>, <span class="hljs-string">'key2'</span>: <span class="hljs-number">1</span>}
</code></pre>
<h2 data-id="heading-15">数据类型转化</h2>
<ul>
<li>隐式类型转换 - 自动完成</li>
<li>显式类型转换 - 需要使用类型函数来转换</li>
</ul>
<p>隐式转换：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">a</span> = <span class="hljs-number">1</span> <span class="hljs-comment"># int</span>
<span class="hljs-attr">b</span> = <span class="hljs-number">1.2</span> <span class="hljs-comment"># float</span>
<span class="hljs-attr">c</span> = a + b <span class="hljs-comment"># float</span>
</code></pre>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">a</span> = <span class="hljs-number">1</span> <span class="hljs-comment"># int</span>
<span class="hljs-attr">b</span> = <span class="hljs-string">"1"</span> <span class="hljs-comment"># float</span>
<span class="hljs-attr">c</span> = a + b <span class="hljs-comment"># 运行报错，字符串和int不能隐式转换</span>
</code></pre>
<p>显示转化，使用目标类型名函数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(<span class="hljs-number">1.2</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(<span class="hljs-string">"1"</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">float</span>(<span class="hljs-number">1</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">float</span>(<span class="hljs-string">"1.3"</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(<span class="hljs-number">1.2</span>))
</code></pre>
<p>显示转化汇总：</p>
<ul>
<li>int(x) 将x转换为一个整数</li>
<li>float(x) 将x转换到一个浮点数</li>
<li>complex(x) 创建一个复数</li>
<li>str(x) 将x转为字符串</li>
<li>repr(x) 将x转为表达式字符串</li>
<li>eval(str) 用来计算在字符串中的有效Python表达式,并返回一个对象</li>
<li>tuple(s) 将序列 s 转换为一个元组</li>
<li>list(s) 将序列 s 转换为一个列表</li>
<li>set(s) 转换为可变集合</li>
<li>dict(d) 创建一个字典。d 必须是一个 (key, value)元组序列</li>
<li>frozenset(s) 转换为不可变集合</li>
<li>chr(x) 将一个整数转换为一个字符</li>
<li>ord(x) 将一个字符转换为它的整数值</li>
<li>hex(x) 将一个整数转换为一个十六进制字符串</li>
<li>oct(x) 将一个整数转换为一个八进制字符串</li>
</ul>
<h2 data-id="heading-16">推导式</h2>
<p>推导式是一种独特的数据处理方式，可以从一个数据序列构建另一个新的数据序列的结构体。</p>
<ul>
<li>列表(list)推导式</li>
<li>字典(dict)推导式</li>
<li>集合(set)推导式</li>
<li>元组(tuple)推导式</li>
</ul>
<p>列表(list)推导式</p>
<pre><code class="hljs language-scss" lang="scss">list = <span class="hljs-selector-attr">[<span class="hljs-string">'ZhangSan'</span>, <span class="hljs-string">'LiSi'</span>, <span class="hljs-string">'wei'</span>, <span class="hljs-string">'wangwu'</span>, <span class="hljs-string">'s'</span>, <span class="hljs-string">'a'</span>]</span>
list2 = <span class="hljs-selector-attr">[name.upper() for name in list if len(name) &gt; 3]</span>
<span class="hljs-built_in">print</span>(list2) # <span class="hljs-selector-attr">[<span class="hljs-string">'ZHANGSAN'</span>, <span class="hljs-string">'LISI'</span>, <span class="hljs-string">'WANGWU'</span>]</span>

list3 = <span class="hljs-selector-attr">[i for i in range(20) if i%4 == 0]</span>
<span class="hljs-built_in">print</span>(list3) # <span class="hljs-selector-attr">[0, 4, 8, 12, 16]</span>
</code></pre>
<p>字典(dict)推导式</p>
<pre><code class="hljs language-css" lang="css">list = <span class="hljs-selector-attr">[<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key222'</span>, <span class="hljs-string">'key33333'</span>]</span>
dict = {key: <span class="hljs-built_in">len</span>(key) for key in list}
print(dict) # {'key1': <span class="hljs-number">4</span>, <span class="hljs-string">'key222'</span>: <span class="hljs-number">6</span>, <span class="hljs-string">'key33333'</span>: <span class="hljs-number">8</span>}

dict2 = {x: x ** <span class="hljs-number">2</span> for x in (<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>)}
print(dict2) # {<span class="hljs-number">2</span>: <span class="hljs-number">4</span>, <span class="hljs-number">4</span>: <span class="hljs-number">16</span>, <span class="hljs-number">6</span>: <span class="hljs-number">36</span>}
</code></pre>
<p>集合(set)推导式</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">set1</span> = {i ** <span class="hljs-number">2</span> for i in (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)}
print(set1)  <span class="hljs-comment"># {1, 4, 9}</span>
<span class="hljs-attr">a</span> = {x for x in <span class="hljs-string">'abracadabra'</span> if x not in <span class="hljs-string">'abc'</span>}
print(a)  <span class="hljs-comment"># {'r', 'd'}</span>
</code></pre>
<p>元组(tuple)推导式</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">a</span> = (x for x in range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>))  # 返回的生成器对象，需要用<span class="hljs-built_in">tuple</span>(a)转换成元组
<span class="hljs-built_in">print</span>(tuple(a))  # (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>)
</code></pre>
<h2 data-id="heading-17">运算符</h2>
<ul>
<li>算数运算符</li>
<li>比较运算符</li>
<li>赋值运算符</li>
<li>逻辑运算符</li>
<li>位运算符</li>
<li>成员运算符</li>
<li>身份运算符</li>
<li>运算符优先级</li>
</ul>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89079fe1ca3a4c38b7cd31cc21f2051d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1670&amp;h=960&amp;s=145618&amp;e=png&amp;b=fbf9f9" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a7cb635f6384453cb8e565228bbdb2af~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1672&amp;h=1018&amp;s=156164&amp;e=png&amp;b=ffffff" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f047849fcf0c448981df1e72e3e9f1c7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1666&amp;h=1154&amp;s=202976&amp;e=png&amp;b=faf8f8" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47ea651e14af440b8c4d0d60899ee6b4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1692&amp;h=1604&amp;s=300298&amp;e=png&amp;b=f9f8f8" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee093ca9550d4a9e92e8c48e1076bc3f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1678&amp;h=478&amp;s=102449&amp;e=png&amp;b=fdfdfd" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16157fc86d294b65b14702e8c47916b7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1682&amp;h=414&amp;s=94084&amp;e=png&amp;b=fdfdfd" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span> = <span class="hljs-number">2</span>
<span class="hljs-selector-tag">b</span> = <span class="hljs-number">20</span>
list = <span class="hljs-selector-attr">[1, 2, 3, 4, 5]</span>
if (<span class="hljs-selector-tag">a</span> in list):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1 - 变量 a 在给定的列表中 list 中"</span>)
else:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1 - 变量 a 不在给定的列表中 list 中"</span>)
if (b not in list):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2 - 变量 b 不在给定的列表中 list 中"</span>)
else:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2 - 变量 b 在给定的列表中 list 中"</span>)
</code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d0e78abb59c43669799fe8b6e27d610~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1708&amp;h=480&amp;s=100256&amp;e=png&amp;b=fdfdfd" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span> = <span class="hljs-number">20</span>
<span class="hljs-selector-tag">b</span> = <span class="hljs-number">20</span>

if (<span class="hljs-selector-tag">a</span> is <span class="hljs-selector-tag">b</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1 - a 和 b 有相同的标识"</span>)
else:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1 - a 和 b 没有相同的标识"</span>)

if (<span class="hljs-built_in">id</span>(a) == <span class="hljs-built_in">id</span>(b)):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2 - a 和 b 有相同的标识"</span>)
else:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2 - a 和 b 没有相同的标识"</span>)
</code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c6f1c9ffa9e40d890b0a31c83dda0b2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1752&amp;h=1830&amp;s=253774&amp;e=png&amp;b=fcfcfc" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-18">数学函数</h2>
<p>常用函数</p>

































































<table><thead><tr><th>函数</th><th>返回值 ( 描述 )</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-abs.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-abs.html" ref="nofollow noopener noreferrer">abs(x)</a></td><td>返回数字的绝对值，如abs(-10) 返回 10</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-ceil.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-ceil.html" ref="nofollow noopener noreferrer">ceil(x)</a></td><td>返回数字的上入整数，如math.ceil(4.1) 返回 5</td></tr><tr><td>cmp(x, y)</td><td>如果 x &lt; y 返回 -1, 如果 x == y 返回 0, 如果 x &gt; y 返回 1。 <strong>Python 3 已废弃，使用 (x&gt;y)-(x&lt;y) 替换</strong>。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-exp.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-exp.html" ref="nofollow noopener noreferrer">exp(x)</a></td><td>返回e的x次幂(ex),如math.exp(1) 返回2.718281828459045</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-fabs.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-fabs.html" ref="nofollow noopener noreferrer">fabs(x)</a></td><td>返回数字的绝对值，如math.fabs(-10) 返回10.0</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-floor.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-floor.html" ref="nofollow noopener noreferrer">floor(x)</a></td><td>返回数字的下舍整数，如math.floor(4.9)返回 4</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-log.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-log.html" ref="nofollow noopener noreferrer">log(x)</a></td><td>如math.log(math.e)返回1.0,math.log(100,10)返回2.0</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-log10.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-log10.html" ref="nofollow noopener noreferrer">log10(x)</a></td><td>返回以10为基数的x的对数，如math.log10(100)返回 2.0</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-max.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-max.html" ref="nofollow noopener noreferrer">max(x1, x2,...)</a></td><td>返回给定参数的最大值，参数可以为序列。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-min.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-min.html" ref="nofollow noopener noreferrer">min(x1, x2,...)</a></td><td>返回给定参数的最小值，参数可以为序列。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-modf.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-modf.html" ref="nofollow noopener noreferrer">modf(x)</a></td><td>返回x的整数部分与小数部分，两部分的数值符号与x相同，整数部分以浮点型表示。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-pow.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-pow.html" ref="nofollow noopener noreferrer">pow(x, y)</a></td><td>x**y 运算后的值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-round.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-round.html" ref="nofollow noopener noreferrer">round(x [,n])</a></td><td>返回浮点数 x 的四舍五入值，如给出 n 值，则代表舍入到小数点后的位数。<strong>其实准确的说是保留值将保留到离上一位更近的一端。</strong></td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-sqrt.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-sqrt.html" ref="nofollow noopener noreferrer">sqrt(x)</a></td><td>返回数字x的平方根。</td></tr></tbody></table>
<h2 data-id="heading-19">随机数函数</h2>
<p>常用随机数函数：</p>

































<table><thead><tr><th>函数</th><th>描述</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-choice.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-choice.html" ref="nofollow noopener noreferrer">choice(seq)</a></td><td>从序列的元素中随机挑选一个元素，比如random.choice(range(10))，从0到9中随机挑选一个整数。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-randrange.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-randrange.html" ref="nofollow noopener noreferrer">randrange ([start,] stop [,step])</a></td><td>从指定范围内，按指定基数递增的集合中获取一个随机数，基数默认值为 1</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-random.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-random.html" ref="nofollow noopener noreferrer">random()</a></td><td>随机生成下一个实数，它在[0,1)范围内。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-seed.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-seed.html" ref="nofollow noopener noreferrer">seed([x])</a></td><td>改变随机数生成器的种子seed。如果你不了解其原理，你不必特别去设定seed，Python会帮你选择seed。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-shuffle.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-shuffle.html" ref="nofollow noopener noreferrer">shuffle(lst)</a></td><td>将序列的所有元素随机排序</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-uniform.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-uniform.html" ref="nofollow noopener noreferrer">uniform(x, y)</a></td><td>随机生成下一个实数，它在[x,y]范围内。</td></tr></tbody></table>
<h2 data-id="heading-20">三角函数</h2>
<p>常用三角函数：</p>

















































<table><thead><tr><th>函数</th><th>描述</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-acos.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-acos.html" ref="nofollow noopener noreferrer">acos(x)</a></td><td>返回x的反余弦弧度值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-asin.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-asin.html" ref="nofollow noopener noreferrer">asin(x)</a></td><td>返回x的反正弦弧度值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-atan.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-atan.html" ref="nofollow noopener noreferrer">atan(x)</a></td><td>返回x的反正切弧度值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-atan2.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-atan2.html" ref="nofollow noopener noreferrer">atan2(y, x)</a></td><td>返回给定的 X 及 Y 坐标值的反正切值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-cos.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-cos.html" ref="nofollow noopener noreferrer">cos(x)</a></td><td>返回x的弧度的余弦值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-hypot.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-hypot.html" ref="nofollow noopener noreferrer">hypot(x, y)</a></td><td>返回欧几里德范数 sqrt(x<em>x + y</em>y)。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-sin.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-sin.html" ref="nofollow noopener noreferrer">sin(x)</a></td><td>返回的x弧度的正弦值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-tan.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-tan.html" ref="nofollow noopener noreferrer">tan(x)</a></td><td>返回x弧度的正切值。</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-degrees.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-degrees.html" ref="nofollow noopener noreferrer">degrees(x)</a></td><td>将弧度转换为角度,如degrees(math.pi/2) ， 返回90.0</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-func-number-radians.html" target="_blank" title="https://www.runoob.com/python3/python3-func-number-radians.html" ref="nofollow noopener noreferrer">radians(x)</a></td><td>将角度转换为弧度</td></tr></tbody></table>
<h2 data-id="heading-21">数学常量</h2>

















<table><thead><tr><th>常量</th><th>描述</th></tr></thead><tbody><tr><td>pi</td><td>数学常量 pi（圆周率，一般以π来表示）</td></tr><tr><td>e</td><td>数学常量 e，e即自然常数（自然常数）。</td></tr></tbody></table>
<h2 data-id="heading-22">end</h2>
<p>关键字end可以用于将结果输出到同一行，或者在输出的末尾添加不同的字符</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span> = <span class="hljs-number">0</span>, <span class="hljs-number">1</span>
<span class="hljs-selector-tag">while</span> <span class="hljs-selector-tag">b</span> &lt; <span class="hljs-number">1000</span>:
    <span class="hljs-selector-tag">print</span>(b, end=<span class="hljs-string">','</span>)
    <span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span> = <span class="hljs-selector-tag">b</span>, <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>
    
输出：
<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8</span>,<span class="hljs-number">13</span>,<span class="hljs-number">21</span>,<span class="hljs-number">34</span>,<span class="hljs-number">55</span>,<span class="hljs-number">89</span>,<span class="hljs-number">144</span>,<span class="hljs-number">233</span>,<span class="hljs-number">377</span>,<span class="hljs-number">610</span>,<span class="hljs-number">987</span>,
</code></pre>
<h2 data-id="heading-23">循环</h2>
<ul>
<li>while else</li>
</ul>
<p>while true内执行多次，else执行1次</p>
<pre><code class="hljs language-bash" lang="bash">count = 10
<span class="hljs-keyword">while</span> count &lt; 5:
    <span class="hljs-built_in">print</span>(count, <span class="hljs-string">" 小于 5"</span>)
    count = count - 1
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(count, <span class="hljs-string">" 大于或等于 5"</span>)
    count = count - 1
</code></pre>
<ul>
<li>for else</li>
</ul>
<p>只有for内循环一次都未执行时才走else</p>
<pre><code class="hljs language-bash" lang="bash">sites = [<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>]
<span class="hljs-keyword">for</span> site <span class="hljs-keyword">in</span> sites:
    <span class="hljs-keyword">if</span> site == <span class="hljs-string">"b"</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"aaa!"</span>)
        <span class="hljs-built_in">break</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"循环数据 "</span> + site)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"没有循环数据!"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"完成循环!"</span>)
</code></pre>
<ul>
<li>range</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">for <span class="hljs-selector-tag">i</span> in <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    <span class="hljs-built_in">print</span>(i)

for i in <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, <span class="hljs-number">9</span>):
    <span class="hljs-built_in">print</span>(i)

for i in <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(i)

for i in <span class="hljs-built_in">range</span>(-<span class="hljs-number">10</span>, -<span class="hljs-number">100</span>, -<span class="hljs-number">30</span>):
    <span class="hljs-built_in">print</span>(i)

list = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>))
<span class="hljs-built_in">print</span>(list)
</code></pre>
<ul>
<li>pass</li>
</ul>
<p>pass是空语句，是为了保持程序结构的完整性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> letter <span class="hljs-keyword">in</span> <span class="hljs-string">'abcde'</span>:
    <span class="hljs-keyword">if</span> letter == <span class="hljs-string">'o'</span>:
        <span class="hljs-keyword">pass</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'执行 pass 块'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前字母 :'</span>, letter)
</code></pre>
<h2 data-id="heading-24">同时遍历两个序列</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">questions</span> = <span class="hljs-selector-attr">[<span class="hljs-string">'name'</span>, <span class="hljs-string">'quest'</span>, <span class="hljs-string">'favorite color'</span>]</span>
<span class="hljs-selector-tag">answers</span> = <span class="hljs-selector-attr">[<span class="hljs-string">'lancelot'</span>, <span class="hljs-string">'the holy grail'</span>, <span class="hljs-string">'blue'</span>]</span>
<span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">q</span>, <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">zip</span>(questions, answers):
    <span class="hljs-selector-tag">print</span>(<span class="hljs-string">'q = {0}?  a = {1}.'</span>.<span class="hljs-built_in">format</span>(q, a))
    
输出：
<span class="hljs-selector-tag">q</span> = <span class="hljs-selector-tag">name</span>?  <span class="hljs-selector-tag">a</span> = <span class="hljs-selector-tag">lancelot</span>.
<span class="hljs-selector-tag">q</span> = <span class="hljs-selector-tag">quest</span>?  <span class="hljs-selector-tag">a</span> = <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">holy</span> <span class="hljs-selector-tag">grail</span>.
<span class="hljs-selector-tag">q</span> = <span class="hljs-selector-tag">favorite</span> <span class="hljs-selector-tag">color</span>?  <span class="hljs-selector-tag">a</span> = <span class="hljs-selector-tag">blue</span>.
</code></pre>
<h2 data-id="heading-25">异常处理</h2>
<ul>
<li>如果没有异常：try...else...finally...</li>
<li>有异常：try...except...finally...</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">this_fails</span>():
    x = <span class="hljs-number">1</span> / <span class="hljs-number">0</span>

<span class="hljs-keyword">try</span>:
    this_fails()
<span class="hljs-keyword">except</span> ZeroDivisionError <span class="hljs-keyword">as</span> err:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'Handling run-time error:'</span>, err)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"oveer"</span>)
<span class="hljs-keyword">finally</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'这句话，无论异常是否发生都会执行。'</span>)
</code></pre>
<ul>
<li>抛出异常 raise</li>
</ul>

<pre><code class="hljs language-css" lang="css">x = <span class="hljs-number">10</span>\
if x &gt; <span class="hljs-number">5</span>:\
    raise <span class="hljs-built_in">Exception</span>(<span class="hljs-string">'x 不能大于 5。x 的值为: {}'</span>.<span class="hljs-built_in">format</span>(x))
</code></pre>
<ul>
<li>自定义异常</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyError</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, value</span>):
        self.value = value

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">repr</span>(self.value)

<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">raise</span> MyError(<span class="hljs-number">2</span> * <span class="hljs-number">2</span>)
<span class="hljs-keyword">except</span> MyError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'My exception occurred, value:'</span>, e.value)
</code></pre>
<ul>
<li>with</li>
</ul>
<p>关键词 with 语句就可以保证诸如文件之类的对象在使用完之后一定会正确的执行他的清理方法</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"myfile.txt"</span>) <span class="hljs-keyword">as</span> f:
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
        <span class="hljs-built_in">print</span>(line, end=<span class="hljs-string">""</span>)
</code></pre>
<h2 data-id="heading-26">类</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span>:
    <span class="hljs-string">"""一个简单的类实例"""</span>
    i = <span class="hljs-number">12345</span>
    a = <span class="hljs-number">1</span>
    b = <span class="hljs-number">2</span>
    __c = <span class="hljs-number">2</span>  <span class="hljs-comment"># 私有属性</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, a, b</span>):  <span class="hljs-comment"># 构造方法</span>
        self.i = <span class="hljs-number">222</span>
        self.a = a
        self.b = b

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">self</span>):  <span class="hljs-comment"># 常规方法</span>
        <span class="hljs-keyword">return</span> self.a + self.b + self.__c
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__foo</span>(<span class="hljs-params">self</span>):  <span class="hljs-comment"># 私有方法 </span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'这是私有方法'</span>)

<span class="hljs-comment"># 实例化类</span>
x = MyClass(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)

<span class="hljs-comment"># 访问类的属性和方法</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"MyClass 类的属性 i 为："</span>, x.i)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"MyClass 类的方法 f 输出为："</span>, x.f())
</code></pre>
<ul>
<li>继承</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MySubClass</span>(<span class="hljs-title class_">MyClass</span>):
    d = <span class="hljs-number">4</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>,a,b,d</span>):
        <span class="hljs-title class_">MyClass</span>.__init__(<span class="hljs-variable language_">self</span>,a,b)  <span class="hljs-comment"># 调用父类构造方法</span>
        <span class="hljs-variable language_">self</span>.d = d

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):  <span class="hljs-comment"># 覆写父类方法</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.a * <span class="hljs-variable language_">self</span>.b *<span class="hljs-variable language_">self</span>.d

msc = <span class="hljs-title class_">MySubClass</span>(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
result = msc.f()
print(result)
</code></pre>
<ul>
<li>多继承</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 类定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">people</span>:
    <span class="hljs-comment"># 定义基本属性</span>
    name = <span class="hljs-string">''</span>
    age = <span class="hljs-number">0</span>
    <span class="hljs-comment"># 定义私有属性,私有属性在类外部无法直接进行访问</span>
    __weight = <span class="hljs-number">0</span>

    <span class="hljs-comment"># 定义构造方法</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n, a, w</span>):
        self.name = n
        self.age = a
        self.__weight = w

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"%s 说: 我 %d 岁。"</span> % (self.name, self.age))

<span class="hljs-comment"># 单继承示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">student</span>(<span class="hljs-title class_ inherited__">people</span>):
    grade = <span class="hljs-string">''</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n, a, w, g</span>):
        <span class="hljs-comment"># 调用父类的构函</span>
        people.__init__(self, n, a, w)
        self.grade = g

    <span class="hljs-comment"># 覆写父类的方法</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"%s 说: 我 %d 岁了，我在读 %d 年级"</span> % (self.name, self.age, self.grade))

<span class="hljs-comment"># 另一个类，多重继承之前的准备</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">speaker</span>():
    topic = <span class="hljs-string">''</span>
    name = <span class="hljs-string">''</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n, t</span>):
        self.name = n
        self.topic = t

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"我叫 %s，我是一个演说家，我演讲的主题是 %s"</span> % (self.name, self.topic))

<span class="hljs-comment"># 多重继承</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">sample</span>(speaker, student):
    a = <span class="hljs-string">''</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n, a, w, g, t</span>):
        student.__init__(self, n, a, w, g)
        speaker.__init__(self, n, t)

test = sample(<span class="hljs-string">"Tim"</span>, <span class="hljs-number">25</span>, <span class="hljs-number">80</span>, <span class="hljs-number">4</span>, <span class="hljs-string">"Python"</span>)
test.speak()  <span class="hljs-comment"># 方法名同，默认调用的是在括号中参数位置排前父类的方法</span>
</code></pre>
<h2 data-id="heading-27">json</h2>
<ul>
<li>dumps  对象转字符串</li>
<li>loads  字符串转对象</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
data = {
    <span class="hljs-string">'no'</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">'name'</span>: <span class="hljs-string">'Runoob'</span>,
    <span class="hljs-string">'url'</span>: <span class="hljs-string">'http://www.runoob.com'</span>
}

json_str = json.dumps(data)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Python 原始数据："</span>, <span class="hljs-built_in">repr</span>(data))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"JSON 对象："</span>, json_str)

<span class="hljs-comment"># 将 JSON 对象转换为 Python 字典</span>
data2 = json.loads(json_str)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"data2['name']: "</span>, data2[<span class="hljs-string">'name'</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"data2['url']: "</span>, data2[<span class="hljs-string">'url'</span>])
</code></pre>
<p>参考菜鸟教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fpython3%2Fpython3-tutorial.html" target="_blank" title="https://www.runoob.com/python3/python3-tutorial.html" ref="nofollow noopener noreferrer">www.runoob.com/python3/pyt…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Fishhook原理深度剖析：从Mach-O到运行时函数Hook]]></title>    <link>https://juejin.cn/post/7596975035438792713</link>    <guid>https://juejin.cn/post/7596975035438792713</guid>    <pubDate>2026-01-20T04:07:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438792713" data-draft-id="7596890557545971758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Fishhook原理深度剖析：从Mach-O到运行时函数Hook"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-20T04:07:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Fishhook原理深度剖析：从Mach-O到运行时函数Hook
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:07:52.000Z" title="Tue Jan 20 2026 04:07:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在iOS/macOS开发中，函数Hook是一项强大的技术，它允许我们在运行时修改函数行为，广泛应用于调试、监控、性能分析等领域。Fishhook作为Facebook开源的一个轻量级Hook框架，其设计精巧、实现简洁，是理解macOS/iOS系统动态链接机制的绝佳案例。本文将深入剖析Fishhook的工作原理，解答一系列核心问题。</p>
<h2 data-id="heading-1">一、Fishhook是什么？</h2>
<p>Fishhook是一个基于动态链接特性的函数Hook库，专门针对macOS和iOS平台设计。它的核心思想是通过修改Mach-O文件中的符号绑定表来实现C函数的Hook。</p>
<p><strong>核心特点：</strong></p>
<ul>
<li>轻量级，仅几百行代码</li>
<li>专注于C函数Hook</li>
<li>基于合法的dyld API</li>
<li>主要用于调试和监控场景</li>
</ul>
<h2 data-id="heading-2">二、核心问题：Fishhook为什么只能Hook动态链接函数？</h2>
<h3 data-id="heading-3">1. Mach-O文件结构回顾</h3>
<p>要理解Fishhook的限制，首先要了解Mach-O文件结构：</p>
<pre><code class="hljs language-markdown" lang="markdown">Mach-O Header
Load Commands
<span class="hljs-bullet">    -</span> LC<span class="hljs-emphasis">_SEGMENT_</span>64
<span class="hljs-bullet">    -</span> LC<span class="hljs-emphasis">_SYMTAB (符号表)
    - LC_</span>DYSYMTAB (动态符号表)
<span class="hljs-bullet">    -</span> LC<span class="hljs-emphasis">_DYLD_</span>INFO (绑定信息)
Data
<span class="hljs-bullet">    -</span> <span class="hljs-strong">__TEXT (代码段，只读)
    - __</span>DATA (数据段，可写)
<span class="hljs-bullet">        -</span> <span class="hljs-strong">__la<span class="hljs-emphasis">_symbol_</span>ptr (惰性绑定指针)
        - __</span>nl<span class="hljs-emphasis">_symbol_</span>ptr (非惰性绑定指针)
<span class="hljs-bullet">        -</span> <span class="hljs-strong">__got (全局偏移表)
    - __</span>LINKEDIT (链接信息)
</code></pre>
<h3 data-id="heading-4">2. 动态链接 vs 静态链接</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 静态链接函数（无法Hook）</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">internal_function</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 编译时直接嵌入二进制</span>
    <span class="hljs-comment">// 调用方式：call 0x100000f00 (直接地址)</span>
}

<span class="hljs-comment">// 动态链接函数（可以Hook）</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span> {
    <span class="hljs-comment">// 来自libSystem.dylib</span>
    <span class="hljs-comment">// 调用方式：call [__la_symbol_ptr + offset] (间接寻址)</span>
}
</code></pre>
<p><strong>关键区别：</strong> 动态链接函数通过符号指针表间接调用，Fishhook正是通过修改这个指针表中的地址来实现Hook。</p>
<h3 data-id="heading-5">3. 为什么只能Hook系统库函数？</h3>
<p>这是一个常见的误解！<strong>Fishhook不仅可以Hook系统库函数，也可以Hook自定义动态库函数。</strong></p>
<pre><code class="hljs language-objective-c" lang="objective-c">// 自定义动态库中的函数也可以Hook
__attribute__((visibility("default")))
void my_dynamic_function() {
    // 这个函数可以被Fishhook Hook
}

// 只要满足以下条件：
// 1. 函数来自动态库（不是静态链接）
// 2. 函数具有外部可见性（不是static）
// 3. 函数通过符号表引用
</code></pre>
<h2 data-id="heading-6">三、符号绑定机制深度解析</h2>
<h3 data-id="heading-7">1. 惰性绑定（Lazy Binding） vs 非惰性绑定</h3>
<h4 data-id="heading-8"><strong>惰性绑定（__la_symbol_ptr）</strong></h4>
<pre><code class="hljs language-assembly" lang="assembly">; 第一次调用printf时的流程
call printf    ; 实际调用桩代码

; __stubs中的桩代码
___stub_printf:
    jmp *___la_symbol_ptr[0]   ; 第一次跳转到dyld_stub_binder

; 绑定后的状态
___la_symbol_ptr[0] = 0x7fff12345678 (真实printf地址)
</code></pre>
<h4 data-id="heading-9"><strong>非惰性绑定（__nl_symbol_ptr）</strong></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 程序启动时立即绑定的函数</span>
<span class="hljs-comment">// 现代iOS/macOS中，__nl_symbol_ptr已较少使用</span>
<span class="hljs-comment">// 取而代之的是__got（全局偏移表）</span>

<span class="hljs-comment">// 使用__got的示例</span>
<span class="hljs-type">void</span> *function_ptr __attribute__((section(<span class="hljs-string">"__DATA,__got"</span>))) = &amp;some_function;
</code></pre>
<h4 data-id="heading-10"><strong>现代绑定机制变化</strong></h4>
<p>在现代 iOS/macOS 中，传统的 <code>__nl_symbol_ptr / __la_symbol_ptr</code> 的角色已被弱化，
编译器和 dyld 更多通过<code> GOT-like</code> 的间接寻址方式以及 <code>chained fixups</code> 机制来完成符号绑定；因此使用时需要注意是否能正确实现hook.</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 传统方式的缺点</span>
<span class="hljs-comment"># 1. 重定位表可能很大</span>
<span class="hljs-comment"># 2. 加载时需要大量随机内存访问</span>
<span class="hljs-comment"># 3. 不支持新硬件特性</span>
<span class="hljs-comment"># 4. 安全保护有限</span>

<span class="hljs-comment"># Chained Fixups 的优势</span>
<span class="hljs-comment"># 1. 更小的二进制大小（减少30-50%重定位数据）</span>
<span class="hljs-comment"># 2. 更快的启动速度</span>
<span class="hljs-comment"># 3. 支持指针认证（PAC）</span>
<span class="hljs-comment"># 4. 更好的安全性和性能</span>

// 寻址方式对比
<span class="hljs-comment">; 传统方式（x86_64）</span>
<span class="hljs-comment">; 通过 __la_symbol_ptr 调用 printf</span>
lea     rdi, <span class="hljs-section">[rip + format_string]</span>
call    qword ptr <span class="hljs-section">[rip + ___la_symbol_ptr_printf]</span>

<span class="hljs-comment">; __la_symbol_ptr 节区内容：</span>
___la_symbol_ptr_printf:
    .quad   ___dyld_stub_binder_printf

<span class="hljs-comment">; 现代方式（arm64）</span>
<span class="hljs-comment">; 通过 GOT-like 间接寻址</span>
adrp    x0, _printf@GOTPAGE     <span class="hljs-comment">; 获取 GOT 页</span>
ldr     x1, <span class="hljs-section">[x0, _printf@GOTPAGEOFF]</span> <span class="hljs-comment">; 从 GOT 加载地址</span>
blr     x1                      <span class="hljs-comment">; 间接跳转</span>

<span class="hljs-comment">; 实际上，编译器可能生成更优化的代码</span>
<span class="hljs-comment">; 直接使用 PC 相对寻址，不需要显式的 GOT 节区</span>
</code></pre>
<h3 data-id="heading-11">2. dyld_stub_binder的工作原理</h3>
<p>当第一次调用动态链接函数时，系统如何查找真实地址？</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// dyld_stub_binder的简化流程</span>
<span class="hljs-type">void</span>* <span class="hljs-title function_">dyld_stub_binder</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> lazy_binding_info_offset)</span> {
    <span class="hljs-comment">// 1. 从__LINKEDIT获取绑定信息</span>
    LazyBindingInfo *info = get_binding_info(offset);
    
    <span class="hljs-comment">// 2. 提取符号名和库序号</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *symbol_name = info-&gt;symbol_name;
    <span class="hljs-type">int</span> library_ordinal = info-&gt;library_ordinal;
    
    <span class="hljs-comment">// 3. 在指定动态库中查找符号</span>
    <span class="hljs-type">void</span> *address = find_symbol(symbol_name, library_ordinal);
    
    <span class="hljs-comment">// 4. 修改符号指针表</span>
    <span class="hljs-type">void</span> **symbol_ptr = info-&gt;symbol_pointer;
    *symbol_ptr = address;  <span class="hljs-comment">// 关键步骤！</span>
    
    <span class="hljs-comment">// 5. 跳转到目标函数</span>
    <span class="hljs-keyword">return</span> address;
}
</code></pre>
<h3 data-id="heading-12">3. ASLR（地址空间布局随机化）的影响</h3>
<p>ASLR是现代操作系统的安全特性，每次启动时系统模块的加载地址都随机变化：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 没有ASLR：</span>
<span class="hljs-comment">// printf地址固定为0x7fff12345678</span>

<span class="hljs-comment">// 有ASLR：</span>
<span class="hljs-comment">// 第一次启动：printf地址为0x7fff12345678</span>
<span class="hljs-comment">// 第二次启动：printf地址为0x7fff56789abc</span>
<span class="hljs-comment">// 第三次启动：printf地址为0x7fff9abcdef0</span>

<span class="hljs-comment">// Mach-O通过位置无关代码支持ASLR：</span>
<span class="hljs-comment">// 所有外部引用都通过指针表间接访问</span>
<span class="hljs-comment">// 指针表地址在运行时由dyld填充</span>
</code></pre>
<h2 data-id="heading-13">四、Fishhook的核心实现原理</h2>
<h3 data-id="heading-14">1. 核心数据结构：rebinding</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rebinding</span> {</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;      <span class="hljs-comment">// 要Hook的函数名</span>
    <span class="hljs-type">void</span> *replacement;     <span class="hljs-comment">// 替换函数的地址</span>
    <span class="hljs-type">void</span> **replaced;       <span class="hljs-comment">// 保存原始函数指针</span>
};
</code></pre>
<h3 data-id="heading-15">2. Fishhook的工作流程</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">rebind_symbols</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rebinding rebindings[], <span class="hljs-type">size_t</span> rebindings_nel)</span> {
    <span class="hljs-comment">// 1. 遍历所有镜像（动态库）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _dyld_image_count(); i++) {
        <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mach_header</span> *<span class="hljs-title">header</span> =</span> _dyld_get_image_header(i);
        
        <span class="hljs-comment">// 2. 查找__DATA段中的符号指针表</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">segment_command</span> *<span class="hljs-title">seg</span> =</span> find_segment(header, <span class="hljs-string">"__DATA"</span>);
        <span class="hljs-keyword">if</span> (!seg) <span class="hljs-keyword">continue</span>;
        
        <span class="hljs-comment">// 3. 查找__la_symbol_ptr和__got节</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">section</span> *<span class="hljs-title">la_section</span> =</span> find_section(seg, <span class="hljs-string">"__la_symbol_ptr"</span>);
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">section</span> *<span class="hljs-title">got_section</span> =</span> find_section(seg, <span class="hljs-string">"__got"</span>);
        
        <span class="hljs-comment">// 4. 处理每个符号指针</span>
        perform_rebinding_with_section(la_section, rebindings, rebindings_nel);
        perform_rebinding_with_section(got_section, rebindings, rebindings_nel);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-16">3. 关键函数：查找和替换符号</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">perform_rebinding_with_section</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> section *section,
                                          <span class="hljs-keyword">struct</span> rebinding rebindings[],
                                          <span class="hljs-type">size_t</span> rebindings_nel)</span> {
    <span class="hljs-comment">// 1. 获取间接符号表</span>
    <span class="hljs-type">uint32_t</span> *indirect_symbol_indices = indirect_symbol_table + section-&gt;reserved1;
    
    <span class="hljs-comment">// 2. 遍历符号指针表中的每个条目</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; section-&gt;size / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*); i++) {
        <span class="hljs-type">uint32_t</span> symtab_index = indirect_symbol_indices[i];
        
        <span class="hljs-comment">// 3. 在动态符号表中查找符号信息</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nlist_64</span> *<span class="hljs-title">symbol</span> =</span> &amp;symtab[symtab_index];
        <span class="hljs-type">uint32_t</span> strtab_offset = symbol-&gt;n_un.n_strx;
        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *symbol_name = strtab + strtab_offset;
        
        <span class="hljs-comment">// 4. 检查是否是需要Hook的函数</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; rebindings_nel; j++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(symbol_name, rebindings[j].name) == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 5. 找到目标！进行Hook</span>
                <span class="hljs-type">void</span> **symbol_ptr = (<span class="hljs-type">void</span>**)(section-&gt;addr + i * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*));
                
                <span class="hljs-comment">// 保存原始函数指针</span>
                <span class="hljs-keyword">if</span> (rebindings[j].replaced != <span class="hljs-literal">NULL</span>) {
                    *rebindings[j].replaced = *symbol_ptr;
                }
                
                <span class="hljs-comment">// 替换为新的函数地址</span>
                *symbol_ptr = rebindings[j].replacement;
                
                <span class="hljs-keyword">break</span>;
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-17">五、实际应用场景和限制</h2>
<h3 data-id="heading-18">1. 支持的函数类型</h3>



































<table><thead><tr><th>函数类型</th><th>是否支持</th><th>说明</th></tr></thead><tbody><tr><td>C函数（动态库）</td><td>✅ 完全支持</td><td>Fishhook的主要目标</td></tr><tr><td>Objective-C方法</td><td>❌ 不支持</td><td>使用Method Swizzling</td></tr><tr><td>Swift函数（@_cdecl）</td><td>✅ 条件支持</td><td>需要C接口导出</td></tr><tr><td>静态链接函数</td><td>❌ 不支持</td><td>编译时直接链接</td></tr><tr><td>内联函数</td><td>❌ 不支持</td><td>编译时展开</td></tr></tbody></table>
<h3 data-id="heading-19">2. iOS上的特殊限制</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 在非越狱iOS设备上：
// ✅ 可以Hook自己的函数和系统公开API
// ❌ 不能Hook系统私有函数（受代码签名保护）

// 在越狱iOS设备上：
// ✅ 可以Hook所有函数

// 验证方法：
#include &lt;fishhook.h&gt;
#include &lt;stdio.h&gt;

// 可以Hook的系统公开函数
static int (*original_printf)(const char *, ...);

int hooked_printf(const char *format, ...) {
    // Hook实现
    return original_printf("[HOOKED] %s", format);
}

__attribute__((constructor))
static void setup_hook() {
    struct rebinding rebind = {"printf", hooked_printf, (void**)&amp;original_printf};
    rebind_symbols(&amp;rebind, 1);
}
</code></pre>
<h3 data-id="heading-20">3. 自定义动态库的Hook</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// MyDynamicFramework.framework
__attribute__((visibility("default")))
void framework_function() {
    NSLog(@"Original framework function");
}

// 主工程中的Hook
static void (*original_framework_func)() = NULL;

void hooked_framework_func() {
    NSLog(@"Before framework function");
    original_framework_func();
    NSLog(@"After framework function");
}

// 安装Hook
struct rebinding rebind = {
    "framework_function",
    hooked_framework_func,
    (void**)&amp;original_framework_func
};
rebind_symbols(&amp;rebind, 1);
</code></pre>
<h2 data-id="heading-21">六、与Method Swizzling的对比</h2>
<h3 data-id="heading-22">1. Fishhook（C函数Hook）</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 适用于C函数</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">hook_c_function</span><span class="hljs-params">()</span> {
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rebinding</span> <span class="hljs-title">rebind</span> =</span> {<span class="hljs-string">"printf"</span>, hooked_printf, &amp;original_printf};
    rebind_symbols(&amp;rebind, <span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-23">2. Method Swizzling（Objective-C方法Hook）</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 适用于Objective-C方法
+ (void)hookObjectiveCMethod {
    Method original = class_getInstanceMethod([UIView class], @selector(setBackgroundColor:));
    Method swizzled = class_getInstanceMethod([self class], @selector(hooked_setBackgroundColor:));
    method_exchangeImplementations(original, swizzled);
}
</code></pre>
<h3 data-id="heading-24">3. 选择指南</h3>





























<table><thead><tr><th>场景</th><th>推荐技术</th></tr></thead><tbody><tr><td>Hook C系统函数</td><td>Fishhook</td></tr><tr><td>Hook C自定义函数</td><td>Fishhook</td></tr><tr><td>Hook Objective-C方法</td><td>Method Swizzling</td></tr><tr><td>Hook Swift方法</td><td>Method Swizzling（通过@objc暴露）</td></tr><tr><td>底层系统监控</td><td>Fishhook</td></tr></tbody></table>
<h2 data-id="heading-25">七、实战案例</h2>
<h3 data-id="heading-26">1. 性能监控</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 监控内存分配
static void *(*original_malloc)(size_t);
static void (*original_free)(void *);

void *hooked_malloc(size_t size) {
    void *ptr = original_malloc(size);
    
    // 记录大内存分配
    if (size &gt; 1024 * 1024) {
        printf("[MEMORY] Large malloc: %zu bytes\n", size);
    }
    
    return ptr;
}

void hooked_free(void *ptr) {
    // 可以在这里添加内存释放监控
    original_free(ptr);
}
</code></pre>
<h2 data-id="heading-27">八、常见问题解答</h2>
<h3 data-id="heading-28">Q1: Fishhook能Hook静态库函数吗？</h3>
<p><strong>A:</strong> 取决于静态库的链接方式：</p>
<ul>
<li>如果静态库被完全复制到动态库中，可以Hook</li>
<li>如果静态库保持外部引用，需要在链接静态库的地方Hook</li>
<li>静态库的私有函数（static）无法Hook</li>
</ul>
<h3 data-id="heading-29">Q2: 为什么OC和Swift方法不能用Fishhook Hook？</h3>
<p><strong>A:</strong> Objective-C和Swift的方法调用机制完全不同：</p>
<ul>
<li>Objective-C使用消息发送机制（objc_msgSend）</li>
<li>Swift有自己的分发机制（虚函数表、直接调用等）</li>
<li>它们不通过符号绑定表调用，因此Fishhook无法修改</li>
</ul>
<h3 data-id="heading-30">Q3: Hook的时机是什么？</h3>
<p><strong>A:</strong> Fishhook可以在运行时任何时间点进行Hook，但最佳实践是：</p>
<pre><code class="hljs language-objective-c" lang="objective-c">// 1. 程序启动时（推荐）
__attribute__((constructor))
static void setup_hooks() {
    // 在main()函数之前执行
}

// 2. 运行时动态Hook
void dynamic_hook() {
    // 可以在需要时动态安装或移除Hook
}

// 3. 使用dispatch_once保证只Hook一次
static dispatch_once_t onceToken;
dispatch_once(&amp;onceToken, ^{
    // 安装Hook
});
</code></pre>
<h3 data-id="heading-31">Q4: 在MachOView中为什么看不到__nl_symbol_ptr？</h3>
<p><strong>A:</strong> 在现代iOS/macOS系统中：</p>
<ul>
<li><code>__nl_symbol_ptr</code>已被<code>__got</code>（全局偏移表）替代</li>
<li>所有需要立即绑定的符号现在都放在<code>__got</code>中</li>
<li>这是为了更好的位置无关代码支持和性能优化</li>
</ul>
<h2 data-id="heading-32">九、Fishhook的局限性</h2>
<h3 data-id="heading-33">1. 技术限制</h3>
<ul>
<li>只能Hook通过符号表调用的函数</li>
<li>无法Hook内联函数和静态链接函数</li>
<li>对C++函数支持有限（名称重整问题）</li>
<li>线程安全问题需要开发者自己处理</li>
</ul>
<h3 data-id="heading-34">2. 平台限制</h3>
<ul>
<li>iOS非越狱设备受限较多</li>
<li>某些系统函数受代码签名保护</li>
<li>不同iOS版本可能有行为差异</li>
</ul>
<h3 data-id="heading-35">3. 性能考虑</h3>
<ul>
<li>第一次Hook需要遍历符号表，有性能开销</li>
<li>频繁的动态Hook/Unhook可能影响性能</li>
<li>需要考虑多线程环境下的安全性</li>
</ul>
<h2 data-id="heading-36">十、未来展望</h2>
<h3 data-id="heading-37">1. 替代方案</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 1. Dobby（原DobbyHook）
// 支持inline hook，更强大
#include &lt;dobby.h&gt;
DobbyHook((void *)printf, (void *)hooked_printf, (void **)&amp;original_printf);

// 2. substrate（越狱设备）
// iOS越狱环境下的完整Hook框架
MSHookFunction((void *)printf, (void *)hooked_printf, (void **)&amp;original_printf);
</code></pre>
<h3 data-id="heading-38">2. 发展趋势</h3>
<ul>
<li>Apple正在加强系统安全性</li>
<li>静态分析和运行时保护机制增强</li>
<li>对动态代码修改的限制可能增加</li>
<li>开发者需要更多关注官方提供的调试和监控API</li>
</ul>
<h2 data-id="heading-39">结语</h2>
<p>Fishhook通过精巧地利用Mach-O文件的动态链接机制，实现了轻量级的函数Hook功能。虽然它有一定的局限性，但仍然是理解macOS/iOS系统底层机制的绝佳案例，也是许多调试和监控工具的基础。</p>
<p>通过本文的详细解析，我们希望读者能够：</p>
<ol>
<li>深入理解Mach-O文件结构和动态链接机制</li>
<li>掌握Fishhook的工作原理和使用方法</li>
<li>了解不同Hook技术的适用场景</li>
<li>在实际开发中正确应用Hook技术</li>
</ol>
<p>记住，强大的工具也意味着重大的责任。Hook技术应该用于正当的调试、监控和优化目的，而不是破坏系统安全或侵犯用户隐私。</p>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Ffishhook" target="_blank" title="https://github.com/facebook/fishhook" ref="nofollow noopener noreferrer">Fishhook GitHub仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Farchive%2Fdocumentation%2FPerformance%2FConceptual%2FCodeFootprint%2FArticles%2FMachOOverview.html" target="_blank" title="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/CodeFootprint/Articles/MachOOverview.html" ref="nofollow noopener noreferrer">Apple Mach-O文件格式文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopensource.apple.com%2Fsource%2Fdyld%2F" target="_blank" title="https://opensource.apple.com/source/dyld/" ref="nofollow noopener noreferrer">dyld源码分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.douban.com%2Fsubject%2F30227889%2F" target="_blank" title="https://book.douban.com/subject/30227889/" ref="nofollow noopener noreferrer">iOS逆向工程：原理与实践</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[中国AI模型登顶！阿里的Z-Image-Turbo 成为文生图天花板]]></title>    <link>https://juejin.cn/post/7596989416760541219</link>    <guid>https://juejin.cn/post/7596989416760541219</guid>    <pubDate>2026-01-20T04:13:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596989416760541219" data-draft-id="7596989416760524835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="中国AI模型登顶！阿里的Z-Image-Turbo 成为文生图天花板"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-20T04:13:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摸鱼的春哥"/> <meta itemprop="url" content="https://juejin.cn/user/1714893870865303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            中国AI模型登顶！阿里的Z-Image-Turbo 成为文生图天花板
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893870865303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摸鱼的春哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:13:47.000Z" title="Tue Jan 20 2026 04:13:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说实话，这几个月 AI 圈子的变化快得让人有点跟不上。</p>
<p>前阵子大家还在讨论国外的 Midjourney V6 或是 Flux 有多强，结果一转眼，国产模型又杀出来了。</p>
<p>这次的主角是阿里的 Z-Image-Turbo。</p>
<p>名字听起来挺硬核的，但简单来说，它刚刚在一众评测里拿了个第一，算是把“文生图”这个领域的天花板，又往上顶了顶。</p>
<h2 data-id="heading-0">1. 不只是“画得好”，关键是“快”</h2>
<p>大家玩 AI 绘画，最头疼的是什么？除了要费劲写提示词，就是“等”。</p>
<p>以前生成一张高清大图，你可能得去倒杯水，甚至还得修修补补半天。但这次 Z-Image-Turbo 最大的卖点，就在那个 "Turbo" 上。</p>
<p>它的出图速度非常夸张。怎么形容呢？差不多就是你刚敲完回车，脑子里的画面还没完全定型，屏幕上图已经出来了。而且，这可不是那种糊弄人的草图，是那种光影、纹理、甚至是毛发细节都拉满的成品。</p>
<p>有测评博主试了一下，同样的复杂场景——比如“雨夜霓虹灯下的机械姬”，它处理反光和水渍的质感，比之前的行业老大还要自然。这种感觉，就像是给你的显卡打了鸡血一样。</p>
<p>我尝试了以下提示词：</p>
<blockquote>
<p>一张充满张力的漫画风格摄影作品。夜晚，霓虹灯闪烁的赛博朋克街道。一位身穿JK制服的少女，摆出专业的日本女武士拔刀起势姿态（居合道架势），身体重心下沉。她的左手紧握腰间的刀鞘，右手反手握住刀柄，准备拔刀。强烈的彩色霓虹光从她背后照射，勾勒出帅气的剪影轮廓光。她猛然回头看向身后，眼神警觉、锐利，又带有一丝被惊动的慌乱。雨夜湿漉漉的地面反射着光影，颗粒感，极具冲击力。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aadc21030ed74d579cfd2ee4dfe49098~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769487226&amp;x-signature=Q56xMyWfg1hFvQ5azG7JHU6sAhM%3D" alt="" loading="lazy"/></p>
<p>效果非常不错。</p>
<h2 data-id="heading-1">2. 终于不用那是蹩脚的“机翻英文”了</h2>
<p>对于咱们国内用户来说，Z-Image-Turbo 最让人舒服的一点，其实是懂中文。</p>
<p>玩过国外模型的朋友都知道，为了让 AI 听懂人话，不仅得用英文写提示词，还得背各种复杂的语法公式。想画个“红烧肉”，如果不描述清楚肥瘦相间、色泽红亮，它很可能给你画出一块奇怪的生肉。</p>
<p>但阿里的这个模型毕竟是自家孩子，对中文语境的理解那是真的到位。</p>
<p>你直接输入一句大白话，他就能get到我们中国的点，比如：</p>
<blockquote>
<p>大师级作品，油画媒介，半身肖像，1个女孩，特写，斑驳的阳光，丁达尔效应（光柱），光斑落在皮肤上，温暖的金光，绚烂的色彩，丰富的笔触感，厚涂法，秋日氛围，柔焦，梦幻，极其细致的皮肤质感。</p>
</blockquote>
<p>效果如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40a5b164343241b5b0ce6ac43c26deb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769487226&amp;x-signature=G7%2BijKhFOf47grx2%2F24cAW5HYaI%3D" alt="" loading="lazy"/></p>
<p>说白了，它降低了咱们普通人玩 AI 的门槛。不用学咒语，只要你会说话，就能当画家。</p>
<h2 data-id="heading-2">3. 最重要的，能白嫖试用</h2>
<p>感兴趣的可以访问网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.z-image-pro.com%2F" target="_blank" title="https://www.z-image-pro.com/" ref="nofollow noopener noreferrer">www.z-image-pro.com/</a> 进行免费试用。</p>
<p>如果你是开发者，你甚至能白嫖API。</p>
<p>当然了，AI 这个领域大家也知道，今天的第一名，可能下个月就被超越了。</p>
<p>但 Z-Image-Turbo 的出现，至少证明了一件事：在审美和技术结合这块，国产模型已经完全不虚那几家国外巨头了。如果你最近正好想做点海报，或者单纯想画着玩，真的可以去试试这个新“天花板”。</p>
<p>毕竟，好用、听话、还画得快，谁能拒绝呢？</p>
<p>一张它画的小怪兽镇楼：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da3a1255f4c947c29f22e4607ae275a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pG46bG855qE5pil5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769487226&amp;x-signature=k6BNAHxQSq5jj94qjYObYU6K90Q%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用C#高效嵌入文件和注释附件到PDF文档]]></title>    <link>https://juejin.cn/post/7596989416760377379</link>    <guid>https://juejin.cn/post/7596989416760377379</guid>    <pubDate>2026-01-20T03:39:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596989416760377379" data-draft-id="7596962344045789224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用C#高效嵌入文件和注释附件到PDF文档"/> <meta itemprop="keywords" content="后端,C#"/> <meta itemprop="datePublished" content="2026-01-20T03:39:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户835629078051"/> <meta itemprop="url" content="https://juejin.cn/user/3150554985403516"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用C#高效嵌入文件和注释附件到PDF文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3150554985403516/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户835629078051
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:39:08.000Z" title="Tue Jan 20 2026 03:39:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d48f5da43fee40d38ca3fbc06f73861d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODM1NjI5MDc4MDUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485148&amp;x-signature=jtjCFGXZoSeBxjiKKTfdIXQ4TFc%3D" alt="如何使用C#在PDF文档中插入附件" loading="lazy"/></p>
<p>在现代办公和数据交换中，PDF文档因其跨平台、内容固定等特性，已经成为不可或缺的一部分。然而，有时我们不仅需要共享PDF内容本身，还需要附带一些相关的支持文件，例如源数据文件、详细报告、多媒体内容或是补充说明。这时，如何在PDF文档中高效且专业地嵌入附件，就成为了一个重要的需求。</p>
<p>本教程将深入探讨如何在C#编程环境中，利用强大的Spire.PDF for .NET库实现PDF附件的插入。我们将详细介绍两种关键的附件插入方法：<strong>直接插入附件</strong>和<strong>插入附件注释</strong>，帮助您根据不同场景选择最合适的方案，从而显著提升您的文档处理能力。</p>
<h2 data-id="heading-0">理解PDF附件及其应用场景</h2>
<p>PDF附件，顾名思义，就是嵌入在PDF文件内部的另一个文件。它与普通的超链接或文件路径引用不同，附件是文件本身的一部分，即使PDF文件被移动或重命名，附件依然保持可访问性，无需担心链接失效。</p>
<p>PDF附件的应用场景非常广泛：</p>
<ul>
<li><strong>数据归档与溯源：</strong> 将生成PDF报告的原始数据文件（如Excel、CSV）作为附件嵌入，方便日后查阅和验证。</li>
<li><strong>多媒体内容嵌入：</strong> 在演示文稿或电子书中嵌入视频、音频文件，提供更丰富的阅读体验。</li>
<li><strong>补充文档：</strong> 将合同的附件、技术手册的补充说明等作为附件，确保所有相关信息集中管理。</li>
<li><strong>源代码或配置：</strong> 对于技术文档，可以将示例代码或配置文件作为附件，方便用户直接获取。</li>
</ul>
<p>为了在C#中实现这些功能，我们将依赖于一个专业的PDF处理库——Spire.PDF for .NET。它提供了丰富的API，使开发者能够轻松地创建、修改、读取和转换PDF文档，包括对附件的全面支持。</p>
<h2 data-id="heading-1">使用C#直接插入附件到PDF</h2>
<p>直接插入附件指的是将一个文件作为“包裹”在PDF内部的数据流，通常在PDF阅读器的“附件”面板中可见。这种方式适用于需要批量嵌入附件或附件作为背景数据，不直接在页面上显示的情况。</p>
<h3 data-id="heading-2">详细步骤</h3>
<ol>
<li><strong>环境准备：</strong>
首先，您需要在您的.NET项目中安装Spire.PDF for .NET库。最便捷的方式是通过NuGet包管理器：
Install-Package Spire.PDF</li>
<li><strong>创建或加载PDF文档：</strong>
您可以创建一个新的PDF文档，或者加载一个现有的PDF文档。</li>
<li><strong>选择附件文件：</strong>
指定您希望作为附件插入的文件的路径。</li>
<li><strong>添加附件到PDF文档的附件集合中：</strong>
使用<code>PdfAttachment</code>类创建附件对象，并将其添加到<code>PdfDocument</code>的<code>Attachments</code>集合中。</li>
<li><strong>保存修改后的PDF文档：</strong>
将包含新附件的PDF文档保存到指定路径。</li>
</ol>
<h3 data-id="heading-3">C#代码示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Spire.Pdf;
<span class="hljs-keyword">using</span> Spire.Pdf.Attachments;
<span class="hljs-keyword">using</span> System.IO;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">InsertPdfAttachment</span>
{
    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-comment">// 1. 创建一个新的PDF文档</span>
            PdfDocument doc = <span class="hljs-keyword">new</span> PdfDocument();
            doc.LoadFromFile(<span class="hljs-string">"Input.pdf"</span>); <span class="hljs-comment">// 如果您想加载现有PDF，请使用此行</span>

            <span class="hljs-comment">// 添加一个页面以确保文档有内容（如果是新文档）</span>
            <span class="hljs-keyword">if</span> (doc.Pages.Count == <span class="hljs-number">0</span>)
            {
                doc.Pages.Add();
            }

            <span class="hljs-comment">// 2. 指定附件文件路径</span>
            <span class="hljs-built_in">string</span> attachmentFilePath = <span class="hljs-string">"Sample.xlsx"</span>; <span class="hljs-comment">// 这是一个示例Excel文件</span>

            <span class="hljs-comment">// 创建一个示例附件文件（如果不存在）</span>
            <span class="hljs-keyword">if</span> (!File.Exists(attachmentFilePath))
            {
                File.WriteAllText(attachmentFilePath, <span class="hljs-string">"This is a sample text attachment content."</span>);
            }

            <span class="hljs-comment">// 3. 创建PdfAttachment对象</span>
            PdfAttachment attachment = <span class="hljs-keyword">new</span> PdfAttachment(attachmentFilePath);

            <span class="hljs-comment">// 读取附件文件的所有字节数据</span>
            attachment.Data = File.ReadAllBytes(attachmentFilePath);

            <span class="hljs-comment">// 设置附件的描述和MIME类型（可选）</span>
            attachment.Description = <span class="hljs-string">"这是一个示例文本附件。"</span>;
            attachment.MimeType = <span class="hljs-string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>; <span class="hljs-comment">// 可选，可根据附件类型设置MIME类型</span>

            <span class="hljs-comment">// 4. 将附件添加到PDF文档的Attachments集合中</span>
            doc.Attachments.Add(attachment);

            <span class="hljs-comment">// 5. 保存修改后的PDF文档</span>
            doc.SaveToFile(<span class="hljs-string">"PdfWithDirectAttachment.pdf"</span>);
            doc.Close();

            Console.WriteLine(<span class="hljs-string">"附件已成功直接插入到PDF文档中！"</span>);
        }
    }
}
</code></pre>
<p><strong>结果文档预览：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3861a398bbc0437cb44fd3269abc86f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODM1NjI5MDc4MDUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485148&amp;x-signature=QG1eRrxn6zW9zxiiWj8p2X5fu7o%3D" alt="使用C#在PDF文档中直接插入附件" loading="lazy"/></p>
<h3 data-id="heading-4">解释和注意事项</h3>
<ul>
<li><code>PdfAttachment attachment = new PdfAttachment(attachmentFilePath);</code>：构造函数接收附件的文件名，这通常是附件在PDF阅读器中显示的名称。</li>
<li><code>attachment.Data = File.ReadAllBytes(attachmentFilePath);</code>：这是关键一步，将附件文件的二进制内容读取并赋值给<code>Data</code>属性。</li>
<li><code>attachment.Description</code>和<code>attachment.MimeType</code>：这些属性是可选的，但建议设置，它们提供了关于附件的额外信息，有助于阅读器正确处理和显示附件。</li>
<li>文件路径：请确保<code>attachmentFilePath</code>指向的文件实际存在。在实际应用中，您可能需要处理文件不存在的异常。</li>
</ul>
<h2 data-id="heading-5">使用C#插入附件注释</h2>
<p>附件注释（Attachment Annotation）则更为直观和交互。它会在PDF页面上显示一个图标（例如一个回形针），用户点击该图标即可打开或保存附件。这种方式适用于需要在PDF特定位置明确指示附件存在，并提供用户交互的场景。</p>
<h3 data-id="heading-6">详细步骤</h3>
<ol>
<li><strong>创建或加载PDF文档：</strong>
与直接插入附件相同。</li>
<li><strong>选择附件文件：</strong>
指定您希望作为附件注释插入的文件的路径。</li>
<li><strong>创建附件注释对象：</strong>
实例化<code>PdfAttachmentAnnotation</code>类，并指定其在PDF页面上的位置和大小。</li>
<li><strong>关联附件文件到附件注释：</strong>
通过<code>Attachment</code>属性将之前创建的<code>PdfAttachment</code>对象与注释关联起来。</li>
<li><strong>将附件注释添加到PDF页面：</strong>
将创建好的<code>PdfAttachmentAnnotation</code>对象添加到目标页面的<code>Annotations</code>集合中。</li>
<li><strong>保存修改后的PDF文档。</strong></li>
</ol>
<h3 data-id="heading-7">C#代码示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Spire.Pdf;
<span class="hljs-keyword">using</span> Spire.Pdf.Annotations;
<span class="hljs-keyword">using</span> Spire.Pdf.Attachments;
<span class="hljs-keyword">using</span> System.Drawing;
<span class="hljs-keyword">using</span> System.IO;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">InsertPdfAttachmentAnnotation</span>
{
    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-comment">// 1. 创建一个新的PDF文档</span>
            PdfDocument doc = <span class="hljs-keyword">new</span> PdfDocument();
            <span class="hljs-comment">//doc.LoadFromFile("Input.pdf"); // 如果您想加载现有PDF，请使用此行</span>

            <span class="hljs-comment">// 获取第一个页面（如果文档为空，则添加一个新页面）</span>
            PdfPageBase page = doc.Pages.Count &gt; <span class="hljs-number">0</span> ? doc.Pages[<span class="hljs-number">0</span>] : doc.Pages.Add();

            <span class="hljs-comment">// 2. 指定附件文件路径</span>
            <span class="hljs-built_in">string</span> attachmentFilePath = <span class="hljs-string">"Ocean1.png"</span>; <span class="hljs-comment">// 这是一个示例图片文件</span>

            <span class="hljs-comment">// 创建一个示例附件文件（如果不存在）</span>
            <span class="hljs-keyword">if</span> (!File.Exists(attachmentFilePath))
            {
                <span class="hljs-comment">// 简单创建一个空白图片作为示例</span>
                <span class="hljs-keyword">using</span> (Bitmap bmp = <span class="hljs-keyword">new</span> Bitmap(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>))
                {
                    <span class="hljs-keyword">using</span> (Graphics g = Graphics.FromImage(bmp))
                    {
                        g.FillRectangle(Brushes.LightBlue, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
                        g.DrawString(<span class="hljs-string">"附件内容"</span>, <span class="hljs-keyword">new</span> Font(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">12</span>), Brushes.Black, <span class="hljs-number">10</span>, <span class="hljs-number">40</span>);
                    }
                    bmp.Save(attachmentFilePath, System.Drawing.Imaging.ImageFormat.Png);
                }
            }

            <span class="hljs-comment">// 3. 创建PdfAttachment对象（与直接插入附件类似）</span>
            PdfAttachment attachment = <span class="hljs-keyword">new</span> PdfAttachment(attachmentFilePath);
            attachment.Data = File.ReadAllBytes(attachmentFilePath);
            attachment.Description = <span class="hljs-string">"这是一个示例图片附件。"</span>;

            <span class="hljs-comment">// 4. 创建附件注释对象，并指定其在页面上的位置和大小</span>
            <span class="hljs-comment">// 在页面坐标 (100, 100) 处创建一个 24x24 像素的注释图标</span>
            RectangleF annotationBounds = <span class="hljs-keyword">new</span> RectangleF(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">24</span>, <span class="hljs-number">24</span>);
            PdfAttachmentAnnotation attachmentAnnotation = <span class="hljs-keyword">new</span> PdfAttachmentAnnotation(annotationBounds, attachment.FileName, attachment.Data);

            <span class="hljs-comment">// 5. 设置附件注释的属性（可选）</span>
            attachmentAnnotation.Icon = PdfAttachmentIcon.Paperclip; <span class="hljs-comment">// 设置图标样式，例如回形针</span>
            attachmentAnnotation.Text = <span class="hljs-string">"点击查看图片附件"</span>; <span class="hljs-comment">// 鼠标悬停时的提示文本</span>
            attachmentAnnotation.Color = Color.LightBlue; <span class="hljs-comment">// 设置注释图标的背景颜色</span>

            <span class="hljs-comment">// 6. 将附件注释添加到PDF页面</span>
            page.Annotations.Add(attachmentAnnotation);

            <span class="hljs-comment">// 7. 保存修改后的PDF文档</span>
            doc.SaveToFile(<span class="hljs-string">"PdfWithAttachmentAnnotation.pdf"</span>);
            doc.Close();

            Console.WriteLine(<span class="hljs-string">"附件注释已成功插入到PDF文档中！"</span>);
        }
    }
}
</code></pre>
<p><strong>结果文档预览：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5320a7e8cfc74a378e394a8469c0f7c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODM1NjI5MDc4MDUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485148&amp;x-signature=s9HXCKaSTKaut23bgtKPUMuEtmA%3D" alt="使用C#在PDF文档中插入附件注释" loading="lazy"/></p>
<h3 data-id="heading-8">解释和注意事项</h3>
<ul>
<li><code>RectangleF annotationBounds = new RectangleF(100, 100, 24, 24);</code>：定义了附件注释图标在页面上的位置（X, Y）和大小（宽度，高度）。</li>
<li><code>PdfAttachmentAnnotation attachmentAnnotation = new PdfAttachmentAnnotation(annotationBounds, fileName, attatchmentData);</code>：构造函数需要注释的边界和要关联的<code>PdfAttachment</code>对象。</li>
<li><code>attachmentAnnotation.Icon = PdfAttachmentIcon.Paperclip;</code>：您可以选择不同的内置图标样式，例如<code>PushPin</code>、<code>Graph</code>等。</li>
<li><code>attachmentAnnotation.Text</code>：鼠标悬停在图标上时显示的文本，提供更好的用户体验。</li>
<li><code>attachmentAnnotation.Color</code>：自定义注释图标的颜色。</li>
</ul>
<h2 data-id="heading-9">两种方法的对比与选择</h2>
<p>了解了两种附件插入方式后，我们可以通过对比来帮助您做出更明智的选择。</p>






























<table><thead><tr><th align="left">特点</th><th align="left">直接插入附件</th><th align="left">插入附件注释</th></tr></thead><tbody><tr><td align="left"><strong>可见性</strong></td><td align="left">通常不可见，需通过PDF阅读器菜单（如“附件”面板）访问</td><td align="left">在PDF页面上显示图标，直观可见，指示附件位置</td></tr><tr><td align="left"><strong>交互性</strong></td><td align="left">较低，用户需主动查找并打开附件</td><td align="left">较高，用户可直接点击页面上的图标来打开附件</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">批量嵌入背景数据、元数据、不需直接在页面上交互的文件；对文件大小有较高要求时，可避免页面渲染额外元素。</td><td align="left">需要明确指示附件位置、提供用户交互、增强文档内容的可读性和功能性；例如在特定图表旁边附加原始数据，或在段落旁附加补充说明。</td></tr><tr><td align="left"><strong>复杂性</strong></td><td align="left">相对简单，只需创建附件对象并添加到文档集合</td><td align="left">略复杂，需考虑注释的位置、大小、图标样式等页面布局因素</td></tr></tbody></table>
<p><strong>选择建议：</strong></p>
<ul>
<li>如果您只是想将一些辅助文件打包到PDF中，而不需要在PDF页面上显示任何指示，或者附件数量较多、不适合在页面上逐一展示，那么<strong>直接插入附件</strong>是更简洁高效的选择。</li>
<li>如果您希望用户能够直观地看到附件的存在，并通过点击页面上的特定区域来访问附件，例如在报告的某个图表旁附上原始数据，或者在说明文档的某处提供一个视频教程，那么<strong>插入附件注释</strong>将提供更好的用户体验和交互性。</li>
</ul>
<h2 data-id="heading-10">结语</h2>
<p>通过本教程，我们深入探讨了如何使用C#和Spire.PDF for .NET库在PDF文档中插入附件。无论是选择直接将文件嵌入PDF，还是通过附件注释提供更具交互性的体验，Spire.PDF都提供了强大且灵活的工具来满足您的需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[新建一个angular项目]]></title>    <link>https://juejin.cn/post/7596975035438612489</link>    <guid>https://juejin.cn/post/7596975035438612489</guid>    <pubDate>2026-01-20T03:42:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438612489" data-draft-id="7596983314806751282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="新建一个angular项目"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T03:42:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="米诺zuo"/> <meta itemprop="url" content="https://juejin.cn/user/2436173497373399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            新建一个angular项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173497373399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    米诺zuo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:42:35.000Z" title="Tue Jan 20 2026 03:42:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">新建一个 Angular 项目主要分为三个步骤：<strong>安装环境</strong>、<strong>创建项目</strong> 和 <strong>启动项目</strong>。</h2>
<h3 data-id="heading-1">第一步：安装必要的环境</h3>
<p>在使用 Angular 之前，你的电脑上必须安装 <strong>Node.js</strong>。Angular CLI（命令行工具）依赖于 Node.js 来运行。</p>
<ol>
<li><strong>安装 Node.js</strong>：
<ul>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer">Node.js 官网</a>。</li>
<li>下载并安装 <strong>LTS 版本</strong>（长期支持版，最稳定）。</li>
<li><em>提示：安装后，在终端输入 <code>node -v</code> 和 <code>npm -v</code> 检查是否安装成功。</em></li>
</ul>
</li>
<li><strong>全局安装 Angular CLI</strong>：
<ul>
<li>打开终端（Terminal、CMD 或 PowerShell）。</li>
<li>输入以下命令并回车：
<pre><code class="hljs language-bash" lang="bash">npm install -g @angular/cli
</code></pre>
</li>
<li>这个命令会全局安装 Angular 的命令行工具，安装完成后，你可以输入 <code>ng version</code> 来检查是否安装成功。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-2">第二步：创建新项目</h3>
<p>环境准备好后，使用 <code>ng new</code> 命令来创建项目。</p>
<ol>
<li><strong>进入你想要存放项目的目录</strong>（例如 <code>cd Desktop</code>）。</li>
<li><strong>运行创建命令</strong>：
<pre><code class="hljs language-bash" lang="bash">ng new my-first-app
</code></pre>
<em>(注：<code>my-first-app</code> 是你的项目名称，可以自定义)</em></li>
<li><strong>回答配置问题</strong>（以 Angular 17+ 为例）：
命令运行后，CLI 会询问你几个问题来配置项目。通常建议新手如下选择（按提示输入字母并回车）：
<ul>
<li><strong>Which stylesheet format would you like to use?</strong> (你想使用哪种样式表格式？)
<ul>
<li>建议选择：<code>CSS</code> (如果你不熟悉 SCSS/Sass，选 CSS 最简单)</li>
</ul>
</li>
<li><strong>Do you want to enable Server-Side Rendering (SSR) and Static Site Generation (SSG/Prerendering)?</strong> (是否启用服务端渲染？)
<ul>
<li>建议选择：<code>N</code> (No)</li>
<li><em>理由：对于初学者构建普通单页应用，不需要 SSR，这样构建速度更快。</em></li>
</ul>
</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-3">第三步：启动开发服务器</h3>
<p>项目创建完成后，进入项目文件夹并启动它。</p>
<ol>
<li><strong>进入项目目录</strong>：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> my-first-app
</code></pre>
</li>
<li><strong>启动项目</strong>：
<pre><code class="hljs language-bash" lang="bash">ng serve
</code></pre>
<em>(或者使用简写 <code>npm start</code>)</em></li>
<li><strong>查看结果</strong>：
<ul>
<li>终端显示 <code>Local: http://localhost:4200/</code> 表示编译成功。</li>
<li>打开浏览器，访问 <code>http://localhost:4200/</code>。</li>
<li>如果看到 Angular 的欢迎页面（大大的 Angular Logo），恭喜你，项目创建成功！</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-4">常用附加操作</h3>
<h4 data-id="heading-5">1. 使用 VS Code 打开项目</h4>
<p>如果你使用 Visual Studio Code 编写代码，可以在终端中输入：</p>
<pre><code class="hljs language-bash" lang="bash">code .
</code></pre>
<p><em>(注意：需要确保你已经安装了 VS Code 并将其添加到了系统环境变量中)</em></p>
<h4 data-id="heading-6">2. 创建一个新组件</h4>
<p>在开发过程中，你通常需要创建新的组件。不要手动创建文件，请使用 CLI 命令：</p>
<pre><code class="hljs language-bash" lang="bash">ng generate component my-new-component
</code></pre>
<h2 data-id="heading-7"><em>(简写: <code>ng g c my-new-component</code>)</em></h2>
<h3 data-id="heading-8">常见问题排查</h3>
<ol>
<li><strong><code>ng</code> 命令找不到</strong>：
<ul>
<li>说明 Angular CLI 没有正确安装或环境变量没配置好。尝试重新运行 <code>npm install -g @angular/cli</code>。</li>
</ul>
</li>
<li><strong>安装速度极慢</strong>：
<ul>
<li>如果你在中国大陆，直接从 npm 服务器下载依赖可能会很慢。建议安装淘宝镜像源：
<pre><code class="hljs language-bash" lang="bash">npm config <span class="hljs-built_in">set</span> registry https://registry.npmmirror.com
</code></pre>
</li>
</ul>
</li>
<li><strong>端口被占用</strong>：
<ul>
<li>如果 4200 端口被占用，可以使用 <code>ng serve --port 4300</code> 来指定其他端口。
祝你开发顺利！</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Composable 中处理 DOM 元素]]></title>    <link>https://juejin.cn/post/7596993862533922816</link>    <guid>https://juejin.cn/post/7596993862533922816</guid>    <pubDate>2026-01-20T03:43:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596993862533922816" data-draft-id="7596993862533890048" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Composable 中处理 DOM 元素"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-20T03:43:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unknown331"/> <meta itemprop="url" content="https://juejin.cn/user/2826172528344323"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Composable 中处理 DOM 元素
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2826172528344323/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unknown331
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:43:06.000Z" title="Tue Jan 20 2026 03:43:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一个非常经典的问题：在 Composable 中处理 DOM 元素。</p>
<p>答案是：<strong>可以抽离，而且非常推荐。</strong> 在 Vue 3 的 Composition API 中，你可以直接将 <code>ref(null)</code> 定义在 Composable 内部并返回，或者从外部将 DOM Ref 作为参数传入。</p>
<p>为了保持逻辑的纯粹性，我建议采用 <strong>“定义在内，暴露在外”</strong> 的方案。这样 <code>InputField.vue</code> 就不需要维护这个 DOM 引用了。</p>
<hr/>
<h3 data-id="heading-0">1. 编写 <code>useInputHistory.js</code></h3>
<p>我们需要将 <code>chatStore</code> 的操作、<code>nextTick</code> 逻辑以及光标控制（<code>placeCaretAtEnd</code>）全部收拢。</p>
<p>JavaScript</p>
<pre><code class="hljs language-ini" lang="ini">// composables/useInputHistory.js
import { ref, nextTick } from 'vue'<span class="hljs-comment">;</span>
import { useChatStore } from '../stores/chat.js'<span class="hljs-comment">;</span>

export function useInputHistory() {
  const <span class="hljs-attr">chatStore</span> = useChatStore()<span class="hljs-comment">;</span>
  
  // 在 Composable 内部定义 DOM Ref
  const <span class="hljs-attr">skillAreaRef</span> = ref(null)<span class="hljs-comment">;</span>

  // 辅助函数：将光标移至 contenteditable 末尾
  const <span class="hljs-attr">placeCaretAtEnd</span> = () =&gt; {
    const <span class="hljs-attr">el</span> = skillAreaRef.value<span class="hljs-comment">;</span>
    if (!el) return<span class="hljs-comment">;</span>
    const <span class="hljs-attr">range</span> = document.createRange()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">selection</span> = window.getSelection()<span class="hljs-comment">;</span>
    range.selectNodeContents(el)<span class="hljs-comment">;</span>
    range.collapse(false)<span class="hljs-comment">;</span>
    selection.removeAllRanges()<span class="hljs-comment">;</span>
    selection.addRange(range)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  /**
   * 撤销或重做逻辑
   * @param {string} keyFlag 'z' 或 'y'
   * @param {Ref} userInput 外部传入的普通输入框文本引用
   * @param {string} mode 模式标识
   */
  const <span class="hljs-attr">unOrRedo</span> = async (keyFlag, userInput, mode = null) =&gt; {
    // 1. 获取 store 计算后的新文本
    const <span class="hljs-attr">finallyMsg</span> = chatStore.operationOfInput(keyFlag)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">newContent</span> = finallyMsg ?? <span class="hljs-string">''</span><span class="hljs-comment">;</span>

    // 2. 更新基础 userInput (textarea 使用)
    <span class="hljs-attr">userInput.value</span> = newContent<span class="hljs-comment">;</span>

    // 3. 处理翻译模式 (contenteditable 使用)
    if (<span class="hljs-attr">mode</span> === <span class="hljs-string">'translate'</span> &amp;&amp; skillAreaRef.value) {
      if (!newContent) {
        // 处理特殊占位符逻辑
        <span class="hljs-attr">skillAreaRef.value.innerText</span> = <span class="hljs-string">'\u200B'</span><span class="hljs-comment">;</span>
        skillAreaRef.value.classList.add('empty')<span class="hljs-comment">;</span>
      } else {
        <span class="hljs-attr">skillAreaRef.value.innerText</span> = newContent<span class="hljs-comment">;</span>
        skillAreaRef.value.classList.remove('empty')<span class="hljs-comment">;</span>
      }

      // 等待 DOM 更新后重置光标
      await nextTick()<span class="hljs-comment">;</span>
      placeCaretAtEnd()<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return {
    skillAreaRef, // 暴露出去，让模板进行绑定
    unOrRedo
  }<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-1">2. 在 <code>InputField.vue</code> 中替换逻辑</h3>
<p>现在，你需要删除组件内原有的 <code>skillAreaRef</code> 定义，改为从 Hook 中获取。</p>
<p>JavaScript</p>
<pre><code class="hljs language-xml" lang="xml">// InputField.vue
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// ... 其他引入</span>
<span class="hljs-keyword">import</span> { useInputHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ChatInput/composables/useInputHistory.js'</span>;

<span class="hljs-comment">// 1. 初始化 Hook</span>
<span class="hljs-comment">// 注意：这里拿到的 skillAreaRef 直接对应模板里的 ref="skillAreaRef"</span>
<span class="hljs-keyword">const</span> { skillAreaRef, unOrRedo } = <span class="hljs-title function_">useInputHistory</span>();

<span class="hljs-comment">// 2. 之前的 handleKeydown 和 handleTranslateKeydown 逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleKeydown</span> = (<span class="hljs-params">event</span>) =&gt; {
  <span class="hljs-comment">// ... </span>
  <span class="hljs-keyword">if</span> (ctrlKey &amp;&amp; (keyFlag === <span class="hljs-string">'z'</span> || keyFlag === <span class="hljs-string">'y'</span>)) {
    event.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-comment">// 传入 userInput，Hook 会自动处理文本框和 skillArea</span>
    <span class="hljs-title function_">unOrRedo</span>(keyFlag, userInput); 
    <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTranslateKeydown</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">if</span> (ctrlKey &amp;&amp; (keyFlag === <span class="hljs-string">'z'</span> || keyFlag === <span class="hljs-string">'y'</span>)) {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-comment">// 传入模式标识 'translate'</span>
    <span class="hljs-title function_">unOrRedo</span>(keyFlag, userInput, <span class="hljs-string">'translate'</span>);
    <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-comment">// 3. 删除组件内原来的 unOrRedo 函数和 placeCaretAtEnd 函数</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"skillAreaRef"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"skill-user-message"</span>
    <span class="hljs-attr">...</span>
  &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">3. 为什么这样抽离是正确的？</h3>
<ol>
<li><strong>自动绑定</strong>：在 Vue 3 中，只要 Composable 返回的 <code>ref</code> 名称与模板中的 <code>ref="..."</code> 属性值一致，Vue 会自动完成 DOM 绑定。</li>
<li><strong>降低组件复杂度</strong>：<code>InputField.vue</code> 不再需要关心如何操作 Range 对象、如何处理 <code>\u200B</code> 占位符，它只需要调用 <code>unOrRedo</code> 这个指令即可。</li>
<li><strong>光标逻辑复用</strong>：光标定位逻辑（<code>placeCaretAtEnd</code>）被封装在了 Hook 内部，不会污染主组件的命名空间。</li>
</ol>
<h3 data-id="heading-3">💡 核心总结贴纸</h3>
<blockquote>
<p><strong>Composable 处理 DOM 的黄金定律</strong>：</p>
<ul>
<li><strong>定义在内</strong>：在 Hook 内部 <code>const myRef = ref(null)</code>。</li>
<li><strong>返回引用</strong>：<code>return { myRef }</code>。</li>
<li><strong>外部绑定</strong>：组件 <code>const { myRef } = useHook()</code>，模板 <code>&lt;div ref="myRef"&gt;</code>。</li>
<li><strong>安全访问</strong>：在 Hook 的函数内访问 <code>myRef.value</code> 时需做非空检查。</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 对象字面量与面向对象编程：表现力之源]]></title>    <link>https://juejin.cn/post/7596989416760426531</link>    <guid>https://juejin.cn/post/7596989416760426531</guid>    <pubDate>2026-01-20T03:52:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596989416760426531" data-draft-id="7596989416760410147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 对象字面量与面向对象编程：表现力之源"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-20T03:52:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户575730334624"/> <meta itemprop="url" content="https://juejin.cn/user/2860271309712009"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 对象字面量与面向对象编程：表现力之源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2860271309712009/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户575730334624
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:52:52.000Z" title="Tue Jan 20 2026 03:52:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 对象字面量与面向对象编程：表现力之源</h2>
<p>JavaScript 作为一门动态、灵活的脚本语言，以其极强的表现力和低门槛著称。与其他静态语言（如 Java、C++）不同，JavaScript <strong>无需预先定义类</strong>即可创建对象——这正是其“表现力”的核心体现之一。在早期 JavaScript 中，甚至没有 <code>class</code> 关键字（ES6 才引入），开发者完全依赖<strong>对象字面量</strong>（Object Literal）来构建复杂的数据结构和行为逻辑。本文将深入探讨 JavaScript 的对象字面量、面向对象思想，以及其独特的数据类型体系，帮助你理解为何 JS 被誉为“最有表现力的脚本语言”。</p>
<hr/>
<h3 data-id="heading-1">一、对象字面量：JSON 风格的直接表达</h3>
<p>在 JavaScript 中，<strong>对象字面量</strong>是用花括号 <code>{}</code> 直接定义对象的方式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> person = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"郑志鹏"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">hobbies</span>: [<span class="hljs-string">"学习"</span>, <span class="hljs-string">"乒乓球"</span>],
  <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`你好，我是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
};
</code></pre>
<p>这种写法直观、简洁，几乎等同于 JSON（JavaScript Object Notation）格式。事实上，JSON 正是从 JS 对象字面量演化而来。</p>
<h4 data-id="heading-2">为什么说它“有表现力”？</h4>
<ul>
<li><strong>无需类模板</strong>：Java 中要创建一个 <code>Person</code> 对象，必须先写一个 <code>class Person</code>；而 JS 可以直接“字面意义上”写出这个对象。</li>
<li><strong>动态可变</strong>：对象属性可在运行时增删改：
<pre><code class="hljs language-js" lang="js">person.<span class="hljs-property">city</span> = <span class="hljs-string">"上饶"</span>; <span class="hljs-comment">// 动态添加属性</span>
<span class="hljs-keyword">delete</span> person.<span class="hljs-property">age</span>;     <span class="hljs-comment">// 删除属性</span>
</code></pre>
</li>
<li><strong>方法即属性</strong>：函数也是值，可作为对象的方法直接嵌入。</li>
</ul>
<blockquote>
<p>✅ <strong>提示</strong>：对象字面量是 JavaScript 实现“简单面向对象”的基石。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">二、面向对象：从属性方法到人际关系建模</h3>
<p>面向对象编程（OOP）的核心思想是：<strong>将现实世界抽象为对象，对象包含属性（数据）和方法（行为）</strong>。</p>
<h4 data-id="heading-4">1. 简单的面向对象</h4>
<p>以“送花”场景为例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> zzp = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"郑志鹏"</span>,
  <span class="hljs-title function_">sendFlower</span>(<span class="hljs-params">target</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target.<span class="hljs-property">receiveFlower</span> === <span class="hljs-string">'function'</span>) {
      target.<span class="hljs-title function_">receiveFlower</span>(<span class="hljs-variable language_">this</span>);
    }
  }
};

<span class="hljs-keyword">let</span> xm = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"小美"</span>,
  <span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">sender</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 收到了 <span class="hljs-subst">${sender.name}</span> 送的花！`</span>);
  }
};

zzp.<span class="hljs-title function_">sendFlower</span>(xm); <span class="hljs-comment">// 输出：小美收到了 郑志鹏 送的花！</span>
</code></pre>
<p>这里，<code>zzp</code> 和 <code>xm</code> 是两个独立对象，通过方法交互，体现了<strong>封装</strong>（数据与行为绑定）和<strong>消息传递</strong>（调用对方方法）。</p>
<h4 data-id="heading-5">2. 复杂的人际关系建模</h4>
<p>JS 的灵活性允许我们模拟更复杂的关系：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> socialNetwork = {
  <span class="hljs-attr">users</span>: {},
  <span class="hljs-title function_">addUser</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>[user.<span class="hljs-property">name</span>] = user;
  },
  <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"><span class="hljs-keyword">from</span>, to, msg</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>[to]) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>[to].<span class="hljs-property">inbox</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">from</span>}</span>: <span class="hljs-subst">${msg}</span>`</span>);
    }
  }
};

<span class="hljs-keyword">let</span> alice = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">inbox</span>: [] };
<span class="hljs-keyword">let</span> bob = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">inbox</span>: [] };

socialNetwork.<span class="hljs-title function_">addUser</span>(alice);
socialNetwork.<span class="hljs-title function_">addUser</span>(bob);
socialNetwork.<span class="hljs-title function_">sendMessage</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"今晚打球吗？"</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bob.<span class="hljs-property">inbox</span>); <span class="hljs-comment">// ["Alice: 今晚打球吗？"]</span>
</code></pre>
<p>这种动态、松耦合的建模方式，正是 JavaScript 在前端状态管理、游戏开发等领域大放异彩的原因。</p>
<hr/>
<h3 data-id="heading-6">三、JavaScript 数据类型详解（面试高频考点）</h3>
<p>理解 JS 的数据类型，是掌握其对象模型的前提。JS 共有 <strong>7 种基本数据类型</strong>（ES2022 起）：</p>













































<table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>string</code></td><td>字符串</td><td><code>"hello"</code></td></tr><tr><td><code>number</code></td><td>数值（含整数、浮点、NaN、Infinity）</td><td><code>42</code>, <code>3.14</code></td></tr><tr><td><code>boolean</code></td><td>布尔值</td><td><code>true</code>, <code>false</code></td></tr><tr><td><code>null</code></td><td>空值（有意 absence of value）</td><td><code>null</code></td></tr><tr><td><code>undefined</code></td><td>未定义（变量声明未赋值）</td><td><code>let a; console.log(a); // undefined</code></td></tr><tr><td><code>symbol</code></td><td>唯一标识符（ES6 新增）</td><td><code>Symbol('id')</code></td></tr><tr><td><code>bigint</code></td><td>大整数（ES2020 新增）</td><td><code>123n</code></td></tr></tbody></table>
<blockquote>
<p>⚠️ 注意：<strong>数组（Array）不是独立的数据类型！</strong></p>
</blockquote>
<h4 data-id="heading-7">关键认知：万物皆对象？不！</h4>
<p>使用 <code>typeof</code> 操作符可验证：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">typeof</span> <span class="hljs-string">"abc"</span>        <span class="hljs-comment">// "string"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-number">123</span>          <span class="hljs-comment">// "number"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-literal">true</span>         <span class="hljs-comment">// "boolean"</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-literal">null</span>         <span class="hljs-comment">// "object" ← 这是历史 bug！</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-literal">undefined</span>    <span class="hljs-comment">// "undefined"</span>
<span class="hljs-keyword">typeof</span> {}           <span class="hljs-comment">// "object"</span>
<span class="hljs-keyword">typeof</span> []           <span class="hljs-comment">// "object" ← 数组本质是对象！</span>
<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){} <span class="hljs-comment">// "function" ← 函数是特殊对象</span>
</code></pre>
<h5 data-id="heading-8">重点澄清：</h5>
<ul>
<li><strong>数组是对象</strong>：<code>Array</code> 是 <code>Object</code> 的子类型，具有索引和 <code>length</code> 属性。</li>
<li><strong>函数是对象</strong>：可拥有属性、方法，甚至可被调用。</li>
<li><strong><code>null</code> 的 <code>typeof</code> 是 <code>"object"</code></strong>：这是 JavaScript 最著名的 bug 之一，源于早期实现错误，但为兼容性保留至今。</li>
</ul>
<hr/>
<h3 data-id="heading-9">四、对象 vs 基本类型：引用与值的区别</h3>
<p>这是 JS 面试必考题！</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 基本类型：按值传递</span>
<span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;
<span class="hljs-keyword">let</span> b = a;
b = <span class="hljs-number">20</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 10 → 不受影响</span>

<span class="hljs-comment">// 对象：按引用传递</span>
<span class="hljs-keyword">let</span> obj1 = { <span class="hljs-attr">name</span>: <span class="hljs-string">"A"</span> };
<span class="hljs-keyword">let</span> obj2 = obj1;
obj2.<span class="hljs-property">name</span> = <span class="hljs-string">"B"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj1.<span class="hljs-property">name</span>); <span class="hljs-comment">// "B" → 被修改！</span>
</code></pre>
<ul>
<li><strong>基本类型</strong>（string/number/boolean 等）存储在栈中，赋值时复制值。</li>
<li><strong>对象</strong>（包括数组、函数）存储在堆中，变量保存的是<strong>引用地址</strong>，赋值时复制地址。</li>
</ul>
<blockquote>
<p>💡 理解这一点，才能避免“改了一个对象，另一个也变了”的坑。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">五、现代 JavaScript 的演进：从字面量到 class</h3>
<p>虽然对象字面量足够强大，但随着项目复杂度提升，ES6 引入了 <code>class</code> 语法糖：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 传统字面量（工厂模式）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">return</span> {
    name,
    <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>); }
  };
}

<span class="hljs-comment">// ES6 class（更清晰的构造语义）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}
</code></pre>
<p>但请注意：<strong><code>class</code> 本质仍是基于原型的对象</strong>，底层依然依赖对象字面量和函数。</p>
<hr/>
<h3 data-id="heading-11">结语：表现力源于简单与自由</h3>
<p>JavaScript 的魅力，在于它用最简单的语法（<code>{}</code>、<code>[]</code>）实现了强大的抽象能力。你不需要理解复杂的类继承体系，就能用对象字面量表达现实世界的实体与关系。这种“所见即所得”的表现力，正是它成为 Web 开发首选语言的关键。</p>
<blockquote>
<p><strong>记住</strong>：</p>
<ul>
<li>对象字面量是 JS 面向对象的起点；</li>
<li>数组是对象，函数也是对象；</li>
<li><code>let/const</code> 不挂全局，调试时可用 <code>var</code> 或 <code>window.xxx</code>；</li>
<li>理解数据类型与引用机制，是写出健壮代码的基础。</li>
</ul>
</blockquote>
<p>掌握这些核心概念，你不仅能应对面试，更能写出更具表现力的 JavaScript 代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 代理模式（Proxy Pattern）：用接口实现灵活送花逻辑]]></title>    <link>https://juejin.cn/post/7597009443084419087</link>    <guid>https://juejin.cn/post/7597009443084419087</guid>    <pubDate>2026-01-20T03:59:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597009443084419087" data-draft-id="7596989416760459299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 代理模式（Proxy Pattern）：用接口实现灵活送花逻辑"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-20T03:59:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户575730334624"/> <meta itemprop="url" content="https://juejin.cn/user/2860271309712009"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 代理模式（Proxy Pattern）：用接口实现灵活送花逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2860271309712009/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户575730334624
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:59:32.000Z" title="Tue Jan 20 2026 03:59:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 代理模式（Proxy Pattern）：用接口实现灵活送花逻辑</h2>
<p>在软件工程中，<strong>设计模式</strong>是解决常见问题的可复用方案。其中，<strong>代理模式（Proxy Pattern）</strong> 是结构型设计模式的经典代表。它通过引入一个“代理人”对象，控制对目标对象的访问，在不改变原始接口的前提下，增强或拦截行为。</p>
<p>本文将以一个生动的“送花”场景为例，深入讲解 JavaScript 中如何利用<strong>面向接口编程</strong>的思想实现代理模式，并探讨其在现代前端开发中的实际价值。</p>
<hr/>
<h3 data-id="heading-1">一、问题背景：直接送花，可能被拒！</h3>
<p>假设我们有两位女生：</p>
<ul>
<li><strong>小美（xm）</strong>：性格直率，收到花会直接回应。</li>
<li><strong>小红（xh）</strong>：温柔体贴，愿意帮别人传递心意。</li>
</ul>
<p>而男生 <strong>郑志鹏（zzp）</strong> 想给小美送花，但担心被拒绝。于是他灵机一动：<strong>先送给小红，让小红代为转交</strong>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 小美：直接接收</span>
<span class="hljs-keyword">const</span> xm = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'小美'</span>,
  <span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">sender</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 收到了 <span class="hljs-subst">${sender.name}</span> 的花！`</span>);
    <span class="hljs-keyword">if</span> (sender.<span class="hljs-property">name</span> === <span class="hljs-string">'郑志鹏'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'……但小美拒绝了！'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
};

<span class="hljs-comment">// 郑志鹏</span>
<span class="hljs-keyword">const</span> zzp = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'郑志鹏'</span>,
  <span class="hljs-title function_">sendFlower</span>(<span class="hljs-params">target</span>) {
    target.<span class="hljs-title function_">receiveFlower</span>(<span class="hljs-variable language_">this</span>);
  }
};
</code></pre>
<p>如果 <code>zzp.sendFlower(xm)</code>，结果很可能是被拒。这不符合“高内聚、低耦合”的设计原则——<strong>送花逻辑与接收者的具体行为强耦合</strong>。</p>
<hr/>
<h3 data-id="heading-2">二、面向接口编程：统一行为契约</h3>
<p>在 Java/C# 等语言中，我们会定义一个 <code>FlowerReceiver</code> 接口，要求所有接收者实现 <code>receiveFlower</code> 方法。JavaScript 虽无原生接口，但可通过<strong>约定</strong>实现相同效果：</p>
<blockquote>
<p><strong>只要对象有 <code>receiveFlower(sender)</code> 方法，就视为“花接收者”</strong>。</p>
</blockquote>
<p>这就是<strong>鸭子类型（Duck Typing）</strong>：“如果它走起来像鸭子，叫起来像鸭子，那它就是鸭子。”</p>
<p>于是我们让 <strong>小红（xh）也实现相同的“接口”</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> xh = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'小红'</span>,
  <span class="hljs-attr">realTarget</span>: xm, <span class="hljs-comment">// 代理的真实目标</span>
  <span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">sender</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 作为代理收到了 <span class="hljs-subst">${sender.name}</span> 的花`</span>);
    
    <span class="hljs-comment">// 代理逻辑：先检查送花人</span>
    <span class="hljs-keyword">if</span> (sender.<span class="hljs-property">name</span> === <span class="hljs-string">'郑志鹏'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'小红决定帮忙转交……'</span>);
      <span class="hljs-comment">// 转交给小美</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">realTarget</span>.<span class="hljs-title function_">receiveFlower</span>(sender);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'非郑志鹏，直接转交'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">realTarget</span>.<span class="hljs-title function_">receiveFlower</span>(sender);
    }
  }
};
</code></pre>
<p>现在，<code>xm</code> 和 <code>xh</code> 都实现了相同的“接口”——拥有 <code>receiveFlower</code> 方法。<strong>zzp 无需知道对方是本人还是代理</strong>，只需调用同一方法即可。</p>
<pre><code class="hljs language-js" lang="js">zzp.<span class="hljs-title function_">sendFlower</span>(xh); 
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 小红 作为代理收到了 郑志鹏 的花</span>
<span class="hljs-comment">// 小红决定帮忙转交……</span>
<span class="hljs-comment">// 小美 收到了 郑志鹏 的花！</span>
<span class="hljs-comment">// ……但小美拒绝了！</span>
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：调用方（zzp）只依赖“接口”，不关心具体实现（是本人还是代理）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、代理模式的核心结构</h3>
<p>代理模式包含三个角色：</p>

























<table><thead><tr><th>角色</th><th>说明</th><th>本例对应</th></tr></thead><tbody><tr><td><strong>Subject（抽象主题）</strong></td><td>定义公共接口</td><td><code>receiveFlower</code> 方法约定</td></tr><tr><td><strong>RealSubject（真实主题）</strong></td><td>被代理的真实对象</td><td><code>xm</code>（小美）</td></tr><tr><td><strong>Proxy（代理）</strong></td><td>控制对 RealSubject 的访问</td><td><code>xh</code>（小红）</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[Client: zzp] --&gt;|sendFlower| B[Proxy: xh]
  B --&gt;|receiveFlower| C[RealSubject: xm]
</code></pre>
<p>代理可以在调用前后插入逻辑，例如：</p>
<ul>
<li>权限检查</li>
<li>日志记录</li>
<li>延迟加载</li>
<li>缓存结果</li>
<li>网络请求拦截</li>
</ul>
<hr/>
<h3 data-id="heading-4">四、JavaScript 原生 Proxy：更强大的元编程</h3>
<p>除了手动编写代理对象，ES6 还提供了内置的 <code>Proxy</code> 构造函数，可动态拦截对象操作：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> xm = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'小美'</span>,
  <span class="hljs-title function_">receiveFlower</span>(<span class="hljs-params">sender</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 收到了花`</span>);
    <span class="hljs-keyword">return</span> sender.<span class="hljs-property">name</span> !== <span class="hljs-string">'郑志鹏'</span>;
  }
};

<span class="hljs-comment">// 创建代理</span>
<span class="hljs-keyword">const</span> xhProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(xm, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) {
    <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">'receiveFlower'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">sender</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'【代理拦截】小红正在处理送花请求...'</span>);
        <span class="hljs-keyword">if</span> (sender.<span class="hljs-property">name</span> === <span class="hljs-string">'郑志鹏'</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'检测到郑志鹏！启动情感缓冲策略...'</span>);
          <span class="hljs-comment">// 可以修改行为，比如假装接受</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'小红：花我收下了，谢谢你的心意 ❤️'</span>);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 返回成功，避免伤害</span>
        }
        <span class="hljs-comment">// 否则正常转发</span>
        <span class="hljs-keyword">return</span> target[prop].<span class="hljs-title function_">call</span>(target, sender);
      };
    }
    <span class="hljs-keyword">return</span> target[prop];
  }
});

zzp.<span class="hljs-title function_">sendFlower</span>(xhProxy);
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 【代理拦截】小红正在处理送花请求...</span>
<span class="hljs-comment">// 检测到郑志鹏！启动情感缓冲策略...</span>
<span class="hljs-comment">// 小红：花我收下了，谢谢你的心意 ❤️</span>
</code></pre>
<blockquote>
<p>💡 <code>Proxy</code> 允许拦截 <code>get</code>、<code>set</code>、<code>apply</code> 等 13 种操作，是 Vue 3 响应式系统的核心。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">五、代理模式的典型应用场景</h3>
<h4 data-id="heading-6">1. <strong>虚拟代理（Virtual Proxy）</strong></h4>
<p>延迟初始化昂贵资源：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> imageProxy = {
  <span class="hljs-attr">src</span>: <span class="hljs-string">'large-image.jpg'</span>,
  <span class="hljs-title function_">loadImage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">_realImage</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_realImage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>(); <span class="hljs-comment">// 实际加载</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_realImage</span>.<span class="hljs-property">src</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">src</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_realImage</span>;
  }
};
</code></pre>
<h4 data-id="heading-7">2. <strong>保护代理（Protection Proxy）</strong></h4>
<p>控制访问权限：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> userProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(realUser, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key</span>) {
    <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'salary'</span> &amp;&amp; currentUser.<span class="hljs-property">role</span> !== <span class="hljs-string">'admin'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'无权访问薪资信息'</span>);
    }
    <span class="hljs-keyword">return</span> target[key];
  }
});
</code></pre>
<h4 data-id="heading-8">3. <strong>缓存代理（Caching Proxy）</strong></h4>
<p>避免重复计算：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> apiProxy = {
  <span class="hljs-attr">cache</span>: {},
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[id]) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[id];
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/data/<span class="hljs-subst">${id}</span>`</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>[id] = data;
    <span class="hljs-keyword">return</span> data;
  }
};
</code></pre>
<hr/>
<h3 data-id="heading-9">六、为什么代理模式在 JS 中如此重要？</h3>
<ol>
<li>
<p><strong>无类继承，靠组合与代理</strong><br/>
JS 没有接口关键字，但通过“鸭子类型 + 代理”，轻松实现多态。</p>
</li>
<li>
<p><strong>函数是一等公民</strong><br/>
方法可被替换、包装、拦截，天然支持代理行为。</p>
</li>
<li>
<p><strong>响应式框架的基石</strong><br/>
Vue、MobX 等均使用 <code>Proxy</code> 或 <code>Object.defineProperty</code> 实现数据监听。</p>
</li>
<li>
<p><strong>AOP（面向切面编程）的简易实现</strong><br/>
日志、性能监控、错误捕获等横切关注点，可通过代理统一处理。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">结语：代理，让代码更聪明</h3>
<p>回到送花的故事：<strong>小红作为代理，不仅传递了花，更传递了善意</strong>。在代码世界中，代理模式同样扮演着“智能中介”的角色——它解耦调用者与被调用者，赋予系统灵活性、安全性和可扩展性。</p>
<blockquote>
<p><strong>记住</strong>：</p>
<ul>
<li>代理模式的核心是 <strong>“相同的接口，不同的实现”</strong>；</li>
<li>JavaScript 的动态特性使其成为实现代理的理想语言；</li>
<li>无论是手动代理还是 <code>Proxy</code>，本质都是 <strong>控制访问 + 增强行为</strong>。</li>
</ul>
</blockquote>
<p>下次当你需要“在不修改原对象的前提下增加功能”时，不妨想想：<strong>是否该请一位“小红”来帮忙？</strong></p>
<hr/>
<p><strong>延伸思考</strong>：</p>
<ul>
<li>如何用代理模式实现前端 API 请求的统一 loading 和 error 处理？</li>
<li>Vue 3 的 <code>reactive()</code> 是如何利用 <code>Proxy</code> 实现响应式的？</li>
</ul>
<p>掌握代理模式，你离写出优雅、健壮的 JavaScript 代码又近了一步 🌸</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript基础类型全解]]></title>    <link>https://juejin.cn/post/7596975035438841865</link>    <guid>https://juejin.cn/post/7596975035438841865</guid>    <pubDate>2026-01-20T04:13:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438841865" data-draft-id="7596955804260941874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript基础类型全解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T04:13:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript基础类型全解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:13:15.000Z" title="Tue Jan 20 2026 04:13:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>TypeScript 的类型系统看似简单，但当 undefined、null、void、never 同时出现在错误信息中时，你是否也会感到过困惑？本篇文章将深入 TypeScript 的类型层次，揭开每个基础类型背后的秘密。</p>
</blockquote>
<h2 data-id="heading-0">TypeScript的类型层次结构</h2>
<p>在深入具体类型前，让我们先理解TypeScript的类型层次结构：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c7c92a772264bcbafddacf11407a19e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3VoZW5fbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769487195&amp;x-signature=HQlU6WDHtOpX5%2BxB9OjMtOpsI7w%3D" alt="TypeScript的类型层次结构" loading="lazy"/>
从上图中，我们可以看出：</p>
<ul>
<li>顶层类型：any &amp; unknown：任何值都可以赋值给它。</li>
<li>基础类型：number &amp; bigint &amp; boolean &amp; string &amp; symbol：构建一切的基石。</li>
<li>对象类型：object &amp; array &amp; function。</li>
<li>特殊类型：enum &amp; tuple。</li>
<li>空类型：null &amp; undefined &amp; void &amp; never：边界情况，4种不同的表示为“空”的类型。</li>
<li>底层类型：never：最特殊的一种空类型，没有值可以赋值给它。</li>
</ul>
<h2 data-id="heading-1">顶层类型</h2>
<h3 data-id="heading-2">any：类型系统的"逃生舱"</h3>
<p>any 类型是所有类型的“教父”，会放弃所有类型检查，所以也被称为类型系统的"逃生舱"。为达目的，它可以不惜一切代价，因此 any 类型通常会作为代码兜底的类型，即我们和 TypeScript 类型检测器确实是无法确实类型是什么。在实际开发中，any 类型一定要慎用，除非不得已。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// any放弃所有类型检查</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">dangerous</span>: <span class="hljs-built_in">any</span> = <span class="hljs-string">"hello world"</span>;
dangerous = <span class="hljs-number">42</span>;                    <span class="hljs-comment">// 可以重新赋值为任意类型</span>
dangerous.<span class="hljs-title function_">nonExistentMethod</span>();     <span class="hljs-comment">// 编译通过，运行时崩溃！</span>
dangerous.<span class="hljs-title function_">toFixed</span>();              <span class="hljs-comment">// 编译通过，但string没有toFixed方法</span>
</code></pre>
<p>上述代码可以看出，在使用 any 类型时，会存在一定的风险，那么在何时使用 any 比较合适呢？</p>
<ul>
<li>迁移JavaScript项目时的临时方案。</li>
<li>处理第三方库没有类型定义的情况。</li>
<li>编写测试时快速原型。</li>
</ul>
<h3 data-id="heading-3">unknown：类型安全的any</h3>
<p>如果 any 是教父，那么 unknown 就可以理解成是一个“卧底”，与坏人同流合污，但却是好人一边的。当我们确实无法预知一个值的类型时，不要使用 any，可以使用 unknown。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// unknown保持类型检查</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">safe</span>: <span class="hljs-built_in">unknown</span> = <span class="hljs-string">"hello world"</span>;
safe = <span class="hljs-number">42</span>;                        <span class="hljs-comment">// 可以重新赋值</span>
<span class="hljs-comment">// safe.toFixed();                // 编译错误：需要类型收窄</span>

<span class="hljs-comment">// 必须进行类型守卫</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> safe === <span class="hljs-string">"number"</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(safe.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>)); <span class="hljs-comment">// 类型收窄为number</span>
}
</code></pre>
<blockquote>
<p>对于 any 和 unknown 类型的使用，在后面会专门写一篇文章进行详细讲解。</p>
</blockquote>
<h2 data-id="heading-4">基础类型全解</h2>
<h3 data-id="heading-5">number</h3>
<p>number 包括所有的数字：整数、浮点数、正数、负数、Infinity 、 NaN等。值得注意的是，JavaScript 中不存在真正意义上的整数，所有的数字都是浮点数。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 所有数字类型都是number</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">decimal</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">6</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">hex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0xf00d</span>;       <span class="hljs-comment">// 十六进制</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">binary</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0b1010</span>;    <span class="hljs-comment">// 二进制</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">octal</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0o744</span>;      <span class="hljs-comment">// 八进制</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">float</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">3.14</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">infinity</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">Infinity</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">notANumber</span>: <span class="hljs-built_in">number</span> = <span class="hljs-title class_">NaN</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">big</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1_000_000</span>;    <span class="hljs-comment">// 数值分隔符</span>

<span class="hljs-comment">// 注：JavaScript的数字都是浮点数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">0.1</span> + <span class="hljs-number">0.2</span>); <span class="hljs-comment">// 0.30000000000000004</span>

<span class="hljs-comment">// 数字字面量类型（TypeScript的强大特性）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Dice</span> = <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span> | <span class="hljs-number">4</span> | <span class="hljs-number">5</span> | <span class="hljs-number">6</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">rollDice</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Dice</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// 只能返回1-6</span>
}
</code></pre>
<h3 data-id="heading-6">bigint</h3>
<p>在 JavaScript中，number 类型能表示的最大整数为2^53，而 bigint 能表示的数比这个要大得多，并且它能表示真正的大整数，我们也不用再担心精度丢失问题。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// bigint可以安全表示任意大的整数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">big</span>: <span class="hljs-built_in">bigint</span> = <span class="hljs-number">9007199254740991n</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">huge</span>: <span class="hljs-built_in">bigint</span> = <span class="hljs-title class_">BigInt</span>(<span class="hljs-number">9007199254740991</span>);

<span class="hljs-comment">// 与number不兼容</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">normal</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>;
<span class="hljs-comment">// const mixed: bigint = normal; // 类型错误</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">converted</span>: <span class="hljs-built_in">bigint</span> = <span class="hljs-title class_">BigInt</span>(normal); <span class="hljs-comment">// 编译通过</span>
</code></pre>
<h3 data-id="heading-7">boolean</h3>
<p>boolean 类型的值有两个：true 和 false。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 基本的布尔类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">isActive</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">const</span> isDone = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 类型推断为boolean</span>
</code></pre>
<h3 data-id="heading-8">string</h3>
<p>string 类型包含所有的字符串，以及可以对字符串执行的操作：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 基本字符串类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"TypeScript"</span>;
<span class="hljs-keyword">const</span> greeting = <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>; <span class="hljs-comment">// 模板字符串</span>
</code></pre>
<blockquote>
<p>对于上述的几种基本数据类型，在实际开发中并不推荐声明变量类型。因为对于基本数据类型，TypeScript 是怎么自动推断出具体的数据类型，显式类型声明反而是多余的：
<code>let x: number = 10;  // 不要这么写</code>
<code>let x = 10; // 推荐这样写</code></p>
</blockquote>
<h3 data-id="heading-9">symbol和unique symbol</h3>
<p>symbol 是 ES6+ 中新引入的语言特性；unique symbol 是TypeScript的类型级唯一性，两者都用于表示真正的唯一性。</p>
<h4 data-id="heading-10">symbol：运行时的唯一标识</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 每个Symbol都是唯一的</span>
<span class="hljs-keyword">const</span> sym1 = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"description"</span>);
<span class="hljs-keyword">const</span> sym2 = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"description"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sym1 === sym2); <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 作为对象键（不会意外覆盖）</span>
<span class="hljs-keyword">const</span> uniqueKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"user:id"</span>);
<span class="hljs-keyword">const</span> user = {
    [uniqueKey]: <span class="hljs-number">123</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user[uniqueKey]); <span class="hljs-comment">// 123</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(user)); <span class="hljs-comment">// ["name"]，symbol键不可枚举</span>
</code></pre>
<h4 data-id="heading-11">unique symbol：编译时的唯一性保证</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// unique symbol有独特的类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Brand</span>: unique <span class="hljs-built_in">symbol</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"Brand"</span>);

<span class="hljs-comment">// 品牌类型模式：防止类型混淆</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserId</span> = <span class="hljs-built_in">number</span> &amp; { <span class="hljs-keyword">readonly</span> [<span class="hljs-title class_">Brand</span>]: <span class="hljs-literal">true</span> };
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ProductId</span> = <span class="hljs-built_in">number</span> &amp; { <span class="hljs-keyword">readonly</span> [<span class="hljs-title class_">Brand</span>]: <span class="hljs-literal">true</span> };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUserId</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">UserId</span> {
    <span class="hljs-keyword">return</span> id <span class="hljs-keyword">as</span> <span class="hljs-title class_">UserId</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createProductId</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">ProductId</span> {
    <span class="hljs-keyword">return</span> id <span class="hljs-keyword">as</span> <span class="hljs-title class_">ProductId</span>;
}

<span class="hljs-keyword">const</span> userId = <span class="hljs-title function_">createUserId</span>(<span class="hljs-number">123</span>);
<span class="hljs-keyword">const</span> productId = <span class="hljs-title function_">createProductId</span>(<span class="hljs-number">123</span>);

<span class="hljs-comment">// TypeScript阻止误用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processUser</span>(<span class="hljs-params">id: UserId</span>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-title function_">processUser</span>(userId);     <span class="hljs-comment">// 正常运行</span>
<span class="hljs-title function_">processUser</span>(productId);  <span class="hljs-comment">// 类型错误</span>
<span class="hljs-title function_">processUser</span>(<span class="hljs-number">123</span>);        <span class="hljs-comment">// 类型错误</span>
</code></pre>
<h2 data-id="heading-12">四大"空值"类型</h2>
<h3 data-id="heading-13">null vs undefined：JavaScript的双重空值</h3>
<ul>
<li>null：有意的空值。</li>
<li>undefined：未定义的值。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// null：有意的空值</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">explicitNull</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// undefined：未定义的值</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">notInitialized</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;

<span class="hljs-comment">// 可选参数和属性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name?: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// name的类型是 string | undefined</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">${name ?? <span class="hljs-string">"Guest"</span>}</span>`</span>);
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    middleName?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// string | undefined</span>
}
</code></pre>
<h3 data-id="heading-14">void vs never：函数的返回类型</h3>
<ul>
<li>void：正常执行但无返回值。</li>
<li>never：永不返回的函数。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 场景1：总是抛出错误</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">never</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
}

<span class="hljs-comment">// 场景2：无限循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">infiniteLoop</span>(<span class="hljs-params"/>): <span class="hljs-built_in">never</span> {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// 永不结束</span>
    }
}

<span class="hljs-comment">// 场景3：穷尽性检查（Exhaustiveness checking）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Shape</span> = <span class="hljs-string">"circle"</span> | <span class="hljs-string">"square"</span> | <span class="hljs-string">"triangle"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getArea</span>(<span class="hljs-params">shape: Shape</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">switch</span> (shape) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"circle"</span>: <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">1</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"square"</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">"triangle"</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">0.5</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-comment">// 如果Shape类型扩展，这里会报错</span>
            <span class="hljs-keyword">const</span> <span class="hljs-attr">exhaustiveCheck</span>: <span class="hljs-built_in">never</span> = shape;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Unhandled shape: <span class="hljs-subst">${exhaustiveCheck}</span>`</span>);
    }
}

<span class="hljs-comment">// 场景4：类型运算中的不可能</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NonNullable</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span> ? <span class="hljs-built_in">never</span> : T;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractStrings</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? T : <span class="hljs-built_in">never</span>;
</code></pre>
<h2 data-id="heading-15">对象类型</h2>
<h3 data-id="heading-16">object</h3>
<p>在 TypeScript 中，object 类型用于表示非原始类型的值，仅比any 类型的范围窄一点，但也窄不了多少。object 类型对值知之甚少，只能表示该值是一个 JavaScript 对象，而不是 null。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">o: <span class="hljs-built_in">object</span> | <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">void</span>;

<span class="hljs-title function_">create</span>({ <span class="hljs-attr">prop</span>: <span class="hljs-number">0</span> });     <span class="hljs-comment">// ✅ 对象</span>
<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);            <span class="hljs-comment">// ✅ null</span>
<span class="hljs-title function_">create</span>([]);              <span class="hljs-comment">// ✅ 数组</span>
<span class="hljs-title function_">create</span>(<span class="hljs-function">() =&gt;</span> {});        <span class="hljs-comment">// ✅ 函数</span>
<span class="hljs-title function_">create</span>(<span class="hljs-number">42</span>);              <span class="hljs-comment">// ❌ 原始类型</span>
<span class="hljs-title function_">create</span>(<span class="hljs-string">"string"</span>);        <span class="hljs-comment">// ❌ 原始类型</span>

<span class="hljs-comment">// 但object太宽泛，通常使用更具体的类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-attr">apiUrl</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 使用Record表示键值对</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Headers</span> = <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;
</code></pre>
<h3 data-id="heading-17">array</h3>
<p>和 JavaScript 中一样，TypeScript 中的数组也是特殊类型的对象：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 两种写法等价</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">list1</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">let</span> <span class="hljs-attr">list2</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// 只读数组</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">readonlyList</span>: <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-comment">// readonlyList.push(4); // ❌ 编译错误</span>

<span class="hljs-comment">// 多维数组</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">matrix</span>: <span class="hljs-built_in">number</span>[][] = [
    [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],
    [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]
];

<span class="hljs-comment">// 数组泛型方法</span>
<span class="hljs-keyword">function</span> reverse&lt;T&gt;(<span class="hljs-attr">array</span>: T[]): T[] {
    <span class="hljs-keyword">return</span> [...array].<span class="hljs-title function_">reverse</span>();
}
</code></pre>
<h3 data-id="heading-18">function</h3>
<p>和 JavaScript 中一样，TypeScript 中的 function 也是特殊类型的对象：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 函数类型声明</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GreetFunction</span> = <span class="hljs-function">(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">BinaryOperator</span> = <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;

<span class="hljs-comment">// 函数实现</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">greet</span>: <span class="hljs-title class_">GreetFunction</span> = <span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">add</span>: <span class="hljs-title class_">BinaryOperator</span> = <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b;

<span class="hljs-comment">// 可选参数和默认参数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age?: <span class="hljs-built_in">number</span>, isAdmin = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-comment">// age: number | undefined</span>
    <span class="hljs-comment">// isAdmin: boolean</span>
}

<span class="hljs-comment">// 剩余参数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">...numbers: <span class="hljs-built_in">number</span>[]</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> numbers.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">total, n</span>) =&gt;</span> total + n, <span class="hljs-number">0</span>);
}

<span class="hljs-comment">// 函数重载（提供更好的类型提示）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">format</span>(<span class="hljs-params">input: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">format</span>(<span class="hljs-params">input: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">format</span>(<span class="hljs-params">input: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> input === <span class="hljs-string">"string"</span>) {
        <span class="hljs-keyword">return</span> input.<span class="hljs-title function_">toUpperCase</span>();
    }
    <span class="hljs-keyword">return</span> input.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
}
</code></pre>
<blockquote>
<p>对于函数重载，在后面会专门写一篇文章进行详细讲解。</p>
</blockquote>
<h3 data-id="heading-19">tuple</h3>
<p>tuple 类型是 array类型的子类型，表示为元组，是数组的一种特殊方式：长度固定，各索引位上的值具有固定的已知类型。在声明元组时，必须显式注解类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 基本元组</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">pair</span>: [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>] = [<span class="hljs-string">"hello"</span>, <span class="hljs-number">42</span>];

<span class="hljs-comment">// 可选元素</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">optionalTuple</span>: [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>?] = [<span class="hljs-string">"hello"</span>];
optionalTuple = [<span class="hljs-string">"hello"</span>, <span class="hljs-number">42</span>];

<span class="hljs-comment">// 带标签的元组（TypeScript 4.0+）</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">user</span>: [<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>, email?: <span class="hljs-built_in">string</span>] = [<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>];

<span class="hljs-comment">// 剩余元素</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">StringNumberPair</span> = [<span class="hljs-built_in">string</span>, ...<span class="hljs-built_in">number</span>[]];
<span class="hljs-keyword">const</span> <span class="hljs-attr">snp</span>: <span class="hljs-title class_">StringNumberPair</span> = [<span class="hljs-string">"hello"</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
</code></pre>
<h3 data-id="heading-20">enum</h3>
<p>enum 类型的作用是枚举类型中包含的各个值，是一种无序的数据结构，把键映射到值上。可以把枚举理解成键固定的对象：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 数字枚举（默认）</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">Direction</span> {
    <span class="hljs-title class_">Up</span>,    <span class="hljs-comment">// 0</span>
    <span class="hljs-title class_">Down</span>,  <span class="hljs-comment">// 1</span>
    <span class="hljs-title class_">Left</span>,  <span class="hljs-comment">// 2</span>
    <span class="hljs-title class_">Right</span>  <span class="hljs-comment">// 3</span>
}

<span class="hljs-comment">// 字符串枚举</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">LogLevel</span> {
    <span class="hljs-title class_">Info</span> = <span class="hljs-string">"INFO"</span>,
    <span class="hljs-title class_">Warn</span> = <span class="hljs-string">"WARN"</span>,
    <span class="hljs-title class_">Error</span> = <span class="hljs-string">"ERROR"</span>
}

<span class="hljs-comment">// 常量枚举（编译时完全删除）</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ButtonType</span> {
    <span class="hljs-title class_">Primary</span>,
    <span class="hljs-title class_">Secondary</span>,
    <span class="hljs-title class_">Danger</span>
}

<span class="hljs-comment">// 异构枚举（混合字符串和数字，不推荐）</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">Confusing</span> {
    <span class="hljs-title class_">Yes</span> = <span class="hljs-number">1</span>,
    <span class="hljs-title class_">No</span> = <span class="hljs-string">"NO"</span>
}

<span class="hljs-comment">// 现代替代方案：联合类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ModernDirection</span> = <span class="hljs-string">"up"</span> | <span class="hljs-string">"down"</span> | <span class="hljs-string">"left"</span> | <span class="hljs-string">"right"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ModernLogLevel</span> = <span class="hljs-string">"INFO"</span> | <span class="hljs-string">"WARN"</span> | <span class="hljs-string">"ERROR"</span>;
</code></pre>
<h2 data-id="heading-21">结语</h2>
<p>本文介绍了 TypeScript 中的数据类型，对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为Claude注入“执行力”：Awesome Claude Skills——打开AI助手的开关矩阵]]></title>    <link>https://juejin.cn/post/7596955804260827186</link>    <guid>https://juejin.cn/post/7596955804260827186</guid>    <pubDate>2026-01-20T03:40:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596955804260827186" data-draft-id="7596890557547003950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为Claude注入“执行力”：Awesome Claude Skills——打开AI助手的开关矩阵"/> <meta itemprop="keywords" content="数据分析,Claude,开源"/> <meta itemprop="datePublished" content="2026-01-20T03:40:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大厂技术总监下海"/> <meta itemprop="url" content="https://juejin.cn/user/4091714106833577"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为Claude注入“执行力”：Awesome Claude Skills——打开AI助手的开关矩阵
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4091714106833577/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大厂技术总监下海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:40:13.000Z" title="Tue Jan 20 2026 03:40:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Claude Skills 技术生态深度解构：从工作流标准化到模型能力工程化</h2>
<h3 data-id="heading-1">1. 整体介绍</h3>
<h4 data-id="heading-2">1.1 项目概览与现状</h4>
<p><strong>项目地址</strong>：<code>ComposioHQ/awesome-claude-skills</code> (GitHub仓库)
<strong>项目定位</strong>：Claude AI 技能生态系统的精选目录与开发框架
<strong>当前状态</strong>：作为社区维护项目，汇集了来自 Anthropic 官方及第三方开发者的 50+ 实用技能，形成了 Claude 能力扩展的事实标准。</p>
<p>项目采用典型的 Awesome-List 模式组织，但超越了简单的资源聚合，提供了完整的技能创建、分发、使用框架。其核心价值在于将大模型的泛化能力通过标准化接口转化为可预测、可复用的专业化工作流。</p>
<h4 data-id="heading-3">1.2 核心功能与价值主张</h4>
<p><strong>核心功能架构</strong>：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────┐
│                    Claude 核心平台                          │
│  (Claude<span class="hljs-selector-class">.ai</span> / Claude <span class="hljs-selector-tag">Code</span> / Claude API)                    │
├──────────────┬────────────────┬─────────────────────────────┤
│ 文档处理      │ 开发工具链      │ 外部系统集成                │
│ • PDF/Word   │ • TDD/架构设计  │ • <span class="hljs-number">500</span>+应用连接器            │
│ • Excel/PPT  │ • 测试自动化    │ • 身份验证代理               │
│ • 格式转换    │ • 代码审查      │ • 动作执行引擎              │
└──────────────┴────────────────┴─────────────────────────────┘
</code></pre>
<p><strong>关键能力示例</strong>：</p>
<ul>
<li><strong>跨平台一致性</strong>：技能在 Claude.ai（Web界面）、Claude Code（IDE环境）、Claude API（编程接口）间无缝迁移</li>
<li><strong>渐进式能力加载</strong>：基于上下文的按需技能激活机制，优化 token 使用效率</li>
<li><strong>标准化集成接口</strong>：通过统一的 SKILL.md 规范定义技能行为边界</li>
</ul>
<h4 data-id="heading-4">1.3 问题空间与目标受众</h4>
<p><strong>解决的痛点</strong>：</p>



































<table><thead><tr><th>问题类别</th><th>具体表现</th><th>传统解决方案</th><th>局限性</th></tr></thead><tbody><tr><td><strong>能力泛化</strong></td><td>大模型擅长生成文本，但缺乏确定性操作能力</td><td>人工编写脚本/使用专用工具</td><td>学习成本高，上下文切换频繁</td></tr><tr><td><strong>工作流碎片化</strong></td><td>复杂任务需多工具协同</td><td>手动串联不同应用</td><td>效率低，易出错，难以复用</td></tr><tr><td><strong>操作不可控</strong></td><td>模型自由发挥可能导致非预期结果</td><td>编写详细提示词约束</td><td>约束不完整，边界模糊</td></tr><tr><td><strong>企业集成困难</strong></td><td>缺乏标准化方式连接内部系统</td><td>定制开发接口</td><td>开发周期长，维护成本高</td></tr></tbody></table>
<p><strong>目标受众矩阵</strong>：</p>
<ul>
<li><strong>开发者</strong>：需要代码生成、测试、架构指导的软件工程师</li>
<li><strong>知识工作者</strong>：处理文档、数据分析、内容创作的办公人员</li>
<li><strong>业务运营者</strong>：需要连接CRM、邮件、协作工具的业务人员</li>
<li><strong>技能开发者</strong>：希望扩展Claude能力边界的生态建设者</li>
</ul>
<h4 data-id="heading-5">1.4 解决方案演进对比</h4>
<p><strong>传统模式</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 传统提示工程 - 脆弱且难维护</span>
prompt = <span class="hljs-string">"""
请帮我发送邮件：
收件人：client@example.com
主题：项目更新
内容：包含附件report.pdf
但注意：不要真的发送，只生成草稿
"""</span>
<span class="hljs-comment"># 问题：约束不明确，模型可能误解"不要真的发送"的边界</span>
</code></pre>
<p><strong>Skills 新范式</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># SKILL.md 元数据 - 明确的执行边界</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">email-sender</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">通过Gmail</span> <span class="hljs-string">API发送邮件，仅在用户明确要求发送时使用</span>
<span class="hljs-attr">trigger_keywords:</span> [<span class="hljs-string">"发送邮件"</span>, <span class="hljs-string">"send email"</span>, <span class="hljs-string">"email to"</span>]
<span class="hljs-attr">safety_checks:</span> [<span class="hljs-string">"确认收件人"</span>, <span class="hljs-string">"确认内容"</span>, <span class="hljs-string">"用户明确授权"</span>]
</code></pre>
<p><strong>优势对比分析</strong>：</p>



































<table><thead><tr><th>维度</th><th>传统提示工程</th><th>Claude Skills 方案</th></tr></thead><tbody><tr><td><strong>可复用性</strong></td><td>低 - 每次需重新描述</td><td>高 - 一次定义，多处使用</td></tr><tr><td><strong>确定性</strong></td><td>中 - 依赖模型理解</td><td>高 - 明确定义的执行边界</td></tr><tr><td><strong>维护成本</strong></td><td>高 - 分散在各处对话中</td><td>低 - 集中管理，版本控制</td></tr><tr><td><strong>企业集成</strong></td><td>困难 - 无标准化接口</td><td>相对简单 - 统一接入规范</td></tr><tr><td><strong>能力扩展</strong></td><td>有限 - 仅文本生成</td><td>广泛 - 可集成任意外部系统</td></tr></tbody></table>
<h4 data-id="heading-6">1.5 商业价值评估</h4>
<p><strong>价值评估模型</strong>：</p>
<pre><code class="hljs">总价值 = 开发成本节约 + 效率提升价值 + 问题空间覆盖价值
</code></pre>
<p><strong>开发成本节约分析</strong>：</p>
<ul>
<li><strong>重复提示词编写</strong>：每个技能平均减少 100-500 行提示词重复编写</li>
<li><strong>集成开发时间</strong>：通过 Composio 连接器，外部应用集成从 2-5 人天减少到 0.5-1 人天</li>
<li><strong>维护成本</strong>：标准化接口降低技能维护复杂度约 40-60%</li>
</ul>
<p><strong>效率提升量化</strong>：</p>
<ul>
<li><strong>文档处理</strong>：PDF/Word 操作任务时间减少 50-70%</li>
<li><strong>开发工作流</strong>：代码审查、测试编写等重复任务自动化程度提高 60-80%</li>
<li><strong>跨应用操作</strong>：手动切换应用时间减少 80-90%</li>
</ul>
<p><strong>问题空间覆盖估算</strong>：</p>
<ul>
<li><strong>直接覆盖领域</strong>：文档处理、开发工具链、基础自动化等 10+ 核心领域</li>
<li><strong>可扩展领域</strong>：通过技能创建框架可覆盖任意垂直行业</li>
<li><strong>长尾需求满足</strong>：社区贡献机制可积累满足特定场景的专用技能</li>
</ul>
<p><strong>保守估值逻辑</strong>：
假设：</p>
<ol>
<li>每个技能平均为 100 名用户节省 1 小时/周</li>
<li>平均时薪按 $50 计算</li>
<li>项目包含 50 个核心技能</li>
</ol>
<p>周价值 = 100用户 × 1小时 × <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>50</mn><mo>×</mo><mn>50</mn><mtext>技能</mtext><mo>×</mo><mn>0.3</mn><mo stretchy="false">(</mo><mtext>实际使用率</mtext><mo stretchy="false">)</mo><mo>=</mo></mrow><annotation encoding="application/x-tex">50 × 50技能 × 0.3(实际使用率) = </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">50</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord">50</span><span class="mord cjk_fallback">技能</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.3</span><span class="mopen">(</span><span class="mord cjk_fallback">实际使用率</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span></span></span></span></span>75,000
年价值 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>75</mn><mo separator="true">,</mo><mn>000</mn><mo>×</mo><mn>52</mn><mtext>周</mtext><mo>×</mo><mn>0.7</mn><mo stretchy="false">(</mo><mtext>考虑节假日</mtext><mo stretchy="false">)</mo><mo>≈</mo></mrow><annotation encoding="application/x-tex">75,000 × 52周 × 0.7(考虑节假日) ≈ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">75</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord">52</span><span class="mord cjk_fallback">周</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.7</span><span class="mopen">(</span><span class="mord cjk_fallback">考虑节假日</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span></span></span></span></span>2.7M</p>
<p>此估值为理论最大值，实际价值受采用率、技能质量、集成深度等多因素影响。</p>
<h3 data-id="heading-7">2. 详细功能拆解</h3>
<h4 data-id="heading-8">2.1 核心架构设计</h4>
<p><strong>三层能力扩展模型</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[Claude 基础模型] --&gt; B[技能执行层]
    B --&gt; C[外部系统层]
    
    B --&gt; B1[文档处理技能]
    B --&gt; B2[开发工具技能]
    B --&gt; B3[业务自动化技能]
    
    C --&gt; C1[云服务 API]
    C --&gt; C2[本地工具链]
    C --&gt; C3[企业系统]
    
    B1 --&gt; D1[PDF/Word/Excel]
    B2 --&gt; D2[Git/Test/Playwright]
    B3 --&gt; D3[Email/Slack/Notion]
    
    C1 --&gt; E1[AWS/GCP/Azure]
    C2 --&gt; E2[Docker/CLI/IDE]
    C3 --&gt; E3[CRM/ERP/数据库]
</code></pre>
<p><strong>关键设计原则</strong>：</p>
<ol>
<li><strong>能力模块化</strong>：每个技能专注单一职责，通过组合实现复杂工作流</li>
<li><strong>接口标准化</strong>：统一的 SKILL.md 规范确保技能可移植性</li>
<li><strong>上下文隔离</strong>：技能间互不干扰，避免意外副作用</li>
<li><strong>安全边界明确</strong>：危险操作需要显式用户确认</li>
</ol>
<h4 data-id="heading-9">2.2 技能创建与分发机制</h4>
<p><strong>技能生命周期管理</strong>：</p>
<pre><code class="hljs">创建 → 测试 → 打包 → 分发 → 使用 → 迭代
</code></pre>
<p><strong>技能包结构规范</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">skill-name/
├── SKILL.md          <span class="hljs-comment"># 技能定义（YAML元数据 + Markdown指令）</span>
├── scripts/          <span class="hljs-comment"># 可执行脚本（Python/Bash等）</span>
├── references/       <span class="hljs-comment"># 参考文档（按需加载）</span>
├── assets/           <span class="hljs-comment"># 资源文件（模板、图片等）</span>
└── LICENSE.txt       <span class="hljs-comment"># 许可证信息</span>
</code></pre>
<p><strong>技能触发机制</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 伪代码：技能匹配与激活逻辑</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">activate_skill</span>(<span class="hljs-params">user_query, available_skills</span>):
    <span class="hljs-string">"""基于查询内容自动选择合适的技能"""</span>
    <span class="hljs-keyword">for</span> skill <span class="hljs-keyword">in</span> available_skills:
        <span class="hljs-comment"># 1. 检查元数据匹配度</span>
        match_score = calculate_match_score(
            user_query, 
            skill.metadata.description,
            skill.metadata.keywords
        )
        
        <span class="hljs-comment"># 2. 检查使用上下文</span>
        <span class="hljs-keyword">if</span> is_relevant_context(skill, conversation_history):
            match_score *= context_multiplier
            
        <span class="hljs-comment"># 3. 阈值判断</span>
        <span class="hljs-keyword">if</span> match_score &gt; ACTIVATION_THRESHOLD:
            <span class="hljs-keyword">return</span> skill.load_instructions()
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># 无匹配技能，使用基础模型能力</span>
</code></pre>
<h4 data-id="heading-10">2.3 外部系统集成方案</h4>
<p><strong>Composio 集成架构</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────┐    ┌──────────────┐    ┌──────────────┐
│   Claude    │───▶│  Composio    │───▶│  目标应用    │
│   Skills    │    │  连接器层    │    │ (500+ API)  │
└─────────────┘    └──────────────┘    └──────────────┘
<span class="hljs-code">        │                  │                    │
        │          身份验证代理           标准化API适配
        └──────────────────────────────────────┘
                统一动作执行接口
</span></code></pre>
<p><strong>关键集成特性</strong>：</p>
<ol>
<li><strong>身份验证抽象</strong>：OAuth、API Key、Session Cookie 等统一管理</li>
<li><strong>API 规范化</strong>：不同应用的相似操作映射到统一接口</li>
<li><strong>错误处理标准化</strong>：网络异常、权限不足、速率限制等统一处理</li>
<li><strong>动作编排</strong>：支持多步骤工作流的顺序/并行执行</li>
</ol>
<h3 data-id="heading-11">3. 技术难点与解决方案</h3>
<h4 data-id="heading-12">3.1 核心挑战分析</h4>









































<table><thead><tr><th>技术难点</th><th>具体表现</th><th>项目解决方案</th><th>有效性评估</th></tr></thead><tbody><tr><td><strong>上下文管理</strong></td><td>技能指令占用token，影响主要任务</td><td>渐进式加载策略</td><td>高 - 优化30-50% token使用</td></tr><tr><td><strong>技能冲突</strong></td><td>多个技能同时被触发时的优先级</td><td>基于置信度的排序算法</td><td>中 - 仍需人工干预边界场景</td></tr><tr><td><strong>执行安全性</strong></td><td>危险操作（删除、发送）需要确认</td><td>显式确认机制 + 权限分级</td><td>高 - 建立多层保护</td></tr><tr><td><strong>技能质量保障</strong></td><td>社区贡献技能的质量参差不齐</td><td>标准化模板 + 验证脚本</td><td>中 - 依赖社区自律</td></tr><tr><td><strong>平台兼容性</strong></td><td>不同Claude平台的能力差异</td><td>平台特性检测 + 条件逻辑</td><td>高 - 实现透明适配</td></tr></tbody></table>
<h4 data-id="heading-13">3.2 渐进式加载策略实现</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProgressiveLoadingSkill</span>:
    <span class="hljs-string">"""渐进式技能加载实现"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, skill_dir</span>):
        self.metadata = self._load_metadata(skill_dir)      <span class="hljs-comment"># 始终加载 (~100 tokens)</span>
        self.instructions = <span class="hljs-literal">None</span>                           <span class="hljs-comment"># 按需加载 (~1-5k tokens)</span>
        self.references = {}                               <span class="hljs-comment"># 按需加载 (可能很大)</span>
        self.assets = <span class="hljs-literal">None</span>                                 <span class="hljs-comment"># 不加载到上下文</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">activate</span>(<span class="hljs-params">self, query, context</span>):
        <span class="hljs-string">"""激活技能并加载必要内容"""</span>
        <span class="hljs-comment"># 步骤1：仅基于元数据判断是否相关</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._is_relevant(query, context):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        
        <span class="hljs-comment"># 步骤2：加载核心指令</span>
        <span class="hljs-keyword">if</span> self.instructions <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.instructions = self._load_instructions()
            
        <span class="hljs-comment"># 步骤3：检查是否需要参考文档</span>
        needed_refs = self._identify_needed_references(query)
        <span class="hljs-keyword">for</span> ref <span class="hljs-keyword">in</span> needed_refs:
            <span class="hljs-keyword">if</span> ref <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.references:
                self.references[ref] = self._load_reference(ref)
        
        <span class="hljs-keyword">return</span> self._build_context()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_build_context</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""构建最终上下文，控制总token数"""</span>
        context_parts = [
            <span class="hljs-string">f"# 技能: <span class="hljs-subst">{self.metadata[<span class="hljs-string">'name'</span>]}</span>"</span>,
            <span class="hljs-string">f"描述: <span class="hljs-subst">{self.metadata[<span class="hljs-string">'description'</span>]}</span>"</span>,
            self.instructions
        ]
        
        <span class="hljs-comment"># 只添加必要的参考文档</span>
        <span class="hljs-keyword">for</span> ref_name, ref_content <span class="hljs-keyword">in</span> self.references.items():
            <span class="hljs-keyword">if</span> self._ref_is_needed_now(ref_name):
                context_parts.append(<span class="hljs-string">f"\n## 参考: <span class="hljs-subst">{ref_name}</span>\n<span class="hljs-subst">{ref_content}</span>"</span>)
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>.join(context_parts)
</code></pre>
<h4 data-id="heading-14">3.3 安全执行边界设计</h4>
<p><strong>安全层次模型</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[用户请求] --&gt; B{安全检查点1&lt;br/&gt;技能匹配度}
    B --&gt;|高置信度| C{安全检查点2&lt;br/&gt;操作危险等级}
    B --&gt;|低置信度| D[请求澄清]
    
    C --&gt;|低风险| E[直接执行]
    C --&gt;|中风险| F{安全检查点3&lt;br/&gt;显式确认}
    C --&gt;|高风险| G[拒绝执行]
    
    F --&gt;|用户确认| H[限制性执行]
    F --&gt;|用户拒绝| I[取消操作]
    
    H --&gt; J[监控执行]
    J --&gt; K[结果验证]
</code></pre>
<p><strong>危险操作分类示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 风险等级定义</span>
<span class="hljs-attr">risk_levels:</span>
  <span class="hljs-attr">low:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">读取文件</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">查询数据</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">生成内容</span>
  <span class="hljs-attr">medium:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">修改文件</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">发送消息草稿</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">创建临时资源</span>
  <span class="hljs-attr">high:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">删除文件/数据</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">发送正式邮件</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">修改生产配置</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">金融交易操作</span>
</code></pre>
<h3 data-id="heading-15">4. 详细设计图</h3>
<h4 data-id="heading-16">4.1 系统架构图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "用户交互层"
        A1[Claude.ai Web界面]
        A2[Claude Code IDE]
        A3[Claude API 程序调用]
    end
    
    subgraph "技能管理层"
        B1[技能加载器]
        B2[技能匹配引擎]
        B3[上下文管理器]
    end
    
    subgraph "技能执行层"
        C1[文档处理技能]
        C2[开发工具技能]
        C3[自动化技能]
        C4[自定义技能]
    end
    
    subgraph "外部集成层"
        D1[Composio 连接器]
        D2[本地工具调用]
        D3[API 网关]
    end
    
    subgraph "数据与资源层"
        E1[技能存储库]
        E2[用户配置]
        E3[执行日志]
    end
    
    A1 --&gt; B1
    A2 --&gt; B1
    A3 --&gt; B1
    
    B1 --&gt; E1
    B2 --&gt; B1
    B3 --&gt; B2
    
    B2 --&gt; C1
    B2 --&gt; C2
    B2 --&gt; C3
    B2 --&gt; C4
    
    C1 --&gt; D2
    C2 --&gt; D2
    C3 --&gt; D1
    C4 --&gt; D3
    
    D1 --&gt; F1[(外部服务)]
    D2 --&gt; F2[(本地系统)]
    D3 --&gt; F3[(企业API)]
    
    B3 --&gt; E3
</code></pre>
<h4 data-id="heading-17">4.2 核心执行序列图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Claude as Claude 核心
    participant SkillMgr as 技能管理器
    participant Skill as 具体技能
    participant External as 外部系统
    
    User-&gt;&gt;Claude: 发送请求:"发送邮件给客户"
    
    Claude-&gt;&gt;SkillMgr: 查询相关技能
    SkillMgr-&gt;&gt;SkillMgr: 匹配算法计算
    SkillMgr--&gt;&gt;Claude: 返回: "connect-apps"技能
    
    Claude-&gt;&gt;Skill: 加载技能指令
    Skill--&gt;&gt;Claude: 返回技能执行流程
    
    Claude-&gt;&gt;User: 请求确认:"确认发送邮件?"
    User-&gt;&gt;Claude: "确认发送"
    
    Claude-&gt;&gt;Skill: 执行邮件发送
    Skill-&gt;&gt;External: 调用Gmail API
    External--&gt;&gt;Skill: 返回发送结果
    
    Skill--&gt;&gt;Claude: 返回执行结果
    Claude--&gt;&gt;User: "邮件已成功发送"
    
    Note over SkillMgr,Skill: 技能执行期间&lt;br/&gt;保持上下文隔离
</code></pre>
<h4 data-id="heading-18">4.3 核心类图设计</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4d9b96e35b74ae4af7f2a9736c475b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5Y6C5oqA5pyv5oC755uR5LiL5rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485213&amp;x-signature=0tfHkpB4D13miykSclmw0DaZGi4%3D" alt="deepseek_mermaid_20260120_e17937.png" loading="lazy"/></p>
<h4 data-id="heading-19">4.4 技能执行状态图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    [*] --&gt; Idle : 初始化
    
    Idle --&gt; Matching : 接收用户请求
    Matching --&gt; Evaluating : 找到候选技能
    
    Evaluating --&gt; Loading : 技能相关度高
    Evaluating --&gt; Idle : 无相关技能
    
    state Loading {
        [*] --&gt; LoadMetadata
        LoadMetadata --&gt; LoadInstructions : 元数据有效
        LoadInstructions --&gt; LoadResources : 指令加载完成
        LoadResources --&gt; [*] : 资源就绪
    }
    
    Loading --&gt; Confirming : 需要用户确认
    Loading --&gt; Executing : 直接执行
    
    Confirming --&gt; Executing : 用户确认
    Confirming --&gt; Idle : 用户取消
    
    state Executing {
        [*] --&gt; PreCheck
        PreCheck --&gt; Running : 检查通过
        PreCheck --&gt; Failed : 检查失败
        
        Running --&gt; Verifying : 执行完成
        Verifying --&gt; [*] : 验证通过
        Verifying --&gt; Rollback : 验证失败
        
        Rollback --&gt; [*] : 回滚完成
    }
    
    Executing --&gt; Completed : 执行成功
    Executing --&gt; Failed : 执行失败
    
    Completed --&gt; Idle : 清理上下文
    Failed --&gt; Idle : 记录错误
</code></pre>
<h3 data-id="heading-20">5. 核心代码实现解析</h3>
<h4 data-id="heading-21">5.1 技能初始化引擎 (<code>init_skill.py</code>)</h4>
<p><strong>设计思想</strong>：通过标准化模板降低技能创建门槛，确保结构一致性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
技能初始化脚本 - 核心功能解析
File: scripts/init_skill.py
作用：创建符合规范的技能目录结构
"""</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillInitializer</span>:
    <span class="hljs-string">"""技能初始化器 - 确保所有技能遵循相同结构"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_skill_structure</span>(<span class="hljs-params">self, skill_name, target_path</span>):
        <span class="hljs-string">"""
        创建标准化技能目录结构
        
        参数:
            skill_name: 技能名称（需符合命名规范）
            target_path: 目标路径
            
        返回:
            SkillMetadata: 创建技能的元数据
        """</span>
        <span class="hljs-comment"># 1. 验证技能名称</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self._validate_skill_name(skill_name):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"技能名称 '<span class="hljs-subst">{skill_name}</span>' 不符合规范"</span>)
        
        <span class="hljs-comment"># 2. 创建目录结构</span>
        skill_dir = Path(target_path) / skill_name
        skill_dir.mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">False</span>)
        
        <span class="hljs-comment"># 3. 生成核心文件</span>
        self._create_skill_md(skill_dir, skill_name)
        self._create_resource_dirs(skill_dir)
        self._create_example_files(skill_dir, skill_name)
        
        <span class="hljs-comment"># 4. 验证并返回元数据</span>
        <span class="hljs-keyword">return</span> self._validate_structure(skill_dir)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_create_skill_md</span>(<span class="hljs-params">self, skill_dir, skill_name</span>):
        <span class="hljs-string">"""创建 SKILL.md 文件 - 技能的核心定义"""</span>
        metadata = {
            <span class="hljs-string">'name'</span>: skill_name,
            <span class="hljs-string">'description'</span>: self._generate_description(skill_name),
            <span class="hljs-string">'version'</span>: <span class="hljs-string">'1.0.0'</span>,
            <span class="hljs-string">'author'</span>: <span class="hljs-string">'待补充'</span>,
            <span class="hljs-string">'tags'</span>: self._suggest_tags(skill_name)
        }
        
        <span class="hljs-comment"># YAML 前置元数据 + Markdown 指令部分</span>
        content = self._render_skill_template(metadata)
        
        (skill_dir / <span class="hljs-string">'SKILL.md'</span>).write_text(content)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_create_resource_dirs</span>(<span class="hljs-params">self, skill_dir</span>):
        <span class="hljs-string">"""创建标准资源目录"""</span>
        dirs = [<span class="hljs-string">'scripts'</span>, <span class="hljs-string">'references'</span>, <span class="hljs-string">'assets'</span>, <span class="hljs-string">'templates'</span>]
        <span class="hljs-keyword">for</span> dir_name <span class="hljs-keyword">in</span> dirs:
            (skill_dir / dir_name).mkdir(exist_ok=<span class="hljs-literal">True</span>)
            
            <span class="hljs-comment"># 创建 .gitkeep 文件确保目录被版本控制</span>
            (skill_dir / dir_name / <span class="hljs-string">'.gitkeep'</span>).touch()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_description</span>(<span class="hljs-params">self, skill_name</span>):
        <span class="hljs-string">"""基于技能名称生成建议的描述"""</span>
        <span class="hljs-comment"># 智能解析技能名称中的关键词</span>
        <span class="hljs-comment"># 如 "pdf-extractor" -&gt; "提取PDF文件中的文本和表格数据"</span>
        words = skill_name.replace(<span class="hljs-string">'-'</span>, <span class="hljs-string">' '</span>).split()
        
        <span class="hljs-comment"># 映射常见动词和名词</span>
        verb_map = {
            <span class="hljs-string">'extract'</span>: <span class="hljs-string">'提取'</span>, <span class="hljs-string">'convert'</span>: <span class="hljs-string">'转换'</span>, <span class="hljs-string">'generate'</span>: <span class="hljs-string">'生成'</span>,
            <span class="hljs-string">'analyze'</span>: <span class="hljs-string">'分析'</span>, <span class="hljs-string">'create'</span>: <span class="hljs-string">'创建'</span>, <span class="hljs-string">'manage'</span>: <span class="hljs-string">'管理'</span>
        }
        
        noun_map = {
            <span class="hljs-string">'pdf'</span>: <span class="hljs-string">'PDF文档'</span>, <span class="hljs-string">'csv'</span>: <span class="hljs-string">'CSV文件'</span>, <span class="hljs-string">'data'</span>: <span class="hljs-string">'数据'</span>,
            <span class="hljs-string">'image'</span>: <span class="hljs-string">'图像'</span>, <span class="hljs-string">'document'</span>: <span class="hljs-string">'文档'</span>, <span class="hljs-string">'code'</span>: <span class="hljs-string">'代码'</span>
        }
        
        <span class="hljs-comment"># 构建自然语言描述</span>
        description_parts = []
        <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> words:
            <span class="hljs-keyword">if</span> word <span class="hljs-keyword">in</span> verb_map:
                description_parts.append(verb_map[word])
            <span class="hljs-keyword">elif</span> word <span class="hljs-keyword">in</span> noun_map:
                description_parts.append(noun_map[word])
            <span class="hljs-keyword">else</span>:
                description_parts.append(word)
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">' '</span>.join(description_parts)}</span>。使用场景：待补充。"</span>
</code></pre>
<h4 data-id="heading-22">5.2 技能打包与验证 (<code>package_skill.py</code> 逻辑)</h4>
<p><strong>关键验证逻辑</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillValidator</span>:
    <span class="hljs-string">"""技能包验证器 - 确保技能质量"""</span>
    
    REQUIRED_FIELDS = [<span class="hljs-string">'name'</span>, <span class="hljs-string">'description'</span>]
    NAME_PATTERN = <span class="hljs-string">r'^[a-z0-9]+(?:-[a-z0-9]+)*$'</span>  <span class="hljs-comment"># 只允许小写字母、数字和连字符</span>
    MAX_DESCRIPTION_LENGTH = <span class="hljs-number">200</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_skill</span>(<span class="hljs-params">self, skill_path</span>):
        <span class="hljs-string">"""
        验证技能包是否符合所有规范
        
        返回:
            ValidationResult: 包含通过/失败状态和详细错误信息
        """</span>
        errors = []
        warnings = []
        
        <span class="hljs-comment"># 1. 检查目录结构</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (skill_path / <span class="hljs-string">'SKILL.md'</span>).exists():
            errors.append(<span class="hljs-string">"缺少 SKILL.md 文件"</span>)
        
        <span class="hljs-comment"># 2. 解析并验证元数据</span>
        metadata = self._extract_metadata(skill_path)
        <span class="hljs-keyword">if</span> metadata:
            errors.extend(self._validate_metadata(metadata))
        
        <span class="hljs-comment"># 3. 检查文件大小和类型</span>
        warnings.extend(self._check_resource_files(skill_path))
        
        <span class="hljs-comment"># 4. 验证示例和文档质量</span>
        <span class="hljs-keyword">if</span> self._has_examples(skill_path):
            warnings.extend(self._validate_examples(skill_path))
        
        <span class="hljs-keyword">return</span> ValidationResult(
            is_valid=<span class="hljs-built_in">len</span>(errors) == <span class="hljs-number">0</span>,
            errors=errors,
            warnings=warnings
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate_metadata</span>(<span class="hljs-params">self, metadata</span>):
        <span class="hljs-string">"""验证SKILL.md中的YAML元数据"""</span>
        errors = []
        
        <span class="hljs-comment"># 检查必填字段</span>
        <span class="hljs-keyword">for</span> field <span class="hljs-keyword">in</span> self.REQUIRED_FIELDS:
            <span class="hljs-keyword">if</span> field <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> metadata:
                errors.append(<span class="hljs-string">f"缺少必填字段: <span class="hljs-subst">{field}</span>"</span>)
        
        <span class="hljs-comment"># 验证名称格式</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'name'</span> <span class="hljs-keyword">in</span> metadata:
            name = metadata[<span class="hljs-string">'name'</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> re.<span class="hljs-keyword">match</span>(self.NAME_PATTERN, name):
                errors.append(
                    <span class="hljs-string">f"技能名称 '<span class="hljs-subst">{name}</span>' 不符合规范。"</span>
                    <span class="hljs-string">f"只允许小写字母、数字和连字符"</span>
                )
        
        <span class="hljs-comment"># 验证描述质量</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'description'</span> <span class="hljs-keyword">in</span> metadata:
            desc = metadata[<span class="hljs-string">'description'</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(desc) &gt; self.MAX_DESCRIPTION_LENGTH:
                errors.append(<span class="hljs-string">f"描述过长 (<span class="hljs-subst">{<span class="hljs-built_in">len</span>(desc)}</span> 字符)。最大 <span class="hljs-subst">{self.MAX_DESCRIPTION_LENGTH}</span>"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> desc.endswith((<span class="hljs-string">'.'</span>, <span class="hljs-string">'。'</span>, <span class="hljs-string">'!'</span>, <span class="hljs-string">'!'</span>)):
                warnings.append(<span class="hljs-string">"建议描述以句号结束以提高可读性"</span>)
        
        <span class="hljs-keyword">return</span> errors
</code></pre>
<h4 data-id="heading-23">5.3 技能执行引擎核心逻辑</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillExecutionEngine</span>:
    <span class="hljs-string">"""技能执行引擎 - 管理技能生命周期"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, skill_registry, context_manager</span>):
        self.skills = skill_registry
        self.context = context_manager
        self.active_skills = {}  <span class="hljs-comment"># 当前活跃技能</span>
        
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_user_request</span>(<span class="hljs-params">self, user_query, conversation_history</span>):
        <span class="hljs-string">"""
        处理用户请求的核心流程
        
        返回:
            ExecutionResult: 包含响应文本和执行的技能信息
        """</span>
        <span class="hljs-comment"># 1. 分析用户意图</span>
        intent = <span class="hljs-keyword">await</span> self._analyze_intent(user_query, conversation_history)
        
        <span class="hljs-comment"># 2. 查找相关技能</span>
        candidate_skills = self._find_relevant_skills(intent)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> candidate_skills:
            <span class="hljs-comment"># 无相关技能，使用基础模型</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> self._fallback_to_base_model(user_query)
        
        <span class="hljs-comment"># 3. 选择最佳技能</span>
        selected_skill = self._select_best_skill(candidate_skills, intent)
        
        <span class="hljs-comment"># 4. 安全检查</span>
        safety_check = <span class="hljs-keyword">await</span> self._perform_safety_check(selected_skill, intent)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> safety_check.approved:
            <span class="hljs-keyword">return</span> ExecutionResult(
                response=safety_check.rejection_reason,
                skill_used=<span class="hljs-literal">None</span>
            )
        
        <span class="hljs-comment"># 5. 执行技能</span>
        <span class="hljs-keyword">try</span>:
            result = <span class="hljs-keyword">await</span> selected_skill.execute(
                intent.parameters,
                context=self.context.get_skill_context(selected_skill)
            )
            
            <span class="hljs-comment"># 6. 后处理</span>
            processed_result = self._post_process_result(result)
            
            <span class="hljs-keyword">return</span> ExecutionResult(
                response=processed_result.output,
                skill_used=selected_skill.metadata.name,
                metadata={
                    <span class="hljs-string">'execution_time'</span>: result.execution_time,
                    <span class="hljs-string">'resources_used'</span>: result.resources
                }
            )
            
        <span class="hljs-keyword">except</span> SkillExecutionError <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 错误处理和降级</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> self._handle_execution_error(e, user_query)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_find_relevant_skills</span>(<span class="hljs-params">self, intent</span>):
        <span class="hljs-string">"""基于意图查找相关技能"""</span>
        relevant_skills = []
        
        <span class="hljs-keyword">for</span> skill <span class="hljs-keyword">in</span> self.skills.values():
            <span class="hljs-comment"># 基于元数据的关键词匹配</span>
            relevance_score = self._calculate_relevance_score(skill, intent)
            
            <span class="hljs-comment"># 基于上下文的适用性检查</span>
            <span class="hljs-keyword">if</span> self._is_applicable_in_context(skill):
                relevance_score *= self.CONTEXT_BOOST_FACTOR
            
            <span class="hljs-keyword">if</span> relevance_score &gt;= self.MIN_RELEVANCE_THRESHOLD:
                relevant_skills.append({
                    <span class="hljs-string">'skill'</span>: skill,
                    <span class="hljs-string">'score'</span>: relevance_score
                })
        
        <span class="hljs-comment"># 按相关性排序</span>
        relevant_skills.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'score'</span>], reverse=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> [item[<span class="hljs-string">'skill'</span>] <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> relevant_skills[:self.MAX_CANDIDATES]]
</code></pre>
<h4 data-id="heading-24">5.4 Composio 集成适配器</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ComposioAdapter</span>:
    <span class="hljs-string">"""Composio 平台适配器 - 统一外部应用集成"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, api_key, config_path=<span class="hljs-literal">None</span></span>):
        self.client = ComposioClient(api_key)
        self.connected_apps = {}
        self.action_registry = {}
        
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_app</span>(<span class="hljs-params">self, app_name, auth_config</span>):
        <span class="hljs-string">"""
        连接外部应用
        
        参数:
            app_name: 应用名称 (如 'gmail', 'slack')
            auth_config: 身份验证配置
            
        返回:
            AppConnection: 连接对象
        """</span>
        <span class="hljs-comment"># 检查是否已连接</span>
        <span class="hljs-keyword">if</span> app_name <span class="hljs-keyword">in</span> self.connected_apps:
            <span class="hljs-keyword">return</span> self.connected_apps[app_name]
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 通过 Composio 建立连接</span>
            connection = <span class="hljs-keyword">await</span> self.client.connect_app(
                app_name=app_name,
                auth_config=auth_config
            )
            
            <span class="hljs-comment"># 缓存连接</span>
            self.connected_apps[app_name] = connection
            
            <span class="hljs-comment"># 预加载可用动作</span>
            actions = <span class="hljs-keyword">await</span> self.client.get_app_actions(app_name)
            self.action_registry[app_name] = actions
            
            <span class="hljs-keyword">return</span> connection
            
        <span class="hljs-keyword">except</span> ComposioError <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">if</span> e.code == <span class="hljs-string">'AUTH_REQUIRED'</span>:
                <span class="hljs-comment"># 触发 OAuth 流程</span>
                oauth_url = <span class="hljs-keyword">await</span> self.client.get_oauth_url(app_name)
                <span class="hljs-keyword">raise</span> OAuthRequiredError(oauth_url)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_action</span>(<span class="hljs-params">self, app_name, action_name, parameters</span>):
        <span class="hljs-string">"""
        执行外部应用动作
        
        参数:
            app_name: 应用名称
            action_name: 动作名称
            parameters: 动作参数
            
        返回:
            ActionResult: 执行结果
        """</span>
        <span class="hljs-comment"># 1. 验证动作存在</span>
        <span class="hljs-keyword">if</span> app_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.action_registry:
            <span class="hljs-keyword">raise</span> AppNotConnectedError(app_name)
        
        available_actions = self.action_registry[app_name]
        <span class="hljs-keyword">if</span> action_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> available_actions:
            <span class="hljs-keyword">raise</span> ActionNotFoundError(app_name, action_name)
        
        <span class="hljs-comment"># 2. 参数验证和转换</span>
        validated_params = self._validate_action_parameters(
            action_name, parameters, available_actions[action_name]
        )
        
        <span class="hljs-comment"># 3. 执行动作</span>
        <span class="hljs-keyword">try</span>:
            result = <span class="hljs-keyword">await</span> self.client.execute_action(
                app_name=app_name,
                action_name=action_name,
                parameters=validated_params
            )
            
            <span class="hljs-keyword">return</span> ActionResult(
                success=<span class="hljs-literal">True</span>,
                data=result.data,
                metadata=result.metadata
            )
            
        <span class="hljs-keyword">except</span> ComposioError <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 错误分类和处理</span>
            error_type = self._classify_composio_error(e)
            <span class="hljs-keyword">return</span> ActionResult(
                success=<span class="hljs-literal">False</span>,
                error=self._format_user_friendly_error(error_type, e)
            )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate_action_parameters</span>(<span class="hljs-params">self, action_name, params, action_schema</span>):
        <span class="hljs-string">"""根据动作模式验证参数"""</span>
        validated = {}
        
        <span class="hljs-keyword">for</span> param_name, param_schema <span class="hljs-keyword">in</span> action_schema[<span class="hljs-string">'parameters'</span>].items():
            <span class="hljs-keyword">if</span> param_name <span class="hljs-keyword">in</span> params:
                <span class="hljs-comment"># 类型检查和转换</span>
                value = params[param_name]
                
                <span class="hljs-keyword">if</span> param_schema.get(<span class="hljs-string">'required'</span>, <span class="hljs-literal">False</span>) <span class="hljs-keyword">and</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                    <span class="hljs-keyword">raise</span> MissingRequiredParameterError(param_name)
                
                validated[param_name] = self._convert_value_type(
                    value, param_schema.get(<span class="hljs-string">'type'</span>, <span class="hljs-string">'string'</span>)
                )
            <span class="hljs-keyword">elif</span> param_schema.get(<span class="hljs-string">'required'</span>, <span class="hljs-literal">False</span>):
                <span class="hljs-keyword">raise</span> MissingRequiredParameterError(param_name)
        
        <span class="hljs-keyword">return</span> validated
</code></pre>
<h3 data-id="heading-25">6. 技术对比与选型分析</h3>
<h4 data-id="heading-26">6.1 Claude Skills vs. 其他AI扩展方案</h4>





















































<table><thead><tr><th>方案</th><th>代表项目</th><th>核心思想</th><th>优势</th><th>局限</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Claude Skills</strong></td><td>awesome-claude-skills</td><td>标准化技能包，渐进式加载</td><td>平台原生，体验一致，生态完整</td><td>仅限Claude，相对封闭</td><td>Claude生态内的深度集成</td></tr><tr><td><strong>LangChain Tools</strong></td><td>LangChain</td><td>通用工具抽象层</td><td>模型无关，工具丰富，社区活跃</td><td>配置复杂，性能开销</td><td>多模型混合，复杂代理</td></tr><tr><td><strong>GPTs/Actions</strong></td><td>OpenAI GPTs</td><td>私有化技能商店</td><td>用户友好，图形化创建</td><td>绑定OpenAI，灵活性有限</td><td>快速原型，非技术用户</td></tr><tr><td><strong>AutoGPT Plugins</strong></td><td>Auto-GPT</td><td>自主代理插件系统</td><td>高度自主，目标驱动</td><td>稳定性差，资源消耗大</td><td>实验性，研究场景</td></tr><tr><td><strong>MCP Servers</strong></td><td>Model Context Protocol</td><td>标准化上下文协议</td><td>协议开放，厂商中立</td><td>生态早期，工具较少</td><td>需要跨平台部署</td></tr></tbody></table>
<h4 data-id="heading-27">6.2 架构选择合理性分析</h4>
<p><strong>选择渐进式加载的原因</strong>：</p>
<ol>
<li><strong>成本控制</strong>：AI模型按token计费，减少不必要上下文可显著降低成本</li>
<li><strong>性能优化</strong>：短上下文通常获得更快响应和更稳定输出</li>
<li><strong>专注度提升</strong>：相关度低的技能不会干扰当前任务</li>
</ol>
<p><strong>选择文件系统存储而非数据库</strong>：</p>
<ol>
<li><strong>简化部署</strong>：技能作为文件易于版本控制、分发和备份</li>
<li><strong>开发友好</strong>：开发者可直接编辑文本文件，无需数据库客户端</li>
<li><strong>可移植性</strong>：技能包可压缩传输，适应离线或网络受限环境</li>
</ol>
<p><strong>选择YAML+Markdown混合格式</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># YAML部分 - 机器可读，用于自动化处理</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">pdf-processor</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">处理PDF文档的完整工具集</span>
<span class="hljs-attr">version:</span> <span class="hljs-number">1.2</span><span class="hljs-number">.0</span>
<span class="hljs-attr">tags:</span> [<span class="hljs-string">pdf</span>, <span class="hljs-string">document</span>, <span class="hljs-string">automation</span>]
<span class="hljs-attr">risk_level:</span> <span class="hljs-string">medium</span>
<span class="hljs-comment"># ↑ 程序可解析，用于技能匹配和过滤</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># Markdown部分 - 人类可读，包含详细指令</span>
<span class="hljs-comment"># PDF处理指南</span>
<span class="hljs-comment">## 当使用此技能时...</span>
<span class="hljs-comment"># ↓ Claude直接读取，作为执行指导</span>
</code></pre>
<h4 data-id="heading-28">6.3 性能优化策略</h4>
<p><strong>上下文管理优化</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedContextManager</span>:
    <span class="hljs-string">"""优化版上下文管理器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_context</span>(<span class="hljs-params">self, skill, user_query, history</span>):
        <span class="hljs-string">"""构建最优上下文，平衡信息完整性和长度"""</span>
        
        <span class="hljs-comment"># 1. 基础上下文（始终包含）</span>
        base_context = [
            skill.metadata_summary(),      <span class="hljs-comment"># ~50 tokens</span>
            current_goal(user_query),      <span class="hljs-comment"># ~20 tokens</span>
        ]
        
        <span class="hljs-comment"># 2. 选择性包含历史</span>
        relevant_history = self._extract_relevant_history(history, skill)
        <span class="hljs-keyword">if</span> relevant_history:               <span class="hljs-comment"># ~100-500 tokens</span>
            base_context.append(relevant_history)
        
        <span class="hljs-comment"># 3. 技能特定内容（按需加载）</span>
        <span class="hljs-keyword">if</span> skill.requires_examples(user_query):
            base_context.append(skill.get_examples())  <span class="hljs-comment"># ~200 tokens</span>
        
        <span class="hljs-keyword">if</span> skill.requires_reference(user_query):
            <span class="hljs-comment"># 只加载相关部分，而非整个文档</span>
            ref_section = skill.get_relevant_section(user_query)
            base_context.append(ref_section)           <span class="hljs-comment"># ~100-300 tokens</span>
        
        <span class="hljs-comment"># 4. 合并并截断</span>
        final_context = self._merge_and_truncate(base_context)
        <span class="hljs-keyword">return</span> final_context
</code></pre>
<h3 data-id="heading-29">7. 部署与实践建议</h3>
<h4 data-id="heading-30">7.1 企业级部署架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "企业网络区"
        A1[内部用户]
        A2[业务系统]
    end
    
    subgraph "DMZ区"
        B1[反向代理]
        B2[API网关]
    end
    
    subgraph "应用服务器区"
        C1[Claude API服务]
        C2[技能管理服务]
        C3[Composio适配器]
    end
    
    subgraph "数据存储区"
        D1[技能仓库]
        D2[连接配置]
        D3[执行日志]
    end
    
    subgraph "外部服务"
        E1[Anthropic API]
        E2[Composio平台]
        E3[企业SaaS应用]
    end
    
    A1 --&gt; B1
    A2 --&gt; B2
    
    B1 --&gt; C1
    B2 --&gt; C2
    
    C1 --&gt; D1
    C2 --&gt; D1
    
    C3 --&gt; D2
    C3 --&gt; D3
    
    C1 --&gt; E1
    C3 --&gt; E2
    C3 --&gt; E3
</code></pre>
<h4 data-id="heading-31">7.2 安全配置建议</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># security-policy.yaml</span>
<span class="hljs-attr">skill_security:</span>
  <span class="hljs-comment"># 技能安装策略</span>
  <span class="hljs-attr">allowed_sources:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"anthropics/skills"</span>          <span class="hljs-comment"># 官方仓库</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"内部/已验证技能"</span>            <span class="hljs-comment"># 企业内部分发</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"特定GitHub用户"</span>             <span class="hljs-comment"># 受信任开发者</span>
  
  <span class="hljs-comment"># 执行权限控制</span>
  <span class="hljs-attr">execution_limits:</span>
    <span class="hljs-attr">max_file_size_mb:</span> <span class="hljs-number">50</span>          <span class="hljs-comment"># 最大文件大小</span>
    <span class="hljs-attr">allowed_file_types:</span>           <span class="hljs-comment"># 允许的文件类型</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">.pdf</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">.docx</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">.xlsx</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">.txt</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">.csv</span>
    
    <span class="hljs-attr">network_access:</span>              <span class="hljs-comment"># 网络访问控制</span>
      <span class="hljs-attr">allowed_domains:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"api.composio.dev"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"github.com"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"企业内部域名"</span>
    
  <span class="hljs-comment"># 敏感操作保护</span>
  <span class="hljs-attr">sensitive_operations:</span>
    <span class="hljs-attr">require_explicit_approval:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"删除文件"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"发送外部邮件"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"修改数据库"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"金融交易"</span>
    
    <span class="hljs-attr">approval_mechanism:</span> <span class="hljs-string">"双重确认"</span>  <span class="hljs-comment"># 或"管理员审批"</span>
  
  <span class="hljs-comment"># 审计与日志</span>
  <span class="hljs-attr">audit:</span>
    <span class="hljs-attr">log_all_executions:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">retain_logs_days:</span> <span class="hljs-number">90</span>
    <span class="hljs-attr">alert_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"多次失败尝试"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"敏感操作"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"异常资源使用"</span>
</code></pre>
<h4 data-id="heading-32">7.3 监控与运维指标</h4>
<p><strong>关键性能指标</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillMonitoring</span>:
    <span class="hljs-string">"""技能执行监控"""</span>
    
    METRICS = {
        <span class="hljs-comment"># 使用指标</span>
        <span class="hljs-string">'skill_activation_rate'</span>: <span class="hljs-string">'技能激活频率'</span>,
        <span class="hljs-string">'avg_execution_time'</span>: <span class="hljs-string">'平均执行时间'</span>,
        <span class="hljs-string">'success_rate'</span>: <span class="hljs-string">'执行成功率'</span>,
        
        <span class="hljs-comment"># 资源指标  </span>
        <span class="hljs-string">'context_token_usage'</span>: <span class="hljs-string">'上下文token使用量'</span>,
        <span class="hljs-string">'external_api_calls'</span>: <span class="hljs-string">'外部API调用次数'</span>,
        <span class="hljs-string">'file_operations'</span>: <span class="hljs-string">'文件操作次数'</span>,
        
        <span class="hljs-comment"># 质量指标</span>
        <span class="hljs-string">'user_satisfaction'</span>: <span class="hljs-string">'用户满意度'</span>,
        <span class="hljs-string">'error_distribution'</span>: <span class="hljs-string">'错误类型分布'</span>,
        <span class="hljs-string">'skill_relevance_score'</span>: <span class="hljs-string">'技能相关性评分'</span>
    }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">collect_metrics</span>(<span class="hljs-params">self, execution_result</span>):
        <span class="hljs-string">"""收集单次执行的指标"""</span>
        metrics = {
            <span class="hljs-string">'timestamp'</span>: datetime.now(),
            <span class="hljs-string">'skill_name'</span>: execution_result.skill_name,
            <span class="hljs-string">'execution_time_ms'</span>: execution_result.duration,
            <span class="hljs-string">'token_usage'</span>: {
                <span class="hljs-string">'input'</span>: execution_result.input_tokens,
                <span class="hljs-string">'output'</span>: execution_result.output_tokens,
                <span class="hljs-string">'total'</span>: execution_result.total_tokens
            },
            <span class="hljs-string">'success'</span>: execution_result.success,
            <span class="hljs-string">'error_type'</span>: execution_result.error_type <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> execution_result.success <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
        }
        
        <span class="hljs-comment"># 发送到监控系统</span>
        self._send_to_monitoring_backend(metrics)
        
        <span class="hljs-comment"># 实时报警检查</span>
        self._check_anomalies(metrics)
</code></pre>
<h3 data-id="heading-33">8. 总结与展望</h3>
<h4 data-id="heading-34">8.1 项目技术价值总结</h4>
<p><strong>Awesome Claude Skills</strong> 项目的技术贡献体现在多个层面：</p>
<ol>
<li>
<p><strong>标准化框架</strong>：定义了可扩展、可维护的技能开发规范，降低了大模型能力工程化的门槛。</p>
</li>
<li>
<p><strong>渐进式架构</strong>：创新的三层加载策略，在能力丰富性和执行效率间取得良好平衡。</p>
</li>
<li>
<p><strong>生态建设</strong>：通过社区贡献机制，形成了可持续的技能扩展模式。</p>
</li>
<li>
<p><strong>企业就绪</strong>：提供安全控制、监控集成等企业级特性，支持生产环境部署。</p>
</li>
</ol>
<h4 data-id="heading-35">8.2 技术发展趋势</h4>
<p><strong>短期演进方向</strong>：</p>
<ol>
<li><strong>技能组合</strong>：支持多技能串联形成复杂工作流</li>
<li><strong>条件执行</strong>：基于执行结果的动态技能选择</li>
<li><strong>学习优化</strong>：根据使用反馈自动优化技能指令</li>
</ol>
<p><strong>长期技术展望</strong>：</p>
<ol>
<li><strong>技能市场机制</strong>：基于使用量、评分的技能分发与奖励</li>
<li><strong>自动技能生成</strong>：从文档、API描述自动创建基础技能</li>
<li><strong>跨模型兼容</strong>：技能描述格式向其他大模型平台扩展</li>
</ol>
<h4 data-id="heading-36">8.3 实践建议</h4>
<p><strong>对于技能使用者</strong>：</p>
<ul>
<li>从高频、重复任务开始引入技能自动化</li>
<li>建立内部技能评估和推广机制</li>
<li>关注技能安全策略，特别是数据保护</li>
</ul>
<p><strong>对于技能开发者</strong>：</p>
<ul>
<li>遵循标准化结构，确保技能可维护性</li>
<li>提供充分示例和边界条件说明</li>
<li>考虑技能在不同Claude平台上的兼容性</li>
</ul>
<p><strong>对于企业架构师</strong>：</p>
<ul>
<li>评估技能对现有工作流的增强潜力</li>
<li>规划技能治理和生命周期管理流程</li>
<li>考虑与现有自动化工具链的集成路径</li>
</ul>
<hr/>
<p><strong>技术实现核心要点回顾</strong>：</p>
<ol>
<li>技能的本质是 <strong>标准化的工作流描述</strong>，而非代码</li>
<li><strong>渐进式加载</strong> 是平衡能力与效率的关键设计</li>
<li><strong>安全边界</strong> 通过多层检查和显式确认保障</li>
<li><strong>生态系统</strong> 通过标准化接口和工具链支持持续扩展</li>
</ol>
<p>该项目展示了如何将大模型的生成能力转化为确定性操作能力，为AI代理的实用化部署提供了有价值的参考架构。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite构建速度提升50%的5个隐藏技巧，90%开发者都不知道！]]></title>    <link>https://juejin.cn/post/7596962344045920296</link>    <guid>https://juejin.cn/post/7596962344045920296</guid>    <pubDate>2026-01-20T04:18:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596962344045920296" data-draft-id="7596962344045903912" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite构建速度提升50%的5个隐藏技巧，90%开发者都不知道！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-20T04:18:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite构建速度提升50%的5个隐藏技巧，90%开发者都不知道！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:18:28.000Z" title="Tue Jan 20 2026 04:18:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite构建速度提升50%的5个隐藏技巧，90%开发者都不知道！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代前端开发中，构建工具的性能直接决定了开发者的效率和体验。Vite凭借其基于ESM的极速冷启动和热更新能力，已经成为越来越多项目的首选构建工具。然而，即使是Vite这样的高性能工具，也存在许多被忽视的优化空间。本文将揭示5个鲜为人知的Vite优化技巧，这些方法经过实际项目验证，最高可实现50%的构建速度提升！</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 精准配置<code>optimizeDeps</code>参数</h3>
<p>大多数开发者只是简单启用Vite的依赖预构建功能（<code>optimizeDeps</code>），却忽略了它的精细化配置潜力：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-comment">// 显式指定需要预编译的依赖</span>
    <span class="hljs-attr">include</span>: [
      <span class="hljs-string">'react'</span>,
      <span class="hljs-string">'react-dom'</span>,
      <span class="hljs-string">'lodash-es'</span>, <span class="hljs-comment">// 对ESM版本的lodash进行优化</span>
      <span class="hljs-string">'antd/es/button'</span> <span class="hljs-comment">// 按需引入组件时特别有效</span>
    ],
    <span class="hljs-comment">// 排除已知不需要优化的依赖</span>
    <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'moment'</span>],
    <span class="hljs-comment">// 强制重新预构建（适用于本地linked包调试）</span>
    <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// 启用多线程处理</span>
    <span class="hljs-attr">workers</span>: <span class="hljs-literal">true</span>
  }
}
</code></pre>
<p><strong>深度解析</strong>：</p>
<ul>
<li><code>include</code>列表可以避免Vite执行耗时的依赖探测过程</li>
<li><code>exclude</code>能防止不必要的模块被处理</li>
<li><code>workers</code>选项利用多核CPU并行处理依赖（实测可减少30%预构建时间）</li>
</ul>
<h3 data-id="heading-4">2. Rollup插件顺序的艺术</h3>
<p>虽然Vite底层使用Rollup打包生产代码，但很少有人注意到插件顺序对性能的影响：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { visualizer } <span class="hljs-keyword">from</span> <span class="hljs-string">'rollup-plugin-visualizer'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// ✅正确的插件顺序（性能最佳）</span>
    <span class="hljs-title function_">vue</span>(),        <span class="hljs-comment">// 框架插件优先</span>
    <span class="hljs-title function_">legacy</span>(),     <span class="hljs-comment">// polyfill相关次之</span>
    
    <span class="hljs-comment">// ❌错误的放置位置会导致重复分析AST</span>
    <span class="hljs-title function_">visualizer</span>()   <span class="hljs-comment">// 分析工具应该最后执行</span>
    
    <span class="hljs-comment">// ⚠️压缩相关插件会被自动追加到最后（无需手动添加）</span>
  ]
}
</code></pre>
<p><strong>性能数据对比</strong>：</p>

















<table><thead><tr><th><strong>插件顺序方案</strong></th><th><strong>构建时间(秒)</strong></th></tr></thead><tbody><tr><td><strong>最优顺序</strong></td><td>12.3</td></tr><tr><td><strong>随机顺序</strong></td><td>16.7 (+35%)</td></tr></tbody></table>
<h3 data-id="heading-5">3. CSS处理的隐藏优化项</h3>
<p>CSS处理往往是构建的性能瓶颈之一，以下是关键优化点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">css</span>: {
    <span class="hljs-comment">// ✨关键配置：禁用sourcemap可获得20%-30%提速</span>
    <span class="hljs-attr">devSourcemap</span>: <span class="hljs-literal">false</span>,
    
    <span class="hljs-attr">postcss</span>: {
      <span class="hljs-attr">plugins</span>: [
        <span class="hljs-built_in">require</span>(<span class="hljs-string">'postcss-import'</span>)({
          <span class="hljs-attr">path</span>: [<span class="hljs-string">'src/styles'</span>], <span class="hljs-comment">// 📌指定查找路径减少文件探测时间</span>
        }),
        <span class="hljs-built_in">require</span>(<span class="hljs-string">'tailwindcss'</span>)({
          <span class="hljs-attr">content</span>: [<span class="hljs-string">"./src/**/*.{html,js}"</span>], <span class="hljs-comment">// 🎯精确限定扫描范围 </span>
        })
      ]
    },
    
    <span class="hljs-attr">modules</span>: {
      <span class="hljs-attr">scopeBehaviour</span>: <span class="hljs-string">'local'</span>,
      <span class="hljs-attr">generateScopedName</span>: <span class="hljs-string">'[name]__[local]___[hash:base64:5]'</span>
      <span class="hljs-comment">// 💡使用确定性的类名生成规则可避免哈希计算开销 </span>
    }
}
</code></pre>
<p><strong>实战建议</strong>：</p>
<ul>
<li>Tailwind用户应严格限定content扫描范围（大型项目可节省40%以上CSS处理时间）</li>
<li>PostCSS配置中避免使用<code>:global</code>等低效选择器</li>
</ul>
<h3 data-id="heading-6">4. Rust驱动的极致优化</h3>
<p>利用Rust编写的SWC替代Babel/TS编译器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> swc <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-swc'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
 <span class="hljs-attr">plugins</span>: [
   swc.<span class="hljs-title function_">vite</span>({
     <span class="hljs-attr">tsconfigFile</span>: <span class="hljs-string">'./tsconfig.json'</span>,
     <span class="hljs-attr">jsc</span>:{
       <span class="hljs-attr">target</span>:<span class="hljs-string">'es2022'</span>,
       <span class="hljs-attr">parser</span>:{ <span class="hljs-attr">syntax</span>:<span class="hljs-string">'typescript'</span> },
       <span class="hljs-attr">transform</span>:{
         <span class="hljs-attr">react</span>:{ <span class="hljs-attr">runtime</span>:<span class="hljs-string">'automatic'</span> }
       }
     }
   })
 ]
})
</code></pre>
<p><strong>性能对比测试结果</strong>：</p>




















<table><thead><tr><th><strong>编译器类型</strong></th><th><strong>冷启动时间(ms)</strong></th><th><strong>HMR更新(ms)</strong></th></tr></thead><tbody><tr><td>Babel+TS</td><td>~1200</td><td>~400</td></tr><tr><td>SWC</td><td>~450 (-62%)</td><td>~150 (-62%)</td></tr></tbody></table>
<h3 data-id="heading-7">5. Node_modules缓存策略进阶</h3>
<p>超越默认缓存机制的高级技巧：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { createLogger } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">const</span> logger = <span class="hljs-title function_">createLogger</span>()
<span class="hljs-keyword">let</span> cacheVersion = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
 <span class="hljs-attr">cacheDir</span>:<span class="hljs-string">`node_modules/.vite_<span class="hljs-subst">${cacheVersion}</span>`</span>, 
  
 <span class="hljs-attr">server</span>:{
   <span class="hljs-attr">watch</span>:{
     <span class="hljs-attr">usePolling</span>:<span class="hljs-literal">true</span>,
     <span class="hljs-attr">interval</span>:
       process.<span class="hljs-property">env</span>.<span class="hljs-property">DOCKER_MODE</span> ? 
         <span class="hljs-number">1000</span> : <span class="hljs-literal">undefined</span> 
     <span class="hljs-comment">/**
      * 🐳 Docker环境需要特殊处理文件监听：
      * - polling模式确保容器内文件变化能被检测到  
      * - Windows/WSL2同理需要此配置  
      */</span>
   }
 },
  
 <span class="hljs-attr">build</span>:{
   <span class="hljs-attr">rollupOptions</span>:{
     <span class="hljs-attr">output</span>:{
       <span class="hljs-title function_">manualChunks</span>(<span class="hljs-params">id</span>){
         <span class="hljs-keyword">if</span>(id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'node_modules'</span>)){
           <span class="hljs-keyword">return</span> id.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/[\\/]node_modules[\\/](.*?)([\\/]|$)/</span>)[<span class="hljs-number">1</span>]
         }
         <span class="hljs-comment">/**
          * 📦自定义chunk分割策略：
          * - react/vue等框架单独分包  
          * - UI库独立分包  
          * - utils类库合并分组  
          */</span>
       }
     }
   } 
 },
  
 <span class="hljs-attr">plugins</span>:[{
   <span class="hljs-attr">name</span>:<span class="hljs-string">'cache-reset-trigger'</span>,
   
</code></pre>
<h2 data-id="heading-8"/>
<h2 data-id="heading-9"/>
<h2 data-id="heading-10"/>
<pre><code class="hljs">   
</code></pre>
<h2 data-id="heading-11"/>
<pre><code class="hljs">   
</code></pre>
<h2 data-id="heading-12"/>
<pre><code class="hljs language-ini" lang="ini">   

}<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-13"/>
<pre><code class="hljs">   

}
</code></pre>
<h2 data-id="heading-14"/>
<pre><code class="hljs">   

]
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【playwright 学习笔记 day01】原理讲解与基础操作]]></title>    <link>https://juejin.cn/post/7596962772145094671</link>    <guid>https://juejin.cn/post/7596962772145094671</guid>    <pubDate>2026-01-20T04:05:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596962772145094671" data-draft-id="7596993862533496832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【playwright 学习笔记 day01】原理讲解与基础操作"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T04:05:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户453447493875"/> <meta itemprop="url" content="https://juejin.cn/user/590879236308844"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【playwright 学习笔记 day01】原理讲解与基础操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/590879236308844/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户453447493875
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:05:33.000Z" title="Tue Jan 20 2026 04:05:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">原理：</h2>
<p><code>Playwright</code> 是微软开发的 <code>Web应用</code> 的 <code>自动化测试框架</code> 。</p>
<p>它和另外一个 web自动化框架 <code>Selenium</code> 有 什么区别呢？</p>
<p>区别一：</p>
<p>Selenium 只提供了 Web 自动化功能， 如果你要做自动化测试，需要结合其它自动化测试框架</p>
<p>而 Playwright 是面向自动化测试的，除了Web自动化功能，它也包含了自动化测试的功能框架；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76a5766af2f2413588b5c345da67e7e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDUzNDQ3NDkzODc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486733&amp;x-signature=WWrjnJZsMH3eVH6GSlVy0SN9A0c%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>安装过程跳过，直接进入基础代码</p>
<p>我这里使用的环境是vscode的虚拟环境、python3.14.2</p>
<h2 data-id="heading-1">基础代码：</h2>
<p>导入playwright库：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> playwright.<span class="hljs-property">sync_api</span> <span class="hljs-keyword">import</span> sync_playwright
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>.start()会返回一个playwright进程</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 启动 playwright driver 进程</span>
<span class="hljs-attr">p</span> = sync_playwright().start()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 启动浏览器，返回 Browser 类型对象</span>
<span class="hljs-attr">browser</span> = p.chromium.launch(headless=<span class="hljs-literal">False</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>headless=False 取消无头模式，该模式下我们可以直接看到程序打开的浏览器</p>
<p>headless=True 开启无头模式，我们程序打开的浏览器被隐藏</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment"># 创建新页面，返回 Page 类型对象</span>
page = browser.<span class="hljs-title function_ invoke__">new_page</span>()
page.<span class="hljs-keyword">goto</span>(<span class="hljs-string">"https://www.byhy.net/cdn2/files/selenium/stock1.html"</span>)
<span class="hljs-keyword">print</span>(page.<span class="hljs-title function_ invoke__">title</span>()) <span class="hljs-comment"># 打印网页标题栏</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>page用来接收新页面的参数，可以通过page来对新页面进行操作</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 输入通讯，点击查询。这是定位与操作，是自动化重点，后文详细讲解</span>
page.locator(<span class="hljs-string">'#kw'</span>).fill(<span class="hljs-string">'通讯'</span>)  <span class="hljs-comment"># 输入通讯</span>
page.locator(<span class="hljs-string">'#go'</span>).click()      <span class="hljs-comment"># 点击查询</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d94ec37735ca45d58e383ac53b73e396~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDUzNDQ3NDkzODc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486733&amp;x-signature=K6jU0FU7Zu83GK8EUFVE9GvT0%2F0%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p><strong>.locator() 定位</strong>到#kw搜索框，fill() 输入通讯</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 打印所有搜索内容</span>
<span class="hljs-attr">lcs</span> = page.locator(<span class="hljs-string">".result-item"</span>).all()
for lc in lcs:
    print(lc.inner_text())
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 关闭浏览器</span>
browser.close()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 关闭 playwright driver 进程</span>
p.stop()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>完整代码和结果：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> playwright.sync_api <span class="hljs-keyword">import</span> sync_playwright

<span class="hljs-built_in">input</span>(<span class="hljs-string">'1....'</span>)
<span class="hljs-comment"># 启动 playwright driver 进程</span>
p = sync_playwright().start()

<span class="hljs-built_in">input</span>(<span class="hljs-string">'2....'</span>)
<span class="hljs-comment"># 启动浏览器，返回 Browser 类型对象</span>
browser = p.chromium.launch(headless=<span class="hljs-literal">False</span>)

<span class="hljs-comment"># 创建新页面，返回 Page 类型对象</span>
page = browser.new_page()
page.goto(<span class="hljs-string">"https://www.byhy.net/cdn2/files/selenium/stock1.html"</span>)
<span class="hljs-built_in">print</span>(page.title()) <span class="hljs-comment"># 打印网页标题栏</span>

<span class="hljs-comment"># 输入通讯，点击查询。这是定位与操作，是自动化重点，后文详细讲解</span>
page.locator(<span class="hljs-string">'#kw'</span>).fill(<span class="hljs-string">'通讯'</span>)  <span class="hljs-comment"># 输入通讯</span>
page.locator(<span class="hljs-string">'#go'</span>).click()      <span class="hljs-comment"># 点击查询</span>

<span class="hljs-comment"># 打印所有搜索内容</span>
lcs = page.locator(<span class="hljs-string">".result-item"</span>).<span class="hljs-built_in">all</span>()
<span class="hljs-keyword">for</span> lc <span class="hljs-keyword">in</span> lcs:
    <span class="hljs-built_in">print</span>(lc.inner_text())

<span class="hljs-built_in">input</span>(<span class="hljs-string">'3....'</span>)
<span class="hljs-comment"># 关闭浏览器</span>
browser.close()
<span class="hljs-built_in">input</span>(<span class="hljs-string">'4....'</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad75674db0074cda93eaf9611c5cb1e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDUzNDQ3NDkzODc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486733&amp;x-signature=Eq5UAnx%2B87JhmEH6HzlfNCSSTC0%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>以上代码没有正确输出打印的结果，是因为程序来不及加载信息，我们需要给程序几秒等待的时间</p>
<h2 data-id="heading-2">界面等待：</h2>
<pre><code class="hljs language-scss" lang="scss">page<span class="hljs-selector-class">.wait_for_timeout</span>(<span class="hljs-number">2000</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>加入等待时间后就正常打印出抓取的信息了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d1fc334d4d54a1fac24d6924d30fcfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDUzNDQ3NDkzODc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486733&amp;x-signature=50rRtaeYlOUTMrZ21oehqdo4ZTc%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h2 data-id="heading-3">自动化代码助手：</h2>
<p>该助手主要记录我们对浏览器的操作，定位、文本框输入、输入网站等...</p>
<p>不能过彻底代替我们实现我们想要的功能，例如：无法完成数据的抓取</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行代码</span>
playwright codegen
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eda280395014bffbca13244297f913e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDUzNDQ3NDkzODc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486733&amp;x-signature=9DDclaJlKTmwHfNF%2BFytsJHU6e8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h2 data-id="heading-4">跟踪功能<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.byhy.net%2Fetc%2Fplaywright%2F01%2F%23h_7" title="https://www.byhy.net/etc/playwright/01/#h_7" target="_blank" ref="nofollow noopener noreferrer">🏷️</a></h2>
<p>Playwright 有个特色功能： 跟踪（tracing）</p>
<p>启用跟踪功能后， 可以在执行自动化后，通过记录的跟踪数据文件， 回看自动化过程中的每个细节。</p>
<p>下面的的代码进行了自动化搜索股票，并打开跟踪功能，保存 跟踪数据文件 为 <code>trace.zip</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/776c4ddd2d274e32b4c128cab5d061d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDUzNDQ3NDkzODc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486733&amp;x-signature=vdEr0ll1f%2BAGUVRp7pJ9gpOFOug%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>执行完以后，我们发现，当前工作目录下面多了 trace.zip 这个跟踪数据文件。</p>
<p>怎么查看这个跟踪文件呢？有2种方法：</p>
<ul>
<li>直接访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftrace.playwright.dev%2F" title="https://trace.playwright.dev/" target="_blank" ref="nofollow noopener noreferrer">trace.playwright.dev</a> 这个网站，上传 跟踪文件</li>
<li>执行命令 <strong><code>playwright show-trace trace.zip</code></strong></li>
<li><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5354de65222d47709bd26e4ee6189dc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDUzNDQ3NDkzODc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486733&amp;x-signature=9C012w5uuWvsvu53Y8SUYPkweDc%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</li>
</ul>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AgentSkill 使用和开发完整指南]]></title>    <link>https://juejin.cn/post/7596934200581324836</link>    <guid>https://juejin.cn/post/7596934200581324836</guid>    <pubDate>2026-01-20T00:36:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596934200581324836" data-draft-id="7596970073749471268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AgentSkill 使用和开发完整指南"/> <meta itemprop="keywords" content="前端,AI编程,人工智能"/> <meta itemprop="datePublished" content="2026-01-20T00:36:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qiyue77"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450881991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AgentSkill 使用和开发完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450881991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qiyue77
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T00:36:08.000Z" title="Tue Jan 20 2026 00:36:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、CC中使用Agent skill</h3>
<p>先开门见山，让你快速用起来，建立学习自信，同时降低认知成本。</p>
<h4 data-id="heading-1">1.1 创建skill目录</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/.claude/skills/explaining-code
</code></pre>
<h4 data-id="heading-2">1.2 创建SKILL.md文件</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">explaining-code</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">使用可视化图表和类比来解释代码。在解释代码工作原理、教授代码库知识，或用户询问"这是如何工作的？"时使用。</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">解释代码时，始终包含：</span>

<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">**从类比开始**：将代码与日常生活中的事物进行比较</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">**绘制图表**：使用</span> <span class="hljs-string">ASCII</span> <span class="hljs-string">艺术展示流程、结构或关系</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">**逐步讲解代码**：逐步解释发生了什么</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">**指出常见陷阱**：常见的错误或误解是什么？</span>

<span class="hljs-string">保持解释的对话性。对于复杂概念，使用多个类比。</span>
</code></pre>
<h4 data-id="heading-3">1.3 检查可用性</h4>
<p>启动claude code，然后执行/skills可查看当前所有skill</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd8569c75bc540dc9eddcf6ca15cb27c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=6BvLB0ySlmvQqF0kCGklfmzVdOo%3D" alt="" loading="lazy"/></p>
<p>当然官方提供了一种验证方法，<code>What Skills are available?</code>，不过是一种提问表述，你用中文也可以。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/747e5450e9d64f9f98df96becf783629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=LQOoaMgV1bdt%2FG10x5%2BiJkqqmFI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">1.4 测试效果</h4>
<p>测试效果，本质就是给AI一个符合SKILL要求的任务</p>
<p>比如我开发了一个格式化文本的SKILL，如下图，我告诉他格式化清理空格。</p>
<p><strong>我的SKILL</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72415e3737304e58bb35775f4ef98e75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=HBDSJOO2oWJmULwByyMYRZqN27o%3D" alt="" loading="lazy"/></p>
<p><strong>实际测试</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04d5886d9ace4b128fd4d370f61113c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=88PRlXCPZhOik2veOYZsj2nSKTk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8f54e17bc744f3c9f1c1124d1329da5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=yoi9Ab0KAoO6o55q4rFCyDuJnbI%3D" alt="" loading="lazy"/></p>
<p>从上面我们会发现一个有趣的问题，<strong>第一次它没有使用技能，当我问它后，它调用了技能</strong>。</p>
<p>这里其实可以得到2个结论：</p>
<ul>
<li>
<p><strong>SKILL不是100%执行的</strong>，官方也说明了，符合要求才会触发技能</p>
</li>
<li>
<p><strong>过于简单的任务，必须要触发技能</strong>，AI自己可以处理</p>
</li>
</ul>
<p>按照上面流程，用户可以快速使用和验证，掌握Agent Skill使用要领，<strong>构建学习信心</strong>，然后下面我们在细节展开知识点。</p>
<h3 data-id="heading-5">二、一个真实案例实践</h3>
<h4 data-id="heading-6">2.1 安装</h4>
<p>安装方式有多种，我这里只针对CC的安装进行介绍。</p>
<p><strong>方法一：</strong> 简单粗暴，直接下载官方github文件，然后复制到对应目录下。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06699b0c8a9f457f997c9854fac1325c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=xu7mvWU6UfHWLtud7PbuZA8OVbY%3D" alt="" loading="lazy"/></p>
<p><strong>方法二：</strong> 注意颜面，保持优雅，用官方命令进行安装</p>
<ul>
<li>
<p>启动claude执行 <code>/plugin install document-skills@anthropic-agent-skills</code></p>
</li>
<li>
<p>完成后重启项目，如果不行，执行 <code>/plugin</code> 检查是否启用</p>
</li>
</ul>
<p><strong>方法三：</strong> 兜兜绕绕也能行，从插件里选择，还可以看到别的skill平台</p>
<ul>
<li>启动claude执行 <code>/plugin marketplace add anthropics/skills </code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96fdb9daa65e41f5b514c94b942e77be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=26dqFIecYKFstUQW7HdFBioVeAc%3D" alt="" loading="lazy"/></p>
<ul>
<li>执行<code>/plugins</code>，在 Discover中找到官方skill</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/682f24af7cfe45b19072430cd1dcd960~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=XgQO01NuYwnbeBm0yRJLr4c0fOA%3D" alt="" loading="lazy"/></p>
<ul>
<li>选择安装位置，用户维度，项目维度，本地当前库，安装完成后，会在<code>.claude/</code>下生成一个json文件</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1141c55df88d4023946d1a0c067a6172~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=%2Fchh9poV9RzDufjINRIa3NHr9M0%3D" alt="" loading="lazy"/></p>
<ul>
<li>重启claude 工具，再次执行 <code>/skills</code>，即可查看到安装的技能</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b58d0b12e0784dd2b423f10be41e80d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=36lxfpech30th4a6SpNoJNQAq8I%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">2.2 实际应用</h4>
<ul>
<li>我让claude把excel生成数据报表，这个表述命中了技能描述，所以开始调用技能</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-string">name：</span> <span class="hljs-string">xlsx</span>
<span class="hljs-string">description：</span> <span class="hljs-string">全面的电子表格创建、编辑和分析功能，支持公式、格式化、数据分析和可视化。当</span> <span class="hljs-string">Claude</span> <span class="hljs-string">需要处理电子表格文件（.xlsx、.xlsm、.csv、.tsv</span> <span class="hljs-string">等）时，可用于：1.创建包含公式和格式的新电子表格;2.读取或分析数据;3.修改现有电子表格同时保留公式;4.在电子表格中进行数据分析和可视化;5.重新计算公式</span>

<span class="hljs-meta">---
</span></code></pre>
<ul>
<li>这里开始执行技能（会自动检测工具，如果没有安装，可以让claude自行安装处理）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e65a47d943a4779a8a72bd654044fb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=CACMngJN7vmTIv139HW2kCjlFb4%3D" alt="" loading="lazy"/></p>
<ul>
<li>最终把我的excel中的数据提起生成了折线图和柱状图</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfe67814fcef4c69ae8619573bd2ec4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=V9Bwm05TSwqIqz2iGXvZN1fPLY0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">2.3 哪里有别人做好的skill包</h4>
<p><strong>官方skill</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Ftree%2Fmain%2Fskills" target="_blank" title="https://github.com/anthropics/skills/tree/main/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p><strong>三方平台</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fskillsmp.com%2Fzh" target="_blank" title="https://skillsmp.com/zh" ref="nofollow noopener noreferrer">skillsmp.com/zh</a></p>
<p><strong>面向编程</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel-labs%2Fagent-skills%2Ftree%2Fmain%2Fskills" target="_blank" title="https://github.com/vercel-labs/agent-skills/tree/main/skills" ref="nofollow noopener noreferrer">github.com/vercel-labs…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fobra%2Fsuperpowers%2Ftree%2Fmain%2Fskills" target="_blank" title="https://github.com/obra/superpowers/tree/main/skills" ref="nofollow noopener noreferrer">github.com/obra/superp…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/ComposioHQ/…</a></p>
<p><strong>面向UI</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnextlevelbuilder%2Fui-ux-pro-max-skill" target="_blank" title="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill" ref="nofollow noopener noreferrer">github.com/nextlevelbu…</a></p>
<p><strong>工作流平台（dify/n8n）</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Ftree%2Fmain%2F.claude%2Fskills" target="_blank" title="https://github.com/langgenius/dify/tree/main/.claude/skills" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fczlonkowski%2Fn8n-skills" target="_blank" title="https://github.com/czlonkowski/n8n-skills" ref="nofollow noopener noreferrer">github.com/czlonkowski…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkepano%2Fobsidian-skills" target="_blank" title="https://github.com/kepano/obsidian-skills" ref="nofollow noopener noreferrer">github.com/kepano/obsi…</a></p>
<p><strong>其他类型</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOthmanAdi%2Fplanning-with-files" target="_blank" title="https://github.com/OthmanAdi/planning-with-files" ref="nofollow noopener noreferrer">github.com/OthmanAdi/p…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyusufkaraaslan%2FSkill_Seekers" target="_blank" title="https://github.com/yusufkaraaslan/Skill_Seekers" ref="nofollow noopener noreferrer">github.com/yusufkaraas…</a></p>
<h3 data-id="heading-9">三、基础信息</h3>
<h4 data-id="heading-10">3.1 背景</h4>
<p>智能体越来越强大，工作中需要更具可组合性、可扩展性和可移植性的方法实践</p>
<h4 data-id="heading-11">3.2 Agent skill是什么</h4>
<p>一种<strong>利用文件和文件夹构建专业化Agent的新方法</strong>，用来扩展Claude功能的模块化功能。每个技能都包含指令、元数据和可选资源（脚本、模板）</p>
<ul>
<li>指令：告诉Claude如何完成任务</li>
<li>元数据：描述Skill的作用和使用时机</li>
<li>资源：脚本、模板、参考文档等</li>
</ul>
<p>可以理解成工具箱，每个工具箱里有不同工具， 医药箱里面放的药品，可以用来治病。工具箱里面放的扳手，可以用来拧螺丝，这些工具都被你所用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c70ec9b741d24c55904d2c884b9df807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=cjQuSjMYCkes6ZLksgnyZKQ54dc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">3.3 为什么使用</h4>
<ul>
<li>
<p>技能是基于<strong>文件系统</strong>的<strong>可重用资源</strong>，为Claude提供特定领域的专业知识和能力</p>
</li>
<li>
<p>相比rule能力更加强大，skills是更复杂通用能力封装（支持脚本，工具调用），不在仅仅局限Prompt</p>
</li>
<li>
<p>技能<strong>按需加载</strong>，无需在多个对话中重复提供相同的指导，与提示（针对一次性任务的对话级指令）不同</p>
</li>
</ul>
<h4 data-id="heading-13">3.4 什么场景使用skill</h4>
<ul>
<li>
<p>发现自己在向AI反复解释同一件事，或者你在开发中，已经生成的模版结构，rule内容很可能有适用的场景</p>
</li>
<li>
<p>某些任务需要特定知识、模板、材料才能做好，但缺“特定场景的知识材料”（checklist文档/兼容性文档）</p>
</li>
<li>
<p>发现任务复杂，需要一些脚本工具，多个流程协同完成，<code>提取 =&gt; 清洗 =&gt; 组装 =&gt; 输出结果</code>，需要“组合多个流程”才能完成</p>
</li>
</ul>
<h4 data-id="heading-14">3.5 整体架构</h4>
<p><strong>架构来自于官方：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fequipping-agents-for-the-real-world-with-agent-skills" target="_blank" title="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1dfbb59a6744d4280c8b532e0d76e23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=Ms6LxpM6J3%2FDBBOd7Qr0cDSh6wE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-15">3.6 技能的整体组成</h4>
<ul>
<li>最简单版本只要一个SKILL.md即可，只需要包含<strong>元数据和指令</strong></li>
<li>复杂的则是由 元数据 + 指令 + 资源和代码三部分构成</li>
<li>SKILL.md <strong>不可以直接在 skills目录下，必须有子目录</strong></li>
</ul>
<h5 data-id="heading-16">3.6.1 skill位置</h5>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 项目下</span>
.claude/skills/

.claude/skills/demo1/<span class="hljs-built_in">SKILL</span>.md
.claude/skills/demo2/<span class="hljs-built_in">SKILL</span>.md

<span class="hljs-comment">// 用户维度</span>
～/.claude/skills/

<span class="hljs-comment">// 插件下</span>
skills/my-skill/<span class="hljs-built_in">SKILL</span>.md在插件目录中

<span class="hljs-comment">// 错误示例</span>
～/.claude/skills/<span class="hljs-built_in">SKILL</span>.md
</code></pre>
<h5 data-id="heading-17">3.6.2 skill全部可用字段</h5>
<p><strong>更多可以参考：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2Fspecification%23body-content" target="_blank" title="https://agentskills.io/specification#body-content" ref="nofollow noopener noreferrer">agentskills.io/specificati…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Fskills%23available-metadata-fields" target="_blank" title="https://code.claude.com/docs/en/skills#available-metadata-fields" ref="nofollow noopener noreferrer">code.claude.com/docs/en/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38a0375cfe6042718305d5051cddba9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=xTyJqZ8YG0DYBtsCmkWzCA9Keeg%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-18">3.6.3 元数据（始终加载）</h5>
<p>SKILL.md文件头部对技能的描述信息，<strong>即为元数据</strong>。SKILL.md YAML frontmatter 必须的只有两个name和description字段：</p>
<pre><code class="hljs language-shell" lang="shell">name：
最多 64 个字符
必须仅包含小写字母、数字和连字符。
不能包含 XML 标签
不能包含保留字：“anthropic”、“claude”

description：
必须不为空
最多 1024 个字符
不能包含 XML 标签
应该描述该技能的作用以及何时使用。
<span class="hljs-meta prompt_">
# </span><span class="bash">你的技能名字</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 介绍</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 示例</span></span>
</code></pre>
<p><strong>以下一个简单的示例</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">//</span> <span class="hljs-string">SKILL.md</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">text-formatter</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">格式化和美化文本内容，包括大小写转换、空格清理、换行处理和文本对齐。当用户需要格式化文本、清理空格或转换大小写时使用。</span>
<span class="hljs-meta">---
</span></code></pre>
<h5 data-id="heading-19">3.6.4 指令（触发时加载）</h5>
<p>也就是SKILL.md的主体内容，是对这个技巧的说明，让Claude知道要干什么。主体内容包含程序性知识，工作流程、最佳实践和指导原则</p>
<p>当您任务内容与技能描述相符时，Claude会通过bash从文件系统中读取SKILL.md文件。只有这样，该文件的内容才会显示在上下文窗口中**（节省Token和上下文）**。</p>
<p><strong>以下一个简单的示例</strong>（这么简单的任务不需要SKILL，仅为示意）</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">//</span> <span class="hljs-string">SKILL.md</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">text-formatter</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">格式化文本内容，进行大小写转换</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># 文本格式化工具</span>

<span class="hljs-comment">## 概述</span>
<span class="hljs-string">这个</span> <span class="hljs-string">Skill</span> <span class="hljs-string">帮助用户对文本内容进行格式化操作。</span>

<span class="hljs-comment">## 支持的操作</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">标题格式：每个单词首字母大写</span>

<span class="hljs-comment">## 操作指南</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">识别用户请求的格式化操作</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">相应地处理输入文本</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">除非明确要求删除，否则保留重要的格式</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">返回格式化后的结果</span>

<span class="hljs-comment">## 示例</span>
<span class="hljs-comment">### 示例1：标题格式</span>

<span class="hljs-string">输入：</span>
<span class="hljs-string">the</span> <span class="hljs-string">quick</span> <span class="hljs-string">brown</span> <span class="hljs-string">fox</span> <span class="hljs-string">jumps</span> <span class="hljs-string">over</span> <span class="hljs-string">the</span> <span class="hljs-string">lazy</span> <span class="hljs-string">dog</span>

<span class="hljs-string">操作：转换为标题格式</span>

<span class="hljs-string">输出：</span>
<span class="hljs-string">The</span> <span class="hljs-string">Quick</span> <span class="hljs-string">Brown</span> <span class="hljs-string">Fox</span> <span class="hljs-string">Jumps</span> <span class="hljs-string">Over</span> <span class="hljs-string">The</span> <span class="hljs-string">Lazy</span> <span class="hljs-string">Dog</span>

<span class="hljs-comment">## 使用提示</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">注意特殊字符和标点符号的处理</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">对于标题格式，考虑冠词（如</span> <span class="hljs-string">a、an、the）在中间时应该小写</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">如果操作不明确，请询问用户澄清</span>

<span class="hljs-comment">## 错误处理</span>
<span class="hljs-string">如果输入为空：</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">返回空字符串并附注说明</span>

<span class="hljs-string">如果操作不明确：</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">请用户指定操作</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">提供可用操作的示例</span>
</code></pre>
<h5 data-id="heading-20">3.6.5 资源和代码（按需加载）</h5>
<p>主要包含如下三点：说明、代码、资源</p>
<p><strong>说明：</strong> 包含指导和工作流程的附加Markdown文件（FORMS.md/REFERENCE.md）</p>
<p><strong>代码：</strong> scripts脚本，通过bash运行的可执行脚本，这些脚本提供确定性操作，而无需消耗上下文信息</p>
<p><strong>资源：</strong> 参考资料，例：API文档、输出模板</p>
<pre><code class="hljs language-scss" lang="scss">demoskill/
├── SKILL<span class="hljs-selector-class">.md</span>
├── FORMS<span class="hljs-selector-class">.md</span> (表单填写指南)
├── REFERENCE<span class="hljs-selector-class">.md</span> (详细的API参考文档)
└── scripts/
    └── script<span class="hljs-selector-class">.py</span> (脚本)
</code></pre>
<p><strong>加载实际和消耗</strong></p>
<pre><code class="hljs language-dart" lang="dart">元数据 =&gt; 始终加载（启动时）=&gt; 每项技能约需<span class="hljs-number">100</span> Token	

说明 =&gt; 技能触发时 =&gt; 低于<span class="hljs-number">5000</span> Token =&gt; SKILL.md 正文包含说明和指导

资源 =&gt; 根据需要 =&gt; 实际上无限 =&gt; 通过bash执行的捆绑文件
</code></pre>
<p><strong>claude在被引用时才会访问这些文件，SKILL这种文件系统模型优势：指令提供灵活的指导，代码提供可靠性，资源用于事实查找</strong></p>
<h4 data-id="heading-21">3.7 安全问题</h4>
<p>正因为SKILL具有复杂的能力以及对工具，脚本的执行权限，所以SKILL是一种<strong>带有安全隐患的能力</strong>。需要对其保持安全意识。</p>
<h5 data-id="heading-22">3.7.1 官方SKILL</h5>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Ftree%2Fmain" target="_blank" title="https://github.com/anthropics/skills/tree/main" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<ul>
<li>
<p>要检查技能中包含的所有文件，包括 SKILL.md 文件、脚本、图像和其他资源</p>
</li>
<li>
<p>外部数据源存在风险，从外部 URL 获取数据的技能尤其危险</p>
</li>
<li>
<p>工具滥用，调用工具文件操作、bash 命令、代码执行</p>
</li>
<li>
<p>数据泄露，掌握敏感数据访问权限的技能，可能将信息泄露给外部系统</p>
</li>
</ul>
<h3 data-id="heading-23">四、最佳实践</h3>
<h4 data-id="heading-24">4.1 核心原则</h4>
<h5 data-id="heading-25">4.1.1 大道至简，简洁是关键</h5>
<ul>
<li>
<p>上下文窗口是公共资源，技能会将上下文窗口与claude需要了解的所有其他信息共享，系统提示，对话历史，您实际的请求。<strong>所以只补充克劳德原本不了解的背景信息</strong></p>
</li>
<li>
<p>启动时，只会预加载所有技能的元数据（名称和描述）Claude仅在技能相关时才会读取SKILL.md文件，并仅在需要时读取其他文件</p>
</li>
</ul>
<h5 data-id="heading-26">4.1.2 适当的自由度</h5>
<pre><code class="hljs language-markdown" lang="markdown">// 高自由度，由AI发挥
<span class="hljs-section">## 代码审查流程</span>
<span class="hljs-bullet">1.</span> 分析代码结构和组织方式
<span class="hljs-bullet">2.</span> 检查潜在的 bug 或边界情况
<span class="hljs-bullet">3.</span> 提出可读性和可维护性改进建议
<span class="hljs-bullet">4.</span> 验证是否符合项目规范

// 低自由度，必须严格执行
<span class="hljs-section">## 数据库迁移</span>
请严格按照以下脚本执行：

python scripts/migrate.py --verify --backup

不要修改命令或添加额外的标志。
</code></pre>
<h5 data-id="heading-27">4.1.3 多模型测试</h5>
<ul>
<li>
<p>技能是对模型的补充，因此其有效性取决于底层模型。请在所有计划使用该技能的模型上测试该技能</p>
</li>
<li>
<p>技能本身是包含自然语言表述和说明的，所以会存在上下文信息竞争和语义理解差异等问题，<strong>幻觉依然可能存在</strong></p>
</li>
</ul>
<h4 data-id="heading-28">4.2 技能结构细节</h4>
<h5 data-id="heading-29">4.2.1 命名</h5>
<ul>
<li>
<p>技能名称使用动名词形式（动词 + -ing），因为这样可以清晰地描述技能所提供的活动或能力；例：<code>writing-documentation</code></p>
</li>
<li>
<p>不能包含保留字 “anthropic”、“claude”；例：<code>claude-tools</code></p>
</li>
</ul>
<h5 data-id="heading-30">4.2.2 描述</h5>
<ul>
<li>始终使用第三人称写作，视角不一致可能会导致查找困难。</li>
</ul>

<pre><code class="hljs">好的： “处理 Excel 文件并生成报告”
坏的： “我可以帮您处理Excel文件”
</code></pre>
<ul>
<li>
<p>描述对于技能选择极其重要，描述要具体且包含关键术语。既要<strong>说明技能的功能，也要说明具体的触发条件/使用场景</strong></p>
</li>
<li>
<p>克劳德会根据描述从<strong>众多可用技能中选择</strong>合适的技能。描述必须足够明确具体，而SKILL.md的其余部分则提供了实现细节。</p>
</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 正确</span>
description: 从 PDF 文件中提取文本和表格，填写表单，合并文档。在处理 PDF 文件时，或当用户提到 PDF、表单或文档提取时使用。

<span class="hljs-comment">// 错误</span>
description: 处理文件相关操作
</code></pre>
<h5 data-id="heading-31">4.2.3 指令内容实践指导</h5>
<ul>
<li>为了获得最佳性能，SKILL.md正文控制在500 行以内，<strong>超过后拆分文档</strong></li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">text-formatter</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">格式化文本内容，进行大小写转换</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">...</span>
<span class="hljs-string">...</span>
<span class="hljs-string">...</span>
<span class="hljs-string">如果需要复杂处理，请阅读</span> <span class="hljs-string">./REFERENCE.md</span>
</code></pre>
<ul>
<li>
<p>避免文档深度嵌套，文献推荐保持在SKILL.md同级目录（有文件夹也可以），所有参考文献<strong>都应直接链接到SKILL.md</strong>。</p>
</li>
<li>
<p>遇到嵌套引用时，Claude可能会使用head -100预览命令而<strong>不是读取整个文件，从而导致信息不完整</strong></p>
</li>
</ul>

<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 正确</span>
<span class="hljs-built_in">SKILL</span>.md 
  |── REFERENCE.md
  └── FORMS.md
   
<span class="hljs-comment">// 错误</span>
<span class="hljs-built_in">SKILL</span>.md 
  └── REFERENCE.md
        └── FORMS.md
</code></pre>
<ul>
<li>为长文献文件添加目录，对于超过100行的，可以在顶部添加目录，即使预览部分读取结果时，也能看到所有可用信息</li>
</ul>

<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 目录</span></span>
- 身份验证和设置
- 核心方法（创建、读取、更新、删除）
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 身份验证和设置</span></span>
...
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 核心方法</span></span>
...
</code></pre>
<ul>
<li>避免使用有时效性的信息</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">// 错误
当技能调用时，时间处在2025年5月以后，使用新的API，否者使用旧的API。

// 正确的
<span class="hljs-comment">## 当前方法</span>
使用 v2 API: `api.example.com/v2/messages`

<span class="hljs-comment">## 旧版方法</span>
&lt;details&gt;
&lt;summary&gt;v1 API (2025-05弃用)&lt;/summary&gt;

使用 v1 API: `api.example.com/v1/messages`

该API后续将不在支持

&lt;/details&gt;
</code></pre>
<ul>
<li>始终保持一致性的术语，不要混用近义词</li>
</ul>

<pre><code class="hljs language-objectivec" lang="objectivec">如果用了“API 端点”，那整个<span class="hljs-built_in">SKILL</span>相关都保持一致，不要突然换成“API 路由”

如果用了“提取”，那就都保持一致，不要使用“拉取”、“获取”
</code></pre>
<ul>
<li>
<p>合理的使用样本示例和模版结构，可以根据需求，提供不同灵活度的约束条件</p>
</li>
<li>
<p>通过自然语言约束灵活度，必须代表严格，建议代表宽松（<strong>既然是自然语言，那就可能有不稳定性</strong>）</p>
</li>
</ul>

<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 输出格式</span></span>

必须（建议）按照如下格式，输出内容信息
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 标题1</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">### 标题1.1</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#### 标题1.1.1</span></span>
</code></pre>
<ul>
<li>如果必要时，提供示例，但切记不要过度。</li>
</ul>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-strong">**Example 1:**</span>
xxxxxx

<span class="hljs-strong">**Example 2:**</span>
xxxxxx

</code></pre>
<ul>
<li>使用条件工作流，来处理不同分支任务（<strong>既然是自然语言，那就可能有不稳定性</strong>）</li>
</ul>

<pre><code class="hljs language-markdown" lang="markdown">确定修改类型：
<span class="hljs-strong">**创建新内容？**</span> → 遵循下面的"创建流程"
<span class="hljs-strong">**编辑现有内容？**</span> → 遵循下面的"编辑流程"

创建流程：
<span class="hljs-bullet">-</span> 使用 docx-js 库
<span class="hljs-bullet">-</span> 从零构建文档
<span class="hljs-bullet">-</span> 导出为 .docx 格式

编辑流程：
<span class="hljs-bullet">-</span> 解包现有文档
<span class="hljs-bullet">-</span> 直接修改 XML
<span class="hljs-bullet">-</span> 每次更改后验证
<span class="hljs-bullet">-</span> 完成后重新打包
</code></pre>
<ul>
<li>避免提供过多选项</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 错误情况</span>
你可以使用，pypdf工具，pdfplumber工具，或者pdf2image工具
</code></pre>
<h5 data-id="heading-32">4.2.4 复杂任务解决方案</h5>
<ul>
<li>
<p>针对复杂任务，使用工作流处理处理，并且增加检测反馈回路，验证结果正确性</p>
</li>
<li>
<p>将复杂的操作分解成循序渐进的步骤。提供一份清单，<strong>让其复制到回复中</strong>，并在流程进行过程中逐项勾选</p>
</li>
<li>
<p>检查每个声明是否引用了正确的源文档，如果有异常进行步骤回溯</p>
</li>
</ul>

<pre><code class="hljs language-diff" lang="diff">复制此清单并跟踪进度：(这个比较重要)

研究进度：
<span class="hljs-deletion">- [ ] 步骤 1：阅读所有源文档</span>
<span class="hljs-deletion">- [ ] 步骤 2：识别关键主题</span>
<span class="hljs-deletion">- [ ] 步骤 3：交叉引用声明</span>
<span class="hljs-deletion">- [ ] 步骤 4：创建结构化摘要</span>
<span class="hljs-deletion">- [ ] 步骤 5：验证引用</span>

步骤 1：阅读所有源文档
审阅 sources/ 目录中的每个文档。记录主要论点和支持证据。

步骤 2：识别关键主题
查找跨来源的模式。哪些主题反复出现？来源在哪些地方一致或分歧？

步骤 3：交叉引用声明
对每个主要声明，验证其是否出现在源材料中。记录每个要点由哪个来源支持。

步骤 4：创建结构化摘要
按主题组织发现。包括：
<span class="hljs-deletion">- 主要声明</span>
<span class="hljs-deletion">- 来自来源的支持证据</span>
<span class="hljs-deletion">- 冲突观点（如有）</span>

步骤 5：验证引用
检查每个声明是否引用了正确的源文档。如引用不完整，返回步骤 3。
</code></pre>
<h3 data-id="heading-33">五、如何开发自己的Skill</h3>
<h4 data-id="heading-34">5.1 第一步安装</h4>
<p>首先安装skill-creator，是官方提供的用来创建skill的skill（有点绕口），你可以直接下载安装，也可以用上面提到的方式安装</p>
<p>也可以把下面连接地址给Claude，让他自主安装（<strong>如果用了国内模型，这个有随机性，中间可能出岔子</strong>）</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Ftree%2Fmain%2Fskills%2Fskill-creator" target="_blank" title="https://github.com/anthropics/skills/tree/main/skills/skill-creator" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bdd4aefa05f442695ea0dba39b53629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=IMsb4HE%2BVlgwpis5%2B2ziFvBnw5c%3D" alt="" loading="lazy"/></p>
<p>当你使用 /skills 能够查看到自己的技能里有 skill-creator 时，说明安装成功</p>
<h4 data-id="heading-35">5.2 创建自己skill</h4>
<ul>
<li>claude 会分析你的内容描述以及项目结构等，然后开始创建skill</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7d0c52945bd445a8d7fd1e22351d4e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=4rLveRkHv2o36%2B3H2YddYfG8%2Bzs%3D" alt="" loading="lazy"/></p>
<ul>
<li>按照TODO清单，逐步完成</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81ebfe18a017465ab94785cc3e06e9e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=PqD2zhoPOeFDaprkB39LJG2urnY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e818215d5044f4caa77233901db92ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=r7KFXXmGy1PX0mmOy42k6cTg%2BEI%3D" alt="" loading="lazy"/></p>
<ul>
<li>这次我们看一下，刚才创建skill是不是就已经出现了</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7190315d4c5482da65c76c03bcd93d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=QFjPYMn%2BlMSZM8r%2FyimLALZ%2FFQk%3D" alt="" loading="lazy"/></p>
<p><strong>是不是觉得很ok了？嘿嘿，告诉你个坏消息，完全错了。</strong> 知道错在哪里吗？这个技能完全是AI自己 <strong>“按照知识瞎编的，当然一样可用”</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d55012ef3444e0e8d5f76d0a0e2cb1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=NB%2Fvy9Jw9haM0pNyBq44YA52iw4%3D" alt="" loading="lazy"/></p>
<p><strong>真正的技能调用是这样的</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/403e70345c484c299f8a5ab83c3473d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=j1uoI22PwQ0T1qr%2FpM8vwG3I%2BvA%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>最后一步，是打包构建.skill文件（一种压缩包），当然不构建也是可以使用的。<strong>为什么要这么做？</strong></p>
</li>
<li>
<p>1.标准化封装；2.便捷分发；3.版本控制；4.安全验证；5.自动化安装。6.未来应该会有通用的包管理库（类似前端npm）</p>
</li>
</ul>
<h4 data-id="heading-36">5.3 开发调试和技能测试流程</h4>
<p>上面是快速产出流程，但是一个技能就像一款软件产品，它是解决一类问题，并被可能被很多人或者模型使用的，所以稳定可靠非常重要。</p>
<h5 data-id="heading-37">5.3.1 能力调试</h5>
<ul>
<li>
<p>能力调试的本本事就是SKILL.md提示词和脚本的调试测试，因为<strong>官方明确说明skill在创建或修改时自动加载</strong>，所以提示词调试应该是有<strong>热更新</strong>的概念，改完即可生效。</p>
</li>
<li>
<p><strong>对于脚本调试，推荐直接使用命令调用，会比大模型触发速快</strong>，如果不懂命令行，那就保持大模型处理</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02fdeaaf81ce421b9f71a5b51331b691~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=3ESqshlS%2BTcX7I%2Boaq280wXw%2B3U%3D" alt="" loading="lazy"/></p>
<ul>
<li>技能不太符合要求，我就继续修改脚本和SKILL.md进行调试，直到达标</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70a680a112cd47c4b7a9df6401cf534f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=1tsUWXZooDk9DOGyRSZ%2BH4txtDo%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-38">5.3.2 技能标准检测</h5>
<ul>
<li>使用skill-creater验证自己开发的技术是否合格。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63ee2da5d2974570a4ea39f79d9650db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=pZjOVX%2BwYkNdMYhSgWYvSTPJ2xI%3D" alt="" loading="lazy"/></p>
<ul>
<li>发现了目录嵌套问题</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5eaa9b6f47442ea93b353cb23244e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=QECTX4dfuUQ6o7h%2Bwt%2Fr31uYxUE%3D" alt="" loading="lazy"/></p>
<ul>
<li>自动解决问题，然后再次验证通过</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0879aec45490460db53640f7f7dbb087~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=%2BJjut3EJapuo379gl2HYlfTXa0k%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-39">5.4 开发自己skill阶段的问题</h4>
<ul>
<li>第一个问题就是<strong>AI明显存在理解问题的</strong>，不一定使用技能，skill不是一个足够稳定能力（<strong>不排除因为我用了阿里的代理问题</strong>，我看他人分享截图流程是比较顺利的）。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/678b3b95efd24f46abe81341926d2f4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=PeLpXcXCBzAnA5dF97qS7WbcAac%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>丢步骤和流程，</strong> 官方skill-creater，在第5步骤是明确有打包说明的，胆这次最后它还是任务开发完就结束了（上一个技能就自动打包了）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73242d49c9224217aa8923fdc8753b68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=x8%2FH0mKmiLp88Vem7nIKpkgJXgw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73a99836c0d04baf8f34bb9ae71509a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=VjKpoh4YVL%2FjwDTog%2B5MdcoKpaI%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>AI嘴还是挺硬的，</strong> 想要开发好的技能，最佳实践还需要开发者有经验，只靠AI生成，会有问题</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24421516d1f54480afe530a74be7def4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=N4AUkcsmvIatd4KmP6MvYXl%2FTgw%3D" alt="" loading="lazy"/></p>
<p><strong>最后附上检查清单，便于审查技能情况是否按照规范实践</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Fbest-practices%23checklist-for-effective-skills" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices#checklist-for-effective-skills" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p>
<h3 data-id="heading-40">六、附录参考</h3>
<p><strong>官方快速开始</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Foverview%23pre-built-agent-skills" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview#pre-built-agent-skills" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p>
<p><strong>claude code使用文档</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Fskills%23multiple-skills-conflict" target="_blank" title="https://code.claude.com/docs/en/skills#multiple-skills-conflict" ref="nofollow noopener noreferrer">code.claude.com/docs/en/ski…</a></p>
<p><strong>最佳实践</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p>
<p><strong>skill开放标准</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2Fhome" target="_blank" title="https://agentskills.io/home" ref="nofollow noopener noreferrer">agentskills.io/home</a></p>
<p><strong>官方博客</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fequipping-agents-for-the-real-world-with-agent-skills" target="_blank" title="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[收藏！LLM-RL训练框架：3大流派+6大框架，一文搞定]]></title>    <link>https://juejin.cn/post/7596906923892899850</link>    <guid>https://juejin.cn/post/7596906923892899850</guid>    <pubDate>2026-01-20T00:37:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596906923892899850" data-draft-id="7596970073749356580" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="收藏！LLM-RL训练框架：3大流派+6大框架，一文搞定"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-20T00:37:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AIFrontiers"/> <meta itemprop="url" content="https://juejin.cn/user/4443547050451306"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            收藏！LLM-RL训练框架：3大流派+6大框架，一文搞定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4443547050451306/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AIFrontiers
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T00:37:24.000Z" title="Tue Jan 20 2026 00:37:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>原文: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F9f4mqYVGKNS-LhmHLl6CXw" target="_blank" title="https://mp.weixin.qq.com/s/9f4mqYVGKNS-LhmHLl6CXw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/9f4mqYVGK…</a></strong></p>
<p><strong>LLM-RL往期文章推荐</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fcx3qY42Lp0L3RaSOgsH77A" target="_blank" title="https://mp.weixin.qq.com/s/cx3qY42Lp0L3RaSOgsH77A" ref="nofollow noopener noreferrer">小白也能看懂的RL-PPO</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FnfN0dWT3ZfDuW7ZGfaG6dA" target="_blank" title="https://mp.weixin.qq.com/s/nfN0dWT3ZfDuW7ZGfaG6dA" ref="nofollow noopener noreferrer">收藏！强化学习从入门到封神：5 本经典教材 + 8 大实战项目 + 7个免费视频，一站式搞定</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F4_6CBXMJhqmiYKSzsAXncg" target="_blank" title="https://mp.weixin.qq.com/s/4_6CBXMJhqmiYKSzsAXncg" ref="nofollow noopener noreferrer">小白也能看懂的RLHF：基础篇</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F8O7W8--x14-b1d3M9IS_3w" target="_blank" title="https://mp.weixin.qq.com/s/8O7W8--x14-b1d3M9IS_3w" ref="nofollow noopener noreferrer">小白也能看懂的RLHF-PPO：原理篇</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F9KT9LrMTXDGHSvGFrQhRkg" target="_blank" title="https://mp.weixin.qq.com/s/9KT9LrMTXDGHSvGFrQhRkg" ref="nofollow noopener noreferrer">小白也能看懂的LLM-RL算法：PPO/DPO/GRPO/GSPO</a></p>
<p>2022年OpenAI发布Chatgpt之后，LLM成为了街头巷尾热议的话题。其中，LLM的训练和微调技术成为了这波技术浪潮的大功臣。在前面几篇中，我们详细介绍了LLM-RL训练、微调的核心算法原理。本篇将聚焦梳理LLM-RL开源 LLM-RL 训练框架。</p>
<p>在LLM-RL训练和微调技术演进中，模型对齐技术从辅助微调手段成为决定模型推理、安全与指令遵循能力的核心；SFT（Supervised Fine-Tuning）奠定模型基础行为，RLHF及其衍生的 RLVR（Reinforcement Learning with Verifiable Rewards）则成为突破模型能力上限的关键。</p>
<p>早期RLHF以OpenAI InstructGPT的PPO为核心，但该算法训练成本高，催生了2023年DPO等离线算法成为主流。2025年DeepSeek-R1等模型崛起后，在线采样和过程奖励模型相关的慢思考能力成竞争重点，倒逼社区革新LLM-RL训练框架。本报告将深度解构分析TRL、OpenRLHF、verl、LLaMA Factory四大主流开源LLM-RL训练框架，及 DeepSpeed等重要生态组件，围绕架构设计、关键特性、分布式计算策略及适用场景等维度展开，为相关从业者提供选型参考。</p>
<h2 data-id="heading-0">1 LLM-RL训练的挑战与架构演变</h2>
<p>为了更好的理解各大框架的设计理论，我们先简单剖析下LLM-RL训练中的挑战点。从往期的文章中可以看出，RLHF引入了复杂的环境交互过程：模型必须先根据当前的策略生成样本，并由奖励模型评分，最后通过梯度更新策略。这便带来以下两大挑战：</p>
<ul>
<li>
<p><strong>生成瓶颈与</strong> <strong>显存</strong> <strong>碎片化</strong>：在经典的RLHF流程中，经验数据生成耗时占训练周期 80%-90%的时间，而传统训练框架将生成与训练阶段耦合在同一计算流，会导致模式频繁切换，既造成显存碎片化，也生成阶段的推理效率极低即。即，在训练阶段时，需要维护庞大的梯度图和优化器状态，切换到生成模式时，又需要利用KV Cache来加速推理。</p>
</li>
<li>
<p><strong>四个模型协同的</strong> <strong>分布式</strong> <strong>难题</strong>：标准的PPO算法需要同时在显存中维护四个模型（Actor模型、Critic模型、Reward模型、Reference模型）。以训练一个70B的模型为例，仅仅加载这四个模型的权重就需要超过500GB的显存（FP16精度），这还没加上维护优化器状态和梯度值的存储显存，如何高效地在多GPU节点间切分这四个模型，成为了区分各框架架构优劣的关键因素。</p>
</li>
</ul>
<h3 data-id="heading-1">1.1 架构演进的三大流派</h3>
<p>针对上述挑战，开源社区演化出了三种主要的架构流派：</p>
<ul>
<li>
<p><strong>单体集成流派：</strong> 以<strong>TRL(Transformer</strong> <strong>Reinforcement Learning</strong> <strong>)</strong> 为代表，依托Hugging Face生态，强调算法的模块化和易用性，适合中小规模模型的科研探索。</p>
</li>
<li>
<p><strong>Ray</strong> <strong>分布式</strong> <strong>解耦</strong> <strong>流派：</strong> 以<strong>OpenRLHF</strong>为代表，利用Ray框架将Actor、Critic等模型物理分离到不同的GPU组，并引入vLLM作为独立的推理引擎，大幅提升生成效率，适合大规模模型的生产级训练。</p>
</li>
<li>
<p><strong>混合流引擎流派：</strong> 以<strong>verl</strong> <strong>(Volcano Engine</strong> <strong>RL</strong> <strong>)</strong> 为代表，通过极其灵活的3D-HybridEngine实现计算与数据的解耦，支持Megatron-LM等超大规模并行策略，面向万亿参数模型的极致优化。</p>
</li>
</ul>
<h2 data-id="heading-2">2 TRL</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fefe8bdde6743f388c4d0a4133f03de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUlGcm9udGllcnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474243&amp;x-signature=pjchySsGHNxZD7YVPajZdYu3t44%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Ftrl" target="_blank" title="https://github.com/huggingface/trl" ref="nofollow noopener noreferrer">github.com/huggingface…</a> | 17k⭐</p>
</li>
<li>
<p>官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Ftrl%2Findex" target="_blank" title="https://huggingface.co/docs/trl/index" ref="nofollow noopener noreferrer">huggingface.co/docs/trl/in…</a></p>
</li>
</ul>
<p>TRL不仅是一个代码库，更是Hugging Face生态在后训练阶段的官方实施标准，是生态系统的基石与标准化。它通过与transformers、accelerate和peft库的无缝集成，极大地降低了开发者进入RLHF领域的门槛。</p>
<h3 data-id="heading-3">2.1 核心架构：基于Trainer的模块化设计</h3>
<p>TRL的设计哲学是将强化学习过程封装为标准的Trainer类，继承自Transformers库的训练逻辑。这种设计使得熟悉SFT的用户可以几乎零成本地迁移到RLHF。</p>
<ul>
<li>
<p><strong>PPOTrainer 与 GRPOTrainer</strong>：TRL覆盖了经典PPO的PPOTrainer，v0.17.0+版本新增GRPOTrainer，GRPO通过生成输出组的相对归一化计算优势函数，去除Critic 模型、大幅降显存，是DeepSeek-R1等推理模型复现的首选算法。</p>
</li>
<li>
<p><strong>模型封装</strong>: TRL的AutoModelForCausalLMWithValueHead可以为任意因果语言模型动态加价值头，支持PPO价值估计，能直接对Llama 3、Mistral等模型做RL微调，适配灵活。</p>
</li>
</ul>
<h3 data-id="heading-4">2.2 关键特性</h3>
<ul>
<li>
<p><strong>算法全覆盖</strong>：TRL覆盖SFT、DPO、IPO、KTO、GRPO、BCO等主流后训练算法，是学术界新算法基准对比的首选框架。</p>
</li>
<li>
<p><strong>PEFT与量化集成</strong>：深度绑定peft和bitsandbytes，原生支持QLoRA，单张RTX 4090即可4-bit量化加载大模型并完成PPO、DPO微调，配置便捷。</p>
</li>
<li>
<p><strong>OpenEnv与Agent支持</strong>：集成OpenEnv实现模型与外部环境交互，顺应Agentic AI发展，从对齐工具演进为通用决策智能训练框架，支持工具调用与多步推理的强化学习。</p>
</li>
</ul>
<h3 data-id="heading-5">2.3 局限性与适用场景</h3>
<p>TRL易用性极佳，但大规模分布式训练效率不足</p>
<ul>
<li>
<p><strong>性能瓶颈</strong>：TRL默认用Hugging Face的generate ()生成样本，该方法未做系统级优化。在单体架构下，Actor与 Critic模型在同进程中通过accelerate进行调度，会带来显存的频繁换入换出和通信开销。</p>
</li>
<li>
<p><strong>适用场景</strong>：算法研究员、教育工作者以及算力受限（使用单机多卡或单卡）开发者的最佳选择，适合验证新 Reward函数、探索新Loss、小于30B模型上快速实验。</p>
</li>
</ul>
<h2 data-id="heading-6">3 OpenRLHF</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5eb1780773d45a6903344c5db7ba701~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUlGcm9udGllcnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474243&amp;x-signature=5pvuSOm37i5XDGHksob789oWlDU%3D" alt="" loading="lazy"/></p>
<ul>
<li>gitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOpenRLHF%2FOpenRLHF" target="_blank" title="https://github.com/OpenRLHF/OpenRLHF" ref="nofollow noopener noreferrer">github.com/OpenRLHF/Op…</a> 8.8k⭐</li>
</ul>
<p>作为基于Ray与vLLM的分布式扩展架构，OpenRLHF是针对大规模生产环境设计的对齐框架，其核心设计出发点在于，RLHF的训练效率瓶颈在于生成阶段，且不同模型（Actor, Critic）对计算资源的需求截然不同。因此，OpenRLHF开启了大融合的的架构重构之路，核心为基于Ray的完全解耦。</p>
<h3 data-id="heading-7">3.1 架构革新：Ray+vLLM+DeepSpeed</h3>
<p>OpenRLHF基于Ray分布式框架，将PPO的四个模型物理拆分至不同GPU资源组，并引入专用推理引擎，核心优化体现在三方面：</p>
<ul>
<li>
<p><strong>调度</strong> <strong>解耦</strong>：支持用户灵活定义资源拓扑，可按任务将不同模型部署在独立GPU组，还能按需拆分/合并 Reward、Reference模型，彻底消除单体架构的短板效应。例如，训练一个70B模型训练时，可将Actor模型部署在8张A100上通过vLLM高速生成，Critic模型部署在另外4张A100进行价值评估，Reward和Reference模型可按需拆分或合并。</p>
</li>
<li>
<p><strong>推理加速</strong>：首个集成vLLM到RLHF训练循环的框架，借助PagedAttention和张量并行，让生成吞吐量数倍提升。同时，框架通过NCCL/CUDA IPC（进程间通信）实现Ray Actor间权重高效同步，保证训练与推理引擎参数一致；</p>
</li>
<li>
<p><strong>算法稳定性优化</strong>：集成优势归一化、梯度裁剪、分布式Adam Offload等验证有效的优化策略，解决 PPO 训练不稳定问题，保障千卡规模下的训练收敛性。</p>
</li>
</ul>
<h3 data-id="heading-8">3.2 关键特性与Agent范式</h3>
<ul>
<li><strong>Token-Level流水线：</strong> OpenRLHF采用「<strong>Token-in-Token-out</strong>」的设计范式。将单轮对话、多轮Agent交互均视为Token流处理，使其能够无缝支持复杂的Agent训练场景，确保训练时的文本分布与推理时完全一致，避免分布偏移问题。</li>
<li><strong>算法支持：</strong> 除了PPO，OpenRLHF还支持REINFORCE++、DAPO、RLOO等前沿算法，且支持条件PPO和拒绝采样，微调高推理能力模型时优势显著。</li>
</ul>
<h3 data-id="heading-9">3.3 性能优势与数据实证</h3>
<p>OpenRLHF在公开基准测试中性能优势显著，在GSM8K数据集GRPO的训练任务中，单Epoch仅需1657秒，相比于同等配置TRL的5189秒速度提升超3倍，这种效率提升源于vLLM高吞吐生成以及Ray异构模型调度的零开销切换。</p>
<p>对于70B+参数的超大模型，OpenRLHF是目前开源界少数能提供开箱即用全量微调方案的框架。</p>
<h2 data-id="heading-10">4 verl</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8020855e61a54666b4fbe8c6f4191a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUlGcm9udGllcnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474243&amp;x-signature=mSAcRS1gRoMBkd62HKX%2BwXiODLY%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>gitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvolcengine%2Fverl" target="_blank" title="https://github.com/volcengine/verl" ref="nofollow noopener noreferrer">github.com/volcengine/…</a> 18.5k⭐</p>
</li>
<li>
<p>官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fverl.readthedocs.io%2Fen%2Flatest%2F" target="_blank" title="https://verl.readthedocs.io/en/latest/" ref="nofollow noopener noreferrer">verl.readthedocs.io/en/latest/</a></p>
</li>
</ul>
<p>verl 是字节跳动（火山引擎）开源的 RLHF 框架，为 HybridFlow（<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2409.19256v2%25EF%25BC%2589%25E8%25AE%25BA%25E6%2596%2587%25E7%259A%2584%25E5%25B7%25A5%25E7%25A8%258B%25E5%25AE%259E%25E7%258E%25B0%25EF%25BC%258Cverl%25E4%25B8%25BB%25E8%25A6%2581%25E9%259D%25A2%25E5%2590%2591%25E4%25B8%2587%25E4%25BA%25BF%25E5%258F%2582%25E6%2595%25B0%25E6%25A8%25A1%25E5%259E%258B%25E4%25B8%258E%25E8%25B6%2585%25E5%25A4%25A7%25E8%25A7%2584%25E6%25A8%25A1%25E9%259B%2586%25E7%25BE%25A4%25E7%259A%2584%25E5%25B7%25A5%25E4%25B8%259A%25E7%25BA%25A7%25E9%259C%2580%25E6%25B1%2582%25E3%2580%2582" target="_blank" title="https://arxiv.org/pdf/2409.19256v2%EF%BC%89%E8%AE%BA%E6%96%87%E7%9A%84%E5%B7%A5%E7%A8%8B%E5%AE%9E%E7%8E%B0%EF%BC%8Cverl%E4%B8%BB%E8%A6%81%E9%9D%A2%E5%90%91%E4%B8%87%E4%BA%BF%E5%8F%82%E6%95%B0%E6%A8%A1%E5%9E%8B%E4%B8%8E%E8%B6%85%E5%A4%A7%E8%A7%84%E6%A8%A1%E9%9B%86%E7%BE%A4%E7%9A%84%E5%B7%A5%E4%B8%9A%E7%BA%A7%E9%9C%80%E6%B1%82%E3%80%82" ref="nofollow noopener noreferrer">arxiv.org/pdf/2409.19…</a></p>
<h3 data-id="heading-11">4.1 HybridFlow与3D-HybridEngine</h3>
<p>verl 的核心创新是编程模型与底层引擎深度协同，解决超大模型异构计算流的数据依赖问题。</p>
<ul>
<li><strong>3D-HybridEngine：</strong> 不同于OpenRLHF依赖Ray进行物理显存隔离，verl引入了3D-HybridEngine，该技术可在同组GPU上高效切换训练与生成状态，基于Megatron-LM并行切分策略实现Actor模型权重的显存原地复用或高效重分片，消除海量权重的网络传输开销、避免显存冗余占用。</li>
<li><strong>可编程数据流</strong>：verl提供了混合控制器功能，允许用户通过简单的Python代码定义复杂的RL数据流，解耦计算与数据依赖，灵活构建 PPO、GRPO/RLOO 等各类算法。</li>
</ul>
<h3 data-id="heading-12">4.2 Megatron-LM 生态与万亿模型支持</h3>
<p>verl的一个显著特征是深度支持<strong>Megatron-LM</strong>，对于100B+参数模型或MoE模型（如DeepSeek-V3 671B），单纯的DeepSpeed ZeRO策略往往由于通信瓶颈而难以扩展。verl集成了Megatron的张量并行（TP）、流水线并行（PP）和专家并行（EP），使其能够训练其它框架无法支持的超大模型。 此外，verl还具备以下特性：</p>
<ul>
<li><strong>后端多样性：</strong> 除了Megatron，verl也支持PyTorch FSDP和FSDP2，为Hugging Face模型用户提供了灵活性。</li>
<li><strong>推理集成：</strong> verl同样集成了vLLM和SGLang作为推理后端。其中，SGLang在结构化输出、长Context推理上性能优于vLLM，对推理类模型训练至关重要。</li>
</ul>
<h3 data-id="heading-13">4.3 性能优势</h3>
<p>verl兼具基础设施属性与算法创新价值，官方仓库提供 DeepSeek-R1-Zero/DeepSeek-R1 的完整复现方案，含 GRPO、GPG 算法实现。同时，开源了SOTA算法DAPO的代码，该算法在AIME 2024基准测试中表现优异。verl成为当前复现和研究推理大模型的首选框架。</p>
<h2 data-id="heading-14">5 LLaMA Factory</h2>
<ul>
<li>
<p>gitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhiyouga%2FLlamaFactory" target="_blank" title="https://github.com/hiyouga/LlamaFactory" ref="nofollow noopener noreferrer">github.com/hiyouga/Lla…</a> 66.1k⭐</p>
</li>
<li>
<p>官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.llamafactory.com.cn%2Fdocs%2Fdocuments%2Fintroduct" target="_blank" title="https://docs.llamafactory.com.cn/docs/documents/introduct" ref="nofollow noopener noreferrer">docs.llamafactory.com.cn/docs/docume…</a></p>
</li>
</ul>
<p>LLaMA-Factory Online 是一个面向科研机构、企业研发团队或个人开发者快速构建和部署AI应用的一站式大模型训练与微调平台，致力于提供简单易用、高效灵活的全流程解决方案。平台以“低门槛、高效率、强扩展”为核心，通过集成化工具链、可视化操作界面与自动化工作流，显著降低大模型定制与优化的技术成本，助力用户快速实现模型从开发调试到生产部署的全周期闭环，功能示意如下所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03e9834716e64cdaa57f6377dd28d49f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUlGcm9udGllcnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474243&amp;x-signature=q7qGReXXKI1cFgrCvVeGO6iN2iA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">5.1 统一接口与可视化训练</h3>
<p>LLaMA Factory最核心的贡献是提供了一个名为LLaMA Board的Web UI界面。用户无需编写一行代码，即可通过网页配置训练参数、选择数据集、监控训练进度并评估模型。</p>
<ul>
<li><strong>多模式支持：</strong> 框架底层封装了TRL、DeepSpeed和自定义的训练流程，用户可以通过下拉菜单在预训练（Pre-training）、指令监督微调（SFT）、DPO、PPO、KTO和ORPO之间无缝切换。</li>
<li><strong>低门槛适配：</strong> 对于不熟悉分布式系统的中小企业或个人开发者，LLaMA Factory屏蔽了accelerate config或deepspeed配置文件的复杂性，通过直观的表单驱动整个流程。</li>
</ul>
<h3 data-id="heading-16">5.2 Unsloth集成与效率优化</h3>
<p>LLaMA Factory非常敏锐地集成了社区中最高效的工具。</p>
<ul>
<li><strong>Unsloth加速：</strong> 它是首批集成<strong>Unsloth</strong>的框架之一。Unsloth通过手写Triton内核重写了Llama和Mistral模型的反向传播逻辑，使得LoRA微调速度提升了2倍，显存占用减少了50%以上。这使得在单张显卡上微调Llama3-70B成为可能。</li>
<li><strong>广泛的模型支持：</strong> 框架的维护者更新速度极快，几乎在Qwen、DeepSeek、Yi、Gemma等新模型发布的当天就能提供支持。</li>
</ul>
<h3 data-id="heading-17">5.3 局限性</h3>
<p>尽管在SFT和DPO领域表现出色，但在PPO等在线RL训练方面，LLaMA Factory的能力相对有限。它主要依赖单机多卡或简单的多机配置，缺乏OpenRLHF或verl那种复杂的Actor-Critic拆分调度能力，更适合基于LoRA的轻量级RLHF，而非从零开始训练基座模型的RL对齐。</p>
<h2 data-id="heading-18">6 垂直领域与高性能计算框架</h2>
<p>除了上述四大通用框架，还存在针对特定需求优化的LLM-RL解决方案。</p>
<h3 data-id="heading-19">6.1 RAGEN</h3>
<ul>
<li>gitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fragen-ai%2Fragen" target="_blank" title="https://github.com/ragen-ai/ragen" ref="nofollow noopener noreferrer">github.com/ragen-ai/ra…</a> 2.5k⭐</li>
<li>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fragen-doc.readthedocs.io%2Fen%2Flatest%2F" target="_blank" title="https://ragen-doc.readthedocs.io/en/latest/" ref="nofollow noopener noreferrer">ragen-doc.readthedocs.io/en/latest/</a></li>
</ul>
<p>RAGEN是基于verl构建的垂直框架，专门解决Agent在多步环境中的强化学习问题。</p>
<ul>
<li>
<p><strong>StarPO 算法：</strong> 针对多轮对话中常见的<strong>回声陷阱</strong>（即模型重复之前的错误）和梯度爆炸问题，RAGEN引入了StarPO算法，优化的是整个交互轨迹而非单个Token，使模型能够学会规划和工具使用。</p>
</li>
<li>
<p><strong>应用场景：</strong> 训练模型玩Sokoban游戏、解决复杂的逻辑谜题或执行多步API调用。</p>
</li>
</ul>
<h3 data-id="heading-20">6.2 DeepSpeed</h3>
<ul>
<li>
<p>gitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepspeedai%2FDeepSpeed" target="_blank" title="https://github.com/deepspeedai/DeepSpeed" ref="nofollow noopener noreferrer">github.com/deepspeedai…</a> 41.3k⭐</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FDeepSpeedExamples" target="_blank" title="https://github.com/microsoft/DeepSpeedExamples" ref="nofollow noopener noreferrer">github.com/microsoft/D…</a> 6.8k⭐</li>
</ul>
</li>
</ul>
<p>微软开源的LLM-RL优化框架，核心价值是「低成本高效训练/推理超大模型」，解决大模型显存不足、速度慢、成本高的核心痛点，是大模型落地主流框架。</p>
<p><strong>核心特性</strong></p>
<ul>
<li>
<p><strong>极致</strong> <strong>显存</strong> <strong>优化</strong>：以ZeRO系列优化器为核心，结合3D并行，显存占用降低5-10倍，支持千亿/万亿级参数量模型训练，推理侧ZeRO-Inference同步优化显存。</p>
</li>
<li>
<p><strong>高速高吞吐</strong>：算子级定制优化、混合精度训练、数据预处理加速，算力利用率达70%-90%，训练/推理速度远超原生PyTorch。</p>
</li>
<li>
<p><strong>全链路支持</strong>：覆盖预训练、SFT、RLHF、推理部署全流程，训练模型可直接部署，无技术断点。适配 Hugging Face Transformers、Megatron-LM 等主流生态，支持NVIDIA/AMD GPU、CPU等硬件。</p>
</li>
<li>
<p><strong>生产级特性</strong>：内置MoE模型支持、智能checkpoint管理、断点续训、量化推理等工业级功能。</p>
</li>
</ul>
<h2 data-id="heading-21">7 框架横向评测与选型指南</h2>
<p>为了帮助读者在众多框架中做出精准选择，我们将从性能、易用性和硬件需求三个维度进行横向对比。</p>
<h3 data-id="heading-22">7.1 吞吐量与性能对比</h3>
<p>根据公开的基准测试和社区反馈，各框架在吞吐量上的表现呈现明显的分层：</p>

































<table><thead><tr><th><strong>维度</strong></th><th><strong>OpenRLHF</strong></th><th><strong>verl</strong></th><th><strong>TRL</strong></th><th><strong>LLaMA Factory</strong></th></tr></thead><tbody><tr><td><strong>PPO</strong> <strong>/GRPO</strong> <strong>吞吐量</strong></td><td>极高 (vLLM加速)</td><td>极高 (vLLM/SGLang + HybridEngine)</td><td>中等 (原生Generate)</td><td>中等 (依赖后端)</td></tr><tr><td><strong>70B+模型支持</strong></td><td>原生支持 (Ray 分布式)</td><td>原生支持 (Megatron/FSDP)</td><td>困难 (需大量显存/量化)</td><td>仅限 LoRA/QLoRA</td></tr><tr><td><strong>通信开销</strong></td><td>中 (Ray跨节点通信)</td><td>低 (3D-HybridEngine原地复用)</td><td>高 (单体调度)</td><td>N/A</td></tr></tbody></table>
<ul>
<li><strong>verl vs OpenRLHF:</strong> 在使用FSDP后端时，verl与OpenRLHF性能差异不大，因为瓶颈都在vLLM推理上。但在超大规模（&gt;100B）且需要Megatron切分时，verl的架构更具优势，因为它避免了复杂的跨进程权重同步。</li>
</ul>
<h3 data-id="heading-23">7.2 选型建议</h3>
<ul>
<li>
<p><strong>算法研究员</strong>：</p>
<ul>
<li><strong>首选TRL</strong>：代码结构最清晰，文档最丰富，修改Loss函数或尝试新算法（如DPO改版）最容易。</li>
<li><strong>备选 LLaMA Factory</strong>：只是想快速验证SFT+DPO的效果，不需要写代码。</li>
</ul>
</li>
<li>
<p><strong>中小企业：</strong></p>
<ul>
<li><strong>OpenRLHF</strong>：性价比最高。能够利用Ray将散落在不同服务器上的消费级显卡（如4090）组合起来训练7B-34B模型，且性能优异。</li>
<li><strong>LLaMA Factory</strong>：如果团队缺乏深度开发能力，仅需对现有模型进行微调适配。</li>
</ul>
</li>
<li>
<p><strong>基础模型团队架构师</strong>：</p>
<ul>
<li><strong>verl</strong>：唯一能够原生支持万亿参数MoE模型全量RLHF的框架，与Megatron的结合是训练DeepSeek级别模型的必选项。</li>
</ul>
</li>
<li>
<p><strong>Agent应用开发者：</strong></p>
<ul>
<li>RAGEN或OpenRLHF： 需要对多轮对话轨迹进行整体优化，这两者提供了最好的Agent抽象。</li>
</ul>
</li>
</ul>
<p>随着RLVR的兴起，LLM-RL训练框架将不再仅仅是语言模型的优化器，演变为包含编译器、解释器和模拟器的复杂环境交互系统。框架竞争的焦点将从单纯的吞吐量转向环境交互效率、复杂推理轨迹的优化能力。对于开发者而言，掌握这些框架的原理与实践，将是应对这一AI浪潮的核心竞争力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Python 和 Jax 构建推荐系统(二) 数学考量]]></title>    <link>https://juejin.cn/post/7596943803933720616</link>    <guid>https://juejin.cn/post/7596943803933720616</guid>    <pubDate>2026-01-20T01:01:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596943803933720616" data-draft-id="7596905015367532544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Python 和 Jax 构建推荐系统(二) 数学考量"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-20T01:01:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonSkywalker"/> <meta itemprop="url" content="https://juejin.cn/user/4153307917979129"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Python 和 Jax 构建推荐系统(二) 数学考量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4153307917979129/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonSkywalker
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:01:20.000Z" title="Tue Jan 20 2026 01:01:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">数学考量</h2>
<h3 data-id="heading-1">齐夫定律与马太效应</h3>
<p>在机器学习的广泛应用中，大规模语料库中唯一项（Token）的观测分布普遍遵循<strong>齐夫定律 (Zipf’s Law)</strong>，即<strong>频率随排名的下降呈指数级衰减</strong>。在推荐系统领域，这种统计规律直接导致了<strong>马太效应 (The Matthew Effect)</strong>，即<strong>流行度偏差</strong>。</p>
<blockquote>
<p>[!NOTE]</p>
<p>标题：电影评分数量与排名的长尾图</p>
<p>这张图片展示了一个经典的<strong>长尾分布（Long-tail Distribution）</strong>。</p>
<p><strong>Y轴 ：</strong> 代表被评分的次数（即流行度或热度）。</p>
<p><strong>X轴：</strong> 代表电影的排名。电影按照评分数量从高到低排序。</p>
<p>在这张电影评分图中，如果把“单词频率”换成“电影被评分的次数”，把“单词排名”换成“电影排名”，图形就完全符合幂律分布的特征。<strong>极少数</strong>的电影（头部）占据了<strong>极大部分</strong>的用户注意力（评分）。排名靠后的电影，其受关注度呈指数级下降，这符合<strong>齐夫定律</strong>。由<strong>马太效应</strong>可知，排名靠前的电影（头部）因为本身知名度高，会被推荐系统放在显眼位置，或者被更多人谈论。这导致更多人去观看并打分，从而进一步巩固了它们的高排名。 用户的注意力和时间是有限的。头部电影吸走了绝大部分流量，导致尾部电影（那些位于X轴右侧的数万部电影）很难被发现，长期处于“无人问津”的状态。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69c69bc1ee464eb39a6f5722bdb5bb18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25Ta3l3YWxrZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769475680&amp;x-signature=sTw4EqunucD%2Fo22CO7ri4XjIe2s%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>**马太效应 **</p>
<p>马太效应或称<strong>流行度偏差</strong> (popularity bias)指出，**最受欢迎的商品将继续吸引最多的注意力，并拉大与其他商品的差距。即“强者愈强”。**表现为热门商品的点击量远超平均水平，活跃用户贡献的评分数量远超平均水平。</p>
</blockquote>
<p>假设**概率质量函数(离散型随机变量概率分布)**由齐夫定律描述，其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 为物品总数，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 为排名：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mi>k</mi></mrow><mrow><munderover><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mn>1</mn><mi mathvariant="normal">/</mi><mi>n</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">f(k,M) = \frac{1/k}{\sum_{n=1}^{M} 1/n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.5979em;vertical-align:-1.1709em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1709em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>分母是调和级数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>M</mi></msub><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></msubsup><mn>1</mn><mi mathvariant="normal">/</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">H_M = \sum_{n=1}^{M} 1/n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal">n</span></span></span></span></span>，作为归一化因子，确保所有概率之和为 1。</p>
<p>对于用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>，第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个最热门物品出现在其评分集中的概率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo></mrow><mn>1</mn></mfrac><mo>=</mo><mfrac><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mi>i</mi></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mn>1</mn><mi mathvariant="normal">/</mi><mi>j</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">P(i) = \frac{f(i, M)}{\sum_{j=1}^{M} f(j, M)} = \frac{f(i,M)}{1} = \frac{1/i}{\sum_{j=1}^{M} 1/j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.734em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.734em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1/</span><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>排名为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的同一个物品同时出现在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 的集中的概率（联合概率）是各自概率的乘积：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>P</mi><mi>i</mi><mn>2</mn></msubsup><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><msup><mrow><mo fence="true">(</mo><mfrac><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mi>i</mi></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mn>1</mn><mi mathvariant="normal">/</mi><mi>j</mi></mrow></mfrac><mo fence="true">)</mo></mrow><mn>2</mn></msup><mo>=</mo><mfrac><mrow><mn>1</mn><mi mathvariant="normal">/</mi><msup><mi>i</mi><mn>2</mn></msup></mrow><mrow><mo stretchy="false">(</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mn>1</mn><mi mathvariant="normal">/</mi><mi>j</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">P_{i}^2 = P_i \cdot P_i = \left( \frac{1/i}{\sum_{j=1}^{M} 1/j} \right)^2 = \frac{1/i^2}{(\sum_{j=1}^{M} 1/j)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1111em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.2611em;vertical-align:-1.307em;"/><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1/</span><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.954em;"><span style="top:-4.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.7982em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1/</span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p><strong>可知两个用户在其评分集中共享一个物品的概率随着其流行度排名的平方而下降。(分母 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow><mo fence="true">(</mo><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></msubsup><mfrac><mn>1</mn><mi>j</mi></mfrac><mo fence="true">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\left(\sum_{j=1}^{M} \frac{1}{j}\right)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.004em;vertical-align:-0.65em;"/><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4811em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.354em;"><span style="top:-3.6029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> 是一个固定的数值</strong>。这表明，<strong>用户相似度分数的计算在数学上极度依赖于少数头部热门物品，而非长尾物品</strong>。</p>
<h4 data-id="heading-2">基于集合相似度的计算</h4>
<p>在推荐系统中，衡量用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 相似度最直观的方法是看他们的<strong>重合</strong>度，相似度通常定义为<strong>交集大小与并集大小的比值</strong>。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mi>i</mi><mi>m</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∩</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi></mrow><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∪</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">Sim(A, B) = \frac{|\mathcal{I}_A \cap \mathcal{I}_B|}{|\mathcal{I}_A \cup \mathcal{I}_B|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">im</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>假设用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>，分别拥有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>A</mi></msub><mo>=</mo><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">N_A = |\mathcal{I}_A|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>B</mi></msub><mo>=</mo><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">N_B = |\mathcal{I}_B|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span></span> 个评分。假设语料库中有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 个物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>V</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>V</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>V</mi><mi>M</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{V_1, V_2, \dots, V_M\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">}</span></span></span></span></span>。分子部分 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∩</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">|\mathcal{I}_A \cap \mathcal{I}_B|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span></span> 代表<strong>两人共同拥有的物品数</strong>。对于每一个物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，我们定义一个指示变量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">X_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：</p>
<ul>
<li>如果物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 同时出现在用户 A 和用户 B 的评分集中，则 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">X_i = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>。</li>
<li>否则，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">X_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>。</li>
</ul>
<p>那么，两个用户共同评分的物品总数（即交集的大小）可以表示为所有指示变量的和：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∩</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">|\mathcal{I}_A \cap \mathcal{I}_B| = \sum_{i=1}^{M} X_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>对于第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个物品，用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 选中的概率是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 选中的概率也是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。假设两人选电影是<strong>独立行为</strong>，那么<strong>两人同时选中第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个物品</strong>的联合概率就是：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>A</mi><mtext> and </mtext><mi>B</mi><mtext> chose </mtext><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>×</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><msubsup><mi>P</mi><mi>i</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">P(A \text{ and } B \text{ chose } i) = P_i \times P_i = P_i^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mord text"><span class="mord"> and </span></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord text"><span class="mord"> chose </span></span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1111em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>根据期望的线性性质，总和的期望等于期望的总和：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∩</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi><mo stretchy="false">]</mo><mo>=</mo><mi>E</mi><mrow><mo fence="true">[</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mi>X</mi><mi>i</mi></msub><mo fence="true">]</mo></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mi>E</mi><mo stretchy="false">[</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">E[|\mathcal{I}_A \cap \mathcal{I}_B|] = E\left[ \sum_{i=1}^{M} X_i \right] = \sum_{i=1}^{M} E[X_i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></div>
<p>对于离散的指示变量，其期望值等于它取 1 时的概率：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo>=</mo><mn>1</mn><mo>⋅</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mn>0</mn><mo>⋅</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">E[X_i] = 1 \cdot P(X_i = 1) + 0 \cdot P(X_i = 0) = P(X_i = 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></div>
<p>由于总共有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 个物品，将所有物品“被共同选中”的概率累加起来，就得到了<strong>期望的交集大小</strong>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∩</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi><mo stretchy="false">]</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msubsup><mi>P</mi><mi>i</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">E[|\mathcal{I}_A \cap \mathcal{I}_B|] = \sum_{i=1}^{M} P_i^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>分母 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∪</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\| \mathcal{I}_A \cup \mathcal{I}_B \|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∥</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∥</span></span></span></span></span> 是两人评分集合的并集大小，起到<strong>缩放</strong>的作用，将结果约束在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> 之间。</p>
<p>因此，由于单个物品共享带来的相似度期望分数为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>S</mi><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>l</mi><mi>e</mi></mrow></msub><mo>=</mo><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msubsup><mi>P</mi><mi>i</mi><mn>2</mn></msubsup></mrow><mrow><mi mathvariant="normal">∥</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∪</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∥</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">S_{single} = \frac{\sum_{i=1}^{M} P_{i}^2}{\| \mathcal{I}_A \cup \mathcal{I}_B \|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.6069em;vertical-align:-0.936em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6709em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">∥</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∥</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.6897em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>为了计算<strong>总的平均相似度</strong>，需要把“共享 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span> 个物品”的所有可能性累加起来。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>S</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>N</mi><mi>A</mi></msub><mo separator="true">,</mo><msub><mi>N</mi><mi>B</mi></msub><mo stretchy="false">)</mo></mrow></munderover><mfrac><mrow><munderover><mo>∑</mo><mrow><msub><mi>i</mi><mn>1</mn></msub><mo>=</mo><mn>1</mn></mrow><mrow><mi>M</mi><mo>−</mo><mi>t</mi><mo>+</mo><mn>1</mn></mrow></munderover><munderover><mo>∑</mo><mrow><msub><mi>i</mi><mn>2</mn></msub><mo>=</mo><msub><mi>i</mi><mn>1</mn></msub><mo>+</mo><mn>1</mn></mrow><mrow><mi>M</mi><mo>−</mo><mi>t</mi><mo>+</mo><mn>2</mn></mrow></munderover><mo>⋯</mo><munderover><mo>∑</mo><mrow><msub><mi>i</mi><mi>t</mi></msub><mo>=</mo><msub><mi>i</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><mn>1</mn></mrow><mi>M</mi></munderover><mrow><mo fence="true">(</mo><munderover><mo>∏</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msubsup><mi>P</mi><msub><mi>i</mi><mi>k</mi></msub><mn>2</mn></msubsup><mo fence="true">)</mo></mrow></mrow><mrow><mi mathvariant="normal">∥</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∪</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><msup><mi mathvariant="normal">∥</mi><mi>t</mi></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">S_{total} = \sum_{t=1}^{\min(N_A, N_B)} \frac{\sum_{i_1=1}^{M-t+1} \sum_{i_2=i_1+1}^{M-t+2} \dots \sum_{i_t=i_{t-1}+1}^{M} \left( \prod_{k=1}^{t} P_{i_k}^2 \right)}{\| \mathcal{I}_A \cup \mathcal{I}_B \|^t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.4571em;vertical-align:-1.2671em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.961em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.386em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">i</span><span class="mtight">n</span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.19em;"><span style="top:-2.464em;"><span class="pstrut" style="height:3.15em;"/><span class="mord"><span class="mord">∥</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7196em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span></span><span style="top:-3.38em;"><span class="pstrut" style="height:3.15em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-4.19em;"><span class="pstrut" style="height:3.15em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3998em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3998em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2025em;"><span/></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4415em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∏</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9335em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3645em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<h3 data-id="heading-3">稀疏性</h3>
<p>稀疏性是齐夫分布在推荐系统矩阵表示中的直接后果。随着马太效应将大部分评分推向少数热门列，用户-物品矩阵在传统线性代数意义上变得<strong>高度稀疏</strong>。</p>
<p>于任意用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>，选中排名为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的概率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 依然由齐夫定律定义：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mi>i</mi></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mn>1</mn><mi mathvariant="normal">/</mi><mi>j</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">P_i = \frac{1/i}{\sum_{j=1}^{M} 1/j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.734em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1/</span><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>为了衡量稀疏性对协作的影响，需要计算：对于一个用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>，有多少<strong>其他用户</strong>会和他因为同一个物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 产生关联？</p>
<p>（<strong>单个物品的碰撞期望计算</strong>）假设系统中共有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 个用户。对于排名第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的物品，其他任一用户选中它的概率也是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。因此，在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">M-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 个其他用户中，选中该物品的期望人数为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>E</mi><mi>i</mi></msub><mo>=</mo><mo stretchy="false">(</mo><mi>M</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">E_i = (M - 1) \cdot P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>将所有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 个物品能带来的“共享机会”累加，得到与用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> <strong>至少共享一个评分的其他用户总数</strong>的理论期望值：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Total Shared Users</mtext><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mo stretchy="false">(</mo><mi>M</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{Total Shared Users} = \sum_{i=1}^{M} (M - 1) \cdot P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord text"><span class="mord">Total Shared Users</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>这组公式揭示了<strong>稀疏性将重点推向最受欢迎的用户，并有使推荐器变得短视 (myopic) 的风险。</strong></p>
<blockquote>
<p>[!NOTE]</p>
<p>X轴：用户的排名</p>
<p>Y轴：相似度计数</p>
<ul>
<li>这代表了系统在该排名区间内发现的“相似用户对”的数量。</li>
<li>数值越高，说明算法在该排名附近越容易找到协作邻居。</li>
</ul>
<p>从散点分布的总趋势可以看出，<strong>随着用户排名的增加，相似度计数呈现明显的下降趋势。</strong></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015f0c7f943c45bd8f3b79ddc14bfdf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25Ta3l3YWxrZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769475680&amp;x-signature=H4ihxTN3qtgwrcJBSpBks%2BC5yf8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">协同过滤的用户相似度</h3>
<p>在协同过滤算法体系中，衡量用户之间的相似程度是构建推荐系统的逻辑起点。通过将用户<strong>映射到多维特征空间</strong>，可以将抽象的兴趣转化为可计算的几何距离或统计相关性，从而实现基于邻域的预测。</p>
<p>在经典几何学中，点与点之间的关系通常由**度量（Metric）**定义。一个标准的度量空间需要满足包括三角不等式在内的严格数学性质：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>c</mi><mo stretchy="false">)</mo><mo>≤</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>+</mo><mi>d</mi><mo stretchy="false">(</mo><mi>b</mi><mo separator="true">,</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, c) \leq d(a, b) + d(b, c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span></span></div>
<p>在机器学习任务中，研究者更倾向于使用**相似度（Similarity）**函数。当不相似度函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span> 的取值范围在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> 时，相似度定义为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Sim</mtext><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>:</mo><mo>=</mo><mn>1</mn><mo>−</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Sim}(a, b) := 1 - d(a, b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Sim</span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></div>
<blockquote>
<p>在实际工程中，许多有效的相似性度量并不完全满足度量空间的公理（如三角不等式），这些空间被称为<strong>伪空间（Pseudo-spaces）</strong>。尽管在数学严谨性上有所欠缺，但它们在捕捉高维数据的关联特征方面具有极高的实用价值。</p>
</blockquote>
<h4 data-id="heading-5">最近邻理论</h4>
<p>最近邻（Nearest Neighbors）算法是一种基于几何思想的非参数化方法，广泛应用于分类、排名和聚类任务。给定特征向量定义的空间及空间内的一点，通过计算距离找到与其地理位置最接近的其他点。CF 将用户映射到由物品评分定义的特征空间中。通过寻找目标用户的最近邻，可以将已有数据中的用户偏好迁移至新用户，从而实现预测推理。</p>
<h4 data-id="heading-6">皮尔逊相关系数</h4>
<p>在协同过滤场景下，<strong>用户通常不在同一个特征空间内</strong>（每个人评分的物品集合不同）。皮尔逊相关系数通过<strong>提取两个用户共同评分的物品子集，计算其评分分布的相关性</strong>。该方法相比欧几里得距离的优势在于，通过减去均值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover></mrow><annotation encoding="application/x-tex">\bar{r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5678em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span></span></span></span></span>，它能够自动<strong>抵消用户评分尺度不一</strong>（如某些用户习惯性给高分，某些则偏严苛）带来的偏差。</p>
<p>设 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 为两个用户，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">R</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathcal{R}_{A,B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 为他们共同评分过的物品集合。用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 对物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 的评分为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">r_{A,x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。用户相似度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{USim}(A,B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span></span> 的计算公式如下：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow></munder><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>A</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>B</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>B</mi></msub><mo stretchy="false">)</mo></mrow><mrow><msqrt><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow></munder><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>A</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt><msqrt><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow></munder><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>B</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>B</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{USim}(A, B) = \frac{\sum_{x \in \mathcal{R}_{A,B}} (r_{A,x} - \bar{r}_A)(r_{B,x} - \bar{r}_B)}{\sqrt{\sum_{x \in \mathcal{R}_{A,B}} (r_{A,x} - \bar{r}_A)^2} \sqrt{\sum_{x \in \mathcal{R}_{A,B}} (r_{B,x} - \bar{r}_B)^2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.3672em;vertical-align:-1.73em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6372em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.1114em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1114em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"/><span class="mord" style="padding-left:1em;"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2822em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4972em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.0714em;"><span class="pstrut" style="height:3.8em;"/><span class="hide-tail" style="min-width:1.02em;height:1.88em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.88em" viewbox="0 0 400000 1944" preserveaspectratio="xMinYMin slice"><path d="M983 90&#10;l0 -0&#10;c4,-6.7,10,-10,18,-10 H400000v40&#10;H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7&#10;s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744&#10;c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30&#10;c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722&#10;c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5&#10;c53.7,-170.3,84.5,-266.8,92.5,-289.5z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7286em;"><span/></span></span></span></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1114em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"/><span class="mord" style="padding-left:1em;"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2822em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4972em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.0714em;"><span class="pstrut" style="height:3.8em;"/><span class="hide-tail" style="min-width:1.02em;height:1.88em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.88em" viewbox="0 0 400000 1944" preserveaspectratio="xMinYMin slice"><path d="M983 90&#10;l0 -0&#10;c4,-6.7,10,-10,18,-10 H400000v40&#10;H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7&#10;s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744&#10;c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30&#10;c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722&#10;c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5&#10;c53.7,-170.3,84.5,-266.8,92.5,-289.5z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7286em;"><span/></span></span></span></span></span></span><span style="top:-3.3414em;"><span class="pstrut" style="height:3.1114em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.9986em;"><span class="pstrut" style="height:3.1114em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2822em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4972em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.73em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p><strong>符号定义：</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">R</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathcal{R}_{A,B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 共同评价过的物品交集。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">r_{A,x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 对物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 的原始评分。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\bar{r}_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 在共同评分集合中的平均评分。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{USim}(A, B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span></span>：取值范围为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-1, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>，其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 表示完全正相关，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">1</span></span></span></span></span> 表示完全负相关。</li>
</ul>
<p>注意这是描述用户评分的联合分布变量的<strong>相似性</strong>。</p>
<h4 data-id="heading-7">通过相似性进行评分</h4>
<p>引入用户相似度后，可以通过加权聚合邻居的<strong>评价来估计目标用户对未见物品的兴趣</strong>。</p>
<p>对于用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span>，其亲和力分数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Aff</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Aff}(A, i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Aff</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span></span> 的计算公式如下：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Aff</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>A</mi></msub><mo>+</mo><mfrac><mrow><munder><mo>∑</mo><mrow><mi>U</mi><mo>∈</mo><msub><mi>N</mi><mi>A</mi></msub></mrow></munder><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>U</mi><mo stretchy="false">)</mo><mo>⋅</mo><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>U</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>U</mi></msub><mo stretchy="false">)</mo></mrow><mrow><munder><mo>∑</mo><mrow><mi>U</mi><mo>∈</mo><msub><mi>N</mi><mi>A</mi></msub></mrow></munder><mi mathvariant="normal">∣</mi><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>U</mi><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{Aff}(A,i) = \bar{r}_A + \frac{\sum_{U \in N_A} \text{USim}(A,U) \cdot (r_{U,i} - \bar{r}_U)}{\sum_{U \in N_A} |\text{USim}(A,U)|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Aff</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.626em;vertical-align:-1.086em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.54em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">∣</span><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">)</span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.79em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.086em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p><strong>符号定义：</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Aff</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Aff}(A,i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Aff</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span></span>：预测用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 对物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的评分。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\bar{r}_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 在其历史评分记录中的平均分，代表其基础“慷慨程度”。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">N_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 的<strong>邻域（Neighborhood）</strong>，即与其最相似的一组用户。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>U</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{USim}(A,U)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">)</span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 与邻居 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span></span> 之间的相似度权重（通常由皮尔逊相关系数得出）。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mrow><mi>U</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>U</mi></msub></mrow><annotation encoding="application/x-tex">r_{U,i} - \bar{r}_U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：邻居 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span></span> 对物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的评分与其自身平均分的差值。</li>
</ul>
<p>该模型基于以下假设：<strong>用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 的评分行为等于其自身的平均评分偏好，加上邻居偏离其自身均值的加权修正。</strong> 这种方法不仅参考了相似用户的观点，还修正了不同用户之间“评分慷慨程度”的差异。</p>
<h4 data-id="heading-8">相似度向度量空间的转换</h4>
<p>虽然皮尔逊相关系数（Pearson Correlation, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{A,B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>）在衡量相关性方面表现出色，但它直接定义的距离 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>1</mn><mo>−</mo><msub><mi>P</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d = 1 - P_{A,B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 在数学上并不构成严格的<strong>度量空间（Metric Space）</strong>。其主要缺陷在于不满足<strong>三角不等式</strong>。为了在需要严格度量性质的算法（如某些高维空间索引或聚类算法）中使用相关系数，需要进行数学变换。</p>

























<table><thead><tr><th><strong>转换方法</strong></th><th><strong>公式</strong></th><th><strong>特性</strong></th></tr></thead><tbody><tr><td><strong>直接补数</strong></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><msub><mi>P</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow><annotation encoding="application/x-tex">1 - P_{A,B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></td><td>满足非负性、自反性、对称性，但不满足三角不等式。</td></tr><tr><td><strong>平方根变换</strong></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mrow><mn>1</mn><mo>−</mo><msub><mi>P</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{1 - P_{A,B}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.3564em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8836em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8436em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3564em;"><span/></span></span></span></span></span></span></span></span></td><td><strong>最常用方法</strong>。能够将其转化为符合三角不等式的欧几里得度量。</td></tr><tr><td><strong>角度转换</strong></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>arccos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>P</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\arccos(P_{A,B})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mop">arccos</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></td><td>将相关性视为向量间的夹角，在余弦相似度场景中尤为常见。</td></tr></tbody></table>
<h3 data-id="heading-9">推荐系统中的探索与利用</h3>
<p>在构建推荐系统时，开发者往往面临着<strong>维持当前最优性能与探索未知潜力的平衡问题</strong>。单纯依赖历史数据最大化短期收益（如 MPIR 算法），往往会导致系统陷入局部最优，并引发长期的负面效应。</p>
<p><strong>最热门商品推荐器 (MPIR)</strong>：虽然易于实现且逻辑清晰，但其本质是放大马太效应。<strong>随着时间，循环反馈会失效</strong>。MPIR 会持续向用户展示已知的热门物品，这导致这些物品的流行度进一步上升。在极限情况下，推荐系统将退化为<strong>平凡推荐器</strong>，即失去个性化能力，仅能反馈大盘趋势。</p>
<h4 data-id="heading-10">模态状态风险</h4>
<p>在缺乏随机化机制的情况下，单纯最大化损失函数（或奖励函数）会导致算法迅速陷入<strong>模态状态 (Modal State) <strong>。这意味着算法无法再学习到关于</strong>长尾物品</strong>或潜在兴趣的任何新信息，从而使系统的整体探索能力陷入停滞。</p>
<h4 data-id="heading-11">探索与利用框架</h4>
<p>为了克服上述故障模式，推荐系统引入了源自<strong>多臂老虎机 (Multi-armed Bandits, MAB)</strong> 的策略。</p>
<p><strong>利用 (Exploit)</strong>：基于当前已知的最优先验估计，选择预期奖励最高的推荐方案（“臂”），以最大化即时收益。</p>
<p><strong>探索 (Explore)</strong>：以一定的概率尝试非最优或未知的替代方案，目的是收集更多数据，更新对物品分布的估计。</p>
<p>给定一组候选推荐方案（臂） <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span>，智能体（Agent）的目标是最大化奖励函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(y_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。由于智能体初始并不知道结果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>a</mi><mo>∈</mo><mi>A</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{a \in A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8607em;vertical-align:-0.1774em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight">A</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span/></span></span></span></span></span></span></span></span></span> 的真实分布，其执行逻辑如下：</p>
<ol>
<li><strong>假设先验分布</strong>：假设 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>a</mi><mo>∈</mo><mi>A</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{a \in A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8607em;vertical-align:-0.1774em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight">A</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span/></span></span></span></span></span></span></span></span></span> 遵循某种分布。</li>
<li><strong>数据更新</strong>：通过观察推荐结果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">y_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，更新分布参数。</li>
<li><strong>期望估计</strong>：在足够观察后，估计各方案的期望奖励 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mrow><mi>a</mi><mo>∈</mo><mi>A</mi></mrow></msub><mo>=</mo><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><mi mathvariant="script">R</mi><mo stretchy="false">(</mo><msub><mi>Y</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mu_{a \in A} = \mathbb{E}[\mathcal{R}(Y_a)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight">A</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathbb">E</span><span class="mopen">[</span><span class="mord mathcal">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)]</span></span></span></span></span>。</li>
</ol>
<h4 data-id="heading-12"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span>-贪婪算法</h4>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span>-贪婪(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span>-greedy)是处理探索-利用权衡最直观且高效的算法。</p>
<p>对于参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\epsilon \in [0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">ϵ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>：</p>
<ul>
<li><strong>以概率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">1 - \epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 执行“利用”</strong>：选择当前估计奖励最高的物品。</li>
<li><strong>以概率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 执行“探索”</strong>：从候选池中随机选择一个物品。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> jax <span class="hljs-keyword">import</span> random
key = random.PRNGKey(<span class="hljs-number">0</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_most_popular_recs_ep_greedy</span>(<span class="hljs-params">
    max_num_recs: <span class="hljs-built_in">int</span>,
    epsilon: <span class="hljs-built_in">float</span>
</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:
    <span class="hljs-comment"># 验证超参数范围</span>
    <span class="hljs-keyword">assert</span> <span class="hljs-number">0</span> &lt; epsilon &lt; <span class="hljs-number">1.0</span>
    
    items_popularity_dict = get_item_popularities()
    
    <span class="hljs-keyword">if</span> items_popularity_dict:
        <span class="hljs-comment"># 1. 排序器逻辑：按流行度降序排列</span>
        sorted_items = <span class="hljs-built_in">sorted</span>(
            items_popularity_dict.items(),
            key=<span class="hljs-keyword">lambda</span> item: item[<span class="hljs-number">1</span>],
            reverse=<span class="hljs-literal">True</span>,
        )
        top_items = [i[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sorted_items]
        recommendations = []
        
        <span class="hljs-comment"># 2. 填充推荐列表</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_num_recs):
            <span class="hljs-comment"># 确定当前步骤是利用还是探索</span>
            <span class="hljs-keyword">if</span> random.uniform(key) &gt; epsilon: 
                <span class="hljs-comment"># 利用：弹出当前最热门的物品</span>
                recommendations.append(top_items.pop(<span class="hljs-number">0</span>))
            <span class="hljs-keyword">else</span>: 
                <span class="hljs-comment"># 探索：从剩余物品池中随机抽取</span>
                explore_choice = random.randint(<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(top_items))
                recommendations.append(top_items.pop(explore_choice))
                
        <span class="hljs-keyword">return</span> recommendations
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<p>引入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span>-贪婪策略后，推荐系统的三层架构需进行相应的职责调整：</p>

























<table><thead><tr><th><strong>组件</strong></th><th><strong>状态</strong></th><th><strong>变更说明</strong></th></tr></thead><tbody><tr><td><strong>收集器 (Collector)</strong></td><td>无需变更</td><td>依然负责获取物品的原始流行度计数。</td></tr><tr><td><strong>排序器 (Ranker)</strong></td><td>无需变更</td><td>依然按流行度对候选物品进行全序排列。</td></tr><tr><td><strong>服务端 (Server)</strong></td><td><strong>核心变更</strong></td><td>不再直接截取 Top-K，而是集成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 逻辑，逐个确定推荐位是填充排名靠前的物品还是随机物品。</td></tr></tbody></table>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 的取值直接决定了系统的“好奇心”程度。</p>
<p><strong>动态衰减策略</strong>：通用的最佳实践是在系统运行初期设置较大的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span>（高强度探索），随着收集的数据增多，逐步减小 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 的值，直至收敛到一个较小的稳定值。</p>
<h3 data-id="heading-13">自然语言处理与推荐系统的几何关联</h3>
<p>在工业级推荐系统的演进过程中，借用自然语言处理（NLP）领域的序列建模直觉已成为一种标准范式。<strong>Word2Vec</strong> 模型通过<strong>词语在句子中的共现关系</strong>来学习词的语义表示。将其逻辑迁移至推荐系统，便催生了<strong>将用户行为序列视作句子，将交互物品视作单词的建模策略</strong>。</p>
<p>Skip-gram 结构的 Word2Vec 通过预测上下文单词来学习目标单词的隐含意义。其核心逻辑如下：</p>
<ul>
<li><strong>输入与输出</strong>：输入为经过独热编码（One-hot Encoding）的单词，输出层维度等于词汇表大小，用于预测共现概率。</li>
<li><strong>瓶颈层（Bottleneck Layer）</strong>：网络中间存在一个维度远小于词汇表大小的隐藏层。</li>
<li><strong>表征压缩</strong>：通过训练，高维稀疏的独热向量被映射到低维稠密的潜在空间（Latent Space）。在这个空间中，向量间的几何相似性直接对应了语义的相似性。</li>
</ul>
<p>推荐系统利用上述思想实现从协同过滤（CF）向序列化建模的跨越：</p>
<ul>
<li><strong>句子与序列</strong>：将用户在特定时间内的有序互动记录（如电影评分序列、商品点击序列）视为 NLP 中的句子。</li>
<li><strong>单词与物品</strong>：序列中的每一个互动项被视为单词。</li>
<li><strong>相似性假设</strong>：模型通过物品在大量用户历史中的共现关系学习其向量表示。基于此，推荐系统可以从“寻找相似用户”转向“寻找相似物品”，即假设用户未来会喜欢与其历史行为空间距离接近的物品。</li>
</ul>
<h4 data-id="heading-14">潜在空间与向量搜索</h4>
<p>通过模型学习，物品被嵌入到一个高维的<strong>潜在空间（或称表示空间、环境空间）</strong>。推荐系统的本质任务转变为在该空间内进行高效的几何搜索。</p>
<p>在高维潜在空间中，距离度量面临维度诅咒：</p>
<ul>
<li><strong>欧几里得距离失效</strong>：随着维度增加，空间趋于稀疏，欧几里得距离的性能显著下降。局部距离虽有参考价值，但全局距离的可靠性较低。</li>
<li><strong>余弦相似度（Cosine Similarity）</strong>：在实践中，余弦距离通常比欧几里得距离表现更好，因为它关注的是向量的方向而非绝对长度。</li>
<li><strong>相似度最大化</strong>：工程实现上，最大化向量点积或余弦相似度通常比最小化距离函数更具鲁棒性。</li>
</ul>
<blockquote>
<p>[!NOTE]</p>
<p>在数学中，欧几里得距离被定义为连接两点之间的<strong>线段长度</strong>。</p>
<p>二维空间 (2D)</p>
<p>对于平面上的两个点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_1, y_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(x_2, y_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，距离 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span> 为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo>−</mo><msub><mi>x</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>−</mo><msub><mi>y</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">d(P, Q) = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.2561em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9839em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.9439em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2561em;"><span/></span></span></span></span></span></span></span></span></div>
<p>三维空间 (3D)</p>
<p>对于空间中的点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_1, y_1, z_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(x_2, y_2, z_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo>−</mo><msub><mi>x</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>−</mo><msub><mi>y</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>z</mi><mn>2</mn></msub><mo>−</mo><msub><mi>z</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">d(P, Q) = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2 + (z_2 - z_1)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.2561em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9839em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.9439em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2561em;"><span/></span></span></span></span></span></span></span></span></div>
<p>n 维空间 (n-D)</p>
<p>在机器学习等高维场景中，设两点为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_1, x_2, \dots, x_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(y_1, y_2, \dots, y_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">d(P, Q) = \sqrt{\sum_{i=1}^n (x_i - y_i)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.1568em;vertical-align:-1.2777em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8791em;"><span class="svg-align" style="top:-5.1168em;"><span class="pstrut" style="height:5.1168em;"/><span class="mord" style="padding-left:1.056em;"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.8391em;"><span class="pstrut" style="height:5.1168em;"/><span class="hide-tail" style="min-width:0.742em;height:3.1968em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.1968em" viewbox="0 0 400000 3196" preserveaspectratio="xMinYMin slice"><path d="M702 80H40000040&#10;H742v3062l-4 4-4 4c-.667.7 -2 1.5-4 2.5s-4.167 1.833-6.5 2.5-5.5 1-9.5 1&#10;h-12l-28-84c-16.667-52-96.667 -294.333-240-727l-212 -643 -85 170&#10;c-4-3.333-8.333-7.667-13 -13l-13-13l77-155 77-156c66 199.333 139 419.667&#10;219 661 l218 661zM702 80H400000v40H742z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span></span></span></span></span></div>
</blockquote>
<blockquote>
<p>[!NOTE]</p>
<p><strong>余弦相似度</strong></p>
<p>对于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 维向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>，其余弦相似度定义为两向量的点积除以它们模长的乘积：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>similarity</mtext><mo>=</mo><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>A</mi><mo>⋅</mo><mi>B</mi></mrow><mrow><mi mathvariant="normal">∥</mi><mi>A</mi><mi mathvariant="normal">∥</mi><mi mathvariant="normal">∥</mi><mi>B</mi><mi mathvariant="normal">∥</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>A</mi><mi>i</mi></msub><msub><mi>B</mi><mi>i</mi></msub></mrow><mrow><msqrt><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msubsup><mi>A</mi><mi>i</mi><mn>2</mn></msubsup></mrow></msqrt><msqrt><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msubsup><mi>B</mi><mi>i</mi><mn>2</mn></msubsup></mrow></msqrt></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{similarity} = \cos(\theta) = \frac{A \cdot B}{\|A\| \|B\|} = \frac{\sum_{i=1}^{n} A_i B_i}{\sqrt{\sum_{i=1}^{n} A_i^2} \sqrt{\sum_{i=1}^{n} B_i^2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">similarity</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.2963em;vertical-align:-0.936em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">∥</span><span class="mord mathnormal">A</span><span class="mord">∥∥</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">∥</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.624em;vertical-align:-1.13em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.494em;"><span style="top:-2.1727em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9373em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8973em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3027em;"><span/></span></span></span></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9373em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.4231em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8973em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3027em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.6897em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.13em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p><strong>符号定义：</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⋅</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A \cdot B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>：向量的点积。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><mi>A</mi><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\|A\|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∥</span><span class="mord mathnormal">A</span><span class="mord">∥</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><mi>B</mi><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\|B\|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∥</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">∥</span></span></span></span></span>：向量的模长（即 L2 范数）。</li>
</ul>
</blockquote>
<h4 data-id="heading-15">使用相似性产生推荐</h4>
<p>给定用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 及其喜欢的物品集合，通过潜在空间中的向量运算可以推导出推荐结果。</p>
<p><strong>符号定义：</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">R</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{R}_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 已评分或交互过的物品集合。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">v_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 在潜在空间中的特征向量，其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">x \in \mathcal{R}_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 的关联向量集 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>v</mi><mi>x</mi></msub><mo>∣</mo><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mi>A</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{v_x \mid x \in \mathcal{R}_A\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">}</span></span></span></span></span>。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">v_y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>：待预测物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span> 的特征向量。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">r_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：用户对物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 的评分或反馈权重。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>USim</mtext><mo stretchy="false">(</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{USim}(\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord">⋅</span><span class="mclose">)</span></span></span></span></span>：潜在空间中的相似度函数（如余弦相似度）。</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>avg</mtext><mo stretchy="false">(</mo><mi>A</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{avg}(A)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">avg</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mclose">)</span></span></span></span></span></strong>：用户兴趣的中心向量，定义为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mi>n</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\frac{1}{n} \sum_{i=1}^{n} v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">R</mi><mi>A</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">n = |\mathcal{R}_A|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span></span>）。</li>
</ul>
<p><strong>推荐生成策略：</strong></p>
<h5 data-id="heading-16">均值重心法</h5>
<p>假设用户喜欢的物品在潜在空间中具有聚类特性。通过取平均值，模型试图捕捉用户兴趣的最大公约数。寻找与用户交互历史平均位置最接近的物品。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><munder><mrow><mi mathvariant="normal">argmax</mi><mo>⁡</mo></mrow><mrow><mi>y</mi><mo>∈</mo><mtext>Items</mtext></mrow></munder><mrow><mo fence="true">(</mo><mtext>USim</mtext><mo stretchy="false">(</mo><msub><mi>v</mi><mi>y</mi></msub><mo separator="true">,</mo><mtext>avg</mtext><mo stretchy="false">(</mo><mi>A</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">y^* = \operatorname*{argmax}_{y \in \text{Items}} \left( \text{USim}(v_y, \text{avg}(A)) \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8249em;vertical-align:-1.0749em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.1612em;margin-left:0em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mrel mtight">∈</span><span class="mord text mtight"><span class="mord mtight">Items</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span><span class="mop"><span class="mord mathrm">argmax</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0749em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord text"><span class="mord">avg</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mclose">))</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></div>
<p>均值重心法的优点在于计算极其简单，在线预测时只需一次向量搜索。但也容易受到“长尾”行为的影响。如果用户同时喜欢两种完全不同的东西（如：硬核科幻与浪漫喜剧），其重心可能落在空间中一个荒芜的中间区域，导致推荐出“平庸且不相关”的物品。</p>
<h5 data-id="heading-17">加权反馈法</h5>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">R</mi><mi>A</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">|\mathcal{R}_A|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span></span>：用户交互过的<strong>物品总数</strong>。</li>
</ul>
<p>引入用户评分作为权重，<strong>提升高质量反馈的影响力</strong>。高评分或高频互动的物品在空间中对用户坐标的拉引力更强。这使得用户向量向其最满意的物品区域偏移。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><munder><mrow><mi mathvariant="normal">argmax</mi><mo>⁡</mo></mrow><mrow><mi>y</mi><mo>∈</mo><mtext>Items</mtext></mrow></munder><mrow><mo fence="true">(</mo><mtext>USim</mtext><mrow><mo fence="true">(</mo><msub><mi>v</mi><mi>y</mi></msub><mo separator="true">,</mo><mfrac><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mi>A</mi></msub></mrow></munder><msub><mi>r</mi><mi>x</mi></msub><mo>⋅</mo><msub><mi>v</mi><mi>x</mi></msub></mrow><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mi>A</mi></msub></mrow></munder><msub><mi>r</mi><mi>x</mi></msub></mrow></mfrac><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">y^* = \operatorname*{argmax}_{y \in \text{Items}} \left( \text{USim} \left( v_y, \frac{\sum_{x \in \mathcal{R}_A} r_x \cdot v_x}{\sum_{x \in \mathcal{R}_A} r_x} \right) \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.1612em;margin-left:0em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mrel mtight">∈</span><span class="mord text mtight"><span class="mord mtight">Items</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span><span class="mop"><span class="mord mathrm">argmax</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0749em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord text"><span class="mord">USim</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.54em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.79em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.086em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span></span></span></span></div>
<h5 data-id="heading-18">单点加权推荐</h5>
<p>针对多兴趣用户，寻找与<strong>特定喜好物品最相似</strong>的推荐。单点加权策略保留了用户交互历史中每一个物品的独立特征。它认为用户的兴趣并非单一的聚合点，而是分布在潜在空间中的多个<strong>离散坐标点</strong>。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><msub><mtext>argmax</mtext><mi>y</mi></msub><mrow><mo fence="true">{</mo><mtext>USim</mtext><mo stretchy="false">(</mo><msub><mi>v</mi><mi>y</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>x</mi></msub><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>r</mi><mi>x</mi></msub><mo>∣</mo><mi>y</mi><mo>∈</mo><mtext>Items</mtext><mo separator="true">,</mo><msub><mi>v</mi><mi>x</mi></msub><mo>∈</mo><mi mathvariant="script">A</mi><mo fence="true">}</mo></mrow></mrow><annotation encoding="application/x-tex">y^* = \text{argmax}_{y} \left\{ \text{USim}(v_y, v_x) \cdot r_x \mid y \in \text{Items}, v_x \in \mathcal{A} \right\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1302em;vertical-align:-0.3802em;"/><span class="mord"><span class="mord text"><span class="mord">argmax</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0573em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">{</span><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">Items</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathcal">A</span><span class="mclose delimcenter" style="top:0em;">}</span></span></span></span></span></span></div>
<h5 data-id="heading-19">Top-K 覆盖</h5>
<p>对用户喜欢的不同物品分别执行搜索，获取 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 个多样化结果。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mo>=</mo><munder><mo>⋃</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mi>A</mi></msub></mrow></munder><munder><mrow><mi mathvariant="normal">top-k</mi><mo>⁡</mo></mrow><mrow><mi>y</mi><mo>∈</mo><mtext>Items</mtext></mrow></munder><mrow><mo fence="true">(</mo><mtext>USim</mtext><mo stretchy="false">(</mo><msub><mi>v</mi><mi>y</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>x</mi></msub><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>r</mi><mi>x</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">S = \bigcup_{x \in \mathcal{R}_A} \operatorname*{top-k}_{y \in \text{Items}} \left( \text{USim}(v_y, v_x) \cdot r_x \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4446em;vertical-align:-1.3946em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8557em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">⋃</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3946em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-2.1612em;margin-left:0em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mrel mtight">∈</span><span class="mord text mtight"><span class="mord mtight">Items</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span><span class="mop"><span class="mord mathrm">top-k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0749em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></div>
<h4 data-id="heading-20">最近邻搜索</h4>
<p>在完成物品向量化后，推荐系统面临的核心工程问题是如何从数百万甚至数亿个物品向量中快速找到与目标向量最相似的项。精确最近邻搜索需要计算目标向量与全量库中每个向量的距离，其<strong>计算复杂度随库规模呈线性增长</strong>，无法满足在线实时推荐的延迟要求。</p>
<p>为了平衡精度与速度，工程实践中普遍采用**近似最近邻（Approximate Nearest Neighbors ANN）**搜索算法，通过索引结构（如量化、聚类或图结构）缩小搜索范围，仅返回物理距离极其接近（而非绝对最近）的结果。ANN 算法能以极微小的精度损失换取数个数量级的执行速度提升。在任何需要执行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>argmax</mtext></mrow><annotation encoding="application/x-tex">\text{argmax}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">argmax</span></span></span></span></span></span> 或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>argmin</mtext></mrow><annotation encoding="application/x-tex">\text{argmin}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8623em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">argmin</span></span></span></span></span></span> 运算的大规模向量检索场景中，ANN 均是实际的底层实现支柱。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Function Calling案例：可视化的一站式数据助手]]></title>    <link>https://juejin.cn/post/7596971669862531113</link>    <guid>https://juejin.cn/post/7596971669862531113</guid>    <pubDate>2026-01-20T01:08:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596971669862531113" data-draft-id="7595358285722206217" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Function Calling案例：可视化的一站式数据助手"/> <meta itemprop="keywords" content="后端,人工智能,Python"/> <meta itemprop="datePublished" content="2026-01-20T01:08:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星浩AI"/> <meta itemprop="url" content="https://juejin.cn/user/2904236059009760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Function Calling案例：可视化的一站式数据助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2904236059009760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星浩AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:08:21.000Z" title="Tue Jan 20 2026 01:08:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“4月到6月，一日票和二日票每周卖了多少？哪个渠道卖得最好？” 这是运营同事每天都要手动查表、拼Excel、画图才能回答的问题。既浪费时间，又无法确保准确性。</p>
</blockquote>
<p>有没有可能，像聊天一样问一句，就自动得到答案和可视化结果？</p>
<p><strong>现在，有了。</strong></p>
<h3 data-id="heading-0">🎯 打造“会查数据库还会画图”的门票助手</h3>
<p>这个助手不需要你写 SQL、不用打开 Excel。你只需用自然语言提问，比如：</p>
<ul>
<li>“4 到 6 月每周卖了多少一日票和二日票？”</li>
<li>“哪个销售渠道的入园人数最多？”</li>
<li>“上个月北京用户买了多少张折扣票？”</li>
</ul>
<p>它会自动完成以下流程：</p>
<ol>
<li><strong>理解意图</strong>→ 2.<strong>生成精准 SQL</strong>→ 3.<strong>查询真实订单库</strong>→ 4.<strong>返回结构化结果 + 自动绘图</strong></li>
</ol>
<blockquote>
<p>💡一句话：让数据自己说话。</p>
</blockquote>
<h3 data-id="heading-1">📋 方案总览：一个「会查库 + 会画图」的门票助手</h3>
<p>整体架构可以拆解为<strong>4 个关键组件</strong>：</p>

























<table><thead><tr><th>组件</th><th>职责说明</th></tr></thead><tbody><tr><td>LLM（门票助手大脑）</td><td>基于 Qwen，通过 system prompt 理解表结构、SKU 规则和常见查询意图</td></tr><tr><td>Function Calling（工具调用层）</td><td>借助Assistant的function_list机制，把 LLM 生成的 SQL 交给工具执行</td></tr><tr><td>SQL 工具exc_sql（数据访问层）</td><td>与 MySQL 8.0 连接，只读执行查询，返回 Markdown 表格（以及后续扩展的图表）</td></tr><tr><td>WebUI / 终端交互（展示层）</td><td>为运营/业务同学提供聊天式界面，直接看到表格和图表结果</td></tr></tbody></table>
<h3 data-id="heading-2">⚡ 快速开始</h3>
<p>在开始搭建之前，需要先完成环境准备：</p>
<h4 data-id="heading-3">1. 安装依赖</h4>
<pre><code class="hljs language-text" lang="text">dashscope==1.22.1
matplotlib==3.10.3
numpy==2.3.0
pandas==2.3.0
qwen_agent==0.0.25
scikit_learn==1.7.0
SQLAlchemy==2.0.23
qwen_agent==0.0.19
</code></pre>
<pre><code class="hljs language-bash" lang="bash">pip install -r requirements.txt
</code></pre>
<h4 data-id="heading-4">2. 配置数据库连接</h4>
<p>确保已安装并启动 MySQL 8.0 数据库，创建<code>tkt_orders</code>表并导入示例数据。</p>
<p>修改<code>get_engine()</code>函数中的数据库连接信息（详见下方代码解析部分）。</p>
<h4 data-id="heading-5">3. 配置 API Key</h4>
<p>确保已配置 Qwen API Key，可通过环境变量设置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> DASHSCOPE_API_KEY=<span class="hljs-string">'your-api-key'</span>
</code></pre>
<h3 data-id="heading-6">🚀 实现方案与搭建流程</h3>
<p>从工程视角看，整个门票助手可以拆成几个清晰的步骤：先用 system prompt「教会」模型业务表结构和口径，再通过 function calling 接上只读 SQL 工具，最后用 WebUI 暴露给运营同学使用。</p>
<h4 data-id="heading-7">Step 1：系统初始化</h4>
<ul>
<li>设置系统 prompt，描述门票表结构和常见查询需求</li>
<li>注册 SQL 查询工具（<code>exc_sql</code>），用于执行数据查询</li>
</ul>
<h4 data-id="heading-8">Step 2：助手实例化</h4>
<p>使用 Qwen-Agent 的<code>Assistant</code>类，加载 LLM 配置、system prompt 和<code>function_list</code>（只包含<code>exc_sql</code>）。</p>
<h4 data-id="heading-9">Step 3：设置交互模式</h4>
<ul>
<li>选择 WebUI 模式，用户通过网页输入问题，助手自动完成 SQL 查询并返回结果</li>
<li>可以在界面右侧列出常见问题，方便运营「一键点选」</li>
</ul>
<h4 data-id="heading-10">Step 4：Function Call 机制</h4>
<p>完整的调用流程如下：</p>
<ol>
<li><strong>用户输入</strong>：自然语言问题</li>
<li><strong>LLM 解析</strong>：理解意图并自动生成 SQL 查询语句</li>
<li><strong>工具调用</strong>：<code>exc_sql</code>工具被自动调用，执行 SQL 并返回查询结果</li>
<li><strong>结果展示</strong>：通过终端或 WebUI 展示给用户</li>
</ol>
<h3 data-id="heading-11">💻 关键代码解析</h3>
<p>下面几节会从<strong>system prompt</strong>、<strong>工具注册</strong>和<strong>Agent 初始化</strong>三个角度，拆解整个 function calling 流程。</p>
<h4 data-id="heading-12">1、 System Prompt：让模型理解业务</h4>
<p>在实现 function calling 之前，最关键的是让模型<strong>真正理解你的业务表结构和业务口径</strong>。</p>
<p>下面通过<code>system_prompt</code>把门票订单表结构、一日/二日票的 SKU 归并规则以及典型聚合写死在提示词里，给模型一套“业务说明书”。</p>
<pre><code class="hljs language-python" lang="python">system_prompt = <span class="hljs-string">"""我是门票助手，以下是关于门票订单表相关的字段，我可能会编写对应的SQL(运行环境是MySQL8.0)，对数据进行查询
-- 门票订单表
CREATE TABLE tkt_orders (
    order_time DATETIME,             -- 订单日期
    account_id INT,                  -- 预定用户ID
    gov_id VARCHAR(18),              -- 商品使用人ID（身份证号）
    gender VARCHAR(10),              -- 使用人性别
    age INT,                         -- 年龄
    province VARCHAR(30),           -- 使用人省份
    SKU VARCHAR(100),                -- 商品SKU名
    product_serial_no VARCHAR(30),  -- 商品ID
    eco_main_order_id VARCHAR(20),  -- 订单ID
    sales_channel VARCHAR(20),      -- 销售渠道
    status VARCHAR(30),             -- 商品状态
    order_value DECIMAL(10,2),       -- 订单金额
    quantity INT                     -- 商品数量
);
一日门票，对应多种SKU：
Universal Studios Beijing One-Day Dated Ticket-Standard
Universal Studios Beijing One-Day Dated Ticket-Child
Universal Studios Beijing One-Day Dated Ticket-Senior
二日门票，对应多种SKU：
USB 1.5-Day Dated Ticket Standard
USB 1.5-Day Dated Ticket Discounted
一日门票、二日门票查询
SUM(CASE WHEN SKU LIKE 'Universal Studios Beijing One-Day%' THEN quantity ELSE 0 END) AS one_day_ticket_sales,
SUM(CASE WHEN SKU LIKE 'USB%' THEN quantity ELSE 0 END) AS two_day_ticket_sales
我将回答用户关于门票相关的问题
"""</span>
</code></pre>
<h4 data-id="heading-13">2、exc_sql 工具注册：把 SQL 交给「安全的查询工具」</h4>
<p>有了能写 SQL 的模型，还需要一个「只读的 SQL 执行器」。</p>
<p><code>exc_sql</code>工具负责接收模型生成的 SQL，连接 MySQL，并把结果以 Markdown 表格形式返回给 LLM，用于后续解释和可视化。</p>
<h5 data-id="heading-14">数据库连接封装</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_engine</span>():
    <span class="hljs-string">"""
    获取数据库连接 engine
    """</span>
    <span class="hljs-keyword">return</span> create_engine(
        <span class="hljs-string">f'mysql+mysqlconnector://用户名:密码@localhost:3306/数据库名称?charset=utf8mb4'</span>,
        connect_args={<span class="hljs-string">'connect_timeout'</span>: <span class="hljs-number">10</span>}, pool_size=<span class="hljs-number">10</span>, max_overflow=<span class="hljs-number">20</span>
    )
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@register_tool(<span class="hljs-params"><span class="hljs-string">'exc_sql'</span></span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExcSQLTool</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):
    <span class="hljs-string">"""
    SQL查询工具，执行传入的SQL语句并返回结果。
    """</span>
    description = <span class="hljs-string">'对于生成的SQL，进行SQL查询'</span>
    parameters = [{
        <span class="hljs-string">'name'</span>: <span class="hljs-string">'sql_input'</span>,
        <span class="hljs-string">'type'</span>: <span class="hljs-string">'string'</span>,
        <span class="hljs-string">'description'</span>: <span class="hljs-string">'生成的SQL语句'</span>,
        <span class="hljs-string">'required'</span>: <span class="hljs-literal">True</span>
    }]

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">self, params: <span class="hljs-built_in">str</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">import</span> json
        args = json.loads(params)
        sql_input = args[<span class="hljs-string">'sql_input'</span>]
        database = args.get(<span class="hljs-string">'database'</span>, <span class="hljs-string">'ubr'</span>)
        <span class="hljs-comment"># 创建数据库连接</span>
        engine = get_engine()
        <span class="hljs-keyword">try</span>:
            df = pd.read_sql(sql_input, engine)
            <span class="hljs-comment"># 返回前10行，防止数据过多</span>
            <span class="hljs-keyword">return</span> df.head(<span class="hljs-number">10</span>).to_markdown(index=<span class="hljs-literal">False</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span><span class="hljs-string">f"SQL执行出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
</code></pre>
<h5 data-id="heading-15">函数描述：让 LLM 知道「工具长什么样」</h5>
<pre><code class="hljs language-python" lang="python">functions_desc = [
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"exc_sql"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"对于生成的SQL，进行SQL查询"</span>,
        <span class="hljs-string">"parameters"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
            <span class="hljs-string">"properties"</span>: {
                <span class="hljs-string">"sql_input"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                    <span class="hljs-string">"description"</span>: <span class="hljs-string">"生成的SQL语句"</span>,
                }
            },
            <span class="hljs-string">"required"</span>: [<span class="hljs-string">"sql_input"</span>],
        },
    },
]
</code></pre>
<h4 data-id="heading-16">3、Assistant 初始化与 function_list：把「大脑」和「工具」接上</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_agent_service</span>():
    <span class="hljs-string">"""初始化门票助手服务"""</span>
    llm_cfg = {
        <span class="hljs-string">'model'</span>: <span class="hljs-string">'qwen-turbo-latest'</span>,
        <span class="hljs-string">'timeout'</span>: <span class="hljs-number">30</span>,
        <span class="hljs-string">'retry_count'</span>: <span class="hljs-number">3</span>,
    }
    <span class="hljs-keyword">try</span>:
        bot = Assistant(
            llm=llm_cfg,
            name=<span class="hljs-string">'门票助手'</span>,
            description=<span class="hljs-string">'门票查询与订单分析'</span>,
            system_message=system_prompt,
            function_list=[<span class="hljs-string">'exc_sql'</span>],  <span class="hljs-comment"># 只传工具名字符串</span>
        )
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"助手初始化成功！"</span>)
        <span class="hljs-keyword">return</span> bot
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"助手初始化失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">raise</span>
</code></pre>
<h4 data-id="heading-17">4、Web 图形界面：给运营一个可直接使用的入口</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">app_gui</span>():
    <span class="hljs-string">"""图形界面模式，提供 Web 图形界面"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在启动 Web 界面..."</span>)
        <span class="hljs-comment"># 初始化助手</span>
        bot = init_agent_service()
        <span class="hljs-comment"># 配置聊天界面，列举3个典型门票查询问题</span>
        chatbot_config = {
            <span class="hljs-string">'prompt.suggestions'</span>: [
                <span class="hljs-string">'2023年4、5、6月一日门票，二日门票的销量多少？帮我按照周进行统计'</span>,
                <span class="hljs-string">'2023年7月的不同省份的入园人数统计'</span>,
                <span class="hljs-string">'帮我查看2023年10月1-7日销售渠道订单金额排名'</span>,
            ]
        }
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Web 界面准备就绪，正在启动服务..."</span>)
        <span class="hljs-comment"># 启动 Web 界面</span>
        WebUI(
            bot,
            chatbot_config=chatbot_config
        ).run()
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"启动 Web 界面失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请检查网络连接和 API Key 配置"</span>)
</code></pre>
<blockquote>
<p>总结：至此，function call 相关逻辑全部通过Assistant的function_list机制与工具注册实现。LLM 只负责“提 SQL”exc_sql负责“真查询”前端 WebUI/终端则负责把结果友好地呈现出来同一套逻辑既支持终端（app_tui），也支持 WebUI 两种交互方式。</p>
</blockquote>
<h3 data-id="heading-18">📊 门票助手示例</h3>
<h4 data-id="heading-19">示例一：按周统计销量</h4>
<p><strong>问题</strong>：2023年4、5、6月一日门票，二日门票的销量多少？帮我按照周进行统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0b026fc5fab411ab2197271dda6a33b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pif5rWpQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476101&amp;x-signature=LX3VPBZ20QtTG2LkqnAb9I9Jgt0%3D" alt="img_1.jpg" loading="lazy"/></p>
<h4 data-id="heading-20">示例二：销售渠道订单金额排名</h4>
<p><strong>问题</strong>：帮我查看2023年10月1-7日销售渠道订单金额排名</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0525ec3d558405d8c82deca744f3f5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pif5rWpQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476101&amp;x-signature=7PBOq0gk9cpix%2F1uvFlHzGiJUpI%3D" alt="img_2.jpg" loading="lazy"/></p>
<h3 data-id="heading-21">📈 可视化图表：让结果「一眼看懂」</h3>
<p>以上示例通过表格进行展示，实际业务中往往还需要快速对比不同 SKU、不同渠道、不同时间段的趋势，这时就需要把查询结果自动转成图表。</p>
<p>在原有<code>exc_sql</code>函数基础上，增加绘图功能，返回结果包括：<strong>数据表 markdown</strong>以及<strong>可视化的图表 PNG</strong>。</p>
<h4 data-id="heading-22">实现步骤</h4>
<h5 data-id="heading-23">Step 1：SQL 查询获取数据</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 执行SQL查询</span>
df = pd.read_sql(sql_input, engine)
<span class="hljs-comment"># 生成markdown表格</span>
md = df.head(<span class="hljs-number">10</span>).to_markdown(index=<span class="hljs-literal">False</span>)
</code></pre>
<p><strong>提示词增加内容</strong>：</p>
<blockquote>
<p>⚠️重要：每当exc_sql工具返回 markdown 表格和图片时，你必须原样输出工具返回的全部内容（包括图片 markdown），不要只总结表格，也不要省略图片。这样用户才能直接看到表格和图片。</p>
</blockquote>
<h5 data-id="heading-24">Step 2：自动推断图表字段</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 自动推断x/y字段</span>
x_candidates = df.select_dtypes(include=[<span class="hljs-string">'object'</span>]).columns.tolist()
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> x_candidates:
    x_candidates = df.columns.tolist()
x = x_candidates[<span class="hljs-number">0</span>]
y_candidates = df.select_dtypes(include=[<span class="hljs-string">'number'</span>]).columns.tolist()
y_fields = y_candidates
</code></pre>
<p><strong>字段推断逻辑</strong>：</p>
<ul>
<li><strong>x 轴字段</strong>：优先选择第一个字符串类型（object）的列，如日期、分类名称等</li>
<li><strong>y 轴字段</strong>：选择所有数值类型的列，支持多系列数据展示</li>
</ul>
<h5 data-id="heading-25">Step 3：柱状图绘制</h5>
<pre><code class="hljs language-python" lang="python">plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">5</span>))
bar_width = <span class="hljs-number">0.35</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(y_fields) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.6</span>
x_labels = df[x].astype(<span class="hljs-built_in">str</span>)
x_pos = <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(df))
<span class="hljs-keyword">for</span> idx, y_col <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(y_fields):
    plt.bar([p + idx*bar_width <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> x_pos], df[y_col], width=bar_width, label=y_col)
</code></pre>
<p><strong>绘图逻辑</strong>：</p>
<ul>
<li>创建适当大小的图表</li>
<li>根据 y 轴字段数量调整柱宽</li>
<li>支持多系列数据的并列柱状图</li>
<li>每个 y 轴字段绘制一组柱子</li>
<li>自动错开位置，避免柱子重叠</li>
</ul>
<h5 data-id="heading-26">Step 4：图表样式设置</h5>
<pre><code class="hljs language-python" lang="python">plt.xlabel(x)
plt.ylabel(<span class="hljs-string">','</span>.join(y_fields))
plt.title(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">' &amp; '</span>.join(y_fields)}</span> by <span class="hljs-subst">{x}</span>"</span>)
plt.xticks([p + bar_width*(<span class="hljs-built_in">len</span>(y_fields)-<span class="hljs-number">1</span>)/<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> x_pos], x_labels, rotation=<span class="hljs-number">45</span>, ha=<span class="hljs-string">'right'</span>)
plt.legend()
plt.tight_layout()
</code></pre>
<p><strong>样式设置</strong>：</p>
<ul>
<li>设置 x 轴、y 轴标签</li>
<li>自动生成图表标题</li>
<li>x 轴标签 45 度倾斜，避免重叠</li>
<li>添加图例，区分多系列数据</li>
<li>调整图表布局，确保所有元素可见</li>
</ul>
<h5 data-id="heading-27">Step 5：图表保存与返回</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 自动创建目录</span>
save_dir = os.path.join(os.path.dirname(__file__), <span class="hljs-string">'image_show'</span>)
os.makedirs(save_dir, exist_ok=<span class="hljs-literal">True</span>)
<span class="hljs-comment"># 生成唯一文件名</span>
filename = <span class="hljs-string">f'bar_<span class="hljs-subst">{<span class="hljs-built_in">int</span>(time.time()*<span class="hljs-number">1000</span>)}</span>.png'</span>
save_path = os.path.join(save_dir, filename)
plt.savefig(save_path)
plt.close()
img_path = os.path.join(<span class="hljs-string">'image_show'</span>, filename)
img_md = <span class="hljs-string">f'![柱状图](<span class="hljs-subst">{img_path}</span>)'</span>
<span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{md}</span>\n\n<span class="hljs-subst">{img_md}</span>
</span></code></pre>
<p><strong>保存与返回逻辑</strong>：</p>
<ul>
<li>自动创建图片保存目录</li>
<li>生成基于时间戳的唯一文件名</li>
<li>保存图片到本地</li>
<li>生成 markdown 格式的图片引用</li>
<li>返回「表格 + 图片」组合结果</li>
</ul>
<blockquote>
<p>⚠️注意：在提示词中需要明确要求——每当exc_sql工具返回 Markdown 表格和图片时，LLM 必须原样输出工具返回的全部内容（包括图片 Markdown），不要只总结表格，也不要省略图片，这样运营同学才能直接看到完整结果。</p>
</blockquote>
<h4 data-id="heading-28">图表示例</h4>
<h5 data-id="heading-29">示例一：按周统计销量（带图表）</h5>
<p><strong>问题</strong>：2023年4、5、6月一日门票，二日门票的销量多少？帮我按照周进行统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5df8ab691dc4d448dff6fbe04cde287~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pif5rWpQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476101&amp;x-signature=jmO8IIU7h8BCvTfHZ%2FonxlPIQ9Q%3D" alt="img_3.jpg" loading="lazy"/></p>
<h5 data-id="heading-30">示例二：销售渠道订单金额排名（带图表）</h5>
<p><strong>问题</strong>：帮我查看2023年10月1-7日销售渠道订单金额排名</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3db1451b7473419a9fe2686a1a7b67c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pif5rWpQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476101&amp;x-signature=rFaYPgga0F1V4HjGxq9OtG4%2BJSU%3D" alt="img_4.jpg" loading="lazy"/></p>
<h3 data-id="heading-31">🔐 进阶与安全实践</h3>
<p>在真实业务环境中，还可以在此基础上做一些进阶优化：</p>

























<table><thead><tr><th>优化项</th><th>说明</th></tr></thead><tbody><tr><td>SQL 安全与只读控制</td><td>限制只允许SELECT语句、自动追加LIMIT，防止误删误改或一次性拉取海量数据</td></tr><tr><td>错误兜底与重试</td><td>当 SQL 语法错误或执行失败时，向用户返回清晰的错误信息，并允许模型基于错误信息自动重写 SQL 再试</td></tr><tr><td>多轮对话与上下文记忆</td><td>支持用户先问「查一下 4–6 月一日票销量」，再追问「那按渠道拆一下」，模型可自动继承时间范围等上下文</td></tr><tr><td>业务口径统一</td><td>把「一日票」「二日票」等业务口径、SKU 归并规则统一写在 system prompt 或配置文件中，避免同一指标不同口径</td></tr></tbody></table>
<blockquote>
<p>💡总结：通过这些实践，function calling 不仅能在 demo 中跑通，也能更稳健地落地到生产业务中。</p>
</blockquote>
<p>**🎉 恭喜！**你已经掌握了如何用 Function Calling 构建一个「会查数据库还会画图」的智能助手。
现在，让数据自己说话吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员应该成为一个什么样的人]]></title>    <link>https://juejin.cn/post/7596975035438448649</link>    <guid>https://juejin.cn/post/7596975035438448649</guid>    <pubDate>2026-01-20T03:20:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438448649" data-draft-id="7596990822127108134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员应该成为一个什么样的人"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-20T03:20:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端之虎陈随易"/> <meta itemprop="url" content="https://juejin.cn/user/1239904846873326"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员应该成为一个什么样的人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904846873326/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端之虎陈随易
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:20:32.000Z" title="Tue Jan 20 2026 03:20:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这两天，被<code>麻园诗人</code>圈粉了，歌曲<code>泸沽湖</code>循环再听。</p>
<p>上一首循环听的歌曲，应该是<code>福禄寿</code>的<code>我用什么把你留住</code>。</p>
<p>事不过三，再往前推一个，那就是电视剧<code>凡人歌</code>的伴奏<code>椿乐队</code>的<code>野草</code>。</p>
<p>这些歌都有一个共同的特点，或者说，我听的歌，都有一个共同的特点：<code>忧伤中带着向上的力量</code>。</p>
<p>人生百年，蜉蝣一日，对于未来，我一直是持悲观态度的，因为我认为，人，生来就是受苦的。</p>
<p>不说所有人，大部分人都有着无忧无虑的童年，迷茫的青年，焦虑的中年，至于老年怎么样，我现在还无法感同身受。</p>
<p>人到中年，以成功为目标来说，这是最后一次拼一把的机会。</p>
<p>不管是否下有小，还是上有老，一旦在中年结束之前无法有所突破，那么往后的每一步都会走得尤其艰难。</p>
<p>我经常感到庆幸的是，我此时已经在追求自己目标的道路上，前进了很长的一段距离了，而我才刚刚踏入中年的门槛。</p>
<p>作为一个在折腾路上持续不断地折腾了近10年的老码农，同时也最为一个技术圈有一点小人气的小博主，我时不时地就想分享一些关于自己对于人生，对于未来的思考和建议，希望可以给关注我的小伙伴们提供一些关于人生方向和抉择判断的参考。</p>
<p>回到文章开头提到的三首歌，三个乐队，三种力量中来，这篇文章我想分享的就是，<code>程序员应该成为一个什么样的人</code>。</p>
<p>正所谓，干一行，爱一行，我十分热爱编程，甚至是痴迷的程度，刚入行的前几年，研究代码当饭吃，不管是吃饭、坐公交还是上厕所，必然会用手机打开技术相关的书籍学习研究。</p>
<p>所以我的第一个建议就是，<code>专业</code>。</p>
<p>不要把写代码仅仅只是作为一个赚钱的手段，最好是练成一个赚钱的手艺，当然门槛其实也不用太高，能够一人之力解决项目中遇到的绝大部分问题就行。</p>
<p>但我从业10年以来，真正说遇到的程序员中，解决问题手到擒来的真没几个，很多都不具备熟练且顺畅地解决问题的能力，要练。</p>
<p>第二个建议，<code>责任</code>。</p>
<p>说实话，程序员是最容易摸鱼的群体，我估计没有之一。</p>
<p>本身就对电脑操作了如指掌，又是坐办公室，又是高薪，每天的工作就是对着电脑，偷摸地聊聊天，刷刷网页，看看帖子，基本都可以做到神不知，鬼不觉。</p>
<p>鱼可以摸，我们每个月拿高薪的同时，工作一定要做好，代码一定要写好。</p>
<p>为什么说这个话呢，对代码不负责的程序员可太多了，有多少后端程序员的接口是不做字段类型，大小，长短等规则验证的？有多少前端程序员代码不复用封装，页面乱如麻的。</p>
<p>做一个有责任，负责任的人，不用把公司当家，但可以服从公司的合理安排，为公司的发展壮大做贡献的人。</p>
<p>但不知道从什么时候起，网上关于<code>员工</code>和<code>公司</code>、<code>老板</code>的对立关系越来越多。</p>
<p>首先，遇到不良公司，不良老板，咱们肯定是不能再把公司当<code>家</code>的，公事公办，每个月给我碎银几两，我给你解决等同程度的问题。</p>
<p>我写了10年代码，职场待了5年，跳槽了近10次，全部都是中小公司，公司人数最多的一次也不过是接近100人，从来没有超过。</p>
<p>如果要让我对职场遇到的老板们一个评价，只有三个字：<code>不容易</code>，是的，很多开公司，当老板的，真的不容易，很不容易。</p>
<p>曾经年轻气盛，离职的时候老板挽留甚至下跪的。</p>
<p>与老板，同事，甲方聚餐我把两盘龙虾吃完了，老板还在低声下气给甲方赔罪喝酒喝到吐的，当然，不是因为我把桌子上两盘龙虾都吃了的原因，毕竟我还留了一只给我们公司的女同事。</p>
<p>而是项目延期，公司老板在甲方面前，真的特别卑微，但落到我们这些普通员工身份，一点多余的压力都没感受到，只有吃大餐的兴奋和喜悦。</p>
<p>也有公司工资发不出，老板找员工借钱的，或者自己借网贷的，其实每天压力山大，但却并没有表现得特别明显的，反而还要照顾我们这些牛马的情绪和状态。</p>
<p>这里，我给的第三个建议是，<code>理解</code>，理解老板，理解他们的不容易，但不要理解黑心老板。</p>
<p>创业是一个风险特别大的事情，我们牛马的代价，最多就是没有工作，欠一点工资，但老板创业很可能是赌上身家性命的。</p>
<p>问题是，既然代价这么大，那为什么又要去创业呢？其实很多时候，事情并不是只有两种状态，两种结果，人是思想和感情都很复杂的动物，想得越多，束缚越重。</p>
<p>第四个建议呢，<code>折腾</code>，为我们自己考虑，为未来考虑。</p>
<p>为什么要折腾？有很多人都问过我，你这么折腾，折腾这么多年，到底是为了什么？好像做出了一些成绩，但又不多，我很佩服你，但只能半服。</p>
<p>我只能说，折腾是<code>必要</code>的，也是<code>值得</code>的。</p>
<p>2020年下半年我回到农村以来，最开始只有接单这一条路，三年时间，平均月收入从2000到15000，三年后，放弃9成以上的接单业务，主做自媒体和独立开发，收入又断崖式下跌，仿佛回到了解放前，但我开心无比。</p>
<p>从24年开始，我把主要的时间和精力，放到自媒体，独立开发方向，我每天写文章，发视频，做产品，玩开源，不亦乐乎。</p>
<p>这事要放到刚回村那一年，我恐怕早就已经西北风了，哪像现在这样，写文章有钱赚，接推广有钱赚，做产品有钱赚，维护微信社群也有钱赚，虽然都不多，但平均下来，每个月的开销完全足够了。</p>
<p>人生最大的意义是什么？我认为人生最大的意义就是自由。</p>
<p>身体自由，想去哪去哪。思想自由，想干嘛干嘛。我可以睡到自然醒，也可以困了随时睡。劲头来了，我可以连续写半年的开源项目，提交代码3000次。也可以在沉迷做产品的时候，一不小心干了个通宵，不用担心第二天要打卡上班。</p>
<p>但自由是有代价的，我是吃过苦过来的，压力最大的时候真的觉得人生没有意义了，如果贸然离职，压力会大到你无法想象的。</p>
<p>所以，好好上班，在上班有稳定收入的前提下，再不断地去探索额外的收入和事业，为未来谋出路。</p>
<p>最后一个建议，<code>心态</code>，良好的心态是一个非常非常非常重要的能力。</p>
<p>很多事情不是<code>一蹴而就</code>的，而是<code>水到渠成</code>的，不要过于着急，很有可能急不来。</p>
<p>按照自己的节奏和计划，稳步前进，慢就是快，太快反而容易翻跟头。</p>
<p>其实还有很多建议，但没必要全部写出来，不完美的东西，才是最美的，人生本就是一个充满了遗憾的旅程，你看见了这边的风景，那必然会错过另一边的惊喜。</p>
<p>接受不完美，接受不完美的文章，接受不完美的世界，接受不完美的自己，接受不完美的公司，接受不完美的老板，接受不完美的伴侣，接受不富裕的父母，接受平凡而普通的下一代。</p>
<p>点个关注，结个善缘。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 Vue 3 核心概念：Composable 还是 Pinia Store？]]></title>    <link>https://juejin.cn/post/7597009443084304399</link>    <guid>https://juejin.cn/post/7597009443084304399</guid>    <pubDate>2026-01-20T03:26:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597009443084304399" data-draft-id="7597009443084288015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 Vue 3 核心概念：Composable 还是 Pinia Store？"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-20T03:26:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unknown331"/> <meta itemprop="url" content="https://juejin.cn/user/2826172528344323"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 Vue 3 核心概念：Composable 还是 Pinia Store？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2826172528344323/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unknown331
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:26:20.000Z" title="Tue Jan 20 2026 03:26:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<p>在重构代码（如 <code>useFileHandler.js</code>）时，我们经常会发现逻辑钩子的写法与 Pinia 非常相似。这并非巧合，而是 Vue 3 <strong>响应式编程模型</strong>的高度统一。</p>
<h3 data-id="heading-0">1. 结构大比拼：为什么它们是“双胞胎”？</h3>
<p>无论是 Composable 还是 Pinia，它们都遵循 <strong>State (状态) -&gt; Getters (派生) -&gt; Actions (动作)</strong> 的设计模式。</p>






























<table><thead><tr><th><strong>逻辑单元</strong></th><th><strong>Composable 钩子</strong></th><th><strong>Pinia Store (Setup 写法)</strong></th></tr></thead><tbody><tr><td><strong>定义状态</strong></td><td><code>ref()</code>, <code>reactive()</code></td><td><code>ref()</code>, <code>reactive()</code></td></tr><tr><td><strong>派生数据</strong></td><td><code>computed()</code></td><td><code>computed()</code></td></tr><tr><td><strong>业务方法</strong></td><td><code>function doSomething() { ... }</code></td><td><code>function doSomething() { ... }</code></td></tr><tr><td><strong>暴露结果</strong></td><td><code>return { ... }</code></td><td><code>return { ... }</code></td></tr></tbody></table>
<blockquote>
<p><strong>结论</strong>：Pinia 的 Setup Store 本质上就是一个“被全局管理的 Composable”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">2. 本质区别：逻辑克隆 vs. 数据共享</h3>
<p>虽然长得像，但它们的<strong>生命周期</strong>和<strong>作用域</strong>截然不同：</p>
<h4 data-id="heading-2"><strong>Composable (如 <code>useFileHandler</code>) — “逻辑模具”</strong></h4>
<ul>
<li>
<p><strong>私有实例</strong>：每次在组件中 <code>const { ... } = useFileHandler()</code>，都会创建一个<strong>全新的状态</strong>。</p>
</li>
<li>
<p><strong>生命周期</strong>：通常与调用它的组件挂钩（随组件销毁而注销）。</p>
</li>
<li>
<p><strong>核心用途</strong>：<strong>逻辑提取与复用</strong>。</p>
<ul>
<li><em>例子</em>：校验文件大小、格式过滤、图片重命名逻辑。不管在哪里用，这些“动作”是一样的，但处理的文件是当前组件私有的。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3"><strong>Pinia Store (如 <code>fileStore</code>) — “内存数据库”</strong></h4>
<ul>
<li>
<p><strong>全局单例</strong>：无论在多少个组件中引用，所有组件访问的都是<strong>同一份数据</strong>。</p>
</li>
<li>
<p><strong>永久驻留</strong>：除非刷新页面或手动重置，数据在整个应用生命周期内一直存在。</p>
</li>
<li>
<p><strong>核心用途</strong>：<strong>跨组件状态共享</strong>。</p>
<ul>
<li><em>例子</em>：已上传的文件列表。你在“输入框组件”上传，在“侧边栏组件”要实时看到，这时必须用 Store。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">3. 重构实战：它们如何“打配合”？</h3>
<p>在高质量的代码架构中，Composable 往往作为 <strong>“业务协调员”</strong> ，连接组件与 Store：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useFileHandler.js (Composable)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFileHandler</span>(<span class="hljs-params">isTranslateMode</span>) {
  <span class="hljs-keyword">const</span> fileStore = <span class="hljs-title function_">useFileStore</span>(); <span class="hljs-comment">// 1. 连接全局数据源 (Store)</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">validate</span> = (<span class="hljs-params">file</span>) =&gt; { <span class="hljs-comment">/* 2. 执行私有校验逻辑 */</span> };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">upload</span> = (<span class="hljs-params">file</span>) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">validate</span>(file)) {
      fileStore.<span class="hljs-title function_">addFile</span>(file);   <span class="hljs-comment">// 3. 校验通过，写入全局状态</span>
    }
  };

  <span class="hljs-keyword">return</span> { upload };
}
</code></pre>
<hr/>
<h3 data-id="heading-5">💡 复习金句（避坑指南）</h3>
<ol>
<li>
<p><strong>传参不带 <code>.value</code></strong>：在组件中调用钩子传入 <code>computed</code> 参数时，直接传变量名（如 <code>useFileHandler(isTranslate)</code>），这样钩子内部才能通过 <code>.value</code> 追踪到响应式变化。</p>
</li>
<li>
<p><strong>职责要分离</strong>：</p>
<ul>
<li><strong>Store</strong> 应该尽量“纯粹”，只管存取数据。</li>
<li><strong>Composable</strong> 负责“脏活累活”，比如复杂的 <code>if-else</code> 校验、粘贴事件解析。</li>
</ul>
</li>
<li>
<p><strong>物归原主</strong>：不属于该逻辑块的配置（如输入框字符限制 <code>inputCharLimit</code>）不要硬塞进 Hook，应保持 Hook 的<strong>单一职责</strong>。</p>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 效率分水岭：只会用 AI 提问已经不够了，掌握 Skills 才是硬通货]]></title>    <link>https://juejin.cn/post/7596962344045133864</link>    <guid>https://juejin.cn/post/7596962344045133864</guid>    <pubDate>2026-01-20T02:20:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596962344045133864" data-draft-id="7596962344045084712" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 效率分水岭：只会用 AI 提问已经不够了，掌握 Skills 才是硬通货"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-20T02:20:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟鸣"/> <meta itemprop="url" content="https://juejin.cn/user/4107431171852270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 效率分水岭：只会用 AI 提问已经不够了，掌握 Skills 才是硬通货
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431171852270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟鸣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T02:20:25.000Z" title="Tue Jan 20 2026 02:20:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10b0798f23f54cfc803f9bc98749126a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=m16B2%2Bwchm3EWaup1Ad27ONkpAY%3D" alt="图片" loading="lazy"/></p>
<p>最近 Agent Skills 非常火爆，2026 年1月1 日到现在，不完全统计 Github 上每天新增（某 Skills 市场收录）的 Skills 1W+，最高一天接近 4W。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc0731cc9b584871ab0b278c25255720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=up1Om1eqRAdvJqdKjHRF1%2BeErbQ%3D" alt="图片" loading="lazy"/></p>
<p>最近很多人问我：</p>
<ul>
<li>学长我不是程序员需要学 Skills 吗？</li>
<li>学长 Skills 是不是只能用来写代码？</li>
<li>学长我想直接发送商品信息，让 Skills 自动帮我按照特定格式生成内容可以吗？</li>
<li>学长我创建 Skills 内容多了模型使用的时候效果不好怎么办？</li>
</ul>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4f08d34d19a4850aa8eb7ebd79c7d2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=TOxzhS8wdl8Oo5uHBGlZXV%2F9eIY%3D" alt="图片" loading="lazy"/></p>
<p>昨天看到全栈式工程师 @_kaichen 发表了自己对 Agent Skills 的理解，讲得挺不错，引起了 6W 多次阅读：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">我之前完全误判了 Agent Skills
一直以程序员视角觉得 Skills 只是 Workflow Prompt，有用，但没什么大不了的，对吧？
直到这周看着推上一堆人疯狂分享各种 <span class="hljs-built_in">SKILL</span>，一开始看多了还有点不适，但突然反应过来：
卧槽，这东西不是简单文字，这是新一代的程序，而且还能自我迭代。
传统程序员怎么做功能？用代码编排流程，输入什么、处理什么、输出什么，一行行写死，编译打包交付上线。
Skills 怎么做功能？用 Markdown 写流程说明，告诉它什么场景触发、调用什么工具、输出什么格式。
这简直是大白话编程，用任何自然语言都接受的编程。
再进一步，这 Skills 是活的，是插件化的，是任何人都能轻松定制的。
传统软件，用户拿到只能用，不能改。想加功能？等下版本。有 bug？提工单排队。
Skills 不一样，觉得哪里不顺手，直接打开那个 .md 文件，用人话改几句就生效，甚至能丢 AI 帮你迭代升级。
没有环境配置，没有编译，没有部署。真正一次编写到处使用。
任何人都能拷贝、改造、升级、再分享。
每个人只要用从小学会的语言就能开发，甚至不需要打字，语音下达指令就行。
Agent 时代，人人都是开发者😲
</code></pre>
<hr/>
<p>最近和朋友聊天的时候，有很让人感慨。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a6ce77de9ad471f9f0a32a00ab1828b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=FGSiXduQ%2BOmoCe8P3Mqeupt8UoE%3D" alt="图片" loading="lazy"/></p>
<p>一个朋友说：“听说”（注意是听说而不是亲身体会）  Skills 挺好，但是平时挺忙的，没时间学啊。让我突然想到了上面这张图。</p>
<p>其实，有些时候恰恰是因为我们没有利用好 AI，把我们从越来越多的重复性的简单任务解放出来，所以才很忙。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63e2358c7cd54e7e8d98868b59564c18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=rZ2LYDeM%2FYXawoOOaTA7wqAPf48%3D" alt="图片" loading="lazy"/></p>
<p>举一个简单的例子，以前我校对字幕可能需要花半个小时到一个小时，现在我搞好了Skills，直接让它全自动的校验。我忙我自己的，几分钟后回去全部都搞好了。</p>
<p>像这种例子比比皆是，我掌握了skills 的使用和创建方法，我就可以根据我的工作和学习的场景，越来越多的场景去打造 skills 更全自动的完成。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4adb7df70d80486cafdc3b5410e4afbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=MnLjD%2F0W98aiAAgPxugj%2FrtS5NU%3D" alt="图片" loading="lazy"/></p>
<p>2025 年 AI Coding 大爆发，Cursor、Claude Code、Qoder、Antigravity 等层出不穷，给程序员带来的巨大的效率提升。我现在几乎完全用提示词来写代码了，只需要做一些检查和修改。</p>
<p>2026年 Claude Cowork 的出现，开始真正将能干活的 Agent 走向非程序员群体。国内已经有类似的工具，如ZCode，很多厂商会飞速跟进。能够尽早掌握这些工具，用好 Skills 的人将会和身边人产生巨大的效率差。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c4189193e4945d29d49459cf896c83b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=2M%2BP4OEB4kyiCrRN8pctDxlYITc%3D" alt="图片" loading="lazy"/></p>
<p>其实在我看来，<strong>Skills 不是专门给程序员用的“新技术”，更是给所有人工作和学习升级的“新途径”</strong> 。</p>
<p>很多人可能会说，<strong>Skills 和我有什么关系？我为什么要学</strong>？</p>
<p>为了让大家更有体感，我讲几个我已经创建出来正在用的真实的例子：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c05bd8e66f3a4e11afeb033aff1dc7eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=PhGVXuWHojmp%2FHnOIaVlmJdMkT4%3D" alt="图片" loading="lazy"/></p>
<p>比如说我们经常需要阅读一份材料，如阅读多个官方文档（如小报童官方文档、扣子官方文档、某某流程文档等），来解决问题。</p>
<p>如果没有提供对应的 AI 功能，那么我们可能每次都需要浪费很多时间，找到我们想要解决问题所需要阅读的片段。</p>
<p>搞一个“XX 文档 Skill”,我们下次需要用到这些文档的时候，它就会自动从我们这些 skills 中提取相关信息，回答我们的问题，甚至根据信息自主解决。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7ade6104a9145c3ade628740226effa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=34llTUDKrp0nqlJ%2BkEKt8KhKybY%3D" alt="图片" loading="lazy"/></p>
<p>我之前录视频会有很多 AI 相关的术语，视频转文字的字幕经常出错，人工校对半小时甚至一个多小时。</p>
<p>如果是以前我可能会在网页上传进一个智能体，然后把文件传上去，校对完了之后下载下来。</p>
<p>如果字幕的文件很长，我还要手动地把它拆成好几份，分别上传，分别粘贴回来，费时费力。</p>
<p>我现在只需要创建一个"字幕校对的 Skills"，我告诉 AI 帮我进行字幕校验，它就会按照我的要求，用我的专属词库进行字幕的校对，几分钟就校验完了，非常快，质量非常好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69bfb61c15a841d59ba119b71143820d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=IinEyKi0i97oko17k1KGvGkd9m8%3D" alt="图片" loading="lazy"/></p>
<p>我们之前学习某一个知识点，可能比较枯燥。</p>
<p>我们可能需要看一个文档，然后再把一些不太熟悉的段落复制出来，然后放到网页上问 DeepSeek。</p>
<p>我们只需要创建一个"通俗讲解专家 Skill"，边阅读的时候，圈选让 AI 自动按照我们的想法给我们解读。</p>
<p>如先让它就会用生活化的例子，让我们快速理解 80%；然后用相对通俗的语言进行专业性的讲解；再给我们一些顺口溜或者对比等比较容易记忆的方法；最后画一张图，帮我们非常直观地理解这个知识。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1e631d0acd24901b5e8ebb95b971ce7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=5hr0VK2rqbqWDDelJ7%2FkkUHMq1I%3D" alt="图片" loading="lazy"/></p>
<p>我之前看一篇论文可能抓不住重点，看完也没留下什么印象。</p>
<p>我们只需要创建一个"论文高效解读专家 Skill"。就可以先用一句话概括论文重点；然后，给出论文创新点；再结合自己的研究领域，给出可能带来的启发；最后，可以让它针对论文提出 5 个相关问题自问自答，帮我们更高效地理解论文。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56134ae06e334e0d9991058e52cba83c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=bAhOAYffb8lPEpcUeKz6AUko3IQ%3D" alt="图片" loading="lazy"/></p>
<p>比如说我之前需要下载 B 站的视频，之前还需要找一些支持下载的网站存起来，下次还要打开这个网站，网站上还有一些广告，下载的话转换完了还需要手动点击，非常繁琐。</p>
<p>现在我只需要创建一个"视频下载 Skills"，那么下次我直接把 B 站的视频发给他，告诉他下载，他就会自动地帮我下载到指定的目录中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa9452d84a0444fdba62d2ba19f49044~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=z8%2BNqxUmIp5vdtv7YANh0STj0B8%3D" alt="图片" loading="lazy"/></p>
<p><strong>这种例子还有很多很多</strong>，不管你是软件工程师还是非工程师群体（如产品经理、运营、大学生、大学老师等），掌握 Skills 的使用和自动创建，可以更早享受 AI 带来的真正巨大的效率提升，快速拉开和普通人的差距，解放自己。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/968ee3a29a2c4f4099d6f3181e7c2463~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=RDYL42qQwwPuRt0u8wJ14TVNHVY%3D" alt="图片" loading="lazy"/></p>
<p>当前，市面上很多 Skills 相关的文章质量参差不齐，很多人没有真正理解就敢发文章，误人子弟。</p>
<p>官方的 Skills 文档质量很高，对更好地理解 Skills，更高效得创建 Skills，有帮助。</p>
<p>但是很多人看完之后还是不知道怎么去使用和创建，而且自己去创建技能的时候也会遇到很多坑，效果不好也不知道问题出现在哪里，也不知道怎么解决。</p>
<p>我最近出了一个 《手把手带你玩转 Agent Skills：从零基础到实战高手》: <a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaobot.net%2Fp%2Fagent-skills%25C2%25A0%25E7%25BB%2593%25E5%2590%2588%25E8%2587%25AA%25E5%25B7%25B1%25E7%259A%2584%25E5%25AE%259E%25E6%2588%2598%25EF%25BC%258C%25E7%259C%259F%25E6%25AD%25A3%25E8%25AE%25A9%25E5%25A4%25A7%25E5%25AE%25B6%25E5%25BD%25BB%25E5%25BA%2595%25E7%2590%2586%25E8%25A7%25A3" target="_blank" title="https://xiaobot.net/p/agent-skills%C2%A0%E7%BB%93%E5%90%88%E8%87%AA%E5%B7%B1%E7%9A%84%E5%AE%9E%E6%88%98%EF%BC%8C%E7%9C%9F%E6%AD%A3%E8%AE%A9%E5%A4%A7%E5%AE%B6%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3" ref="nofollow noopener noreferrer">xiaobot.net/p/agent-ski…</a> Skills，快速安装使用 Skills，能够根据自己学习和工作场景高效创建 Skills 等。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/353fc76a011d4e43aa58fdb99e26d068~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=htLlYIhBeN3300Euh16aETqVkrk%3D" alt="图片" loading="lazy"/></p>
<p>专栏大纲如上图所示，计划 18 节，已经更新到 10 节，最近会快速更新完毕。</p>
<p>学完这个专栏，能够灵活使用以及根据自己的工作和学习场景打造适合自己的 Skills，把更多活派发给 AI，解放自己。</p>
<p>想要一起学习 Skills 的朋友，关注微信公众号：<strong>悟鸣AI,</strong> 发送数字“9”，获取专栏链接及粉丝优惠券。</p>
<p>欢迎关注我的公众号，后续会陆续分享比较有用的 AI 工具和比较好的 AI 经验，比较客观理性的 AI 观点等。</p>
<p><img src="" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a656964f3c8472e8133493c0ed0cf1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=J8IKCghTTyrkOcFyxYnZVpBftDE%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官 : “ 请你说一下 call、apply、bind 的区别 ? ”]]></title>    <link>https://juejin.cn/post/7597009443084337167</link>    <guid>https://juejin.cn/post/7597009443084337167</guid>    <pubDate>2026-01-20T03:26:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597009443084337167" data-draft-id="7597009443084222479" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官 : “ 请你说一下 call、apply、bind 的区别 ? ”"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-20T03:26:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="千寻girling"/> <meta itemprop="url" content="https://juejin.cn/user/2276467567770442"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官 : “ 请你说一下 call、apply、bind 的区别 ? ”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2276467567770442/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    千寻girling
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:26:42.000Z" title="Tue Jan 20 2026 03:26:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">call、apply、bind 的核心区别</h3>
<p>这三个方法的作用都是<strong>改变函数的 <code>this</code> 指向</strong>，他们三个的第一个参数是要绑定给函数的 <code>this</code> 对象。但在传参方式和执行时机上有明显不同。</p>
<hr/>
<h3 data-id="heading-1">详细对比</h3>





























<table><thead><tr><th>特性</th><th><code>call</code></th><th><code>apply</code></th><th><code>bind</code></th></tr></thead><tbody><tr><td><strong><code>this</code> 绑定后是否立即执行</strong></td><td>立即执行</td><td>立即执行</td><td>返回一个新函数，需手动调用才执行</td></tr><tr><td><strong>传参方式</strong></td><td>逐个传递参数</td><td>以数组形式传递参数</td><td>预先传递部分参数（柯里化），剩余参数在调用时传递</td></tr><tr><td><strong>返回值</strong></td><td>函数执行结果</td><td>函数执行结果</td><td>新的绑定函数</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">代码示例</h3>
<h4 data-id="heading-3">1. call 用法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.greeting}</span>, <span class="hljs-subst">${name}</span>!`</span>);
}

<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">greeting</span>: <span class="hljs-string">'Hello'</span> };
greet.<span class="hljs-title function_">call</span>(obj, <span class="hljs-string">'Alice'</span>); <span class="hljs-comment">// 输出：Hello, Alice!</span>
</code></pre>
<h4 data-id="heading-4">2. apply 用法</h4>
<pre><code class="hljs language-ini" lang="ini">function sum(a, b) {
  return a + b<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">numbers</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">result</span> = sum.apply(null, numbers)<span class="hljs-comment">; // 输出：3</span>
</code></pre>
<h4 data-id="heading-5">3. bind 用法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.greeting}</span>, <span class="hljs-subst">${name}</span>!`</span>);
}

<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">greeting</span>: <span class="hljs-string">'Hi'</span> };
<span class="hljs-keyword">const</span> boundGreet = greet.<span class="hljs-title function_">bind</span>(obj);
<span class="hljs-title function_">boundGreet</span>(<span class="hljs-string">'Bob'</span>); <span class="hljs-comment">// 输出：Hi, Bob!</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">核心场景</h3>
<ul>
<li><strong><code>call</code></strong>：适合参数数量明确的场景，如继承、借用方法。</li>
<li><strong><code>apply</code></strong>：适合参数数量不确定或已存在数组的场景，如数组求最大值 <code>Math.max.apply(null, [1, 2, 3])</code>。</li>
<li><strong><code>bind</code></strong>：适合需要延迟执行或预先绑定 <code>this</code> 的场景，如事件回调、定时器。</li>
</ul>
<p>这三个方法的作用都是<strong>改变函数的 <code>this</code> 指向</strong>，call , apply , bind 他们三个的第一个参数是要绑定给函数的 <code>this</code> 对象。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年 CSS 年度调查报告亮点速览]]></title>    <link>https://juejin.cn/post/7596943803934670888</link>    <guid>https://juejin.cn/post/7596943803934670888</guid>    <pubDate>2026-01-20T03:04:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596943803934670888" data-draft-id="7596943803934621736" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 2025 年 CSS 年度调查报告亮点速览"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-20T03:04:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             2025 年 CSS 年度调查报告亮点速览
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:04:01.000Z" title="Tue Jan 20 2026 03:04:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日，「State of CSS 2025」年度调查报告公布。</p>
<p>这份报告收集了全球数万名开发者的真实使用经验和反馈，堪称是 Web 开发领域的“年度风向标”。</p>
<p>本篇我们盘点下这份报告的亮点部分。</p>
<h2 data-id="heading-0">1. 使用率最高的功能是 :has()</h2>
<p><strong>在调查的所有功能中，</strong><code>**:has()**</code><strong>是使用率最高也是最受欢迎的功能。</strong></p>
<p>想必大家已经很熟悉了，它是一个功能非常强大的伪类，可以实现类似“父选择器”和“前面兄弟选择器”的功能。</p>
<p>举个简单的例子，下面的 CSS 代码表示如果 <code>&lt;a&gt;</code> 元素里面有 <code>&lt;img&gt;</code> 元素，则这个 <code>&lt;a&gt;</code> 元素就会匹配。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:has</span>(<span class="hljs-selector-tag">img</span>) {
  <span class="hljs-attribute">display</span>: block;
}
</code></pre>
<p>我们可以使用这个选择器轻松区分是文字链接还是图像链接，并设置不同的 CSS 样式。</p>
<h2 data-id="heading-1">2. 使用率第二高的功能是 aspect-ratio</h2>
<p>这个 CSS 属性允许你定义元素盒子的宽高比。</p>
<p>这意味着即使父容器或视口大小发生变化，浏览器也会调整元素的尺寸以保持指定的宽高比。</p>
<p>比如我们将一张图片设置为 3/2 宽高比：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">img</span> {
  aspect-ratio: <span class="hljs-number">3</span>/<span class="hljs-number">2</span>;
}
</code></pre>
<h2 data-id="heading-2">3. 使用率最低的是 sibling-count 和 sibling-index</h2>
<p>记得以前实现列表项交错动画时，要手动给每个元素设置不同的延迟吗？</p>
<p>现在，用 <code>sibling-index()</code> 一行代码就能搞定！</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">li</span> {
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">transition-delay</span>: <span class="hljs-built_in">calc</span>((<span class="hljs-built_in">sibling-index</span>() - <span class="hljs-number">1</span>) * <span class="hljs-number">100ms</span>);
}
</code></pre>
<p>这个函数会自动获取元素在兄弟节点中的位置（从 1 开始计数），通过简单的计算就能实现<strong>流畅的交错动画效果</strong>。</p>
<p>如果再搭配 <code>@starting-style</code>，连入场动画都能轻松搞定：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">li</span> {
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">transition-delay</span>: <span class="hljs-built_in">calc</span>((<span class="hljs-built_in">sibling-index</span>() - <span class="hljs-number">1</span>) * <span class="hljs-number">100ms</span>);

  <span class="hljs-keyword">@starting-style</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fargyleink%2Fpen%2FKwKXPYW" target="_blank" title="https://codepen.io/argyleink/pen/KwKXPYW" ref="nofollow noopener noreferrer">实现效果如下：</a></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1a4f0f145d4232a37913f620cc868d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=87sNHhi%2BWbIxUaBheGB0pwLtcRo%3D" alt="" loading="lazy"/></p>
<p>之所以使用率最低，可以理解，因为浏览器支持还比较新。</p>
<h2 data-id="heading-3">4. 受欢迎程度第二高的功能是 Subgrid</h2>
<p>Subgrid 表示子网格，它并不是一个 CSS 属性，而是 grid-template-columns 和 grid-template-rows 属性支持的关键字，其使用的场景需要外面已经有个 Grid 布局。</p>
<p>什么时候会用到 Subgrid 呢？</p>
<p>举个例子，这是一个布局效果：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6e8b08e65a24a0f8a6f1db19000aab2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=iz0TkuOpABZCRaF5VU%2BjAYWKrkg%3D" alt="" loading="lazy"/></p>
<p>你会发现，标题字数不一样，内容字数不一样，导致底部很难对齐。</p>
<p>然而我们想要的效果是这样的：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b50ee87a778a445e909c74b315cf7cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=n9xK2PPEkRShrOPWMdjSqgZEY%2FU%3D" alt="" loading="lazy"/></p>
<p>此时就可以用到 Subgrid，使用示例如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.wrapper</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr;
}

<span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">grid-row</span>: <span class="hljs-number">1</span> / <span class="hljs-number">4</span>;
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-rows</span>: subgrid;
}
</code></pre>
<h2 data-id="heading-4">5. 认知度增长最高的是 light-dark()</h2>
<p>不知道你是否实现过网站的浅色和深色主题：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 默认浅色主题 */</span>
  <span class="hljs-attr">--text-heading</span>: <span class="hljs-number">#000</span>;
  <span class="hljs-attr">--text-body</span>: <span class="hljs-number">#212121</span>;
  <span class="hljs-attr">--surface</span>: <span class="hljs-number">#efefef</span>;

  <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme</span>: dark) {
    <span class="hljs-comment">/* 暗色主题 - 第一遍 */</span>
    <span class="hljs-attr">--text-heading</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attr">--text-body</span>: <span class="hljs-number">#efefef</span>;
    <span class="hljs-attr">--surface</span>: <span class="hljs-number">#212121</span>;
  }
}

<span class="hljs-selector-class">.dark-theme</span> {
  <span class="hljs-comment">/* 暗色主题 - 又写一遍！ */</span>
  <span class="hljs-attr">--text-heading</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attr">--text-body</span>: <span class="hljs-number">#efefef</span>;
  <span class="hljs-attr">--surface</span>: <span class="hljs-number">#212121</span>;
}
</code></pre>
<p>同样的颜色写两遍，一个给媒体查询（自动切换），一个给切换按钮。</p>
<p>改一次要改两个地方，烦死了！</p>
<p>现在使用 <code>light-dark()</code> 轻松实现！</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 跟随系统偏好 */</span>
  <span class="hljs-attribute">color</span>-scheme: light dark;

  <span class="hljs-comment">/* 一次定义，自动切换 */</span>
  <span class="hljs-attr">--text-heading</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#000</span>, <span class="hljs-number">#fff</span>);
  <span class="hljs-attr">--text-body</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#212121</span>, <span class="hljs-number">#efefef</span>);
  <span class="hljs-attr">--surface</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#efefef</span>, <span class="hljs-number">#212121</span>);
}
</code></pre>
<p>就这么简单！系统是浅色就用第一个，暗色就用第二个。</p>
<h2 data-id="heading-5">6. 评论最多的功能是 line-clamp，多是负面评价</h2>
<p>CSS 属性 line-clamp 用于将容器的内容限制为指定的行数，也就是我们常实现的内容多时显示省略号的效果。</p>
<p>举个例子：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">p</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">display</span>: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: <span class="hljs-number">2</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
}
</code></pre>
<p>效果如下：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/105ce52fd632442aa0623d5c73e8eff5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=D5Mt8kShf1PSVoKu8BZRmNGjZf8%3D" alt="" loading="lazy"/></p>
<p>之所以被大家吐槽，多是因为技术局限性问题，比如：</p>
<ul>
<li>能限制行数，无法精确控制高度</li>
<li>浏览器兼容性还不够好</li>
<li>与动态内容配合困难：当文本内容长度不确定时，难以准确控制显示效果</li>
</ul>
<p>当我们实际使用 line-clamp 的时候，还要配合一系列属性比如 display、-webkit-box-orient、overflow、text-overflow，这种组合方案既复杂又不够语义化。</p>
<h2 data-id="heading-6">7. 结论</h2>
<p>CSS 这些年无疑在快速的发展中，而人们对 CSS 的满意度也在持续攀升。</p>
<p>引用报告中的一句话：</p>
<p><strong>“如果说 2025 年的主题是稳定不可能之事，那么 2026 年或许是实现期待已久的梦想之年。”</strong></p>
<p>对于热爱 CSS 的人来说，现在正是尝试、学习并参与塑造未来发展方向的最佳时机。</p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong>，每天分享前端知识、AI 干货。</p>
<p>新的一年，如果你想快速改变自己，欢迎加入我的知识星球：“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2Fcourse%3Fto%3Dzsxq" target="_blank" title="https://yayujs.com/course?to=zsxq" ref="nofollow noopener noreferrer">冴羽·前端大佬成长之路</a>”，10 年工作总结、100+ 篇精华主题、70W 字原创内容，带你升级认知、重构生活、建立知识管理系统、通关面试、引领职场。用一年时间，实现十倍成长，一鸣惊人。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第 4 章：工具调用基础——让 LLM 走出“缸中之脑”]]></title>    <link>https://juejin.cn/post/7596943803934326824</link>    <guid>https://juejin.cn/post/7596943803934326824</guid>    <pubDate>2026-01-20T02:33:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596943803934326824" data-draft-id="7596943803934228520" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第 4 章：工具调用基础——让 LLM 走出“缸中之脑”"/> <meta itemprop="keywords" content="前端,Agent,AIGC"/> <meta itemprop="datePublished" content="2026-01-20T02:33:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="芋圆ai"/> <meta itemprop="url" content="https://juejin.cn/user/1451828494217415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第 4 章：工具调用基础——让 LLM 走出“缸中之脑”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1451828494217415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    芋圆ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T02:33:46.000Z" title="Tue Jan 20 2026 02:33:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第 4 章：工具调用基础——让 LLM 走出“缸中之脑”</h2>
<blockquote>
<p><strong>"工具是人类进化的延伸。"</strong></p>
<p><strong>对于 LLM 而言，Tool（工具）就是它的手脚。没有工具，它只是一个被困在服务器里的"缸中之脑"，博学但无力；有了工具，它才能真正干预物理世界，从 Chatbot 进化为 Agent。</strong></p>
</blockquote>
<h3 data-id="heading-1">4.1 核心痛点：全知全能的"局限性"</h3>
<p>哲学上有一个思想实验叫<strong>缸中之脑</strong>：一个大脑即使能思考整个宇宙，如果无法<strong>感知</strong>当下的温度，也无法<strong>改变</strong>任何现实，它就是无力的。</p>
<p>这就是 LLM 的根本困境。</p>
<p>就像我们部署的客服 Agent 回答极其流畅，但在被问到"今天的贷款利率"时，它自信地引用了训练数据中的 4.35%（2020 年数据），而当时实际利率已降至 3.65%。</p>
<p><strong>这次事故揭示了 LLM 的致命短板：</strong></p>

























<table><thead><tr><th>维度</th><th>能力层级</th><th>根本原因</th></tr></thead><tbody><tr><td><strong>语言能力</strong></td><td><strong>教授级</strong></td><td>掌握了人类几乎所有的文本模式</td></tr><tr><td><strong>现实连接</strong></td><td><strong>断网级</strong></td><td>知识截止于训练结束那一刻（Knowledge Cutoff）</td></tr><tr><td><strong>行动能力</strong></td><td><strong>零</strong></td><td>只能生成字符，不能点击鼠标、不能发请求</td></tr></tbody></table>
<p>要让这个"大脑"有用，必须给它接上神经末梢（API）和机械臂（执行器）。在 Agent 领域，这就是 <strong>Function Calling（工具调用）</strong> 。</p>
<h3 data-id="heading-2">4.2 本质还原：Function Calling 的工作流</h3>
<p>把 Function Calling 理解为"调用函数"是程序员的思维定势；在 Agent 的语境下，它其实是一种**"委托协议"**。</p>
<p>当 LLM 决定使用工具时，它并不是自己在"运行"什么，而是在填写一张<strong>业务委托单</strong>。</p>
<p><strong>它的内心独白是这样的：</strong></p>
<blockquote>
<p>"嘿，系统，我算不准这个，但我知道你们有个叫'计算器'的部门。请帮我算一下'5 的阶乘'，然后把结果填在单子上还给我。"</p>
</blockquote>
<p><strong>流程的本质是：</strong></p>
<ol>
<li><strong>思考（LLM）</strong> ：分析用户意图，判断是否需要外援。</li>
<li><strong>委托（Protocol）</strong> ：LLM 输出一个标准的结构化请求（比如一张包含工具名和参数的工单）。</li>
<li><strong>执行（System）</strong> ：Agent 系统截获这张工单，去执行真正的代码（查库、搜索、计算）。</li>
<li><strong>反馈（Result）</strong> ：系统把执行结果打包成文本，喂回给 LLM。</li>
<li><strong>再思考（LLM）</strong> ：LLM 拿着结果，组织语言回答用户。</li>
</ol>
<p>这种**"思考与执行解耦"**的设计，是 Agent 能够安全落地的基石——LLM 负责决策（大脑），系统负责执行（手脚），各司其职。</p>
<h3 data-id="heading-3">4.3 深度解剖：一个工业级工具的"五脏六腑"</h3>
<p>很多教程只教你给工具起个名字，这是玩具级的做法。在工业级框架中，一个成熟的工具设计必须像<strong>入职员工</strong>一样，经过严格的背景调查和岗位定义。</p>
<h4 data-id="heading-4">1. 岗位说明书（Metadata）：风控的防线</h4>
<p>在商业环境中，<strong>失控的 Agent 比人工智障更可怕。</strong> 因此，我们定义工具时，不仅仅是定义功能，更是在定义<strong>边界</strong>。</p>
<p>一个完善的工具定义应包含以下"安全带"：</p>
<ul>
<li><strong>身份标识</strong>：它是谁？（唯一名称）</li>
<li><strong>操作手册</strong>：它是干什么的？（给 LLM 看的说明书）</li>
<li><strong>权限等级</strong>：是否需要人类授权？（防止它私自删除数据库）</li>
<li><strong>熔断机制（Rate Limit）</strong> ：每分钟允许调几次？（防止 Agent 陷入死循环搞挂下游服务）</li>
<li><strong>止损机制（Timeout）</strong> ：最多允许运行多久？（防止任务卡死）</li>
<li><strong>财务审计</strong>：调用一次大概花多少钱？（控制 Token 成本）</li>
</ul>
<p><strong>真实案例</strong>：如果没有熔断机制，一个陷入逻辑死循环的 Agent 曾在一分钟内对搜索接口发起了 500 次调用，直接导致账号因欠费被封锁。</p>
<h4 data-id="heading-5">2. 描述工程（Description）：把 LLM 当实习生</h4>
<p>这是工具定义中<strong>最关键</strong>的部分。LLM 是否调用工具、参数填得对不对，全看"操作手册"（Description）写得好不好。</p>
<p><strong>一个实用的原则：不要把 LLM 当作冷冰冰的编译器，要把它当作新来的实习生。</strong></p>
<ul>
<li>
<p><strong>❌ 糟糕的指令（程序员思维）</strong> ：</p>
<blockquote>
<p>"Google 搜索功能。" <em>（太简略，实习生不知道什么时候该用，什么时候不该用）</em></p>
</blockquote>
</li>
<li>
<p><strong>✅ 优秀的指令（管理者思维）</strong> ：</p>
<blockquote>
<p>"当用户询问实时新闻、具体事实（如股价、天气）或 2023 年后的事件时使用此工具。**注意：**不要用于查询通用常识（如'苹果的颜色'），也不要用于回答哲学问题。"</p>
</blockquote>
</li>
</ul>
<p>你需要明确告诉它： <strong>"做什么"</strong> 、 <strong>"什么情况做"<strong>以及</strong>"什么情况不做"</strong> 。</p>
<h4 data-id="heading-6">3. 容错与防御：系统的"自动纠偏"</h4>
<p>LLM 是概率模型，它大概率是对的，但总有 0.1% 的概率会犯迷糊。比如你让它填数字，它可能填了数字的汉字写法。</p>
<p>成熟的 Agent 系统必须具备<strong>防御性</strong>：它像一个经验丰富的老员工，在执行"实习生"（LLM）发出的工单前，会默默修正那些明显的格式错误（自动类型转换、范围截断），而不是直接报错让系统崩溃。</p>
<h3 data-id="heading-7">4.4 认知负荷：为什么工具不能太多？</h3>
<p>如果你给 Agent 一次性挂载了 50 个工具，你会发现它变笨了。它可能该用搜索的时候用了爬虫，或者干脆拒绝回答。</p>
<p><strong>原因在于"认知负荷"（Cognitive Load）和注意力分散。</strong></p>
<p>LLM 的注意力窗口是有限的。这就好比你让一个修理工把 50 把不同的扳手都挂在腰带上，他干活时光是找工具就要花半天，还容易拿错。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f33d33c0c96447d98fbdeb07ba84a010~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IqL5ZyGYWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769481225&amp;x-signature=DXeSU5qTYAUxcg4Yc6KqSZDzLCE%3D" alt="0010页.jpg" loading="lazy"/></p>
<h4 data-id="heading-8">解决方案：动态工具加载（Dynamic Loading）</h4>
<p>不要一次性把整个仓库倒出来。根据任务的上下文，只给它最需要的工具包。</p>
<ul>
<li><strong>写作模式</strong>：只提供"知识库检索"工具，屏蔽代码解释器和搜索引擎，减少干扰。</li>
<li><strong>分析模式</strong>：只提供"计算器"和"数据库查询"工具。</li>
</ul>
<p><strong>少即是多。</strong> 只有精准地限制选项，才能显著提高 Agent 的决策质量。</p>
<h3 data-id="heading-9">4.5 避坑指南：墨菲定律的实证</h3>
<p>在数百个 Agent 的落地过程中，我们验证了墨菲定律：<strong>如果工具参数可能被填错，LLM 一定会填错。</strong></p>
<h4 data-id="heading-10">陷阱 1：参数幻觉</h4>
<p>LLM 经常会"自作聪明"，编造出 API 中根本不存在的参数。</p>
<ul>
<li><strong>解法（菜单化）</strong> ：不要给它开放式填空题，尽量给它选择题。明确告诉它："这个参数只能选 A、B 或 C"。</li>
</ul>
<h4 data-id="heading-11">陷阱 2：格式黑洞</h4>
<p>你让它填日期，它可能填 "2024年1月1日"，也可能填 "Jan 1st"。</p>
<ul>
<li><strong>解法（样本化）</strong> ：在说明书中直接给出<strong>少样本示例（Few-Shot Examples）</strong> 。比如："日期格式必须参考：2024-05-20"。</li>
</ul>
<h4 data-id="heading-12">陷阱 3：安全漏洞</h4>
<p>允许 LLM 直接生成代码并在你的机器上运行，无异于把家门钥匙交给陌生人。</p>
<ul>
<li><strong>解法（沙箱化）</strong> ：永远不要信任 LLM 的输出。所有的执行操作必须在**沙箱（Sandbox）**或隔离容器中进行，确保即使它发疯，也破坏不了主系统。</li>
</ul>
<h3 data-id="heading-13">4.6 总结</h3>
<p>工具调用不仅仅是技术接口的对接，它是构建 Agent <strong>行动力</strong> 的关键。</p>
<ol>
<li><strong>连接现实</strong>：工具让 LLM 突破了训练数据的时空限制，从"空想家"变成了"实干家"。</li>
<li><strong>工程落地</strong>：必须通过权限、限流、容错等机制，把概率性的 AI 关进确定性的工程笼子里。</li>
<li><strong>认知管理</strong>：通过精心设计的说明书和动态筛选机制，降低 LLM 的决策难度，像管理实习生一样管理 AI。</li>
</ol>
<p>掌握了工具调用，你的 LLM 就不再是一个只会陪聊的 Chatbot，而是一个能真正创造价值的数字员工。</p>
<p>但问题来了：如果我们开发的工具只能在自己的系统里用，是不是太封闭了？能不能让 Agent 直接使用别人写好的工具，甚至直接操控原本给人类设计的软件？</p>
<p>下一章，我们将探讨 <strong>MCP (Model Context Protocol)</strong> —— 它是连接不同 Agent 生态的"通用语"，是实现 AI 互联的关键一步。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc84839bb76847cabc29692eb298be05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IqL5ZyGYWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769481225&amp;x-signature=114L0o0TXWSqQy3ty3YvXjT2yS4%3D" alt="0015页.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习Three.js--网格模型]]></title>    <link>https://juejin.cn/post/7596966040922062854</link>    <guid>https://juejin.cn/post/7596966040922062854</guid>    <pubDate>2026-01-20T03:05:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596966040922062854" data-draft-id="7596997542041681963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习Three.js--网格模型"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-20T03:05:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="造轮子的猪"/> <meta itemprop="url" content="https://juejin.cn/user/497453720940158"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习Three.js--网格模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/497453720940158/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    造轮子的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:05:11.000Z" title="Tue Jan 20 2026 03:05:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">学习Three.js--网格模型</h2>
<h3 data-id="heading-1">前置核心说明</h3>
<p>上文说明了 <strong>「场景(Scene)、相机(Camera)、渲染器(Renderer)」三大核心、几何体(Geometry)、材质(Material)</strong> 相关知识，而 <strong>「网格模型(Mesh)」就是衔接「几何体」和「材质」的核心桥梁</strong>，是 Three.js 中实现<strong>可视化3D物体的最终载体</strong>。</p>
<h4 data-id="heading-2">核心关系</h4>
<pre><code class="hljs language-scss" lang="scss">几何体(Geometry) → 物体的「骨架/形状」
材质(Material) → 物体的「皮肤/外观」
网格模型(Mesh) → 将「骨架+皮肤」绑定为一个完整的、可渲染的<span class="hljs-number">3</span>D实体对象
</code></pre>
<p>所有能在 Three.js 场景中<strong>看到的实体3D物体</strong>，本质都是各类「网格/渲染对象」；
所有网格对象创建后，都通过 <code>scene.add(网格对象)</code> 方法添加到场景中才能被渲染；
单位遵循 Three.js 右手坐标系：<strong>X轴右、Y轴上、Z轴外</strong>，角度单位均为「弧度」。</p>
<hr/>
<h3 data-id="heading-3">一、什么是 THREE.Mesh 核心网格模型</h3>
<h4 data-id="heading-4">1.1 概念与核心作用</h4>
<p><code>THREE.Mesh</code> 是 Three.js 中 <strong>最基础、最核心、使用率99%的网格渲染类</strong>，也是所有<strong>立体实体模型</strong>的核心载体。</p>
<ul>
<li>作用：接收「几何体」和「材质」两个核心参数，将二者封装为一个<strong>具备形状+外观的完整3D对象</strong>；</li>
<li>特性：<code>THREE.Mesh</code> 渲染的是<strong>带面、带体积的实心几何体</strong>，支持光照、阴影、纹理、透明度等所有材质特性；</li>
<li>适用场景：<strong>所有立体3D实体</strong> → 立方体、球体、圆柱、自定义模型等，都是通过 <code>THREE.Mesh</code> 实现渲染。</li>
</ul>
<h4 data-id="heading-5">1.2 标准创建语法 &amp; 完整参数</h4>
<h5 data-id="heading-6">基础语法</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.Mesh(几何体, 材质)</span>
<span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>( geometry, material );
scene.<span class="hljs-title function_">add</span>(mesh); <span class="hljs-comment">// 添加到场景才能渲染</span>
</code></pre>
<h5 data-id="heading-7">参数详细说明</h5>























<table><thead><tr><th>参数名</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td><code>geometry</code></td><td>THREE.Geometry / THREE.BufferGeometry</td><td>是</td><td>几何体对象，定义网格的形状/结构（如BoxGeometry、SphereGeometry）</td></tr><tr><td><code>material</code></td><td>THREE.Material 任意子类</td><td>是</td><td>材质对象，定义网格的外观（如MeshStandardMaterial、MeshBasicMaterial）</td></tr></tbody></table>
<h5 data-id="heading-8">扩展语法（材质传数组，一个几何体绑定多个材质）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 一个几何体的不同面，绑定不同材质，材质数组的长度要与几何体的面数匹配</span>
<span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>( geometry, [material1, material2, material3] );
</code></pre>
<h4 data-id="heading-9">1.3 核心注意事项</h4>
<ol>
<li><strong>材质/几何体复用</strong>：同一个几何体/材质可以被多个 <code>Mesh</code> 复用，比如100个立方体用同一个几何体+材质，仅创建1份即可，<strong>极大节省内存，优化性能</strong>；</li>
<li><strong>几何体类型兼容</strong>：<code>THREE.Mesh</code> 仅支持「面几何体」（有体积、有面的几何体），不支持线、点类几何体；</li>
<li><strong>版本提示</strong>：Three.js <code>r125+</code> 版本后，<strong>推荐使用 BufferGeometry</strong> 替代旧的 Geometry，前者性能更高，是官方主推的几何体类型，二者用法一致。</li>
</ol>
<hr/>
<h3 data-id="heading-10">二、THREE.Mesh 核心公共属性 &amp; 方法</h3>
<p><code>THREE.Mesh</code> 继承自 <code>THREE.Object3D</code>，拥有<strong>所有3D对象通用的核心属性和方法</strong>，这些是你操控3D物体的<strong>核心API</strong>，<strong>所有网格/渲染对象都共用</strong>，必学必记，无例外！</p>
<blockquote>
<p>所有属性支持「创建后动态修改」，修改后立即生效，无需重新创建Mesh。</p>
</blockquote>
<h4 data-id="heading-11">2.1 三大核心变换属性（位置、旋转、缩放，最常用TOP3）</h4>
<h5 data-id="heading-12">① 位置属性 <code>position</code> → 控制物体在场景中的坐标</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 类型：THREE.Vector3 对象，默认值 (0, 0, 0) 场景原点</span>
mesh.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// X轴向右移动2个单位</span>
mesh.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = -<span class="hljs-number">1</span>; <span class="hljs-comment">// Y轴向下移动1个单位</span>
mesh.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// Z轴向外移动3个单位</span>
<span class="hljs-comment">// 批量设置：x, y, z</span>
mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">3</span>);
</code></pre>
<h5 data-id="heading-13">② 旋转属性 <code>rotation</code> → 控制物体的旋转角度</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 类型：THREE.Euler 对象，默认值 (0, 0, 0)，单位是「弧度」不是角度！</span>
mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>; <span class="hljs-comment">// 绕X轴旋转90°</span>
mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>; <span class="hljs-comment">// 绕Y轴旋转180°</span>
mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">z</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">4</span>; <span class="hljs-comment">// 绕Z轴旋转45°</span>
<span class="hljs-comment">// 批量设置：x, y, z 弧度值</span>
mesh.<span class="hljs-property">rotation</span>.<span class="hljs-title function_">set</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>/<span class="hljs-number">2</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>/<span class="hljs-number">4</span>);
<span class="hljs-comment">// 角度转弧度小技巧：角度值 * Math.PI / 180</span>
mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = <span class="hljs-number">45</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>; <span class="hljs-comment">// 绕Y轴旋转45°</span>
</code></pre>
<h5 data-id="heading-14">③ 缩放属性 <code>scale</code> → 控制物体的大小缩放</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 类型：THREE.Vector3 对象，默认值 (1, 1, 1) 原始尺寸</span>
mesh.<span class="hljs-property">scale</span>.<span class="hljs-property">x</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// X轴放大2倍</span>
mesh.<span class="hljs-property">scale</span>.<span class="hljs-property">y</span> = <span class="hljs-number">0.5</span>; <span class="hljs-comment">// Y轴缩小为原来的0.5倍</span>
<span class="hljs-comment">// 批量设置：等比缩放/非等比缩放</span>
mesh.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// X放大2倍，Y缩小0.5倍，Z不变</span>
mesh.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>); <span class="hljs-comment">// 整体等比放大3倍</span>
</code></pre>
<h4 data-id="heading-15">2.2 高频基础属性</h4>
<pre><code class="hljs language-javascript" lang="javascript">mesh.<span class="hljs-property">visible</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 布尔值，默认true，是否显示该物体；false则隐藏，不参与渲染</span>
mesh.<span class="hljs-property">name</span> = <span class="hljs-string">"cube"</span>; <span class="hljs-comment">// 字符串，给物体命名，可通过 scene.getObjectByName("cube") 获取该物体</span>
mesh.<span class="hljs-property">userData</span> = {<span class="hljs-attr">id</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">type</span>:<span class="hljs-string">"cube"</span>}; <span class="hljs-comment">// 自定义数据，存储业务相关信息，不影响渲染</span>
mesh.<span class="hljs-property">matrixAutoUpdate</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 布尔值，默认true，自动更新变换矩阵；手动控制矩阵时设为false</span>
</code></pre>
<h4 data-id="heading-16">2.3 光影相关核心属性（实现阴影必备）</h4>
<pre><code class="hljs language-javascript" lang="javascript">mesh.<span class="hljs-property">castShadow</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 布尔值，默认false，该物体是否「投射阴影」到其他物体上</span>
mesh.<span class="hljs-property">receiveShadow</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 布尔值，默认false，该物体是否「接收」其他物体投射的阴影</span>
</code></pre>
<blockquote>
<p>注意：开启阴影后，还需要开启「光源的阴影投射」+「渲染器的阴影支持」才能生效。</p>
</blockquote>
<h4 data-id="heading-17">2.4 核心常用方法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 让物体始终朝向某个目标点/物体</span>
mesh.<span class="hljs-title function_">lookAt</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)); <span class="hljs-comment">// 朝向场景原点</span>
mesh.<span class="hljs-title function_">lookAt</span>(camera.<span class="hljs-property">position</span>); <span class="hljs-comment">// 朝向相机位置</span>

<span class="hljs-comment">// 2. 给物体添加子物体（父子层级关系）</span>
<span class="hljs-keyword">const</span> childMesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geo, mat);
mesh.<span class="hljs-title function_">add</span>(childMesh); <span class="hljs-comment">// childMesh成为mesh的子物体，继承父物体的位置/旋转/缩放</span>

<span class="hljs-comment">// 3. 移除子物体</span>
mesh.<span class="hljs-title function_">remove</span>(childMesh);

<span class="hljs-comment">// 4. 克隆当前物体（深拷贝，包含几何体、材质、所有属性）</span>
<span class="hljs-keyword">const</span> meshClone = mesh.<span class="hljs-title function_">clone</span>();
scene.<span class="hljs-title function_">add</span>(meshClone);

<span class="hljs-comment">// 5. 清除物体的所有变换（位置归零、旋转归零、缩放还原）</span>
mesh.<span class="hljs-title function_">resetMatrix</span>();
</code></pre>
<hr/>
<h3 data-id="heading-18">三、Three.js 中「所有网格/渲染对象」分类大全（完整8类，含参数+用途）</h3>
<p>Three.js 提供的<strong>所有可视化渲染对象</strong> —— <code>THREE.Mesh</code> 只是「立体实体」的核心，Three.js 为了满足不同的可视化需求，提供了<strong>8类专用的网格/渲染对象</strong>，全部继承自 <code>THREE.Object3D</code>，共用上述所有公共属性和方法，只是<strong>渲染形态、适用场景、创建参数不同</strong>。</p>
<h4 data-id="heading-19">核心分类原则</h4>
<p>所有渲染对象按「渲染形态」分为四大类：<strong>实体类、线类、点类、精灵类</strong>，以下按「使用率从高到低」排序，全部整理了 <strong>创建语法、完整参数、核心特点、适用场景</strong></p>
<hr/>
<h4 data-id="heading-20">第一类：实体类渲染对象（核心，立体有体积，共2个）</h4>
<h5 data-id="heading-21">1. THREE.Mesh（上文详解，使用率 99%）</h5>
<ul>
<li>核心：渲染<strong>实心立体几何体</strong>，带面、带体积，支持所有材质；</li>
<li>适用：所有3D实体模型（立方体、球体、圆柱、自定义模型）；</li>
<li>创建：<code>new THREE.Mesh(geometry, material)</code>。</li>
</ul>
<h5 data-id="heading-22">2. THREE.SkinnedMesh（骨骼蒙皮网格，进阶）</h5>
<ul>
<li>核心：<code>THREE.Mesh</code> 的子类，支持<strong>骨骼绑定+蒙皮动画</strong>，可以让模型实现关节弯曲、人物行走等骨骼动画；</li>
<li>适用：人物模型、动物模型、有骨骼动画的3D角色；</li>
<li>创建语法 &amp; 参数：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.SkinnedMesh(几何体, 材质, 骨骼数组(可选))</span>
<span class="hljs-keyword">const</span> skinnedMesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SkinnedMesh</span>(geometry, material, bones);
</code></pre>
</li>
<li>特点：比普通Mesh多了骨骼相关的属性和方法，是实现3D角色动画的核心。</li>
</ul>
<hr/>
<h4 data-id="heading-23">第二类：线类渲染对象（纯线条，无面无体积，共3个）</h4>
<blockquote>
<p>所有线类对象，<strong>必须搭配「线材质」</strong>：<code>LineBasicMaterial</code>(实线) / <code>LineDashedMaterial</code>(虚线)，不能使用Mesh系列材质！
核心特点：只渲染几何体的「棱边/顶点连线」，无面、无体积，性能极高，适合绘制轮廓、辅助线、轨迹线等。</p>
</blockquote>
<h5 data-id="heading-24">1. THREE.Line（连续线条，使用率最高）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.Line(几何体, 材质)</span>
<span class="hljs-comment">// 几何体：必须是 BufferGeometry，顶点按顺序连成「一条连续的折线」</span>
<span class="hljs-keyword">const</span> lineGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>().<span class="hljs-title function_">setFromPoints</span>([
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>)
]);
<span class="hljs-keyword">const</span> lineMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">LineBasicMaterial</span>({<span class="hljs-attr">color</span>:<span class="hljs-number">0xff0000</span>});
<span class="hljs-keyword">const</span> line = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Line</span>(lineGeometry, lineMaterial);
scene.<span class="hljs-title function_">add</span>(line);
</code></pre>
<ul>
<li>特点：顶点按传入顺序<strong>首尾相连成连续线条</strong>，最后一个顶点不闭合到起点；</li>
<li>适用：折线、轨迹线、连接线、电路图等。</li>
</ul>
<h5 data-id="heading-25">2. THREE.LineSegments（分段线条）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.LineSegments(几何体, 材质)</span>
<span class="hljs-comment">// 特点：顶点按「两两一组」渲染成独立的线段，组与组之间不连接</span>
<span class="hljs-keyword">const</span> line = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">LineSegments</span>(geometry, material);
</code></pre>
<ul>
<li>适用：网格辅助线、坐标轴、虚线框、多段独立线条等。</li>
</ul>
<h5 data-id="heading-26">3. THREE.LineLoop（闭合线条）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.LineLoop(几何体, 材质)</span>
<span class="hljs-comment">// 特点：顶点按顺序连成连续线条，「最后一个顶点会闭合到第一个顶点」，形成封闭图形</span>
<span class="hljs-keyword">const</span> line = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">LineLoop</span>(geometry, material);
</code></pre>
<ul>
<li>适用：圆形轮廓、正方形边框、封闭轨迹线等。</li>
</ul>
<blockquote>
<p>线类必看注意点：使用 <code>LineDashedMaterial</code>(虚线材质) 时，必须给几何体执行 <code>geometry.computeLineDistances()</code>，否则虚线不生效！</p>
</blockquote>
<hr/>
<h4 data-id="heading-27">第三类：点/粒子类渲染对象（纯点，共1个）</h4>
<h5 data-id="heading-28">THREE.Points（粒子/点云模型）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.Points(几何体, 材质)</span>
<span class="hljs-comment">// 核心：必须搭配「点材质」PointsMaterial，不能使用其他材质</span>
<span class="hljs-keyword">const</span> pointsArr = [];
<span class="hljs-keyword">const</span> count = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
     <span class="hljs-keyword">const</span> x = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">10</span>; <span class="hljs-comment">// -5 ～ +5</span>
    <span class="hljs-keyword">const</span> y = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">10</span>;
    <span class="hljs-keyword">const</span> z = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">10</span>;
    pointsArr.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(x, y, z));
}
<span class="hljs-keyword">const</span> pointsGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>().<span class="hljs-title function_">setFromPoints</span>(pointsArr); <span class="hljs-comment">// pointsArr是顶点数组</span>
<span class="hljs-keyword">const</span> pointsMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PointsMaterial</span>({<span class="hljs-attr">color</span>:<span class="hljs-number">0xffffff</span>, <span class="hljs-attr">size</span>:<span class="hljs-number">2</span>});
<span class="hljs-keyword">const</span> points = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Points</span>(pointsGeometry, pointsMaterial);
scene.<span class="hljs-title function_">add</span>(points);
</code></pre>
<ul>
<li>核心特点：渲染几何体的<strong>每个顶点为一个独立的点/粒子</strong>，无面、无线条，仅显示点；</li>
<li>材质专属：只能用 <code>THREE.PointsMaterial</code>，支持粒子大小、颜色、透明度、纹理贴图；</li>
<li>适用场景：<strong>粒子特效</strong>（星空、雪花、雨滴、烟雾、火焰）、点云模型、数据可视化散点图等。</li>
</ul>
<hr/>
<h4 data-id="heading-29">第四类：精灵类渲染对象（2D平面，始终朝相机，共2个）</h4>
<h5 data-id="heading-30">1. THREE.Sprite（精灵模型）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.Sprite(材质) → 无需几何体！</span>
<span class="hljs-keyword">const</span> spriteMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SpriteMaterial</span>({<span class="hljs-attr">color</span>:<span class="hljs-number">0xff0000</span>, <span class="hljs-attr">transparent</span>:<span class="hljs-literal">true</span>});
<span class="hljs-keyword">const</span> sprite = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Sprite</span>(spriteMaterial);
scene.<span class="hljs-title function_">add</span>(sprite);
</code></pre>
<ul>
<li>核心特点：<strong>无需几何体</strong>，本质是一个「无限薄的2D正方形平面」，<strong>无论相机如何旋转，始终正面朝向相机</strong>；</li>
<li>材质专属：必须搭配 <code>THREE.SpriteMaterial</code> 精灵材质；</li>
<li>大小控制：通过 <code>sprite.scale.set(width, height, 1)</code> 控制尺寸；</li>
<li>适用场景：3D场景中的2D元素（图标、血条、标签、子弹、火焰粒子、雪花）。</li>
</ul>
<h5 data-id="heading-31">2. THREE.SpriteGroup（精灵组，进阶）</h5>
<ul>
<li>核心：批量渲染多个Sprite，<strong>性能极高</strong>，适合创建大量精灵（如10000个雪花、雨滴）；</li>
<li>语法：<code>new THREE.SpriteGroup(material, {size:1000})</code>；</li>
<li>适用：大规模粒子特效、海量精灵渲染。</li>
</ul>
<hr/>
<h3 data-id="heading-32">四、补充：特殊「网格相关」知识点</h3>
<h4 data-id="heading-33">4.1 关于「BufferGeometry 优先使用」的说明</h4>
<p>Three.js 中有两种几何体：<code>Geometry</code>（旧版） 和 <code>BufferGeometry</code>（新版），二者都能传给Mesh/Line/Points，但：</p>
<ul>
<li>推荐：<strong>所有场景优先使用 BufferGeometry</strong>，它是官方主推的几何体类型；</li>
<li>优势：<code>BufferGeometry</code> 对GPU更友好，内存占用更少，渲染性能更高，支持所有新特性；</li>
<li>兼容：所有网格对象对两种几何体的支持完全一致，用法无区别，只是创建方式不同。</li>
</ul>
<h4 data-id="heading-34">4.2 网格模型的性能优化核心技巧</h4>
<ol>
<li><strong>复用几何体和材质</strong>：同一个几何体/材质，尽量给多个网格对象复用，减少内存占用；</li>
<li><strong>减少分段数</strong>：几何体的分段数越高，顶点越多，渲染越慢，够用即可（如球体32段足够平滑）；</li>
<li><strong>批量渲染</strong>：大量相同的简单物体，使用 <code>InstancedMesh</code>（实例化网格）替代多个Mesh，性能提升百倍；</li>
<li><strong>隐藏不可见物体</strong>：对屏幕外的物体设置 <code>visible=false</code>，减少渲染计算；</li>
<li><strong>减少阴影开启</strong>：阴影渲染性能开销大，非必要场景关闭 <code>castShadow/receiveShadow</code>。</li>
</ol>
<h4 data-id="heading-35">4.3 易混淆概念区分</h4>
<ol>
<li>误区：<code>THREE.Mesh</code> 是唯一的网格模型 →  正确：<code>Mesh</code> 只是「实体网格」，还有线、点、精灵等专用渲染对象；</li>
<li>误区：线类对象可以用Mesh材质 →  正确：线类必须用线材质，点类必须用点材质，精灵必须用精灵材质，<strong>材质和渲染对象是一一对应的</strong>；</li>
<li>误区：Sprite需要几何体 →  正确：Sprite无需几何体，是自带2D平面的渲染对象。</li>
</ol>
<hr/>
<h3 data-id="heading-36">五、完整的「Mesh创建+使用」示例代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 官网地址</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://threejsfundamentals.org/threejs/resources/threejs/r132/build/three.module.js'</span>
<span class="hljs-comment">// 1. 创建三大核心</span>
<span class="hljs-comment">//场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
<span class="hljs-comment">//透视相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>/<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
<span class="hljs-comment">//相机默认创建在场景的**坐标原点 (0,0,0)**，与场景中心重合，此时会和几何体重叠导致看不到内容，**必须手动调整相机位置**，最常用的就是调整Z轴让相机「后退」：</span>
<span class="hljs-comment">// 相机沿Z轴向后移动5个单位，即可看到场景中心的物体</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">5</span>;

<span class="hljs-comment">//渲染器</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>();
<span class="hljs-comment">// 设置渲染画布的尺寸（与浏览器窗口一致，满屏显示）</span>
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-comment">// 将渲染器生成的canvas画布，添加到HTML页面中</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-comment">// 2. 创建几何体+材质</span>
<span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>); <span class="hljs-comment">// 立方体几何体</span>
<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshStandardMaterial</span>({<span class="hljs-attr">color</span>:<span class="hljs-number">0x00ff00</span>, <span class="hljs-attr">roughness</span>:<span class="hljs-number">0.5</span>, <span class="hljs-attr">metalness</span>:<span class="hljs-number">0.2</span>}); <span class="hljs-comment">// PBR材质</span>

<span class="hljs-comment">// 3. 创建核心网格模型Mesh</span>
<span class="hljs-keyword">const</span> cubeMesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);
<span class="hljs-comment">// 设置Mesh属性</span>
cubeMesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 位置</span>
cubeMesh.<span class="hljs-property">rotation</span>.<span class="hljs-title function_">set</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>/<span class="hljs-number">4</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>/<span class="hljs-number">4</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 旋转</span>
cubeMesh.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>); <span class="hljs-comment">// 缩放</span>
cubeMesh.<span class="hljs-property">castShadow</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 投射阴影</span>
cubeMesh.<span class="hljs-property">name</span> = <span class="hljs-string">"cube"</span>; <span class="hljs-comment">// 命名</span>

<span class="hljs-comment">// 4. 添加到场景</span>
scene.<span class="hljs-title function_">add</span>(cubeMesh);

<span class="hljs-comment">// 5. 添加光源（PBR材质必须加光源）</span>
<span class="hljs-keyword">const</span> ambientLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.5</span>);
<span class="hljs-keyword">const</span> dirLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">1</span>);
dirLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>,<span class="hljs-number">5</span>,<span class="hljs-number">5</span>);
dirLight.<span class="hljs-property">castShadow</span> = <span class="hljs-literal">true</span>;
scene.<span class="hljs-title function_">add</span>(ambientLight, dirLight);

<span class="hljs-comment">// 6. 动画循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  cubeMesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> += <span class="hljs-number">0.01</span>;
  cubeMesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.01</span>;
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
}
<span class="hljs-title function_">animate</span>();

</code></pre>
<hr/>
<h3 data-id="heading-37">核心知识总结</h3>
<ol>
<li><strong>核心关系</strong>：几何体(形状)+材质(外观) → Mesh(实体对象)，Mesh是3D实体的最终载体；</li>
<li><strong>网格体系</strong>：Three.js的可视化对象分4类 → 实体(Mesh/SkinnedMesh)、线(Line/LineSegments)、点(Points)、精灵(Sprite)；</li>
<li><strong>三大变换</strong>：所有网格对象共用 <code>position</code>(位置)、<code>rotation</code>(旋转)、<code>scale</code>(缩放)，是操控物体的核心；</li>
<li><strong>材质匹配</strong>：实体用Mesh材质，线用线材质，点用点材质，精灵用精灵材质，一一对应；</li>
<li><strong>性能优先</strong>：优先用BufferGeometry，复用几何体/材质，减少分段数，提升渲染效率。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor CLI重磅更新！]]></title>    <link>https://juejin.cn/post/7596845113282002953</link>    <guid>https://juejin.cn/post/7596845113282002953</guid>    <pubDate>2026-01-20T00:33:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596845113282002953" data-draft-id="7595808703074484250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor CLI重磅更新！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-20T00:33:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor CLI重磅更新！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T00:33:59.000Z" title="Tue Jan 20 2026 00:33:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前几天，cursor没有带来cursor IDE的更新，但是这次却带来了cursor CLI的更新。一直以来cursor都把IDE作为自身的重心来发展，这次终于开始像cc开始走终端AI发展了。</p>
<p>下面就直接来看看这次cursor 都给CLI带来了哪些新能力。</p>
<h3 data-id="heading-0">第一个，plan模式</h3>
<p>我们知道，plan模式在现在的AI IDE里面都已经是默认的模式了，这次cursor效仿cc带来了终端的plan模式。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/706c20df53054608a8e420bc5457780a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=vYnNmSedKTJvaqgtY0pVgRXQg4w%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>你可以通过 /plan 开启plan模式。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4d19deb30ee4128bfc821ef7678fb48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=HI4wM6BnCF6a09M8AkDH6yX%2FXE0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>同时cursor cli也支持提问模式，通过/ask开启。</p>
<h3 data-id="heading-1">第二个，云端模式</h3>
<p>cc有自己的cloud ，可以方便的把一端的对话无缝的迁移到其他平台，让AI在后台持续为你工作。这次cursor也带来了自己的cloud 智能体，实现了CLI，web，手机端的对话分享。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/713f8ca35ea04e30b0532f587d2bcb91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=ICe8%2B%2FGd1qiezRmT8qMs2nXGAPw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>对于使用者，只需要在消息前面加上 &amp;，就可以把消息发送到云端了。</p>
<h3 data-id="heading-2">第三个，逐词级别的内联差异查看</h3>
<p>这次新版本CLI还增加了类似git diff的功能，方便的大家查看更改前后的差别，不过这个功能比git diff还更强了一步，精确到了单词级别的差别查看。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b2c93d7340c4d3b981b49d18bb80103~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=7HuO98r5PbDXIJGw0o5oRngpwo4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">第四个，一键创建规则</h3>
<p>通过/rules 命令，可以直接创建rule，修改和查看已有的rule。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51d13f454c8b4f178b6066e75efc3178~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=P2f1unNkzOmQbusERNq61SZKJyk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">第五个，一键创建命令</h3>
<p>和rule一样，CLI也提供了/commands 命令来创建，编辑，查看命令。</p>
<p>伴随着这次的更新，CLI的打开方式也迎来了简化，过去开启CLI的方式是使用cursor-agent，这次直接简化为如下方式</p>
<p>除了前面提到的plan和ask模式，agent就是默认的模式，因为agent模式可以访问所有的工具，最适合处理复杂的编码任务。</p>
<h3 data-id="heading-5">第六个，debug模式</h3>
<p>写代码一时爽，debug的时候火葬场，每个程序员都会经理bug的多次打击，这次的cursor CLI也带来额debug模式来帮你做debug的事情。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61a4418c478242bebbbe211ce88616de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=Rz6MozRZDY7XQnfgyisz9f%2BLzUg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>当CLI也难以解决某个bug的时候，不会在那里瞎猜小号你的耐心，会自动查看运行时状态信息来尝试解决。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Rules 到 Skills：用 Anthropic 开放标准重构你的 AI 编程工作流]]></title>    <link>https://juejin.cn/post/7596970073749585956</link>    <guid>https://juejin.cn/post/7596970073749585956</guid>    <pubDate>2026-01-20T01:04:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596970073749585956" data-draft-id="7596971669862465577" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Rules 到 Skills：用 Anthropic 开放标准重构你的 AI 编程工作流"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-20T01:04:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lambert281"/> <meta itemprop="url" content="https://juejin.cn/user/2253355646455980"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Rules 到 Skills：用 Anthropic 开放标准重构你的 AI 编程工作流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2253355646455980/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lambert281
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:04:07.000Z" title="Tue Jan 20 2026 01:04:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从 Rules 到 Skills：用 Anthropic 开放标准重构你的 AI 编程工作流</h2>
<blockquote>
<p>基于 Java 后端 Skills 实战（REST API / Service / 异常处理 / 校验 / 日志 / MyBatis-Plus）</p>
<p>本文适合作为一篇 CSDN 博客发布，系统介绍 Skills 标准、工具链以及一个完整的 Java 后端 Skills 实战项目。</p>
<p>GitHub 项目地址：<code>https://github.com/lambert0529/skills</code></p>
</blockquote>
<blockquote>
<p><strong>说明</strong>：本文档基于 <strong>Anthropic Skills 开放标准</strong>编写，全面介绍 Skills 的概念、使用方法和最佳实践，并结合 Java 后端 Skills 进行实战演示。适用于所有支持该标准的 AI 编程助手（Cursor、Claude Code、Windsurf、Aider 等）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">📖 目录</h3>
<ol>
<li><a href="#1-skill-%E6%98%AF%E4%BB%80%E4%B9%88" title="#1-skill-%E6%98%AF%E4%BB%80%E4%B9%88">Skill 是什么</a></li>
<li><a href="#2-skill-vs-rules-vs-busagent-vs-commands-vs-mcp-%E5%AF%B9%E6%AF%94" title="#2-skill-vs-rules-vs-busagent-vs-commands-vs-mcp-%E5%AF%B9%E6%AF%94">Skill vs Rules vs BusAgent vs Commands vs MCP 对比</a></li>
<li><a href="#3-%E5%90%84%E5%A4%A7%E7%BC%96%E8%BE%91%E5%B7%A5%E5%85%B7%E5%AF%B9-skills-%E7%9A%84%E6%94%AF%E6%8C%81%E5%92%8C%E9%80%82%E9%85%8D%E8%BF%9B%E5%BA%A6" title="#3-%E5%90%84%E5%A4%A7%E7%BC%96%E8%BE%91%E5%B7%A5%E5%85%B7%E5%AF%B9-skills-%E7%9A%84%E6%94%AF%E6%8C%81%E5%92%8C%E9%80%82%E9%85%8D%E8%BF%9B%E5%BA%A6">各大编辑工具对 Skills 的支持和适配进度</a></li>
<li><a href="#4-skills-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E5%92%8C%E7%BB%86%E8%8A%82" title="#4-skills-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E5%92%8C%E7%BB%86%E8%8A%82">Skills 使用技巧和细节</a></li>
<li><a href="#5-openskills-%E4%BD%BF%E7%94%A8%E7%BB%86%E8%8A%82" title="#5-openskills-%E4%BD%BF%E7%94%A8%E7%BB%86%E8%8A%82">OpenSkills 使用细节</a></li>
<li><a href="#6-%E6%9C%AC%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E7%9A%84-skills" title="#6-%E6%9C%AC%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E7%9A%84-skills">本项目开发的 Skills</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">1. Skill 是什么</h3>
<h4 data-id="heading-3">1.1 定义</h4>
<p><strong>Skills（技能）</strong> 是由 <strong>Anthropic</strong> 提出的一个<strong>开放标准（Open Standard）</strong>，用于增强 AI Agent 在特定任务上的能力。Skills 是一种可重用、结构化的知识包，封装了特定领域知识、工作流程、脚本和最佳实践，供 Agent 根据任务需要按需加载，而不是始终包含在上下文中。</p>
<h4 data-id="heading-4">1.2 核心特性</h4>
<ul>
<li>🌐 <strong>开放标准</strong>：由 Anthropic 定义，遵循统一的规范格式</li>
<li>🔄 <strong>跨平台兼容</strong>：可在多个 AI 编程助手间共享（Cursor、Claude Code、Windsurf、Aider 等）</li>
<li>📦 <strong>渐进式加载</strong>：采用"渐进式披露（Progressive Disclosure）"机制，节省上下文窗口</li>
<li>🔧 <strong>可扩展</strong>：支持自定义命令、钩子脚本、领域知识等多种内容类型</li>
<li>🎯 <strong>智能匹配</strong>：Agent 自动扫描技能描述，根据任务相关性匹配技能</li>
</ul>
<h4 data-id="heading-5">1.3 标准结构</h4>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">Anthropic Skills 开放标准</a>，每个 Skill 应该包含以下结构：</p>
<pre><code class="hljs language-bash" lang="bash">skill-name/
├── SKILL.md          <span class="hljs-comment"># 必需：技能定义（YAML front matter + Markdown）</span>
├── scripts/          <span class="hljs-comment"># 可选：脚本文件（自动化任务逻辑）</span>
├── assets/           <span class="hljs-comment"># 可选：资源文件（用于输出的模板、图标、字体等）</span>
└── references/       <span class="hljs-comment"># 可选：文档和参考资料（按需加载）</span>
</code></pre>
<h4 data-id="heading-6">1.4 SKILL.md 格式</h4>
<p><strong>YAML Front Matter</strong>（必需）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">skill-name</span>          <span class="hljs-comment"># 必需：技能名称（kebab-case）</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">技能描述</span>      <span class="hljs-comment"># 必需：技能描述（用于 Agent 匹配任务，应包含具体使用场景）</span>
<span class="hljs-meta">---
</span></code></pre>
<p><strong>Markdown 内容</strong>：</p>
<ul>
<li>技能说明、使用方法、行为定义等</li>
<li>应保持简洁（&lt;500行，推荐&lt;300行）</li>
<li>详细内容放在 <code>references/</code> 中</li>
</ul>
<h4 data-id="heading-7">1.5 渐进式披露原则</h4>
<p>Skills 使用三级加载系统来高效管理上下文：</p>
<ol>
<li><strong>Metadata（name + description）</strong> - 始终在上下文中（~100 词）</li>
<li><strong>SKILL.md body</strong> - 当技能触发时加载（&lt;5k 词，建议 &lt;300 行）</li>
<li><strong>Bundled resources</strong> - 按 Claude 需要时加载（无限制，因为脚本可以执行而不读入上下文窗口）</li>
</ol>
<p><strong>关键原则</strong>：</p>
<ul>
<li>保持 SKILL.md 简洁，只包含核心流程和指导</li>
<li>详细内容移到 <code>references/</code> 文件</li>
<li>使用链接引用详细内容，确保读者知道它们存在以及何时使用</li>
<li>避免深层嵌套引用 - 保持 references 从 SKILL.md 一级深度</li>
</ul>
<hr/>
<h3 data-id="heading-8">2. Skill vs Rules vs BusAgent vs Commands vs MCP 对比</h3>
<h4 data-id="heading-9">2.1 概念对比表</h4>





































































































































<table><thead><tr><th>特性</th><th>Skills（技能）</th><th>Rules（规则）</th><th>BusAgent</th><th>Commands（命令）</th><th>MCP（模型上下文协议）</th></tr></thead><tbody><tr><td><strong>标准/协议</strong></td><td>Anthropic Skills 开放标准</td><td>平台特定（如 Cursor Rules）</td><td>平台特定</td><td>平台特定（Slash Commands）</td><td>Model Context Protocol 开放协议</td></tr><tr><td><strong>核心作用</strong></td><td>教 Agent <strong>如何做</strong>，提供知识、流程、判断、风格</td><td>对 Agent 输出/行为的静态约束或规范</td><td>业务代理，封装业务逻辑</td><td>简单的 prompt 模板，快速执行特定行为</td><td>给 Agent <strong>能做什么动作</strong>，访问外部系统/数据/工具</td></tr><tr><td><strong>执行能力</strong></td><td>本身不直接执行外部动作（除非 Skill 内含脚本并被执行）</td><td>没有执行外部工具能力，仅约束文本/输出内容</td><td>可执行业务逻辑和外部调用</td><td>无执行能力，仅提供 prompt 模板</td><td>本质是执行动作/调用外部逻辑</td></tr><tr><td><strong>文件结构</strong></td><td>目录形式：<code>SKILL.md</code> + 脚本/模板/资源</td><td><code>.mdc</code> 或 <code>.md</code> 文件</td><td>配置文件或代码</td><td>单个 Markdown 文件</td><td>JSON 配置</td></tr><tr><td><strong>加载方式</strong></td><td>渐进式加载（按需，扫描名称和描述后决定）</td><td>静态加载（总是或按规则）</td><td>按需加载</td><td>手动显式调用（用户输入 <code>/command</code>）</td><td>按需调用外部服务</td></tr><tr><td><strong>上下文消耗</strong></td><td>低（渐进式披露，仅在需要时载入）</td><td>中等（常驻文本，可能消耗较多 Token）</td><td>中等（按需加载）</td><td>低（仅在调用时加载）</td><td>工具描述占用部分，工具调用开销较大</td></tr><tr><td><strong>自动发现</strong></td><td>✅ 支持（Agent 扫描匹配）</td><td>✅ 支持（自动包含）</td><td>✅ 支持（按需匹配）</td><td>❌ 不支持（需显式调用）</td><td>✅ 支持（按需调用）</td></tr><tr><td><strong>使用场景</strong></td><td>特定任务的专业能力、工作流程、领域知识</td><td>编码规范、团队标准、全局规则</td><td>业务场景封装、复杂业务流程</td><td>快速简短、频繁重用的命令</td><td>访问外部数据源、执行外部工具、查询数据库</td></tr><tr><td><strong>存放位置</strong></td><td><code>.agent/skills/</code>（通用）或 <code>.claude/skills/</code></td><td><code>.cursor/rules/*.mdc</code> 或 <code>AGENTS.md</code></td><td>平台特定目录</td><td><code>.claude/commands/</code> 或 <code>.cursor/commands/</code></td><td><code>.cursor/mcp.json</code> 或 <code>~/.cursor/mcp.json</code></td></tr><tr><td><strong>文件格式</strong></td><td><code>SKILL.md</code>（YAML front matter + Markdown，标准格式）</td><td><code>.mdc</code> 或 <code>.md</code>（平台特定）</td><td>配置文件或代码</td><td><code>.md</code>（简单 Markdown，无特殊格式要求）</td><td>JSON 配置</td></tr><tr><td><strong>触发方式</strong></td><td>Agent 扫描匹配或 <code>/skill-name</code> 命令</td><td>自动包含或按匹配规则</td><td>按业务场景匹配</td><td>用户显式输入 <code>/command-name</code></td><td>Agent 需要时调用</td></tr><tr><td><strong>可移植性</strong></td><td>高（开放标准，跨平台兼容）</td><td>较有限（平台专有格式）</td><td>较有限（平台专有）</td><td>较有限（平台专有，但格式简单）</td><td>较好（协议标准，但不同 Agent 支持程度可能不同）</td></tr><tr><td><strong>创建难度</strong></td><td>中等（需要 SKILL.md + 可选脚本/资源）</td><td>最基础（创建门槛低）</td><td>较高（需要业务逻辑设计）</td><td>低（只需一个 Markdown 文件）</td><td>较高（需搭建 server、定义 schema、权限、安全、认证等）</td></tr><tr><td><strong>安全性</strong></td><td>如果 Skill 中含脚本，有代码执行权限，需要谨慎信任来源</td><td>相对安全（只包含文本规则，没有执行外部代码）</td><td>中等（可执行业务逻辑）</td><td>相对安全（仅文本 prompt，无脚本执行）</td><td>动作调用本身含有安全性风险，权限控制必需</td></tr><tr><td><strong>复杂度支持</strong></td><td>高（支持多文件、脚本、复杂流程）</td><td>低（静态规则）</td><td>高（支持复杂业务逻辑）</td><td>低（简单 prompt 模板）</td><td>高（可连接复杂外部系统）</td></tr></tbody></table>
<h4 data-id="heading-10">2.2 详细对比</h4>
<h5 data-id="heading-11">Skills（技能）- Anthropic 开放标准</h5>
<p><strong>定义</strong>：Skills 是由 Anthropic 定义的开放标准，用于封装复杂的能力包，包含 <code>SKILL.md</code> 文件以及可选的脚本、模板、参考资料等资源。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ <strong>开放标准</strong>：遵循 Anthropic Skills 规范，跨平台兼容</li>
<li>✅ <strong>节省上下文</strong>：渐进式加载机制，只在需要时加载</li>
<li>✅ <strong>灵活性强</strong>：可以根据任务动态选择使用</li>
<li>✅ <strong>可复用</strong>：一次定义，可在多个项目、多个 Agent 平台间共享</li>
<li>✅ <strong>模块化</strong>：每个技能专注一个功能领域，职责清晰</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>代码审查、测试生成、文档生成等特定任务</li>
<li>需要复杂工作流程的场景</li>
<li>团队共享的专业知识和最佳实践</li>
<li>跨项目、跨平台的知识复用</li>
</ul>
<h5 data-id="heading-12">Rules（规则）</h5>
<p><strong>定义</strong>：Rules 是对 Agent 输出/行为的静态约束或规范，通常以 <code>.mdc</code> 或 <code>.md</code> 文件形式存在。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 持续生效：始终包含在上下文中</li>
<li>✅ 稳定性高：功能成熟，广泛使用</li>
<li>✅ 自动应用：无需手动触发</li>
</ul>
<p><strong>劣势</strong>：</p>
<ul>
<li>⚠️ 占用上下文：始终加载，可能占用较多 token</li>
<li>⚠️ 不够灵活：所有对话都会包含，即使不相关</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>编码规范、命名约定</li>
<li>项目结构说明</li>
<li>团队工作流程</li>
<li>需要持续指导的规则</li>
</ul>
<h5 data-id="heading-13">BusAgent（业务代理）</h5>
<p><strong>定义</strong>：BusAgent 是平台特定的业务代理机制，用于封装业务逻辑和复杂业务流程。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 业务逻辑封装：可以封装复杂的业务场景</li>
<li>✅ 可执行：可以执行业务逻辑和外部调用</li>
</ul>
<p><strong>劣势</strong>：</p>
<ul>
<li>⚠️ 平台特定：不同平台实现不同</li>
<li>⚠️ 复杂度高：需要业务逻辑设计</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>复杂业务流程封装</li>
<li>业务场景自动化</li>
<li>平台特定的业务逻辑</li>
</ul>
<h5 data-id="heading-14">Commands（命令）- Slash Commands</h5>
<p><strong>定义</strong>：Commands（也称为 Slash Commands）是简单的 prompt 模板，通常是一个 Markdown 文件，用于快速执行特定行为。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ <strong>简单快速</strong>：只需一个 Markdown 文件，编辑方便</li>
<li>✅ <strong>可控性强</strong>：用户明确触发，行为可预测</li>
<li>✅ <strong>安全性好</strong>：内容简单，无复杂依赖，审查容易</li>
</ul>
<p><strong>劣势</strong>：</p>
<ul>
<li>⚠️ <strong>灵活性低</strong>：不支持复杂流程、多个文件、标准化资源</li>
<li>⚠️ <strong>自动化能力差</strong>：需要用户每次明确调用，不能基于上下文自动匹配</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>快速简短、频繁重用的命令</li>
<li>简单的 prompt 模板，如 <code>/review code</code>、<code>/optimize</code></li>
<li>不需要复杂脚本或流程的行为</li>
</ul>
<h5 data-id="heading-15">MCP（Model Context Protocol）</h5>
<p><strong>定义</strong>：MCP 是 Model Context Protocol 的缩写，是一个开放协议，用于连接外部系统、获取实时数据、执行外部工具。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 连接外部系统：可以访问数据库、API、文件系统等</li>
<li>✅ 实时数据：获取最新的外部数据</li>
<li>✅ 工具集成：可以调用外部工具和脚本</li>
</ul>
<p><strong>劣势</strong>：</p>
<ul>
<li>⚠️ 需要配置：需要设置 MCP 服务器</li>
<li>⚠️ 依赖外部：需要外部系统可用</li>
<li>⚠️ 性能考虑：网络调用可能较慢</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>访问数据库查询数据</li>
<li>调用外部 API</li>
<li>执行系统命令</li>
<li>读取文件系统</li>
</ul>
<h4 data-id="heading-16">2.3 融合趋势</h4>
<p><strong>重要更新</strong>：在 Claude Code 2.1.3+ 版本中，Anthropic 正在<strong>合并</strong> Commands 和 Skills，将两者视为同一种能力单元，主要区别仅在"调用方式"（显式 vs 自动触发）。</p>
<p><strong>合并后的特点</strong>：</p>
<ul>
<li>无论是 <code>.claude/commands/</code> 还是 <code>.claude/skills/</code> 中的内容，从系统角度看都是 Skill</li>
<li>可以通过 Settings 或 frontmatter 设定是否允许自动触发</li>
<li>支持 <code>user-invocable</code>、<code>disable-model-invocation</code> 等设置</li>
</ul>
<p><strong>建议</strong>：</p>
<ul>
<li>新项目建议直接使用 Skills 标准格式</li>
<li>简单命令可以创建为 Skill，但设置 <code>disable-model-invocation: true</code> 仅允许手动调用</li>
<li>复杂工作流使用完整的 Skills 结构，支持自动发现</li>
</ul>
<h4 data-id="heading-17">2.4 使用建议</h4>
<p><strong>组合使用</strong>（最佳实践）：</p>
<ul>
<li><strong>Rules</strong>：放置编码规范、架构约束等静态规则（平台特定）</li>
<li><strong>Commands</strong>：放置简单、频繁重用的快捷命令（平台特定，或迁移到 Skills）</li>
<li><strong>Skills</strong>：放置可执行的工作流、特定领域的动态知识（跨平台标准，推荐）</li>
<li><strong>MCP</strong>：连接外部系统，获取实时数据（开放协议）</li>
<li><strong>BusAgent</strong>：封装复杂业务逻辑（平台特定）</li>
</ul>
<p><strong>最强组合</strong>：Skills + MCP + Rules 并用</p>
<ul>
<li><strong>Skills</strong> 提供<strong>何时做什么</strong>以及<strong>如何做</strong>的知识</li>
<li><strong>MCP</strong> 提供<strong>能做什么动作</strong>的能力</li>
<li><strong>Rules</strong> 提供<strong>必须遵循</strong>的约束和规范</li>
<li><strong>Commands</strong> 提供<strong>快速执行</strong>的简单命令（可选，建议迁移到 Skills）</li>
<li><strong>BusAgent</strong> 提供<strong>业务逻辑封装</strong>（平台特定）</li>
</ul>
<hr/>
<h3 data-id="heading-18">3. 各大编辑工具对 Skills 的支持和适配进度</h3>
<h4 data-id="heading-19">3.1 适配情况总览</h4>











































































<table><thead><tr><th>工具/平台</th><th>支持状态</th><th>支持类型</th><th>使用方式</th><th>限制与注意事项</th></tr></thead><tbody><tr><td><strong>Claude Code</strong></td><td>✅ <strong>完全支持</strong></td><td>原生支持 Anthropic Skills 标准</td><td>文件系统目录结构（<code>.claude/skills/</code> 或 <code>.agent/skills/</code>）</td><td>自动触发机制依赖技能描述质量</td></tr><tr><td><strong>Claude.ai（Web）</strong></td><td>✅ <strong>完全支持</strong></td><td>预构建 Skills + 自定义 Skills</td><td>设置中启用，上传 ZIP 或使用 Partner Skills</td><td>需开启 Code Execution 权限</td></tr><tr><td><strong>Claude API</strong></td><td>✅ <strong>完全支持</strong></td><td>通过 API 管理 Skills</td><td><code>/v1/skills</code> 端点上传管理</td><td>需要 API 密钥和相应权限</td></tr><tr><td><strong>Cursor</strong></td><td>⚠️ <strong>Beta/Nightly</strong></td><td>通过 OpenSkills 和 AGENTS.md</td><td>使用 OpenSkills CLI 同步到 <code>.cursor/rules/AGENTS.md</code></td><td>功能尚未完全稳定，自动触发不保证</td></tr><tr><td><strong>Windsurf</strong></td><td>✅ <strong>支持</strong></td><td>原生支持 Anthropic Skills 标准</td><td>类似 Claude Code 的文件系统结构</td><td>社区反馈较少，功能相对稳定</td></tr><tr><td><strong>Aider</strong></td><td>✅ <strong>支持</strong></td><td>原生支持 Anthropic Skills 标准</td><td>文件系统目录结构</td><td>支持自动发现和手动调用</td></tr><tr><td><strong>VS Code（GitHub Copilot）</strong></td><td>✅ <strong>已集成</strong></td><td>通过 Microsoft 集成</td><td>在 VS Code 中定义 Skills</td><td>需要 GitHub Copilot 订阅</td></tr><tr><td><strong>OpenAI Codex CLI</strong></td><td>✅ <strong>部分支持</strong></td><td>Skills 框架（类似 Anthropic）</td><td><code>~/.codex/skills/</code> 目录</td><td>格式与 Anthropic 高度一致，但功能较新</td></tr><tr><td><strong>ChatGPT</strong></td><td>✅ <strong>部分支持</strong></td><td>Code Interpreter 预置 + 自定义</td><td>通过设置上传 Skills</td><td>触发机制不如 Claude 稳定</td></tr></tbody></table>
<h4 data-id="heading-20">3.2 Claude Code 详细支持情况</h4>
<p><strong>Claude Code</strong> 是 Anthropic 官方开发的 AI 编程助手，对 Skills 标准提供<strong>最完整和原生</strong>的支持。</p>
<p><strong>支持的功能</strong>：</p>
<ul>
<li>✅ <strong>自动发现</strong>：Agent 自动扫描技能目录，根据任务相关性匹配技能</li>
<li>✅ <strong>自动触发</strong>：当任务匹配技能描述时，自动加载技能内容</li>
<li>✅ <strong>手动调用</strong>：支持通过 <code>/skill-name</code> 命令手动触发</li>
<li>✅ <strong>目录结构</strong>：支持 <code>.claude/skills/</code> 和 <code>.agent/skills/</code> 目录</li>
<li>✅ <strong>完整格式</strong>：支持 SKILL.md + 脚本 + 模板 + 资源的完整结构</li>
<li>✅ <strong>组织级管理</strong>：支持团队共享和组织级 Skills</li>
</ul>
<p><strong>使用方式</strong>：</p>
<ul>
<li><strong>项目级 Skills</strong>：<code>项目根目录/.claude/skills/</code> 或 <code>.agent/skills/</code></li>
<li><strong>全局 Skills</strong>：<code>~/.claude/skills/</code> 或 <code>~/.agent/skills/</code></li>
</ul>
<h4 data-id="heading-21">3.3 Cursor 支持情况</h4>
<p><strong>支持程度</strong>：⚠️ <strong>Beta/Nightly 阶段，功能尚未完全稳定</strong></p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>通过 <strong>OpenSkills CLI</strong> 工具管理技能</li>
<li>使用 <strong>AGENTS.md</strong> 文件让 Agent 发现可用技能</li>
<li>Agent 通过 <code>openskills read</code> 命令加载技能内容</li>
</ul>
<p><strong>使用流程</strong>：</p>
<ol>
<li><strong>安装技能</strong>：使用 OpenSkills 安装到 <code>.agent/skills/</code> 目录</li>
<li><strong>同步到 AGENTS.md</strong>：执行 <code>openskills sync -o .cursor/rules/AGENTS.md</code></li>
<li><strong>Agent 发现</strong>：Cursor Agent 读取 AGENTS.md 中的技能列表</li>
<li><strong>技能加载</strong>：Agent 执行 <code>openskills read &lt;skill-name&gt;</code> 加载技能</li>
</ol>
<p><strong>限制与注意事项</strong>：</p>
<ul>
<li>⚠️ <strong>自动触发不稳定</strong>：Agent 可能不会自动识别和使用技能</li>
<li>⚠️ <strong>需要手动提示</strong>：建议在任务中明确提到技能名称</li>
<li>⚠️ <strong>Nightly 版本</strong>：需要切换到 Cursor Nightly 渠道</li>
<li>⚠️ <strong>权限问题</strong>：使用 <code>openskills</code> 而非 <code>npx openskills</code> 避免权限错误</li>
</ul>
<h4 data-id="heading-22">3.4 其他工具支持情况</h4>
<h5 data-id="heading-23">Windsurf</h5>
<ul>
<li>✅ <strong>原生支持</strong>：原生支持 Anthropic Skills 标准</li>
<li>✅ <strong>自动发现</strong>：支持自动发现和手动调用</li>
<li>✅ <strong>文件系统结构</strong>：类似 Claude Code 的文件系统结构</li>
</ul>
<h5 data-id="heading-24">Aider</h5>
<ul>
<li>✅ <strong>原生支持</strong>：原生支持 Anthropic Skills 标准</li>
<li>✅ <strong>自动发现</strong>：支持自动发现和手动调用</li>
<li>✅ <strong>目录结构</strong>：支持 <code>.aider/skills/</code> 目录</li>
</ul>
<h5 data-id="heading-25">VS Code（GitHub Copilot）</h5>
<ul>
<li>✅ <strong>已集成</strong>：Microsoft 在 Anthropic 宣布开放标准后迅速集成</li>
<li>⚠️ <strong>需要订阅</strong>：需要 GitHub Copilot 订阅</li>
<li>✅ <strong>在 VS Code 中定义</strong>：支持在 VS Code 中定义和使用 Skills</li>
</ul>
<h4 data-id="heading-26">3.5 时间线与标准化进程</h4>
<h5 data-id="heading-27">关键时间节点</h5>



































<table><thead><tr><th>时间</th><th>事件</th><th>影响</th></tr></thead><tbody><tr><td><strong>2025 年 10 月中旬</strong></td><td>Anthropic 正式在 Claude 中推出 Agent Skills 功能</td><td>首次公开发布 Skills 概念</td></tr><tr><td><strong>2025 年 12 月 18 日</strong></td><td>Anthropic 将 Agent Skills 发布为<strong>开放标准</strong>（agent-skills.io）</td><td>标准化进程，Microsoft、OpenAI 等迅速集成</td></tr><tr><td><strong>Claude Code v2.1.1</strong></td><td>开始合并 Commands 和 Skills</td><td>统一底层工具</td></tr><tr><td><strong>Claude Code v2.1.3</strong></td><td>Commands 和 Skills 完全合并</td><td>用户可见的融合完成</td></tr><tr><td><strong>2026 年 1 月</strong></td><td>多个平台宣布支持或正在集成</td><td>生态逐步完善</td></tr></tbody></table>
<h5 data-id="heading-28">标准化影响</h5>
<p><strong>开放标准发布后的影响</strong>：</p>
<ul>
<li>✅ <strong>Microsoft</strong>：在 VS Code 和 GitHub 中迅速集成</li>
<li>✅ <strong>OpenAI</strong>：在 ChatGPT 和 Codex CLI 中开始支持</li>
<li>✅ <strong>第三方工具</strong>：Cursor、Windsurf、Aider 等逐步支持</li>
<li>✅ <strong>企业工具</strong>：Notion、Figma、Atlassian 等提供 Partner Skills</li>
</ul>
<hr/>
<h3 data-id="heading-29">4. Skills 使用技巧和细节</h3>
<h4 data-id="heading-30">4.1 技能描述优化技巧</h4>
<p><strong>关键原则</strong>：技能描述是 Agent 决定是否使用技能的主要依据，必须清晰、具体、包含使用场景。</p>
<h5 data-id="heading-31">好的描述示例</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">java-rest-api-design</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">生成符合主流规范的</span> <span class="hljs-string">Java</span> <span class="hljs-string">RESTful</span> <span class="hljs-string">API</span> <span class="hljs-string">接口设计，包括</span> <span class="hljs-string">Controller、DTO、统一响应格式、异常处理等。使用场景：(1)</span> <span class="hljs-string">创建新的</span> <span class="hljs-string">REST</span> <span class="hljs-string">API</span> <span class="hljs-string">接口，(2)</span> <span class="hljs-string">设计</span> <span class="hljs-string">Controller</span> <span class="hljs-string">层代码，(3)</span> <span class="hljs-string">生成</span> <span class="hljs-string">API</span> <span class="hljs-string">相关的</span> <span class="hljs-string">DTO</span> <span class="hljs-string">类，(4)</span> <span class="hljs-string">审查或优化现有</span> <span class="hljs-string">API</span> <span class="hljs-string">设计，(5)</span> <span class="hljs-string">需要遵循</span> <span class="hljs-string">Spring</span> <span class="hljs-string">Boot</span> <span class="hljs-string">最佳实践和</span> <span class="hljs-string">RESTful</span> <span class="hljs-string">规范时</span>
<span class="hljs-meta">---
</span></code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 明确说明技能功能</li>
<li>✅ 列出具体使用场景</li>
<li>✅ 包含关键词（REST API、Controller、DTO、Spring Boot）</li>
<li>✅ 描述长度适中（100-200 词）</li>
</ul>
<h5 data-id="heading-32">不好的描述示例</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">java-api</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">生成</span> <span class="hljs-string">API</span> <span class="hljs-string">代码</span>
<span class="hljs-meta">---
</span></code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>❌ 描述过于简单，缺少使用场景</li>
<li>❌ 关键词不够具体</li>
<li>❌ Agent 难以判断何时使用</li>
</ul>
<h4 data-id="heading-33">4.2 SKILL.md 内容组织技巧</h4>
<h5 data-id="heading-34">保持简洁</h5>
<p><strong>原则</strong>：SKILL.md 应保持简洁（&lt;500行，推荐&lt;300行），只包含核心流程和指导。</p>
<p><strong>好的结构</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Skill 名称</span>

<span class="hljs-section">## 快速开始</span>
核心流程和步骤...

<span class="hljs-section">## 详细参考</span>
<span class="hljs-bullet">-</span> 详细内容见 [<span class="hljs-string">references/xxx.md</span>](<span class="hljs-link">references/xxx.md</span>)
<span class="hljs-bullet">-</span> 代码模板见 <span class="hljs-code">`assets/xxx.java`</span>
</code></pre>
<h5 data-id="heading-35">使用链接引用</h5>
<p><strong>原则</strong>：详细内容放在 <code>references/</code> 中，SKILL.md 中使用链接引用。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 详细参考</span>

<span class="hljs-bullet">-</span> <span class="hljs-strong">**RESTful 模式**</span>：见 [<span class="hljs-string">references/restful-patterns.md</span>](<span class="hljs-link">references/restful-patterns.md</span>)
<span class="hljs-bullet">-</span> <span class="hljs-strong">**DTO 模式**</span>：见 [<span class="hljs-string">references/dto-patterns.md</span>](<span class="hljs-link">references/dto-patterns.md</span>)
<span class="hljs-bullet">-</span> <span class="hljs-strong">**代码模板**</span>：见 <span class="hljs-code">`assets/ControllerTemplate.java`</span>
</code></pre>
<h4 data-id="heading-36">4.3 目录结构最佳实践</h4>
<h5 data-id="heading-37">标准目录结构</h5>
<pre><code class="hljs language-bash" lang="bash">skill-name/
├── SKILL.md          <span class="hljs-comment"># 必需：技能定义（简洁，&lt;300行）</span>
├── scripts/          <span class="hljs-comment"># 可选：可执行脚本</span>
├── assets/           <span class="hljs-comment"># 可选：用于输出的模板、图标等</span>
└── references/       <span class="hljs-comment"># 可选：按需加载的文档和参考资料</span>
</code></pre>
<h5 data-id="heading-38">目录用途说明</h5>
<ul>
<li><strong>SKILL.md</strong>：核心定义，应保持简洁</li>
<li><strong>scripts/</strong>：可执行脚本，用于自动化任务</li>
<li><strong>assets/</strong>：不加载到上下文，用于输出的文件（模板、图标等）</li>
<li><strong>references/</strong>：按需加载的文档和参考资料</li>
</ul>
<h4 data-id="heading-39">4.4 触发技巧</h4>
<h5 data-id="heading-40">自然语言触发（推荐）</h5>
<p><strong>方式</strong>：在任务描述中使用技能相关的关键词。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户：为用户管理创建 <span class="hljs-attribute">REST</span> API 接口

Agent：
<span class="hljs-number">1</span>. 识别到需要"<span class="hljs-attribute">REST</span> API 设计"任务
<span class="hljs-number">2</span>. 在 AGENTS<span class="hljs-selector-class">.md</span> 中找到 java-<span class="hljs-attribute">rest</span>-api-design 技能
<span class="hljs-number">3</span>. 执行：openskills read java-<span class="hljs-attribute">rest</span>-api-design
<span class="hljs-number">4</span>. 按照技能定义生成 Controller 和 DTO 代码
</code></pre>
<h5 data-id="heading-41">明确指定技能</h5>
<p><strong>方式</strong>：在任务中明确提到技能名称。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户：使用 java-<span class="hljs-attribute">rest</span>-api-design 技能为用户管理创建 <span class="hljs-attribute">REST</span> API
</code></pre>
<h5 data-id="heading-42">使用命令触发</h5>
<p><strong>方式</strong>：使用 <code>/skill-name</code> 命令手动触发。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户：/java-<span class="hljs-attribute">rest</span>-api-design 为用户管理创建 <span class="hljs-attribute">REST</span> API
</code></pre>
<h4 data-id="heading-43">4.5 调试技巧</h4>
<h5 data-id="heading-44">验证技能是否被使用</h5>
<p><strong>方法 1：观察 Agent 响应</strong></p>
<ul>
<li>如果 Agent 使用了技能，应该提到技能名称</li>
<li>展示技能加载过程</li>
<li>按照技能定义的格式输出</li>
</ul>
<p><strong>方法 2：查看执行日志</strong></p>
<ul>
<li>如果 Agent 执行了 <code>openskills read</code>，应该能看到命令执行记录</li>
<li>技能内容加载过程</li>
</ul>
<p><strong>方法 3：对比输出格式</strong></p>
<ul>
<li>如果 Agent 使用了技能，输出应该符合技能定义的格式</li>
</ul>
<h5 data-id="heading-45">常见问题排查</h5>
<p><strong>问题 1：技能没有被自动触发</strong></p>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>优化技能描述</strong>：在 YAML front matter 的 <code>description</code> 字段中使用具体、明确的关键词</li>
<li><strong>使用 forced eval hook</strong>：在技能中添加评估机制，强制 Agent 评估每个技能是否匹配</li>
<li><strong>手动提示</strong>：在任务中明确提到技能名称或相关关键词</li>
</ol>
<p><strong>问题 2：技能描述没有同步到 AGENTS.md</strong></p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>确保 SKILL.md 文件包含 YAML front matter</li>
<li>确保 <code>name</code> 和 <code>description</code> 字段存在</li>
<li>重新执行 <code>openskills sync</code></li>
</ul>
<p><strong>问题 3：技能内容加载失败</strong></p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>检查技能文件路径是否正确</li>
<li>确保 <code>openskills</code> 命令可用</li>
<li>检查权限问题</li>
</ul>
<hr/>
<h3 data-id="heading-46">5. OpenSkills 使用细节</h3>
<h4 data-id="heading-47">5.1 什么是 OpenSkills</h4>
<p><strong>OpenSkills</strong> 是一个由社区开发的开源 CLI 工具，用于管理和使用遵循 <strong>Anthropic Skills 标准</strong>的技能。它将 Anthropic 定义的 Skills 开放标准扩展到任何支持的 AI 编程代理中（Cursor、Claude Code、Windsurf、Aider 等）。</p>
<p><strong>核心价值</strong>：</p>
<ul>
<li>🔧 提供统一的技能管理接口</li>
<li>📦 支持从 Anthropic 官方市场、GitHub 仓库、本地路径安装技能</li>
<li>🔄 自动同步技能信息到 <code>AGENTS.md</code>，供 Agent 发现和使用</li>
<li>🌐 支持多种安装模式（项目级、全局、通用），适配不同使用场景</li>
</ul>
<h4 data-id="heading-48">5.2 安装 OpenSkills</h4>
<h5 data-id="heading-49">前置要求</h5>
<ul>
<li>Node.js ≥ v20.6</li>
<li>Git（用于从 GitHub 安装技能）</li>
</ul>
<h5 data-id="heading-50">安装步骤</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局安装 OpenSkills CLI</span>
npm install -g openskills

<span class="hljs-comment"># 验证安装</span>
openskills --version
</code></pre>
<h4 data-id="heading-51">5.3 核心功能</h4>
<h5 data-id="heading-52">1. 安装技能（Install）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从 Anthropic 官方市场安装所有技能</span>
openskills install anthropics/skills

<span class="hljs-comment"># 从 GitHub 仓库安装特定技能</span>
openskills install username/repo-name

<span class="hljs-comment"># 从本地路径安装</span>
openskills install ./local-skill-path

<span class="hljs-comment"># 安装到通用目录（多 Agent 共享，推荐）</span>
openskills install anthropics/skills --universal

<span class="hljs-comment"># 全局安装（所有项目共享）</span>
openskills install anthropics/skills --global

<span class="hljs-comment"># 跳过确认提示（适合 CI/CD）</span>
openskills install anthropics/skills --<span class="hljs-built_in">yes</span>
</code></pre>
<p><strong>⚠️ 重要：工作目录要求</strong></p>
<ul>
<li><strong>项目级和通用模式</strong>：必须在项目根目录执行</li>
<li><strong>全局模式</strong>：可以在任何目录执行</li>
</ul>
<h5 data-id="heading-53">2. 列出已安装技能（List）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出当前项目的技能</span>
openskills list

<span class="hljs-comment"># 列出全局技能</span>
openskills list --global

<span class="hljs-comment"># 列出通用技能</span>
openskills list --universal
</code></pre>
<h5 data-id="heading-54">3. 同步技能到 AGENTS.md（Sync）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 同步到默认位置</span>
openskills <span class="hljs-built_in">sync</span>

<span class="hljs-comment"># 同步到指定路径（推荐）</span>
openskills <span class="hljs-built_in">sync</span> -o .cursor/rules/AGENTS.md

<span class="hljs-comment"># 同步到通用位置</span>
openskills <span class="hljs-built_in">sync</span> --universal

<span class="hljs-comment"># 跳过确认提示</span>
openskills <span class="hljs-built_in">sync</span> --<span class="hljs-built_in">yes</span>
</code></pre>
<p><strong>生成的 AGENTS.md 格式</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">available_skills</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>java-rest-api-design<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>生成符合主流规范的 Java RESTful API 接口设计...<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">location</span>&gt;</span>project<span class="hljs-tag">&lt;/<span class="hljs-name">location</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">available_skills</span>&gt;</span>
</code></pre>
<h5 data-id="heading-55">4. 读取技能内容（Read）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 读取技能内容</span>
openskills <span class="hljs-built_in">read</span> java-rest-api-design

<span class="hljs-comment"># 读取多个技能</span>
openskills <span class="hljs-built_in">read</span> skill-one,skill-two
</code></pre>
<h5 data-id="heading-56">5. 删除技能（Remove）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除指定技能</span>
openskills remove &lt;skill-name&gt;

<span class="hljs-comment"># 交互式管理（批量删除）</span>
openskills manage
</code></pre>
<h4 data-id="heading-57">5.4 安装模式详解</h4>

































<table><thead><tr><th>模式</th><th>命令参数</th><th>安装位置</th><th>需要项目目录</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>项目级</strong></td><td>无参数（默认）</td><td><code>项目目录/.claude/skills/</code></td><td>✅ 是</td><td>项目特定技能</td></tr><tr><td><strong>全局</strong></td><td><code>--global</code></td><td><code>~/.claude/skills/</code></td><td>❌ 否</td><td>所有项目共享</td></tr><tr><td><strong>通用</strong></td><td><code>--universal</code></td><td><code>项目目录/.agent/skills/</code> 或 <code>~/.agent/skills/</code></td><td>✅ 是</td><td>多 Agent 共享（推荐）</td></tr></tbody></table>
<h4 data-id="heading-58">5.5 目录识别规则</h4>
<p><strong>OpenSkills 只识别以下目录</strong>：</p>
<ul>
<li>✅ <code>.claude/skills/</code> - Claude 生态技能目录</li>
<li>✅ <code>.agent/skills/</code> - 通用技能目录（推荐）</li>
<li>❌ <code>.cursor/skills/</code> - <strong>不被 OpenSkills 识别</strong></li>
</ul>
<p><strong>目录查找优先级</strong>（从高到低）：</p>
<ol>
<li><code>./.agent/skills/</code> - 当前项目的通用技能</li>
<li><code>~/.agent/skills/</code> - 全局通用技能</li>
<li><code>./.claude/skills/</code> - 当前项目的 Claude 技能</li>
<li><code>~/.claude/skills/</code> - 全局 Claude 技能</li>
</ol>
<h4 data-id="heading-59">5.6 常见问题</h4>
<h5 data-id="heading-60">Q1: 为什么描述没有同步到 AGENTS.md？</h5>
<p><strong>A</strong>: SKILL.md 文件缺少 YAML front matter。需要在文件开头添加：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">skill-name</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">技能描述（应包含具体使用场景，如：使用场景：(1)</span> <span class="hljs-string">xxx，(2)</span> <span class="hljs-string">xxx）</span>
<span class="hljs-meta">---
</span></code></pre>
<p><strong>注意</strong>：根据 Anthropic Skills 规范，frontmatter 只包含 <code>name</code> 和 <code>description</code>，不需要 <code>version</code> 和 <code>tags</code>。</p>
<h5 data-id="heading-61">Q2: 为什么 <code>openskills list</code> 显示没有技能？</h5>
<p><strong>A</strong>: 检查技能是否在正确的目录：</p>
<ul>
<li>确保在项目根目录执行</li>
<li>检查 <code>.agent/skills/</code> 或 <code>.claude/skills/</code> 目录</li>
<li>确保 SKILL.md 文件存在</li>
</ul>
<h5 data-id="heading-62">Q3: 为什么 <code>npx openskills</code> 报权限错误？</h5>
<p><strong>A</strong>: 使用全局安装的 <code>openskills</code> 命令，而不是 <code>npx openskills</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ✅ 正确</span>
openskills <span class="hljs-built_in">read</span> java-rest-api-design

<span class="hljs-comment"># ❌ 错误（可能权限问题）</span>
npx openskills <span class="hljs-built_in">read</span> java-rest-api-design
</code></pre>
<hr/>
<h3 data-id="heading-63">6. 本项目开发的 Skills</h3>
<h4 data-id="heading-64">6.1 项目介绍</h4>
<p>本项目提供了一套完整的 <strong>Java 后端开发 Skills</strong>，基于主流后端开发规范和 Spring Boot 最佳实践，帮助开发者快速生成符合规范的代码。</p>
<p><strong>GitHub 地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flambert0529%2Fskills.git" target="_blank" title="https://github.com/lambert0529/skills.git" ref="nofollow noopener noreferrer">github.com/lambert0529…</a></p>
<p><strong>Gitee 地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flbl_lambert%2Fskills.git" target="_blank" title="https://gitee.com/lbl_lambert/skills.git" ref="nofollow noopener noreferrer">gitee.com/lbl_lambert…</a></p>
<h4 data-id="heading-65">6.2 Skills 列表</h4>
<p>本项目已创建了以下 7 个 Java 后端开发 Skills：</p>
<h5 data-id="heading-66">1. <strong>java-rest-api-design</strong> - RESTful API 设计规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>生成符合规范的 RESTful API 接口</li>
<li>创建 Controller 层代码</li>
<li>生成 API 相关的 DTO 类</li>
<li>遵循 Spring Boot 最佳实践和 RESTful 规范</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>创建新的 REST API 接口</li>
<li>设计 Controller 层代码</li>
<li>生成 API 相关的 DTO 类</li>
<li>审查或优化现有 API 设计</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">java-<span class="hljs-attribute">rest</span>-api-design/
├── SKILL<span class="hljs-selector-class">.md</span> (<span class="hljs-number">82</span> 行)
├── assets/
│   ├── ControllerTemplate<span class="hljs-selector-class">.java</span>
│   └── CreateRequestTemplate<span class="hljs-selector-class">.java</span>
└── references/
    ├── restful-patterns<span class="hljs-selector-class">.md</span>
    ├── dto-patterns<span class="hljs-selector-class">.md</span>
    └── example-usage<span class="hljs-selector-class">.md</span>
</code></pre>
<h5 data-id="heading-67">2. <strong>java-service-layer</strong> - Service 层开发规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>生成 Service 接口和实现类</li>
<li>实现业务逻辑和事务管理</li>
<li>遵循分层架构最佳实践</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>创建新的 Service 层代码</li>
<li>实现业务逻辑处理</li>
<li>设计 Service 接口</li>
<li>优化现有 Service 代码</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">java-service-layer/
├── SKILL.md (88 行)
├── assets/
│   ├── ServiceInterfaceTemplate.java
│   └── ServiceImplTemplate.java
└── references/
<span class="hljs-code">    ├── transaction-management.md
    └── business-logic-patterns.md
</span></code></pre>
<h5 data-id="heading-68">3. <strong>java-exception-handling</strong> - 异常处理规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>设计全局异常处理器</li>
<li>定义错误码和异常类</li>
<li>统一异常响应格式</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>设计异常处理机制</li>
<li>创建自定义异常类</li>
<li>实现全局异常处理器</li>
<li>定义错误码体系</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-css" lang="css">java-exception-handling/
├── SKILL<span class="hljs-selector-class">.md</span> (<span class="hljs-number">86</span> 行)
├── assets/
│   ├── GlobalExceptionHandlerTemplate<span class="hljs-selector-class">.java</span>
│   └── ErrorCodeExample<span class="hljs-selector-class">.java</span>
└── references/
    ├── exception-classes<span class="hljs-selector-class">.md</span>
    └── error-<span class="hljs-selector-tag">code</span>-definition<span class="hljs-selector-class">.md</span>
</code></pre>
<h5 data-id="heading-69">4. <strong>java-validation</strong> - 参数校验规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>为请求参数添加校验注解</li>
<li>创建自定义校验器</li>
<li>实现分组校验</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>为创建用户请求添加参数校验</li>
<li>创建自定义校验器</li>
<li>实现分组校验</li>
<li>优化现有校验逻辑</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">java<span class="hljs-operator">-</span>validation<span class="hljs-operator">/</span>
├── SKILL.md (<span class="hljs-number">127</span> 行)
├── assets<span class="hljs-operator">/</span>
│   └── CustomValidatorTemplate.java
└── <span class="hljs-keyword">references</span><span class="hljs-operator">/</span>
    ├── bean<span class="hljs-operator">-</span>validation<span class="hljs-operator">-</span>annotations.md
    ├── <span class="hljs-keyword">group</span><span class="hljs-operator">-</span>validation.md
    └── validation<span class="hljs-operator">-</span>examples.md
</code></pre>
<h5 data-id="heading-70">5. <strong>java-response-wrapper</strong> - 统一响应格式规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>创建统一响应包装类</li>
<li>实现分页响应格式</li>
<li>统一 API 返回格式</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>设计统一响应格式</li>
<li>创建响应包装类</li>
<li>实现分页响应</li>
<li>统一 API 返回格式</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">java-<span class="hljs-built_in">response</span>-wrapper/
├── SKILL.md (<span class="hljs-number">80</span> 行)
├── assets/
│   ├── ResultTemplate.java
│   └── PageResultTemplate.java
└── references/
    ├── <span class="hljs-built_in">response</span>-formats.md
    └── page-result.md
</code></pre>
<h5 data-id="heading-71">6. <strong>java-logging</strong> - 日志记录规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>配置日志格式和级别</li>
<li>实现日志脱敏</li>
<li>遵循日志记录最佳实践</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>为 Service 添加日志记录</li>
<li>配置日志格式</li>
<li>实现日志脱敏</li>
<li>优化现有日志记录</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-lua" lang="lua">java-logging/
├── SKILL.md (<span class="hljs-number">120</span> 行)
├── assets/
│   ├── logback-example.xml
│   └── desensitization-utils.java
└── references/
    ├── <span class="hljs-built_in">log</span>-levels.md
    └── <span class="hljs-built_in">log</span>-<span class="hljs-built_in">format</span>.md
</code></pre>
<h5 data-id="heading-72">7. <strong>java-mybatis-plus-generator</strong> - MyBatis-Plus 代码生成</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>生成基于 MyBatis-Plus 的完整分层代码</li>
<li>创建 Controller、Service、Mapper 层</li>
<li>集成 PageHelper 分页功能</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>创建基于 MyBatis-Plus 的 CRUD 操作</li>
<li>生成分页查询功能</li>
<li>实现 Service 层和 DAO 层代码</li>
<li>生成 Mapper XML 文件</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">java-mybatis-plus-generator/
├── SKILL.md (102 行)
├── assets/
│   ├── EntityTemplate.java
│   ├── MapperInterfaceTemplate.java
│   ├── MapperXmlTemplate.xml
│   ├── ServiceInterfaceTemplate.java
│   ├── ServiceImplTemplate.java
│   └── ControllerTemplate.java
└── references/
<span class="hljs-code">    ├── pagehelper-usage.md
    ├── query-wrapper.md
    └── generation-examples.md
</span></code></pre>
<h4 data-id="heading-73">6.3 安装和使用</h4>
<h5 data-id="heading-74">从 GitHub 安装</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装本项目所有 Skills</span>
openskills install lambert0529/skills --universal

<span class="hljs-comment"># 或者指定 java 目录</span>
openskills install lambert0529/skills/java --universal
</code></pre>
<h5 data-id="heading-75">从本地安装</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从本地 java 目录安装</span>
openskills install ./java --universal
</code></pre>
<h5 data-id="heading-76">同步到 AGENTS.md</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 同步到 Cursor</span>
openskills <span class="hljs-built_in">sync</span> --<span class="hljs-built_in">yes</span> -o .cursor/rules/AGENTS.md
</code></pre>
<h5 data-id="heading-77">使用示例</h5>
<p><strong>在 Cursor 中</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"为用户管理创建 REST API 接口"</span>
<span class="hljs-string">"创建用户 Service 层，包含事务管理"</span>
<span class="hljs-string">"设计异常处理机制"</span>
<span class="hljs-string">"为创建用户请求添加参数校验"</span>
<span class="hljs-string">"设计统一响应格式"</span>
<span class="hljs-string">"为 Service 添加日志记录"</span>
<span class="hljs-string">"为用户管理生成基于 MyBatis-Plus 的 CRUD 代码"</span>
</code></pre>
<h4 data-id="heading-78">6.4 规范覆盖范围</h4>
<p>这些 Skills 覆盖了 Java 后端开发的核心规范：</p>
<ul>
<li>✅ RESTful API 设计</li>
<li>✅ 分层架构（Controller-Service-Repository）</li>
<li>✅ 异常处理机制</li>
<li>✅ 参数校验</li>
<li>✅ 统一响应格式</li>
<li>✅ 日志记录</li>
<li>✅ 事务管理</li>
<li>✅ MyBatis-Plus 集成</li>
<li>✅ 代码规范</li>
</ul>
<h4 data-id="heading-79">6.5 项目特点</h4>
<ul>
<li>✅ <strong>符合规范</strong>：完全遵循 Anthropic Skills 开放标准</li>
<li>✅ <strong>渐进式披露</strong>：SKILL.md 简洁（80-127 行），详细内容在 references 中</li>
<li>✅ <strong>跨平台兼容</strong>：可在 Cursor、Claude Code、Windsurf、Aider 等平台使用</li>
<li>✅ <strong>最佳实践</strong>：基于 Spring Boot 和主流后端开发规范</li>
<li>✅ <strong>开箱即用</strong>：提供完整的代码模板和参考资料</li>
</ul>
<h4 data-id="heading-80">6.6 贡献和反馈</h4>
<p>欢迎贡献和反馈！</p>
<ul>
<li><strong>GitHub Issues</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flambert0529%2Fskills%2Fissues" target="_blank" title="https://github.com/lambert0529/skills/issues" ref="nofollow noopener noreferrer">github.com/lambert0529…</a></li>
<li><strong>Pull Requests</strong>：欢迎提交 PR 改进 Skills</li>
<li><strong>Star</strong>：如果觉得有用，请给项目一个 Star ⭐</li>
</ul>
<hr/>
<h3 data-id="heading-81">📋 快速参考</h3>
<h4 data-id="heading-82">常用命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装技能</span>
openskills install lambert0529/skills --universal

<span class="hljs-comment"># 列出技能</span>
openskills list

<span class="hljs-comment"># 同步到 AGENTS.md</span>
openskills <span class="hljs-built_in">sync</span> --<span class="hljs-built_in">yes</span> -o .cursor/rules/AGENTS.md

<span class="hljs-comment"># 读取技能</span>
openskills <span class="hljs-built_in">read</span> java-rest-api-design

<span class="hljs-comment"># 删除技能</span>
openskills remove old-skill
</code></pre>
<h4 data-id="heading-83">目录结构</h4>
<pre><code class="hljs language-bash" lang="bash">项目根目录/
├── .agent/
│   └── skills/              <span class="hljs-comment"># 通用技能（推荐）</span>
│       ├── java-rest-api-design/
│       │   └── SKILL.md
│       └── ...
├── .claude/
│   └── skills/             <span class="hljs-comment"># Claude 技能</span>
└── .cursor/
    ├── rules/
    │   └── AGENTS.md        <span class="hljs-comment"># 技能列表（同步生成）</span>
    └── skills/              <span class="hljs-comment"># 手动创建（不被 OpenSkills 识别）</span>
</code></pre>
<hr/>
<h3 data-id="heading-84">🔗 相关资源</h3>
<h4 data-id="heading-85">标准与规范</h4>
<ul>
<li><strong>Anthropic Skills 标准</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%25EF%25BC%2588%25E5%25AE%2598%25E6%2596%25B9%25E6%25A0%2587%25E5%2587%2586%25E5%25AE%259A%25E4%25B9%2589%25EF%25BC%2589" target="_blank" title="https://github.com/anthropics/skills%EF%BC%88%E5%AE%98%E6%96%B9%E6%A0%87%E5%87%86%E5%AE%9A%E4%B9%89%EF%BC%89" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></li>
<li><strong>Anthropic Skills 市场</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%25EF%25BC%2588%25E5%25AE%2598%25E6%2596%25B9%25E6%258A%2580%25E8%2583%25BD%25E5%25BA%2593%25EF%25BC%2589" target="_blank" title="https://github.com/anthropics/skills%EF%BC%88%E5%AE%98%E6%96%B9%E6%8A%80%E8%83%BD%E5%BA%93%EF%BC%89" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></li>
</ul>
<h4 data-id="heading-86">工具与实现</h4>
<ul>
<li><strong>OpenSkills GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnumman-ali%2Fopenskills%25EF%25BC%2588%25E5%25BC%2580%25E6%25BA%2590" target="_blank" title="https://github.com/numman-ali/openskills%EF%BC%88%E5%BC%80%E6%BA%90" ref="nofollow noopener noreferrer">github.com/numman-ali/…</a> CLI 工具）</li>
<li><strong>OpenSkills 文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnumman-ali%2Fopenskills%23readme" target="_blank" title="https://github.com/numman-ali/openskills#readme" ref="nofollow noopener noreferrer">github.com/numman-ali/…</a></li>
</ul>
<h4 data-id="heading-87">平台支持</h4>
<ul>
<li><strong>Cursor 文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.cursor.com%25EF%25BC%2588Skills" target="_blank" title="https://docs.cursor.com%EF%BC%88Skills" ref="nofollow noopener noreferrer">docs.cursor.com（Skills</a> 支持情况请查看最新文档）</li>
<li><strong>Claude Code</strong>：原生支持 Anthropic Skills 标准</li>
<li><strong>Windsurf</strong>：支持 Anthropic Skills 标准</li>
<li><strong>Aider</strong>：支持 Anthropic Skills 标准</li>
</ul>
<h4 data-id="heading-88">项目资源</h4>
<ul>
<li><strong>本项目 GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flambert0529%2Fskills.git" target="_blank" title="https://github.com/lambert0529/skills.git" ref="nofollow noopener noreferrer">github.com/lambert0529…</a></li>
<li><strong>本项目 Gitee</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flbl_lambert%2Fskills.git" target="_blank" title="https://gitee.com/lbl_lambert/skills.git" ref="nofollow noopener noreferrer">gitee.com/lbl_lambert…</a></li>
<li><strong>项目 README</strong>：./README.md</li>
<li><strong>Java Skills README</strong>：./java/README.md</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Python 设置 Windows 文件默认打开程序]]></title>    <link>https://juejin.cn/post/7596926832913301567</link>    <guid>https://juejin.cn/post/7596926832913301567</guid>    <pubDate>2026-01-19T17:15:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596926832913301567" data-draft-id="7596883689827713087" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Python 设置 Windows 文件默认打开程序"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-19T17:15:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户836279132519"/> <meta itemprop="url" content="https://juejin.cn/user/344583214737996"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Python 设置 Windows 文件默认打开程序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/344583214737996/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户836279132519
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T17:15:39.000Z" title="Mon Jan 19 2026 17:15:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>转载自我的个人博客<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.ksable.top%2F2026%2F01%2F19%2Fyong-python-she-zhi-windows-wen-jian-mo-ren-da-kai-cheng-xu%2F" target="_blank" title="https://blog.ksable.top/2026/01/19/yong-python-she-zhi-windows-wen-jian-mo-ren-da-kai-cheng-xu/" ref="nofollow noopener noreferrer">《Posts: 用 Python 设置 Windows 文件默认打开程序》</a><br/>
如有什么疑问可在文章下方评论</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>本人为班里任命的电教委员（苦差事），因班里的教学需求，要在特定的某天切换使用某个播放器。</p>
<p>本人就想通过 Python 自动化设置默认 MP4 打开程序，然后就在请教 deepseek 等助手后，运行其生成的代码。随后就被各种奇怪的报错给卡死了。无奈之下便上 Github 看看有没有相关的代码。</p>
<p>万幸的是，我真的在 Github 上找到个用 Python 写的 文件默认大师 软件，感谢原作者。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F3089464667%2Fdefault-app" target="_blank" title="https://github.com/3089464667/default-app" ref="nofollow noopener noreferrer">github.com/3089464667/…</a></p>
<p>我便阅读这代码，并提取了其中设置默认程序的核心代码。</p>
<h2 data-id="heading-1">代码讲解</h2>
<p>这段代码是一个用于 Windows 系统设置文件默认打开程序的 Python 工具。它通过命令行和注册表两种方式修改关联，适用于 Windows 7/10/11。</p>
<h3 data-id="heading-2">核心功能</h3>
<ul>
<li><strong>设置默认程序</strong>：通过 <code>set_default_app()</code> 函数指定文件扩展名与对应的应用程序路径，可自动配置系统关联。</li>
<li><strong>兼容性处理</strong>：优先使用 <code>assoc</code> 和 <code>ftype</code> 命令行设置，同时直接修改注册表，并处理 Windows 10/11 的用户选择验证机制。</li>
<li><strong>验证功能</strong>：<code>check_default_app()</code> 可检查当前默认程序是否为指定应用。</li>
</ul>
<h3 data-id="heading-3">使用示例</h3>
<pre><code class="hljs language-python" lang="python">set_default_app(<span class="hljs-string">".txt"</span>, <span class="hljs-string">"C:\\Windows\\notepad.exe"</span>)
<span class="hljs-keyword">if</span> check_default_app(<span class="hljs-string">".txt"</span>, <span class="hljs-string">"C:\\Windows\\notepad.exe"</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"设置成功"</span>)
</code></pre>
<h3 data-id="heading-4">完整代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> winreg
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> hashlib

<span class="hljs-keyword">def</span> <span class="hljs-title function_">set_default_app_cmd</span>(<span class="hljs-params">file_extension, app_path</span>):
    <span class="hljs-string">"""
    使用 Windows 命令行工具设置默认打开程序，兼容 Windows 10/11
    """</span>
    <span class="hljs-keyword">try</span>:
        ext = file_extension <span class="hljs-keyword">if</span> file_extension.startswith(<span class="hljs-string">'.'</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">'.'</span> + file_extension
        prog_id = ext[<span class="hljs-number">1</span>:].upper() + <span class="hljs-string">"File"</span>
        subprocess.run(<span class="hljs-string">f'assoc <span class="hljs-subst">{ext}</span>=<span class="hljs-subst">{prog_id}</span>'</span>, shell=<span class="hljs-literal">True</span>, check=<span class="hljs-literal">True</span>)
        subprocess.run(<span class="hljs-string">f'ftype <span class="hljs-subst">{prog_id}</span>="<span class="hljs-subst">{app_path}</span>" "%1"'</span>, shell=<span class="hljs-literal">True</span>, check=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">""</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-built_in">str</span>(e)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">set_default_app</span>(<span class="hljs-params">file_extension, app_path, icon_path=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">"""
    设置文件扩展名的默认打开程序
    参数:
        file_extension: 文件扩展名（如 ".txt" 或 "txt"）
        app_path: 应用程序完整路径
        icon_path: 可选图标路径
    返回: 无
    """</span>
    <span class="hljs-comment"># 先用命令行设置</span>
    ok, msg = set_default_app_cmd(file_extension, app_path)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"命令行设置失败: <span class="hljs-subst">{msg}</span>"</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 确保扩展名格式正确</span>
        ext = file_extension <span class="hljs-keyword">if</span> file_extension.startswith(<span class="hljs-string">'.'</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">'.'</span> + file_extension
        
        <span class="hljs-comment"># 创建或打开扩展名对应的注册表键</span>
        <span class="hljs-keyword">with</span> winreg.CreateKey(winreg.HKEY_CLASSES_ROOT, ext) <span class="hljs-keyword">as</span> key:
            prog_id = winreg.QueryValue(key, <span class="hljs-literal">None</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> prog_id:
                prog_id = ext[<span class="hljs-number">1</span>:].upper() + <span class="hljs-string">"File"</span>
                winreg.SetValue(key, <span class="hljs-literal">None</span>, winreg.REG_SZ, prog_id)
            
            <span class="hljs-comment"># 设置打开命令</span>
            <span class="hljs-keyword">with</span> winreg.CreateKey(winreg.HKEY_CLASSES_ROOT, <span class="hljs-string">f"<span class="hljs-subst">{prog_id}</span>\\shell\\open\\command"</span>) <span class="hljs-keyword">as</span> cmd_key:
                winreg.SetValue(cmd_key, <span class="hljs-literal">None</span>, winreg.REG_SZ, <span class="hljs-string">f"\"<span class="hljs-subst">{app_path}</span>\" \"%1\""</span>)
        
        <span class="hljs-comment"># 处理用户选择（Windows 10/11 需要）</span>
        user_choice_path = <span class="hljs-string">f"Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\FileExts\\<span class="hljs-subst">{ext}</span>\\"</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> winreg.OpenKey(winreg.HKEY_CURRENT_USER, user_choice_path, <span class="hljs-number">0</span>, winreg.KEY_ALL_ACCESS) <span class="hljs-keyword">as</span> key:
                winreg.DeleteKey(key, <span class="hljs-string">"UserChoice"</span>)
        <span class="hljs-keyword">except</span> WindowsError:
            <span class="hljs-keyword">pass</span>
        
        <span class="hljs-comment"># 生成用户选择哈希（Windows 10/11 验证机制）</span>
        <span class="hljs-keyword">try</span>:
            user_sid = os.getlogin()
        <span class="hljs-keyword">except</span> Exception:
            user_sid = <span class="hljs-string">"unknown"</span>
        
        timestamp = <span class="hljs-built_in">int</span>(time.time())
        hash_input = <span class="hljs-string">f"<span class="hljs-subst">{prog_id}</span><span class="hljs-subst">{user_sid}</span><span class="hljs-subst">{timestamp}</span>"</span>.encode(<span class="hljs-string">'utf-16le'</span>)
        hash_value = hashlib.sha256(hash_input).hexdigest()
        
        <span class="hljs-keyword">with</span> winreg.CreateKey(winreg.HKEY_CURRENT_USER, user_choice_path + <span class="hljs-string">"UserChoice"</span>) <span class="hljs-keyword">as</span> key:
            winreg.SetValueEx(key, <span class="hljs-string">"ProgId"</span>, <span class="hljs-number">0</span>, winreg.REG_SZ, prog_id)
            winreg.SetValueEx(key, <span class="hljs-string">"Hash"</span>, <span class="hljs-number">0</span>, winreg.REG_SZ, hash_value)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功设置 <span class="hljs-subst">{ext}</span> 的默认打开程序为: <span class="hljs-subst">{app_path}</span>"</span>)
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"设置默认程序失败: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">check_default_app</span>(<span class="hljs-params">file_extension, app_path</span>):
    <span class="hljs-string">"""
    检查当前扩展名的默认打开程序是否为指定程序
    参数:
        file_extension: 文件扩展名
        app_path: 应用程序路径
    返回: True/False
    """</span>
    ext = file_extension <span class="hljs-keyword">if</span> file_extension.startswith(<span class="hljs-string">'.'</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">'.'</span> + file_extension
    <span class="hljs-keyword">try</span>:
        output = subprocess.check_output(<span class="hljs-string">f"assoc <span class="hljs-subst">{ext}</span>"</span>, shell=<span class="hljs-literal">True</span>, encoding=<span class="hljs-string">"gbk"</span>, errors=<span class="hljs-string">"ignore"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-string">"="</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> output:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        prog_id = output.strip().split(<span class="hljs-string">"="</span>)[-<span class="hljs-number">1</span>]
        output2 = subprocess.check_output(<span class="hljs-string">f"ftype <span class="hljs-subst">{prog_id}</span>"</span>, shell=<span class="hljs-literal">True</span>, encoding=<span class="hljs-string">"gbk"</span>, errors=<span class="hljs-string">"ignore"</span>)
        <span class="hljs-keyword">if</span> app_path.lower() <span class="hljs-keyword">in</span> output2.lower():
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-keyword">except</span> Exception:
        <span class="hljs-keyword">pass</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 示例1：设置.txt文件用记事本打开</span>
    set_default_app(<span class="hljs-string">".txt"</span>, <span class="hljs-string">"C:\\Windows\\notepad.exe"</span>)
    
    <span class="hljs-comment"># 示例2：设置.jpg文件用照片查看器打开</span>
    set_default_app(<span class="hljs-string">"jpg"</span>, <span class="hljs-string">"C:\\Windows\\System32\\rundll32.exe"</span>, <span class="hljs-string">"C:\\Windows\\System32\\photo_viewer.dll"</span>)
    
    <span class="hljs-comment"># 检查设置是否成功</span>
    <span class="hljs-keyword">if</span> check_default_app(<span class="hljs-string">".txt"</span>, <span class="hljs-string">"C:\\Windows\\notepad.exe"</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"设置成功！"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"设置失败！"</span>)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度详解Spring Context]]></title>    <link>https://juejin.cn/post/7596975035438546953</link>    <guid>https://juejin.cn/post/7596975035438546953</guid>    <pubDate>2026-01-20T03:37:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438546953" data-draft-id="7596890557547069486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度详解Spring Context"/> <meta itemprop="keywords" content="Spring,Java"/> <meta itemprop="datePublished" content="2026-01-20T03:37:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度详解Spring Context
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:37:00.000Z" title="Tue Jan 20 2026 03:37:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深度详解Spring Context</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7723bfb345a4c2eab39754b86a7781a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=k2wElk9obQ9tmFe0xXx%2FuDdzvks%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>每个Spring开发者都离不开Context，但你真的了解它吗？</p>
</blockquote>
<h2 data-id="heading-1">引言：Spring Context 的核心地位</h2>
<p>Spring Context作为Spring框架的核心组件，是IoC容器的具体实现。它就像一个巨大的工厂，负责管理所有的Bean对象，控制它们的生命周期，并解决它们之间的依赖关系。</p>
<h2 data-id="heading-2">什么是Spring Context？</h2>
<p>Spring Context是Spring框架的核心容器，它继承自<code>BeanFactory</code>接口，但在其基础上增加了企业级应用所需的功能：</p>
<ul>
<li>国际化支持</li>
<li>事件传播机制</li>
<li>资源加载</li>
<li>AOP集成</li>
<li>事务管理</li>
</ul>
<h2 data-id="heading-3">四大ApplicationContext全解析</h2>
<h3 data-id="heading-4">1️⃣ AnnotationConfigApplicationContext - Java配置的王者</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cfc620b85a84f69bdff81aafc428b7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=HuyKzJRT9%2BamoC7SS8rcIV%2BjSyA%3D" alt="" loading="lazy"/></p>
<p><strong>适用场景：</strong></p>
<ul>
<li>现代Spring Boot应用</li>
<li>纯Java配置的项目</li>
<li>需要类型安全的配置</li>
</ul>
<p><strong>核心特点：</strong></p>
<ul>
<li>完全基于注解的配置方式</li>
<li>支持Java 8的Lambda表达式</li>
<li>与Spring Boot无缝集成</li>
</ul>
<p><strong>实战代码示例：</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@ComponentScan</span>(<span class="hljs-string">"com.example.service"</span>)
<span class="hljs-variable">@PropertySource</span>(<span class="hljs-string">"classpath:application.properties"</span>)
public class AppConfig {

    <span class="hljs-variable">@Value</span>(<span class="hljs-string">"${app.name}"</span>)
    private String appName;

    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@Scope</span>(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
    public UserService <span class="hljs-built_in">userService</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">UserServiceImpl</span>();
    }

    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">dataSource</span>() {
        <span class="hljs-selector-tag">HikariDataSource</span> <span class="hljs-selector-tag">dataSource</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HikariDataSource</span>();
        <span class="hljs-selector-tag">dataSource</span><span class="hljs-selector-class">.setJdbcUrl</span>(<span class="hljs-string">"jdbc:mysql://localhost:3306/mydb"</span>);
        <span class="hljs-selector-tag">dataSource</span><span class="hljs-selector-class">.setUsername</span>(<span class="hljs-string">"root"</span>);
        <span class="hljs-selector-tag">dataSource</span><span class="hljs-selector-class">.setPassword</span>(<span class="hljs-string">"password"</span>);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">dataSource</span>;
    }
}

<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">MainApplication</span> {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-comment">// 创建上下文</span>
        <span class="hljs-selector-tag">ApplicationContext</span> <span class="hljs-selector-tag">context</span> =
            <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">AnnotationConfigApplicationContext</span>(AppConfig.class);

        <span class="hljs-comment">// 获取Bean</span>
        <span class="hljs-selector-tag">UserService</span> <span class="hljs-selector-tag">userService</span> = <span class="hljs-selector-tag">context</span><span class="hljs-selector-class">.getBean</span>(UserService.class);
        <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">dataSource</span> = <span class="hljs-selector-tag">context</span><span class="hljs-selector-class">.getBean</span>(DataSource.class);

        <span class="hljs-comment">// 使用服务</span>
        <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.processUser</span>();
    }
}
</code></pre>
<p><strong>生产环境应用：</strong> 在Spring Boot项目中，我们通常通过<code>@SpringBootApplication</code>注解自动创建<code>AnnotationConfigApplicationContext</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">MyApplication</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<h3 data-id="heading-5">2️⃣ ClassPathXmlApplicationContext - 类路径XML配置</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ee8f6b7ded249d79a2d85b704f0e375~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=zj5DYJ6PYTgQqpDFskRcH3O8QT0%3D" alt="" loading="lazy"/></p>
<p><strong>适用场景：</strong></p>
<ul>
<li>传统Spring应用</li>
<li>需要与XML配置兼容</li>
<li>类路径资源管理</li>
</ul>
<p><strong>核心特点：</strong></p>
<ul>
<li>从类路径加载XML配置文件</li>
<li>支持通配符配置</li>
<li>兼容性好</li>
</ul>
<p><strong>实战代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XmlConfigApp</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 基础用法</span>
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"applicationContext.xml"</span>);

        <span class="hljs-comment">// 2. 多配置文件</span>
        String[] configLocations = {
            <span class="hljs-string">"spring-datasource.xml"</span>,
            <span class="hljs-string">"spring-service.xml"</span>,
            <span class="hljs-string">"spring-mvc.xml"</span>
        };
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context2</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(configLocations);

        <span class="hljs-comment">// 3. 使用通配符</span>
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context3</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"classpath*:spring/*.xml"</span>);

        <span class="hljs-comment">// 获取Bean</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> context.getBean(UserService.class);
    }
}
</code></pre>
<p><strong>XML配置文件示例：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- applicationContext.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span>
       <span class="hljs-attr">xmlns:tx</span>=<span class="hljs-string">"http://www.springframework.org/schema/tx"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd
           http://www.springframework.org/schema/tx
           http://www.springframework.org/schema/tx/spring-tx.xsd"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 组件扫描 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">"com.example"</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- 属性文件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">"classpath:application.properties"</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- 数据源配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.zaxxer.hikari.HikariDataSource"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driverClassName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${db.driver}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jdbcUrl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${db.url}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${db.username}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${db.password}"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- JPA配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"entityManagerFactory"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"packagesToScan"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.example.entity"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jpaVendorAdapter"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jpaProperties"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">props</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">props</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 事务管理器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"transactionManager"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.orm.jpa.JpaTransactionManager"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"entityManagerFactory"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"entityManagerFactory"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 启用事务注解 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">"transactionManager"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">3️⃣ FileSystemXmlApplicationContext - 文件系统XML配置</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7b81c3f101f4d91bb38e23fb12bb9c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=C%2FdyOQxV%2B540HH46ocW9B3vAl6Y%3D" alt="" loading="lazy"/></p>
<p><strong>适用场景：</strong></p>
<ul>
<li>外部配置文件管理</li>
<li>开发环境快速配置</li>
<li>多环境部署</li>
</ul>
<p><strong>核心特点：</strong></p>
<ul>
<li>从文件系统加载配置文件</li>
<li>支持绝对路径</li>
<li>便于外部配置管理</li>
</ul>
<p><strong>实战代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileSystemConfigApp</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 使用绝对路径</span>
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context1</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSystemXmlApplicationContext</span>(
                <span class="hljs-string">"C:/config/spring/applicationContext.xml"</span>);

        <span class="hljs-comment">// 2. 使用多个配置文件</span>
        String[] configPaths = {
            <span class="hljs-string">"/opt/spring/config/datasource.xml"</span>,
            <span class="hljs-string">"/opt/spring/config/service.xml"</span>
        };
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context2</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSystemXmlApplicationContext</span>(configPaths);

        <span class="hljs-comment">// 3. 相对路径（不推荐，路径不明确）</span>
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context3</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSystemXmlApplicationContext</span>(<span class="hljs-string">"config/spring.xml"</span>);

        <span class="hljs-comment">// 使用上下文</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> context1.getBean(UserService.class);
    }
}
</code></pre>
<p><strong>最佳实践：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">CONFIG_DIR</span> = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">getProperty</span>(<span class="hljs-string">"user.dir"</span>) + <span class="hljs-string">"/config"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">ApplicationContext</span> <span class="hljs-title function_">createApplicationContext</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> profile</span>) {
        <span class="hljs-title class_">String</span> configPath = <span class="hljs-variable constant_">CONFIG_DIR</span> + <span class="hljs-string">"/application-"</span> + profile + <span class="hljs-string">".xml"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSystemXmlApplicationContext</span>(configPath);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 根据环境创建不同的上下文</span>
        <span class="hljs-title class_">String</span> env = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">getProperty</span>(<span class="hljs-string">"spring.profiles.active"</span>, <span class="hljs-string">"dev"</span>);
        <span class="hljs-title class_">ApplicationContext</span> context = <span class="hljs-title function_">createApplicationContext</span>(env);
    }
}
</code></pre>
<h3 data-id="heading-7">4️⃣ WebApplicationContext - Web应用的守护神</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ed2897170c54fa0b63fd86e374c10da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=cK9fTCd5oj4vIe9pTzhSDAgCyDg%3D" alt="" loading="lazy"/></p>
<p><strong>适用场景：</strong></p>
<ul>
<li>Web应用开发</li>
<li>Spring MVC应用</li>
<li>Servlet容器集成</li>
</ul>
<p><strong>核心特点：</strong></p>
<ul>
<li>继承自ApplicationContext</li>
<li>提供Web特有的功能</li>
<li>支持Servlet生命周期集成</li>
</ul>
<p><strong>Web.xml配置示例：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- web.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee
         http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span>
         <span class="hljs-attr">version</span>=<span class="hljs-string">"4.0"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Context配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>
            /WEB-INF/spring/root-context.xml
            /WEB-INF/spring/app-config.xml
        <span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 监听器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring MVC配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>dispatcher<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>/WEB-INF/spring/servlet-context.xml<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>dispatcher<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web.xml</span>&gt;</span>
</code></pre>
<p><strong>Servlet集成示例：</strong></p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 自定义Servlet</span>
<span class="hljs-meta">@WebServlet</span>(<span class="hljs-string">"/api/users"</span>)
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserService</span> userService;

    <span class="hljs-meta">@Override</span>
    public void init() <span class="hljs-keyword">throws</span> <span class="hljs-type">ServletException</span> {
        <span class="hljs-comment">// 获取WebApplicationContext</span>
        <span class="hljs-type">WebApplicationContext</span> context =
            <span class="hljs-type">WebApplicationContextUtils</span>.getWebApplicationContext(
                getServletContext());

        <span class="hljs-comment">// 手动注入（不推荐，应该使用注解）</span>
        <span class="hljs-keyword">if</span> (userService == <span class="hljs-literal">null</span>) {
            userService = context.getBean(<span class="hljs-type">UserService</span>.<span class="hljs-keyword">class</span>);
        }
    }

    <span class="hljs-keyword">protected</span> void doGet(<span class="hljs-type">HttpServletRequest</span> request,
                        <span class="hljs-type">HttpServletResponse</span> response) {
        <span class="hljs-type">List</span>&lt;<span class="hljs-type">User</span>&gt; users = userService.getAllUsers();
        <span class="hljs-comment">// 返回JSON响应</span>
    }
}

<span class="hljs-comment">// 使用注解的控制器</span>
<span class="hljs-meta">@Controller</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/api"</span>)
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiController</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserService</span> userService;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/users"</span>)
    <span class="hljs-meta">@ResponseBody</span>
    public <span class="hljs-type">List</span>&lt;<span class="hljs-type">User</span>&gt; getUsers() {
        <span class="hljs-keyword">return</span> userService.getAllUsers();
    }
}
</code></pre>
<h2 data-id="heading-8">生产环境实战：微服务架构中的Spring Context</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88563da06a4e4a148e83a72a3a8122f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=4nQxBy0JQu6HIdQkKvCfhFKLCuY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">微服务集成示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户服务</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-meta">@ComponentScan</span>(<span class="hljs-string">"com.example.user"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceProvider</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">UserServiceProvider</span>.<span class="hljs-property">class</span>, args);
    }
}

<span class="hljs-comment">// 订单服务</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-meta">@ComponentScan</span>(<span class="hljs-string">"com.example.order"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceProvider</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">OrderServiceProvider</span>.<span class="hljs-property">class</span>, args);
    }
}

<span class="hljs-comment">// 公共配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@PropertySource</span>(<span class="hljs-string">"classpath:application-common.properties"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@LoadBalanced</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RestTemplate</span> <span class="hljs-title function_">restTemplate</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RedisConnectionFactory</span> <span class="hljs-title function_">redisConnectionFactory</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">LettuceConnectionFactory</span>.<span class="hljs-title function_">builder</span>()
            .<span class="hljs-title function_">host</span>(<span class="hljs-string">"redis-server"</span>)
            .<span class="hljs-title function_">port</span>(<span class="hljs-number">6379</span>)
            .<span class="hljs-title function_">build</span>();
    }
}
</code></pre>
<h3 data-id="heading-10">Spring Boot与Spring Cloud整合</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@EnableDiscoveryClient</span>
<span class="hljs-variable">@EnableCircuitBreaker</span>
public class MicroserviceApplication {

    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(MicroserviceApplication.class, args);
    }

    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">WebApplicationContext</span> <span class="hljs-selector-tag">webApplicationContext</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">AnnotationConfigWebApplicationContext</span>();
    }
}

<span class="hljs-comment">// 服务实现类</span>
@<span class="hljs-selector-tag">Service</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">OrderServiceImpl</span> <span class="hljs-selector-tag">implements</span> <span class="hljs-selector-tag">OrderService</span> {

    <span class="hljs-variable">@Autowired</span>
    private UserClient userClient;

    <span class="hljs-variable">@Autowired</span>
    private PaymentClient paymentClient;

    <span class="hljs-variable">@Autowired</span>
    private InventoryClient inventoryClient;

    <span class="hljs-variable">@HystrixCommand</span>(fallbackMethod = <span class="hljs-string">"createOrderFallback"</span>)
    <span class="hljs-variable">@Override</span>
    public Order <span class="hljs-built_in">createOrder</span>(OrderDTO orderDTO) {
        <span class="hljs-comment">// 1. 检查用户</span>
        <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">user</span> = <span class="hljs-selector-tag">userClient</span><span class="hljs-selector-class">.getUser</span>(orderDTO.<span class="hljs-built_in">getUserId</span>());

        <span class="hljs-comment">// 2. 检查库存</span>
        <span class="hljs-selector-tag">inventoryClient</span><span class="hljs-selector-class">.checkInventory</span>(orderDTO.<span class="hljs-built_in">getItems</span>());

        <span class="hljs-comment">// 3. 创建订单</span>
        <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>();
        <span class="hljs-comment">// ... 设置订单信息</span>

        <span class="hljs-comment">// 4. 处理支付</span>
        <span class="hljs-selector-tag">PaymentResult</span> <span class="hljs-selector-tag">payment</span> = <span class="hljs-selector-tag">paymentClient</span><span class="hljs-selector-class">.processPayment</span>(order);

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">orderRepository</span><span class="hljs-selector-class">.save</span>(order);
    }

    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">createOrderFallback</span>(OrderDTO orderDTO) {
        <span class="hljs-comment">// 降级处理</span>
        <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>();
        <span class="hljs-selector-tag">order</span><span class="hljs-selector-class">.setStatus</span>(<span class="hljs-string">"FAILED"</span>);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">order</span>;
    }
}
</code></pre>
<h2 data-id="heading-11">性能优化与最佳实践</h2>
<h3 data-id="heading-12">1. 上下文加载优化</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 延迟加载</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedConfig</span> {

    <span class="hljs-meta">@Lazy</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">HeavyService</span> <span class="hljs-title function_">heavyService</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeavyService</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-meta">@Scope</span>(value = <span class="hljs-title class_">ConfigurableBeanFactory</span>.<span class="hljs-property">SCOPE_SINGLETON</span>,
           proxyMode = <span class="hljs-title class_">ScopedProxyMode</span>.<span class="hljs-property">TARGET_CLASS</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ExpensiveService</span> <span class="hljs-title function_">expensiveService</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpensiveService</span>();
    }
}
</code></pre>
<h3 data-id="heading-13">2. 内存管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 配置JVM参数</span>
<span class="hljs-comment">// 在启动脚本中添加：</span>
<span class="hljs-comment">// -XX:+UseG1GC -Xms512m -Xmx1024m -XX:MaxMetaspaceSize=256m</span>

<span class="hljs-comment">// 配置Bean生命周期</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LifecycleConfig</span> {

    <span class="hljs-meta">@Bean</span>(destroyMethod = <span class="hljs-string">"cleanup"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResourceCleanup</span> <span class="hljs-title function_">resourceCleanup</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceCleanup</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@DependsOn</span>(<span class="hljs-string">"resourceCleanup"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MainService</span> <span class="hljs-title function_">mainService</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainService</span>();
    }
}
</code></pre>
<h3 data-id="heading-14">3. 多环境配置</h3>
<pre><code class="hljs language-ini" lang="ini">// application-dev.properties
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://dev-db:<span class="hljs-number">3306</span>/mydb
<span class="hljs-attr">spring.datasource.username</span>=dev_user
<span class="hljs-attr">spring.datasource.password</span>=dev_pass

// application-prod.properties
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://prod-db:<span class="hljs-number">3306</span>/mydb
<span class="hljs-attr">spring.datasource.username</span>=prod_user
<span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-variable">${PROD_DB_PASSWORD}</span>

// application-test.properties
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://test-db:<span class="hljs-number">3306</span>/mydb
<span class="hljs-attr">spring.datasource.username</span>=test_user
<span class="hljs-attr">spring.datasource.password</span>=test_pass

// 激活不同环境
java -jar app.jar <span class="hljs-attr">--spring.profiles.active</span>=prod
</code></pre>
<h2 data-id="heading-15">总结</h2>
<p>四种ApplicationContext各有其适用场景：</p>
<ol>
<li><strong>AnnotationConfigApplicationContext</strong> - 现代Java配置的首选</li>
<li><strong>ClassPathXmlApplicationContext</strong> - 传统XML配置的可靠选择</li>
<li><strong>FileSystemXmlApplicationContext</strong> - 外部配置管理的灵活方案</li>
<li><strong>WebApplicationContext</strong> - Web应用的专用容器</li>
</ol>
<p>在实际开发中，推荐根据项目需求和技术栈选择合适的ApplicationContext实现方式，并注意性能优化和最佳实践的应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4372c83677914713b13ca746663536de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=yc2qgLtlO%2FpMVth%2BUqoH1Y3uL3U%3D" alt="" loading="lazy"/></p>
<p>记住，Spring Context是Spring框架的核心，掌握它的使用将让你在Spring开发的道路上更加游刃有余！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 工程化（四）：Vite 与基于 Rust/Go 的新一代构建浪潮]]></title>    <link>https://juejin.cn/post/7596990822127091750</link>    <guid>https://juejin.cn/post/7596990822127091750</guid>    <pubDate>2026-01-20T03:19:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596990822127091750" data-draft-id="7596983314805833778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 工程化（四）：Vite 与基于 Rust/Go 的新一代构建浪潮"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T03:19:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 工程化（四）：Vite 与基于 Rust/Go 的新一代构建浪潮
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:19:03.000Z" title="Tue Jan 20 2026 03:19:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>"天下苦 Webpack 久矣。"</p>
<p>这句话虽然偏激，却道出了 2020 年前后前端开发者的心声。随着项目规模从几百个模块膨胀到几万个模块，Webpack 的启动时间从 30 秒延长到了 5 分钟。开发者每天花在 <code>npm run dev</code> 上的等待时间，足够喝完一整天的咖啡。</p>
<p>并不是 Webpack 不够优秀，而是基于 JavaScript 编写的构建工具，在处理海量 AST（抽象语法树）转换时，撞上了 Node.js 单线程的物理墙壁。</p>
<p>于是，一场关于“速度”的革命爆发了。这场革命分为两条战线：一条是以 Vite 为代表的 <strong>架构模式革新（Unbundled）</strong> ，另一条是以 Esbuild/Rspack 为代表的 <strong>底层语言大换血（Native）</strong> 。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/760ebae872534810bd35720d406174f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486343&amp;x-signature=5405nRFw85I%2FupLIxxhpOZ3x%2FKY%3D" alt="unnamed.jpg" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 架构的降维打击：Vite 的 O(1) 启动哲学</h2>
<p>Vite（法语意为“快”）的横空出世，给了当时的构建圈一记响亮的耳光。它的核心武器不是算法优化，而是 <strong>“偷懒”</strong> 。</p>
<h3 data-id="heading-1">1.1 从 Eager 到 Lazy：开发环境的范式转移</h3>
<p>Webpack 的 Dev Server 是 <strong>Eager（急切）</strong> 的。不管你当前访问哪个页面，它必须先把整个项目打包好，存到内存里，然后才能启动服务器。项目越大，启动越慢，时间复杂度是 <strong>O(n)</strong> 。</p>
<p>Vite 的 Dev Server 是 Lazy（懒惰） 的。</p>
<p>利用浏览器原生支持 ESM (
</p><ol>
<li>启动一个简单的 Node Server。</li>
<li>浏览器请求 <code>main.js</code>。</li>
<li>Vite 拦截请求，简单处理（比如把 JSX 编译成 JS），返回给浏览器。</li>
<li>浏览器解析 <code>main.js</code>，发现 <code>import App from './App.vue'</code>，再次发送请求。</li>
<li>Vite 再次拦截，编译 <code>App.vue</code>，返回...</li>
</ol>
<p>架构视角：</p>
<p>Vite 将“构建”这个动作，从 服务器端 (Build Time) 转移到了 浏览器端 (Runtime)，并将全量计算拆解成了按需计算。</p>
<p>无论你的项目有 100 个页面还是 1000 个页面，Vite 启动时只处理入口文件。启动速度与项目规模解耦，时间复杂度变成了 O(1)。</p>
<h3 data-id="heading-2">1.2 生产环境的妥协：Bundle 依然必要</h3>
<p>很多新手误以为 Vite 在生产环境也是 Bundless（无打包）的。<strong>这是错的。</strong></p>
<p>虽然 HTTP/2 支持多路复用，理论上可以并发请求几百个文件，但在物理现实中，网络瀑布流 (Network Waterfall) 依然是性能杀手。</p>
<p>如果 A.js 依赖 B.js，B.js 依赖 C.js，浏览器必须串行下载。在移动端弱网环境下，这种 RTT（往返时延）是不可接受的。</p>
<p>因此，Vite 在生产环境依然调用 Rollup 进行打包。</p>
<p>这就引入了一个架构上的 一致性风险：开发环境（Esbuild + 原生 ESM）与生产环境（Rollup Bundle）不仅运行机制不同，甚至部分 AST 解析逻辑也不一致。这是 Vite 架构中最大的 Trade-off。</p>
<hr/>
<h2 data-id="heading-3">二、 算力的暴力美学：Rust 与 Go 的底层重写</h2>
<p>架构优化总有尽头，当 JS 引擎跑得冒烟也追不上项目膨胀的速度时，基础架构师们决定更换底层的“发动机”。</p>
<h3 data-id="heading-4">2.1 Esbuild：Go 语言的闪电战</h3>
<p>Esbuild 是第一个打破僵局的英雄。它用 Go 语言编写，主打“快到离谱”。</p>
<p>它比 Webpack 快 10-100 倍。为什么？</p>
<ol>
<li><strong>编译型语言 vs 解释型语言：</strong> Go 编译成机器码，没有 JS 的 JIT 开销。</li>
<li><strong>极致并行 (Parallelism)：</strong> Webpack 运行在 Node.js 主线程（虽然有 worker-thread 但开销大），而 Esbuild 利用 Go 的 Goroutine 榨干了 CPU 的每一个核心。</li>
<li><strong>零内存拷贝：</strong> 从解析到打印，尽量复用数据结构，减少内存占用。</li>
</ol>
<p>Vite 的预构建（Pre-bundling）就是基于 Esbuild 实现的，把成吨的 <code>node_modules</code> 依赖瞬间转换成 ESM。</p>
<h3 data-id="heading-5">2.2 SWC 与 Turbopack：Vercel 的野望</h3>
<p>SWC (Speedy Web Compiler) 是用 Rust 写的，它的目标是替代 Babel。</p>
<p>而 Turbopack（由 Webpack 之父 Tobias 创建，Vercel 赞助）则是基于 Rust 的“Webpack 接班人”。它引入了 增量计算 (Incremental Computation) 的概念——永远只计算变动的部分，且在函数级别进行缓存。</p>
<p>虽然 Turbopack 声称比 Vite 快 10 倍，但在生态兼容性上目前仍处于追赶状态。</p>
<hr/>
<h2 data-id="heading-6">三、 终极缝合怪：Rspack 的兼容之道</h2>
<p>架构选型往往不是选“最先进的”，而是选“最合适的”。</p>
<p>Vite 虽然好，但对于那些拥有几百个自定义 Webpack Loader/Plugin 的巨型老项目来说，迁移成本等于重写。</p>
<p>这时候，字节跳动开源的 Rspack 走了一条极其务实（也极其困难）的路：</p>
<p>用 Rust 重写 Webpack。</p>
<h3 data-id="heading-7">3.1 "Webpack Interface, Rust Kernel"</h3>
<p>Rspack 的架构策略非常狡猾：</p>
<ul>
<li><strong>外壳：</strong> 几乎 100% 模拟 Webpack 的配置 API、Loader 机制和 Plugin 系统。</li>
<li><strong>内核：</strong> 底层全部用 Rust 实现并行编译、Tree Shaking 和压缩。</li>
</ul>
<p>这意味着，你可能只需要把 <code>webpack.config.js</code> 改名为 <code>rspack.config.js</code>，安装几个包，就能获得 10 倍的构建性能提升。</p>
<p>架构视角：</p>
<p>Rspack 解决的是 “存量市场” 的痛点。它牺牲了部分架构的纯洁性（背负了 Webpack 的配置包袱），换取了巨大的生态兼容性。这在架构演进中被称为 Strangler Fig Pattern（绞杀榕模式） 的变体——在旧接口下替换新实现。</p>
<hr/>
<h2 data-id="heading-8">四、 架构师的决策矩阵：2026 年选什么？</h2>
<p>站在今天，面对 Webpack、Vite、Rspack，架构师该如何抉择？</p>









































<table><thead><tr><th><strong>维度</strong></th><th><strong>Vite</strong></th><th><strong>Rspack</strong></th><th><strong>Webpack 5</strong></th></tr></thead><tbody><tr><td><strong>核心场景</strong></td><td>中小型项目、新项目、单页应用 (SPA)</td><td>巨型 Monorepo、存量项目迁移、对构建速度极度敏感</td><td>及其特殊的定制化需求、老旧生态捆绑</td></tr><tr><td><strong>开发体验 (DX)</strong></td><td>🌟🌟🌟🌟🌟 (秒开)</td><td>🌟🌟🌟🌟 (极快)</td><td>🌟🌟 (慢)</td></tr><tr><td><strong>生产性能 (UX)</strong></td><td>🌟🌟🌟 (依赖 Rollup)</td><td>🌟🌟🌟🌟🌟 (内置 Rust 优化)</td><td>🌟🌟🌟</td></tr><tr><td><strong>生态兼容</strong></td><td>Rollup 生态优先</td><td>Webpack 生态优先</td><td>原生 Webpack</td></tr><tr><td><strong>底层语言</strong></td><td>JS (部分 Esbuild-Go)</td><td>Rust</td><td>JS</td></tr></tbody></table>
<h3 data-id="heading-9">最佳实践建议：</h3>
<ol>
<li><strong>Greenfield (新项目)：</strong> 闭眼选 <strong>Vite</strong>。社区最活跃，插件生态最好，DX 最佳。</li>
<li><strong>Brownfield (老旧大仓)：</strong> 尝试迁移到 <strong>Rspack</strong>。不要试图把一个配置了 5 年的 Webpack 项目硬迁到 Vite，你会死在 Loader 的兼容性上。Rspack 是这类项目的救星。</li>
<li><strong>Library (库开发)：</strong> 依然推荐 <strong>Rollup</strong> 或基于 Rollup 的构建流。Vite 的库模式本质也是 Rollup。</li>
</ol>
<hr/>
<h2 data-id="heading-10">结语：工具链的终局</h2>
<p>从 Webpack 的大包大揽，到 Vite 的按需加载，再到 Rspack 的 Rust 重构。前端构建工具的发展史，其实就是一部 <strong>“对抗熵增与压榨硬件性能”</strong> 的历史。</p>
<p>未来的构建工具将不再是单纯的 JavaScript 脚本，而是一套 <strong>基于 Rust/Go 的高性能二进制工具链</strong>。前端工程师的门槛，正在从“配置工程师”转变为“理解编译原理与系统架构”的工程师。</p>
<blockquote>
<p>Next Step:</p>
<p>引擎已经准备就绪，&lt;模块化&gt; 和 &lt;包管理&gt; 也已齐备。但如何让成百上千的开发人员在这条高速公路上不发生车祸？我们需要一套强有力的交通规则。</p>
<p>下一节，我们将进入**《第五篇：规范——把标准装进盒子里：企业级脚手架的设计与落地》**，聊聊 如何通过脚手架强制执行架构意志。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>