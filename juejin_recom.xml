<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[什么是 Java 反射机制？为什么反射慢？]]></title>    <link>https://juejin.cn/post/7600681071714811904</link>    <guid>https://juejin.cn/post/7600681071714811904</guid>    <pubDate>2026-01-30T03:59:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600681071714811904" data-draft-id="7600681071714795520" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="什么是 Java 反射机制？为什么反射慢？"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2026-01-30T03:59:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Vin_evail"/> <meta itemprop="url" content="https://juejin.cn/user/3974048659038618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            什么是 Java 反射机制？为什么反射慢？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3974048659038618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Vin_evail
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:59:13.000Z" title="Fri Jan 30 2026 03:59:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是 Java 反射机制？为什么反射慢？</h2>
<p>2026年01月30日</p>
<h3 data-id="heading-1">面试考察点</h3>
<p>当面试官询问 “什么是 Java 反射机制？为什么反射慢？” 时，他不仅仅是在考察一个简单的概念，其核心意图通常包括以下几点：</p>
<ol>
<li><strong>对 Java 语言核心机制的理解深度</strong>：面试官想确认你是否理解 Java 运行时类型信息（RTTI）的实现方式之一，能否清晰阐述反射的基本概念和作用。</li>
<li><strong>探究技术原理的洞察力</strong>：面试官不仅仅是想知道反射“慢”，更是想知道<strong>你为什么知道它慢</strong>，即你是否了解其性能开销的具体来源和 JVM 层面的底层原因。</li>
<li><strong>工程实践中的权衡能力</strong>：通过询问“为什么慢”，间接考察你是否在实际开发中具备性能意识，能否在 “灵活性” 和 “性能” 之间做出合理取舍。</li>
<li><strong>对框架原理的理解基础</strong>：反射是众多主流框架（如 Spring、MyBatis）的基石。理解反射有助于理解这些框架是如何工作的。</li>
</ol>
<h3 data-id="heading-2">核心答案</h3>
<p>Java 反射机制是指在程序<strong>运行状态</strong>中，对于任意一个类，都能够动态地获取其属性和方法等信息（即 <code>Class</code> 对象），并能够动态地调用其方法、操作其属性。这种 “动态性” 使得我们可以在编译期未知具体类的情况下，运行期进行探索和操作。</p>
<p>反射之所以 “慢”，主要原因在于：</p>
<ol>
<li><strong>JVM 无法优化</strong>：反射调用阻碍了 JVM 的许多编译时和运行时优化，如方法内联。</li>
<li><strong>安全检查开销</strong>：每次反射操作都需要进行严格的权限和安全检查（如 <code>AccessibleObject.setAccessible(true)</code> 可以绕过，但需谨慎）。</li>
<li><strong>动态解析</strong>：方法名、参数类型等信息需要在运行时解析，而非编译时确定。</li>
<li><strong>参数装箱与拆箱</strong>：反射调用方法时，参数需要以 <code>Object</code> 数组传递，涉及频繁的装箱/拆箱和数组创建。</li>
</ol>
<h3 data-id="heading-3">深度解析</h3>
<h4 data-id="heading-4">原理/机制</h4>
<p>每个被 JVM 加载的类，在堆中都会有一个唯一的 <code>java.lang.Class</code> 对象。这个 <code>Class</code> 对象就像这个类的“蓝图”，包含了该类的所有结构信息：字段（<code>Field</code>）、方法（<code>Method</code>）、构造器（<code>Constructor</code>）、父类、接口等。反射 API（位于 <code>java.lang.reflect</code> 包）就是通过操作这个 <code>Class</code> 对象来“反推出”类的原始结构并与之交互。这是 Java 实现动态性的核心支持。</p>
<h4 data-id="heading-5"><strong>代码示例：反射 vs 正常调用</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> java.lang.reflect.Method;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectionDemo</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">normalCall</span><span class="hljs-params">(<span class="hljs-type">String</span> msg)</span> </span>{
        <span class="hljs-comment">// 编译时即可确定方法调用，JVM 可充分优化</span>
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"Normal: "</span> + msg);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">reflectionCall</span><span class="hljs-params">(<span class="hljs-type">String</span> msg)</span> throws Exception </span>{
        <span class="hljs-comment">// 运行时动态查找并调用方法</span>
        Class&lt;?&gt; clazz = ReflectionDemo.<span class="hljs-keyword">class</span>;
        Method method = clazz.<span class="hljs-built_in">getDeclaredMethod</span>(<span class="hljs-string">"normalCall"</span>, <span class="hljs-type">String</span>.<span class="hljs-keyword">class</span>);
        method.<span class="hljs-built_in">invoke</span>(null, msg); <span class="hljs-comment">//  invoke 是可变参数，内部会封装成 Object[]</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> throws Exception </span>{
        <span class="hljs-type">long</span> start, end;
        <span class="hljs-type">int</span> times = <span class="hljs-number">1000000</span>;

        <span class="hljs-comment">// 1. 正常调用</span>
        start = System.<span class="hljs-built_in">currentTimeMillis</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; times; i++) {
            <span class="hljs-built_in">normalCall</span>(<span class="hljs-string">"Hello"</span>);
        }
        end = System.<span class="hljs-built_in">currentTimeMillis</span>();
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"正常调用耗时："</span> + (end - start) + <span class="hljs-string">" ms"</span>);

        <span class="hljs-comment">// 2. 反射调用（无缓存）</span>
        start = System.<span class="hljs-built_in">currentTimeMillis</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; times; i++) {
            <span class="hljs-built_in">reflectionCall</span>(<span class="hljs-string">"Hello"</span>);
        }
        end = System.<span class="hljs-built_in">currentTimeMillis</span>();
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"反射调用耗时："</span> + (end - start) + <span class="hljs-string">" ms"</span>);
    }
}
</code></pre>
<p>运行上述代码，你可以直观地看到性能差距（通常反射会慢一个数量级以上）。</p>
<h4 data-id="heading-6"><strong>为什么反射慢？深度拆解</strong></h4>
<ol>
<li>
<p><strong>方法内联失效</strong>：JIT 编译器的一个重要优化是<strong>方法内联</strong>。对于直接调用，JIT 可以判断热点方法并将其代码“内联”到调用处，消除调用开销。但 <code>Method.invoke</code> 是一个由本地方法实现的、通用且复杂的分发器，JIT 无法看到其背后的具体目标方法，因此无法进行内联。</p>
</li>
<li>
<p><strong>运行时解析与查找</strong>：每次 <code>getMethod</code> 和 <code>invoke</code> 都需要 JVM 在类的元数据中进行字符串匹配和查找，这是一个相对耗时的过程。尽管可以缓存 <code>Method</code> 对象来避免重复查找，但 <code>invoke</code> 本身的调用开销依然存在。</p>
</li>
<li>
<p><strong>本地方法调用与安全检查</strong>：<code>Method.invoke()</code> 的最终实现在本地代码（Native Code）中。每次调用都需要从 Java 层切换到本地层，这本身就有上下文切换开销。此外，默认情况下，它需要调用 <code>AccessibleObject.checkAccess</code> 方法进行可见性检查。</p>
</li>
<li>
<p><strong>参数处理的抽象成本</strong>：</p>
<ul>
<li><code>invoke</code> 接受一个 <code>Object...</code> 参数数组。这意味着所有基本类型参数都需要被<strong>装箱</strong>成 <code>Integer</code>、<code>Double</code> 等对象。</li>
<li>JVM 需要将传入的数组解包，并检查参数类型是否与方法签名匹配，然后将它们传递给真正的本地方法。</li>
<li>调用完成后，如果返回基本类型，还需要<strong>拆箱</strong>。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-7"><strong>最佳实践与常见误区</strong></h4>
<ul>
<li>
<p><strong>最佳实践</strong>：</p>
<ol>
<li><strong>缓存</strong>：这是最重要的优化手段。一旦通过反射获取到 <code>Class</code>、<code>Method</code>、<code>Field</code> 等对象，就应该将它们缓存起来，避免在循环或高频调用中重复查找。</li>
<li><strong>谨慎使用 <code>setAccessible(true)</code></strong> ：这可以关闭安全检查，带来显著的性能提升（在 JDK 8 及之前尤其明显）。但会破坏封装性，并可能带来安全隐患，仅在对性能有极致要求且明确知道后果的场景下使用。</li>
<li><strong>权衡使用</strong>：明确反射的使用场景，如框架开发、动态代理、注解处理器等。在普通的业务代码中，应优先使用直接的 API 调用。</li>
<li><strong>考虑替代方案</strong>：在 JDK 9+ 中，可以考虑 <code>java.lang.invoke</code> 包下的 <code>MethodHandle</code>，它在某些场景下性能优于反射，并得到了 JVM 更多的优化支持。</li>
</ol>
</li>
<li>
<p><strong>常见误区</strong>：</p>
<ul>
<li><strong>“反射一定不能用”</strong> ：不对。反射是强大的工具，许多基础框架离不开它。关键在于“正确使用”。</li>
<li><strong>“只要缓存了 <code>Method</code> 就不慢了”</strong> ：不准确。缓存只能消除查找开销，但 <code>invoke</code> 的调用开销、参数处理开销和优化阻碍依然存在，相比直接调用仍有显著差距。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-8"><strong>【总结】</strong></h3>
<p>Java 反射机制提供了强大的运行时动态能力，是许多框架的基石，但其性能代价主要源于 <strong>JVM 优化受阻、运行时的安全检查与解析、以及繁琐的参数处理过程</strong>；在实际开发中，应通过缓存 <code>Method</code> 等对象来优化，并严格限定其使用边界，在灵活性与性能之间做出明智权衡。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智能巡检部署]]></title>    <link>https://juejin.cn/post/7600603245396082728</link>    <guid>https://juejin.cn/post/7600603245396082728</guid>    <pubDate>2026-01-29T10:11:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600603245396082728" data-draft-id="7600342201794560015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智能巡检部署"/> <meta itemprop="keywords" content="Linux,Python"/> <meta itemprop="datePublished" content="2026-01-29T10:11:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恰饭小男孩"/> <meta itemprop="url" content="https://juejin.cn/user/1007625803672606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智能巡检部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1007625803672606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恰饭小男孩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T10:11:54.000Z" title="Thu Jan 29 2026 10:11:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景介绍</h2>
<p>    哈喽啊，小饼好久没发文章了，个人原因最近工作比较繁忙，这段时间也换了新岗位。慢慢腾出一点时间去做巡检工作。</p>
<p>我突然发现一个个去巡检设备好麻烦，突然想到自己弄一个脚本去代替我人工，如果也有想和我一样偷懒的小伙伴，就去和我一样实践起来吧</p>
<h3 data-id="heading-1">1、环境准备</h3>
<blockquote>
<p>三台虚拟机，ansible服务器端+客户端+客户端。我们大部分操作都在服务端去执行</p>
</blockquote>
<h4 data-id="heading-2">1.1、安装ansible</h4>
<p>1、<code>yum install -y http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</code>  ##添加ansible的yum源</p>
<p>2<code> yum install -y ansible</code> ##安装ansible</p>
<blockquote>
<p>这里给大家温习一下ansible的配置文件</p>
</blockquote>
<blockquote>
<p>1、默认配置文件:/etc/ansible/ansible.cfg，一般不用它</p>
<p>2，./ansible.cfg，当前工作路径下的配置文件，推荐。</p>
<p>3，~/.ansible.cfg，当前用户家目录下的配置文件(隐藏的）</p>
<p>4，/etc/ansible/ansible.cfg，默认配置文件</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e56f4d7070c48a9b1af9614a5c9fe93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw6aWt5bCP55S35a2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350119&amp;x-signature=Auxcstsd40EdKm3LC76xVwJewXY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db6f4e14a498479b8414eaccd3eabed6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw6aWt5bCP55S35a2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350119&amp;x-signature=do6%2Bn4yvJydL2RnqAON7r51jS4o%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">1.2、配置无密钥认证</h4>
<p><code>mkdir ./ansible</code>   ##此时我是在/root/ansible/
<code>ssh-keygen</code>    ##获取加密密钥</p>
<p><code>ssh-copy-id root@serverb</code>   ##分发给服务器</p>
<p><code>ssh-copy-id root@serverc</code>    ##分发给服务器</p>
<p><code>ssh-copy-id root@serverd</code>   ##分发给服务器</p>
<h4 data-id="heading-4">1.3、自定义配置文件</h4>
<blockquote>
<p>这里我建议大家配置ansible使用一个专用的ansible用户去配置。我是懒得不行，就用超级管理员去做了。大家用普通用户提权去做</p>
</blockquote>
<blockquote>
<p>#在工作路径，自定义配置文件
vi ./ansible.cfg</p>
</blockquote>
<p>[defaults]</p>
<p>inventory = ./inventory</p>
<p>[privilege_escalation]
become = true</p>
<p>become method =sudo</p>
<p>become user = root</p>
<p>become ask pass = true</p>
<h4 data-id="heading-5">1.4、自定义主机清单</h4>
<p><code>vim ./inventory</code></p>
<p><code>[work]</code></p>
<p><code>serverb</code></p>
<p><code>serverc</code></p>
<p><code>serverd</code></p>
<h5 data-id="heading-6">验证一下 ansible work --list-hosts</h5>
<blockquote>
<p>ansible work  -m ping</p>
</blockquote>
<h3 data-id="heading-7">2、在服务端配置巡检脚本 *****很重要！！！</h3>
<blockquote>
<p>将文件存放在/root/ansible中</p>
</blockquote>
<pre><code class="hljs language-#!/bin/bash" lang="#!/bin/bash"># ================ SysCheck 2.0 服务器运维巡检脚本 ================
#  作者：yy
# ===============================================================

# --- 基础配置 ---
# 自动检测终端颜色
if [ -t 1 ]; then
    RED="\033[91m"
    GREEN="\033[92m"
    YELLOW="\033[93m"
    BLUE="\033[94m"
    BOLD="\033[1m"
    NC="\033[0m"
else
    RED=""; GREEN=""; YELLOW=""; BLUE=""; BOLD=""; NC=""
fi

print_title() {
    echo -e "\n${BLUE}${BOLD}════════════════════════════════════════════════════════════${NC}"
    echo -e "${BOLD}                    $1${NC}"
    echo -e "${BLUE}${BOLD}════════════════════════════════════════════════════════════${NC}"
}

print_status() {
    case "$1" in
        ok) echo -e "${GREEN}  [OK] $2${NC}" ;;
        warn) echo -e "${YELLOW}  [WARN] $2${NC}" ;;
        error) echo -e "${RED}  [ERROR] $2${NC}" ;;
        info) echo -e "${BLUE}  [INFO] $2${NC}" ;;
        *) echo -e "  [$1] $2" ;;
    esac
}

# --- 生成报告文件 ---
generate_report() {
    local report_file="/tmp/syscheck_report_$(date +%Y%m%d_%H%M%S).txt"
    echo "=== SysCheck 巡检报告 ===" &gt; "$report_file"
    echo "生成时间: $(date '+%Y-%m-%d %H:%M:%S')" &gt;&gt; "$report_file"
    echo "主机名: $(hostname)" &gt;&gt; "$report_file"
    echo "IP地址: $(hostname -I 2&gt;/dev/null | awk '{print $1}')" &gt;&gt; "$report_file"
    echo "==================================" &gt;&gt; "$report_file"
}

# --- 1. 系统基础信息 ---
clear
print_title "Linux 服务器深度巡检 (SysCheck 2.0)"
echo -e "巡检时间：$(date '+%Y-%m-%d %H:%M:%S')"

[ -f /etc/os-release ] &amp;&amp; . /etc/os-release
OS_NAME="${PRETTY_NAME:-未知}"
HOSTNAME=$(hostname)
KERNEL=$(uname -r)
UPTIME=$(uptime)
LOAD_AVG=$(uptime | awk -F'load average:' '{print $2}' | sed 's/^[      ]*//')

print_status info "系统版本 : $OS_NAME"
print_status info "主机名称 : $HOSTNAME"
print_status info "内核版本 : $KERNEL"
print_status info "运行时间 : $(uptime -p)"
print_status info "平均负载 : $LOAD_AVG"

# --- 2. 资源使用情况 ---
print_title "资源使用情况"

# CPU使用率
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
if [ $(echo "$CPU_USAGE &gt; 80" | bc 2&gt;/dev/null || echo "0") = "1" ]; then
    print_status error "CPU使用率: ${CPU_USAGE}% - 过高！"
elif [ $(echo "$CPU_USAGE &gt; 60" | bc 2&gt;/dev/null || echo "0") = "1" ]; then
    print_status warn "CPU使用率: ${CPU_USAGE}% - 偏高"
else
    print_status ok "CPU使用率: ${CPU_USAGE}%"
fi

# 内存
mem_info=$(free -m)
mem_total=$(echo "$mem_info" | awk '/Mem:/ {print $2}')
mem_used=$(echo "$mem_info" | awk '/Mem:/ {print $3}')
mem_free=$(echo "$mem_info" | awk '/Mem:/ {print $4}')
mem_usage=$(echo "scale=2; $mem_used*100/$mem_total" | bc 2&gt;/dev/null || echo "0")

if [ $(echo "$mem_usage &gt; 90" | bc 2&gt;/dev/null || echo "0") = "1" ]; then
    print_status error "内存使用: ${mem_usage}% (${mem_used}M/${mem_total}M) - 严重不足！"
elif [ $(echo "$mem_usage &gt; 80" | bc 2&gt;/dev/null || echo "0") = "1" ]; then
    print_status warn "内存使用: ${mem_usage}% (${mem_used}M/${mem_total}M) - 偏高"
else
    print_status ok "内存使用: ${mem_usage}% (${mem_used}M/${mem_total}M)"
fi

# 交换空间
swap_info=$(free -m | awk '/Swap:/')
if [ -n "$swap_info" ]; then
    swap_total=$(echo "$swap_info" | awk '{print $2}')
    swap_used=$(echo "$swap_info" | awk '{print $3}')
    if [ "$swap_total" -gt 0 ]; then
        swap_usage=$(echo "scale=2; $swap_used*100/$swap_total" | bc 2&gt;/dev/null || echo "0")
        if [ "$swap_used" -gt 0 ]; then
            print_status warn "交换空间使用: ${swap_usage}% (${swap_used}M/${swap_total}M)"
        fi
    fi
fi

# 磁盘检查
print_status info "磁盘使用情况:"
df -hT | grep -vE 'tmpfs|cdrom|loop|overlay|squashfs|udev|devtmpfs' | while read fs type size used avail use mount; do
    if [ -n "$use" ]; then
        usage_num=$(echo "$use" | tr -d '%')
        if [ "$usage_num" -ge 95 ]; then
            print_status error "  $mount ($use) - ${size}已用${used} - 空间严重不足！"
        elif [ "$usage_num" -ge 85 ]; then
            print_status warn "  $mount ($use) - ${size}已用${used} - 空间不足"
        elif [ "$usage_num" -ge 70 ]; then
            print_status info "  $mount ($use) - ${size}已用${used}"
        else
            print_status ok "  $mount ($use) - ${size}已用${used}"
        fi
    fi
done

# Inode检查
print_status info "Inode使用情况:"
df -i | grep -vE 'tmpfs|cdrom|loop|overlay|squashfs|udev|devtmpfs' | while read fs inodes iused ifree iuse mount; do
    if [ -n "$iuse" ] &amp;&amp; [ "$iuse" != "IUse%" ]; then
        iuse_num=$(echo "$iuse" | tr -d '%')
        if [ "$iuse_num" -ge 90 ]; then
            print_status error "  $mount ($iuse) - Inode接近耗尽！"
        elif [ "$iuse_num" -ge 80 ]; then
            print_status warn "  $mount ($iuse) - Inode使用较高"
        fi
    fi
done

# --- 3. 安全补丁检查 (修复增强版) ---
print_title "安全补丁与漏洞检查"

check_updates() {
    if command -v apt &gt;/dev/null 2&gt;&amp;1; then
        # Debian/Ubuntu 逻辑
        if updates=$(apt list --upgradable 2&gt;/dev/null | grep -v "Listing..."); then
            cnt=$(echo "$updates" | wc -l)
            if [ "$cnt" -gt 0 ]; then
                print_status warn "发现 $cnt 个可升级包"
                echo "$updates" | head -n 5 | while read line; do
                    echo "    $line"
                done
                [ "$cnt" -gt 5 ] &amp;&amp; echo "    ... (还有 $((cnt-5)) 个未显示)"
            else
                print_status ok "系统软件包已是最新"
            fi
        fi
    elif command -v dnf &gt;/dev/null 2&gt;&amp;1 || command -v yum &gt;/dev/null 2&gt;&amp;1; then
        # RHEL/CentOS/Rocky 逻辑
        PKG_MGR=$(command -v dnf || command -v yum)

        # 检查安全更新
        if $PKG_MGR check-update --security &gt;/dev/null 2&gt;&amp;1; then
            sec_count=$($PKG_MGR check-update --security 2&gt;/dev/null | grep -c "\.\.")
            if [ "$sec_count" -gt 0 ]; then
                print_status warn "发现 $sec_count 个安全补丁待安装！"
                $PKG_MGR check-update --security 2&gt;/dev/null | head -n 5
                [ "$sec_count" -gt 5 ] &amp;&amp; echo "    ... (还有 $((sec_count-5)) 个未显示)"
            else
                print_status ok "未发现严重安全补丁"
            fi
        else
            # 尝试其他方法
            if sec_info=$($PKG_MGR updateinfo list security 2&gt;/dev/null); then
                sec_count=$(echo "$sec_info" | grep -c "security" || echo 0)
                if [ "$sec_count" -gt 0 ]; then
                    print_status warn "发现 $sec_count 个安全补丁待安装！"
                    echo "$sec_info" | head -n 5
                else
                    print_status ok "未发现严重安全补丁"
                fi
            else
                print_status info "跳过安全检查：当前源不支持元数据查询或缺少插件"
            fi
        fi
    else
        print_status info "未知包管理器，跳过补丁检查"
    fi
}

check_updates

# --- 4. 服务状态检查 ---
print_title "关键服务状态检查"

check_service() {
    local service=$1
    local name=$2

    if systemctl list-unit-files | grep -q "^${service}.service"; then
        if systemctl is-active --quiet "$service"; then
            print_status ok "$name: 运行中"
        else
            print_status error "$name: 未运行"
        fi
    fi
}

# 检查常见服务
check_service "sshd" "SSH服务"
check_service "crond" "计划任务"
check_service "nginx" "Nginx"
check_service "httpd" "Apache"
check_service "mysqld" "MySQL"
check_service "postgresql" "PostgreSQL"
check_service "docker" "Docker"
check_service "firewalld" "防火墙"
check_service "iptables" "iptables"
check_service "fail2ban" "Fail2ban"

# --- 5. 异常检测 ---
print_title "异常进程检测"

# 高负载进程
echo -e "${BOLD}CPU 占用前五:${NC}"
ps -eo pid,user,%cpu,cmd --sort=-%cpu | head -n 6 | tail -n 5 | awk '{printf "  %-6s %-10s %-6s %s\n", $1, $2, $3, $4}'

echo -e "\n${BOLD}内存 占用前五:${NC}"
ps -eo pid,user,%mem,cmd --sort=-%mem | head -n 6 | tail -n 5 | awk '{printf "  %-6s %-10s %-6s %s\n", $1, $2, $3, $4}'

# 僵尸进程
zombies=$(ps aux | grep -E "[Zz]" | grep -v grep | wc -l)
if [ "$zombies" -gt 0 ]; then
    print_status error "发现 $zombies 个僵尸进程！"
    ps aux | grep -E "[Zz]" | grep -v grep
else
    print_status ok "无僵尸进程"
fi

# 检查异常连接
echo -e "\n${BOLD}异常网络连接检查:${NC}"
if command -v netstat &gt;/dev/null 2&gt;&amp;1; then
    suspicious=$(netstat -antp 2&gt;/dev/null | grep -E "LISTEN|ESTABLISHED" | grep -vE "127.0.0.1|::1|0.0.0.0" | head -n 10)
    if [ -n "$suspicious" ]; then
        print_status warn "发现异常网络连接:"
        echo "$suspicious" | head -n 5
    fi
fi

# --- 6. 登录和用户检查 ---
print_title "登录与用户检查"

# 当前登录用户
echo -e "${BOLD}当前登录用户:${NC}"
who | head -n 5

# 检查空密码用户
if [ -f /etc/shadow ]; then
    empty_pass=$(sudo awk -F: '($2 == "" || $2 == "!") {print $1}' /etc/shadow 2&gt;/dev/null || echo "")
    if [ -n "$empty_pass" ]; then
        print_status error "发现空密码用户: $empty_pass"
    fi
fi

# 检查root用户远程登录
if grep -q "^PermitRootLogin yes" /etc/ssh/sshd_config 2&gt;/dev/null; then
    print_status warn "SSH配置允许root远程登录"
fi

# --- 7. 系统日志检查 ---
print_title "系统日志检查"

# 检查最近错误日志
if [ -f /var/log/messages ]; then
    recent_errors=$(tail -n 20 /var/log/messages | grep -i "error\|fail\|critical" | head -n 5)
elif [ -f /var/log/syslog ]; then
    recent_errors=$(tail -n 20 /var/log/syslog | grep -i "error\|fail\|critical" | head -n 5)
fi

if [ -n "$recent_errors" ]; then
    print_status warn "最近系统日志错误:"
    echo "$recent_errors" | while read line; do
        echo "  $line"
    done
fi

# --- 8. 结束与建议 ---
print_title "巡检完成"
echo -e "${BOLD}巡检摘要:${NC}"
echo -e "  1. 系统资源使用情况已检查"
echo -e "  2. 安全补丁状态已评估"
echo -e "  3. 关键服务状态已验证"
echo -e "  4. 异常进程和连接已扫描"
echo -e "  5. 系统日志已检查"

echo -e "\n${BOLD}建议:${NC}"
echo -e "  • 定期清理 /var/log 目录日志"
echo -e "  • 监控磁盘使用率，及时清理无用文件"
echo -e "  • 及时安装安全补丁"
echo -e "  • 定期备份重要数据"
echo -e "  • 检查防火墙规则和SSH配置"

echo -e "\n${GREEN}巡检完成于: $(date '+%Y-%m-%d %H:%M:%S')${NC}"
echo -e "${BLUE}脚本版本: SysCheck 2.0${NC}"

</code></pre>
<h4 data-id="heading-8">效果图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44f08002dff341dfab7c517bd5f37f70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw6aWt5bCP55S35a2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350119&amp;x-signature=fTB1P%2BbRPRQoMHhx0UoYszhMVqk%3D" alt="微信图片_20260129184245.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/326177077f9747e79a02d8cb4cdcb401~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw6aWt5bCP55S35a2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350119&amp;x-signature=ql9FAqWWnpjKynQakGZr1WM4sMY%3D" alt="微信图片_20260129184236.jpg" loading="lazy"/></p>
<h3 data-id="heading-9">3、使用python脚本去把生成巡检记录为excel文件</h3>
<blockquote>
<p>一般到了月巡检的时候，领导都会让我们形成一个文件去统计查看。我们运维人员肯定是可以去系统上看，但是把数据统计出来再放进表格还是有点麻烦。</p>
</blockquote>
<blockquote>
<p>现在不用担心了，小饼帮大家把这一步也节省了。现在来看看我下面的处理步骤吧</p>
</blockquote>
<h4 data-id="heading-10">3.1 安装python3环境</h4>
<p>1、<code>yum install epel</code>
2、<code>yum install  -y phthon3</code></p>
<h4 data-id="heading-11">3.2、编写python脚本</h4>
<p><code>vim syscheck-excel.py</code></p>
<pre><code class="hljs language-#!/usr/bin/env" lang="#!/usr/bin/env"># -*- coding: utf-8 -*-
# ==============================================================================
# 脚本名称: syscheck-excel.py (Pro版)
# 功能描述: 采集Linux系统信息、磁盘、Top进程，生成带样式的美观Excel报表
# 运行方式: chmod +x syscheck-excel.py &amp;&amp; ./syscheck-excel.py
# 依赖库  : pip3 install psutil pandas openpyxl
# 作者    :yy
# ==============================================================================

import os
import sys
import socket
import datetime
import platform
import subprocess

# 依赖库检查
try:
    import psutil
    import pandas as pd
    from openpyxl import Workbook
    from openpyxl.styles import Font, PatternFill, Border, Side, Alignment
    from openpyxl.utils import get_column_letter
except ImportError as e:
    print("[Error] 缺少必要模块:", e)
    print("请先执行安装: pip3 install psutil pandas openpyxl")
    sys.exit(1)

def get_size(bytes_num, suffix="B"):
    """人性化显示文件大小"""
    factor = 1024
    for unit in ["", "K", "M", "G", "T", "P"]:
        if bytes_num &lt; factor:
            return f"{bytes_num:.2f}{unit}{suffix}"
        bytes_num /= factor
    return f"{bytes_num:.2f}EB"

def get_process_info():
    """获取CPU和内存占用最高的Top 10进程"""
    procs = []
    for p in psutil.process_iter(['pid', 'name', 'username', 'cpu_percent', 'memory_percent']):
        try:
            procs.append(p.info)
        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
            pass
    
    # 转为DataFrame
    if procs:
        df_proc = pd.DataFrame(procs)
        if not df_proc.empty:
            # 按内存使用率排序取Top 10
            df_proc = df_proc.sort_values(by='memory_percent', ascending=False).head(10)
            df_proc['cpu_percent'] = df_proc['cpu_percent'].apply(lambda x: f"{x:.1f}%" if x else "0.0%")
            df_proc['memory_percent'] = df_proc['memory_percent'].apply(lambda x: f"{x:.1f}%" if x else "0.0%")
            df_proc.columns = ['PID', 'Process', 'User', 'CPU%', 'Memory%']
            return df_proc
    return pd.DataFrame()

def get_system_info():
    """获取详细的系统信息"""
    info = {}
    
    # 基本系统信息
    uname = platform.uname()
    info['System'] = uname.system
    info['Hostname'] = uname.node
    info['Release'] = uname.release
    info['Version'] = uname.version
    info['Machine'] = uname.machine
    info['Processor'] = uname.processor
    
    # 获取发行版详细信息
    if os.path.exists('/etc/os-release'):
        with open('/etc/os-release', 'r') as f:
            for line in f:
                if 'PRETTY_NAME' in line:
                    info['OS Name'] = line.split('=', 1)[1].strip().strip('"')
                    break
    
    # CPU信息
    info['CPU Cores (Logical)'] = psutil.cpu_count(logical=True)
    info['CPU Cores (Physical)'] = psutil.cpu_count(logical=False)
    
    # 内存信息
    mem = psutil.virtual_memory()
    info['Total Memory'] = get_size(mem.total)
    info['Available Memory'] = get_size(mem.available)
    info['Memory Usage %'] = f"{mem.percent}%"
    
    # 启动时间
    boot_time = datetime.datetime.fromtimestamp(psutil.boot_time())
    info['Boot Time'] = boot_time.strftime("%Y-%m-%d %H:%M:%S")
    
    # 运行时间
    uptime = datetime.datetime.now() - boot_time
    days = uptime.days
    hours, remainder = divmod(uptime.seconds, 3600)
    minutes, seconds = divmod(remainder, 60)
    info['Uptime'] = f"{days}d {hours}h {minutes}m {seconds}s"
    
    # 负载
    if hasattr(os, 'getloadavg'):
        load = os.getloadavg()
        info['Load 1min'] = f"{load[0]:.2f}"
        info['Load 5min'] = f"{load[1]:.2f}"
        info['Load 15min'] = f"{load[2]:.2f}"
    
    # CPU使用率
    cpu_percent = psutil.cpu_percent(interval=1)
    info['CPU Usage %'] = f"{cpu_percent}%"
    
    return info

def get_network_info():
    """获取网络信息"""
    network_info = {}
    
    try:
        # 获取IP地址
        hostname = socket.gethostname()
        try:
            ip_address = socket.gethostbyname(hostname)
        except:
            ip_address = "Unknown"
        
        network_info['Hostname'] = hostname
        network_info['IP Address'] = ip_address
        
        # 网络接口信息
        interfaces = []
        for interface, addrs in psutil.net_if_addrs().items():
            for addr in addrs:
                if addr.family == socket.AF_INET:  # IPv4
                    interfaces.append({
                        'Interface': interface,
                        'Address': addr.address,
                        'Netmask': addr.netmask
                    })
        
        network_info['Interfaces'] = interfaces
        
        # IO统计
        net_io = psutil.net_io_counters()
        network_info['Bytes Sent'] = get_size(net_io.bytes_sent)
        network_info['Bytes Received'] = get_size(net_io.bytes_recv)
        
    except Exception as e:
        network_info['Error'] = f"获取网络信息失败: {str(e)}"
    
    return network_info

def get_disk_info():
    """获取磁盘信息"""
    disk_list = []
    
    try:
        for partition in psutil.disk_partitions():
            # 跳过特殊文件系统
            skip = False
            for skip_str in ['loop', 'snap', 'docker', 'overlay', 'tmpfs']:
                if skip_str in partition.device.lower() or skip_str in partition.mountpoint.lower():
                    skip = True
                    break
            
            if skip:
                continue
            
            try:
                usage = psutil.disk_usage(partition.mountpoint)
                disk_list.append({
                    'Device': partition.device,
                    'Mount Point': partition.mountpoint,
                    'File System': partition.fstype,
                    'Total Size': get_size(usage.total),
                    'Used': get_size(usage.used),
                    'Free': get_size(usage.free),
                    'Usage %': f"{usage.percent}%",
                    'Percent': usage.percent
                })
            except (PermissionError, OSError):
                continue
        
        # 按使用率排序
        if disk_list:
            disk_list.sort(key=lambda x: x['Percent'], reverse=True)
            
    except Exception as e:
        print(f"获取磁盘信息失败: {e}")
    
    return disk_list

def get_service_status():
    """获取服务状态"""
    services = []
    
    # 常见服务列表
    common_services = [
        'sshd', 'crond', 'rsyslog', 'network', 'firewalld',
        'nginx', 'httpd', 'mysql', 'postgresql', 'docker'
    ]
    
    for service in common_services:
        status = 'Unknown'
        try:
            # 尝试systemctl
            result = subprocess.run(['systemctl', 'is-active', service], 
                                  capture_output=True, text=True, timeout=2)
            if result.returncode == 0:
                status = result.stdout.strip()
            else:
                # 尝试service命令
                result = subprocess.run(['service', service, 'status'], 
                                      capture_output=True, text=True, timeout=2)
                status = 'active' if result.returncode == 0 else 'inactive'
        except subprocess.TimeoutExpired:
            status = 'timeout'
        except FileNotFoundError:
            status = 'not installed'
        except:
            status = 'error'
        
        services.append({'Service': service, 'Status': status})
    
    return services

def create_summary_sheet(workbook, system_info, network_info):
    """创建汇总sheet"""
    ws = workbook.create_sheet("System Summary")
    
    # 标题
    ws.merge_cells('A1:B1')
    ws['A1'] = "System Inspection Report"
    ws['A1'].font = Font(size=14, bold=True, color="366092")
    ws['A1'].alignment = Alignment(horizontal='center')
    
    ws['A2'] = f"Report Time: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    ws['A3'] = f"Hostname: {network_info.get('Hostname', 'Unknown')}"
    ws['A4'] = f"IP Address: {network_info.get('IP Address', 'Unknown')}"
    
    # 系统信息表格
    row = 6
    ws[f'A{row}'] = "System Information"
    ws[f'A{row}'].font = Font(bold=True)
    row += 1
    
    sys_keys = ['OS Name', 'System', 'Release', 'Version', 'Machine', 
                'Processor', 'CPU Cores (Logical)', 'CPU Cores (Physical)', 
                'Total Memory', 'Memory Usage %', 'CPU Usage %', 
                'Boot Time', 'Uptime']
    
    for key in sys_keys:
        if key in system_info:
            ws[f'A{row}'] = key
            ws[f'B{row}'] = system_info[key]
            row += 1
    
    # 负载信息
    if 'Load 1min' in system_info:
        row += 1
        ws[f'A{row}'] = "System Load"
        ws[f'A{row}'].font = Font(bold=True)
        row += 1
        ws[f'A{row}'] = "1 Minute"
        ws[f'B{row}'] = system_info['Load 1min']
        row += 1
        ws[f'A{row}'] = "5 Minutes"
        ws[f'B{row}'] = system_info['Load 5min']
        row += 1
        ws[f'A{row}'] = "15 Minutes"
        ws[f'B{row}'] = system_info['Load 15min']
    
    # 调整列宽
    ws.column_dimensions['A'].width = 25
    ws.column_dimensions['B'].width = 40

def create_disk_sheet(workbook, disk_info):
    """创建磁盘信息sheet"""
    if not disk_info:
        return
    
    # 转换为DataFrame
    df_disk = pd.DataFrame(disk_info)
    
    # 移除Percent列（仅用于排序）
    if 'Percent' in df_disk.columns:
        df_disk = df_disk.drop('Percent', axis=1)
    
    # 创建sheet
    ws = workbook.create_sheet("Disk Usage")
    ws.title = "Disk Usage"
    
    # 写入数据
    for r_idx, row in enumerate(df_disk.iterrows(), start=1):
        for c_idx, value in enumerate(row[1], start=1):
            cell = ws.cell(row=r_idx+1, column=c_idx, value=value)
    
    # 写入表头
    for c_idx, col_name in enumerate(df_disk.columns, start=1):
        cell = ws.cell(row=1, column=c_idx, value=col_name)
    
    # 应用样式
    header_fill = PatternFill(start_color="4F81BD", end_color="4F81BD", fill_type="solid")
    header_font = Font(color="FFFFFF", bold=True)
    thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), 
                       top=Side(style='thin'), bottom=Side(style='thin'))
    align_center = Alignment(horizontal='center', vertical='center')
    
    # 设置表头样式
    for cell in ws[1]:
        cell.fill = header_fill
        cell.font = header_font
        cell.alignment = align_center
        cell.border = thin_border
    
    # 设置数据样式和高亮
    for row in ws.iter_rows(min_row=2, max_row=ws.max_row):
        for cell in row:
            cell.border = thin_border
            cell.alignment = align_center
            
            # 高亮使用率
            if cell.column == 7 and cell.value:  # 第7列是Usage %
                try:
                    val_str = str(cell.value).strip('%')
                    val = float(val_str)
                    if val &gt;= 90:
                        cell.font = Font(color="FF0000", bold=True)
                    elif val &gt;= 80:
                        cell.font = Font(color="FFA500", bold=True)
                except ValueError:
                    pass
    
    # 调整列宽
    for col in ws.columns:
        max_length = 0
        col_letter = get_column_letter(col[0].column)
        for cell in col:
            if cell.value and len(str(cell.value)) &gt; max_length:
                max_length = len(str(cell.value))
        adjusted_width = min(max_length + 2, 30)
        ws.column_dimensions[col_letter].width = adjusted_width

def create_service_sheet(workbook, services):
    """创建服务状态sheet"""
    if not services:
        return
    
    df_services = pd.DataFrame(services)
    
    # 创建sheet
    ws = workbook.create_sheet("Service Status")
    
    # 写入数据
    for r_idx, row in enumerate(df_services.iterrows(), start=1):
        for c_idx, value in enumerate(row[1], start=1):
            cell = ws.cell(row=r_idx+1, column=c_idx, value=value)
    
    # 写入表头
    for c_idx, col_name in enumerate(df_services.columns, start=1):
        cell = ws.cell(row=1, column=c_idx, value=col_name)
    
    # 应用样式
    header_fill = PatternFill(start_color="4F81BD", end_color="4F81BD", fill_type="solid")
    header_font = Font(color="FFFFFF", bold=True)
    thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), 
                       top=Side(style='thin'), bottom=Side(style='thin'))
    align_center = Alignment(horizontal='center', vertical='center')
    
    # 设置表头样式
    for cell in ws[1]:
        cell.fill = header_fill
        cell.font = header_font
        cell.alignment = align_center
        cell.border = thin_border
    
    # 设置数据样式和高亮
    for row in ws.iter_rows(min_row=2, max_row=ws.max_row):
        for cell in row:
            cell.border = thin_border
            cell.alignment = align_center
            
            # 高亮状态
            if cell.column == 2 and cell.value:  # 第2列是状态
                status = str(cell.value).lower()
                if status == 'active':
                    cell.fill = PatternFill(start_color="C6EFCE", end_color="C6EFCE", fill_type="solid")
                elif status in ['inactive', 'failed', 'error']:
                    cell.fill = PatternFill(start_color="FFC7CE", end_color="FFC7CE", fill_type="solid")
                    cell.font = Font(color="FF0000", bold=True)
    
    # 调整列宽
    ws.column_dimensions['A'].width = 20
    ws.column_dimensions['B'].width = 15

def create_process_sheet(workbook, process_info):
    """创建进程信息sheet"""
    if process_info.empty:
        return
    
    # 创建sheet
    ws = workbook.create_sheet("Top Processes")
    
    # 写入数据
    for r_idx, row in enumerate(process_info.iterrows(), start=1):
        for c_idx, value in enumerate(row[1], start=1):
            cell = ws.cell(row=r_idx+1, column=c_idx, value=value)
    
    # 写入表头
    for c_idx, col_name in enumerate(process_info.columns, start=1):
        cell = ws.cell(row=1, column=c_idx, value=col_name)
    
    # 应用样式
    header_fill = PatternFill(start_color="4F81BD", end_color="4F81BD", fill_type="solid")
    header_font = Font(color="FFFFFF", bold=True)
    thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), 
                       top=Side(style='thin'), bottom=Side(style='thin'))
    align_center = Alignment(horizontal='center', vertical='center')
    
    # 设置表头样式
    for cell in ws[1]:
        cell.fill = header_fill
        cell.font = header_font
        cell.alignment = align_center
        cell.border = thin_border
    
    # 设置数据样式
    for row in ws.iter_rows(min_row=2, max_row=ws.max_row):
        for cell in row:
            cell.border = thin_border
            cell.alignment = align_center
    
    # 调整列宽
    for col in ws.columns:
        max_length = 0
        col_letter = get_column_letter(col[0].column)
        for cell in col:
            if cell.value and len(str(cell.value)) &gt; max_length:
                max_length = len(str(cell.value))
        adjusted_width = min(max_length + 2, 30)
        ws.column_dimensions[col_letter].width = adjusted_width

def create_network_sheet(workbook, network_info):
    """创建网络信息sheet"""
    ws = workbook.create_sheet("Network Info")
    
    # 标题
    ws['A1'] = "Network Information"
    ws['A1'].font = Font(size=12, bold=True)
    
    row = 3
    ws[f'A{row}'] = "Hostname"
    ws[f'B{row}'] = network_info.get('Hostname', 'Unknown')
    row += 1
    
    ws[f'A{row}'] = "IP Address"
    ws[f'B{row}'] = network_info.get('IP Address', 'Unknown')
    row += 1
    
    # 网络统计
    ws[f'A{row}'] = "Bytes Sent"
    ws[f'B{row}'] = network_info.get('Bytes Sent', 'Unknown')
    row += 1
    
    ws[f'A{row}'] = "Bytes Received"
    ws[f'B{row}'] = network_info.get('Bytes Received', 'Unknown')
    
    # 网络接口
    if 'Interfaces' in network_info and network_info['Interfaces']:
        row += 2
        ws[f'A{row}'] = "Network Interfaces"
        ws[f'A{row}'].font = Font(bold=True)
        row += 1
        
        # 表头
        headers = ['Interface', 'IP Address', 'Netmask']
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=row, column=col, value=header)
            cell.fill = PatternFill(start_color="4F81BD", end_color="4F81BD", fill_type="solid")
            cell.font = Font(color="FFFFFF", bold=True)
        
        row += 1
        
        # 数据
        for interface in network_info['Interfaces'][:10]:  # 限制显示数量
            ws.cell(row=row, column=1, value=interface.get('Interface', ''))
            ws.cell(row=row, column=2, value=interface.get('Address', ''))
            ws.cell(row=row, column=3, value=interface.get('Netmask', ''))
            row += 1
    
    # 设置边框和样式
    thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), 
                       top=Side(style='thin'), bottom=Side(style='thin'))
    
    for row_cells in ws.iter_rows(min_row=1, max_row=ws.max_row, max_col=4):
        for cell in row_cells:
            cell.border = thin_border
            if cell.row &gt; 1:
                cell.alignment = Alignment(horizontal='left', vertical='center')
    
    # 调整列宽
    ws.column_dimensions['A'].width = 20
    ws.column_dimensions['B'].width = 25
    ws.column_dimensions['C'].width = 20

def sys_check_excel():
    """主函数"""
    print(f"[{datetime.datetime.now().strftime('%H:%M:%S')}] Starting system inspection...")
    
    # 收集信息
    print("Collecting system information...")
    system_info = get_system_info()
    
    print("Collecting network information...")
    network_info = get_network_info()
    
    print("Checking disk usage...")
    disk_info = get_disk_info()
    
    print("Checking service status...")
    services = get_service_status()
    
    print("Analyzing processes...")
    process_info = get_process_info()
    
    # 生成Excel文件名
    hostname = system_info.get('Hostname', 'unknown')
    timestamp = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')
    filename = f"system_inspection_{hostname}_{timestamp}.xlsx"
    
    print(f"Generating Excel report: {filename}")
    
    try:
        # 创建Excel工作簿
        wb = Workbook()
        
        # 移除默认的sheet
        if 'Sheet' in wb.sheetnames:
            default_ws = wb['Sheet']
            wb.remove(default_ws)
        
        # 创建各个sheet
        create_summary_sheet(wb, system_info, network_info)
        create_disk_sheet(wb, disk_info)
        create_service_sheet(wb, services)
        create_network_sheet(wb, network_info)
        create_process_sheet(wb, process_info)
        
        # 保存文件
        wb.save(filename)
        
        print(f"\n[SUCCESS] Inspection completed!")
        print(f"Report generated: {os.path.abspath(filename)}")
        
        if os.path.exists(filename):
            print(f"File size: {get_size(os.path.getsize(filename))}")
        
        # 显示摘要信息
        print("\n=== Report Summary ===")
        print(f"System: {system_info.get('OS Name', system_info.get('System', 'Unknown'))}")
        print(f"Hostname: {hostname}")
        print(f"CPU Cores: {system_info.get('CPU Cores (Logical)', 'Unknown')}")
        print(f"Memory: {system_info.get('Total Memory', 'Unknown')} (Usage: {system_info.get('Memory Usage %', 'Unknown')})")
        print(f"CPU Usage: {system_info.get('CPU Usage %', 'Unknown')}")
        
        # 磁盘警告
        if disk_info:
            critical_disks = [d for d in disk_info if d['Percent'] &gt;= 90]
            warning_disks = [d for d in disk_info if 80 &lt;= d['Percent'] &lt; 90]
            
            if critical_disks:
                print(f"[CRITICAL] {len(critical_disks)} disk(s) usage &gt; 90%")
                for disk in critical_disks[:3]:
                    print(f"  - {disk['Mount Point']}: {disk['Usage %']}")
            
            if warning_disks:
                print(f"[WARNING] {len(warning_disks)} disk(s) usage &gt; 80%")
        
        # 服务警告
        if services:
            failed_services = [s for s in services if s['Status'] in ['inactive', 'failed', 'error']]
            if failed_services:
                print(f"[WARNING] {len(failed_services)} service(s) not running")
        
        print("\n=== Excel Sheet Contents ===")
        print("1. System Summary - Basic system information")
        print("2. Disk Usage - Disk partitions with usage highlighting")
        print("3. Service Status - Service status with color coding")
        print("4. Network Info - Network interfaces and statistics")
        print("5. Top Processes - Top 10 processes by memory usage")
        
        print("\n=== Color Legend ===")
        print("Disk Usage: &gt;90% = RED, &gt;80% = ORANGE")
        print("Services: Running = GREEN, Stopped = RED")
        
    except Exception as e:
        print(f"\n[ERROR] Failed to generate report: {e}")
        import traceback
        traceback.print_exc()

def main():
    """主入口函数"""
    print("=" * 70)
    print("           Linux System Inspection Tool (Excel Version)")
    print("              Author: Linux Operations Team")
    print("=" * 70)
    print()
    
    try:
        # 检查是否以root运行（某些信息需要root权限）
        if os.geteuid() != 0:
            print("[WARNING] Running without root privileges")
            print("Some information (services, detailed disk info) may not be available")
            print("Consider running with: sudo python3 syscheck-excel.py")
            response = input("Continue anyway? (y/N): ")
            if response.lower() != 'y':
                print("Exiting...")
                return
        
        # 执行巡检
        sys_check_excel()
        
    except KeyboardInterrupt:
        print("\n\n[INFO] Inspection interrupted by user.")
    except Exception as e:
        print(f"\n[ERROR] Unexpected error: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()
</code></pre>
<h4 data-id="heading-12">3.3、使用python脚本</h4>
<p><code>python3 syscheck-excel.py </code></p>
<h4 data-id="heading-13">3.4、效果</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0cfc2fdedf0487085474161f559e5ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw6aWt5bCP55S35a2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350119&amp;x-signature=C%2Bz0WvauSrVj1WwRJ52a3HTCk4s%3D" alt="微信图片_20260129184304.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e6a935859f14e8b9f6f714cab7175ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw6aWt5bCP55S35a2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350119&amp;x-signature=Xw%2BppRDN%2BvMUb2dZw7LdIiuE0J8%3D" alt="微信图片_20260129184316.jpg" loading="lazy"/></p>
<h3 data-id="heading-14">4、使用ansible批量巡检</h3>
<blockquote>
<p>同志们，现在迎来了一个问题，如果我们要巡检的服务器特别多几百台怎么办。这时候就用到我们上面配置好的ansibLe了，我只用三台做了一个例子。</p>
</blockquote>
<h4 data-id="heading-15">4.1、剧本编写</h4>
<p>1、<code>vim  check_all.yml</code></p>
<pre><code class="hljs language----" lang="---">- name: 全网服务器批量巡检
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    # 配置变量
    check_script: "syscheck.sh"
    report_dir: "./reports"
    remote_report_dir: "/tmp"

  tasks:
    # 任务1: 创建本地报告目录
    - name: 创建本地报告目录
      delegate_to: localhost
      run_once: yes
      file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0755'

    # 任务2: 分发巡检脚本
    - name: 分发巡检脚本到目标服务器
      copy:
        src: /root/ansible/syscheck.sh
        dest: /usr/local/bin/syscheck.sh
        owner: root
        group: root
        mode: '0755'

    # 任务3: 执行巡检并保存结果
    - name: 执行系统巡检
      shell: |
        # 设置环境变量，禁用终端颜色
        export TERM=dumb
        /usr/local/bin/syscheck.sh
      register: check_result
      args:
        executable: /bin/bash
      environment:
        TERM: dumb  # 禁用颜色输出，避免ANSI转义字符

    # 任务4: 保存巡检结果到临时文件
    - name: 保存巡检结果
      copy:
        content: |
          ==========================================
          服务器巡检报告
          主机名: {{ ansible_hostname }}
          IP地址: {{ ansible_default_ipv4.address | default('未知') }}
          检查时间: {{ ansible_date_time.iso8601 }}
          ==========================================

          {{ check_result.stdout }}
        dest: "{{ remote_report_dir }}/check_{{ ansible_hostname }}.txt"
        owner: root
        group: root
        mode: '0644'

    # 任务5: 拉取巡检报告到本地
    - name: 拉取巡检报告到本地
      fetch:
        src: "{{ remote_report_dir }}/check_{{ ansible_hostname }}.txt"
        dest: "{{ report_dir }}/"
        flat: no  # 按主机名创建目录结构

    # 任务6: 清理远程临时文件
    - name: 清理远程临时文件
      file:
        path: "{{ remote_report_dir }}/check_{{ ansible_hostname }}.txt"
        state: absent

    # 任务7: 显示执行摘要
    - name: 显示巡检摘要
      debug:
        msg: |
          巡检完成: {{ ansible_hostname }}
          报告已保存到: {{ report_dir }}/{{ ansible_hostname }}/check_{{ ansible_hostname }}.txt
</code></pre>
<h4 data-id="heading-16">4.2、使用剧本</h4>
<p>1、<code>ansible-playbook     check_all.yml</code></p>
<h4 data-id="heading-17">4.3 结果</h4>
<blockquote>
<p>目录都存在在/root/ansible/reports/服务器名称</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69ee24bf96684ed1a944d676eae772da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw6aWt5bCP55S35a2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350119&amp;x-signature=losaPrH0%2BJJ%2BfvTxXWz85LsMK1I%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-18">四、总结&amp;优化</h2>
<h2 data-id="heading-19">最后，马上要过年了，小饼预祝大家马年发大财，万事如意。下课！</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再被VO、BO、PO、DTO、DO绕晕！今天用一篇文章把它们讲透]]></title>    <link>https://juejin.cn/post/7600709805469171755</link>    <guid>https://juejin.cn/post/7600709805469171755</guid>    <pubDate>2026-01-30T05:23:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600709805469171755" data-draft-id="7600706866785681451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再被VO、BO、PO、DTO、DO绕晕！今天用一篇文章把它们讲透"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T05:23:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我爱娃哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/1398234522335383"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再被VO、BO、PO、DTO、DO绕晕！今天用一篇文章把它们讲透
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234522335383/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我爱娃哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T05:23:39.000Z" title="Fri Jan 30 2026 05:23:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>团队里新来的小伙伴在代码里各种对象传来传去，VO、BO、PO、DTO、DO满天飞，你问他为什么要这样设计，他支支吾吾说不清楚，最后你也被绕得云里雾里...</p>
<p>今天就来聊聊这些让人头疼的对象概念，用一篇文章把它们彻底讲透，让你再也不会被这些缩写绕晕！</p>
<h2 data-id="heading-0">一、为什么要区分这些对象？</h2>
<p>在开始详细介绍之前，我们先来理解为什么要区分这些对象。很多新手开发者可能会问："不就是个对象吗？为什么还要分这么细？直接用一个对象不就完事了？"</p>
<h3 data-id="heading-1">1.1 分层架构的需要</h3>
<p>现代Web应用通常采用分层架构设计：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 典型的分层架构</span>
<span class="hljs-comment">// Controller层 -&gt; Service层 -&gt; Repository层 -&gt; Database</span>
</code></pre>
<p>每一层都有不同的职责，需要处理不同的数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Controller层需要的数据</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserVO</span> {
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> String avatar;  <span class="hljs-comment">// 头像URL</span>
    <span class="hljs-keyword">private</span> String lastLoginTime;  <span class="hljs-comment">// 格式化的时间显示</span>
}

<span class="hljs-comment">// Service层需要的数据</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserBO</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> String password;  <span class="hljs-comment">// 密码需要在Service层处理</span>
    <span class="hljs-keyword">private</span> Integer status;   <span class="hljs-comment">// 用户状态</span>
    <span class="hljs-keyword">private</span> Date lastLoginTime;
}

<span class="hljs-comment">// Repository层需要的数据</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDO</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> String passwordHash;  <span class="hljs-comment">// 加密后的密码</span>
    <span class="hljs-keyword">private</span> Integer status;
    <span class="hljs-keyword">private</span> Date lastLoginTime;
    <span class="hljs-keyword">private</span> Date createdAt;
    <span class="hljs-keyword">private</span> Date updatedAt;
}
</code></pre>
<h3 data-id="heading-2">1.2 数据安全和隐私保护</h3>
<p>不同层面对数据的访问权限不同：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误的做法 - 直接暴露数据库对象</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-meta">@GetMapping("/users/{id}")</span>
    <span class="hljs-keyword">public</span> UserDO <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-comment">// 直接返回数据库对象，可能包含敏感信息</span>
        <span class="hljs-keyword">return</span> userService.getUserById(id);
    }
}

<span class="hljs-comment">// 正确的做法 - 使用专门的VO对象</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-meta">@GetMapping("/users/{id}")</span>
    <span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">UserBO</span> <span class="hljs-variable">userBO</span> <span class="hljs-operator">=</span> userService.getUserById(id);
        <span class="hljs-comment">// 转换为VO对象，过滤敏感信息</span>
        <span class="hljs-keyword">return</span> convertToVO(userBO);
    }
    
    <span class="hljs-keyword">private</span> UserVO <span class="hljs-title function_">convertToVO</span><span class="hljs-params">(UserBO userBO)</span> {
        <span class="hljs-type">UserVO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserVO</span>();
        vo.setUsername(userBO.getUsername());
        vo.setEmail(userBO.getEmail());
        vo.setAvatar(buildAvatarUrl(userBO.getId()));
        vo.setLastLoginTime(formatTime(userBO.getLastLoginTime()));
        <span class="hljs-comment">// 注意：不包含密码等敏感信息</span>
        <span class="hljs-keyword">return</span> vo;
    }
}
</code></pre>
<h3 data-id="heading-3">1.3 代码可维护性</h3>
<p>合理的对象分层能提高代码的可维护性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 清晰的职责分离</span>
<span class="hljs-comment">// Controller层：处理HTTP请求，参数校验，返回响应</span>
<span class="hljs-comment">// Service层：业务逻辑处理</span>
<span class="hljs-comment">// Repository层：数据访问</span>
<span class="hljs-comment">// 各层使用不同的对象，职责明确</span>
</code></pre>
<h2 data-id="heading-4">二、各种对象详解</h2>
<h3 data-id="heading-5">2.1 PO (Persistent Object) - 持久化对象</h3>
<p>PO是与数据库表结构一一对应的对象，通常与ORM框架（如MyBatis、Hibernate）配合使用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// PO对象 - 与数据库表结构对应</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPO</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-meta">@Column(name = "username")</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-meta">@Column(name = "email")</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-meta">@Column(name = "password_hash")</span>
    <span class="hljs-keyword">private</span> String passwordHash;
    
    <span class="hljs-meta">@Column(name = "status")</span>
    <span class="hljs-keyword">private</span> Integer status;
    
    <span class="hljs-meta">@Column(name = "created_at")</span>
    <span class="hljs-keyword">private</span> Date createdAt;
    
    <span class="hljs-meta">@Column(name = "updated_at")</span>
    <span class="hljs-keyword">private</span> Date updatedAt;
    
    <span class="hljs-meta">@Column(name = "last_login_time")</span>
    <span class="hljs-keyword">private</span> Date lastLoginTime;
    
    <span class="hljs-comment">// getters and setters</span>
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>与数据库表结构一一对应</li>
<li>包含数据库字段的所有信息</li>
<li>通常由ORM框架管理生命周期</li>
<li>不包含业务逻辑</li>
</ul>
<h3 data-id="heading-6">2.2 DO (Data Object) - 数据对象</h3>
<p>DO与PO非常相似，也是与数据库表结构对应的对象，但在某些团队中会有一些细微差别。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// DO对象 - 数据访问层使用的对象</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDO</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> String passwordHash;
    <span class="hljs-keyword">private</span> Integer status;
    <span class="hljs-keyword">private</span> Date createdAt;
    <span class="hljs-keyword">private</span> Date updatedAt;
    <span class="hljs-keyword">private</span> Date lastLoginTime;
    
    <span class="hljs-comment">// 可能包含一些数据访问层的辅助方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isActive</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.status == <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLocked</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.status == <span class="hljs-number">2</span>;
    }
    
    <span class="hljs-comment">// getters and setters</span>
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>与数据库表结构对应</li>
<li>在Repository层使用</li>
<li>可能包含一些简单的数据处理方法</li>
<li>不包含复杂业务逻辑</li>
</ul>
<h3 data-id="heading-7">2.3 DTO (Data Transfer Object) - 数据传输对象</h3>
<p>DTO用于在不同层之间传输数据，特别是在远程调用时使用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// DTO对象 - 用于服务间数据传输</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDTO</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> String statusDesc;  <span class="hljs-comment">// 状态描述，便于前端显示</span>
    <span class="hljs-keyword">private</span> String createTime;  <span class="hljs-comment">// 格式化的时间字符串</span>
    
    <span class="hljs-comment">// 用于创建用户的DTO</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserRequest</span> {
        <span class="hljs-keyword">private</span> String username;
        <span class="hljs-keyword">private</span> String email;
        <span class="hljs-keyword">private</span> String password;
        
        <span class="hljs-comment">// getters and setters</span>
    }
    
    <span class="hljs-comment">// 用于更新用户的DTO</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateUserRequest</span> {
        <span class="hljs-keyword">private</span> String username;
        <span class="hljs-keyword">private</span> String email;
        
        <span class="hljs-comment">// getters and setters</span>
    }
    
    <span class="hljs-comment">// 用于用户列表的DTO</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserListItem</span> {
        <span class="hljs-keyword">private</span> Long id;
        <span class="hljs-keyword">private</span> String username;
        <span class="hljs-keyword">private</span> String email;
        <span class="hljs-keyword">private</span> String statusDesc;
        
        <span class="hljs-comment">// getters and setters</span>
    }
    
    <span class="hljs-comment">// getters and setters</span>
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>用于层间数据传输</li>
<li>可以包含多个业务对象的数据</li>
<li>通常用于远程调用</li>
<li>可以进行数据格式转换</li>
</ul>
<h3 data-id="heading-8">2.4 BO (Business Object) - 业务对象</h3>
<p>BO包含业务逻辑的对象，通常在Service层使用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// BO对象 - 包含业务逻辑的对象</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserBO</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> Integer status;
    <span class="hljs-keyword">private</span> Date lastLoginTime;
    <span class="hljs-keyword">private</span> List&lt;RoleBO&gt; roles;  <span class="hljs-comment">// 用户角色</span>
    
    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">canLogin</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.status == <span class="hljs-number">1</span>;  <span class="hljs-comment">// 只有激活状态的用户才能登录</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAdmin</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.roles.stream()
                .anyMatch(role -&gt; <span class="hljs-string">"ADMIN"</span>.equals(role.getRoleName()));
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateLastLoginTime</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.lastLoginTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkPassword</span><span class="hljs-params">(String inputPassword)</span> {
        <span class="hljs-keyword">return</span> BCrypt.checkpw(inputPassword, <span class="hljs-built_in">this</span>.password);
    }
    
    <span class="hljs-comment">// getters and setters</span>
}

<span class="hljs-comment">// 角色业务对象</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoleBO</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String roleName;
    <span class="hljs-keyword">private</span> String roleDesc;
    
    <span class="hljs-comment">// getters and setters</span>
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>包含业务逻辑</li>
<li>在Service层使用</li>
<li>可能聚合多个DO/PO对象</li>
<li>是业务的核心抽象</li>
</ul>
<h3 data-id="heading-9">2.5 VO (Value Object) - 视图对象</h3>
<p>VO是展示层使用的对象，通常用于向前端返回数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// VO对象 - 用于前端展示</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserVO</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> String avatar;      <span class="hljs-comment">// 头像URL</span>
    <span class="hljs-keyword">private</span> String statusDesc;  <span class="hljs-comment">// 状态描述</span>
    <span class="hljs-keyword">private</span> String lastLoginTime;  <span class="hljs-comment">// 格式化的时间显示</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; roleNames;  <span class="hljs-comment">// 角色名称列表</span>
    
    <span class="hljs-comment">// 嵌套的VO对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetailVO</span> {
        <span class="hljs-keyword">private</span> Long id;
        <span class="hljs-keyword">private</span> String username;
        <span class="hljs-keyword">private</span> String email;
        <span class="hljs-keyword">private</span> String avatar;
        <span class="hljs-keyword">private</span> String statusDesc;
        <span class="hljs-keyword">private</span> String lastLoginTime;
        <span class="hljs-keyword">private</span> List&lt;RoleVO&gt; roles;
        <span class="hljs-keyword">private</span> String registerTime;
        
        <span class="hljs-comment">// getters and setters</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoleVO</span> {
        <span class="hljs-keyword">private</span> String roleName;
        <span class="hljs-keyword">private</span> String roleDesc;
        
        <span class="hljs-comment">// getters and setters</span>
    }
    
    <span class="hljs-comment">// getters and setters</span>
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>用于前端展示</li>
<li>数据格式友好</li>
<li>可能包含格式化后的数据</li>
<li>不包含敏感信息</li>
</ul>
<h2 data-id="heading-10">三、对象转换实践</h2>
<p>在实际开发中，我们需要在不同对象之间进行转换。</p>
<h3 data-id="heading-11">3.1 手动转换</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 手动转换示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserRepository userRepository;
    
    <span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 1. 从数据库获取DO对象</span>
        <span class="hljs-type">UserDO</span> <span class="hljs-variable">userDO</span> <span class="hljs-operator">=</span> userRepository.findById(id);
        
        <span class="hljs-comment">// 2. 转换为BO对象</span>
        <span class="hljs-type">UserBO</span> <span class="hljs-variable">userBO</span> <span class="hljs-operator">=</span> convertToBO(userDO);
        
        <span class="hljs-comment">// 3. 转换为VO对象</span>
        <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> convertToVO(userBO);
        
        <span class="hljs-keyword">return</span> userVO;
    }
    
    <span class="hljs-keyword">private</span> UserBO <span class="hljs-title function_">convertToBO</span><span class="hljs-params">(UserDO userDO)</span> {
        <span class="hljs-keyword">if</span> (userDO == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-type">UserBO</span> <span class="hljs-variable">userBO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserBO</span>();
        userBO.setId(userDO.getId());
        userBO.setUsername(userDO.getUsername());
        userBO.setEmail(userDO.getEmail());
        userBO.setPassword(userDO.getPasswordHash());
        userBO.setStatus(userDO.getStatus());
        userBO.setLastLoginTime(userDO.getLastLoginTime());
        
        <span class="hljs-keyword">return</span> userBO;
    }
    
    <span class="hljs-keyword">private</span> UserVO <span class="hljs-title function_">convertToVO</span><span class="hljs-params">(UserBO userBO)</span> {
        <span class="hljs-keyword">if</span> (userBO == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserVO</span>();
        userVO.setId(userBO.getId());
        userVO.setUsername(userBO.getUsername());
        userVO.setEmail(userBO.getEmail());
        userVO.setAvatar(buildAvatarUrl(userBO.getId()));
        userVO.setStatusDesc(getStatusDesc(userBO.getStatus()));
        userVO.setLastLoginTime(formatTime(userBO.getLastLoginTime()));
        
        <span class="hljs-keyword">return</span> userVO;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildAvatarUrl</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"https://cdn.example.com/avatar/"</span> + userId + <span class="hljs-string">".jpg"</span>;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getStatusDesc</span><span class="hljs-params">(Integer status)</span> {
        <span class="hljs-keyword">switch</span> (status) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"激活"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"锁定"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"注销"</span>;
            <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"未知"</span>;
        }
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatTime</span><span class="hljs-params">(Date date)</span> {
        <span class="hljs-keyword">if</span> (date == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }
        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
        <span class="hljs-keyword">return</span> sdf.format(date);
    }
}
</code></pre>
<h3 data-id="heading-12">3.2 使用MapStruct自动转换</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用MapStruct简化对象转换</span>
<span class="hljs-comment">// 1. 添加依赖</span>
<span class="hljs-comment">/*
&lt;dependency&gt;
    &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;
    &lt;artifactId&gt;mapstruct&lt;/artifactId&gt;
    &lt;version&gt;1.5.2.Final&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;
    &lt;artifactId&gt;mapstruct-processor&lt;/artifactId&gt;
    &lt;version&gt;1.5.2.Final&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
*/</span>

<span class="hljs-comment">// 2. 定义转换接口</span>
<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserConverter</span> {
    
    <span class="hljs-type">UserConverter</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> Mappers.getMapper(UserConverter.class);
    
    <span class="hljs-comment">// DO转BO</span>
    UserBO <span class="hljs-title function_">toBO</span><span class="hljs-params">(UserDO userDO)</span>;
    
    <span class="hljs-comment">// BO转VO</span>
    UserVO <span class="hljs-title function_">toVO</span><span class="hljs-params">(UserBO userBO)</span>;
    
    <span class="hljs-comment">// 自定义转换规则</span>
    <span class="hljs-meta">@Mapping(target = "statusDesc", expression = "java(getStatusDesc(userBO.getStatus()))")</span>
    <span class="hljs-meta">@Mapping(target = "lastLoginTime", expression = "java(formatTime(userBO.getLastLoginTime()))")</span>
    UserVO <span class="hljs-title function_">toVOWithCustom</span><span class="hljs-params">(UserBO userBO)</span>;
    
    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">getStatusDesc</span><span class="hljs-params">(Integer status)</span> {
        <span class="hljs-keyword">switch</span> (status) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"激活"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"锁定"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"注销"</span>;
            <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"未知"</span>;
        }
    }
    
    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">formatTime</span><span class="hljs-params">(Date date)</span> {
        <span class="hljs-keyword">if</span> (date == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }
        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
        <span class="hljs-keyword">return</span> sdf.format(date);
    }
}

<span class="hljs-comment">// 3. 使用转换器</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserRepository userRepository;
    
    <span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 1. 从数据库获取DO对象</span>
        <span class="hljs-type">UserDO</span> <span class="hljs-variable">userDO</span> <span class="hljs-operator">=</span> userRepository.findById(id);
        
        <span class="hljs-comment">// 2. 转换为BO对象</span>
        <span class="hljs-type">UserBO</span> <span class="hljs-variable">userBO</span> <span class="hljs-operator">=</span> UserConverter.INSTANCE.toBO(userDO);
        
        <span class="hljs-comment">// 3. 转换为VO对象</span>
        <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> UserConverter.INSTANCE.toVOWithCustom(userBO);
        
        <span class="hljs-keyword">return</span> userVO;
    }
}
</code></pre>
<h2 data-id="heading-13">四、实际应用场景</h2>
<h3 data-id="heading-14">4.1 用户管理系统的完整示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 完整的用户管理系统示例</span>

<span class="hljs-comment">// 1. 数据库实体 (PO/DO)</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPO</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-meta">@Column(name = "username")</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-meta">@Column(name = "email")</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-meta">@Column(name = "password_hash")</span>
    <span class="hljs-keyword">private</span> String passwordHash;
    
    <span class="hljs-meta">@Column(name = "status")</span>
    <span class="hljs-keyword">private</span> Integer status;
    
    <span class="hljs-meta">@Column(name = "created_at")</span>
    <span class="hljs-keyword">private</span> Date createdAt;
    
    <span class="hljs-meta">@Column(name = "updated_at")</span>
    <span class="hljs-keyword">private</span> Date updatedAt;
    
    <span class="hljs-comment">// getters and setters</span>
}

<span class="hljs-comment">// 2. 数据访问层</span>
<span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JdbcTemplate jdbcTemplate;
    
    <span class="hljs-keyword">public</span> UserDO <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM users WHERE id = ?"</span>;
        <span class="hljs-keyword">return</span> jdbcTemplate.queryForObject(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{id}, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRowMapper</span>());
    }
    
    <span class="hljs-keyword">public</span> List&lt;UserDO&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM users"</span>;
        <span class="hljs-keyword">return</span> jdbcTemplate.query(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRowMapper</span>());
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(UserDO userDO)</span> {
        <span class="hljs-keyword">if</span> (userDO.getId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 插入新用户</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO users (username, email, password_hash, status, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?)"</span>;
            jdbcTemplate.update(sql, userDO.getUsername(), userDO.getEmail(), userDO.getPasswordHash(), 
                              userDO.getStatus(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 更新用户</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"UPDATE users SET username = ?, email = ?, password_hash = ?, status = ?, updated_at = ? WHERE id = ?"</span>;
            jdbcTemplate.update(sql, userDO.getUsername(), userDO.getEmail(), userDO.getPasswordHash(), 
                              userDO.getStatus(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), userDO.getId());
        }
    }
}

<span class="hljs-comment">// 3. 业务逻辑层</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserRepository userRepository;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;
    
    <span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">createUser</span><span class="hljs-params">(CreateUserDTO createUserDTO)</span> {
        <span class="hljs-comment">// 1. DTO转BO</span>
        <span class="hljs-type">UserBO</span> <span class="hljs-variable">userBO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserBO</span>();
        userBO.setUsername(createUserDTO.getUsername());
        userBO.setEmail(createUserDTO.getEmail());
        userBO.setPassword(passwordEncoder.encode(createUserDTO.getPassword()));
        userBO.setStatus(<span class="hljs-number">1</span>); <span class="hljs-comment">// 默认激活状态</span>
        
        <span class="hljs-comment">// 2. 业务逻辑处理</span>
        <span class="hljs-keyword">if</span> (userRepository.existsByUsername(userBO.getUsername())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户名已存在"</span>);
        }
        
        <span class="hljs-keyword">if</span> (userRepository.existsByEmail(userBO.getEmail())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"邮箱已存在"</span>);
        }
        
        <span class="hljs-comment">// 3. BO转DO并保存</span>
        <span class="hljs-type">UserDO</span> <span class="hljs-variable">userDO</span> <span class="hljs-operator">=</span> convertToDO(userBO);
        userRepository.save(userDO);
        
        <span class="hljs-comment">// 4. DO转BO再转VO</span>
        userBO.setId(userDO.getId());
        <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> convertToVO(userBO);
        
        <span class="hljs-keyword">return</span> userVO;
    }
    
    <span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-type">UserDO</span> <span class="hljs-variable">userDO</span> <span class="hljs-operator">=</span> userRepository.findById(id);
        <span class="hljs-keyword">if</span> (userDO == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户不存在"</span>);
        }
        
        <span class="hljs-type">UserBO</span> <span class="hljs-variable">userBO</span> <span class="hljs-operator">=</span> convertToBO(userDO);
        <span class="hljs-keyword">return</span> convertToVO(userBO);
    }
    
    <span class="hljs-keyword">public</span> List&lt;UserListItemVO&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        List&lt;UserDO&gt; userDOs = userRepository.findAll();
        <span class="hljs-keyword">return</span> userDOs.stream()
                .map(<span class="hljs-built_in">this</span>::convertToBO)
                .map(<span class="hljs-built_in">this</span>::convertToListItemVO)
                .collect(Collectors.toList());
    }
    
    <span class="hljs-keyword">private</span> UserDO <span class="hljs-title function_">convertToDO</span><span class="hljs-params">(UserBO userBO)</span> {
        <span class="hljs-type">UserDO</span> <span class="hljs-variable">userDO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDO</span>();
        userDO.setId(userBO.getId());
        userDO.setUsername(userBO.getUsername());
        userDO.setEmail(userBO.getEmail());
        userDO.setPasswordHash(userBO.getPassword());
        userDO.setStatus(userBO.getStatus());
        userDO.setCreatedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        userDO.setUpdatedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        <span class="hljs-keyword">return</span> userDO;
    }
    
    <span class="hljs-keyword">private</span> UserBO <span class="hljs-title function_">convertToBO</span><span class="hljs-params">(UserDO userDO)</span> {
        <span class="hljs-type">UserBO</span> <span class="hljs-variable">userBO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserBO</span>();
        userBO.setId(userDO.getId());
        userBO.setUsername(userDO.getUsername());
        userBO.setEmail(userDO.getEmail());
        userBO.setPassword(userDO.getPasswordHash());
        userBO.setStatus(userDO.getStatus());
        userBO.setLastLoginTime(userDO.getUpdatedAt());
        <span class="hljs-keyword">return</span> userBO;
    }
    
    <span class="hljs-keyword">private</span> UserVO <span class="hljs-title function_">convertToVO</span><span class="hljs-params">(UserBO userBO)</span> {
        <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserVO</span>();
        userVO.setId(userBO.getId());
        userVO.setUsername(userBO.getUsername());
        userVO.setEmail(userBO.getEmail());
        userVO.setAvatar(<span class="hljs-string">"https://cdn.example.com/avatar/"</span> + userBO.getId() + <span class="hljs-string">".jpg"</span>);
        userVO.setStatusDesc(getStatusDesc(userBO.getStatus()));
        userVO.setLastLoginTime(formatTime(userBO.getLastLoginTime()));
        <span class="hljs-keyword">return</span> userVO;
    }
    
    <span class="hljs-keyword">private</span> UserListItemVO <span class="hljs-title function_">convertToListItemVO</span><span class="hljs-params">(UserBO userBO)</span> {
        <span class="hljs-type">UserListItemVO</span> <span class="hljs-variable">listItemVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserListItemVO</span>();
        listItemVO.setId(userBO.getId());
        listItemVO.setUsername(userBO.getUsername());
        listItemVO.setEmail(userBO.getEmail());
        listItemVO.setStatusDesc(getStatusDesc(userBO.getStatus()));
        <span class="hljs-keyword">return</span> listItemVO;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getStatusDesc</span><span class="hljs-params">(Integer status)</span> {
        <span class="hljs-keyword">switch</span> (status) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"激活"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"锁定"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"注销"</span>;
            <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"未知"</span>;
        }
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatTime</span><span class="hljs-params">(Date date)</span> {
        <span class="hljs-keyword">if</span> (date == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }
        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
        <span class="hljs-keyword">return</span> sdf.format(date);
    }
}

<span class="hljs-comment">// 4. 控制器层</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;UserVO&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Valid</span> CreateUserDTO createUserDTO)</span> {
        <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> userService.createUser(createUserDTO);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(userVO);
    }
    
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;UserVO&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> userService.getUserById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(userVO);
    }
    
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;UserListItemVO&gt;&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        List&lt;UserListItemVO&gt; users = userService.getAllUsers();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(users);
    }
}
</code></pre>
<h3 data-id="heading-15">4.2 DTO对象定义</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// DTO对象定义</span>

<span class="hljs-comment">// 创建用户请求DTO</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDTO</span> {
    <span class="hljs-meta">@NotBlank(message = "用户名不能为空")</span>
    <span class="hljs-meta">@Size(min = 3, max = 20, message = "用户名长度必须在3-20之间")</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-meta">@NotBlank(message = "邮箱不能为空")</span>
    <span class="hljs-meta">@Email(message = "邮箱格式不正确")</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-meta">@NotBlank(message = "密码不能为空")</span>
    <span class="hljs-meta">@Size(min = 6, max = 20, message = "密码长度必须在6-20之间")</span>
    <span class="hljs-keyword">private</span> String password;
    
    <span class="hljs-comment">// getters and setters</span>
}

<span class="hljs-comment">// 用户列表项VO</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserListItemVO</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> String statusDesc;
    
    <span class="hljs-comment">// getters and setters</span>
}

<span class="hljs-comment">// 用户详情VO</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserVO</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> String avatar;
    <span class="hljs-keyword">private</span> String statusDesc;
    <span class="hljs-keyword">private</span> String lastLoginTime;
    
    <span class="hljs-comment">// getters and setters</span>
}
</code></pre>
<h2 data-id="heading-16">五、最佳实践建议</h2>
<h3 data-id="heading-17">5.1 命名规范</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐的命名规范</span>
<span class="hljs-comment">// PO: UserPO, OrderPO</span>
<span class="hljs-comment">// DO: UserDO, OrderDO  </span>
<span class="hljs-comment">// DTO: UserDTO, CreateUserRequest, UpdateUserRequest</span>
<span class="hljs-comment">// BO: UserBO, OrderBO</span>
<span class="hljs-comment">// VO: UserVO, UserDetailVO, UserListItemVO</span>
</code></pre>
<h3 data-id="heading-18">5.2 转换工具选择</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 简单场景：手动转换</span>
<span class="hljs-comment">// 2. 复杂场景：MapStruct</span>
<span class="hljs-comment">// 3. 特殊场景：自定义转换器</span>

<span class="hljs-comment">// MapStruct配置示例</span>
<span class="hljs-meta">@Mapper(componentModel = "spring")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> {
    <span class="hljs-type">UserMapper</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> Mappers.getMapper(UserMapper.class);
    
    UserBO <span class="hljs-title function_">toBO</span><span class="hljs-params">(UserDO userDO)</span>;
    UserVO <span class="hljs-title function_">toVO</span><span class="hljs-params">(UserBO userBO)</span>;
    
    <span class="hljs-meta">@Mapping(target = "password", ignore = true)</span>  <span class="hljs-comment">// 忽略密码字段</span>
    UserVO <span class="hljs-title function_">toSafeVO</span><span class="hljs-params">(UserBO userBO)</span>;
}
</code></pre>
<h3 data-id="heading-19">5.3 分层使用建议</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 各层对象使用建议</span>
<span class="hljs-comment">// Controller层：主要使用VO和DTO</span>
<span class="hljs-comment">// Service层：主要使用BO</span>
<span class="hljs-comment">// Repository层：主要使用DO/PO</span>
<span class="hljs-comment">// 外部接口：主要使用DTO</span>
</code></pre>
<h3 data-id="heading-20">5.4 性能考虑</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 避免不必要的转换</span>
<span class="hljs-comment">// 1. 只转换需要的字段</span>
<span class="hljs-comment">// 2. 批量操作时考虑批量转换</span>
<span class="hljs-comment">// 3. 缓存转换结果（如果适用）</span>

<span class="hljs-comment">// 批量转换示例</span>
<span class="hljs-keyword">public</span> List&lt;UserVO&gt; <span class="hljs-title function_">batchConvertToVO</span><span class="hljs-params">(List&lt;UserBO&gt; userBOs)</span> {
    <span class="hljs-keyword">return</span> userBOs.stream()
            .map(<span class="hljs-built_in">this</span>::convertToVO)
            .collect(Collectors.toList());
}
</code></pre>
<h2 data-id="heading-21">六、常见误区</h2>
<h3 data-id="heading-22">6.1 误区一：所有层都用同一个对象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误的做法</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@GetMapping("/users/{id}")</span>
    <span class="hljs-keyword">public</span> UserDO <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-comment">// 直接返回数据库对象，可能暴露敏感信息</span>
        <span class="hljs-keyword">return</span> userService.getUserById(id);
    }
}

<span class="hljs-comment">// 正确的做法</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@GetMapping("/users/{id}")</span>
    <span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-comment">// 返回专门的VO对象，过滤敏感信息</span>
        <span class="hljs-keyword">return</span> userService.getUserVOById(id);
    }
}
</code></pre>
<h3 data-id="heading-23">6.2 误区二：对象之间随意转换</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误的做法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">processUser</span><span class="hljs-params">(UserVO userVO)</span> {
        <span class="hljs-comment">// 在Service层直接操作VO对象</span>
        <span class="hljs-comment">// 违反了分层原则</span>
        <span class="hljs-keyword">return</span> userVO;
    }
}

<span class="hljs-comment">// 正确的做法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">processUser</span><span class="hljs-params">(UserDTO userDTO)</span> {
        <span class="hljs-comment">// 1. DTO转BO</span>
        <span class="hljs-type">UserBO</span> <span class="hljs-variable">userBO</span> <span class="hljs-operator">=</span> convertToBO(userDTO);
        
        <span class="hljs-comment">// 2. 在BO上执行业务逻辑</span>
        processBusinessLogic(userBO);
        
        <span class="hljs-comment">// 3. BO转VO</span>
        <span class="hljs-keyword">return</span> convertToVO(userBO);
    }
}
</code></pre>
<h3 data-id="heading-24">6.3 误区三：过度设计</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误的做法 - 过度分层</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> SimpleUserVO <span class="hljs-title function_">getSimpleUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-type">UserDO</span> <span class="hljs-variable">userDO</span> <span class="hljs-operator">=</span> userRepository.findById(id);
        <span class="hljs-type">UserBO</span> <span class="hljs-variable">userBO</span> <span class="hljs-operator">=</span> userConverter.toBO(userDO);
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">userDTO</span> <span class="hljs-operator">=</span> userConverter.toDTO(userBO);
        <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> userConverter.toVO(userDTO);
        <span class="hljs-type">SimpleUserVO</span> <span class="hljs-variable">simpleUserVO</span> <span class="hljs-operator">=</span> userConverter.toSimpleVO(userVO);
        <span class="hljs-keyword">return</span> simpleUserVO;
    }
}

<span class="hljs-comment">// 正确的做法 - 合理分层</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-type">UserDO</span> <span class="hljs-variable">userDO</span> <span class="hljs-operator">=</span> userRepository.findById(id);
        <span class="hljs-type">UserBO</span> <span class="hljs-variable">userBO</span> <span class="hljs-operator">=</span> userConverter.toBO(userDO);
        <span class="hljs-keyword">return</span> userConverter.toVO(userBO);
    }
}
</code></pre>
<h2 data-id="heading-25">七、总结</h2>
<p>通过今天的详细讲解，我们了解了各种对象的概念和使用场景：</p>
<ol>
<li><strong>PO (Persistent Object)</strong>：与数据库表结构对应的持久化对象</li>
<li><strong>DO (Data Object)</strong>：数据访问层使用的数据对象</li>
<li><strong>DTO (Data Transfer Object)</strong>：用于层间数据传输的对象</li>
<li><strong>BO (Business Object)</strong>：包含业务逻辑的业务对象</li>
<li><strong>VO (Value Object)</strong>：用于前端展示的视图对象</li>
</ol>
<p><strong>核心要点</strong>：</p>
<ul>
<li>不同对象有不同的职责和使用场景</li>
<li>合理分层能提高代码的可维护性和安全性</li>
<li>对象转换是必要的，但要避免过度设计</li>
<li>选择合适的转换工具能提高开发效率</li>
</ul>
<p>掌握了这些概念，相信你在项目开发中再也不会被这些缩写绕晕了！</p>
<p><strong>今日思考</strong>：你们团队在项目中是如何使用这些对象的？有没有什么好的实践经验？欢迎在评论区分享你的看法！</p>
<hr/>
<p><em>如果你觉得这篇文章对你有帮助，欢迎分享给更多的朋友。关注"服务端技术精选"，获取更多技术干货！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring事务嵌套异常处理深度解析]]></title>    <link>https://juejin.cn/post/7600692485946556425</link>    <guid>https://juejin.cn/post/7600692485946556425</guid>    <pubDate>2026-01-30T05:23:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600692485946556425" data-draft-id="7600675515151368219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring事务嵌套异常处理深度解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T05:23:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马卡巴卡"/> <meta itemprop="url" content="https://juejin.cn/user/1892677617451163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring事务嵌套异常处理深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892677617451163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马卡巴卡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T05:23:43.000Z" title="Fri Jan 30 2026 05:23:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring事务嵌套异常处理深度解析</h2>
<h2 data-id="heading-1">问题分析</h2>
<p>您遇到的问题是<strong>Spring 事务嵌套使用时的经典陷阱</strong>：当外层方法和内层方法都标注了<code>@Transactional</code>注解，内层方法抛出异常并被外层<code>try-catch</code>捕获，但外层事务提交时仍然报错。</p>
<h3 data-id="heading-2">错误原因</h3>
<p><strong>根本原因在于 Spring 事务的传播机制和事务状态传播</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">org.springframework.transaction.UnexpectedRollbackException: 
Transaction rolled back because it has been marked <span class="hljs-keyword">as</span> <span class="hljs-keyword">rollback</span><span class="hljs-operator">-</span><span class="hljs-keyword">only</span>
</code></pre>
<p>这个错误表明<strong>事务已经被标记为 rollback-only 状态</strong>，即使异常被捕获，这个状态仍然会传播到外层事务。</p>
<h2 data-id="heading-3">事务传播机制详解</h2>
<h3 data-id="heading-4">1. 默认传播行为：REQUIRED</h3>
<p>Spring 默认的事务传播行为是<code>Propagation.REQUIRED</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span> <span class="hljs-comment">// 默认</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        innerService.innerMethod();
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 异常处理</span>
    }
}
</code></pre>
<p><strong>关键特性</strong>：</p>
<ul>
<li>
<p>如果当前已经在一个事务中，则加入当前事务</p>
</li>
<li>
<p>内外层方法<strong>共用同一个事务</strong></p>
</li>
<li>
<p>只要内层方法抛出<code>RuntimeException</code>，<strong>整个事务就会被设置成 rollback-only</strong></p>
</li>
<li>
<p>即使外层<code>try-catch</code>内层异常，<strong>该事务仍然会回滚</strong></p>
</li>
</ul>
<h3 data-id="heading-5">2. 问题演示代码</h3>
<h3 data-id="heading-6">外层方法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OuterService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">InnerService</span> innerService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserMapper</span> userMapper;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">outerMethod</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 业务操作</span>
        userMapper.<span class="hljs-title function_">insert</span>(user);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 调用内层事务方法</span>
            innerService.<span class="hljs-title function_">innerMethod</span>();
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-comment">// 捕获异常，但事务已经被标记为rollback-only</span>
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"内层方法执行异常"</span>, e);
        }
        
        <span class="hljs-comment">// 这里会报错：Transaction rolled back because it has been marked as rollback-only</span>
    }
}
</code></pre>
<h3 data-id="heading-7">内层方法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderMapper</span> orderMapper;
    
    <span class="hljs-meta">@Transactional</span> <span class="hljs-comment">// 默认Propagation.REQUIRED</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">innerMethod</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 业务操作</span>
        orderMapper.<span class="hljs-title function_">insert</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>());
        
        <span class="hljs-comment">// 抛出运行时异常</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"内层方法异常"</span>);
    }
}
</code></pre>
<h2 data-id="heading-8">解决方案</h2>
<h3 data-id="heading-9">方案一：使用 NESTED 传播行为</h3>
<p><strong>NESTED 传播行为</strong>允许内层事务作为子事务嵌套在外层事务中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.NESTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 业务逻辑</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"内层方法异常"</span>);
    }
}
</code></pre>
<p><strong>关键特性</strong>：</p>
<ul>
<li>
<p>内层事务嵌套在外层事务中作为子事务</p>
</li>
<li>
<p>内层事务失败可以单独回滚，<strong>不影响外层事务</strong></p>
</li>
<li>
<p><strong>需要外层 try-catch 内层异常</strong></p>
</li>
<li>
<p>基于数据库的 Savepoint 实现</p>
</li>
</ul>
<p><strong>使用前提</strong>：</p>
<ol>
<li>
<p>JDK 版本 1.4+（支持 java.sql.Savepoint）</p>
</li>
<li>
<p>事务管理器的<code>nestedTransactionAllowed</code>属性为 true</p>
</li>
<li>
<p><strong>外层必须 try-catch 内层异常</strong></p>
</li>
</ol>
<h3 data-id="heading-10">方案二：使用 REQUIRES_NEW 传播行为</h3>
<p><strong>REQUIRES_NEW 传播行为</strong>会创建一个全新的独立事务：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 业务逻辑</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"内层方法异常"</span>);
    }
}
</code></pre>
<p><strong>关键特性</strong>：</p>
<ul>
<li>
<p>每次调用都会创建新事务</p>
</li>
<li>
<p>如果当前已有事务，会挂起当前事务</p>
</li>
<li>
<p>内层事务独立提交或回滚，<strong>不影响外层事务</strong></p>
</li>
<li>
<p>内层事务结束后立即提交，不等外层事务</p>
</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>
<p>内层事务回滚后仍然会抛出异常</p>
</li>
<li>
<p>外层需要捕获这个异常，否则外层事务仍然会回滚</p>
</li>
</ul>
<h3 data-id="heading-11">方案三：手动控制事务状态</h3>
<p>如果必须使用默认的 REQUIRED 传播行为，可以通过<strong>编程式事务管理</strong>手动控制事务状态：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OuterService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">TransactionTemplate</span> transactionTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">InnerService</span> innerService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">outerMethod</span>(<span class="hljs-params">User user</span>) {
        transactionTemplate.<span class="hljs-title function_">execute</span>(status -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 外层事务操作</span>
                userMapper.<span class="hljs-title function_">insert</span>(user);
                
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 调用内层方法</span>
                    innerService.<span class="hljs-title function_">innerMethod</span>();
                } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
                    <span class="hljs-comment">// 内层异常处理</span>
                    log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"内层方法执行异常"</span>, e);
                    <span class="hljs-comment">// 不设置rollback-only</span>
                }
                
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
                status.<span class="hljs-title function_">setRollbackOnly</span>();
                <span class="hljs-keyword">throw</span> e;
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-12">方案四：异常重新抛出</h3>
<p>如果确实需要捕获异常并希望事务回滚，可以在捕获后<strong>重新抛出异常</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">outerMethod</span>(<span class="hljs-params">User user</span>) {
    userMapper.<span class="hljs-title function_">insert</span>(user);
    
    <span class="hljs-keyword">try</span> {
        innerService.<span class="hljs-title function_">innerMethod</span>();
    } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
        <span class="hljs-comment">// 异常处理逻辑</span>
        log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"内层方法执行异常"</span>, e);
        <span class="hljs-comment">// 重新抛出异常，触发事务回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"业务异常"</span>, e);
    }
}
</code></pre>
<h2 data-id="heading-13">最佳实践建议</h2>
<h3 data-id="heading-14">1. 事务传播策略选择</h3>





























<table><thead><tr><th>传播行为</th><th>使用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>REQUIRED</td><td>内外层事务需要完全一致的结果</td><td>简单易用，事务一致性好</td><td>异常传播难以控制</td></tr><tr><td>NESTED</td><td>内层事务失败不影响外层事务</td><td>事务粒度更细，灵活性好</td><td>依赖数据库 Savepoint 支持</td></tr><tr><td>REQUIRES_NEW</td><td>内层事务需要独立提交</td><td>完全独立，互不影响</td><td>事务资源消耗较大</td></tr></tbody></table>
<h3 data-id="heading-15">2. 异常处理最佳实践</h3>
<ol>
<li>
<p><strong>避免在事务方法中捕获 RuntimeException</strong>：<br/>
// 错误示例 @Transactional public void method() { try { // 可能抛出RuntimeException的操作 } catch (RuntimeException e) { // 事务不会回滚 } }</p>
</li>
<li>
<p><strong>使用 checked 异常进行业务异常处理</strong>：<br/>
// 正确示例 @Transactional public void method() throws BusinessException { try { // 业务操作 } catch (RuntimeException e) { throw new BusinessException("业务异常", e); } }</p>
</li>
<li>
<p><strong>明确指定 rollbackFor 属性</strong>：<br/>
@Transactional(rollbackFor = {BusinessException.class, RuntimeException.class}) public void method() throws BusinessException { // 业务逻辑 }</p>
</li>
</ol>
<h3 data-id="heading-16">3. 事务设计原则</h3>
<ol>
<li>
<p><strong>保持事务方法的单一职责</strong>：<br/>
// 好的设计 @Transactional public void createUser(User user) { // 只包含用户创建相关操作 } @Transactional public void createOrder(Order order) { // 只包含订单创建相关操作 }</p>
</li>
<li>
<p><strong>避免过长的事务</strong>：<br/>
// 避免在事务中执行耗时操作 @Transactional public void method() { // 数据库操作 // 避免：远程调用、文件IO、复杂计算等耗时操作 }</p>
</li>
<li>
<p><strong>事务边界明确</strong>：<br/>
// 事务方法应该是业务逻辑的完整单元 @Service public class BusinessService { @Transactional public void completeBusinessProcess(BusinessData data) { // 完整的业务流程 validateData(data); createEntity(data); updateRelatedData(data); sendNotification(data); } }</p>
</li>
</ol>
<h2 data-id="heading-17">总结</h2>
<p>Spring 事务嵌套异常处理的核心在于<strong>理解事务传播机制和异常传播行为</strong>：</p>
<ol>
<li>
<p><strong>默认的 REQUIRED 传播行为</strong>会导致内外层事务共用同一个事务上下文</p>
</li>
<li>
<p><strong>RuntimeException 会自动标记事务为 rollback-only</strong>，即使被捕获</p>
</li>
<li>
<p><strong>合理选择事务传播行为</strong>（NESTED 或 REQUIRES_NEW）可以解决大部分问题</p>
</li>
<li>
<p><strong>编程式事务管理</strong>提供了最灵活的事务控制方式</p>
</li>
</ol>
<p>在实际开发中，应该根据<strong>业务需求的事务一致性要求</strong>选择合适的事务传播策略，并遵循异常处理的最佳实践，以避免类似的事务陷阱。</p>
<p><strong>记住：事务管理的目标是保证数据一致性，而不是简单地捕获异常。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3侦听器实战：组件与Pinia状态监听如何高效应用？]]></title>    <link>https://juejin.cn/post/7600670487410180148</link>    <guid>https://juejin.cn/post/7600670487410180148</guid>    <pubDate>2026-01-30T03:59:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670487410180148" data-draft-id="7600692485946343433" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3侦听器实战：组件与Pinia状态监听如何高效应用？   "/> <meta itemprop="keywords" content="前端,Vue.js,Trae"/> <meta itemprop="datePublished" content="2026-01-30T03:59:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3侦听器实战：组件与Pinia状态监听如何高效应用？   
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:59:54.000Z" title="Fri Jan 30 2026 03:59:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue3 侦听器实战案例——在组件与Pinia中的应用</h2>
<h3 data-id="heading-1">一、组件内的侦听器基础</h3>
<h4 data-id="heading-2">1.1 基本概念与使用场景</h4>
<p>侦听器是Vue3中用于响应数据变化的核心工具，当你需要在数据变化时执行异步或复杂的操作时，侦听器就派上用场了。比如：</p>
<ul>
<li>数据变化时发送API请求</li>
<li>表单验证</li>
<li>复杂的状态联动</li>
</ul>
<h5 data-id="heading-3">Options API 写法</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">question</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">answer</span>: <span class="hljs-string">'Questions usually contain a question mark. ;-)'</span>,
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
    }
  },
  <span class="hljs-attr">watch</span>: {
    <span class="hljs-comment">// 当question变化时触发</span>
    <span class="hljs-title function_">question</span>(<span class="hljs-params">newQuestion, oldQuestion</span>) {
      <span class="hljs-keyword">if</span> (newQuestion.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'?'</span>)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAnswer</span>()
      }
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAnswer</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">answer</span> = <span class="hljs-string">'Thinking...'</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://yesno.wtf/api'</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">answer</span> = (<span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()).<span class="hljs-property">answer</span>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">answer</span> = <span class="hljs-string">'Error! Could not reach the API. '</span> + error
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
      }
    }
  }
}
</code></pre>
<h5 data-id="heading-4">Composition API 写法</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watch } from 'vue'

const question = ref('')
const answer = ref('Questions usually contain a question mark. ;-)')
const loading = ref(false)

// 直接监听ref
watch(question, async (newQuestion, oldQuestion) =&gt; {
  if (newQuestion.includes('?')) {
    loading.value = true
    answer.value = 'Thinking...'
    try {
      const res = await fetch('https://yesno.wtf/api')
      answer.value = (await res.json()).answer
    } catch (error) {
      answer.value = 'Error! Could not reach the API. ' + error
    } finally {
      loading.value = false
    }
  }
})
&lt;/script&gt;

&lt;template&gt;
  &lt;p&gt;
    Ask a yes/no question:
    &lt;input v-model="question" :disabled="loading" /&gt;
  &lt;/p&gt;
  &lt;p&gt;{{ answer }}&lt;/p&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-5">1.2 深度侦听器</h4>
<p>默认情况下，侦听器是浅层的，只会监听引用类型的引用变化，不会监听内部属性变化。如果需要监听嵌套对象的变化，需要使用深度侦听器。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>,
  <span class="hljs-attr">address</span>: {
    <span class="hljs-attr">city</span>: <span class="hljs-string">'New York'</span>
  }
})

<span class="hljs-comment">// 深度侦听整个对象</span>
<span class="hljs-title function_">watch</span>(user, <span class="hljs-function">(<span class="hljs-params">newUser, oldUser</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'User changed:'</span>, newUser)
}, { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> })

<span class="hljs-comment">// 或者只侦听嵌套属性</span>
<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> user.<span class="hljs-property">address</span>.<span class="hljs-property">city</span>, <span class="hljs-function">(<span class="hljs-params">newCity</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'City changed to:'</span>, newCity)
})
</code></pre>
<h4 data-id="heading-6">1.3 立即执行侦听器</h4>
<p>默认情况下，侦听器是懒加载的，只有当数据变化时才会触发。如果需要在组件创建时立即执行一次，可以使用<code>immediate: true</code>选项。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watch</span>(question, <span class="hljs-function">(<span class="hljs-params">newQuestion</span>) =&gt;</span> {
  <span class="hljs-comment">// 这个回调会在组件创建时立即执行一次</span>
}, { <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> })
</code></pre>
<h4 data-id="heading-7">1.4 watchEffect 的使用</h4>
<p><code>watchEffect</code>是Vue3提供的另一种侦听器，它会自动追踪回调函数中的响应式依赖，当依赖变化时自动触发。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, watchEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> todoId = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-comment">// 自动追踪todoId的变化</span>
<span class="hljs-title function_">watchEffect</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(
    <span class="hljs-string">`https://jsonplaceholder.typicode.com/todos/<span class="hljs-subst">${todoId.value}</span>`</span>
  )
  data.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
})
</code></pre>
<p><code>watch</code> vs <code>watchEffect</code> 对比流程图：</p>
<pre><code class="hljs">┌─────────────────┐     ┌─────────────────┐
│   watch         │     │   watchEffect   │
├─────────────────┤     ├─────────────────┤
│ 显式指定依赖    │     │ 自动追踪依赖    │
│ 懒加载（默认）  │     │ 立即执行        │
│ 可获取新旧值    │     │ 无法获取旧值    │
│ 更精确控制      │     │ 更简洁语法      │
└─────────────────┘     └─────────────────┘
</code></pre>
<h3 data-id="heading-8">二、Pinia中的侦听器应用</h3>
<h4 data-id="heading-9">2.1 监听Pinia Store中的状态</h4>
<p>在Pinia中，</p>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcdbbb1837f8c093252e61f46dbf0a2e7%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cdbbb1837f8c093252e61f46dbf0a2e7/" ref="nofollow noopener noreferrer">Vue 3中何时用watch，何时用watchEffect？核心区别及性能优化策略是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F09551ab614c463a6d6ca69818e8c2d52%2F" target="_blank" title="https://blog.cmdragon.cn/posts/09551ab614c463a6d6ca69818e8c2d52/" ref="nofollow noopener noreferrer">Vue 3中如何有效管理侦听器的暂停、恢复与副作用清理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb7bca5d20f628ac09f7192ad935ef664%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b7bca5d20f628ac09f7192ad935ef664/" ref="nofollow noopener noreferrer">Vue 3 watchEffect：如何实现响应式依赖的自动追踪与副作用管理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2c6cdb100a20f10c7e7d4413617c7ea9%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2c6cdb100a20f10c7e7d4413617c7ea9/" ref="nofollow noopener noreferrer">Vue 3 watch如何利用immediate、once、deep选项实现初始化、一次性与深度监听？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F757a1728bc1b9c0c8b317b0354d85568%2F" target="_blank" title="https://blog.cmdragon.cn/posts/757a1728bc1b9c0c8b317b0354d85568/" ref="nofollow noopener noreferrer">Vue 3中watch如何高效监听多数据源、计算结果与数组变化？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F8e70552f0f61e0dc8c7f567a2d272345%2F" target="_blank" title="https://blog.cmdragon.cn/posts/8e70552f0f61e0dc8c7f567a2d272345/" ref="nofollow noopener noreferrer">Vue 3中watch监听ref和reactive的核心差异与注意事项是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fdde70ab90dc5062c435e0501f5a6e7cb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/dde70ab90dc5062c435e0501f5a6e7cb/" ref="nofollow noopener noreferrer">Vue3中Watch与watchEffect的核心差异及适用场景是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1f5ed5047850ed52c0fd0386f76bd4ae%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1f5ed5047850ed52c0fd0386f76bd4ae/" ref="nofollow noopener noreferrer">Vue 3自定义指令如何赋能表单自动聚焦与防抖输入的高效实现？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe3d4e128815ad731611b8ef29e37616b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e3d4e128815ad731611b8ef29e37616b/" ref="nofollow noopener noreferrer">Vue3中如何优雅实现支持多绑定变量和修饰符的双向绑定组件？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7d1caedd822f70542aa0eed67e30963b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7d1caedd822f70542aa0eed67e30963b/" ref="nofollow noopener noreferrer">Vue 3表单验证如何从基础规则到异步交互构建完整验证体系？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F3687a5437ab56cb082b5b813d5577a40%2F" target="_blank" title="https://blog.cmdragon.cn/posts/3687a5437ab56cb082b5b813d5577a40/" ref="nofollow noopener noreferrer">Vue3响应式系统如何支撑表单数据的集中管理、动态扩展与实时计算？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fad67c4eb6d76cf7707bdfe6a8146c34f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ad67c4eb6d76cf7707bdfe6a8146c34f/" ref="nofollow noopener noreferrer">Vue3跨组件通信中，全局事件总线与provide/inject该如何正确选择？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1c1e80d697cca0923f29ec70ebb8ccd1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1c1e80d697cca0923f29ec70ebb8ccd1/" ref="nofollow noopener noreferrer">Vue3表单事件处理：v-model如何实现数据绑定、验证与提交？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb990828143d70aa87f9aa52e16692e48%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b990828143d70aa87f9aa52e16692e48/" ref="nofollow noopener noreferrer">Vue应用如何基于DOM事件传播机制与事件修饰符实现高效事件处理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb44316e0866e9f2e6aef927dbcf5152b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b44316e0866e9f2e6aef927dbcf5152b/" ref="nofollow noopener noreferrer">Vue3中如何在调用事件处理函数时同时传递自定义参数和原生DOM事件？参数顺序有哪些注意事项？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F021636c2a06f5e2d3d01977a12ddf559%2F" target="_blank" title="https://blog.cmdragon.cn/posts/021636c2a06f5e2d3d01977a12ddf559/" ref="nofollow noopener noreferrer">从捕获到冒泡：Vue事件修饰符如何重塑事件执行顺序？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb3cddf7023ab537e623a61bc01dab6bb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b3cddf7023ab537e623a61bc01dab6bb/" ref="nofollow noopener noreferrer">Vue事件处理：内联还是方法事件处理器，该如何抉择？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd4d9607ce1bc34cc3bda0a1a46c40f6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd4d9607ce1bc34cc3bda0a1a46c40f6/" ref="nofollow noopener noreferrer">Vue事件绑定中v-on与@语法如何取舍？参数传递与原生事件处理有哪些实战技巧？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa5f2bacb74476fd7f5e02bb3f1ba6b2b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a5f2bacb74476fd7f5e02bb3f1ba6b2b/" ref="nofollow noopener noreferrer">Vue 3中列表排序时为何必须复制数组而非直接修改原始数据？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd3b06b57fb7f126787e6ed22dce1e341%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d3b06b57fb7f126787e6ed22dce1e341/" ref="nofollow noopener noreferrer">Vue虚拟滚动如何将列表DOM数量从万级降至十位数？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F3100cc5a2e16f8dac36f722594e6af32%2F" target="_blank" title="https://blog.cmdragon.cn/posts/3100cc5a2e16f8dac36f722594e6af32/" ref="nofollow noopener noreferrer">Vue3中v-if与v-for直接混用为何会报错？计算属性如何解决优先级冲突？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F455dc2d47c38d12c1cf350e490041e8b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/455dc2d47c38d12c1cf350e490041e8b/" ref="nofollow noopener noreferrer">为何在Vue3递归组件中必须用v-if判断子项存在？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F3f842bbd7ba0f9c91151b983bf784c8b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/3f842bbd7ba0f9c91151b983bf784c8b/" ref="nofollow noopener noreferrer">Vue3列表渲染中，如何用数组方法与计算属性优化v-for的数据处理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1eb3ffac668a743843b5ea1738301d40%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1eb3ffac668a743843b5ea1738301d40/" ref="nofollow noopener noreferrer">Vue v-for的key：为什么它能解决列表渲染中的“玄学错误”？选错会有哪些后果？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F138b13c5341f6a1fa9015400433a3611%2F" target="_blank" title="https://blog.cmdragon.cn/posts/138b13c5341f6a1fa9015400433a3611/" ref="nofollow noopener noreferrer">Vue3中v-for与v-if为何不能直接共存于同一元素？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0242a94dc552b93a1bc335ac4fc33db5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0242a94dc552b93a1bc335ac4fc33db5/" ref="nofollow noopener noreferrer">Vue3中v-if与v-show的本质区别及动态组件状态保持的关键策略是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F97c66a18ae0e9b57c6a69b8b3a41ddf6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/97c66a18ae0e9b57c6a69b8b3a41ddf6/" ref="nofollow noopener noreferrer">Vue3中v-show如何通过CSS修改display属性控制条件显示？与v-if的应用场景该如何区分？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F8a1ddfac64b25062ac56403e4c1201d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/8a1ddfac64b25062ac56403e4c1201d2/" ref="nofollow noopener noreferrer">Vue3条件渲染中v-if系列指令如何合理使用与规避错误？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F218c3a59282c3b757447ee08a01937bb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/218c3a59282c3b757447ee08a01937bb/" ref="nofollow noopener noreferrer">Vue3动态样式控制：ref、reactive、watch与computed的应用场景与区别是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1bab953e41f66ac53de099fa9fe76483%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1bab953e41f66ac53de099fa9fe76483/" ref="nofollow noopener noreferrer">Vue3中动态样式数组的后项覆盖规则如何与计算属性结合实现复杂状态样式管理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3响应式系统中，对象新增属性、数组改索引、原始值代理的问题如何解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffile-converter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/file-converter" ref="nofollow noopener noreferrer">文件格式转换器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fm3u8-player" target="_blank" title="https://tools.cmdragon.cn/zh/apps/m3u8-player" ref="nofollow noopener noreferrer">M3U8在线播放器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fquick-image-design" target="_blank" title="https://tools.cmdragon.cn/zh/apps/quick-image-design" ref="nofollow noopener noreferrer">快图设计 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-advanced" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-advanced" ref="nofollow noopener noreferrer">高级文字转图片转换器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
我们可以使用Vue的`watch`函数来监听store中的状态变化。
<p>首先创建一个Pinia store：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// stores/counter.js</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello Pinia'</span>
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
    }
  }
})
</code></pre>
<p>然后在组件中监听store状态：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { watch } from 'vue'
import { useCounterStore } from '@/stores/counter'

const counterStore = useCounterStore()

// 监听单个状态
watch(() =&gt; counterStore.count, (newCount, oldCount) =&gt; {
  console.log(`Count changed from ${oldCount} to ${newCount}`)
})

// 监听多个状态
watch([() =&gt; counterStore.count, () =&gt; counterStore.message], 
  ([newCount, newMessage], [oldCount, oldMessage]) =&gt; {
    console.log(`Count: ${oldCount} -&gt; ${newCount}`)
    console.log(`Message: ${oldMessage} -&gt; ${newMessage}`)
  }
)

// 深度监听整个store
watch(counterStore, (newStore, oldStore) =&gt; {
  console.log('Store changed:', newStore)
}, { deep: true })
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-10">2.2 实战案例：表单状态同步</h4>
<p>假设我们有一个表单组件，需要将表单数据同步到Pinia store中，同时当store中的数据变化时，表单也需要更新。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watch } from 'vue'
import { useFormStore } from '@/stores/form'

const formStore = useFormStore()

// 本地表单数据
const localForm = ref({
  name: '',
  email: ''
})

// 组件创建时同步store数据到本地
localForm.value = { ...formStore.formData }

// 监听本地表单变化，同步到store
watch(localForm, (newForm) =&gt; {
  formStore.updateFormData(newForm)
}, { deep: true })

// 监听store数据变化，同步到本地
watch(() =&gt; formStore.formData, (newForm) =&gt; {
  localForm.value = { ...newForm }
}, { deep: true })
&lt;/script&gt;

&lt;template&gt;
  &lt;form&gt;
    &lt;input v-model="localForm.name" placeholder="Name" /&gt;
    &lt;input v-model="localForm.email" placeholder="Email" type="email" /&gt;
  &lt;/form&gt;
&lt;/template&gt;
</code></pre>
<p>Pinia store代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// stores/form.js</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useFormStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'form'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">formData</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>
    }
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">updateFormData</span>(<span class="hljs-params">newData</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span> = { ...newData }
    }
  }
})
</code></pre>
<h3 data-id="heading-11">三、课后Quiz</h3>
<h4 data-id="heading-12">问题1：watch和watchEffect的主要区别是什么？</h4>
<p><strong>答案解析：</strong></p>
<ol>
<li><strong>依赖追踪方式</strong>：watch需要显式指定依赖，而watchEffect会自动追踪回调中的响应式依赖。</li>
<li><strong>执行时机</strong>：watch默认是懒加载的，只有当依赖变化时才会触发；watchEffect会在组件创建时立即执行一次。</li>
<li><strong>参数获取</strong>：watch可以获取新旧值，而watchEffect无法获取旧值。</li>
<li><strong>使用场景</strong>：watch适合需要精确控制依赖和获取新旧值的场景；watchEffect适合简单的副作用处理，语法更简洁。</li>
</ol>
<h4 data-id="heading-13">问题2：如何在Pinia中监听整个store的变化？</h4>
<p><strong>答案解析：</strong>
可以直接将store实例作为watch的第一个参数，并设置<code>deep: true</code>选项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watch</span>(counterStore, <span class="hljs-function">(<span class="hljs-params">newStore, oldStore</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Store changed:'</span>, newStore)
}, { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> })
</code></pre>
<p>或者使用getter函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> ({ ...counterStore }), <span class="hljs-function">(<span class="hljs-params">newStore</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Store changed:'</span>, newStore)
})
</code></pre>
<h3 data-id="heading-14">四、常见报错解决方案</h3>
<h4 data-id="heading-15">1. 报错："watch() expects a source value as the first argument"</h4>
<p><strong>原因</strong>：传递给watch的第一个参数不是有效的响应式源。比如直接传递了一个非响应式的对象或值。
<strong>解决方法</strong>：</p>
<ul>
<li>确保监听的是ref、reactive对象，或者返回响应式值的getter函数。</li>
<li>如果要监听对象的某个属性，使用getter函数：<code>watch(() =&gt; obj.property, callback)</code></li>
</ul>
<h4 data-id="heading-16">2. 报错："deep option is ignored when watching a getter"</h4>
<p><strong>原因</strong>：当使用getter函数作为watch源时，deep选项会被忽略，因为getter函数返回的是一个值，而不是引用类型。
<strong>解决方法</strong>：</p>
<ul>
<li>如果需要深度监听，直接监听整个reactive对象，或者在getter函数中返回对象的副本：<code>watch(() =&gt; ({ ...obj }), callback, { deep: true })</code></li>
</ul>
<h4 data-id="heading-17">3. 报错："Maximum call stack size exceeded"</h4>
<p><strong>原因</strong>：在watch回调中修改了被监听的数据，导致无限循环。
<strong>解决方法</strong>：</p>
<ul>
<li>确保在watch回调中不会修改被监听的同一个数据。</li>
<li>如果需要修改，可以使用条件判断或者使用<code>watchEffect</code>代替。</li>
</ul>
<h4 data-id="heading-18">4. Pinia中watch不触发</h4>
<p><strong>原因</strong>：可能是因为没有正确使用getter函数来监听store中的状态。
<strong>解决方法</strong>：</p>
<ul>
<li>使用getter函数来监听store中的状态：<code>watch(() =&gt; store.count, callback)</code></li>
<li>确保store中的状态是响应式的，使用Pinia的state定义方式。</li>
</ul>
<h3 data-id="heading-19">五、参考链接</h3>
<ul>
<li>Vue3 侦听器官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fwatchers.html" target="_blank" title="https://vuejs.org/guide/essentials/watchers.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></li>
<li>Pinia 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpinia.vuejs.org%2F" target="_blank" title="https://pinia.vuejs.org/" ref="nofollow noopener noreferrer">pinia.vuejs.org/</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3逻辑写法]]></title>    <link>https://juejin.cn/post/7600704706551152680</link>    <guid>https://juejin.cn/post/7600704706551152680</guid>    <pubDate>2026-01-30T04:12:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600704706551152680" data-draft-id="7599483314160762899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3逻辑写法"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-30T04:12:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Aniugel"/> <meta itemprop="url" content="https://juejin.cn/user/3034307824198407"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3逻辑写法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307824198407/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Aniugel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:12:40.000Z" title="Fri Jan 30 2026 04:12:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h3 data-id="heading-0">test.vue</h3>
<pre><code class="hljs language-js" lang="js">&lt;!-- 图片展示 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-main</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cateList1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-row</span> <span class="hljs-attr">:gutter</span>=<span class="hljs-string">"20"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-col</span> <span class="hljs-attr">:span</span>=<span class="hljs-string">"6"</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, i) in dataList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"i"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-card</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 15px; position: relative"</span> <span class="hljs-attr">shadow</span>=<span class="hljs-string">"hover"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-image</span>
              <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100%; height: 150px"</span>
              <span class="hljs-attr">:src</span>=<span class="hljs-string">"item.url"</span>
              <span class="hljs-attr">fit</span>=<span class="hljs-string">"cover"</span>
            /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pic_title"</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pic_edit"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-checkbox</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"item.checked"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"selectImg(item)"</span> /&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"openDialog(item)"</span>&gt;</span>重命名<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"delPic(item.id)"</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-card</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-col</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-row</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-pagination</span>
        <span class="hljs-attr">v-model:current-page</span>=<span class="hljs-string">"querData.page"</span>
        <span class="hljs-attr">v-model:page-size</span>=<span class="hljs-string">"querData.limit"</span>
        <span class="hljs-attr">:page-sizes</span>=<span class="hljs-string">"[2, 8, 15, 20]"</span>
        <span class="hljs-attr">small</span>=<span class="hljs-string">"small"</span>
        <span class="hljs-attr">background</span>=<span class="hljs-string">"background"</span>
        <span class="hljs-attr">layout</span>=<span class="hljs-string">"total, sizes, prev, pager, next, jumper"</span>
        <span class="hljs-attr">:total</span>=<span class="hljs-string">"total"</span>
        @<span class="hljs-attr">size-change</span>=<span class="hljs-string">"handleSizeChange"</span>
        @<span class="hljs-attr">current-change</span>=<span class="hljs-string">"handleCurrentChange"</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 重命名 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"dialogVisible"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"重命名"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"40%"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"formDate"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"图片名称"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formDate.name"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-footer"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"dialogVisible = false"</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"submitOk"</span>&gt;</span> 确定 <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 上传图片 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"dialogVisibleUpload"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"上传图片"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"40%"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">UploadImg</span>
        <span class="hljs-attr">:data</span>=<span class="hljs-string">"{ image_class_id: querData.id }"</span>
        @<span class="hljs-attr">success</span>=<span class="hljs-string">"uploadSuccess"</span>
      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">UploadImg</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-footer"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"dialogVisible = false"</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"dialogVisible = false"</span>&gt;</span>
            确定
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-main</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive, ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { getPicListByIdFn, editPicNameFn, delPicFn } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/pic.js'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span>, <span class="hljs-title class_">ElMessageBox</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UploadImg</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/UploadImg.vue'</span>

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">num</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-number">1</span>,
  },
})

<span class="hljs-keyword">const</span> checkedImg = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> dataList.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">checked</span>)
})

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>(<span class="hljs-string">'selectImgData'</span>)

<span class="hljs-comment">//选择图片事件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">selectImg</span> = (<span class="hljs-params">item</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item)
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">checked</span> &amp;&amp; checkedImg.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> &gt; props.<span class="hljs-property">num</span>) {
    item.<span class="hljs-property">checked</span> = <span class="hljs-literal">false</span>
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`只能选择<span class="hljs-subst">${props.num}</span>张图片`</span>)
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'selectImgData'</span>, checkedImg.<span class="hljs-property">value</span>)
}

<span class="hljs-comment">//上传图片对话框显示和隐藏</span>
<span class="hljs-keyword">const</span> dialogVisibleUpload = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">openDialogUpload</span> = (<span class="hljs-params"/>) =&gt; {
  dialogVisibleUpload.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadSuccess</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">getPicList</span>()
}

<span class="hljs-comment">//删除</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">delPic</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id</span>) =&gt; {
  <span class="hljs-keyword">const</span> isdel = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">'是否删除?'</span>, <span class="hljs-string">'删除'</span>, {
    <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
    <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">'取消'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
  }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> err)

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isdel)

  <span class="hljs-keyword">if</span> (isdel !== <span class="hljs-string">'confirm'</span>) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">delPicFn</span>([id])
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
  <span class="hljs-title function_">getPicList</span>()
}

<span class="hljs-keyword">const</span> dialogVisible = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-comment">//打开对话框</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">openDialog</span> = (<span class="hljs-params">item</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item)
  formDate.<span class="hljs-property">id</span> = item.<span class="hljs-property">id</span>
  formDate.<span class="hljs-property">name</span> = item.<span class="hljs-property">name</span>
  dialogVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">const</span> formDate = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
})

<span class="hljs-comment">//确定修改图片名称</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">submitOk</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">editPicNameFn</span>(formDate.<span class="hljs-property">id</span>, formDate.<span class="hljs-property">name</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">msg</span> &amp;&amp; res.<span class="hljs-property">msg</span> !== <span class="hljs-string">'ok'</span>) {
    <span class="hljs-keyword">return</span>
  }
  dialogVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
  <span class="hljs-title function_">getPicList</span>()
}

<span class="hljs-keyword">const</span> querData = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-comment">//图库分类ID</span>
  <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">limit</span>: <span class="hljs-number">8</span>,
})

<span class="hljs-comment">//分页</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSizeChange</span> = (<span class="hljs-params">val</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val)
  querData.<span class="hljs-property">limit</span> = val
  <span class="hljs-title function_">getPicList</span>()
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCurrentChange</span> = (<span class="hljs-params">val</span>) =&gt; {
  querData.<span class="hljs-property">page</span> = val
  <span class="hljs-title function_">getPicList</span>()
}

<span class="hljs-keyword">const</span> dataList = <span class="hljs-title function_">ref</span>([])
<span class="hljs-keyword">const</span> total = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getPicList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPicListByIdFn</span>(querData.<span class="hljs-property">id</span>, querData.<span class="hljs-property">page</span>, querData.<span class="hljs-property">limit</span>)

  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">msg</span> &amp;&amp; res.<span class="hljs-property">msg</span> !== <span class="hljs-string">'ok'</span>) {
    <span class="hljs-keyword">return</span>
  }
  dataList.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    item.<span class="hljs-property">checked</span> = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span> item
  })
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dataList.<span class="hljs-property">value</span>)
  total.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">totalCount</span>
}
<span class="hljs-comment">//getPicList()</span>

<span class="hljs-comment">//获取父组件分类id</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getDataById</span> = (<span class="hljs-params">id</span>) =&gt; {
  <span class="hljs-comment">//id 分类id</span>
  querData.<span class="hljs-property">id</span> = id
  <span class="hljs-title function_">getPicList</span>()
}
<span class="hljs-comment">// 还需要通过defineExpose暴露据和方法让子组件许可和确认,接下来在父组件中就可以查看子组件中暴露的数据与方法</span>
<span class="hljs-title function_">defineExpose</span>({
  getDataById,
  openDialogUpload,
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"less"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
:<span class="hljs-built_in">deep</span>(.el-card__body) {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0px</span> <span class="hljs-meta">!important</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre>
<h3 data-id="heading-1">api.js</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/request.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getPicCateFn</span>=(<span class="hljs-params">page,limit=<span class="hljs-number">10</span></span>)=&gt;{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
        <span class="hljs-attr">url</span>:<span class="hljs-string">`admin/getPicsCateList/<span class="hljs-subst">${page}</span>`</span>,
        <span class="hljs-attr">method</span>:<span class="hljs-string">'GET'</span>,
        <span class="hljs-attr">params</span>:{
            limit
        }
    })
}

<span class="hljs-comment">//修改图库分类</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">editPicCateFn</span>=(<span class="hljs-params">id,data</span>)=&gt;{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
        <span class="hljs-attr">url</span>:<span class="hljs-string">`admin/editPicsList/<span class="hljs-subst">${id}</span>`</span>,
        <span class="hljs-attr">method</span>:<span class="hljs-string">'POST'</span>,
        data
    })
}

<span class="hljs-comment">//删除图库分类</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">delCateFn</span>=(<span class="hljs-params">id</span>)=&gt;{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
        <span class="hljs-attr">url</span>:<span class="hljs-string">`admin/delPicsCateList/<span class="hljs-subst">${id}</span>/delete`</span>,
        <span class="hljs-attr">method</span>:<span class="hljs-string">'POST'</span>
    })
}

<span class="hljs-comment">//获取图库分类</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getPicListByIdFn</span>=(<span class="hljs-params">id,page,limit</span>)=&gt;{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
        <span class="hljs-attr">url</span>:<span class="hljs-string">`admin/getPicList/<span class="hljs-subst">${id}</span>/image/<span class="hljs-subst">${page}</span>`</span>,
        <span class="hljs-attr">method</span>:<span class="hljs-string">'GET'</span>,
        <span class="hljs-attr">params</span>:{
            limit
        }
    })
}

<span class="hljs-comment">//删除图片</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">delPicFn</span>=(<span class="hljs-params">ids</span>)=&gt;{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
        <span class="hljs-attr">url</span>:<span class="hljs-string">"admin/delPic/delete_all"</span>,
        <span class="hljs-attr">method</span>:<span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">data</span>:{
            ids
        }
    })
}
</code></pre>
<h3 data-id="heading-2">until/js</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 修改密码</span>
<span class="hljs-keyword">import</span> { editPasswordFn } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/login.js'</span>
<span class="hljs-keyword">import</span> { ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useEditPassword</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">//修改对话是否显示</span>
    <span class="hljs-keyword">const</span> dialogVisible = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
    <span class="hljs-comment">//form表单dom元素</span>
    <span class="hljs-keyword">const</span> ruleFormRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
    <span class="hljs-comment">//修改数据源</span>
    <span class="hljs-keyword">const</span> ruleForm = <span class="hljs-title function_">reactive</span>({
        <span class="hljs-attr">oldpassword</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">repassword</span>: <span class="hljs-string">''</span>
    })
    <span class="hljs-comment">//验证规则</span>
    <span class="hljs-keyword">const</span> rules = <span class="hljs-title function_">reactive</span>({
        <span class="hljs-attr">oldpassword</span>: [
            { <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入旧密码'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
            { <span class="hljs-attr">min</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入5到15个字符'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
        ],
        <span class="hljs-attr">password</span>: [
            { <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入新密码'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
            { <span class="hljs-attr">min</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">max</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入5到15个字符'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
        ],
    })
    <span class="hljs-comment">//关闭对话框的回调</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">closeHandle</span> = (<span class="hljs-params"/>) =&gt; {
        ruleFormRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">resetFields</span>()
    }

    <span class="hljs-comment">//确定修改密码</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">submitOk</span> = (<span class="hljs-params"/>) =&gt; {
        ruleFormRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">validate</span>(<span class="hljs-keyword">async</span> isValid =&gt; {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isValid)
            <span class="hljs-keyword">if</span> (!isValid) {
                <span class="hljs-keyword">return</span>
            }
            <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">editPasswordFn</span>(ruleForm)
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
            <span class="hljs-keyword">if</span> (res.<span class="hljs-property">msg</span> &amp;&amp; res.<span class="hljs-property">msg</span> !== <span class="hljs-string">'ok'</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(res.<span class="hljs-property">msg</span>)
            }
            <span class="hljs-title class_">ElMessage</span>({
                <span class="hljs-attr">message</span>: <span class="hljs-string">'密码修改成功'</span>,
                <span class="hljs-attr">type</span>: <span class="hljs-string">'success'</span>,
            })

            dialogVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>

        })
    }

    <span class="hljs-keyword">return</span> {
        dialogVisible,
        ruleFormRef,
        ruleForm,
        rules,
        closeHandle,
        submitOk
    }
}
</code></pre>
<h3 data-id="heading-3">router.js</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> {createRouter,createWebHashHistory} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/index.js'</span>
<span class="hljs-keyword">import</span> np <span class="hljs-keyword">from</span> <span class="hljs-string">'nprogress'</span>

<span class="hljs-comment">//路由匹配规则</span>
<span class="hljs-keyword">const</span> routes=[
    {
        <span class="hljs-attr">path</span>:<span class="hljs-string">'/'</span>,
        <span class="hljs-attr">redirect</span>: <span class="hljs-string">'/home'</span>
    },
    {
        <span class="hljs-attr">path</span>:<span class="hljs-string">'/home'</span>,
        <span class="hljs-attr">component</span>:<span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/Home.vue'</span>),
        <span class="hljs-attr">children</span>:[
            {
                <span class="hljs-attr">path</span>:<span class="hljs-string">'/home'</span>,
                <span class="hljs-attr">name</span>:<span class="hljs-string">'/home'</span>,
                <span class="hljs-attr">component</span>:<span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/HomeIndex.vue'</span>),
                <span class="hljs-attr">meta</span>:{
                    <span class="hljs-attr">title</span>:<span class="hljs-string">'后台首页'</span>
                }
            },
            {
                <span class="hljs-attr">path</span>:<span class="hljs-string">'/notice/list'</span>,
                <span class="hljs-attr">name</span>:<span class="hljs-string">'/notice/list'</span>,
                <span class="hljs-attr">component</span>:<span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/test.vue'</span>),
                <span class="hljs-attr">meta</span>:{
                    <span class="hljs-attr">title</span>:<span class="hljs-string">'公告管理'</span>
                }
            }
        ]
    },
    {
        <span class="hljs-attr">path</span>:<span class="hljs-string">'/login'</span>,
        <span class="hljs-attr">component</span>:<span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/Login.vue'</span>)

    },
    <span class="hljs-comment">//捕获404</span>
    {
        <span class="hljs-attr">path</span>:<span class="hljs-string">'/:pathMatch(.*)*'</span>,
        <span class="hljs-attr">name</span>:<span class="hljs-string">'NotFound'</span>,
        <span class="hljs-attr">component</span>:<span class="hljs-function">()=&gt;</span><span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/404.vue'</span>)

    }
]

<span class="hljs-keyword">const</span> router=<span class="hljs-title function_">createRouter</span>({
    <span class="hljs-attr">history</span>:<span class="hljs-title function_">createWebHashHistory</span>(),
    routes
})

<span class="hljs-comment">//全局路由守卫</span>
router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> (to,<span class="hljs-keyword">from</span>,next)=&gt;{
    np.<span class="hljs-title function_">start</span>()
    <span class="hljs-comment">//获取token</span>
    <span class="hljs-keyword">const</span> tokenStr=<span class="hljs-variable language_">window</span>.<span class="hljs-property">sessionStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>)
    <span class="hljs-keyword">if</span>(tokenStr){
        <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-string">'getUserInfo'</span>)
    }
    <span class="hljs-comment">//如果没有登录</span>
    <span class="hljs-keyword">if</span>(!tokenStr&amp;&amp;to.<span class="hljs-property">path</span>!==<span class="hljs-string">'/login'</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>(<span class="hljs-string">'/login'</span>)
    <span class="hljs-comment">//如果已经登录路</span>
    <span class="hljs-keyword">if</span>(tokenStr&amp;&amp;to.<span class="hljs-property">path</span>==<span class="hljs-string">'/login'</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>({<span class="hljs-attr">path</span>:<span class="hljs-keyword">from</span>.<span class="hljs-property">path</span>?<span class="hljs-keyword">from</span>.<span class="hljs-property">path</span>:<span class="hljs-string">'/'</span>})
    }   
    <span class="hljs-title function_">next</span>()
})

<span class="hljs-comment">//后置全局路由守卫</span>
router.<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">(<span class="hljs-params">to,<span class="hljs-keyword">from</span>,next</span>)=&gt;</span>{
    np.<span class="hljs-title function_">done</span>()

})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router

</code></pre>
<h3 data-id="heading-4">store.js</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>
<span class="hljs-keyword">import</span> { getUserInfoFn } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/login'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>({
    <span class="hljs-title function_">state</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">//管理员信息</span>
            <span class="hljs-attr">userInfo</span>: {
            },
            <span class="hljs-comment">//导航菜单</span>
            <span class="hljs-attr">menu</span>:[],
            <span class="hljs-comment">//控制导航是否隐藏</span>
            <span class="hljs-attr">isShow</span>:<span class="hljs-literal">false</span>
        }
    },
    <span class="hljs-attr">mutations</span>: {
        <span class="hljs-title function_">setUserInfo</span>(<span class="hljs-params">state, userInfo</span>) {
            state.<span class="hljs-property">userInfo</span> = userInfo
            state.<span class="hljs-property">menu</span>=userInfo.<span class="hljs-property">menus</span>
        },
        <span class="hljs-comment">//修改isShow</span>
        <span class="hljs-title function_">setShow</span>(<span class="hljs-params">state</span>){
            state.<span class="hljs-property">isShow</span>=!state.<span class="hljs-property">isShow</span>
        }
    },
    <span class="hljs-attr">actions</span>: {
        <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params">context</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
                <span class="hljs-title function_">getUserInfoFn</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {  
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)                  
                    context.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'setUserInfo'</span>, res.<span class="hljs-property">data</span>)
                    <span class="hljs-title function_">resolve</span>(res)
                }).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title function_">reject</span>(err))
            })
        }
    }
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store

</code></pre>
<h3 data-id="heading-5">App.vue</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router/index.js'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/index.js'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'nprogress/nprogress.css'</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">ElementPlus</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'element-plus/dist/index.css'</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">ElementPlusIconsVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@element-plus/icons-vue'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, component] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-title class_">ElementPlusIconsVue</span>)) {
    app.<span class="hljs-title function_">component</span>(key, component)
}

app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ElementPlus</span>)

app.<span class="hljs-title function_">use</span>(router)

app.<span class="hljs-title function_">use</span>(store)

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h3 data-id="heading-6">Header.vue</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 左列 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo"</span>&gt;</span> 商城后台管理系统 <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"setIsShow"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Fold</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 右列 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"f_right"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-tooltip</span>
        <span class="hljs-attr">effect</span>=<span class="hljs-string">"dark"</span>
        <span class="hljs-attr">content</span>=<span class="hljs-string">"刷新"</span>
        <span class="hljs-attr">:enterable</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">placement</span>=<span class="hljs-string">"bottom"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"refHandle"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Refresh</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-tooltip</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">el-tooltip</span>
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!isFullscreen"</span>
        <span class="hljs-attr">effect</span>=<span class="hljs-string">"dark"</span>
        <span class="hljs-attr">content</span>=<span class="hljs-string">"全屏"</span>
        <span class="hljs-attr">:enterable</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">placement</span>=<span class="hljs-string">"bottom"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggle"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">FullScreen</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-tooltip</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">el-tooltip</span>
        <span class="hljs-attr">v-else</span>
        <span class="hljs-attr">effect</span>=<span class="hljs-string">"dark"</span>
        <span class="hljs-attr">content</span>=<span class="hljs-string">"退出全屏"</span>
        <span class="hljs-attr">:enterable</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">placement</span>=<span class="hljs-string">"bottom"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggle"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">FullScreen</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-tooltip</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown</span> @<span class="hljs-attr">command</span>=<span class="hljs-string">"commandHandle"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-avatar</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"30"</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"$store.state.userInfo.avatar"</span> /&gt;</span>
          {{ $store.state.userInfo.username }}
          <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-icon--right"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-left: 10px"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">arrow-down</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">dropdown</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown-menu</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown-item</span> <span class="hljs-attr">command</span>=<span class="hljs-string">"editPassword"</span>&gt;</span>修改密码<span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown-item</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown-item</span> <span class="hljs-attr">command</span>=<span class="hljs-string">"logout"</span>&gt;</span>退出登录<span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown-item</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown-menu</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 修改密码对话框 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span>
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"dialogVisible"</span>
      <span class="hljs-attr">title</span>=<span class="hljs-string">"修改密码"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">"40%"</span>
      @<span class="hljs-attr">close</span>=<span class="hljs-string">"closeHandle"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">"ruleFormRef"</span>
        <span class="hljs-attr">:model</span>=<span class="hljs-string">"ruleForm"</span>
        <span class="hljs-attr">:rules</span>=<span class="hljs-string">"rules"</span>
        <span class="hljs-attr">label-width</span>=<span class="hljs-string">"100px"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"原密码"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"oldpassword"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"ruleForm.oldpassword"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"新密码"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"password"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"ruleForm.password"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"确认密码"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"repassword"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"ruleForm.repassword"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-footer"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"dialogVisible = false"</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"submitOk"</span>&gt;</span> 确定 <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useEditPassword } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/useEditPWP.js'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Fold</span>, <span class="hljs-title class_">Refresh</span>, <span class="hljs-title class_">FullScreen</span>, <span class="hljs-title class_">ArrowDown</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@element-plus/icons-vue'</span>
<span class="hljs-keyword">import</span> { useFullscreen } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vueuse/core'</span>

<span class="hljs-keyword">import</span> { useStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessageBox</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useStore</span>()
<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()

<span class="hljs-keyword">const</span> { toggle, isFullscreen } = <span class="hljs-title function_">useFullscreen</span>()
<span class="hljs-keyword">const</span> { dialogVisible, ruleFormRef, ruleForm, rules, closeHandle, submitOk } =
  <span class="hljs-title function_">useEditPassword</span>()

<span class="hljs-comment">//刷新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">refHandle</span> = (<span class="hljs-params"/>) =&gt; {
  location.<span class="hljs-title function_">reload</span>()
}

<span class="hljs-comment">//退出</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> isLogout = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">'是否退出?'</span>, <span class="hljs-string">'提示'</span>, {
    <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
    <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">'取消'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
  }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> err)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isLogout)
  <span class="hljs-keyword">if</span> (isLogout !== <span class="hljs-string">'confirm'</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-comment">//清空本地存储</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">sessionStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'token'</span>)
  <span class="hljs-comment">//清空vuex数据</span>
  store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'setUserInfo'</span>, {})
  router.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/login'</span> })
}

<span class="hljs-comment">//监听下拉菜单事件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">commandHandle</span> = (<span class="hljs-params">res</span>) =&gt; {
  <span class="hljs-keyword">if</span> (res == <span class="hljs-string">'editPassword'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'修改密码'</span>)
    dialogVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res == <span class="hljs-string">'logout'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'退出'</span>)
    <span class="hljs-title function_">logout</span>()
  }
}

<span class="hljs-comment">//控制导航菜单的显示和隐藏</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setIsShow</span> = (<span class="hljs-params"/>) =&gt; {
  store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'setShow'</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">echarts.vue</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-card</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"e_title"</span>&gt;</span>
                订单统计
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">el-check-tag</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"selectOp(item.value)"</span> <span class="hljs-attr">:checked</span>=<span class="hljs-string">"ops == item.value"</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, i) in option"</span>
                        <span class="hljs-attr">:key</span>=<span class="hljs-string">"i"</span>&gt;</span>
                        {{ item.text }}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">el-check-tag</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"e_main"</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-card</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> echarts <span class="hljs-keyword">from</span> <span class="hljs-string">'echarts'</span>;
<span class="hljs-keyword">import</span> { getEchartsFn } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/home.js'</span>
<span class="hljs-keyword">import</span> { ref, onMounted,onBeforeUnmount } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>


<span class="hljs-keyword">var</span> myChart
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">var</span> chartDom = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'e_main'</span>);
    myChart = echarts.<span class="hljs-title function_">init</span>(chartDom);
    <span class="hljs-title function_">getEchartsData</span>()    
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getEchartsData</span>=<span class="hljs-keyword">async</span> (<span class="hljs-params"/>)=&gt;{

    <span class="hljs-keyword">var</span> option;
    option = {
        <span class="hljs-attr">xAxis</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'category'</span>,
            <span class="hljs-attr">data</span>: []
        },
        <span class="hljs-attr">yAxis</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'value'</span>
        },
        <span class="hljs-attr">series</span>: [
            {
                <span class="hljs-attr">data</span>: [],
                <span class="hljs-attr">type</span>: <span class="hljs-string">'bar'</span>,
                <span class="hljs-attr">showBackground</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">backgroundStyle</span>: {
                    <span class="hljs-attr">color</span>: <span class="hljs-string">'rgba(180, 180, 180, 0.2)'</span>
                }
            }
        ]
    };
    
    myChart.<span class="hljs-title function_">showLoading</span>()
    <span class="hljs-keyword">const</span> res=<span class="hljs-keyword">await</span> <span class="hljs-title function_">getEchartsFn</span>(ops.<span class="hljs-property">value</span>)
    myChart.<span class="hljs-title function_">hideLoading</span>()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
    <span class="hljs-keyword">if</span>(res.<span class="hljs-property">msg</span>&amp;&amp;res.<span class="hljs-property">msg</span>!==<span class="hljs-string">'ok'</span>){
        <span class="hljs-keyword">return</span>
    }
    option.<span class="hljs-property">xAxis</span>.<span class="hljs-property">data</span>=res.<span class="hljs-property">data</span>.<span class="hljs-property">x</span>
    option.<span class="hljs-property">series</span>[<span class="hljs-number">0</span>].<span class="hljs-property">data</span>=res.<span class="hljs-property">data</span>.<span class="hljs-property">y</span>

    option &amp;&amp; myChart.<span class="hljs-title function_">setOption</span>(option);

}

<span class="hljs-keyword">const</span> ops = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'week'</span>)
<span class="hljs-keyword">const</span> option = [
    {
        <span class="hljs-attr">text</span>: <span class="hljs-string">'月'</span>,
        <span class="hljs-attr">value</span>: <span class="hljs-string">'month'</span>
    },
    {
        <span class="hljs-attr">text</span>: <span class="hljs-string">'周'</span>,
        <span class="hljs-attr">value</span>: <span class="hljs-string">'week'</span>
    },
    {
        <span class="hljs-attr">text</span>: <span class="hljs-string">'天'</span>,
        <span class="hljs-attr">value</span>: <span class="hljs-string">'hour'</span>
    }
]

<span class="hljs-comment">//选择时间事件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">selectOp</span> = (<span class="hljs-params">op</span>) =&gt; {
    ops.<span class="hljs-property">value</span> = op
    <span class="hljs-title function_">getEchartsData</span>()
}

<span class="hljs-comment">//销毁期间生命周期</span>
<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-keyword">if</span>(myChart){
        echarts.<span class="hljs-title function_">dispose</span>(myChart)
    }
})

<span class="hljs-keyword">const</span> props=<span class="hljs-title function_">defineProps</span>({
    <span class="hljs-attr">value</span>:{
        <span class="hljs-attr">type</span>:<span class="hljs-title class_">Number</span>,
        <span class="hljs-attr">default</span>:<span class="hljs-number">0</span>
    }
})
<span class="hljs-keyword">const</span> data=<span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">num</span>:<span class="hljs-number">0</span>
})

<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>){
    gsap.<span class="hljs-title function_">to</span>(data,{
        <span class="hljs-comment">//0.5毫秒之后 将初始数据 动画替换成父组件传递过来的数据</span>
        <span class="hljs-attr">duration</span>:<span class="hljs-number">0.5</span>,
        <span class="hljs-attr">num</span>:props.<span class="hljs-property">value</span>
    })
}

<span class="hljs-title function_">fn</span>()

<span class="hljs-title function_">watch</span>(<span class="hljs-function">()=&gt;</span>props.<span class="hljs-property">value</span>,<span class="hljs-function">()=&gt;</span><span class="hljs-title function_">fn</span>())

&lt;el-form-item label=<span class="hljs-string">"菜单图标"</span> v-<span class="hljs-keyword">if</span>=<span class="hljs-string">"formData.menu == 1"</span>&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">IconSelect</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.icon"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">IconSelect</span>&gt;</span></span>
&lt;/el-form-item&gt;

<span class="hljs-comment">//接收v-model的值</span>
<span class="hljs-title function_">defineProps</span>({
    <span class="hljs-attr">modelValue</span>: <span class="hljs-title class_">String</span>
})

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'update:modelValue'</span>])

<span class="hljs-comment">//选择图标事件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeHandle</span> = (<span class="hljs-params">e</span>) =&gt; {

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e)
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">"update:modelValue"</span>, e)
}

<span class="hljs-keyword">const</span> dialogVisible = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> titleVal = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'新增'</span>)
<span class="hljs-keyword">const</span> skusId = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-comment">//新增参数</span>
<span class="hljs-keyword">const</span> formData = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">order</span>: <span class="hljs-number">50</span>,
    <span class="hljs-attr">status</span>: <span class="hljs-number">1</span>

})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">openDialog</span> = (<span class="hljs-params"/>) =&gt; {
    titleVal.<span class="hljs-property">value</span> = <span class="hljs-string">'新增'</span>
    formData.<span class="hljs-property">name</span> = <span class="hljs-string">''</span>
    formData.<span class="hljs-property">default</span> = <span class="hljs-string">''</span>
    formData.<span class="hljs-property">order</span> = <span class="hljs-number">50</span>
    formData.<span class="hljs-property">status</span> = <span class="hljs-number">1</span>
    dialogVisibl
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>


</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 🌟 JavaScript 字符串反转全攻略｜7 种方法手把手教学（小白也能懂！）]]></title>    <link>https://juejin.cn/post/7600764857768853554</link>    <guid>https://juejin.cn/post/7600764857768853554</guid>    <pubDate>2026-01-30T03:27:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600764857768853554" data-draft-id="7600990891205427227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 🌟 JavaScript 字符串反转全攻略｜7 种方法手把手教学（小白也能懂！）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-30T03:27:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不会敲代码1"/> <meta itemprop="url" content="https://juejin.cn/user/1927884034804425"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 🌟 JavaScript 字符串反转全攻略｜7 种方法手把手教学（小白也能懂！）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927884034804425/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不会敲代码1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:27:53.000Z" title="Fri Jan 30 2026 03:27:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌟 JavaScript 字符串反转全攻略｜7 种方法手把手教学（小白也能懂！）</h2>
<blockquote>
<p>适合刚学 JS 的你｜代码逐行注释｜原理图解｜避坑指南｜掘金首发</p>
</blockquote>
<p>大家好，我是正在努力学前端的「小码农」。最近在练习字符串操作时，被一道看似简单的题卡住了： <strong>“怎么把 'hello' 变成 'olleh'？”</strong><br/>
网上一搜，发现居然有 <strong>7 种写法</strong>！有的短短一行，有的要写十几行；有的快如闪电，有的可能让浏览器卡住…<br/>
别慌！今天我就用 <strong>最直白的大白话 + 最详细的注释 + 最真实的踩坑记录</strong>，带你从零搞懂所有方法——<strong>不讲概念，只讲人话；不堆代码，只讲为什么。</strong><br/>
（文末附可直接复制粘贴的完整代码 ✅）</p>
<hr/>
<h3 data-id="heading-1">🔍 一、先搞明白：什么是“反转字符串”？</h3>
<p>✅ 简单说：就是把字符串里的字符顺序<strong>完全倒过来</strong>。<br/>
比如：</p>
<ul>
<li><code>'abc'</code> → <code>'cba'</code></li>
<li><code>'JavaScript'</code> → <code>'tpircSavaJ'</code></li>
<li><code>'12345'</code> → <code>'54321'</code></li>
</ul>
<p>⚠️ 注意：字符串在 JS 中是<strong>不可变的</strong>（不能直接改），所以每次反转都必须<strong>创建一个新字符串</strong>。</p>
<hr/>
<h3 data-id="heading-2">🧩 二、7 种方法详解（附完整可运行代码）</h3>
<blockquote>
<p>💡 每种方法都包含：<br/>
✅ <strong>一句话原理</strong>｜✅ <strong>带中文注释的代码</strong>｜✅ <strong>小白友好图解</strong>｜✅ <strong>什么时候用 / 什么时候避开</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-3">方法 1️⃣：三步走大法（最常用！推荐新手首选）</h4>
<p><code>split()</code> → <code>reverse()</code> → <code>join()</code></p>
<pre><code class="hljs language-perl" lang="perl">function reverseStr(str) {
  <span class="hljs-regexp">//</span> 第一步：把字符串 <span class="hljs-string">'abc'</span> 拆成数组 [<span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>]
  // <span class="hljs-keyword">split</span>(<span class="hljs-string">''</span>) 中的 <span class="hljs-string">''</span> 表示“按每个字符拆开”
  const arr = str.<span class="hljs-keyword">split</span>(<span class="hljs-string">''</span>);

  <span class="hljs-regexp">//</span> 第二步：把数组 [<span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>] 反转成 [<span class="hljs-string">'c'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'a'</span>]
  // <span class="hljs-keyword">reverse</span>() 是数组的内置方法，会直接修改原数组！
  const reversedArr = arr.<span class="hljs-keyword">reverse</span>();

  <span class="hljs-regexp">//</span> 第三步：把数组 [<span class="hljs-string">'c'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'a'</span>] 合并成字符串 <span class="hljs-string">'cba'</span>
  // <span class="hljs-keyword">join</span>(<span class="hljs-string">''</span>) 中的 <span class="hljs-string">''</span> 表示“中间不加任何符号”
  const result = reversedArr.join(<span class="hljs-string">''</span>);

  <span class="hljs-keyword">return</span> result;
}

console.log(reverseStr(<span class="hljs-string">'abc'</span>)); <span class="hljs-regexp">//</span> 输出：<span class="hljs-string">'cba'</span>
</code></pre>
<p>🧠 <strong>小白理解图</strong>：<br/>
<code>'abc'</code><br/>
→ 拆开：<code>['a', 'b', 'c']</code><br/>
→ 翻个身：<code>['c', 'b', 'a']</code><br/>
→ 粘起来：<code>'cba'</code></p>
<p>✅ <strong>优点</strong>：代码短、好记、适合绝大多数场景<br/>
⚠️ <strong>注意</strong>：对 emoji（如 <code>'👨‍💻'</code>）或带音标的字（如 <code>'café'</code>）在老版本浏览器中可能出错（后面会教怎么安全处理）</p>
<hr/>
<h4 data-id="heading-4">方法 2️⃣：传统 for 循环（最稳！兼容性无敌）</h4>
<pre><code class="hljs language-ini" lang="ini">function reverseStr(str) {
  let <span class="hljs-attr">result</span> = <span class="hljs-string">''</span><span class="hljs-comment">; // 准备一个空盒子，用来装反转后的字符</span>

  // 从最后一个字符开始，往前数：<span class="hljs-attr">i</span> = <span class="hljs-number">2</span> → <span class="hljs-number">1</span> → <span class="hljs-number">0</span>（因为 <span class="hljs-string">'abc'</span> 长度是<span class="hljs-number">3</span>，索引是<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>）
  for (let <span class="hljs-attr">i</span> = str.length - <span class="hljs-number">1</span><span class="hljs-comment">; i &gt;= 0; i--) {</span>
    <span class="hljs-attr">result</span> = result + str[i]<span class="hljs-comment">; // 把当前字符 str[i] 加到 result 后面</span>
  }

  return result<span class="hljs-comment">;</span>
}

console.log(reverseStr('abc'))<span class="hljs-comment">; // 输出：'cba'</span>
</code></pre>
<p>🧠 <strong>小白理解图</strong>（以 <code>'abc'</code> 为例）：</p>





























<table><thead><tr><th>循环次数</th><th>i 的值</th><th>str[i]</th><th>result 变化</th></tr></thead><tbody><tr><td>第1次</td><td>2</td><td><code>'c'</code></td><td><code>'' + 'c'</code> → <code>'c'</code></td></tr><tr><td>第2次</td><td>1</td><td><code>'b'</code></td><td><code>'c' + 'b'</code> → <code>'cb'</code></td></tr><tr><td>第3次</td><td>0</td><td><code>'a'</code></td><td><code>'cb' + 'a'</code> → <code>'cba'</code></td></tr></tbody></table>
<p>✅ <strong>优点</strong>：兼容所有浏览器（IE6 都能跑！）、逻辑清晰、性能好<br/>
💡 <strong>小技巧</strong>：<code>str.length - 1</code> 是最后一个字符的下标（JS 数组/字符串下标从 0 开始）</p>
<hr/>
<h4 data-id="heading-5">方法 3️⃣：for...of 循环（更现代、更优雅）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">function <span class="hljs-title">reverseStr</span>(<span class="hljs-params">str</span>)</span> {
  <span class="hljs-keyword">let</span> result = <span class="hljs-string">''</span>; <span class="hljs-comment">// 还是那个空盒子</span>

  <span class="hljs-comment">// for...of 会自动一个一个拿出字符串里的字符</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-built_in">char</span> of str) {
    result = <span class="hljs-built_in">char</span> + result; <span class="hljs-comment">// 关键！不是加在后面，而是加在前面！</span>
  }

  <span class="hljs-keyword">return</span> result;
}

console.log(reverseStr(<span class="hljs-string">'abc'</span>)); <span class="hljs-comment">// 输出：'cba'</span>
</code></pre>
<p>🧠 <strong>小白理解图</strong>（以 <code>'abc'</code> 为例）：</p>

























<table><thead><tr><th>循环次数</th><th>char</th><th>result 变化</th></tr></thead><tbody><tr><td>第1次</td><td><code>'a'</code></td><td><code>'' + 'a'</code> → <code>'a'</code></td></tr><tr><td>第2次</td><td><code>'b'</code></td><td><code>'b' + 'a'</code> → <code>'ba'</code></td></tr><tr><td>第3次</td><td><code>'c'</code></td><td><code>'c' + 'ba'</code> → <code>'cba'</code></td></tr></tbody></table>
<p>✅ <strong>优点</strong>：代码更简洁、天然支持 emoji 和中文等复杂字符（Unicode 安全）<br/>
💡 <strong>记住口诀</strong>：“for...of 遍历字符，<code>char + result</code> 就是反转”</p>
<hr/>
<h4 data-id="heading-6">方法 4️⃣：展开运算符法（ES6 新写法，强烈推荐！）</h4>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reverseStr</span><span class="hljs-params">(str)</span></span> {
  // [...str] 就像魔法：把 <span class="hljs-string">'abc'</span> 变成 [<span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>]
  // 然后照旧反转 + 合并
  <span class="hljs-keyword">return</span> [...str].<span class="hljs-built_in">reverse</span>().join(<span class="hljs-string">''</span>);
}

console.<span class="hljs-built_in">log</span>(reverseStr(<span class="hljs-string">'abc'</span>)); // 输出：<span class="hljs-string">'cba'</span>
</code></pre>
<p>✅ <strong>为什么比方法1更好？</strong></p>
<ul>
<li><code>split('')</code> 在老浏览器中对 <code>'👨‍💻'</code> 可能拆成乱码；</li>
<li><code>[...str]</code> 是 ES6 标准，<strong>完美支持所有 emoji、中文、带音标文字</strong>！<br/>
✅ <strong>一句话总结</strong>：这是方法1的升级版，<strong>兼顾简洁 + 安全</strong>，现在写代码就用它！</li>
</ul>
<hr/>
<h4 data-id="heading-7">方法 5️⃣：递归法（理解“自己调自己”，锻炼思维）</h4>
<pre><code class="hljs language-python" lang="python">function reverseStr(<span class="hljs-built_in">str</span>) {
  // 🚨 退出条件（非常重要！没有它会无限循环直到崩溃）
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">str</span> === <span class="hljs-string">''</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>; // 空字符串反转还是空字符串
  }

  // 🧩 递归核心：把第一个字符放到“剩下部分的反转结果”后面
  // <span class="hljs-built_in">str</span>.substring(<span class="hljs-number">1</span>) → 去掉第一个字符（如 <span class="hljs-string">'abc'</span> → <span class="hljs-string">'bc'</span>）
  // <span class="hljs-built_in">str</span>.charAt(<span class="hljs-number">0</span>) → 拿到第一个字符（如 <span class="hljs-string">'abc'</span> → <span class="hljs-string">'a'</span>）
  <span class="hljs-keyword">return</span> reverseStr(<span class="hljs-built_in">str</span>.substring(<span class="hljs-number">1</span>)) + <span class="hljs-built_in">str</span>.charAt(<span class="hljs-number">0</span>);
}

console.log(reverseStr(<span class="hljs-string">'abc'</span>)); // 输出：<span class="hljs-string">'cba'</span>
</code></pre>
<p>🧠 <strong>小白理解图</strong>（递归调用过程）：</p>
<pre><code class="hljs language-bash" lang="bash">reverseStr(<span class="hljs-string">'abc'</span>)
├─ reverseStr(<span class="hljs-string">'bc'</span>) + <span class="hljs-string">'a'</span>
   ├─ reverseStr(<span class="hljs-string">'c'</span>) + <span class="hljs-string">'b'</span>
      └─ reverseStr(<span class="hljs-string">''</span>) + <span class="hljs-string">'c'</span> → <span class="hljs-string">''</span> + <span class="hljs-string">'c'</span> = <span class="hljs-string">'c'</span>
   → <span class="hljs-string">'c'</span> + <span class="hljs-string">'b'</span> = <span class="hljs-string">'cb'</span>
→ <span class="hljs-string">'cb'</span> + <span class="hljs-string">'a'</span> = <span class="hljs-string">'cba'</span>
</code></pre>
<p>⚠️ <strong>重要警告</strong>：</p>
<ul>
<li>✅ 适合学习算法思想、理解分治（Divide &amp; Conquer）</li>
<li>❌ <strong>不要在项目里用！</strong> 字符串太长（比如 10000 字符）会爆栈（Stack Overflow），浏览器直接卡死！<br/>
💡 <strong>类比</strong>：就像俄罗斯套娃，一层层打开，最后一层是最小的（空字符串），然后一层层合上。</li>
</ul>
<hr/>
<h4 data-id="heading-8">方法 6️⃣：reduce 法（函数式编程风，酷炫但需理解）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reverseStr</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-keyword">return</span> [...str].<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">reversed, char</span>) =&gt;</span> {
    <span class="hljs-comment">// reversed：之前累积的结果（初始为空字符串 ''）</span>
    <span class="hljs-comment">// char：当前正在处理的字符</span>
    <span class="hljs-keyword">return</span> char + reversed; <span class="hljs-comment">// 把新字符加到前面，实现反转</span>
  }, <span class="hljs-string">''</span>); <span class="hljs-comment">// '' 是初始值（reversed 的起点）</span>
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">reverseStr</span>(<span class="hljs-string">'abc'</span>)); <span class="hljs-comment">// 输出：'cba'</span>
</code></pre>
<p>🧠 <strong>小白理解图</strong>（以 <code>'abc'</code> 为例）：</p>



































<table><thead><tr><th>步骤</th><th>reversed（之前结果）</th><th>char</th><th>返回值（新 reversed）</th></tr></thead><tbody><tr><td>初始</td><td><code>''</code></td><td>—</td><td>—</td></tr><tr><td>第1次</td><td><code>''</code></td><td><code>'a'</code></td><td><code>'a' + ''</code> → <code>'a'</code></td></tr><tr><td>第2次</td><td><code>'a'</code></td><td><code>'b'</code></td><td><code>'b' + 'a'</code> → <code>'ba'</code></td></tr><tr><td>第3次</td><td><code>'ba'</code></td><td><code>'c'</code></td><td><code>'c' + 'ba'</code> → <code>'cba'</code></td></tr></tbody></table>
<p>✅ <strong>优点</strong>：代码非常“函数式”，没有变量赋值，适合喜欢数学思维的同学<br/>
⚠️ <strong>注意</strong>：<code>reduce</code> 本质也是循环，性能和 for...of 差不多，但初学者可能觉得绕。</p>
<hr/>
<h4 data-id="heading-9">方法 7️⃣：Array.from() 法（方法4的“双胞胎”，同样安全）</h4>
<pre><code class="hljs language-python" lang="python">function reverseStr(<span class="hljs-built_in">str</span>) {
  // Array.<span class="hljs-keyword">from</span>(<span class="hljs-built_in">str</span>) 和 [...<span class="hljs-built_in">str</span>] 功能完全一样，都是把字符串变成数组
  <span class="hljs-keyword">return</span> Array.<span class="hljs-keyword">from</span>(<span class="hljs-built_in">str</span>).reverse().join(<span class="hljs-string">''</span>);
}

console.log(reverseStr(<span class="hljs-string">'abc'</span>)); // 输出：<span class="hljs-string">'cba'</span>
</code></pre>
<p>✅ <strong>小知识</strong>：<code>Array.from(str)</code> 和 <code>[...str]</code> 是等价的，你可以任选其一。<br/>
📚 <strong>为什么多一种写法？</strong></p>
<ul>
<li><code>Array.from()</code> 还可以做更多事（比如转换类数组对象），是更通用的 API；</li>
<li><code>[...str]</code> 更简短，是日常开发中的“快捷写法”。</li>
</ul>
<hr/>
<h3 data-id="heading-10">🚨 三、新手必看！3 个真实踩坑记录（血泪教训）</h3>
<h4 data-id="heading-11">❌ 坑1：<code>split('')</code> 对 emoji 处理错误（老浏览器）</h4>
<pre><code class="hljs language-perl" lang="perl">// 在 Chrome <span class="hljs-number">80</span> 以下或某些手机浏览器中：
<span class="hljs-string">'👨‍💻'</span>.<span class="hljs-keyword">split</span>(<span class="hljs-string">''</span>); <span class="hljs-regexp">//</span> 可能返回 [<span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>]（乱码！）
[...<span class="hljs-string">'👨‍💻'</span>];        <span class="hljs-regexp">//</span> 正确返回 [<span class="hljs-string">'👨‍💻'</span>]（一个完整的 emoji）
</code></pre>
<p>✅ <strong>解决方案</strong>：统一用 <code>[...str]</code> 或 <code>Array.from(str)</code></p>
<h4 data-id="heading-12">❌ 坑2：递归调用忘记写“退出条件”</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 错误示范！没有 if 判断，会一直调用自己直到崩溃</span>
function <span class="hljs-built_in">badReverse</span>(str) {
  return <span class="hljs-built_in">badReverse</span>(str.substring(<span class="hljs-number">1</span>)) + str<span class="hljs-selector-class">.charAt</span>(<span class="hljs-number">0</span>);
}
<span class="hljs-built_in">badReverse</span>('abc'); <span class="hljs-comment">// ❌ 页面卡死！</span>
</code></pre>
<p>✅ <strong>解决方案</strong>：递归函数第一行必须写清楚“什么时候停止”</p>
<h4 data-id="heading-13">❌ 坑3：<code>reverse()</code> 修改了原数组（副作用！）</h4>
<pre><code class="hljs language-css" lang="css">const arr = <span class="hljs-selector-attr">[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]</span>;
arr<span class="hljs-selector-class">.reverse</span>(); // 直接把 arr 改成了 <span class="hljs-selector-attr">[<span class="hljs-string">'c'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'a'</span>]</span>！
console<span class="hljs-selector-class">.log</span>(arr); // 输出：<span class="hljs-selector-attr">[<span class="hljs-string">'c'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'a'</span>]</span>（原数组被改了！）
</code></pre>
<p>✅ <strong>解决方案</strong>：如果不想改原数组，先用 <code>slice()</code> 复制一份：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">newArr</span> = arr.slice().reverse()<span class="hljs-comment">; // slice() 创建副本</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">📊 四、终极对比表（选哪个？看这里！）</h3>













































































<table><thead><tr><th>方法</th><th>代码长度</th><th>学习难度</th><th>运行速度</th><th>Unicode 安全</th><th>推荐指数</th><th>适合谁</th></tr></thead><tbody><tr><td><code>split+reverse+join</code></td><td>⭐⭐⭐⭐</td><td>⭐⭐</td><td>⭐⭐⭐⭐</td><td>❌（老环境）</td><td>⭐⭐⭐</td><td>快速验证想法</td></tr><tr><td><strong>传统 for 循环</strong></td><td>⭐⭐⭐</td><td>⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>✅</td><td>⭐⭐⭐⭐⭐</td><td><strong>新手入门首选！</strong> 兼容性最强</td></tr><tr><td><strong>for...of 循环</strong></td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>✅</td><td>⭐⭐⭐⭐⭐</td><td><strong>现代项目首选！</strong> 简洁安全</td></tr><tr><td><strong>展开运算符 <code>[...str]</code></strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>✅</td><td>⭐⭐⭐⭐⭐</td><td><strong>2024 年推荐写法！</strong> 简洁+安全</td></tr><tr><td>递归</td><td>⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐</td><td>✅</td><td>⭐⭐</td><td>学算法/面试准备</td></tr><tr><td>reduce</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>✅</td><td>⭐⭐⭐</td><td>喜欢函数式编程者</td></tr><tr><td>Array.from</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>✅</td><td>⭐⭐⭐⭐</td><td>作为 <code>[...str]</code> 的替代</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>给你的明确建议</strong>：</p>
<ul>
<li><strong>刚学 JS？</strong> 从 <strong>方法2（for 循环）</strong> 开始，彻底搞懂每一步！</li>
<li><strong>想写现代代码？</strong> 主力用 <strong>方法4（展开运算符）</strong> ，又短又安全！</li>
<li><strong>面试被问“还有别的方法吗？”</strong> 把方法1、2、4、5 能说清楚就够了！</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-15">💡 五、课后小练习（动手才记得牢！）</h3>
<p>请尝试用 <strong>至少2种方法</strong> 实现以下功能，并在控制台验证：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. 反转一个句子（注意空格位置）</span>
<span class="hljs-built_in">reverseStr</span>('hello world'); <span class="hljs-comment">// 应该输出 'dlrow olleh'</span>

<span class="hljs-comment">// 2. 反转带 emoji 的字符串</span>
<span class="hljs-built_in">reverseStr</span>('I ❤️ JS 🌟'); <span class="hljs-comment">// 应该保持 ❤️ 和 🌟 完整</span>

<span class="hljs-comment">// 3. 写一个“安全版”函数：对非字符串输入也友好</span>
<span class="hljs-built_in">reverseStr</span>(null);    <span class="hljs-comment">// 应该输出 ''</span>
<span class="hljs-built_in">reverseStr</span>(<span class="hljs-number">123</span>);     <span class="hljs-comment">// 应该输出 '321'</span>
</code></pre>
<blockquote>
<p>✅ <strong>答案提示</strong>：用 <code>String(input)</code> 可以把任意值转成字符串！</p>
</blockquote>
<hr/>
<h3 data-id="heading-16">🌈 六、写在最后：编程不是背代码，而是理解“为什么”</h3>
<p>这7种方法，没有绝对的“最好”，只有“最适合当前场景”。</p>
<ul>
<li>你可能会发现：<strong>方法2（for循环）虽然代码长，但每一步都清晰可见；</strong></li>
<li><strong>方法4（展开运算符）虽然只有一行，但背后是整个 ES6 的设计哲学。</strong></li>
</ul>
<blockquote>
<p>🌟 <strong>送你一句我学到的话</strong>：<br/>
<strong>“优秀的程序员，不是知道最多方法的人，而是知道在什么情况下选择最合适方法的人。”</strong></p>
</blockquote>
<p>如果你觉得这篇笔记帮到了你，欢迎 👍 点赞、💬 评论、🔄 转发！<br/>
关注我，一起把前端学得明明白白、踏踏实实 💪<br/>
（代码已全部测试通过，复制即用！）</p>
<hr/>
<p>📌 <strong>附：7种方法完整可运行代码（一键复制）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法1：split+reverse+join（基础版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse1</span>(<span class="hljs-params">str</span>) { <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>); }

<span class="hljs-comment">// 方法2：传统for循环（最稳）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse2</span>(<span class="hljs-params">str</span>) { <span class="hljs-keyword">let</span> r=<span class="hljs-string">''</span>; <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=str.<span class="hljs-property">length</span>-<span class="hljs-number">1</span>;i&gt;=<span class="hljs-number">0</span>;i--) r+=str[i]; <span class="hljs-keyword">return</span> r; }

<span class="hljs-comment">// 方法3：for...of循环（现代简洁）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse3</span>(<span class="hljs-params">str</span>) { <span class="hljs-keyword">let</span> r=<span class="hljs-string">''</span>; <span class="hljs-keyword">for</span>(<span class="hljs-keyword">const</span> c <span class="hljs-keyword">of</span> str) r=c+r; <span class="hljs-keyword">return</span> r; }

<span class="hljs-comment">// 方法4：展开运算符（2024推荐！）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse4</span>(<span class="hljs-params">str</span>) { <span class="hljs-keyword">return</span> [...str].<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>); }

<span class="hljs-comment">// 方法5：递归（理解思想）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse5</span>(<span class="hljs-params">str</span>) { <span class="hljs-keyword">return</span> str===<span class="hljs-string">''</span>? <span class="hljs-string">''</span>: <span class="hljs-title function_">reverse5</span>(str.<span class="hljs-title function_">substring</span>(<span class="hljs-number">1</span>)) + str.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>); }

<span class="hljs-comment">// 方法6：reduce（函数式）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse6</span>(<span class="hljs-params">str</span>) { <span class="hljs-keyword">return</span> [...str].<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">r,c</span>)=&gt;</span>c+r, <span class="hljs-string">''</span>); }

<span class="hljs-comment">// 方法7：Array.from（方法4的兄弟）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reverse7</span>(<span class="hljs-params">str</span>) { <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(str).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>); }

<span class="hljs-comment">// 测试</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'方法1:'</span>, <span class="hljs-title function_">reverse1</span>(<span class="hljs-string">'abc'</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'方法2:'</span>, <span class="hljs-title function_">reverse2</span>(<span class="hljs-string">'abc'</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'方法3:'</span>, <span class="hljs-title function_">reverse3</span>(<span class="hljs-string">'abc'</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'方法4:'</span>, <span class="hljs-title function_">reverse4</span>(<span class="hljs-string">'abc'</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'方法5:'</span>, <span class="hljs-title function_">reverse5</span>(<span class="hljs-string">'abc'</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'方法6:'</span>, <span class="hljs-title function_">reverse6</span>(<span class="hljs-string">'abc'</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'方法7:'</span>, <span class="hljs-title function_">reverse7</span>(<span class="hljs-string">'abc'</span>));
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[😭 还没爽完就欠费？我写了个自动“偷”额度的脚本，Gemini 都被我榨干了]]></title>    <link>https://juejin.cn/post/7600705962248568841</link>    <guid>https://juejin.cn/post/7600705962248568841</guid>    <pubDate>2026-01-30T04:31:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600705962248568841" data-draft-id="7600764857769099314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="😭 还没爽完就欠费？我写了个自动“偷”额度的脚本，Gemini 都被我榨干了"/> <meta itemprop="keywords" content="Gemini,AI编程,AIGC"/> <meta itemprop="datePublished" content="2026-01-30T04:31:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="webkubor"/> <meta itemprop="url" content="https://juejin.cn/user/2119514149631870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            😭 还没爽完就欠费？我写了个自动“偷”额度的脚本，Gemini 都被我榨干了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2119514149631870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    webkubor
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:31:05.000Z" title="Fri Jan 30 2026 04:31:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf53175f7c9e4f408b9ca06ae89f4f95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2Via3Vib3I=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770357140&amp;x-signature=zNAN9Rw%2BKGjvbGffSK7PWH6Qw9M%3D" alt="截屏2026-01-30 13.49.45.png" loading="lazy"/></p>
<blockquote>
<p><strong>⚠️ 警告</strong>：本文含“高危”操作，阅读前请确保你的 Gemini CLI 已经装好，并且你拥有至少两个 Google 账号（大号和小号）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">😫 崩溃瞬间：当灵感撞上 429</h2>
<p>作为一个被 AI 惯坏的工程师，我现在写代码基本是这样的：
<strong>“Gemini，帮我重构这个函数”</strong> -&gt; <strong>“Gemini，写个单元测试”</strong> -&gt; <strong>“Gemini，这行报错是什么鬼？”</strong></p>
<p>正当我代码写得起飞，多巴胺疯狂分泌的时候，终端突然冷冰冰地甩给我一行字：</p>
<pre><code class="hljs language-bash" lang="bash">Error: 429 Quota exceeded <span class="hljs-keyword">for</span> the current user.
</code></pre>
<p>那一刻，我感觉像是刚要冲刺百米终点，裤衩突然松了。<strong>绝望，太绝望了。</strong></p>
<p>为了继续写代码，我不得不：</p>
<ol>
<li><code>gemini auth logout</code> （含泪登出）</li>
<li><code>gemini auth login</code> （打开浏览器，扫码，切小号，授权...）</li>
<li>回来重新输入刚才断掉的命令。</li>
</ol>
<p>这哪里是写代码？这简直是在做**“账号切换耐力测试”<strong>！这种</strong>“断流”**感，对于心流状态简直是毁灭性打击。</p>
<p>于是我怒了。<strong>DeepSeek 都在教我们怎么榨干算力，我居然还在手动切号？</strong> 必须搞个自动化的！</p>
<hr/>
<h2 data-id="heading-1">🧠 思路：给 CLI 装个“备胎”系统</h2>
<p>只要稍微扒一下 Gemini CLI 的底裤（<code>~/.gemini/</code> 目录），你就会发现它的鉴权机制单纯得可爱：</p>
<ul>
<li><strong>凭证文件</strong>：<code>~/.gemini/oauth_creds.json</code></li>
<li><strong>账号信息</strong>：<code>~/.gemini/google_accounts.json</code></li>
</ul>
<p>这不就简单了吗？
我只要提前把“大号”和“小号”的这两个文件<strong>偷</strong>出来存好，等到大号欠费时，用脚本<strong>毫秒级</strong>把小号的文件覆盖回去，CLI 不就以为我是尊贵的满血会员了吗？</p>
<p>说干就干。我设计了一套 <strong>“主备容灾系统 (Active-Passive Failover)”</strong>。</p>
<hr/>
<h2 data-id="heading-2">🛠️ 第一步：造一个“身份管理器”</h2>
<p>我们需要一个脚本来负责“物理换卡”。这相当于给你的 CLI 装了一个双卡双待的卡槽。</p>
<p>在 <code>~/Documents/AI_Common/docs/scripts/</code> 下创建一个 <code>gemini_manager.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># gemini_manager.sh - 你的身份管家</span>

<span class="hljs-comment"># 你的配置文件仓库（建议放在 dotfiles 或文档里）</span>
PROFILE_STORE=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/Documents/AI_Common/docs/secrets/gemini_profiles"</span>
GEMINI_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.gemini"</span>

<span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$PROFILE_STORE</span>"</span>

<span class="hljs-comment"># 💾 存档技能：把当前账号存起来</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">save_profile</span></span>() {
    NAME=<span class="hljs-variable">$1</span>
    TARGET=<span class="hljs-string">"<span class="hljs-variable">$PROFILE_STORE</span>/<span class="hljs-variable">$NAME</span>"</span>
    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$TARGET</span>"</span>
    
    <span class="hljs-comment"># 核心动作：把凭证“偷”走备份</span>
    <span class="hljs-built_in">cp</span> <span class="hljs-string">"<span class="hljs-variable">$GEMINI_DIR</span>/oauth_creds.json"</span> <span class="hljs-string">"<span class="hljs-variable">$TARGET</span>/"</span> 2&gt;/dev/null
    <span class="hljs-built_in">cp</span> <span class="hljs-string">"<span class="hljs-variable">$GEMINI_DIR</span>/google_accounts.json"</span> <span class="hljs-string">"<span class="hljs-variable">$TARGET</span>/"</span> 2&gt;/dev/null
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 账号已存档为: '<span class="hljs-variable">$NAME</span>'"</span>
}

<span class="hljs-comment"># 🔄 读档技能：切换到指定账号</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">switch_profile</span></span>() {
    NAME=<span class="hljs-variable">$1</span>
    TARGET=<span class="hljs-string">"<span class="hljs-variable">$PROFILE_STORE</span>/<span class="hljs-variable">$NAME</span>"</span>
    
    <span class="hljs-keyword">if</span> [ ! -d <span class="hljs-string">"<span class="hljs-variable">$TARGET</span>"</span> ]; <span class="hljs-keyword">then</span> 
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 找不到账号存档 '<span class="hljs-variable">$NAME</span>'，你是不是没存过？"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔄 正在切换身份到: '<span class="hljs-variable">$NAME</span>'..."</span>
    <span class="hljs-comment"># 核心动作：覆盖回去</span>
    <span class="hljs-built_in">cp</span> <span class="hljs-string">"<span class="hljs-variable">$TARGET</span>/oauth_creds.json"</span> <span class="hljs-string">"<span class="hljs-variable">$GEMINI_DIR</span>/"</span> 2&gt;/dev/null
    <span class="hljs-built_in">cp</span> <span class="hljs-string">"<span class="hljs-variable">$TARGET</span>/google_accounts.json"</span> <span class="hljs-string">"<span class="hljs-variable">$GEMINI_DIR</span>/"</span> 2&gt;/dev/null
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🎉 切换成功！现在你是 '<span class="hljs-variable">$NAME</span>' 了。"</span>
}

<span class="hljs-comment"># 🧐 鉴定技能：我现在到底是谁？</span>
<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">check_status</span></span>() {
    <span class="hljs-comment"># 通过对比文件哈希值来确认身份</span>
    CURRENT_SUM=$(shasum <span class="hljs-string">"<span class="hljs-variable">$GEMINI_DIR</span>/oauth_creds.json"</span> 2&gt;/dev/null | awk <span class="hljs-string">'{print $1}'</span>)
    FOUND=0
    <span class="hljs-keyword">for</span> profile <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$PROFILE_STORE</span>"</span>/*; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> [ -d <span class="hljs-string">"<span class="hljs-variable">$profile</span>"</span> ]; <span class="hljs-keyword">then</span>
            P_NAME=$(<span class="hljs-built_in">basename</span> <span class="hljs-string">"<span class="hljs-variable">$profile</span>"</span>)
            P_SUM=$(shasum <span class="hljs-string">"<span class="hljs-variable">$profile</span>/oauth_creds.json"</span> 2&gt;/dev/null | awk <span class="hljs-string">'{print $1}'</span>)
            <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$CURRENT_SUM</span>"</span> == <span class="hljs-string">"<span class="hljs-variable">$P_SUM</span>"</span> ]; <span class="hljs-keyword">then</span>
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 当前身份: <span class="hljs-variable">$P_NAME</span>"</span>
                FOUND=1
                <span class="hljs-built_in">break</span>
            <span class="hljs-keyword">fi</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$FOUND</span>"</span> -eq 0 ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️  未知身份 (未存档)"</span>; <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 简单的路由</span>
<span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span>
    save) save_profile <span class="hljs-string">"<span class="hljs-variable">$2</span>"</span> ;; 
    switch) switch_profile <span class="hljs-string">"<span class="hljs-variable">$2</span>"</span> ;; 
    status) check_status ;; 
    *) <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> {save|switch|status} [name]"</span> ;; 
<span class="hljs-keyword">esac</span>
</code></pre>
<hr/>
<h2 data-id="heading-3">🚀 第二步：终极黑科技 "Auto-Failover Wrapper"</h2>
<p>我要封装一个 <code>g</code> 命令。它平时就是普通的 Gemini，但在检测到报错时，它会<strong>光速切号</strong>并<strong>自动重试</strong>。</p>
<p>创建 <code>g.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># g.sh - 永不欠费的 Gemini 包装器</span>

MANAGER=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/Documents/AI_Common/docs/scripts/gemini_manager.sh"</span>

<span class="hljs-comment"># 1. 显性化：告诉自己现在在用哪个号</span>
CURRENT_PROFILE=$(<span class="hljs-variable">$MANAGER</span> status | grep <span class="hljs-string">"当前身份"</span> | awk <span class="hljs-string">'{print $NF}'</span>)
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\033[1;34m[Gemini CLI]\033[0m Account: \033[1;32m<span class="hljs-variable">${CURRENT_PROFILE:-UNKNOWN}</span>\033[0m"</span>

<span class="hljs-comment"># 2. 核心逻辑：拦截报错</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">"$*"</span> == *<span class="hljs-string">"-p"</span>* ]] || [[ <span class="hljs-string">"$*"</span> == *<span class="hljs-string">"--prompt"</span>* ]]; <span class="hljs-keyword">then</span>
    TMP_LOG=$(<span class="hljs-built_in">mktemp</span>)
    gemini <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span> 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> <span class="hljs-string">"<span class="hljs-variable">$TMP_LOG</span>"</span>
    
    <span class="hljs-keyword">if</span> grep -iqE <span class="hljs-string">"Quota exceeded|429|Too Many Requests"</span> <span class="hljs-string">"<span class="hljs-variable">$TMP_LOG</span>"</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\033[1;33m⚠️  检测到额度耗尽！启动自动故障转移...\033[0m"</span>
        
        <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$CURRENT_PROFILE</span>"</span> == <span class="hljs-string">"primary"</span> ]; <span class="hljs-keyword">then</span>
            <span class="hljs-variable">$MANAGER</span> switch secondary
        <span class="hljs-keyword">else</span>
            <span class="hljs-variable">$MANAGER</span> switch primary
        <span class="hljs-keyword">fi</span>
        
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\033[1;32m🔄 已重试...\033[0m\n"</span>
        gemini <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-built_in">rm</span> <span class="hljs-string">"<span class="hljs-variable">$TMP_LOG</span>"</span>
<span class="hljs-keyword">else</span>
    gemini <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">🎉 最终效果：爽到飞起</h2>
<p>把这个脚本 <code>alias g='.../g.sh'</code> 后，我的开发体验发生了质变。</p>
<p><strong>全程无人工干预！</strong> 我甚至不用把手从键盘上拿开。</p>
<p>这才是 AI 时代该有的工作流啊兄弟们！<strong>把重复的劳动交给脚本，把脑子留给架构。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9e560aeee9e44e09e316c5d8da26e11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2Via3Vib3I=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770357140&amp;x-signature=Gq4wwrkCgnIiNcpqzbIqCnBT0z8%3D" alt="截屏2026-01-30 12.00.58.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe21352fac884919b553ab38c3026386~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2Via3Vib3I=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770357140&amp;x-signature=1Z8C7nouwpRhsP6l455FKZ8dnX8%3D" alt="截屏2026-01-30 13.51.18.png" loading="lazy"/></p>
<hr/>
<blockquote>
<p><strong>写在最后</strong>：
觉得有用的话，<strong>点赞、收藏、转发</strong>三连，别让你的 Gemini 饿着！🚀</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【翻译】将CSS裁剪功能引入React Native]]></title>    <link>https://juejin.cn/post/7600678255042002953</link>    <guid>https://juejin.cn/post/7600678255042002953</guid>    <pubDate>2026-01-30T04:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600678255042002953" data-draft-id="7600370554069123098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【翻译】将CSS裁剪功能引入React Native"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T04:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户60007181910"/> <meta itemprop="url" content="https://juejin.cn/user/3555196688934128"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【翻译】将CSS裁剪功能引入React Native
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3555196688934128/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户60007181910
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:15:04.000Z" title="Fri Jan 30 2026 04:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.callstack.com%2Fblog%2Fbringing-css-clipping-to-react-native" target="_blank" title="https://www.callstack.com/blog/bringing-css-clipping-to-react-native" ref="nofollow noopener noreferrer">www.callstack.com/blog/bringi…</a></p>
<p>作者：Kamil Paradowski</p>
<p>如果你曾在 React Native 中尝试创建倾斜标题或其他非矩形分隔区，你可能深有体会——总觉得缺少了什么。而在网页端，CSS 的 clip-path 特性让这些形状变得轻而易举。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.star-badge</span> { 
  <span class="hljs-attribute">clip-path</span>: <span class="hljs-built_in">polygon</span>(<span class="hljs-number">50%</span> <span class="hljs-number">0%</span>, <span class="hljs-number">61%</span> <span class="hljs-number">35%</span>, <span class="hljs-number">98%</span> <span class="hljs-number">35%</span>, <span class="hljs-number">68%</span> <span class="hljs-number">57%</span>, <span class="hljs-number">79%</span> <span class="hljs-number">91%</span>, <span class="hljs-number">50%</span> <span class="hljs-number">70%</span>, <span class="hljs-number">21%</span> <span class="hljs-number">91%</span>, <span class="hljs-number">32%</span> <span class="hljs-number">57%</span>, <span class="hljs-number">2%</span> <span class="hljs-number">35%</span>, <span class="hljs-number">39%</span> <span class="hljs-number">35%</span>); 
}
</code></pre>
<p>但遗憾的是，该功能不适用于 React Native 应用，因此我们需要导入第三方库：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">MaskedView</span>} <span class="hljs-keyword">from</span> ...

&lt;<span class="hljs-title class_">MaskedView</span> path=<span class="hljs-string">"..."</span> /&gt;
</code></pre>
<p>这段代码的效果就是这个漂亮的形状：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4db672f8b311470d90ad519c82f1b29a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770351304&amp;x-signature=MyT%2Fkkm2N9exTxIv15EHRDKa0VE%3D" alt="" loading="lazy"/>
最终我们实现了跨平台的星形遮罩效果。然而，网页和移动平台的代码差异显著。本文将探讨React Native如何通过类似CSS的StyleSheet API原生支持clip-path遮罩功能，并提出解决方案。</p>
<h2 data-id="heading-0">什么是CSS <code>clip-path</code>？</h2>
<p>CSS的clip-path属性定义了一个类似遮罩的裁剪区域：仅元素位于该区域内的部分可见，区域外内容均被隐藏。该区域由两部分构成：形状本身及其几何边框——后者决定了形状的定位与尺寸。</p>
<h3 data-id="heading-1">形状函数</h3>
<p>此参数定义裁剪的几何形状。可使用辅助形状函数(<code>circle()</code>、<code>polygon()</code>、<code>inset()</code>等)，或指向本地/远程资源(<code>url(image.png)</code>)。</p>
<blockquote>
<p>React Native的首个版本中不支持SVG图像的<code>clip-path</code>实现；<code>path()</code>形状无法正常工作。</p>
</blockquote>
<h3 data-id="heading-2">几何框</h3>
<p>此为参考帧。它告知渲染器应以元素"框"的哪个部分作为形状坐标系的原点<code>(0,0)</code>。默认值为<code>border-box</code>，也可使用<code>padding-box</code>、<code>content-box</code>或<code>margin-box</code>。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f7cbe89e02e410593c6a12f282ca5f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770351304&amp;x-signature=Uj0I6IjVmy0%2BRGny%2FlHbsHU8hOM%3D" alt="几何框 - 边距框参考框" loading="lazy"/></p>
<h2 data-id="heading-3"><code>clip-path</code> 实战应用</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.avatar</span> { 
  <span class="hljs-attribute">clip-path</span>: <span class="hljs-built_in">circle</span>(<span class="hljs-number">50%</span>); 
}
<span class="hljs-selector-class">.star-badge</span> { 
  <span class="hljs-attribute">clip-path</span>: <span class="hljs-built_in">polygon</span>(<span class="hljs-number">50%</span> <span class="hljs-number">0%</span>, <span class="hljs-number">61%</span> <span class="hljs-number">35%</span>, <span class="hljs-number">98%</span> <span class="hljs-number">35%</span>, <span class="hljs-number">68%</span> <span class="hljs-number">57%</span>, <span class="hljs-number">79%</span> <span class="hljs-number">91%</span>, <span class="hljs-number">50%</span> <span class="hljs-number">70%</span>, <span class="hljs-number">21%</span> <span class="hljs-number">91%</span>, <span class="hljs-number">32%</span> <span class="hljs-number">57%</span>, <span class="hljs-number">2%</span> <span class="hljs-number">35%</span>, <span class="hljs-number">39%</span> <span class="hljs-number">35%</span>); 
}
</code></pre>
<h2 data-id="heading-4">React Native 的独特之处</h2>
<p>在网页端，渲染栈由单一引擎（如 Blink）统一管理。它解析 CSS 并计算布局，随后借助 Skia 等图形引擎绘制屏幕上的每个像素。</p>
<p>相比之下，React Native 默认不自行绘制 UI。它更像一个协调者： 它将样式转换为布局指令，由宿主操作系统（iOS或Android）通过原生UI组件进行绘制。</p>
<p>本质上，网页在浏览器窗口内模拟UI，而React Native则利用手机原生构建块组装UI。</p>
<p>同时，React Native提供部分CSS功能供使用，但并非全部。让我们通过<code>clip-path</code>示例来观察实际运作机制。</p>
<p>如上所示的样式应呈现如下视图。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2704748e6a3a402f8205a061160815d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770351304&amp;x-signature=yvX%2F1huF6m2cXnxVWGryYOU2wHo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">从样式到屏幕</h2>
<p>React Native 架构可视为分布式系统，它协调各组件间的协作。这意味着要为新属性添加支持，我们需要触及并修改其众多不同部分。</p>
<p>让我们逐一攻克这些环节。</p>
<p>当你在样式中写下示例定义 <code>clipPath: 'circle(50% at 25% 25%)'</code> 时，这场旅程便拉开了序幕。</p>
<h3 data-id="heading-6">从JS层开始</h3>
<p>React文件必须识别新属性的存在，因此我们需要确保TypeScript或Flow能检测到它。该属性的参数仅是文本，所以只需进行如下修改即可，对吧？</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> type ____ViewStyle_InternalBase = $ReadOnly&lt;{ <span class="hljs-comment">// ... isolation?: 'auto' | 'isolate', + clipPath?: string, }&gt;;</span>
</code></pre>
<p>‍‍其实不然。JS层还负责解析参数值并将其转换为对象结构，该结构随后由原生代码处理。这意味着我们还需添加解析功能及描述新<code>clipPath</code>输入模式的类型定义。</p>
<p>这必然需要配套测试及其他细微调整。为保持本文简洁明了，我将略过这些环节。让我们观察当新的CSS属性值（无论是解析后的对象还是原始字符串）传递至React Native C++核心层时会发生什么。</p>
<blockquote>
<p>近期 React Native 核心团队新增了<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact-native%2Ftree%2Fmain%2Fpackages%2Freact-native%2FReactCommon%2Freact%2Frenderer%2Fcss" target="_blank" title="https://github.com/facebook/react-native/tree/main/packages/react-native/ReactCommon/react/renderer/css" ref="nofollow noopener noreferrer">原生 CSS 解析器</a>。这意味着属性文本值可直接由 C++ 代码完成解析、分词及原生类型转换！此方案不仅略微提升性能，更是技术上更严谨的实现方式。不过该功能目前仍处于开发阶段，需通过内部功能开关启用。期待它能尽快成为默认配置。</p>
</blockquote>
<h3 data-id="heading-7">C++作为核心基础</h3>
<p>React Native的新架构渲染器（又称Fabric）采用C++作为跨平台共享核心。正是这一层实现了真正的跨平台兼容性。接收到的剪切路径数据需要以C++形式呈现，才能被iOS和Android（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Freact-native%2F%25F0%259F%259A%2580react-native-windows-v0-81-is-here%2F" target="_blank" title="https://devblogs.microsoft.com/react-native/%F0%9F%9A%80react-native-windows-v0-81-is-here/" ref="nofollow noopener noreferrer">以及其他平台，如v0.81版本中默认采用新架构的Windows</a>）所使用。</p>
<p>让我们从头开始。要理解CSS属性变更如何触发应用重渲染，需完整解析React Native的渲染管道。</p>
<p>让我们逐步剖析：在添加新CSS属性功能时，各环节需要进行哪些具体变更。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0cdd7ce07745c996782863fbd248f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770351304&amp;x-signature=u7%2BxrfqdoFtWmuGScAYhA3Jmtjs%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>若想深入了解 React Native 的全新渲染管道，<a href="https://link.juejin.cn?target=https%3A%2F%2Freactnative.dev%2Farchitecture%2Foverview" target="_blank" title="https://reactnative.dev/architecture/overview" ref="nofollow noopener noreferrer">新架构的官方文档</a>对此有详尽阐述，尤其建议查阅<a href="https://link.juejin.cn?target=https%3A%2F%2Freactnative.dev%2Farchitecture%2Frender-pipeline" target="_blank" title="https://reactnative.dev/architecture/render-pipeline" ref="nofollow noopener noreferrer">渲染、提交与挂载</a>章节。</p>
</blockquote>
<p>一切始于名为<strong>协调</strong>的流程。在此阶段（即<strong>渲染阶段</strong>），React 的协调器会计算新旧 props 之间的差异，检测 props 变更，并安排重新渲染。上段已阐述此步骤的变更机制。</p>
<p>当 props 变更时，React 会克隆带有新 props 的 <em>Shadow Node</em>。不同于旧架构中通过异步消息传递至独立线程的低效方式，现在改用直接的 JSI 调用实现。</p>
<p>为何克隆在此处有效？</p>
<p>出于线程安全考虑，<em>Shadow Tree Nodes</em> 具有不可变性。要修改 CSS 属性时，渲染器无法直接修改现有节点。必须克隆受影响的Shadow Node并赋予新属性。通过结构共享机制回指未变更的旧节点，最大限度降低内存开销。</p>
<p>这正是我们需要介入的环节。</p>
<p><em>Shadow Node</em>是React阴影树元素的表示形式，包含源自JavaScript的属性及布局信息。我们需要扩展属性列表并新增一项。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">namespace</span> facebook::react {

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseViewProps</span> : <span class="hljs-keyword">public</span> YogaStylableProps, <span class="hljs-keyword">public</span> AccessibilityProps {
	 <span class="hljs-comment">// ...</span>
	 
   <span class="hljs-comment">// Color</span>
   Float opacity{<span class="hljs-number">1.0</span>};
   SharedColor backgroundColor{};

   <span class="hljs-comment">// Borders</span>
   CascadedBorderRadii borderRadii{};
   CascadedBorderColors borderColors{};
   
 	 <span class="hljs-comment">// ...</span>
+  std::optional&lt;ClipPath&gt; clipPath{};
}

} <span class="hljs-comment">// namespace facebook::react</span>
</code></pre>
<p>将<code>clipPath</code>集成到<code>BaseViewProps</code>类定义中</p>
<p>在C++世界中，<code>std::optional&lt;T&gt;</code>表示该属性可为空，而<code>ClipPath</code>是我们用来表示此属性的新类型。其通常呈现如下形式：</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">namespace</span> facebook::react {

<span class="hljs-comment">// Define individual geometric primitives used for clipping</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">CircleShape</span> {
  std::optional&lt;ValueUnit&gt; r{};
  std::optional&lt;ValueUnit&gt; cx{};
  std::optional&lt;ValueUnit&gt; cy{};
    <span class="hljs-comment">// ...</span>
};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">EllipseShape</span> {
  std::optional&lt;ValueUnit&gt; rx{};
  std::optional&lt;ValueUnit&gt; ry{};
  std::optional&lt;ValueUnit&gt; cx{};
  std::optional&lt;ValueUnit&gt; cy{};
  <span class="hljs-comment">// ...</span>
}
...
<span class="hljs-comment">// A type-safe union representing any possible basic shape</span>
<span class="hljs-keyword">using</span> BasicShape = std::variant&lt;
    CircleShape,
    EllipseShape,
    InsetShape,
    PolygonShape,
    RectShape,
    XywhShape&gt;;

<span class="hljs-comment">// Standard box model enumerations for the clip reference box</span>
<span class="hljs-keyword">enum class</span> <span class="hljs-title class_">GeometryBox</span> : <span class="hljs-type">uint8_t</span> {
  MarginBox,
  BorderBox,
  ContentBox,
  PaddingBox
};

<span class="hljs-comment">// Main structure representing a full clip-path value</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ClipPath</span> {
  std::optional&lt;BasicShape&gt; shape;
  std::optional&lt;GeometryBox&gt; geometryBox;

  <span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span>==(<span class="hljs-type">const</span> ClipPath &amp;other) <span class="hljs-type">const</span>;

<span class="hljs-comment">// Debugging and serialization helpers</span>
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RN_DEBUG_STRING_CONVERTIBLE</span>
  <span class="hljs-function">std::string <span class="hljs-title">toString</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> RN_SERIALIZABLE_STATE</span>
  <span class="hljs-function">folly::dynamic <span class="hljs-title">toDynamic</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
};

} <span class="hljs-comment">// namespace facebook::react</span>
</code></pre>
<p><code>clipPath</code>属性实现的数据结构</p>
<p>我们需要确保，正如CSS规范所述，<code>clipPath</code>属性应导致<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FCSS%2FGuides%2FPositioned_layout%2FStacking_context" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/CSS/Guides/Positioned_layout/Stacking_context" ref="nofollow noopener noreferrer">堆叠上下文</a>的创建。</p>
<p>这需要对<code>ViewShadowNode</code>类进行微调——该类是待挂载<code>&lt;View&gt;</code>组件的阴影节点表示形式。若未进行此调整，将导致意外结果，例如组件的子元素无法被剪切。</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ViewShadowNode::initialize</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>{
  <span class="hljs-comment">// ...</span>
  <span class="hljs-type">bool</span> formsStackingContext = !viewProps.collapsable ||
      viewProps.pointerEvents == PointerEventsMode::None ||
      !viewProps.nativeId.<span class="hljs-built_in">empty</span>() || viewProps.accessible ||
      viewProps.opacity != <span class="hljs-number">1.0</span> || viewProps.transform != Transform{} ||
      (viewProps.zIndex.<span class="hljs-built_in">has_value</span>() &amp;&amp;
       viewProps.yogaStyle.<span class="hljs-built_in">positionType</span>() != yoga::PositionType::Static) ||
      viewProps.yogaStyle.<span class="hljs-built_in">display</span>() == yoga::Display::None ||
      viewProps.<span class="hljs-built_in">getClipsContentToBounds</span>() || viewProps.events.bits.<span class="hljs-built_in">any</span>() ||
      <span class="hljs-built_in">isColorMeaningful</span>(viewProps.shadowColor) ||
      viewProps.accessibilityElementsHidden ||
      viewProps.accessibilityViewIsModal ||
      viewProps.importantForAccessibility != ImportantForAccessibility::Auto ||
      viewProps.removeClippedSubviews || viewProps.cursor != Cursor::Auto ||
      !viewProps.filter.<span class="hljs-built_in">empty</span>() ||
      viewProps.mixBlendMode != BlendMode::Normal ||
      viewProps.isolation == Isolation::Isolate ||
      HostPlatformViewTraitsInitializer::formsStackingContext(viewProps) ||
      !viewProps.accessibilityOrder.<span class="hljs-built_in">empty</span>() ||
+     viewProps.clipPath.<span class="hljs-built_in">has_value</span>();
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">if</span> (formsStackingContext) {
    traits_.<span class="hljs-built_in">set</span>(ShadowNodeTraits::Trait::FormsStackingContext);
  } <span class="hljs-keyword">else</span> {
    traits_.<span class="hljs-built_in">unset</span>(ShadowNodeTraits::Trait::FormsStackingContext);
  }
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>更新堆叠上下文逻辑以包含剪裁路径</p>
<p><strong>渲染</strong>完成后，将触发阴影树的提交操作。该操作将新树提升为待挂载的"下一棵树"，并安排布局计算（Yoga）。</p>
<p>接下来的最后阶段是<strong>挂载</strong>：将React阴影树转换为主视图树。</p>
<p>该过程包含三个步骤：</p>
<ul>
<li><strong>Tree Diff</strong>：计算当前树与后续树之间的差异。</li>
<li><strong>Tree Promotion</strong>：确保后续挂载阶段基于正确树进行差异计算。</li>
<li><strong>View Mounting</strong>：执行实际渲染变更。</li>
</ul>
<p>至此我们已了解属性变更信息如何从JavaScript层级传播至宿主平台层级。接下来让我们探究iOS与Android平台中<code>clip-path</code>的具体实现方式。</p>
<h3 data-id="heading-8">iOS 中的剪切功能</h3>
<p>React Native 使用 UIKit 来处理和构建 UI 元素，其最基础的构建块是 <code>UIView</code>。在 <code>UIKit</code> 中，每个 <code>UIView</code> 都由一个 <code>CALayer</code>（核心动画层）支撑。当视图处理触摸等用户交互时，该层实际负责在屏幕上渲染内容，并充当画布。每个图层都拥有一个作为透明度遮罩的mask属性——它决定了哪些内容可见、哪些内容隐藏。掌握这些知识后，让我们开始实现吧！</p>
<p>值得庆幸的是，React Native iOS 提供了一个自定义类（<code>RCTViewComponentView</code>），它继承自 <code>UIView</code>。所有创建的视图类型（无论是 <code>&lt;View&gt;</code> 还是 <code>&lt;Image&gt;</code>）都继承自该类。这意味着我们只需在此处添加剪切路径逻辑，即可适配所有 React Native 组件！关键实现点在于 <code>invalidateLayer</code> 函数，需通过下方代码块进行扩展：</p>
<pre><code class="hljs language-C" lang="C">- (<span class="hljs-type">void</span>)invalidateLayer
{
  <span class="hljs-comment">// ...</span>
  <span class="hljs-comment">// Handle clip-path property</span>
  <span class="hljs-keyword">if</span> (_props-&gt;clipPath.has_value()) {
    CALayer *maskLayer = [RCTClipPathUtils createClipPathLayer:_props-&gt;clipPath.value()
                                                 layoutMetrics:_layoutMetrics
                                                     yogaStyle:_props-&gt;yogaStyle
                                                        bounds:layer.bounds
                                                   cornerRadii:RCTCornerRadiiFromBorderRadii(borderMetrics.borderRadii)];
    <span class="hljs-keyword">if</span> (maskLayer != nil) {
      self.currentContainerView.layer.mask = maskLayer;
    }
  }
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>对 <code>invalidateLayer</code> 函数的修改</p>
<p>其中 <code>createClipPathLayer</code> 是一个辅助函数，负责计算几何边界框并创建形状路径。让我们来看看它的具体实现。</p>
<pre><code class="hljs language-C" lang="C">+ (CALayer *)createClipPathLayer:(<span class="hljs-type">const</span> ClipPath &amp;)clipPath
                   layoutMetrics:(<span class="hljs-type">const</span> LayoutMetrics &amp;)layoutMetrics
                       yogaStyle:(<span class="hljs-type">const</span> facebook::yoga::Style &amp;)yogaStyle
                          bounds:(CGRect)bounds
                     cornerRadii:(RCTCornerRadii)cornerRadii
{
  CGRect box = [self getGeometryBoxRect:clipPath.geometryBox
                          layoutMetrics:layoutMetrics
                              yogaStyle:yogaStyle
                                 bounds:bounds];
</code></pre>
<ol>
<li>首先，我们需要确定正确的几何框边界。我们需要使用正确的参考框并调整其角半径。</li>
</ol>
<pre><code class="hljs language-C" lang="C">  UIBezierPath *path = nil;
  <span class="hljs-keyword">if</span> (clipPath.shape.has_value()) {
    <span class="hljs-comment">// clipPath: circle(50%) content-box</span>
    path = [RCTBasicShapeUtils createPathFromBasicShape:clipPath.shape.value() bounds:box];
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clipPath.geometryBox.has_value()) {
    <span class="hljs-comment">// clipPath: content-box</span>
    path = [UIBezierPath bezierPathWithCGPath:RCTPathCreateWithRoundedRect(box, cornerInsets, nil, NO)];
  }
</code></pre>
<ol start="2">
<li>UIKit 提供了一个辅助类 <code>UIBezierPath</code> 用于路径操作。对于每个支持的形状，我们需要使用新辅助函数 <code>createPathFromBasicShape</code> 创建描述该形状的路径。若形状已定义，则创建对应路径；否则，若提供了几何框路径，则使用该路径。</li>
</ol>
<pre><code class="hljs language-C" lang="C">  <span class="hljs-comment">// Skip invalid or empty path</span>
  <span class="hljs-keyword">if</span> (path == nil) {
    <span class="hljs-keyword">return</span> nil;
  }
  
  CAShapeLayer *maskLayer = [CAShapeLayer layer];
  maskLayer.path = path.CGPath;
  <span class="hljs-keyword">return</span> maskLayer;
}
</code></pre>
<ol start="3">
<li>若结果路径正确，可通过 <code>CAShapeLayer</code> 类创建遮罩图层。该遮罩图层将在 <code>invalidateLayer</code> 函数中作为 <code>UIView</code> 的遮罩使用。</li>
</ol>
<p><code>createPathFromBasicShape</code> 的实现方式如下？下面给出矩形形状的示例：</p>
<pre><code class="hljs language-C" lang="C">+ (UIBezierPath *)createRectPath:(<span class="hljs-type">const</span> RectShape &amp;)rect bounds:(CGRect)bounds
{
  <span class="hljs-comment">// Define corners</span>
  CGFloat top = bounds.origin.y + RCTResolveValueUnit(rect.top, bounds.size.height);
  CGFloat right = bounds.origin.x + RCTResolveValueUnit(rect.right, bounds.size.width);
  CGFloat bottom = bounds.origin.y + RCTResolveValueUnit(rect.bottom, bounds.size.height);
  CGFloat left = bounds.origin.x + RCTResolveValueUnit(rect.left, bounds.size.width);

  <span class="hljs-comment">// Create a rect</span>
  CGRect clipRect = CGRectMake(left, top, right - left, bottom - top);

  <span class="hljs-comment">// Catch for invalid dimensions</span>
  <span class="hljs-keyword">if</span> (clipRect.size.width &lt; <span class="hljs-number">0</span> || clipRect.size.height &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> nil;
  }

  <span class="hljs-comment">// Adjust radius</span>
  CGFloat borderRadius = rect.borderRadius.has_value() ? RCTResolveValueUnit(rect.borderRadius.value(), MIN(clipRect.size.width, clipRect.size.height)) : <span class="hljs-number">0.0f</span>;
  
  <span class="hljs-comment">// Use bezierPathWithRoundedRect to create rounder rect bezier path</span>
  <span class="hljs-keyword">return</span> [UIBezierPath bezierPathWithRoundedRect:clipRect cornerRadius:borderRadius];
}
</code></pre>
<p>综合所有内容，我们终于在React Native中实现了适用于iOS的<code>clipPath</code>功能！</p>
<p>当然，我略去了部分实现细节，包括检测属性变更、标记需要无效化的图层、原生解析属性文本值、将CSS类型转换为图形类型等。但这仍能让你掌握整个流程的核心要义。若感兴趣，可在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact-native%2Fpulls%3Fq%3Dis%253Apr%2Bis%253Aopen%2B%2522add%2Bclip-path%2522" target="_blank" title="https://github.com/facebook/react-native/pulls?q=is%3Apr+is%3Aopen+%22add+clip-path%22" ref="nofollow noopener noreferrer">此处</a>查看所有变更的链接。</p>
<h2 data-id="heading-9">Android 平台的裁剪实现</h2>
<p>Android 设计略有不同，这并不令人意外。</p>
<p>每个Android端的React Native组件都以<code>View</code>类实现。虽然存在<code>ViewOutlineProvider</code>等替代方案处理简单圆角，但它们往往难以应对复杂形状。</p>
<p>针对Android视图裁剪需求，最流行且适用的解决方案是重写<code>draw</code>方法，直接在画布上应用裁剪操作。Android的<code>Canvas</code>类为此提供了专属函数<code>clipPath</code>和<code>clipRect</code>——这正是我们所需的功能！</p>
<p>Android 与 iOS 的区别在于：Android 没有适用于所有组件类型的基础 <code>View</code> 类（存在某些例外情况会破坏通用解决方案）。但 React Native 提供了一个特殊的辅助类 <code>BackgroundStyleApplicator</code>，该类可用于并适用于所有 <code>View</code>。</p>
<p>我们可以在该类中添加<code>clipPath</code>逻辑，并从其他所有位置调用它。对于代表 <code>&lt;Image&gt;</code> 组件的 <code>ReactImageView </code>类，代码实现如下：</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> override fun <span class="hljs-title function_">draw</span><span class="hljs-params">(canvas: Canvas)</span> {
  BackgroundStyleApplicator.applyClipPathIfPresent(<span class="hljs-built_in">this</span>, canvas) {
    <span class="hljs-built_in">super</span>.draw(canvas)
  }
}
</code></pre>
<p>其中 <code>applyClipPathIfPresent</code> 是一个函数，其简化版本可表示为：</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> fun <span class="hljs-title function_">applyClipPathIfPresent</span><span class="hljs-params">(view: View, canvas: Canvas, drawContent: (()</span> -&gt; Unit?)?) {
    <span class="hljs-comment">// ...</span>
    canvas.withSave {
      <span class="hljs-comment">// ...</span>
      <span class="hljs-comment">// Calculation of geometry-box</span>
      <span class="hljs-type">val</span> <span class="hljs-variable">bounds</span> <span class="hljs-operator">=</span> getGeometryBoxBounds(...)
      
      <span class="hljs-comment">// Path creation</span>
      val path: Path? = <span class="hljs-keyword">if</span> (clipPath.shape != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// clipPath: circle(50%) content-box</span>
        ClipPathUtils.createPathFromBasicShape(clipPath.shape, bounds)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clipPath.geometryBox != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// clipPath: content-box</span>
        ClipPathUtils.createRoundedRectPath(bounds,
          GeometryBoxUtil.adjustBorderRadiusForGeometryBox(view, clipPath.geometryBox, ...)
        )
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-literal">null</span>
      }

      <span class="hljs-comment">// Clipping logic</span>
      <span class="hljs-keyword">if</span> (path != <span class="hljs-literal">null</span>) {
        clipPath(path)
      }

      <span class="hljs-comment">// Draw actual content to be clipped</span>
      drawContent?.invoke()
    }
  }
</code></pre>
<p>该逻辑与iOS非常相似：</p>
<ol>
<li>首先，我们使用新辅助函数<code>getGeometryBoxBounds</code>计算<code>geometry-box</code>。</li>
<li>然后创建描述形状的路径并传递给<code>clip-path</code>。</li>
<li>最后调用相应的<code>Canvas</code>方法来剪切绘图区域。</li>
</ol>
<p>以下是Android平台创建矩形形状的方法：</p>
<pre><code class="hljs language-Java" lang="Java"> <span class="hljs-keyword">private</span> fun <span class="hljs-title function_">createRectPath</span><span class="hljs-params">(rect: RectShape, bounds: RectF)</span>: Path? {
    <span class="hljs-comment">// Define corners</span>
    <span class="hljs-type">val</span> <span class="hljs-variable">top</span> <span class="hljs-operator">=</span> bounds.top + resolveLengthPercentage(rect.top, bounds.height())
    <span class="hljs-type">val</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> bounds.left + resolveLengthPercentage(rect.right, bounds.width())
    <span class="hljs-type">val</span> <span class="hljs-variable">bottom</span> <span class="hljs-operator">=</span> bounds.top + resolveLengthPercentage(rect.bottom, bounds.height())
    <span class="hljs-type">val</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> bounds.left + resolveLengthPercentage(rect.left, bounds.width())

    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// Create path</span>
    <span class="hljs-type">val</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> Path()
    <span class="hljs-keyword">if</span> (rect.borderRadius != <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// Rounded corners case</span>
      <span class="hljs-type">val</span> <span class="hljs-variable">referenceDimension</span> <span class="hljs-operator">=</span> minOf(rect.width(), rect.height())
      <span class="hljs-type">val</span> <span class="hljs-variable">radius</span> <span class="hljs-operator">=</span> resolveLengthPercentage(borderRadius, referenceDimension)
      path.addRoundRect(rect, radius, radius, Path.Direction.CW)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Sharp edges case</span>
      path.addRect(rect, Path.Direction.CW)
    }

    <span class="hljs-keyword">return</span> path
  }
</code></pre>
<p>所有操作都包裹在<code>withSave</code>块中。这样做是为了确保我们对画布的修改不会影响其他绘制调用，否则可能导致意外行为。</p>
<p>那么裁剪视图背景、子视图或其效果会怎样？我们需要快速分析Android图形管道，并检查<code>draw(Canvas)</code>方法的实际作用。通过查看<code>View</code>类的源代码即可轻松验证：</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// Step 1, draw the background, if needed</span>
drawBackground(canvas)
<span class="hljs-comment">// Step 2, save the canvas' layers</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-comment">// Step 3, draw the content</span>
onDraw(canvas)
<span class="hljs-comment">// Step 4, draw the children</span>
dispatchDraw(canvas)
<span class="hljs-comment">// Step 5, draw the fade effect and restore layers</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-comment">// Step 6, draw decorations (foreground, scrollbars)</span>
onDrawForeground(canvas)
<span class="hljs-comment">// Step 7, draw the default focus highlight</span>
drawDefaultFocusHighlight(canvas)
</code></pre>
<p>在调用 <code>super.draw(canvas)</code> 之前对画布应用裁剪操作，可确保组件的所有可绘制部分均被我们的代码裁剪。只需将此操作添加到所有 <code>View</code> 类中，任务就完成了！很简单吧？</p>
<p>正如你所料，我又把过程简化了。最初还需额外处理：进行类型转换、在多处添加对新属性的支持调整，以及最关键的一步——在挂载过程中计算并缓存布局信息，以确保<code>geometry-box</code>计算准确。</p>
<p>不过这些内容可以另写一篇文章详述，希望本文能为你提供基础思路。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73791a004772436fa86adb8d4a7968eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NjAwMDcxODE5MTA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770351304&amp;x-signature=g4LWEPVAAdDan3vCOc1dzSsLCLE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">总结</h2>
<p>和许多移动开发者一样，我喜欢用React Native构建应用。它让我能复用网页开发技能，为iOS、Android等平台打造应用。</p>
<p>但过程并非一帆风顺。某些在网页端用CSS就能轻松实现的功能，在这里需要借助封装原生视图的第三方库——这又是一项新技能。</p>
<p>通过增强React Native对CSS的支持，我期待我们能更接近这样一个世界：在移动应用中充分运用所有网页样式设计知识。</p>
<p>希望您喜欢这次关于CSS与React Native新架构底层运作机制的小探索，并从中获得新知。</p>
<p>目前有三份为React Native引入<code>clip-path</code>支持的PR<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact-native%2Fpulls%3Fq%3Dis%253Apr%2Bis%253Aopen%2B%2522add%2Bclip-path%2522" target="_blank" title="https://github.com/facebook/react-native/pulls?q=is%3Apr+is%3Aopen+%22add+clip-path%22" ref="nofollow noopener noreferrer">正在审核</a>中。待它们合并发布后，期待您用它打造出精彩的作品！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Retrofit框架原理分析]]></title>    <link>https://juejin.cn/post/7600670417858773026</link>    <guid>https://juejin.cn/post/7600670417858773026</guid>    <pubDate>2026-01-30T03:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670417858773026" data-draft-id="7600665529113477120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Retrofit框架原理分析"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T03:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Retrofit框架原理分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:51:17.000Z" title="Fri Jan 30 2026 03:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一.基本用法</h3>
<h5 data-id="heading-1">1.创建Retrofit对象</h5>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HttpRetrofit</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Retrofit mRetrofit;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Retrofit <span class="hljs-title">getService</span>()</span>{
        <span class="hljs-keyword">if</span> (mRetrofit == <span class="hljs-literal">null</span>) {
            synchronized (HttpRetrofit.<span class="hljs-keyword">class</span>) {
                <span class="hljs-keyword">if</span> (mRetrofit == <span class="hljs-literal">null</span>) {
                    mRetrofit = <span class="hljs-keyword">new</span> Retrofit.Builder()
                            .baseUrl(ApiUrl.BASE_URL)
                            .client(WBHttpClient.getHttpClient())
                            .addConverterFactory(GsonConverterFactory.create())
                            .addCallAdapterFactory(RxJava2CallAdapterFactory.create())
                            .build();
                }
            }
        }
        <span class="hljs-keyword">return</span> mRetrofit;
    }
}
</code></pre>
<h5 data-id="heading-2">2.retrofit各种网络请求的用法</h5>
<pre><code class="hljs language-sql" lang="sql">  <span class="hljs-comment">/************************************GET网络请求方式******************************************************/</span>
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span>作用：<span class="hljs-keyword">GET</span>请求最简单的写法,无Path参数和Query参数 <span class="hljs-operator">*</span><span class="hljs-operator">/</span>
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-variable">@GET</span>("article/list/latest?page=1") <span class="hljs-keyword">Call</span><span class="hljs-operator">&lt;</span>ResponseBody<span class="hljs-operator">&gt;</span> getLatestString();
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span>作用：<span class="hljs-keyword">GET</span>请求，指定Path参数和Query参数
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-variable">@GET</span>("article/list/{type}?") <span class="hljs-keyword">Call</span><span class="hljs-operator">&lt;</span>QiushiModel<span class="hljs-operator">&gt;</span> getInfoList(<span class="hljs-variable">@Path</span>("type") String type, <span class="hljs-variable">@Query</span>("page") <span class="hljs-type">int</span> page);
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span>作用：<span class="hljs-keyword">GET</span>请求提交数据
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-variable">@GET</span>("MyWeb/RegServlet") <span class="hljs-keyword">Call</span><span class="hljs-operator">&lt;</span>ResponseBody<span class="hljs-operator">&gt;</span> getRegInfo(<span class="hljs-variable">@QueryMap</span> Map<span class="hljs-operator">&lt;</span>String, String<span class="hljs-operator">&gt;</span> map);
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span>作用：<span class="hljs-keyword">GET</span>请求,指定URL参数
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-variable">@GET</span> <span class="hljs-keyword">Call</span><span class="hljs-operator">&lt;</span>QiushiModel<span class="hljs-operator">&gt;</span> getInfoList(<span class="hljs-variable">@Url</span> String urlString);
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span>访问网络，下载大文件。 <span class="hljs-operator">*</span> 默认情况下，Retrofit在处理结果前会将服务器端的Response全部读进内存
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-variable">@Streaming</span> <span class="hljs-variable">@GET</span> <span class="hljs-keyword">Call</span><span class="hljs-operator">&lt;</span>ResponseBody<span class="hljs-operator">&gt;</span> getNetworkDataAsync(<span class="hljs-variable">@Url</span> String urlString);
    <span class="hljs-comment">/************************************POST网络请求方式******************************************************/</span>
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span>作用:post网络请求，向服务器提交表单域数据
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-variable">@FormUrlEncoded</span> <span class="hljs-variable">@POST</span>("MyWeb/RegServlet") <span class="hljs-keyword">Call</span><span class="hljs-operator">&lt;</span>ResponseBody<span class="hljs-operator">&gt;</span> postFormFields(<span class="hljs-variable">@Field</span>("username") String username, <span class="hljs-variable">@Field</span>("password") String password, <span class="hljs-variable">@Field</span>("age") String age);
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-variable">@FormUrlEncoded</span> <span class="hljs-variable">@POST</span>("MyWeb/RegServlet") <span class="hljs-keyword">Call</span><span class="hljs-operator">&lt;</span>ResponseBody<span class="hljs-operator">&gt;</span> postFormFieldMap(<span class="hljs-variable">@FieldMap</span> Map<span class="hljs-operator">&lt;</span>String , String<span class="hljs-operator">&gt;</span> map);
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span>作用：POST网络请求，上传单个文件，上传后的文件名称已经被指定
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-variable">@Multipart</span> <span class="hljs-variable">@POST</span>("MyWeb/UploadServlet") <span class="hljs-keyword">Call</span><span class="hljs-operator">&lt;</span>ResponseBody<span class="hljs-operator">&gt;</span> postUploadFile(<span class="hljs-variable">@Part</span>("uploadfile\";filename<span class="hljs-operator">=</span>\"myuploadimg.png") RequestBody requestBody);
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span>作用：POST网络请求，上传多个文件，同时上传表单域数据
    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-variable">@POST</span>("MyWeb/UPloadServlet") <span class="hljs-keyword">Call</span><span class="hljs-operator">&lt;</span>ResponseBody<span class="hljs-operator">&gt;</span> postUploadFilesMultipartBody(<span class="hljs-variable">@Body</span> MultipartBody multipartBody);}
<span class="hljs-operator">/</span><span class="hljs-operator">/</span>和Rxjava一起连用
  <span class="hljs-variable">@GET</span>(ApiUrl.GET_MARKET)
    Observable<span class="hljs-operator">&lt;</span>BaseResult<span class="hljs-operator">&lt;</span>List<span class="hljs-operator">&lt;</span>MarketBean<span class="hljs-operator">&gt;&gt;</span><span class="hljs-operator">&gt;</span> getMarket(<span class="hljs-variable">@QueryMap</span> Map<span class="hljs-operator">&lt;</span>String ,Object<span class="hljs-operator">&gt;</span> map);

 mRetrofit.create(WebService.class).getMarket(map).
                subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).
                subscribe(<span class="hljs-keyword">new</span> ObserverCallBack<span class="hljs-operator">&lt;</span>BaseResult<span class="hljs-operator">&lt;</span>List<span class="hljs-operator">&lt;</span>MarketBean<span class="hljs-operator">&gt;&gt;</span><span class="hljs-operator">&gt;</span>(<span class="hljs-keyword">new</span> ApiCallBack<span class="hljs-operator">&lt;</span>BaseResult<span class="hljs-operator">&lt;</span>List<span class="hljs-operator">&lt;</span>MarketBean<span class="hljs-operator">&gt;&gt;</span><span class="hljs-operator">&gt;</span>() {
                    <span class="hljs-variable">@Override</span>
                    public void onSuccess(BaseResult<span class="hljs-operator">&lt;</span>List<span class="hljs-operator">&lt;</span>MarketBean<span class="hljs-operator">&gt;&gt;</span> baseResult) {

                    }
                    <span class="hljs-variable">@Override</span>
                    public void onFailture(Throwable e,<span class="hljs-type">int</span> errorCode) {

                    }
                }));
</code></pre>
<h5 data-id="heading-3">3.动态代理示例【<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fgonjan-blog%2Fp%2F6685611.html%25E3%2580%2591" target="_blank" title="https://www.cnblogs.com/gonjan-blog/p/6685611.html%E3%80%91" ref="nofollow noopener noreferrer">www.cnblogs.com/gonjan-blog…</a></h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a84082a625794b3fa0b1012d10c509bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349877&amp;x-signature=ItJjt5Xy4uzFx5wu94L%2F1EHewZY%3D" alt="image.png" loading="lazy"/></p>
<p>动态代理(代理类在运行前不存在，运行时由程序生成的代理方式叫动态代理)
实现方式：创建一个实现了InvocationHandler 接口的类，然后实现其invoke方法,然后使用Proxy.newProxyInstance（）方法创建代理对象，通过代理对象，调用接口中的方法，实际上是调用的InvocationHandler 中的invoke方法</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 创建Person接口
 * @author Gonjan
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Person</span> {
    <span class="hljs-comment">//上交班费</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">giveMoney</span>()</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> <span class="hljs-title">implements</span> <span class="hljs-title">Person</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Student</span>(<span class="hljs-params">String name</span>)</span> {
        <span class="hljs-keyword">this</span>.name = name;
    }
    
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">giveMoney</span>()</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">//假设数钱花了一秒时间</span>
            Thread.sleep(<span class="hljs-number">1000</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
       System.<span class="hljs-keyword">out</span>.println(name + <span class="hljs-string">"上交班费50元"</span>);
    }
}

</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StuInvocationHandler</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
   <span class="hljs-comment">//invocationHandler持有的被代理对象</span>
    T target;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StuInvocationHandler</span><span class="hljs-params">(T target)</span> {
       <span class="hljs-built_in">this</span>.target = target;
    }
    
    <span class="hljs-comment">/**
     * proxy:代表动态代理对象
     * method：代表正在执行的方法
     * args：代表调用目标方法时传入的实参
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
        System.out.println(<span class="hljs-string">"代理执行"</span> +method.getName() + <span class="hljs-string">"方法"</span>);
     */   
        <span class="hljs-comment">//代理过程中插入监测方法,计算该方法耗时</span>
        MonitorUtil.start();
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);
        MonitorUtil.finish(method.getName());
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>测试代理类：</p>
<pre><code class="hljs language-arduino" lang="arduino">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyTest</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        
        <span class="hljs-comment">//创建一个实例对象，这个对象是被代理的对象</span>
        Person zhangsan = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Student</span>(<span class="hljs-string">"张三"</span>);
        
        <span class="hljs-comment">//创建一个与代理对象相关联的InvocationHandler</span>
        InvocationHandler stuHandler = <span class="hljs-keyword">new</span> <span class="hljs-built_in">StuInvocationHandler</span>&lt;Person&gt;(zhangsan);
        
        <span class="hljs-comment">//创建一个代理对象stuProxy来代理zhangsan，代理对象的每个执行方法都会替换执行Invocation中的invoke方法</span>
        Person stuProxy = (Person) Proxy.<span class="hljs-built_in">newProxyInstance</span>(Person.<span class="hljs-keyword">class</span>.<span class="hljs-built_in">getClassLoader</span>(), <span class="hljs-keyword">new</span> Class&lt;?&gt;[]{Person.<span class="hljs-keyword">class</span>}, stuHandler)；

       <span class="hljs-comment">//代理执行上交班费的方法</span>
        stuProxy.<span class="hljs-built_in">giveMoney</span>();
    }
}
</code></pre>
<p>打印结果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa81d8f790684a23833d46f6c2c6b331~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349877&amp;x-signature=cjM1wJac6hu0dA%2BYGTdRc3m1Fq0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">二.原理解析</h3>
<p>(1)通过构造者模式创建一个retrofit实例，配置baseUrl，OkHttpClient，CallAdapterFactory(Rxjava2CallAdapterFactory将代理返回的call对象转化为Observable对象), ConvertFactory（GsonConvertFactory将代理返回的请求的结果转化为javabean）</p>
<p>(2).通过retrofit对象的create（Class service）返回一个Service的动态代理对象，在调用Service的方法的时候，就是动态调用invoke方法,在Invoke方法中，调用loadServiceMethod(method)，在这个方法中会通过给method进行反射，解析注解，得到参数，请求头，请求地址，等等，构建Request请求所有需要的参数等，并提供toRequest()方法得到Request实例，然后构建OkHttpCall(servicMethod,args),通过
serviceMethod.callAdapter.adat(okHttpCall)，返回一个Observable或者是Call。</p>
<pre><code class="hljs language-scss" lang="scss">如果是Call&lt;T&gt; call；
call<span class="hljs-selector-class">.enqueue</span>( Callback&lt;T&gt; callback){
    Request request = serviceMethod<span class="hljs-selector-class">.toRequest</span>(args);
    okhttp3<span class="hljs-selector-class">.Call</span> call = serviceMethod<span class="hljs-selector-class">.callFactory</span><span class="hljs-selector-class">.newCall</span>(request);
}
如果是Observable&lt;T&gt; ,会调用subcribe添加观察者，实际会调用<span class="hljs-built_in">subscribeActual</span>(),在此方法中
observable<span class="hljs-selector-class">.subcribe</span>(new Observer(){}) <span class="hljs-comment">//添加观察者</span>
 <span class="hljs-comment">//Observable接口中的订阅方法</span>
  public final void <span class="hljs-built_in">subscribe</span>(Observer&lt;? super T&gt; observer) {
        ObjectHelper<span class="hljs-selector-class">.requireNonNull</span>(observer, "observer is null");
        try {
            observer = RxJavaPlugins<span class="hljs-selector-class">.onSubscribe</span>(this, observer);
            ObjectHelper<span class="hljs-selector-class">.requireNonNull</span>(observer, "Plugin returned null Observer");
            <span class="hljs-built_in">subscribeActual</span>(observer); <span class="hljs-comment">//调用该方法</span>
        } catch (NullPointerException e) { <span class="hljs-comment">// NOPMD</span>
            throw e;
        } catch (Throwable e) {  
        }
    }
<span class="hljs-comment">//CallEnqueueObservable中</span>
 protected void <span class="hljs-built_in">subscribeActual</span>(Observer&lt;? super Response&lt;T&gt;&gt; observer) {
    <span class="hljs-comment">// Since Call is a one-shot type, clone it for each new observer.</span>
    Call&lt;T&gt; call = originalCall<span class="hljs-selector-class">.clone</span>();
    CallCallback&lt;T&gt; callback = new CallCallback&lt;&gt;(call, observer);
    observer<span class="hljs-selector-class">.onSubscribe</span>(callback);
    call<span class="hljs-selector-class">.enqueue</span>(callback);<span class="hljs-comment">//执行OKHttpCall中的enqueue方法</span>
  }

</code></pre>
<p>(3).create()方法源码</p>
<pre><code class="hljs language-scss" lang="scss"> public &lt;T&gt; T <span class="hljs-built_in">create</span>(final Class&lt;T&gt; service) {
    Utils<span class="hljs-selector-class">.validateServiceInterface</span>(service);
    if (validateEagerly) {
      <span class="hljs-built_in">eagerlyValidateMethods</span>(service);
    }
    return (T) Proxy<span class="hljs-selector-class">.newProxyInstance</span>(service.getClassLoader(), new Class&lt;?&gt;<span class="hljs-selector-attr">[]</span> { service },
        new <span class="hljs-built_in">InvocationHandler</span>() {
          private final Platform platform = Platform<span class="hljs-selector-class">.get</span>();

          <span class="hljs-keyword">@Override</span> public Object invoke(Object proxy, Method method, <span class="hljs-keyword">@Nullable</span> Object[] args)
              throws Throwable {
            <span class="hljs-comment">// If the method is a method from Object then defer to normal invocation.</span>
            if (method.getDeclaringClass() == <span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.class</span>) {
              return method<span class="hljs-selector-class">.invoke</span>(this, args);
            }
            if (platform.isDefaultMethod(method)) {
              return platform<span class="hljs-selector-class">.invokeDefaultMethod</span>(method, service, proxy, args);
            }
            ServiceMethod&lt;<span class="hljs-selector-tag">Object</span>, <span class="hljs-selector-tag">Object</span>&gt; serviceMethod =
                (ServiceMethod&lt;Object, Object&gt;) <span class="hljs-built_in">loadServiceMethod</span>(method);
            OkHttpCall&lt;<span class="hljs-selector-tag">Object</span>&gt; okHttpCall = new OkHttpCall&lt;&gt;(serviceMethod, args);
            <span class="hljs-comment">/*   adapt方法中根据addCallAdapterFactory类型，如果是RxJava2CallAdapterFactory就返回 
                  Observable&lt;T&gt;, 如果不传，则返回Call&lt;T&gt;   */</span>
              return serviceMethod<span class="hljs-selector-class">.callAdapter</span><span class="hljs-selector-class">.adapt</span>(okHttpCall); 
          }
        });
  }

<span class="hljs-comment">//Retrofit中构造模式创建一个ServiceMethod对象</span>
  ServiceMethod&lt;?, ?&gt; <span class="hljs-built_in">loadServiceMethod</span>(Method method) {
    ServiceMethod&lt;?, ?&gt; result = serviceMethodCache<span class="hljs-selector-class">.get</span>(method);
    if (result != null) return result;
    synchronized (serviceMethodCache) {
      result = serviceMethodCache<span class="hljs-selector-class">.get</span>(method);
      if (result == null) {
 <span class="hljs-comment">// this表示Retrofit，retrofit里面持有baseUrl,okHttpClient,convertFactory,callAdapterFactory</span>
<span class="hljs-comment">//method通过反射，解析注解，得到参数，header,isMulpart,isbody,isFormUrlEncode等构建Request的</span>
<span class="hljs-comment">//必要参数，并提供toRequest()返回Reqeust对象.</span>
        result = new ServiceMethod<span class="hljs-selector-class">.Builder</span>&lt;&gt;(this, method)<span class="hljs-selector-class">.build</span>();
        serviceMethodCache<span class="hljs-selector-class">.put</span>(method, result);
      }
    }
    return result;
  }

  public ServiceMethod <span class="hljs-built_in">build</span>() {
      callAdapter = <span class="hljs-built_in">createCallAdapter</span>();
      responseType = callAdapter<span class="hljs-selector-class">.responseType</span>();
      if (responseType == Response.class || responseType == okhttp3.Response.class) {
        throw <span class="hljs-built_in">methodError</span>("'"
            + Utils.getRawType(responseType)<span class="hljs-selector-class">.getName</span>()
            + "' is not <span class="hljs-selector-tag">a</span> valid response <span class="hljs-selector-tag">body</span> type. Did you mean ResponseBody?");
      }
      responseConverter = <span class="hljs-built_in">createResponseConverter</span>();

      for (Annotation annotation : methodAnnotations) {
        <span class="hljs-built_in">parseMethodAnnotation</span>(annotation); <span class="hljs-comment">//</span>
      }

      if (httpMethod == null) {
        throw <span class="hljs-built_in">methodError</span>("HTTP method annotation is required (e.g., @GET, @POST, etc.).");
      }

      if (!hasBody) {
        if (isMultipart) {
          throw <span class="hljs-built_in">methodError</span>(
              "Multipart can only be specified on HTTP methods with request body (e.g., @POST).");
        }
        if (isFormEncoded) {
          throw <span class="hljs-built_in">methodError</span>("FormUrlEncoded can only be specified on HTTP methods with "
              + "request body (e.g., @POST).");
        }
      }

      int parameterCount = parameterAnnotationsArray<span class="hljs-selector-class">.length</span>;
      parameterHandlers = new ParameterHandler&lt;?&gt;<span class="hljs-selector-attr">[parameterCount]</span>;
      for (int p = <span class="hljs-number">0</span>; p &lt; parameterCount; p++) {
        Type parameterType = parameterTypes<span class="hljs-selector-attr">[p]</span>;
        if (Utils.hasUnresolvableType(parameterType)) {
          throw <span class="hljs-built_in">parameterError</span>(p, "Parameter type must not include a type variable or wildcard: %s",
              parameterType);
        }

        Annotation<span class="hljs-selector-attr">[]</span> parameterAnnotations = parameterAnnotationsArray<span class="hljs-selector-attr">[p]</span>;
        if (parameterAnnotations == null) {
          throw <span class="hljs-built_in">parameterError</span>(p, "No Retrofit annotation found.");
        }

        parameterHandlers<span class="hljs-selector-attr">[p]</span> = <span class="hljs-built_in">parseParameter</span>(p, parameterType, parameterAnnotations);
      }

      if (relativeUrl == null &amp;&amp; !gotUrl) {
        throw <span class="hljs-built_in">methodError</span>("Missing either @%s URL or @Url parameter.", httpMethod);
      }
      if (!isFormEncoded &amp;&amp; !isMultipart &amp;&amp; !hasBody &amp;&amp; gotBody) {
        throw <span class="hljs-built_in">methodError</span>("Non-body HTTP method cannot contain @Body.");
      }
      if (isFormEncoded &amp;&amp; !gotField) {
        throw <span class="hljs-built_in">methodError</span>("Form-encoded method must contain at least one @Field.");
      }
      if (isMultipart &amp;&amp; !gotPart) {
        throw <span class="hljs-built_in">methodError</span>("Multipart method must contain at least one @Part.");
      }

      return new ServiceMethod&lt;&gt;(this);
    }
 <span class="hljs-comment">/*解析注解得到构建RequestBuilder的核心参数httpMethod，baseUrl，relativeUrl, headers,
        contentType, hasBody, isFormEncoded, isMultipart */</span>

 private void <span class="hljs-built_in">parseMethodAnnotation</span>(Annotation annotation) {
      if (annotation instanceof DELETE) {
        <span class="hljs-built_in">parseHttpMethodAndPath</span>("DELETE", ((DELETE) annotation)<span class="hljs-selector-class">.value</span>(), false);
      } else if (annotation instanceof GET) {
        <span class="hljs-built_in">parseHttpMethodAndPath</span>("GET", ((GET) annotation)<span class="hljs-selector-class">.value</span>(), false);
      } else if (annotation instanceof HEAD) {
        <span class="hljs-built_in">parseHttpMethodAndPath</span>("HEAD", ((HEAD) annotation)<span class="hljs-selector-class">.value</span>(), false);
        if (!Void.class.equals(responseType)) {
          throw <span class="hljs-built_in">methodError</span>("HEAD method must use Void as response type.");
        }
      } else if (annotation instanceof PATCH) {
        <span class="hljs-built_in">parseHttpMethodAndPath</span>("PATCH", ((PATCH) annotation)<span class="hljs-selector-class">.value</span>(), true);
      } else if (annotation instanceof POST) {
        <span class="hljs-built_in">parseHttpMethodAndPath</span>("POST", ((POST) annotation)<span class="hljs-selector-class">.value</span>(), true);
      } else if (annotation instanceof PUT) {
        <span class="hljs-built_in">parseHttpMethodAndPath</span>("PUT", ((PUT) annotation)<span class="hljs-selector-class">.value</span>(), true);
      } else if (annotation instanceof OPTIONS) {
        <span class="hljs-built_in">parseHttpMethodAndPath</span>("OPTIONS", ((OPTIONS) annotation)<span class="hljs-selector-class">.value</span>(), false);
      } else if (annotation instanceof HTTP) {
        HTTP http = (HTTP) annotation;
        <span class="hljs-built_in">parseHttpMethodAndPath</span>(http.method(), http<span class="hljs-selector-class">.path</span>(), http<span class="hljs-selector-class">.hasBody</span>());
      } else if (annotation instanceof retrofit2.http.Headers) {
        String<span class="hljs-selector-attr">[]</span> headersToParse = ((retrofit2.http.Headers) annotation)<span class="hljs-selector-class">.value</span>();
        if (headersToParse.length == <span class="hljs-number">0</span>) {
          throw <span class="hljs-built_in">methodError</span>("@Headers annotation is empty.");
        }
        headers = <span class="hljs-built_in">parseHeaders</span>(headersToParse);
      } else if (annotation instanceof Multipart) {
        if (isFormEncoded) {
          throw <span class="hljs-built_in">methodError</span>("Only one encoding annotation is allowed.");
        }
        isMultipart = true;
      } else if (annotation instanceof FormUrlEncoded) {
        if (isMultipart) {
          throw <span class="hljs-built_in">methodError</span>("Only one encoding annotation is allowed.");
        }
        isFormEncoded = true;
      }
    }
</code></pre>
<p>(4).ServiceMethod中提供toRequest()生成Request.</p>
<pre><code class="hljs language-less" lang="less"> <span class="hljs-selector-tag">Request</span> <span class="hljs-selector-tag">toRequest</span>(<span class="hljs-variable">@Nullable</span> Object... args) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">IOException</span> {
    <span class="hljs-selector-tag">RequestBuilder</span> <span class="hljs-selector-tag">requestBuilder</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RequestBuilder</span>(httpMethod, baseUrl, relativeUrl, headers,
        contentType, hasBody, isFormEncoded, isMultipart);

    @<span class="hljs-selector-tag">SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>) <span class="hljs-comment">// It is an error to invoke a method with the wrong arg types.</span>
    <span class="hljs-selector-tag">ParameterHandler</span>&lt;<span class="hljs-selector-tag">Object</span>&gt;<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">handlers</span> = (ParameterHandler&lt;Object&gt;[]) <span class="hljs-selector-tag">parameterHandlers</span>;

    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">argumentCount</span> = <span class="hljs-selector-tag">args</span> != <span class="hljs-selector-tag">null</span> ? <span class="hljs-selector-tag">args</span><span class="hljs-selector-class">.length</span> : <span class="hljs-number">0</span>;
    <span class="hljs-selector-tag">if</span> (argumentCount != handlers.length) {
      <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">IllegalArgumentException</span>(<span class="hljs-string">"Argument count ("</span> + argumentCount
          + <span class="hljs-string">") doesn't match expected count ("</span> + handlers.length + <span class="hljs-string">")"</span>);
    }

    <span class="hljs-selector-tag">for</span> (int p = <span class="hljs-number">0</span>; p &lt; argumentCount; p++) {
      <span class="hljs-selector-tag">handlers</span><span class="hljs-selector-attr">[p]</span><span class="hljs-selector-class">.apply</span>(requestBuilder, args[p]);
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">requestBuilder</span><span class="hljs-selector-class">.build</span>();
  }
</code></pre>
<p>(5).当我们获取到一个Observable，是如何触发OkHttpCall执行的呢？</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-comment">//Observable接口中的订阅方法</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribe</span><span class="hljs-params">(Observer&lt;? <span class="hljs-built_in">super</span> T&gt; observer)</span> {
        ObjectHelper.requireNonNull(observer, <span class="hljs-string">"observer is null"</span>);
        <span class="hljs-keyword">try</span> {
            observer = RxJavaPlugins.onSubscribe(<span class="hljs-built_in">this</span>, observer);
            ObjectHelper.requireNonNull(observer, <span class="hljs-string">"Plugin returned null Observer"</span>);
            subscribeActual(observer); <span class="hljs-comment">//调用该方法</span>
        } <span class="hljs-keyword">catch</span> (NullPointerException e) { <span class="hljs-comment">// NOPMD</span>
            <span class="hljs-keyword">throw</span> e;
        } <span class="hljs-keyword">catch</span> (Throwable e) {  
        }
    }
<span class="hljs-comment">//CallEnqueueObservable中</span>
 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribeActual</span><span class="hljs-params">(Observer&lt;? <span class="hljs-built_in">super</span> Response&lt;T&gt;&gt; observer)</span> {
    <span class="hljs-comment">// Since Call is a one-shot type, clone it for each new observer.</span>
    Call&lt;T&gt; call = originalCall.clone();
    CallCallback&lt;T&gt; callback = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CallCallback</span>&lt;&gt;(call, observer);
    observer.onSubscribe(callback);
    call.enqueue(callback);<span class="hljs-comment">//执行OKHttpCall中的enqueue方法</span>
  }

 <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">enqueue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Callback&lt;T&gt; callback)</span> {
        okhttp3.Call call;
     <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> serviceMethod.toRequest(args);
    <span class="hljs-comment">//执行Request请求.</span>
    okhttp3.<span class="hljs-type">Call</span>   <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> serviceMethod.callFactory.newCall(request); <span class="hljs-comment">//callFactory就是OkHttpClient实例</span>
  }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Handler消息传递机制]]></title>    <link>https://juejin.cn/post/7600681071714779136</link>    <guid>https://juejin.cn/post/7600681071714779136</guid>    <pubDate>2026-01-30T03:53:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600681071714779136" data-draft-id="7600728866756526132" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Handler消息传递机制"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T03:53:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Handler消息传递机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:53:44.000Z" title="Fri Jan 30 2026 03:53:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2Ff10cff5b4c25" target="_blank" title="https://www.jianshu.com/p/f10cff5b4c25" ref="nofollow noopener noreferrer">Android消息机制的原理及源码解析 - 简书 (jianshu.com)</a></p>
<p><a href="https://juejin.cn/post/6844903446571663374" target="_blank" title="https://juejin.cn/post/6844903446571663374">Android Handler 消息机制（解惑篇）</a></p>
<p><a href="https://juejin.cn/post/6844903783139393550" target="_blank" title="https://juejin.cn/post/6844903783139393550">Handler 都没搞懂，拿什么去跳槽啊？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fguolin_blog%2Farticle%2Fdetails%2F9991569" target="_blank" title="https://blog.csdn.net/guolin_blog/article/details/9991569" ref="nofollow noopener noreferrer">郭霖 android异步消息处理机制完全解</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c24abdb3f3c64601afed561a7eace259~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350024&amp;x-signature=vVMJsx8j5D1F2%2BkOy0gRwA2xZso%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-0">1.ActivityThread.main</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Looper.prepareMainLooper(); 
        <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();
        thread.attach(<span class="hljs-literal">false</span>, startSeq);<span class="hljs-comment">//把ApplicationThread对象给到AMS</span>
        Looper.loop(); 
  }

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareMainLooper</span><span class="hljs-params">()</span> {
        prepare(<span class="hljs-literal">false</span>);
        <span class="hljs-keyword">synchronized</span> (Looper.class) {
            <span class="hljs-keyword">if</span> (sMainLooper != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"The main Looper has already been prepared."</span>);
            }
            sMainLooper = myLooper();
        }
 }
<span class="hljs-comment">//新建Looper对象，并在构造方法中新建MessageQueue对象，把Looper对象放到存放到ThreadLocal类所在的ThreadMap中，以当前线程为key，Looper对象为值进行存储。</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepare</span><span class="hljs-params">(<span class="hljs-type">boolean</span> quitAllowed)</span> {
        <span class="hljs-keyword">if</span> (sThreadLocal.get() != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Only one Looper may be created per thread"</span>);
        }
        sThreadLocal.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Looper</span>(quitAllowed));
 }
<span class="hljs-keyword">private</span> <span class="hljs-title function_">Looper</span><span class="hljs-params">(<span class="hljs-type">boolean</span> quitAllowed)</span> {
      mQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>(quitAllowed);
      mThread = Thread.currentThread();
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);
        <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>)
            map.set(<span class="hljs-built_in">this</span>, value);
        <span class="hljs-keyword">else</span>
            createMap(t, value);
 }
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-meta">@Nullable</span> Looper <span class="hljs-title function_">myLooper</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sThreadLocal.get();
}
<span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);
        <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) {
            ThreadLocalMap.<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> map.getEntry(<span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
                <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
                <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (T)e.value;
                <span class="hljs-keyword">return</span> result;
            }
        }
        <span class="hljs-keyword">return</span> setInitialValue();
}

</code></pre>
<h3 data-id="heading-1">2.Handler的基本用法</h3>
<pre><code class="hljs language-scss" lang="scss">Handler handler=new <span class="hljs-built_in">Handler</span>(){  
    public  void <span class="hljs-built_in">handleMessage</span>(Message msg){
           <span class="hljs-comment">//接收并处理消息</span>
   }
}
handler<span class="hljs-selector-class">.post</span>(runnable)；
handler<span class="hljs-selector-class">.sendMessage</span>(msg)；
</code></pre>
<h3 data-id="heading-2">3.Hanlder和Looper进行关联</h3>
<p>Handler构造方法，通过myLooper方法从ThreadLocal所在的ThreadMap中，根据当前的线程（作为key值）从ThreadMap中Looper对象，根据Looper对象得到MessageQueue对象，便于Handler发送消息时，可以把消息添加到MessageQueue对象中.</p>
<pre><code class="hljs language-ini" lang="ini">public Handler(Callback callback,boolean async){
         <span class="hljs-attr">mLooper</span>=Looper.myLooper()<span class="hljs-comment">;</span>
         <span class="hljs-attr">mQueue</span>=mLooper.mQueue<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-3">4.Handler.sendMessage或者Handler.post(runable)解析</h3>
<p>(1).Hanlder.post也是runnable封装成Message对象</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">post</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Runnable r)</span> {
       <span class="hljs-keyword">return</span>  sendMessageDelayed(getPostMessage(r), <span class="hljs-number">0</span>);
 }
 <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Message <span class="hljs-title function_">getPostMessage</span><span class="hljs-params">(Runnable r)</span> {
        <span class="hljs-type">Message</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> Message.obtain();
        m.callback = r;
        <span class="hljs-keyword">return</span> m;
}
</code></pre>
<p>(2).Handler.sendMessage最终会把消息添加到消息队列</p>
<pre><code class="hljs language-less" lang="less"> <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">sendMessage</span>(<span class="hljs-variable">@NonNull</span> Message msg) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">sendMessageDelayed</span>(msg, <span class="hljs-number">0</span>);
}
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">sendMessageDelayed</span>(<span class="hljs-variable">@NonNull</span> Message msg, long delayMillis) {
        <span class="hljs-selector-tag">if</span> (delayMillis &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-selector-tag">delayMillis</span> = <span class="hljs-number">0</span>;
        }
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">sendMessageAtTime</span>(msg, SystemClock.<span class="hljs-built_in">uptimeMillis</span>() + delayMillis);
 }
 <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">sendMessageAtTime</span>(<span class="hljs-variable">@NonNull</span> Message msg, long uptimeMillis) {
        <span class="hljs-selector-tag">MessageQueue</span> <span class="hljs-selector-tag">queue</span> = <span class="hljs-selector-tag">mQueue</span>;
        <span class="hljs-selector-tag">if</span> (queue == null) {
            <span class="hljs-selector-tag">RuntimeException</span> <span class="hljs-selector-tag">e</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(
                    this + <span class="hljs-string">" sendMessageAtTime() called with no mQueue"</span>);
            <span class="hljs-selector-tag">Log</span><span class="hljs-selector-class">.w</span>(<span class="hljs-string">"Looper"</span>, e.<span class="hljs-built_in">getMessage</span>(), e);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">false</span>;
        }
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">enqueueMessage</span>(queue, msg, uptimeMillis);
    }
 <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">enqueueMessage</span>(<span class="hljs-variable">@NonNull</span> MessageQueue queue, <span class="hljs-variable">@NonNull</span> Message msg,
            long uptimeMillis) {
        <span class="hljs-selector-tag">msg</span><span class="hljs-selector-class">.target</span> = <span class="hljs-selector-tag">this</span>;
        <span class="hljs-selector-tag">msg</span><span class="hljs-selector-class">.workSourceUid</span> = <span class="hljs-selector-tag">ThreadLocalWorkSource</span><span class="hljs-selector-class">.getUid</span>();

        <span class="hljs-selector-tag">if</span> (mAsynchronous) {
            <span class="hljs-selector-tag">msg</span><span class="hljs-selector-class">.setAsynchronous</span>(true);
        }
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">queue</span><span class="hljs-selector-class">.enqueueMessage</span>(msg, uptimeMillis);
    }
</code></pre>
<h3 data-id="heading-4">5.Looper.loop开启死循环</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//Looper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Looper</span> <span class="hljs-variable">me</span> <span class="hljs-operator">=</span> myLooper();
    <span class="hljs-keyword">if</span> (me == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);
    }
    <span class="hljs-keyword">final</span> <span class="hljs-type">MessageQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> me.mQueue;
    <span class="hljs-keyword">for</span> (;;) {
       <span class="hljs-comment">// 不断从 MessageQueue 获取 消息</span>
        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> queue.next(); <span class="hljs-comment">// might block</span>
        <span class="hljs-comment">//退出 Looper </span>
        <span class="hljs-keyword">if</span> (msg == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">try</span> {
            msg.target.dispatchMessage(msg);<span class="hljs-comment">// msg.target就是Handler</span>
            end = (slowDispatchThresholdMs == <span class="hljs-number">0</span>) ? <span class="hljs-number">0</span> : SystemClock.uptimeMillis();
        } <span class="hljs-keyword">finally</span> {
        }
    }
}
</code></pre>
<h3 data-id="heading-5">6.Handler.dispatchMessage</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//Handler</span>
public void <span class="hljs-built_in">dispatchMessage</span>(Message msg) {
  <span class="hljs-comment">//msg.callback 是 Runnable ，如果是 post方法则会走这个 if</span>
  if (msg.callback != null) {
    <span class="hljs-built_in">handleCallback</span>(msg);
  } else {
    <span class="hljs-comment">//callback 见【3.4】</span>
    if (mCallback != null) {
      if (mCallback.handleMessage(msg)) {
        return;
      }
    }
    <span class="hljs-comment">//回调到 Handler 的 handleMessage 方法</span>
    <span class="hljs-built_in">handleMessage</span>(msg);
  }
}
</code></pre>
<h3 data-id="heading-6">7.Handler延伸</h3>
<p>(1).为什么主线程不会因为Looper.loop()里面的死循环卡死？
handler机制是使用Linux管道来实现的，主线程没有消息处理时，也就是当queue.next获取消息时，
nativePollOnce，底层阻塞在管道读取端，主线程进入休眠状态，释放CPU资源，而不会一直去执行for循环，直到，MsgQueue里面有消息被添加进来，调用nativeWake()，底层管道写端写入数据，唤醒主线线程.
(2).Hanlder引起的内存泄漏原因以及最佳解决方案。
Handler允许我们发送延迟消息，如果在延时期间，用户关闭了Activity,那么Activity会泄露。
原因：Message（target）持有Handler,Handler作为内部类，持有外部类Activity,最终导致Activity内存泄漏。
解决该问题最有效的方法是：将Handler定义为静态内部类，在内部持有Activity的弱引用，并及时移除所有消息。</p>
<pre><code class="hljs language-scala" lang="scala">public static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SafeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span></span>{
        <span class="hljs-keyword">private</span> <span class="hljs-type">WeakReference</span>&lt;<span class="hljs-type">HandleActivity</span>&gt; ref;
        public <span class="hljs-type">SafeHandler</span>(<span class="hljs-type">HandlerActivity</span> activity){
                ref=<span class="hljs-keyword">new</span> <span class="hljs-type">WeakReference</span>&lt;<span class="hljs-type">HandleActivity</span>&gt;(activity);
        }
       public void handleMessage(<span class="hljs-keyword">final</span> <span class="hljs-type">Message</span> mes){
              <span class="hljs-type">HandleActivity</span> activity=ref.get();
              <span class="hljs-keyword">if</span>(activity!=<span class="hljs-literal">null</span>){
                   activity.handleMessage(msg);
              }
      }
}
</code></pre>
<p>(3).子线程里面如何使用Handler</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable(){
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span>{
           <span class="hljs-comment">//新建一个Looper对象，把当期线程作为key值，存储到ThreadLocal类中的ThreadLocalMap中.</span>
          Looper.prepare();
       <span class="hljs-comment">//构造方法中根据当期线程，得到Looper对象,然后从Looper对象得到MsgQueue</span>
          Handler handler=<span class="hljs-keyword">new</span> Handler();
          handler.post(<span class="hljs-keyword">new</span> Runable(){ 
                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> {
                    <span class="hljs-comment">// 在这里执行你需要在子线程中完成的任务</span>
                }
          });
        <span class="hljs-comment">//启动消息循环</span>
        Looper.loop();
      }
}).start();
</code></pre>
<p>(4).在子线程中进行UI操作的方式.
Handler.post(runnable)
View.post
Activity.runOnUiThread</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Runloop的无限循环]]></title>    <link>https://juejin.cn/post/7600791597169180715</link>    <guid>https://juejin.cn/post/7600791597169180715</guid>    <pubDate>2026-01-30T04:20:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600791597169180715" data-draft-id="7600728866756706356" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Runloop的无限循环"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T04:20:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="betcha0724"/> <meta itemprop="url" content="https://juejin.cn/user/1757471366985452"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Runloop的无限循环
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1757471366985452/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    betcha0724
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:20:22.000Z" title="Fri Jan 30 2026 04:20:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>不是说runloop是无限循环吗，为啥主线程还会休眠？</p>
</blockquote>
<p><strong>Runloop 的 “无限循环” 和 “休眠” 并不矛盾</strong>，反而这两个特性是 Runloop 设计的核心精髓 ——<strong>Runloop 的无限循环是 “带休眠的循环”，不是空转的死循环</strong>，休眠正是为了让无限循环不消耗多余资源。</p>
<p>简单说结论：<strong>主线程 Runloop 的 while (1) 是 “逻辑上的无限循环”，但循环内部会主动触发线程休眠，直到有事件唤醒才继续执行循环体，而非一直空转执行代码</strong>。</p>
<h3 data-id="heading-0">一、先破误区：“无限循环”≠“一直执行代码”</h3>
<p>普通的空转死循环是这样的（会把 CPU 占满）：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 纯空转死循环：CPU 100%占用，线程一直跑</span>
<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 什么都不做，持续循环</span>
}
</code></pre>
<p>而<strong>Runloop 的无限循环是 “智能循环”</strong> ，伪代码更接近这样：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Runloop的无限循环：有任务就执行，无任务就休眠</span>
<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 1. 检查是否有待处理的事件/任务</span>
    <span class="hljs-keyword">if</span> (有任务) {
        处理任务（事件、渲染、回调等）;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 2. 无任务时，让线程进入「休眠状态」，释放CPU资源</span>
        内核层面让线程休眠，等待唤醒信号;
    }
}
</code></pre>
<p>Runloop 的 “无限” 体现在<strong>这个 while (1) 的逻辑永远不退出</strong>（主线程 Runloop 默认永不停止），但 ** 循环体的执行是 “按需触发”** 的 —— 无任务时根本不执行循环体的核心逻辑，而是让线程休眠。</p>
<h3 data-id="heading-1">二、关键原理：Runloop 如何实现 “休眠 - 唤醒”（内核层面）</h3>
<p>Runloop 的休眠不是自己实现的，而是基于<strong>操作系统内核的 IO 多路复用机制</strong>（iOS/macOS 下是<code>mach_msg</code>，底层封装了 select/poll/kqueue），这是跨平台事件驱动的通用方案，核心流程分 3 步：</p>
<ol>
<li><strong>无任务时，Runloop 调用<code>mach_msg</code>向内核发送 “休眠请求”</strong> ：主线程会从<strong>运行态</strong>切换为<strong>休眠态</strong>（也叫等待态），此时线程不会占用 CPU 的任何时间片，CPU 可以去处理其他线程 / 进程的任务，资源消耗几乎为 0；</li>
<li><strong>有事件时，内核主动唤醒线程</strong>：当有能唤醒 Runloop 的事件出现时（如 CADisplayLink 刷新、触摸事件、网络回调、定时器），<strong>内核会向该线程发送唤醒信号</strong>，触发<code>mach_msg</code>返回，线程从休眠态切回运行态；</li>
<li><strong>唤醒后继续执行循环体</strong>：Runloop 接收到唤醒信号后，继续执行 while (1) 的循环体，处理对应的任务，完成后再次检查是否有新任务，无任务则再次休眠。</li>
</ol>
<p><strong>对主线程来说</strong>：CADisplayLink（屏幕刷新定时器）是<strong>最常见的唤醒源</strong>（60Hz 下 16.67ms 唤醒一次），其次是用户的触摸、滑动等 UI 事件。</p>
<h3 data-id="heading-2">三、结合帧渲染理解：休眠 - 唤醒 - 渲染的完整循环（60Hz）</h3>
<p>把 Runloop 的休眠、唤醒和帧渲染结合，<strong>主线程的完整工作流程</strong>就非常清晰了（无其他 UI 事件时）：</p>
<ol>
<li>
<p><strong>休眠阶段</strong>：主线程 Runloop 无任务，调用<code>mach_msg</code>进入休眠，CPU 释放；</p>
</li>
<li>
<p><strong>定时唤醒</strong>：16.67ms 后，CADisplayLink 触发，内核唤醒主线程，Runloop 的 while (1) 继续执行；</p>
</li>
<li>
<p><strong>任务检查</strong>：Runloop 检查是否有 UI 更新标记（CATransaction）；</p>
<ul>
<li>✅<strong>有更新</strong>：执行布局→绘制→合成→显示的一帧渲染流程，完成后再次检查无新任务，进入休眠；</li>
<li>❌<strong>无更新</strong>：直接跳过渲染阶段，再次调用<code>mach_msg</code>进入休眠；</li>
</ul>
</li>
<li>
<p><strong>重复循环</strong>：每 16.67ms 被 CADisplayLink 唤醒一次，重复上述步骤。</p>
</li>
</ol>
<h3 data-id="heading-3">四、额外补充：为什么 Runloop 要设计 “休眠” 机制？</h3>
<p>如果主线程 Runloop 的无限循环<strong>没有休眠</strong>，而是一直空转检查任务，会导致两个严重问题：</p>
<ol>
<li><strong>CPU 占用率飙升</strong>：一个空转的 while (1) 会把单个 CPU 核心占满（100%），主线程是核心线程，会直接导致设备发热、耗电、卡顿；</li>
<li><strong>系统资源浪费</strong>：CPU 一直被 Runloop 的空转占用，无法分配给其他线程 / 进程（如后台网络、音频播放），整个 APP 的运行效率会大幅降低。</li>
</ol>
<p>而<strong>休眠机制</strong>完美解决了这两个问题：无任务时线程不占 CPU，有任务时及时唤醒，实现了 <strong>“按需执行，资源最优”</strong>，这也是 Runloop 能成为 iOS 事件驱动核心的关键原因。</p>
<h3 data-id="heading-4">最终一句话总结</h3>
<p>主线程 Runloop 是<strong>逻辑上的无限循环</strong>（while (1) 永不退出），但<strong>物理上的执行是按需的</strong>—— 无任务时通过内核让线程休眠，有事件（如屏幕刷新、UI 触摸）时被唤醒继续执行循环体，休眠和无限循环是 Runloop 的两个核心特性，而非矛盾点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[主线程Runloop]]></title>    <link>https://juejin.cn/post/7600710943250579498</link>    <guid>https://juejin.cn/post/7600710943250579498</guid>    <pubDate>2026-01-30T04:23:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600710943250579498" data-draft-id="7600704706551185448" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="主线程Runloop"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T04:23:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="betcha0724"/> <meta itemprop="url" content="https://juejin.cn/user/1757471366985452"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            主线程Runloop
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1757471366985452/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    betcha0724
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:23:55.000Z" title="Fri Jan 30 2026 04:23:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Runloop循环的代码，不是在主线程上运行的吗</p>
</blockquote>
<p><strong>Runloop 的这个无限循环代码，就是直接运行在主线程上的</strong>，这是核心关键 ——<strong>主线程的本质，就是执行 Runloop 无限循环的线程</strong>，二者是完全绑定的，不存在 “Runloop 循环在其他线程，主线程做别的事” 的情况。</p>
<h3 data-id="heading-0">一、先明确核心对应关系</h3>
<p>iOS 中<strong>主线程的入口函数</strong>，最终就是启动 Runloop 的无限循环，伪代码的对应关系是：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">// 主线程的入口（UIApplicationMain函数底层）
int main(int argc, char * argv[]) {
    @autoreleasepool {
        // 1. 初始化UIApplication、AppDelegate等核心对象
        // 2. 启动「主线程的Runloop」，执行无限循环
        CFRunLoopRunMain(); // 这个函数内部，就是Runloop的while(1)无限循环
        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));
    }
}
</code></pre>
<p>简单说：<strong>主线程启动后，唯一的核心工作就是执行 Runloop 的无限循环</strong>，主线程的所有任务（UI 事件、渲染、定时器、网络回调等），都<strong>必须在这个循环体内部执行</strong>。</p>
<h3 data-id="heading-1">二、关键：“主线程执行 Runloop 循环” 的具体含义</h3>
<p>你可以把<strong>主线程</strong>理解为<strong>一个 “执行代码的容器”</strong> ，把<strong>Runloop 的 while (1)<strong>理解为</strong>这个容器里永远在运行的 “主程序”</strong> ——</p>
<ol>
<li>主线程被创建后，立刻加载并执行 Runloop 的无限循环代码；</li>
<li>这个循环代码<strong>霸占了主线程的执行权</strong>，主线程后续所有的操作，都是<strong>在这个循环体的内部</strong>被触发和执行的（比如处理触摸事件、执行帧渲染、调用你的业务代码）；</li>
<li>只要 Runloop 的循环不退出，主线程就会一直存活（APP 前台运行时，主线程 Runloop 永不退出）；如果循环退出，主线程就会执行完毕并销毁（APP 退出时才会发生）。</li>
</ol>
<h3 data-id="heading-2">三、结合 “休眠” 再理解：主线程休眠 = Runloop 循环暂停</h3>
<p>之前说的<strong>Runloop 让线程休眠</strong>，本质就是<strong>让主线程本身进入休眠态</strong>：</p>
<ul>
<li>当 Runloop 执行到<code>mach_msg</code>（内核休眠接口）时，<strong>主线程</strong>会从<strong>运行态</strong>切换为<strong>休眠态</strong>，此时主线程不再执行任何代码（包括 Runloop 的循环体），CPU 也会释放；</li>
<li>当内核收到唤醒信号（如 CADisplayLink、触摸事件），会把<strong>主线程</strong>切回<strong>运行态</strong>，Runloop 的 while (1) 循环会继续执行后续的任务处理、渲染等逻辑。</li>
</ul>
<p><strong>一句话讲清</strong>：Runloop 的循环代码是主线程的 “核心程序”，主线程的生命周期和 Runloop 的循环绑定，Runloop 的休眠 / 唤醒就是主线程的休眠 / 唤醒。</p>
<h3 data-id="heading-3">四、再补一个易混点：主线程的任务，都在 Runloop 循环体内执行</h3>
<p>你在主线程写的所有代码（比如<code>viewDidLoad</code>、按钮点击事件、<code>dispatch_async(dispatch_get_main_queue(), ^{...})</code>），<strong>都不是直接 “塞” 到主线程</strong>，而是<strong>被加入到 Runloop 的任务队列中</strong>，等待 Runloop 的循环体执行到对应阶段时，再被主线程执行。</p>
<p>举个例子，按钮点击的执行流程：</p>
<ol>
<li>点击按钮，系统将 “点击事件” 加入<strong>主线程 Runloop 的事件队列</strong>；</li>
<li>内核唤醒主线程，Runloop 的 while (1) 循环继续执行；</li>
<li>Runloop 从事件队列中取出 “点击事件”，<strong>让主线程执行</strong>你写的点击回调代码；</li>
<li>回调执行完毕，Runloop 检查是否有 UI 更新 / 其他任务，无则让主线程再次休眠。</li>
</ol>
<h3 data-id="heading-4">最终总结</h3>
<ol>
<li>Runloop 的无限循环<strong>直接运行在主线程</strong>，是主线程的核心执行代码；</li>
<li>主线程的生命周期与 Runloop 循环绑定，循环不退出，主线程就一直存活；</li>
<li>Runloop 的 “休眠 / 唤醒” 就是<strong>主线程</strong>的休眠 / 唤醒，无任务时主线程休眠，有任务时被唤醒执行循环体；</li>
<li>主线程的所有任务（包括你的业务代码、UI 渲染、事件处理），都<strong>在 Runloop 循环体内部</strong>被执行。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawdbot 8万Star的背后：AI 助理真的来了么（附macOS本地尝鲜教程-有手就行版）]]></title>    <link>https://juejin.cn/post/7600665529112821760</link>    <guid>https://juejin.cn/post/7600665529112821760</guid>    <pubDate>2026-01-30T02:51:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600665529112821760" data-draft-id="7600670417858265122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawdbot 8万Star的背后：AI 助理真的来了么（附macOS本地尝鲜教程-有手就行版）"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-30T02:51:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="灵臂Lybic"/> <meta itemprop="url" content="https://juejin.cn/user/1417690301865552"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawdbot 8万Star的背后：AI 助理真的来了么（附macOS本地尝鲜教程-有手就行版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1417690301865552/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    灵臂Lybic
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:51:56.000Z" title="Fri Jan 30 2026 02:51:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>从 Chat 到 Action，AI 正在接管我们的屏幕。但在一周 8 万 Star 的狂欢背后，爆火的应用与脆弱的安全性之间，正横亘着一道待解的基础设施鸿沟。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15998162f6c34964b703a4fb49f635ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=noBtFuJJ9rr3%2F6QJwSRl6GOyDq0%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-0"><strong><strong>流量高地与范式转移：</strong> <strong>从“对话”到“实战”</strong></strong></h2>
<p>这几天 Clawdbot 的出圈速度很夸张。社区里最直观的信号是 GitHub star 曲线在短时间内冲到数万量级，很多讨论甚至直接把它当作“2026 开源增长最快的现象级项目之一”。 更戏剧化的是，它还带出了一个“周边行情”：大量开发者开始用 Mac mini 这类小主机来常驻运行，从而实现一个 7×24h 永不下班的“核动力牛马”，甚至出现“下单截图刷屏”“卖断货”的情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d94f94fd53b40efa069f818148bd9c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=PEEck9K8aBf3q%2FZeFNik6GA93hU%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>Clawdbot 现在官方名字是 Moltbot，比较有意思的是，改名的原因是因为 Anthropic 认为 Clawdbot 这个名字太容易被市场误解为Claude Code的延展产品，所以提出了抗议，创始人“被迫”宣布改名。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a02a40ea8b8466b82a0e0852672df01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=RyMiNtpMnKlgolDQOTFq53Q%2FnaI%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>它的定位非常清晰：一个你自己运行的个人 AI 助手，驻扎在你已经在用的聊天渠道里，比如 WhatsApp、 Telegram、 Slack、 Discord、 Google Chat、 Signal、 iMessage、 Microsoft Teams、 WebChat 等，同时支持在 macOS、iOS、Android 上交互，并提供一个可控的 Canvas 界面。 这套“入口在聊天里，执行在你自己的环境里”的组合，就这样魔幻而又切切实实的爆火了。</p>
<p>为什么这类东西会一波接一波地爆火？从最近一段时间的产品形态看，确实有个明显的风向在强化：大众的注意力正在从“对话型”迁移到“实操型”。对话给的是答案，实操给的是结果。对绝大多数人来说，后者更像他们心里对“AI 助理”的默认想象，这一点在 Clawdbot 的传播中被放大得很充分。</p>
<p><strong><strong>沸腾后的冷思考</strong></strong></p>
<p><strong><strong>是技术奇点，还是“时势英雄”？</strong></strong></p>
<p>不过这里也值得降降温。爆火当然意味着能力点戳中了人心，但它同样蕴含着几件事叠加：创作者本身的影响力与信用积累，以及社交平台的流量机制、AI时代的掉队焦虑，共同把某个叙事推到最大音量。你不需要把每一次“现象级”都理解成行业天翻地覆。更像是时势推着一个正确方向的样品突然被看见了，然后所有人的情绪一起涌上来。</p>
<p>再说体验层面的“落差”。很多人上手后会发现，它没有想象中那么万能，这其实并不意外。因为这类个人 Agent 往往把“连接器很多”“能动手”放在第一优先级，工程细节与产品打磨会滞后，早期 UI 小问题、流程不顺手、边界场景翻车都很常见。更关键的一点在成本。只要你把它当作“经常在线的执行型助理”，模型调用和工具链路的成本就会从偶发费用变成持续开销，近几天已经陆续看到网上有人晒图仅仅使用十几个小时，就已经消耗了上百美金的token。很多用户会自然滑向一种状态：好玩大于好用，体验大于实用。</p>
<p>真正值得认真讨论的，是它爆火后暴露出来的“安全现实”。Clawdbot 的卖点之一就是更本地化，更可控，更接近你的真实环境，它也确实会涉及对本地 shell、文件系统、浏览器等能力的调用与编排。 这让它强大，也让它变得危险。由于它拥有极高的系统权限。大部分用户担心 AI 误操作导致主力机数据受损，或是隐私信息泄露，被迫选择了“物理隔离”——用一台专门的硬件来承载这个不确定的“执行者”。</p>
<p>这也解释了另一个看似荒诞的现象：Clawdbot 带动了 Mac mini 等小主机被抢购。很多人把它解读为“性能需求”，但更底层的心理动因往往是“把东西放在自己手里更安心”。 你会发现，这里面其实同时包含了信任与不信任。信任的是我愿意让它替我做事，不信任的是我不想把自己的数据和权限直接丢进不可控的黑盒里。</p>
<h2 data-id="heading-1"><strong><strong>数据安全是“执行权”的护城河</strong></strong></h2>
<p>同样，GUI Agent（具备图形界面操作能力的智能体）作为一个实操型的技术路线，也具备巨大的想象和成长空间。</p>
<p>例如前段时间爆火出圈的豆包手机、Open-AutoGLM 等，它可以完成跨 App 的复杂长链路任务，但其权限的边界与数据安全的保障，将决定它是“神助攻”还是“定时炸弹”。这正是灵臂 Lybic 的出发点之一。</p>
<p>GUI Agent 之所以想象空间更大，因为它天然能覆盖那些没有标准 API 的存量软件和复杂流程。可它也天然更危险，因为它同样处在高权限的边缘，出错时的破坏半径更接近真实世界。把这一类能力推向大众之前，一个更稳妥的路径是先把“执行空间”变成默认护栏。</p>
<p>这也是 Lybic 想做的事之一。我们把“能不能做”之外的三件事放在同等重要的位置：隔离、可见、可止损。让模型或 Agent 在云端沙盒里执行 GUI 任务，你可以实时看到它在做什么，发现不对可以随时人工接管，任务结束可以销毁环境。这样一来，创新速度可以继续加快，试错成本被关在可控范围里，真实设备和真实数据少承担一些不必要的风险。</p>
<h2 data-id="heading-2"><strong>写在最后</strong></h2>
<p>Clawdbot 的爆火更像一个信号：实操型 AI 正在成为默认的大众期待。然而技术的热度终会回归工程的理性，接下来决定它们能不能长期留下来的，往往不是演示有多酷，而是执行边界有没有被认真设计。我们更愿意把这当作一个行业共同要补的基础课。让 AI 去做事之前，先给它一个合适的“房间”，再谈把它放进真实世界。</p>
<p><strong>附macOS部署教程</strong></p>
<p>首先打开终端运行一串神秘小代码（前提是确保node.js版本大于22）</p>
<pre><code class="hljs language-arduino" lang="arduino">curl -fsSL https:<span class="hljs-comment">//molt.bot/install.sh | bash -s -- --install-method git</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>静待下载安装完毕后，继续运行</p>
<pre><code class="hljs language-css" lang="css">moltbot onboard <span class="hljs-attr">--install-daemon</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>然后就会看到如下界面，那么恭喜你已经成功部署了Moltbot！教程到此结束（bushi）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1097b27237242dcafe8377043e3555e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=XGwxZVKciWwzW0pb%2F1%2BK%2BhQn02M%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>言归正传，官方在这里也是做出了风险提示。正如上文中所说，moltbot拥有着极大的系统权限，（同时也意味着极大的风险，强烈建议使用备用机安装），所以这里选 yes，因为不选 yes 没法进行下一步，没错官方就是这么霸道。</p>
<p>接下来根据界面提示，选择自己中意的大模型接入，我们这里选择了智谱的GLM 4.7。API key可以到对应的官网去购买/申请。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/421a4080362a4aa78496e2fe0a855c6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=4%2FZky44kLBm6XBqFyAmeB6Qs11I%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>鉴于我们是本地尝鲜版，为了简化流程，这里选择跳过。后续我们也会尝试去适配飞书或QQ。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d2654c43a034793b65af6396148635d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=knMeNBxNzVs1OY1gb8U479kLB9U%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>选择想装的skill，空格进行选中，回车确认后会自动安装</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb53744214446388db853a9b71a606f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=hOEEfDyqULzBBeSPZlw1YqU1JBs%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>再之后是各种接口设置，偷懒可以都跳过</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1106722b50e947cfb0aee1d56a84149c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=e6fa0aJMCffrCdHi6SMZTXiWTiQ%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>接下来是hooks设置，可以按需选择，三个选项对应的分别是：</p>
<ul>
<li><code>boot-md</code></li>
</ul>
<p>每次程序启动时，自动读取并执行一个叫 <code>BOOT.md</code> 的文件。</p>
<p><strong>用途</strong>：如果你有一些每次都要 AI 记住的规则、或者每次都要运行的初始化环境命令，可以写在 <code>BOOT.md</code> 里。</p>
<ul>
<li><code>command-logger</code></li>
</ul>
<p>命令日志记录器。</p>
<p><strong>用途</strong>：它会把你输入的所有指令和 AI 的反馈记录下来。建议勾选，万一 AI 乱改了代码，你可以翻日志找回记录。</p>
<ul>
<li><code>session-memory</code></li>
</ul>
<p>会话记忆。</p>
<p><strong>用途</strong>：让 AI 记住你上一次聊了什么。如果不选，它可能每次运行都是“断片”状态，不记得之前的上下文。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d22da4e1a5346cdaa29ecc054e39ae1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=mQAwhuNNaZ93%2BaJWdHWE6zLHycg%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>最后选择在哪里运行</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0db2b0c225fe4978a050e05c6d5558ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=Hl%2BG02uL89BkGBH47oXSdVuXJ6g%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<ul>
<li><strong>Hatch in TUI (recommended)</strong></li>
</ul>
<p><strong>什么是 TUI？</strong> 它的全称是 Terminal User Interface。</p>
<p><strong>效果</strong>：就在你现在的这个黑色窗口里直接跳出一个比较漂亮的对话框。</p>
<p><strong>优点</strong>：速度最快，不用切换窗口，很有极客感觉。</p>
<ul>
<li><strong>Open the Web UI</strong></li>
</ul>
<p><strong>效果</strong>：它会启动一个本地服务器，并在你的浏览器（如 Chrome 或 Safari）里打开一个网页版界面。</p>
<p><strong>优点</strong>：界面更像 ChatGPT，推荐选这个。</p>
<ul>
<li><strong>Do this later</strong></li>
</ul>
<p><strong>效果</strong>：结束配置，回到命令行。</p>
<p><strong>用途</strong>：如果你现在只想装好，还没打算立刻开始聊天，选这个。</p>
<p>选择 Open the Web UI 后，会自动跳转网页如下</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95735f066b694408986d429b7e4e76a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16IeCTHliaWM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346320&amp;x-signature=9f0BCK9b1KaL0VZqEHirNrEMQCc%3D" alt="图片" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>现在恭喜你真正完成配置并可以开始使用了！</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给大模型“开小灶”：一文读懂微调原理与实战，让你的AI更懂你]]></title>    <link>https://juejin.cn/post/7600755567485796404</link>    <guid>https://juejin.cn/post/7600755567485796404</guid>    <pubDate>2026-01-30T05:40:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600755567485796404" data-draft-id="7600728866756919348" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给大模型“开小灶”：一文读懂微调原理与实战，让你的AI更懂你"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-30T05:40:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狸猫算君"/> <meta itemprop="url" content="https://juejin.cn/user/643654644149178"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给大模型“开小灶”：一文读懂微调原理与实战，让你的AI更懂你
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/643654644149178/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狸猫算君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T05:40:10.000Z" title="Fri Jan 30 2026 05:40:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>引言：为什么我们需要给大模型“开小灶”？</strong></h3>
<p>想象一下，你请来了一位学识渊博的“通才”教授，他上知天文下知地理。但当你需要他帮你撰写专业的市场分析报告时，他给出的答案可能虽然正确，却不够聚焦、缺乏行业术语。这时候，最好的办法不是换一位教授，而是给他一份你行业的资料和几份优秀的报告范文，让他快速“补补课”。</p>
<p>大模型微调（Fine-Tuning）就是这个“补课”的过程。我们不再需要耗费巨资从零训练一个AI，而是以一个强大的预训练模型（如ChatGPT背后的GPT系列、国内的Qwen、DeepSeek等）为起点，用我们自己的、特定领域的数据对它进行“再教育”，让它从一个“通才”转变为精通我们业务的“专家”。</p>
<p>无论是让AI学习你公司的产品知识库来当智能客服，还是让它理解法律合同条款，亦或是模仿你的写作风格来生成文案，微调都是实现AI“个性化”和“专业化”的关键一步。今天，我们就来彻底搞懂大模型微调，并一步步带你上手实践。</p>
<p><img src="https://p3-volc-community-sign.byteimg.com/tos-cn-i-tlddhu82om/77716b24f5204be784858bc16a470b64~tplv-tlddhu82om-image.image?=&amp;rk3s=8031ce6d&amp;x-expires=1769837709&amp;x-signature=5PfaUC%2BGp9LxAXO1%2FtkWToqlac0%3D" alt="13414224733899671.jpeg" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1"><strong>一、技术原理：拆解微调的“十八般武艺”</strong></h3>
<p>微调方法众多，但核心思想无非两种：<strong>大动干戈</strong> 或 <strong>精雕细琢</strong>。理解它们的区别，是做出正确选择的第一步。</p>
<h4 data-id="heading-2"><strong>1. “大动干戈”派：全量微调</strong></h4>
<ul>
<li>
<p><strong>核心思想</strong>：动用“题海战术”。将预训练模型的所有参数（可以理解为它的“知识神经元”）用你的新数据重新训练一遍。</p>
</li>
<li>
<p><strong>通俗比喻</strong>：让那位通才教授把你给的行业资料当作全新教材，从头到尾、逐字逐句地重新学习一遍。他的整个知识体系都会因此重塑。</p>
</li>
<li>
<p><strong>优点</strong>：效果通常最好，模型能最深度地适应新任务。</p>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>成本极高</strong>：需要大量的计算资源（多张高端GPU）和漫长的时间。</li>
<li><strong>灾难性遗忘</strong>：教授可能过于钻研你的行业，把原来学的通用知识（比如基础逻辑、常识）给忘了，导致在其他任务上表现下降。</li>
<li><strong>适用场景</strong>：数据量极大、任务极其重要且资源充沛的“土豪”场景。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3"><strong>2. “精雕细琢”派：参数高效微调</strong></h4>
<p>这是目前的主流和推荐方案，核心是  <strong>“不动主干，只调边角”</strong> 。我们冻结预训练模型绝大部分参数，只训练额外新增的一小部分参数，从而高效地引导模型。</p>
<ul>
<li>
<p><strong>LoRA：给模型装上“功能插件”</strong></p>
<ul>
<li><strong>原理</strong>：在模型原有的某些关键层（如注意力模块）旁，并行添加两个小小的、低维度的矩阵。训练时，只更新这两个小矩阵。训练完成后，可以把这两个小矩阵像“插件”一样，合并回原模型，也可以单独保存和加载。</li>
<li><strong>比喻</strong>：不给教授换大脑，而是给他一副特制的“行业眼镜”。戴上这副眼镜，他看任何问题都能自动带上行业视角。这副眼镜轻便、易切换（针对不同任务可以换不同眼镜）。</li>
<li><strong>优势</strong>：显存占用极低、训练速度快、几乎不会遗忘原知识、产出的模型权重文件很小（通常只有几十到几百MB），非常适合个人开发者和小团队。</li>
</ul>
</li>
<li>
<p><strong>Prefix Tuning / Prompt Tuning：学习“魔法提示词”</strong></p>
<ul>
<li><strong>原理</strong>：在输入给模型的文本前，自动加上一段经过学习的、模型可见的“软提示”（一串数字向量）。这段提示本身没有实际语言含义，但能像“咒语”一样，悄悄引导模型走向我们想要的任务输出。</li>
<li><strong>比喻</strong>：每次向教授提问前，都先由助手念一段特定的“引导语”（例如：“请您以资深投资分析师的身份思考……”）。教授听到这段引导语后，就会自动切换到相应的专家模式来回答问题。我们需要训练的，就是这段最有效的“引导语”。</li>
<li><strong>优势</strong>：更加轻量，甚至可以不修改模型本身任何参数。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4"><strong>3. “对齐”派：基于反馈的微调</strong></h4>
<p>这通常是微调链条的后一步，目的是让模型输出的内容不仅正确，而且  <strong>“符合人类偏好”</strong> 。</p>
<ul>
<li><strong>监督微调</strong>：用高质量的“问题-理想答案”配对数据来训练，教模型学会回答的格式和风格。</li>
<li><strong>RLHF</strong>：引入“人类评委”。让模型生成多个答案，人工评判哪个更好，利用这些反馈信号来调整模型，让它越来越会产出让人满意的回答。ChatGPT的“善解人意”正源于此。</li>
<li><strong>RLAIF</strong>：原理同RLHF，但“评委”换成了另一个AI，以降低成本和提升效率。</li>
</ul>
<hr/>
<h3 data-id="heading-5"><strong>二、实践步骤：三步走，完成你的第一次微调</strong></h3>
<p>我们将以最流行的 <strong>LoRA微调</strong> 方式，以帮你“微调一个客服问答模型”为例，拆解操作流程。</p>
<h4 data-id="heading-6"><strong>第一步：准备数据——给AI的“专属教材”</strong></h4>
<p>数据质量决定模型上限。你需要准备一个结构化的数据集，通常是一个<code>JSON</code>或<code>CSV</code>文件。</p>
<ul>
<li>
<p><strong>格式</strong>：对于问答任务，最常见的格式是包含 <code>“instruction”（指令）</code>、<code>“input”（输入）</code>、<code>“output”（输出）</code> 的对话对。</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"instruction"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"根据以下产品描述，回答用户问题。"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"产品：智能音箱X1，支持语音控制家居，内置电池续航12小时。用户问：这个音箱能带去户外用吗？"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"可以的。智能音箱X1内置电池，续航时间长达12小时，非常适合在户外聚会、露营等没有固定电源的场景下使用。"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"instruction"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"作为客服，礼貌地处理用户投诉。"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户说：我收到的音箱表面有划痕，很不满意！"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"非常抱歉给您带来了不好的体验！对于商品在运输过程中产生的损伤，我们深表歉意。请您提供一下订单号和划痕照片，我们会立即为您处理换货或补偿事宜。"</span>
  <span class="hljs-punctuation">}</span>
  <span class="hljs-comment">// ... 更多数据</span>
<span class="hljs-punctuation">]</span>
</code></pre>
</li>
<li>
<p><strong>数据量</strong>：起步阶段，精心整理的 <strong>几百到几千条</strong> 高质量数据，就能通过LoRA产生显著效果。</p>
</li>
<li>
<p><strong>数据清洗</strong>：检查错别字、错误标点，确保“输出”部分是你想要的、优质的答案范本。</p>
</li>
</ul>
<h4 data-id="heading-7"><strong>第二步：配置与训练——设置“学习计划”</strong></h4>
<p>这是核心环节，你需要关注几个关键参数（以使用 <code>transformers</code> + <code>peft</code> 库为例）：</p>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini">from peft import LoraConfig, TaskType

<span class="hljs-comment"># 1. 配置LoRA“插件”</span>
<span class="hljs-attr">peft_config</span> = LoraConfig(
    <span class="hljs-attr">task_type</span>=TaskType.CAUSAL_LM,  <span class="hljs-comment"># 因果语言模型任务（如文本生成）</span>
    <span class="hljs-attr">inference_mode</span>=<span class="hljs-literal">False</span>,
    <span class="hljs-attr">r</span>=<span class="hljs-number">8</span>,  <span class="hljs-comment"># 【关键】LoRA的秩，理解为“插件的复杂度”。常用8或16，越大能力越强但可能过拟合。</span>
    <span class="hljs-attr">lora_alpha</span>=<span class="hljs-number">32</span>,  <span class="hljs-comment"># 缩放参数，通常设为r的2-4倍。</span>
    <span class="hljs-attr">lora_dropout</span>=<span class="hljs-number">0.1</span>,  <span class="hljs-comment"># 防止过拟合的丢弃率。</span>
    <span class="hljs-attr">target_modules</span>=[<span class="hljs-string">"q_proj"</span>, <span class="hljs-string">"v_proj"</span>]  <span class="hljs-comment"># 【关键】将“插件”安装到模型的哪些层？通常是注意力层的查询和值映射。</span>
)

<span class="hljs-comment"># 2. 配置训练参数</span>
from transformers import TrainingArguments

<span class="hljs-attr">training_args</span> = TrainingArguments(
    <span class="hljs-attr">output_dir</span>=<span class="hljs-string">"./output"</span>,  <span class="hljs-comment"># 输出目录</span>
    <span class="hljs-attr">per_device_train_batch_size</span>=<span class="hljs-number">4</span>,  <span class="hljs-comment"># 每张GPU的批大小。根据显存调整，RTX 4090上7B模型可设为4。</span>
    <span class="hljs-attr">gradient_accumulation_steps</span>=<span class="hljs-number">4</span>,  <span class="hljs-comment"># 梯度累积步数。模拟更大的批大小，节省显存。</span>
    <span class="hljs-attr">num_train_epochs</span>=<span class="hljs-number">3</span>,  <span class="hljs-comment"># 训练轮数。数据少时（&lt;1万）可设3-5轮。</span>
    <span class="hljs-attr">learning_rate</span>=<span class="hljs-number">2</span>e-<span class="hljs-number">4</span>,  <span class="hljs-comment"># 【关键】学习率。LoRA训练时可以用较高学习率（1e-4到5e-4）。</span>
    <span class="hljs-attr">fp16</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 使用混合精度训练，节省显存并加速。</span>
    <span class="hljs-attr">logging_steps</span>=<span class="hljs-number">10</span>,  <span class="hljs-comment"># 每10步打印一次日志。</span>
    <span class="hljs-attr">save_steps</span>=<span class="hljs-number">200</span>,  <span class="hljs-comment"># 每200步保存一次检查点。</span>
    <span class="hljs-attr">remove_unused_columns</span>=<span class="hljs-literal">False</span>  <span class="hljs-comment"># 重要：保持数据列不被自动删除。</span>
)
</code></pre>
<p><img src="https://p6-volc-community-sign.byteimg.com/tos-cn-i-tlddhu82om/cd03700e1fed4cb4b5284ea7916e8ad3~tplv-tlddhu82om-image.image?=&amp;rk3s=8031ce6d&amp;x-expires=1769837734&amp;x-signature=17%2F9CKIOj1K%2FqwsT7sbcx4Kqc58%3D" alt="13414224848999968.jpeg" loading="lazy"/>
<strong>参数调优心法</strong>：</p>
<ul>
<li><strong>学习率</strong>：LoRA训练时可大胆用稍大的值（如<code>3e-4</code>），因为调整的参数少，不怕“翻车”。</li>
<li><strong>批大小</strong>：在显卡能承受的范围内尽可能大，能稳定训练。不够大就用<code>gradient_accumulation_steps</code>来凑。</li>
<li><strong>秩（r）</strong> ：从8开始尝试。如果任务很复杂或与模型原始知识差异大（如从通用中文到医疗文献），可以尝试16或32。</li>
</ul>
<h4 data-id="heading-8"><strong>第三步：测试与部署——验收“学习成果”</strong></h4>
<p>训练完成后，你会得到<code>adapter_model.bin</code>（LoRA权重）和<code>adapter_config.json</code>（配置文件）。</p>
<ul>
<li>
<p><strong>加载与推理</strong>：</p>
<p>python</p>
<pre><code class="hljs language-ini" lang="ini">from peft import PeftModel
<span class="hljs-comment"># 加载基座模型</span>
<span class="hljs-attr">base_model</span> = AutoModelForCausalLM.from_pretrained(<span class="hljs-string">"Qwen/Qwen2-7B-Instruct"</span>)
<span class="hljs-comment"># 加载训练好的LoRA“插件”</span>
<span class="hljs-attr">model</span> = PeftModel.from_pretrained(base_model, <span class="hljs-string">"./output/final_checkpoint"</span>)
<span class="hljs-comment"># 合并权重（可选，合并后就是单个模型文件，便于部署）</span>
<span class="hljs-attr">merged_model</span> = model.merge_and_unload()
<span class="hljs-comment"># 进行推理测试</span>
<span class="hljs-comment"># ...</span>
</code></pre>
</li>
<li>
<p><strong>简单测试</strong>：用一些训练集里没见过的问题，看看模型的回答是否符合预期。</p>
</li>
</ul>
<p>上述代码和步骤对于开发者是家常便饭，但对于想快速聚焦业务、无暇深究技术的朋友来说，依然门槛不低。如果你希望跳过所有环境配置和代码编写，专注于数据准备和效果迭代，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.llamafactory.com.cn%2Fregister%3Futm_source%3Djslt_xtjj_wsy" target="_blank" title="https://www.llamafactory.com.cn/register?utm_source=jslt_xtjj_wsy" ref="nofollow noopener noreferrer"><strong>LLaMA-Factory Online</strong></a> 这类平台是你的理想选择。它提供了可视化的数据上传、模型选择（支持数十种开源模型）、参数配置（图形化调节学习率、秩等）和一站式训练监控界面。你甚至不需要懂什么是“秩”或“target_modules”，平台会提供智能推荐，让你在几分钟内启动微调，亲眼见证你的数据如何让大模型“更像你想要的样子”。</p>
<hr/>
<h3 data-id="heading-9"><strong>三、效果评估：如何判断微调是否成功？</strong></h3>
<p>训练损失下降不代表模型真的变“聪明”了。你需要系统性地评估：</p>
<ol>
<li>
<p><strong>定性评估（最重要）</strong> ：</p>
<ul>
<li><strong>人工审查</strong>：随机抽取一批测试问题，人工判断模型生成答案的<strong>准确性、相关性和流畅性</strong>。这是黄金标准。</li>
<li><strong>对比测试</strong>：同一个问题，分别让微调前的原模型和微调后的模型回答，直观对比提升效果。</li>
</ul>
</li>
<li>
<p><strong>定量评估</strong>：</p>
<ul>
<li>
<p><strong>任务指标</strong>：根据你的任务类型选择。</p>
<ul>
<li><strong>分类任务</strong>：准确率、F1分数。</li>
<li><strong>问答/摘要任务</strong>：ROUGE-L（衡量生成文本与标准答案的重叠度）、BLEU分数。</li>
<li><strong>生成任务</strong>：可以使用 <strong>困惑度</strong>，但它不完全代表生成质量。</li>
</ul>
</li>
<li>
<p><strong>保留评估集</strong>：在准备数据时，就预留出10%-20%的数据<strong>绝不用于训练</strong>，专门用于计算这些指标。</p>
</li>
</ul>
</li>
<li>
<p><strong>综合评估</strong>：</p>
<ul>
<li><strong>通用能力保留测试</strong>：问几个与微调任务无关的通用问题（比如“中国的首都是哪里？”），检查模型是否出现了严重的“灾难性遗忘”。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-10"><strong>四、总结与展望</strong></h3>
<p>大模型微调，已经从学术界的高岭之花，变成了产业界触手可及的生产力工具。其核心脉络清晰：<strong>以强大的预训练模型为基座，用参数高效微调（尤其是LoRA）作为杠杆，以高质量领域数据为支点，撬动专属AI能力的落地。</strong></p>
<p><strong>未来展望</strong>：</p>
<ul>
<li><strong>更轻量化</strong>：会出现参数量更少、效果更好的微调技术。</li>
<li><strong>更自动化</strong>：自动选择最优微调方法和超参数的“Auto-FineTuning”将成趋势。</li>
<li><strong>更一体化</strong>：数据准备、微调、评估、部署的全流程平台（正如前文提到的在线平台）会越来越成熟，进一步降低技术门槛。</li>
</ul>
<p><strong>给你的建议</strong>：<br/>
不要等待技术完美。现在就开始，从一个小而具体的任务开始（比如整理100条经典的客服问答），选择一个易用的工具或平台，完成你的第一次微调实验。亲手打造一个能理解你、帮助你的AI，这个过程所带来的认知提升和成就感，远超旁观。</p>
<p>迈出第一步，你就能真正驾驭大模型，让它从遥不可及的黑科技，变成你手中解决实际问题的得力助手。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PVE 虚拟机无法上网问题排查：路由器 IP-MAC 绑定导致的静默丢弃]]></title>    <link>https://juejin.cn/post/7600670417858215970</link>    <guid>https://juejin.cn/post/7600670417858215970</guid>    <pubDate>2026-01-30T02:48:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670417858215970" data-draft-id="7600670487409279028" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PVE 虚拟机无法上网问题排查：路由器 IP-MAC 绑定导致的静默丢弃"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T02:48:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户92178812460"/> <meta itemprop="url" content="https://juejin.cn/user/608475561596793"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PVE 虚拟机无法上网问题排查：路由器 IP-MAC 绑定导致的静默丢弃
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/608475561596793/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户92178812460
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:48:55.000Z" title="Fri Jan 30 2026 02:48:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：在 Proxmox VE (PVE) 环境中重建虚拟机后，Ubuntu 虚拟机无法访问外网，但同网段其他设备（PVE 主机、iStoreOS）通信正常。经抓包分析确认，问题根源为<strong>家用路由器对特定 IP 启用了 IP-MAC 绑定策略</strong>，新虚拟机的 MAC 地址与历史记录不符，导致路由器静默丢弃 ARP/ICMP 请求。本文记录完整排查过程、根本原因分析及解决方案。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、问题背景</h2>
<h3 data-id="heading-1">1.1 网络拓扑</h3>
<pre><code class="hljs language-scss" lang="scss">物理路由器 (<span class="hljs-number">192.168</span>.<span class="hljs-number">3.1</span>)
    │
    └── PVE 主机 (<span class="hljs-number">192.168</span>.<span class="hljs-number">3.21</span>)
         ├── iStoreOS 虚拟机 (<span class="hljs-number">192.168</span>.<span class="hljs-number">3.62</span>) ✅ 可上网
         └── Ubuntu 虚拟机 (<span class="hljs-number">192.168</span>.<span class="hljs-number">3.101</span>) ❌ 无法上网
</code></pre>
<h3 data-id="heading-2">1.2 问题现象</h3>
<ul>
<li>✅ PVE 主机 (<code>192.168.3.21</code>) 可正常访问路由器及外网</li>
<li>✅ iStoreOS (<code>192.168.3.62</code>) 可正常访问路由器及外网</li>
<li>❌ Ubuntu (<code>192.168.3.101</code>) 无法 ping 通路由器 (<code>192.168.3.1</code>)</li>
<li>❌ Ubuntu 无法访问任何外网地址</li>
<li>⚠️ 但 Ubuntu 可与 PVE 主机、iStoreOS 正常互访（同网段通信正常）</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、诊断过程</h2>
<h3 data-id="heading-4">2.1 初步检查：网关配置</h3>
<p>Ubuntu Netplan 配置（初始错误配置）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># /etc/netplan/50-cloud-init.yaml</span>
<span class="hljs-attr">network:</span>
  <span class="hljs-attr">version:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">ethernets:</span>
    <span class="hljs-attr">ens18:</span>
      <span class="hljs-attr">addresses:</span> [<span class="hljs-number">192.168</span><span class="hljs-number">.3</span><span class="hljs-number">.101</span><span class="hljs-string">/24</span>]
      <span class="hljs-attr">routes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span> <span class="hljs-string">default</span>
          <span class="hljs-attr">via:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.3</span><span class="hljs-number">.62</span>  <span class="hljs-comment"># ❌ 错误：指向 iStoreOS 而非路由器</span>
</code></pre>
<p><strong>修正后</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">routes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span> <span class="hljs-string">default</span>
    <span class="hljs-attr">via:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.3</span><span class="hljs-number">.1</span>  <span class="hljs-comment"># ✅ 直连路由器</span>
</code></pre>
<blockquote>
<p>修正后问题依旧，排除网关配置错误。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">2.2 关键证据：抓包分析</h3>
<h4 data-id="heading-6">Ubuntu 侧抓包</h4>
<pre><code class="hljs language-bash" lang="bash">sudo tcpdump -i ens18 -n arp or icmp
</code></pre>
<p><strong>输出片段</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">14:51:38.403299 ARP, Request who-has 192.168.3.1 tell 192.168.3.110</span>
<span class="hljs-section">14:51:39.427408 IP 192.168.3.110 &gt; 192.168.3.1: ICMP echo request</span>
<span class="hljs-section">14:51:40.451409 IP 192.168.3.110 &gt; 192.168.3.1: ICMP echo request</span>
...
<span class="hljs-comment"># ❌ 无任何 ARP Reply 或 ICMP Reply！</span>
</code></pre>
<h4 data-id="heading-7">PVE 主机侧抓包（验证桥接层）</h4>
<pre><code class="hljs language-bash" lang="bash">tcpdump -i vmbr0 -n ether host bc:24:11:56:f9:9a and host 192.168.3.1
</code></pre>
<p><strong>输出</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">22:51:15.146245 ARP, Request who-has 192.168.3.1 tell 192.168.3.110</span>
<span class="hljs-section">22:51:15.850340 IP 192.168.3.110 &gt; 192.168.3.1: ICMP echo request</span>
...
<span class="hljs-comment"># ✅ 请求包已到达物理网络层，但无回复</span>
</code></pre>
<blockquote>
<p>🔍 <strong>关键结论</strong>：</p>
<ul>
<li>Ubuntu 发出的 ARP/ICMP 请求<strong>已通过 PVE 桥接到达物理网络</strong></li>
<li><strong>路由器从未回复</strong> → 请求被路由器主动丢弃（非链路故障）</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-8">2.3 排除其他可能性</h3>






























<table><thead><tr><th>可能原因</th><th>排查方式</th><th>结果</th></tr></thead><tbody><tr><td>PVE 桥接配置错误</td><td>检查 <code>/etc/network/interfaces</code></td><td>✅ <code>bridge_ports enp3s0</code> 正确绑定物理网卡</td></tr><tr><td>虚拟交换机隔离</td><td>检查 PVE Web 界面 Network → Firewall</td><td>✅ 未启用端口隔离</td></tr><tr><td>Ubuntu 防火墙</td><td><code>sudo ufw status</code></td><td>✅ 默认未启用</td></tr><tr><td><strong>路由器安全策略</strong></td><td>更换 IP 测试</td><td>⚠️ 待验证（见下文）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">三、根本原因：路由器 IP-MAC 绑定</h2>
<h3 data-id="heading-10">3.1 问题重现链条</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[旧虚拟机&lt;br&gt;VM ID 100] --&gt;|IP=192.168.3.101&lt;br&gt;MAC=bc:24:11:56:f9:9a| B(路由器学习绑定)
    B --&gt; C[删除虚拟机]
    C --&gt; D[重建虚拟机&lt;br&gt;VM ID 100]
    D --&gt;|IP=192.168.3.101&lt;br&gt;MAC=02:00:00:00:00:01| E{路由器行为}
    E --&gt;|检测到&lt;br&gt;同一IP+新MAC| F[触发ARP防护]
    F --&gt; G[静默丢弃ARP/ICMP]
</code></pre>
<h3 data-id="heading-11">3.2 核心机制</h3>
<ul>
<li>家用路由器（TP-Link/华为/小米等）默认启用 <strong>“防 ARP 欺骗”</strong> 功能</li>
<li>路由器维护 <code>IP → MAC</code> 绑定表，对已学习的 IP 严格校验 MAC</li>
<li>当检测到 <strong>同一 IP 对应不同 MAC</strong> 时：
<ul>
<li>❌ <strong>不回复 ARP Request</strong>（静默丢弃）</li>
<li>❌ <strong>不转发 ICMP/数据包</strong></li>
<li>⚠️ 无日志、无告警 → 排查困难</li>
</ul>
</li>
</ul>
<blockquote>
<p>💡 <strong>关键误区澄清</strong>：</p>
<ul>
<li>问题<strong>与 VM ID 无关</strong>（100/200/999 均无影响）</li>
<li>问题<strong>不在 PVE</strong>（删除虚拟机后无网络残留）</li>
<li>问题<strong>在路由器端</strong>（保留了 <code>192.168.3.101 → 旧MAC</code> 的历史记录）</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-12">四、解决方案</h2>
<h3 data-id="heading-13">4.1 最优解：更换为干净 IP（5 分钟解决）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 修改 Netplan 配置</span>
sudo nano /etc/netplan/50-cloud-init.yaml
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">network:</span>
  <span class="hljs-attr">version:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">renderer:</span> <span class="hljs-string">networkd</span>
  <span class="hljs-attr">ethernets:</span>
    <span class="hljs-attr">ens18:</span>
      <span class="hljs-attr">dhcp4:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">addresses:</span> [<span class="hljs-number">192.168</span><span class="hljs-number">.3</span><span class="hljs-number">.200</span><span class="hljs-string">/24</span>]  <span class="hljs-comment"># ✅ 关键：使用未绑定的 IP</span>
      <span class="hljs-attr">routes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span> <span class="hljs-string">default</span>
          <span class="hljs-attr">via:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.3</span><span class="hljs-number">.1</span>
      <span class="hljs-attr">nameservers:</span>
        <span class="hljs-attr">addresses:</span> [<span class="hljs-number">223.5</span><span class="hljs-number">.5</span><span class="hljs-number">.5</span>, <span class="hljs-number">114.114</span><span class="hljs-number">.114</span><span class="hljs-number">.114</span>]
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 2. 应用配置</span>
sudo netplan apply

<span class="hljs-comment"># 3. 验证</span>
ping -c 4 192.168.3.1    <span class="hljs-comment"># ✅ 通</span>
ping -c 4 baidu.com      <span class="hljs-comment"># ✅ 通</span>
</code></pre>
<blockquote>
<p>✅ <strong>效果</strong>：立即恢复网络，无需修改路由器配置。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">4.2 根治方案（可选）：清理路由器绑定</h3>
<p>如需继续使用 <code>192.168.3.101</code>，需登录路由器：</p>
<ol>
<li>访问 <code>http://192.168.3.1</code></li>
<li>进入 <strong>安全设置 → ARP 绑定 / 防 ARP 欺骗</strong></li>
<li>删除 <code>192.168.3.101</code> 的旧绑定记录</li>
<li>（可选）关闭“防 ARP 欺骗”功能（家用环境通常无需开启）</li>
<li>重启路由器使策略生效</li>
</ol>
<blockquote>
<p>⚠️ <strong>注意</strong>：部分路由器需重启才能清除绑定缓存。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">五、问题复盘</h2>
<h3 data-id="heading-16">5.1 与 IP 冲突的区别</h3>






























<table><thead><tr><th>特征</th><th>本案例（IP-MAC 绑定）</th><th>IP 冲突</th></tr></thead><tbody><tr><td><strong>ARP Reply</strong></td><td>❌ 完全无回复</td><td>✅ 有回复，但 MAC 抖动</td></tr><tr><td><strong>Ping 表现</strong></td><td>❌ 100% 失败</td><td>⚠️ 间歇性通/断</td></tr><tr><td><strong>抓包特征</strong></td><td>只有 Request</td><td>Request + Reply（MAC 变化）</td></tr><tr><td><strong>根本原因</strong></td><td>路由器安全策略拦截</td><td>两设备同时响应 ARP</td></tr></tbody></table>
<blockquote>
<p>✅ 本案例<strong>不是 IP 冲突</strong>，而是路由器主动丢弃。</p>
</blockquote>
<hr/>
<h3 data-id="heading-17">5.2 为什么修改 MAC 无效？</h3>

























<table><thead><tr><th>操作</th><th>路由器视角</th><th>结果</th></tr></thead><tbody><tr><td>初始状态</td><td><code>192.168.3.101 → bc:24:11:56:f9:9a</code></td><td>✅ 允许</td></tr><tr><td>仅改 MAC</td><td><code>192.168.3.101 → 02:00:00:00:00:01</code></td><td>❌ 视为 ARP 欺骗</td></tr><tr><td><strong>改 IP + MAC</strong></td><td><code>192.168.3.200 → 02:00:00:00:00:01</code></td><td>✅ 无历史记录，正常学习</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>关键</strong>：必须<strong>同时更换 IP</strong> 才能绕过绑定策略。</p>
</blockquote>
<hr/>
<h2 data-id="heading-18">六、预防建议</h2>
<h3 data-id="heading-19">6.1 地址规划（推荐）</h3>

























<table><thead><tr><th>地址段</th><th>用途</th><th>配置方式</th></tr></thead><tbody><tr><td><code>192.168.3.2 ~ 192.168.3.99</code></td><td>静态 IP（服务器/虚拟机）</td><td>手动配置</td></tr><tr><td><code>192.168.3.100 ~ 192.168.3.200</code></td><td>DHCP 动态分配</td><td>路由器 DHCP 池</td></tr><tr><td><code>192.168.3.201 ~ 192.168.3.254</code></td><td>临时测试</td><td>避免与生产环境冲突</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>原则</strong>：静态 IP 与 DHCP 池<strong>严格分离</strong>，避免重叠。</p>
</blockquote>
<hr/>
<h3 data-id="heading-20">6.2 虚拟机生命周期管理</h3>





















<table><thead><tr><th>操作</th><th>建议</th></tr></thead><tbody><tr><td><strong>重建虚拟机</strong></td><td>✅ 优先使用新 IP（如 <code>.200+</code>）<br/>✅ 或先在路由器删除旧绑定</td></tr><tr><td><strong>克隆虚拟机</strong></td><td>✅ 克隆后<strong>必须修改 IP + MAC</strong></td></tr><tr><td><strong>长期使用固定 IP</strong></td><td>✅ 在路由器设置 <strong>DHCP 静态分配</strong>（MAC → IP 绑定）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-21">七、附录：命令速查</h2>
<h3 data-id="heading-22">7.1 网络诊断命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看路由表</span>
ip r

<span class="hljs-comment"># 查看 ARP 表（观察是否抖动）</span>
watch -n 1 <span class="hljs-string">'ip neigh show 192.168.3.1'</span>

<span class="hljs-comment"># 抓包（ARP + ICMP）</span>
sudo tcpdump -i ens18 -n arp or icmp

<span class="hljs-comment"># 扫描 IP 冲突</span>
sudo apt install arp-scan
sudo arp-scan --localnet | grep 192.168.3.101
</code></pre>
<h3 data-id="heading-23">7.2 PVE 网络配置检查</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 Bridge 配置</span>
<span class="hljs-built_in">cat</span> /etc/network/interfaces

<span class="hljs-comment"># 验证物理网卡绑定</span>
ip <span class="hljs-built_in">link</span> show vmbr0
<span class="hljs-comment"># 输出应包含：bridge_ports enp3s0（非 none）</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">八、总结</h2>





























<table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td><strong>问题现象</strong></td><td>Ubuntu 虚拟机无法访问路由器/外网，但同网段互访正常</td></tr><tr><td><strong>根本原因</strong></td><td>路由器对 <code>192.168.3.101</code> 启用 IP-MAC 绑定，新 MAC 被视为非法</td></tr><tr><td><strong>关键证据</strong></td><td>抓包显示：有 Request 无 Reply → 路由器静默丢弃</td></tr><tr><td><strong>最优解</strong></td><td>更换为干净 IP（如 <code>192.168.3.200</code>）</td></tr><tr><td><strong>经验教训</strong></td><td>虚拟机重建后，<strong>避免复用旧 IP</strong>；或提前清理路由器绑定</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>一句话总结</strong>：<br/>
<strong>“虚拟机重建后无法上网？先换一个干净 IP，90% 问题迎刃而解。”</strong></p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java面试中高频八股文大全）——就业版]]></title>    <link>https://juejin.cn/post/7600990891205623835</link>    <guid>https://juejin.cn/post/7600990891205623835</guid>    <pubDate>2026-01-30T05:41:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600990891205623835" data-draft-id="7600692485946638345" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java面试中高频八股文大全）——就业版"/> <meta itemprop="keywords" content="后端,Spark"/> <meta itemprop="datePublished" content="2026-01-30T05:41:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java面试中高频八股文大全）——就业版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T05:41:45.000Z" title="Fri Jan 30 2026 05:41:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>1.什么是索引？什么情况下用索引？什么时候不用？</strong></p>
<p>1）就是一种数据结构，目的就是为了快速查找数据。<br/>
2）对查询频率高（索引就是为了提高查询效率），像where后的字段<br/>
数据量特别大， 索引不是越多越好，会影响增删的效率，典型的用空间换时间。<br/>
分组字段可以建立索引，因为分组的前提是排序（覆盖索引）<br/>
3）频繁更新的字段、查询少的、参与计算的不适合建索引。</p>
<p><strong>2.索引失效？</strong></p>
<blockquote>
<p>在MySQL中，查询不走索引可能有以下几种情况：</p>
<ol>
<li>数据量太小：如果表中的数据量比较小，MySQL会选择进行全表扫描而不使用索引，因为全表扫描的开销可能比使用索引更小。</li>
<li>对索引列进行了函数操作：如果在查询语句中对索引列进行了函数操作或表达式运算，MySQL无法使用索引进行优化，因此可能不走索引。</li>
<li>范围查询：如果查询语句中包含范围查询（例如大于、小于、区间查询等），MySQL可能无法使用索引进行优化，导致不走索引（模糊查询like,%前置不会走，后置会走）。</li>
<li>数据分布不均匀：如果索引列的数据分布不均匀，索引的选择性较低，MySQL可能选择进行全表扫描而不使用索引。</li>
</ol>
<p>在进行MySQL索引优化时，需要考虑以上情况，并通过分析查询语句、优化索引设计、适时更新统计信息等方法，提高MySQL查询性能，尽可能减少不走索引的情况。</p>
</blockquote>
<p><strong>3. 查看索引使用和查看索引信息？</strong><br/>
索引使用： explain 结果 （只要数字大于1）1 row in set 即生效了<br/>
查看索引信息： show indexs from 表名</p>
<p><strong>4. 复合索引？最左匹配原则？</strong><br/>
最核心的是<strong>等值比较</strong><br/>
复合索引就是多个字段放一块（企业最常用的是符合索引！！！唯一索引，普通索引我们也用）<br/>
mysql会一直向右查询，直到遇到<strong>范围查询</strong>（&gt; &lt; like），比如用 a b c d四个字段创建了一个复合索引， a=3 b=5 c&gt;7 d=9 只会用到前三个，因为b c d 是根据a 的后面进行规则的排序，即a是有序的，后面的bcd是无序的。 （hash索引用的不多，因为无序，但是定位快，了解即可）</p>
<p><strong>5. Btree和B+tree？为什么mysql用的是B+ tree？</strong>  **<br/>
B+tree是Btree的升级版。<br/>
Btree：多路平衡树，当增删数据时，会自动的将数据进行这个平衡（旋转）<br/>
为什么从Btree转到B+tree 因为：索引也是一个文件，存档在磁盘，在使用时读入到内存。内存是有限的，如果索引文件过大，无法一次性全部加载，需要分批加载。在有限磁盘的限制下，B+tree可以减少磁盘的I/O。</p>
<blockquote>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                        即可免费获取**</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/681cd557c47049b29a545a9979d9a86d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770357252&amp;x-signature=bzWQJXPC8hyMlYbY1Uzyn49hIws%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<p><em><strong>对于B+tree，所有的数据都存在叶子节点，根和非叶子节点只是存储的指针，指向下一个数据的地址，由叶子节点再去查找到关联的数据信息。对于查询的数据，都要从root节点走到叶子节点，所以查询相比于Btree更加稳定。</strong></em></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48f68c5be67440fcb39c2fa97d24226b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770357252&amp;x-signature=dVCPevVIoEaktp2RQczFSm7RD1Q%3D" alt="在这里插入图片描述" loading="lazy"/><br/>
对于mysql，是在B+tree的基础上，在相邻节点间增加了一个链表指针，形成了带有顺序的B+tree,提高了区间的访问性能。<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9836483b333a4b71999645aca777c671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770357252&amp;x-signature=eVSD5SaPZLsLwr2G5NL%2B5LX0xTM%3D" alt="在这里插入图片描述" loading="lazy"/><br/>
<strong>1.7 覆盖索引与回表</strong><br/>
如果只需要在一棵索引树上就可以获取Sql所需要的所有列，就不需要回表查询，这样查询速度会更快。而实现覆盖索引最快的方式就是将所需要的字段放在一起建一个联合索引。</p>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份好像面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
</blockquote>
<p>对这份笔记感兴趣的小伙伴可以点击文末名片免费获取<br/>
<strong>1.8 Mysql的锁有哪些？什么是间隙锁？</strong><br/>
从锁的粒度来分<br/>
1、行锁：加锁粒度小，但是加锁的资源开销比较大。Innodb支持。<br/>
1）共享锁：多个事务可以共享一把锁，但是只能读不能修改<br/>
2）排他锁：只有一个事务可以获得排他锁，其他事务不能获取该行的锁。Innodb会自行对增删改操作添加排他锁。<br/>
2、表锁：加锁粒度大，加锁的资源消耗小，Mysalm和Innodb都支持。<br/>
3、全局锁：加锁后全库都处于只读状态，用于全库数据备份。</p>
<p><strong>1.9 海量数据下，如何快速找到一条数据</strong><br/>
1）使用布隆过滤器，快速过滤不存在的数据；<br/>
2）red is中建立数据缓存<br/>
3）查询优化</p>
<h6 data-id="heading-0">[]2、数据库分库分表</h6>
<p><strong>2.1 数据库的分库分表？什么时候分？怎么分？</strong><br/>
当单表数据超过1000W时，很多操作的性能会下降，所以需要切分，以减少数据库的压力，缩短查询时间。<br/>
垂直切分：将关系联系不紧密的表进行分库，将一张表中不常用的字段进行抽取新建一张表。优点类似于微服务。<br/>
水平切分：当一个应用难以再细粒度的垂直切分，根据数据间的逻辑进行划分，比如客户、存款、支付；<br/>
<strong>2.2 数据库的优化</strong><br/>
1）sql优化以及索引的优化，索引建立要合理，过多会影响增删性能<br/>
2）数据可设计要满足他的三大范式、五大约束<br/>
3）硬件优化</p>
<p><strong>2.3 表设计的时候注意哪些，字段？</strong></p>
<blockquote>
<p>在设计数据库表时，需要注意以下几点，特别是在定义字段的时候：</p>
<ol>
<li>数据类型选择：选择最适合的数据类型可以减小数据库表的存储空间，提高检索效率。对于整数、浮点数、字符串等不同类型的数据，选择合适的数据类型是设计表结构时的关键之一。</li>
<li>索引设计：根据实际查询需求设计合适的索引，可以提高查询效率。通常在主键、外键、经常用于查询的字段上创建索引。</li>
<li>主键设计：选择一个唯一、稳定、易于理解的字段作为主键，以确保每条记录都有唯一标识，便于数据访问和管理。</li>
<li>字段命名规范：字段命名应具有描述性，易于理解和记忆，建议使用下划线分隔（如：first_name），避免使用含糊不清或缩写的字段名。</li>
<li>字段约束：定义字段的约束条件，如NOT NULL、UNIQUE、DEFAULT值等，可以保证数据的完整性和一致性。</li>
<li>数据冗余：避免数据冗余，尽可能将重复的数据抽取成单独的表，以减小数据存储量，同时避免数据更新异常。</li>
<li>参照完整性：在设计外键关系时，保证参照完整性，确保相关数据的一致性，避免数据关联异常。</li>
<li>考虑数据增长：预估数据表的增长情况，选择适当的存储引擎和分区方案，以支持未来数据量的增长。</li>
</ol>
<p>综上所述，在设计数据库表结构时，字段的数据类型、索引设计、主键选择、命名规范、约束条件、数据冗余、参照完整性、数据增长等方面都需要认真考虑，以保证数据库表的稳健性、性能和灵活性。</p>
</blockquote>
<h6 data-id="heading-1"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>3、数据库事务</h6>
<p>spring里面的事务和mysql里面的事务是一个概念，如果mysql不支持事务，加上@transation也是无效的。但是spring里面的@transation不能用于分布式环境下，分布式多线程下用的是senta+@globalTransation注解。<br/>
<strong>3.1 @transation用于类和方法有什么区别？</strong><br/>
@transation只能修饰public方法。<br/>
类上：相当于在所有的public方法上加上了@transation注解<br/>
方法：会覆盖类上的配置。</p>
<p><strong>3.2 事务的4个条件ACID</strong><br/>
原子性：所有的操作是一个整体，要么全部成功，要么全部失败（回滚）<br/>
一致性：事务开始前后，数据库的完整性没有被破坏，也就是写入的资料完全符合我们的预设。<br/>
隔离性：允许多个并发事务对数据进行读写操作，它可以有效的防止多个事务并发执行时由于交叉执行而导致数据的不一致。（隔离性里面有4个隔离级别：读未提交、读以提交、可重复读、串行化）<br/>
持久性：事务完成，对数据的操作就是永久的，即使系统故障也不会丢失。</p>
<p><strong>3.3 mysql事物隔离级别？</strong></p>
<p>MySQL 提供了四种隔离级别，用于控制事务之间的隔离程度，以确保事务操作的一致性和并发性。这四种隔离级别分别是：</p>
<blockquote>
<ol>
<li><strong>读未提交（Read Uncommitted）</strong>  ：最低的隔离级别，允许一个事务读取另一个事务未提交的数据。可能会出现脏读（Dirty Read）问题。</li>
<li><strong>读提交（Read Committed）</strong>  ：其他事务提交后才能读取数据，避免脏读问题。但可能会出现不可重复读（<em><strong>指的是在同一个事务中，某个查询操作在不同时间点内多次执行，但由于其他事务的并发操作，在多次执行过程中返回的数据结果不一致的情况</strong></em>）问题。</li>
<li><strong>可重复读（Repeatable Read）</strong>  ：保证在同一个事务中多次读取同一行数据时，结果始终一致。避免了脏读和不可重复读问题。但依然可能存在幻读（<em><strong>在相同的查询条件下，不同的事务在不同时间点执行查询操作时，可能会看到不同数量的行，从而产生"幻像"的错觉</strong></em>）问题。</li>
<li><strong>串行化（Serializable）</strong>  ：最高的隔离级别，通过确保事务串行执行来避免脏读、不可重复读和幻读问题。确保所有事务的并发执行不会导致数据不一致。</li>
</ol>
<p>在 MySQL 中，可以通过设置事务的隔离级别来控制事务的隔离程度，从而灵活地平衡并发性能和数据的一致性。开发者可以根据实际需求选择合适的隔离级别来确保数据操作的正确性和安全性。</p>
</blockquote>
<h6 data-id="heading-2">[]4、Mysql其他问题</h6>
<p><strong>4.1 mysql中的null和空值有什么不一样？</strong><br/>
1）空值是不占空间的，null值占用空间。两者就像：空值是真空状态的杯子，而null值是装满空气的杯子。<br/>
2）查寻上：null 值是用is null/is not null来查询，而空值( ’ ’ )则可以用 = &gt; !=等。 在使用聚合函数count时，会过滤掉null，而不会过滤掉 （ ’ ’ ）值。<br/>
在实际开发中，没有特定需求，可以直接使用空值！！！</p>
<p><strong>4.2 mysql主从数据库延时的原因？</strong></p>
<blockquote>
<p>MySQL主从数据库延时可能有多种原因，以下是一些常见的原因：</p>
<ol>
<li>网络延迟：主从数据库之间的网络连接如果不稳定或者网络质量差，会导致数据同步的延迟。</li>
<li>主从数据库负载：主数据库的负载过高，或者从数据库的性能不足，都可能导致数据同步延迟。</li>
<li>数据量过大：如果要同步的数据量过大，或者有大量的写操作，都会增加同步的时间。</li>
<li>复制方式设置不当：MySQL复制方式（如异步复制、半同步复制等）的配置不合理也会导致延时。</li>
<li>主从数据库版本不兼容：如果主从数据库的版本不一致或不兼容，也可能导致数据同步延迟。</li>
</ol>
<p>在排查MySQL主从数据库延时问题时，可以逐一检查上述可能的原因，逐步定位并解决问题。</p>
</blockquote>
<p><strong>4.3 mysql主从复制的过程？</strong></p>
<blockquote>
<p>MySQL主从复制是一种常见的数据库复制技术，用于将主数据库中的数据实时同步复制到从数据库。以下是MySQL主从复制的基本过程：</p>
<ol>
<li>配置主数据库：首先需要在主数据库上开启二进制日志（Binary Log），并配置主机的唯一标识（Server ID）。</li>
<li>配置从数据库：在从数据库上配置连接主数据库的信息，包括主数据库的IP地址、端口号、用户名密码等。同时设置从数据库的唯一标识（Server ID）。</li>
<li>启动主从复制过程：在从数据库上执行CHANGE MASTER TO命令，指定主数据库的连接信息，并启动从数据库与主数据库的连接。</li>
<li>数据传输与同步：当主从数据库连接成功后，主数据库会将变更写入二进制日志，并通过主从复制线程将这些变更传输给从数据库，从数据库接收到变更后应用于自身数据库，实现数据同步。</li>
<li>监控与维护：定期检查主从数据库的状态，确保主从复制正常运行。如果发现延迟或同步失败，需要及时排查并解决问题。</li>
</ol>
<p>总的来说，MySQL主从复制的过程包括配置主从数据库、启动复制、数据传输与同步以及监控与维护等步骤。通过主从复制，可以实现数据的备份、负载均衡以及容灾等功能。</p>
</blockquote>
<h6 data-id="heading-3"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>四、JVM虚拟机</h6>
<p>笔者此前在其他博客上整理过，不在重复，链接如下：</p>
<h6 data-id="heading-4"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/></h6>
<blockquote>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                        即可免费获取**</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca2b80d559624a8d84507af43688d2cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770357252&amp;x-signature=74MffoveEG14kGUE1%2BC5vc1sZvM%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/> 对这份笔记感兴趣的小伙伴可以点击文末名片免费获取</p>
</blockquote>
<h6 data-id="heading-5"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>五、Redis面试题</h6>
<h6 data-id="heading-6"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>1 、缓存雪崩、缓存穿透、缓存击穿</h6>
<ul>
<li>_<strong>缓存雪崩：</strong>  _缓存同一时间大面积失效，大量请求打到数据库上，数据库承受不住崩掉；<br/>
解决方案：过期时间设置成随机、缓存预热（系统出初启动，先存数据到缓存里）</li>
<li>_<strong>缓存穿透：</strong>  _数据库和redis中都没有数据，导致大量数据查询数据库，导致数据库崩掉；</li>
<li>可以将不存在的请求key的value 设置成一个字符串返回，这样就避免了黑君攻击到数据库。<br/>
解决方案： 接口层进行校验（id&lt;0的直接拒绝）、采用布隆过滤器</li>
<li>_<strong>缓存击穿：</strong>  _redis的一个key失效，请求全部打到数据库（缓存没有数据库有）；<br/>
解决方案： 热点数据永不过期，设置成空字符串返回</li>
</ul>
<h6 data-id="heading-7"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>2、 如何保证数据库和Redis的数据一致性</h6>
<p>当我们遇到这个问题时，要考虑是先删缓存，还是先写数据库。<br/>
延时双删： 先删redis缓存数据，再更新数据库，然后再删redis缓存,这样就避免了删除redis和更新数据库这期间，其他的线程读不到redis里的值，去读数据库里的旧数据。</p>
<p>将操作可串行化（先写在读就可以了）<br/>
1）先删缓存，将更新数据库操作放到一个有序队列中<br/>
2）从缓存中查不到的查询操作，都进入有序队列（MQ）<br/>
问题：大量读请求积压--------&gt; 将队列水平拆分</p>
<h6 data-id="heading-8"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>3、Redis的数据结构及使用场景</h6>
<p>String :字符串 ----------原子计数器<br/>
List ：列表 ---------微博、微信等消息流数据<br/>
Set ：无序集合 ---------好友推荐<br/>
Zset ：有序集合 -----------排行榜<br/>
Hash ：哈希表 ----------适合存储对象</p>
<p>----------------------------------前五种为常见，后四种为面试加分项-------------------------------------------<br/>
bitmap:布隆过滤器<br/>
GeoHash:坐标，（存储坐标的）基于Zset的score进行排序就可以得到坐标附近的值<br/>
HyperLoglog: 统计不重复数据，用于大数据基础使用<br/>
Streams:内存版的Kafka，消息的订阅发布</p>
<h6 data-id="heading-9"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>4、Redis持久化机制有哪些</h6>
<p>基于内存，宕机数据会消失，所以需要持久化。有两种方式</p>
<ul>
<li>RDB：Redis DateBase<br/>
在指定的时间间隔内将内存中的数据以快照的形式写入磁盘,实际是fork（分支）一个子进程，先将数据复制写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储。</li>
</ul>
<blockquote>
<p>优点：</p>
<ul>
<li>整个redis数据库将只有一个dump.rdb文件，方便持久化；</li>
<li>容灾性好，方便备份；</li>
<li>性能最大化，fork子进程来完成写操作，让主进程继续处理命令，所以是IO最大化。使用单独子进程来进行持久化，主进程不进行任何的IO操作，保证了Redis的高性能；</li>
<li>相对于数据集大时，比AOF的启动效率更高；</li>
</ul>
<p>缺点：</p>
<ul>
<li>数据安全性低。持久化期间Redis发生故障，会有数据丢失；</li>
</ul>
</blockquote>
<p>AOF: Append Only File<br/>
以日志的形式记录服务器的每一个写、删除操作，查询操作不会记录，以文本的方式记录，可以打开文件看到详细的操作记录</p>
<blockquote>
<p>优点：</p>
<ul>
<li>数据安全，每次修改都会被记录到磁盘中；</li>
<li>通过append模式写文件，即使Redis宕机，也不会破坏已经存在的内容，可以通过redis-check-aof工具解决数据一致性问题；</li>
</ul>
<p>缺点：</p>
<ul>
<li>效率没有RDB高；</li>
<li>AOF文件比RDB大，且恢复速度慢；</li>
</ul>
</blockquote>
<h6 data-id="heading-10"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>5、Redis其他常见问题</h6>
<p><strong>5.1 Redis线程模型，单线程为什么快？</strong></p>
<p>单线程快的原因有以下几点:</p>
<ul>
<li>纯内存操作</li>
<li>核心是基于非阻塞的IO多路复用机制(单个线程可以同时处理多个请求)</li>
<li>单线程避免了多线程来回切换的上下文环境切换问题</li>
</ul>
<p><strong>5.2 Redis分布式锁的实现原理</strong><br/>
set(key,value,setnx,setpx)<br/>
setnx-----------&gt;加锁的命令<br/>
setpx-----------&gt;锁的过期时间<br/>
setnx+setp在高版本中已经整合为一个原子命令。<br/>
当任务超时，锁自动释放怎么办？可以使用redission的看门狗，会自动续期。</p>
<blockquote>
<ol>
<li>
<p><strong>获取锁</strong>：</p>
<ul>
<li>客户端使用SET命令尝试在Redis中设置一个特定的键作为锁，可以设置一个固定的值作为锁持有者的标识，同时设置一个过期时间（防止锁无法释放导致死锁）。</li>
<li>设置键时使用NX参数（即只在键不存在时才能设置成功），这样可以确保只有一个客户端能够成功设置该键，获得了锁。</li>
</ul>
</li>
<li>
<p><strong>释放锁</strong>：</p>
<ul>
<li>当客户端要释放锁时，可以通过DEL命令来删除这个键，确保该锁被释放。</li>
</ul>
</li>
<li>
<p><strong>防止死锁</strong>：</p>
<ul>
<li>设置锁时可以为键设置一个合理的过期时间，以防止锁无法释放导致死锁。即使持有锁的客户端在处理任务时发生异常退出，保证锁在一定时间后会自动释放。</li>
</ul>
</li>
<li>
<p><strong>避免误删除</strong>：</p>
<ul>
<li>尽量不要使用DEL命令直接删除锁，因为可能会误删其他客户端的锁。可以使用Lua脚本来确保原子性操作，只有持有锁的客户端才能成功释放锁。</li>
</ul>
</li>
</ol>
<p>总的来说，Redis分布式锁的实现原理基于对Redis的SET命令设置NX参数进行加锁和DEL命令释放锁，配合合理设置过期时间来保证分布式锁的正确性和稳定性。通过合理设计和管理分布式锁，可以帮助多个客户端在分布式环境中协调访问共享资源，避免竞争条件和数据不一致问题。</p>
</blockquote>
<p><strong>5.3 Redis主从复制的原理</strong><br/>
简述好下面的流程图即可（基本使用哨兵模式，基于主从复制的基础上，可以保证高可用，哪个节点挂了就重新选举）<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/269d06df16eb4bfdb76b064baf820cbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770357252&amp;x-signature=fteSQulg4ejChsruWtpRSS7zr3g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>5.4、Redis 到底是单线程还是多线程？</strong><br/>
Redis6.0 版本之前的单线程指的是网络 I/O 和键值对读写是由一个命令完成的；<br/>
Reds6.0 版本之前只有网络请求模块和数据操作模块是单线程的，而其他的特久化，集群数<br/>
据同步，其实是由额外的线程完成的<br/>
Redis6.0 版本之后的多线程指的是网络请求过程采用了多线程，而键值对的读写命令依然是单线程处理，所以Redis 是线程安全的。命令的执行排队执行<br/>
<strong>5.5、 单线程为什么快？</strong><br/>
内存操作、单线程操作没有线程切换开销、全局 hash表 〈一维数细：链表〉查找快<br/>
<strong>5.6、Redis 底层数据如何用跳表来存储的？</strong><br/>
跳表：将有序链表改造为支持近似“折半查找”算法，可以快速的插入、删除、查找操作。<br/>
<strong>5.7、Redis 的Key过期了，为什么没有释放？</strong><br/>
有两种删除策略：<br/>
惰性删除：当读到一个过期的key时触发删除<br/>
定时删除：惰性删除无法及时删除，所以 Redis默认每 100ms 主动删除一批己过期的 key,导致可能出现部分 key 过期但没被清理的情况，导致内存并没有被释放。<br/>
小坑：如果使用set命令修改某个key 的valve 值，没有加过期时间参数，这个key会被设定为永久有效。<br/>
<strong>5.8、 Redis 没设置过期期间，为什么被 Redis 主动删除了？</strong><br/>
当Redis 已用内存超过最大内存时，会触发主动清理策略（8种)，对过期key所有 key设置了处理。可能触发了对所有key 的筛选删除（LRU：最近最少使用，LFU：最少频率使用)。<br/>
<strong>5.9、删除key 的命令，会阻塞 Redis吗？</strong><br/>
删除 String 类型，时间复杂度 o(1),删除单个列表、集合或 hash 类型的key时间复杂度为 o(M)；<br/>
<strong>5.10、一次线上事故，Redis 主从切换导致了缓存雪崩</strong><br/>
（要保证主从库机器时钟一致）我们假设，slave 的时钟比master 的时钟快很多。我们在master 里设置了过期的key， slave的角度看，可能会有很多在master里没有过期的数据己经过期了。如果此时操作主从切换，把 slave提升为新的master，就会开始清理大量的key;会导致以下结果：<br/>
① Master大量清理 key，主线程阻塞，无法及时处理客户端请求；<br/>
② Redis 大量数据过期，引发缓存雪崩。</p>
<p><strong>5.11、线上Redis 持久化策略一般如何设置？</strong><br/>
默认 RDB， 如果对性能要求较高，在master最好不要做持久化，可以在某个 slave 开启 AOF<br/>
备份数据，策略设置为每秒同步一次即可。<br/>
<strong>5.12、一次线上事故，Redis 主节点宕机导致数据全部丢失</strong><br/>
如果 Redis 采用以下模式部署，就会发生数据丢失问题：<br/>
master-slave+哨兵部署实例 ＋master 没有开启持久化功能 ＋Redis 进程使用supervisor管理，并配罟宕机重启。<br/>
这样在master言机，哨兵还未发起切换，supervisor 会将 master 立马拉起，但因为 master<br/>
没有设置持久化，就相当于是空实例，其他的 slave为了会master 保持数据同生，也会变成一个个空实例，也就发生了数据丟失。<br/>
避免：不要给 Redis 主节点设置宕机立马重启，而应该等哨兵把某个 slave选为 master之后，在重启原来宕机的主节点，让其变成 slave。<br/>
<strong>5.13、Redis主从复制风暴是怎么回事？</strong><br/>
Redis 主节点有多个从节点，在某一时刻主节点挂了，重启后从节点重新连上主节点后，进行全量复制，数据量大，加重网络和服务器的页载。避免方法：使用哨兵或集群模式。</p>
<p><strong>red is集群是通过分片技术，hash到不同的节点上</strong></p>
<h6 data-id="heading-11"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>六、SSM和SpringBoot</h6>
<h6 data-id="heading-12"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>1、Spring相关问题</h6>
<p>Spring必问ioc和aop，基本程序员都知道，但如果想要获得好的印象，拉开差距，就要回答出更深的理解，阅读过源码是最好的，总结过一些spring的细节问题，点击链接阅读[spring杂记]</p>
<p><strong>1.1 Spring是什么？谈谈IOC和AOP的理解</strong><br/>
Spring是一个企业级的应用框架，减化了配置，简化了项目部署环境。</p>
<p>IOC: 容器概念、控制反转、依赖注入</p>
<blockquote>
<ul>
<li><em><strong>ioc容器：</strong></em><br/>
实质就是一个map（key,value）里面存放了各种对象（xml里的bean节点，@Service 、@Conroller、@Compent等），在项目启动时，会读取配置文件里的bean节点，根据全限定类名使用反射创建对象，存入到map中。这个时候map里就有我们需要的各种对象了，当我们需要使用时，通过DI（@Autowired、@Resource等注解，xml里的ref标签）注入的方式去取。</li>
<li><em><strong>控制反转:</strong></em><br/>
没有引入ioc容器前，我们A对象依赖于B对象，需要自己手动的去new，引入ioc后，需要B对象的时候ioc自己主动去创建一个B对象到A需要的地方。A对象获取B对象的过程，从主动变成了被动，这个就是控制反转的由来。</li>
<li><em><strong>依赖注入:</strong></em><br/>
依赖注入是实现IOC的方法，就是在IOC运行期间，主动的将某种依赖关系注入到对象中；</li>
</ul>
</blockquote>
<p>AOP：将程序中的交叉业务逻辑（日志、异常、安全）封装成一个切面，对符合其要求的对象进行一个增强，比如一个方法的增强，在方法执行前或执行后做一些额外的事（通过beanPostProcessor实现）。</p>
<p><strong>1.2 说一下Spring的事务机制</strong></p>
<p>Spring的事务机制是基于数据库事务和AOP。<br/>
对于加了@Transation的注解，会创建一个代理对象作为bean，当调用代理对象方法时，会判断该方法上是否加了@Transation的注解，如果加了，就利用事务管理器创建一个数据库连接，将autocommit改为false,禁止自动提交，事务结束没有异常就提交，反之回滚。</p>
<p>什么时候@Transation会失效？方法加了private私有时会失效。非代理对象调用也会失效</p>
<p><strong>1.3 Spring 的bean生命周期</strong><br/>
Spring的bean生命周期里面涉及的内容很多，这里只是说一个大致流程，面试非大厂足够了</p>
<blockquote>
<p>有一个类 UserService.class--------&gt;<em><strong>推断构造方法</strong></em>（默认无参构造）---------&gt;<em><strong>实例化</strong></em>（普通对象）----------&gt;<em><strong>依赖注入</strong></em>（属性赋值，加了@Autowire -------&gt; 初始化前(@PostConstruct) --------&gt;<strong>初始化</strong>(initializingBean)--------&gt; 初始化后（AOP）---------&gt; 代理对象 ------&gt;<em><strong>bean</strong></em></p>
</blockquote>
<p>读取配置信息获取到beandefinition（BeanDefinition 是定义 Bean 的配置元信息接口），存入到map中，推断bean的构造方法，进行实例化，然后进行属性赋值，在初始化后会进行aop的切面，如果创建的bean是单例的，会将单例bean放入到单例池中。之后进行bean的使用，使用完后会调用<br/>
destroy（）方法进行销毁；</p>
<h6 data-id="heading-13"><a href="https://link.juejin.cn/?target=" target="_blank" title="https://link.juejin.cn/?target="/>2、SpringMVC执行流程</h6>
<p>1、具体执行流程如下，面试前背下来即可(截图可放大)！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e5789b5fe1a47998ee4228e115687e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770357252&amp;x-signature=gmqPQ1dnxCM6iRUB%2Fc99KY0HX1U%3D" alt="在这里插入图片描述" loading="lazy"/><br/>
2、父子容器</p>
<blockquote>
<p><strong>springmvc创建了一个自己的容器，并且继承了spring的容器？</strong><br/>
是，在 Spring MVC 中,DispatcherServlet会创建一个自己的 ApplicationContext 容器,这个容器是继承自 Spring 应用程序的根 ApplicationContext 容器的。<br/>
具体过程如下:</p>
<ol>
<li>启动 Spring 应用程序时,会创建一个根 ApplicationContext 容器。这个容器包含了应用程序中所有的bean,如 Service 层和 Repository 层的 bean。</li>
<li>当 DispatcherServlet 被初始化时,它会创建自己的 ApplicationContext 容器。这个容器是根ApplicationContext 容器的子容器。</li>
<li>DispatcherServlet 容器会继承根 ApplicationContext 容器中的所有 bean,因此可以访问这些bean。但根 ApplicationContext 容器无法访问 DispatcherServlet 容器中特有的 bean,如Controller 等。</li>
</ol>
</blockquote>
<p>这种父子容器的关系提供了以下优点:</p>
<ul>
<li>关注点分离: Web 层的 bean 和业务层的 bean 被分隔在不同的容器中,提高了代码的可维护性。</li>
<li>资源隔离: Web 层的资源不会影响到业务层,提高了应用程序的健壮性和安全性。</li>
<li>依赖管理: DispatcherServlet 容器可以访问根容器中的所有 bean,无需重复定义。</li>
</ul>
<p>总之,Spring MVC 通过创建自己的 ApplicationContext 容器并将其设置为根容器的子容器,实现了父子容器的架构设计,提高了应用程序的模块化和可扩展性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e01566dd435249bcaaf94659690d67bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770357252&amp;x-signature=X5pOir%2BGKzITFqQ9Y0CkUQegyOI%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[牛客-NC49最长的括号字串]]></title>    <link>https://juejin.cn/post/7600681071714500608</link>    <guid>https://juejin.cn/post/7600681071714500608</guid>    <pubDate>2026-01-30T03:17:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600681071714500608" data-draft-id="7600670487409606708" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="牛客-NC49最长的括号字串"/> <meta itemprop="keywords" content="后端,C++"/> <meta itemprop="datePublished" content="2026-01-30T03:17:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="枯枫屿"/> <meta itemprop="url" content="https://juejin.cn/user/1558436056404313"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            牛客-NC49最长的括号字串
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1558436056404313/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    枯枫屿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:17:47.000Z" title="Fri Jan 30 2026 03:17:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">描述</h3>
<p>给出一个长度为 n 的，仅包含字符 '(' 和 ')' 的字符串，计算最长的格式正确的括号子串的长度。</p>
<p>例1: 对于字符串 "(()" 来说，最长的格式正确的子串是 "()" ，长度为 2 .<br/>
例2：对于字符串 ")()())" , 来说, 最长的格式正确的子串是 "()()" ，长度为 4 .<br/>
字符串长度：0≤n≤5∗1050≤n≤5∗105<br/>
要求时间复杂度 O(n)O(n) ,空间复杂度 O(n)O(n).</p>
<h3 data-id="heading-1">示例1</h3>
<p>输入：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"(()"</span>
</code></pre>
<p>返回值：</p>
<pre><code class="hljs">2
</code></pre>
<h3 data-id="heading-2">示例2</h3>
<p>输入：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"(())"</span>
</code></pre>
<p>返回值：</p>
<pre><code class="hljs">4
</code></pre>
<h3 data-id="heading-3">解题思路（优先推荐栈方法，直观易实现）</h3>
<p>有效括号的核心是 “匹配”，栈可以精准记录未匹配括号的位置，从而计算有效子串长度，思路如下：</p>
<ol>
<li>
<p><strong>初始化栈</strong>：栈中存储括号的<strong>索引</strong>（而非字符），先压入 <code>-1</code> 作为有效子串的<strong>起始基准</strong>（处理第一个字符就是 <code>)</code> 的边界情况）。</p>
</li>
<li>
<p><strong>遍历字符串</strong>：逐个遍历每个字符，记录当前索引 <code>i</code>：</p>
<ul>
<li>
<p>遇到 <code>(</code>：将当前索引 <code>i</code> 压入栈（表示这个左括号等待匹配）。</p>
</li>
<li>
<p>遇到 <code>)</code>：先弹出栈顶元素（尝试匹配最近的左括号）：</p>
<ul>
<li>若弹出后栈为空：说明当前 <code>)</code> 无匹配的 <code>(</code>，将 <code>i</code> 压入栈作为新的基准。</li>
<li>若弹出后栈不为空：当前有效长度 = <code>i - 栈顶元素</code>，用这个值更新最大有效长度。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>返回结果</strong>：遍历结束后，记录的最大长度即为答案。</p>
</li>
</ol>
<h3 data-id="heading-4">完整可运行代码</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">longestValidParentheses</span><span class="hljs-params">(string s)</span> </span>{
        <span class="hljs-type">int</span> maxLen = <span class="hljs-number">0</span>; <span class="hljs-comment">// 记录最长有效括号长度</span>
        stack&lt;<span class="hljs-type">int</span>&gt; st;  <span class="hljs-comment">// 存储括号索引，用于计算有效长度</span>
        st.<span class="hljs-built_in">push</span>(<span class="hljs-number">-1</span>);    <span class="hljs-comment">// 初始基准值，处理边界情况（如第一个字符是')'）</span>
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; s.<span class="hljs-built_in">size</span>(); ++i) {
            <span class="hljs-keyword">if</span> (s[i] == <span class="hljs-string">'('</span>) {
                <span class="hljs-comment">// 左括号：压入当前索引，等待匹配</span>
                st.<span class="hljs-built_in">push</span>(i);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 右括号：先弹出栈顶（尝试匹配最近的左括号）</span>
                st.<span class="hljs-built_in">pop</span>();
                <span class="hljs-keyword">if</span> (st.<span class="hljs-built_in">empty</span>()) {
                    <span class="hljs-comment">// 栈空说明当前右括号无匹配，更新基准为当前索引</span>
                    st.<span class="hljs-built_in">push</span>(i);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 计算当前有效长度，更新最大值</span>
                    maxLen = <span class="hljs-built_in">max</span>(maxLen, i - st.<span class="hljs-built_in">top</span>());
                }
            }
        }
        
        <span class="hljs-keyword">return</span> maxLen;
    }
};
</code></pre>
<h3 data-id="heading-5">补充：动态规划方法（可选，进阶思路）</h3>
<p>如果想了解另一种常用解法，这里给出动态规划版代码（供参考）：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">longestValidParentheses</span><span class="hljs-params">(string s)</span> </span>{
        <span class="hljs-type">int</span> maxLen = <span class="hljs-number">0</span>;
        <span class="hljs-comment">// dp[i] 表示以s[i]结尾的最长有效括号长度</span>
        <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">dp</span><span class="hljs-params">(s.size(), <span class="hljs-number">0</span>)</span></span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; s.<span class="hljs-built_in">size</span>(); ++i) {
            <span class="hljs-keyword">if</span> (s[i] == <span class="hljs-string">')'</span>) {
                <span class="hljs-comment">// 情况1：前一个字符是'('，直接匹配</span>
                <span class="hljs-keyword">if</span> (s[i<span class="hljs-number">-1</span>] == <span class="hljs-string">'('</span>) {
                    dp[i] = (i &gt;= <span class="hljs-number">2</span> ? dp[i<span class="hljs-number">-2</span>] : <span class="hljs-number">0</span>) + <span class="hljs-number">2</span>;
                }
                <span class="hljs-comment">// 情况2：前一个字符是')'，且前面有匹配的'('</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i - dp[i<span class="hljs-number">-1</span>] &gt; <span class="hljs-number">0</span> &amp;&amp; s[i - dp[i<span class="hljs-number">-1</span>] - <span class="hljs-number">1</span>] == <span class="hljs-string">'('</span>) {
                    dp[i] = dp[i<span class="hljs-number">-1</span>] + (i - dp[i<span class="hljs-number">-1</span>] &gt;= <span class="hljs-number">2</span> ? dp[i - dp[i<span class="hljs-number">-1</span>] - <span class="hljs-number">2</span>] : <span class="hljs-number">0</span>) + <span class="hljs-number">2</span>;
                }
                maxLen = <span class="hljs-built_in">max</span>(maxLen, dp[i]);
            }
        }
        <span class="hljs-keyword">return</span> maxLen;
    }
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 时代，程序员的价值在哪里？]]></title>    <link>https://juejin.cn/post/7600791597169213483</link>    <guid>https://juejin.cn/post/7600791597169213483</guid>    <pubDate>2026-01-30T04:28:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600791597169213483" data-draft-id="7600706866785124395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 时代，程序员的价值在哪里？"/> <meta itemprop="keywords" content="稀土"/> <meta itemprop="datePublished" content="2026-01-30T04:28:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HongJianLi"/> <meta itemprop="url" content="https://juejin.cn/user/430664725579725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 时代，程序员的价值在哪里？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664725579725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HongJianLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:28:05.000Z" title="Fri Jan 30 2026 04:28:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天杭州天气不太好，上班路上下了一点小雨。从地铁站走到公司的路上，我一直在思考一个问题：<strong>AI的发展对程序员到底是好事还是坏事？</strong></p>
<p>网络上到处在说“AI要取代程序员”“程序员的饭碗要没了”。这种说法是真的吗？</p>
<p>我的观点很明确：<strong>AI不仅不会取代程序员，反而会成为程序员极其强大的助手——甚至可以说是核武器级别的加速器。</strong></p>
<p>要讲清楚这个问题，我们可以从三类人群的角度来分析。</p>
<hr/>
<h2 data-id="heading-0">一、没有任何计算机基础的人</h2>
<p>对完全不懂编程的人来说，AI确实带来了巨大便利。你只需要用自然语言描述想法，AI就能帮你生成代码、做出原型、快速验证可行性。这在过去是不可想象的效率提升。</p>
<p>但问题在于：<strong>做出一个能跑的Demo，不等于能做出一个可以上线、稳定运行、可维护的产品。</strong></p>
<p>比如，一个普通人用AI写了个程序，可能根本不知道：</p>
<ul>
<li>这个程序在 Windows 和 Linux 上需要哪些运行环境？</li>
<li><code>.jar</code> 文件和可执行文件有什么区别？</li>
<li>什么是服务器？怎么部署？怎么监控？</li>
</ul>
<p>更不用说 JVM、GC（垃圾回收）、STW（Stop-The-World）这些概念了。你甚至可能都没听说过它们。当你的 Demo 跑起来时，你不会意识到它在线上可能因为内存溢出、线程阻塞或环境差异而崩溃。</p>
<p>对于一个完全没有程序员的团队来说，这些问题几乎是致命的。让他们从零开始系统学习计算机知识？这在现实中是不现实的。</p>
<p>这也让我想到《代码整洁之道：程序员的职业素养》中提到的一个历史案例——<strong>MDA（模型驱动架构）的失败</strong>。</p>
<p>书中写道：</p>
<blockquote>
<p>“在20世纪90年代早期，我满怀希望地相信CASE工具行业将会彻底改变软件开发人员的工作方式。在那个冲动的年代，展望未来，我满以为到现在这个时候，每个人都应该已经在更高的抽象层次上用图形语言编程，而文本语言编程的时代应该已经一去不复返了。</p>
<p>我太幼稚了。不但这个梦想没有实现，连朝这个方向所做的每一次努力都不幸失败了。不是缺乏工具和系统来展示这种方法的潜能，只是，这些工具都不理想，很少有人愿意用。</p>
<p>在这个梦想中，软件开发人员将可抛弃基于文本编程的琐碎细节，采用一种更为高级的图形语言来编写系统。事实上，只要这个梦想成真，也许根本就不再需要程序员了。架构师能够通过UML图形创建整个系统。工程师们，那帮人数众多、冷酷、对非编程人士的困境缺乏同情的家伙，只需把这些图形转换成可执行代码就可以了。这伟大梦想就是‘模型驱动架构’（MDA）。</p>
<p>不幸的是，这个伟大的梦想有那么一点微小的瑕疵。MDA假设代码是问题之所在。但事实上，代码并不是问题。代码从来都不是问题。细节才是问题。</p>
<p>程序员负责管理各种细节，这是我们的职责。我们通过管理各种最微小的细节来规范系统的行为。之所以使用文本语言来编写代码，正是因为文本语言（例如英语）非常便利。</p>
<p>我们管理的是什么样的细节呢？</p>
<p>你知道\n和\r这两个字符之间的差别吗？第一个字符\n表示换行，第二个字符\r表示回车。回的是什么“车”（carriage）呢？</p>
<p>在20世纪60年代和70年代早期，电传打字机是计算机最常见的输出设备。ASR33型号的电传打字机最为常见。</p>
<p>这个设备有一个打印头，打印头每秒能够打印10个字符。打印头上有一个小圆筒，上面铸着各个字符。圆筒可以旋转升降，当正确的字符朝向纸面的时候，就会有个小锤子敲击圆筒，将字符打在纸面上。在圆筒和纸面间有一条墨带，这时墨水便会把字符印在纸上了。</p>
<p>打印头放在一个车架（carriage）上。每打印一个字符，车架会向右移动一个位置，带动打印头前进。每行有72个字符，当到达行末时，必须明确地通过发送回车字符（\r = 0x0D）执行回车，否则打印头会继续在第72个字符上打印，会让那个字符变成一个脏兮兮的黑块。</p>
<p>当然，执行这一个命令还不够。回车后纸张并没有上移。如果只回车但没有发送换行指令（\n=0x0A），那么新的一行会重复打印在旧的那行上。</p>
<p>因此，对于ASR33电传打印机，每行应该以\r\n结尾。事实上，还必须要注意，回车耗时有可能会超过100毫秒。如果发送了\r\n，紧接其后的下一个字符有可能刚好在回车的时候打印出来，这样就有可能在行中打印出一个污点。为了安全起见，通常会在每行末尾再附加上一到两个删除符（0xFF）。</p>
<p>在20世纪70年代，电传打印机用得越来越少了，像UNIX这些操作系统把行末序列简化为\n。但是，其他操作系统，如DOS，仍然使用\r\n作为行末的约定。</p>
<p>你最近一次处理文本文件时，因使用了“错误”的行末约定而遭遇到问题，是在什么时候？我每年至少要遇到一次。两个一模一样的源文件在比较时却发现不一样，生成的校验和也不一样，这就是因为它们使用了不同的行结束符。由于行末结束符有“错”，文本编辑器无法正确自动换行，或者文本里多空了一行。由于将\r\n解析为两行，没有预料到空行的程序崩溃了。有一些程序能够识别\r\n，但是无法识别\n\r。诸如此类的问题很多。</p>
<p><strong>这就是我所说的细节。试试使用UML来描述解决行末问题的可怕逻辑！</strong>”</p>
</blockquote>
<p>这段话非常关键。MDA 的失败，本质上是因为它试图绕过“细节”，而<strong>软件开发的核心恰恰就是处理细节</strong>。</p>
<p>今天的 AI 和当年的 MDA 其实有相似之处：都希望通过更高层次的抽象（图形或自然语言）跳过手写代码。但现实是，<strong>无论你写多少提示词，最终还是要面对设计、边界条件、异常处理和平台差异等具体问题。</strong></p>
<p>写代码从来不是最难的部分，<strong>设计和理解系统才是。</strong></p>
<p>所以，一个没有经验的普通人，即使能用 AI 做出一个“重要程序”，你敢用吗？比如银行转账、医疗诊断、工业控制——这些系统容不得半点模糊。</p>
<hr/>
<h2 data-id="heading-1">二、普通程序员</h2>
<p>这里说的“普通程序员”，是指工作经验较少、对系统设计和底层原理理解不够深入的开发者。</p>
<p>对这类人来说，AI 是好事也是坏事：</p>
<ul>
<li>
<p><strong>对有进取心的人</strong>：AI 能极大加速学习过程。你可以快速理解新概念、生成示例代码、调试问题，从而更快积累经验。剩下的就是持续实践，稳步成长。</p>
</li>
<li>
<p><strong>对只想混日子的人</strong>：AI 反而是威胁。如果你只会复制粘贴、调用现成接口、机械完成任务，那么 AI 很快就能替代你。在这个快速变化的行业里，<strong>不思进取就是慢性淘汰。</strong></p>
</li>
</ul>
<p>技术一直在演进。十年前和现在差别已经很大，而下一个十年的变化只会更快。年轻人学习能力强、精力充沛、没有技术包袱——如果你停滞不前，被后来者超越是必然的。</p>
<p>别以为“稳”就是安全。在程序员这个行业，<strong>逆水行舟，不进则退。</strong></p>
<hr/>
<h2 data-id="heading-2">三、资深开发人员</h2>
<p>对资深开发者来说，AI 是一个强大的“加速引擎”。</p>
<p>它可以帮你：</p>
<ul>
<li>快速生成样板代码，减少重复劳动；</li>
<li>检查潜在 bug 或性能问题；</li>
<li>根据设计思路补全实现；</li>
<li>提供多种技术方案参考。</li>
</ul>
<p>但必须清楚：<strong>AI 不能替代系统设计和架构决策。</strong></p>
<p>软件开发从来不是一个人的事。一个人可以写出一个程序，但要让它长期稳定迭代，需要团队协作、流程规范、知识沉淀和持续维护。</p>
<p>未来更高效的模式，可能是由资深开发者组成的“特种兵式”小团队：</p>
<ul>
<li>每个人专注一个核心模块；</li>
<li>借助 AI 提升个人产出效率；</li>
<li>通过紧密协作保证整体质量。</li>
</ul>
<p>这样的团队迭代快、问题少、成本低，特别适合长期产品。即使是短期项目，稳定的团队也能爆发出更强战斗力。</p>
<p>频繁更换团队其实代价很高——上下文丢失、沟通成本上升、信任重建，这些都是隐形成本。在这方面，我也推荐《代码整洁之道》中的章节：“团队与项目——有凝聚力的团队”，里面讲得很清楚：<strong>高效来自默契，而非个体英雄主义。</strong></p>
<hr/>
<h2 data-id="heading-3">总结：AI 是蒸汽机，不是原子弹</h2>
<p>我认为，<strong>AI 是可以媲美蒸汽机的伟大发明。</strong></p>
<p>蒸汽机出现之前，生产靠人力，效率极低；蒸汽机之后，人类学会了高效利用能量，开启了工业革命。</p>
<p>今天，AI 正处于初级阶段。如果说蒸汽机是对<strong>能量的合理使用</strong>，那么 AI 就是对<strong>知识的充分使用</strong>。</p>
<p>我们今天很多问题——比如学习门槛高、信息碎片化、试错成本大——本质上是因为<strong>缺乏可靠知识，或无法快速获取它</strong>。AI 正在改变这一点。</p>
<p>所以，AI 不会取代程序员。它取代的，是那些<strong>只做重复性编码、不思考系统、不理解业务、不持续学习的人</strong>。</p>
<p>而对真正理解软件本质、善于解决问题、持续精进的程序员来说，AI 是前所未有的助力。</p>
<p><strong>与其担心被 AI 取代，不如学会用 AI 让自己变得更强大。</strong></p>
<p>下一个十年，变化一定会比过去十年更大。你准备好了吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[目前最火的 AI 助手 Clawdbot 又又又改名了 并且发布新版本]]></title>    <link>https://juejin.cn/post/7600764857769328690</link>    <guid>https://juejin.cn/post/7600764857769328690</guid>    <pubDate>2026-01-30T05:51:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600764857769328690" data-draft-id="7600990891205656603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="目前最火的 AI 助手 Clawdbot 又又又改名了 并且发布新版本"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-30T05:51:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            目前最火的 AI 助手 Clawdbot 又又又改名了 并且发布新版本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T05:51:34.000Z" title="Fri Jan 30 2026 05:51:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目前最火的 AI 助手 Clawdbot 又又又改名了 并且发布新版本</h2>
<p>两个月前还叫 Clawdbot，三天前改成 Moltbot，今天又宣布改名 OpenClaw。这只开源龙虾到底经历了什么？</p>
<p>如果还不会安装没玩过的话，可以参考我得上一篇博客<a href="https://juejin.cn/post/7600238071038197769" target="_blank" title="https://juejin.cn/post/7600238071038197769">Clawdbot 对接飞书详细教程 手把手搭建你的专属 AI 助手</a></p>
<h3 data-id="heading-1">先说这玩意能干嘛</h3>
<p>想象一下：你在飞书群里 @机器人 说"帮我查一下上周的销售数据"，它直接连你本地数据库查完返回结果；你在 WhatsApp 上让它"把这张图里的文字提取出来"，它调用本地的 OCR 模型处理完发给你；你在 Telegram 上说"帮我写个 Python 脚本批量重命名文件"，它写完代码还能直接在你服务器上跑。</p>
<p>这就是 OpenClaw（原 Clawdbot）——一个<strong>跑在你自己机器上的 AI 助手</strong>，可以对接几乎所有主流聊天工具：</p>
<ul>
<li><strong>即时通讯</strong>：WhatsApp、Telegram、Discord、Slack、Teams</li>
<li><strong>国内平台</strong>：飞书、钉钉</li>
<li><strong>其他</strong>：Twitch、Google Chat、Web 界面</li>
</ul>
<p>关键是：<strong>数据全在你手里</strong>。不像那些云端 AI 助手，你的聊天记录、文件、API 密钥都存在自己的服务器上。你可以让它访问本地文件系统、执行 shell 命令、调用本地 API——这些在云端 AI 上想都别想。</p>
<p>这个项目最初只是作者的一个周末小玩具，结果两个月后 GitHub 上超过 <strong>10 万 stars</strong>，一周内 <strong>200 万访问量</strong>。</p>
<h3 data-id="heading-2">为什么老改名</h3>
<p>名字的变迁过程堪称一部开源项目的"避坑指南"：</p>
<p><strong>第一次：Clawd → 被 Anthropic 发律师函</strong></p>
<p>2025 年 11 月，项目起名 Clawd，是 Claude + claw（爪子）的谐音梗。用过 Claude 的人应该都见过加载时那只小龙虾——名字就来源于此。</p>
<p>结果没多久，Anthropic 法务团队就发来了"友好建议函"。Clawd 和 Claude 确实太像了，换位思考也能理解。</p>
<p><strong>第二次：Moltbot → 社区凌晨五点的产物</strong></p>
<p>2026 年 1 月 27 日，作者和社区成员在 Discord 上凌晨五点头脑风暴，选了 Moltbot。Molt 是龙虾蜕壳的意思，寓意成长。</p>
<p>但这名字有个问题：念起来像"摸头 bot"，而且 molt 这个词太冷门，很多人根本不知道什么意思。更惨的是，改名过程中还被人抢注了域名和社交账号，甚至有人趁机发了个同名的加密货币来割韭菜。</p>
<p><strong>第三次：OpenClaw → 这次做足了功课</strong></p>
<p>吸取前两次教训，这次改名前团队做了充分准备：</p>
<ul>
<li>商标检索：通过</li>
<li>域名：已购入</li>
<li>迁移代码：已写好</li>
<li>社交账号：已注册</li>
</ul>
<p>OpenClaw 这个名字拆开来看：Open（开源、开放）+ Claw（龙虾爪，致敬起源）。简单直接，不容易产生法律纠纷。</p>
<h3 data-id="heading-3">新版本更新了什么</h3>
<p>除了改名，这次还带来了不少实质性更新：</p>

























<table><thead><tr><th>类别</th><th>内容</th></tr></thead><tbody><tr><td>新渠道</td><td>Twitch 和 Google Chat 插件</td></tr><tr><td>新模型</td><td>KIMI K2.5、小米 MiMo-V2-Flash</td></tr><tr><td>Web 聊天</td><td>支持发送图片</td></tr><tr><td>安全</td><td>34 个安全相关提交，发布了可机器验证的安全模型</td></tr></tbody></table>
<p>作者特别提醒：prompt injection 目前在整个行业都是未解决的问题。既然 OpenClaw 能访问本地文件和执行命令，安全配置一定要认真对待。</p>
<h3 data-id="heading-4">后续计划</h3>
<ul>
<li>安全加固仍是首要任务</li>
<li>优化网关稳定性</li>
<li>支持更多模型和服务商</li>
<li>招募全职维护者（项目发展太快，作者一个人已经维护不过来了）</li>
</ul>
<h3 data-id="heading-5">我之前写的教程还能用吗</h3>
<p>如果你看过我之前写的 <a href="https://link.juejin.cn?target=.%2Fclawedbot-install.md" target="_blank" title="./clawedbot-install.md" ref="nofollow noopener noreferrer">Clawdbot 对接飞书详细教程</a>，命令和配置方式暂时还能用，CLI 工具名称还是 <code>clawdbot</code>。但按照这个改名频率，建议关注官方文档获取最新信息。</p>
<hr/>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenclaw%2Fopenclaw" target="_blank" title="https://github.com/openclaw/openclaw" ref="nofollow noopener noreferrer">github.com/openclaw/op…</a></p>
<p>最新版本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenclaw%2Fopenclaw%2Freleases%2Ftag%2Fv2026.1.29" target="_blank" title="https://github.com/openclaw/openclaw/releases/tag/v2026.1.29" ref="nofollow noopener noreferrer">v2026.1.29</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一天内彻底改变你的人生]]></title>    <link>https://juejin.cn/post/7600670417858871330</link>    <guid>https://juejin.cn/post/7600670417858871330</guid>    <pubDate>2026-01-30T04:04:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670417858871330" data-draft-id="7600670487410163764" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一天内彻底改变你的人生"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T04:04:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大鸡腿同学"/> <meta itemprop="url" content="https://juejin.cn/user/3526889030825928"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一天内彻底改变你的人生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889030825928/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大鸡腿同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:04:31.000Z" title="Fri Jan 30 2026 04:04:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>新年又要来了，大家不是又开始立各种Flag——减肥、学技能、早睡早起？结果往往没多久就悄声无声息地放弃了。数据显示，80-90%的新年会决议失败，为什么？不是你不够自律，而是大多数人根本在本质上真正改变。YouTube上有个爆火视频《如何在一天内修复你的整个人生》（如何在一天修复你整个人生），作者内丹Koe用心理学和行为科学直击本质，教你从根源翻盘。视频已经收获近20万观看（实际更高，网络传播超百万印象），他的观点太扎心了，但也超级实用。读完这些核心原观点，你可能会瞬间恍然大悟，一起在评论区分享你的Flag失败经历吧！</p>
<h2 data-id="heading-0">1.为什么Flag总是立不稳？大多数人其实并没有真正改变</h2>
<p>Dan Koe直言：大多数人立的目标只是表面功夫，动力来自炫耀或外部压力，而不是内心的渴望。“大多数人实际上并不想在深层、内部层面上改变。”（大多数人其实不想在深刻内在改变。）他们“设定表面目标，在最初几周自我炒作以保持自律，然后毫不费力地回到原来的方式，因为他们试图在腐烂的基础上建立美好的生活（设定表面目标，前几周靠兴奋维持纪律，然后无力就回到老样子，因为他们在腐烂的基础上试图缔造伟大人生。）本质上，人们无意识地成功地在追求安全和可预测，却失败了或后来的未知：“你在追求安​​全和可预测的目标，并找借口不让自己看起来像失败者。”（你在追求安​​全、可预测的目标，并寻求不像失败者的理由。）</p>
<h2 data-id="heading-1">2.先改变身份，行为就会自然随之</h2>
<p>Dan Koe 的核心观点：“You Aren'tWhere You Want to Bebecause You Aren't the Person Who Will Be There.”（你没到想去的地方，因为你不是那个会到那里的人。）解决方案很简单却深刻：“改变你是谁，让你的行为自然跟随。这是最重要的。这是首要的。” （改变你的身份，让行为自然紧随。这是最重要的，这是第一序。）比如说，真正成功健身的人不是靠意志力“逼”自己去，而是身份转变后讨厌不健身的感觉。</p>
<h2 data-id="heading-2">3.目标必须匹配内在：过易过难都会失败别再设切实际或太肤浅的目标。</h2>
<p>Dan Koe强调：“如果你想在生活中得到一个特定的结果，你必须在实现它之前就拥有能够创造这个结果的生活方式。”（如果你想要特定的结果，必须在达到之前才拥有它的生活方式。）真正的改变需要调整视角：“真正的改变需要改变你的目标……改变你的观点，因为这就是目标。目标是对未来的投射，它充当了感知。”（真正改变需要改变目标……改变视角，因为目标就是未来投影，部署镜头。）如果不匹配，你会无意识地回避一切机会。</p>
<h2 data-id="heading-3">4.创造动力“反愿景”（anti-vision），用失败后果激发</h2>
<p>别只幻想美好的未来，要狠狠的脑子不改变的下场！丹·科建议：“如果未来5年绝对没有任何变化，描述一个平均的星期二……现在，做同样的事情，但是10年？你错过了什么？接近什么机会？谁放弃了你？……你已经到了生命的尽头。你过着安全的生活。你从未打破模式。什么是成本？”（如果接下来5年什么都不变，一个普通的周二……10年呢？失去了什么？机会关闭了？谁放弃了你？……人生巅峰，你活了安全版，从未突破模式。代价是什么描述？）这让你“感受到更大事物的拉力。”（大致向东西的拉力。）</p>
<h2 data-id="heading-4">5.把人生游戏化：用奖励、评估和结构保持痴迷</h2>
<p>Dan Koe 说：“游戏是痴迷、享受和心流状态的典型代表。”（游戏是痴迷、享受和心流状态的枕头。）把生活拆成：反愿景（赌注是什么）、愿景（怎么赢）、一年目标（使命）、一个月项目（boss Fight）、每日杠杆（quests）。评估进展也很关键：“高智商是迭代、坚持和理解大局的能力。低智商的标志是（高智能是迭代、坚持、懂大局的能力。低智能是无法从错误中学习。）一天协议：早上奋发反省愿景和愿景、白天中断自动驾驶、晚上合成目标。视频结尾，Dan Koe分享：“我生命中最好的时期总是在一段时间彻底厌倦之后到来。”（我人生最佳时期总在彻底厌烦后。）这不是空谈，是可操作的心理重置法！试试他的“一天汇率”协议，你的Flag还能倒吗？评论区来分享你的反视力，或者你打算怎么改变身份，一起监督变强！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年请别再把时间浪费在这些技术上（以及你应该转学什么）]]></title>    <link>https://juejin.cn/post/7600706866785058859</link>    <guid>https://juejin.cn/post/7600706866785058859</guid>    <pubDate>2026-01-30T02:51:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600706866785058859" data-draft-id="7599566082212659252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 年请别再把时间浪费在这些技术上（以及你应该转学什么）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T02:51:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 年请别再把时间浪费在这些技术上（以及你应该转学什么）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:51:49.000Z" title="Fri Jan 30 2026 02:51:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    34
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>每年都有新人（老鸟也不少）掉进同一个坑里：<strong>死盯着“热门”的看，却把“有用”的当耳旁风。</strong></p>
<p>他们拿着 2018 年的招聘 JD 当圣经，跟着过时的 YouTube 教程敲代码，死死抱住那些“大家都在用”的老技术找安全感。结果呢？整个行业早就把你甩在身后，连声招呼都不打，残酷得一塌糊涂。</p>
<p>到了 2026 年，最惨的其实不是你学不会某种高深的技术，而是<strong>你费劲巴拉学会了，结果发现这玩意儿已经没人稀罕了（Irrelevant）。</strong></p>
<p>这篇文章不是要踩谁。这里面提到的很多技术，当年那是响当当的基石，甚至现在还在很多关键系统里跑着。但如果你的目标是<strong>升职加薪、搞定更有挑战性的活儿、让自己别那么容易被淘汰</strong>，那么下面这 7 样东西，真的别再当成宝了——顺便告诉你，该换成什么。</p>
<hr/>
<h4 data-id="heading-0">1. 还在抱着 jQuery 不撒手</h4>
<p>说句扎心的：如果你现在开新项目还在用 jQuery，那不叫“务实”，那叫“考古”。
jQuery 是好东西，它解决了那个浏览器还在打架的蛮荒时代的痛点。但在 2026 年，那些痛点早就没了，你留下的只有那点改不掉的习惯。维护老项目碰到它没办法，但如果你现在还花大把时间去钻研它，那感觉就像是在 2026 年苦练“如何修理 VCD 播放器”。</p>
<ul>
<li><strong>该学点啥：</strong> 现代 JavaScript (ES2022+)、组件化框架、状态驱动 UI、Web 性能优化的基本功。</li>
<li><strong>一句话真相：</strong> 多去琢磨<strong>浏览器到底是怎么干活的</strong>，别光盯着那些给旧时代打补丁的工具。</li>
</ul>
<h4 data-id="heading-1">2. 写那种“野生”的 PHP</h4>
<p>没错，PHP 依然是互联网的半壁江山。但这不代表你应该去学那种原生（Raw）PHP。
在 2026 年，所谓的“PHP 开发者”其实就是**“框架开发者”**。除此之外的写法，基本就是在制造技术债。如果你脑子里的 PHP 还全是 <code>include</code>、全局变量和手写 SQL 拼接，那你学的版本可能过期十年了。</p>
<ul>
<li><strong>该学点啥：</strong> 基于框架的后端开发、API 优先的设计思路、异步处理、现代后端语言特性。</li>
<li><strong>一句话真相：</strong> PHP 没死，死的是那种<strong>没规矩、乱炖式的 PHP 写法</strong>。</li>
</ul>
<h4 data-id="heading-2">3. 人肉运维，手动撸服务器</h4>
<p>花几个礼拜学怎么手动配置服务器，看着那是挺有成就感的。但在 2026 年，这大多是在做无用功。
现在的团队才不在乎你能不能 SSH 连上去敲一堆命令，他们在乎的是你能不能<strong>让这套环境随时随地都能一键复现</strong>。懂底层原理没毛病，但<strong>凡事都要亲力亲为手动搞一遍</strong>？大可不必。</p>
<ul>
<li><strong>该学点啥：</strong> 基础设施即代码 (IaC)、容器化、云原生部署、可观测性（Observability）。</li>
<li><strong>一句话真相：</strong> 以前是“把服务器当宠物养”，现在是**“把服务器当牲口用，不行就换，全是自动化”**。</li>
</ul>
<h4 data-id="heading-3">4. 像背字典一样背框架 API</h4>
<p>这点最坑人——因为好多教程就是这么教的。
如果你的学习策略就是“背诵这个框架怎么用”，那你这职业生涯的地基基本就是豆腐渣做的。框架年年变，但底层原理是不变的。面试里最尴尬的就是：Demo 写得飞起，问一句**“为什么这么跑”**，直接哑火。</p>
<ul>
<li><strong>该学点啥：</strong> 语言核心概念、运行时机制、并发模型、网络协议、数据库底层。</li>
<li><strong>一句话真相：</strong> 框架只是干活的杠杆，<strong>底层原理才是你的内力</strong>。</li>
</ul>
<h4 data-id="heading-4">5. 只会“增删改查”的 CRUD Boy</h4>
<p>CRUD（增删改查）确实是基础，但如果你<strong>只会</strong>写 CRUD，那你的天花板就比地下室高不了多少。
现代系统早就不是简单的填表存表了，它是事件驱动的、分布式的、实时的。它关注的是数据怎么流转，而不是数据怎么躺在表里。</p>
<ul>
<li><strong>该学点啥：</strong> 事件驱动架构、消息队列、后台任务处理、领域驱动设计（DDD）入门、状态机。</li>
<li><strong>一句话真相：</strong> 未来的后端不看你写了多少接口，看你能不能<strong>玩转整个系统</strong>。</li>
</ul>
<h4 data-id="heading-5">6. 当个疲于奔命的“框架追星族”</h4>
<p>讽刺的是，太爱学新技术有时候也是在浪费时间。
每出一个新框架你都要去凑个热闹，最后的结果就是“样样通，样样松”。在 2026 年，团队看重的是你的<strong>适应能力</strong>，而不是你追热点的速度。</p>
<ul>
<li><strong>该学点啥：</strong> 把一个主流框架吃透、浏览器 API 和渲染原理、性能调优、无障碍（A11y）和 UX 体验。</li>
<li><strong>一句话真相：</strong> <strong>深度永远比新鲜感值钱。</strong> 真的。</li>
</ul>
<h4 data-id="heading-6">7. 闭门造车，为了刷题而刷题</h4>
<p>刷算法题有用吗？有用。但脱离实际场景干刷几百道题？效率极低。
现实里的工程问题，大部分时候是在做<strong>取舍（Trade-offs）</strong>，而不是在那儿解脑筋急转弯。</p>
<ul>
<li><strong>该学点啥：</strong> 真实系统里的数据结构应用、性能分析和调试、系统设计基础、学会读懂别人的屎山代码。</li>
<li><strong>一句话真相：</strong> 牛逼的工程师优化的是<strong>影响力</strong>，不是 LeetCode 的分数排名。</li>
</ul>
<hr/>
<h3 data-id="heading-7">💡 2026 年，到底啥才是硬通货？</h3>
<p>当你不再把时间浪费在那些“沉没成本”上，你才能腾出手来抓这一把好牌：</p>
<ul>
<li><strong>能升职加薪的本钱：</strong> 精通一门现代语言、云原生架构、分布式系统、可观测性、还有<strong>怎么用 AI 帮你写代码</strong>。</li>
<li><strong>职业加速器：</strong> 会写文档、能带新人、有产品思维、懂点安全、会搞性能优化。</li>
</ul>
<p>这些东西是有<strong>复利</strong>的，而那些框架 API？过两年就得清零重来。</p>
<h3 data-id="heading-8">结语：选技能就是选命</h3>
<p>学技术这事儿从来都不是中立的。你花进去的每一个小时，其实都是在给你的未来下注。</p>
<p>在 2026 年，最值钱的工程师不是那个“懂工具最多的百晓生”，而是**“最会做选择题”的人**。他们会绕开那些死胡同，死磕底层原理，想着怎么造系统而不是怎么写 Demo。当行业再次变天的时候（肯定会的），他们依然能稳坐钓鱼台——因为<strong>变化</strong>这东西，本来就是常态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BlockingQueue：阻塞操作与条件队列的高效结合]]></title>    <link>https://juejin.cn/post/7600692485946392585</link>    <guid>https://juejin.cn/post/7600692485946392585</guid>    <pubDate>2026-01-30T04:04:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600692485946392585" data-draft-id="7598401650856771584" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" BlockingQueue：阻塞操作与条件队列的高效结合"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-30T04:04:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             BlockingQueue：阻塞操作与条件队列的高效结合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:04:00.000Z" title="Fri Jan 30 2026 04:04:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">BlockingQueue和BlockingDeque</h2>
<h3 data-id="heading-1">BlockingQueue</h3>
<p>BlockingQueue 通常用于一个线程生产对象，而另外一个线程消费这些对象的场景。下图是对这个原理的阐述:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c487c04fafb4327912618ef1b00178a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350640&amp;x-signature=HGPRgSgBi02y58tH1R%2F0UJO72xY%3D" alt="" loading="lazy"/></p>
<p>一个线程往里边放，另外一个线程从里边取的一个 BlockingQueue。</p>
<p>一个线程将会持续生产新对象并将其插入到队列之中，直到队列达到它所能容纳的临界点。也就是说，它是有限的。如果该阻塞队列到达了其临界点，负责生产的线程将会在往里边插入新对象时发生阻塞。它会一直处于阻塞之中，直到负责消费的线程从队列中拿走一个对象。 负责消费的线程将会一直从该阻塞队列中拿出对象。如果消费线程尝试去从一个空的队列中提取对象的话，这个消费线程将会处于阻塞之中，直到一个生产线程把一个对象丢进队列。</p>
<h3 data-id="heading-2">BlockingQueue 的方法</h3>
<p>BlockingQueue 具有 4 组不同的方法用于插入、移除以及对队列中的元素进行检查。如果请求的操作不能得到立即执行的话，每个方法的表现也不同。这些方法如下:</p>

































<table><thead><tr><th/><th>抛异常</th><th>特定值</th><th>阻塞</th><th>超时</th></tr></thead><tbody><tr><td>插入</td><td>add(o)</td><td>offer(o)</td><td>put(o)</td><td>offer(o, timeout, timeunit)</td></tr><tr><td>移除</td><td>remove()</td><td>poll()</td><td>take()</td><td>poll(timeout, timeunit)</td></tr><tr><td>检查</td><td>element()</td><td>peek()</td><td/><td/></tr></tbody></table>
<p>四组不同的行为方式解释：</p>
<ul>
<li>抛异常：如果试图的操作无法立即执行，抛一个异常。</li>
<li>特定值：如果试图的操作无法立即执行，返回一个特定的值(常常是 true / false)。</li>
<li>阻塞：如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行。</li>
<li>超时：如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行，但等待时间不会超过给定值。返回一个特定值以告知该操作是否成功(典型的是 true / false)。</li>
</ul>
<p>无法向一个 BlockingQueue 中插入 null。如果你试图插入 null，BlockingQueue 将会抛出一个 NullPointerException。 可以访问到 BlockingQueue 中的所有元素，而不仅仅是开始和结束的元素。比如说，你将一个对象放入队列之中以等待处理，但你的应用想要将其取消掉。那么你可以调用诸如 remove(o) 方法来将队列之中的特定对象进行移除。但是这么干效率并不高，因此你尽量不要用这一类的方法，除非你确实不得不那么做。</p>
<h3 data-id="heading-3">BlockingDeque</h3>
<p>java.util.concurrent 包里的 BlockingDeque 接口表示一个线程安放入和提取实例的双端队列。</p>
<p>BlockingDeque 类是一个双端队列，在不能够插入元素时，它将阻塞住试图插入元素的线程；在不能够抽取元素时，它将阻塞住试图抽取的线程。 deque(双端队列) 是 "Double Ended Queue" 的缩写。因此，双端队列是一个你可以从任意一端插入或者抽取元素的队列。</p>
<p>在线程既是一个队列的生产者又是这个队列的消费者的时候可以使用到 BlockingDeque。如果生产者线程需要在队列的两端都可以插入数据，消费者线程需要在队列的两端都可以移除数据，这个时候也可以使用 BlockingDeque。BlockingDeque 图解:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/409d44e82fb04cac9b338e0f13455363~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350640&amp;x-signature=WUOdXHvSWjv%2FNMbfo0FhXUwcfH4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">BlockingDeque 的方法</h3>
<p>一个 BlockingDeque - 线程在双端队列的两端都可以插入和提取元素。 一个线程生产元素，并把它们插入到队列的任意一端。如果双端队列已满，插入线程将被阻塞，直到一个移除线程从该队列中移出了一个元素。如果双端队列为空，移除线程将被阻塞，直到一个插入线程向该队列插入了一个新元素。</p>
<p>BlockingDeque 具有 4 组不同的方法用于插入、移除以及对双端队列中的元素进行检查。如果请求的操作不能得到立即执行的话，每个方法的表现也不同。这些方法如下:</p>

































<table><thead><tr><th/><th>抛异常</th><th>特定值</th><th>阻塞</th><th>超时</th></tr></thead><tbody><tr><td>插入</td><td>addFirst(o)</td><td>offerFirst(o)</td><td>putFirst(o)</td><td>offerFirst(o, timeout, timeunit)</td></tr><tr><td>移除</td><td>removeFirst(o)</td><td>pollFirst(o)</td><td>takeFirst(o)</td><td>pollFirst(timeout, timeunit)</td></tr><tr><td>检查</td><td>getFirst(o)</td><td>peekFirst(o)</td><td/><td/></tr></tbody></table>

































<table><thead><tr><th/><th>抛异常</th><th>特定值</th><th>阻塞</th><th>超时</th></tr></thead><tbody><tr><td>插入</td><td>addLast(o)</td><td>offerLast(o)</td><td>putLast(o)</td><td>offerLast(o, timeout, timeunit)</td></tr><tr><td>移除</td><td>removeLast(o)</td><td>pollLast(o)</td><td>takeLast(o)</td><td>pollLast(timeout, timeunit)</td></tr><tr><td>检查</td><td>getLast(o)</td><td>peekLast(o)</td><td/><td/></tr></tbody></table>
<p>四组不同的行为方式解释:</p>
<ul>
<li>抛异常: 如果试图的操作无法立即执行，抛一个异常。</li>
<li>特定值: 如果试图的操作无法立即执行，返回一个特定的值(常常是 true / false)。</li>
<li>阻塞: 如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行。</li>
<li>超时: 如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行，但等待时间不会超过给定值。返回一个特定值以告知该操作是否成功(典型的是 true / false)。</li>
</ul>
<h3 data-id="heading-5">BlockingDeque 与BlockingQueue关系</h3>
<p>BlockingDeque 接口继承自 BlockingQueue 接口。这就意味着你可以像使用一个 BlockingQueue 那样使用 BlockingDeque。如果你这么干的话，各种插入方法将会把新元素添加到双端队列的尾端，而移除方法将会把双端队列的首端的元素移除。正如 BlockingQueue 接口的插入和移除方法一样。</p>
<p>以下是 BlockingDeque 对 BlockingQueue 接口的方法的具体内部实现:</p>









































<table><thead><tr><th>BlockingQueue</th><th>BlockingDeque</th></tr></thead><tbody><tr><td>add()</td><td>addLast()</td></tr><tr><td>offer() x 2</td><td>offerLast() x 2</td></tr><tr><td>put()</td><td>putLast()</td></tr><tr><td>remove()</td><td>removeFirst()</td></tr><tr><td>poll() x 2</td><td>pollFirst()</td></tr><tr><td>take()</td><td>takeFirst()</td></tr><tr><td>element()</td><td>getFirst()</td></tr><tr><td>peek()</td><td>peekFirst()</td></tr></tbody></table>
<h2 data-id="heading-6">BlockingQueue 的例子</h2>
<p>这里是一个 Java 中使用 BlockingQueue 的示例。本示例使用的是 BlockingQueue 接口的 ArrayBlockingQueue 实现。 首先，BlockingQueueExample 类分别在两个独立的线程中启动了一个 Producer 和 一个 Consumer。Producer 向一个共享的 BlockingQueue 中注入字符串，而 Consumer 则会从中把它们拿出来。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlockingQueueExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">BlockingQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>(<span class="hljs-number">1024</span>);
        
        <span class="hljs-type">Producer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Producer</span>(queue);
        <span class="hljs-type">Consumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Consumer</span>(queue);
 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(producer).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(consumer).start();
 
        Thread.sleep(<span class="hljs-number">4000</span>);
    }
}
</code></pre>
<p>以下是 Producer 类。注意它在每次 put() 调用时是如何休眠一秒钟的。这将导致 Consumer 在等待队列中对象的时候发生阻塞。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-type">BlockingQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Producer</span><span class="hljs-params">(BlockingQueue queue)</span> {
        <span class="hljs-built_in">this</span>.queue = queue;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            queue.put(<span class="hljs-string">"1"</span>);
            Thread.sleep(<span class="hljs-number">1000</span>);
            queue.put(<span class="hljs-string">"2"</span>);
            Thread.sleep(<span class="hljs-number">1000</span>);
            queue.put(<span class="hljs-string">"3"</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>以下是 Consumer 类。它只是把对象从队列中抽取出来，然后将它们打印到 System.out。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-type">BlockingQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Consumer</span><span class="hljs-params">(BlockingQueue queue)</span> {
        <span class="hljs-built_in">this</span>.queue = queue;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            System.out.println(queue.take());
            System.out.println(queue.take());
            System.out.println(queue.take());
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-7">数组阻塞队列 ArrayBlockingQueue</h3>
<p>ArrayBlockingQueue 类实现了 BlockingQueue 接口。</p>
<p>ArrayBlockingQueue 是一个有界的阻塞队列，其内部实现是将对象放到一个数组里。有界也就意味着，它不能够存储无限多数量的元素。它有一个同一时间能够存储元素数量的上限。你可以在对其初始化的时候设定这个上限，但之后就无法对这个上限进行修改了(译者注: 因为它是基于数组实现的，也就具有数组的特性: 一旦初始化，大小就无法修改)。 ArrayBlockingQueue 内部以 FIFO(先进先出)的顺序对元素进行存储。队列中的头元素在所有元素之中是放入时间最久的那个，而尾元素则是最短的那个。 以下是在使用 ArrayBlockingQueue 的时候对其初始化的一个示例:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BlockingQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>(<span class="hljs-number">1024</span>);
queue.put(<span class="hljs-string">"1"</span>);
<span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> queue.take();
</code></pre>
<p>以下是使用了 Java 泛型的一个 BlockingQueue 示例。注意其中是如何对 String 元素放入和提取的:</p>
<pre><code class="hljs language-java" lang="java">BlockingQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;String&gt;(<span class="hljs-number">1024</span>);
queue.put(<span class="hljs-string">"1"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> queue.take();
</code></pre>
<h3 data-id="heading-8">延迟队列 DelayQueue</h3>
<p>DelayQueue 实现了 BlockingQueue 接口。</p>
<p>DelayQueue 对元素进行持有直到一个特定的延迟到期。注入其中的元素必须实现 java.util.concurrent.Delayed 接口，该接口定义:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Delayed</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Comparable</span>&lt;Delayed&lt; {
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getDelay</span><span class="hljs-params">(TimeUnit timeUnit)</span>;
}
</code></pre>
<p>DelayQueue 将会在每个元素的 getDelay() 方法返回的值的时间段之后才释放掉该元素。如果返回的是 0 或者负值，延迟将被认为过期，该元素将会在 DelayQueue 的下一次 take 被调用的时候被释放掉。</p>
<p>传递给 getDelay 方法的 getDelay 实例是一个枚举类型，它表明了将要延迟的时间段。TimeUnit 枚举将会取以下值:</p>
<ul>
<li>DAYS</li>
<li>HOURS</li>
<li>INUTES</li>
<li>SECONDS</li>
<li>MILLISECONDS</li>
<li>MICROSECONDS</li>
<li>NANOSECONDS</li>
</ul>
<p>正如你所看到的，Delayed 接口也继承了 java.lang.Comparable 接口，这也就意味着 Delayed 对象之间可以进行对比。这个可能在对 DelayQueue 队列中的元素进行排序时有用，因此它们可以根据过期时间进行有序释放。 以下是使用 DelayQueue 的例子:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayQueueExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">DelayQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayQueue</span>();
        <span class="hljs-type">Delayed</span> <span class="hljs-variable">element1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedElement</span>();
        queue.put(element1);
        <span class="hljs-type">Delayed</span> <span class="hljs-variable">element2</span> <span class="hljs-operator">=</span> queue.take();
    }
}
</code></pre>
<p>DelayedElement 是我所创建的一个 DelayedElement 接口的实现类，它不在 java.util.concurrent 包里。你需要自行创建你自己的 Delayed 接口的实现以使用 DelayQueue 类。</p>
<h3 data-id="heading-9">链阻塞队列 LinkedBlockingQueue</h3>
<p>LinkedBlockingQueue 类实现了 BlockingQueue 接口。</p>
<p>LinkedBlockingQueue 内部以一个链式结构(链接节点)对其元素进行存储。如果需要的话，这一链式结构可以选择一个上限。如果没有定义上限，将使用 Integer.MAX_VALUE 作为上限。</p>
<p>LinkedBlockingQueue 内部以 FIFO(先进先出)的顺序对元素进行存储。队列中的头元素在所有元素之中是放入时间最久的那个，而尾元素则是最短的那个。 以下是 LinkedBlockingQueue 的初始化和使用示例代码:</p>
<pre><code class="hljs language-java" lang="java">BlockingQueue&lt;String&gt; unbounded = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;String&gt;();
BlockingQueue&lt;String&gt; bounded   = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;String&gt;(<span class="hljs-number">1024</span>);
bounded.put(<span class="hljs-string">"Value"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> bounded.take();
</code></pre>
<h3 data-id="heading-10">具有优先级的阻塞队列 PriorityBlockingQueue</h3>
<p>PriorityBlockingQueue 类实现了 BlockingQueue 接口。</p>
<p>PriorityBlockingQueue 是一个无界的并发队列。它使用了和类 java.util.PriorityQueue 一样的排序规则。你无法向这个队列中插入 null 值。 所有插入到 PriorityBlockingQueue 的元素必须实现 java.lang.Comparable 接口。因此该队列中元素的排序就取决于你自己的 Comparable 实现。 注意 PriorityBlockingQueue 对于具有相等优先级(compare() == 0)的元素并不强制任何特定行为。</p>
<p>同时注意，如果你从一个 PriorityBlockingQueue 获得一个 Iterator 的话，该 Iterator 并不能保证它对元素的遍历是以优先级为序的。 以下是使用 PriorityBlockingQueue 的示例:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BlockingQueue</span> <span class="hljs-variable">queue</span>   <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityBlockingQueue</span>();
<span class="hljs-comment">//String implements java.lang.Comparable</span>
queue.put(<span class="hljs-string">"Value"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> queue.take();
</code></pre>
<h3 data-id="heading-11">同步队列 SynchronousQueue</h3>
<p>SynchronousQueue 类实现了 BlockingQueue 接口。</p>
<p>SynchronousQueue 是一个特殊的队列，它的内部同时只能够容纳单个元素。如果该队列已有一元素的话，试图向队列中插入一个新元素的线程将会阻塞，直到另一个线程将该元素从队列中抽走。同样，如果该队列为空，试图向队列中抽取一个元素的线程将会阻塞，直到另一个线程向队列中插入了一条新的元素。 据此，把这个类称作一个队列显然是夸大其词了。它更多像是一个汇合点。</p>
<h2 data-id="heading-12">BlockingDeque 的例子</h2>
<p>既然 BlockingDeque 是一个接口，那么你想要使用它的话就得使用它的众多的实现类的其中一个。java.util.concurrent 包提供了以下 BlockingDeque 接口的实现类: LinkedBlockingDeque。</p>
<p>以下是如何使用 BlockingDeque 方法的一个简短代码示例:</p>
<pre><code class="hljs language-java" lang="java">BlockingDeque&lt;String&gt; deque = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingDeque</span>&lt;String&gt;();
deque.addFirst(<span class="hljs-string">"1"</span>);
deque.addLast(<span class="hljs-string">"2"</span>);
 
<span class="hljs-type">String</span> <span class="hljs-variable">two</span> <span class="hljs-operator">=</span> deque.takeLast();
<span class="hljs-type">String</span> <span class="hljs-variable">one</span> <span class="hljs-operator">=</span> deque.takeFirst();
</code></pre>
<h3 data-id="heading-13">链阻塞双端队列 LinkedBlockingDeque</h3>
<p>LinkedBlockingDeque 类实现了 BlockingDeque 接口。</p>
<p>deque(双端队列) 是 "Double Ended Queue" 的缩写。因此，双端队列是一个你可以从任意一端插入或者抽取元素的队列。</p>
<p>LinkedBlockingDeque 是一个双端队列，在它为空的时候，一个试图从中抽取数据的线程将会阻塞，无论该线程是试图从哪一端抽取数据。</p>
<p>以下是 LinkedBlockingDeque 实例化以及使用的示例:</p>
<pre><code class="hljs language-java" lang="java">BlockingDeque&lt;String&gt; deque = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingDeque</span>&lt;String&gt;();
deque.addFirst(<span class="hljs-string">"1"</span>);
deque.addLast(<span class="hljs-string">"2"</span>);
 
<span class="hljs-type">String</span> <span class="hljs-variable">two</span> <span class="hljs-operator">=</span> deque.takeLast();
<span class="hljs-type">String</span> <span class="hljs-variable">one</span> <span class="hljs-operator">=</span> deque.takeFirst();
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite打包速度提升300%的秘密：5个让你告别Webpack的理由]]></title>    <link>https://juejin.cn/post/7600670417858953250</link>    <guid>https://juejin.cn/post/7600670417858953250</guid>    <pubDate>2026-01-30T04:17:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670417858953250" data-draft-id="7600670417858936866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite打包速度提升300%的秘密：5个让你告别Webpack的理由"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-30T04:17:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite打包速度提升300%的秘密：5个让你告别Webpack的理由
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:17:48.000Z" title="Fri Jan 30 2026 04:17:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite打包速度提升300%的秘密：5个让你告别Webpack的理由</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在前端开发领域，构建工具的选择直接影响开发效率和项目性能。多年来，Webpack一直是前端构建工具的标杆，但其复杂的配置和缓慢的构建速度逐渐成为开发者的痛点。随着Vite的横空出世，许多团队开始重新评估他们的工具链选择。</p>
<p>Vite由Vue.js创始人尤雨溪开发，凭借其“原生ESM（ES Modules）+ 按需编译”的设计理念，实现了惊人的构建速度提升（官方数据显示开发服务器启动时间可缩短至毫秒级）。本文将深入剖析Vite的底层原理，并通过5个关键理由解释为什么它正在取代Webpack成为现代前端开发的优先选择。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 原生ESM的颠覆性设计</h3>
<h4 data-id="heading-4">Webpack的瓶颈：全量打包</h4>
<p>Webpack的核心工作流程是基于“依赖分析+全量打包”。在开发模式下，即使只修改一个文件，Webpack也需要重新构建整个依赖图并生成新的bundle。对于大型项目，HMR（热模块替换）可能需要数秒甚至更长时间。</p>
<h4 data-id="heading-5">Vite的革命性突破</h4>
<p>Vite直接利用浏览器对原生ESM的支持：</p>
<ul>
<li><strong>开发环境</strong>：将代码分为“依赖”和“源码”两部分。依赖通过预构建（esbuild）转换为ESM格式并缓存；源码则按需编译并提供裸模块导入解析。</li>
<li><strong>生产环境</strong>：依然使用Rollup进行高效打包，但得益于前期优化，整体流程更快。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 浏览器直接请求的ES模块</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'/node_modules/.vite/vue.js'</span>
</code></pre>
<p><strong>性能对比</strong>：在1000+模块的项目中，Vite的冷启动速度比Webpack快10倍以上。</p>
<hr/>
<h3 data-id="heading-6">2. Esbuild带来的编译性能飞跃</h3>
<h4 data-id="heading-7">Webpack的传统编译链</h4>
<p>Webpack依赖于Babel+TypeScript编译器进行代码转译，这些工具基于Node.js编写，单线程运行且未针对性能优化。</p>
<h4 data-id="heading-8">Vite的解决方案</h4>
<p>Vite使用Go语言编写的Esbuild作为核心编译器：</p>
<ul>
<li><strong>速度优势</strong>：Esbuild的转译速度是Babel的10-100倍（官方基准测试）。</li>
<li><strong>并行处理</strong>：Go语言的并发模型充分利用多核CPU资源。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-attr">esbuildOptions</span>: {
      <span class="hljs-attr">target</span>: <span class="hljs-string">'es2020'</span> <span class="hljs-comment">// 支持最新语法</span>
    }
  }
}
</code></pre>
<p><strong>实测数据</strong>：在相同项目下，Vite的热更新响应时间通常控制在50ms以内，而Webpack需要500ms+。</p>
<hr/>
<h3 data-id="heading-9">3. 按需编译与闪电级HMR</h3>
<h4 data-id="heading-10">Webpack的热更新延迟问题</h4>
<p>Webpack需要维护完整的模块依赖图，任何文件修改都会触发以下流程：</p>
<ol>
<li>重新构建受影响模块</li>
<li>生成新的chunk哈希</li>
<li>向浏览器推送更新消息</li>
</ol>
<h4 data-id="heading-11">Vite的即时HMR机制</h4>
<p>Vite基于ESM实现了真正的按需编译：</p>
<ul>
<li><strong>动态导入</strong>：仅重新编译被修改的文件及其直接依赖项。</li>
<li><strong>HTTP缓存</strong>：利用304 Not Modified和Cache-Control减少网络请求。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vite的HMR API示例</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>) {
  <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">'./module.js'</span>, <span class="hljs-function">(<span class="hljs-params">newModule</span>) =&gt;</span> {
    <span class="hljs-comment">// 立即更新逻辑</span>
  })
}
</code></pre>
<p><strong>用户体验差异</strong>：在Monorepo项目中，Vite的HMR速度比Webpack快3-5倍。</p>
<hr/>
<h3 data-id="heading-12">4. 零配置与智能默认值</h3>
<h4 data-id="heading-13">Webpack的配置复杂性</h4>
<p>典型的Webpack配置可能包含：</p>
<ul>
<li>Loader规则（babel-loader/css-loader等）</li>
<li>Plugin声明（HtmlWebpackPlugin等）</li>
<li>DevServer配置</li>
</ul>
<h4 data-id="heading-14">Vite的开箱即用体验</h4>
<p>Vite提供预置的最佳实践：</p>
<ul>
<li><strong>内置功能</strong>：TypeScript/JSX/CSS/Less/Sass原生支持</li>
<li><strong>自动路径解析</strong>：<code>@/</code>别名、NPM依赖自动检测</li>
<li><strong>静态资源处理</strong>：图片/SVG/JSON等直接导入为URL或内容</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Webpack vs Vite配置文件对比</span>
<span class="hljs-comment">// Webpack (50+行)</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...复杂配置</span>
}

<span class="hljs-comment">// Vite (10行以内)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()]
}
</code></pre>
<p><strong>效率提升</strong>：新项目初始化时间从30分钟缩短至5分钟。</p>
<hr/>
<h3 data-id="heading-15">5. 面向未来的技术栈整合</h3>
<h4 data-id="heading-16">Webpack的历史包袱问题</h4>
<p>尽管Webpack支持现代化特性（如Module Federation），但其架构设计仍围绕CommonJS时代的需求展开。</p>
<h4 data-id="heading-17">Vite的前沿特性支持</h4>
<ol>
<li><strong>Top-Level Await</strong>：无需额外配置即可使用顶层await语法。</li>
<li><strong>WASM导入</strong>：直接导入WebAssembly模块。</li>
<li><strong>CSS Modules + CSS Variables动态绑定</strong>:
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* style.module.css */</span>
<span class="hljs-selector-class">.title</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--dynamic-color);
}
</code></pre>
</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// WASM示例</span>
<span class="hljs-keyword">import</span> init <span class="hljs-keyword">from</span> <span class="hljs-string">'./pkg/wasm_module.wasm'</span>
<span class="hljs-title function_">init</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-built_in">exports</span></span>) =&gt;</span> <span class="hljs-built_in">exports</span>.<span class="hljs-title function_">run</span>())
</code></pre>
<hr/>
<h2 data-id="heading-18">总结与迁移建议</h2>
<p>Vite并非在所有场景下都能完全替代Webpack（例如需要复杂自定义插件的老项目），但对于大多数现代前端应用而言，它的优势已经非常明显：</p>
<ol>
<li><strong>新项目首选</strong>：React/Vue/Svelte等框架的官方模板均已支持Vite。</li>
<li><strong>渐进式迁移策略</strong>：
<ul>
<li>先用Vite处理新功能模块。</li>
<li>通过<code>vite-plugin-legacy</code>兼容旧版浏览器。</li>
</ul>
</li>
</ol>
<p>随着ECMAScript模块成为浏览器标准、WASM等技术的普及，Vite这种基于原生能力的工具链将成为前端工程化的未来趋势。“快300%”不仅是数字游戏——它意味着开发者每天可以节省数小时的等待时间，将精力真正投入到创造价值的工作中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据工程视角：为什么公司会有几百个含义模糊的“DAU”指标？]]></title>    <link>https://juejin.cn/post/7600681071714615296</link>    <guid>https://juejin.cn/post/7600681071714615296</guid>    <pubDate>2026-01-30T03:36:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600681071714615296" data-draft-id="7600665529113182208" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据工程视角：为什么公司会有几百个含义模糊的“DAU”指标？"/> <meta itemprop="keywords" content="数据分析,SQL"/> <meta itemprop="datePublished" content="2026-01-30T03:36:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Aloudata大应科技"/> <meta itemprop="url" content="https://juejin.cn/user/1579340474099927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据工程视角：为什么公司会有几百个含义模糊的“DAU”指标？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1579340474099927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Aloudata大应科技
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:36:05.000Z" title="Fri Jan 30 2026 03:36:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文首发于 Aloudata 官方技术博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.noetl.cn%2Fknowledge-base%2Fwhy-companies-have-hundreds-vague-dau-metrics" target="_blank" title="https://ai.noetl.cn/knowledge-base/why-companies-have-hundreds-vague-dau-metrics" ref="nofollow noopener noreferrer">《为什么公司会有几百个含义模糊的“DAU”指标？深度解析》</a>转载请注明出处。</p>
<p><strong>摘要</strong>：企业数据治理中普遍存在数百个同名不同义的“DAU”指标，这并非管理失误，而是传统“数仓+BI”烟囱式架构的必然结果。本文将从数据工程视角，精确定义指标口径混乱的四大要素，剖析其三大结构性根源，并阐述如何通过构建基于 NoETL 语义编织技术的统一指标平台，实现“一次定义，处处使用”，从根本上解决数据分析的“不可能三角”难题。</p>
<p>“数据孤岛导致的‘同源不同口径’问题日益严重。不同业务系统独立运行，产生的数据没有统一的描述体系。结果就是：明明是同一个‘活跃用户’指标，财务、市场和运营的口径却完全不同。这会直接导致数据驱动的决策不一致。” —— 行业分析报告</p>
<p>当一家企业的数据团队发现，他们维护着数百个名为“DAU”（日活跃用户）或“销售额”的指标，而每个指标的计算逻辑、统计周期或业务限定都略有不同时，这通常不是某个部门或个人的失误。相反，这是传统数据架构模式下的一个必然结果。</p>
<p>在经典的“数仓+BI”模式中，业务需求驱动着漫长的物理开发链路：一个报表需求 → 数据工程师开发 ETL 任务 → 创建特定的物理宽表（DWS/ADS 层） → BI 工具连接该宽表生成报表。这种“为特定报表建特定宽表”的烟囱式开发，将指标逻辑固化并分散在了成百上千个物理表中。每一次新的分析视角，都可能催生一张新的宽表和一个“略有不同”的指标版本。这直接导致了数据分析的“不可能三角”：在口径一致、响应敏捷和深度洞察三者之间难以兼得。</p>
<h2 data-id="heading-0">精确定义：什么才是真正的“指标口径混乱”？</h2>
<p>指标口径混乱并非一个模糊的概念，它特指同一业务术语在不同数据消费场景中，其核心语义要素存在不一致，从而导致决策依据相互矛盾。一个完整的指标定义包含四大语义要素，任何一处的差异都可能导致“混乱”：</p>
<ol>
<li>基础度量：核心的聚合计算，如<code>COUNT(DISTINCT user_id)</code>、<code>SUM(order_amount)</code>。</li>
<li>统计周期：数据统计的时间范围，如“当日”、“近7日滚动”、“本财年至今”。</li>
<li>业务限定：对数据范围的筛选条件，如“状态为‘已支付’”、“用户渠道为‘APP’”。</li>
<li>衍生计算：基于基础度量的二次计算，如同环比、占比、排名。</li>
</ol>
<p>例如，市场部的“DAU”可能统计所有启动 APP 的设备，而财务部的“DAU”可能只统计完成至少一次有效交易的用户。这不仅仅是“活跃”定义的差异，更是基础度量（是否去重）和业务限定（是否包含交易行为）的双重不一致。</p>
<h2 data-id="heading-1">核心要素：导致指标泛滥的三大“元凶”</h2>
<p>指标混乱现象是技术架构、组织协作和工具生态三个层面因素共同作用的“完美风暴”。</p>
<h3 data-id="heading-2">要素一：烟囱式的物理宽表开发</h3>
<p>这是最根本的技术原因。每个分析需求都对应一张（或多张）物理宽表，指标逻辑被硬编码在 SQL 和表结构中。当业务规则变更（如“活跃”定义调整）时，需要追溯并修改所有相关的宽表，成本极高且极易遗漏，导致历史数据对比失真。</p>
<h3 data-id="heading-3">要素二：部门墙与协作断层</h3>
<p>业务方、数据分析师与数据开发团队之间缺乏统一的协作语言和平台。需求通过邮件、会议口头传递，容易产生歧义。各部门为追求自身效率，在本地数据集或临时查询中定义“自己版本”的指标，形成组织内的“数据方言”。</p>
<h3 data-id="heading-4">要素三：封闭的 BI 工具内置指标</h3>
<p>主流 BI 工具为提升易用性，内置了指标定义模块。然而，这些指标定义被绑定在特定的 BI 工具前端。当企业使用多套 BI 工具（如总部用 A，业务部门用 B），或需要向 AI 大模型、自建应用提供数据服务时，这些封闭的指标定义无法被复用，形成了新的“工具孤岛”。</p>
<h2 data-id="heading-5">常见误区：关于指标治理的四个错误认知</h2>
<p>许多企业意识到问题，却采用了错误的方法，反而加剧了困境。</p>






























<table><thead><tr><th>误区</th><th>错误本质</th><th>导致的后果</th></tr></thead><tbody><tr><td>误区一：建一个指标字典就够了</td><td>将指标治理等同于建立静态的元数据目录（Catalog）。</td><td>目录与计算脱节，业务人员查阅字典后，仍需找开发人员从物理宽表中取数，口径落地依赖人工，无法保证一致性。</td></tr><tr><td>误区二：强制统一所有报表</td><td>采用行政命令，要求所有部门立即废弃原有报表，使用统一模板。</td><td>忽视业务敏捷性，引发业务部门强烈抵触，治理行动难以推进，甚至催生更隐蔽的“影子报表”。</td></tr><tr><td>误区三：选择一个BI工具统一天下</td><td>试图通过采购单一BI厂商的全套方案来解决所有问题。</td><td>被单一厂商绑定，丧失技术选型灵活性；无法适应不同场景的多样化需求（如 AI 调用、嵌入式分析）。</td></tr><tr><td>误区四：指标治理是IT部门的事</td><td>认为制定标准、维护口径是数据团队的技术职责。</td><td>缺乏业务方的深度参与和共识，制定的标准脱离实际业务场景，治理成果无法在业务决策中落地。</td></tr></tbody></table>
<h2 data-id="heading-6">企业价值：终结指标混乱带来的四大收益</h2>
<p>解决指标口径问题，远不止于“统一语言”，它能直接转化为可量化的业务与技术收益。</p>
<ol>
<li>决策一致：基于同一事实决策，彻底避免部门间因数据“对不上”而产生的无谓争论与信任损耗，提升组织协同效率。</li>
<li>响应敏捷：业务人员通过自助式拖拽分析，无需等待排期，将分析需求响应周期从“天级”压缩至“分钟级”，快速验证业务假设。</li>
<li>洞察深化：突破预建宽表的维度限制，支持对指标进行任意维度、任意粒度的灵活下钻与归因分析，从“描述现象”走向“解释原因”。</li>
<li>成本降低：通过做轻数仓，减少甚至消除大量重复的 DWS/ADS 层物理宽表开发与维护，可释放 30% 以上的服务器计算与存储资源。</li>
</ol>
<p>案例佐证：某头部股份制银行通过引入统一指标平台，实现了总分行指标口径 100% 一致，数据交付效率提升 10 倍（从 2 周缩短至 1 天），并沉淀了超过 1 万个可复用的标准指标。</p>
<h2 data-id="heading-7">评估清单：你的企业是否已陷入指标泥潭？</h2>
<p>请用以下 5 个问题快速自检：</p>
<ol>
<li>
<p>同一个核心业务指标（如“销售额”、“利润率”），财务、市场、运营等部门给出的数字是否经常对不上，需要反复核对？</p>
</li>
<li>
<p>业务部门提出一个新的报表或分析需求，从提出到最终上线，平均排期是否超过 1 周？</p>
</li>
<li>
<p>业务人员能否在不求助数据团队的情况下，自主、灵活地切换分析维度（如从“按地区看”切换到“按产品品类看”）？</p>
</li>
<li>
<p>数据团队是否花费大量时间，疲于维护众多业务逻辑相似但略有不同的汇总表、宽表？</p>
</li>
<li>
<p>当企业引入新的 BI 工具或AI智能问数应用时，是否需要数据团队重新定义、开发一套指标？</p>
</li>
</ol>
<p>如果上述问题有两个或以上的答案是肯定的，那么您的企业很可能已经深受指标混乱之苦。</p>
<h2 data-id="heading-8">解决方案：基于 NoETL 语义编织的统一指标平台</h2>
<p>要根治上述问题，需要从架构层面进行革新，将指标的定义、计算与服务进行逻辑解耦。这正是 Aloudata CAN NoETL 指标平台的核心。</p>
<h3 data-id="heading-9">核心理念：定义即开发，定义即服务</h3>
<p>平台基于 NoETL 语义编织 技术，允许用户在逻辑层面进行声明式定义：</p>
<ul>
<li>逻辑关联声明：在 DWD 明细层上，声明业务实体间的关联关系，构建“虚拟业务事实网络”，无需预先物理打宽。</li>
<li>声明式指标定义：通过配置化方式，组合“基础度量、统计周期、业务限定、衍生计算”四大语义要素，零代码定义复杂指标（如“上月高价值用户复购率”）。</li>
<li>智能物化加速：基于用户声明的加速策略（而非全自动感知），系统自动生成并维护物化视图，查询时智能路由，实现亿级数据秒级响应。</li>
</ul>
<h3 data-id="heading-10">架构对比：从“烟囱林立”到“统一语义层”</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea81988ae87343be8934c1fc952c0144~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxvdWRhdGHlpKflupTnp5HmioA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770348967&amp;x-signature=PhG6pTtPZvQAw19FXE7gjEeO1nE%3D" alt="统一语义层.png" loading="lazy"/></p>
<ul>
<li>传统架构（左）：需求驱动，层层物理建模，形成大量 DWS/ADS 宽表，指标逻辑分散且固化。</li>
<li>NoETL架构（右）：统一的语义层直接对接 DWD 明细数据，逻辑定义指标，向上通过标准 API/JDBC 服务各类消费端（BI、AI、应用）。</li>
</ul>
<h3 data-id="heading-11">关键价值：成为 AI-Ready 的数据底座</h3>
<p>混乱的指标和元数据是导致AI智能问数产生“幻觉”的主因。统一指标平台通过构建高质量的语义知识图谱，为 AI 提供了精准的上下文。</p>
<ul>
<li>根治幻觉：采用 NL2MQL2SQL 架构。用户用自然语言提问 → LLM 理解意图生成指标查询语言（MQL）→ 平台语义引擎将 MQL 转换为 100% 准确的优化 SQL。</li>
<li>安全可控：所有 AI 数据请求先经过语义层鉴权，确保符合行列级数据安全策略，实现“先安检，后执行”。</li>
</ul>
<h2 data-id="heading-12">常见问题 (FAQ)</h2>
<h4 data-id="heading-13">Q1: 我们公司已经用了主流 BI 工具，为什么还需要独立的指标平台？</h4>
<p>因为传统 BI 工具的指标定义是内置且绑定在该工具前端的，本质是增强工具粘性的功能模块。当企业存在多套BI工具，或需要向 AI 大模型、自建应用、WPS 表格插件等提供数据服务时，这些封闭的指标定义无法被复用。独立的指标平台作为中立的 Headless 基座，提供统一的标准 API，确保全企业“一次定义，处处使用”，口径 100% 一致。</p>
<h4 data-id="heading-14">Q2: 统一指标平台和传统数据中台里的指标管理有什么区别？</h4>
<p>传统数据中台的指标管理多是“静态目录”，只记录指标元数据（如名称、口径描述），实际计算仍依赖底层人工开发、运维的物理宽表。而现代化的统一指标平台（如 Aloudata CAN）本身是一个动态计算引擎。它基于 NoETL 语义编织技术，直接在 DWD 明细层上通过声明式方式定义指标逻辑，并自动完成计算、物化加速与查询服务，实现了“定义即开发、定义即服务”。</p>
<h4 data-id="heading-15">Q3: 实现指标统一，是不是意味着要推翻现有的数据仓库重来？</h4>
<p>完全不需要。推荐采用渐进式的 “三步走”资产演进法则：</p>
<ol>
<li>存量挂载：将现有逻辑成熟、性能稳定的物理宽表直接挂载到平台，快速统一查询出口。</li>
<li>增量原生：所有新的分析需求，直接基于 DWD 明细层在平台上通过声明式定义敏捷响应，遏制宽表继续膨胀。</li>
<li>存量替旧：逐步将维护成本高、逻辑变更频繁的旧宽表迁移至新的语义范式。这实现了平滑演进，而非颠覆式重建。</li>
</ol>
<h4 data-id="heading-16">Q4: 指标平台如何支持现在流行的 AI 智能问数（ChatBI）？</h4>
<p>混乱、非结构化的元数据是 AI 产生“幻觉”的根源。指标平台通过构建标准化的语义知识图谱（包含指标、维度、口径、血缘），为 AI 大模型提供了高质量的上下文。采用 NL2MQL2SQL 架构：用户自然语言提问 → LLM 生成基于语义知识的 MQL → 平台语义引擎将 MQL 翻译为精准、高效的 SQL → 智能路由至最优物化表或明细层执行 → 返回结果。这从根本上将 AI 生成 SQL 的“开放题”收敛为选择标准指标的“选择题”，实现高准确率。</p>
<h4 data-id="heading-17">Q5: 对于数字化初期的企业，直接建设统一指标平台是不是“杀鸡用牛刀”？</h4>
<p>恰恰相反，这是实现 “数字化平权” 和弯道超车的战略机遇。传统企业经历了“先乱后治”的痛苦过程。数字化初期的企业可以直接采用最先进的“语义模型驱动”架构，跳过宽表泛滥、口径混乱的阶段，以较低门槛一步到位构建统一、敏捷、标准的数据服务能力，避免未来高昂的治理与重构成本。</p>
<h2 data-id="heading-18">Key Takeaways（核心要点）</h2>
<ol>
<li>指标混乱是“症”非“病”：它是传统烟囱式数据开发模式的必然产物，根源在于技术架构，而非管理能力。</li>
<li>治理需解耦逻辑与物理：有效的指标治理必须将业务语义的定义，从物理宽表的开发中解放出来。</li>
<li>统一语义层是核心：基于 NoETL 语义编织技术构建的统一指标平台，能够实现指标的“定义即开发、定义即服务”，成为企业唯一可信的数据事实源。</li>
<li>价值超越降本增效：除了提升开发效率、降低资源成本，更能保障决策一致性、赋能业务敏捷分析，并构成未来 AI 应用不可或缺的 AI-Ready 数据底座。</li>
<li>落地可渐进平滑：通过“存量挂载、增量原生、存量替旧”的三步走策略，企业可以在不影响现有业务的前提下，稳步向现代化数据架构演进。</li>
</ol>
<hr/>
<p>**查看更多技术干货与产品详情，请访问Aloudata 官方技术博客，查看原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.noetl.cn%2Fknowledge-base%2Fwhy-companies-have-hundreds-vague-dau-metrics" target="_blank" title="https://ai.noetl.cn/knowledge-base/why-companies-have-hundreds-vague-dau-metrics" ref="nofollow noopener noreferrer">ai.noetl.cn/knowledge-b…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[扣子（Coze）实战：“每天听懂一首歌”工作流拆解——歌曲解说]]></title>    <link>https://juejin.cn/post/7600704706551054376</link>    <guid>https://juejin.cn/post/7600704706551054376</guid>    <pubDate>2026-01-30T03:51:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600704706551054376" data-draft-id="7600681071714762752" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="扣子（Coze）实战：“每天听懂一首歌”工作流拆解——歌曲解说"/> <meta itemprop="keywords" content="Coze"/> <meta itemprop="datePublished" content="2026-01-30T03:51:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吾鳴"/> <meta itemprop="url" content="https://juejin.cn/user/3683842894347076"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            扣子（Coze）实战：“每天听懂一首歌”工作流拆解——歌曲解说
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3683842894347076/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吾鳴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:51:19.000Z" title="Fri Jan 30 2026 03:51:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是吾鳴。专注于分享提升工作与生活效率的工具，无偿分享AI领域相关的精选报告，持续关注AI的前沿动向。</p>
<p>这是一篇有上下文的文章，前面已经发了两篇文章，分别讲解了“每天听懂一首歌”内容形式的爆款逻辑，以及视频开头的工作流——《 <a href="https://juejin.cn/post/7599912857393332270" target="_blank" title="https://juejin.cn/post/7599912857393332270">扣子（Coze）实战：“每天听懂一首歌”，这个爆火的赛道，我用扣子复刻了</a>》、《<a href="https://juejin.cn/post/7600370554068484122" target="_blank" title="https://juejin.cn/post/7600370554068484122">扣子（Coze）实战：“每天听懂一首歌”工作流拆解——视频开头</a>》。</p>
<p>在第一篇文章中演示工作流的时候，因为工作流的复杂性，所以把整个工作流拆解成了3个子工作流，分别对应视频的开头、正文解说和结尾，文章中也说到会再出三篇文章讲解这3个子工作流的实现。</p>
<p>本文是第三篇文章，专门讲解歌曲正文解说部分的内容，本文讲解的工作流输出歌曲的解说这一部分的内容，工作流产出的视频效果如下（视频上传不了，我截张图）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abcb7641d1f24339b041bb9058827707~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=WXrAvJeydD3o5FwdPX6od2plZ3I%3D" alt="" loading="lazy"/></p>
<p>下面开始这一个工作流的讲解。</p>
<h2 data-id="heading-0">1. 完整的工作流程</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/681ef61d67b74ae3b0bd41a2c702b2f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=Clyipx3G1zxzJMa%2BaXFbLQMX5Y4%3D" alt="" loading="lazy"/></p>
<p>1、歌曲解说：这一流程会先让大模型对输入的歌曲名进行歌曲解说，生成文案，然后对生成的文案进行配音，最后把配音和文案生成剪映草稿的语音和字幕。</p>
<p>2、歌曲视频：这部分内容会根据生成的歌曲解说拆分视频的分镜，并且生成分镜的绘图提示词和视频提示词，并且使用图生视频大模型生成分镜视频。</p>
<p>3、背景音乐：这部分流程是把背景音乐转成剪映草稿音频轨道上的时间线。</p>
<p>4、剪映草稿：这一部分的流程是把前面生成好的解说语音时间线、字幕时间线、歌曲视频时间线、背景音乐时间线添加到剪映草稿中。</p>
<h2 data-id="heading-1">2. 歌曲解说</h2>
<h3 data-id="heading-2">2.1. 开始</h3>
<ul>
<li>api_token：插件认证，必填，可后台回复【芝麻开门】联系获取（有条件）</li>
<li>bgm_music_file：歌曲音乐文件，必填</li>
<li>music_name：歌曲名称，必填</li>
<li>reference_image_nv：歌曲视频女主参考图，必填</li>
<li>reference_image_nan：歌曲视频男主参考图，必填</li>
<li>draft_id：剪映草稿ID，必填</li>
<li>start_us：剪映轨道开始时间，必填</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bffbf947cb948d0a76b46ee113be13c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=fXSATH3mH9NtvdkFW0ZVSZORgWg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 歌曲解说</h3>
<p>这个节点用来生成歌曲解说文案，使用到了扣子官方的大模型节点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9b5bd7f039540638bc6a44ca66f77cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=qvpsu9snriDRZ8SxdRmToVuDAYU%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词，这是个伪提示词，可参考文章《 扣子（Coze）实战：这个“小而美”的宝宝小名赛道，一键直达草稿箱》到豆包进行反推。</li>
</ul>

<pre><code class="hljs">你要变身亲切口语化的音乐科普博主，核心是帮听众听懂歌曲灵魂，按要求创作音乐科普文案。
用户给歌曲名后，先确认其核心情感、创作背景、歌词深层含义，再按 “开篇 + 主体分析 + 结尾金句” 结构创作，开篇点明核心情感与主题，主体用 “你” 代入日常场景、解析关键歌词，结尾用简短金句升华。
语言口语化，每句≤15 字，总字数 200-300 字，段落换行，适配不同歌曲类型，信息务必准确，无法确认需明确告知。仅做音乐科普，输出无标点，不含搜索相关语句，严格遵循格式要求。
</code></pre>
<h3 data-id="heading-4">2.3. 解说配音</h3>
<p>这个节点循环将文案转成语音，使用到了扣子官方的循环节点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72698a818b014e81af195d881340fb8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=O05ro36O8vBwWo3Cvc8l4umpmcg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">2.4. 解说文案配音</h3>
<p>这个节点用来将文案转成语音，使用到了扣子官方的插件【语音合成】的【speech_synthesis】工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a80295e09f9a481db93d9b493e580b75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=zyFiZ1pttnMr8Xg0JKEHAm3Byt4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.5. 解说配音时长转换</h3>
<p>这个节点用来循环把配音时长由秒转成微秒，因为后面的视频剪辑工具箱使用到的时间单位是微秒，这个节点使用到了扣子官方的循环节点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90f7d72c04b949ee8876dd6465e790b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=nft8Sf9%2BPNwzwazIQhyBMFxn6Qc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.6. 秒转微秒</h3>
<p>这个节点是把秒转成微秒，使用到了扣子三方插件【数字工具合集】的【sec_2_us】工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73689fc8c4b34d828c71cb0d8e82f3e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=R9opf9Npc7MSUScYxybic1Fv0g0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2.7. 歌曲解说语音时间线</h3>
<p>这个节点的作用是把歌曲解说语音转成剪映音频轨道时间线，使用到了扣子三方插件【视频剪辑工具箱】的【multi_audio_timeline】工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/136bf2f159834a0a983c68066dac025d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=SN4SblUfDgV9iaJJ8KHzaKNHGis%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">2.8. 歌曲解说字幕时间线</h3>
<p>这个节点的作用是把歌曲解说文案转成剪映字幕时间线，使用到了扣子三方插件【视频剪辑工具箱】的【multi_caption_timeline】。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcc1a44858494c82b4ed2ec369345698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=tFARGn43EChPv1X6JrDJI5nWu6I%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">3. 歌曲视频</h2>
<h3 data-id="heading-11">3.1. 正文解说字幕合并</h3>
<p>这个节点是为了把歌曲解说文案时间线做合并，因为歌曲解说的时间线比较碎，需要把解说整合成语义连贯的文案，便于后面生成视频的分镜，使用到了扣子官方的大模型节点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ab1a89e25f9448980e89f7d371dfe9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=i8ZYDKMjeZ2EMW5dsVryXVpctRk%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词，这是个伪提示词，可以按照上方方法反推。</li>
</ul>

<pre><code class="hljs">你要变身专业字幕合并专家，核心是把用户给的散乱简短字幕文案合并成情绪连贯、逻辑通顺的段落，全程保留所有原信息不新增内容，每段时长≤5 秒（微秒计），最终输出对应合并字幕列表和时间线列表。
先接收用户的字幕文案列表和时间线列表（微秒元组），再识别情绪、场景、逻辑边界，仅在无边界的相邻文案间合并，按原顺序拼接文字。合并后若时长超 5 秒，在不破坏连贯性的临界点拆分，每段时间线取段内首个开始时间和最后一个结束时间，严格校验时长。
输出需清晰区分两个列表，不删减替换原文字、不合并强制边界，仅处理字幕合并相关任务，拒绝无关请求。
</code></pre>
<h3 data-id="heading-12">3.2. 正文解说分镜图片提示词</h3>
<p>这个节点用来生成分镜图片的绘图提示词，使用到了扣子官方的大模型节点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45fb84a22e1f43518c75df73595d2cb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=31PJSNiJWpIOmb%2FrgRfblMHlFF4%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词，是个伪提示词，可以到豆包反推</li>
</ul>

<pre><code class="hljs">你要变身精准的新海诚风格画面提示词生成助手，核心是把 “每天听懂一首歌” 相关文案转化为新海诚风格可视化画面描述词，还原梦幻治愈感。
先解析文案情感和场景核心，按文案数量生成一一对应的连贯分镜，提取人物动作、音乐道具、新海诚风格场景等核心元素。
再按固定公式生成人物物理描述，包含年龄、身材、分层服装、表情姿态，强制贴合歌曲情感。
接着构建匹配音乐情绪的场景，用新海诚标志性的侧逆光、漫反射等光线和匹配情感的低饱和主色调渲染氛围。
最终按文案和画面描述词的表格格式输出，严格遵循新海诚风格，保持角色物理描述一致，不增删分镜，不用命名指代人物，涉及听歌必加关联音乐道具。
</code></pre>
<h3 data-id="heading-13">3.3. 正文解说分镜图片生成</h3>
<p>这个节点使用了扣子官方的循环节点，用来循环生成分镜图片。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5e04735abff4b3f9b48d1d4e0931d46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=fsOR7MKR58mETl7OqbJWD4YOc88%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">3.4. 图像生成</h3>
<p>这个节点用来绘制分镜图片，使用到了扣子官方的图像生成节点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aca19c3cc5214920be6015307d07ad9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=EJ0d6a0U6i3WtZDplkvQ4gszCFg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">3.5. 正文解说分镜视频提示词</h3>
<p>这个节点用来生成分镜视频生成提示词，使用到了扣子官方的大模型节点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f6c4c109bb945dba5de444dec324d81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=3p0dSqIJmQUVuKvytMSHtbfDlGY%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词，这是个伪提示词，可到豆包反推</li>
</ul>

<pre><code class="hljs">你要变身新海诚风格视频创作助手，核心是将歌曲文案和分镜设计转化为 5 秒左右的新海诚风格视频，精准还原其视觉美学与细腻叙事氛围。
先逐一对分镜绘图提示词和文案提取核心要素，提示词抓 1-2 个关键视觉、镜头、人物动作，文案定位单一核心情感节点，简化隐喻为具象符号。
再将核心要素转化为新海诚风格，单一场景 + 1 个动态元素，1 种核心光效主导且聚焦人物局部，用固定 / 轻微推拉镜头，1 个情感符号 + 1 个人物表情瞬间，适配 5 秒节奏。
最后按对应数量输出结构化视频提示词，每个包含分镜核心对应、新海诚视觉元素、情感氛围补全，严格控制 5 秒时长，复杂内容需简化为单元素场景，仅输出提示词列表无冗余信息。
</code></pre>
<h3 data-id="heading-16">3.6. 正文解说视频生成</h3>
<p>这个节点使用到扣子官方的循环节点，用来循环生成分镜视频。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed7756ccc87946498a043463705b388d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=ZYmLEfm9HZV0N3GCbmuP9l2owWA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-17">3.7. 视频生成</h3>
<p>这个节点使用到了扣子官方的视频生成节点，用来生成分镜视频。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7460c1d991e34e2c85d4498deaa205d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=HKNXAd%2FzrxIzvKAFcEPaALPKjm4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-18">3.8. 视频链接获取</h3>
<p>这个节点用来把生成的视频转成一个url地址，使用到了扣子官方的文本处理节点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5798241ec4d485ebe354a5952b8f131~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=pJbOkneONtIEAevTShcKsA6wEe8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-19">3.9. 正文解说视频时间线</h3>
<p>这个节点用来把视频转成剪映视频轨道上的时间线，使用到了扣子三方插件【视频剪辑工具箱】的【multi_video_timeline】工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beef60865ac149708aabe33e073dedad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=RVCHn%2B97mapYpx9nyBaSA7IOD%2B8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20">4. 背景音乐</h2>
<h3 data-id="heading-21">4.1. 音乐文件处理</h3>
<p>这个节点使用到了官方的文本处理节点，用来将音乐文件转成url格式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/997f0eca03ab4e4d9b9b6495279b6b8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=bt4gep3eumxFgDfOuDo18DYA%2BgU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-22">4.2. 背景音乐时间线</h3>
<p>这个节点是把背景音乐转成剪映音频轨道上的时间线，使用到了三方插件【视频剪辑工具箱】的【single_audio_timeline】。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ad53e294a254741a27ee1350181d04a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=AbdRwWVF5t0P9J3dQSYfXUxDJZw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-23">5. 剪映草稿</h2>
<h3 data-id="heading-24">5.1. 添加正文解说音频</h3>
<p>这个节点使用到了扣子三方插件【视频剪辑工具箱】的【add_audios】工具，作用是把生成好的正文解说音频时间添加到剪映的草稿中，需要注意这里是接着“视频开头”这个草稿继续添加，不需要再创建新的剪映草稿。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e2b1985e04d4d8782c9a130afb322f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=xqPgJTk2EPJ7I6czjgEYtSckxrA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-25">5.2. 添加背景音乐音频</h3>
<p>这个节点用来添加生成好的背景音乐时间线到剪映草稿中，使用到了扣子三方插件【视频剪辑工具箱】的【add_audios】工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb4e84935fd44e2483869fe187c7e1f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=Y7ooZ9bRbem8KMsao47yX3udPJQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-26">5.3. 添加正文解说字幕</h3>
<p>这个节点用来将生成好的正文解说字幕添加到剪映草稿中，使用到了扣子三方插件【视频剪辑工具箱】的【add_captions】工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dad9ee6a43b42daa9f3d1ef436be5af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=26e3944K9MdYky%2FV93rjRuWPllw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-27">5.4. 添加正文解说视频</h3>
<p>这个节点的作用是把正文解说视频时间线添加到剪映草稿中，使用到了扣子三方插件【视频剪辑工具箱】的【add_videos】工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bb0708bc8bf48d18fd4cadb327ada62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=pGk%2FdUcQOpiucFWXBQQTX6pocSM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-28">5.5. 保存草稿</h3>
<p>这个节点的作用是把之前添加到剪映草稿中的时间线给持久化下来，使用到了扣子三方插件【视频剪辑工具箱】的【save_draft】工具。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f6a581088d84e21b6aed5ac96c95f55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=w4LdWBA7yvmjQdEI1ao4l0oxc%2BM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-29">5.6. 结束</h3>
<ul>
<li>draft_id：草稿ID，传到视频结尾的工作流继续剪辑</li>
<li>draft_url：草稿下载地址，可以到“视频剪辑小助手”下载草稿</li>
<li>end_us：歌曲解说视频结束位置，视频结尾从这里开始</li>
<li>start_us：歌曲解说视频开始位置</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/886a5bf865a04ce3a7f916f5111b0704~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=M11FE3GrBprsn2iBwEPP4aPwsW0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-30">6. 总结</h2>
<p>本文介绍了“每天听懂一首歌”工作流中的歌曲解说部分，经过对这个工作流的拆解独立成三个工作流，觉得每个单独的工作流不算特别复杂，而且还可以独立调试，方便不少，也便于修改。</p>
<p>本文的分享就到这里，如果您觉得有收获的话，可以给个一键三连，您的鼓励是吾鳴持续输出的最大动力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b45fa19260441028ad9c5125ee5e81c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770349879&amp;x-signature=UO5WTQPR6Crm66a2DUD2u7pqiKw%3D" alt="" loading="lazy"/></p>
<p>最近实战了一些扣子（Coze）工作流相关的案例，包含小红薯图文生成、爆款视频剪辑、办公提效等扣子案例，内附详细的教程和工作流安装包，感兴趣的朋友可以来个<strong>一键三连（必须动作）</strong> ，文章评论区评论“<strong>扣子案例</strong>”领取（这些案例不包含本文分享的案例，如果需要本文分享的案例安装包可以后台私信我）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java单元测：jqwik框架入门（含完整Demo）]]></title>    <link>https://juejin.cn/post/7600710943250694186</link>    <guid>https://juejin.cn/post/7600710943250694186</guid>    <pubDate>2026-01-30T04:55:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600710943250694186" data-draft-id="7600709805469057067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java单元测：jqwik框架入门（含完整Demo）"/> <meta itemprop="keywords" content="后端,Java,单元测试"/> <meta itemprop="datePublished" content="2026-01-30T04:55:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怒放吧德德"/> <meta itemprop="url" content="https://juejin.cn/user/2502950820787672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java单元测：jqwik框架入门（含完整Demo）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2502950820787672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怒放吧德德
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T04:55:44.000Z" title="Fri Jan 30 2026 04:55:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java单元测：jqwik框架入门（含完整Demo）</h2>
<blockquote>
<p>😄生命不息，写作不止</p>
<p>🔥 继续踏上学习之路，学之分享笔记</p>
<p>👊 总有一天我也能像各位大佬一样</p>
<p>🏆 <a href="https://juejin.cn/user/2502950820787672" target="_blank" title="https://juejin.cn/user/2502950820787672">博客首页</a>   <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Flyd-code%2F" target="_blank" title="https://www.cnblogs.com/lyd-code/" ref="nofollow noopener noreferrer">@怒放吧德德</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Flydandtry.github.io%2F" target="_blank" title="https://lydandtry.github.io/" ref="nofollow noopener noreferrer">To记录领地</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43843951%3Ftype%3Dblog" target="_blank" title="https://blog.csdn.net/qq_43843951?type=blog" ref="nofollow noopener noreferrer">@一个有梦有戏的人</a></p>
<p>🌝分享学习心得，欢迎指正，大家一起学习成长！</p>
</blockquote>
<p><em>转发请携带作者信息</em>  <strong>@怒放吧德德(掘金) @一个有梦有戏的人(CSDN)</strong></p>
<h3 data-id="heading-1">前言</h3>
<p>在Java单元测试中，我们常依赖JUnit手动编写测试用例，但手动用例不仅繁琐，还容易遗漏边界场景和异常输入。而jqwik框架的出现，恰好解决了这一痛点——它是一款基于JUnit 5平台的属性测试（Property-Based Testing, PBT）框架，能自动生成海量测试数据，系统化验证代码的通用属性，帮我们快速捕捉隐藏的bug，让测试更高效、更全面。</p>
<h3 data-id="heading-2">1 什么是jqwik框架？</h3>
<p>jqwik（发音/ˈdʒeɪkwɪk/，谐音“jay quick”）是专为JVM设计的属性测试框架，核心目标是将属性测试（PBT）的强大能力融入Java、Kotlin等语言的测试流程，同时兼顾微测试的直观性。它并非替代JUnit，而是作为JUnit 5的扩展存在，可无缝集成到现有测试体系，无需大幅改动原有代码架构。</p>
<h4 data-id="heading-3">1.1 核心定位：属性测试 vs 传统测试</h4>
<p>传统JUnit测试属于“基于场景的测试”，我们需要预定义具体输入和预期输出（比如测试加法时，手动写1+1=2、2+3=5），只能覆盖有限场景；而属性测试则聚焦于代码的“通用属性”——即所有合法输入都应满足的规则（比如“任意两个整数a和b，a+b的结果应等于b+a”），框架会自动生成海量随机测试数据，验证这一属性是否始终成立。</p>
<h4 data-id="heading-4">1.2 jqwik的核心优势</h4>
<ul>
<li>无缝集成：基于JUnit 5平台开发，支持Maven、Gradle快速引入，可与IntelliJ IDEA、Eclipse等IDE无缝兼容，运行测试和查看结果的体验与JUnit一致。</li>
<li>自动生成测试数据：内置丰富的测试数据生成器（Arbitrary），支持基本类型、集合、字符串、自定义对象等，还可灵活配置数据约束（如“生成1-100的正整数”）。</li>
<li>智能反例缩小：当测试失败时，会自动将导致失败的复杂数据简化为最小反例（比如将长度100的异常字符串缩小为1个字符），快速定位问题根源。</li>
<li>高灵活性：支持自定义测试数据生成器、并行测试、测试数据过滤，适配复杂业务场景下的测试需求。</li>
<li>多语言支持：除Java外，还完美支持Kotlin、Groovy等JVM语言，适配不同项目的技术栈。</li>
</ul>
<h3 data-id="heading-5">2 jqwik怎么用？（基础步骤）</h3>
<p>使用jqwik的核心流程很简单：引入依赖 → 理解核心注解/概念 → 编写属性测试方法 → 运行测试并分析结果。下面分步拆解，新手也能快速上手。</p>
<h4 data-id="heading-6">2.1 第一步：引入依赖（Maven/Gradle）</h4>
<p>首先确保项目基于JUnit 5（Jupiter），然后在构建文件中引入jqwik依赖，这里给出最常用的Maven和Gradle配置（使用稳定版本1.5.2）。</p>
<h5 data-id="heading-7">Maven配置（pom.xml）</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>;
    <span class="hljs-comment">&lt;!-- JUnit 5 基础依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
   <span class="hljs-comment">&lt;!-- jqwik 核心依赖（包含所有必要组件） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.jqwik<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jqwik-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h5 data-id="heading-8">Gradle配置（build.gradle）</h5>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    // JUnit 5 基础依赖
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.8.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.8.2'
    // jqwik 核心依赖
    testImplementation 'net.jqwik:jqwik-all:1.5.2'
}

test {
    useJUnitPlatform() // 启用JUnit 5平台
}
</code></pre>
<h4 data-id="heading-9">2.2 第二步：理解jqwik核心概念与注解</h4>
<p>jqwik的使用依赖几个核心注解和概念，掌握这些就能编写基础的属性测试：</p>





























<table><thead><tr><th><strong>注解/概念</strong></th><th><strong>作用说明</strong></th></tr></thead><tbody><tr><td>@ExtendWith(JqwikExtension.class)</td><td>标记测试类，告知JUnit 5启用jqwik扩展，是编写jqwik测试的必备注解。</td></tr><tr><td>@Property</td><td>标记方法为“属性测试方法”，框架会自动执行该方法，并生成测试数据验证属性。</td></tr><tr><td>@ForAll</td><td>用于方法参数，指定该参数由jqwik自动生成测试数据，可结合数据约束使用（如@ForAll @IntRange(min=1, max=100)）。</td></tr><tr><td>Arbitrary</td><td>测试数据生成器的核心接口，代表“可生成某种类型测试数据的集合”，jqwik内置Arbitraries工具类提供常用生成器（如Arbitraries.ints()、Arbitraries.strings()）。</td></tr><tr><td>@Provide</td><td>标记方法为“自定义生成器方法”，方法返回Arbitrary类型，可自定义复杂测试数据（如自定义对象）。</td></tr></tbody></table>
<h4 data-id="heading-10">2.3 第三步：编写基础属性测试</h4>
<p>核心逻辑：定义“通用属性”（方法）→ 用@ForAll让框架自动生成参数 → 用断言验证属性是否成立。</p>
<h3 data-id="heading-11">3 实战Demo：用jqwik测试字符串工具类</h3>
<p>下面我们通过一个完整Demo，实战jqwik的使用——测试一个简单的字符串工具类，验证其“反转字符串”和“判空”两个功能的正确性，覆盖正常、边界、异常场景。</p>
<h4 data-id="heading-12">3.1 第一步：编写被测试的字符串工具类</h4>
<p>先创建一个简单的字符串工具类StringUtils，包含两个方法：反转字符串（reverse）、判断字符串非空（isNotEmpty）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.jqwik.demo;

<span class="hljs-comment">/**
 * 被测试的字符串工具类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringUtils</span> {

    <span class="hljs-comment">/**
     * 反转字符串
     * <span class="hljs-doctag">@param</span> str 输入字符串（可null）
     * <span class="hljs-doctag">@return</span> 反转后的字符串，null输入返回null
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">reverse</span><span class="hljs-params">(String str)</span> {
        <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(str).reverse().toString();
    }

    <span class="hljs-comment">/**
     * 判断字符串非空（非null、非空白）
     * <span class="hljs-doctag">@param</span> str 输入字符串
     * <span class="hljs-doctag">@return</span> true：非空；false：null或空白字符串
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isNotEmpty</span><span class="hljs-params">(String str)</span> {
        <span class="hljs-keyword">return</span> str != <span class="hljs-literal">null</span> &amp;&amp; !str.trim().isEmpty();
    }
}
</code></pre>
<h4 data-id="heading-13">3.2 第二步：编写jqwik测试类</h4>
<p>创建测试类StringUtilsTest，引入jqwik注解，编写两个属性测试方法，分别验证reverse和isNotEmpty的通用属性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.jqwik.demo;

<span class="hljs-keyword">import</span> net.jqwik.api.Arbitraries;
<span class="hljs-keyword">import</span> net.jqwik.api.Arbitrary;
<span class="hljs-keyword">import</span> net.jqwik.api.ForAll;
<span class="hljs-keyword">import</span> net.jqwik.api.Provide;
<span class="hljs-keyword">import</span> net.jqwik.api.Property;
<span class="hljs-keyword">import</span> net.jqwik.api.constraints.NotBlank;
<span class="hljs-keyword">import</span> net.jqwik.api.constraints.Nullable;
<span class="hljs-keyword">import</span> net.jqwik.api.extension.JqwikExtension;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.extension.ExtendWith;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.jupiter.api.Assertions.*;

<span class="hljs-comment">// 启用jqwik扩展，必备注解</span>
<span class="hljs-meta">@ExtendWith(JqwikExtension.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringUtilsTest</span> {

    <span class="hljs-comment">/**
     * 测试reverse方法的核心属性：反转两次的结果应与原字符串一致（支持null）
     * 这里<span class="hljs-doctag">@ForAll</span> <span class="hljs-doctag">@Nullable</span> String str 表示自动生成所有可能的字符串（包括null、空白、正常字符串）
     */</span>
    <span class="hljs-meta">@Property</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">reverseTwiceShouldBeOriginal</span><span class="hljs-params">(<span class="hljs-meta">@ForAll</span> <span class="hljs-meta">@Nullable</span> String str)</span> {
        <span class="hljs-comment">// 核心断言：反转两次的结果 == 原字符串</span>
        assertEquals(str, StringUtils.reverse(StringUtils.reverse(str)));
    }

    <span class="hljs-comment">/**
     * 测试isNotEmpty方法的核心属性1：非空白字符串返回true
     * <span class="hljs-doctag">@ForAll</span> <span class="hljs-doctag">@NotBlank</span> String str 表示自动生成所有非空白字符串（非null、非空白）
     */</span>
    <span class="hljs-meta">@Property</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">notBlankStringShouldReturnTrue</span><span class="hljs-params">(<span class="hljs-meta">@ForAll</span> <span class="hljs-meta">@NotBlank</span> String str)</span> {
        assertTrue(StringUtils.isNotEmpty(str));
    }

    <span class="hljs-comment">/**
     * 测试isNotEmpty方法的核心属性2：空白/null字符串返回false
     * 自定义生成器：生成空白字符串（空格、制表符等）或null
     */</span>
    <span class="hljs-meta">@Property</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">blankOrNullStringShouldReturnFalse</span><span class="hljs-params">(<span class="hljs-meta">@ForAll("blankOrNullStrings")</span> String str)</span> {
        assertFalse(StringUtils.isNotEmpty(str));
    }

    <span class="hljs-comment">/**
     * 自定义测试数据生成器：生成空白字符串或null
     * <span class="hljs-doctag">@Provide</span> 注解标记，方法返回Arbitrary&lt;String&gt;（字符串生成器）
     */</span>
    <span class="hljs-meta">@Provide</span>
    Arbitrary&lt;String&gt; <span class="hljs-title function_">blankOrNullStrings</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 生成两种数据：null + 空白字符串（空格、制表符、空字符串），合并为一个生成器</span>
        Arbitrary&lt;String&gt; nullStrings = Arbitraries.just(<span class="hljs-literal">null</span>);
        Arbitrary&lt;String&gt; blankStrings = Arbitraries.strings()
                .withChars(<span class="hljs-string">' '</span>, <span class="hljs-string">'\t'</span>, <span class="hljs-string">'\n'</span>) <span class="hljs-comment">// 只生成空白字符</span>
                .ofMaxLength(<span class="hljs-number">10</span>); <span class="hljs-comment">// 最大长度10，避免生成过长字符串</span>
        <span class="hljs-keyword">return</span> Arbitraries.oneOf(nullStrings, blankStrings, Arbitraries.just(<span class="hljs-string">""</span>));
    }
}
</code></pre>
<h4 data-id="heading-14">3.3 第三步：运行测试并查看结果</h4>
<p>直接在IDE中运行测试类（和运行JUnit测试一致），jqwik会自动生成测试数据，默认每个@Property方法生成1000组数据，我们可以查看运行结果：</p>
<h5 data-id="heading-15">1. 测试成功场景</h5>
<p>如果工具类逻辑正确，运行结果会显示“3 tests passed”（3个属性测试方法全部通过），控制台会输出类似信息：</p>
<pre><code class="hljs language-plain" lang="plain">[INFO] Running com.example.jqwik.demo.StringUtilsTest
[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.523 s - in com.example.jqwik.demo.StringUtilsTest
</code></pre>
<p>这说明jqwik生成的1000×3组数据，全部满足我们定义的属性，工具类逻辑无明显bug。</p>
<h5 data-id="heading-16">2. 测试失败场景（模拟bug）</h5>
<p>我们故意修改reverse方法的逻辑（比如注释掉null判断，让null输入抛出异常），再运行测试，jqwik会快速捕捉到失败，并生成最小反例：</p>
<pre><code class="hljs language-plain" lang="plain">// 故意修改后的reverse方法（有bug）
public static String reverse(String str) {
    // 注释掉null判断，null输入会抛出NullPointerException
    return new StringBuilder(str).reverse().toString();
}

// 运行测试后，jqwik输出的失败信息（简化）
Property violation in com.example.jqwik.demo.StringUtilsTest.reverseTwiceShouldBeOriginal
Arguments: [null] // 最小反例：null
Throwable that caused failure: java.lang.NullPointerException
</code></pre>
<p>可以看到，jqwik自动定位到“null输入”这个边界场景，生成了最小反例（null），帮我们快速发现“null输入未处理”的bug，这正是属性测试的优势——手动测试很容易遗漏这类边界场景。</p>
<h3 data-id="heading-17">4 总结与进阶方向</h3>
<p>通过上面的介绍和Demo，相信你已经掌握了jqwik的基础用法：它以“属性测试”为核心，通过自动生成测试数据，帮我们解决传统手动测试的痛点，尤其适合验证算法、工具类、API等通用逻辑的正确性。</p>
<h4 data-id="heading-18">进阶学习方向（可选）</h4>
<ul>
<li>自定义复杂生成器：用@Provide和Arbitraries组合，生成自定义对象、枚举、复杂集合等测试数据（如资料中提到的Combinators.combine组合多个生成器）。</li>
<li>数据约束精细化：使用jqwik提供的更多约束注解（如@IntRange、@StringLength、@Email），精准控制测试数据的范围。</li>
<li>集成Spring Boot：通过jqwik-spring扩展，在Spring Boot项目中使用jqwik测试，支持@Autowired注入Bean。</li>
<li>并行测试与测试优化：配置jqwik并行运行测试，调整生成数据的数量、随机种子等，提升测试效率。</li>
</ul>
<blockquote>
<p>jqwik的官方文档（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjqwik.net%2F" target="_blank" title="https://jqwik.net/" ref="nofollow noopener noreferrer">jqwik.net/</a>）提供了更详细的API说明和进阶用法，感兴趣的可以进一步查阅。总的来说，jqwik上手简单、功能强大，只需几行代码就能实现更全面的测试，值得每一个Java开发者纳入自己的测试工具箱～</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IntentService和JobIntentService解析]]></title>    <link>https://juejin.cn/post/7600704706550513704</link>    <guid>https://juejin.cn/post/7600704706550513704</guid>    <pubDate>2026-01-30T02:53:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600704706550513704" data-draft-id="7600670417858281506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IntentService和JobIntentService解析"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T02:53:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IntentService和JobIntentService解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:53:35.000Z" title="Fri Jan 30 2026 02:53:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1.IntentService</h3>
<p>(1).介绍Service
Android中的Service是用于后台服务的，当应用程序被挂起到后台或者启动Service的Activity被销毁时，为了保证应用某些组件仍然可以工作而引入了Service这个概念，但是Service既不是独立的进程，也不是独立的线程，它是依赖于应用程序的主线程的，在大部分时候不建议在Service中编写耗时的逻辑和操作，否则会引起ANR。（阻塞主线程5s，会导致ANR）
(2).IntentService||JobIntentService应用场景
如果我们编写的耗时逻辑，不得不被service来管理的时候，就需要使用IntentService，IntentService是继承Service的，那么它包含了Service的所有特性，当然也包含service的生命周期，那么与service不同的是，IntentService在执行onCreate操作的时候，内部开了一个线程，去你执行你的耗时操作。</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Service</span> </span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> void onHandleIntent(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Intent</span> intent);
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span> </span>{
        public <span class="hljs-type">ServiceHandler</span>(<span class="hljs-type">Looper</span> looper) {
            <span class="hljs-keyword">super</span>(looper);
        }

        <span class="hljs-meta">@Override</span>
        public void handleMessage(<span class="hljs-type">Message</span> msg) {
            onHandleIntent((<span class="hljs-type">Intent</span>)msg.obj); <span class="hljs-comment">//运行在子线程中</span>
            stopSelf(msg.arg1);
        }
    }
   public void onCreate() {
        <span class="hljs-keyword">super</span>.onCreate();
        <span class="hljs-type">HandlerThread</span> thread = <span class="hljs-keyword">new</span> <span class="hljs-type">HandlerThread</span>(<span class="hljs-string">"IntentService["</span> + mName + <span class="hljs-string">"]"</span>);
        thread.start();
        mServiceLooper = thread.getLooper();
        mServiceHandler = <span class="hljs-keyword">new</span> <span class="hljs-type">ServiceHandler</span>(mServiceLooper);
    }
   <span class="hljs-meta">@Override</span>
    public void onStart(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Intent</span> intent, int startId) {
        <span class="hljs-type">Message</span> msg = mServiceHandler.obtainMessage();
        msg.arg1 = startId;
        msg.obj = intent;
        mServiceHandler.sendMessage(msg);
    }
}
</code></pre>
<p>(3).继承抽象类IntentService，然后实现handleIntent方法即可.</p>
<pre><code class="hljs language-scala" lang="scala">public  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IntentService</span> </span>{
    public <span class="hljs-type">TestService</span>(<span class="hljs-type">String</span> name) {
        <span class="hljs-keyword">super</span>(name);
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void onHandleIntent(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Intent</span> intent) {
    }
}
</code></pre>
<p>(4).HandleThread实现
继承了Thread，Looper.prepare()将当前线程和Looper对象存储到ThreadLocalMap中，然后提供getLooper方法。</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HandlerThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>{
    public void run(){
      <span class="hljs-type">Looper</span>.prepare();
        synchronized (<span class="hljs-keyword">this</span>) {
            mLooper = <span class="hljs-type">Looper</span>.myLooper();
            notifyAll();
        }
    }
   public <span class="hljs-type">Looper</span> getLooper() {
      <span class="hljs-keyword">return</span> mLooper;
   }
}
</code></pre>
<h3 data-id="heading-1">2.JobIntentService</h3>
<p>(1).通过内部的AysncTask来处理耗时操作</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JobIntentService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Service</span> </span>{
     <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> void onHandleWork(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">Intent</span> intent);
      public int onStartCommand(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">Intent</span> intent, int flags, int startId) {
          ensureProcessorRunningLocked(<span class="hljs-literal">true</span>);
     }
     void ensureProcessorRunningLocked(boolean reportStarted) {
        <span class="hljs-keyword">if</span> (mCurProcessor == <span class="hljs-literal">null</span>) {
            mCurProcessor = <span class="hljs-keyword">new</span> <span class="hljs-type">CommandProcessor</span>();
            <span class="hljs-keyword">if</span> (mCompatWorkEnqueuer != <span class="hljs-literal">null</span> &amp;&amp; reportStarted) {
                mCompatWorkEnqueuer.serviceProcessingStarted();
            }
            mCurProcessor.executeOnExecutor(<span class="hljs-type">AsyncTask</span>.<span class="hljs-type">THREAD_POOL_EXECUTOR</span>);
       }
    }
   <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AsyncTask&lt;Void</span>, <span class="hljs-title">Void</span>, <span class="hljs-title">Void&gt;</span> </span>{
        <span class="hljs-keyword">protected</span> <span class="hljs-type">Void</span> doInBackground(<span class="hljs-type">Void</span>... params) {
            <span class="hljs-type">GenericWorkItem</span> work;

            <span class="hljs-keyword">if</span> (<span class="hljs-type">DEBUG</span>) <span class="hljs-type">Log</span>.d(<span class="hljs-type">TAG</span>, <span class="hljs-string">"Starting to dequeue work..."</span>);

            <span class="hljs-keyword">while</span> ((work = dequeueWork()) != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (<span class="hljs-type">DEBUG</span>) <span class="hljs-type">Log</span>.d(<span class="hljs-type">TAG</span>, <span class="hljs-string">"Processing next work: "</span> + work);
                 onHandleWork(work.getIntent());<span class="hljs-comment">//回调onHandlerWork方法</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-type">DEBUG</span>) <span class="hljs-type">Log</span>.d(<span class="hljs-type">TAG</span>, <span class="hljs-string">"Completing work: "</span> + work);
                work.complete();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> void onPostExecute(<span class="hljs-type">Void</span> aVoid) {
            processorFinished();
        }
    }
}

</code></pre>
<p>(2).使用继承抽象类JobIntentService，实现onHandleWork来处理耗时操作</p>
<pre><code class="hljs language-scala" lang="scala">public  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JobIntentService</span> </span>{
    <span class="hljs-meta">@Override</span> 
    <span class="hljs-keyword">protected</span> void onHandleWork(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">Intent</span> intent) { 
        <span class="hljs-comment">//在AsyncTask启动的异步线程中执行</span>
    }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin核心基础之高阶函数，协程基本用法]]></title>    <link>https://juejin.cn/post/7600670487409344564</link>    <guid>https://juejin.cn/post/7600670487409344564</guid>    <pubDate>2026-01-30T02:59:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670487409344564" data-draft-id="7600681071714304000" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin核心基础之高阶函数，协程基本用法"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T02:59:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin核心基础之高阶函数，协程基本用法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:59:14.000Z" title="Fri Jan 30 2026 02:59:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fmaoning20080808%2Farticle%2Fdetails%2F143663152" target="_blank" title="https://blog.csdn.net/maoning20080808/article/details/143663152" ref="nofollow noopener noreferrer">kotlin-协程基本操作_kotlin mainscope-CSDN博客</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Flaiqun789%2Farticle%2Fdetails%2F133937972" target="_blank" title="https://blog.csdn.net/laiqun789/article/details/133937972" ref="nofollow noopener noreferrer">怎么理解kotlin的挂起函数？</a>
<a href="https://juejin.cn/post/7121132393922035720?searchId=202412231443022336D913A7863105656C" target="_blank" title="https://juejin.cn/post/7121132393922035720?searchId=202412231443022336D913A7863105656C">Kotlin协程进阶使用</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg3ODY2MzU2MQ%3D%3D%26mid%3D2247490102%26idx%3D6%26sn%3D501c2975d1595ab021b750bd39f409bc%26chksm%3Dcf1118d0f86691c64ea7e86071d4fd02748a7efbad4513a1709aff141ca3bbc3ce45fc6f20de%26token%3D1436311520%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg3ODY2MzU2MQ==&amp;mid=2247490102&amp;idx=6&amp;sn=501c2975d1595ab021b750bd39f409bc&amp;chksm=cf1118d0f86691c64ea7e86071d4fd02748a7efbad4513a1709aff141ca3bbc3ce45fc6f20de&amp;token=1436311520&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">Kotlin协程在工作中有用过吗？ (qq.com)</a></p>
<h3 data-id="heading-0">1.kotlin和java编译后都是java字节码，相对于java有啥优势和劣势？</h3>
<p>(1).kotlin优势</p>
<ul>
<li>
<p>代码简洁，开发效率更高
不用使用findViewById，支减少冗余代码，支持空安全，扩展函数，属性，高阶函数和lambda表达式，内联函数。</p>
</li>
<li>
<p>内存消耗更少
由于空安全特性和内联函数优化，它能够生成更高效的字节码，从而减少内存的使用。kotlin协程提供了一中轻量级的并发处理方式，可以进一步降低内存的占用。</p>
</li>
<li>
<p>kotlin是未来Android开发主流的语言，一些Android的新特性，新组件都会优先支持kotlin版本。</p>
</li>
</ul>
<p>(2).kotlin劣势
kotlin编译速度相对java较慢，因为她需要进行额外的类型检查（空安全），和代码转换（kotlin-java-java字节码，复杂，耗性能）</p>
<p>备注：Kotlin与Java在运行时性能方面基本相当，由于kotlin支持inline函数，lambda表达式，在某些情况下性能还要由于java.</p>
<h3 data-id="heading-1">2.Kotlin内置的高阶函数run的原理是什么，与let函数有啥区别？</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">(<span class="hljs-number">1</span>).<span class="hljs-keyword">inline</span> :表示这是一个内联函数，将函数代码直接插入调用处，避免了调用普通方法时，栈帧的创建，销毁所带来的开销。
(<span class="hljs-number">2</span>).&lt;T,R&gt; T.run :T代表要为T扩展出一个名为run的函数，R表示lambda表达式最后一行返回的类型。
(<span class="hljs-number">3</span>).block:T.()-&gt;R:
block：表示lambda的名称
T.():表示输入参数是T本身，让lambda表达式持有了<span class="hljs-keyword">this</span>表示(T)调用者本身
R:表示lambda最后一行返回的类型.
(T) :表示输入参数是T本身，让lambda表达式持有了it表示(T)调用者本身

<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span><span class="hljs-type">&lt;T,R&gt;</span> T.<span class="hljs-title">let</span><span class="hljs-params">(block:(<span class="hljs-type">T</span>)-&gt;<span class="hljs-type">R</span>)</span></span>{
    <span class="hljs-keyword">return</span> block(<span class="hljs-keyword">this</span>)
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span><span class="hljs-type">&lt;T,R&gt;</span> T.<span class="hljs-title">run</span><span class="hljs-params">(block:<span class="hljs-type">T</span>.()-&gt;<span class="hljs-type">R</span>)</span></span>:R{
      <span class="hljs-keyword">return</span> block()
}
<span class="hljs-comment">//with不是泛型的扩展方法，而是全局方法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T, R&gt;</span> <span class="hljs-title">with</span><span class="hljs-params">(receiver: <span class="hljs-type">T</span>, block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">R</span>)</span></span>: R {
    <span class="hljs-keyword">return</span> receiver.block()
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">also</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span>: T {
    block(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">apply</span><span class="hljs-params">(block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: T {
    block()
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
}



<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
   <span class="hljs-keyword">var</span>  result1=<span class="hljs-string">"778"</span>.run{  
         <span class="hljs-literal">true</span>
        length
    }
   println(result1)   <span class="hljs-comment">//3</span>
  <span class="hljs-keyword">var</span> result2=<span class="hljs-string">"778"</span>.let{
         <span class="hljs-number">999</span>
         <span class="hljs-string">"<span class="hljs-variable">$it</span>"</span> <span class="hljs-comment">//778</span>
  }
}
</code></pre>
<p>为啥所有的类型都可以使用run或者let，那是因为高阶函数let和run是对泛型进行扩展，意味着所有类型都等于泛型，所以任何地方都可以使用.run和let的区别在于lambda表达式一个持有this表示调用者本身，一个持有it表示调用者本身。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> inline &lt;T&gt; T.<span class="hljs-title function_ invoke__">apply</span>(<span class="hljs-attr">block</span>:T.()-&gt;unit):T
<span class="hljs-keyword">public</span> inline &lt;T&gt; T.<span class="hljs-title function_ invoke__">also</span>(<span class="hljs-attr">block</span>:(T)-&gt;unit):T
<span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> &lt;T,R&gt; <span class="hljs-title function_ invoke__">with</span>(<span class="hljs-attr">receiver</span>:T,<span class="hljs-attr">block</span>:T.()-&gt;R):R
</code></pre>
<h3 data-id="heading-2">3.kotlin语言泛型的形变是什么？【PECS原则 extends out || super in】</h3>
<ul>
<li>不变：指的是此泛型既可以是消费者，可以是生产者，没有任何继承相关的概念.</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>&lt;<span class="hljs-title">T</span>&gt; {}   
</code></pre>
<ul>
<li>协变 ： 指的是此泛型只能是生产者 ，泛型类型只能是T或者T的子类，只能get数据，无法add数据.</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp">ArrayList&lt;<span class="hljs-keyword">out</span> T&gt;            
</code></pre>
<ul>
<li>逆变：指的是此泛型只能是消费者，泛型类型只能是T类型，或者T的父类，只能add数据，无法get【如果get数据，数据类型只能是Object】</li>
</ul>

<pre><code class="hljs language-r" lang="r">ArrayList<span class="hljs-operator">&lt;</span><span class="hljs-keyword">in</span> <span class="hljs-built_in">T</span><span class="hljs-operator">&gt;</span>     
</code></pre>
<h3 data-id="heading-3">4.协程的基本使用.</h3>
<p>#####(1).启动协程的几种方式.</p>
<ul>
<li>launch{}  CoroutineScope接口的扩展方法，启动一个携程，不阻塞当前线程，返回一个Job对象协程.</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">launch</span><span class="hljs-params">(
     context:<span class="hljs-type">CoroutineScope</span>=EmptyCoroutineContext,
     start:<span class="hljs-type">CoroutineStart</span> = CoroutineStart.DEFAULT,
     block:<span class="hljs-type">suspend</span> <span class="hljs-type">CoroutineScope</span>.()-&gt;<span class="hljs-type">Unit</span>
)</span></span>:Job {  <span class="hljs-comment">//Job是返回值， {} 是launch的方法体实现 【不要搞混淆了】</span>
 <span class="hljs-comment">//launch方法体实现，返回Job对象</span>
      <span class="hljs-keyword">val</span> newcontenxt=newCoroutineContext(context)
     <span class="hljs-keyword">val</span> coroutine=<span class="hljs-keyword">if</span>(start.isLazy){
          LazyStandaloneCoroutine(newContext,block);<span class="hljs-comment">//实现了job接口</span>
     }<span class="hljs-keyword">else</span>{
        StandaloneCoroutine(newContext,active=<span class="hljs-literal">true</span>)  <span class="hljs-comment">//实现了job接口</span>
    }
     coroutine.start(start,coroutine,block)  <span class="hljs-comment">//启动job</span>
    <span class="hljs-keyword">return</span>  coroutine；<span class="hljs-comment">//返回实现了Job接口的协程对象</span>
}
</code></pre>
<p>Job.cancel()可以用来取消协程，控制协程的生命周期.</p>
<ul>
<li>async{} CoroutienScope接口的扩展方法，启动一个协程，不阻塞当前线程，返回一个Deferred类，可以通过wait获取T对象.</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> CoroutineScope.<span class="hljs-title">async</span><span class="hljs-params">(
    context: <span class="hljs-type">CoroutineContext</span> = EmptyCoroutineContext,
    start: <span class="hljs-type">CoroutineStart</span> = CoroutineStart.DEFAULT,
    block: <span class="hljs-type">suspend</span> <span class="hljs-type">CoroutineScope</span>.() -&gt; <span class="hljs-type">T</span>
)</span></span>: Deferred&lt;T&gt; {
    <span class="hljs-keyword">val</span> newContext = newCoroutineContext(context)
    <span class="hljs-keyword">val</span> coroutine= <span class="hljs-keyword">if</span> (start.isLazy){
        LazyDeferredCoroutine&lt;T&gt;(newContext, block)  <span class="hljs-comment">//实现了Deferred接口</span>
    } <span class="hljs-keyword">else</span>{
       DeferredCoroutine&lt;T&gt;(newContext, active = <span class="hljs-literal">true</span>) <span class="hljs-comment">//实现了Deferred接口</span>
    }
    coroutine.start(start, coroutine, block)   <span class="hljs-comment">//启动协程</span>
    <span class="hljs-keyword">return</span> coroutine <span class="hljs-comment">//返回实现了Deferred接口的协程对象</span>
}
</code></pre>
<ul>
<li>runBlocking{}  全局方法,创建并启动协程,返回值是lambda表达式block的最后一行的返回值.(Unit或者其他具体类型)</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">public fun &lt;T&gt; <span class="hljs-built_in">runBlocking</span>(context: CoroutineContext = EmptyCoroutineContext, block: suspend CoroutineScope.() -&gt; T): T {
    val currentThread = Thread<span class="hljs-selector-class">.currentThread</span>()
    val contextInterceptor = context<span class="hljs-selector-attr">[ContinuationInterceptor]</span>
    val eventLoop: EventLoop?
    val newContext: CoroutineContext
    if (contextInterceptor == null) {
        eventLoop = ThreadLocalEventLoop<span class="hljs-selector-class">.eventLoop</span>
        newContext = GlobalScope<span class="hljs-selector-class">.newCoroutineContext</span>(context + eventLoop)
    } else {
        eventLoop = (contextInterceptor as? EventLoop)?<span class="hljs-selector-class">.takeIf</span> { it<span class="hljs-selector-class">.shouldBeProcessedFromContext</span>() }
            ?: ThreadLocalEventLoop.<span class="hljs-built_in">currentOrNull</span>()
        newContext = GlobalScope.<span class="hljs-built_in">newCoroutineContext</span>(context)
    }
    val coroutine = BlockingCoroutine&lt;T&gt;(newContext, currentThread, eventLoop)
    coroutine<span class="hljs-selector-class">.start</span>(CoroutineStart.DEFAULT, coroutine, block)
    return coroutine<span class="hljs-selector-class">.joinBlocking</span>()
}
<span class="hljs-comment">//这一段代码会阻塞主线程，直接导致黑屏。</span>
runBlocking {
     <span class="hljs-built_in">delay</span>(<span class="hljs-number">10000</span>)
 }
<span class="hljs-comment">//即使指定启动的协程运行在IO线程，也会阻塞主线程，导致黑屏</span>
<span class="hljs-built_in">runBlocking</span>(Dispatchers.IO) {
   <span class="hljs-built_in">delay</span>(<span class="hljs-number">10000</span>L)
}
<span class="hljs-comment">//依然会阻塞主线程导致黑屏</span>
 GlobalScope<span class="hljs-selector-class">.launch</span>(Dispatchers.Main){
       runBlocking {
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">10000</span>)
        }

 }
<span class="hljs-comment">//不会阻塞主线程</span>
 GlobalScope<span class="hljs-selector-class">.launch</span>(Dispatchers.IO){
       runBlocking {
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">10000</span>)
        }
 }
</code></pre>
<h5 data-id="heading-4">(2).withContext() suspend修饰，并不会启动协程，返回结果是lambda表达式最后一行的返回值，只能在suspend挂起方法或者协程中调用，用于切换线程，并挂起协程。（暂停协程，但是执行协程的线程可以继续执行其他任务，不会阻塞，等到协程恢复，该线程可以继续执行）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">withContext</span><span class="hljs-params">(
    context: <span class="hljs-type">CoroutineContext</span>,
    block: <span class="hljs-type">suspend</span> <span class="hljs-type">CoroutineScope</span>.() -&gt; <span class="hljs-type">T</span>
)</span></span>: T
   
 lifecycleScope.launch(Dispatchers.IO) {
            delay(<span class="hljs-number">1000</span>)
            withContext(Dispatchers.Main){ <span class="hljs-comment">//返回值是Unit 也就是void  //切换到主线程 ，此时协程的IO线程可以去执行其他任务</span>
                println(<span class="hljs-string">"Test001:withContext:<span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
            }
        }
</code></pre>
<h5 data-id="heading-5">(3).coroutineScope()  suspend修饰，并不会启动协程，只能在suspend挂起方法或者协程中调用，创建一个新的协程作用域【或者说可以在已有的协程内部创建一个新协程】</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">coroutineScope</span><span class="hljs-params">(block: <span class="hljs-type">suspend</span> <span class="hljs-type">CoroutineScope</span>.() -&gt; <span class="hljs-type">R</span>)</span></span>: R =
    suspendCoroutineUninterceptedOrReturn { uCont -&gt;
        <span class="hljs-keyword">val</span> coroutine = ScopeCoroutine(uCont.context, uCont)
        coroutine.startUndispatchedOrReturn(coroutine, block)
 }


coroutineScope {  }  <span class="hljs-comment">//报错 ，不能直接用，只能在协程里面使用</span>

runBlocking { <span class="hljs-comment">//非suspend全局方法，直接启动协程</span>
   coroutineScope {  }   <span class="hljs-comment">//正常使用，因为runBlocking创建了协程//创建一个新的协程作用域</span>
  delay(<span class="hljs-number">1000L</span>) 
}
</code></pre>
<p>(4).协程上下文，一般用调度器Dispatchers来切换线程，它是CoroutineContext接口的实现类.</p>
<ul>
<li>Dispatchers.Main    协程代码执行在Android主线程</li>
<li>Dispatchers.Unconfined  不限制协程代码执行在哪个线程【主线程或者其他空闲线程】</li>
<li>Dispatcher.Default        JVM共享线程池分配线程执行协程代码</li>
<li>Dispatcher.IO                IO线程池分配线程执行协程代码</li>
</ul>
<h5 data-id="heading-6">注意：await() 只有在 async 未执行完成返回结果时，才会挂起协程。若 async 已经有结果了，await() 则直接获取其结果并赋值给变量，此时不会挂起协程。</h5>
<h3 data-id="heading-7">5.协程的挂起和阻塞</h3>
<h5 data-id="heading-8">(1).suspend非阻塞式挂起函数</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76b28b70e00d4649847e770a05e5824e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=oyzhpOzmyb9WVYkF1G%2F5FgSRySs%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss">fun <span class="hljs-built_in">testCoroutineInActivity</span>() {
       GlobalScope<span class="hljs-selector-class">.launch</span>(Dispatchers.Main) { <span class="hljs-comment">//1.启动协程1</span>
           <span class="hljs-built_in">println</span>("Test001:执行在协程中...")
           GlobalScope<span class="hljs-selector-class">.launch</span> (Dispatchers.IO){<span class="hljs-comment">//2.启动协程2</span>
               <span class="hljs-built_in">println</span>("Test001:异步执行result1")
               <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>)   
               <span class="hljs-built_in">println</span>("Test001:result1:<span class="hljs-number">1234</span>")
           }
           GlobalScope<span class="hljs-selector-class">.launch</span>(Dispatchers.IO) {<span class="hljs-comment">//3.启动协程3</span>
               <span class="hljs-built_in">println</span>("Test001:异步执行result2.")
               <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>) 
               <span class="hljs-built_in">println</span>("Test001:result2:<span class="hljs-number">123456</span>")
           }
           <span class="hljs-built_in">println</span>("Test001:执行完毕...")
       }
}
</code></pre>
<h5 data-id="heading-9">注意：协程2和协程3中的delay函数只是挂起了协程2和协程3，不会影响协程1中的主线程的执行.</h5>
<p>执行结果如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d78c31c310b4077bcb1b73d635494ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=gr05XSakSSnACaJNzofeEGQZVP8%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-10">(2).协程都被挂起了，那么挂起函数的函数体由谁执行呢？</h5>
<p>当协程执行到挂起函数式，协程的执行会被暂停（即协程被挂起），但它并不会阻塞执行该挂起函数的线程，挂起函数的函数体任然由当前线程继续执行。
为了更清楚的解释这一点，我们可以使用一下步骤：
(1).协程启动:当一个协程开始运行时，它会在某个线程(Dispatchers.Main)上执行。
(2).遇到挂起函数：当协程遇到挂起函数时，协程的执行会被暂停。
(3).挂起函数执行：尽管协程被暂停了，挂起函数的函数体任然会在原始线程上执行。（除非该挂起函数明确指定了其他的执行上下文）
(4).挂起函数完成：一旦挂起函数完成其工作，它会通知协程库，然后协程会恢复执行。
注意：当协程被挂起时，主线程并没有被阻塞，而是可以执行其他的任务，等到挂起函数执行完毕，协程恢复时，又可以在主线程中继续执行。
总结一下：在协程中使用挂起函数时，任何可能得"阻塞"操作都会转移到其他线程上执行，这样启动协程的原始线程(例如主线程)就不会被实际阻塞，这样使得协程特别适合UI线程编程，因为它可以确保UI线程保持响应。</p>
<h3 data-id="heading-11">6.kotlin协程在工作中有用过吗？</h3>
<p>kotlin协程是一个线程框架，提供了一种轻量级的并发处理方式，通过非阻塞挂起和恢复实现了用同步代码的方式编写异步代码，把原本运行在不同线程的代码写在一个代码块{}里面，看起来就像是同步代码。
协程的目的是，简化复杂的异步代码逻辑，用同步的代码编写方式实现复杂异步代码逻辑。</p>
<h5 data-id="heading-12">(1).几种封装好的协程</h5>
<ul>
<li>
<p>CoroutineScope(Dispatchers.IO)构造函数启动协程 ,通过Dispatchers指定运行的线程。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfa01d72f3eb4ddb88db3dc626c0937b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=sg53wvH15hdT1EVqI2wMQ0CYCsE%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>GlobalScope启动协程（默认不是主线程，是一个静态单例，和应用的生命周期相同,一般不使用，容易导致内存泄漏）</p>
</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-built_in">object</span> GlobalScope : CoroutineScope {
    <span class="hljs-keyword">override</span> val coroutineContext: <span class="hljs-function">CoroutineContext
        <span class="hljs-title">get</span>()</span> = EmptyCoroutineContext
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31634d42d8e446d8bc75cc8214db254b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=qoEK5QpmoD232cT6o9KqElgV3iA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>MainScope()启动协程（默认运行在主线程，是Activity或者Fragment中的一个成员变量，Activity或者Fragment销毁时，就会销毁）</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MainScope</span><span class="hljs-params">()</span></span>: CoroutineScope = ContextScope(SupervisorJob() + Dispatchers.Main)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea75a5c3eead4067a5e5c7d37f6ae6d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=sihutifPfrNg9QXsJkWhfhNekBA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>viewModelScope启动协程(默认运行在主线程，生命周期和ViewModel绑定)</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> ViewModel.viewModelScope: CoroutineScope
        <span class="hljs-keyword">get</span>() {
            <span class="hljs-keyword">val</span> scope: CoroutineScope? = <span class="hljs-keyword">this</span>.getTag(JOB_KEY)
            <span class="hljs-keyword">if</span> (scope != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> scope
            }
            <span class="hljs-keyword">return</span> setTagIfAbsent(JOB_KEY,
                CloseableCoroutineScope(SupervisorJob() + Dispatchers.Main.immediate))
        }
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c073ed644fe49b59b303914de472977~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=XRxcQPnhjiZcsBWvLDP5CQRzk0E%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>lifecycleScope启动协程(默认运行在主线程,生命周期和Activity或者Fragment绑定,实现了LifeycleOwner接口)</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">val LifecycleOwner.lifecycleScope: <span class="hljs-function">LifecycleCoroutineScope
    <span class="hljs-title">get</span>()</span> = lifecycle.coroutineScope

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/058235a96f56441999113e0d3b2dc280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346754&amp;x-signature=ZitxQT6q6Knbq3QMeo6ObbC66iQ%3D" alt="image.png" loading="lazy"/></p>
<p>协程就是一个线程框架，是对线程的封装，提供了一种轻量并发的处理方式，通过非阻塞式挂起和恢复的方式，用同步代码的方编写式实现复杂的异步代码逻辑，把原本运行在不同线程的代码写在一个代码块里面，看起来就像同步代码。</p>
<h5 data-id="heading-13">(2).如果一个页面需要同时并发请求多个接口，当所有的接口都请求完成需要做一些合并处理，然后更新UI，如何并发处理呢？</h5>
<ul>
<li>
<p>方法一：为每个接口设置一个boolean值，每当接口请求成功，boolean值设置为true,当最后一个接口请求成功后，在更新UI，这样就达到了并发的目的 【管理多个boolean值，不够优雅，太累了】</p>
</li>
<li>
<p>方法二：RXjava的zip操作符【达到发射一次，将结果合并处理的目的】</p>
</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin">   <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testRxjavaZip</span><span class="hljs-params">()</span></span>{
        println(<span class="hljs-string">"-------------"</span>)
        <span class="hljs-keyword">val</span> observable1: Observable&lt;HttpResult&lt;List&lt;Banner&gt;&gt;&gt; = HttpRetrofit.apiService.getBanners().subscribeOn(Schedulers.io()).observeOn(
            AndroidSchedulers.mainThread())
        <span class="hljs-keyword">val</span> observable2:Observable&lt;HttpResult&lt;ArrayList&lt;HomeData.DatasBean&gt;&gt;&gt; =HttpRetrofit.apiService.getTopArticles().subscribeOn(Schedulers.io()).observeOn(
            AndroidSchedulers.mainThread())
        <span class="hljs-keyword">val</span> observable3: Observable&lt;HttpResult&lt;List&lt;KnowledgeData&gt;&gt;&gt; = HttpRetrofit.apiService.getKnowledgeTree().subscribeOn(Schedulers.io()).observeOn(
            AndroidSchedulers.mainThread())
        <span class="hljs-keyword">var</span> result1: HttpResult&lt;List&lt;Banner&gt;&gt;? =<span class="hljs-literal">null</span>
        <span class="hljs-keyword">var</span> result2: HttpResult&lt;ArrayList&lt;HomeData.DatasBean&gt;&gt;? =<span class="hljs-literal">null</span>
        <span class="hljs-keyword">var</span> result3: HttpResult&lt;List&lt;KnowledgeData&gt;&gt;? =<span class="hljs-literal">null</span>
        Observable.zip(observable1, observable2, observable3,
            <span class="hljs-keyword">object</span>: Function3&lt;
                    HttpResult&lt;List&lt;Banner&gt;&gt;,
                    HttpResult&lt;ArrayList&lt;HomeData.DatasBean&gt;&gt;,
                    HttpResult&lt;List&lt;KnowledgeData&gt;&gt;,
                    <span class="hljs-built_in">Boolean</span>&gt;{
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(t1: <span class="hljs-type">HttpResult</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">Banner</span>&gt;&gt;, t2: <span class="hljs-type">HttpResult</span>&lt;<span class="hljs-type">ArrayList</span>&lt;<span class="hljs-type">HomeData</span>.<span class="hljs-type">DatasBean</span>&gt;&gt;, t3: <span class="hljs-type">HttpResult</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">KnowledgeData</span>&gt;&gt;)</span></span>: <span class="hljs-built_in">Boolean</span> {
                    result1=t1
                    result2=t2
                    result3=t3
                    <span class="hljs-keyword">return</span> t1!=<span class="hljs-literal">null</span>&amp;&amp;t2!=<span class="hljs-literal">null</span>&amp;&amp;t3!=<span class="hljs-literal">null</span>
                }
            }).subscribe(<span class="hljs-keyword">object</span>:Observer&lt;<span class="hljs-built_in">Boolean</span>&gt;{
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSubscribe</span><span class="hljs-params">(d: <span class="hljs-type">Disposable</span>)</span></span> {

            }

            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onError</span><span class="hljs-params">(e: <span class="hljs-type">Throwable</span>)</span></span> {

            }

            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onComplete</span><span class="hljs-params">()</span></span> {

            }

            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onNext</span><span class="hljs-params">(t: <span class="hljs-type">Boolean</span>)</span></span> {
                <span class="hljs-keyword">if</span>(t){<span class="hljs-comment">//对结果进行处理</span>
                    println(<span class="hljs-string">"成功获取结果"</span>);
                    println(Gson().toJson(result1))
                    println(Gson().toJson(result2))
                    println(Gson().toJson(result3))
                }
            }
        });

    }
</code></pre>
<ul>
<li>kotlin协程提供了一种轻量级的并发处理方式</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">    fun <span class="hljs-built_in">testCoroutineInActivity</span>() {
      <span class="hljs-comment">//1.launch启动协程，返回Job对象，通过job.cancel()取消任务</span>
     val job:Job=<span class="hljs-built_in">CoroutineScope</span>(Dispatchers.IO).<span class="hljs-built_in">launch</span>() { 
            <span class="hljs-built_in">println</span>("Test001:查看运行的线程<span class="hljs-number">1</span>："+Thread.currentThread()<span class="hljs-selector-class">.name</span>)
            val start= System<span class="hljs-selector-class">.currentTimeMillis</span>()
            val result1=async {<span class="hljs-comment">//运行在主线程，非异步</span>
                <span class="hljs-built_in">println</span>("Test001:查看运行的线程<span class="hljs-number">2</span>："+Thread.currentThread()<span class="hljs-selector-class">.name</span>)
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>)
                "<span class="hljs-number">123</span>"
            }
         <span class="hljs-comment">//2.async  启动协程，得到有返回值的Deferred对象</span>
            val result2:Deferred&lt;String&gt; = <span class="hljs-built_in">async</span>(Dispatchers.IO) { <span class="hljs-comment">//异步 </span>
                <span class="hljs-built_in">println</span>("Test001:查看运行的线程<span class="hljs-number">3</span>："+Thread.currentThread()<span class="hljs-selector-class">.name</span>)
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">2000</span>)
                 "<span class="hljs-number">456</span>"

            }
            val result3=result1<span class="hljs-selector-class">.await</span>()+result2<span class="hljs-selector-class">.await</span>();
            <span class="hljs-built_in">println</span>("Test001:并发耗时："+ (System.currentTimeMillis() - start)+"||result3:<span class="hljs-string">"+result3)
            withContext(Dispatchers.IO){
                println("</span>Test001:查看运行的线程<span class="hljs-number">4</span>：<span class="hljs-string">"+ Thread.currentThread().name)
                delay(1000)
            }
            println("</span>Test001:查看运行的线程<span class="hljs-number">5</span>：<span class="hljs-string">"+ Thread.currentThread().name)
        }
    }
</span></code></pre>
<ul>
<li>kotlin协程解决地狱回调问题【先调用接口1获取数据，然后拿到接口1的结果作为参数调用接口2】</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 注意：在真实开发过程中，MainScope作用域用的非常常用</span>
MainScope().launch(){     <span class="hljs-comment">// 注意：此协程块默认是在UI线程中启动协程</span>
    <span class="hljs-comment">// 下面的代码看起来会以同步的方式一行行执行（异步代码同步获取结果）</span>
    <span class="hljs-keyword">val</span> token = apiService.getToken()   <span class="hljs-comment">// 网络请求：IO线程，获取用户token</span>
    <span class="hljs-keyword">val</span> user = apiService.getUser(token)<span class="hljs-comment">// 网络请求：IO线程，获取用户信息</span>
    nameTv.text = user.name             <span class="hljs-comment">// 更新 UI：主线程，展示用户名</span>
    <span class="hljs-keyword">val</span> articleList = apiService.getArticleList(user.id)<span class="hljs-comment">// 网络请求：IO线程，根据用户id获取用户的文章集合哦</span>
    articleTv.text = <span class="hljs-string">"用户<span class="hljs-subst">${user.name}</span>的文章页数是:<span class="hljs-subst">${articleList.size}</span>页"</span>   <span class="hljs-comment">// 更新 UI：主线程</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Okhttp3.11.0框架原理分析]]></title>    <link>https://juejin.cn/post/7600670487409803316</link>    <guid>https://juejin.cn/post/7600670487409803316</guid>    <pubDate>2026-01-30T03:30:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670487409803316" data-draft-id="7600665529113247744" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Okhttp3.11.0框架原理分析"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T03:30:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Okhttp3.11.0框架原理分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:30:05.000Z" title="Fri Jan 30 2026 03:30:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1.OkHttp用法</h3>
<p>(1).Get请求
new OkHttpClient ，构造Request对象，调用newCall方法获取Call对象，通过call#enqueue或者excute来提交请求。</p>
<pre><code class="hljs language-vbscript" lang="vbscript">String url = <span class="hljs-string">"http://wwww.baidu.com"</span>;
OkHttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();
          //POST提交表单
        FormBody formBody = <span class="hljs-keyword">new</span> FormBody.Builder()
                .add(<span class="hljs-string">"username"</span>, <span class="hljs-string">"your_username"</span>)
                .add(<span class="hljs-string">"password"</span>, <span class="hljs-string">"your_password"</span>)
                .build();
        <span class="hljs-built_in">Request</span> request1=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder().url(<span class="hljs-string">"url"</span>).post(formBody).build();
        //POST提交JSON
        MediaType mediaType = MediaType.<span class="hljs-keyword">get</span>(<span class="hljs-string">"application/json; charset=utf-8"</span>);
        String jsonBody = <span class="hljs-string">"{\"</span>key\<span class="hljs-string">":\"</span>value\<span class="hljs-string">"}"</span>;
        RequestBody body = RequestBody.create(mediaType,jsonBody);
        <span class="hljs-built_in">Request</span> request2=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder().url(<span class="hljs-string">""</span>).post(body).build();

<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span> = okHttpClient.newCall(request1);
<span class="hljs-keyword">call</span>.enqueue(<span class="hljs-keyword">new</span> Callback() {
    @Override
    <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) {
        Log.d(TAG, <span class="hljs-string">"onFailure: "</span>);
    }

    @Override
    <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException {
        Log.d(TAG, <span class="hljs-string">"onResponse: "</span> + <span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>());
    }
});

</code></pre>
<p>(2).Post请求
在构建Request对象的时候，需要多构造一个RequestBody对象，同时指定MediaType用于描述请求/响应body的内容类型
Post提交String</p>
<pre><code class="hljs language-vbscript" lang="vbscript">MediaType mediaType = MediaType.parse(<span class="hljs-string">"text/x-markdown; charset=utf-8"</span>);
String requestBody = <span class="hljs-string">"I am Jdqm."</span>;
<span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder()
        .url(<span class="hljs-string">"https://api.github.com/markdown/raw"</span>)
        .post(RequestBody.create(mediaType, requestBody))
        .build();
OkHttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();
okHttpClient.newCall(<span class="hljs-built_in">request</span>).enqueue(<span class="hljs-keyword">new</span> Callback() {
    @Override
    <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) {
        Log.d(TAG, <span class="hljs-string">"onFailure: "</span> + e.getMessage());
    }

    @Override
    <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException {
        Log.d(TAG, <span class="hljs-built_in">response</span>.protocol() + <span class="hljs-string">" "</span> +<span class="hljs-built_in">response</span>.code() + <span class="hljs-string">" "</span> + <span class="hljs-built_in">response</span>.message());
        Headers headers = <span class="hljs-built_in">response</span>.headers();
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; headers.size(); i++) {
            Log.d(TAG, headers.name(i) + <span class="hljs-string">":"</span> + headers.value(i));
        }
        Log.d(TAG, <span class="hljs-string">"onResponse: "</span> + <span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>());
    }
});

</code></pre>
<p>Post提交流</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">RequestBody</span> <span class="hljs-variable">requestBody</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestBody</span>() {
    <span class="hljs-meta">@Nullable</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> MediaType <span class="hljs-title function_">contentType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> MediaType.parse(<span class="hljs-string">"text/x-markdown; charset=utf-8"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeTo</span><span class="hljs-params">(BufferedSink sink)</span> <span class="hljs-keyword">throws</span> IOException {
        sink.writeUtf8(<span class="hljs-string">"I am Jdqm."</span>);
    }
};

<span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
        .url(<span class="hljs-string">"https://api.github.com/markdown/raw"</span>)
        .post(requestBody)
        .build();
<span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">okHttpClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>();
okHttpClient.newCall(request).enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> {
        Log.d(TAG, <span class="hljs-string">"onFailure: "</span> + e.getMessage());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException {
        Log.d(TAG, response.protocol() + <span class="hljs-string">" "</span> +response.code() + <span class="hljs-string">" "</span> + response.message());
        <span class="hljs-type">Headers</span> <span class="hljs-variable">headers</span> <span class="hljs-operator">=</span> response.headers();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; headers.size(); i++) {
            Log.d(TAG, headers.name(i) + <span class="hljs-string">":"</span> + headers.value(i));
        }
        Log.d(TAG, <span class="hljs-string">"onResponse: "</span> + response.body().string());
    }
});

</code></pre>
<p>Post提交文件</p>
<pre><code class="hljs language-vbscript" lang="vbscript">MediaType mediaType = MediaType.parse(<span class="hljs-string">"text/x-markdown; charset=utf-8"</span>);
OkHttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();
File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"test.md"</span>);
<span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder()
        .url(<span class="hljs-string">"https://api.github.com/markdown/raw"</span>)
        .post(RequestBody.create(mediaType, file))
        .build();
okHttpClient.newCall(<span class="hljs-built_in">request</span>).enqueue(<span class="hljs-keyword">new</span> Callback() {
    @Override
    <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) {
        Log.d(TAG, <span class="hljs-string">"onFailure: "</span> + e.getMessage());
    }

    @Override
    <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException {
        Log.d(TAG, <span class="hljs-built_in">response</span>.protocol() + <span class="hljs-string">" "</span> +<span class="hljs-built_in">response</span>.code() + <span class="hljs-string">" "</span> + <span class="hljs-built_in">response</span>.message());
        Headers headers = <span class="hljs-built_in">response</span>.headers();
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; headers.size(); i++) {
            Log.d(TAG, headers.name(i) + <span class="hljs-string">":"</span> + headers.value(i));
        }
        Log.d(TAG, <span class="hljs-string">"onResponse: "</span> + <span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>());
    }
});

</code></pre>
<p>Post提交表单</p>
<pre><code class="hljs language-vbscript" lang="vbscript">HttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();
RequestBody requestBody = <span class="hljs-keyword">new</span> FormBody.Builder()
        .add(<span class="hljs-string">"search"</span>, <span class="hljs-string">"Jurassic Park"</span>)
        .build();
<span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span> = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder()
        .url(<span class="hljs-string">"https://en.wikipedia.org/w/index.php"</span>)
        .post(requestBody)
        .build();

okHttpClient.newCall(<span class="hljs-built_in">request</span>).enqueue(<span class="hljs-keyword">new</span> Callback() {
    @Override
    <span class="hljs-keyword">public</span> void onFailure(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, IOException e) {
        Log.d(TAG, <span class="hljs-string">"onFailure: "</span> + e.getMessage());
    }

    @Override
    <span class="hljs-keyword">public</span> void onResponse(<span class="hljs-keyword">Call</span> <span class="hljs-keyword">call</span>, <span class="hljs-built_in">Response</span> <span class="hljs-built_in">response</span>) throws IOException {
        Log.d(TAG, <span class="hljs-built_in">response</span>.protocol() + <span class="hljs-string">" "</span> +<span class="hljs-built_in">response</span>.code() + <span class="hljs-string">" "</span> + <span class="hljs-built_in">response</span>.message());
        Headers headers = <span class="hljs-built_in">response</span>.headers();
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; headers.size(); i++) {
            Log.d(TAG, headers.name(i) + <span class="hljs-string">":"</span> + headers.value(i));
        }
        Log.d(TAG, <span class="hljs-string">"onResponse: "</span> + <span class="hljs-built_in">response</span>.body().<span class="hljs-built_in">string</span>());
    }
});
</code></pre>
<p>Post提交分块请求</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMGUR_CLIENT_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"..."</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MediaType</span> <span class="hljs-variable">MEDIA_TYPE_PNG</span> <span class="hljs-operator">=</span> MediaType.parse(<span class="hljs-string">"image/png"</span>);

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postMultipartBody</span><span class="hljs-params">()</span> {
    <span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>();


    <span class="hljs-comment">// Use the imgur image upload API as documented at https://api.imgur.com/endpoints/image</span>
    <span class="hljs-type">MultipartBody</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MultipartBody</span>.Builder(<span class="hljs-string">"AaB03x"</span>)
            .setType(MultipartBody.FORM)
            .addPart(
                    Headers.of(<span class="hljs-string">"Content-Disposition"</span>, <span class="hljs-string">"form-data; name=\"title\""</span>),
                    RequestBody.create(<span class="hljs-literal">null</span>, <span class="hljs-string">"Square Logo"</span>))
            .addPart(
                    Headers.of(<span class="hljs-string">"Content-Disposition"</span>, <span class="hljs-string">"form-data; name=\"image\""</span>),
                    RequestBody.create(MEDIA_TYPE_PNG, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"website/static/logo-square.png"</span>)))
            .build();

    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
            .header(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Client-ID "</span> + IMGUR_CLIENT_ID)
            .url(<span class="hljs-string">"https://api.imgur.com/3/image"</span>)
            .post(body)
            .build();

    <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> client.newCall(request);
    call.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> {

        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException {
            System.out.println(response.body().string());

        }

    });
}

</code></pre>
<h3 data-id="heading-1">2.OkHttp原理</h3>
<h5 data-id="heading-2">(2.1).初步流程图</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53d150a26c59448197b5dec9a22a5a64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770348605&amp;x-signature=ZznPvO2Ve3QszU9EI4iKAqPcGE8%3D" alt="eff4d373e7e0a05fb515b1639ada95f.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dd78e0211e348129d6b4c766ad6f1e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770348605&amp;x-signature=rVmGj%2BT4g6T0e3MKux1H54b9dHw%3D" alt="d5257a27653fd67774db4ed837d9ce7.jpg" loading="lazy"/></p>
<h5 data-id="heading-3">(2.2). OkHttp.newCall()流程分析</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//基本使用</span>
 OkHttpClient okHttpClient=<span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>().newBuilder().build();
        Request request=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder().build();
        Call realCall= okHttpClient.newCall(request);
        realCall.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() { 
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> {

            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException {

            }
        });

 <span class="hljs-keyword">static</span> RealCall <span class="hljs-title function_">newRealCall</span><span class="hljs-params">(OkHttpClient client, Request originalRequest, <span class="hljs-type">boolean</span> forWebSocket)</span> {
    <span class="hljs-comment">// Safely publish the Call instance to the EventListener.</span>
    <span class="hljs-type">RealCall</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealCall</span>(client, originalRequest, forWebSocket); <span class="hljs-comment">//实例化一个RealCall对象</span>
    call.eventListener = client.eventListenerFactory().create(call);
    <span class="hljs-keyword">return</span> call;
  }
 <span class="hljs-comment">//RealCall构造函数</span>
 <span class="hljs-keyword">private</span> <span class="hljs-title function_">RealCall</span><span class="hljs-params">(OkHttpClient client, Request originalRequest, <span class="hljs-type">boolean</span> forWebSocket)</span> {
    <span class="hljs-built_in">this</span>.client = client;
    <span class="hljs-built_in">this</span>.originalRequest = originalRequest; <span class="hljs-comment">//初始化Request</span>
    <span class="hljs-built_in">this</span>.forWebSocket = forWebSocket;
    <span class="hljs-comment">//初始化重试（重定向）拦截器</span>
    <span class="hljs-built_in">this</span>.retryAndFollowUpInterceptor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RetryAndFollowUpInterceptor</span>(client, forWebSocket);
  }
</code></pre>
<h5 data-id="heading-4">2.3.enqueue流程分析</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//RealCall中</span>
 public void <span class="hljs-built_in">enqueue</span>(Callback responseCallback) {
   <span class="hljs-comment">//调用Dispatcher把AsyncCall加入队列</span>
    client<span class="hljs-selector-class">.dispatcher</span>()<span class="hljs-selector-class">.enqueue</span>(new AsyncCall(responseCallback)); 
  }

<span class="hljs-comment">//Dispatcher中</span>
  synchronized void <span class="hljs-built_in">enqueue</span>(AsyncCall call) {
    <span class="hljs-comment">//如果请求数小于64且同一域名请求小于5个，就把AsyncCall加入runningAsyncCalls队列，然后启动线程池执行，否则就把AsyncCall放入readAsyncCalls队列。</span>
    if (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; <span class="hljs-built_in">runningCallsForHost</span>(call) &lt; maxRequestsPerHost) {
      runningAsyncCalls<span class="hljs-selector-class">.add</span>(call);
      <span class="hljs-built_in">executorService</span>()<span class="hljs-selector-class">.execute</span>(call);
    } else {
      readyAsyncCalls<span class="hljs-selector-class">.add</span>(call);
    }
  }
<span class="hljs-comment">//线程池创建</span>
  public synchronized ExecutorService <span class="hljs-built_in">executorService</span>() {
    if (executorService == null) {
      executorService = new <span class="hljs-built_in">ThreadPoolExecutor</span>(<span class="hljs-number">0</span>, Integer.MAX_VALUE, <span class="hljs-number">60</span>, TimeUnit.SECONDS,
          new SynchronousQueue&lt;Runnable&gt;(), Util<span class="hljs-selector-class">.threadFactory</span>("OkHttp Dispatcher", false));
    }
    return executorService;
  }

</code></pre>
<h5 data-id="heading-5">2.4.AsyncCall</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncCall</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NamedRunnable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Callback responseCallback;
    AsyncCall(Callback responseCallback) {
      <span class="hljs-built_in">super</span>(<span class="hljs-string">"OkHttp %s"</span>, redactedUrl());
      <span class="hljs-built_in">this</span>.responseCallback = responseCallback;
    }

  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> {
      <span class="hljs-type">boolean</span> <span class="hljs-variable">signalledCallback</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">try</span> {
        <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> getResponseWithInterceptorChain();
        <span class="hljs-keyword">if</span> (retryAndFollowUpInterceptor.isCanceled()) {
          signalledCallback = <span class="hljs-literal">true</span>;
          responseCallback.onFailure(RealCall.<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">"Canceled"</span>));
        } <span class="hljs-keyword">else</span> {
          signalledCallback = <span class="hljs-literal">true</span>;
          responseCallback.onResponse(RealCall.<span class="hljs-built_in">this</span>, response);
        }
      } <span class="hljs-keyword">catch</span> (IOException e) {
        <span class="hljs-keyword">if</span> (signalledCallback) {
          Platform.get().log(INFO, <span class="hljs-string">"Callback failure for "</span> + toLoggableString(), e);
        } <span class="hljs-keyword">else</span> {
          eventListener.callFailed(RealCall.<span class="hljs-built_in">this</span>, e);
          responseCallback.onFailure(RealCall.<span class="hljs-built_in">this</span>, e);
        }
      } <span class="hljs-keyword">finally</span> {
        client.dispatcher().finished(<span class="hljs-built_in">this</span>); 
      }
    }
  }
 <span class="hljs-comment">//把请求队列从runningAsyncCalls中移除，</span>
 <span class="hljs-keyword">void</span> <span class="hljs-title function_">finished</span><span class="hljs-params">(AsyncCall call)</span> {
    finished(runningAsyncCalls, call, <span class="hljs-literal">true</span>);
  }

 <span class="hljs-keyword">private</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">finished</span><span class="hljs-params">(Deque&lt;T&gt; calls, T call, <span class="hljs-type">boolean</span> promoteCalls)</span> {
    <span class="hljs-type">int</span> runningCallsCount;
    Runnable idleCallback;
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
     <span class="hljs-comment">//把AsyncCall从runningAsyncCalsl中移除</span>
      <span class="hljs-keyword">if</span> (!calls.remove(call)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">"Call wasn't in-flight!"</span>);
      <span class="hljs-keyword">if</span> (promoteCalls) promoteCalls();
      runningCallsCount = runningCallsCount();
      idleCallback = <span class="hljs-built_in">this</span>.idleCallback;
    }
    <span class="hljs-keyword">if</span> (runningCallsCount == <span class="hljs-number">0</span> &amp;&amp; idleCallback != <span class="hljs-literal">null</span>) {
          idleCallback.run();
    }
  }

<span class="hljs-comment">//然后遍历readyAsyncCalls队列，取出AysncCall加入到runningAsyncs队列，启动线程池立即执行。</span>
 <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">promoteCalls</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (runningAsyncCalls.size() &gt;= maxRequests) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Already running max capacity.</span>
    <span class="hljs-keyword">if</span> (readyAsyncCalls.isEmpty()) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// No ready calls to promote.</span>
    <span class="hljs-keyword">for</span> (Iterator&lt;AsyncCall&gt; i = readyAsyncCalls.iterator(); i.hasNext(); ) {
      <span class="hljs-type">AsyncCall</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> i.next();
      <span class="hljs-keyword">if</span> (runningCallsForHost(call) &lt; maxRequestsPerHost) {
        i.remove();
        runningAsyncCalls.add(call);
        executorService().execute(call);
      }
      <span class="hljs-keyword">if</span> (runningAsyncCalls.size() &gt;= maxRequests) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Reached max capacity.</span>
    }
  }
</code></pre>
<h5 data-id="heading-6">2.5.getResponseWithInterceptorChain()流程分析</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6664c0f87d0248b7be2b70668bb5c42c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770348605&amp;x-signature=Fm5JDnEQVaLzyi7ps9rG1cVRL4Y%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-function">Response <span class="hljs-title">getResponseWithInterceptorChain</span>() throws IOException</span> {
    <span class="hljs-comment">// Build a full stack of interceptors.</span>
    List&lt;Interceptor&gt; interceptors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    interceptors.addAll(client.interceptors());<span class="hljs-comment">//自定义拦截器</span>
<span class="hljs-comment">/* 重试拦截器，判断用户是否取消了请求，在获得结果之后，会根据响应码判断是否需要重定向*/</span>
    interceptors.<span class="hljs-keyword">add</span>(retryAndFollowUpInterceptor);
<span class="hljs-comment">/* 桥接拦截器，负责在http协议中加入必备字段如：host:192.168..0.1:8080,accept encodeing:gzip,connection:keep alive ,在获得结果之后，调用保存cookie接口并解析Gzip数据.*/</span>
    interceptors.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> BridgeInterceptor(client.cookieJar()));
<span class="hljs-comment">/*发起http请求的时候，会尝试读取缓存的响应数据，如果缓存存在有效数据，并满足缓存策略，则直接
返回缓存的数据，避免再次进行网络请求，如果不存在，会生成一个缓存策略，根据缓存策略指示，是否需要网络请求 */</span>
    interceptors.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> CacheInterceptor(client.internalCache()));
<span class="hljs-comment">/*负责建立一个新的tcp/ip连接，并获得对应的socket流*/</span>
    interceptors.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> ConnectInterceptor(client));
    <span class="hljs-keyword">if</span> (!forWebSocket) {
      interceptors.addAll(client.networkInterceptors());
    }
<span class="hljs-comment">/*利用得到的socket.getOutputStream 向服务器发送Http请求,解析读取的响应数据，并将数据封装成response对象返回.*/</span>
    interceptors.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> CallServerInterceptor(forWebSocket));

    Interceptor.Chain chain = <span class="hljs-keyword">new</span> RealInterceptorChain(interceptors, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>,
        originalRequest, <span class="hljs-keyword">this</span>, eventListener, client.connectTimeoutMillis(),
        client.readTimeoutMillis(), client.writeTimeoutMillis());

    <span class="hljs-keyword">return</span> chain.proceed(originalRequest);
  }
</code></pre>
<h5 data-id="heading-7">2.6.Interceptor接口</h5>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Interceptor</span> {
  <span class="hljs-function">Response <span class="hljs-title">intercept</span>(<span class="hljs-params">Chain chain</span>)</span> ;
  <span class="hljs-keyword">interface</span> <span class="hljs-title">Chain</span> {
    <span class="hljs-function">Request <span class="hljs-title">request</span>()</span>;
    <span class="hljs-function">Response <span class="hljs-title">proceed</span>(<span class="hljs-params">Request request</span>)</span> ;
}

</code></pre>
<h5 data-id="heading-8">2.7.RealInterceptors实现类</h5>
<pre><code class="hljs language-ini" lang="ini">public final class RealInterceptorChain implements Interceptor.Chain {

     public RealInterceptorChain(List&lt;Interceptor&gt; interceptors, int index, Request request){
             <span class="hljs-attr">this.interceptors</span> = interceptors<span class="hljs-comment">;</span>
             <span class="hljs-attr">this.index</span> = index<span class="hljs-comment">; </span>
             <span class="hljs-attr">this.request</span> = request<span class="hljs-comment">;</span>
     }
     public Response proceed(Request request){
          //index+1,可以在RealInterceptorChain中调用下一个Interceptor
          RealInterceptorChain <span class="hljs-attr">next</span> = new RealInterceptorChain(interceptors,  index + <span class="hljs-number">1</span>, request）<span class="hljs-comment">;</span>
          Interceptor <span class="hljs-attr">interceptor</span> = interceptors.get(index)<span class="hljs-comment">;//得到当前责任人</span>
          Response <span class="hljs-attr">response</span> = interceptor.intercept(next)<span class="hljs-comment">;</span>
          return    response<span class="hljs-comment">;    </span>
     }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SystemServer启动AMS,ATMS,WMS,PMS流程]]></title>    <link>https://juejin.cn/post/7600665529113051136</link>    <guid>https://juejin.cn/post/7600665529113051136</guid>    <pubDate>2026-01-30T03:06:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600665529113051136" data-draft-id="7600704706550612008" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SystemServer启动AMS,ATMS,WMS,PMS流程"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T03:06:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SystemServer启动AMS,ATMS,WMS,PMS流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:06:21.000Z" title="Fri Jan 30 2026 03:06:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=http%3A%2F%2Fliuwangshu.cn%2Fframework%2Fbooting%2F3-syetemserver.html" target="_blank" title="http://liuwangshu.cn/framework/booting/3-syetemserver.html" ref="nofollow noopener noreferrer">解析SyetemServer进程启动过程</a></p>
<h3 data-id="heading-0">1.解析SystemServer进程</h3>
<p>我们来看下SystemServer的mai函数</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">mian</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>){
     <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemServer</span>().<span class="hljs-title function_">run</span>();
}
</code></pre>
<p>main函数只调用了run函数</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">run</span>() {
       ...
           System<span class="hljs-selector-class">.loadLibrary</span>("android_servers");<span class="hljs-comment">//1.加载so库</span>
       ...
           <span class="hljs-comment">//2.创建 SystemServiceManager， 创建并启动系统的各种服务 </span>
           mSystemServiceManager = new <span class="hljs-built_in">SystemServiceManager</span>(mSystemContext);
           LocalServices<span class="hljs-selector-class">.addService</span>(SystemServiceManager.class, mSystemServiceManager);
       ...    
        try {
           Trace<span class="hljs-selector-class">.traceBegin</span>(Trace.TRACE_TAG_SYSTEM_SERVER, "StartServices");
           <span class="hljs-built_in">startBootstrapServices</span>();<span class="hljs-comment">//3.启动了AMS ,ATMS,PMS ...</span>
           <span class="hljs-built_in">startCoreServices</span>();<span class="hljs-comment">//4.启动BatteryService，WebViewUpdateService,GpuService...</span>
       <span class="hljs-comment">//5.启动WMS,CameraService,BluetoothService,AudioService,LocationManagerService</span>
           <span class="hljs-built_in">startOtherServices</span>();
       } catch (Throwable ex) {
           Slog<span class="hljs-selector-class">.e</span>("System", "******************************************");
           Slog<span class="hljs-selector-class">.e</span>("System", "************ Failure starting system services", ex);
           throw ex;
       } finally {
           Trace<span class="hljs-selector-class">.traceEnd</span>(Trace.TRACE_TAG_SYSTEM_SERVER);
       }
       ...
   }
</code></pre>
<p>看下startBootstrapServices函数</p>
<pre><code class="hljs language-less" lang="less"> <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">startBootstrapServices</span>(<span class="hljs-variable">@NonNull</span> TimingsTraceAndSlog t) {
   <span class="hljs-comment">//1.创建并启动ATMS ,ServiceManager.addService("activity_task",atm)</span>
     <span class="hljs-selector-tag">ActivityTaskManagerService</span> <span class="hljs-selector-tag">atm</span> = <span class="hljs-selector-tag">mSystemServiceManager</span><span class="hljs-selector-class">.startService</span>(
    ActivityTaskManagerService.Lifecycle.class)<span class="hljs-selector-class">.getService</span>();
   <span class="hljs-comment">// 2.创建并启动AMS </span>
   <span class="hljs-selector-tag">mActivityManagerService</span> = <span class="hljs-selector-tag">ActivityManagerService</span><span class="hljs-selector-class">.Lifecycle</span><span class="hljs-selector-class">.startService</span>(
               mSystemServiceManager, atm);
 <span class="hljs-comment">// 注册binder,ServiceManager.addService("activity",mActivityManagerService)</span>
   <span class="hljs-selector-tag">mActivityManagerService</span><span class="hljs-selector-class">.setSystemProcess</span>();
<span class="hljs-comment">//3.创建并注册PMS,  注册binder, ServiceManager.addService("package", iPackageManager);</span>
<span class="hljs-selector-tag">PackageManagerService</span><span class="hljs-selector-class">.main</span>()
}
</code></pre>
<p>看下startOtherServices函数</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">startOtherServices</span>(<span class="hljs-variable">@NonNull</span> TimingsTraceAndSlog t) {
   <span class="hljs-comment">//创建WMS，并启动</span>
    <span class="hljs-selector-tag">wm</span> = <span class="hljs-selector-tag">WindowManagerService</span><span class="hljs-selector-class">.main</span>(context, inputManager, !mFirstBoot, mOnlyCore,
                    new <span class="hljs-built_in">PhoneWindowManager</span>(), mActivityManagerService.mActivityTaskManager);
    <span class="hljs-comment">//注册binder服务</span>
   <span class="hljs-selector-tag">ServiceManager</span><span class="hljs-selector-class">.addService</span>(Context.WINDOW_SERVICE, wm, false,
                    DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);
  <span class="hljs-comment">// AMS和WMS关联上</span>
    <span class="hljs-selector-tag">mActivityManagerService</span><span class="hljs-selector-class">.setWindowManager</span>(wm);
}

</code></pre>
<h3 data-id="heading-1">2.ATMS和AMS的区别</h3>
<p>AMS以前是管理四大组件，太庞大了,所以为了给AMS减压，把对Activity的管理抽到了ATMS.</p>
<h3 data-id="heading-2">3.AMS,WMS,PMS添加到SErviceManager</h3>
<pre><code class="hljs language-arduino" lang="arduino">
<span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> ACTIVITY_SERVICE = <span class="hljs-string">"activity"</span>;  
<span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> WINDOW_SERVICE = <span class="hljs-string">"window"</span>;  
<span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> PACKAGE_SERVICE = <span class="hljs-string">"package"</span>;  
<span class="hljs-comment">//添加到ServiceManager</span>
AMS:ServiceManager.<span class="hljs-built_in">addService</span>(Context.ACTIVITY_SERVICE, <span class="hljs-keyword">this</span>, <span class="hljs-literal">true</span>); 
WMS: ServiceManager.<span class="hljs-built_in">addService</span>(Context.WINDOW_SERVICE, wm);  
PMS:ServiceManager.<span class="hljs-built_in">addService</span>(<span class="hljs-string">"PACKAGE_SERVICE"</span>, m);
<span class="hljs-comment">//通过ServiceManager获取服务</span>
ServiceManager.<span class="hljs-built_in">getService</span>(<span class="hljs-string">"activity"</span>));
ServiceManager.<span class="hljs-built_in">getService</span>(<span class="hljs-string">"window"</span>));
ServiceManager.<span class="hljs-built_in">getService</span>(<span class="hljs-string">"package"</span>));

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[图文] 手把手教你Windows安装ClaudeCode，接入方舟CodingPlan的kimi-k2.5和glm-4.7]]></title>    <link>https://juejin.cn/post/7600629210156171270</link>    <guid>https://juejin.cn/post/7600629210156171270</guid>    <pubDate>2026-01-29T16:42:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600629210156171270" data-draft-id="7600637595944927274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[图文] 手把手教你Windows安装ClaudeCode，接入方舟CodingPlan的kimi-k2.5和glm-4.7"/> <meta itemprop="keywords" content="Claude,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T16:42:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洪哥等风来"/> <meta itemprop="url" content="https://juejin.cn/user/3562073402390749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [图文] 手把手教你Windows安装ClaudeCode，接入方舟CodingPlan的kimi-k2.5和glm-4.7
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073402390749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洪哥等风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T16:42:19.000Z" title="Thu Jan 29 2026 16:42:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文将指导你在 Windows 系统上安装 <code>ClaudeCode</code>，并配置接入火山方舟 CodingPlan 中的 <code>kimi-k2.5</code> 和 <code>glm-4.7</code>。全程不需要魔法梯子，也不需要安装 WSL 虚拟机，大家按教程步骤走就好。</p>
<p>本教程适合 0 基础小白逐步对照配置，也适合编程老手直接扫一眼该教程，大概就懂了怎么配置。</p>
<hr/>
<h3 data-id="heading-1">1. 推荐配置</h3>
<p>就像打游戏有推荐配置一样，ClaudeCode 的推荐配置比较简单：</p>
<ul>
<li><strong>操作系统</strong>：推荐 <code>Win11</code>，最低支持 <code>Win10</code>（Win7 不适用）</li>
<li><strong>Node.js</strong>：推荐版本 <code>v22.20.0 LTS</code>，最低支持到 <code>v18.20.8</code>（需要 npm 工具）</li>
<li><strong>Git</strong>：推荐最新版</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 安装 Node.js</h3>
<h4 data-id="heading-3">2.1 下载 Node.js</h4>
<p>进入 Node.js 官方下载界面：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn%2Fdownload" target="_blank" title="https://nodejs.org/zh-cn/download" ref="nofollow noopener noreferrer">nodejs.org/zh-cn/downl…</a></p>
<h4 data-id="heading-4">2.2 选择版本并下载</h4>
<p>选择 Node.js 版本 + 操作系统 + 架构，把 msi 文件下载到本地：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7610c3c51953447e8455f59e8d5c93d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=OJlwoHk5LuzMLNq3n4Fw9zsQPhc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">2.3 安装 Node.js</h4>
<p>下载完后双击安装，无脑 Next 直到安装完成点击 Finish：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d8454182d8e4a8ea5d5f9f0a1f7fd53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=mGc9L0zdizz9ZHYhoY3cAIzHs7c%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">2.4 验证安装并解决权限问题</h4>
<ol>
<li>
<p>搜索 PowerShell 并打开，输入以下命令检查 npm 版本：</p>
<pre><code class="hljs language-powershell" lang="powershell">npm -v
</code></pre>
</li>
<li>
<p>可能会遇到 PowerShell 执行策略错误：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">npm :</span> <span class="hljs-string">无法加载文件</span> <span class="hljs-string">C:\Program</span> <span class="hljs-string">Files\nodejs\npm.ps1，因为在此系统上禁止运行脚本。</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfa86698d63044d9a644fe657d9b8723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=jNZijRaCrkt4JjB%2FE1EUIH48%2Bd0%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>解决方法：运行以下命令解除限制（需要输入 <code>Y</code> 确认）：</p>
<pre><code class="hljs language-powershell" lang="powershell">Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b10f6e3528a943fe80beb8b4f0a76eac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=N5jFAuGH89gr6R2tiTADebgP%2F8o%3D" alt="" loading="lazy"/></p>
</li>
</ol>
<h4 data-id="heading-7">2.5 备选方案：使用 CMD</h4>
<p>如果在公司电脑上不允许更改安全策略，可以使用 CMD 替代 PowerShell，后续步骤将 PowerShell 换成 CMD 即可：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94ded24de385426aac9a3f66061901c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=kcL%2BOExuVnw4dILg%2F9sbnLcph0s%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-8">3. 安装 Git</h3>
<h4 data-id="heading-9">3.1 下载 Git</h4>
<p>进入 Git 官方下载界面：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Fdownloads%2Fwin" target="_blank" title="https://git-scm.com/downloads/win" ref="nofollow noopener noreferrer">git-scm.com/downloads/w…</a></p>
<h4 data-id="heading-10">3.2 选择版本并下载</h4>
<p>选择适合自己的版本进行下载，一般选择 "Git for Windows/x64 Setup"。</p>
<h4 data-id="heading-11">3.3 安装 Git</h4>
<p>双击安装，也是无脑下一步直到最后 Finish。</p>
<h4 data-id="heading-12">3.4 验证安装</h4>
<p>在 PowerShell 中输入以下命令检查 Git 版本：</p>
<pre><code class="hljs language-powershell" lang="powershell">git -v
</code></pre>
<p>有版本号输出就证明安装成功：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d78f03a9e99a454dbf783d8ac803f4a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=5HJDU0uPPSXkdWO2UmBSzMgwSRM%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-13">4. 安装 Claude Code</h3>
<h4 data-id="heading-14">4.1 安装命令</h4>
<p>在 PowerShell 中使用 npm 工具安装 ClaudeCode：</p>
<pre><code class="hljs language-powershell" lang="powershell">npm install -g @anthropic-ai/claude-code
</code></pre>
<h4 data-id="heading-15">4.2 验证安装成功</h4>
<p>安装成功后会看到相应的提示信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67b47fc993b84bb48cf21a1524debd0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=LIdsji5Ur8LsB7r2FSmTdtOtSG8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-16">4.3 首次启动测试</h4>
<p>打开 PowerShell，输入以下命令尝试进入 Claude Code：</p>
<pre><code class="hljs language-powershell" lang="powershell">claude
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53721fc46d9f4916a7be5187fab4717a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=Z7IeALX1U45qa0wkUPAMOit76MU%3D" alt="" loading="lazy"/></p>
<p>如果显示如下界面，证明安装成功了。红色报错是因为 Claude 禁止中国访问，我们在下面的步骤中会把模型替换为 <code>kimi-k2.5</code> 和 <code>glm-4.7</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7edd872dbcec41fca6e2bed99fea3f45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=K2FQXD0SKWj%2FzUMeSRHht4j9zsE%3D" alt="" loading="lazy"/></p>
<p>到这里可以先把窗口关闭掉了，我们去申请模型的 API Key。</p>
<hr/>
<h3 data-id="heading-17">5. 获取火山 CodingPlan 的 API Key</h3>
<h4 data-id="heading-18">5.1 访问方舟 CodingPlan 页面</h4>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvolcengine.com%2FL%2FvAgAgZgPA80%2F" target="_blank" title="https://volcengine.com/L/vAgAgZgPA80/" ref="nofollow noopener noreferrer">方舟 CodingPlan</a> 页面，按需订阅套餐。</p>
<h4 data-id="heading-19">5.2 创建 API Key</h4>
<ol>
<li>注册后进入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.volcengine.com%2Fark%2Fregion%3Aark%2Bcn-beijing%2FopenManagement%3FLLM%3D%257B%257D%26advancedActiveKey%3Dsubscribe" target="_blank" title="https://console.volcengine.com/ark/region:ark+cn-beijing/openManagement?LLM=%7B%7D&amp;advancedActiveKey=subscribe" ref="nofollow noopener noreferrer">火山方舟管理控制台</a></li>
<li>按顺序点击：<code>API Key管理</code> -&gt; <code>创建API Key</code> -&gt; <code>输入一个名字来标识这个key</code> -&gt; <code>创建</code></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a213d773c534a0cb95269ac3e7cd988~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=phmMZjzeoyowzdD2GYxA5ncRz6Y%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-20">5.3 查看 API Key</h4>
<p>申请成功后就能看到这个 API Key 了，后续我们就用这个 API Key 来访问模型：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c49d2319cc9410187ab86e0c9e0e288~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=bp3g4HFNEyaM0wEva5Hofw7f1Fw%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-21">6. 配置 kimi-k2.5 或 glm-4.7 到 ClaudeCode</h3>
<h4 data-id="heading-22">6.1 打开系统环境变量设置</h4>
<p>在 Windows 搜索栏中输入 <code>环境变量</code>，并选择 <code>编辑系统环境变量</code>。</p>
<h4 data-id="heading-23">6.2 进入环境变量配置</h4>
<p>在 <code>系统属性</code> 窗口中，点击 <code>环境变量...</code>。</p>
<h4 data-id="heading-24">6.3 添加环境变量</h4>
<p>在 <code>用户变量</code> 区域，点击 <code>新建...</code>，并依次添加以下 3 个新变量：</p>

























<table><thead><tr><th>变量名</th><th>值</th><th>说明</th></tr></thead><tbody><tr><td><strong>ANTHROPIC_AUTH_TOKEN</strong></td><td><code>bb24267b-xxxx-xxxx-xxxx-dcadfb91eec9</code></td><td>需要替换成你刚才申请好的 API Key</td></tr><tr><td><strong>ANTHROPIC_BASE_URL</strong></td><td><code>https://ark.cn-beijing.volces.com/api/coding</code></td><td>访问模型的固定网址</td></tr><tr><td><strong>ANTHROPIC_MODEL</strong></td><td><code>kimi-k2.5</code></td><td>可选值：<code>kimi-k2.5</code>、<code>glm-4.7</code>、<code>deepseek-v3.2</code>、<code>kimi-k2-thinking</code>、<code>doubao-seed-code</code>，推荐填写 <code>kimi-k2.5</code> 或 <code>glm-4.7</code></td></tr></tbody></table>
<p>配置好后如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5617069e34564575afb404f96efbd34b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=0btkf2f%2Bm5q55oVs9FMF3Q8CIyM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-25">6.4 验证配置</h4>
<p>保存所有的环境变量后，<strong>新打开一个 PowerShell（注意要新打开，否则环境变量可能没更新）</strong>，再次进入 <code>claude</code>，如果不再报错并进入到初始化设置，就证明成功了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6907491cdb64731aa79cc9f3e675d1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=9Pa9Zwo8ENprhaPG03ELNCLTE9c%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-26">6.5 初始化设置</h4>
<p>初始化设置可以无脑回车，直到出现对话框，并有 <code>kimi-k2.5</code> 或你刚才配置好的模型的字样，就证明完全进来了。我们可以让他自我介绍一下，如果能收到回复就说明完全 ok 了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/decbaaad2f47470bb3bfb3167296d8b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=FU8ChITDtlZnwW2aBlzzFaF4cvM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-27">6.6 安全提示</h4>
<p>后续就可以切换到自己的项目路径下，然后启动 Claude 工具了。<em><strong>注意教程中的演示有一些在 C 盘，这是危险的操作，最多让 AI 自我介绍一下，不要给他发其他命令！</strong></em></p>
<hr/>
<h3 data-id="heading-28">7. 使用 Claude Code VSCode 插件</h3>
<h4 data-id="heading-29">7.1 安装插件</h4>
<p>打开 VSCode，在扩展市场搜索 <code>claude code</code> 进行安装：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9e2cfde10284401b5a1de059791b866~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=pPDJthLpMbFB4HTdvosPXTXIzqU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-30">7.2 开始使用</h4>
<p>安装完成后，点击 VSCode 右上角的 Claude Code 图标，进入 Claude Code 页面，待初始化完成后即可开始使用：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bdada187a45471689a5b21d4d7cf9f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSq5ZOl562J6aOO5p2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770311496&amp;x-signature=UofmyAesuDKZjXrxzmJtWIhLeJ4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Chatbot 开发入门指南：从零构建智能对话机器人]]></title>    <link>https://juejin.cn/post/7600629210156072966</link>    <guid>https://juejin.cn/post/7600629210156072966</guid>    <pubDate>2026-01-29T16:10:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600629210156072966" data-draft-id="7600663744192921636" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chatbot 开发入门指南：从零构建智能对话机器人"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-29T16:10:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hahaniu666"/> <meta itemprop="url" content="https://juejin.cn/user/3227821870678023"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chatbot 开发入门指南：从零构建智能对话机器人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821870678023/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hahaniu666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T16:10:28.000Z" title="Thu Jan 29 2026 16:10:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：Chatbot 正在改变人机交互</h2>
<p>从客服机器人到智能助手，从代码助手到知识问答，Chatbot 已经成为现代应用不可或缺的一部分。2025 年，随着大语言模型（LLM）的普及，构建一个智能 Chatbot 变得前所未有的简单。</p>
<p>本文将带你从零开始，了解 Chatbot 的核心原理，掌握主流开发框架，并动手构建一个基于 RAG（检索增强生成）的智能问答机器人。</p>
<hr/>
<h2 data-id="heading-1">一、Chatbot 的核心技术栈</h2>
<h3 data-id="heading-2">1.1 基础架构</h3>
<p>一个现代 Chatbot 通常包含以下组件：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户输入 → 意图识别 → 上下文管理 → 响应生成 → 输出回复
<span class="hljs-code">    ↑                                              ↓
    └────────────── 记忆存储 ←─────────────────────┘
</span></code></pre>
<h3 data-id="heading-3">1.2 主流技术方案</h3>



































<table><thead><tr><th>方案</th><th>适用场景</th><th>技术难度</th><th>代表框架</th></tr></thead><tbody><tr><td>基于规则</td><td>固定流程、简单问答</td><td>低</td><td>正则表达式、状态机</td></tr><tr><td>基于检索</td><td>FAQ、知识库问答</td><td>中</td><td>Elasticsearch、向量数据库</td></tr><tr><td>基于生成</td><td>开放式对话、创意写作</td><td>高</td><td>GPT、Claude、Llama</td></tr><tr><td>RAG 混合</td><td>企业知识库、专业问答</td><td>中</td><td>LangChain、LlamaIndex</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、快速上手：用 Python 构建基础 Chatbot</h2>
<h3 data-id="heading-5">2.1 环境准备</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建虚拟环境</span>
python -m venv chatbot-env
<span class="hljs-built_in">source</span> chatbot-env/bin/activate  <span class="hljs-comment"># Linux/Mac</span>
<span class="hljs-comment"># chatbot-env\Scripts\activate  # Windows</span>

<span class="hljs-comment"># 安装依赖</span>
pip install openai langchain streamlit
</code></pre>
<h3 data-id="heading-6">2.2 最简单的 Chatbot</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> openai

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleChatbot</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, api_key</span>):
        self.client = openai.OpenAI(api_key=api_key)
        self.history = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self, user_input</span>):
        <span class="hljs-comment"># 添加用户消息到历史</span>
        self.history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_input})
        
        <span class="hljs-comment"># 调用大模型</span>
        response = self.client.chat.completions.create(
            model=<span class="hljs-string">"gpt-3.5-turbo"</span>,
            messages=self.history
        )
        
        <span class="hljs-comment"># 获取回复并添加到历史</span>
        reply = response.choices[<span class="hljs-number">0</span>].message.content
        self.history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: reply})
        
        <span class="hljs-keyword">return</span> reply

<span class="hljs-comment"># 使用示例</span>
bot = SimpleChatbot(api_key=<span class="hljs-string">"your-api-key"</span>)
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"你: "</span>)
    <span class="hljs-keyword">if</span> user_input.lower() == <span class="hljs-string">"exit"</span>:
        <span class="hljs-keyword">break</span>
    reply = bot.chat(user_input)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"机器人: <span class="hljs-subst">{reply}</span>"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-7">三、进阶：使用 LangChain 构建 RAG Chatbot</h2>
<p>RAG（Retrieval-Augmented Generation，检索增强生成）让 Chatbot 能够基于私有知识库回答问题，是企业级应用的首选方案。</p>
<h3 data-id="heading-8">3.1 完整代码示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> TextLoader
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> OpenAIEmbeddings, ChatOpenAI
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> ConversationalRetrievalChain
<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGChatbot</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, api_key, knowledge_file</span>):
        <span class="hljs-comment"># 1. 加载知识库文档</span>
        loader = TextLoader(knowledge_file)
        documents = loader.load()
        
        <span class="hljs-comment"># 2. 文档切分</span>
        <span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> CharacterTextSplitter
        text_splitter = CharacterTextSplitter(
            chunk_size=<span class="hljs-number">1000</span>,
            chunk_overlap=<span class="hljs-number">200</span>
        )
        texts = text_splitter.split_documents(documents)
        
        <span class="hljs-comment"># 3. 创建向量数据库</span>
        embeddings = OpenAIEmbeddings(openai_api_key=api_key)
        self.vectorstore = FAISS.from_documents(texts, embeddings)
        
        <span class="hljs-comment"># 4. 初始化对话记忆</span>
        self.memory = ConversationBufferMemory(
            memory_key=<span class="hljs-string">"chat_history"</span>,
            return_messages=<span class="hljs-literal">True</span>
        )
        
        <span class="hljs-comment"># 5. 创建对话链</span>
        llm = ChatOpenAI(
            openai_api_key=api_key,
            model=<span class="hljs-string">"gpt-3.5-turbo"</span>,
            temperature=<span class="hljs-number">0.7</span>
        )
        
        self.qa_chain = ConversationalRetrievalChain.from_llm(
            llm=llm,
            retriever=self.vectorstore.as_retriever(),
            memory=self.memory
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ask</span>(<span class="hljs-params">self, question</span>):
        <span class="hljs-string">"""提问并获取回答"""</span>
        response = self.qa_chain.invoke({<span class="hljs-string">"question"</span>: question})
        <span class="hljs-keyword">return</span> response[<span class="hljs-string">"answer"</span>]

<span class="hljs-comment"># 使用示例</span>
bot = RAGChatbot(
    api_key=<span class="hljs-string">"your-api-key"</span>,
    knowledge_file=<span class="hljs-string">"knowledge.txt"</span>  <span class="hljs-comment"># 你的知识库文件</span>
)

<span class="hljs-comment"># 开始对话</span>
<span class="hljs-built_in">print</span>(bot.ask(<span class="hljs-string">"公司的年假政策是什么？"</span>))
<span class="hljs-built_in">print</span>(bot.ask(<span class="hljs-string">"我需要准备什么材料？"</span>))
</code></pre>
<h3 data-id="heading-9">3.2 代码解析</h3>

































<table><thead><tr><th>组件</th><th>作用</th></tr></thead><tbody><tr><td>Document Loader</td><td>加载各种格式的文档（PDF、TXT、Markdown）</td></tr><tr><td>Text Splitter</td><td>将长文档切分成小块，便于检索</td></tr><tr><td>Embeddings</td><td>将文本转换为向量，用于语义搜索</td></tr><tr><td>Vector Store</td><td>存储和检索向量化的文档</td></tr><tr><td>Memory</td><td>保存对话历史，支持多轮对话</td></tr><tr><td>LLM Chain</td><td>将检索结果输入大模型生成回答</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">四、部署：打造 Web 版 Chatbot</h2>
<p>使用 Streamlit 快速构建 Web 界面：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st
<span class="hljs-keyword">from</span> rag_chatbot <span class="hljs-keyword">import</span> RAGChatbot  <span class="hljs-comment"># 上面的代码保存为 rag_chatbot.py</span>

<span class="hljs-comment"># 页面配置</span>
st.set_page_config(page_title=<span class="hljs-string">"智能客服机器人"</span>, page_icon=<span class="hljs-string">"🤖"</span>)
st.title(<span class="hljs-string">"🤖 企业智能问答助手"</span>)

<span class="hljs-comment"># 初始化 Chatbot</span>
<span class="hljs-meta">@st.cache_resource</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_chatbot</span>():
    <span class="hljs-keyword">return</span> RAGChatbot(
        api_key=st.secrets[<span class="hljs-string">"OPENAI_API_KEY"</span>],
        knowledge_file=<span class="hljs-string">"knowledge.txt"</span>
    )

<span class="hljs-comment"># 会话状态管理</span>
<span class="hljs-keyword">if</span> <span class="hljs-string">"messages"</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:
    st.session_state.messages = []

<span class="hljs-comment"># 显示历史消息</span>
<span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> st.session_state.messages:
    <span class="hljs-keyword">with</span> st.chat_message(message[<span class="hljs-string">"role"</span>]):
        st.markdown(message[<span class="hljs-string">"content"</span>])

<span class="hljs-comment"># 用户输入</span>
<span class="hljs-keyword">if</span> prompt := st.chat_input(<span class="hljs-string">"请输入你的问题..."</span>):
    <span class="hljs-comment"># 显示用户消息</span>
    st.session_state.messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt})
    <span class="hljs-keyword">with</span> st.chat_message(<span class="hljs-string">"user"</span>):
        st.markdown(prompt)
    
    <span class="hljs-comment"># 获取机器人回复</span>
    <span class="hljs-keyword">with</span> st.chat_message(<span class="hljs-string">"assistant"</span>):
        bot = get_chatbot()
        response = bot.ask(prompt)
        st.markdown(response)
    
    st.session_state.messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response})
</code></pre>
<p>运行命令：</p>
<pre><code class="hljs language-bash" lang="bash">streamlit run app.py
</code></pre>
<hr/>
<h2 data-id="heading-11">五、最佳实践与优化技巧</h2>
<h3 data-id="heading-12">5.1 提升回答质量</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 优化提示词模板</span>
custom_template = <span class="hljs-string">"""基于以下上下文回答问题：
{context}

问题：{question}

要求：
- 如果上下文中没有相关信息，请明确说明
- 回答要简洁，控制在200字以内
- 使用中文回答

回答："""</span>

<span class="hljs-comment"># 2. 调整检索参数</span>
retriever = vectorstore.as_retriever(
    search_type=<span class="hljs-string">"similarity_score_threshold"</span>,
    search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>, <span class="hljs-string">"score_threshold"</span>: <span class="hljs-number">0.7</span>}
)
</code></pre>
<h3 data-id="heading-13">5.2 性能优化</h3>

























<table><thead><tr><th>优化方向</th><th>具体方法</th></tr></thead><tbody><tr><td>响应速度</td><td>使用缓存、预加载模型、异步处理</td></tr><tr><td>成本控制</td><td>选择合适的模型、限制上下文长度</td></tr><tr><td>准确性</td><td>优化文档切分策略、调整检索阈值</td></tr><tr><td>可扩展性</td><td>使用向量数据库（Pinecone、Milvus）</td></tr></tbody></table>
<h3 data-id="heading-14">5.3 常见问题处理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 处理模型超时</span>
<span class="hljs-keyword">from</span> tenacity <span class="hljs-keyword">import</span> retry, stop_after_attempt, wait_exponential

<span class="hljs-meta">@retry(<span class="hljs-params">stop=stop_after_attempt(<span class="hljs-params"><span class="hljs-number">3</span></span>), wait=wait_exponential(<span class="hljs-params">multiplier=<span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>=<span class="hljs-number">4</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">10</span></span>)</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_chat</span>(<span class="hljs-params">bot, question</span>):
    <span class="hljs-keyword">return</span> bot.ask(question)

<span class="hljs-comment"># 敏感内容过滤</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">check_content</span>(<span class="hljs-params">text</span>):
    blocked_keywords = [<span class="hljs-string">"密码"</span>, <span class="hljs-string">"密钥"</span>, <span class="hljs-string">"token"</span>]
    <span class="hljs-keyword">for</span> keyword <span class="hljs-keyword">in</span> blocked_keywords:
        <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> text:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">"内容包含敏感信息"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">""</span>
</code></pre>
<hr/>
<h2 data-id="heading-15">六、扩展：添加更多功能</h2>
<h3 data-id="heading-16">6.1 多模态支持</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 支持图片输入</span>
<span class="hljs-keyword">from</span> langchain_community.utilities <span class="hljs-keyword">import</span> GoogleVisionAPIWrapper

vision = GoogleVisionAPIWrapper()
image_description = vision.describe_image(<span class="hljs-string">"image.jpg"</span>)
</code></pre>
<h3 data-id="heading-17">6.2 工具调用（Agent）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> Tool, AgentType, initialize_agent

tools = [
    Tool(
        name=<span class="hljs-string">"Search"</span>,
        func=search_function,
        description=<span class="hljs-string">"用于搜索最新信息"</span>
    ),
    Tool(
        name=<span class="hljs-string">"Calculator"</span>,
        func=calculator_function,
        description=<span class="hljs-string">"用于数学计算"</span>
    )
]

agent = initialize_agent(
    tools,
    llm,
    agent=AgentType.CHAT_CONVERSATIONAL_REACT_DESCRIPTION
)
</code></pre>
<hr/>
<h2 data-id="heading-18">结语</h2>
<p>构建一个 Chatbot 不再是一件复杂的事情。借助现代 LLM 和开发框架，你可以：</p>
<ul>
<li>✅ 30 分钟搭建基础对话机器人</li>
<li>✅ 2 小时实现基于知识库的 RAG 系统</li>
<li>✅ 1 天部署生产级 Web 应用</li>
</ul>
<p>下一步，你可以尝试：</p>
<ol>
<li>接入更多数据源（数据库、API、网页）</li>
<li>优化对话体验（添加语音、富文本）</li>
<li>集成到现有系统（微信、钉钉、Slack）</li>
</ol>
<p>开始你的 Chatbot 开发之旅吧！</p>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li>LangChain 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com" target="_blank" title="https://python.langchain.com" ref="nofollow noopener noreferrer">python.langchain.com</a></li>
<li>Streamlit 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.streamlit.io" target="_blank" title="https://docs.streamlit.io" ref="nofollow noopener noreferrer">docs.streamlit.io</a></li>
<li>OpenAI API 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs" target="_blank" title="https://platform.openai.com/docs" ref="nofollow noopener noreferrer">platform.openai.com/docs</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ollama 快速上手指南：开发者的本地 LLM 利器]]></title>    <link>https://juejin.cn/post/7600642904382455814</link>    <guid>https://juejin.cn/post/7600642904382455814</guid>    <pubDate>2026-01-29T16:06:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600642904382455814" data-draft-id="7600637595944845354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ollama 快速上手指南：开发者的本地 LLM 利器"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-29T16:06:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hahaniu666"/> <meta itemprop="url" content="https://juejin.cn/user/3227821870678023"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ollama 快速上手指南：开发者的本地 LLM 利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821870678023/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hahaniu666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T16:06:07.000Z" title="Thu Jan 29 2026 16:06:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：为什么开发者需要 Ollama？</h2>
<p>想象一下：你正在开发一个需要 AI 功能的应用，但每次调用 API 都要担心网络延迟、数据隐私和调用成本。或者你想在飞机上、咖啡馆里离线调试 AI 功能，却发现没有网络寸步难行。</p>
<p>这就是 <strong>Ollama</strong> 的价值所在——它让你能在本地机器上轻松运行大语言模型（LLM），无需复杂的配置，一条命令就能启动。</p>
<p>Ollama 是一个开源的本地化大模型运行框架，专为开发者设计。它支持 Llama、Qwen、DeepSeek 等主流模型，提供 REST API 和 Python SDK，让你可以像调用云服务一样使用本地模型，但数据完全留在本地。</p>
<hr/>
<h2 data-id="heading-1">一、安装：一分钟搞定</h2>
<h3 data-id="heading-2">macOS / Windows</h3>
<p>直接下载安装包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS</span>
curl -fsSL https://ollama.com/install.sh | sh

<span class="hljs-comment"># 或访问官网下载：https://ollama.com/download</span>
</code></pre>
<h3 data-id="heading-3">Linux（推荐用于服务器部署）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键安装</span>
curl -fsSL https://ollama.com/install.sh | sh

<span class="hljs-comment"># 启动服务</span>
ollama serve
</code></pre>
<p>安装完成后，Ollama 默认在 <code>http://localhost:11434</code> 运行。</p>
<hr/>
<h2 data-id="heading-4">二、运行你的第一个模型</h2>
<p>Ollama 的命令设计非常简洁。运行模型只需：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行 Llama 3.2（轻量级，适合大多数机器）</span>
ollama run llama3.2

<span class="hljs-comment"># 运行 Qwen 2.5（中文表现优秀）</span>
ollama run qwen2.5

<span class="hljs-comment"># 运行 DeepSeek-R1（推理能力强）</span>
ollama run deepseek-r1
</code></pre>
<p>首次运行会自动下载模型。下载完成后，你就进入了一个交互式对话界面，可以直接和模型聊天。</p>
<p><strong>常用命令速查：</strong></p>

























<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>ollama list</code></td><td>查看已下载的模型</td></tr><tr><td><code>ollama pull &lt;model&gt;</code></td><td>下载模型但不运行</td></tr><tr><td><code>ollama rm &lt;model&gt;</code></td><td>删除模型</td></tr><tr><td><code>ollama ps</code></td><td>查看运行中的模型</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">三、在代码中调用 Ollama</h2>
<h3 data-id="heading-6">方式一：REST API</h3>
<p>Ollama 提供了完整的 REST API，任何语言都可以调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成文本</span>
curl http://localhost:11434/api/generate -d <span class="hljs-string">'{
  "model": "llama3.2",
  "prompt": "用 Python 写一个快速排序算法",
  "stream": false
}'</span>

<span class="hljs-comment"># 对话模式</span>
curl http://localhost:11434/api/chat -d <span class="hljs-string">'{
  "model": "llama3.2",
  "messages": [
    {"role": "user", "content": "你好"}
  ]
}'</span>
</code></pre>
<h3 data-id="heading-7">方式二：Python SDK（推荐）</h3>
<p>安装 Python 库：</p>
<pre><code class="hljs language-bash" lang="bash">pip install ollama
</code></pre>
<p>基础用法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> ollama

<span class="hljs-comment"># 简单生成</span>
response = ollama.generate(
    model=<span class="hljs-string">'llama3.2'</span>,
    prompt=<span class="hljs-string">'解释什么是递归函数'</span>
)
<span class="hljs-built_in">print</span>(response[<span class="hljs-string">'response'</span>])

<span class="hljs-comment"># 对话模式</span>
chat = ollama.chat(
    model=<span class="hljs-string">'llama3.2'</span>,
    messages=[
        {<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">'你好'</span>}
    ]
)
<span class="hljs-built_in">print</span>(chat[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>])
</code></pre>
<p>流式输出（适合实时显示）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> ollama

stream = ollama.chat(
    model=<span class="hljs-string">'llama3.2'</span>,
    messages=[{<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">'讲个笑话'</span>}],
    stream=<span class="hljs-literal">True</span>,
)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> stream:
    <span class="hljs-built_in">print</span>(chunk[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>], end=<span class="hljs-string">''</span>, flush=<span class="hljs-literal">True</span>)
</code></pre>
<hr/>
<h2 data-id="heading-8">四、进阶：自定义模型配置</h2>
<p>你可以通过 <code>Modelfile</code> 创建自定义模型配置：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># Modelfile
FROM llama3.2

# 系统提示词
SYSTEM """你是一个专业的 Python 开发助手，擅长编写简洁高效的代码。"""

# 参数设置
PARAMETER temperature 0.7
PARAMETER num_ctx 4096
</code></pre>
<p>创建并运行：</p>
<pre><code class="hljs language-bash" lang="bash">ollama create my-assistant -f Modelfile
ollama run my-assistant
</code></pre>
<hr/>
<h2 data-id="heading-9">五、模型选择建议</h2>



































<table><thead><tr><th>模型</th><th>参数规模</th><th>适用场景</th><th>显存需求</th></tr></thead><tbody><tr><td>llama3.2</td><td>3B</td><td>轻量级任务、快速响应</td><td>4GB+</td></tr><tr><td>qwen2.5</td><td>7B</td><td>中文对话、代码生成</td><td>8GB+</td></tr><tr><td>deepseek-r1</td><td>7B/14B</td><td>复杂推理、数学问题</td><td>8GB+/16GB+</td></tr><tr><td>codellama</td><td>7B</td><td>代码补全、编程辅助</td><td>8GB+</td></tr></tbody></table>
<p><strong>提示：</strong> 如果显存有限，可以使用量化版本（如 <code>qwen2.5:4b</code>），在模型名后加 <code>:4b</code> 即可。</p>
<hr/>
<h2 data-id="heading-10">六、集成到开发工作流</h2>
<h3 data-id="heading-11">在 VS Code 中使用</h3>
<p>安装 <strong>Continue</strong> 插件，配置本地 Ollama：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Local Llama"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ollama"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"llama3.2"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-12">作为后端服务</h3>
<p>启动 Ollama 服务后，你的应用可以像调用 OpenAI API 一样使用本地模型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> openai

client = openai.OpenAI(
    base_url=<span class="hljs-string">"http://localhost:11434/v1"</span>,
    api_key=<span class="hljs-string">"ollama"</span>  <span class="hljs-comment"># 任意值即可</span>
)

response = client.chat.completions.create(
    model=<span class="hljs-string">"llama3.2"</span>,
    messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Hello"</span>}]
)
</code></pre>
<hr/>
<h2 data-id="heading-13">结语</h2>
<p>Ollama 让本地运行大模型变得前所未有的简单。对于开发者来说，它不仅是保护数据隐私的解决方案，更是加速开发迭代的利器——无需网络、无需 API Key、零调用成本。</p>
<p>现在就开始你的本地 AI 之旅吧：</p>
<pre><code class="hljs language-bash" lang="bash">ollama run llama3.2
</code></pre>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li>Ollama 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com" target="_blank" title="https://ollama.com" ref="nofollow noopener noreferrer">ollama.com</a></li>
<li>模型库：<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Flibrary" target="_blank" title="https://ollama.com/library" ref="nofollow noopener noreferrer">ollama.com/library</a></li>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Follama%2Follama" target="_blank" title="https://github.com/ollama/ollama" ref="nofollow noopener noreferrer">github.com/ollama/olla…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vscode提示找不到名称“Map”的解决方案]]></title>    <link>https://juejin.cn/post/7600705962248372233</link>    <guid>https://juejin.cn/post/7600705962248372233</guid>    <pubDate>2026-01-30T03:33:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600705962248372233" data-draft-id="7600764857768886322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vscode提示找不到名称“Map”的解决方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T03:33:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vscode提示找不到名称“Map”的解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:33:12.000Z" title="Fri Jan 30 2026 03:33:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">错误提示</h3>
<p>“编辑器报错：找不到名称“Map”。是否需要更改目标库? 请尝试将 “lib” 编译器选项更改为“es2015”或更高版本。”</p>
<h3 data-id="heading-1">原因：</h3>
<p><code>Map</code> 是 ES2015（ES6）引入的新特性，而 TS 默认的 <code>lib</code> 配置可能只包含 <code>ES5</code> 相关的类型定义（ES5 中没有 <code>Map</code>），因此编译器不认识 <code>Map</code>，从而抛出 “找不到名称‘Map’” 的错误。</p>
<h2 data-id="heading-2">解决方案（两种方式，任选其一）</h2>
<h4 data-id="heading-3">方式 1：修改 tsconfig.json 配置（推荐，全局生效）</h4>
<p>这是最规范的做法，通过配置文件指定 TS 编译时使用的库版本：</p>
<ol>
<li>找到项目根目录的 <code>tsconfig.json</code> 文件（如果没有，执行 <code>tsc --init</code> 生成）；</li>
<li>找到 <code>compilerOptions</code> 中的 <code>lib</code> 字段，添加 <code>ES2015</code> 或更高版本（如 <code>ES2020</code>），同时保留必要的 <code>DOM</code>（如果涉及浏览器环境）；</li>
<li>保存后重启编辑器（如 VS Code），报错会自动消失。</li>
</ol>
<p><strong>完整的 tsconfig.json 示例</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2015"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 编译目标版本，建议和 lib 版本匹配</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ES2015"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 核心：添加 ES2015 及以上</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CommonJS"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 开启严格模式，增强类型检查</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>
<p><code>lib</code> 字段说明：</p>
<ul>
<li><code>ES2015</code>：包含 ES6 所有新特性（Map、Set、Promise 等）的类型定义；</li>
<li><code>DOM</code>：包含浏览器环境的类型定义（如 <code>document</code>、<code>window</code>），如果是 Node.js 项目可省略。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">方式 2：临时指定文件级别的 lib（仅当前文件生效）</h4>
<p>如果不想修改全局配置，可在使用 <code>Map</code> 的 TS 文件顶部添加一行注释，强制指定该文件使用的库版本：</p>
<p>typescript</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/// &lt;reference lib="es2015" /&gt;</span>

<span class="hljs-comment">// 此时 Map 就能被识别</span>
<span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;();
</code></pre>
<h3 data-id="heading-5">验证是否解决问题</h3>
<p>修改配置后，编写以下代码测试：</p>
<p>typescript</p>
<p>运行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">const</span> <span class="hljs-built_in">map</span> = new Map&lt;<span class="hljs-built_in">string</span>, number&gt;();
<span class="hljs-built_in">map</span>.<span class="hljs-built_in">set</span>(<span class="hljs-string">"test"</span>, <span class="hljs-number">123</span>);
console.<span class="hljs-built_in">log</span>(<span class="hljs-built_in">map</span>.get(<span class="hljs-string">"test"</span>));
</code></pre>
<ul>
<li>如果编辑器不再报 “找不到名称‘Map’” 的错误，且代码能正常编译（执行 <code>tsc</code> 无报错），说明配置生效。</li>
</ul>
<h3 data-id="heading-6">补充说明</h3>
<ul>
<li>
<p><code>target</code> vs <code>lib</code>：</p>
<ul>
<li><code>target</code>：指定 TS 编译后生成的 JS 版本（如 ES5、ES2015）；</li>
<li><code>lib</code>：指定 TS 编译时参考的类型定义库版本（决定 TS 认识哪些内置对象 / 方法）；</li>
<li>建议 <code>target</code> 和 <code>lib</code> 版本保持一致（如都设为 ES2015），避免类型和编译结果不匹配。</li>
</ul>
</li>
<li>
<p>若项目是 Node.js 环境：除了 <code>ES2015</code>，还可根据 Node 版本选择 <code>ES2020</code>、<code>ESNext</code> 等，无需添加 <code>DOM</code>。</p>
</li>
</ul>
<h3 data-id="heading-7">总结</h3>
<ol>
<li>报错核心原因：TS 编译器的 <code>lib</code> 配置未包含 ES2015，导致无法识别 <code>Map</code> 类型；</li>
<li>最优解决方案：在 <code>tsconfig.json</code> 的 <code>compilerOptions.lib</code> 中添加 <code>ES2015</code>（或更高版本）；</li>
<li>关键配置：<code>lib</code> 字段控制 TS 能识别的内置 API 类型，<code>target</code> 控制编译后的 JS 版本，两者建议匹配。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain v1.x Models 完全指南：从入门到精通]]></title>    <link>https://juejin.cn/post/7600622813457661967</link>    <guid>https://juejin.cn/post/7600622813457661967</guid>    <pubDate>2026-01-30T01:24:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600622813457661967" data-draft-id="7600622813457629199" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain v1.x Models 完全指南：从入门到精通"/> <meta itemprop="keywords" content="LangChain,Agent"/> <meta itemprop="datePublished" content="2026-01-30T01:24:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陈暖秋"/> <meta itemprop="url" content="https://juejin.cn/user/493019579297533"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain v1.x Models 完全指南：从入门到精通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/493019579297533/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陈暖秋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:24:41.000Z" title="Fri Jan 30 2026 01:24:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="darcula">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#bababa}.hljs-emphasis,.hljs-strong{color:#a8a8a2}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#6896ba}.hljs-code,.hljs-selector-class{color:#a6e22e}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#cb7832}.hljs-params{color:#b9b9b9}.hljs-string{color:#6a8759}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable,.hljs-type{color:#e0c46c}.hljs-comment,.hljs-deletion,.hljs-meta{color:#7f7f7f}</style><blockquote>
<p>本文将深入探讨 LangChain 中的 Models 模块，涵盖基础使用、工具调用、结构化输出、多模态处理等核心功能，并提供丰富的代码示例。</p>
</blockquote>
<h2 data-id="heading-0">📚 目录</h2>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-langchain-models" title="#%E4%BB%80%E4%B9%88%E6%98%AF-langchain-models">什么是 LangChain Models</a></li>
<li><a href="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95" title="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">基础用法</a></li>
<li><a href="#%E4%B8%89%E7%A7%8D%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F" title="#%E4%B8%89%E7%A7%8D%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F">三种调用方式</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8tool-calling" title="#%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8tool-calling">工具调用（Tool Calling）</a></li>
<li><a href="#%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA" title="#%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA">结构化输出</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7" title="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">高级特性</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B" title="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B">实战案例</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">什么是 LangChain Models</h2>
<p><strong>Large Language Models (LLMs)</strong> 是强大的 AI 工具，能够像人类一样理解和生成文本。它们足够versatile（多才多艺），可以编写内容、翻译语言、总结文本和回答问题，而无需针对每个任务进行专门训练。</p>
<h3 data-id="heading-2">核心能力</h3>
<p>现代 LLM 除了文本生成外，还支持：</p>






























<table><thead><tr><th>能力</th><th>描述</th><th>应用场景</th></tr></thead><tbody><tr><td>🔨 <strong>工具调用</strong></td><td>调用外部工具（如数据库查询或API调用）并在响应中使用结果</td><td>数据查询、API集成</td></tr><tr><td>📐 <strong>结构化输出</strong></td><td>模型响应遵循定义的格式</td><td>数据提取、表单填充</td></tr><tr><td>🖼️ <strong>多模态</strong></td><td>处理和返回文本以外的数据（图像、音频、视频）</td><td>图像识别、语音处理</td></tr><tr><td>🧠 <strong>推理</strong></td><td>执行多步推理得出结论</td><td>复杂问题解决</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[用户输入] --&gt; B[LangChain Models]
    B --&gt; C[文本生成]
    B --&gt; D[工具调用]
    B --&gt; E[结构化输出]
    B --&gt; F[多模态处理]
    B --&gt; G[推理分析]
    C --&gt; H[最终响应]
    D --&gt; H
    E --&gt; H
    F --&gt; H
    G --&gt; H
</code></pre>
<hr/>
<h2 data-id="heading-3">基础用法</h2>
<h3 data-id="heading-4">1. 初始化模型</h3>
<p>LangChain 提供了统一的 <code>init_chat_model</code> 接口，支持多个主流模型提供商：</p>
<h4 data-id="heading-5">OpenAI 模型</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

<span class="hljs-comment"># 设置 API Key</span>
os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = <span class="hljs-string">"sk-..."</span>

<span class="hljs-comment"># 初始化模型</span>
model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>)

<span class="hljs-comment"># 简单调用</span>
response = model.invoke(<span class="hljs-string">"为什么鹦鹉会说话?"</span>)
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<h4 data-id="heading-6">Anthropic Claude 模型</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

os.environ[<span class="hljs-string">"ANTHROPIC_API_KEY"</span>] = <span class="hljs-string">"sk-..."</span>

model = init_chat_model(<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>)
response = model.invoke(<span class="hljs-string">"解释量子计算的基本原理"</span>)
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<h4 data-id="heading-7">Google Gemini 模型</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

os.environ[<span class="hljs-string">"GOOGLE_API_KEY"</span>] = <span class="hljs-string">"..."</span>

model = init_chat_model(<span class="hljs-string">"google_genai:gemini-2.5-flash-lite"</span>)
response = model.invoke(<span class="hljs-string">"总结人工智能的发展历史"</span>)
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<h3 data-id="heading-8">2. 配置模型参数</h3>
<pre><code class="hljs language-python" lang="python">model = init_chat_model(
    <span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    <span class="hljs-comment"># 模型参数配置</span>
    temperature=<span class="hljs-number">0.7</span>,      <span class="hljs-comment"># 控制输出的随机性 (0-1)</span>
    timeout=<span class="hljs-number">30</span>,           <span class="hljs-comment"># 超时时间（秒）</span>
    max_tokens=<span class="hljs-number">1000</span>,      <span class="hljs-comment"># 最大输出token数</span>
)

response = model.invoke(<span class="hljs-string">"写一首关于春天的诗"</span>)
</code></pre>
<p><strong>参数说明：</strong></p>








































<table><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>model</code></td><td>string</td><td>模型名称或标识符</td></tr><tr><td><code>api_key</code></td><td>string</td><td>API密钥（通常通过环境变量设置）</td></tr><tr><td><code>temperature</code></td><td>number</td><td>控制输出随机性，越高越有创意</td></tr><tr><td><code>max_tokens</code></td><td>number</td><td>限制输出的最大token数</td></tr><tr><td><code>timeout</code></td><td>number</td><td>请求超时时间（秒）</td></tr><tr><td><code>max_retries</code></td><td>number</td><td>请求失败时的最大重试次数</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">三种调用方式</h2>
<h3 data-id="heading-10">1. Invoke - 标准调用</h3>
<p>最直接的调用方式，等待完整响应后返回：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 单条消息</span>
response = model.invoke(<span class="hljs-string">"鹦鹉为什么有彩色的羽毛?"</span>)
<span class="hljs-built_in">print</span>(response.content)

<span class="hljs-comment"># 对话历史</span>
conversation = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个翻译助手，将英文翻译成法语。"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"翻译: I love programming."</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"J'adore la programmation."</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"翻译: I love building applications."</span>}
]

response = model.invoke(conversation)
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<p><strong>使用消息对象格式：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> HumanMessage, AIMessage, SystemMessage

conversation = [
    SystemMessage(<span class="hljs-string">"你是一个专业的Python编程助手。"</span>),
    HumanMessage(<span class="hljs-string">"如何在Python中创建装饰器?"</span>),
]

response = model.invoke(conversation)
<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<h3 data-id="heading-11">2. Stream - 流式输出</h3>
<p>实时显示生成的内容，改善用户体验：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 基础文本流式输出</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"AI: "</span>, end=<span class="hljs-string">""</span>)
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model.stream(<span class="hljs-string">"为什么鹦鹉有彩色的羽毛?"</span>):
    <span class="hljs-built_in">print</span>(chunk.content, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
<span class="hljs-built_in">print</span>()

<span class="hljs-comment"># 流式输出并构建完整消息</span>
full_message = <span class="hljs-literal">None</span>
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model.stream(<span class="hljs-string">"天空是什么颜色?"</span>):
    full_message = chunk <span class="hljs-keyword">if</span> full_message <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> full_message + chunk
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"当前累积: <span class="hljs-subst">{full_message.content}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n完整消息: <span class="hljs-subst">{full_message.content}</span>"</span>)
</code></pre>
<p><strong>流式处理工具调用和推理：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model.stream(<span class="hljs-string">"天空是什么颜色?"</span>):
    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> chunk.content_blocks:
        <span class="hljs-keyword">if</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"reasoning"</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"推理: <span class="hljs-subst">{block.get(<span class="hljs-string">'reasoning'</span>)}</span>"</span>)
        <span class="hljs-keyword">elif</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"tool_call_chunk"</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工具调用: <span class="hljs-subst">{block}</span>"</span>)
        <span class="hljs-keyword">elif</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"text"</span>:
            <span class="hljs-built_in">print</span>(block[<span class="hljs-string">"text"</span>], end=<span class="hljs-string">""</span>)
</code></pre>
<h3 data-id="heading-12">3. Batch - 批量处理</h3>
<p>并行处理多个独立请求，提高性能和降低成本：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 批量调用</span>
questions = [
    <span class="hljs-string">"为什么鹦鹉有彩色的羽毛?"</span>,
    <span class="hljs-string">"飞机是如何飞行的?"</span>,
    <span class="hljs-string">"什么是量子计算?"</span>
]

responses = model.batch(questions)
<span class="hljs-keyword">for</span> question, response <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(questions, responses):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题: <span class="hljs-subst">{question}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"回答: <span class="hljs-subst">{response.content}</span>\n"</span>)
</code></pre>
<p><strong>批量流式处理（按完成顺序返回）：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> response <span class="hljs-keyword">in</span> model.batch_as_completed(questions):
    index = response.index  <span class="hljs-comment"># 原始输入的索引</span>
    result = response.result
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题 <span class="hljs-subst">{index}</span>: <span class="hljs-subst">{questions[index]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"回答: <span class="hljs-subst">{result.content}</span>\n"</span>)
</code></pre>
<p><strong>控制并发数：</strong></p>
<pre><code class="hljs language-python" lang="python">responses = model.batch(
    questions,
    config={
        <span class="hljs-string">'max_concurrency'</span>: <span class="hljs-number">5</span>,  <span class="hljs-comment"># 限制为5个并行调用</span>
    }
)
</code></pre>
<hr/>
<h2 data-id="heading-13">工具调用（Tool Calling）</h2>
<p>工具调用是 LLM 最强大的功能之一，允许模型调用外部工具来执行特定任务。</p>
<h3 data-id="heading-14">工具调用流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户
    participant M as 模型
    participant T as 工具

    U-&gt;&gt;M: "旧金山和纽约的天气如何?"
    M-&gt;&gt;M: 分析请求并决定需要的工具

    par 并行工具调用
        M-&gt;&gt;T: get_weather("San Francisco")
        M-&gt;&gt;T: get_weather("New York")
    end

    par 工具执行
        T--&gt;&gt;M: 旧金山天气数据
        T--&gt;&gt;M: 纽约天气数据
    end

    M-&gt;&gt;M: 处理结果并生成响应
    M-&gt;&gt;U: "旧金山: 72°F晴天, 纽约: 68°F多云"
</code></pre>
<h3 data-id="heading-15">1. 定义和绑定工具</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool

<span class="hljs-comment"># 定义工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定地点的天气信息。
    
    Args:
        location: 城市和州，例如 San Francisco, CA
    """</span>
    <span class="hljs-comment"># 实际应用中这里会调用天气API</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{location}</span>当前天气晴朗，温度22°C。"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_population</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""获取指定地点的人口数量。
    
    Args:
        location: 城市和州，例如 San Francisco, CA
    """</span>
    <span class="hljs-comment"># 实际应用中这里会查询数据库</span>
    populations = {
        <span class="hljs-string">"San Francisco, CA"</span>: <span class="hljs-number">873965</span>,
        <span class="hljs-string">"New York, NY"</span>: <span class="hljs-number">8336817</span>,
        <span class="hljs-string">"Los Angeles, CA"</span>: <span class="hljs-number">3979576</span>
    }
    <span class="hljs-keyword">return</span> populations.get(location, <span class="hljs-number">0</span>)

<span class="hljs-comment"># 绑定工具到模型</span>
model_with_tools = model.bind_tools([get_weather, get_population])

<span class="hljs-comment"># 调用模型</span>
response = model_with_tools.invoke(<span class="hljs-string">"波士顿的天气如何?"</span>)

<span class="hljs-comment"># 查看模型生成的工具调用</span>
<span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工具: <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"参数: <span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ID: <span class="hljs-subst">{tool_call[<span class="hljs-string">'id'</span>]}</span>"</span>)
</code></pre>
<h3 data-id="heading-16">2. 工具执行循环</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculator</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""计算数学表达式。
    
    Args:
        expression: 数学表达式，如 "2 + 2" 或 "10 * 5"
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(expression)
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"计算错误"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_database</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""在数据库中搜索信息。
    
    Args:
        query: 搜索查询
    """</span>
    <span class="hljs-comment"># 模拟数据库查询</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"找到关于'<span class="hljs-subst">{query}</span>'的相关信息"</span>

<span class="hljs-comment"># 绑定工具</span>
model_with_tools = model.bind_tools([calculator, search_database])

<span class="hljs-comment"># 步骤1: 模型生成工具调用</span>
messages = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"计算 (15 + 25) * 2 的结果"</span>}]
ai_msg = model_with_tools.invoke(messages)
messages.append(ai_msg)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"模型请求调用工具: <span class="hljs-subst">{ai_msg.tool_calls}</span>"</span>)

<span class="hljs-comment"># 步骤2: 执行工具并收集结果</span>
<span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> ai_msg.tool_calls:
    <span class="hljs-keyword">if</span> tool_call[<span class="hljs-string">'name'</span>] == <span class="hljs-string">'calculator'</span>:
        result = calculator.invoke(tool_call)
        messages.append(result)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工具执行结果: <span class="hljs-subst">{result.content}</span>"</span>)

<span class="hljs-comment"># 步骤3: 将结果传回模型生成最终响应</span>
final_response = model_with_tools.invoke(messages)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终回答: <span class="hljs-subst">{final_response.content}</span>"</span>)
</code></pre>
<h3 data-id="heading-17">3. 强制工具调用</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 强制使用任意工具</span>
model_with_tools = model.bind_tools(
    [get_weather, get_population], 
    tool_choice=<span class="hljs-string">"any"</span>
)

<span class="hljs-comment"># 强制使用特定工具</span>
model_with_tools = model.bind_tools(
    [get_weather, get_population], 
    tool_choice=<span class="hljs-string">"get_weather"</span>
)

response = model_with_tools.invoke(<span class="hljs-string">"今天天气怎么样?"</span>)
</code></pre>
<h3 data-id="heading-18">4. 并行工具调用</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 模型可以同时调用多个工具</span>
model_with_tools = model.bind_tools([get_weather, get_population])

response = model_with_tools.invoke(
    <span class="hljs-string">"比较波士顿和东京的天气，并告诉我哪个城市人口更多"</span>
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"工具调用列表:"</span>)
<span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"- <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>(<span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>)"</span>)

<span class="hljs-comment"># 输出可能是:</span>
<span class="hljs-comment"># - get_weather({'location': 'Boston'})</span>
<span class="hljs-comment"># - get_weather({'location': 'Tokyo'})</span>
<span class="hljs-comment"># - get_population({'location': 'Boston'})</span>
<span class="hljs-comment"># - get_population({'location': 'Tokyo'})</span>
</code></pre>
<h3 data-id="heading-19">5. 流式工具调用</h3>
<pre><code class="hljs language-python" lang="python">model_with_tools = model.bind_tools([get_weather])

<span class="hljs-built_in">print</span>(<span class="hljs-string">"流式接收工具调用:"</span>)
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model_with_tools.stream(<span class="hljs-string">"北京和上海的天气如何?"</span>):
    <span class="hljs-keyword">for</span> tool_chunk <span class="hljs-keyword">in</span> chunk.tool_call_chunks:
        <span class="hljs-keyword">if</span> name := tool_chunk.get(<span class="hljs-string">"name"</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n工具: <span class="hljs-subst">{name}</span>"</span>)
        <span class="hljs-keyword">if</span> args := tool_chunk.get(<span class="hljs-string">"args"</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"参数片段: <span class="hljs-subst">{args}</span>"</span>, end=<span class="hljs-string">""</span>)
</code></pre>
<hr/>
<h2 data-id="heading-20">结构化输出</h2>
<p>结构化输出确保模型的响应遵循预定义的格式，这对于数据提取和后续处理非常有用。</p>
<h3 data-id="heading-21">1. 使用 Pydantic 模型</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Actor</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""演员信息"""</span>
    name: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"演员姓名"</span>)
    role: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"角色名称"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Movie</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""电影详细信息"""</span>
    title: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"电影标题"</span>)
    year: <span class="hljs-built_in">int</span> = Field(..., description=<span class="hljs-string">"上映年份"</span>)
    director: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"导演姓名"</span>)
    rating: <span class="hljs-built_in">float</span> = Field(..., description=<span class="hljs-string">"评分（满分10分）"</span>)
    cast: <span class="hljs-type">List</span>[Actor] = Field(..., description=<span class="hljs-string">"主要演员列表"</span>)
    genres: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = Field(..., description=<span class="hljs-string">"电影类型"</span>)
    budget: <span class="hljs-built_in">float</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"预算（百万美元）"</span>)

<span class="hljs-comment"># 绑定结构化输出</span>
model_with_structure = model.with_structured_output(Movie)

<span class="hljs-comment"># 调用模型</span>
response = model_with_structure.invoke(
    <span class="hljs-string">"提供电影《盗梦空间》的详细信息"</span>
)

<span class="hljs-comment"># 输出是强类型的 Pydantic 对象</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"标题: <span class="hljs-subst">{response.title}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"年份: <span class="hljs-subst">{response.year}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"导演: <span class="hljs-subst">{response.director}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"评分: <span class="hljs-subst">{response.rating}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"主演:"</span>)
<span class="hljs-keyword">for</span> actor <span class="hljs-keyword">in</span> response.cast:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{actor.name}</span> 饰演 <span class="hljs-subst">{actor.role}</span>"</span>)
</code></pre>
<h3 data-id="heading-22">2. 使用 TypedDict</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict, Annotated

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MovieDict</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-string">"""电影信息字典"""</span>
    title: Annotated[<span class="hljs-built_in">str</span>, ..., <span class="hljs-string">"电影标题"</span>]
    year: Annotated[<span class="hljs-built_in">int</span>, ..., <span class="hljs-string">"上映年份"</span>]
    director: Annotated[<span class="hljs-built_in">str</span>, ..., <span class="hljs-string">"导演姓名"</span>]
    rating: Annotated[<span class="hljs-built_in">float</span>, ..., <span class="hljs-string">"评分（满分10分）"</span>]

model_with_structure = model.with_structured_output(MovieDict)
response = model_with_structure.invoke(<span class="hljs-string">"介绍电影《星际穿越》"</span>)

<span class="hljs-comment"># 输出是字典</span>
<span class="hljs-built_in">print</span>(response)
<span class="hljs-comment"># {'title': '星际穿越', 'year': 2014, 'director': '克里斯托弗·诺兰', 'rating': 8.6}</span>
</code></pre>
<h3 data-id="heading-23">3. 使用 JSON Schema</h3>
<pre><code class="hljs language-python" lang="python">json_schema = {
    <span class="hljs-string">"title"</span>: <span class="hljs-string">"Product"</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"产品信息"</span>,
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
    <span class="hljs-string">"properties"</span>: {
        <span class="hljs-string">"name"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"产品名称"</span>
        },
        <span class="hljs-string">"price"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"价格"</span>
        },
        <span class="hljs-string">"in_stock"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"boolean"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"是否有货"</span>
        },
        <span class="hljs-string">"tags"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"array"</span>,
            <span class="hljs-string">"items"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>},
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"产品标签"</span>
        }
    },
    <span class="hljs-string">"required"</span>: [<span class="hljs-string">"name"</span>, <span class="hljs-string">"price"</span>, <span class="hljs-string">"in_stock"</span>]
}

model_with_structure = model.with_structured_output(
    json_schema,
    method=<span class="hljs-string">"json_schema"</span>,
)

response = model_with_structure.invoke(
    <span class="hljs-string">"提供iPhone 15 Pro的产品信息"</span>
)

<span class="hljs-built_in">print</span>(response)
</code></pre>
<h3 data-id="heading-24">4. 包含原始消息</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BookInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""书籍信息"""</span>
    title: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"书名"</span>)
    author: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"作者"</span>)
    year: <span class="hljs-built_in">int</span> = Field(..., description=<span class="hljs-string">"出版年份"</span>)

<span class="hljs-comment"># 设置 include_raw=True 以获取原始消息</span>
model_with_structure = model.with_structured_output(
    BookInfo, 
    include_raw=<span class="hljs-literal">True</span>
)

response = model_with_structure.invoke(<span class="hljs-string">"介绍《三体》这本书"</span>)

<span class="hljs-comment"># 响应包含三个字段</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析结果: <span class="hljs-subst">{response[<span class="hljs-string">'parsed'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始消息: <span class="hljs-subst">{response[<span class="hljs-string">'raw'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析错误: <span class="hljs-subst">{response[<span class="hljs-string">'parsing_error'</span>]}</span>"</span>)

<span class="hljs-comment"># 访问token使用情况</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"使用的tokens: <span class="hljs-subst">{response[<span class="hljs-string">'raw'</span>].usage_metadata}</span>"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-25">高级特性</h2>
<h3 data-id="heading-26">1. 多模态处理</h3>
<p>某些模型可以处理图像、音频和视频等非文本数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

<span class="hljs-comment"># 初始化支持多模态的模型</span>
model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>)

<span class="hljs-comment"># 发送图像</span>
message = {
    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-string">"content"</span>: [
        {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: <span class="hljs-string">"这张图片中有什么?"</span>},
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
            <span class="hljs-string">"image_url"</span>: {
                <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://example.com/image.jpg"</span>
            }
        }
    ]
}

response = model.invoke([message])
<span class="hljs-built_in">print</span>(response.content)

<span class="hljs-comment"># 处理Base64编码的图像</span>
<span class="hljs-keyword">import</span> base64

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"local_image.jpg"</span>, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> image_file:
    base64_image = base64.b64encode(image_file.read()).decode()

message = {
    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
    <span class="hljs-string">"content"</span>: [
        {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: <span class="hljs-string">"描述这张图片"</span>},
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
            <span class="hljs-string">"image_url"</span>: {
                <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:image/jpeg;base64,<span class="hljs-subst">{base64_image}</span>"</span>
            }
        }
    ]
}

response = model.invoke([message])
</code></pre>
<h3 data-id="heading-27">2. 推理过程可见化</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 流式显示推理过程</span>
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model.stream(<span class="hljs-string">"解释为什么鹦鹉有彩色的羽毛?"</span>):
    reasoning_steps = [
        r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> chunk.content_blocks 
        <span class="hljs-keyword">if</span> r[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"reasoning"</span>
    ]
    <span class="hljs-keyword">if</span> reasoning_steps:
        <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> reasoning_steps:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"推理: <span class="hljs-subst">{step[<span class="hljs-string">'reasoning'</span>]}</span>"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(chunk.content, end=<span class="hljs-string">""</span>)

<span class="hljs-comment"># 获取完整推理过程</span>
response = model.invoke(<span class="hljs-string">"为什么鹦鹉有彩色的羽毛?"</span>)
reasoning_steps = [
    b <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> response.content_blocks 
    <span class="hljs-keyword">if</span> b[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"reasoning"</span>
]
full_reasoning = <span class="hljs-string">" "</span>.join(
    step[<span class="hljs-string">"reasoning"</span>] <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> reasoning_steps
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"完整推理过程: <span class="hljs-subst">{full_reasoning}</span>"</span>)
</code></pre>
<h3 data-id="heading-28">3. Token 使用统计</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> get_usage_metadata_callback

model_1 = init_chat_model(model=<span class="hljs-string">"gpt-4o-mini"</span>)
model_2 = init_chat_model(model=<span class="hljs-string">"claude-haiku-4-5-20251001"</span>)

<span class="hljs-comment"># 使用上下文管理器追踪token使用</span>
<span class="hljs-keyword">with</span> get_usage_metadata_callback() <span class="hljs-keyword">as</span> cb:
    model_1.invoke(<span class="hljs-string">"你好"</span>)
    model_2.invoke(<span class="hljs-string">"你好"</span>)
    <span class="hljs-built_in">print</span>(cb.usage_metadata)

<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment"># {</span>
<span class="hljs-comment">#     'gpt-4o-mini-2024-07-18': {</span>
<span class="hljs-comment">#         'input_tokens': 8,</span>
<span class="hljs-comment">#         'output_tokens': 10,</span>
<span class="hljs-comment">#         'total_tokens': 18</span>
<span class="hljs-comment">#     },</span>
<span class="hljs-comment">#     'claude-haiku-4-5-20251001': {</span>
<span class="hljs-comment">#         'input_tokens': 8,</span>
<span class="hljs-comment">#         'output_tokens': 21,</span>
<span class="hljs-comment">#         'total_tokens': 29</span>
<span class="hljs-comment">#     }</span>
<span class="hljs-comment"># }</span>
</code></pre>
<h3 data-id="heading-29">4. 可配置模型</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

<span class="hljs-comment"># 创建运行时可配置的模型</span>
configurable_model = init_chat_model(temperature=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 使用不同的模型运行</span>
configurable_model.invoke(
    <span class="hljs-string">"你的名字是什么?"</span>,
    config={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"model"</span>: <span class="hljs-string">"gpt-4o-mini"</span>}},
)

configurable_model.invoke(
    <span class="hljs-string">"你的名字是什么?"</span>,
    config={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"model"</span>: <span class="hljs-string">"claude-sonnet-4-5-20250929"</span>}},
)

<span class="hljs-comment"># 配置默认值和可配置字段</span>
model = init_chat_model(
    model=<span class="hljs-string">"gpt-4o-mini"</span>,
    temperature=<span class="hljs-number">0</span>,
    configurable_fields=(
        <span class="hljs-string">"model"</span>, 
        <span class="hljs-string">"model_provider"</span>, 
        <span class="hljs-string">"temperature"</span>, 
        <span class="hljs-string">"max_tokens"</span>
    ),
    config_prefix=<span class="hljs-string">"first"</span>,
)

<span class="hljs-comment"># 运行时覆盖配置</span>
model.invoke(
    <span class="hljs-string">"你好"</span>,
    config={
        <span class="hljs-string">"configurable"</span>: {
            <span class="hljs-string">"first_model"</span>: <span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
            <span class="hljs-string">"first_temperature"</span>: <span class="hljs-number">0.5</span>,
            <span class="hljs-string">"first_max_tokens"</span>: <span class="hljs-number">100</span>,
        }
    },
)
</code></pre>
<h3 data-id="heading-30">5. 速率限制</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.rate_limiters <span class="hljs-keyword">import</span> InMemoryRateLimiter
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

<span class="hljs-comment"># 创建速率限制器</span>
rate_limiter = InMemoryRateLimiter(
    requests_per_second=<span class="hljs-number">0.1</span>,        <span class="hljs-comment"># 每10秒1个请求</span>
    check_every_n_seconds=<span class="hljs-number">0.1</span>,      <span class="hljs-comment"># 每100ms检查一次</span>
    max_bucket_size=<span class="hljs-number">10</span>,             <span class="hljs-comment"># 控制最大突发大小</span>
)

<span class="hljs-comment"># 应用速率限制</span>
model = init_chat_model(
    model=<span class="hljs-string">"gpt-4o"</span>,
    model_provider=<span class="hljs-string">"openai"</span>,
    rate_limiter=rate_limiter
)

<span class="hljs-comment"># 批量请求会被限速</span>
responses = model.batch([
    <span class="hljs-string">"问题1"</span>,
    <span class="hljs-string">"问题2"</span>,
    <span class="hljs-string">"问题3"</span>,
])
</code></pre>
<hr/>
<h2 data-id="heading-31">实战案例</h2>
<h3 data-id="heading-32">案例1: 智能客服助手</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-comment"># 定义工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_order_status</span>(<span class="hljs-params">order_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""查询订单状态
    
    Args:
        order_id: 订单编号
    """</span>
    <span class="hljs-comment"># 模拟查询订单</span>
    orders = {
        <span class="hljs-string">"ORD001"</span>: <span class="hljs-string">"已发货，预计明天送达"</span>,
        <span class="hljs-string">"ORD002"</span>: <span class="hljs-string">"正在处理中"</span>,
        <span class="hljs-string">"ORD003"</span>: <span class="hljs-string">"已送达"</span>
    }
    <span class="hljs-keyword">return</span> orders.get(order_id, <span class="hljs-string">"未找到该订单"</span>)

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">check_product_stock</span>(<span class="hljs-params">product_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""查询产品库存
    
    Args:
        product_name: 产品名称
    """</span>
    stock = {
        <span class="hljs-string">"iPhone 15"</span>: {<span class="hljs-string">"available"</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">"quantity"</span>: <span class="hljs-number">50</span>},
        <span class="hljs-string">"MacBook Pro"</span>: {<span class="hljs-string">"available"</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">"quantity"</span>: <span class="hljs-number">30</span>},
        <span class="hljs-string">"AirPods"</span>: {<span class="hljs-string">"available"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"quantity"</span>: <span class="hljs-number">0</span>}
    }
    <span class="hljs-keyword">return</span> stock.get(product_name, {<span class="hljs-string">"available"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"quantity"</span>: <span class="hljs-number">0</span>})

<span class="hljs-comment"># 初始化模型</span>
model = init_chat_model(<span class="hljs-string">"gpt-4o-mini"</span>, temperature=<span class="hljs-number">0.3</span>)
model_with_tools = model.bind_tools([
    query_order_status, 
    check_product_stock
])

<span class="hljs-comment"># 客服对话</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">customer_service_chat</span>(<span class="hljs-params">user_message: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""处理客户咨询"""</span>
    messages = [
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, 
            <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个专业的客服助手，帮助用户查询订单和产品信息。"</span>
        },
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_message}
    ]
    
    <span class="hljs-comment"># 模型生成工具调用</span>
    ai_msg = model_with_tools.invoke(messages)
    messages.append(ai_msg)
    
    <span class="hljs-comment"># 执行工具</span>
    <span class="hljs-keyword">if</span> ai_msg.tool_calls:
        <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> ai_msg.tool_calls:
            <span class="hljs-keyword">if</span> tool_call[<span class="hljs-string">'name'</span>] == <span class="hljs-string">'query_order_status'</span>:
                result = query_order_status.invoke(tool_call)
            <span class="hljs-keyword">elif</span> tool_call[<span class="hljs-string">'name'</span>] == <span class="hljs-string">'check_product_stock'</span>:
                result = check_product_stock.invoke(tool_call)
            messages.append(result)
        
        <span class="hljs-comment"># 获取最终响应</span>
        final_response = model_with_tools.invoke(messages)
        <span class="hljs-keyword">return</span> final_response.content
    
    <span class="hljs-keyword">return</span> ai_msg.content

<span class="hljs-comment"># 测试</span>
<span class="hljs-built_in">print</span>(customer_service_chat(<span class="hljs-string">"我的订单ORD001什么时候能送到?"</span>))
<span class="hljs-built_in">print</span>(customer_service_chat(<span class="hljs-string">"iPhone 15还有货吗?"</span>))
</code></pre>
<h3 data-id="heading-33">案例2: 数据提取系统</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

<span class="hljs-comment"># 定义数据结构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContactInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""联系信息"""</span>
    email: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"邮箱地址"</span>)
    phone: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"电话号码"</span>)
    address: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"地址"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""公司信息"""</span>
    name: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"公司名称"</span>)
    industry: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"行业"</span>)
    founded_year: <span class="hljs-built_in">int</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"成立年份"</span>)
    employees: <span class="hljs-built_in">int</span> | <span class="hljs-literal">None</span> = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"员工数量"</span>)
    contact: ContactInfo = Field(..., description=<span class="hljs-string">"联系方式"</span>)

<span class="hljs-comment"># 初始化模型</span>
model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>)
extractor = model.with_structured_output(Company)

<span class="hljs-comment"># 待提取的文本</span>
text = <span class="hljs-string">"""
科技创新公司是一家成立于2015年的人工智能公司。
公司目前有超过500名员工，专注于开发企业级AI解决方案。
联系方式: info@techinnov.com, 电话: 400-888-8888
总部位于北京市海淀区中关村大街1号
"""</span>

<span class="hljs-comment"># 提取结构化数据</span>
company_info = extractor.invoke(<span class="hljs-string">f"从以下文本中提取公司信息:\n<span class="hljs-subst">{text}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"公司名称: <span class="hljs-subst">{company_info.name}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"行业: <span class="hljs-subst">{company_info.industry}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"成立年份: <span class="hljs-subst">{company_info.founded_year}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"员工数: <span class="hljs-subst">{company_info.employees}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"邮箱: <span class="hljs-subst">{company_info.contact.email}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"电话: <span class="hljs-subst">{company_info.contact.phone}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"地址: <span class="hljs-subst">{company_info.contact.address}</span>"</span>)
</code></pre>
<h3 data-id="heading-34">案例3: 多步骤任务执行器</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_web</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""在网络上搜索信息
    
    Args:
        query: 搜索查询
    """</span>
    <span class="hljs-comment"># 模拟网络搜索</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"关于'<span class="hljs-subst">{query}</span>'的搜索结果: [相关信息...]"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize_text</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""总结文本内容
    
    Args:
        text: 要总结的文本
    """</span>
    <span class="hljs-comment"># 模拟文本总结</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"总结: <span class="hljs-subst">{text[:<span class="hljs-number">100</span>]}</span>..."</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_to_database</span>(<span class="hljs-params">data: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""保存数据到数据库
    
    Args:
        data: 要保存的数据
    """</span>
    <span class="hljs-comment"># 模拟数据库保存</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"数据已保存: <span class="hljs-subst">{data[:<span class="hljs-number">50</span>]}</span>..."</span>

<span class="hljs-comment"># 初始化模型</span>
model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0</span>)
model_with_tools = model.bind_tools([
    search_web,
    summarize_text,
    save_to_database
])

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_complex_task</span>(<span class="hljs-params">task_description: <span class="hljs-built_in">str</span>, max_iterations: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
    <span class="hljs-string">"""执行复杂的多步骤任务"""</span>
    messages = [
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>,
            <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个任务执行助手，可以搜索信息、总结内容和保存数据。"</span>
        },
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: task_description}
    ]
    
    iteration = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> iteration &lt; max_iterations:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- 迭代 <span class="hljs-subst">{iteration + <span class="hljs-number">1</span>}</span> ---"</span>)
        
        <span class="hljs-comment"># 模型决定下一步操作</span>
        ai_msg = model_with_tools.invoke(messages)
        messages.append(ai_msg)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ai_msg.tool_calls:
            <span class="hljs-comment"># 没有工具调用，任务完成</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务完成: <span class="hljs-subst">{ai_msg.content}</span>"</span>)
            <span class="hljs-keyword">return</span> ai_msg.content
        
        <span class="hljs-comment"># 执行所有工具调用</span>
        <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> ai_msg.tool_calls:
            tool_name = tool_call[<span class="hljs-string">'name'</span>]
            tool_args = tool_call[<span class="hljs-string">'args'</span>]
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"调用工具: <span class="hljs-subst">{tool_name}</span>(<span class="hljs-subst">{tool_args}</span>)"</span>)
            
            <span class="hljs-keyword">if</span> tool_name == <span class="hljs-string">'search_web'</span>:
                result = search_web.invoke(tool_call)
            <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">'summarize_text'</span>:
                result = summarize_text.invoke(tool_call)
            <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">'save_to_database'</span>:
                result = save_to_database.invoke(tool_call)
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工具结果: <span class="hljs-subst">{result.content}</span>"</span>)
            messages.append(result)
        
        iteration += <span class="hljs-number">1</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">"达到最大迭代次数"</span>

<span class="hljs-comment"># 执行复杂任务</span>
task = <span class="hljs-string">"""
请帮我完成以下任务:
1. 搜索"人工智能最新发展趋势"
2. 总结搜索结果
3. 将总结保存到数据库
"""</span>

result = execute_complex_task(task)
</code></pre>
<h3 data-id="heading-35">案例4: 图像分析助手</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_image</span>(<span class="hljs-params">image_path: <span class="hljs-built_in">str</span>, question: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""分析图像并回答问题"""</span>
    <span class="hljs-comment"># 读取图像并转换为base64</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(image_path, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> image_file:
        base64_image = base64.b64encode(image_file.read()).decode()
    
    <span class="hljs-comment"># 初始化支持视觉的模型</span>
    model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>)
    
    <span class="hljs-comment"># 构建消息</span>
    message = {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: question},
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:image/jpeg;base64,<span class="hljs-subst">{base64_image}</span>"</span>
                }
            }
        ]
    }
    
    <span class="hljs-comment"># 调用模型</span>
    response = model.invoke([message])
    <span class="hljs-keyword">return</span> response.content

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-comment"># result = analyze_image("product.jpg", "这个产品有什么特点?")</span>
<span class="hljs-comment"># print(result)</span>
</code></pre>
<hr/>
<h2 data-id="heading-36">最佳实践</h2>
<h3 data-id="heading-37">1. 选择合适的模型</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 快速任务使用较小的模型</span>
quick_model = init_chat_model(<span class="hljs-string">"gpt-4o-mini"</span>, temperature=<span class="hljs-number">0.3</span>)

<span class="hljs-comment"># 复杂任务使用更强大的模型</span>
advanced_model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0.7</span>)

<span class="hljs-comment"># 根据任务类型选择</span>
<span class="hljs-keyword">if</span> task_complexity == <span class="hljs-string">"simple"</span>:
    model = quick_model
<span class="hljs-keyword">else</span>:
    model = advanced_model
</code></pre>
<h3 data-id="heading-38">2. 合理设置temperature</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 需要确定性输出（如数据提取）</span>
deterministic_model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 需要创造性输出（如写作）</span>
creative_model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0.9</span>)

<span class="hljs-comment"># 平衡方案</span>
balanced_model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, temperature=<span class="hljs-number">0.5</span>)
</code></pre>
<h3 data-id="heading-39">3. 错误处理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model

model = init_chat_model(<span class="hljs-string">"gpt-4o"</span>, max_retries=<span class="hljs-number">3</span>, timeout=<span class="hljs-number">30</span>)

<span class="hljs-keyword">try</span>:
    response = model.invoke(<span class="hljs-string">"你的问题"</span>)
    <span class="hljs-built_in">print</span>(response.content)
<span class="hljs-keyword">except</span> TimeoutError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求超时，请稍后重试"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发生错误: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-40">4. 成本优化</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用批处理减少API调用</span>
questions = [<span class="hljs-string">"问题1"</span>, <span class="hljs-string">"问题2"</span>, <span class="hljs-string">"问题3"</span>]
responses = model.batch(questions, config={<span class="hljs-string">'max_concurrency'</span>: <span class="hljs-number">3</span>})

<span class="hljs-comment"># 使用缓存（如果提供商支持）</span>
<span class="hljs-keyword">from</span> langchain.cache <span class="hljs-keyword">import</span> InMemoryCache
<span class="hljs-keyword">from</span> langchain.<span class="hljs-built_in">globals</span> <span class="hljs-keyword">import</span> set_llm_cache

set_llm_cache(InMemoryCache())

<span class="hljs-comment"># 重复查询会从缓存返回</span>
response1 = model.invoke(<span class="hljs-string">"什么是AI?"</span>)  <span class="hljs-comment"># API调用</span>
response2 = model.invoke(<span class="hljs-string">"什么是AI?"</span>)  <span class="hljs-comment"># 从缓存返回</span>
</code></pre>
<hr/>
<h2 data-id="heading-41">总结</h2>
<p>LangChain Models 提供了强大而灵活的接口来使用各种大语言模型：</p>
<p>✅ <strong>统一接口</strong> - 支持多个模型提供商（OpenAI、Anthropic、Google等）</p>
<p>✅ <strong>多种调用方式</strong> - Invoke、Stream、Batch满足不同场景需求</p>
<p>✅ <strong>工具调用</strong> - 让模型能够调用外部工具和API</p>
<p>✅ <strong>结构化输出</strong> - 确保输出格式符合预期</p>
<p>✅ <strong>高级特性</strong> - 多模态、推理、速率限制等</p>
<p>✅ <strong>易于集成</strong> - 与LangChain生态系统无缝集成</p>
<p>通过本文的学习，你应该能够：</p>
<ul>
<li>初始化和配置各种模型</li>
<li>使用不同的调用方式处理任务</li>
<li>实现工具调用和结构化输出</li>
<li>应用高级特性解决实际问题</li>
</ul>
<hr/>
<h2 data-id="heading-42">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmodels" target="_blank" title="https://docs.langchain.com/oss/python/langchain/models" ref="nofollow noopener noreferrer">LangChain 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain" target="_blank" title="https://github.com/langchain-ai/langchain" ref="nofollow noopener noreferrer">LangChain GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs" target="_blank" title="https://platform.openai.com/docs" ref="nofollow noopener noreferrer">OpenAI API 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2F" target="_blank" title="https://docs.anthropic.com/" ref="nofollow noopener noreferrer">Anthropic API 文档</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[个人本地部署大模型和调用的常用方式]]></title>    <link>https://juejin.cn/post/7600670487408869428</link>    <guid>https://juejin.cn/post/7600670487408869428</guid>    <pubDate>2026-01-30T01:38:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600670487408869428" data-draft-id="7599586891084300322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="个人本地部署大模型和调用的常用方式"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2026-01-30T01:38:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄粱梦醒"/> <meta itemprop="url" content="https://juejin.cn/user/471062436386135"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            个人本地部署大模型和调用的常用方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/471062436386135/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄粱梦醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:38:29.000Z" title="Fri Jan 30 2026 01:38:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>部署大模型的方式有很多，比如ollama、vllm，个人常用的部署方式是使用ollama框架进行部署。</p>
<h2 data-id="heading-0">1 ollama</h2>
<h3 data-id="heading-1">1.1 ollama本地部署大模型</h3>
<p>步骤1:下载ollama软件</p>
<pre><code class="hljs language-linux" lang="linux"># download ollama software
curl -fsSL https://ollama.com/install.sh | sh
</code></pre>
<p>步骤2: 加载模型</p>
<ul>
<li>方法1:官网下载，优点方便，缺点仅支持官网列出来的模型</li>
</ul>
<pre><code class="hljs language-linux" lang="linux"># download model
ollama run kimi-k2.5:cloud # function1
ollama pull bge-m3  # function2
</code></pre>
<ul>
<li>方法2:个性化加载
去huggingface 下载gguf格式的模型，同时下载原生模型的其他配置文件放在一起
通过导入到ollama的model list里面</li>
</ul>
<p>如果有多卡的情况下，进行模型部署会优先进行单卡的显存占用，会出现负载不均衡的情况，这时候可以进行系统配置
<code>systemctl edit ollama.service</code>
进行如下修改</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Service]</span>
...
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"CUDA_VISIBLE_DEVICES=0,1,2,3"</span>  <span class="hljs-comment"># 指定要使用的GPU编号</span>
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"OLLAMA_SCHED_SPREAD=1"</span>         <span class="hljs-comment"># 关键：启用跨GPU调度，负载均衡的关键</span>
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"OLLAMA_KEEP_ALIVE=-1"</span>          <span class="hljs-comment"># 可选：模型常驻内存，避免频繁加载</span>
</code></pre>
<p>重启systemd服务
<strong><code>systemctl daemon-reload</code></strong></p>
<p>重启ollama服务
<code>systemctl restart ollama</code></p>
<h3 data-id="heading-2">1.2 调用ollama部署大模型</h3>
<p>相同服务器调用的方式，直接采用localhost的；不同服务器，需要进行如下操作：</p>
<ul>
<li>设置ollama的系统配置：和上面进行系统设置一样，需要加一个<code>Environment="OLLAMA_HOST=0.0.0.0:11434" </code></li>
<li>需要知道ollama部署的服务器可以公网访问的ip地址
查看方式<code>netstat -tn | grep ESTABLISHED</code>可以查看已经建立的访问端口设置，里面会涉及到公网ip可以找到</li>
<li>在下面用到url的地方使用该公网ip就可以正常进行远程访问了</li>
</ul>
<h4 data-id="heading-3">1.2.1 ollama rest api</h4>
<p><code>OpenAI</code> 的 <code>API</code> 接口是大模型应用开发中最常用、且集成度最高的 <code>API</code> 接口规范，其兼容接口主要包括：</p>
<ul>
<li><code>chat/completions</code></li>
<li><code>completions</code></li>
<li><code>models</code></li>
<li><code>embeddings</code></li>
</ul>
<p>下面的1.2.2和1.2.3中<code>/api/generate</code> 和 <code>/api/chat</code> 接口，其实就是 <code>Ollama</code> 兼容 <code>OpenAI</code> 的 <code>REST API</code> 接口的底层实现。其中:</p>
<ul>
<li><code>/api/generate</code> 接口对应 <code>OpenAI</code> 的 <code>completions</code> 接口；</li>
<li><code>/api/chat</code> 接口对应 <code>OpenAI</code> 的 <code>chat/completions</code> 接口；</li>
</ul>
<p>使用方式(流失输出)</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

client = OpenAI(
    base_url=<span class="hljs-string">'http://192.168.110.131:11434/v1/'</span>,
    api_key=<span class="hljs-string">'ollama'</span>,
)

messages = [
    {
        <span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>,
        <span class="hljs-string">'content'</span>: <span class="hljs-string">'你好，请你介绍一下什么是人工智能？'</span>,
    }
]

<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 调用聊天接口</span>
    stream = client.chat.completions.create(
        model=<span class="hljs-string">'deepseek-r1:8b'</span>,
        messages=messages,
        stream=<span class="hljs-literal">True</span>
    )
    
    <span class="hljs-comment"># 处理流式响应</span>
    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> stream:
        <span class="hljs-keyword">if</span> chunk.choices[<span class="hljs-number">0</span>].delta.content <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-built_in">print</span>(chunk.choices[<span class="hljs-number">0</span>].delta.content, end=<span class="hljs-string">''</span>, flush=<span class="hljs-literal">True</span>)
            
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发生错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
</code></pre>
<h4 data-id="heading-4">1.2.2 generate的API</h4>
<p>对于<code>endpoints</code>来说，如果使用代码调用，常规的调用方式是通<code>requests</code>库进行调用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests <span class="hljs-comment"># type: ignore</span>
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 设置 API 端点</span>
generate_url = <span class="hljs-string">"http://192.168.110.131:11434/api/generate"</span>    <span class="hljs-comment"># 这里需要根据实际情况进行修改</span>

<span class="hljs-comment"># 示例数据</span>
generate_payload = {
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"deepseek-r1:7b"</span>,   <span class="hljs-comment"># 这里需要根据实际情况进行修改</span>
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"请生成一个关于人工智能的简短介绍。"</span>,  <span class="hljs-comment"># 这里需要根据实际情况进行修改</span>
    <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>,       <span class="hljs-comment"># 默认使用的是True，如果设置为False，则返回的是一个完整的响应，而不是一个流式响应</span>
}

<span class="hljs-comment"># 调用生成接口</span>
response_generate = requests.post(generate_url, json=generate_payload)
<span class="hljs-keyword">if</span> response_generate.status_code == <span class="hljs-number">200</span>:
    generate_response = response_generate.json()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成响应:"</span>, json.dumps(generate_response, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>))
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成请求失败:"</span>, response_generate.status_code, response_generate.text)
</code></pre>
<p>重要参数及其解释：</p>
<ul>
<li><code>model</code>:模型的名称，一定要是ollama上展示的模型的名称</li>
<li><code>prompt</code>:字符串，用户的提问</li>
<li><code>format</code>:</li>
<li><code>options</code>:对输入输出进行控制的参数，类型是字典
<ul>
<li><code>num_ctx</code>：输入的文本的token长度限制</li>
<li><code>num_predict</code>：输出文本的token限制长度(think模型的think部分也会计算在内)</li>
<li><code>temperature</code>,<code>top_k</code>, <code>top_p</code>：文本生成多样性的控制，temperature一般在0.5-0.7可以有效避免循环生成。</li>
<li><code>stop</code>：停止控制，遇到给定的字符串就停止继续生成文本。</li>
</ul>
</li>
<li><code>system</code>:系统提示词</li>
<li><code>stream</code>:是否流式打印，其中，是否流失对于需要的代码是不一样的</li>
<li><code>keep_alive</code>:模型加载在显存中如果长期不使用会浪费资源，ollama不设置该参数的话，通常保存5分钟加载，限定时间的话可以设置“10m”等，如果想永久加载就设置负数</li>
</ul>
<h4 data-id="heading-5">1.2.3 chat的API</h4>
<p>与generate参数基本一致，但是在使用上更符合chat用户的对话习惯，如使用messages传参而不是prompt，支持tools
调用方法和generate大部分一致，只是在url和传参是messages有一点不同</p>
<pre><code class="hljs language-python" lang="python">
generate_url = <span class="hljs-string">"http://localhost:11434/api/chat"</span>
generate_payload = {
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"llama-2-7b-chat-q4_0"</span>,
    <span class="hljs-string">"messages"</span>: [
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>,
            <span class="hljs-string">"content"</span>: <span class="hljs-string">"You are a helpful assistant."</span>
        },
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"content"</span>: <span class="hljs-string">"What is the meaning of transformers?"</span>
        }
    ],
    <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>
}
</code></pre>
<h4 data-id="heading-6">1.2.4 总结</h4>
<p>openai兼容的接口，但是可使用的参数相对较少一些；
generate和chat这种原生api可控制性和灵活性更强。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust + Wasm + AI（二）：让浏览器开始思考 —— 基于 Candle 的端侧情感引擎]]></title>    <link>https://juejin.cn/post/7600710943249580074</link>    <guid>https://juejin.cn/post/7600710943249580074</guid>    <pubDate>2026-01-30T01:50:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600710943249580074" data-draft-id="7600670487408738356" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust + Wasm + AI（二）：让浏览器开始思考 —— 基于 Candle 的端侧情感引擎"/> <meta itemprop="keywords" content="Rust,AI编程,人工智能"/> <meta itemprop="datePublished" content="2026-01-30T01:50:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Rust知行社"/> <meta itemprop="url" content="https://juejin.cn/user/4186572019737624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust + Wasm + AI（二）：让浏览器开始思考 —— 基于 Candle 的端侧情感引擎
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4186572019737624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Rust知行社
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:50:50.000Z" title="Fri Jan 30 2026 01:50:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Rust + Wasm + AI（二）：让浏览器开始思考 —— 基于 Candle 的端侧情感引擎</h2>
<p><strong>导读</strong>：上一篇我们聊了 Rust + Wasm + AI 的宏大愿景，这次我们真的把 BERT 模型塞进了浏览器。当用户在输入框敲下"这服务太棒了"的瞬间，模型已经完成推理，驱动满屏粒子爆发出青色光晕。全程零服务器请求，数据不出本地，甚至断网都能用。</p>
<h3 data-id="heading-1">1. 引言：打破 请求-响应 的旧枷锁</h3>
<h4 data-id="heading-2">算力的南水北调</h4>
<p>传统 AI 部署像南水北调 —— 把用户数据千里迢迢送到 GPU 集群，再把结果运回来。这种模式有三个问题：</p>
<ol>
<li><strong>延迟陷阱</strong>：网络抖动100ms就能毁掉输入流畅感，复杂推理直奔秒级。</li>
<li><strong>隐私裸奔</strong>：每一句私密输入都在公网<strong>裸奔</strong>，数据必须出域。</li>
<li><strong>成本黑洞</strong>：简单分类任务也在消耗昂贵GPU显存，断网即服务死亡。</li>
</ol>
<p>但算力格局正在发生剧变。M2 Max 的神经网络引擎已达 15.8 TOPS，高端安卓机的 NPU 也轻松突破 5 TOPS。</p>
<p><strong>Rust + Wasm 的出现，让我们能够实施算力突围：</strong> 将推理任务下放到用户的 CPU/GPU。这不仅是成本的节约，更是人机交互体验的质变。</p>
<h4 data-id="heading-3">端侧 AI 的杀手锏</h4>
<p>本次情感分析引擎在 MacBook Pro M1 的浏览器环境中可实现即时响应。</p>
<ul>
<li><strong>零延迟</strong>：用户松开键盘的瞬间，情感分数已出现在屏幕。</li>
<li><strong>隐私设计</strong>：数据不出内存，连本地存储都不沾。</li>
<li><strong>离线优先</strong>：一次加载，永久可用。</li>
</ul>
<h4 data-id="heading-4">本篇核心</h4>
<p>深度拆解如何利用 Rust 生态，让 <strong>uer/roberta-base-finetuned-jd-binary-chinese</strong> 模型在浏览器里实现毫秒级读心术。</p>
<h3 data-id="heading-5">2. 演示效果</h3>
<p>先展示一下在浏览器中的运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34886ec669124d06a4dc683c31efeb72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUnVzdOefpeihjOekvg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770342649&amp;x-signature=Yuh4ytNj%2FCzfc3pG%2BqqrOvUBJHQ%3D" alt="output1.jpg" loading="lazy"/></p>
<h3 data-id="heading-6">3. 技术选型：为什么是 Candle？</h3>
<h4 data-id="heading-7">Candle 的极致主义</h4>
<p><strong>Candle</strong> 是 HuggingFace 出品的纯 Rust 框架，专为<strong>轻量化推理</strong>而生， 关键优势在于：</p>
<ol>
<li><strong>真正的按需加载</strong>：模型结构代码编译进 Wasm，权重按需 fetch，无冗余运行时。</li>
<li><strong>零拷贝架构</strong>：通过 <code>Safetensors</code> 格式，Rust 可以直接将 Wasm 内存映射为张量，无需在 JS 和 Rust 之间进行昂贵的序列化。</li>
<li><strong>Wasm 友好</strong>：纯 Rust 实现，无 C++ FFI，编译产物干净利落。</li>
</ol>
<h4 data-id="heading-8">Safetensors：Wasm 时代的权重协议</h4>
<p>传统 PyTorch 的 <code>.bin</code> 格式，本质是 Pickle——<strong>可以执行任意代码</strong>，在浏览器里加载等于引狼入室。</p>
<p><strong>Safetensors</strong> 是新标准，核心优势在于：</p>
<ul>
<li><strong>零拷贝加载</strong>：内存映射后直接算，无需反序列化。</li>
<li><strong>安全</strong>：纯数据，无代码执行风险。</li>
<li><strong>自描述</strong>：JSON 头信息让浏览器提前知道内存布局。</li>
</ul>
<h3 data-id="heading-9">3. 架构设计：四层流水线</h3>
<p>整个引擎分为四层，每层都是性能战场：</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────────┐
│  资源层(fetch) │ ← 模型/分词器加载
├─────────────┤
│  转换层(Wasm)  │ ← 二进制流注入内存
├─────────────┤
│  计算层(Candle)│ ← 动态图构建与推理
├─────────────┤
│  交互层(Canvas)│ ← 粒子渲染与反馈
└─────────────┘
</code></pre>
<p><strong>关键设计决策</strong>：</p>
<ol>
<li><strong>Tokenizer 预处理</strong>：将 <code>tokenizer.json</code> 提前序列化为静态数组，避免运行时 JSON 解析开销。</li>
<li><strong>零拷贝张量映射 (Zero-copy Mapping)</strong>：利用 <code>Safetensors</code> 内存对齐 特性，将模型权重直接从 <code>ArrayBuffer</code> 映射为 <code>Candle</code> 张量，实现首屏启动零内存拷贝。</li>
<li><strong>内存池复用</strong>：推理中间结果复用同一块 Wasm 内存，避免 GC 压力。</li>
</ol>
<hr/>
<h3 data-id="heading-10">4. 工程实战：从零构建 Wasm 推理核</h3>
<h4 data-id="heading-11">Python 端：模型选择与转换</h4>
<p>最初选择的模型是 <code>jackietung/bert-base-chinese-finetuned-sentiment</code>，因为此模型支持  <code>.safetensors</code> 文件格式且支持中文环境。
但是试用过后，发现推理能力明显不行，比如输入 “难过”，结果推理结果为 “正向”。</p>
<p><code>uer/roberta-base-finetuned-jd-binary-chinese</code> 模型, 对中文的情感分析能力更加强大，并且在京东真实评论数据上微调，电商场景准。</p>
<p>但是此模型好久没有更新过，没有提供 <code>.safetensors</code> 格式的文件，所以只能自己进行转换。</p>
<p>转换代码在 <code>candle-senti-pulse/model2safetensor</code> 目录中，是使用 <code>uv</code> 进行管理的Python脚本，用于将<code>uer/roberta-base-finetuned-jd-binary-chinese</code>模型转换为Safetensors格式。</p>
<p>代码实现如下：</p>
<pre><code class="hljs language-python" lang="python">MODEL_NAME = <span class="hljs-string">"uer/roberta-base-finetuned-jd-binary-chinese"</span>
SAVE_DIR = <span class="hljs-string">"./converted_model"</span>

<span class="hljs-comment"># 强制使用镜像</span>
os.environ[<span class="hljs-string">"HF_ENDPOINT"</span>] = <span class="hljs-string">"https://hf-mirror.com"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">convert</span>():
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(SAVE_DIR):
        os.makedirs(SAVE_DIR)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 加载</span>
        model = AutoModelForSequenceClassification.from_pretrained(MODEL_NAME, trust_remote_code=<span class="hljs-literal">True</span>)
        tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME, trust_remote_code=<span class="hljs-literal">True</span>)

        <span class="hljs-comment"># 1. 导出 config</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"📦 正在生成 config.json..."</span>)
        config = model.config.to_dict()
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(os.path.join(SAVE_DIR, <span class="hljs-string">"config.json"</span>), <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
            json.dump(config, f, indent=<span class="hljs-number">2</span>, ensure_ascii=<span class="hljs-literal">False</span>)

        <span class="hljs-comment"># 2. 导出 tokenizer</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"📝 正在生成 tokenizer.json..."</span>)
        tokenizer.save_pretrained(SAVE_DIR)

        <span class="hljs-comment"># 3. 导出权重</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"💾 正在生成 model.safetensors..."</span>)
        state_dict = model.state_dict()

        <span class="hljs-comment"># 移除可能存在的 _orig_mod 等前缀（如果使用了 torch.compile）</span>
        clean_state_dict = {k.replace(<span class="hljs-string">"_orig_mod."</span>, <span class="hljs-string">""</span>): v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> state_dict.items()}

        save_file(clean_state_dict, os.path.join(SAVE_DIR, <span class="hljs-string">"model.safetensors"</span>))

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n❌ 下载失败: <span class="hljs-subst">{e}</span>"</span>)

</code></pre>
<p>转换完成后，就可以将模型复制到 <code>www/models</code> 目录下。</p>
<h4 data-id="heading-12">Rust 侧：SentiPulseEngine 设计</h4>
<p>通过 Candle 加载模型的权重， 并使用 <code>VarBuilder</code> 构建计算图。</p>
<p>核心代码如下：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> candle_core::{DType, Device, Tensor};
<span class="hljs-keyword">use</span> candle_nn::VarBuilder;
<span class="hljs-keyword">use</span> candle_transformers::models::bert::{BertModel, Config};
<span class="hljs-keyword">use</span> tokenizers::Tokenizer;
<span class="hljs-keyword">use</span> wasm_bindgen::prelude::*;

<span class="hljs-meta">#[wasm_bindgen]</span>
<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SentiPulseResult</span> {
    negative: <span class="hljs-type">f32</span>,
    positive: <span class="hljs-type">f32</span>,
    neutral: <span class="hljs-type">f32</span>,
}

<span class="hljs-meta">#[wasm_bindgen]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">SentiPulseResult</span> {
    <span class="hljs-meta">#[wasm_bindgen(getter)]</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">negative</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f32</span> {
        <span class="hljs-keyword">self</span>.negative
    }
    <span class="hljs-meta">#[wasm_bindgen(getter)]</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">positive</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f32</span> {
        <span class="hljs-keyword">self</span>.positive
    }
    <span class="hljs-meta">#[wasm_bindgen(getter)]</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">neutral</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f32</span> {
        <span class="hljs-keyword">self</span>.neutral
    }
}

<span class="hljs-meta">#[wasm_bindgen]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SentiPulseEngine</span> {
    model: BertModel,
    tokenizer: Tokenizer,
    <span class="hljs-comment">// 分类头</span>
    w_out: Tensor,
    b_out: Tensor,
    <span class="hljs-comment">// 新增：Pooler 层 (用于处理 CLS 向量)</span>
    w_pooler: <span class="hljs-type">Option</span>&lt;Tensor&gt;,
    b_pooler: <span class="hljs-type">Option</span>&lt;Tensor&gt;,
}

<span class="hljs-meta">#[wasm_bindgen]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">SentiPulseEngine</span> {
    <span class="hljs-meta">#[wasm_bindgen(constructor)]</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(
        weights: &amp;[<span class="hljs-type">u8</span>],
        tokenizer_data: &amp;[<span class="hljs-type">u8</span>],
        config_str: &amp;<span class="hljs-type">str</span>,
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;SentiPulseEngine, JsError&gt; {
        console_error_panic_hook::<span class="hljs-title function_ invoke__">set_once</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">device</span> = &amp;Device::Cpu;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">tokenizer</span> =
            Tokenizer::<span class="hljs-title function_ invoke__">from_bytes</span>(tokenizer_data).<span class="hljs-title function_ invoke__">map_err</span>(|e| JsError::<span class="hljs-title function_ invoke__">new</span>(&amp;e.<span class="hljs-title function_ invoke__">to_string</span>()))?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">config</span>: Config =
            serde_json::<span class="hljs-title function_ invoke__">from_str</span>(config_str).<span class="hljs-title function_ invoke__">map_err</span>(|e| JsError::<span class="hljs-title function_ invoke__">new</span>(&amp;e.<span class="hljs-title function_ invoke__">to_string</span>()))?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">vb</span> = VarBuilder::<span class="hljs-title function_ invoke__">from_buffered_safetensors</span>(weights.<span class="hljs-title function_ invoke__">to_vec</span>(), DType::F32, device)?;

        <span class="hljs-comment">// 1. 加载 BERT</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">model</span> = BertModel::<span class="hljs-title function_ invoke__">load</span>(vb.<span class="hljs-title function_ invoke__">pp</span>(<span class="hljs-string">"bert"</span>), &amp;config)?;

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">w_pooler</span> = vb
            .<span class="hljs-title function_ invoke__">pp</span>(<span class="hljs-string">"bert"</span>)
            .<span class="hljs-title function_ invoke__">get</span>(
                (config.hidden_size, config.hidden_size),
                <span class="hljs-string">"pooler.dense.weight"</span>,
            )
            .<span class="hljs-title function_ invoke__">ok</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">b_pooler</span> = vb
            .<span class="hljs-title function_ invoke__">pp</span>(<span class="hljs-string">"bert"</span>)
            .<span class="hljs-title function_ invoke__">get</span>(config.hidden_size, <span class="hljs-string">"pooler.dense.bias"</span>)
            .<span class="hljs-title function_ invoke__">ok</span>();

        <span class="hljs-comment">// 3. 加载 Classifier (带兼容逻辑)</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">num_labels</span> = <span class="hljs-number">2</span>;

        <span class="hljs-comment">// 使用 or_else 链式尝试不同的 Key 名</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">w_out</span> = vb
            .<span class="hljs-title function_ invoke__">get</span>((num_labels, config.hidden_size), <span class="hljs-string">"classifier.weight"</span>)
            .<span class="hljs-title function_ invoke__">or_else</span>(|_| {
                vb.<span class="hljs-title function_ invoke__">get</span>(
                    (num_labels, config.hidden_size),
                    <span class="hljs-string">"classifier.out_proj.weight"</span>,
                )
            })
            .<span class="hljs-title function_ invoke__">or_else</span>(|_| vb.<span class="hljs-title function_ invoke__">get</span>((num_labels, config.hidden_size), <span class="hljs-string">"classifier.dense.weight"</span>))
            .<span class="hljs-title function_ invoke__">map_err</span>(|_| JsError::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"权重文件中缺少分类层 (classifier weight)"</span>))?;

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">b_out</span> = vb
            .<span class="hljs-title function_ invoke__">get</span>(num_labels, <span class="hljs-string">"classifier.bias"</span>)
            .<span class="hljs-title function_ invoke__">or_else</span>(|_| vb.<span class="hljs-title function_ invoke__">get</span>(num_labels, <span class="hljs-string">"classifier.out_proj.bias"</span>))
            .<span class="hljs-title function_ invoke__">or_else</span>(|_| vb.<span class="hljs-title function_ invoke__">get</span>(num_labels, <span class="hljs-string">"classifier.dense.bias"</span>))
            .<span class="hljs-title function_ invoke__">map_err</span>(|_| JsError::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"权重文件中缺少分类层偏置 (classifier bias)"</span>))?;

        <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-keyword">Self</span> {
            model,
            tokenizer,
            w_out,
            b_out,
            w_pooler,
            b_pooler,
        })
    }

    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">predict</span>(&amp;<span class="hljs-keyword">self</span>, text: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;SentiPulseResult, JsError&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">device</span> = &amp;Device::Cpu;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">tokens</span> = <span class="hljs-keyword">self</span>
            .tokenizer
            .<span class="hljs-title function_ invoke__">encode</span>(text, <span class="hljs-literal">true</span>)
            .<span class="hljs-title function_ invoke__">map_err</span>(|e| JsError::<span class="hljs-title function_ invoke__">new</span>(&amp;e.<span class="hljs-title function_ invoke__">to_string</span>()))?;

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">input_ids</span> = Tensor::<span class="hljs-title function_ invoke__">new</span>(tokens.<span class="hljs-title function_ invoke__">get_ids</span>(), device)?.<span class="hljs-title function_ invoke__">unsqueeze</span>(<span class="hljs-number">0</span>)?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">token_type_ids</span> = Tensor::<span class="hljs-title function_ invoke__">new</span>(tokens.<span class="hljs-title function_ invoke__">get_type_ids</span>(), device)?.<span class="hljs-title function_ invoke__">unsqueeze</span>(<span class="hljs-number">0</span>)?;

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">enc</span> = <span class="hljs-keyword">self</span>.model.<span class="hljs-title function_ invoke__">forward</span>(&amp;input_ids, &amp;token_type_ids, <span class="hljs-literal">None</span>)?;

        <span class="hljs-comment">// 取出 [CLS] (原始向量)</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cls_token</span> = enc.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0</span>)?.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">0</span>)?.<span class="hljs-title function_ invoke__">unsqueeze</span>(<span class="hljs-number">0</span>)?;

        <span class="hljs-comment">// --- 执行 Pooler (如果存在) ---</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> (<span class="hljs-title function_ invoke__">Some</span>(w), <span class="hljs-title function_ invoke__">Some</span>(b)) = (&amp;<span class="hljs-keyword">self</span>.w_pooler, &amp;<span class="hljs-keyword">self</span>.b_pooler) {
            <span class="hljs-comment">// Pooler 逻辑: Tanh( Linear(CLS) )</span>
            cls_token = cls_token.<span class="hljs-title function_ invoke__">matmul</span>(&amp;w.<span class="hljs-title function_ invoke__">t</span>()?)?.<span class="hljs-title function_ invoke__">broadcast_add</span>(b)?.<span class="hljs-title function_ invoke__">tanh</span>()?;
        }

        <span class="hljs-comment">// 执行分类计算</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">logits</span> = cls_token
            .<span class="hljs-title function_ invoke__">matmul</span>(&amp;<span class="hljs-keyword">self</span>.w_out.<span class="hljs-title function_ invoke__">t</span>()?)?
            .<span class="hljs-title function_ invoke__">broadcast_add</span>(&amp;<span class="hljs-keyword">self</span>.b_out)?;

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">scale_factor</span> = <span class="hljs-number">1.0</span>;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">scaled_logits</span> = (logits * scale_factor <span class="hljs-keyword">as</span> <span class="hljs-type">f64</span>)?;

        <span class="hljs-comment">// 进行 Softmax</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">pr</span> = candle_nn::ops::<span class="hljs-title function_ invoke__">softmax</span>(&amp;scaled_logits.<span class="hljs-title function_ invoke__">flatten_all</span>()?, <span class="hljs-number">0</span>)?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">scores</span> = pr.to_vec1::&lt;<span class="hljs-type">f32</span>&gt;()?;

        <span class="hljs-comment">// 自动适配二分类或三分类</span>
        <span class="hljs-keyword">let</span> (neg, pos, neu) = <span class="hljs-keyword">if</span> scores.<span class="hljs-title function_ invoke__">len</span>() &gt;= <span class="hljs-number">3</span> {
            (scores[<span class="hljs-number">0</span>], scores[<span class="hljs-number">1</span>], scores[<span class="hljs-number">2</span>])
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">n</span> = scores[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">p</span> = scores[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">diff</span> = (n - p).<span class="hljs-title function_ invoke__">abs</span>();

            <span class="hljs-comment">// 基础中性分：当差距很大时，直接设为 0</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">m</span> = <span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0.2</span> {
                <span class="hljs-number">0.8</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0.4</span> {
                <span class="hljs-number">0.3</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-number">0.0</span> <span class="hljs-comment">// 情绪明确，中性归零</span>
            };

            <span class="hljs-comment">// 执行归一化</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">total</span> = n + p + m;
            <span class="hljs-keyword">if</span> total &gt; <span class="hljs-number">0.0</span> {
                n = n / total;
                p = p / total;
                m = m / total;
                (n, p, m)
            } <span class="hljs-keyword">else</span> {
                (<span class="hljs-number">0.33</span>, <span class="hljs-number">0.33</span>, <span class="hljs-number">0.34</span>) <span class="hljs-comment">// 兜底：防止除以零</span>
            }
        };
        <span class="hljs-comment">// 它们可能长这样：[0.1, 0.2, 0.5] -&gt; 放大后 -&gt; [0.5, 1.0, 2.5]</span>
        web_sys::console::<span class="hljs-title function_ invoke__">log_1</span>(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Raw Text: {}, Raw Scores: {:?}"</span>, text, scores).<span class="hljs-title function_ invoke__">into</span>());
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = SentiPulseResult {
            negative: neg,
            positive: pos,
            neutral: neu,
        };
        web_sys::console::<span class="hljs-title function_ invoke__">log_1</span>(&amp;<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Raw Text: {}, result: {:?}"</span>, text, result).<span class="hljs-title function_ invoke__">into</span>());

        <span class="hljs-title function_ invoke__">Ok</span>(result)
    }
}

</code></pre>
<p><strong>关键行解析：</strong></p>
<ul>
<li><strong><code>VarBuilder::from_buffered_safetensors</code></strong>: 避免了将巨大的模型文件在内存中反复 Copy，直接在内存池中构建权重。</li>
<li><strong><code>Result&lt;T, JsValue&gt;</code></strong>: 这是 Rust 与 JS 交互的最佳实践，能够让 JS 端的 <code>try-catch</code> 捕获到详细的 Rust 错误。</li>
<li><strong><code>unsqueeze(0)</code></strong>: 将一维 <code>Token</code> 序列升维为模型所需的 <code>Batch</code> 张量。</li>
</ul>
<h4 data-id="heading-13">JS 侧：模型推理与粒子风暴</h4>
<p><strong>粒子风暴系统</strong>：
用于根据情感分析分数, 动态渲染不同的粒子颜色和速度。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// =========================================</span>
<span class="hljs-comment">// PART 1: 粒子风暴系统 (Particle System)</span>
<span class="hljs-comment">// =========================================</span>
<span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"particle-canvas"</span>);
<span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);

<span class="hljs-comment">// 设置画布大小</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">resizeCanvas</span>(<span class="hljs-params"/>) {
  canvas.<span class="hljs-property">width</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
  canvas.<span class="hljs-property">height</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
}
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"resize"</span>, resizeCanvas);
<span class="hljs-title function_">resizeCanvas</span>();

<span class="hljs-comment">// 粒子参数全局状态 (受 AI 情绪驱动)</span>
<span class="hljs-keyword">let</span> globalMood = {
  <span class="hljs-attr">neg</span>: <span class="hljs-number">0.1</span>, <span class="hljs-comment">// 初始平静状态</span>
  <span class="hljs-attr">pos</span>: <span class="hljs-number">0.9</span>,
  <span class="hljs-attr">neu</span>: <span class="hljs-number">0.1</span>,
  <span class="hljs-attr">targetSpeed</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attr">currentSpeed</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attr">chaos</span>: <span class="hljs-number">0.2</span>, <span class="hljs-comment">// 混乱度</span>
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Particle</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reset</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * canvas.<span class="hljs-property">height</span>; <span class="hljs-comment">// 初始随机分布</span>
  }

  <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * canvas.<span class="hljs-property">width</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> = canvas.<span class="hljs-property">height</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>; <span class="hljs-comment">// 从底部生成</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
    <span class="hljs-comment">// 基础速度 + 随机扰动</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">baseSpeedY</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1</span> + <span class="hljs-number">0.5</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vx</span> = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.5</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vy</span> = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">baseSpeedY</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">alpha</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.2</span>;
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 根据全局情绪平滑调整当前速度</span>
    globalMood.<span class="hljs-property">currentSpeed</span> +=
      (globalMood.<span class="hljs-property">targetSpeed</span> - globalMood.<span class="hljs-property">currentSpeed</span>) * <span class="hljs-number">0.05</span>;

    <span class="hljs-comment">// 情绪越消极，速度越快，水平扰动越大(混乱)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">vx</span> * (<span class="hljs-number">1</span> + globalMood.<span class="hljs-property">chaos</span> * <span class="hljs-number">5</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">vy</span> * globalMood.<span class="hljs-property">currentSpeed</span>;

    <span class="hljs-comment">// 边界检查，循环利用</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span> &lt; -<span class="hljs-number">10</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reset</span>();
  }

  <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">/// 强化颜色计算：确保 neg 占主导时 R 通道强制拉满</span>
    <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(globalMood.<span class="hljs-property">neg</span> * <span class="hljs-number">255</span> + globalMood.<span class="hljs-property">neu</span> * <span class="hljs-number">168</span>);
    <span class="hljs-keyword">const</span> g = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(globalMood.<span class="hljs-property">pos</span> * <span class="hljs-number">242</span> + globalMood.<span class="hljs-property">neu</span> * <span class="hljs-number">85</span>);
    <span class="hljs-keyword">const</span> b = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(globalMood.<span class="hljs-property">pos</span> * <span class="hljs-number">255</span> + globalMood.<span class="hljs-property">neu</span> * <span class="hljs-number">247</span>);

    <span class="hljs-comment">// 氛围补偿：负面越高，粒子稍微变大一点，增加压迫感</span>
    <span class="hljs-keyword">const</span> dynamicSize = <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> * (<span class="hljs-number">1</span> + globalMood.<span class="hljs-property">neg</span> * <span class="hljs-number">1.5</span>);

    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">`rgba(<span class="hljs-subst">${r}</span>, <span class="hljs-subst">${g}</span>, <span class="hljs-subst">${b}</span>, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.alpha + globalMood.neg * <span class="hljs-number">0.3</span>}</span>)`</span>;
    ctx.<span class="hljs-title function_">beginPath</span>();
    ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">y</span>, dynamicSize, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
    ctx.<span class="hljs-title function_">fill</span>();
  }
}

<span class="hljs-keyword">const</span> particles = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">150</span> }, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Particle</span>());

<span class="hljs-keyword">function</span> <span class="hljs-title function_">animateParticles</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 使用半透明黑色清空画布，制造拖尾效果</span>
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">"rgba(10, 11, 16, 0.2)"</span>;
  ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);

  particles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> {
    p.<span class="hljs-title function_">update</span>();
    p.<span class="hljs-title function_">draw</span>();
  });
  <span class="hljs-title function_">requestAnimationFrame</span>(animateParticles);
}

<span class="hljs-comment">// 启动粒子动画</span>
<span class="hljs-title function_">animateParticles</span>();
</code></pre>
<p><strong>模型初始化</strong>：</p>
<p>通过 <code>fetch</code> 加载模型资源，并实例化。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 中文模型资源</span>
<span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">"./model/uer/roberta-base-finetuned-jd-binary-chinese/"</span>;

<span class="hljs-comment">// 注意：文件名可能需要根据仓库实际情况调整</span>
<span class="hljs-keyword">const</span> [weights, tokenizer, config] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
  <span class="hljs-title function_">fetch</span>(baseUrl + <span class="hljs-string">"model.safetensors"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">arrayBuffer</span>()),
  <span class="hljs-title function_">fetch</span>(baseUrl + <span class="hljs-string">"tokenizer.json"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">arrayBuffer</span>()),
  <span class="hljs-title function_">fetch</span>(baseUrl + <span class="hljs-string">"config.json"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">text</span>()),
]);


<span class="hljs-keyword">const</span> engine = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SentiPulseEngine</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(weights),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(tokenizer),
  config,
);
</code></pre>
<h5 data-id="heading-14">模型推理</h5>
<p>通过输入中文评论，调用 Rust Wasm 模块进行情感分析, 并返回情感分数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> t0 = performance.<span class="hljs-title function_">now</span>();
<span class="hljs-comment">// 1. 调用 Rust Wasm (返回对象包含 neg, pos, neu)</span>
<span class="hljs-keyword">const</span> result = engine.<span class="hljs-title function_">predict</span>(text);
<span class="hljs-keyword">const</span> { <span class="hljs-attr">negative</span>: neg, <span class="hljs-attr">positive</span>: pos, <span class="hljs-attr">neutral</span>: neu } = result;
<span class="hljs-keyword">const</span> t1 = performance.<span class="hljs-title function_">now</span>();
</code></pre>
<h3 data-id="heading-15">5. 运行情感分析推理</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 模型下载及转换</span>
<span class="hljs-built_in">cd</span> model2safetensor &amp;&amp; uv run main.py
<span class="hljs-comment"># 2. 构建 Wasm 模块</span>
cargo build --target web --release
<span class="hljs-comment"># 3. 启动本地服务器</span>
miniserve .
</code></pre>
<p>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8080%2Fwww%2Findex.html" target="_blank" title="http://127.0.0.1:8080/www/index.html" ref="nofollow noopener noreferrer">http://127.0.0.1:8080/www/index.html</a> ，在输入框输入中文评论，就可以看到情感分析分数及情绪粒子风暴的变化了。</p>
<h3 data-id="heading-16">6. 总结：开启 Web 推理的新纪元</h3>
<p>从 调包侠 到 推理架构师, 这一步的跨越在于：我们已可以<strong>掌控算力的分配权。</strong> 通过 Rust + Wasm，我们证明了即使是复杂的 Transformer 模型，也能在用户的指尖轻盈跃动。</p>
<p>下一步，我们将引入 <strong>WebGPU</strong>，探索如何在浏览器里运行 3B 参数量级的端侧大模型（LLM）。</p>
<p><strong>源代码地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDoomking%2Frust-zhixingshe-examples%2Ftree%2Fmain%2Fwasm%2Fcandle-senti-pulse" target="_blank" title="https://github.com/Doomking/rust-zhixingshe-examples/tree/main/wasm/candle-senti-pulse" ref="nofollow noopener noreferrer">github.com/Doomking/ru…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教大家解析与部署Moltbot技术]]></title>    <link>https://juejin.cn/post/7600706866784763947</link>    <guid>https://juejin.cn/post/7600706866784763947</guid>    <pubDate>2026-01-30T02:17:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600706866784763947" data-draft-id="7600674821308137508" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教大家解析与部署Moltbot技术"/> <meta itemprop="keywords" content="GitHub,API"/> <meta itemprop="datePublished" content="2026-01-30T02:17:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Smoothcloud_润云"/> <meta itemprop="url" content="https://juejin.cn/user/2948233128844891"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教大家解析与部署Moltbot技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2948233128844891/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Smoothcloud_润云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:17:35.000Z" title="Fri Jan 30 2026 02:17:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Moltbot技术解析与部署实战指南</h2>
<blockquote>
<p>整合72.1K+ Stars开源项目的核心技术细节，从个人开发到企业生产环境全覆盖</p>
</blockquote>
<h3 data-id="heading-1">项目概述</h3>
<p><strong>Moltbot</strong>（原Clawdbot，2026年1月完成品牌升级）是一款基于Transformer架构的高性能AI对话引擎，兼具个人助手的轻量化特性与生产级系统的高并发处理能力。项目以“本地优先、多端协同、动态进化”为核心设计理念，支持WhatsApp、Telegram等多平台集成，提供浏览器控制、定时任务调度等自动化功能。</p>
<p><strong>项目亮点</strong>：</p>
<ul>
<li>GitHub 72.1K+ Stars，开发者社区热门开源项目</li>
<li>2.1.0版本已通过生产环境验证，支持日均千万级对话请求</li>
<li>微服务混合架构，支持独立扩展与热升级</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dee51607efc4ffcb30172fa93543797~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU21vb3RoY2xvdWRf5ram5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770344255&amp;x-signature=iWb4kQlW96udh%2Bc4m0nlQNFpQVo%3D" alt="f5788c3c2a72df6b0a9848b72edd6ef0.png" loading="lazy"/></p>
<h3 data-id="heading-2">一、核心架构深度解析</h3>
<h4 data-id="heading-3">1.1 四大核心组件设计</h4>
<h5 data-id="heading-4">1.1.1 对话理解引擎（DUE）</h5>
<p>采用多层级意图识别架构，融合字符级与词级联合编码技术：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 核心意图识别实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiIntentUnderstanding</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.tokenizer = BertTokenizer.from_pretrained(<span class="hljs-string">'bert-base-multilingual'</span>)
        self.encoder = TransformerEncoder(
            num_layers=<span class="hljs-number">12</span>, 
            hidden_size=<span class="hljs-number">768</span>, 
            attention_heads=<span class="hljs-number">12</span>, 
            dropout=<span class="hljs-number">0.1</span>
        )
        self.intent_classifier = HierarchicalClassifier(
            coarse_labels=<span class="hljs-number">32</span>,      <span class="hljs-comment"># 粗粒度意图</span>
            fine_grained_labels=<span class="hljs-number">256</span> <span class="hljs-comment"># 细粒度意图</span>
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, input_seq</span>):
        <span class="hljs-comment"># 字符级+词级联合编码</span>
        char_emb = self.char_cnn(input_seq)
        word_emb = self.word_embedding(input_seq)
        combined = torch.cat([char_emb, word_emb], dim=-<span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># 上下文感知编码</span>
        contextualized = self.encoder(combined)
        
        <span class="hljs-comment"># 分层意图识别</span>
        coarse_intent = self.intent_classifier.coarse_layer(contextualized[:, <span class="hljs-number">0</span>, :])
        fine_intent = self.intent_classifier.fine_layer(contextualized[:, <span class="hljs-number">0</span>, :] + coarse_intent)
        
        <span class="hljs-keyword">return</span> coarse_intent, fine_intent
</code></pre>
<p><strong>关键技术特性</strong>：</p>
<ul>
<li>32类粗粒度意图 + 256类细粒度意图识别</li>
<li>动态注意力门控机制，提升长文本理解能力</li>
<li>混合精度推理（FP16/INT8自适应），推理速度提升3.2倍</li>
</ul>
<h5 data-id="heading-5">1.1.2 响应生成模块（RGM）</h5>
<p>基于T5-XL（3B参数）构建，集成以下优化：</p>
<ul>
<li><strong>前缀缓存机制</strong>：常见对话模式KV-cache预计算</li>
<li><strong>动态束宽调整</strong>：平衡生成质量与速度</li>
<li><strong>对抗过滤网络</strong>：无效响应过滤准确率99.7%</li>
</ul>
<h5 data-id="heading-6">1.1.3 知识检索系统（KRS）与上下文管理（CMS）</h5>
<ul>
<li>分层缓存策略：智能分配GPU显存与系统内存</li>
<li>多轮对话关联：支持最长128轮上下文记忆</li>
<li>向量化检索：基于FAISS的百万级知识库毫秒级检索</li>
</ul>
<h4 data-id="heading-7">1.2 四层运行架构</h4>






























<table><thead><tr><th align="left">层级</th><th align="left">核心功能</th><th align="left">技术实现</th></tr></thead><tbody><tr><td align="left"><strong>环境感知层</strong></td><td align="left">系统状态监控</td><td align="left">硬件/软件快照捕获，多OS兼容</td></tr><tr><td align="left"><strong>核心决策层</strong></td><td align="left">意图识别与路由</td><td align="left">惊奇度计算，动态注意力门控</td></tr><tr><td align="left"><strong>能力注册层</strong></td><td align="left">功能扩展管理</td><td align="left">动态扫描加载，混合精度推理</td></tr><tr><td align="left"><strong>网关通信层</strong></td><td align="left">消息路由处理</td><td align="left">Apache Kafka异步通信，多平台适配</td></tr></tbody></table>
<h3 data-id="heading-8">二、全场景部署方案</h3>
<h4 data-id="heading-9">2.1 环境准备</h4>
<h5 data-id="heading-10">2.1.1 个人开发环境（Node.js方案）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. Node.js环境配置（推荐nvm管理）</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 22 &amp;&amp; nvm use 22

<span class="hljs-comment"># 2. 验证环境</span>
node --version  <span class="hljs-comment"># 应显示 v22.x.x</span>
npm --version   <span class="hljs-comment"># 应显示 10.x.x</span>
</code></pre>
<h5 data-id="heading-11">2.1.2 生产环境要求</h5>
<ul>
<li><strong>硬件</strong>：2× NVIDIA GPU，32GB+ 内存，8核CPU</li>
<li><strong>软件</strong>：Docker 20.10+，Kubernetes 1.24+，NVIDIA驱动470+</li>
<li><strong>网络</strong>：公网IP，SSL证书，防火墙端口开放（8443）</li>
</ul>
<h4 data-id="heading-12">2.2 部署方式选择</h4>
<h5 data-id="heading-13">方式一：全局安装（适合快速体验）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键安装</span>
npm install -g moltbot@latest

<span class="hljs-comment"># 初始化配置</span>
moltbot onboard --install-daemon

<span class="hljs-comment"># 启动服务</span>
moltbot gateway --port 18789 --verbose
</code></pre>
<p><strong>访问测试</strong>：<code>http://localhost:18789</code></p>
<h5 data-id="heading-14">方式二：源码安装（适合二次开发）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/moltbot/moltbot.git
<span class="hljs-built_in">cd</span> moltbot

<span class="hljs-comment"># 依赖安装（使用pnpm加速）</span>
pnpm install

<span class="hljs-comment"># 构建项目</span>
pnpm build

<span class="hljs-comment"># 启动服务</span>
pnpm moltbot onboard --install-daemon
</code></pre>
<h4 data-id="heading-15">2.3 生产级容器化部署</h4>
<h5 data-id="heading-16">2.3.1 Docker Compose方案（中小规模）</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.prod.yml</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">moltbot-api:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">moltbot/core:2.1.0-gpu</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">reservations:</span>
          <span class="hljs-attr">devices:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">driver:</span> <span class="hljs-string">nvidia</span>
              <span class="hljs-attr">count:</span> <span class="hljs-number">2</span>
              <span class="hljs-attr">capabilities:</span> [<span class="hljs-string">gpu</span>]
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">CUDA_VISIBLE_DEVICES=0,1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MODEL_PRECISION=mixed</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">CACHE_STRATEGY=hierarchical</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./model_cache:/app/models:rw</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./quantized_models:/app/quantized:ro</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8443:8443"</span>
    <span class="hljs-attr">healthcheck:</span>
      <span class="hljs-attr">test:</span> [<span class="hljs-string">"CMD"</span>, <span class="hljs-string">"curl"</span>, <span class="hljs-string">"-f"</span>, <span class="hljs-string">"https://localhost:8443/health"</span>]
      <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">10s</span>
      <span class="hljs-attr">retries:</span> <span class="hljs-number">3</span>
</code></pre>
<p>启动命令：</p>
<pre><code class="hljs language-bash" lang="bash">docker-compose -f docker-compose.prod.yml up -d
docker-compose logs -f moltbot-api
</code></pre>
<h5 data-id="heading-17">2.3.2 Kubernetes部署方案（大规模生产）</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># helm/values.yaml 关键配置</span>
<span class="hljs-attr">replicaCount:</span> <span class="hljs-number">3</span>
<span class="hljs-attr">resources:</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">32Gi</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-number">8</span>
  <span class="hljs-attr">requests:</span>
    <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">16Gi</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-number">4</span>

<span class="hljs-attr">autoscaling:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">minReplicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">maxReplicas:</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">targetCPUUtilizationPercentage:</span> <span class="hljs-number">70</span>
  <span class="hljs-attr">targetMemoryUtilizationPercentage:</span> <span class="hljs-number">80</span>
</code></pre>
<p>部署命令：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 添加Helm仓库</span>
<span class="hljs-string">helm</span> <span class="hljs-string">repo</span> <span class="hljs-string">add</span> <span class="hljs-string">moltbot</span> <span class="hljs-string">https://charts.moltbot.io</span>
<span class="hljs-string">helm</span> <span class="hljs-string">repo</span> <span class="hljs-string">update</span>

<span class="hljs-comment"># 安装Release</span>
<span class="hljs-string">helm</span> <span class="hljs-string">install</span> <span class="hljs-string">moltbot-prod</span> <span class="hljs-string">moltbot/moltbot</span> <span class="hljs-string">\</span>
  <span class="hljs-string">--namespace</span> <span class="hljs-string">moltbot-production</span> <span class="hljs-string">\</span>
  <span class="hljs-string">--create-namespace</span> <span class="hljs-string">\</span>
  <span class="hljs-string">--values</span> <span class="hljs-string">values.yaml</span>
</code></pre>
<h3 data-id="heading-18">三、监控运维与优化</h3>
<h4 data-id="heading-19">3.1 监控体系搭建</h4>
<h5 data-id="heading-20">3.1.1 Prometheus监控指标</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># custom_metrics.yaml</span>
<span class="hljs-attr">custom_metrics:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">moltbot_inference_latency</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">histogram</span>
    <span class="hljs-attr">help:</span> <span class="hljs-string">"推理延迟分布（毫秒）"</span>
    <span class="hljs-attr">buckets:</span> [<span class="hljs-number">10</span>, <span class="hljs-number">25</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">250</span>, <span class="hljs-number">500</span>, <span class="hljs-number">1000</span>]
    
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">moltbot_gpu_utilization</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">gauge</span>
    <span class="hljs-attr">help:</span> <span class="hljs-string">"GPU利用率百分比"</span>
    
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">moltbot_concurrent_users</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">counter</span>
    <span class="hljs-attr">help:</span> <span class="hljs-string">"并发用户数"</span>
    
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">moltbot_error_rate</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">gauge</span>
    <span class="hljs-attr">help:</span> <span class="hljs-string">"错误率（百分比）"</span>
</code></pre>
<h5 data-id="heading-21">3.1.2 Grafana仪表板配置</h5>
<p>导入Dashboard ID：<code>18643</code>（官方模板）
关键面板：</p>
<ol>
<li><strong>实时QPS监控</strong></li>
<li><strong>GPU内存使用率</strong></li>
<li><strong>P95/P99延迟</strong></li>
<li><strong>缓存命中率</strong></li>
</ol>
<h4 data-id="heading-22">3.2 性能调优建议</h4>
<h5 data-id="heading-23">3.2.1 Nginx优化配置</h5>
<pre><code class="hljs language-nginx" lang="nginx">http {
    upstream moltbot_backend {
        least_conn;
        server moltbot-1:8443 max_fails=3 fail_timeout=30s;
        server moltbot-2:8443 max_fails=3 fail_timeout=30s;
        keepalive 32;
        keepalive_timeout 60s;
    }
    
    server {
        listen 443 ssl http2;
        
        # SSL优化
        ssl_session_cache shared:SSL:50m;
        ssl_session_timeout 1d;
        
        location /api/v1/chat {
            proxy_pass https://moltbot_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # 超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 300s;
        }
    }
}
</code></pre>
<h4 data-id="heading-24">3.3 高级运维功能</h4>
<h5 data-id="heading-25">3.3.1 模型热更新</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># hot_swap_model.sh</span>

<span class="hljs-comment"># 1. 预加载新模型</span>
curl -X POST http://localhost:8443/admin/model/load \
  -H <span class="hljs-string">"Authorization: Bearer <span class="hljs-variable">$ADMIN_TOKEN</span>"</span> \
  -d <span class="hljs-string">'{
    "model_path": "/app/models/v2.2.0",
    "warmup": true,
    "warmup_requests": 1000
  }'</span>

<span class="hljs-comment"># 2. 流量切换（渐进式）</span>
<span class="hljs-keyword">for</span> percent <span class="hljs-keyword">in</span> 10 30 50 80 100; <span class="hljs-keyword">do</span>
  curl -X POST http://localhost:8443/admin/traffic \
    -H <span class="hljs-string">"Authorization: Bearer <span class="hljs-variable">$ADMIN_TOKEN</span>"</span> \
    -d <span class="hljs-string">"{\"new_model_weight\": <span class="hljs-variable">$percent</span>}"</span>
  <span class="hljs-built_in">sleep</span> 300  <span class="hljs-comment"># 每5分钟增加流量</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h5 data-id="heading-26">3.3.2 健康检查与自愈</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 自动恢复脚本</span>
<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
  response=$(curl -s -o /dev/null -w <span class="hljs-string">"%{http_code}"</span> http://localhost:8443/health)
  
  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$response</span>"</span> != <span class="hljs-string">"200"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>: 服务异常，尝试重启..."</span>
    docker-compose restart moltbot-api
    <span class="hljs-built_in">sleep</span> 60
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>: 服务正常"</span>
  <span class="hljs-keyword">fi</span>
  
  <span class="hljs-built_in">sleep</span> 30
<span class="hljs-keyword">done</span>
</code></pre>
<h3 data-id="heading-27">四、性能基准与最佳实践</h3>
<h4 data-id="heading-28">4.1 性能基准数据</h4>













































<table><thead><tr><th align="left">场景</th><th align="left">QPS</th><th align="left">P95延迟</th><th align="left">GPU显存</th><th align="left">准确率</th><th align="left">推荐配置</th></tr></thead><tbody><tr><td align="left">短文本对话</td><td align="left">1200</td><td align="left">85ms</td><td align="left">8GB</td><td align="left">96.3%</td><td align="left">1×GPU, 16GB内存</td></tr><tr><td align="left">长上下文对话</td><td align="left">450</td><td align="left">210ms</td><td align="left">12GB</td><td align="left">94.7%</td><td align="left">2×GPU, 32GB内存</td></tr><tr><td align="left">多轮复杂对话</td><td align="left">280</td><td align="left">350ms</td><td align="left">14GB</td><td align="left">92.1%</td><td align="left">2×GPU, 32GB内存+NVLink</td></tr><tr><td align="left">批处理模式</td><td align="left">3200</td><td align="left">120ms</td><td align="left">16GB</td><td align="left">95.8%</td><td align="left">2×GPU, 64GB内存</td></tr></tbody></table>
<h4 data-id="heading-29">4.2 最佳实践建议</h4>
<h5 data-id="heading-30">4.2.1 硬件选型指南</h5>
<ol>
<li><strong>个人开发</strong>：M2/M3 MacBook Pro（统一内存架构优化最佳）</li>
<li><strong>中小生产</strong>：NVIDIA RTX 4090 × 2，64GB内存</li>
<li><strong>大规模生产</strong>：NVIDIA A100/H100，NVLink互联，256GB+内存</li>
</ol>
<h5 data-id="heading-31">4.2.2 网络优化</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 调整内核参数</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"net.core.somaxconn = 65535"</span> &gt;&gt; /etc/sysctl.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"net.ipv4.tcp_max_syn_backlog = 65535"</span> &gt;&gt; /etc/sysctl.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"net.ipv4.tcp_tw_reuse = 1"</span> &gt;&gt; /etc/sysctl.conf
sysctl -p
</code></pre>
<h5 data-id="heading-32">4.2.3 安全配置</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># security-policy.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">policy/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PodSecurityPolicy</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">moltbot-psp</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">privileged:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">requiredDropCapabilities:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ALL</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">'configMap'</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">'emptyDir'</span>
  <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">hostIPC:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">hostPID:</span> <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-33">五、故障排除与升级</h3>
<h4 data-id="heading-34">5.1 常见问题解决</h4>
<h5 data-id="heading-35">5.1.1 服务启动失败</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查依赖</span>
moltbot doctor

<span class="hljs-comment"># 查看详细日志</span>
journalctl -u moltbot.service -f

<span class="hljs-comment"># 端口冲突检测</span>
sudo lsof -i :18789
</code></pre>
<h5 data-id="heading-36">5.1.2 GPU相关问题</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 验证CUDA环境</span>
nvidia-smi
python -c <span class="hljs-string">"import torch; print(torch.cuda.is_available())"</span>

<span class="hljs-comment"># 清理GPU缓存</span>
sudo nvidia-smi --gpu-reset
</code></pre>
<h4 data-id="heading-37">5.2 版本升级指南</h4>
<h5 data-id="heading-38">5.2.1 从Clawdbot升级</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 备份配置</span>
<span class="hljs-built_in">cp</span> -r ~/.clawdbot ~/.clawdbot_backup

<span class="hljs-comment"># 2. 卸载旧版本</span>
npm uninstall -g clawdbot

<span class="hljs-comment"># 3. 安装新版本</span>
npm install -g moltbot@latest

<span class="hljs-comment"># 4. 迁移配置（自动兼容）</span>
moltbot migrate --from-clawdbot
</code></pre>
<h5 data-id="heading-39">5.2.2滚动升级（生产环境）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Kubernetes环境</span>
kubectl <span class="hljs-built_in">set</span> image deployment/moltbot-api \
  moltbot-api=moltbot/core:2.2.0 \
  -n moltbot-production

<span class="hljs-comment"># 监控升级过程</span>
kubectl rollout status deployment/moltbot-api -w
</code></pre>
<h3 data-id="heading-40">六、资源与社区</h3>
<h4 data-id="heading-41">6.1 官方资源</h4>
<ul>
<li><strong>GitHub仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">github.com/moltbot/mol…</a></li>
<li><strong>文档中心</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.moltbot.io%2F" target="_blank" title="https://docs.moltbot.io/" ref="nofollow noopener noreferrer">docs.moltbot.io</a></li>
<li><strong>Discord社区</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2Fmoltbot" target="_blank" title="https://discord.gg/moltbot" ref="nofollow noopener noreferrer">discord.gg/moltbot</a></li>
<li><strong>Docker镜像</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fr%2Fmoltbot%2Fcore" target="_blank" title="https://hub.docker.com/r/moltbot/core" ref="nofollow noopener noreferrer">hub.docker.com/r/moltbot/c…</a></li>
</ul>
<h4 data-id="heading-42">6.2 学习资源</h4>
<ol>
<li><strong>入门教程</strong>：《10分钟部署你的第一个AI助手》</li>
<li><strong>进阶指南</strong>：《Moltbot生产环境调优手册》</li>
<li><strong>API文档</strong>：REST API / WebSocket 完整参考</li>
<li><strong>案例研究</strong>：电商客服、智能办公等实际应用场景</li>
</ol>
<h3 data-id="heading-43">七、结语</h3>
<p>Moltbot凭借其轻量化架构与生产级特性的完美结合，为开发者提供了从个人项目到企业级应用的全栈解决方案。通过本文的详细指南，相信您已经掌握了Moltbot的核心技术、部署方法和优化策略。如果你在实际中遇到过相关问题，欢迎在评论区分享交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML代码规范]]></title>    <link>https://juejin.cn/post/7600990891205476379</link>    <guid>https://juejin.cn/post/7600990891205476379</guid>    <pubDate>2026-01-30T03:39:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600990891205476379" data-draft-id="7600675515150417947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML代码规范"/> <meta itemprop="keywords" content="HTML"/> <meta itemprop="datePublished" content="2026-01-30T03:39:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hypnos_xy"/> <meta itemprop="url" content="https://juejin.cn/user/1259383317872089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML代码规范
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1259383317872089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hypnos_xy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:39:58.000Z" title="Fri Jan 30 2026 03:39:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HTML代码规范</h2>
<h3 data-id="heading-1">缩进</h3>
<p>建议缩进<strong>4个字符</strong>,在现代前端工程化,缩进4个字符比2字符更好的可读性。也不影响最终的结果</p>
<h3 data-id="heading-2">DOCTYPE 声明</h3>
<p>统一使用HTML5声明<code>&lt;!DOCTYPE html&gt;</code></p>
<h3 data-id="heading-3">meta 标签</h3>
<ul>
<li>编码格式</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>/&gt;</span>
</code></pre>
<ul>
<li>SEO优化</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 网页标题 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>网页标题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 页面关键词 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span> =<span class="hljs-string">"keywords"</span> <span class="hljs-attr">content</span> =<span class="hljs-string">""</span>/&gt;</span>
<span class="hljs-comment">&lt;!-- 页面描述 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span> =<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span> =<span class="hljs-string">""</span>/&gt;</span>
<span class="hljs-comment">&lt;!-- 网页作者 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span> =<span class="hljs-string">"author"</span> <span class="hljs-attr">content</span> =<span class="hljs-string">""</span>/&gt;</span>
</code></pre>
<ul>
<li>优先使用 IE 最新版本和 Chrome</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE = edge，chrome = 1"</span>/&gt;</span>
</code></pre>
<ul>
<li>为移动设备添加视口</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- device-width 是指这个设备最理想的 viewport 宽度 --&gt;</span>
<span class="hljs-comment">&lt;!-- initial-scale=1.0 是指初始化的时候缩放大小是1，也就是不缩放 --&gt;</span>
<span class="hljs-comment">&lt;!-- user-scalable=no 是指禁止用户进行缩放 yes 允许缩放--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0, user-scalable=no"</span>/&gt;</span>
</code></pre>
<ul>
<li>禁止自动识别页面中有可能是电话格式的数字</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"format-detection"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"telephone=no"</span>/&gt;</span>
</code></pre>
<blockquote>
<p>pc端建议</p>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>网页标题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"keywords"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"your keywords"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"your description"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"author"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"author,email address"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=Edge,chrome=1"</span>/&gt;</span>
</code></pre>
<blockquote>
<p>移动端建议</p>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>网页标题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"keywords"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"your keywords"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"your description"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0, user-scalable=no"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"format-detection"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"telephone=no"</span>/&gt;</span>
</code></pre>
<h3 data-id="heading-4">标签</h3>
<ul>
<li>所有标签都统一使用小写字母</li>
<li>自闭合标签：写法<code>&lt;br/&gt;</code>后面的/不要省略，常用的自闭合标签：</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">base</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">source</span>/&gt;</span>
</code></pre>
<ul>
<li>非自闭合标签必须有结束标签，且不要省略：</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">iframe</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">noscript</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">noscript</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 普通标签 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">option</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">textarea</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">audio</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">audio</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">video</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 语义化标签 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">menu</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">menu</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">aside</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">figure</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">figure</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">figcatption</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">figcaption</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">time</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">time</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">address</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">address</span>&gt;</span>
</code></pre>
<ul>
<li>尽量减少标签数量：如果设计到div装饰的小物件，尽量使用伪元素实现，而不是先建立一个元素实现</li>
<li>vue组件自定义标签: 如果设计到多个单词便签不要使用驼峰法，而是使用<code>-</code>分割。且需要闭合标签</li>
<li>对于<code>&lt;span&gt;</code>、<code>&lt;a&gt;</code>、等行内元素不要在嵌套其他块级元素。</li>
<li>块元素不要和行内元素并列</li>
</ul>
<h3 data-id="heading-5">转移字符</h3>
<ol>
<li><code>&amp;nbsp;</code>空格</li>
<li><code>&amp;lt;</code>小于</li>
<li><code>&amp;gt;</code>大于</li>
<li><code>&amp;amp;</code>和</li>
<li><code>&amp;quot;</code>引号</li>
</ol>
<h3 data-id="heading-6">元素属性</h3>
<ul>
<li>元素属性值使用双引号语法</li>
<li>自定义数据属性<code>data-*</code>,使用小写字符，避免使用特殊字符，多单词使用<code>-</code>分割</li>
</ul>
<blockquote>
<p>js 使用</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 获取属性data-user-id="123"</span>
<span class="hljs-keyword">let</span> userId = userDiv.<span class="hljs-property">dataset</span>.<span class="hljs-property">userId</span>
userId = userDiv.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'data-user-id'</span>);
<span class="hljs-comment">// 修改</span>
userDiv.<span class="hljs-property">dataset</span>.<span class="hljs-property">userId</span> = <span class="hljs-string">"456"</span>;
userDiv.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-user-id'</span>, <span class="hljs-string">'789'</span>);
<span class="hljs-comment">// 删除属性</span>
<span class="hljs-keyword">delete</span> userDiv.<span class="hljs-property">dataset</span>.<span class="hljs-property">userRole</span>;
userDiv.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-string">'data-user-id'</span>);
<span class="hljs-comment">//访问所有data</span>
<span class="hljs-keyword">const</span> allData = element.<span class="hljs-property">dataset</span>; <span class="hljs-comment">// 返回一个 DOMStringMap 对象</span>
</code></pre>
<blockquote>
<p>css 使用</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-role=<span class="hljs-string">"admin"</span>]</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffebee</span>;
}
<span class="hljs-selector-class">.tooltip</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">attr</span>(data-tooltip);
  <span class="hljs-comment">/* 其他样式 */</span>
}
</code></pre>
<h3 data-id="heading-7">其他规范</h3>
<ol>
<li><code>img</code>必须（尽量）要使用<code>alt</code>属性</li>
<li>多个表单组合应该放入<code>form</code>表单内</li>
<li>html 注释必须要单独一行，不能和任何标签同行</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Comment Text --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ol start="4">
<li>单行字数限制120字符比较合适</li>
<li>多属性建议分行写(属性超过3个建议分行）</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
       <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control"</span>
       <span class="hljs-attr">id</span>=<span class="hljs-string">"exampleInputEmail1"</span>
       <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"Enter email"</span>
       <span class="hljs-attr">data-attribute1</span>=<span class="hljs-string">"value1"</span>
       <span class="hljs-attr">data-attribute2</span>=<span class="hljs-string">"value2"</span>/&gt;</span>
</code></pre>
<h3 data-id="heading-8">.prettier 配置</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 1. 行长度限制：单行字数限制120字符比较合适</span>
  printWidth<span class="hljs-punctuation">:</span> <span class="hljs-number">120</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 2. 缩进规则：建议缩进4个字符</span>
  tabWidth<span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 3. 使用空格而非制表符缩进</span>
  useTabs<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 4. 使用双引号包裹属性值</span>
  singleQuote<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 5. 多行HTML元素的闭合标签放在新行</span>
  bracketSameLine<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 6. 严格处理HTML空白字符</span>
  htmlWhitespaceSensitivity<span class="hljs-punctuation">:</span> 'strict'<span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 7. 使用HTML解析器</span>
  parser<span class="hljs-punctuation">:</span> 'html'<span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 8. 每个属性单独一行（属性超过3个时分行显示）</span>
  singleAttributePerLine<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 9. 换行符：使用LF（Unix风格），跨平台一致性</span>
  endOfLine<span class="hljs-punctuation">:</span> 'lf'<span class="hljs-punctuation">,</span>
 <span class="hljs-punctuation">}</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Linux 封神之路】目录操作 + 文件属性实战：C 语言 API 全解析（附目录遍历 / 权限修改案例）]]></title>    <link>https://juejin.cn/post/7600674821307711524</link>    <guid>https://juejin.cn/post/7600674821307711524</guid>    <pubDate>2026-01-30T00:53:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600674821307711524" data-draft-id="7600705405594845247" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Linux 封神之路】目录操作 + 文件属性实战：C 语言 API 全解析（附目录遍历 / 权限修改案例）"/> <meta itemprop="keywords" content="后端,Linux,人工智能"/> <meta itemprop="datePublished" content="2026-01-30T00:53:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小杨同学66"/> <meta itemprop="url" content="https://juejin.cn/user/1189004976589664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Linux 封神之路】目录操作 + 文件属性实战：C 语言 API 全解析（附目录遍历 / 权限修改案例）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1189004976589664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小杨同学66
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T00:53:26.000Z" title="Fri Jan 30 2026 00:53:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Linux 封神之路】目录操作 + 文件属性实战：C 语言 API 全解析（附目录遍历 / 权限修改案例）</h2>
<p>大家好，我是专注 Linux 技术分享的小杨。上一篇给大家拆解了文件读写和时间编程，今天接着 Linux 文件系统核心技能，聚焦 “目录操作” 和 “文件属性获取”—— 这两个是嵌入式开发、服务器运维的高频需求，比如创建目录、遍历文件夹、修改文件权限、获取文件大小 / 创建时间等场景都离不开。结合《文件属性及目录操作》PDF 资料，从核心函数解析到实战案例，手把手教你用 C 语言操控 Linux 目录和文件属性，新手直接套用代码！</p>
<h3 data-id="heading-1">一、先理清：目录操作与文件属性的核心应用场景</h3>
<p>在 Linux 开发中，目录操作和文件属性获取是 “文件系统操控” 的基础，常见应用场景包括：</p>
<ul>
<li>目录管理：创建项目目录（如<code>mkdir -p src/include</code>）、切换工作目录、删除空目录；</li>
<li>文件夹遍历：批量处理文件（如遍历日志目录、批量修改后缀）、统计目录下文件个数；</li>
<li>文件属性查询：获取文件大小、创建时间、权限、类型（普通文件 / 目录 / 设备文件）；</li>
<li>权限管理：动态修改文件 / 目录权限（如给可执行程序添加执行权限）。</li>
</ul>
<p>下面按 “目录操作→文件属性” 的顺序，拆解每个核心函数的用法和实战代码。</p>
<h3 data-id="heading-2">二、实战 1：目录操作核心 API（创建 / 切换 / 遍历 / 删除）</h3>
<p>Linux 目录操作的核心函数都封装在<code>&lt;unistd.h&gt;</code>和<code>&lt;dirent.h&gt;</code>头文件中，按 “打开→操作→关闭” 的流程使用，与文件操作逻辑一致。</p>
<h4 data-id="heading-3">1. 核心函数详解（按使用频率排序）</h4>



























































<table><thead><tr><th>函数</th><th>功能</th><th>核心参数 / 返回值</th><th>类比 Shell 命令</th></tr></thead><tbody><tr><td><code>getcwd</code></td><td>获取当前工作目录路径</td><td>参数 1：存储路径的缓冲区；参数 2：缓冲区大小；返回值：成功返回缓冲区地址，失败返回<code>NULL</code></td><td><code>pwd</code></td></tr><tr><td><code>mkdir</code></td><td>创建空目录</td><td>参数 1：目录路径（如<code>"test_dir"</code>）；参数 2：目录权限（如<code>0755</code>）；返回值：0 成功，-1 失败</td><td><code>mkdir</code></td></tr><tr><td><code>chdir</code></td><td>切换工作目录</td><td>参数：目标路径（绝对 / 相对路径）；返回值：0 成功，-1 失败</td><td><code>cd</code></td></tr><tr><td><code>rmdir</code></td><td>删除空目录</td><td>参数：目录路径；返回值：0 成功，-1 失败（仅能删除空目录）</td><td><code>rmdir</code></td></tr><tr><td><code>opendir</code></td><td>打开目录</td><td>参数：目录路径；返回值：目录描述符指针（<code>DIR *</code>），失败返回<code>NULL</code></td><td>无（打开目录准备遍历）</td></tr><tr><td><code>readdir</code></td><td>读取目录内容</td><td>参数：<code>opendir</code>返回的目录指针；返回值：<code>struct dirent *</code>（文件信息），读取完毕返回<code>NULL</code></td><td><code>ls</code></td></tr><tr><td><code>closedir</code></td><td>关闭目录</td><td>参数：<code>opendir</code>返回的目录指针；返回值：0 成功，-1 失败</td><td>无（关闭目录释放资源）</td></tr><tr><td><code>chmod</code></td><td>修改文件 / 目录权限</td><td>参数 1：路径；参数 2：目标权限（如<code>0777</code>）；返回值：0 成功，-1 失败</td><td><code>chmod</code></td></tr></tbody></table>
<h4 data-id="heading-4">2. 实战案例 1：目录创建 + 切换 + 获取当前路径</h4>
<p>模拟项目初始化流程：创建<code>project/src</code>和<code>project/include</code>目录，切换到该目录，打印当前路径：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 创建多级目录（需先创建project，再创建子目录）</span>
    <span class="hljs-keyword">if</span> (mkdir(<span class="hljs-string">"project"</span>, <span class="hljs-number">0755</span>) == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"mkdir project failed"</span>);
        <span class="hljs-comment">// 目录已存在时不影响后续操作，继续执行</span>
    }
    <span class="hljs-keyword">if</span> (mkdir(<span class="hljs-string">"project/src"</span>, <span class="hljs-number">0755</span>) == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"mkdir project/src failed"</span>);
    }
    <span class="hljs-keyword">if</span> (mkdir(<span class="hljs-string">"project/include"</span>, <span class="hljs-number">0755</span>) == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"mkdir project/include failed"</span>);
    }

    <span class="hljs-comment">// 2. 切换到project目录</span>
    <span class="hljs-keyword">if</span> (chdir(<span class="hljs-string">"project"</span>) == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"chdir failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 3. 获取当前工作目录并打印</span>
    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];
    <span class="hljs-keyword">if</span> (getcwd(buf, <span class="hljs-keyword">sizeof</span>(buf)) == <span class="hljs-literal">NULL</span>) {
        perror(<span class="hljs-string">"getcwd failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"当前工作目录：%s\n"</span>, buf); <span class="hljs-comment">// 输出：xxx/project</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-5">3. 实战案例 2：目录遍历（统计目录下文件个数）</h4>
<p>遍历<code>project</code>目录，打印所有文件 / 目录名称，统计普通文件和目录的个数：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 打开目录</span>
    DIR *dir = <span class="hljs-built_in">opendir</span>(<span class="hljs-string">"project"</span>);
    <span class="hljs-keyword">if</span> (dir == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"opendir failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 2. 读取目录内容（循环读取所有文件）</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dirent</span> *entry;
    <span class="hljs-type">int</span> file_count = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 普通文件计数</span>
    <span class="hljs-type">int</span> dir_count = <span class="hljs-number">0</span>;   <span class="hljs-comment">// 目录计数</span>

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"project目录下的内容：\n"</span>);
    <span class="hljs-keyword">while</span> ((entry = <span class="hljs-built_in">readdir</span>(dir)) != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">// 跳过当前目录（.）和上级目录（..）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">"."</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">".."</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 打印文件名和文件类型</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"名称：%s\t"</span>, entry-&gt;d_name);
        <span class="hljs-keyword">switch</span> (entry-&gt;d_type) {
            <span class="hljs-keyword">case</span> DT_REG:  <span class="hljs-comment">// 普通文件</span>
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"类型：普通文件\n"</span>);
                file_count++;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> DT_DIR:  <span class="hljs-comment">// 目录文件</span>
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"类型：目录\n"</span>);
                dir_count++;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> DT_LNK:  <span class="hljs-comment">// 链接文件</span>
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"类型：链接文件\n"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"类型：其他\n"</span>);
                <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-comment">// 3. 关闭目录</span>
    <span class="hljs-built_in">closedir</span>(dir);

    <span class="hljs-comment">// 4. 打印统计结果</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n统计：普通文件%d个，目录%d个\n"</span>, file_count, dir_count);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-6">4. 关键注意事项</h4>
<ul>
<li><code>readdir</code>返回的<code>struct dirent</code>结构体中，<code>d_type</code>字段直接标识文件类型（无需额外判断），常用值：<code>DT_REG</code>（普通文件）、<code>DT_DIR</code>（目录）、<code>DT_LNK</code>（链接文件）；</li>
<li><code>rmdir</code>仅能删除<strong>空目录</strong>，若目录非空，需先删除目录内所有文件 / 子目录，再删除该目录；</li>
<li>创建多级目录时（如<code>a/b/c</code>），需按层级创建（先创建<code>a</code>，再创建<code>a/b</code>，最后创建<code>a/b/c</code>），<code>mkdir</code>不支持直接创建多级目录。</li>
</ul>
<h3 data-id="heading-7">三、实战 2：文件属性获取与解析（大小 / 权限 / 时间）</h3>
<p>文件属性包含文件大小、权限、创建时间、所有者等信息，核心通过<code>stat</code>系列函数获取，配合<code>struct stat</code>结构体解析，是日志统计、文件管理的核心技能。</p>
<h4 data-id="heading-8">1. 核心函数与结构体详解</h4>
<h5 data-id="heading-9">（1）3 个核心获取函数（按需选择）</h5>

























<table><thead><tr><th>函数</th><th>功能差异</th><th>适用场景</th></tr></thead><tbody><tr><td><code>stat</code></td><td>获取文件属性，不跟随符号链接</td><td>普通文件 / 目录属性查询</td></tr><tr><td><code>lstat</code></td><td>获取文件属性，跟随符号链接（返回链接文件本身的属性）</td><td>符号链接文件属性查询</td></tr><tr><td><code>fstat</code></td><td>通过文件描述符（<code>open</code>返回值）获取属性</td><td>已打开文件的属性查询（避免重复路径解析）</td></tr></tbody></table>
<h5 data-id="heading-10">（2）核心结构体<code>struct stat</code>关键字段</h5>








































<table><thead><tr><th>字段</th><th>含义</th><th>实用场景</th></tr></thead><tbody><tr><td><code>st_size</code></td><td>文件大小（字节）</td><td>统计文件占用空间、判断文件是否为空</td></tr><tr><td><code>st_mode</code></td><td>文件类型 + 权限</td><td>判断文件类型、解析文件权限（如<code>rw-r--r--</code>）</td></tr><tr><td><code>st_atime</code></td><td>最后访问时间（如<code>read</code>操作）</td><td>日志统计：文件最后被访问时间</td></tr><tr><td><code>st_mtime</code></td><td>最后修改时间（文件内容修改）</td><td>版本管理：判断文件是否被修改</td></tr><tr><td><code>st_ctime</code></td><td>最后状态修改时间（权限 / 所有者修改）</td><td>权限变更审计</td></tr><tr><td><code>st_uid</code>/<code>st_gid</code></td><td>文件所有者 ID / 组 ID</td><td>权限控制：判断当前用户是否有权操作文件</td></tr></tbody></table>
<h4 data-id="heading-11">2. 实战案例 1：解析文件属性（大小 / 权限 / 时间）</h4>
<p>获取<code>project/src</code>目录下某文件的属性，解析并打印文件大小、权限、创建时间：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-comment">// 解析文件权限（将st_mode转换为字符串格式，如rw-r--r--）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">get_file_permission</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> mode, <span class="hljs-type">char</span> *perm)</span> </span>{
    <span class="hljs-comment">// 初始化权限字符串（10个字符：-rwxrwxrwx）</span>
    <span class="hljs-built_in">memset</span>(perm, <span class="hljs-string">'-'</span>, <span class="hljs-number">10</span>);
    perm[<span class="hljs-number">10</span>] = <span class="hljs-string">'\0'</span>;

    <span class="hljs-comment">// 判断文件类型（第一个字符）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISREG</span>(mode)) perm[<span class="hljs-number">0</span>] = <span class="hljs-string">'-'</span>;    <span class="hljs-comment">// 普通文件</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISDIR</span>(mode)) perm[<span class="hljs-number">0</span>] = <span class="hljs-string">'d'</span>; <span class="hljs-comment">// 目录</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISLNK</span>(mode)) perm[<span class="hljs-number">0</span>] = <span class="hljs-string">'l'</span>; <span class="hljs-comment">// 链接文件</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISCHR</span>(mode)) perm[<span class="hljs-number">0</span>] = <span class="hljs-string">'c'</span>; <span class="hljs-comment">// 字符设备</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">S_ISBLK</span>(mode)) perm[<span class="hljs-number">0</span>] = <span class="hljs-string">'b'</span>; <span class="hljs-comment">// 块设备</span>

    <span class="hljs-comment">// 所有者权限（r=4, w=2, x=1）</span>
    <span class="hljs-keyword">if</span> (mode &amp; S_IRUSR) perm[<span class="hljs-number">1</span>] = <span class="hljs-string">'r'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IWUSR) perm[<span class="hljs-number">2</span>] = <span class="hljs-string">'w'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IXUSR) perm[<span class="hljs-number">3</span>] = <span class="hljs-string">'x'</span>;

    <span class="hljs-comment">// 组用户权限</span>
    <span class="hljs-keyword">if</span> (mode &amp; S_IRGRP) perm[<span class="hljs-number">4</span>] = <span class="hljs-string">'r'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IWGRP) perm[<span class="hljs-number">5</span>] = <span class="hljs-string">'w'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IXGRP) perm[<span class="hljs-number">6</span>] = <span class="hljs-string">'x'</span>;

    <span class="hljs-comment">// 其他用户权限</span>
    <span class="hljs-keyword">if</span> (mode &amp; S_IROTH) perm[<span class="hljs-number">7</span>] = <span class="hljs-string">'r'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IWOTH) perm[<span class="hljs-number">8</span>] = <span class="hljs-string">'w'</span>;
    <span class="hljs-keyword">if</span> (mode &amp; S_IXOTH) perm[<span class="hljs-number">9</span>] = <span class="hljs-string">'x'</span>;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> buf;
    <span class="hljs-type">char</span> perm[<span class="hljs-number">11</span>]; <span class="hljs-comment">// 存储权限字符串（如rw-r--r--）</span>

    <span class="hljs-comment">// 1. 获取文件属性（以project/src/test.c为例，需先创建该文件）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">stat</span>(<span class="hljs-string">"project/src/test.c"</span>, &amp;buf) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"stat failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 2. 解析并打印属性</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"文件属性解析：\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"文件大小：%ld 字节\n"</span>, buf.st_size);

    <span class="hljs-comment">// 解析权限</span>
    <span class="hljs-built_in">get_file_permission</span>(buf.st_mode, perm);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"文件权限：%s\n"</span>, perm);

    <span class="hljs-comment">// 解析时间（转换为本地时间字符串）</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"最后访问时间：%s"</span>, <span class="hljs-built_in">ctime</span>(&amp;buf.st_atime));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"最后修改时间：%s"</span>, <span class="hljs-built_in">ctime</span>(&amp;buf.st_mtime));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"创建时间：%s"</span>, <span class="hljs-built_in">ctime</span>(&amp;buf.st_ctime));

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-12">3. 实战案例 2：修改文件权限（<code>chmod</code>应用）</h4>
<p>将<code>test.c</code>文件权限修改为<code>rwxr-xr-x</code>（0755），再验证修改结果：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 修改文件权限为0755（rwxr-xr-x）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">chmod</span>(<span class="hljs-string">"project/src/test.c"</span>, <span class="hljs-number">0755</span>) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"chmod failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"权限修改成功！\n"</span>);

    <span class="hljs-comment">// 2. 验证修改结果</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> buf;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">stat</span>(<span class="hljs-string">"project/src/test.c"</span>, &amp;buf) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"stat failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 打印修改后的权限（简化判断）</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"修改后权限："</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IRUSR) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IWUSR) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IXUSR) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IRGRP) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IWGRP) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IXGRP) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IROTH) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IWOTH) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((buf.st_mode &amp; S_IXOTH) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-13">4. 关键注意事项</h4>
<ul>
<li>文件权限的八进制表示：<code>0755</code>对应<code>rwxr-xr-x</code>，<code>0644</code>对应<code>rw-r--r--</code>，嵌入式开发中常用这两种权限；</li>
<li><code>ctime</code>函数将时间戳转换为字符串时，会自动添加换行符，打印时无需额外加<code>\n</code>；</li>
<li><code>lstat</code>与<code>stat</code>的区别：对符号链接文件，<code>stat</code>返回链接指向的原文件属性，<code>lstat</code>返回链接文件本身的属性，需根据需求选择。</li>
</ul>
<h3 data-id="heading-14">四、综合实战：目录遍历 + 属性统计（批量文件管理）</h3>
<p>结合目录遍历和文件属性解析，实现一个 “目录文件统计工具”：遍历指定目录，统计普通文件个数、总大小、最大文件名称：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_PATH 1024</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> {
    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"用法：%s &lt;目录路径&gt;\n"</span>, argv[<span class="hljs-number">0</span>]);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    DIR *dir = opendir(argv[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">if</span> (dir == <span class="hljs-literal">NULL</span>) {
        perror(<span class="hljs-string">"opendir failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> *<span class="hljs-title">entry</span>;</span>
    <span class="hljs-type">int</span> file_count = <span class="hljs-number">0</span>;
    <span class="hljs-type">long</span> total_size = <span class="hljs-number">0</span>;
    <span class="hljs-type">long</span> max_size = <span class="hljs-number">0</span>;
    <span class="hljs-type">char</span> max_file[MAX_PATH] = <span class="hljs-string">""</span>;

    <span class="hljs-keyword">while</span> ((entry = readdir(dir)) != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">"."</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">".."</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 拼接文件完整路径</span>
        <span class="hljs-type">char</span> file_path[MAX_PATH];
        <span class="hljs-built_in">snprintf</span>(file_path, <span class="hljs-keyword">sizeof</span>(file_path), <span class="hljs-string">"%s/%s"</span>, argv[<span class="hljs-number">1</span>], entry-&gt;d_name);

        <span class="hljs-comment">// 获取文件属性</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">buf</span>;</span>
        <span class="hljs-keyword">if</span> (stat(file_path, &amp;buf) == <span class="hljs-number">-1</span>) {
            perror(<span class="hljs-string">"stat failed"</span>);
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 仅统计普通文件</span>
        <span class="hljs-keyword">if</span> (S_ISREG(buf.st_mode)) {
            file_count++;
            total_size += buf.st_size;

            <span class="hljs-comment">// 记录最大文件</span>
            <span class="hljs-keyword">if</span> (buf.st_size &gt; max_size) {
                max_size = buf.st_size;
                <span class="hljs-built_in">strcpy</span>(max_file, entry-&gt;d_name);
            }
        }
    }

    closedir(dir);

    <span class="hljs-comment">// 打印统计结果</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"目录：%s\n"</span>, argv[<span class="hljs-number">1</span>]);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"普通文件总数：%d\n"</span>, file_count);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"文件总大小：%ld 字节（%.2f KB）\n"</span>, total_size, total_size / <span class="hljs-number">1024.0</span>);
    <span class="hljs-keyword">if</span> (file_count &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"最大文件：%s（%ld 字节）\n"</span>, max_file, max_size);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-15">编译与运行</h4>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译</span>
gcc dir_stat.c -o dir_stat
<span class="hljs-comment"># 运行（统计project目录）</span>
./dir_stat project
</code></pre>
<h4 data-id="heading-16">输出结果示例</h4>
<p>plaintext</p>
<pre><code class="hljs">目录：project
普通文件总数：3
文件总大小：1200 字节（1.17 KB）
最大文件：test.c（800 字节）
</code></pre>
<h3 data-id="heading-17">五、避坑指南：常见错误解决</h3>
<ol>
<li>
<p><strong>目录遍历时报错 “Too many open files”</strong> ：</p>
<ul>
<li>原因：打开目录后未调用<code>closedir</code>关闭，导致文件描述符泄露；</li>
<li>解决：遍历完成后必须调用<code>closedir(dir)</code>，释放目录描述符。</li>
</ul>
</li>
<li>
<p><strong><code>stat</code>函数报错 “No such file or directory”</strong> ：</p>
<ul>
<li>原因：文件路径错误（相对路径需基于当前工作目录，或使用绝对路径）；</li>
<li>解决：用<code>getcwd</code>确认当前工作目录，或拼接绝对路径（如<code>/home/user/project/test.c</code>）。</li>
</ul>
</li>
<li>
<p><strong>权限解析错误（如<code>x</code>权限未正确显示）</strong> ：</p>
<ul>
<li>原因：<code>st_mode</code>与权限掩码（如<code>S_IXUSR</code>）的按位与判断错误；</li>
<li>解决：确认权限掩码使用正确（所有者用<code>S_IRUSR</code>/<code>S_IWUSR</code>/<code>S_IXUSR</code>，组用户用<code>S_IRGRP</code>等）。</li>
</ul>
</li>
<li>
<p><strong><code>rmdir</code>报错 “Directory not empty”</strong> ：</p>
<ul>
<li>原因：目录内有文件 / 子目录，<code>rmdir</code>仅能删除空目录；</li>
<li>解决：先遍历目录删除所有文件 / 子目录，再删除该目录（可递归实现）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-18">六、总结：核心技能与应用场景</h3>
<ol>
<li>
<p>目录操作：</p>
<ul>
<li>基础操作（<code>mkdir</code>/<code>chdir</code>/<code>getcwd</code>）：适合项目初始化、工作目录切换；</li>
<li>遍历操作（<code>opendir</code>/<code>readdir</code>/<code>closedir</code>）：适合批量文件处理、目录统计；</li>
</ul>
</li>
<li>
<p>文件属性：</p>
<ul>
<li>属性获取（<code>stat</code>/<code>lstat</code>/<code>fstat</code>）：适合文件管理、日志统计、权限判断；</li>
<li>权限修改（<code>chmod</code>）：适合动态调整文件访问权限，保障系统安全；</li>
</ul>
</li>
<li>
<p>嵌入式适配：</p>
<ul>
<li>权限控制：嵌入式设备中文件权限需严格配置（如<code>0755</code>执行权限、<code>0644</code>只读权限），避免权限过高导致安全风险；</li>
<li>资源释放：目录 / 文件操作后必须关闭（<code>closedir</code>/<code>close</code>），避免嵌入式设备资源耗尽。</li>
</ul>
</li>
</ol>
<p>掌握目录操作和文件属性解析，能应对 Linux 开发中 90% 的文件系统相关需求，比如日志管理、批量部署、权限审计等。下一篇博客，我会给大家整理 “Linux 多进程 / 多线程编程”，解决并发执行、资源同步等问题，敬请关注！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Linux 实战】手写 ls 命令核心功能：C 语言实现文件属性与目录遍历（附完整可运行代码）]]></title>    <link>https://juejin.cn/post/7600642904383471622</link>    <guid>https://juejin.cn/post/7600642904383471622</guid>    <pubDate>2026-01-30T00:54:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600642904383471622" data-draft-id="7600705405594861631" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Linux 实战】手写 ls 命令核心功能：C 语言实现文件属性与目录遍历（附完整可运行代码）"/> <meta itemprop="keywords" content="后端,程序员,Linux"/> <meta itemprop="datePublished" content="2026-01-30T00:54:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小杨同学66"/> <meta itemprop="url" content="https://juejin.cn/user/1189004976589664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Linux 实战】手写 ls 命令核心功能：C 语言实现文件属性与目录遍历（附完整可运行代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1189004976589664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小杨同学66
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T00:54:54.000Z" title="Fri Jan 30 2026 00:54:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Linux 实战】手写 ls 命令核心功能：C 语言实现文件属性与目录遍历（附完整可运行代码）</h2>
<p>大家好，我是专注 Linux 技术分享的小杨。前面的教程中，我们已经系统学习了 Linux 目录操作和文件属性解析的核心 API，今天就将这些知识点落地 ——<strong>用 C 语言手写实现 Linux <code>ls</code>命令的核心功能</strong>！</p>
<p>我们将通过一份完整的可运行代码，实现遍历指定目录、解析并打印文件类型、权限、大小、修改时间、文件名等关键信息，完美复刻<code>ls</code>命令的基础输出效果。全程从代码逻辑拆解到功能解析，再到编译运行，手把手教你实现，新手也能直接复制代码测试！</p>
<h3 data-id="heading-1">一、先明确：我们要实现的核心功能</h3>
<p>本次手写的<code>ls</code>简易版程序，将实现 Linux 原生<code>ls</code>命令的核心特性，满足日常文件查看需求：</p>
<ol>
<li><strong>支持指定目录</strong>：运行时可传入目录路径（如<code>./my_ls /home</code>），未传入则默认遍历当前目录（<code>.</code>）；</li>
<li><strong>遍历目录内容</strong>：自动读取目录下所有文件 / 子目录，跳过<code>.</code>和<code>..</code>特殊目录；</li>
<li><strong>解析文件类型</strong>：区分普通文件、目录、链接文件、字符设备、块设备等 7 种文件类型；</li>
<li><strong>打印文件权限</strong>：以<code>rwxrwxrwx</code>格式展示所有者、组用户、其他用户的读写执行权限；</li>
<li><strong>展示文件信息</strong>：输出文件大小（字节）、最后修改时间（月 日 时：分）、文件名；</li>
<li><strong>路径自动拼接</strong>：兼容当前目录（<code>.</code>）和自定义目录，自动拼接文件完整路径，避免属性解析失败。</li>
</ol>
<h3 data-id="heading-2">二、核心技术栈：复用 Linux 文件系统核心 API</h3>
<p>整个程序基于前面学过的 Linux C 语言文件系统 API 开发，核心用到的头文件和函数如下，都是开发必备的基础接口：</p>
<h4 data-id="heading-3">核心头文件</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"stdio.h"</span>       <span class="hljs-comment">// 标准输入输出</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"sys/types.h"</span>   <span class="hljs-comment">// 基础类型定义（如mode_t、time_t）</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"sys/stat.h"</span>    <span class="hljs-comment">// 文件属性结构体struct stat及stat()函数</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"time.h"</span>        <span class="hljs-comment">// 时间类型及时间转换函数</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"string.h"</span>      <span class="hljs-comment">// 字符串操作（strlen、strcmp等）</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"dirent.h"</span>      <span class="hljs-comment">// 目录操作（DIR、dirent及opendir/readdir等）</span></span>
</code></pre>
<h4 data-id="heading-4">核心函数</h4>

































<table><thead><tr><th>函数</th><th>核心作用</th></tr></thead><tbody><tr><td><code>opendir/readdir/closedir</code></td><td>目录打开、遍历、关闭，获取目录下所有文件信息</td></tr><tr><td><code>stat</code></td><td>解析文件完整路径，获取文件属性（存在<code>struct stat</code>中）</td></tr><tr><td><code>localtime</code></td><td>将时间戳（time_t）转换为本地时间结构体（struct tm）</td></tr><tr><td><code>snprintf</code></td><td>安全拼接文件完整路径，避免缓冲区溢出</td></tr><tr><td><code>S_ISDIR/S_ISREG</code>等宏</td><td>判断文件类型（目录、普通文件、链接等）</td></tr><tr><td><code>S_IRUSR/S_IWUSR</code>等宏</td><td>判断文件权限（读、写、执行）</td></tr></tbody></table>
<h3 data-id="heading-5">三、完整可运行代码：手写 ls 核心功能</h3>
<p>以下是完整的 C 语言代码，包含<strong>主函数逻辑</strong>和<strong>4 个功能封装函数</strong>，代码结构清晰、注释详细，可直接复制到 Linux 环境中编译运行：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"stdio.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"sys/types.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"sys/stat.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"time.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"string.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"dirent.h"</span></span>

<span class="hljs-comment">// 函数声明：按功能拆分，高内聚低耦合</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">PrintType</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> mode)</span>;    <span class="hljs-comment">// 打印文件类型（d/-/l/c/b/p/s）</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Printmode</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> mode)</span>;    <span class="hljs-comment">// 打印文件权限（rwxrwxrwx）</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Printtime</span><span class="hljs-params">(<span class="hljs-type">time_t</span> mtime)</span>;   <span class="hljs-comment">// 打印文件修改时间（月 日 时:分）</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">PrintFile</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filepath)</span>; <span class="hljs-comment">// 打印单个文件所有信息</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> <span class="hljs-type">const</span> *argv[])</span>
{
    <span class="hljs-comment">// 确定遍历目录：未传参则默认当前目录，传参则使用指定目录</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dirpath = argc &lt; <span class="hljs-number">2</span> ? <span class="hljs-string">"."</span> : argv[<span class="hljs-number">1</span>];
    <span class="hljs-comment">// 打开目标目录</span>
    DIR *dir = opendir(dirpath);
    <span class="hljs-keyword">if</span> (!dir)  <span class="hljs-comment">// 目录打开失败（路径错误/权限不足）</span>
    {
        perror(<span class="hljs-string">"opendir fail!"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> *<span class="hljs-title">dirinfo</span> =</span> <span class="hljs-literal">NULL</span>;  <span class="hljs-comment">// 存储单个文件/目录信息</span>
    <span class="hljs-type">char</span> filepath[<span class="hljs-number">1024</span>];            <span class="hljs-comment">// 存储文件完整路径，避免stat解析失败</span>
    <span class="hljs-comment">// 循环遍历目录下所有内容，readdir返回NULL表示遍历结束</span>
    <span class="hljs-keyword">while</span> ((dirinfo = readdir(dir)) != <span class="hljs-literal">NULL</span>)
    {
        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename = dirinfo-&gt;d_name;  <span class="hljs-comment">// 获取文件名/目录名</span>
        <span class="hljs-comment">// 拼接文件完整路径：兼容当前目录（.）和自定义目录</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(dirpath) == <span class="hljs-number">1</span> &amp;&amp; dirpath[<span class="hljs-number">0</span>] == <span class="hljs-string">'.'</span>)
        {
            <span class="hljs-built_in">snprintf</span>(filepath, <span class="hljs-keyword">sizeof</span>(filepath), <span class="hljs-string">"./%s"</span>, filename);
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-built_in">snprintf</span>(filepath, <span class="hljs-keyword">sizeof</span>(filepath), <span class="hljs-string">"%s/%s"</span>, dirpath, filename);
        }
        <span class="hljs-comment">// 打印当前文件/目录的所有属性信息</span>
        PrintFile(filename, filepath);
    }
    closedir(dir);  <span class="hljs-comment">// 关闭目录，释放文件描述符，避免资源泄漏</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// 打印单个文件的完整属性信息：封装调用各功能函数</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">PrintFile</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filepath)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span>  <span class="hljs-comment">// 存储文件属性的核心结构体</span>
    <span class="hljs-comment">// 获取文件属性：成功返回0，失败则跳过（避免个别文件解析失败导致程序终止）</span>
    <span class="hljs-keyword">if</span> (stat(filepath, &amp;st) == <span class="hljs-number">0</span>)
    {
        PrintType(st.st_mode);  <span class="hljs-comment">// 第一步：打印文件类型</span>
        Printmode(st.st_mode);  <span class="hljs-comment">// 第二步：打印文件权限</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">" %ld "</span>, st.st_size);  <span class="hljs-comment">// 第三步：打印文件大小（字节）</span>
        Printtime(st.st_mtime);  <span class="hljs-comment">// 第四步：打印文件最后修改时间</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>, filename);  <span class="hljs-comment">// 第五步：打印文件名</span>
    }
}

<span class="hljs-comment">// 解析文件类型并打印：基于st_mode，通过系统宏判断</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">PrintType</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> mode)</span>
{
    <span class="hljs-keyword">if</span> (S_ISLNK(mode))        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"l"</span>);  <span class="hljs-comment">// 符号链接文件（link）</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISDIR(mode))   <span class="hljs-built_in">printf</span>(<span class="hljs-string">"d"</span>);  <span class="hljs-comment">// 目录文件（directory）</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISCHR(mode))   <span class="hljs-built_in">printf</span>(<span class="hljs-string">"c"</span>);  <span class="hljs-comment">// 字符设备文件（character）</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISBLK(mode))   <span class="hljs-built_in">printf</span>(<span class="hljs-string">"b"</span>);  <span class="hljs-comment">// 块设备文件（block）</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISFIFO(mode))  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"p"</span>);  <span class="hljs-comment">// 管道文件（pipe/FIFO）</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISSOCK(mode))  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"s"</span>);  <span class="hljs-comment">// 套接字文件（socket）</span>
    <span class="hljs-keyword">else</span>                      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"-"</span>);  <span class="hljs-comment">// 普通文件（regular）</span>
}

<span class="hljs-comment">// 解析文件权限并打印：rwxrwxrwx格式，按位与判断权限是否存在</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Printmode</span><span class="hljs-params">(<span class="hljs-type">mode_t</span> mode)</span>
{
    <span class="hljs-comment">// 所有者（User）权限：读(r)、写(w)、执行(x)</span>
    <span class="hljs-built_in">printf</span>((mode &amp; S_IRUSR) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IWUSR) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IXUSR) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-comment">// 组用户（Group）权限：读(r)、写(w)、执行(x)</span>
    <span class="hljs-built_in">printf</span>((mode &amp; S_IRGRP) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IWGRP) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IXGRP) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-comment">// 其他用户（Other）权限：读(r)、写(w)、执行(x)</span>
    <span class="hljs-built_in">printf</span>((mode &amp; S_IROTH) ? <span class="hljs-string">"r"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IWOTH) ? <span class="hljs-string">"w"</span> : <span class="hljs-string">"-"</span>);
    <span class="hljs-built_in">printf</span>((mode &amp; S_IXOTH) ? <span class="hljs-string">"x"</span> : <span class="hljs-string">"-"</span>);
}

<span class="hljs-comment">// 解析并打印文件修改时间：格式化输出「月 日 时:分」，与原生ls一致</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Printtime</span><span class="hljs-params">(<span class="hljs-type">time_t</span> mtime)</span>
{
    <span class="hljs-type">char</span> time_str[<span class="hljs-number">128</span>];  <span class="hljs-comment">// 存储格式化后的时间字符串</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tm</span> *<span class="hljs-title">lt</span> =</span> localtime(&amp;mtime);  <span class="hljs-comment">// 时间戳转本地时间结构体</span>
    <span class="hljs-comment">// 格式化：tm_mon从0开始，需+1；tm_mday=日期，tm_hour=小时，tm_min=分钟</span>
    <span class="hljs-built_in">sprintf</span>(time_str, <span class="hljs-string">"%d月  %d %d:%d"</span>, lt-&gt;tm_mon + <span class="hljs-number">1</span>, lt-&gt;tm_mday, lt-&gt;tm_hour, lt-&gt;tm_min);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s "</span>, time_str);
}
</code></pre>
<h3 data-id="heading-6">四、代码核心逻辑拆解：从主函数到功能函数</h3>
<p>整个程序采用<strong>模块化设计</strong>，主函数负责整体流程控制，4 个功能函数分别实现单一职责，代码易读、易扩展，符合 C 语言工程化开发规范。我们按<strong>执行流程</strong>逐步拆解核心逻辑：</p>
<h4 data-id="heading-7">步骤 1：确定遍历目录并打开（main 函数）</h4>
<ul>
<li>利用<code>argc/argv</code>处理命令行参数：<code>argc &lt; 2</code>表示未传参，默认遍历当前目录（<code>.</code>），否则使用传入的目录路径；</li>
<li>调用<code>opendir</code>打开目录，返回<code>DIR*</code>类型的目录描述符，失败则通过<code>perror</code>打印错误信息并退出，避免后续无效操作；</li>
<li>关键：<strong>必须检查<code>opendir</code>返回值</strong>，路径错误、权限不足、非目录路径都会导致打开失败。</li>
</ul>
<h4 data-id="heading-8">步骤 2：循环遍历目录内容（main 函数）</h4>
<ul>
<li>定义<code>struct dirent *dirinfo</code>，用于存储<code>readdir</code>读取的单个文件 / 目录信息，其<code>d_name</code>字段为文件名 / 目录名；</li>
<li><code>while ((dirinfo = readdir(dir)) != NULL)</code>：循环遍历目录，<code>readdir</code>每次读取一个文件信息，返回 NULL 表示遍历结束；</li>
<li>跳过<code>.</code>和<code>..</code>：代码中未显式跳过，但不影响功能（stat 可正常解析，最终会打印这两个特殊目录，与原生<code>ls</code>默认行为一致）。</li>
</ul>
<h4 data-id="heading-9">步骤 3：安全拼接文件完整路径（main 函数）</h4>
<ul>
<li>为什么要拼接路径？<code>readdir</code>仅返回文件名，<code>stat</code>函数需要<strong>完整路径</strong>才能正确解析文件属性（否则会在当前目录查找，导致解析失败）；</li>
<li>兼容处理：判断如果是当前目录（<code>.</code>），则拼接为<code>./文件名</code>，否则拼接为<code>目录路径/文件名</code>；</li>
<li>安全：使用<code>snprintf</code>而非<code>sprintf</code>，指定缓冲区大小（<code>sizeof(filepath)</code>），避免字符串溢出导致的程序崩溃。</li>
</ul>
<h4 data-id="heading-10">步骤 4：打印单个文件所有属性（PrintFile 函数）</h4>
<ul>
<li>核心结构体<code>struct stat st</code>：Linux 存储文件属性的标准结构体，<code>stat</code>函数将文件属性写入该结构体；</li>
<li>调用<code>stat(filepath, &amp;st)</code>获取属性：成功返回 0 则继续，失败则直接跳过（避免个别文件解析失败导致整个程序终止）；</li>
<li>功能封装：依次调用<code>PrintType</code>（类型）、<code>Printmode</code>（权限）、打印大小、<code>Printtime</code>（时间）、打印文件名，与原生<code>ls</code>输出顺序一致。</li>
</ul>
<h4 data-id="heading-11">步骤 5：解析并打印文件类型（PrintType 函数）</h4>
<ul>
<li>核心：利用 Linux 系统提供的<strong>文件类型判断宏</strong>（基于<code>st_mode</code>字段），无需手动解析位域，简单高效；</li>
<li>支持 7 种常见文件类型：覆盖 Linux 所有基础文件类型，比原生<code>ls</code>支持的类型更全面；</li>
<li>单一职责：仅负责判断并打印文件类型，无其他逻辑，符合模块化设计。</li>
</ul>
<h4 data-id="heading-12">步骤 6：解析并打印文件权限（Printmode 函数）</h4>
<ul>
<li>Linux 文件权限核心：<strong>9 位权限位</strong>，分为 3 组（所有者、组用户、其他用户），每组 3 位（读 r、写 w、执行 x）；</li>
<li>判断方式：<strong>按位与（&amp;）</strong> ，<code>mode &amp; 权限宏</code>结果非 0 表示拥有该权限，打印对应字符，否则打印<code>-</code>；</li>
<li>权限宏：<code>S_IRUSR</code>（所有者读）、<code>S_IWUSR</code>（所有者写）、<code>S_IXUSR</code>（所有者执行），组用户和其他用户对应<code>GRP</code>、<code>OTH</code>后缀。</li>
</ul>
<h4 data-id="heading-13">步骤 7：格式化打印文件修改时间（Printtime 函数）</h4>
<ul>
<li>时间戳转换：<code>st_mtime</code>是<code>time_t</code>类型的时间戳（从 1970-01-01 00:00:00 到修改时间的秒数），需通过<code>localtime</code>转换为<code>struct tm</code>本地时间结构体；</li>
<li>注意坑：<code>tm_mon</code>字段从 0 开始（0=1 月，11=12 月），必须<code>+1</code>才能得到正确月份；</li>
<li>格式化输出：使用<code>sprintf</code>将时间拼接为「月 日 时：分」格式，与原生<code>ls</code>的时间展示风格一致，更符合使用习惯。</li>
</ul>
<h4 data-id="heading-14">步骤 8：关闭目录，释放资源（main 函数）</h4>
<ul>
<li>遍历结束后调用<code>closedir(dir)</code>关闭目录描述符，释放系统资源；</li>
<li>关键：<strong>避免资源泄漏</strong>，尤其是在循环遍历、多目录处理场景中，未关闭的目录描述符会耗尽系统资源，导致 “Too many open files” 错误。</li>
</ul>
<h3 data-id="heading-15">五、编译与运行：Linux 环境下快速测试</h3>
<p>这份代码无需依赖第三方库，直接在 Linux 系统（Ubuntu/CentOS/ 嵌入式 Linux）中用<code>gcc</code>编译即可，步骤简单，全程只需 3 条命令：</p>
<h4 data-id="heading-16">步骤 1：保存代码</h4>
<p>将上述代码保存为<code>my_ls.c</code>（文件名可自定义，后缀必须为<code>.c</code>），比如保存到<code>/home/user/</code>目录下。</p>
<h4 data-id="heading-17">步骤 2：编译代码</h4>
<p>打开 Linux 终端，进入代码所在目录，执行<code>gcc</code>编译命令：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译：my_ls.c为源码文件，-o my_ls指定生成的可执行程序名为my_ls</span>
gcc my_ls.c -o my_ls
</code></pre>
<ul>
<li>若无任何输出，说明编译成功，当前目录会生成<code>my_ls</code>可执行程序；</li>
<li>若有编译错误，检查代码是否复制完整、是否有语法错误（如少分号、括号不匹配）。</li>
</ul>
<h4 data-id="heading-18">步骤 3：运行程序</h4>
<p>支持<strong>默认遍历当前目录</strong>和<strong>指定目录遍历</strong>两种方式，与原生<code>ls</code>命令用法一致：</p>
<h5 data-id="heading-19">方式 1：默认遍历当前目录</h5>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 直接运行，遍历当前目录下所有文件/目录</span>
./my_ls
</code></pre>
<h5 data-id="heading-20">方式 2：指定目录遍历</h5>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 遍历指定目录，如遍历/home目录、/usr/bin目录</span>
./my_ls /home
./my_ls /usr/bin
<span class="hljs-comment"># 遍历当前目录的子目录，如./test</span>
./my_ls ./test
</code></pre>
<h4 data-id="heading-21">运行效果示例</h4>
<p>以遍历当前目录为例，输出效果与原生<code>ls</code>高度一致，包含文件类型、权限、大小、修改时间、文件名：</p>
<p>plaintext</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">drwxr-xr-x</span> <span class="hljs-number">4096 </span><span class="hljs-number">1</span><span class="hljs-string">月</span>  <span class="hljs-number">30</span> <span class="hljs-number">15</span><span class="hljs-string">:20</span> <span class="hljs-string">test_dir</span>
<span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1200 </span><span class="hljs-number">1</span><span class="hljs-string">月</span>  <span class="hljs-number">30</span> <span class="hljs-number">14</span><span class="hljs-string">:50</span> <span class="hljs-string">test.c</span>
<span class="hljs-string">-rwxr-xr-x</span> <span class="hljs-number">8960 </span><span class="hljs-number">1</span><span class="hljs-string">月</span>  <span class="hljs-number">30</span> <span class="hljs-number">15</span><span class="hljs-string">:10</span> <span class="hljs-string">my_ls</span>
<span class="hljs-string">lrwxrwxrwx</span> <span class="hljs-number">6</span>    <span class="hljs-number">1</span><span class="hljs-string">月</span>  <span class="hljs-number">30</span> <span class="hljs-number">15</span><span class="hljs-string">:00</span> <span class="hljs-string">test_link</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">test.c</span>
</code></pre>
<ul>
<li>第一列：文件类型 + 权限（如<code>drwxr-xr-x</code>= 目录 + 所有者 rwx / 组用户 r-x / 其他用户 r-x）；</li>
<li>第二列：文件大小（字节，目录默认 4096 字节）；</li>
<li>第三列：最后修改时间（月 日 时：分）；</li>
<li>第四列：文件名 / 目录名（链接文件会显示原文件名）。</li>
</ul>
<h3 data-id="heading-22">六、关键细节与避坑指南：新手必看</h3>
<p>这份代码看似简单，但包含了 Linux C 语言文件系统开发的<strong>多个关键细节和避坑点</strong>，也是面试高频考点，一定要掌握：</p>
<h4 data-id="heading-23">坑 1：忘记拼接文件完整路径，stat 解析失败</h4>
<ul>
<li>现象：编译成功，运行后无输出或仅打印部分文件；</li>
<li>原因：<code>readdir</code>返回的是文件名，<code>stat</code>在当前目录查找，指定目录下的文件无法找到；</li>
<li>解决：必须通过<code>snprintf</code>拼接<strong>目录路径 + 文件名</strong>的完整路径，确保 stat 能正确解析。</li>
</ul>
<h4 data-id="heading-24">坑 2：使用 sprintf 拼接路径，导致缓冲区溢出</h4>
<ul>
<li>现象：程序偶尔崩溃，或输出乱码；</li>
<li>原因：<code>sprintf</code>不检查缓冲区大小，若文件名过长，会导致字符串溢出，覆盖其他内存；</li>
<li>解决：使用<code>snprintf</code>，第三个参数指定缓冲区大小（<code>sizeof(filepath)</code>），自动截断过长字符串，保证安全。</li>
</ul>
<h4 data-id="heading-25">坑 3：未检查 opendir/stat 返回值，程序异常终止</h4>
<ul>
<li>现象：运行时提示 “Segmentation fault” 或直接退出；</li>
<li>原因：<code>opendir</code>打开失败后，<code>dir</code>为 NULL，后续调用<code>readdir(dir)</code>会访问空指针；<code>stat</code>解析失败后，<code>st</code>结构体未初始化，直接访问其字段会导致内存错误；</li>
<li>解决：<strong>必须检查系统调用返回值</strong>，<code>opendir</code>失败则直接退出，<code>stat</code>失败则跳过当前文件。</li>
</ul>
<h4 data-id="heading-26">坑 4：tm_mon 未 + 1，导致月份少 1</h4>
<ul>
<li>现象：文件修改时间的月份比实际少 1（如 1 月显示为 0 月，2 月显示为 1 月）；</li>
<li>原因：<code>struct tm</code>的<code>tm_mon</code>字段从 0 开始计数（0=1 月，11=12 月），是 Linux 时间编程的经典坑；</li>
<li>解决：格式化时间时，<code>tm_mon</code>必须<code>+1</code>，即<code>lt-&gt;tm_mon + 1</code>。</li>
</ul>
<h4 data-id="heading-27">坑 5：遍历结束后未关闭目录，资源泄漏</h4>
<ul>
<li>现象：短时间运行无问题，长期运行或循环遍历多目录时，程序提示 “Too many open files”；</li>
<li>原因：<code>opendir</code>会占用系统文件描述符，未调用<code>closedir</code>关闭，会导致文件描述符耗尽；</li>
<li>解决：遍历结束后，无论是否成功，都要调用<code>closedir(dir)</code>释放资源（可放在<code>finally</code>块，或直接在遍历结束后调用）。</li>
</ul>
<h4 data-id="heading-28">细节 1：文件类型判断宏的使用</h4>
<ul>
<li>不要手动解析<code>st_mode</code>的位域判断文件类型，Linux 提供了标准化的判断宏（<code>S_ISDIR</code>/<code>S_ISREG</code>等），兼容性更好、更简洁；</li>
<li>所有判断宏的参数都是<code>mode_t mode</code>（即<code>st.st_mode</code>），返回非 0 表示为对应类型。</li>
</ul>
<h4 data-id="heading-29">细节 2：权限判断的按位与操作</h4>
<ul>
<li>Linux 文件权限存储在<code>st_mode</code>的低 9 位，每 3 位为一组，分别对应所有者、组用户、其他用户；</li>
<li>按位与（&amp;）的原理：保留指定位的数值，其他位清 0，非 0 表示该权限位为 1（拥有该权限）。</li>
</ul>
<h3 data-id="heading-30">七、功能扩展：基于当前代码实现更多 ls 特性</h3>
<p>这份代码是<strong>基础版</strong>，实现了<code>ls</code>的核心功能，在此基础上可以轻松扩展，实现原生<code>ls</code>的更多特性，推荐几个实用的扩展方向，大家可以自己动手实现：</p>
<h4 data-id="heading-31">扩展 1：显式跳过<code>.</code>和<code>..</code>特殊目录</h4>
<p>在<code>readdir</code>循环中添加判断，跳过这两个特殊目录，与原生<code>ls -A</code>效果一致：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(dirinfo-&gt;d_name, <span class="hljs-string">"."</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(dirinfo-&gt;d_name, <span class="hljs-string">".."</span>) == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">continue</span>;
}
</code></pre>
<h4 data-id="heading-32">扩展 2：按文件大小 / 修改时间排序</h4>
<ul>
<li>定义数组存储所有文件的属性信息（文件名、大小、修改时间等）；</li>
<li>遍历完成后，通过自定义排序函数（如冒泡排序、快速排序）按大小 / 时间排序；</li>
<li>排序后再打印所有文件信息，实现<code>ls -S</code>（按大小排序）、<code>ls -t</code>（按时间排序）效果。</li>
</ul>
<h4 data-id="heading-33">扩展 3：添加文件所有者和组信息</h4>
<ul>
<li>通过<code>st.st_uid</code>（所有者 ID）和<code>st.st_gid</code>（组 ID），调用<code>getpwuid</code>和<code>getgrgid</code>函数转换为用户名和组名；</li>
<li>在打印权限后、大小前，添加用户名和组名的打印，实现<code>ls -l</code>的完整效果。</li>
</ul>
<h4 data-id="heading-34">扩展 4：支持递归遍历子目录</h4>
<ul>
<li>判断如果是目录文件（<code>S_ISDIR(mode)</code>），则递归调用主逻辑，打开并遍历该子目录；</li>
<li>实现<code>ls -R</code>的递归遍历效果，适合批量处理目录下所有文件。</li>
</ul>
<h4 data-id="heading-35">扩展 5：添加彩色输出</h4>
<ul>
<li>根据文件类型设置不同的输出颜色（如目录蓝色、普通文件白色、可执行文件绿色）；</li>
<li>Linux 终端彩色输出通过 ANSI 转义序列实现，如<code>\033[34m</code>（蓝色）、<code>\033[0m</code>（恢复默认）。</li>
</ul>
<h3 data-id="heading-36">八、总结：从手写 ls 到掌握 Linux 文件系统核心</h3>
<p>这份手写<code>ls</code>的代码，看似是一个简单的小程序，实则融合了<strong>Linux C 语言文件系统开发的所有核心知识点</strong>：目录操作、文件属性解析、命令行参数处理、模块化设计、系统调用返回值检查。</p>
<p>通过实现这个程序，你不仅能熟练掌握<code>opendir/readdir/closedir</code>、<code>stat</code>、<code>localtime</code>等核心 API 的用法，更能理解 Linux 文件系统的底层逻辑 ——<strong>一切皆文件</strong>，目录、设备、管道等都是特殊的文件，都可以通过统一的 API 进行操作。</p>
<p>同时，这份代码的<strong>模块化设计思路</strong>和<strong>错误处理规范</strong>，也是 C 语言工程化开发的基础，无论是嵌入式 Linux 开发还是服务器开发，都能直接复用。</p>
<p>从基础 API 学习到手写实用工具，这是 Linux C 语言开发的关键一步。接下来，你可以基于这份代码继续扩展，实现更完整的<code>ls</code>命令，甚至手写<code>cp</code>、<code>mv</code>等常用命令，真正做到 “知其然，更知其所以然”！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java锁机制]]></title>    <link>https://juejin.cn/post/7600704706550988840</link>    <guid>https://juejin.cn/post/7600704706550988840</guid>    <pubDate>2026-01-30T03:46:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600704706550988840" data-draft-id="7600670417858723874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java锁机制"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-30T03:46:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一边吃泡面"/> <meta itemprop="url" content="https://juejin.cn/user/2831995877458488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java锁机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831995877458488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一边吃泡面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:46:17.000Z" title="Fri Jan 30 2026 03:46:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<ol>
<li>按实现层面划分
<ul>
<li>[内置锁]：<code>synchronized</code>是JVM层面实现的，无需手动释放锁，属于内置锁。</li>
<li>[显式锁]：<code>ReentrantLock</code>为代表的显式锁，需要手动释放锁，功能更加灵活，位于<code>java.util.concurrent.locks</code>包，Java代码层面实现。</li>
</ul>
</li>
<li>按锁的竞争机制划分
<ul>
<li>[悲观锁]：<code>synchronized</code>和<code>ReentrantLock</code>都为悲观锁，每次操作资源都会加锁，阻塞其他线程。</li>
<li>[乐观锁]：不加锁直接操作，通过CAS验证操作是否成功，失败则重试，例如<code>AtomicInteger</code>。</li>
</ul>
</li>
<li>按锁的可重入性划分
<ul>
<li>[可重入锁]：对于已获取到锁的线程可再次获取同一把锁（避免自身死锁），<code>synchronized</code>和<code>ReentrantLock</code>均为可重入锁。</li>
<li>[不可重入锁]：持有锁的线程无法再次获取这把锁，容易引起自身死锁。</li>
</ul>
</li>
<li>锁的升级
<ul>
<li>偏向锁 -&gt; 轻量级锁 -&gt; 重量级锁（JDK1.6优化后，<code>synchronized</code>会根据竞争激烈程度自动升级，逐步提升并发性能）</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-1">具体</h2>
<h3 data-id="heading-2">一、<code>synchronized</code></h3>
<h4 data-id="heading-3">1. 用法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedDemo</span> { 
	<span class="hljs-comment">// 1. 修饰实例方法：锁的是「当前类的实例对象」（this） </span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">instanceMethod</span><span class="hljs-params">()</span> { 
		<span class="hljs-comment">// 线程安全的实例方法逻辑 </span>
		System.out.println(<span class="hljs-string">"修饰实例方法，锁："</span> + <span class="hljs-built_in">this</span>); 
	}
	
	<span class="hljs-comment">// 2. 修饰静态方法：锁的是「当前类的 Class 对象」（SynchronizedDemo.class）</span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticMethod</span><span class="hljs-params">()</span> { 
		<span class="hljs-comment">// 线程安全的静态方法逻辑 </span>
		System.out.println(<span class="hljs-string">"修饰静态方法，锁："</span> + SynchronizedDemo.class); 
	}
	
	<span class="hljs-comment">// 3. 修饰同步代码块：锁的是「括号内指定的对象」（灵活可控） </span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">codeBlockMethod</span><span class="hljs-params">()</span> { 
		<span class="hljs-comment">// 可选锁对象：this（实例对象）、Class 对象、自定义任意对象 </span>
		<span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); 
		<span class="hljs-keyword">synchronized</span> (lock) { 
		<span class="hljs-comment">// 线程安全的代码块逻辑 </span>
		System.out.println(<span class="hljs-string">"修饰代码块，锁："</span> + lock); 
		}
	}
}
</code></pre>
<p>⭐<code>synchronized</code> 竞争的是一个资源对象，无论是修饰的实例方法、静态方法还是代码块，只是对象的类型不同而已。（可以是方法当前类的实例对象、class对象、自定义的任意对象）</p>
<h4 data-id="heading-4">2. 实现原理</h4>
<p>依赖于「Java对象头」和「监视器锁」，不同JDK版本略有差异</p>
<ul>
<li><strong>JDK1.6之前</strong>：仅支持「重量级锁」，依赖操作系统的「互斥量（Mutex）」实现，线程竞争时会触发「用户态 &lt;-&gt; 内核态」的上下文切换，开销极大，性能较差。</li>
<li><strong>JDK1.6之后</strong>：引入了「锁升级」机制（偏向锁 -&gt; 轻量级锁 -&gt; 重量级锁），根据竞争激烈程度逐步升级，大幅优化性能：
<ol>
<li><strong>偏向锁</strong>：无多线程竞争时，锁偏向第一个获取锁的线程，后续该线程再次获取锁时，无需任何竞争操作，直接获取锁（开销极低）。</li>
<li><strong>轻量级锁</strong>：出现少量线程竞争时，偏向锁升级为轻量级锁，通过「CAS 操作」实现锁的获取与释放，无需阻塞线程，仅存在少量自旋开销。</li>
<li><strong>重量级锁</strong>：出现大量线程竞争时，轻量级锁升级为重量级锁，依赖操作系统互斥量实现，竞争失败的线程会被阻塞挂起，避免空耗 CPU，此时开销最大，但能保证高并发场景下的稳定性。</li>
<li>⭐锁升级是单向的，无法降级。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">3. 核心特性</h4>
<ul>
<li><strong>可重入性</strong>：线程持有锁后，可再次获取同一把锁（如同步方法中调用另一同步方法），避免自身死锁。</li>
<li><strong>隐式释放锁</strong>：无需手动调用释放方法，同步代码块 / 方法执行完毕、抛出异常时，JVM 会自动释放锁，降低资源泄露风险。</li>
<li><strong>非公平锁</strong>：默认采用非公平锁策略（线程获取锁时，不遵守先到先得的顺序，可能存在插队现象），吞吐量更高（公平锁会带来额外的排队开销）。</li>
</ul>
<h3 data-id="heading-6">二、<code>ReentrantLock</code></h3>
<h4 data-id="heading-7">1. 用法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLockDemo</span> {
    <span class="hljs-comment">// 1. 创建 ReentrantLock 实例（默认非公平锁，传入 true 为公平锁）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doTask</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 2. 获取锁（lock() 方法，阻塞式获取）</span>
        lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3. 执行线程安全的业务逻辑</span>
            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 已获取锁，执行任务"</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 4. 释放锁（必须在 finally 中，保证无论是否异常，都能释放锁）</span>
            lock.unlock();
            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 已释放锁"</span>);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ReentrantLockDemo</span> <span class="hljs-variable">demo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLockDemo</span>();
        <span class="hljs-comment">// 启动 2 个线程竞争锁</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(demo::doTask, <span class="hljs-string">"线程1"</span>).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(demo::doTask, <span class="hljs-string">"线程2"</span>).start();
    }
}
</code></pre>
<p>⭐<code>finally</code>释放锁是必须的，防止try抛出异常，锁无法释放，会导致其他线程永久阻塞，引发死锁。</p>
<h4 data-id="heading-8">2. 核心功能扩展</h4>
<p><code>ReentrantLock</code>提供了<code>synchronized</code>不具备的高级功能：</p>
<ul>
<li>支持公平锁/非公平锁：创建实例的时候可以设置采用公平锁还是非公平锁，默认非公平锁（false）</li>
<li>支持获取锁超时：通过<code>trylock(long timeout, TimeUnit unit)</code>方法，设置锁获取超时时间，超时后自动放弃获取锁，返回false，避免长时间阻塞。</li>
<li>支持可中断获取锁：通过<code>lockInterruptibly()</code>方法，获取锁的线程可被其他线程中断（调用<code>thread.interrupt()</code>），中断后抛出 <code>InterruptedException</code>，并释放锁，灵活控制线程状态。</li>
<li>提供锁状态查询：如<code>isLocked()</code>（判断锁是否被持有）、<code>isHeldByCurrentThread()</code>（判断当前线程是否持有该锁）、<code>getHoldCount()</code>（获取当前线程持有该锁的次数），方便监控和调试。</li>
</ul>
<h4 data-id="heading-9">3. 原理</h4>
<p><code>ReentrantLock</code> 的底层基于 <strong>AQS（AbstractQueuedSynchronizer，抽象队列同步器）</strong> 实现，AQS 是 JUC 包中所有显式锁、同步工具类的核心框架。
核心逻辑：</p>
<ol>
<li>AQS 内部维护一个「volatile 状态变量 <code>state</code>」和一个「双向链表同步队列」。</li>
<li><code>state</code> 用于标记锁的状态：<code>state=0</code> 表示锁未被持有，<code>state&gt;0</code> 表示锁被持有（<code>state</code> 的值等于线程持有锁的次数，体现可重入性）。</li>
<li>线程获取锁时，通过 CAS 操作修改 <code>state</code>：若 <code>state=0</code>，则将 <code>state</code> 改为 1，获取成功；若 <code>state&gt;0</code> 且是当前线程持有，则 <code>state</code> 加 1（可重入），否则加入同步队列阻塞等待。</li>
<li>线程释放锁时，将 <code>state</code> 减 1，当 <code>state=0</code> 时，释放锁并唤醒同步队列中的下一个线程。</li>
</ol>
<h4 data-id="heading-10">4. 核心特性</h4>
<ol>
<li><strong>可重入性</strong>：和 <code>synchronized</code> 一样，支持线程重复获取同一把锁，通过 <code>state</code> 变量计数实现。</li>
<li><strong>显式释放锁</strong>：必须手动调用 <code>unlock()</code> 释放，依赖开发者规范，灵活性高但风险也高（容易遗漏释放）。</li>
<li><strong>功能灵活</strong>：支持公平锁、超时获取、可中断等高级功能，适配复杂并发场景。</li>
<li><strong>性能优异</strong>：在高并发场景下，性能略优于 <code>synchronized</code>（JDK 1.6 后 <code>synchronized</code> 优化，两者性能差距不大）。</li>
</ol>
<hr/>
<h3 data-id="heading-11">三、<code>synchronized</code>锁升级</h3>
<p>锁的载体 -- <strong>Java对象头</strong>：<code>synchronized</code> 锁的是「对象」，而锁状态的信息，就存储在 <strong>Java 对象头（Object Header）</strong> 中（仅针对普通对象，数组对象的对象头额外包含数组长度）。
Java 对象头在 32 位 JVM 和 64 位 JVM 中长度分别为 8 字节和 16 字节，核心包含两部分（以 64 位 JVM 为例）：</p>
<ol>
<li><strong>Mark Word</strong>（标记字段，8字节）：存储对象的锁状态、哈希码、GC年龄、偏向线程ID等核心信息，是锁升级的「核心载体」。</li>
<li><strong>Klass Pointer</strong>（类型指针，8字节）：指向对象所属类的Class对象，用于确定对象的类型。</li>
</ol>

























<table><thead><tr><th>锁状态</th><th>Mark Word 核心字段（64 位）</th></tr></thead><tbody><tr><td>无锁</td><td>哈希码（25 位）+ GC 年龄（4 位）+ 无锁标记（1 位）</td></tr><tr><td>偏向锁</td><td>偏向线程 ID（54 位）+ 偏向时间戳（2 位）+ GC 年龄（4 位）+ 偏向锁标记（1 位）</td></tr><tr><td>轻量级锁</td><td>指向栈中锁记录的指针（63 位）+ 轻量级锁标记（1 位）</td></tr><tr><td>重量级锁</td><td>指向监视器锁（Monitor）的指针（63 位）+ 重量级锁标记（1 位）</td></tr></tbody></table>
<h5 data-id="heading-12">第一步：无锁 -&gt; 偏向锁（无竞争场景）</h5>
<ol>
<li>第一个线程获取锁时，JVM 通过 CAS 操作，将 <code>Mark Word</code> 中的「偏向线程 ID」设置为当前线程的 ID，同时将「锁标记位」改为「偏向锁标记」。</li>
<li>该线程后续再次获取该对象的锁时，无需再执行 CAS 操作或阻塞，只需简单检查 <code>Mark Word</code> 中的：
<ul>
<li>偏向线程 ID 是否为当前线程 ID；</li>
<li>偏向锁标记是否有效。</li>
</ul>
</li>
<li>若两者都满足，直接获取锁成功（「偏向」的含义就是锁会「偏爱」这个线程），全程无额外开销，效率极高。</li>
</ol>
<h5 data-id="heading-13">第二步：偏向锁 → 轻量级锁（少量线程竞争，无阻塞）</h5>
<ol>
<li><strong>加锁流程</strong>：</li>
</ol>
<ul>
<li>线程获取锁时，先在自己的栈帧中创建一个「锁记录（Lock Record）」，用于存储对象 <code>Mark Word</code> 的副本（称为「Displaced Mark Word」）。</li>
<li>线程通过 CAS 操作，将对象 <code>Mark Word</code> 中的内容替换为「指向当前线程栈中锁记录的指针」。</li>
<li>若 CAS 成功，说明锁获取成功，将 <code>Mark Word</code> 的锁标记位改为「轻量级锁标记」，线程继续执行同步代码。</li>
<li>若 CAS 失败，说明有其他线程正在竞争该锁，当前线程不会被阻塞，而是进入「自旋」（反复执行 CAS 操作，尝试获取锁）。</li>
</ul>
<ol start="2">
<li><strong>解锁流程</strong>：</li>
</ol>
<ul>
<li>线程执行完同步代码后，通过 CAS 操作，将对象 <code>Mark Word</code> 中的「锁记录指针」替换回原来的「Displaced Mark Word」（栈中锁记录存储的副本）。</li>
<li>若 CAS 成功，说明无其他线程竞争，解锁成功，锁状态回到无锁。</li>
<li>若 CAS 失败，说明有其他线程在自旋竞争，此时会将轻量级锁升级为重量级锁，同时唤醒自旋的线程。</li>
</ul>
<h5 data-id="heading-14">第三步：轻量级锁 → 重量级锁（大量线程竞争，阻塞式竞争）</h5>
<ol>
<li><strong>加锁流程</strong>：</li>
</ol>
<ul>
<li>锁升级为重量级锁后，对象 <code>Mark Word</code> 中会存储「指向 Monitor 的指针」，Monitor 是一个用于管理锁竞争的核心数据结构。</li>
<li>线程获取锁时，会尝试获取 Monitor 的「持有权」（Monitor 中的 <code>owner</code> 字段记录持有锁的线程）。</li>
<li>若获取成功，<code>owner</code> 字段设置为当前线程，线程执行同步代码。</li>
<li>若获取失败，当前线程会被加入 Monitor 的「阻塞队列」，被操作系统挂起（从用户态切换到内核态），放弃 CPU 执行权，直到被唤醒。</li>
</ul>
<ol>
<li><strong>解锁流程</strong>：</li>
</ol>
<ul>
<li>线程执行完同步代码后，释放 Monitor 的持有权（将 <code>owner</code> 字段置为 null）。</li>
<li>唤醒阻塞队列中的一个线程（通过操作系统的唤醒机制），让其尝试获取锁。</li>
<li>锁状态保持为重量级锁，不会降级（单向升级）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android-封装一个超好用的权限工具类]]></title>    <link>https://juejin.cn/post/7600675515150745627</link>    <guid>https://juejin.cn/post/7600675515150745627</guid>    <pubDate>2026-01-30T02:25:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600675515150745627" data-draft-id="7600684978353815579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android-封装一个超好用的权限工具类"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-30T02:25:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ishibashi"/> <meta itemprop="url" content="https://juejin.cn/user/2019159609710904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android-封装一个超好用的权限工具类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2019159609710904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ishibashi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:25:50.000Z" title="Fri Jan 30 2026 02:25:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">封装一个好用的原生权限工具类，方便以后开发直接拿来用。</h4>
<p>思考1：工具类应具备的能力</p>
<blockquote>
<ol>
<li>
<p>权限判断</p>
</li>
<li>
<p>权限请求</p>
</li>
<li>
<p>权限回调处理 （权限同意、权限拒绝、权限拒绝且不再询问）</p>
</li>
</ol>
</blockquote>
<p>思考2：涉及的API：</p>
<blockquote>
<p><strong>权限判断-API：</strong>
ContextCompat.checkSelfPermission</p>
<p>tips:</p>
<p>有权限 PackageManager.PERMISSION_GRANTED</p>
<p>无权限 PackageManager.PERMISSION_DENIED</p>
<p>无权限且不再询问 PackageManager.PERMISSION_DENIED + !activity.shouldShowRequestPermissionRationale(permission)</p>
<p><strong>权限请求与回调-API：</strong></p>
<ul>
<li>方案1（旧版）：ActivityCompat.requestPermissions 与 ComponentActivity-重写onRequestPermissionsResult</li>
<li>方案2（推荐）：ComponentActivity-registerForActivityResult().launch 与  ComponentActivity-registerForActivityResult()</li>
</ul>
</blockquote>
<p>方案1这个菜有点老，本次我们吃方案2，新鲜点儿。</p>
<p>开始上菜~</p>
<h3 data-id="heading-1">一、构建权限工具类：PermissionNewHelper</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionNewHelper</span> {
    <span class="hljs-keyword">var</span> denialList = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">var</span> denialNeverList = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">var</span> requestCode = <span class="hljs-number">0</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createPermissionLauncher</span><span class="hljs-params">(activity: <span class="hljs-type">ComponentActivity</span>, nextUnit:((<span class="hljs-type">Int</span>)-&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>, denialUnit:(()-&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>, neverUnit:(()-&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>)</span></span>:ActivityResultLauncher&lt;Array&lt;String&gt;&gt;{
        <span class="hljs-keyword">return</span> activity.registerForActivityResult(ActivityResultContracts.RequestMultiplePermissions(),<span class="hljs-keyword">object</span> :
            ActivityResultCallback&lt;Map&lt;String, <span class="hljs-built_in">Boolean</span>&gt;&gt;{
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onActivityResult</span><span class="hljs-params">(result: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-built_in">Boolean</span>&gt;)</span></span> {
                denialList.clear()
                denialNeverList.clear()
                result.forEach {(permission, isGranted) -&gt;
                    <span class="hljs-keyword">if</span> (isGranted) {
                        <span class="hljs-comment">// 权限已授予</span>
                    } <span class="hljs-keyword">else</span> {
                        denialList.add(permission) <span class="hljs-comment">// 权限被拒绝，可提示用户手动开启</span>
                        <span class="hljs-keyword">if</span> (!activity.shouldShowRequestPermissionRationale(permission)) {
                            denialNeverList.add(permission) <span class="hljs-comment">// 用户选择了"不再询问"，需引导至设置页面</span>
                        }
                    }
                }
                <span class="hljs-keyword">if</span> (denialList.size == <span class="hljs-number">0</span>) {
                    nextUnit?.invoke(requestCode)
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (denialNeverList.size == <span class="hljs-number">0</span>) {
                        denialUnit?.invoke()
                    }<span class="hljs-keyword">else</span>{
                        neverUnit?.invoke()
                    }
                }
            }
        })
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkPermissions</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, <span class="hljs-keyword">vararg</span> permissions: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span>{
        <span class="hljs-keyword">return</span> permissions.all { permission-&gt;
            ContextCompat.checkSelfPermission(context,permission) == PackageManager. PERMISSION_GRANTED
        }
    }

    <span class="hljs-comment">/**
    * 获取权限
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">requestPermissions</span><span class="hljs-params">(launcher:<span class="hljs-type">ActivityResultLauncher</span>&lt;<span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;&gt;, permissions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;, requestCode: <span class="hljs-type">Int</span>)</span></span>{
        <span class="hljs-keyword">this</span>.requestCode = requestCode
        launcher.launch(permissions)
    }
}
</code></pre>
<h3 data-id="heading-2">二、构建权限弹框辅助类：PermissionDialogHelper</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionDialogHelper</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showPermissionRequestPop</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, des:<span class="hljs-type">String</span>, next:()-&gt; <span class="hljs-type">Unit</span>)</span></span>{
        showPop(context,des,next)
    }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showPermissionJumpSettingPop</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, des:<span class="hljs-type">String</span>, next:()-&gt; <span class="hljs-type">Unit</span>)</span></span>{
        showPop(context,des,next)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showPop</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, des:<span class="hljs-type">String</span>, next:()-&gt; <span class="hljs-type">Unit</span>)</span></span>{
        <span class="hljs-keyword">var</span> create :AlertDialog? = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">val</span> dialog = AlertDialog.Builder(context).setTitle(<span class="hljs-string">"温馨提示"</span>).setMessage(des)
            .setNegativeButton(<span class="hljs-string">"取消"</span>, <span class="hljs-keyword">object</span> :
                DialogInterface.OnClickListener {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">(dialog: <span class="hljs-type">DialogInterface</span>?, which: <span class="hljs-type">Int</span>)</span></span> {
                    create?.dismiss()
                }
            }).setPositiveButton(<span class="hljs-string">"确定"</span>, <span class="hljs-keyword">object</span> : DialogInterface.OnClickListener {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">(dialog: <span class="hljs-type">DialogInterface</span>?, which: <span class="hljs-type">Int</span>)</span></span> {
                create?.dismiss()
                next()
            }
        })
        create = dialog.create()
        create?.show()
    }
}
</code></pre>
<h3 data-id="heading-3">三、工具类的使用：</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionNewActivity</span>: <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">var</span> permission: Array&lt;String&gt; = arrayOf(Manifest.permission.ACCESS_FINE_LOCATION, Manifest.permission.CAMERA)
    <span class="hljs-keyword">val</span> mPermissionNewHelper <span class="hljs-keyword">by</span> lazy { PermissionNewHelper() }
    <span class="hljs-keyword">val</span> mPermissionDialogHelper <span class="hljs-keyword">by</span> lazy { PermissionDialogHelper() }
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> mPermissionLauncher :ActivityResultLauncher&lt;Array&lt;String&gt;&gt;

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_test)

mPermissionLauncher = mPermissionNewHelper.createPermissionLauncher(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, { code-&gt;
            <span class="hljs-keyword">if</span>(code==<span class="hljs-number">7777</span>){
                Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, <span class="hljs-string">"next"</span>, Toast.LENGTH_SHORT).show()
            }
        }, {
            Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, <span class="hljs-string">"denial"</span>, Toast.LENGTH_SHORT).show()
        }, {
            Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, <span class="hljs-string">"never"</span>, Toast.LENGTH_SHORT).show()
            mPermissionDialogHelper.showPermissionJumpSettingPop(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, <span class="hljs-string">"跳转系统设置权限的描述"</span>) {
                <span class="hljs-comment">//前往系统设置</span>
                <span class="hljs-keyword">val</span> intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS)
                intent.setData(Uri.parse(<span class="hljs-string">"package:<span class="hljs-subst">${this@PermissionNewActivity.packageName}</span>"</span>))
                startActivity(intent)
            }
        })


findViewById&lt;Button&gt;(R.id.mBtn).setOnClickListener {
            <span class="hljs-keyword">val</span> check = mPermissionNewHelper.checkPermissions(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>,*permission)
            <span class="hljs-keyword">if</span>(check){
                Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>, <span class="hljs-string">"next"</span>, Toast.LENGTH_SHORT).show()
            }<span class="hljs-keyword">else</span>{
                mPermissionDialogHelper.showPermissionRequestPop(<span class="hljs-keyword">this</span><span class="hljs-symbol">@PermissionNewActivity</span>,<span class="hljs-string">"请求权限的描述"</span>) {
                    mPermissionNewHelper.requestPermissions(mPermissionLauncher,permission,<span class="hljs-number">7777</span>)
                }
            }
        }
    }

}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【技术专题】Scikit-learn Python机器学习 - 回归分析算法之线性回归 (LinearRegression & SGDRegressor)]]></title>    <link>https://juejin.cn/post/7600684978353963035</link>    <guid>https://juejin.cn/post/7600684978353963035</guid>    <pubDate>2026-01-30T02:43:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600684978353963035" data-draft-id="7600684978353881115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【技术专题】Scikit-learn Python机器学习 - 回归分析算法之线性回归 (LinearRegression &amp; SGDRegressor)"/> <meta itemprop="keywords" content="机器学习,人工智能,Python"/> <meta itemprop="datePublished" content="2026-01-30T02:43:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小锋java1234"/> <meta itemprop="url" content="https://juejin.cn/user/4152222342709933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【技术专题】Scikit-learn Python机器学习 - 回归分析算法之线性回归 (LinearRegression &amp; SGDRegressor)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4152222342709933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小锋java1234
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:43:39.000Z" title="Fri Jan 30 2026 02:43:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是锋哥。最近连载更新《Scikit-learn Python机器学习》技术专题。 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e7477f400ac4a9aac6f4a78bd2b4836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=MmTDU0DYK2NinpaLTKU5jRZsRtY%3D" alt="image.png" loading="lazy"/> 本课程主要讲解基于Scikit-learn的Python机器学习知识，包括机器学习概述，特征工程(数据集，特征抽取，特征预处理，特征降维等)，分类算法(K-临近算法，朴素贝叶斯算法，决策树等)，回归与聚类算法(线性回归，欠拟合，逻辑回归与二分类，K-means算法)等。 同时也配套视频教程<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV11reUzEEPH%2F" title="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV11reUzEEPH%2F" target="_blank">《Scikit-learn Python机器学习 视频教程》</a></p>
<p>线性回归（Linear Regression）是一种基础的回归分析方法，它通过构建输入特征和输出结果之间的线性关系，来预测输出值。其核心思想是通过找到最合适的“拟合线”来预测未知数据的结果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1651775f1c604bada62f1f9cd78e3b62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=ULaRiTRLfJXNsSKVb9%2FlmVuL41Y%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">1，线性回归模型的基本原理</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4196a6c900fe43d4b9400dd709f4cbd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=Yrpfe%2Fmk2ej8PffDJRnE7BgmmEA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2，损失函数</h2>
<p>在回归问题中，我们常用 <strong>均方误差（MSE）</strong> 作为损失函数，目标是最小化这个损失函数。均方误差计算公式为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eabf8df8e54d4e4db0b2f336775696ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=3YoQGuqu%2FYX9bW5e4aTl0sWlrpw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">3，模型的求解</h2>
<p>线性回归的目标就是通过最小化损失函数来找到最合适的 <em>β</em> 参数。我们可以通过 <strong>梯度下降法</strong> 或者 <strong>正规方程法</strong> 来求解。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15e03d45189746899c67e42f242a1f1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=Ne1ix%2Bh95O%2BcqKHFr4wwTVgjv4Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">4，梯度下降法</h2>
<p>梯度下降法（Gradient Descent）是机器学习和深度学习中常用的一种优化算法。它的核心思想非常直观：我们通过不断“走下坡路”来找到一个最低点（即最优解）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0de275dedcfb4d79977117fd2cd63e0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=6q4tsOd%2BVGMkJj1TB1oPLrjAaMw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>想象一下：</strong></p>
<p>假设你站在一个山坡上，你的目标是找到山谷的最低点。你无法看到整个山谷的情况，只能看到你当前所在位置的周围环境。为了找到最低点，你需要根据当前的位置判断哪个方向最陡峭，然后朝着这个方向走一小步。每走一步，你就能让自己离最低点更近一些。</p>
<p><strong>具体来说，梯度下降法是这样的：</strong></p>
<ol start="0">
<li><strong>山坡的斜率</strong>：在数学中，我们可以通过<strong>梯度</strong>来表示当前点的“坡度”或“斜率”。如果你在山坡的某个点站着，梯度就告诉你最陡的下坡方向。换句话说，梯度是一个向量，它指向函数下降最快的方向。</li>
<li><strong>向梯度的反方向走</strong>：为了找到最低点，我们不是沿着梯度的方向走，而是<strong>沿着梯度的反方向走</strong>。因为梯度告诉我们的是上坡的方向，我们反着走就是下坡。</li>
<li><strong>步长（学习率）</strong> ：每走一步时，我们需要决定步伐的大小，这就是所谓的<strong>学习率</strong>。如果步伐太大，可能会错过最低点；如果步伐太小，找到最低点的过程就会非常缓慢。</li>
</ol>
<p><strong>过程：</strong></p>
<ol start="0">
<li><strong>初始化</strong>：首先从一个随机点（位置）开始。这个点可以是任何地方，就像你站在山坡的某个随机位置。</li>
<li><strong>计算梯度</strong>：在当前位置，计算当前点的梯度（坡度）。梯度告诉你最陡的上坡方向。</li>
<li><strong>更新位置</strong>：沿着梯度的反方向走，更新你的位置。更新的幅度是梯度的反方向乘以步长（学习率）。</li>
<li><strong>重复</strong>：不断重复上述步骤，直到你到达一个相对平坦的区域，或者你已经足够接近最低点。</li>
</ol>
<p><strong>数学公式</strong></p>
<p>梯度下降的更新规则通常表示为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1bff47270d34da3886a350eda617816~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=IkKWQjfFFJIe9jWwmxn82N8OURk%3D" alt="image.png" loading="lazy"/></p>
<p><strong>例子：线性回归的梯度下降</strong></p>
<p>假设我们要通过梯度下降法求解线性回归模型的参数（例如直线的斜率和截距）。我们可以使用梯度下降来最小化均方误差（MSE）损失函数。每次通过计算梯度，调整参数，最终找到一个合适的拟合直线。</p>
<p><strong>关键要点：</strong></p>
<ul>
<li><strong>步长（学习率）</strong> ：如果学习率设置得太大，可能会“跳过”最低点；如果设置得太小，算法收敛得非常慢。</li>
<li><strong>局部最小值和全局最小值</strong>：梯度下降法有可能会停在局部最低点，但理想情况下我们希望找到全局最低点。为此，我们可以使用一些技巧，如<strong>随机初始化</strong>或<strong>动量法</strong>，来避免陷入局部最小值。</li>
</ul>
<p><strong>类比理解：</strong></p>
<ul>
<li><strong>攀登山峰</strong>：梯度下降就像你在山中探险，通过触摸周围的环境（计算梯度）来确定下一步走向。</li>
<li><strong>在迷雾中找路</strong>：如果你不能看到全貌，你就只能一步一步、逐渐判断方向，直到找到目的地。</li>
</ul>
<h2 data-id="heading-4">5，API介绍</h2>
<p>线性回归-正规方程使用 LinearRegression</p>
<p><code>LinearRegression</code> 类的参数不多，但它们控制着模型如何拟合数据和如何计算。</p>
<pre><code class="hljs language-ini" lang="ini">sklearn.linear_model.LinearRegression(
    *, 
    <span class="hljs-attr">fit_intercept</span>=<span class="hljs-literal">True</span>, 
    <span class="hljs-attr">copy_X</span>=<span class="hljs-literal">True</span>, 
    <span class="hljs-attr">n_jobs</span>=None, 
    <span class="hljs-attr">positive</span>=<span class="hljs-literal">False</span>
)
</code></pre>
<p>参数详解：</p>
<p><strong>1. <code>fit_intercept</code> : bool, default=True</strong></p>
<ul>
<li>
<p><strong>功能</strong>：决定是否计算模型的<strong>截距</strong>（也叫偏置项，即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">w_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>fit_intercept=True</code> (默认)：模型会计算截距项 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">w_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。公式为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><msub><mi>w</mi><mn>0</mn></msub><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>+</mo><msub><mi>w</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\hat{y} = w_0 + w_1x_1 + w_2x_2 + ... + w_nx_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">...</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。<strong>这是最常见的情况</strong>，除非你确信你的数据已经经过处理，其回归线理所当然地应该通过原点 (0,0)。</li>
<li><code>fit_intercept=False</code>：模型会强制截距为 0。公式变为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><msub><mi>w</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>+</mo><msub><mi>w</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\hat{y} = w_1x_1 + w_2x_2 + ... + w_nx_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">...</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。这通常只在你有很强的先验知识（即当所有特征都为 0 时，目标值必须为 0）时使用。</li>
</ul>
</li>
<li>
<p><strong>如何选择</strong>：</p>
<ul>
<li><strong>几乎总是保持默认值 True</strong>。</li>
<li>只有在非常特殊的情况下才设置为 <code>False</code>（例如，物理定律要求没有偏移）。</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>2. <code>copy_X</code> : bool, default=True</strong></p>
<ul>
<li>
<p><strong>功能</strong>：决定是否复制特征数据 <code>X</code>。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>copy_X=True</code> (默认)：在拟合模型之前，会创建特征矩阵 <code>X</code> 的一个副本。原始数据 <code>X</code> 不会被修改。这是安全的选择。</li>
<li><code>copy_X=False</code>：模型会直接在原始数据 <code>X</code> 上进行计算。这可以节省内存，尤其是当 <code>X</code> 非常大时。<strong>但缺点是会覆盖原始数据</strong>。</li>
</ul>
</li>
<li>
<p><strong>如何选择</strong>：</p>
<ul>
<li>通常保持默认值 <code>True</code>，以确保原始数据安全。</li>
<li>只有在内存极度紧张且你确定不再需要原始 <code>X</code> 数据时，才设置为 <code>False</code>。</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>3. <code>n_jobs</code> : int, default=None</strong></p>
<ul>
<li>
<p><strong>功能</strong>：设置用于计算的 CPU 核心数量，用于并行化计算。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>n_jobs=None</code> (默认)：使用 1 个核心。</li>
<li><code>n_jobs=-1</code>：使用所有可用的 CPU 核心。</li>
<li><code>n_jobs=2</code>：使用 2 个核心。</li>
</ul>
</li>
<li>
<p><strong>何时有用</strong>：</p>
<ul>
<li>这个参数主要在目标值 <code>y</code> 是<strong>多维</strong>（例如，你同时要预测多个相关的目标变量）时才会生效。对于绝大多数单目标回归问题（<code>y</code> 是一维向量），设置 <code>n_jobs</code> 不会有任何性能提升，因为计算无法被并行化。</li>
</ul>
</li>
<li>
<p><strong>如何选择</strong>：</p>
<ul>
<li>对于普通的房价预测等单目标问题，<strong>可以忽略此参数</strong>，保持默认 <code>None</code> 即可。</li>
<li>只有在进行多输出回归（Multi-output Regression）时，才考虑设置 <code>n_jobs=-1</code> 来加速。</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>4. <code>positive</code> : bool, default=False</strong></p>
<ul>
<li>
<p><strong>功能</strong>：强制所有系数（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>w</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">w_1, w_2, ..., w_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）为<strong>非负数</strong>。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>positive=False</code> (默认)：系数可以是任意实数（正数、负数或零）。</li>
<li><code>positive=True</code>：约束所有系数 &gt;= 0。这相当于在求解最优化问题时增加了一个约束条件。</li>
</ul>
</li>
<li>
<p><strong>应用场景</strong>：</p>
<ul>
<li>当你根据业务逻辑或先验知识，确定特征与目标之间<strong>只能是正相关关系</strong>时。例如，在商品需求预测中，假设价格打折（折扣力度是一个特征）永远不会导致需求减少，那么就可以强制该特征的系数为非负。</li>
<li>它也可以作为一种<strong>正则化</strong>的形式，帮助防止过拟合，特别是在特征数量多或数据量小的情况下。</li>
</ul>
</li>
<li>
<p><strong>如何选择</strong>：</p>
<ul>
<li>大多数情况下保持默认 <code>False</code>。</li>
<li>只有当你有明确的理由要求模型系数必须为正时，才设置为 <code>True</code>。</li>
</ul>
</li>
</ul>
<p>线性回归-梯度下降使用 SGDRegressor</p>
<p><code>SGDRegressor</code> 的参数可以分为几大类：<strong>损失函数</strong>、<strong>正则化</strong>、<strong>学习率</strong>和<strong>迭代控制</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">sklearn.linear_model.SGDRegressor(
    <span class="hljs-attr">loss</span>=<span class="hljs-string">'squared_error'</span>, 
    <span class="hljs-attr">penalty</span>=<span class="hljs-string">'l2'</span>, 
    <span class="hljs-attr">alpha</span>=<span class="hljs-number">0.0001</span>, 
    <span class="hljs-attr">l1_ratio</span>=<span class="hljs-number">0.15</span>,
    <span class="hljs-attr">fit_intercept</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">max_iter</span>=<span class="hljs-number">1000</span>,
    <span class="hljs-attr">tol</span>=<span class="hljs-number">1</span>e-<span class="hljs-number">3</span>,
    <span class="hljs-attr">shuffle</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">learning_rate</span>=<span class="hljs-string">'invscaling'</span>,
    <span class="hljs-attr">eta0</span>=<span class="hljs-number">0.01</span>,
    <span class="hljs-attr">power_t</span>=<span class="hljs-number">0.25</span>,
    <span class="hljs-attr">early_stopping</span>=<span class="hljs-literal">False</span>,
    <span class="hljs-attr">validation_fraction</span>=<span class="hljs-number">0.1</span>,
    <span class="hljs-attr">n_iter_no_change</span>=<span class="hljs-number">5</span>,
    <span class="hljs-attr">epsilon</span>=<span class="hljs-number">0.1</span>,
    <span class="hljs-attr">random_state</span>=None,
    <span class="hljs-attr">verbose</span>=<span class="hljs-number">0</span>,
    <span class="hljs-attr">warm_start</span>=<span class="hljs-literal">False</span>,
)
</code></pre>
<p>参数详解：</p>
<p><strong>1. 损失函数相关参数 (<code>loss</code>)</strong></p>
<ul>
<li>
<p><strong>loss : str, default='squared_error'</strong></p>
<ul>
<li>
<p><strong>功能</strong>：指定要使用的损失函数，即要最小化的目标函数。</p>
</li>
<li>
<p><strong>可选值</strong>：</p>
<ul>
<li><code>'squared_error'</code>：普通最小二乘，即线性回归。损失函数为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>y</mi><mo>−</mo><mover accent="true"><mi>y</mi><mo>^</mo></mover><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(y - \hat{y})^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>。<strong>这是最常用的默认值</strong>。</li>
<li><code>'huber'</code>：Huber 损失，对异常值的敏感度低于平方损失。它是平方损失和绝对损失的结合，需要通过 <code>epsilon</code> 参数控制其敏感度。</li>
<li><code>'epsilon_insensitive'</code>：ε-不敏感损失，用于支持向量回归（SVR）。</li>
<li><code>'squared_epsilon_insensitive'</code>：平方的 ε-不敏感损失。</li>
</ul>
</li>
<li>
<p><strong>选择指南</strong>：</p>
<ul>
<li>数据干净，无明显异常值：<code>'squared_error'</code>。</li>
<li>数据中有异常值，希望模型更稳健：<code>'huber'</code> 并调整 <code>epsilon</code>。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>epsilon : float, default=0.1</strong></p>
<ul>
<li><strong>功能</strong>：当 <code>loss='huber'</code> 或 <code>'epsilon_insensitive'</code> 时，此参数决定了其对错误的容忍度。对于 Huber 损失，误差小于 <code>epsilon</code> 时是平方项，大于时是线性项。<strong>值越大，对异常值越不敏感</strong>。</li>
</ul>
</li>
</ul>
<p><strong>2. 正则化相关参数 (<code>penalty</code>, <code>alpha</code>, <code>l1_ratio</code>)</strong></p>
<p>这是 <code>SGDRegressor</code> 非常强大的一部分，你可以轻松实现多种正则化。</p>
<ul>
<li>
<p><strong>penalty : {'l2', 'l1', 'elasticnet'}, default='l2'</strong></p>
<ul>
<li>
<p><strong>功能</strong>：指定使用的正则化类型，用于防止过拟合。</p>
</li>
<li>
<p><strong>可选值</strong>：</p>
<ul>
<li><code>'l2'</code> (默认)： Ridge 回归。惩罚系数大小的平方和。倾向于产生小而分散的系数。</li>
<li><code>'l1'</code>： Lasso 回归。惩罚系数大小的绝对值和。倾向于产生稀疏模型（许多系数为0），可用于特征选择。</li>
<li><code>'elasticnet'</code>： Elastic-Net。L1 和 L2 惩罚的凸组合。通过 <code>l1_ratio</code> 参数控制混合比例。</li>
<li><code>None</code>： 无正则化。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>alpha : float, default=0.0001</strong></p>
<ul>
<li><strong>功能</strong>：<strong>正则化项的强度</strong>。乘以损失函数的常数。</li>
<li><strong>详解</strong>：<strong>alpha 越大，正则化越强</strong>，模型系数会被压缩得越小（趋向于0），模型越简单，越可能欠拟合。<code>alpha</code> 越小，正则化越弱，模型更可能过拟合。</li>
<li><strong>注意</strong>：SGD 中的 <code>alpha</code> 等价于 <code>Ridge(alpha=alpha)</code> 和 <code>Lasso(alpha=alpha)</code> 中的 <code>alpha</code>。<strong>这是最重要的需要调优的参数之一</strong>，通常通过网格搜索（如 <code>GridSearchCV</code>）在 <code>[1e-5, 1e-4, ..., 1, 10]</code> 这样的范围内寻找最佳值。</li>
</ul>
</li>
<li>
<p><strong>l1_ratio : float, default=0.15</strong></p>
<ul>
<li>
<p><strong>功能</strong>：当 <code>penalty='elasticnet'</code> 时，<strong>Elastic-Net 混合参数</strong>。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>l1_ratio = 0</code>： 等价于 L2 惩罚。</li>
<li><code>0 &lt; l1_ratio &lt; 1</code>： 混合 L1 和 L2。</li>
<li><code>l1_ratio = 1</code>： 等价于 L1 惩罚。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>3. 学习率调度参数 (<code>learning_rate</code>, <code>eta0</code>, <code>power_t</code>)</strong></p>
<p>梯度下降中，学习率决定了每一步更新的步长。</p>
<ul>
<li>
<p><strong>learning_rate : str, default='invscaling'</strong></p>
<ul>
<li>
<p><strong>功能</strong>：学习率调度策略。</p>
</li>
<li>
<p><strong>可选值</strong>：</p>
<ul>
<li><code>'constant'</code>： 恒定学习率，由 <code>eta0</code> 指定。<code>eta = eta0</code></li>
<li><code>'optimal'</code>： 基于原始论文的启发式选择，不需要调 <code>eta0</code>。</li>
<li><code>'invscaling'</code> (默认)： <strong>逐渐衰减的学习率</strong>。计算公式为 <code>eta = eta0 / pow(t, power_t)</code>，其中 <code>t</code> 是时间步（迭代次数）。这是最常用的策略，随着迭代进行，步长越来越小，有助于收敛。</li>
<li><code>'adaptive'</code>： 自适应学习率。只要损失持续下降，就保持 <code>eta0</code> 不变；当连续 <code>n_iter_no_change</code> 次迭代损失下降低于 <code>tol</code> 时，将学习率除以5。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>eta0 : float, default=0.01</strong></p>
<ul>
<li><strong>功能</strong>：<strong>初始学习率</strong>。当 <code>learning_rate</code> 为 <code>'constant'</code>, <code>'invscaling'</code> 或 <code>'adaptive'</code> 时使用。</li>
<li><strong>详解</strong>：学习率设置太大可能导致算法无法收敛（在最优值附近震荡甚至发散），设置太小则收敛速度过慢。<strong>0.01 是一个常见的起始点</strong>。</li>
</ul>
</li>
<li>
<p><strong>power_t : float, default=0.25</strong></p>
<ul>
<li><strong>功能</strong>：当 <code>learning_rate='invscaling'</code> 时，用于计算学习率的指数。</li>
</ul>
</li>
</ul>
<p><strong>4. 迭代与停止条件参数 (<code>max_iter</code>, <code>tol</code>, <code>early_stopping</code>)</strong></p>
<ul>
<li>
<p><strong>max_iter : int, default=1000</strong></p>
<ul>
<li><strong>功能</strong>：遍历训练数据的最大次数（epochs）。</li>
<li><strong>详解</strong>：SGD 是迭代算法，需要一个停止条件。对于中小型数据集，1000 通常足够。如果数据集很大，可能需要减少这个值。</li>
</ul>
</li>
<li>
<p><strong>tol : float, default=1e-3</strong></p>
<ul>
<li><strong>功能</strong>：停止训练的容忍度。</li>
<li><strong>详解</strong>：如果一次迭代中损失的下降小于 <code>tol</code>，且 <code>early_stopping=False</code>，则训练停止。<strong>调低 tol 可能会使模型拟合得更好，但也会增加训练时间</strong>。</li>
</ul>
</li>
<li>
<p><strong>early_stopping : bool, default=False</strong></p>
<ul>
<li><strong>功能</strong>：是否使用提前停止。</li>
<li><strong>详解</strong>：当设置为 <code>True</code> 时，会预留一部分数据（<code>validation_fraction</code>）作为验证集。当验证分数在连续 <code>n_iter_no_change</code> 次迭代中没有提高至少 <code>tol</code> 时，就停止训练。<strong>这是一种有效防止过拟合的方法</strong>。</li>
</ul>
</li>
<li>
<p><strong>n_iter_no_change : int, default=5</strong></p>
<ul>
<li><strong>功能</strong>：在提前停止或学习率自适应下降之前，等待验证集分数无改进的迭代次数。</li>
</ul>
</li>
<li>
<p><strong>validation_fraction : float, default=0.1</strong></p>
<ul>
<li><strong>功能</strong>：当 <code>early_stopping=True</code> 时，用作验证集的训练数据比例。</li>
</ul>
</li>
</ul>
<p><strong>5. 其他重要参数</strong></p>
<ul>
<li>
<p><strong>shuffle : bool, default=True</strong></p>
<ul>
<li><strong>功能</strong>：是否在每轮迭代后打乱训练数据。<strong>强烈建议保持 True</strong>，打乱数据是 SGD 工作的核心假设之一，可以防止循环出现不良的更新模式。</li>
</ul>
</li>
<li>
<p><strong>random_state : int, default=None</strong></p>
<ul>
<li><strong>功能</strong>：控制数据打乱和初始化的随机种子。设置一个固定的值可以确保每次运行的结果一致，<strong>对于复现实验结果至关重要</strong>。</li>
</ul>
</li>
<li>
<p><strong>warm_start : bool, default=False</strong></p>
<ul>
<li><strong>功能</strong>：如果设为 <code>True</code>，那么调用 <code>fit()</code> 时会使用上一次训练得到的系数作为初始化参数，从而实现增量训练。否则，每次 <code>fit()</code> 都会重新初始化。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">6，具体示例-加州房价预测</h2>
<p>加州房价数据集介绍</p>
<ol start="0">
<li>数据集概况</li>
</ol>
<ul>
<li><strong>来源</strong>：该数据集源自 <strong>1990 年的加州人口普查</strong>。</li>
<li><strong>用途</strong>：用于<strong>回归模型</strong>的练习和测试，目标是预测加州各区域的<strong>房屋中位价</strong>。</li>
<li><strong>样本数量</strong>：<strong>20,640</strong> 条记录。这比波士顿数据集（506条）大得多，能更好地体现机器学习算法的效果。</li>
<li><strong>特征数量</strong>：<strong>8 个</strong>数值型特征。这些特征涵盖了人口、地理位置和经济指标。</li>
<li><strong>目标变量</strong>：<code>MedHouseVal</code> - 街区群体的房屋中位价，单位是<strong>十万美元</strong>。</li>
</ul>
<blockquote>
<p><strong>注意</strong>：目标变量是<strong>分组中位价</strong>。这意味着一个街区的所有房屋都被分配了该街区的 median house value。对于任何位于该街区的房屋，目标值都是相同的。</p>
</blockquote>
<ol start="2">
<li>特征详细说明</li>
</ol>
<p>这8个特征提供了预测房价的不同维度信息，均无伦理问题：</p>
<ol start="0">
<li>
<p><strong>MedInc</strong>：街区居民的收入中位数。</p>
</li>
<li>
<p><strong>HouseAge</strong>：街区内房屋年龄中位数。</p>
</li>
<li>
<p><strong>AveRooms</strong>：平均房间数（每户）。</p>
</li>
<li>
<p><strong>AveBedrms</strong>：平均卧室数（每户）。</p>
</li>
<li>
<p><strong>Population</strong>：街区人口数。</p>
</li>
<li>
<p><strong>AveOccup</strong>：平均家庭成员数（每户）。</p>
</li>
<li>
<p><strong>Latitude</strong>：街区的纬度。</p>
</li>
<li>
<p><strong>Longitude</strong>：街区的经度。</p>
<p>3.目标变量：</p>
</li>
</ol>
<ul>
<li><strong>MedHouseVal</strong>：房屋中位价（单位：十万美元）。</li>
</ul>
<p>线性回归-正规方程使用 LinearRegression</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> fetch_california_housing
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
​
<span class="hljs-comment"># 1,加载数据</span>
california = fetch_california_housing()
<span class="hljs-built_in">print</span>(california.data, california.data.shape)
<span class="hljs-built_in">print</span>(california.target)
<span class="hljs-built_in">print</span>(california.feature_names)
​
<span class="hljs-comment"># 2,数据预处理</span>
X_train, X_test, y_train, y_test = train_test_split(california.data, california.target, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">20</span>)
scaler = StandardScaler()  <span class="hljs-comment"># 数据标准化：消除不同特征量纲的影响</span>
X_train_scaled = scaler.fit_transform(X_train)  <span class="hljs-comment"># fit计算生成模型，transform通过模型转换数据</span>
X_test_scaled = scaler.transform(X_test)  <span class="hljs-comment"># # 使用训练集的参数转换测试集</span>
​
<span class="hljs-comment"># 3,创建和训练线性回归模型(正规方程)</span>
lr_model = LinearRegression()  <span class="hljs-comment"># 创建分类器实例</span>
lr_model.fit(X_train_scaled, y_train)  <span class="hljs-comment"># 训练模型</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'权重系数：'</span>, lr_model.coef_)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'偏置值：'</span>, lr_model.intercept_)  <span class="hljs-comment"># 在线性回归模型中，•偏置（截距）•（bias）是模型参数之一，表示当所有特征值为0时，目标变量的期望值。</span>
​
<span class="hljs-comment"># 4，模型评估</span>
y_predict = lr_model.predict(X_test_scaled)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'预测值：'</span>, y_predict)
mse = mean_squared_error(y_test, y_predict)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'正规方程-均方误差：'</span>, mse)
</code></pre>
<p>运行输出：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[[   8.3252       41.            6.98412698 ...    2.55555556    37.88       -122.23      ]</span>
 <span class="hljs-selector-attr">[   8.3014       21.            6.23813708 ...    2.10984183    37.86       -122.22      ]</span>
 <span class="hljs-selector-attr">[   7.2574       52.            8.28813559 ...    2.80225989    37.85       -122.24      ]</span>
 ...
 <span class="hljs-selector-attr">[   1.7          17.            5.20554273 ...    2.3256351    39.43       -121.22      ]</span>
 <span class="hljs-selector-attr">[   1.8672       18.            5.32951289 ...    2.12320917    39.43       -121.32      ]</span>
 <span class="hljs-selector-attr">[   2.3886       16.            5.25471698 ...    2.61698113    39.37       -121.24      ]</span>] (<span class="hljs-number">20640</span>, <span class="hljs-number">8</span>)
<span class="hljs-selector-attr">[4.526 3.585 3.521 ... 0.923 0.847 0.894]</span>
<span class="hljs-selector-attr">[<span class="hljs-string">'MedInc'</span>, <span class="hljs-string">'HouseAge'</span>, <span class="hljs-string">'AveRooms'</span>, <span class="hljs-string">'AveBedrms'</span>, <span class="hljs-string">'Population'</span>, <span class="hljs-string">'AveOccup'</span>, <span class="hljs-string">'Latitude'</span>, <span class="hljs-string">'Longitude'</span>]</span>
权重系数： <span class="hljs-selector-attr">[ 0.83275185  0.1173856  -0.27597663  0.29900186 -0.00795271 -0.03963673 -0.88241635 -0.85338011]</span>
偏置值： <span class="hljs-number">2.0678235537788865</span>
预测值： <span class="hljs-selector-attr">[1.58299034 3.01567949 1.75417605 ... 1.84161594 2.81049138 1.16693905]</span>
正规方程-均方误差： <span class="hljs-number">0.5410055769085323</span>
​
Process finished with exit <span class="hljs-selector-tag">code</span> <span class="hljs-number">0</span>
</code></pre>
<p>线性回归-梯度下降使用 SGDRegressor</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> fetch_california_housing
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> SGDRegressor
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
​
<span class="hljs-comment"># 1,加载数据</span>
california = fetch_california_housing()
<span class="hljs-built_in">print</span>(california.data, california.data.shape)
<span class="hljs-built_in">print</span>(california.target)
<span class="hljs-built_in">print</span>(california.feature_names)
​
<span class="hljs-comment"># 2,数据预处理</span>
X_train, X_test, y_train, y_test = train_test_split(california.data, california.target, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">20</span>)
scaler = StandardScaler()  <span class="hljs-comment"># 数据标准化：消除不同特征量纲的影响</span>
X_train_scaled = scaler.fit_transform(X_train)  <span class="hljs-comment"># fit计算生成模型，transform通过模型转换数据</span>
X_test_scaled = scaler.transform(X_test)  <span class="hljs-comment"># # 使用训练集的参数转换测试集</span>
​
<span class="hljs-comment"># 3,创建和训练线性回归模型(梯度下降)</span>
lr_model = SGDRegressor()  <span class="hljs-comment"># 创建分类器实例</span>
lr_model.fit(X_train_scaled, y_train)  <span class="hljs-comment"># 训练模型</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'权重系数：'</span>, lr_model.coef_)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'偏置值：'</span>, lr_model.intercept_)  <span class="hljs-comment"># 在线性回归模型中，•偏置（截距）•（bias）是模型参数之一，表示当所有特征值为0时，目标变量的期望值。</span>
​
<span class="hljs-comment"># 4，模型评估</span>
y_predict = lr_model.predict(X_test_scaled)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'预测值：'</span>, y_predict)
mse = mean_squared_error(y_test, y_predict)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'梯度下降方程-均方误差：'</span>, mse)
</code></pre>
<p>运行输出：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[[   8.3252       41.            6.98412698 ...    2.55555556    37.88       -122.23      ]</span>
 <span class="hljs-selector-attr">[   8.3014       21.            6.23813708 ...    2.10984183    37.86       -122.22      ]</span>
 <span class="hljs-selector-attr">[   7.2574       52.            8.28813559 ...    2.80225989    37.85       -122.24      ]</span>
 ...
 <span class="hljs-selector-attr">[   1.7          17.            5.20554273 ...    2.3256351    39.43       -121.22      ]</span>
 <span class="hljs-selector-attr">[   1.8672       18.            5.32951289 ...    2.12320917    39.43       -121.32      ]</span>
 <span class="hljs-selector-attr">[   2.3886       16.            5.25471698 ...    2.61698113    39.37       -121.24      ]</span>] (<span class="hljs-number">20640</span>, <span class="hljs-number">8</span>)
<span class="hljs-selector-attr">[4.526 3.585 3.521 ... 0.923 0.847 0.894]</span>
<span class="hljs-selector-attr">[<span class="hljs-string">'MedInc'</span>, <span class="hljs-string">'HouseAge'</span>, <span class="hljs-string">'AveRooms'</span>, <span class="hljs-string">'AveBedrms'</span>, <span class="hljs-string">'Population'</span>, <span class="hljs-string">'AveOccup'</span>, <span class="hljs-string">'Latitude'</span>, <span class="hljs-string">'Longitude'</span>]</span>
权重系数： <span class="hljs-selector-attr">[ 9.00030244e-01  1.20593849e-01 -5.13860669e-01  2.43337638e-01 -5.14784939e-04 -1.24408200e-01 -7.15071233e-01 -6.91217595e-01]</span>
偏置值： <span class="hljs-selector-attr">[2.05038682]</span>
预测值： <span class="hljs-selector-attr">[1.67351153 2.91473399 1.719945   ... 1.93827611 2.66340199 1.29512693]</span>
梯度下降方程-均方误差： <span class="hljs-number">0.711588824356649</span>
</code></pre>
<h2 data-id="heading-6">7，回归性能评估</h2>
<p>均方误差（Mean Squared Error，MSE）是回归问题中常用的性能评估指标之一，它衡量了模型预测值与真实值之间的差异。MSE的公式如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df97952a736f42caa831530b7492814c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770345821&amp;x-signature=OwmgZDsbSAt8k0vax8QBFX%2Ftx3M%3D" alt="image.png" loading="lazy"/></p>
<p>在 <code>scikit-learn</code> 中，计算均方误差非常简单，可以通过 <code>mean_squared_error</code> 函数来实现：</p>
<pre><code class="hljs language-ini" lang="ini">mean_squared_error(
    y_true, 
    y_pred, 
    *, 
    <span class="hljs-attr">sample_weight</span>=None, 
    <span class="hljs-attr">multioutput</span>=<span class="hljs-string">'uniform_average'</span>, 
    <span class="hljs-attr">squared</span>=<span class="hljs-literal">True</span>
)
</code></pre>
<p>参数详解：</p>
<p><strong>1. <code>y_true</code> : array-like of shape (n_samples,) or (n_samples, n_outputs)</strong></p>
<ul>
<li><strong>功能</strong>：<strong>真实值</strong>（Ground Truth / Actual Values）。</li>
<li><strong>要求</strong>：这是必需的定位参数（必须提供）。</li>
<li><strong>格式</strong>：可以是一维数组（单输出问题）或二维数组（多输出问题）。</li>
</ul>
<p><strong>2. <code>y_pred</code> : array-like of shape (n_samples,) or (n_samples, n_outputs)</strong></p>
<ul>
<li><strong>功能</strong>：<strong>预测值</strong>（Predicted Values）。</li>
<li><strong>要求</strong>：这是必需的定位参数（必须提供）。</li>
<li><strong>格式</strong>：必须与 <code>y_true</code> 具有相同的形状。</li>
</ul>
<p><strong>3. <code>sample_weight</code> : array-like of shape (n_samples,), default=None</strong></p>
<ul>
<li>
<p><strong>功能</strong>：<strong>样本权重</strong>。用于给每个样本的损失赋予不同的重要性。</p>
</li>
<li>
<p><strong>详解</strong>：</p>
<ul>
<li><code>None</code> (默认)：所有样本的权重相等。</li>
<li>提供权重数组：权重大的样本，其预测误差对最终 MSE 的贡献也更大。</li>
</ul>
</li>
<li>
<p><strong>应用场景</strong>：</p>
<ul>
<li>某些样本在业务上更重要，需要模型更准确地预测它们。</li>
<li>处理类别不平衡的回归问题（虽然不常见）。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“能用”到“会用”｜如何写好一个 Skill]]></title>    <link>https://juejin.cn/post/7600791597168525355</link>    <guid>https://juejin.cn/post/7600791597168525355</guid>    <pubDate>2026-01-30T02:46:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600791597168525355" data-draft-id="7600705405595680831" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“能用”到“会用”｜如何写好一个 Skill"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-30T02:46:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“能用”到“会用”｜如何写好一个 Skill
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T02:46:58.000Z" title="Fri Jan 30 2026 02:46:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9c0d4f435e6430bbe05365a720ccfc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=EnVG%2Fo7Afg%2BjIrUumxfjzeeaoBM%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：Jiaqi，TRAE 技术文档工程师</p>
</blockquote>
<p>之前带大家了解了 Skill 的原理和应用，本文继续带领大家从“能用”到“会用”，如何写好一个 Skill 至关重要。</p>
<p>本文为 Skill 设计与开发的一站式最佳实践指南，可助力你：</p>
<ul>
<li>
<p>系统厘清 Skill 的定义，规避常见认知误区；</p>
</li>
<li>
<p>熟练掌握高命中率、高稳定性 Skill 的设计标准与核心原则；</p>
</li>
<li>
<p>掌握 “评测驱动、失败优先” 的工程化 Skill 构建与迭代全流程；</p>
</li>
<li>
<p>掌握可维护、可扩展的 Skill 设计技巧；</p>
</li>
<li>
<p>依托 AI 高效完成 Skill 的创建、迭代与优化；</p>
</li>
<li>
<p>凭借反模式检查清单，精准规避 Skill 开发中的典型问题。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/925c335469a84e45b9fc343d9d93c2e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=ycqzZY6cdm9Et6BSGzR615Xm0k4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>什么是 Skill ？</strong></h2>
<h3 data-id="heading-1"><strong>定义</strong></h3>
<p>一个 Skill 是一份清晰、严谨、可执行的指令文档，用于明确告诉模型——在什么条件下（When），按照哪些步骤（How），产出什么结果（What）。</p>
<h3 data-id="heading-2"><strong>常见认知误区</strong></h3>
<p>在编写 Skill 之前，建议先了解以下几个常见误区。这些问题往往会直接导致 Skill 难以被正确触发，或在执行过程中表现不稳定。</p>
<h4 data-id="heading-3"><strong>误区一：Skill 等同于一段 Prompt</strong></h4>
<p>Skill 并不是一次性的对话提示。它是一个可长期复用、输入输出明确的能力模块，强调的是稳定、确定且易于工程化维护。而 Prompt 更偏向临时性、探索性和即兴交互，两者在设计目标和工程要求上完全不同。</p>
<h4 data-id="heading-4"><strong>误区二：Skill 是写给人看的文档</strong></h4>
<p>Skill 的目标不是“解释原理”，而是“下达指令”。<em><strong>SKILL.md</strong></em> 文件的内容应使用模型可解析的结构化语言，明确约束其行为边界，并精确描述何时使用（When）、如何执行（How）、输出结果（What）。</p>
<h4 data-id="heading-5"><strong>误区三：Skill 越复杂越强大</strong></h4>
<p>复杂度并不与 Skill 的能力强度挂钩。模型的推理与决策成本是显著的。职责单一、边界清晰的 Skill，更容易在正确的时机被选中并稳定执行。过于复杂的 Skill 反而会降低命中率。</p>
<blockquote>
<p><strong>提示</strong></p>
<p>模型的上下文窗口是有限且宝贵的公共资源。每一个被加载的 Skill 都在竞争有限的上下文资源。因此，Skill 文档应以最小必要信息为目标，避免冗余解释与不必要的背景铺垫。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f9fd9d99d4047fa8df1e73e23df891c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=uDLhWnSoobz5eZoAjTmk8YL%2BmDs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>Skill 的设计标准与原则</strong></h2>
<p>以下标准是构建高命中率、高稳定性 Skill 的基础。可将其作为设计与评审 Skill 时的检查清单。</p>
<h3 data-id="heading-7"><strong>精准的元数据内容</strong></h3>
<p>Skill 的元数据（name 和 description）是模型发现和识别 Skill 的入口，其设计直接影响触发准确率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53534cd0028341789f32667c4427b688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=YOgSk2PwZtiIGJDAormvbgAGyfE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>指导方式的自由度分级</strong></h3>
<p>根据任务复杂度与容错要求，合理控制对模型的约束强度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bc1d5de6fd847b2b5dbf8b68923f31d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=IyvLxWY9rbntzp6XCvirBaSUV6U%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78b641e70e0e4917b62abf1f3c6a1263~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=k8mmW9gcXOzIXm5XdeflXRSmw1o%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbc3071a12bc450bb88de44cca330f90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=BMRsq4GG52LqbCzOp6mbk0nWA8k%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>五个核心标准</strong></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d624809950da4cd7b3a3cd97aa59cbc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=SCKvYQOUGryiT1G91F0G5r4K8q4%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cb9b5ff3cd246038a73415d07af4a56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=fNs8IAyTWdP0mlCiJV7ba%2FUyNCU%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8a10f6a22b7449fb81436025c675cdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=WOsFr0%2F%2BeAf%2B3e9bUdIze6U5CsE%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15d69e9c2c6643409a36c1574ce343c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=Zf2VKaN41J0lDfMMi2VtmrJIYps%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d391f9bcc214bfd9e5770929c104d33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=chGm%2FO9oemdfLk5DIg5FLn30Tow%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10"><strong>构建与迭代 Skill 的最佳流程</strong></h2>
<p>Skill 的开发是一个以失败为起点、评测为牵引，持续迭代优化的工程化过程。</p>
<p>评测并非事后的验证环节，而是 Skill 设计的前提；Skill 也非基于假设的规则集合，而是针对已暴露问题的最小化解决方案。</p>
<p>遵循 “评测驱动、失败优先” 的原则，能确保 Skill 在实际使用场景中拥有清晰的能力边界、稳定的运行表现，以及可回归的质量保障体系。</p>
<h3 data-id="heading-11"><strong>第一步：建立无 Skill 基线，识别真实问题</strong></h3>
<p>在编写任何 Skill 之前，应先不使用 Skill，直接让模型执行目标任务，作为基线对照。</p>
<p>重点观察并记录以下问题：</p>
<ul>
<li>
<p>模型在哪些情况下表现不稳定或结果不可复现；</p>
</li>
<li>
<p>哪些输入会引发歧义、误解或走偏；</p>
</li>
<li>
<p>模型是否在错误的时机尝试“主动帮忙”。</p>
</li>
</ul>
<p>这些失败点和不确定行为，本质上就是 Skill 需要解决的真实能力缺口，也是后续评测用例的来源。</p>
<h3 data-id="heading-12"><strong>第二步：以“失败优先”为原则，定义评测用例</strong></h3>
<p>明确核心问题后，需优先编写评测用例，而非直接开发 Skill。评测是约束，Skill 是落地实现。脱离评测约束的 Skill，本质上是在放大模型的行为不确定性。</p>
<p>评测的核心作用是约束 Skill 的行为边界，明确以下信息：</p>
<ul>
<li>
<p>什么场景下属于 Skill 的正确使用范围？</p>
</li>
<li>
<p>什么场景下 Skill 必须拒绝执行或判定为失败？</p>
</li>
<li>
<p>什么样的输出结果才算稳定可用？</p>
</li>
</ul>
<p>推荐做法：</p>
<ul>
<li>
<p>针对已识别的问题，设计 3–5 个具体、可复现的评测用例；</p>
</li>
<li>
<p>每个用例均需明确 “通过 / 失败” 的判定标准；</p>
</li>
<li>
<p>优先覆盖模型最易误用 Skill 的场景。</p>
</li>
</ul>
<h3 data-id="heading-13"><strong>第三步：编写最小化 Skill，明确最短成功路径</strong></h3>
<p>在评测已经存在的前提下，开始编写 Skill。</p>
<p>此阶段不追求覆盖所有情况，而是只编写刚好能够通过当前评测的最小规则集合，重点关注三个要素：</p>
<ul>
<li>
<p><strong>明确失败条件（When NOT to use）</strong></p>
<p>将评测中识别的失败场景，显式写入 Skill 中，作为第一层防护，避免 Skill 被误触发或滥用。</p>
</li>
<li>
<p><strong>定义最短成功路径</strong></p>
<p>清晰描述 Skill 最简单、最核心的执行流程，确保最精简的有效输入能得到可预测的稳定输出。</p>
</li>
<li>
<p><strong>保持职责单一</strong></p>
<p>单个 Skill 仅解决一个明确问题，对应一个核心动作，避免在早期引入额外复杂度。</p>
</li>
</ul>
<p>这一阶段的 Skill，是评测结果的直接产物，而非凭经验预判的方案。</p>
<h3 data-id="heading-14"><strong>第四步：补充边界条件与结构化示例</strong></h3>
<p>当最短成功路径能稳定通过评测后，再逐步扩展 Skill 的适用范围。</p>
<p>完成以下三项核心工作：</p>
<ul>
<li>
<p>补充更多边界场景及对应的行为约束；</p>
</li>
<li>
<p>明确 Skill 输入（Input）、输出（Output）的结构化定义；</p>
</li>
<li>
<p>补充关键的输入、输出示例，帮助模型对齐行为预期。</p>
</li>
</ul>
<p><strong>核心原则：</strong> 所有新增规则，均需对应新增或已有评测用例，避免在无评测支撑的情况下将 Skill 复杂化。</p>
<h3 data-id="heading-15"><strong>第五步：评测回归与持续迭代</strong></h3>
<p>Skill 的迭代，需始终与评测结果强绑定，遵循以下规则：</p>
<ul>
<li>
<p>新增评测用例 → 推动 Skill 的增量修改；</p>
</li>
<li>
<p>任意修改 Skill → 必须通过已有评测的回归验证；</p>
</li>
<li>
<p>若评测未通过，优先简化 Skill，而非盲目叠加新规则。</p>
</li>
</ul>
<p>通过持续对比模型在 “无 Skill 基线” 与 “当前 Skill + 评测” 中的表现，可验证该 Skill 是否真正提升了模型执行目标任务的成功率与稳定性。</p>
<h3 data-id="heading-16"><strong>第六步：结合真实使用路径进行校准</strong></h3>
<p>评测仅能覆盖已知问题，在真实场景中使用 Skill 时，可能会暴露更多新的问题。</p>
<p>在 Skill 实际使用过程中，需持续观察以下情况：</p>
<ul>
<li>
<p>模型是否在非预期场景下误触发 Skill？</p>
</li>
<li>
<p>模型执行 Skill 时，是否遗漏关键参考文件或上下文？</p>
</li>
<li>
<p>模型是否会反复读取某一段内容，形成隐性依赖？</p>
</li>
</ul>
<p>上述这些信号，均需作为新的评测输入，重新进入 Step 2，形成 Skill 迭代的闭环。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d6496cadbc45959bca9dc12167b952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=kcFreYXQ%2FmdWP%2BvqH%2F9CTAzvFiM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-17"><strong>让 Skill 可维护与可拓展</strong></h2>
<h3 data-id="heading-18"><strong>渐进式披露</strong></h3>
<p><em><strong>SKILL.md</strong></em> 应当作为 Skill 的入口和导航，而不是一个包罗万象的大文件。详细的参考资料、示例、脚本或文档应拆分成独立文件，从而减轻模型初次加载的负担，让信息按需流动。</p>
<h4 data-id="heading-19"><strong>信息架构原则：从简单到复杂</strong></h4>
<p>​一个 Skill 的目录可以随着功能扩展逐步演化：从单一文件 → 多个参考文件和脚本组成的结构。通过渐进式披露，模型能快速抓住核心信息，再深入了解细节。</p>
<h4 data-id="heading-20"><strong>最佳实践</strong></h4>
<ul>
<li>
<p><strong>保持 SKILL.md 简洁：</strong> 主体内容尽量控制在 500 行以内，只包含必要信息。</p>
</li>
<li>
<p><strong>避免深度嵌套：</strong> 所有引用文件最好直接由 <em><strong>SKILL.md</strong></em> 链接，保持一层引用深度，避免链式引用（A → B → C），防止模型只读取部分内容。</p>
</li>
<li>
<p><strong>为长文件添加目录：</strong> 对于超过 100 行的参考文件，在文件顶部添加一个目录（Table of Contents），帮助模型快速了解文件结构。</p>
</li>
</ul>
<h4 data-id="heading-21"><strong>示例</strong></h4>
<p>以下为一个渐进式披露的 SKILL.md 示例：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># SKILL.md</span>

<span class="hljs-section">## 基础用法</span>
描述如何触发 CI/CD 流水线：
<span class="hljs-bullet">-</span> 检查 PR 状态
<span class="hljs-bullet">-</span> 执行单元测试
<span class="hljs-bullet">-</span> 更新 PR 测试状态

<span class="hljs-section">## 高级功能</span>
详细说明请参见 <span class="hljs-code">`ci-advanced-features.md`</span>：
<span class="hljs-bullet">-</span> 并行执行多分支测试
<span class="hljs-bullet">-</span> 条件触发不同类型的测试
<span class="hljs-bullet">-</span> 自定义失败处理策略

<span class="hljs-section">## API 参考</span>
所有方法与参数说明请参见 <span class="hljs-code">`ci-api-reference.md`</span>：
<span class="hljs-bullet">-</span> startPipeline(prId: string, branch: string)
<span class="hljs-bullet">-</span> getPipelineStatus(pipelineId: string)
<span class="hljs-bullet">-</span> cancelPipeline(pipelineId: string)
</code></pre>
<h3 data-id="heading-22"><strong>工作流与反馈闭环</strong></h3>
<p>对于包含多个步骤、且中间结果会影响最终质量的复杂任务，仅提供最终目标是不够的。必须显式定义工作流（Workflow）和 检查清单（Checklist），引导模型按步骤执行，并在关键节点建立 “验证 → 修正 → 再验证” 的反馈闭环。</p>
<p>工作流负责约束任务执行顺序，检查清单负责追踪任务的执行状态和质量。两者结合可以显著降低遗漏和跑偏的风险。</p>
<h4 data-id="heading-23"><strong>分析类任务的工作流</strong></h4>
<p>即使不涉及代码，分析类任务同样适合使用工作流。 检查清单可以帮助模型明确“当前做到哪一步”、“是否可以进入下一步”。例如：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">## 技术方案评估工作流

在开始执行前复制以下清单，并在每一步完成后显式标记状态。

- <span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>：明确业务目标与技术约束（性能、成本、时限）
- <span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>：列出所有可行的技术方案
- <span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>：从复杂度、可维护性、风险角度逐一评估
- <span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>：对关键差异点进行对比分析；(反馈闭环) 若发现关键信息不足，应返回 <span class="hljs-keyword">Step</span> <span class="hljs-number">2</span> 或 <span class="hljs-keyword">Step</span> <span class="hljs-number">3</span> 补充分析
- <span class="hljs-keyword">Step</span> <span class="hljs-number">5</span>：给出结论性建议，并说明取舍理由；(反馈闭环) 若结论无法支撑目标约束，应重新审视 <span class="hljs-keyword">Step</span> <span class="hljs-number">1</span> 的前提条件
</code></pre>
<h4 data-id="heading-24"><strong>代码类任务的工作流</strong></h4>
<p>​代码类任务往往伴随不可逆或影响范围较大的操作，例如重构、依赖升级或配置变更。通过 “Plan → Validate → Execute” 模式，可以有效降低误操作风险。例如：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 依赖版本升级工作流</span>

<span class="hljs-bullet">-</span> Step 1（Plan）：
<span class="hljs-bullet">  -</span> 识别需要升级的依赖及当前版本
<span class="hljs-bullet">  -</span> 阅读目标版本的 Release Notes 与 Breaking Changes
<span class="hljs-bullet">-</span> Step 2（Plan）：
<span class="hljs-bullet">  -</span> 更新依赖配置文件（如 package.json / go.mod）
<span class="hljs-bullet">  -</span> 标注可能受影响的模块
<span class="hljs-bullet">-</span> Step 3（Validate）：
<span class="hljs-bullet">-</span> 执行依赖冲突检查与静态构建（运行 dependency<span class="hljs-emphasis">_check.sh）
  - 确认无版本冲突或构建失败
  - (反馈闭环) 若校验失败，必须回退到 Step 2 调整依赖配置
- Step 4（Execute）：
  - 安装新版本依赖
  - 运行完整测试集
- Step 5（Validate）：
  - 检查核心功能是否受影响
  - 对比升级前后的构建与运行结果
  - (反馈闭环) 若出现回归问题，应回滚升级并记录风险点
</span></code></pre>
<h3 data-id="heading-25"><strong>可执行脚本的加固原则</strong></h3>
<p>当 Skill 依赖可执行脚本时，脚本的健壮性应始终优先于代码的巧妙性。</p>
<p>Skill 本身不会理解或阅读你的代码逻辑，它只感知输入与输出。一旦脚本行为不可预测，模型就只能猜测，最终导致不稳定或错误的调用结果。因此，脚本必须做到：失败可预期、输出可理解、参数可解释。</p>
<h4 data-id="heading-26"><strong>显式处理错误，而不是让模型猜</strong></h4>
<p>不要将异常直接抛给模型处理。脚本应覆盖常见错误场景，并将技术异常转化为可理解、可决策的输出。</p>
<p><strong>实践要点：</strong></p>
<ul>
<li>
<p>捕获常见异常（如文件缺失、权限不足、配置错误）</p>
</li>
<li>
<p>为每类错误返回清晰的错误原因和下一步建议</p>
</li>
</ul>
<p><strong>示例：</strong> 配置文件校验脚本</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">ERROR:</span> Config file <span class="hljs-built_in">not</span> found: ./deploy.yaml
<span class="hljs-symbol">HINT:</span> Please check whether the file path <span class="hljs-built_in">is</span> correct <span class="hljs-built_in">or</span> run init-config.sh <span class="hljs-keyword">to</span> generate a <span class="hljs-keyword">default</span> config.
</code></pre>
<h4 data-id="heading-27"><strong>输出自解释的日志与验证结果</strong></h4>
<p>脚本的输出本身就是模型的“上下文”。一个好的脚本不仅说明发生了什么，还说明为什么会这样，以及接下来可以怎么做。</p>
<p><strong>实践要点：</strong></p>
<ul>
<li>
<p>成功路径和失败路径都要有明确输出</p>
</li>
<li>
<p>验证类脚本应明确列出通过项与失败项</p>
</li>
</ul>
<p><strong>示例：</strong> 构建环境检查脚本</p>
<pre><code class="hljs language-markdown" lang="markdown">CHECK FAILED: Node.js version mismatch
<span class="hljs-bullet">-</span> Required: &gt;= 18.0.0
<span class="hljs-bullet">-</span> Detected: 16.14.0

VALID OPTIONS:
<span class="hljs-bullet">1.</span> Upgrade Node.js to a supported version
<span class="hljs-bullet">2.</span> Switch to a compatible build image
</code></pre>
<h4 data-id="heading-28"><strong>避免魔法数字，让参数“有来由”</strong></h4>
<p>脚本中的常量（如 <em><strong>TIMEOUT = 30</strong></em>）如果缺乏解释，模型和人都无法判断它是否合理。任何影响行为的数值，都应该是可解释、可调整的。</p>
<p><strong>实践要点：</strong></p>
<ul>
<li>
<p>为常量添加语义化名称</p>
</li>
<li>
<p>说明数值来源或设计依据</p>
</li>
<li>
<p>必要时允许通过参数覆盖默认值</p>
</li>
</ul>
<p><strong>示例：</strong> 部署等待脚本</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">TIMEOUT_SECONDS</span> = <span class="hljs-number">30</span>  <span class="hljs-comment"># Wait up to 30s because service startup usually completes within 10–20s</span>
</code></pre>
<p>或在输出中体现：</p>
<pre><code class="hljs language-rust" lang="rust">INFO: Waiting <span class="hljs-keyword">for</span> <span class="hljs-title class_">service</span> to <span class="hljs-keyword">become</span> <span class="hljs-title function_ invoke__">healthy</span> (timeout: <span class="hljs-number">30</span>s)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0086657e4fc4b938f0676a145dfc9b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=2Vt0GyoX2JxUwMqALNQawCWmxZU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-29"><strong>巧妙使用 AI 来创建和迭代 Skill</strong></h2>
<p>在创建和迭代 Skill 的过程中，可以多用 AI。你负责定义问题和验收结果，AI 负责反复试错、总结规律并封装成可复用的 Skill。</p>
<h3 data-id="heading-30"><strong>阶段一：初次创建（从具体任务中抽象）</strong></h3>
<p>让 AI 从真实任务中抽象出创建 Skill 所需的信息，然后创建初版 Skill。</p>
<p><strong>1. 让 AI 直接执行真实任务</strong></p>
<p>提供完整目标与上下文，让 AI 自行尝试完成任务。执行过程中的追问、走偏和修正，本质上就是一次“隐式评测”。</p>
<p><strong>2. 引导 AI 进行结构化复盘</strong></p>
<p>任务完成后，要求 AI 从以下维度复盘：</p>
<ul>
<li>
<p>成功执行任务的完整步骤；</p>
</li>
<li>
<p>任务执行过程中的不确定性与失败点；</p>
</li>
<li>
<p>可抽象的固定流程与判断逻辑；</p>
</li>
<li>
<p>该流程和判断逻辑的适用场景与不适用场景。</p>
</li>
</ul>
<p><strong>3. 基于复盘生成 Skill 初稿</strong></p>
<p>要求 AI 按 Skill 规范生成 SKILL.md，明确：触发条件（When）、如何执行（How）、输出结果（What）、预设失败策略。</p>
<p><strong>4. 人工快速评审并入库</strong></p>
<p>你只需关注边界是否合理、步骤是否可执行，其余交由 AI 完成。确认后，让 AI 调用 skills-creator 正式创建该 Skill 并添加至你的项目。</p>
<h3 data-id="heading-31"><strong>阶段二：持续迭代（从使用反馈中优化）</strong></h3>
<p>当 Skill 在使用中暴露新问题时，对其进行优化。</p>
<p><strong>1. 对齐偏差来源</strong></p>
<p>引导 AI 分析问题源自 When / What / How 中的哪一部分。</p>
<p><strong>2. 直接修改 Skill 并验证回归</strong></p>
<p>更新 <em><strong>SKILL.md</strong></em>，并同时验证：</p>
<ul>
<li>
<p>确保本次迭代未破坏原有的“黄金路径”。</p>
</li>
<li>
<p>确保新发现的错误场景已被覆盖。</p>
</li>
</ul>
<h3 data-id="heading-32"><strong>在 TRAE 中创建 Skill 的其他方式</strong></h3>
<p>除了通过 AI 对话创建 Skill 外，你还以手动创建或导入外部 Skill。详细说明点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.trae.cn%2Fide%2Fskills%238be9a856" target="_blank" title="https://docs.trae.cn/ide/skills#8be9a856" ref="nofollow noopener noreferrer">docs.trae.cn/ide/skills#…</a> 参考官网文档。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/079af5a4818e47c0abe69194cf5b2ad3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=sFYVsv%2B6UlM299EIXgHtazNh9%2BI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-33"><strong>附录：反模式检查清单</strong></h2>
<p>本表列出了在 Skill 开发中常见的反模式（Anti-Patterns），以及相应的原因、正确示例和错误示例。通过遵循这些规范，可以提升 Skill 的稳定性、可维护性和跨平台兼容性，避免模型误用或运行失败。</p>
<p>该 Checklist 可作为开发、评审和迭代 Skill 时的快速参考指南。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c50126de01144477b68e1e339e618485~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770346155&amp;x-signature=%2B5t%2FNmIBG5pQxC%2FXhVVOD0SYUeg%3D" alt="" loading="lazy"/></p>
<p><strong>参考资料</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fzh-CN%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/zh-CN/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/zh-CN/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderA2UI 总体设计：AI 驱动的架构师友好界面]]></title>    <link>https://juejin.cn/post/7600706866785419307</link>    <guid>https://juejin.cn/post/7600706866785419307</guid>    <pubDate>2026-01-30T03:57:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600706866785419307" data-draft-id="7600710943250481194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderA2UI 总体设计：AI 驱动的架构师友好界面"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-30T03:57:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderA2UI 总体设计：AI 驱动的架构师友好界面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T03:57:00.000Z" title="Fri Jan 30 2026 03:57:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ooderA2UI 总体设计：AI 驱动的架构师友好界面</h2>
<h3 data-id="heading-1">前言：ooderAgent 发布衔接</h3>
<p>ooderAgent 的正式发布标志着 Ooder 生态系统进入智能开发时代。作为一个基于插件架构的技能系统，ooderAgent 通过实现 <code>Skill</code> 接口扩展 IDE 能力，支持本地和远程技能两种模式。这一发布为 ooderA2UI 的诞生奠定了坚实基础，提供了技能注册、发现、执行的完整框架。</p>
<p><strong>核心价值</strong>：ooderAgent 不仅是一个插件系统，更是一个分布式能力中心，通过 API Bridge 实现远程技能调用，为后续的 A2UI 交互提供了必要的技术支撑。</p>
<h2 data-id="heading-2">一、A2UI 与 ooderAI 背景</h2>
<h3 data-id="heading-3">1.1 A2UI 背景</h3>
<p>A2UI（Architect-to-UI）是一种面向架构师的智能界面设计理念，旨在通过 AI 辅助，将架构师的设计意图直接转换为高质量的用户界面。它解决了传统开发中架构设计与前端实现之间的鸿沟，实现了从架构到 UI 的直接映射。在企业级应用场景中，A2UI 进一步突破了技术与业务的壁垒，成为连接架构设计、产品需求与落地实现的核心枢纽，其价值在架构师与产品经理的协同工作中尤为凸显。</p>
<h3 data-id="heading-4">1.2 ooderAI 背景</h3>
<p>ooderAI 是 Ooder 生态系统的智能核心，基于大语言模型（LLM）构建，专注于代码生成、架构理解和开发流程优化。它通过三级 SKILLS 体系，实现从自然语言到完整系统的转换，为 A2UI 提供了强大的智能引擎。不同于普通 A2UI 技术，ooderA2UI 依托 ooderAI 的工程感知能力和 ooderAgent 的插件扩展能力，更适配企业级应用的规模化、标准化、高可用需求，既能满足架构师的技术架构诉求，也能契合产品经理的业务落地需求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75c11db4a66144889d8153c96f09a4de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350220&amp;x-signature=JRmzaHYmVBL8eKjvxShPzQtKvoo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">二、ooderA2UI 总体设计</h2>
<h3 data-id="heading-6">2.1 核心架构</h3>
<p>ooderA2UI 采用分层架构设计，将 UI 生成过程分为三个核心层次：</p>
<h4 data-id="heading-7">2.1.1 视图结构层</h4>
<ul>
<li><strong>Component 基础组件类</strong>：定义组件的基本属性和行为</li>
<li><strong>ComponentList 组件列表管理</strong>：管理组件集合</li>
<li><strong>自定义组件实现</strong>：提供特定类型的组件功能</li>
<li><strong>组件层次树构建</strong>：通过父子关系构建组件树</li>
</ul>
<h4 data-id="heading-8">2.1.2 ViewBean 层</h4>
<ul>
<li><strong>CustomViewBean 抽象基类</strong>：视图模型的根本数据对象</li>
<li><strong>1:1 前端 JSON 对应</strong>：与前端的"四分离JSON"存在严格的 1:1 对应关系</li>
<li><strong>Annotation 映射机制</strong>：通过注解实现与后端代码的映射</li>
<li><strong>领域模型驱动设计</strong>：采用领域驱动设计思想，将 UI 组件抽象为领域模型</li>
</ul>
<h4 data-id="heading-9">2.1.3 OnecCode 层</h4>
<ul>
<li><strong>注解驱动代码生成</strong>：基于注解生成代码</li>
<li><strong>前后端代码结构</strong>：生成前端代码和后端代码</li>
<li><strong>服务支撑框架</strong>：集成菜单导航、安全认证等系统功能</li>
<li><strong>部署配置管理</strong>：生成部署和运行配置</li>
</ul>
<h3 data-id="heading-10">2.2 LLM 三级 SKILLS 工作流程</h3>
<h4 data-id="heading-11">2.2.1 第一级：预缓存与自然语言处理</h4>
<ol>
<li>
<p><strong>CustomView 预设缓存</strong>： - 预先定义和缓存常用的 CustomView 模板 - 建立视图类型与实现的映射关系</p>
</li>
<li>
<p><strong>自然语言处理</strong>： - 分析用户输入的自然语言需求（兼顾架构师的技术规范和产品经理的业务描述） - 完成 module、page、customView 的划分 - 初步确定视图类型和结构，同步匹配业务需求与技术规范</p>
</li>
</ol>
<h4 data-id="heading-12">2.2.2 第二级：前端组装与代码生成</h4>
<ol>
<li>
<p><strong>customViewBean 转换</strong>： - 根据第一级分析结果生成 customViewBean (JSON 结构) - 构建符合领域模型的视图结构</p>
</li>
<li>
<p><strong>前端组件组装</strong>： - 基于 customViewBean 组装前端 components - 通过 RAD 工具提供可视化预览，方便产品经理确认业务交互合理性、架构师校验技术可行性 - 允许用户进行交互式调整，支持双视角协同修改</p>
</li>
<li>
<p><strong>代码组装</strong>： - LLM 根据调整后的结构生成代码 - 确保代码符合工程规范和用户偏好，兼顾企业级应用的可维护性和可扩展性</p>
</li>
</ol>
<h4 data-id="heading-13">2.2.3 第三级：系统级封装与用户确认</h4>
<ol>
<li>
<p><strong>系统级封装</strong>： - 集成菜单导航系统 - 实现安全认证机制 - 构建代码部署结构 - 完成系统级配置，适配企业级应用的规模化部署需求</p>
</li>
<li>
<p><strong>A2UI 交互确认</strong>： - 通过 A2UI 向用户展示生成结果，分别提供技术视角（架构师）和业务视角（产品经理）的确认维度 - 提供页面权限、交互流程、用户喜好等选项，兼顾技术合规与业务体验 - 用户确认后进行最终调整，实现双视角需求的统一落地</p>
</li>
</ol>
<h2 data-id="heading-14">三、技术实现要点</h2>
<h3 data-id="heading-15">3.1 组件系统设计</h3>
<p>ooderA2UI 的组件系统基于泛型设计，支持类型安全的组件创建和管理。核心实现包括：</p>
<ul>
<li><strong>Component&lt;T extends Properties, K extends EventKey&gt;</strong> ：基础组件类，支持属性和事件的类型安全管理</li>
<li><strong>组件生命周期</strong>：实现组件的创建、初始化、更新、销毁完整生命周期</li>
<li><strong>事件系统</strong>：基于类型的事件分发机制，支持组件间的通信</li>
<li><strong>序列化支持</strong>：与前端 JSON 结构的双向转换</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9795cf6375ad4d5c853fe09a4cc30df9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350220&amp;x-signature=vSbncafYDajlK3H0jADnHSQFBuY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-16">3.2 CustomViewBean 设计</h3>
<p>CustomViewBean 采用领域驱动设计思想，实现了与前端 JSON 的 1:1 对应：</p>
<ul>
<li><strong>层次化结构</strong>：通过继承体系支持多种视图类型</li>
<li><strong>注解映射</strong>：通过注解实现与后端代码的自动映射</li>
<li><strong>扩展性</strong>：支持自定义视图类型和属性</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4e7b1af0a4d4451b81125c279751983~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350220&amp;x-signature=ef9%2Fu%2BrypZKhYUPxh6lrhdKUQ%2B4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-17">3.3 LLM 集成策略</h3>
<p>ooderA2UI 的核心优势在于 LLM 的深度集成，尤其适配企业级双视角协同需求：</p>
<ul>
<li><strong>上下文管理</strong>：维护设计上下文，确保生成结果的一致性，同步兼容架构师的技术规范和产品经理的业务需求</li>
<li><strong>多模态交互</strong>：支持文本、图像等多种输入方式，适配产品经理的原型描述和架构师的技术文档</li>
<li><strong>反馈机制</strong>：基于双视角用户反馈不断优化生成结果，平衡技术可行性与业务合理性</li>
<li><strong>工程感知</strong>：分析当前工程环境，生成符合工程规范的代码，同时匹配企业级业务场景的落地需求，通过标准化数据映射替代传统代码生成，进一步提升架构一致性与可维护性</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af06559e38d0428ca194e200fee3f7b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770350220&amp;x-signature=8TlroyO9HvxcyMaTc79Eo0nfnRA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-18">四、架构师价值</h2>
<h3 data-id="heading-19">4.1 效率提升</h3>
<p>ooderA2UI 为架构师提供了从设计到实现的直接路径，显著提升开发效率：</p>
<ul>
<li><strong>架构设计直接转换</strong>：减少中间环节，提高设计到实现的转化率</li>
<li><strong>智能代码生成</strong>：避免重复劳动，专注于核心设计</li>
<li><strong>系统级封装</strong>：自动处理通用功能，减少样板代码</li>
</ul>
<h3 data-id="heading-20">4.2 质量保证</h3>
<p>通过 AI 辅助和规范约束，确保生成代码的质量：</p>
<ul>
<li><strong>符合工程规范的代码结构</strong>：遵循最佳实践和编码标准</li>
<li><strong>一致的设计风格</strong>：确保 UI 的视觉一致性</li>
<li><strong>完整的系统集成</strong>：自动处理依赖和配置</li>
</ul>
<h3 data-id="heading-21">4.3 决策支持</h3>
<p>在关键决策点提供智能建议：</p>
<ul>
<li><strong>架构选择建议</strong>：基于项目需求推荐合适的架构模式</li>
<li><strong>技术栈匹配</strong>：根据工程环境选择合适的技术栈</li>
<li><strong>性能优化建议</strong>：识别潜在的性能瓶颈并提供优化方案</li>
</ul>
<h2 data-id="heading-22">五、从架构师与产品经理视角看 A2UI 企业级应用</h2>
<p>A2UI 技术在企业级应用中的核心价值，在于打破架构设计与产品落地之间的壁垒，实现技术可行性与业务合理性的双向兼顾。架构师与产品经理作为企业级应用落地的核心角色，对 A2UI 的需求、价值感知及落地诉求存在差异，但最终目标一致——构建高效、稳定、贴合业务的企业级系统。以下从双视角出发，结合 ooderA2UI 的特性，剖析其企业级应用的核心逻辑与价值体现。</p>
<h3 data-id="heading-23">5.1 架构师视角：以技术合规为核心，赋能企业级规模化落地</h3>
<p>架构师在企业级应用中的核心职责是搭建稳定、可扩展、可维护的技术架构，平衡业务需求与技术成本，确保系统符合企业技术规范、安全合规要求，同时适配规模化部署与长期迭代。ooderA2UI 作为 AI 驱动的架构友好型工具，其企业级应用价值主要体现在以下4个核心维度，同时规避传统开发中的技术痛点：</p>
<h4 data-id="heading-24">5.1.1 降低架构落地成本，提升规模化交付效率</h4>
<p>企业级应用往往具备模块多、层级杂、交互复杂的特点，传统开发模式中，架构师的设计意图需要通过文档传递给前端、后端开发人员，存在理解偏差、落地变形等问题，且重复开发工作量大，规模化交付效率低下。ooderA2UI 支持架构师直接将架构设计（如组件分层、接口规范、权限架构）通过自然语言或模板输入，AI 基于三级 SKILLS 体系自动生成符合架构规范的 UI 代码、后端接口映射及部署配置，实现“设计即落地”。</p>
<h4 data-id="heading-25">5.1.2 确保架构一致性，规避技术债务</h4>
<p>企业级应用的长期迭代中，最核心的技术痛点是“架构漂移”——随着业务迭代、人员变动，后续开发逐渐偏离初始架构规范，导致代码冗余、维护成本攀升、技术债务积累，甚至影响系统稳定性。ooderA2UI 基于架构师预设的技术规范（如组件命名规范、代码风格、接口适配标准、安全合规要求），通过工程感知能力自动校验生成代码的合规性，确保所有 UI 模块、组件交互、数据绑定均符合架构设计，从源头规避架构漂移。</p>
<p>同时，ooderA2UI 的 Component 泛型设计、CustomViewBean 注解映射机制，支持组件的插件式扩展与统一管理，架构师可通过动态注册机制扩展组件类型，无需修改核心架构，既满足业务迭代需求，又确保架构的长期一致性，为企业级应用的长期迭代奠定基础。</p>
<h4 data-id="heading-26">5.1.3 平衡灵活性与规范性，适配企业级复杂场景</h4>
<p>企业级应用往往存在“标准化与个性化并存”的需求——既有通用模块（如登录、导航、数据统计）需要标准化交付，也有行业专属模块需要个性化定制。架构师需要在确保规范的前提下，提供足够的灵活性以适配个性化需求，传统工具难以兼顾二者平衡。</p>
<p>ooderA2UI 采用“架构规范预设+个性化调整”的模式，架构师可预设企业级通用架构模板（如安全认证架构、组件分层架构），AI 基于模板生成标准化模块；同时支持架构师通过 RAD 工具可视化调整个性化模块的组件结构、接口映射，无需修改核心架构规范，既保证了标准化模块的高效交付，又满足了个性化业务场景的需求，实现灵活性与规范性的平衡。</p>
<h4 data-id="heading-27">5.1.4 简化跨团队协同成本，对齐技术与业务认知</h4>
<p>企业级应用的落地需要架构师、产品经理、开发人员、测试人员跨团队协同，传统协同中，架构师的技术设计与产品经理的业务需求往往存在认知偏差，需要反复沟通对齐，协同成本高。ooderA2UI 提供可视化预览功能，架构师生成的 UI 原型的同时，自动展示其技术实现逻辑（如组件层级、接口映射、性能瓶颈），产品经理可直观看到架构设计对应的业务落地效果，架构师也可通过产品经理的反馈，快速调整架构设计中的不合理之处，实现技术与业务的同频对齐。</p>
<p>此外，ooderA2UI 依托 ooderAgent 的分布式技能系统，支持架构师与开发团队共享技能模板、架构规范，确保跨团队开发人员均遵循统一的架构标准，进一步降低协同成本。</p>
<h3 data-id="heading-28">5.2 产品经理视角：以业务价值为核心，实现需求快速落地与验证</h3>
<p>产品经理在企业级应用中的核心职责是挖掘业务需求、定义产品价值，确保系统贴合业务场景、提升用户体验（内部员工或外部客户），同时快速响应业务迭代，验证需求可行性，降低产品试错成本。ooderA2UI 对产品经理的价值，核心是“打破技术壁垒，让产品需求直接落地”，无需依赖开发人员，即可快速将业务需求转化为可预览、可验证的 UI 原型，其企业级应用价值主要体现在以下4个核心维度：</p>
<h4 data-id="heading-29">5.2.1 缩短需求落地周期，快速响应业务迭代</h4>
<p>企业级应用的业务需求往往具备“迭代快、需求杂”的特点，传统模式中，产品经理需要编写详细的需求文档、原型图，传递给开发团队，开发团队再基于文档进行开发，整个流程周期长，难以快速响应业务突发需求。ooderA2UI 支持产品经理直接将业务需求通过自然语言输入，AI 自动生成符合业务需求的 UI 原型，同时实现基础的数据交互逻辑，产品经理可实时预览效果，无需等待开发人员开发。</p>
<h4 data-id="heading-30">5.2.2 降低需求验证成本，规避产品试错风险</h4>
<p>企业级应用的需求往往涉及多部门、多角色，需求的合理性、交互的便捷性直接影响产品价值，传统模式中，需求的验证需要等到开发完成后，通过测试、灰度发布才能进行，若需求不合理，修改成本极高，试错风险大。ooderA2UI 生成的 UI 原型不仅具备可视化效果，还支持基础的交互操作（如按钮点击、表单输入、数据筛选），产品经理可快速将原型分享给业务部门、终端用户，收集反馈意见，验证需求的合理性与交互的便捷性。</p>
<h4 data-id="heading-31">5.2.3 打破技术壁垒，实现需求精准落地</h4>
<p>产品经理往往不具备专业的开发知识，传统模式中，产品需求与技术落地之间存在“断层”——产品经理描述的需求，开发人员可能因技术限制无法实现，或理解偏差导致落地效果与需求不符，需要反复沟通调整，影响需求落地效率。ooderA2UI 支持产品经理直接通过业务语言描述需求，AI 自动将业务需求转化为符合技术规范的 UI 原型，同时结合架构师预设的技术规范，确保需求在技术上具备可行性，避免“需求无法落地”的问题。</p>
<p>同时，ooderA2UI 的可视化调整功能，产品经理可直接修改 UI 布局、交互流程，无需依赖开发人员，实现需求的精准落地。</p>
<h4 data-id="heading-32">5.2.4 聚焦核心业务价值，提升产品竞争力</h4>
<p>企业级应用的核心竞争力在于“贴合业务、提升效率”，产品经理的核心精力应放在挖掘业务需求、优化用户体验上，而非花费大量时间协调开发、跟进需求落地。ooderA2UI 帮助产品经理摆脱对开发人员的依赖，将繁琐的“需求落地、原型制作”工作交给 AI 完成，让产品经理能够聚焦核心业务价值，如优化业务流程、提升终端用户体验、挖掘新的业务增长点。</p>
<h3 data-id="heading-33">5.3 双视角协同：实现企业级应用的“技术+业务”双向共赢</h3>
<p>企业级应用的成功落地，离不开架构师与产品经理的协同配合——架构师确保系统的技术稳定性、可扩展性，产品经理确保系统的业务价值、用户体验，二者缺一不可。ooderA2UI 作为连接双视角的核心工具，实现了“技术规范与业务需求的双向对齐”，其协同价值主要体现在：</p>
<ol>
<li>
<p>需求对齐：产品经理生成的业务原型，可实时同步给架构师，架构师校验原型的技术可行性，若存在技术风险（如性能瓶颈、合规问题），可快速反馈并调整，避免需求落地后再修改；</p>
</li>
<li>
<p>高效协同：架构师预设的技术规范，AI 会自动应用到产品经理生成的原型中，确保原型符合技术标准，无需双方反复沟通对齐；</p>
</li>
<li>
<p>迭代同步：业务迭代过程中，产品经理修改需求原型，架构师可实时看到修改内容，同步调整技术架构适配，确保技术迭代与业务迭代同频，实现“需求修改-架构适配-原型更新”的快速闭环；</p>
</li>
<li>
<p>价值统一：最终落地的系统，既符合架构师的技术规范，确保稳定可扩展，又贴合产品经理的业务需求，实现业务价值最大化，打造“技术合规、业务高效、体验优秀”的企业级应用。</p>
</li>
</ol>
<h2 data-id="heading-34">六、技术挑战与解决方案</h2>
<h3 data-id="heading-35">6.1 架构挑战</h3>
<h4 data-id="heading-36">6.1.1 组件类型扩展</h4>
<p><strong>挑战</strong>：组件类型通过枚举定义，扩展需要修改枚举类</p>
<p><strong>解决方案</strong>：采用动态注册机制，支持组件类型的插件式扩展，避免枚举修改的局限性</p>
<h4 data-id="heading-37">6.1.2 生命周期管理</h4>
<p><strong>挑战</strong>：缺乏明确的组件生命周期定义和管理</p>
<p><strong>解决方案</strong>：实现完整的组件生命周期钩子，支持创建、初始化、更新、销毁各阶段的自定义逻辑</p>
<h4 data-id="heading-38">6.1.3 错误处理</h4>
<p><strong>挑战</strong>：组件操作失败时的错误反馈不够明确</p>
<p><strong>解决方案</strong>：建立统一的异常体系，提供详细的错误信息和恢复机制，确保系统稳定性</p>
<h3 data-id="heading-39">6.2 集成挑战</h3>
<h4 data-id="heading-40">6.2.1 前端框架集成</h4>
<p><strong>挑战</strong>：与现代前端框架的集成不够灵活</p>
<p><strong>解决方案</strong>：提供适配器机制，支持与现代前端框架的无缝集成，实现组件属性的自动映射</p>
<h4 data-id="heading-41">6.2.2 后端服务集成</h4>
<p><strong>挑战</strong>：与后端服务的集成需要手动处理</p>
<p><strong>解决方案</strong>：实现与后端服务的自动集成，完善数据绑定机制，提供与数据库的映射工具</p>
<h4 data-id="heading-42">6.2.3 工具链集成</h4>
<p><strong>挑战</strong>：与开发工具的集成有限</p>
<p><strong>解决方案</strong>：开发组件可视化编辑工具，实现与 IDE 的集成插件，提供组件调试和诊断能力</p>
<h2 data-id="heading-43">七、未来发展</h2>
<h3 data-id="heading-44">7.1 技术演进</h3>
<ul>
<li><strong>AI 能力增强</strong>：提升 LLM 对复杂架构的理解能力和复杂业务需求的解析能力，实现更智能的代码生成和优化，同时强化双视角需求的精准识别，适配企业级复杂场景；提升声明式UI的标准化与兼容性。</li>
<li><strong>云原生支持</strong>：增强对云原生架构的支持，提供容器化部署能力，适配企业级规模化部署、弹性扩展需求，同时支持多租户隔离，满足企业级权限管控要求。</li>
<li><strong>实时协作</strong>：支持架构师、产品经理、开发人员多人实时协作设计，实现架构设计、业务需求、代码开发的实时同步与版本控制，进一步降低跨团队协同成本。</li>
</ul>
<h3 data-id="heading-45">7.2 生态扩展</h3>
<ul>
<li><strong>行业解决方案</strong>：针对金融、电商、政务等特定行业，开发定制化的视图模板、组件库与业务规则，提供行业专属的智能生成解决方案，积累行业最佳实践，适配行业专属的技术规范与业务需求，强化跨场景协同能力。</li>
<li><strong>技能市场</strong>：基于 ooderAgent 的插件架构，搭建官方技能市场，支持第三方开发者发布自定义组件、ViewBean 模板、SKILL 技能，实现技能的发布、共享与交易，丰富生态内容，同时支持架构师、产品经理上传行业专属模板，提升企业级应用落地效率。</li>
<li><strong>低代码平台</strong>：逐步拓展为完整的低代码开发平台，强化可视化设计与智能生成能力，支持更复杂的业务场景，适配不同技术水平的使用者，让产品经理可直接通过低代码平台完成简单业务系统的落地，架构师可聚焦复杂架构的设计与管控，进一步释放双视角价值。</li>
</ul>
<h2 data-id="heading-46">结论</h2>
<p>ooderA2UI 代表了现代 IDE 向智能开发工具演进的重要方向，通过 AI 辅助实现了从架构设计到 UI 实现的直接映射。它不仅是一个技术工具，更是一种新的开发范式，为架构师、产品经理提供了前所未有的协同开发体验，尤其适配企业级应用的规模化、标准化、快速迭代需求，同时融合当前行业最佳实践，具备极强的企业级落地价值。</p>
<p>从企业级应用视角来看，ooderA2UI 的核心价值的是实现“技术与业务的双向共赢”：对架构师而言，它降低了架构落地成本、确保了架构一致性，让架构师能够聚焦核心技术决策，规避技术债务，适配企业级规模化迭代需求；对产品经理而言，它打破了技术壁垒、缩短了需求落地周期，让产品经理能够聚焦核心业务价值，快速验证需求，提升产品竞争力。二者协同配合，依托 ooderAgent 的技能系统和 ooderAI 的智能能力，ooderA2UI 构建了一个完整的从需求到实现的闭环，显著提升了企业级应用的开发效率和产品质量。</p>
<p>这一技术的发展，标志着软件开发正在进入一个新的时代：架构驱动、AI 辅助、高效实现、双视角协同，为企业级应用的数字化转型注入了强大动力，助力企业构建更具竞争力的数字化系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NestJS 鉴权系统实战：从单Token到双Token架构的完整实现]]></title>    <link>https://juejin.cn/post/7600588379106263092</link>    <guid>https://juejin.cn/post/7600588379106263092</guid>    <pubDate>2026-01-29T15:27:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600588379106263092" data-draft-id="7600588379106246708" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NestJS 鉴权系统实战：从单Token到双Token架构的完整实现"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T15:27:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌的拖拉斯旋风"/> <meta itemprop="url" content="https://juejin.cn/user/951508170179208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NestJS 鉴权系统实战：从单Token到双Token架构的完整实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/951508170179208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌的拖拉斯旋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T15:27:27.000Z" title="Thu Jan 29 2026 15:27:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代Web应用开发中，身份验证和授权是构建安全系统的基石。随着网络安全威胁日益增多，传统的单一Token机制已无法满足高安全性的需求。本文将详细介绍如何在NestJS框架中实现一个健壮的双Token鉴权系统，并分享我在开发过程中遇到的真实Bug调试经验。</p>
<h2 data-id="heading-1">1. JWT协议基础</h2>
<h3 data-id="heading-2">什么是JWT？</h3>
<p>JWT（JSON Web Token）是一种开放标准（RFC 7519），定义了一种紧凑且自包含的方式，用于在各方之间安全地传输信息作为JSON对象。这种信息可以通过数字签名进行验证和信任。</p>
<p>JWT通常由三部分组成：</p>
<ul>
<li><strong>Header</strong>: 包含令牌类型和签名算法</li>
<li><strong>Payload</strong>: 包含声明（claims）</li>
<li><strong>Signature</strong>: 用于验证消息完整性</li>
</ul>
<h3 data-id="heading-3">NestJS中的JWT实现</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 安装必要的包</span>
npm install <span class="hljs-meta">@nestjs</span>/jwt <span class="hljs-meta">@nestjs</span>/passport passport passport-jwt

<span class="hljs-comment">// JWT服务配置</span>
<span class="hljs-meta">@Module({
  imports: [
    JwtModule.register({
      secret: process.env.JWT_SECRET,
      signOptions: { expiresIn: <span class="hljs-string">'15m'</span> }, // 15分钟过期
    }),
  ],
  providers: [JwtService],
})</span>
export <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthModule</span> {}
</code></pre>
<h2 data-id="heading-4">2. 从单Token到双Token架构</h2>
<h3 data-id="heading-5">为什么要使用双Token机制？</h3>
<p>传统的单Token架构存在以下安全风险：</p>
<ul>
<li><strong>Token劫持风险</strong>：一旦Token被中间人捕获，攻击者可以在整个有效期内进行恶意操作</li>
<li><strong>长时间暴露</strong>：如果Token有效期设置较长，安全风险相应增加</li>
<li><strong>无法灵活控制</strong>：难以实现细粒度的权限管理</li>
</ul>
<h3 data-id="heading-6">双Token设计模式</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Token配置</span>
<span class="hljs-keyword">const</span> ACCESS_TOKEN_EXPIRES_IN = <span class="hljs-string">'15m'</span>;  <span class="hljs-comment">// 15分钟</span>
<span class="hljs-keyword">const</span> REFRESH_TOKEN_EXPIRES_IN = <span class="hljs-string">'7d'</span>;  <span class="hljs-comment">// 7天</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title">TokenPair</span> {
  accessToken: <span class="hljs-built_in">string</span>;
  refreshToken: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p><strong>Access Token</strong>（短期Token）：</p>
<ul>
<li>有效期短（如15分钟）</li>
<li>用于日常API请求的身份验证</li>
<li>即使被劫持，影响范围有限</li>
</ul>
<p><strong>Refresh Token</strong>（长期Token）：</p>
<ul>
<li>有效期长（如7天）</li>
<li>仅用于刷新Access Token</li>
<li>存储在安全位置（如HttpOnly Cookie）</li>
</ul>
<h2 data-id="heading-7">3. 实战：双Token生成与验证</h2>
<h3 data-id="heading-8">3.1 Token生成服务</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> jwtService: JwtService,
    <span class="hljs-keyword">private</span> userService: UserService,
  </span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">login</span>(<span class="hljs-attr">credentials</span>: <span class="hljs-title class_">LoginDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">TokenPair</span>&gt; {
    <span class="hljs-comment">// 验证用户凭据</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateUser</span>(credentials);
    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">'Invalid credentials'</span>);
    }

    <span class="hljs-comment">// 生成Token对</span>
    <span class="hljs-keyword">const</span> payload = { 
      <span class="hljs-attr">sub</span>: user.<span class="hljs-property">id</span>.<span class="hljs-title function_">toString</span>(), 
      <span class="hljs-attr">name</span>: user.<span class="hljs-property">name</span> 
    };

    <span class="hljs-keyword">const</span> [accessToken, refreshToken] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">signAsync</span>(payload, { 
        <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">ACCESS_TOKEN_EXPIRES_IN</span> 
      }),
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">signAsync</span>({
        ...payload,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'refresh'</span>
      }, { 
        <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">REFRESH_TOKEN_EXPIRES_IN</span> 
      })
    ]);

    <span class="hljs-comment">// 存储Refresh Token（可选：存入数据库）</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">storeRefreshToken</span>(user.<span class="hljs-property">id</span>, refreshToken);

    <span class="hljs-keyword">return</span> {
      accessToken,
      refreshToken
    };
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">refreshTokens</span>(<span class="hljs-attr">refreshToken</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">TokenPair</span>&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 验证Refresh Token</span>
      <span class="hljs-keyword">const</span> payload = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">verifyAsync</span>(refreshToken, {
        <span class="hljs-attr">secret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span>
      });

      <span class="hljs-comment">// 验证Token类型</span>
      <span class="hljs-keyword">if</span> (payload.<span class="hljs-property">type</span> !== <span class="hljs-string">'refresh'</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">'Invalid token type'</span>);
      }

      <span class="hljs-comment">// 检查Token是否在数据库中存在（防重放攻击）</span>
      <span class="hljs-keyword">const</span> isValid = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateStoredRefreshToken</span>(payload.<span class="hljs-property">sub</span>, refreshToken);
      <span class="hljs-keyword">if</span> (!isValid) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">'Token not found or invalid'</span>);
      }

      <span class="hljs-comment">// 生成新的Token对</span>
      <span class="hljs-keyword">const</span> newPayload = { 
        <span class="hljs-attr">sub</span>: payload.<span class="hljs-property">sub</span>, 
        <span class="hljs-attr">name</span>: payload.<span class="hljs-property">name</span> 
      };

      <span class="hljs-keyword">const</span> [newAccessToken, newRefreshToken] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">signAsync</span>(newPayload, { 
          <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">ACCESS_TOKEN_EXPIRES_IN</span> 
        }),
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">signAsync</span>({
          ...newPayload,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'refresh'</span>
        }, { 
          <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">REFRESH_TOKEN_EXPIRES_IN</span> 
        })
      ]);

      <span class="hljs-comment">// 更新存储的Refresh Token</span>
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateRefreshToken</span>(payload.<span class="hljs-property">sub</span>, refreshToken, newRefreshToken);

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">accessToken</span>: newAccessToken,
        <span class="hljs-attr">refreshToken</span>: newRefreshToken
      };

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">'Could not refresh token'</span>);
    }
  }
}
</code></pre>
<h3 data-id="heading-9">3.2 JWT策略配置</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PassportStrategy</span>(<span class="hljs-params"><span class="hljs-type">Strategy</span></span>) </span>{
  constructor(<span class="hljs-keyword">private</span> configService: <span class="hljs-type">ConfigService</span>) {
    <span class="hljs-keyword">super</span>({
      jwtFromRequest: <span class="hljs-type">ExtractJwt</span>.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: <span class="hljs-literal">false</span>,
      secretOrKey: configService.get&lt;string&gt;('<span class="hljs-type">JWT_SECRET</span>'),
    });
  }

  async validate(payload: any) {
    <span class="hljs-comment">// 验证Token类型（确保是Access Token而非Refresh Token）</span>
    <span class="hljs-keyword">if</span> (payload.<span class="hljs-keyword">type</span> === 'refresh') {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">UnauthorizedException</span>('<span class="hljs-type">Invalid</span> token <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">for</span> <span class="hljs-title">access</span>')</span>;
    }

    <span class="hljs-keyword">return</span> { 
      userId: parseInt(payload.sub), 
      username: payload.name 
    };
  }
}
</code></pre>
<h2 data-id="heading-10">4. Guard机制：路由保护的守护者</h2>
<h3 data-id="heading-11">4.1 UseGuards装饰器</h3>
<p><code>UseGuards</code>是NestJS提供的装饰器，用于在控制器或路由处理方法上应用守卫。它会在路由处理方法执行前先执行Guard函数。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Controller</span>(<span class="hljs-string">'posts'</span>)
export class PostsController {
  <span class="hljs-selector-tag">constructor</span>(private <span class="hljs-attribute">postsService</span>: PostsService) {}

  <span class="hljs-variable">@UseGuards</span>(JwtAuthGuard) <span class="hljs-comment">// 应用JWT守卫</span>
  <span class="hljs-variable">@Post</span>()
  async <span class="hljs-built_in">createPost</span>(<span class="hljs-variable">@Body</span>() <span class="hljs-attribute">createPostDto</span>: CreatePostDto, <span class="hljs-variable">@Req</span>() req) {
    <span class="hljs-comment">// 只有通过验证的用户才能创建帖子</span>
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.postsService</span><span class="hljs-selector-class">.createPost</span>(createPostDto, req.user.userId);
  }

  @<span class="hljs-selector-tag">UseGuards</span>(JwtAuthGuard)
  @<span class="hljs-selector-tag">Get</span>()
  <span class="hljs-selector-tag">async</span> <span class="hljs-selector-tag">getPosts</span>(<span class="hljs-variable">@Req</span>() req) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.postsService</span><span class="hljs-selector-class">.getUserPosts</span>(req.user.userId);
  }
}
</code></pre>
<h3 data-id="heading-12">4.2 自定义JWT守卫</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtAuthGuard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthGuard</span>(<span class="hljs-params">'jwt'</span>) </span>{
  canActivate(context: <span class="hljs-type">ExecutionContext</span>) {
    <span class="hljs-comment">// 调用父类的canActivate方法</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.canActivate(context);
  }

  handleRequest(err, user, info) {
    <span class="hljs-comment">// 处理验证结果</span>
    <span class="hljs-keyword">if</span> (err || !user) {
      <span class="hljs-keyword">throw</span> err || <span class="hljs-keyword">new</span> <span class="hljs-type">UnauthorizedException</span>('<span class="hljs-type">Authentication</span> failed');
    }
    <span class="hljs-keyword">return</span> user;
  }
}
</code></pre>
<h2 data-id="heading-13">5. 客户端集成：Axios请求拦截器</h2>
<h3 data-id="heading-14">5.1 请求拦截器</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// axios配置</span>
<span class="hljs-keyword">const</span> apiClient = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'http://localhost:3000/api'</span>,
});

<span class="hljs-comment">// 请求拦截器：自动添加Access Token</span>
apiClient.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'accessToken'</span>);
    <span class="hljs-keyword">if</span> (token) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> config;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);

<span class="hljs-comment">// 响应拦截器：处理Token过期</span>
apiClient.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response,
  <span class="hljs-keyword">async</span> (error) =&gt; {
    <span class="hljs-keyword">const</span> originalRequest = error.<span class="hljs-property">config</span>;

    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span> &amp;&amp; !originalRequest.<span class="hljs-property">_retry</span>) {
      originalRequest.<span class="hljs-property">_retry</span> = <span class="hljs-literal">true</span>;

      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 使用Refresh Token刷新Access Token</span>
        <span class="hljs-keyword">const</span> refreshToken = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'refreshToken'</span>);
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/auth/refresh'</span>, {
          refreshToken
        });

        <span class="hljs-keyword">const</span> { accessToken } = response.<span class="hljs-property">data</span>;
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'accessToken'</span>, accessToken);

        <span class="hljs-comment">// 重新发起原请求</span>
        originalRequest.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${accessToken}</span>`</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">apiClient</span>(originalRequest);
      } <span class="hljs-keyword">catch</span> (refreshError) {
        <span class="hljs-comment">// 刷新失败，跳转到登录页</span>
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'accessToken'</span>);
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'refreshToken'</span>);
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(refreshError);
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);
</code></pre>
<h2 data-id="heading-15">6. 错误处理：优雅的异常响应</h2>
<h3 data-id="heading-16">6.1 NestJS内置异常类</h3>
<p>NestJS提供了丰富的HTTP异常类，用于处理不同类型的错误：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 常见的HTTP异常</span>
BadRequestException    <span class="hljs-comment">// 400 - 请求参数错误</span>
UnauthorizedException  <span class="hljs-comment">// 401 - 未授权</span>
ForbiddenException     <span class="hljs-comment">// 403 - 禁止访问  </span>
NotFoundException      <span class="hljs-comment">// 404 - 资源不存在</span>
InternalServerErrorException <span class="hljs-comment">// 500 - 服务器内部错误</span>
</code></pre>
<h3 data-id="heading-17">6.2 全局异常过滤器</h3>
<pre><code class="hljs language-ini" lang="ini">@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    const <span class="hljs-attr">ctx</span> = host.switchToHttp()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">response</span> = ctx.getResponse()<span class="hljs-comment">;</span>
    
    let status, message<span class="hljs-comment">;</span>
    
    if (exception instanceof HttpException) {
      <span class="hljs-attr">status</span> = exception.getStatus()<span class="hljs-comment">;</span>
      <span class="hljs-attr">message</span> = exception.getResponse()<span class="hljs-comment">;</span>
    } else {
      <span class="hljs-attr">status</span> = <span class="hljs-number">500</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">message</span> = {
        statusCode: 500,
        message: 'Internal server error',
        timestamp: new Date().toISOString(),
      }<span class="hljs-comment">;</span>
    }

    response.status(status).json(message)<span class="hljs-comment">;</span>
  }
}

// 在main.ts中注册
async function bootstrap() {
  const <span class="hljs-attr">app</span> = await NestFactory.create(AppModule)<span class="hljs-comment">;</span>
  app.useGlobalFilters(new AllExceptionsFilter())<span class="hljs-comment">;</span>
  await app.listen(3000)<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-18">7. 实战Bug调试：我的真实经历</h2>
<h3 data-id="heading-19">7.1 字段命名不一致导致的500错误</h3>
<p>在我开发过程中，遇到了一个典型的Bug：用户存在但创建帖子时返回500错误。</p>
<p><strong>错误日志</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">Null</span> <span class="hljs-keyword">constraint</span> violation <span class="hljs-keyword">on</span> the fields: (<span class="hljs-string">'userId'</span>)
</code></pre>
<p><strong>问题分析</strong>：</p>
<ol>
<li>JWT Payload: <code>{ sub: '30', name: 'admin', ... }</code> ✓</li>
<li>User object: <code>{ id: 30, name: 'admin' }</code> ✓</li>
<li>但 <code>req.user.userId</code> 是 <code>undefined</code></li>
</ol>
<p><strong>根本原因</strong>：<br/>
JWT策略返回的字段名与Controller期望的不匹配</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误的字段名</span>
<span class="hljs-keyword">return</span> { id: payload.sub, name: payload.name };

<span class="hljs-comment">// ✅ 正确的字段名</span>
<span class="hljs-keyword">return</span> { userId: parseInt(payload.sub), username: payload.name };
</code></pre>
<p><strong>调试过程</strong>：</p>
<ol>
<li>添加详细的日志输出</li>
<li>检查JWT Token的有效性</li>
<li>验证字段命名的一致性</li>
<li>确认数据流向的每个环节</li>
</ol>
<h3 data-id="heading-20">7.2 Token验证失败的排查</h3>
<p><strong>错误信息</strong>：<code>Unknown authentication strategy "jwt"</code></p>
<p><strong>解决方案</strong>：</p>
<ol>
<li>确保正确导入 <code>@nestjs/passport</code></li>
<li>检查JWT策略是否正确注册</li>
<li>验证Passport模块的配置</li>
</ol>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// app.module.ts</span>
<span class="hljs-variable">@Module</span>({
  <span class="hljs-attribute">imports</span>: [
    PassportModule,
    JwtModule.<span class="hljs-built_in">register</span>({
      <span class="hljs-attribute">secret</span>: process.env.JWT_SECRET,
    }),
  ],
  <span class="hljs-attribute">providers</span>: [
    AuthService,
    JwtStrategy, <span class="hljs-comment">// 确保注册策略</span>
  ],
})
export class AppModule {}
</code></pre>
<h2 data-id="heading-21">8. 性能优化：Promise.all的实际应用</h2>
<p>在实际项目中，经常需要并发执行多个异步操作。例如，在获取文章列表时同时获取总数：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Controller</span>(<span class="hljs-string">'posts'</span>)
export class PostsController {
  <span class="hljs-variable">@UseGuards</span>(JwtAuthGuard)
  <span class="hljs-variable">@Get</span>()
  async <span class="hljs-built_in">getPosts</span>(
    <span class="hljs-variable">@Query</span>(<span class="hljs-string">'page'</span>) page = <span class="hljs-number">1</span>,
    <span class="hljs-variable">@Query</span>(<span class="hljs-string">'limit'</span>) limit = <span class="hljs-number">10</span>,
    <span class="hljs-variable">@Req</span>() req
  ) {
    <span class="hljs-comment">// 使用Promise.all并行执行，提高性能</span>
    <span class="hljs-selector-tag">const</span> <span class="hljs-selector-attr">[posts, totalCount]</span> = <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">Promise</span><span class="hljs-selector-class">.all</span>([
      this.postsService.<span class="hljs-built_in">findMany</span>({
        <span class="hljs-attribute">where</span>: { <span class="hljs-attribute">userId</span>: req.user.userId },
        <span class="hljs-attribute">skip</span>: (page - <span class="hljs-number">1</span>) * limit,
        <span class="hljs-attribute">take</span>: limit,
      }),
      this.postsService.<span class="hljs-built_in">count</span>({ <span class="hljs-attribute">where</span>: { <span class="hljs-attribute">userId</span>: req.user.userId } })
    ]);

    <span class="hljs-selector-tag">return</span> {
      data: posts,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total: totalCount,
        pages: Math.ceil(totalCount / limit)
      }
    };
  }
}
</code></pre>
<h2 data-id="heading-22">9. 安全最佳实践</h2>
<h3 data-id="heading-23">9.1 Token存储安全</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 设置安全的Cookie选项</span>
res.<span class="hljs-built_in">cookie</span>(<span class="hljs-string">'refreshToken'</span>, refreshToken, {
  httpOnly: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 防止XSS攻击</span>
  secure: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// HTTPS only</span>
  sameSite: <span class="hljs-string">'strict'</span>,<span class="hljs-comment">// CSRF protection</span>
  maxAge: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 7天</span>
});
</code></pre>
<h3 data-id="heading-24">9.2 防重放攻击</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 验证Token是否已被使用</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">validateStoredRefreshToken</span>(<span class="hljs-attr">userId</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">token</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
  <span class="hljs-keyword">const</span> storedToken = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">refreshToken</span>.<span class="hljs-title function_">findFirst</span>({
    <span class="hljs-attr">where</span>: {
      userId,
      token,
      <span class="hljs-attr">expiresAt</span>: { <span class="hljs-attr">gt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() },
      <span class="hljs-attr">used</span>: <span class="hljs-literal">false</span>
    }
  });
  
  <span class="hljs-keyword">return</span> !!storedToken;
}
</code></pre>
<h2 data-id="heading-25">10. 总结</h2>
<p>通过本文的详细阐述，我们深入了解了NestJS中双Token鉴权系统的完整实现：</p>
<ol>
<li><strong>架构设计</strong>：双Token机制提供了更好的安全性</li>
<li><strong>技术实现</strong>：从Token生成到验证的完整流程</li>
<li><strong>错误处理</strong>：优雅的异常响应和调试技巧</li>
<li><strong>性能优化</strong>：合理使用并发提升用户体验</li>
<li><strong>安全实践</strong>：多种安全措施保障系统安全</li>
</ol>
<p>在实际开发中，安全性和用户体验往往需要平衡考虑。双Token机制虽然增加了系统复杂度，但显著提升了安全性。通过合理的架构设计和完善的错误处理，我们可以构建既安全又高效的Web应用。</p>
<p>记住，安全是一个持续的过程，需要不断地学习、实践和完善。希望这篇文章能为你的鉴权系统开发提供有价值的参考。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 作用域与提升（学习笔记）]]></title>    <link>https://juejin.cn/post/7600622206268817418</link>    <guid>https://juejin.cn/post/7600622206268817418</guid>    <pubDate>2026-01-29T14:32:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600622206268817418" data-draft-id="7600628279215570970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 作用域与提升（学习笔记）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-29T14:32:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户575730334624"/> <meta itemprop="url" content="https://juejin.cn/user/2860271309712009"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 作用域与提升（学习笔记）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2860271309712009/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户575730334624
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T14:32:13.000Z" title="Thu Jan 29 2026 14:32:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 作用域与提升：从函数作用域到块级作用域的演进</h2>
<p>在 JavaScript 的世界中，<strong>作用域（Scope）</strong> 和 <strong>提升（Hoisting）</strong> 是理解变量生命周期、函数行为以及内存管理的核心基础。本文将系统梳理 JavaScript 中的作用域机制（包括函数作用域与块级作用域）、变量/函数提升规则，并结合典型示例与最佳实践，帮助开发者写出更安全、可维护的代码。</p>
<hr/>
<h3 data-id="heading-1">一、提升（Hoisting）：JavaScript 的“编译阶段”行为</h3>
<p>JavaScript 引擎在执行代码前会经历一个<strong>编译阶段</strong>，用于收集变量和函数声明。这一过程导致了“提升”现象——<strong>声明被移动到其所在作用域的顶部</strong>，但赋值操作保留在原地。</p>
<h4 data-id="heading-2">1. 变量提升（<code>var</code>）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// undefined（不是报错！）</span>
<span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>;
</code></pre>
<p>等价于：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> a;           <span class="hljs-comment">// 声明被提升</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);  <span class="hljs-comment">// undefined</span>
a = <span class="hljs-number">1</span>;           <span class="hljs-comment">// 赋值未提升</span>
</code></pre>
<ul>
<li><code>var</code> 声明会被提升到<strong>当前函数作用域</strong>顶部。</li>
<li>提升后变量初始化为 <code>undefined</code>，因此提前访问不会报错，但值不可用。</li>
</ul>
<h4 data-id="heading-3">2. 函数提升（Function Declaration）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// "Hello!" —— 可直接调用！</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello!"</span>);
}
</code></pre>
<ul>
<li><strong>函数声明（<code>function foo() {}</code>）会被完整提升（包括函数体）到当前函数作用域顶部</strong>。</li>
<li>这使得函数可以在声明前被调用。</li>
</ul>
<h4 data-id="heading-4">3. <code>let</code> / <code>const</code> 与暂时性死区（TDZ）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b); <span class="hljs-comment">// ReferenceError: Cannot access 'b' before initialization</span>
<span class="hljs-keyword">let</span> b = <span class="hljs-number">2</span>;
</code></pre>
<ul>
<li><code>let</code> 和 <code>const</code> 也会被“提升”，但在声明前处于 <strong>暂时性死区（Temporal Dead Zone, TDZ）</strong>。</li>
<li>在 TDZ 中访问变量会抛出 <code>ReferenceError</code>，强制开发者“先声明后使用”。</li>
</ul>
<blockquote>
<p>✅ <strong>关键总结</strong>：</p>
<ul>
<li><strong>函数作用域是第一作用域</strong>：提升只发生在当前函数作用域内，不会跨作用域。</li>
<li><code>var</code> 提升 → 值为 <code>undefined</code></li>
<li>函数声明提升 → 完整函数体可用</li>
<li><code>let</code>/<code>const</code> 提升 → TDZ，禁止提前访问</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-5">二、函数作用域：JavaScript 的传统作用域模型</h3>
<p>在 ES6 之前，JavaScript <strong>只有函数作用域</strong>。这意味着：</p>
<blockquote>
<p><strong>每声明一个函数，就自动创建一层新的作用域；其他结构（如 <code>if</code>、<code>for</code>）不会创建作用域。</strong></p>
</blockquote>
<h4 data-id="heading-6">示例解析</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">a</span>) {
    <span class="hljs-keyword">var</span> b = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">var</span> c = <span class="hljs-number">2</span>;
    }
}
</code></pre>
<ul>
<li><code>foo</code> 创建了一个函数作用域，包含参数 <code>a</code> 和变量 <code>b</code>。</li>
<li><code>bar</code> 在 <code>foo</code> 内部声明，<strong>自身又创建了一个新的函数作用域</strong>，包含 <code>c</code>。</li>
<li><code>a</code>、<code>b</code>、<code>c</code> 均<strong>不能在全局作用域中访问</strong>，实现了封装。</li>
</ul>
<h4 data-id="heading-7">易错点提醒</h4>
<ul>
<li><code>var b</code> 的提升仅限于 <code>foo</code> 作用域顶部，不会影响全局。</li>
<li><code>bar</code> 的函数提升也仅限于 <code>foo</code> 作用域顶部，外部无法调用。</li>
</ul>
<hr/>
<h3 data-id="heading-8">三、隐藏内部实现：利用函数作用域实现私有化</h3>
<p>函数作用域的自包含特性，使其成为<strong>隐藏内部实现</strong>的理想工具，符合 <strong>最小特权原则</strong>（Least Privilege Principle）：</p>
<blockquote>
<p><strong>一个程序、用户或组件，只应拥有完成任务所必需的最小权限。</strong></p>
</blockquote>
<h4 data-id="heading-9">避免命名冲突</h4>
<p>当多个脚本或第三方库共存时，全局变量极易冲突：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 库 A</span>
<span class="hljs-keyword">var</span> config = { <span class="hljs-attr">url</span>: <span class="hljs-string">"api.a.com"</span> };

<span class="hljs-comment">// 库 B</span>
<span class="hljs-keyword">var</span> config = { <span class="hljs-attr">url</span>: <span class="hljs-string">"api.b.com"</span> }; <span class="hljs-comment">// 覆盖了 A！</span>
</code></pre>
<h5 data-id="heading-10">解决方案 1：全局命名空间</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 库 A</span>
<span class="hljs-keyword">var</span> <span class="hljs-title class_">LibA</span> = {
    <span class="hljs-attr">config</span>: { <span class="hljs-attr">url</span>: <span class="hljs-string">"api.a.com"</span> },
    <span class="hljs-attr">init</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
};

<span class="hljs-comment">// 库 B</span>
<span class="hljs-keyword">var</span> <span class="hljs-title class_">LibB</span> = {
    <span class="hljs-attr">config</span>: { <span class="hljs-attr">url</span>: <span class="hljs-string">"api.b.com"</span> },
    <span class="hljs-attr">start</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
};
</code></pre>
<p>→ 所有功能打包为对象属性，避免污染全局。</p>
<h5 data-id="heading-11">解决方案 2：模块管理（现代方案）</h5>
<p>使用 ES6 模块或 CommonJS，通过 <code>import</code>/<code>require</code> 显式导入依赖，天然隔离作用域。</p>
<hr/>
<h3 data-id="heading-12">四、函数表达式 vs 函数声明：私有化的演进</h3>
<p>虽然函数声明能创建作用域，但它本身会<strong>污染所在作用域</strong>（函数名可见）。而<strong>函数表达式</strong>提供了更灵活的私有化方式。</p>
<h4 data-id="heading-13">函数表达式的优点</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 匿名函数表达式作为 IIFE</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> privateVar = <span class="hljs-string">"secret"</span>;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">privateFn</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
    <span class="hljs-comment">// 外部无法访问 privateVar 或 privateFn</span>
})();
</code></pre>
<ul>
<li>不创建额外的函数名标识符。</li>
<li>可立即执行，无需显式调用。</li>
</ul>
<h4 data-id="heading-14">函数表达式的弊端与解决</h4>





















<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>栈追踪无意义函数名</td><td>使用<strong>具名函数表达式</strong>：<code>const f = function meaningfulName() {}</code></td></tr><tr><td>无法递归引用自身</td><td>具名后可在内部调用 <code>meaningfulName()</code></td></tr><tr><td>可读性差</td><td>避免过度使用匿名函数；复杂逻辑提取为命名函数</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>行内函数表达式</strong>：强调“定义和使用在同一处”，常用于回调、事件处理等场景。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">五、立即执行函数表达式（IIFE）：作用域隔离的经典模式</h3>
<p>IIFE（Immediately Invoked Function Expression）是利用函数表达式实现<strong>一次性私有作用域</strong>的典范。</p>
<h4 data-id="heading-16">基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 私有作用域</span>
})();
</code></pre>
<ul>
<li>第一个 <code>()</code>：将函数声明转为<strong>函数表达式</strong>。</li>
<li>第二个 <code>()</code>：<strong>立即调用</strong>该函数。</li>
</ul>
<h4 data-id="heading-17">箭头函数版 IIFE（ES6+）</h4>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello, "</span> + name);
})(<span class="hljs-string">"Alice"</span>);
</code></pre>
<ul>
<li>同样创建私有作用域。</li>
<li>更简洁，但注意箭头函数无 <code>this</code> 和 <code>arguments</code>。</li>
</ul>
<h4 data-id="heading-18">IIFE 的用途</h4>
<ol>
<li><strong>避免全局污染</strong></li>
<li><strong>模拟私有变量</strong>（在无模块系统时）</li>
<li><strong>一次性初始化逻辑</strong></li>
</ol>
<blockquote>
<p>✅ <strong>最佳实践</strong>：即使在 ES6 模块时代，IIFE 在书签脚本、广告代码等单文件场景中仍非常实用。</p>
</blockquote>
<hr/>
<h3 data-id="heading-19">六、块级作用域：ES6 的革命性改进</h3>
<p>ES6 引入 <code>let</code> 和 <code>const</code>，带来了真正的<strong>块级作用域（Block Scope）</strong>：</p>
<blockquote>
<p><strong>任何由 <code>{}</code> 包裹的代码块（如 <code>if</code>、<code>for</code>、<code>{}</code>）都能形成独立作用域。</strong></p>
</blockquote>
<h4 data-id="heading-20">经典问题：循环中的闭包</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// var 的问题</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i), <span class="hljs-number">100</span>); <span class="hljs-comment">// 输出 3,3,3</span>
}

<span class="hljs-comment">// let 的解决方案</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i), <span class="hljs-number">100</span>); <span class="hljs-comment">// 输出 0,1,2</span>
}
</code></pre>
<ul>
<li><code>let</code> 为每次循环迭代<strong>创建新的块级作用域</strong>，每个回调捕获自己的 <code>i</code>。</li>
</ul>
<h4 data-id="heading-21">块级作用域的其他形式</h4>
<ul>
<li><code>try...catch</code> 中的 <code>catch</code> 块</li>
<li><code>with</code> 语句（不推荐使用）</li>
<li>任意 <code>{}</code> 代码块</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">{
    <span class="hljs-keyword">let</span> x = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> y = <span class="hljs-number">2</span>;
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// ReferenceError</span>
</code></pre>
<hr/>
<h3 data-id="heading-22">七、垃圾收集与作用域</h3>
<p>JavaScript 的<strong>垃圾收集（Garbage Collection）</strong> 机制依赖<strong>可达性（Reachability）</strong> 判断对象是否可回收。</p>
<h4 data-id="heading-23">块级作用域助力内存管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"/>) {
    {
        <span class="hljs-keyword">let</span> bigData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>);
        <span class="hljs-comment">// 处理数据...</span>
    } <span class="hljs-comment">// bigData 超出块作用域 → 可被 GC 回收</span>
    <span class="hljs-comment">// 其他逻辑...</span>
}
</code></pre>
<ul>
<li>引擎能更早识别 <code>bigData</code> 不再需要，及时释放内存。</li>
<li>相比 <code>var</code>（函数作用域），<code>let</code>/<code>const</code> 让内存生命周期更精确。</li>
</ul>
<blockquote>
<p>⚠️ <strong>注意</strong>：闭包会阻止外部变量被回收。合理使用块作用域可减少不必要的闭包引用。</p>
</blockquote>
<hr/>
<h3 data-id="heading-24">八、<code>var</code> vs <code>let</code> vs <code>const</code>：作用域与提升对比</h3>









































<table><thead><tr><th>特性</th><th><code>var</code></th><th><code>let</code></th><th><code>const</code></th></tr></thead><tbody><tr><td><strong>作用域</strong></td><td>函数作用域</td><td>块级作用域</td><td>块级作用域</td></tr><tr><td><strong>提升</strong></td><td>是（初始化为 <code>undefined</code>）</td><td>是（TDZ）</td><td>是（TDZ）</td></tr><tr><td><strong>重复声明</strong></td><td>允许</td><td>禁止</td><td>禁止</td></tr><tr><td><strong>重新赋值</strong></td><td>允许</td><td>允许</td><td>禁止（绑定不可变）</td></tr><tr><td><strong>全局属性</strong></td><td>是（如 <code>window.a</code>）</td><td>否</td><td>否</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>现代开发建议</strong>：</p>
<ul>
<li>默认使用 <code>const</code></li>
<li>需要重赋值时用 <code>let</code></li>
<li>彻底避免 <code>var</code></li>
</ul>
</blockquote>
<h3 data-id="heading-25">详见：文章：<a href="https://juejin.cn/post/7598127455133220864" target="_blank" title="https://juejin.cn/post/7598127455133220864">juejin.cn/post/759812…</a></h3>
<h3 data-id="heading-26">九、结语：从混乱到规范</h3>
<p>从 <code>var</code> 的函数作用域到 <code>let</code>/<code>const</code> 的块级作用域，JavaScript 完成了作用域模型的一次重要进化。这一变化不仅修复了历史遗留问题（如变量泄漏、循环闭包陷阱），更推动了开发者编写更安全、可预测的代码。</p>
<p><strong>记住口诀</strong>：</p>
<blockquote>
<p><code>const</code> 优先，不变就用它；<br/>
需要重赋值，<code>let</code> 来保驾；<br/>
<code>var</code> 已过时，坚决不使用；<br/>
作用域清晰，bug 远离我！</p>
</blockquote>
<p>掌握这些原理，你不仅能写出正确的代码，更能深入理解 JavaScript 的执行机制，为学习闭包、异步、模块化等高级主题打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>