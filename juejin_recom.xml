<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[拒绝“解构重命名”地狱：一位前端架构眼中的命名方案]]></title>    <link>https://juejin.cn/post/7600032104249180223</link>    <guid>https://juejin.cn/post/7600032104249180223</guid>    <pubDate>2026-01-28T12:27:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104249180223" data-draft-id="7600223321041584134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝“解构重命名”地狱：一位前端架构眼中的命名方案"/> <meta itemprop="keywords" content="代码规范,Vue.js"/> <meta itemprop="datePublished" content="2026-01-28T12:27:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿懂在掘金"/> <meta itemprop="url" content="https://juejin.cn/user/4485616525391678"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝“解构重命名”地狱：一位前端架构眼中的命名方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4485616525391678/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿懂在掘金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:27:54.000Z" title="Wed Jan 28 2026 12:27:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为前端架构师，在 Code Review 时最让你头疼的是什么？</p>
<p>是复杂的业务逻辑吗？对于我来说，是那些<strong>细碎且随意的变量命名</strong>。</p>
<p>在 Vue 3 Composition API 普及的今天，我们享受着逻辑复用的红利，却也陷入了 <code>Destructuring Aliasing</code>（解构重命名）的泥潭。当一个组件需要请求三个不同的接口时，原本清爽的代码往往变成了这样：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ 典型的“重命名地狱”</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: userData, <span class="hljs-attr">loading</span>: userLoading, <span class="hljs-attr">run</span>: fetchUser } = <span class="hljs-title function_">useRequest</span>(getUser);
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: listData, <span class="hljs-attr">loading</span>: listLoading, <span class="hljs-attr">run</span>: fetchList } = <span class="hljs-title function_">useRequest</span>(getList);
<span class="hljs-keyword">const</span> { <span class="hljs-attr">loading</span>: submitLoading, <span class="hljs-attr">run</span>: doSubmit } = <span class="hljs-title function_">useRequest</span>(submitForm);
</code></pre>
<p>这段代码有什么问题？</p>
<ol>
<li><strong>心智负担</strong>：开发者每次都需要思考“该叫 <code>fetchUser</code> 还是 <code>getUser</code>？该叫 <code>userLoading</code> 还是 <code>isUserLoading</code>？”</li>
<li><strong>团队熵增</strong>：A 同学喜欢 <code>doSubmit</code>，B 同学喜欢 <code>runSubmit</code>。文档里的规范，在 <code>const { run: ??? }</code> 的那一刻极其脆弱。</li>
<li><strong>可读性断层</strong>：模板中充满了 <code>loading1</code>, <code>loading2</code> 或者是随意的别名，维护者很难一眼看出哪个 loading 对应哪个操作。</li>
</ol>
<p>那么，有没有办法从工程角度解决这个问题？</p>
<p>很高兴能向你介绍我在：<a href="https://link.juejin.cn?target=https%3A%2F%2Fxuyimingwork.github.io%2Fvue-asyncx%2F" target="_blank" title="https://xuyimingwork.github.io/vue-asyncx/" ref="nofollow noopener noreferrer"><strong><code>vue-asyncx</code></strong></a> 中实现的方案：</p>
<p>利用 TS 编译时的能力，推行<strong>强制性的语义化标准</strong>，轻松拉齐团队共识。</p>
<blockquote>
<p>这个工具在单个项目里使用了近600次，全部项目里有数千次的使用。</p>
<p>可以说有接口、有异步的地方，就有它。</p>
</blockquote>
<h2 data-id="heading-0">统一的命名约定</h2>
<p>初始的想法很简单：既然它们是关联的变量，能不能一处命名，处处命名，并且所有团队成员统一规范？</p>
<p>答案是<strong>可以</strong>！利用 TypeScript 的<strong>模板字面量类型 (Template Literal Types)</strong> ，将“命名规范”直接烧录到代码的类型推导中。</p>
<h3 data-id="heading-1">1. 纯动作场景：动作即主语</h3>
<p>对于不需要持久化数据的操作（如提交表单、删除、登录），我们使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fxuyimingwork.github.io%2Fvue-asyncx%2Fhooks%2Fuse-async.html" target="_blank" title="https://xuyimingwork.github.io/vue-asyncx/hooks/use-async.html" ref="nofollow noopener noreferrer"><code>useAsync</code></a>。</p>
<p>你只需要传入一个动词（Action Name）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ✅ vue-asyncx: 语义化即所得 </span>
<span class="hljs-keyword">const</span> { login, loginLoading, loginError } = <span class="hljs-title function_">useAsync</span>(<span class="hljs-string">'login'</span>, loginApi);
</code></pre>
<p><strong>没有解构重命名</strong>。 库根据你传入的字符串 <code>'login'</code>，自动推导出了：</p>
<ul>
<li>方法名：<code>login</code></li>
<li>加载态：<code>loginLoading</code></li>
<li>错误态：<code>loginError</code></li>
</ul>
<p>这消除了“别名选择困难症”。在团队中，只要大家都用这个库，所有人的提交按钮逻辑都会惊人地一致：<code>&lt;button :loading="loginLoading" @click="login"&gt;</code>。</p>
<h3 data-id="heading-2">2. 数据展示场景：分离“数据”与“动作”</h3>
<p>假设我们要获取“用户信息 (User)”。在架构设计上，“用户数据”和“查询用户数据的动作”是两个概念。</p>
<p>因此，<code>vue-asyncx</code>对 <code>useAsync</code> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fxuyimingwork.github.io%2Fvue-asyncx%2Fhooks%2Fuse-async-data.html" target="_blank" title="https://xuyimingwork.github.io/vue-asyncx/hooks/use-async-data.html" ref="nofollow noopener noreferrer"><code>useAsyncData</code></a> 作出语义拆分：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ✅ useAsyncData: 区分 Data 与 Action </span>
<span class="hljs-keyword">const</span> { 
  user, <span class="hljs-comment">// 数据 </span>
  queryUser, <span class="hljs-comment">// 查询数据的方法 </span>
  queryUserLoading, <span class="hljs-comment">// 查询过程的 Loading </span>
  userExpired <span class="hljs-comment">// 数据过期状态 </span>
} = <span class="hljs-title function_">useAsyncData</span>(<span class="hljs-string">'user'</span>, fetchUserApi);
</code></pre>
<ul>
<li><code>user</code> 是异步的数据</li>
<li><code>queryUser</code> 是查询异步数据的函数</li>
<li><code>queryUserLoading</code> 绑定在查询函数上的状态</li>
</ul>
<h2 data-id="heading-3">为什么这对团队、前端架构至关重要？</h2>
<p>作为架构师，引入工具不仅仅是为了少写几行代码，更是为了<strong>治理</strong>。</p>
<h3 data-id="heading-4">1. 消除“方言”</h3>
<p>在没有工具约束时，团队代码往往充斥着方言：</p>
<ul>
<li><code>fetchData</code> vs <code>loadData</code> vs <code>getData</code></li>
<li><code>isSubmitting</code> vs <code>loading</code> vs <code>busy</code></li>
</ul>
<p><code>vue-asyncx</code> 通过 TS 类型系统，让 IDE 变成了你的代码规范检查员。当你输入 <code>const {</code> 并在 <code>useAsyncData('order')</code> 后触发代码提示时，IDE 只会给你 <code>queryOrder</code>，而不是别的。<strong>规范不再写在文档里，而是写在代码补全里。</strong></p>
<p>即使是<strong>前端新手</strong>，即使<strong>刚刚加入</strong>项目，也能写出命名风格一致的代码。</p>
<h3 data-id="heading-5">2. 提升 Code Review 效率</h3>
<p>当我在 Review 代码时，看到 <code>queryOrderLoading</code>，我甚至不需要看上下文，就知道这里有个 <code>queryOrder</code> 的动作，这里渲染 <code>order</code> 的数据；看到 <code>confirmLoading</code>，我知道这是一个操作反馈。</p>
<h3 data-id="heading-6">3. 类型安全的重构</h3>
<p>得益于 TS 的映射类型（Mapped Types），这些动态生成的属性名都是类型安全的。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 源码中的类型魔法</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">UseAsyncDataResult</span>&lt;<span class="hljs-title class_">Fn</span>, <span class="hljs-title class_">Name</span>&gt; = {
    [K <span class="hljs-keyword">in</span> <span class="hljs-title class_">Name</span>]: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-title class_">Data</span>&gt;; <span class="hljs-comment">// 动态生成 user</span>
} &amp; {
    [K <span class="hljs-keyword">in</span> <span class="hljs-string">`query<span class="hljs-subst">${Capitalize&lt;Name&gt;}</span>`</span>]: <span class="hljs-title class_">Fn</span>; <span class="hljs-comment">// 动态生成 queryUser</span>
}
</code></pre>
<p>如果你在重构时把 name 从 <code>'user'</code> 改成了 <code>'profile'</code>，TS 会立即报错，告诉你 <code>queryUser</code> 不存在了，请使用 <code>queryProfile</code>。这种安全感是手动重命名无法比拟的。</p>
<p>并且，使用时不需要多敲一个字符，复杂度都在工具里。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa60336bb79a4527a61925326ce0faea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5oeC5Zyo5o6Y6YeR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770208101&amp;x-signature=O%2FypmOtgxDIYuuzYFjsh4YqcEpQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">结语</h2>
<p>前端工程化发展到今天，我们不应该再把精力浪费在“给变量起名字”这种琐事上。</p>
<p><strong>好的工具应该通过设计（Design），让正确的事情变得自然而然（Default）。</strong></p>
<p>如果你厌倦了在组件里写一堆 <code>: data: xxxData</code>，不妨试试 <a href="https://link.juejin.cn?target=https%3A%2F%2Fxuyimingwork.github.io%2Fvue-asyncx%2F" target="_blank" title="https://xuyimingwork.github.io/vue-asyncx/" ref="nofollow noopener noreferrer"><code>vue-asyncx</code></a>。把命名权交给类型系统，把精力留给业务逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TS 在团队协作中到底有什么用？]]></title>    <link>https://juejin.cn/post/7600032104249196607</link>    <guid>https://juejin.cn/post/7600032104249196607</guid>    <pubDate>2026-01-28T12:39:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104249196607" data-draft-id="7600240045366493238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TS 在团队协作中到底有什么用？"/> <meta itemprop="keywords" content="TypeScript,前端"/> <meta itemprop="datePublished" content="2026-01-28T12:39:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="penjj"/> <meta itemprop="url" content="https://juejin.cn/user/3790771822811917"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TS 在团队协作中到底有什么用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771822811917/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    penjj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:39:18.000Z" title="Wed Jan 28 2026 12:39:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一个经常发生但不太被重视的瞬间</h2>
<p>你大概率写过这样的代码：</p>
<ul>
<li>从 <code>route.query.id</code> 里取 <code>id</code></li>
<li>把它转成 <code>number</code></li>
<li>然后继续请求接口/查列表/打开详情页</li>
</ul>
<p>当一切顺利时，它看起来很自然；当它不顺利时，你会看到两类“修复方式”：</p>
<ul>
<li><strong>强转把错误压下去</strong>：<code>route.query.id as string</code></li>
<li><strong>强行骗过编译器</strong>：<code>route.query.id as unknown as number</code></li>
</ul>
<p>问题是：这些写法并没有让数据更可靠，它们只是让编辑器不再提醒你“这里不确定”。</p>
<p>这篇文章想做的是把不确定性放回它应该待的位置：<strong>边界层</strong>。边界层负责把输入从“不可控”变“可控”，业务层才能更干净、更少分支、更少强转，也更适合长期迭代。</p>
<hr/>
<h2 data-id="heading-1">TS 在团队里解决的不是“类型”，而是“确定性”</h2>
<p>在个人项目里，TS 有时更像“仪式感”；在团队里，它是把协作成本显性化的一种方式。</p>
<ul>
<li><strong>需求变动时</strong>：字段改名、可选变必填、枚举新增分支，TS 能把影响面直接标出来。</li>
<li><strong>重构时</strong>：你更敢删代码、更敢改数据结构，因为编译器会帮你找遗漏。</li>
<li><strong>Code Review 时</strong>：类型比注释更可信，它是能被工具验证的约束。</li>
</ul>
<p>但前提是：你得让 TS 有机会说话，而不是一遇到“不确定”就把它静音。</p>
<hr/>
<h2 data-id="heading-2">正确认识 <code>any</code>、<code>unknown</code>、<code>never</code>：三种“态度”</h2>
<h3 data-id="heading-3"><code>any</code>：不是“我知道是什么”，而是“别管我”</h3>
<p><code>any</code> 最大的问题不是“不严谨”，而是<strong>它会传播</strong>。</p>
<p>一旦某个输入变成 <code>any</code>，后续所有计算、属性访问、函数调用都可能在不报错的情况下继续前进，直到线上某个分支被击中。</p>
<p>团队实践上更好的定位是：</p>
<ul>
<li>把 <code>any</code> 当作“紧急通行证”</li>
<li>只允许出现在：
<ul>
<li>第三方库类型缺失且短期不可补齐</li>
<li>大规模迁移期的过渡层（并且要有收口计划）</li>
</ul>
</li>
<li>在业务核心链路上尽量避免它</li>
</ul>
<h3 data-id="heading-4"><code>unknown</code>：最诚实的起点</h3>
<p><code>unknown</code> 的意义是：<strong>我承认这里不确定，但我会在使用之前把它证明成确定。</strong></p>
<p>这在 Vue3 项目里很常见：</p>
<ul>
<li><code>route.query</code>（URL 输入）</li>
<li>接口返回（跨服务输入）</li>
<li><code>localStorage</code>（持久化输入）</li>
<li><code>window</code>/<code>document</code> 上的扩展属性（环境输入）</li>
</ul>
<p>这些输入不是“写死的本地变量”，它们是世界给你的，默认就该从 <code>unknown</code> 开始思考，而不是从“我希望它是 string”开始。</p>
<h3 data-id="heading-5"><code>never</code>：让“遗漏分支”变成编译期问题</h3>
<p><code>never</code> 常用于两件事：</p>
<ul>
<li><strong>穷尽检查</strong>：联合类型新增分支时，提醒你补齐逻辑</li>
<li><strong>不可达证明</strong>：告诉读者和工具“这里不应该发生”</li>
</ul>
<p>你可以把它理解为：在团队协作里，用 <code>never</code> 把“你肯定不会遇到”的话，变成“工具可以验证不会遇到”。</p>
<hr/>
<h2 data-id="heading-6">把 <code>route.query</code> 从“不可信”收口成“可用”</h2>
<p><code>route.query</code> 的本质是 URL 参数，它天然不可靠：</p>
<ul>
<li>可能没有传：<code>undefined</code></li>
<li>可能重复传：<code>string[]</code></li>
<li>可能传了空字符串、非法字符、甚至恶意内容</li>
</ul>
<p>如果你的业务需要的是 <code>number</code>，那就意味着你必须做两件事：</p>
<ul>
<li><strong>运行时校验</strong>：把不合法输入挡在边界层</li>
<li><strong>类型层表达</strong>：让后续代码拿到的就是确定类型</li>
</ul>
<h3 data-id="heading-7">先从最小的类型守卫开始</h3>
<p>不要让 <code>as string</code> 成为你的第一反应。更可维护的方式是写可复用的 guard：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">x: <span class="hljs-built_in">unknown</span></span>): x is <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'string'</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isStringArray</span>(<span class="hljs-params">x: <span class="hljs-built_in">unknown</span></span>): x is <span class="hljs-built_in">string</span>[] {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(x) &amp;&amp; x.<span class="hljs-title function_">every</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> i === <span class="hljs-string">'string'</span>)
}
</code></pre>
<p>这两段代码的价值不在于“写起来高级”，而在于：</p>
<ul>
<li>它们把“证据”写成了函数</li>
<li>任何人都能复用</li>
<li>你在 review 时能清楚看到“为什么这里变成 string 了”</li>
</ul>
<h3 data-id="heading-8">把 query 的收口做成一个小工具</h3>
<p>业务里最常见的是“取一个 query 参数并保证它是单个字符串”。可以定义一个收口函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getSingleQueryString</span>(<span class="hljs-params">x: <span class="hljs-built_in">unknown</span></span>): <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'string'</span>) <span class="hljs-keyword">return</span> x
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(x)) <span class="hljs-keyword">return</span> x[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
}
</code></pre>
<p>然后针对常见需求再包一层：例如取数字 <code>id</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getQueryNumber</span>(<span class="hljs-params">x: <span class="hljs-built_in">unknown</span></span>): <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> {
  <span class="hljs-keyword">const</span> s = <span class="hljs-title function_">getSingleQueryString</span>(x)
  <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^\d+$/</span>.<span class="hljs-title function_">test</span>(s)) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
  <span class="hljs-keyword">const</span> n = <span class="hljs-title class_">Number</span>(s)
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isFinite</span>(n) ? n : <span class="hljs-literal">undefined</span>
}
</code></pre>
<p>这样业务代码会变得很“单纯”：</p>
<ul>
<li>你拿到的是 <code>number | undefined</code></li>
<li>你只需要处理“有没有 id”，而不是处理一堆类型分支</li>
<li>更不会出现 <code>as unknown as number</code></li>
</ul>
<h3 data-id="heading-9">类型缩窄（Type Narrowing）不是花活，是“证据链”</h3>
<p>上面几段代码其实只做了一件事：把“不确定”一步步缩窄成“确定”。</p>
<p>常用的缩窄手段在这里非常自然：</p>
<ul>
<li><code>typeof x === 'string'</code></li>
<li><code>Array.isArray(x)</code></li>
<li><code>x != null</code></li>
<li>业务校验：正则、<code>Number.isFinite</code>、范围判断等</li>
</ul>
<p>把这些校验集中在边界层，你的业务逻辑会得到一个好处：<strong>分支更少、强转更少、边界更清晰</strong>。</p>
<h3 data-id="heading-10">结合 <code>unplugin-vue-router</code>：它能帮你，但不会替你收口 query</h3>
<p><code>unplugin-vue-router</code> 往往能让“路由结构相关”的类型更聪明，比如某些路由 name、params 的推断。但无论有没有它，<code>query</code> 仍然是 URL 输入：</p>
<ul>
<li>它属于“外部世界”</li>
<li>它不会因为你用了更强的路由工具就自动变可靠</li>
</ul>
<p>因此实践上很推荐把 query 的收口当作一套团队基础设施：统一 guard/parse，统一处理策略（缺失就兜底？非法就报错？）。</p>
<hr/>
<h2 data-id="heading-11"><code>as</code> 的边界：断言不是“类型转换”，是“誓言”</h2>
<p>很多 TS 使用体验变差，来自于对 <code>as</code> 的误解。</p>
<h3 data-id="heading-12"><code>as</code> 不会改变运行时的值</h3>
<p>这句话值得反复强调：<code>as</code> 只发生在类型层，它不会把 <code>"123"</code> 变成 <code>123</code>，也不会把 <code>undefined</code> 变成你想要的值。</p>
<p>所以 <code>as</code> 的正确使用场景是：</p>
<ul>
<li>你已经有运行时证据</li>
<li>你是在把证据告诉编译器</li>
</ul>
<p>例如你前面做了 <code>typeof x === 'string'</code>，此时不需要 <code>as string</code>，编译器已经知道了。真正需要断言的情况往往更少，且更具体。</p>
<h3 data-id="heading-13">警惕 <code>as unknown as T</code>：它通常意味着“我不想处理”</h3>
<p><code>X as unknown as T</code> 的本质是：</p>
<ul>
<li>第一次把类型抬到 <code>unknown</code>（绕过结构检查）</li>
<li>第二次直接落到目标类型 <code>T</code>（绕过合理性）</li>
</ul>
<p>它可以在极少数边界场景救火，但在业务代码里大量出现时，通常说明：</p>
<ul>
<li>输入边界没收口</li>
<li>类型模型设计失败（太宽/太窄）</li>
<li>本该是“解析 + 校验”的问题，被用“强转”掩盖了</li>
</ul>
<p>一个简单但很有效的团队共识是：</p>
<ul>
<li><strong>业务代码里尽量禁止 <code>as unknown as T</code></strong></li>
<li>如果必须使用，只允许在边界层，并说明原因与风险</li>
</ul>
<hr/>
<h2 data-id="heading-14">接口返回类型，从 <code>unknown</code> 起步更安全</h2>
<p>很多人对接口返回类型的直觉是：后端给了字段文档，前端写个类型就完了。</p>
<p>现实是：</p>
<ul>
<li>后端灰度期间字段可能不一致</li>
<li>某些字段可能为空、为 null、为字符串数字</li>
<li>错误时可能返回另一种结构</li>
</ul>
<p>把接口返回当成可信输入，最后往往就是“业务里到处判空 + 到处强转”。</p>
<p>更可持续的写法是分层：</p>
<ul>
<li><strong>边界层（API 层）</strong>：<code>unknown</code> -&gt; parse/validate -&gt; 得到稳定类型</li>
<li><strong>业务层</strong>：只处理稳定类型，不关心“数据怎么来的、脏不脏”</li>
</ul>
<h3 data-id="heading-15">最小落地方式：写解析器，不必立刻引入大框架</h3>
<p>你可以先不引入复杂的 schema 工具，先从“解析函数”开始，把不可信输入收口：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parseUser</span>(<span class="hljs-params">x: <span class="hljs-built_in">unknown</span></span>): <span class="hljs-title class_">User</span> | <span class="hljs-literal">undefined</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> x !== <span class="hljs-string">'object'</span> || x == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">const</span> obj = x <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;
  <span class="hljs-keyword">const</span> id = <span class="hljs-keyword">typeof</span> obj.<span class="hljs-property">id</span> === <span class="hljs-string">'number'</span> ? obj.<span class="hljs-property">id</span> : <span class="hljs-literal">undefined</span>
  <span class="hljs-keyword">const</span> name = <span class="hljs-keyword">typeof</span> obj.<span class="hljs-property">name</span> === <span class="hljs-string">'string'</span> ? obj.<span class="hljs-property">name</span> : <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> || name == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
  <span class="hljs-keyword">return</span> { id, name }
}
</code></pre>
<p>这里你会注意到一个微妙点：<code>as Record&lt;string, unknown&gt;</code> 是一种“受控断言”——你没有直接断言成 <code>User</code>，你断言成了更保守的结构，然后通过缩窄/校验把它变成 <code>User</code>。</p>
<p>这比一上来 <code>x as User</code> 的差别在于：<strong>你把证据写出来了。</strong></p>
<h3 data-id="heading-16">让边界层失败得更明确</h3>
<p>在接口层如果解析失败，你可以选择：</p>
<ul>
<li>直接抛错（让错误早暴露）</li>
<li>返回 <code>undefined</code> 并统一兜底</li>
<li>上报埋点并返回降级数据</li>
</ul>
<p>关键不是选哪一种，而是：不要把失败“带进业务层”，否则业务层每个点都得为边界失败买单。</p>
<hr/>
<h2 data-id="heading-17"><code>satisfies</code> + <code>as const</code>：把“配置错误”变成编译期错误</h2>
<p>Vue3 团队往往有大量“表驱动”的代码：</p>
<ul>
<li>路由 meta 映射</li>
<li>权限 key -&gt; 文案/策略</li>
<li>状态 -&gt; 展示/行为配置</li>
</ul>
<p>这类对象最怕两件事：</p>
<ul>
<li>写漏字段、写错字段名</li>
<li>字面量被扩大成 <code>string</code>，导致补全与约束失效</li>
</ul>
<p><code>as const</code> 能保住字面量，<code>satisfies</code> 能校验结构，但不破坏推断。</p>
<p>你想达到的效果通常是：</p>
<ul>
<li>配置对象的 key/value 仍保持字面量类型（便于自动补全）</li>
<li>同时它必须满足某个结构（便于团队约束与代码生成/消费）</li>
</ul>
<p>一句话概括：</p>
<ul>
<li><code>as Type</code> 更像“我宣称它是”</li>
<li><code>satisfies Type</code> 更像“请你验证它符合”</li>
</ul>
<p>当你的团队大量依赖配置与约束时，<code>satisfies</code> 往往比 <code>as</code> 更像“工程化”的选择。</p>
<hr/>
<h2 data-id="heading-18">把 TS 当成“面向生产的语言”来写</h2>
<p>TS 不参与运行，但你写 TS 的方式会直接影响运行时代码的质量。一个很实用的心智模型是：</p>
<ul>
<li>写 TS 时同时在脑中运行两套解释器：
<ul>
<li>TS 编译器：帮你看见结构、分支、遗漏</li>
<li>JS 解释器：提醒你运行时到底可能拿到什么</li>
</ul>
</li>
</ul>
<p>当你看到自己在某个地方写了很多强转、很多“我觉得它应该是”，往往是一个信号：<strong>你应该停下来，把边界收口做扎实。</strong></p>
<hr/>
<h2 data-id="heading-19">附录：三组“偏实用”的类型体操（用于约束与可读性）</h2>
<p>这一部分不追求炫技，追求两件事：</p>
<ul>
<li>让类型提示更好读（利于 review、利于维护）</li>
<li>把“调用约束”写进类型里（利于长期协作）</li>
</ul>
<h3 data-id="heading-20"><code>Prettify&lt;T&gt;</code>：让类型变得可读</h3>
<p>很多时候你组合了几个工具类型、交叉类型后，IDE 提示会变得又长又难看。<code>Prettify</code> 的目标是把它“展开成更直观的对象形态”。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Prettify</span>&lt;T&gt; = { [K <span class="hljs-keyword">in</span> keyof T]: T[K] } &amp; {}
</code></pre>
<p>使用场景：</p>
<ul>
<li>API 返回类型经过多层组合后难读</li>
<li>Vue 组件 props 类型被交叉/扩展后提示难看</li>
<li>你希望把最终类型以“扁平结构”展示出来方便理解</li>
</ul>
<p>这类体操的价值非常朴素：<strong>减少误读</strong>。</p>
<h3 data-id="heading-21"><code>RequireKeys&lt;T, K&gt;</code> / <code>OptionalKeys&lt;T, K&gt;</code>：表达“同一对象在不同阶段的形态”</h3>
<p>在业务里你经常遇到：</p>
<ul>
<li>创建时必须有 <code>name</code></li>
<li>更新时 <code>name</code> 可选</li>
<li>某些字段在特定状态下必须存在</li>
</ul>
<p>用工具类型表达这类约束，比在注释里写“这个字段更新时可以不传”更可靠。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">RequireKeys</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; =
  T &amp; { [P <span class="hljs-keyword">in</span> K]-?: T[P] }

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">OptionalKeys</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; =
  <span class="hljs-title class_">Omit</span>&lt;T, K&gt; &amp; <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">Pick</span>&lt;T, K&gt;&gt;
</code></pre>
<h3 data-id="heading-22"><code>XOR&lt;T, U&gt;</code>：二选一约束（组件 props / API 参数）</h3>
<p>很多 API/组件都存在“二选一”的输入：</p>
<ul>
<li>传 <code>id</code> 或 <code>slug</code></li>
<li>传 <code>value</code> 或 <code>modelValue</code></li>
<li>传 <code>path</code> 或 <code>name</code></li>
</ul>
<p>用类型表达约束能让调用方更早犯错。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Without</span>&lt;T, U&gt; = { [P <span class="hljs-keyword">in</span> <span class="hljs-title class_">Exclude</span>&lt;keyof T, keyof U&gt;]?: <span class="hljs-built_in">never</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-variable constant_">XOR</span>&lt;T, U&gt; =
  (T &amp; <span class="hljs-title class_">Without</span>&lt;U, T&gt;) | (U &amp; <span class="hljs-title class_">Without</span>&lt;T, U&gt;)
</code></pre>
<p>注意边界：</p>
<ul>
<li>XOR 让类型更强，但也可能让类型报错信息更复杂</li>
<li>一旦团队成员难以理解，就应该用更简单的约束方式（例如拆成两个 API/两个 props 形态）</li>
</ul>
<hr/>
<h2 data-id="heading-23">团队落地建议：从这几条开始就够了</h2>
<ul>
<li><strong>边界层默认不可信</strong>：<code>route.query</code>、接口返回、localStorage 从 <code>unknown</code> 思维起步</li>
<li><strong>缩窄优先</strong>：先写 <code>typeof</code>/<code>Array.isArray</code>/guard，再写业务逻辑</li>
<li><strong>断言慎用</strong>：尽量不用 <code>as unknown as T</code>；如果用了，放在边界层并说明原因</li>
<li><strong>配置表优先用 <code>satisfies</code></strong>：减少“用断言掩盖配置错误”</li>
<li><strong>强转多是信号</strong>：说明收口/建模/推断没做好，应该回到边界层修结构</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建高性能 BackToTop 组件：滚动监听与节流优化实践]]></title>    <link>https://juejin.cn/post/7600245693997350922</link>    <guid>https://juejin.cn/post/7600245693997350922</guid>    <pubDate>2026-01-28T12:46:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600245693997350922" data-draft-id="7600245693997334538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建高性能 BackToTop 组件：滚动监听与节流优化实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T12:46:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建高性能 BackToTop 组件：滚动监听与节流优化实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:46:17.000Z" title="Wed Jan 28 2026 12:46:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着内容不断增长，用户常常需要快速返回页面顶部。一个智能的“回到顶部”按钮不仅能提升用户体验，还能体现产品的细节打磨。然而，实现这样一个看似简单的功能，却隐藏着性能与内存管理的关键考量。本文将深入剖析如何用 React 和 TypeScript 构建一个<strong>高效、健壮、可复用</strong>的 <code>BackToTop</code> 组件。</p>
<h2 data-id="heading-0">核心逻辑：基于滚动位置的显隐控制</h2>
<p>组件的核心需求是：当页面向下滚动超过一定阈值（如 400 像素）时显示按钮，否则隐藏。这需要监听 <code>window</code> 的 <code>scroll</code> 事件，并实时获取 <code>window.scrollY</code> 的值：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">toggleVisibility</span> = () =&gt; {
  setIsVisible(window.scrollY &gt; threshold)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p>通过 <code>useState</code> 管理 <code>isVisible</code> 状态，组件能自动响应滚动变化，动态渲染或移除按钮。这种声明式更新符合 React 的核心思想——状态驱动 UI。</p>
<h2 data-id="heading-1">性能陷阱：高频事件与节流优化</h2>
<p><code>scroll</code> 事件在用户滚动时会以极高频率触发（每秒数十次），若每次触发都执行状态更新，将导致大量不必要的重渲染，严重拖慢页面性能。为此，必须对事件处理函数进行<strong>节流（Throttle）</strong> ：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">export function throttle(<span class="hljs-function"><span class="hljs-keyword">fun</span>: ThrottleFunction, delay: number): ThrottleFunction {</span>
  let last: number | undefined;
  let deferTimer: NodeJS.Timeout | undefined;

  <span class="hljs-keyword">return</span> function (...args: any[]) {
    <span class="hljs-keyword">const</span> now = +new Date();
    <span class="hljs-keyword">if</span> (last &amp;&amp; now &lt; last + delay) {
      clearTimeout(deferTimer);
      deferTimer = setTimeout(() =&gt; {
        last = now;
        <span class="hljs-function"><span class="hljs-title">fun</span><span class="hljs-params">(...args)</span></span>;
      }, delay);
    } <span class="hljs-keyword">else</span> {
      last = now;
      <span class="hljs-function"><span class="hljs-title">fun</span><span class="hljs-params">(...args)</span></span>;
    }
  };
}
</code></pre>
<p>该工具函数确保 <code>toggleVisibility</code> 在指定时间间隔（如 200 毫秒）内最多执行一次。即使用户疯狂滚动，实际的状态检查和更新也被限制在合理频率，极大减轻了主线程负担。</p>
<h2 data-id="heading-2">内存安全：清理副作用防止泄漏</h2>
<p>React 组件可能在任意时刻卸载。若未移除事件监听器，<code>scroll</code> 事件仍会持续调用已卸载组件中的函数，不仅浪费资源，还可能因状态更新引发警告甚至崩溃。因此，<code>useEffect</code> 的清理函数至关重要：</p>
<pre><code class="hljs language-ini" lang="ini">useEffect(() =&gt; {
  const <span class="hljs-attr">throttledFunc</span> = throttle(toggleVisibility, <span class="hljs-number">200</span>)<span class="hljs-comment">;</span>
  window.addEventListener('scroll', throttledFunc)<span class="hljs-comment">;</span>
  return () =&gt; {
    window.removeEventListener('scroll', throttledFunc)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}, <span class="hljs-section">[threshold]</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>这里，<code>useEffect</code> 返回一个清理函数，在组件卸载或 <code>threshold</code> 变化时自动移除监听器。同时，将 <code>threshold</code> 作为依赖项，确保当外部传入新阈值时，能重新绑定带有最新逻辑的监听器。</p>
<h2 data-id="heading-3">用户体验：平滑滚动与视觉反馈</h2>
<p>点击按钮后，不应生硬地跳转到顶部，而应提供流畅的过渡效果：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">scrollToTop</span> = () =&gt; {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  })<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><code>behavior: 'smooth'</code> 利用浏览器原生支持，实现优雅的滚动动画。配合 Tailwind CSS 定义的固定定位、圆角、阴影和悬停效果，按钮在视觉上既醒目又不突兀，层级（<code>z-50</code>）确保其始终位于内容之上。</p>
<h2 data-id="heading-4">类型安全：Props 与工具函数的约束</h2>
<p>TypeScript 为组件提供了完整的类型保障：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">BackToTopProps</span> {
  threshold?: number;
}
</code></pre>
<p><code>threshold</code> 被定义为可选数字，默认值 400，调用者无需记忆参数类型。节流函数也通过泛型约束，确保传入和返回的都是合法函数，避免运行时错误。
一个优秀的通用组件，不仅要功能正确，更要兼顾性能、内存安全和用户体验。<code>BackToTop</code> 组件虽小，却完整体现了现代前端开发的核心原则：<strong>用节流对抗高频事件，用清理函数守护内存，用类型系统预防错误，用细节打磨体验</strong>。这些实践不仅适用于此场景，更是构建任何复杂交互的基础。在追求极致性能与稳定性的今天，这样的工程思维，正是区分“能用”与“好用”的关键所在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建高性能幻灯片组件：基于 shadcn/ui 与 Embla Carousel 的实践]]></title>    <link>https://juejin.cn/post/7600245693997367306</link>    <guid>https://juejin.cn/post/7600245693997367306</guid>    <pubDate>2026-01-28T12:50:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600245693997367306" data-draft-id="7600299283484688434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建高性能幻灯片组件：基于 shadcn/ui 与 Embla Carousel 的实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T12:50:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建高性能幻灯片组件：基于 shadcn/ui 与 Embla Carousel 的实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:50:50.000Z" title="Wed Jan 28 2026 12:50:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动端和响应式 Web 应用中，轮播图（Carousel）是展示核心内容、引导用户注意力的关键组件。然而，一个流畅、可定制且性能优良的轮播实现并不简单——它需要处理自动播放、手势交互、指示器同步、资源优化等多重挑战。本文将深入解析如何利用 <strong>shadcn/ui 的 Carousel 组件</strong> 和 <strong>Embla Carousel 引擎</strong>，构建一个功能完整、体验优雅的 <code>SlideShow</code> 组件。</p>
<h2 data-id="heading-0">分层架构：组合优于继承</h2>
<p>shadcn/ui 提供了一组语义清晰的 Carousel 子组件：</p>
<ul>
<li><code>Carousel</code>：根容器，管理整体状态；</li>
<li><code>CarouselContent</code>：滑动轨道，包裹所有项目；</li>
<li><code>CarouselItem</code>：单个幻灯片项。</li>
</ul>
<p>这种分层结构让开发者能自由组合布局，而非被固定模板束缚。我们的 <code>SlideShow</code> 组件正是基于此构建：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Carousel</span> <span class="hljs-attr">setApi</span>=<span class="hljs-string">{setApi}</span> <span class="hljs-attr">plugins</span>=<span class="hljs-string">{plugins}</span> <span class="hljs-attr">opts</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">loop:</span> <span class="hljs-attr">true</span> }}&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">CarouselContent</span>&gt;</span>
    {slides.map(({ id, image, title }) =&gt; (
      <span class="hljs-tag">&lt;<span class="hljs-name">CarouselItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span>&gt;</span>
        {/* 幻灯片内容 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">CarouselItem</span>&gt;</span>
    ))}
  <span class="hljs-tag">&lt;/<span class="hljs-name">CarouselContent</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Carousel</span>&gt;</span>
</code></pre>
<p>通过 <code>setApi</code> 获取 Carousel 实例，我们得以监听选中事件、控制滚动行为，实现高度定制化。</p>
<h2 data-id="heading-1">自动播放：插件化与性能考量</h2>
<p>自动播放是轮播图的核心功能之一。Embla Carousel 通过插件机制实现此能力：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">plugin</span> = <span class="hljs-title function_ invoke__">useRef</span>(
  autoPlay ? <span class="hljs-title function_ invoke__">AutoPlay</span>({ <span class="hljs-attr">delay</span>: autoPlayDelay, <span class="hljs-attr">stopOnInteraction</span>: <span class="hljs-literal">true</span> }) : <span class="hljs-literal">null</span>
);
</code></pre>
<p>这里使用 <code>useRef</code> 而非 <code>useState</code> 存储插件实例，因为：</p>
<ol>
<li>插件对象无需触发重渲染；</li>
<li><code>useRef</code> 能在组件整个生命周期内保持引用不变，避免因重新创建插件导致内存泄漏或行为异常。</li>
</ol>
<p>同时，通过 <code>onMouseEnter</code>/<code>onMouseLeave</code> 监听用户交互，暂停/恢复自动播放，提升体验：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">onMouseEnter</span>={() =&gt; plugin.current?.stop()}
<span class="hljs-attr">onMouseLeave</span>={() =&gt; plugin.current?.reset()}
</code></pre>
<h2 data-id="heading-2">指示器同步：监听 API 事件</h2>
<p>指示器需实时反映当前激活的幻灯片。我们通过 Carousel API 的 <code>'select'</code> 事件实现同步：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  if (!api) return;
  <span class="hljs-built_in">setSelectedIndex</span>(api.selectedScrollSnap());
  const onSelect = () =&gt; <span class="hljs-built_in">setSelectedIndex</span>(api.selectedScrollSnap());
  api<span class="hljs-selector-class">.on</span>('select', onSelect);
  return () =&gt; api<span class="hljs-selector-class">.off</span>('select', onSelect);
}, <span class="hljs-selector-attr">[api]</span>);
</code></pre>
<p><code>selectedScrollSnap()</code> 返回当前激活项的索引。通过监听 <code>'select'</code> 事件，确保指示器状态与轮播位置严格一致，并在组件卸载时移除监听器，防止内存泄漏。</p>
<h2 data-id="heading-3">视觉优化：渐变遮罩替代纯色背景</h2>
<p>为提升标题可读性，常在图片上叠加半透明遮罩。传统做法可能额外引入一张 PNG 图片，增加 HTTP 请求。我们采用 CSS 渐变实现：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> className="bg-gradient-<span class="hljs-selector-tag">to</span>-t <span class="hljs-selector-tag">from</span>-black/<span class="hljs-number">60</span> <span class="hljs-selector-tag">to</span>-transparent"&gt;
  &lt;<span class="hljs-selector-tag">h3</span>&gt;{title}&lt;/<span class="hljs-selector-tag">h3</span>&gt;
&lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<p><code>from-black/60</code> 表示底部为 60% 不透明度的黑色，顶部透明。这种方式零额外请求、完全由 CSS 渲染，既节省带宽，又保证视觉层次。</p>
<h2 data-id="heading-4">类型安全与可配置性</h2>
<p>组件通过 TypeScript 接口明确输入：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">SlideData</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">image</span>: <span class="hljs-built_in">string</span>;
  title?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SlideShowProps</span> {
  <span class="hljs-attr">slides</span>: <span class="hljs-title class_">SlideData</span>[];
  autoPlay?: <span class="hljs-built_in">boolean</span>;
  autoPlayDelay?: <span class="hljs-built_in">number</span>;
}
</code></pre>
<p>调用者只需提供符合结构的数据，即可获得完整功能。默认参数（<code>autoPlay=true</code>, <code>autoPlayDelay=3000</code>）降低使用门槛，同时保留灵活性。这个 <code>SlideShow</code> 组件展示了现代前端工程的核心理念：<strong>利用成熟库的能力（Embla）、遵循组合式设计（shadcn/ui）、关注性能细节（节流、渐变优化）、保障类型安全（TypeScript）</strong> 。它不仅满足了基本轮播需求，更通过插件机制、API 监听和交互反馈，提供了接近原生应用的流畅体验。在追求极致用户体验的今天，这样的组件正是构建高质量产品的基石。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[救命！我那加载慢到离谱的图片，终于被懒加载 “救活” 了]]></title>    <link>https://juejin.cn/post/7600224355294576667</link>    <guid>https://juejin.cn/post/7600224355294576667</guid>    <pubDate>2026-01-28T12:55:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600224355294576667" data-draft-id="7600002531398369289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="救命！我那加载慢到离谱的图片，终于被懒加载 “救活” 了"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2026-01-28T12:55:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            救命！我那加载慢到离谱的图片，终于被懒加载 “救活” 了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:55:16.000Z" title="Wed Jan 28 2026 12:55:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>你一定有这样的经历：打开一个图片超多的页面，进度条像蜗牛一样爬，屏幕上全是<strong>空白的占位框</strong>，你甚至怀疑自己的网是不是欠费了。</p>
<p>其实这不是你的网络问题，而是页面在一股脑<strong>加载所有图片</strong>，哪怕它们<strong>还在屏幕外面躺着</strong>。这就好比<strong>疯狂星期四你点了一份全家桶</strong>，结果服务员把一年的量都端了上来，你吃不完，还得花大力气搬回家。</p>
<p>好了，那么遇到问题就要解决问题。<strong>懒加载</strong>就是来解决这个问题的 <strong>“聪明服务员”</strong>—— 它只在你<strong>需要的时候</strong>，才把图片端到你面前。</p>
<blockquote>
<p>除了图片，比如视频、音频、甚至是整个 DOM 模块（比如长列表里的卡片、分页内容）都可以用懒加载来优化，本文用图片做代表。</p>
</blockquote>
<h3 data-id="heading-1">一、懒加载到底是什么？</h3>
<p>简单来说，懒加载就是 <strong>“按需加载”</strong>。通俗来讲不就是 <strong>“懒得加载”</strong> 嘛。</p>
<p>具体实现如下：</p>
<ul>
<li>页面刚打开时，<strong>只加载当前屏幕里能看到的图片（或视频等等）</strong>。</li>
<li>等你往下滚动页面，其他图片才会在<strong>进入视野的瞬间加载出来</strong>。</li>
<li>这样一来，页面首次加载速度直接起飞，用户体验瞬间拉满。</li>
</ul>
<p>就比如刷小红书刷快了，图片就会变成这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2d9f3d6cfed45aba012947d46df20c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209716&amp;x-signature=JZIU46js8gAf2NdMyxIs8gSPKnI%3D" alt="image.png" loading="lazy"/></p>
<p>这可不能让网络背锅，这就是运用到了 -- <strong>懒加载</strong>，既不耗太多性能，也不影响用户的体验。</p>
<h3 data-id="heading-2">二、传统懒加载：用滚动监听 + 节流实现</h3>
<p>这是最经典的懒加载方案，核心思路是<strong>监听滚动事件</strong>，判断图片是否进入了<strong>可视区域</strong>。</p>
<h4 data-id="heading-3">先上代码：第一个懒加载实现</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 可视区域高度</span>
<span class="hljs-keyword">const</span> visibleHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;

<span class="hljs-comment">// 懒加载函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">lazyLoad</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> imgs = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img[lazyload]'</span>);
    imgs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> rect = item.<span class="hljs-title function_">getBoundingClientRect</span>();
        <span class="hljs-comment">// 判断图片是否在可视区域内</span>
        <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">top</span> &lt; visibleHeight &amp;&amp; rect.<span class="hljs-property">bottom</span> &gt;= <span class="hljs-number">0</span>) {
            item.<span class="hljs-property">src</span> = item.<span class="hljs-property">dataset</span>.<span class="hljs-property">origin</span>;
            item.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-string">'lazyload'</span>);
        }
    })
}

<span class="hljs-comment">// 节流函数：防止滚动事件触发太频繁</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">fn, <span class="hljs-keyword">await</span></span>) {
    <span class="hljs-keyword">let</span> preTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> nowTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-keyword">if</span> (nowTime - preTime &gt;= <span class="hljs-keyword">await</span>) {
            preTime = nowTime;
            <span class="hljs-title function_">fn</span>();
        }
    }
}

<span class="hljs-comment">// 初始化和监听</span>
<span class="hljs-title function_">lazyLoad</span>();
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-title function_">throttle</span>(lazyLoad, <span class="hljs-number">200</span>));
</code></pre>
<h4 data-id="heading-4">原理拆解：玩转懒加载</h4>
<ol>
<li><code>window.innerHeight</code> 先拿到当前屏幕的高度，这是我们的 <strong>“视野范围”</strong></li>
<li><code>getBoundingClientRect()</code> 用来获取图片元素相对于视口的位置。</li>
<li>当图片的<strong>顶部进入视口</strong>（<code>rect.top &lt; visibleHeight</code>），并且<strong>底部还没完全离开视口</strong>（<code>rect.bottom &gt;= 0</code>）时，就把 <code>data-origin</code> 里的真实地址赋值给 <code>src</code>，图片就开始加载了。</li>
<li>最后别忘了用节流函数 <code>throttle</code>，不然滚动一下触发几十次 <code>lazyLoad</code>，性能开销会很大。</li>
</ol>
<p>了解原理我们直接加上<code>html</code>代码，并且找<code>10张图片</code>实践一下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">img</span>{
            <span class="hljs-attribute">display</span>: block;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/OG4Cnt2SgXAuTj-Vv77ASGszUj1BwOhUXtBCplSlBfQmAAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/Os3eJ8u3SgB3Kd-zrRRhgfR5hUvdwcVPKUTNO6O7sZfUwAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/news_bt/OceYG4p3E6SGFqFBN500JOHSiO4recmt6S1_fml1rlgUEAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://img1.baidu.com/it/u=2631091293,484496842&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=889&amp;h=500"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://img2.baidu.com/it/u=3107839948,3570219976&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=750&amp;h=500"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/O98tXzU2bQgRJ5nRiiJQx_6uwzkB_rsF9e6TA7kcXr058AA/1000"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/Oz13eqQ6iXnUgh-eQxuXT8VmWvogpk66DvRM52Oe0QbNQAA/1000"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/Otvjht3x4wA58ZkSIxSo88NZTsyD6ZdUyiLMHZmGFoHokAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/news_bt/O7ZsQ9IrSfcWAWLPeaRcfeEt5FdyeTfnFYrSGmDSKlU0sAA/1000"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/O_2D2lSAfCS8o9_fGMsuNxOArO_rS1j9Nc2vsYaEaq2PwAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 可视区域的高度</span>
        <span class="hljs-keyword">const</span> visibleHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;

        <span class="hljs-comment">// 懒加载函数</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">lazyLoad</span>(<span class="hljs-params"/>){
            <span class="hljs-keyword">const</span> imgs = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img[lazyload]'</span>);
            <span class="hljs-comment">// console.log(imgs);</span>

            <span class="hljs-comment">// 判断哪些 img 在可视区域内</span>
            imgs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">123</span>);
                <span class="hljs-keyword">const</span> rect = item.<span class="hljs-title function_">getBoundingClientRect</span>();
                <span class="hljs-keyword">if</span>(rect.<span class="hljs-property">top</span> &lt; visibleHeight &amp;&amp; rect.<span class="hljs-property">bottom</span> &gt;= <span class="hljs-number">0</span>){
                    item.<span class="hljs-property">src</span> = item.<span class="hljs-property">dataset</span>.<span class="hljs-property">origin</span>;
                    item.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-string">'lazyload'</span>);
                }
            })
        }
        <span class="hljs-title function_">lazyLoad</span>();
        <span class="hljs-comment">// 监听滚动事件</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-title function_">throttle</span>(lazyLoad, <span class="hljs-number">200</span>));

        <span class="hljs-comment">// 节流函数</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">fn, <span class="hljs-keyword">await</span></span>){  <span class="hljs-comment">// 在规定时间内只执行一次</span>
            <span class="hljs-keyword">let</span> preTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
            <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">const</span> nowTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
                <span class="hljs-keyword">if</span> (nowTime - preTime &gt;= <span class="hljs-keyword">await</span>){
                    preTime = nowTime;
                    <span class="hljs-title function_">fn</span>();
                }
            }
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>可以看到我刚打开浏览器就出现了<code>4张图片</code>，并且这<code>4张图片</code>已经加载好了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ae1cbdc7524e4789699da825596f16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209716&amp;x-signature=VOnWX64fM%2F%2Bc%2Bmz0YcW0w1SDB%2Bw%3D" alt="image.png" loading="lazy"/></p>
<p>很好，那当我们往下滑时，你会发现图片只要在<strong>可视区域</strong>就加载出来：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48c2d8e5a89a4391a2a212a0e6b1c629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209716&amp;x-signature=X03wdZ9HA%2Fwmtz12vDT1N6CRo%2BA%3D" alt="image.png" loading="lazy"/></p>
<p>这个大家可以自己<code>copy代码</code>去试试因为图片看不出效果😭。</p>
<h3 data-id="heading-5">三、现代懒加载：用 IntersectionObserver 躺赢</h3>
<p>传统方案需要自己监听滚动、计算位置，有点像<strong>手动开车</strong>。而 <code>IntersectionObserver</code> 就像<strong>自动驾驶</strong>，它会自动告诉你元素什么时候进入了视口。</p>
<p>看看这个更优雅的实现：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> io = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(
    <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);
    },
    {
        <span class="hljs-attr">threshold</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">1.0</span>]
    }
)
io.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'box'</span>));
</code></pre>
<p>首先要明确：<code>threshold</code> 配置的核心作用是<strong>指定元素可见比例的触发节点</strong>，你配置的 <code>[0, 0.25, 0.5, 0.75, 1.0]</code>，意味着当 <code>box</code> 元素的可见度达到 <code>0%</code>、<code>25%</code>、<code>50%</code>、<code>75%</code>、<code>100%</code> 时，都会<strong>触发一次回调函数</strong>。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span>{
            <span class="hljs-attribute">height</span>: <span class="hljs-number">2000px</span>;
        }
        <span class="hljs-selector-id">#box</span>{
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
            <span class="hljs-attribute">background-color</span>: brown;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">100px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> io = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(
            <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);
            },
            {
                <span class="hljs-attr">threshold</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">1.0</span>]
            }
        )
        io.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'box'</span>));
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>也就是说，我们定义一个棕色的小方块，当这个方块的<strong>可见度</strong>到<code>0%</code>、<code>25%</code>、<code>50%</code>、<code>75%</code>、<code>100%</code>时，就会打印一次<code>hello</code>。</p>
<ul>
<li>最开始的时候，<strong>可见度</strong>为<code>100%</code>所以直接打印一次<code>hello</code>：</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1947a1abb7c4739b7c74ccbc4211840~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209716&amp;x-signature=YrYkDJyVNqp3RafQPMOwfRgtGlk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>当经过一半时，<strong>可见度</strong>分别经过了<code>25%</code>、<code>50%</code>，算上最开始的共打印<code>3次</code>：</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92628145b7f1447b915e46c6d5da2799~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209716&amp;x-signature=bVhhMbNuC2MiiHAs5AhNrKEN388%3D" alt="image.png" loading="lazy"/></p>
<p>了解原理后我们一样用上面的<code>10张图片</code>来举例子：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>图片懒加载演示<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">img</span>{
            <span class="hljs-attribute">display</span>: block;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 所有图片先不填真实src，用data-origin存真实地址，加lazyload标记 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/OG4Cnt2SgXAuTj-Vv77ASGszUj1BwOhUXtBCplSlBfQmAAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/Os3eJ8u3SgB3Kd-zrRRhgfR5hUvdwcVPKUTNO6O7sZfUwAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/news_bt/OceYG4p3E6SGFqFBN500JOHSiO4recmt6S1_fml1rlgUEAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://img1.baidu.com/it/u=2631091293,484496842&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=889&amp;h=500"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://img2.baidu.com/it/u=3107839948,3570219976&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=750&amp;h=500"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/O98tXzU2bQgRJ5nRiiJQx_6uwzkB_rsF9e6TA7kcXr058AA/1000"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/Oz13eqQ6iXnUgh-eQxuXT8VmWvogpk66DvRM52Oe0QbNQAA/1000"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/Otvjht3x4wA58ZkSIxSo88NZTsyD6ZdUyiLMHZmGFoHokAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/news_bt/O7ZsQ9IrSfcWAWLPeaRcfeEt5FdyeTfnFYrSGmDSKlU0sAA/1000"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">lazyload</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">data-origin</span>=<span class="hljs-string">"https://inews.gtimg.com/om_bt/O_2D2lSAfCS8o9_fGMsuNxOArO_rS1j9Nc2vsYaEaq2PwAA/641"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 1. 实例化 IntersectionObserver，传入回调函数</span>
        <span class="hljs-keyword">const</span> io = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(
            <span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
                <span class="hljs-comment">// entries 是被观察元素的状态数组</span>
                entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
                    <span class="hljs-comment">// isIntersecting 为 true 表示元素进入了视口</span>
                    <span class="hljs-keyword">if</span>(item.<span class="hljs-property">isIntersecting</span>){
                        <span class="hljs-comment">// 把 data-origin 里的真实地址赋值给 src，触发图片加载</span>
                        item.<span class="hljs-property">target</span>.<span class="hljs-property">src</span> = item.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">origin</span>;
                        <span class="hljs-comment">// 移除 lazyload 标记，避免重复处理</span>
                        item.<span class="hljs-property">target</span>.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-string">'lazyload'</span>);
                        <span class="hljs-comment">// 加载完成后停止观察该元素，节省性能</span>
                        io.<span class="hljs-title function_">unobserve</span>(item.<span class="hljs-property">target</span>);
                    }
                })
            }
        )

        <span class="hljs-comment">// 2. 获取所有需要懒加载的图片，逐个进行观察</span>
        <span class="hljs-keyword">const</span> imgs = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img[lazyload]'</span>);
        imgs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
            io.<span class="hljs-title function_">observe</span>(item);
        })
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">逻辑拆解：了解代码核心</h4>
<ul>
<li>
<p><strong>HTML 部分</strong>：图片的 <code>src</code> 留空（避免默认加载），用 <code>data-origin</code> 自定义属性存储真实的图片地址，同时添加 <code>lazyload="true"</code> 作为筛选标记，方便后续获取需要懒加载的图片。</p>
</li>
<li>
<p><strong>实例化 IntersectionObserver</strong>：创建一个<strong>观察者实例</strong>，传入的回调函数会在被观察元素的可见状态变化时触发。</p>
</li>
<li>
<p><strong><code>isIntersecting</code> 判断</strong>：这是最关键的属性，它直接告诉我们元素是否进入了视口，不用自己手动计算位置，省去了大量冗余代码。</p>
</li>
<li>
<p><strong>加载图片并停止观察</strong>：当图片进入视口后，把 <code>data-origin</code> 赋值给 <code>src</code>，图片就会开始加载；加载完成后，用 <code>io.unobserve(item.target)</code> 停止观察该图片，避免后续滚动时重复触发回调，优化性能。</p>
</li>
<li>
<p><strong>批量观察图片</strong>：通过 <code>querySelectorAll</code> 获取所有带 <code>lazyload</code> 标记的图片，循环调用 <code>io.observe(item)</code> 让观察者 <strong>“盯紧”</strong> 这些图片。</p>
</li>
</ul>
<h4 data-id="heading-7">进阶优化：配置 threshold 提前加载</h4>
<p>如果你觉得 “进入视口才加载” 有点慢，想让图片提前一点点加载（比如元素露出 10% 就开始加载），可以添加 <code>threshold</code> 配置，让用户体验更流畅：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 实例化时添加配置项</span>
<span class="hljs-keyword">const</span> io = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(
    <span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
        entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (item.<span class="hljs-property">isIntersecting</span>) {
                item.<span class="hljs-property">target</span>.<span class="hljs-property">src</span> = item.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">origin</span>;
                item.<span class="hljs-property">target</span>.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-string">'lazyload'</span>);
                io.<span class="hljs-title function_">unobserve</span>(item.<span class="hljs-property">target</span>);
            }
        })
    },
    {
        <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.1</span> <span class="hljs-comment">// 元素可见度达到 10% 时触发回调</span>
    }
)
</code></pre>
<h4 data-id="heading-8">优势总结</h4>
<ul>
<li>不用监听 <code>scroll</code> 事件，也<strong>不用手动计算</strong>元素位置，代码量少且易维护。</li>
<li>浏览器<strong>原生支持</strong>，内部做了性能优化，比手动节流的滚动监听更高效。</li>
<li>支持灵活配置，比如提前加载、指定观察根元素等，满足不同场景需求。</li>
</ul>
<h3 data-id="heading-9">四、HTML 原生懒加载：一行代码搞定</h3>
<p>如果你觉得 <code>JavaScript</code> 方案还是有点麻烦，那 <code>HTML 原生</code>的懒加载了解一下？</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"placeholder.jpg"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"图片"</span>&gt;</span>
</code></pre>
<p>只需要给<code>img</code>标签加个<code>loading="lazy"</code>属性，浏览器就会自动帮你实现<strong>懒加载</strong>。不过它的兼容性还不是 <code>100%</code>，所以目前项目中还是用<code>JavaScript</code>方案更稳妥。</p>
<h3 data-id="heading-10">五、总结</h3>
<p><strong>懒加载</strong>是解决 <strong>“图片多导致页面加载慢”</strong> 的实用技巧，核心是 <strong>“按需加载”</strong>—— 只在图片进入用户视野时才加载，既提升页面速度，又优化用户体验。</p>
<p>本文列举了<code>3种方法</code>：</p>
<p><strong>1. 传统方案</strong>：靠<code>scroll</code>监听 +<code>getBoundingClientRect()</code>计算位置，搭配节流函数避免性能浪费，但代码繁琐、需手动处理逻辑。</p>
<p><strong>2. 现代方案（推荐）</strong> ：用<code>IntersectionObserver</code>“自动驾驶” 式监听元素可见状态，通过<code>isIntersecting</code>判断是否加载，代码简洁、性能更优，还能通过<code>threshold</code>配置提前加载。</p>
<p><strong>3. 原生方案</strong>：HTML 的<code>loading="lazy"</code>属性一行代码搞定，但兼容性不足，暂不适合全场景。</p>
<h2 data-id="heading-11">结语</h2>
<p>从手动计算位置的 <strong>“原始人”</strong> 方案，到 <code>IntersectionObserver</code> 的 <strong>“自动驾驶”</strong>，再到 HTML 原生的 <strong>“躺平”</strong> 方案，懒加载的进化史，就是前端开发者追求 <strong>“更懒、更高效”</strong> 的历史。无论你用哪种方案，核心思想都是一样的：<strong>不要让用户为他们还没看到的内容买单</strong>。</p>
<p>下次再遇到图片加载慢的问题，别再骂网络了，试试懒加载，让你的页面飞起来！</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FIntersection_Observer_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Intersection_Observer_API" ref="nofollow noopener noreferrer">IntersectionObserver原文文档</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用Ticker API写一个行情面板：一次完整的实现过程]]></title>    <link>https://juejin.cn/post/7600219080046084139</link>    <guid>https://juejin.cn/post/7600219080046084139</guid>    <pubDate>2026-01-28T13:36:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600219080046084139" data-draft-id="7600240045366526006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用Ticker API写一个行情面板：一次完整的实现过程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T13:36:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="瞌睡不醒"/> <meta itemprop="url" content="https://juejin.cn/user/1751965949786761"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用Ticker API写一个行情面板：一次完整的实现过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1751965949786761/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    瞌睡不醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T13:36:26.000Z" title="Wed Jan 28 2026 13:36:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用Ticker API写一个行情面板：一次完整的实现过程</h2>
<blockquote>
<p>在“行情展示”这个场景里，REST Ticker + 定时刷新通常已经能满足需求；这篇我用一个可运行的 Demo，把这件事做出来验证一遍。</p>
</blockquote>
<p>在上一篇专栏中，我把行情API的使用拆成了三个阶段：<strong>启动阶段 / 展示阶段 / 实时阶段</strong>。这篇文章只聚焦第二个阶段，用一个可运行的Demo把它落地。</p>
<hr/>
<h3 data-id="heading-1">一、先把页面结构和真实数据跑通</h3>
<h4 data-id="heading-2">这个Demo要做什么</h4>
<p>这次我做的是一个 Ticker 行情面板：把外汇、贵金属、美股、A 股、加密货币放进同一张表里，满足“看一眼行情”的需求。</p>
<p>数据来源用的是TickDB的/v1/market/ticker，目标很简单：能稳定跑起来、能长期用起来。</p>
<p>这不是一个"盯盘页"，用户不需要盯着价格跳动做决策，只是"看一眼当前行情"。</p>
<h4 data-id="heading-3">先定页面结构</h4>
<p>一开始我确实想直接调接口。打开文档，看到<code>/v1/market/ticker</code>，第一反应是：写个<code>fetch</code>，打印JSON，看看数据长什么样。</p>
<p>但我停下来了。因为我还没想清楚：<strong>这个页面到底要长什么样。</strong></p>
<p>如果这是一个"盯盘页"，那页面结构会完全不同：需要大字号价格、跳动动画、实时连接状态。如果这是一个"列表页"，那就是另一回事。</p>
<p>我当时的判断是：这是一个行情展示页面，用户只是"看一眼行情"。</p>
<p>所以我先把页面结构定下来：</p>
<ol>
<li><strong>Header</strong>：标题 + 说明</li>
<li><strong>控制区</strong>：刷新按钮、刷新间隔选择、管理自选</li>
<li><strong>表格</strong>：Symbol、最新价、涨跌、24h高低、量、时间</li>
<li><strong>状态栏</strong>：API状态、延迟、上次更新时间</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8910b921c3604d448ecb5c2cb3ef800e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg556M552h5LiN6YaS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770212186&amp;x-signature=h86TYbIMUrsVuadQ4D%2FX6b0tbj4%3D" alt="wireframe.png" loading="lazy"/>
这个页面没有秒级跳动、动画效果、深度盘口、K线图，但它已经能回答最常见的问题：现在价格是多少？今天涨还是跌？波动范围大不大？不同市场能不能放在一张表里看？</p>
<p>UI结构定下来之后，后面的实现就有了明确的边界。<strong>后面所有的工作，都是在这张结构里"往里填东西"。</strong></p>
<h4 data-id="heading-4">接入真实数据</h4>
<p>页面结构定型后，我把 fetchTicker() 接到 /v1/market/ticker 上，先跑通一次“从请求到渲染”的闭环。</p>
<p>真正麻烦的是：同一张表里，不同市场返回的字段并不一致。有的没有成交量，有的缺少涨跌额/涨跌幅，有的只有买卖价相关字段。</p>





























<table><thead><tr><th>市场类型</th><th>有成交量</th><th>有涨跌数据</th><th>有买卖价</th></tr></thead><tbody><tr><td>加密货币</td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td>股票</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>外汇/贵金属</td><td>❌</td><td>❌</td><td>✅</td></tr></tbody></table>
<p>如果不做字段容错，页面会直接报错或显示<code>NaN</code>。</p>
<p>所以我必须做字段容错：有值就显示，没有值就显示<code>-</code>。这样无论行情接口返回什么数据，表格都能正常显示。</p>
<p>右上角的"延迟"也是这个阶段加的。很多Demo截图看起来很漂亮，但不知道它是不是真的在跑。加一个延迟数字，<code>100ms</code>、<code>150ms</code>，这个Demo就不再是"演示品"。</p>
<p>到这里为止，这个面板已经可以稳定地用真实市场数据跑起来了。</p>
<hr/>
<h3 data-id="heading-5">二、让行情面板稳定刷新并真正可用</h3>
<h4 data-id="heading-6">自动刷新不能无脑setInterval</h4>
<p>面板能跑了，但如果真的使用起来，马上会遇到一个问题：<strong>没人愿意一直点"刷新"按钮。</strong></p>
<p>一开始我以为自动刷新很简单：<code>setInterval</code>调一下<code>fetchTicker()</code>就行了。</p>
<p>但实际跑起来发现：</p>
<ul>
<li>如果上一次请求还没回来，下一次刷新已经开始了</li>
<li>请求重叠后，数据顺序可能错乱</li>
<li>UI状态变得不可信（到底是在刷新，还是卡住了？）</li>
</ul>
<p>本质上是请求重叠导致的时序问题：上一轮没回来，下一轮又开始了。</p>
<p>我必须引入一个"刷新中"状态来控制节奏：</p>
<pre><code class="hljs language-text" lang="text">  state = {
    isFetching: false,
    nextRefreshAt: null
  }

  function refreshTicker() {
    if (state.isFetching) return

    state.isFetching = true
    fetchTicker()
      .finally(() =&gt; {
        state.isFetching = false
        state.nextRefreshAt = now + interval
      })
  }
</code></pre>
<p>关键是：刷新行为本身必须是显式、可控的状态，而不是隐形的副作用。</p>
<p>工具栏这一行还做了一件事：显示"下次刷新: 5s"，每秒倒计时。</p>
<p>我当时的想法是：当用户能看到"还有3秒刷新"，他会知道系统没有卡住、刷新是有节奏的、如果数据没变不是系统坏了而是市场本身没动。</p>
<p>Demo里默认是5秒刷新，但也可以切换3秒或10秒。我当时选5秒的原因是：3秒收益不明显但请求量翻倍，10秒用户会觉得"有点慢"，5秒是在"感知延迟"和"系统成本"之间找到的平衡点。</p>
<h4 data-id="heading-7">自选列表是前端状态</h4>
<p>面板能稳定刷新了，但又会遇到一个问题：<strong>没人想看所有Symbol。</strong></p>
<p>用户真正想要的是："我关心的那几个Symbol"。</p>
<p>一开始我以为自选列表需要后端支持。但实际上，这是一个纯前端状态问题：</p>
<pre><code class="hljs language-text" lang="text">state = {
  watchlist: loadFromStorage()
}

function updateWatchlist(list) {
  state.watchlist = list
  saveToStorage(list)
}

function refresh() {
  fetchTicker(state.watchlist)
}
</code></pre>
<p>把watchlist提升为明确的状态后，行情刷新逻辑反而变得更简单：每次刷新只请求watchlist里的Symbol。</p>
<p>我还把自选列表存到<code>localStorage</code>。如果每次刷新页面都要重新选Symbol，用户会直接放弃。</p>
<p>这个决策看起来简单，但它背后有一个判断：<strong>自选列表是用户状态，不是行情状态。</strong> 它不需要后端支持，不需要账号系统，只需要浏览器本地存储就够了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dfc8c8ffaf842a497c95c1967f51bab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg556M552h5LiN6YaS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770212186&amp;x-signature=emnH0tEdLh8uHwXiXqqOxJeZmd4%3D" alt="ticker-panel.png" loading="lazy"/>
到这里为止，这个面板具备了最小可用性：刷新稳定、关注列表可保存、打开就能继续用。</p>
<hr/>
<h3 data-id="heading-8">三、补齐可用性与工程完整性</h3>
<h4 data-id="heading-9">搜索和筛选只是视图层问题</h4>
<p>面板能用了，但当我加了几十个产品的时候就会遇到一个问题：<strong>找不到想看的那个。</strong></p>
<p>我引入了基础筛选和搜索：市场筛选（只看外汇、只看美股行情、只看加密货币行情）、搜索框（输入关键词，实时过滤）。</p>
<p>我把搜索/筛选限定在视图层：它只改变表格展示的行，不改变请求的 symbols 列表。
这样请求层和渲染层解耦，避免为了 UI 交互去打乱刷新节奏。这样筛选逻辑和行情逻辑就能彻底解耦，互不干扰。</p>
<h4 data-id="heading-10">异常状态的处理</h4>
<p>做到这里，其实行情面板的“正常路径”已经跑通了。但我很快意识到一件事：<br/>
<strong>如果这个 Demo 真的要给别人用，异常路径不能空着。</strong></p>
<p>最直接的问题就是，一旦接口出错，现在的页面只会“什么都不显示”。<br/>
这在自己调试时还能接受，但对使用者来说，很难判断到底发生了什么。</p>
<p>于是我补了一套最基本的错误状态处理：API Key未配置、请求失败，以及接口返回错误码的情况。同时把底部状态栏的信息也补全了，统一展示API状态、请求延迟和上次更新时间。</p>
<p>逻辑上并不复杂，大致就是把数据请求和渲染包在一层异常处理里：</p>
<pre><code class="hljs language-text" lang="text">try {
  data = fetchTicker()
  render(data)
} catch (err) {
  showErrorState(err)
}
</code></pre>
<p>错误码这块我参考了TickDB的错误文档，做了友好提示：1001是API Key无效或已过期，2002是交易品种不存在，3001是请求频率超限。</p>
<p>另外我在底部状态栏加了一个「导出 CSV」的按钮。
当时的想法很简单：如果用户能把当前行情数据直接导出来，自己再做分析或处理，这个 Demo 就不只是“看一眼效果”，而是已经具备了最小可用的价值。</p>
<hr/>
<h3 data-id="heading-11">四、复盘：行情展示型面板的技术边界</h3>
<p>这个Demo用的是REST Ticker + 定时刷新，这是我在这个场景下的选择。</p>
<p><strong>这个面板解决的是什么场景</strong></p>
<p>用户的行为是"看一眼行情"，不是"盯着价格跳动做决策"。在这个场景下，5秒刷新已经足够，用户关心的Symbol通常不超过10个，当刷新节奏是可感知、可解释的，用户对"实时性"的焦虑会明显下降。</p>
<p>回头看，这个面板之所以能成立，不是因为选了什么“高级技术”，而是每一步都围绕同一个目标：让刷新节奏可控、让状态可解释、让用户能长期用。
在“看一眼行情”的场景里，REST Ticker + 定时刷新就是顺势而为。</p>
<p><strong>WebSocket什么时候才是正确选项</strong></p>
<p>我的判断很简单：当用户的行为从"看"变成"盯"的时候。</p>
<p>具体来说，如果用户只是"看一眼价格"，定时刷新够用；如果用户需要"盯着价格变化做决策"，才需要WebSocket推送。这不是技术选型问题，而是场景判断问题。</p>
<p>很多行情系统一上来就想做"实时"，第一反应是上WebSocket、做秒级刷新、加动画。但实际跑起来会发现：用户根本不需要秒级更新，连接管理、断线重连、消息积压反而成了负担，前端性能问题（DOM频繁更新）比接口延迟更严重。</p>
<p>工程上的专业，恰恰是知道什么时候用什么技术。</p>
<hr/>
<h3 data-id="heading-12">附录：如何运行这个Demo</h3>
<p>这个Demo是纯HTML + 原生JavaScript，无需构建工具。</p>
<p>这个Demo的代码我已经整理成一个完整仓库，包括页面结构、数据请求、刷新逻辑和异常处理。如果你想直接跑一下、或者对某一步的实现细节更感兴趣，可以在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftickdb%2Ftickdb-demo-ticker-panel" target="_blank" title="https://github.com/tickdb/tickdb-demo-ticker-panel" ref="nofollow noopener noreferrer">GitHub</a>里看到完整代码：</p>
<p>👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftickdb%2Ftickdb-demo-ticker-panel" target="_blank" title="https://github.com/tickdb/tickdb-demo-ticker-panel" ref="nofollow noopener noreferrer">github.com/tickdb/tick…</a></p>
<p><strong>运行步骤：</strong></p>
<ol>
<li>打开<code>config.js</code>，填入你的API Key</li>
<li>直接用浏览器打开<code>index.html</code>即可</li>
</ol>
<p><strong>常见问题：</strong></p>
<ul>
<li>看到"请配置API Key"提示，说明<code>config.js</code>未正确配置</li>
<li>数据显示<code>-</code>，说明该市场该字段确实没有数据（这是正常的）</li>
<li>请求失败，检查API Key是否有效、网络是否正常</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[无限滚动 × 图片懒加载：用 Intersection Observer 打造高性能长列表]]></title>    <link>https://juejin.cn/post/7600245693997596682</link>    <guid>https://juejin.cn/post/7600245693997596682</guid>    <pubDate>2026-01-28T13:55:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600245693997596682" data-draft-id="7600245693997563914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="无限滚动 × 图片懒加载：用 Intersection Observer 打造高性能长列表"/> <meta itemprop="keywords" content="前端,设计模式,性能优化"/> <meta itemprop="datePublished" content="2026-01-28T13:55:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xhxxx"/> <meta itemprop="url" content="https://juejin.cn/user/3235201610941578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            无限滚动 × 图片懒加载：用 Intersection Observer 打造高性能长列表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3235201610941578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xhxxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T13:55:50.000Z" title="Wed Jan 28 2026 13:55:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">无限滚动 + 图片懒加载：从“邮差系统”到高性能长列表的优雅实践</h2>
<p>在信息爆炸的时代，用户早已习惯“下拉刷新、无限浏览”的交互方式。无论是刷朋友圈、逛淘宝商品页，还是看新闻资讯流，<strong>长列表</strong>已成为现代 Web 应用的标准配置。</p>
<p>但若不加优化，这类页面就像一辆超载的卡车——启动慢、油耗高、随时可能抛锚。<br/>
如何让它轻盈如跑车？答案是两大利器：<strong>无限滚动（Infinite Scroll）</strong>  与 <strong>图片懒加载（Lazy Load）</strong> 。</p>
<p>而它们背后，其实都依赖同一个精妙的调度系统——<strong>观察者模式（Observer Pattern）</strong> 。<br/>
我们可以把它想象成一个高效的  <strong>“邮差通知系统”</strong> 。</p>
<hr/>
<h3 data-id="heading-1">一、观察者模式：像订阅快递一样监听变化</h3>
<h4 data-id="heading-2">📮 比喻：你不是去快递站蹲点，而是等邮差敲门</h4>
<p>想象你要等一个重要包裹：</p>
<ul>
<li><strong>传统做法</strong>：每隔 5 分钟跑去快递站问：“到了吗？”（轮询）——浪费时间，效率低下。</li>
<li><strong>观察者模式</strong>：你在下单时留下电话，快递员（邮差）一到就主动打电话通知你（回调）——省心、高效、实时。</li>
</ul>
<p>在前端开发中：</p>
<ul>
<li><strong>被观察者（Subject）</strong>  = 快递包裹（比如一个 DOM 元素）；</li>
<li><strong>观察者（Observer）</strong>  = 你留下的联系方式（一段回调函数）；</li>
<li><strong>通知机制</strong> = 邮差敲门（浏览器触发事件）。</li>
</ul>
<blockquote>
<p>✅ <strong>核心价值</strong>：<strong>解耦</strong>！你不需要知道快递站怎么运作，快递员也不需要知道你是谁——只需约定好“到了就通知”。</p>
</blockquote>
<p>这种“被动响应、主动通知”的思想，正是现代前端事件驱动架构的基石。</p>
<hr/>
<h3 data-id="heading-3">二、Intersection Observer：浏览器内置的“智能邮差”</h3>
<p>过去，我们要自己当“盯梢人”：监听 <code>scroll</code> 事件，不断计算元素位置，判断是否进入视野——就像你亲自守在路口看快递车有没有来。</p>
<p>现在，浏览器提供了 <strong><code>IntersectionObserver</code> API</strong> —— 它就像一位<strong>专业的社区邮差</strong>：</p>
<ul>
<li>你只需告诉它：“请帮我盯着这个信箱（DOM 元素）”；</li>
<li>邮差会默默巡逻，一旦信箱和你的视线（视口）重叠，立刻敲门通知你；</li>
<li>你完全不用操心他怎么巡逻、何时巡逻——一切由系统底层高效调度。</li>
</ul>
<blockquote>
<p>💡 这位“邮差”不仅聪明，还很体贴：支持提前通知（<code>rootMargin</code>）、批量处理、异步执行，绝不阻塞主线程。</p>
</blockquote>
<h4 data-id="heading-4">为什么不用 <code>onscroll</code>？</h4>
<p>简单说：<strong><code>scroll</code> 事件高频触发、阻塞主线程、难以精准判断元素可见性</strong>，即使节流也治标不治本。<br/>
而 <code>IntersectionObserver</code> 由浏览器底层异步驱动，<strong>零性能损耗、精准可靠</strong>，是现代标准方案。</p>
<hr/>
<h3 data-id="heading-5">三、无限滚动：监听“到底了”的哨兵</h3>
<h4 data-id="heading-6">🛎️ 比喻：地铁到站前，车厢自动响铃</h4>
<p>我们在列表底部放一个<strong>1像素高的透明哨兵元素</strong>。当它进入视口，说明用户已滑到底部，此时加载下一页。</p>
<h4 data-id="heading-7">✅ 完整代码 + 逐行解析</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useEffect, useRef, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">InfiniteList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [items, setItems] = useState&lt;<span class="hljs-title class_">Item</span>[]&gt;([]);
  <span class="hljs-keyword">const</span> [page, setPage] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [hasMore, setHasMore] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 哨兵元素的引用</span>
  <span class="hljs-keyword">const</span> sentinelRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 模拟加载数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadMore</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (loading || !hasMore) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> newItems = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchItems</span>(page); <span class="hljs-comment">// 假设返回 10 条</span>
      <span class="hljs-title function_">setItems</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, ...newItems]);
      <span class="hljs-title function_">setPage</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
      
      <span class="hljs-comment">// 如果返回少于 10 条，说明没更多了</span>
      <span class="hljs-keyword">if</span> (newItems.<span class="hljs-property">length</span> &lt; <span class="hljs-number">10</span>) {
        <span class="hljs-title function_">setHasMore</span>(<span class="hljs-literal">false</span>);
      }
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-comment">// 创建观察者</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!sentinelRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(
      <span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
        <span class="hljs-comment">// entries[0] 对应 sentinelRef 元素</span>
        <span class="hljs-keyword">if</span> (entries[<span class="hljs-number">0</span>].<span class="hljs-property">isIntersecting</span> &amp;&amp; hasMore &amp;&amp; !loading) {
          <span class="hljs-title function_">loadMore</span>();
        }
      },
      { <span class="hljs-attr">threshold</span>: <span class="hljs-number">0</span> } <span class="hljs-comment">// 只要露出 1px 就触发</span>
    );

    <span class="hljs-comment">// 开始观察哨兵</span>
    observer.<span class="hljs-title function_">observe</span>(sentinelRef.<span class="hljs-property">current</span>);

    <span class="hljs-comment">// 组件卸载时清理，防止内存泄漏</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> observer.<span class="hljs-title function_">disconnect</span>();
  }, [hasMore, loading]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-container"</span>&gt;</span>
      {items.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">ListItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> /&gt;</span>
      ))}
      
      {/* 👇 哨兵元素：不可见，仅用于触发 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{sentinelRef}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> '<span class="hljs-attr">1px</span>' }} /&gt;</span>
      
      {/* 加载状态提示 */}
      {loading &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"loading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      {!hasMore &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"no-more"</span>&gt;</span>没有更多内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-8">🔍 关键点解析：</h4>
<ul>
<li><code>threshold: 0</code>：只要哨兵<strong>有任何部分进入视口</strong>就触发；</li>
<li><code>hasMore &amp;&amp; !loading</code>：双重保险，避免无效或重复请求；</li>
<li><code>observer.disconnect()</code>：<strong>必须清理</strong>，否则组件卸载后仍会回调，导致内存泄漏或 setState 警告。</li>
</ul>
<hr/>
<h3 data-id="heading-9">四、图片懒加载：只为“看得见的图”花钱</h3>
<h4 data-id="heading-10">🖼️ 比喻：美术馆只点亮你眼前的画</h4>
<p>每张图片初始不加载真实资源，仅占位。当其容器即将进入视野，才发起请求。</p>
<h4 data-id="heading-11">✅ 完整代码 + 逐行解析</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useEffect, useRef, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">LazyImage</span>(<span class="hljs-params">{ src, alt, className }: { src: string; alt: string; className?: string }</span>) {
  <span class="hljs-keyword">const</span> imgRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [shouldLoad, setShouldLoad] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!imgRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(
      <span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (entries[<span class="hljs-number">0</span>].<span class="hljs-property">isIntersecting</span>) {
          <span class="hljs-title function_">setShouldLoad</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 触发 img 渲染</span>
          observer.<span class="hljs-title function_">unobserve</span>(imgRef.<span class="hljs-property">current</span>!); <span class="hljs-comment">// 加载后停止观察</span>
        }
      },
      { <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'50px'</span> } <span class="hljs-comment">// 提前 50px 预加载，提升流畅度</span>
    );

    observer.<span class="hljs-title function_">observe</span>(imgRef.<span class="hljs-property">current</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> observer.<span class="hljs-title function_">disconnect</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{imgRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{className}</span>&gt;</span>
      {shouldLoad &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
          <span class="hljs-attr">src</span>=<span class="hljs-string">{src}</span>
          <span class="hljs-attr">alt</span>=<span class="hljs-string">{alt}</span>
          <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span> // <span class="hljs-attr">原生懒加载作为</span> <span class="hljs-attr">fallback</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-full object-cover"</span>
        /&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-12">🔍 关键点解析：</h4>
<ul>
<li><code>rootMargin: '50px'</code>：在图片<strong>距离视口还有 50px 时就触发加载</strong>，用户几乎感知不到延迟；</li>
<li><code>observer.unobserve()</code>：图片一旦开始加载，就<strong>停止观察</strong>，节省资源；</li>
<li><code>loading="lazy"</code>：作为兼容性兜底（旧浏览器可能不支持 IntersectionObserver）；</li>
<li>外层 <code>div</code> 必须有固定宽高，避免加载时布局跳动（CLS 优化）。</li>
</ul>
<hr/>
<h3 data-id="heading-13">总结</h3>
<h4 data-id="heading-14">协同工作：构建高性能闭环</h4>
<p>无限滚动与图片懒加载并非孤立技巧，而是协同工作的性能组合拳：前者按需分页获取数据，后者按需加载媒体资源。二者统一依托 <code>IntersectionObserver</code> —— 这一基于观察者模式的现代 API，以声明式、非阻塞、高精度的方式，将“何时加载”的判断交还给浏览器。最终，在用户无感的前提下，达成<strong>内存可控、流量节省、交互流畅</strong>的高性能长列表体验。这不仅是技术选型，更是对用户体验的深度尊重。</p>
<blockquote>
<p>🌟 <strong>记住</strong>：<br/>
不要自己造轮子去监听滚动，<br/>
让浏览器这位“智能邮差”为你服务。<br/>
用户滑得越快，系统越聪明；<br/>
用户停得越久，资源越省电。</p>
</blockquote>
<p>这才是现代前端应有的优雅。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS-深度拆解 WebSocket：从握手原理到健壮的心跳重连机制]]></title>    <link>https://juejin.cn/post/7600229327436742706</link>    <guid>https://juejin.cn/post/7600229327436742706</guid>    <pubDate>2026-01-28T14:05:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600229327436742706" data-draft-id="7600238071038459913" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS-深度拆解 WebSocket：从握手原理到健壮的心跳重连机制"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-28T14:05:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS-深度拆解 WebSocket：从握手原理到健壮的心跳重连机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:05:10.000Z" title="Wed Jan 28 2026 14:05:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在实时性要求极高的场景（如聊天室、金融行情、即时游戏）中，传统的 HTTP “请求-响应”模式显得捉襟见肘。<strong>WebSocket</strong> 作为 HTML5 推出的双向通信协议，成为了解决这一痛点的终极武器。</p>
<h2 data-id="heading-1">一、 什么是 WebSocket？</h2>
<p>WebSocket 是一种在单个 TCP 连接上进行<strong>全双工</strong>通信的协议。</p>
<ul>
<li><strong>双向性</strong>：服务器可以主动向客户端推数据，客户端也可以主动向服务器发数据。</li>
<li>** 端口号**：默认端口也是80（ws）和443（wss）</li>
<li><strong>持久性</strong>：一旦连接建立，除非主动关闭，否则连接将一直保持。</li>
<li><strong>轻量级</strong>：数据包头部较小，减少了不必要的网络开销。</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、 连接过程：HTTP 的“变脸”艺术</h2>
<p>WebSocket 并不是凭空产生的，它的建立依赖于 HTTP 协议的一次“升级”。</p>
<ol>
<li>
<p><strong>TCP 三次握手</strong>：首先建立基础的 TCP 连接。</p>
</li>
<li>
<p><strong>发送 Upgrade 请求</strong>：tcp连接成功后，客户端先向服务器发送一个GET请求，服务器根据请求头中的<code>Connection</code>和<code>Upgrade</code>，来决定是否需要使用websocket协议：</p>
<ul>
<li><code>Upgrade: websocket</code></li>
<li><code>Connection: Upgrade</code></li>
</ul>
</li>
<li>
<p><strong>服务器响应 101</strong>：如果服务器支持，返回状态码 <strong><code>101 Switching Protocols</code></strong>。</p>
</li>
<li>
<p><strong>协议转换</strong>：握手成功，接下来客户端和服务器可以随时主动发送消息给对方了。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-3">三、 基础用法回顾</h2>
<ul>
<li>
<p>使用webSocket构造函数创建连接，指定 <code>ws</code>（非加密）或 <code>wss</code>（加密）协议</p>
</li>
<li>
<p>设置相关的监听函数：</p>
<ul>
<li><code>onopen</code>：连接建立时触发</li>
<li><code>onmessage</code>：接收服务器消息（数据通过 <code>event.data</code>获取）</li>
<li><code>onerror</code>：通信错误处理</li>
<li><code>onclose</code>：连接关闭时触发</li>
</ul>
</li>
<li>
<p>设置发送与关闭方法</p>
<ul>
<li><code>send()</code>发送文本或二进制数据</li>
<li><code>close()</code>主动终止连接</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> webSocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'ws://localhost:5001'</span>)
<span class="hljs-comment">//连接成功后的回调</span>
webSocket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接成功...'</span>)
  webSocket.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello!'</span>)
}
<span class="hljs-comment">//连接失败后的回调</span>
webSocket.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接失败...'</span>)
}
<span class="hljs-comment">//从服务器接收到信息时的回调</span>
webSocket.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收到消息...'</span> + event.<span class="hljs-property">data</span>)
}
<span class="hljs-comment">//连接关闭后的回调</span>
webSocket.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接已关闭...'</span>)
}


</code></pre>
<hr/>
<h2 data-id="heading-4">四、 核心痛点：连接稳定性与心跳检测</h2>
<h3 data-id="heading-5">1. 为什么需要心跳机制？</h3>
<ul>
<li><strong>网络沉默</strong>：某些网络设备（如防火墙、代理）会自动切断长时间没有数据流动的 TCP 连接。</li>
<li><strong>无感知断开</strong>：如果用户突然断网（如进入电梯），前端的 <code>onclose</code> 有时不会立即触发。如果不发数据，前端可能以为还连着。</li>
</ul>
<h3 data-id="heading-6">2. 解决方案：Ping/Pong 机制</h3>
<p>客户端每隔一段时间发送一个心跳包（Ping），服务端收到消息，并且还活着的话，就会发送一个数据包（Pong）给客户端，告诉自己还活着，说明链路通畅。</p>
<hr/>
<h2 data-id="heading-7">五、 实战：封装一个健壮的 WebSocket类</h2>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// WebSocket类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SocketClient</span> {
<span class="hljs-title function_">constructor</span>(<span class="hljs-params">url, options = {}</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span> = url;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockReconnect</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 避免重复重连</span>

  <span class="hljs-comment">// 配置项</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
    <span class="hljs-attr">heartbeatInterval</span>: <span class="hljs-number">20000</span>, <span class="hljs-comment">// 心跳间隔</span>
    <span class="hljs-attr">reconnectInterval</span>: <span class="hljs-number">5000</span>, <span class="hljs-comment">// 重连间隔</span>
    ...options,
  };

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">heartbeatTimer</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 心跳定时器</span>

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onMessageCallback</span> = options.<span class="hljs-property">onMessage</span> || <span class="hljs-literal">null</span>; <span class="hljs-comment">//  接收消息回调</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">onOpenCallback</span> = options.<span class="hljs-property">onOpen</span> || <span class="hljs-literal">null</span>; <span class="hljs-comment">// 连接成功回调</span>

  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createWebSocket</span>();
}

<span class="hljs-comment">// 创建连接</span>
<span class="hljs-title function_">createWebSocket</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">close</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 清理旧实例和心跳</span>

  <span class="hljs-keyword">try</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initEventHandle</span>();
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"WebSocket 初始化失败:"</span>, e);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reConnect</span>();
  }
}

<span class="hljs-comment">// 初始化相关监听事件</span>
<span class="hljs-title function_">initEventHandle</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"WebSocket 连接成功"</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startHeartbeat</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onOpenCallback</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onOpenCallback</span>();
  };

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-comment">// 只要收到消息，就重置心跳</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resetHeartbeat</span>();

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"收到原始消息："</span>, event.<span class="hljs-property">data</span>);

    <span class="hljs-comment">// 处理业务逻辑</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onMessageCallback</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onMessageCallback</span>(data);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onMessageCallback</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onMessageCallback</span>(event.<span class="hljs-property">data</span>);
    }
  };

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"WebSocket 异常:"</span>, error);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reConnect</span>();
  };

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onclose</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"WebSocket 已关闭:"</span>, event.<span class="hljs-property">code</span>);
  };
}

<span class="hljs-comment">//发送消息</span>
<span class="hljs-title function_">send</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-title function_">send</span>(
      <span class="hljs-keyword">typeof</span> data === <span class="hljs-string">"string"</span> ? data : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)
    );
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"WebSocket 未连接，消息发送失败"</span>);
  }
}

<span class="hljs-comment">//心跳管理</span>
<span class="hljs-title function_">startHeartbeat</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">heartbeatTimer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">send</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"heartbeat"</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发送心跳..."</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startHeartbeat</span>(); <span class="hljs-comment">// 递归开启下一次心跳</span>
    }
  }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">heartbeatInterval</span>);
}

<span class="hljs-comment">//重置心跳</span>
<span class="hljs-title function_">resetHeartbeat</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">heartbeatTimer</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startHeartbeat</span>();
}

<span class="hljs-comment">// 重连逻辑,lockReconnect是为了防止在重连时间间隔内再次连接</span>
<span class="hljs-title function_">reConnect</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lockReconnect</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockReconnect</span> = <span class="hljs-literal">true</span>;

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
    <span class="hljs-string">`将在 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.options.reconnectInterval / <span class="hljs-number">1000</span>}</span>s 后尝试重连...`</span>
  );

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lockReconnect</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createWebSocket</span>();
  }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">reconnectInterval</span>);
}

<span class="hljs-comment">// 主动关闭， 是否永久关闭（不再重连）</span>
<span class="hljs-title function_">close</span>(<span class="hljs-params">permanent = <span class="hljs-literal">true</span></span>) {
  <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">heartbeatTimer</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>) {
    <span class="hljs-comment">// 如果是永久关闭，移除所有监听器防止触发重连逻辑</span>
    <span class="hljs-keyword">if</span> (permanent) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onclose</span> = <span class="hljs-literal">null</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onerror</span> = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">//调用ws close关闭连接</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-literal">null</span>;
  }
}
}
</code></pre>
<hr/>
<h2 data-id="heading-8">六、 总结与注意事项</h2>
<ol>
<li><strong>安全性</strong>：在生产环境务必使用 <strong><code>wss://</code></strong> （WebSocket over TLS），防止数据被中间人窃听。</li>
<li><strong>同源策略</strong>：WebSocket <strong>不受同源策略限制</strong>，但服务器可以通过 <code>Origin</code> 头部进行安全校验。</li>
<li><strong>状态判定</strong>：在调用 <code>send()</code> 之前，务必检查 <code>ws.readyState === WebSocket.OPEN</code> (即 1)，否则会报错。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始：用 react-native-reanimated 构建流畅的动画]]></title>    <link>https://juejin.cn/post/7600060691350503466</link>    <guid>https://juejin.cn/post/7600060691350503466</guid>    <pubDate>2026-01-28T14:45:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350503466" data-draft-id="7599826983887929387" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始：用 react-native-reanimated 构建流畅的动画"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2026-01-28T14:45:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陈皮汽水"/> <meta itemprop="url" content="https://juejin.cn/user/1046390801448536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始：用 react-native-reanimated 构建流畅的动画
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390801448536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陈皮汽水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:45:45.000Z" title="Wed Jan 28 2026 14:45:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>在 React Native 开发中，动画性能一直是开发者关注的重点。传统的 Animated API 在 JS 线程运行，当 JS 线程负载较高时，动画容易出现卡顿。React Native Reanimated 通过将动画逻辑迁移到 UI 线程，实现了接近原生的流畅体验。</p>
<p>本文将从实际应用角度出发，系统介绍 Reanimated 的核心概念和实战技巧，帮助你快速掌握这个强大的动画库。</p>
<hr/>
<h2 data-id="heading-0">为什么选择 Reanimated？</h2>
<h3 data-id="heading-1">技术对比一览</h3>













































<table><thead><tr><th>特性</th><th>Animated API</th><th>Reanimated</th></tr></thead><tbody><tr><td><strong>执行线程</strong></td><td>仅 JS 线程</td><td>支持 UI 线程（主线程）</td></tr><tr><td><strong>性能表现</strong></td><td>受 JS 线程阻塞影响</td><td>高并发下依然流畅，60fps</td></tr><tr><td><strong>手势处理</strong></td><td>需借助第三方实现</td><td>原生内置手势支持</td></tr><tr><td><strong>TypeScript</strong></td><td>类型支持有限</td><td>丰富、完善的类型定义</td></tr><tr><td><strong>新架构兼容</strong></td><td>Fabric 支持有限</td><td>完全兼容 Fabric/Turbo</td></tr><tr><td><strong>复杂动画</strong></td><td>配置复杂，扩展性有限</td><td>支持中断、组合与嵌套</td></tr><tr><td><strong>动画曲线</strong></td><td>基础动画曲线</td><td>内置弹性、衰减等多样曲线</td></tr></tbody></table>
<h3 data-id="heading-2">核心优势</h3>
<ul>
<li><strong>UI 线程执行</strong>：动画逻辑运行于 UI 线程，不受 JS 线程阻塞影响，效果丝滑流畅。</li>
<li><strong>手势支持完善</strong>：与 <code>react-native-gesture-handler</code> 深度集成，交互体验自然流畅。</li>
<li><strong>类型友好</strong>：具备完善的 TypeScript 类型声明，开发体验优异。</li>
<li><strong>兼容新架构</strong>：完美支持 Fabric 与 TurboModules，紧跟 React Native 发展。</li>
<li><strong>丰富动画曲线</strong>：内置弹性、弹跳、衰减等多种缓动曲线，满足多样动画需求。</li>
<li><strong>动画中断与组合</strong>：灵活支持动画中断、组合，复杂交互轻松实现。</li>
<li><strong>生态活跃</strong>：官方文档详尽，社区讨论丰富，兼容主流三方库，生态完善。</li>
</ul>
<hr/>
<h2 data-id="heading-3">快速开始</h2>
<h3 data-id="heading-4">1. 安装依赖</h3>
<blockquote>
<p>本文依赖的库版本如下：</p>
<ul>
<li><strong>react-native（0.83.0）</strong></li>
<li><strong>react-native-gesture-handler（^2.30.0）</strong>：高性能手势库，后续会出文章单独介绍。</li>
<li><strong>react-native-reanimated（^4.2.1）</strong>：动画主库。</li>
<li><strong>react-native-worklets（^0.7.2）</strong>：让 JS 代码能在 UI 线程和 JSI 环境下高效运行，辅助扩展动画效果。</li>
</ul>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">npm install react-native-reanimated react-native-gesture-handler react-native-worklets
</code></pre>
<h3 data-id="heading-5">2. 配置 Babel</h3>
<p>在 <code>babel.config.js</code> 中添加插件：目的是为了能解析 worklets 函数，使其可以再 UI 线程中运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">presets</span>: [<span class="hljs-string">'module:@react-native/babel-preset'</span>],
  <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'react-native-worklets/plugin'</span>],
};
</code></pre>
<h3 data-id="heading-6">3. Native 配置</h3>
<ul>
<li>Android</li>
</ul>
<p>无需多余配置，RN会自动把三方库的 Native 功能打包进 apk 包</p>
<ul>
<li>iOS</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ios &amp;&amp; pod install
</code></pre>
<h3 data-id="heading-7">4. 基础示例</h3>
<p>下面是一个简单的动画示例，展示透明度和位移的动画效果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Animated</span>, {
  useSharedValue,
  useAnimatedStyle,
  withTiming,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-reanimated'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BasicAnimation</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 声明动画值</span>
  <span class="hljs-keyword">const</span> opacity = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> translateX = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 计算动画样式</span>
  <span class="hljs-keyword">const</span> animatedStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">opacity</span>: opacity.<span class="hljs-property">value</span>,
    <span class="hljs-attr">transform</span>: [{ <span class="hljs-attr">translateX</span>: translateX.<span class="hljs-property">value</span> }],
  }));

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePress</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 使用线性动画修改动画值</span>
    opacity.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(opacity.<span class="hljs-property">value</span> === <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>, {
      <span class="hljs-attr">duration</span>: <span class="hljs-number">500</span>,
    });
    translateX.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(translateX.<span class="hljs-property">value</span> === <span class="hljs-number">0</span> ? <span class="hljs-number">100</span> : <span class="hljs-number">0</span>, {
      <span class="hljs-attr">duration</span>: <span class="hljs-number">500</span>,
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.box,</span> <span class="hljs-attr">animatedStyle</span>]} /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Animate"</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handlePress}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: {
    <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
  },
  <span class="hljs-attr">box</span>: {
    <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#4CAF50'</span>,
    <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">20</span>,
  },
});
</code></pre>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa52acecaf104e4d8c6858ffa1f0d33e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI55qu5rG95rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216799&amp;x-signature=vfE1huy4cq5nYv8rBEWJq%2F2RCU8%3D" alt="20260128-224256.578-4.gif" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-8">核心概念</h2>
<h3 data-id="heading-9">1. Shared Values</h3>
<p><code>useSharedValue</code> 用于存储动画状态，是 Reanimated 的核心数据结构：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> scale = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">1</span>);

<span class="hljs-comment">// 读取当前值</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(scale.<span class="hljs-property">value</span>);

<span class="hljs-comment">// 修改值并触发动画</span>
scale.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">2</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
</code></pre>
<h3 data-id="heading-10">2. Animated Styles</h3>
<p><code>useAnimatedStyle</code> 将 shared values 转换为动画样式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> animatedStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">transform</span>: [
    { <span class="hljs-attr">scale</span>: scale.<span class="hljs-property">value</span> },
    { <span class="hljs-attr">rotate</span>: <span class="hljs-string">`<span class="hljs-subst">${rotation.value}</span>deg`</span> },
  ],
  <span class="hljs-attr">opacity</span>: opacity.<span class="hljs-property">value</span>,
}));
</code></pre>
<h3 data-id="heading-11">3. Worklets</h3>
<p>Worklets 是在 UI 线程执行的 JavaScript 函数，通过 <code>'worklet'</code> 指令标记，上面安装的 <code>react-native-worklets/plugin</code> 插件就是为了解析此关键字</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePress</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-string">'worklet'</span>;
  scale.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(<span class="hljs-number">1.5</span>);
};
</code></pre>
<h3 data-id="heading-12">4. 动画函数</h3>
<p>Reanimated 提供多种动画函数，满足不同场景需求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 线性动画</span>
<span class="hljs-title function_">withTiming</span>(targetValue, { <span class="hljs-attr">duration</span>: <span class="hljs-number">500</span> })

<span class="hljs-comment">// 弹簧动画</span>
<span class="hljs-title function_">withSpring</span>(targetValue, {
  <span class="hljs-attr">damping</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">stiffness</span>: <span class="hljs-number">100</span>,
})

<span class="hljs-comment">// 衰减动画</span>
<span class="hljs-title function_">withDecay</span>({ <span class="hljs-attr">velocity</span>: <span class="hljs-number">1000</span> })

<span class="hljs-comment">// 序列动画</span>
<span class="hljs-title function_">withSequence</span>(
  <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">100</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span> }),
  <span class="hljs-title function_">withDelay</span>(<span class="hljs-number">100</span>, <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span> }))
)

<span class="hljs-comment">// 重复动画</span>
<span class="hljs-title function_">withRepeat</span>(<span class="hljs-title function_">withTiming</span>(<span class="hljs-number">1</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">500</span> }), -<span class="hljs-number">1</span>, <span class="hljs-literal">true</span>)
</code></pre>
<hr/>
<h2 data-id="heading-13">实战案例</h2>
<h3 data-id="heading-14">案例 1：可拖拽卡片</h3>
<p>实现类似 Tinder 的卡片拖拽效果，包含拖拽、回弹和飞出动画：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">Dimensions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Animated</span>, {
  useSharedValue,
  useAnimatedStyle,
  withSpring,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-reanimated'</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Gesture</span>,
  <span class="hljs-title class_">GestureDetector</span>,
  <span class="hljs-title class_">GestureHandlerRootView</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-gesture-handler'</span>;

<span class="hljs-keyword">const</span> { <span class="hljs-attr">width</span>: <span class="hljs-variable constant_">SCREEN_WIDTH</span> } = <span class="hljs-title class_">Dimensions</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'window'</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DraggableCard</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> translateX = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> translateY = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> scale = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> color = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-string">'#2196F3'</span>);

  <span class="hljs-keyword">const</span> gesture = <span class="hljs-title class_">Gesture</span>.<span class="hljs-title class_">Pan</span>()
    .<span class="hljs-title function_">onStart</span>(<span class="hljs-function">() =&gt;</span> {
      scale.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(<span class="hljs-number">1.1</span>);
      color.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(<span class="hljs-string">'#FF5722'</span>);
    })
    .<span class="hljs-title function_">onUpdate</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      translateX.<span class="hljs-property">value</span> = event.<span class="hljs-property">translationX</span>;
      translateY.<span class="hljs-property">value</span> = event.<span class="hljs-property">translationY</span>;
    })
    .<span class="hljs-title function_">onEnd</span>(<span class="hljs-function">() =&gt;</span> {
      scale.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(<span class="hljs-number">1</span>);
      color.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(<span class="hljs-string">'#2196F3'</span>);

      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(translateX.<span class="hljs-property">value</span>) &gt; <span class="hljs-variable constant_">SCREEN_WIDTH</span> / <span class="hljs-number">2</span>) {
        translateX.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(
          translateX.<span class="hljs-property">value</span> &gt; <span class="hljs-number">0</span> ? <span class="hljs-variable constant_">SCREEN_WIDTH</span> : -<span class="hljs-variable constant_">SCREEN_WIDTH</span>
        );
      } <span class="hljs-keyword">else</span> {
        translateX.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(<span class="hljs-number">0</span>);
        translateY.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(<span class="hljs-number">0</span>);
      }
    });

  <span class="hljs-keyword">const</span> animatedStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">transform</span>: [
      { <span class="hljs-attr">translateX</span>: translateX.<span class="hljs-property">value</span> },
      { <span class="hljs-attr">translateY</span>: translateY.<span class="hljs-property">value</span> },
      { <span class="hljs-attr">scale</span>: scale.<span class="hljs-property">value</span> },
    ],
    <span class="hljs-attr">backgroundColor</span>: color.<span class="hljs-property">value</span>,
  }));

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">GestureHandlerRootView</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">GestureDetector</span> <span class="hljs-attr">gesture</span>=<span class="hljs-string">{gesture}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.card,</span> <span class="hljs-attr">animatedStyle</span>]}&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.text}</span>&gt;</span>拖拽我！<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">GestureDetector</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">GestureHandlerRootView</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: {
    <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#f5f5f5'</span>,
  },
  <span class="hljs-attr">card</span>: {
    <span class="hljs-attr">width</span>: <span class="hljs-number">300</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">200</span>,
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#2196F3'</span>,
    <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">16</span>,
    <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">shadowColor</span>: <span class="hljs-string">'#000'</span>,
    <span class="hljs-attr">shadowOffset</span>: { <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">4</span> },
    <span class="hljs-attr">shadowOpacity</span>: <span class="hljs-number">0.3</span>,
    <span class="hljs-attr">shadowRadius</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">elevation</span>: <span class="hljs-number">8</span>,
  },
  <span class="hljs-attr">text</span>: {
    <span class="hljs-attr">color</span>: <span class="hljs-string">'white'</span>,
    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">24</span>,
    <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'bold'</span>,
  },
});
</code></pre>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b10f254037a447d09d43fc9774ebf6cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI55qu5rG95rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216799&amp;x-signature=YcYjiKmTvnXI77UrodOZRv%2FuNXk%3D" alt="20260128-224256.578-2.gif" loading="lazy"/></p>
<h3 data-id="heading-15">案例 2：可展开/收起的列表项</h3>
<p>实现常见的展开/收起效果，包含高度动画和箭头旋转：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">TouchableOpacity</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Animated</span>, {
  useSharedValue,
  useAnimatedStyle,
  withTiming,
  <span class="hljs-title class_">Easing</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-reanimated'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpandableItem</span>(<span class="hljs-params">{
  title,
  content,
}: {
  title?: string;
  content?: string;
}</span>) {
  <span class="hljs-keyword">const</span> expanded = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> height = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> opacity = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleExpand</span> = (<span class="hljs-params"/>) =&gt; {
    expanded.<span class="hljs-property">value</span> = !expanded.<span class="hljs-property">value</span>;

    <span class="hljs-keyword">if</span> (expanded.<span class="hljs-property">value</span>) {
      <span class="hljs-comment">// 展开增加高度和透明度</span>
      height.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">100</span>, {
        <span class="hljs-attr">duration</span>: <span class="hljs-number">500</span>,
        <span class="hljs-comment">// 使用贝塞尔曲线动画</span>
        <span class="hljs-attr">easing</span>: <span class="hljs-title class_">Easing</span>.<span class="hljs-title function_">bezier</span>(<span class="hljs-number">0.4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">1</span>),
      });
      opacity.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">1</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 收起减小高度，透明度变为 0</span>
      height.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
      opacity.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">200</span> });
    }
  };

  <span class="hljs-comment">// 内容卡片样式</span>
  <span class="hljs-keyword">const</span> contentStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">height</span>: height.<span class="hljs-property">value</span>,
    <span class="hljs-attr">opacity</span>: opacity.<span class="hljs-property">value</span>,
  }));

  <span class="hljs-comment">// 展开箭头样式</span>
  <span class="hljs-keyword">const</span> arrowStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">transform</span>: [
      {
        <span class="hljs-attr">rotate</span>: <span class="hljs-title function_">withTiming</span>(expanded.<span class="hljs-property">value</span> ? <span class="hljs-string">'180deg'</span> : <span class="hljs-string">'0deg'</span>, {
          <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span>,
        }),
      },
    ],
  }));

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TouchableOpacity</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.header}</span>
        <span class="hljs-attr">onPress</span>=<span class="hljs-string">{toggleExpand}</span>
        <span class="hljs-attr">activeOpacity</span>=<span class="hljs-string">{0.7}</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.title}</span>&gt;</span>{title}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Animated.Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.arrow,</span> <span class="hljs-attr">arrowStyle</span>]}&gt;</span>▼<span class="hljs-tag">&lt;/<span class="hljs-name">Animated.Text</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">TouchableOpacity</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.content,</span> <span class="hljs-attr">contentStyle</span>]}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.contentText}</span>&gt;</span>{content}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: {
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'white'</span>,
    <span class="hljs-attr">marginHorizontal</span>: <span class="hljs-number">16</span>,
    <span class="hljs-attr">marginVertical</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">12</span>,
    <span class="hljs-attr">overflow</span>: <span class="hljs-string">'hidden'</span>,
    <span class="hljs-attr">shadowColor</span>: <span class="hljs-string">'#000'</span>,
    <span class="hljs-attr">shadowOffset</span>: { <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">2</span> },
    <span class="hljs-attr">shadowOpacity</span>: <span class="hljs-number">0.1</span>,
    <span class="hljs-attr">shadowRadius</span>: <span class="hljs-number">4</span>,
    <span class="hljs-attr">elevation</span>: <span class="hljs-number">3</span>,
  },
  <span class="hljs-attr">header</span>: {
    <span class="hljs-attr">flexDirection</span>: <span class="hljs-string">'row'</span>,
    <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'space-between'</span>,
    <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">padding</span>: <span class="hljs-number">16</span>,
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#fff'</span>,
  },
  <span class="hljs-attr">title</span>: {
    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>,
    <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'600'</span>,
    <span class="hljs-attr">color</span>: <span class="hljs-string">'#333'</span>,
  },
  <span class="hljs-attr">arrow</span>: {
    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">12</span>,
    <span class="hljs-attr">color</span>: <span class="hljs-string">'#666'</span>,
  },
  <span class="hljs-attr">content</span>: {
    <span class="hljs-attr">overflow</span>: <span class="hljs-string">'hidden'</span>,
  },
  <span class="hljs-attr">contentText</span>: {
    <span class="hljs-attr">padding</span>: <span class="hljs-number">16</span>,
    <span class="hljs-attr">paddingTop</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">color</span>: <span class="hljs-string">'#666'</span>,
    <span class="hljs-attr">lineHeight</span>: <span class="hljs-number">20</span>,
  },
});
</code></pre>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7c46248f10e41b489f7fe121e2669cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI55qu5rG95rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216799&amp;x-signature=ym5kUue3Uhps38gRPsWHyRncuBQ%3D" alt="20260128-224256.578-3.gif" loading="lazy"/></p>
<h3 data-id="heading-16">案例 3：双指缩放图片</h3>
<p>实现图片的双指缩放和拖拽功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">Dimensions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Animated</span>, {
  useSharedValue,
  useAnimatedStyle,
  withSpring,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-reanimated'</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Gesture</span>,
  <span class="hljs-title class_">GestureDetector</span>,
  <span class="hljs-title class_">GestureHandlerRootView</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-gesture-handler'</span>;

<span class="hljs-keyword">const</span> { <span class="hljs-attr">width</span>: <span class="hljs-variable constant_">SCREEN_WIDTH</span> } = <span class="hljs-title class_">Dimensions</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'window'</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PinchToZoom</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 定义缩放值</span>
  <span class="hljs-keyword">const</span> scale = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">1</span>);
  <span class="hljs-comment">// 用于记录每次缩放结束后的缩放值，实现连续缩放。</span>
  <span class="hljs-keyword">const</span> savedScale = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">1</span>);
  <span class="hljs-comment">// 定义拖拽X值</span>
  <span class="hljs-keyword">const</span> translateX = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);
  <span class="hljs-comment">// 定义拖拽Y值</span>
  <span class="hljs-keyword">const</span> translateY = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 定义双指手势</span>
  <span class="hljs-keyword">const</span> pinchGesture = <span class="hljs-title class_">Gesture</span>.<span class="hljs-title class_">Pinch</span>()
    .<span class="hljs-title function_">onStart</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 双指缩放时，保存当前缩放值</span>
      savedScale.<span class="hljs-property">value</span> = scale.<span class="hljs-property">value</span>;
    })
    .<span class="hljs-title function_">onUpdate</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
      <span class="hljs-comment">// 双指缩放时，根据保存的缩放值和当前缩放值计算新的缩放值</span>
      scale.<span class="hljs-property">value</span> = savedScale.<span class="hljs-property">value</span> * event.<span class="hljs-property">scale</span>;
    })
    .<span class="hljs-title function_">onEnd</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 双指缩放结束时，恢复缩放值</span>
      scale.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(<span class="hljs-number">1</span>);
    });

  <span class="hljs-comment">// 定义拖拽手势</span>
  <span class="hljs-keyword">const</span> panGesture = <span class="hljs-title class_">Gesture</span>.<span class="hljs-title class_">Pan</span>()
    .<span class="hljs-title function_">onUpdate</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
      <span class="hljs-comment">// 拖拽时，根据当前拖拽值计算新的拖拽值</span>
      translateX.<span class="hljs-property">value</span> = event.<span class="hljs-property">translationX</span>;
      translateY.<span class="hljs-property">value</span> = event.<span class="hljs-property">translationY</span>;
    })
    .<span class="hljs-title function_">onEnd</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 拖拽结束时，恢复拖拽值</span>
      translateX.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(<span class="hljs-number">0</span>);
      translateY.<span class="hljs-property">value</span> = <span class="hljs-title function_">withSpring</span>(<span class="hljs-number">0</span>);
    });

  <span class="hljs-comment">// 定义同时执行双指缩放和拖拽手势</span>
  <span class="hljs-keyword">const</span> composed = <span class="hljs-title class_">Gesture</span>.<span class="hljs-title class_">Simultaneous</span>(pinchGesture, panGesture);

  <span class="hljs-comment">// 定义动画样式</span>
  <span class="hljs-keyword">const</span> animatedStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-comment">// 根据当前拖拽值和缩放值计算新的拖拽值和缩放值</span>
    <span class="hljs-attr">transform</span>: [
      { <span class="hljs-attr">translateX</span>: translateX.<span class="hljs-property">value</span> },
      { <span class="hljs-attr">translateY</span>: translateY.<span class="hljs-property">value</span> },
      { <span class="hljs-attr">scale</span>: scale.<span class="hljs-property">value</span> },
    ],
  }));

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">GestureHandlerRootView</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">GestureDetector</span> <span class="hljs-attr">gesture</span>=<span class="hljs-string">{composed}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.imageContainer,</span> <span class="hljs-attr">animatedStyle</span>]}&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.image}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">GestureDetector</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">GestureHandlerRootView</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: {
    <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'rgba(0,0,0,0.5)'</span>,
  },
  <span class="hljs-attr">imageContainer</span>: {
    <span class="hljs-attr">width</span>: <span class="hljs-variable constant_">SCREEN_WIDTH</span> * <span class="hljs-number">0.8</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-variable constant_">SCREEN_WIDTH</span> * <span class="hljs-number">0.8</span>,
  },
  <span class="hljs-attr">image</span>: {
    <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'orange'</span>,
    <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">8</span>,
  },
});
</code></pre>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06df1f40aeae4c849dda50775bdb43fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI55qu5rG95rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216799&amp;x-signature=zN6kwO%2B1Z2r50HgaxXbgRmmCFuE%3D" alt="20260128-224256.578-1.gif" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-17">性能优化技巧</h2>
<h3 data-id="heading-18">1. 避免在动画中调用 JS 函数</h3>
<p>❌ <strong>不推荐的做法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> animatedStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">transform</span>: [{ <span class="hljs-attr">scale</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()) }],
}));
</code></pre>
<p>✅ <strong>推荐的做法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> time = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    time.<span class="hljs-property">value</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  }, <span class="hljs-number">16</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
}, []);

<span class="hljs-keyword">const</span> animatedStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">transform</span>: [{ <span class="hljs-attr">scale</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(time.<span class="hljs-property">value</span>) }],
}));
</code></pre>
<h3 data-id="heading-19">2. 使用 <code>useDerivedValue</code> 缓存计算</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> scale = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> rotation = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);

<span class="hljs-keyword">const</span> combinedTransform = <span class="hljs-title function_">useDerivedValue</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">scale</span>: scale.<span class="hljs-property">value</span>,
    <span class="hljs-attr">rotation</span>: rotation.<span class="hljs-property">value</span>,
  };
});

<span class="hljs-keyword">const</span> animatedStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">transform</span>: [
    { <span class="hljs-attr">scale</span>: combinedTransform.<span class="hljs-property">value</span>.<span class="hljs-property">scale</span> },
    { <span class="hljs-attr">rotate</span>: <span class="hljs-string">`<span class="hljs-subst">${combinedTransform.value.rotation}</span>deg`</span> },
  ],
}));
</code></pre>
<h3 data-id="heading-20">3. 减少不必要的重渲染</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">AnimatedComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ value }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> animatedStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">opacity</span>: value.<span class="hljs-property">value</span>,
  }));

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{animatedStyle}</span> /&gt;</span></span>;
});
</code></pre>
<h3 data-id="heading-21">4. 使用 <code>runOnJS</code> 调用 JS 函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAnimationComplete</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Animation completed!'</span>);
};

<span class="hljs-keyword">const</span> animatedStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">opacity</span>: <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">1</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">500</span> }, <span class="hljs-function">(<span class="hljs-params">finished</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (finished) {
      <span class="hljs-title function_">runOnJS</span>(handleAnimationComplete)();
    }
  }),
}));
</code></pre>
<h3 data-id="heading-22">5. 使用 <code>useAnimatedScrollHandler</code> 优化滚动动画</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> scrollOffset = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);

<span class="hljs-keyword">const</span> scrollHandler = <span class="hljs-title function_">useAnimatedScrollHandler</span>({
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    scrollOffset.<span class="hljs-property">value</span> = event.<span class="hljs-property">contentOffset</span>.<span class="hljs-property">y</span>;
  },
});

<span class="hljs-keyword">const</span> headerStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span> - scrollOffset.<span class="hljs-property">value</span> / <span class="hljs-number">200</span>,
}));

<span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Animated.ScrollView</span>
    <span class="hljs-attr">onScroll</span>=<span class="hljs-string">{scrollHandler}</span>
    <span class="hljs-attr">scrollEventThrottle</span>=<span class="hljs-string">{16}</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.header,</span> <span class="hljs-attr">headerStyle</span>]}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>Header<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.ScrollView</span>&gt;</span></span>
);
</code></pre>
<hr/>
<h2 data-id="heading-23">总结</h2>
<p>Reanimated 通过 UI 线程执行动画，解决了传统 Animated API 的性能瓶颈。掌握以下核心概念即可快速上手：</p>
<ol>
<li><strong>Shared Values</strong> - 动画状态管理</li>
<li><strong>Animated Styles</strong> - 样式动画化</li>
<li><strong>Worklets</strong> - UI 线程函数</li>
<li><strong>Gestures</strong> - 手势交互</li>
<li><strong>动画函数</strong> - withTiming、withSpring 等</li>
</ol>
<h3 data-id="heading-24">进阶学习方向</h3>
<ul>
<li>深入学习 <code>react-native-gesture-handler</code> 的高级手势</li>
<li>探索 Reanimated 的新特性（Layout Animations、Shared Transitions）</li>
<li>学习性能优化最佳实践</li>
<li>构建复杂的动画组合效果</li>
</ul>
<h3 data-id="heading-25">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.swmansion.com%2Freact-native-reanimated%2F" target="_blank" title="https://docs.swmansion.com/react-native-reanimated/" ref="nofollow noopener noreferrer">Reanimated 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.swmansion.com%2Freact-native-gesture-handler%2F" target="_blank" title="https://docs.swmansion.com/react-native-gesture-handler/" ref="nofollow noopener noreferrer">Gesture Handler 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsoftware-mansion%2Freact-native-reanimated%2Ftree%2Fmain%2Fexample" target="_blank" title="https://github.com/software-mansion/react-native-reanimated/tree/main/example" ref="nofollow noopener noreferrer">Reanimated 示例代码</a></li>
</ul>
<hr/>
<p>通过本文的学习，你应该能够使用 Reanimated 构建流畅的动画效果了。建议在实际项目中多加练习，逐步掌握更高级的动画技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[消失的最后一秒：SSE 流式联调中的“时序竞争”]]></title>    <link>https://juejin.cn/post/7600060691350536234</link>    <guid>https://juejin.cn/post/7600060691350536234</guid>    <pubDate>2026-01-28T15:08:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350536234" data-draft-id="7600060691350437930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="消失的最后一秒：SSE 流式联调中的“时序竞争”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T15:08:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="im_AMBER"/> <meta itemprop="url" content="https://juejin.cn/user/370979729333004"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            消失的最后一秒：SSE 流式联调中的“时序竞争”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/370979729333004/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    im_AMBER
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:08:08.000Z" title="Wed Jan 28 2026 15:08:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 AY。 </p>
<p>今天，笔者这个菜鸟程序员在尝试实现流式输出（SSE），原本以为只是调个接口，结果处处是卡点，记录这一场对我来说困难重重的 SSE 联调之旅。</p>
<h2 data-id="heading-0">1. 什么是 SSE (Server-Sent Events)？</h2>
<p>我理解就是后端的消息流<strong>实时</strong>反馈到前端输出。</p>
<p>想象这样一个场景：你需要获取一串不断变化的数字。</p>
<p><strong>SSE</strong>：就像一个转述人实时给你打电话，每接到一个新数字就立刻报给你</p>
<p><strong>轮询（Polling）</strong>：你每隔5分钟给转述人打电话，问他“现在有哪些数字？”</p>
<blockquote>
<p><strong>SSE</strong> 是一种服务器端向客户端推送实时消息的 API。与 WebSockets 不同，它是单向的，（<strong>也就是说，这通电话就像收听一个只能听不能对话的电台广播</strong>），且直接运行在 HTTP 协议之上。</p>
</blockquote>
<h2 data-id="heading-1">2. 为什么要用 SSE?</h2>
<p>我现在做的是一个 Agent 交互，大模型经常会有“正在思考中”，这个思考的过程比直接蹦出结果更有交互体验。用户看着屏幕一字一字蹦出来（吐字效果），心理压力更小；而且有时候答案出了一半，用户觉得够了，还可以随时“挂断”打断生成。</p>
<h2 data-id="heading-2">3. “打电话”的那些事儿：建立连接与数据流</h2>
<p>在前面有关打电话的比方中，要打电话，先得拨通连接。</p>
<p>建立连接其实是前后端的一场<strong>多重协议握手：</strong></p>
<ul>
<li>
<p><strong>第一重：小区保安（CORS 跨源资源共享）</strong> 域名、协议（http/https）、端口，这三样只要有一个对不上，浏览器这个“保安”就会把请求拦住。</p>
<blockquote>
<p>CORS 是浏览器出于安全考虑的限制，需要后端在响应头里显式加上 <code>Access-Control-Allow-Origin</code> 才能放行。</p>
</blockquote>
</li>
<li>
<p><strong>第二重：进门前的询问（OPTIONS 预检请求）</strong> 因为我用了 <strong>POST</strong> 并在 Header 里塞了自定义信息，浏览器会先发一个 <code>OPTIONS</code> 请求问后端：“我待会儿要发个带 JSON 的 POST，你接不接受？”后端点头了，真正的通话（SSE）才能开始。</p>
</li>
<li>
<p><strong>第三重：身份通行证（Authorization）</strong> 原生 <code>EventSource</code> 默认不带任何证件（Header），导致后端不认。所以我才必须改用 <code>fetch</code> 手动塞入 <code>Bearer Token</code>。</p>
</li>
</ul>
<p>这一块涉及到 <strong>应用层协议</strong>（SSE 是基于 HTTP 的长连接，运行在浏览器和服务器之间）和<strong>磁盘写入</strong>（Disk IO，类比一下就是转述人在记录数字）。</p>
<p>但我踩了个大坑：</p>
<p><strong>原生的 EventSource 只支持 GET 请求</strong>，且默认不支持在请求头里带 <code>Authorization</code>。但后端偏偏要用 <strong>POST</strong>，这就像保安只让推着小车的人进，不让开车的人进，我们只能自己“兜底”实现。</p>
<p><strong>那我只好绕路：改用 fetch + ReadableStream 实现。</strong></p>
<p> 【伪代码：用 Fetch 模拟 SSE 建立连接】</p>
<pre><code class="hljs language-css" lang="css">const response = await fetch('/api/v1/stream', {
  method: <span class="hljs-string">'POST'</span>, // 对齐后端 POST 要求
  headers: {
    '<span class="hljs-attribute">Content</span>-Type': <span class="hljs-string">'application/json'</span>,
    <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">'Bearer YOUR_TOKEN'</span> // 手动带上保安要的证件
  },
  <span class="hljs-selector-tag">body</span>: JSON.<span class="hljs-built_in">stringify</span>({ meeting_id: <span class="hljs-string">'123'</span> }) 
});
</code></pre>
<h2 data-id="heading-3">4. 拿到数据流：为什么配合 ReadableStream？</h2>
<p>后端 SSE 返回的数据是<strong>字节流（通常是UTF-8编码的文本数据流）</strong>，像水管里的水。普通请求可以直接 <code>res.json()</code>，但流式数据要求我们一点一点读。</p>
<blockquote>
<p><strong>ReadableStream</strong> 接口表示可读的字节数据流。配合 <strong>TextDecoder</strong>（文本解码器），可以将这些二进制“乱码”翻译成人类能看懂的文字。</p>
</blockquote>
<h4 data-id="heading-4">【伪代码：手动接水管解析数据】</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>?.<span class="hljs-title function_">getReader</span>(); <span class="hljs-comment">// 获取流的读取器（接水管）</span>
<span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(); <span class="hljs-comment">// 乱码翻译器</span>

<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>(); <span class="hljs-comment">// 每次接一桶水（Chunk）</span>
  <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 水流完了，挂电话</span>
  <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value); <span class="hljs-comment">// 二进制转文字</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"接到报数："</span>, chunk);
}
</code></pre>
<h2 data-id="heading-5">5. 踩坑总结：404 错误与“时序竞争”</h2>
<p><strong>终于对齐了以后，居然还是 404！！！！！</strong></p>
<p>我 Debug 了半天，路径和逻辑都没问题。</p>
<p><strong>真相是：任务完成 ≠ 文件可读。</strong></p>
<p>目前 SSE 连接断开时，后端正在后台悄悄写文件。</p>
<p>这就是<strong>时序竞争（Race Condition）</strong>：流式吐字结束了，前端以为“挂电话=活干完”，立刻去拿文件，但后端还没存好（Disk IO 慢）。</p>
<h2 data-id="heading-6">6. 最后的补救：轮询</h2>
<p>虽然用了流式，但最后一步还要靠轮询补救。（保持冷静，坚强的菜鸟...）</p>
<p>我用了一个 <strong>while 循环</strong>：不再死等，而是每 2 秒问一次后端“好了没”。</p>
<ul>
<li>
<p><strong>变量锁定</strong>：用了 <code>currentActiveMeetingId</code> 局部变量，解决了 React 状态更新太慢导致的 ID 传不准。</p>
</li>
<li>
<p><strong>友好提示</strong>：用户会看到 <code>(1/6)</code> 这样的动态提示，知道我们在收尾。</p>
</li>
</ul>
<h2 data-id="heading-7">7. 转机：推动后端实现“五步闭环”</h2>
<p>在我用轮询“补丁”自救后，我也在反思：难道前端注定要一直敲门吗？</p>
<p>经过沟通，后端同学重构了逻辑，把原先那两条各跑各的“平行线”拧成了一股绳。</p>
<p>这就引出了：<strong>异步流程的同步化控制</strong>。</p>
<p>简单说，就是让后端在 SSE 断开之前，先完成“存盘”这个苦力活。</p>
<p><strong>新的流程变成了这样：</strong></p>
<ol>
<li>持续吐字（Streaming）：文字实时跳动。</li>
<li>吐字完成：文字停了，但连接不断。</li>
<li>后端存盘：后端在后台默默把 JSON/PDF 落地。</li>
<li>发送“哨声”：发送一个 status: completed 的信号包，告诉前端“我写完了！”。</li>
<li>挂断电话：这时候再正式断开 SSE。</li>
</ol>
<h2 data-id="heading-8">🌟 总结：不仅仅是“接个接口”</h2>
<p>我本来只是想做一个前端接后端接口的工作，没想到衍生了这么多学习的东西。</p>
<p>作为一个“菜鸟切图仔”，这次联调让我深刻体会到了：<strong>开发不仅仅是写代码，更是前后端的深度协作。</strong></p>
<ol>
<li>
<p><strong>搞清楚数据的来龙去脉</strong>： 以前觉得数据是“跳”出来的，现在知道它是从二进制流（ReadableStream）里一桶桶接出来，再经过解码（TextDecoder）翻译出来的。</p>
</li>
<li>
<p><strong>避开请求 API 的暗坑</strong>： 从 CORS 保安的拦截，到 OPTIONS 预检请求的询问，再到 POST 方法下原生 <code>EventSource</code> 的哑火……这些坑踩过一次，才算真的长了记性。</p>
</li>
<li>
<p><strong>反思自己的小细节</strong>： 我也犯了不少低级错误，比如 API 地址写重了（<code>/v1/stream</code> 写错位了）、路径对不齐等。但也正是这些小错，逼着我学会了看 F12 网络面板，去分析数据到底在哪里断了。</p>
</li>
</ol>
<p><strong>最深刻的感悟：</strong> 以前我只关心“页面好不好看”，现在我开始关心“逻辑稳不稳”。</p>
<p>虽然最后代码很多是发给 AI 改的，但<strong>理解了数据是怎么流转的、知道了异步逻辑里的时序陷阱</strong>，这才是今天最大的收获。</p>
<p>既然逻辑已经闭环，后端也把“哨子”准备好了，我也要把那套凑合的轮询代码删了。</p>
<p>从“能跑就行”到“优雅运行”，这一波不亏！</p>
<p><strong>限于个人经验，文中若有疏漏，还请不吝赐教。</strong></p>
<h3 data-id="heading-9">参考文献：</h3>
<ol>
<li><a href="https://juejin.cn/post/7522700103075135539" title="https://juejin.cn/post/7522700103075135539" target="_blank">从零到一实现流式输出：SSE技术在前端应用中的魔法时刻本文深入解析流式输出SSE技术，从原理到实现全面讲解，助你掌握大厂 - 掘金</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2017%2F05%2Fserver-sent_events.html%23%3A~%3Atext%3D%25E4%25B8%25A5%25E6%25A0%25BC%25E5%259C%25B0%25E8%25AF%25B4%25EF%25BC%258CHTTP%25E5%258D%258F%25E8%25AE%25AE%25E6%2597%25A0%25E6%25B3%2595%25E5%2581%259A%25E5%2588%25B0%25E6%259C%258D%25E5%258A%25A1%25E5%2599%25A8%25E4%25B8%25BB%25E5%258A%25A8%25E6%258E%25A8%25E9%2580%2581%25E4%25BF%25A1%25E6%2581%25AF%25E3%2580%2582%25E4%25BD%2586%25E6%2598%25AF%25EF%25BC%258C%25E6%259C%2589%25E4%25B8%2580%25E7%25A7%258D%25E5%258F%2598%25E9%2580%259A%25E6%2596%25B9%25E6%25B3%2595%25EF%25BC%258C%25E5%25B0%25B1%25E6%2598%25AF%25E6%259C%258D%25E5%258A%25A1%25E5%2599%25A8%25E5%2590%2591%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E5%25A3%25B0%25E6%2598%258E%25EF%25BC%258C%25E6%258E%25A5%25E4%25B8%258B%25E6%259D%25A5%25E8%25A6%2581%25E5%258F%2591%25E9%2580%2581%25E7%259A%2584%25E6%2598%25AF%25E6%25B5%2581%25E4%25BF%25A1%25E6%2581%25AF%25EF%25BC%2588streaming%25EF%25BC%2589%25E3%2580%2582%25E4%25B9%259F%25E5%25B0%25B1%25E6%2598%25AF%25E8%25AF%25B4%25EF%25BC%258C%25E5%258F%2591%25E9%2580%2581%25E7%259A%2584%25E4%25B8%258D%25E6%2598%25AF%25E4%25B8%2580%25E6%25AC%25A1%25E6%2580%25A7%25E7%259A%2584%25E6%2595%25B0%25E6%258D%25AE%25E5%258C%2585%25EF%25BC%258C%25E8%2580%258C%25E6%2598%25AF%25E4%25B8%2580%25E4%25B8%25AA%25E6%2595%25B0%25E6%258D%25AE%25E6%25B5%2581%25EF%25BC%258C%25E4%25BC%259A%25E8%25BF%259E%25E7%25BB%25AD%25E4%25B8%258D%25E6%2596%25AD%25E5%259C%25B0%25E5%258F%2591%25E9%2580%2581%25E8%25BF%2587%25E6%259D%25A5%25E3%2580%2582%25E8%25BF%2599%25E6%2597%25B6%25EF%25BC%258C%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E4%25B8%258D%25E4%25BC%259A%25E5%2585%25B3%25E9%2597%25AD%25E8%25BF%259E%25E6%258E%25A5%25EF%25BC%258C%25E4%25BC%259A%25E4%25B8%2580%25E7%259B%25B4%25E7%25AD%2589%25E7%259D%2580%25E6%259C%258D%25E5%258A%25A1%25E5%2599%25A8%25E5%258F%2591%25E8%25BF%2587%25E6%259D%25A5%25E7%259A%2584%25E6%2596%25B0%25E7%259A%2584%25E6%2595%25B0%25E6%258D%25AE%25E6%25B5%2581%25EF%25BC%258C%25E8%25A7%2586%25E9%25A2%2591%25E6%2592%25AD%25E6%2594%25BE%25E5%25B0%25B1%25E6%2598%25AF%25E8%25BF%2599%25E6%25A0%25B7%25E7%259A%2584%25E4%25BE%258B%25E5%25AD%2590%25E3%2580%2582%25E6%259C%25AC%25E8%25B4%25A8%25E4%25B8%258A%25EF%25BC%258C%25E8%25BF%2599%25E7%25A7%258D%25E9%2580%259A%25E4%25BF%25A1%25E5%25B0%25B1%25E6%2598%25AF%25E4%25BB%25A5%25E6%25B5%2581%25E4%25BF%25A1%25E6%2581%25AF%25E7%259A%2584%25E6%2596%25B9%25E5%25BC%258F%25EF%25BC%258C%25E5%25AE%258C%25E6%2588%2590%25E4%25B8%2580%25E6%25AC%25A1%25E7%2594%25A8%25E6%2597%25B6%25E5%25BE%2588%25E9%2595%25BF%25E7%259A%2584%25E4%25B8%258B%25E8%25BD%25BD%25E3%2580%2582SSE%25E5%25B0%25B1%25E6%2598%25AF%25E5%2588%25A9%25E7%2594%25A8%25E8%25BF%2599%25E7%25A7%258D%25E6%259C%25BA%25E5%2588%25B6%25EF%25BC%258C%25E4%25BD%25BF%25E7%2594%25A8%25E6%25B5%2581%25E4%25BF%25A1%25E6%2581%25AF%25E5%2590%2591%25E6%25B5%258F%25E8%25A7%2588%25E5%2599%25A8%25E6%258E%25A8%25E9%2580%2581%25E4%25BF%25A1%25E6%2581%25AF%25E3%2580%2582%25E5%25AE%2583%25E5%259F%25BA%25E4%25BA%258EHTTP%25E5%258D%258F%25E8%25AE%25AE%25EF%25BC%258C%25E7%259B%25AE%25E5%2589%258D%25E9%2599%25A4%25E4%25BA%2586IE%2FEdge%25EF%25BC%258C%25E5%2585%25B6%25E4%25BB%2596%25E6%25B5%258F%25E8%25A7%2588%25E5%2599%25A8%25E9%2583%25BD%25E6%2594%25AF%25E6%258C%2581%25E3%2580%2582" title="https://www.ruanyifeng.com/blog/2017/05/server-sent_events.html#:~:text=%E4%B8%A5%E6%A0%BC%E5%9C%B0%E8%AF%B4%EF%BC%8CHTTP%E5%8D%8F%E8%AE%AE%E6%97%A0%E6%B3%95%E5%81%9A%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%BB%E5%8A%A8%E6%8E%A8%E9%80%81%E4%BF%A1%E6%81%AF%E3%80%82%E4%BD%86%E6%98%AF%EF%BC%8C%E6%9C%89%E4%B8%80%E7%A7%8D%E5%8F%98%E9%80%9A%E6%96%B9%E6%B3%95%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%91%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A3%B0%E6%98%8E%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E8%A6%81%E5%8F%91%E9%80%81%E7%9A%84%E6%98%AF%E6%B5%81%E4%BF%A1%E6%81%AF%EF%BC%88streaming%EF%BC%89%E3%80%82%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%EF%BC%8C%E5%8F%91%E9%80%81%E7%9A%84%E4%B8%8D%E6%98%AF%E4%B8%80%E6%AC%A1%E6%80%A7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8C%85%EF%BC%8C%E8%80%8C%E6%98%AF%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%B5%81%EF%BC%8C%E4%BC%9A%E8%BF%9E%E7%BB%AD%E4%B8%8D%E6%96%AD%E5%9C%B0%E5%8F%91%E9%80%81%E8%BF%87%E6%9D%A5%E3%80%82%E8%BF%99%E6%97%B6%EF%BC%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8D%E4%BC%9A%E5%85%B3%E9%97%AD%E8%BF%9E%E6%8E%A5%EF%BC%8C%E4%BC%9A%E4%B8%80%E7%9B%B4%E7%AD%89%E7%9D%80%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%91%E8%BF%87%E6%9D%A5%E7%9A%84%E6%96%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E6%B5%81%EF%BC%8C%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E5%B0%B1%E6%98%AF%E8%BF%99%E6%A0%B7%E7%9A%84%E4%BE%8B%E5%AD%90%E3%80%82%E6%9C%AC%E8%B4%A8%E4%B8%8A%EF%BC%8C%E8%BF%99%E7%A7%8D%E9%80%9A%E4%BF%A1%E5%B0%B1%E6%98%AF%E4%BB%A5%E6%B5%81%E4%BF%A1%E6%81%AF%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E5%AE%8C%E6%88%90%E4%B8%80%E6%AC%A1%E7%94%A8%E6%97%B6%E5%BE%88%E9%95%BF%E7%9A%84%E4%B8%8B%E8%BD%BD%E3%80%82SSE%E5%B0%B1%E6%98%AF%E5%88%A9%E7%94%A8%E8%BF%99%E7%A7%8D%E6%9C%BA%E5%88%B6%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%B5%81%E4%BF%A1%E6%81%AF%E5%90%91%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8E%A8%E9%80%81%E4%BF%A1%E6%81%AF%E3%80%82%E5%AE%83%E5%9F%BA%E4%BA%8EHTTP%E5%8D%8F%E8%AE%AE%EF%BC%8C%E7%9B%AE%E5%89%8D%E9%99%A4%E4%BA%86IE/Edge%EF%BC%8C%E5%85%B6%E4%BB%96%E6%B5%8F%E8%A7%88%E5%99%A8%E9%83%BD%E6%94%AF%E6%8C%81%E3%80%82" target="_blank" ref="nofollow noopener noreferrer">Server-Sent Events 教程 - 阮一峰的网络日志</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" target="_blank" ref="nofollow noopener noreferrer">EventSource - Web API | MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FFetch_API%2FUsing_Fetch" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch" target="_blank" ref="nofollow noopener noreferrer">使用 Fetch - Web API | MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTTP%2FGuides%2FCORS" title="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Guides/CORS" target="_blank" ref="nofollow noopener noreferrer">跨源资源共享（CORS） - HTTP | MDN</a></li>
<li><a href="https://juejin.cn/post/7392115832696700937" title="https://juejin.cn/post/7392115832696700937" target="_blank">什么是 CORS？一文搞懂 CORS 原理！什么是 CORS ？CORS 的原理是什么？为什么需要 CORS？在这篇文章 - 掘金</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FReadableStream%2FgetReader" title="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream/getReader" target="_blank" ref="nofollow noopener noreferrer">ReadableStream.getReader() - Web API | MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FReadableStream" title="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream" target="_blank" ref="nofollow noopener noreferrer">ReadableStream - Web API | MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FFetch_API" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API" target="_blank" ref="nofollow noopener noreferrer">Fetch API - Web API | MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2Ffetch" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/fetch" target="_blank" ref="nofollow noopener noreferrer">Window：fetch() 方法 - Web API | MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FXMLHttpRequest_API" title="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest_API" target="_blank" ref="nofollow noopener noreferrer">XMLHttpRequest API - Web API | MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FGlossary%2FXMLHttpRequest" title="https://developer.mozilla.org/zh-CN/docs/Glossary/XMLHttpRequest" target="_blank" ref="nofollow noopener noreferrer">XMLHttpRequest (XHR) - MDN Web 文档术语表：Web 相关术语的定义 | MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.oceanbase.com%2Fblog%2F19643047712" title="https://open.oceanbase.com/blog/19643047712" target="_blank" ref="nofollow noopener noreferrer">轮询(Polling) 是什么？（轮询的原理） - 数据库博客-OceanBase</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FStreams_API%2FUsing_readable_streams" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Streams_API/Using_readable_streams" target="_blank" ref="nofollow noopener noreferrer">使用可读流 - Web API | MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffastapi.tiangolo.com%2Ftutorial%2Fquery-params%2F" title="https://fastapi.tiangolo.com/tutorial/query-params/" target="_blank" ref="nofollow noopener noreferrer">Query Parameters - FastAPI</a></li>
</ol>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我花3个月写了个浏览器端 ML 框架，性能提升 3 倍]]></title>    <link>https://juejin.cn/post/7600260767686901786</link>    <guid>https://juejin.cn/post/7600260767686901786</guid>    <pubDate>2026-01-28T15:41:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600260767686901786" data-draft-id="7600229327437037618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我花3个月写了个浏览器端 ML 框架，性能提升 3 倍"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T15:41:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="szx513"/> <meta itemprop="url" content="https://juejin.cn/user/2170883899668570"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我花3个月写了个浏览器端 ML 框架，性能提升 3 倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2170883899668570/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    szx513
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:41:21.000Z" title="Wed Jan 28 2026 15:41:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我花3个月写了个浏览器端 ML 框架，性能提升 3 倍</h2>
<blockquote>
<p>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fs-zx%2FedgeFlow.js" target="_blank" title="https://github.com/s-zx/edgeFlow.js" ref="nofollow noopener noreferrer">github.com/s-zx/edgeFl…</a>  求 ⭐ Star 支持</p>
</blockquote>
<h3 data-id="heading-1">前言</h3>
<p>最近 AI 很火，浏览器端跑模型的需求也越来越多。我在做一个项目时用了 transformers.js，但遇到了一些让我很难受的问题：</p>
<ol>
<li><strong>只能串行推理</strong> - 我需要同时跑 4 个模型，结果发现只能一个一个来，180ms 的延迟用户体验很差</li>
<li><strong>内存泄漏</strong> - 跑了几个小时后页面就崩了，查了半天发现是 Tensor 没释放</li>
<li><strong>包太大了</strong> - 光 ONNX Runtime 就 2MB+，首屏加载慢得要命</li>
<li><strong>下载体验差</strong> - 500MB 的模型下到一半断了，只能从头来</li>
</ol>
<p>于是我决定自己造个轮子 —— edgeFlow.js。</p>
<h3 data-id="heading-2">效果对比</h3>
<p>先上个数据：</p>






























<table><thead><tr><th>指标</th><th>transformers.js</th><th>edgeFlow.js</th></tr></thead><tbody><tr><td>4模型并发</td><td>180ms (串行)</td><td>52ms (并行)</td></tr><tr><td>包体积</td><td>~2-5MB</td><td>&lt;500KB</td></tr><tr><td>内存管理</td><td>基础</td><td>RAII + 泄漏检测</td></tr><tr><td>下载支持</td><td>普通</td><td>分片 + 断点续传</td></tr></tbody></table>
<p>（是的，性能提升 3 倍不是标题党）</p>
<h3 data-id="heading-3">核心设计</h3>
<h4 data-id="heading-4">1. 并发调度器</h4>
<p>这是整个框架的核心。设计目标：</p>
<ul>
<li>支持多模型并行执行</li>
<li>优先级队列（紧急任务插队）</li>
<li>模型级别隔离（避免竞态）</li>
<li>可选的批处理（合并小请求）</li>
</ul>
<p>关键代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InferenceScheduler</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">queues</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">PriorityQueue</span>&lt;<span class="hljs-title class_">Task</span>&gt;&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">private</span> <span class="hljs-attr">runningTasks</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-title function_">schedule</span>(<span class="hljs-params">modelId, executor, priority</span>) {
    <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>(modelId, executor, priority);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getQueue</span>(modelId).<span class="hljs-title function_">enqueue</span>(task);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processQueue</span>();
    <span class="hljs-keyword">return</span> task;
  }
  
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">processQueue</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [modelId, queue] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queues</span>) {
      <span class="hljs-keyword">while</span> (!queue.<span class="hljs-title function_">isEmpty</span>() &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">canStartTask</span>(modelId)) {
        <span class="hljs-keyword">const</span> task = queue.<span class="hljs-title function_">dequeue</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeTask</span>(task);
      }
    }
  }
}
</code></pre>
<p>为什么需要模型级别隔离？因为同一个模型可能共享 GPU Buffer，并发写入会数据覆盖。</p>
<h4 data-id="heading-5">2. WebGPU 后端</h4>
<p>WebGPU 是浏览器的新一代图形/计算 API，相比 WebGL：</p>
<ul>
<li>原生支持计算着色器</li>
<li>更低的 CPU 开销</li>
<li>更精确的同步控制</li>
</ul>
<p>核心是用 WGSL 写计算着色器：</p>
<pre><code class="hljs language-wgsl" lang="wgsl">@compute @workgroup_size(64)
fn main(@builtin(global_invocation_id) gid: vec3&lt;u32&gt;) {
  let idx = gid.x;
  output[idx] = activation(input[idx] * weight[idx] + bias[idx]);
}
</code></pre>
<p>当然也做了降级：WebGPU → WebNN → WASM。</p>
<h4 data-id="heading-6">3. RAII 内存管理</h4>
<p>借鉴 C++ 的 RAII 思想，实现了 MemoryScope：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">withMemoryScope</span>(<span class="hljs-keyword">async</span> (scope) =&gt; {
  <span class="hljs-comment">// 在作用域内创建的 tensor 会自动追踪</span>
  <span class="hljs-keyword">const</span> a = scope.<span class="hljs-title function_">track</span>(<span class="hljs-title function_">tensor</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]));
  <span class="hljs-keyword">const</span> b = scope.<span class="hljs-title function_">track</span>(<span class="hljs-title function_">tensor</span>([<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]));
  
  <span class="hljs-comment">// 处理...</span>
  <span class="hljs-keyword">const</span> output = <span class="hljs-title function_">matmul</span>(a, b);
  
  <span class="hljs-comment">// 标记要保留的结果</span>
  <span class="hljs-keyword">return</span> scope.<span class="hljs-title function_">keep</span>(output);
});
<span class="hljs-comment">// 离开作用域，a 和 b 自动释放</span>
</code></pre>
<p>还做了泄漏检测：记录每个资源的创建时间和调用栈，超时未释放就报警。</p>
<h4 data-id="heading-7">4. 分片下载 + 断点续传</h4>
<p>大模型动辄几百 MB，传统下载体验很差。我实现了：</p>
<ol>
<li><strong>分片下载</strong>：用 HTTP Range 请求并行下载多个 chunk</li>
<li><strong>断点续传</strong>：下载进度存 IndexedDB，刷新页面继续</li>
<li><strong>智能缓存</strong>：下载完的模型缓存到 IndexedDB，下次秒加载</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 并行下载</span>
<span class="hljs-keyword">const</span> chunks = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
  <span class="hljs-title function_">downloadChunk</span>(url, <span class="hljs-number">0</span>, 5MB),
  <span class="hljs-title function_">downloadChunk</span>(url, 5MB, 10MB),
  <span class="hljs-title function_">downloadChunk</span>(url, 10MB, 15MB),
  <span class="hljs-title function_">downloadChunk</span>(url, 15MB, 20MB),
]);
</code></pre>
<h4 data-id="heading-8">5. 流式文本生成</h4>
<p>支持 GPT 风格的 token-by-token 输出：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> event <span class="hljs-keyword">of</span> generator.<span class="hljs-title function_">stream</span>(<span class="hljs-string">'Once upon a time'</span>)) {
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(event.<span class="hljs-property">token</span>);  <span class="hljs-comment">// 逐字输出</span>
}
</code></pre>
<p>实现用了 AsyncGenerator，配合 top-k/top-p 采样。</p>
<h3 data-id="heading-9">学到了什么</h3>
<p>做这个项目让我深入理解了：</p>
<ol>
<li><strong>浏览器并发模型</strong> - 事件循环、微任务队列、Worker 通信</li>
<li><strong>WebGPU 编程</strong> - 计算着色器、Buffer 管理、同步</li>
<li><strong>内存管理</strong> - JS 的 GC 机制、手动资源管理的必要性</li>
<li><strong>大文件处理</strong> - 分片、断点续传、IndexedDB 的坑</li>
</ol>
<h3 data-id="heading-10">如何使用</h3>
<p>安装：</p>
<pre><code class="hljs language-bash" lang="bash">npm install edgeflow
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { pipeline } <span class="hljs-keyword">from</span> <span class="hljs-string">'edgeflow'</span>;

<span class="hljs-comment">// 情感分析</span>
<span class="hljs-keyword">const</span> classifier = <span class="hljs-keyword">await</span> <span class="hljs-title function_">pipeline</span>(<span class="hljs-string">'text-classification'</span>);
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> classifier.<span class="hljs-title function_">run</span>(<span class="hljs-string">'I love this!'</span>);

<span class="hljs-comment">// 并发执行</span>
<span class="hljs-keyword">const</span> [r1, r2] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
  classifier.<span class="hljs-title function_">run</span>(<span class="hljs-string">'Great!'</span>),
  extractor.<span class="hljs-title function_">run</span>(<span class="hljs-string">'Hello'</span>)
]);

<span class="hljs-comment">// 流式生成</span>
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> {token} <span class="hljs-keyword">of</span> generator.<span class="hljs-title function_">stream</span>(<span class="hljs-string">'Hello'</span>)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(token);
}
</code></pre>
<h3 data-id="heading-11">最后</h3>
<p>这是我第一个认真做的开源项目，花了很多心血。如果觉得有用：</p>
<ul>
<li>⭐ 给个 Star 支持一下</li>
<li>🐛 遇到问题欢迎提 Issue</li>
<li>🔀 欢迎 PR 贡献代码</li>
</ul>
<p>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fs-zx%2FedgeFlow.js" target="_blank" title="https://github.com/s-zx/edgeFlow.js" ref="nofollow noopener noreferrer">github.com/s-zx/edgeFl…</a></p>
<p>有问题欢迎评论区交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS Webview 输入框聚焦自动滚动与定位错乱的相关问题]]></title>    <link>https://juejin.cn/post/7600314093293289510</link>    <guid>https://juejin.cn/post/7600314093293289510</guid>    <pubDate>2026-01-28T15:12:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600314093293289510" data-draft-id="7600238071037804553" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS Webview 输入框聚焦自动滚动与定位错乱的相关问题"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2026-01-28T15:12:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dilettante258"/> <meta itemprop="url" content="https://juejin.cn/user/4374335479359466"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS Webview 输入框聚焦自动滚动与定位错乱的相关问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4374335479359466/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dilettante258
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:12:18.000Z" title="Wed Jan 28 2026 15:12:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64d11ebd1f8b4b91994ee124ec469734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGlsZXR0YW50ZTI1OA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217938&amp;x-signature=h78rEOCHcrOju%2BrrfLElu%2BqfJ58%3D" alt="一则评论" width="80%" loading="lazy"/>
<blockquote>
<p>各位，这太荒谬了。全世界都支持这个功能，只有 Safari 不支持。请尽快修复。你们根本不知道为了解决这个问题，用户要付出多少不必要的努力。</p>
</blockquote>
<p>上图中的评论来自 Safari 的一个 Issue 评论区。做 C 端、特别是手机 Web 开发时，我和认识的朋友们普遍觉得开发体验非常难受。</p>
<p>最近做了一段 C 端实习，积累了一些经验，很多问题在网上都搜不到好用的解决方案。于是想写几篇文章产出一下，回馈社区。</p>
<hr/>
<h2 data-id="heading-0">问题现象</h2>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7cedbed6d4f42528c20770eaba68281~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGlsZXR0YW50ZTI1OA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217938&amp;x-signature=cAulot3XXANAm%2FROTt%2FeB6%2F5488%3D" alt="一则评论" width="40%" loading="lazy"/>
<p>我做了一个简单的 <a href="https://link.juejin.cn?target=http%3A%2F%2Fkairi.cc%2Fzh%2Fgallery%2Fios-input" target="_blank" title="http://kairi.cc/zh/gallery/ios-input" ref="nofollow noopener noreferrer">demo</a>：顶部有一个 sticky 定位的置顶元素，页面偏下的位置有一个输入框。</p>
<p>当在 iOS 里点击这一输入框时，软键盘弹起，输入框上移，而 sticky 定位的元素失效了。</p>
<p><strong>你点了一个靠近底部的 input，键盘一弹，页面自己滚了（有时是 visual viewport 的 offset 在变），然后"特殊定位"的元素就开始漂移、错位、甚至看起来像失效。</strong></p>
<p>更糟糕的是：你明明已经做了"键盘弹起监听 + adapter 顶高 + 滚动到合适位置"的老方案，但它在输入框靠近底部、或者页面本来不可滚动这两个场景下必炸。</p>
<hr/>
<h2 data-id="heading-1">背景知识：Layout Viewport 与 Visual Viewport</h2>
<p>在讨论 iOS 键盘问题之前，需要先理解两个视口的区别，因为这是理解后续所有问题的关键。</p>
<p><strong>Layout Viewport</strong>（布局视口）是 CSS 布局的参考系，<code>position: fixed</code> 和 <code>position: sticky</code> 都是相对于它定位的。它的大小由浏览器初始化时确定，不会因为键盘弹起而改变。</p>
<p><strong>Visual Viewport</strong>（视觉视口）是用户实际看到的那个"窗口"。当键盘弹起时，visual viewport 的高度会缩小，同时可能产生一个 <code>offsetTop</code>——也就是说，visual viewport 在 layout viewport 内部发生了偏移。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a682c315b4e4851bb6320a23197e2cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGlsZXR0YW50ZTI1OA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217938&amp;x-signature=vLe7E%2Bu2MkDMBGTkCtSlMKHZewA%3D" alt="image.png" loading="lazy"/>
在桌面浏览器上，这两个视口几乎总是重合的。但在 iOS 上，<strong>键盘弹起时 visual viewport 会缩小并偏移，而 layout viewport 保持不变</strong>。这就是为什么 <code>position: fixed</code> 的元素看起来"飘了"——它相对于 layout viewport 没有移动，但用户通过 visual viewport 看到的位置变了。</p>
<p>Android 的行为有所不同：大部分 Android 浏览器在键盘弹起时会直接缩小 layout viewport（即触发 <code>window.resize</code>），所以 <code>fixed</code> 定位的元素会跟着重新布局，通常不会出现 iOS 那样的错位问题。</p>
<hr/>
<h2 data-id="heading-2">为什么 iOS 会在 input 聚焦时自动滚动？</h2>
<p>背后原因是 iOS 的两个设计理念：</p>
<ol>
<li><strong>手机屏幕本就小，为了展示更多内容，应该少用绝对定位的元素。</strong> Safari 团队认为 <code>position: fixed</code> 在移动端是一种反模式，所以不会为了维持 fixed 元素的位置而做额外处理。</li>
<li><strong>为了保证用户体验，键盘弹起时需要让用户看到输入框</strong>，会自动滚动 visual viewport。这个滚动是 WebKit 内核层面的行为，JavaScript 层面几乎无法阻止。</li>
</ol>
<h3 data-id="heading-3"><code>focus()</code> 默认会把元素滚进视野</h3>
<p>浏览器的默认策略是：聚焦某个元素时，会尝试把它滚到可见区域。<code>HTMLElement.focus()</code> 的 <code>preventScroll</code> 参数就是为了控制这个行为——默认 <code>preventScroll: false</code>，所以会滚；设为 <code>true</code> 才表示"不准滚"。（[MDN][1]）</p>
<p>但 iOS 的现实是：<code>focus({ preventScroll: true })</code> 在 iOS 15.5 之前不支持；15.5 起支持，但还存在版本/实现差异。（[Can I Use][2]）</p>
<h3 data-id="heading-4">iOS 键盘不仅改变"高度"，还会改变视觉视口的偏移</h3>
<p>iOS 上的键盘弹起，很多时候更像是 <strong>visual viewport 变小并产生 offsetTop</strong>，而不是直觉中的"页面 layout 重新计算并老老实实 resize"。一旦视觉视口发生偏移，<code>position: fixed</code>、sticky 定位、transform 容器里的弹层定位系统就可能出现错位，甚至在键盘收起后还残留偏移（典型是 <code>visualViewport.offsetTop</code> 不归零）。（[WebKit Bugzilla][3]）</p>
<p>这也解释了为什么同一套代码在 Android 上表现正常，在 iOS 上就各种错位——两个平台处理键盘弹起的底层机制完全不同。</p>
<h3 data-id="heading-5">iOS 的 focus 必须在用户手势里触发</h3>
<p>还有一条经常被忽视的硬约束：</p>
<blockquote>
<p><strong>iOS 上想让软键盘真的弹出来，程序化 focus 必须发生在用户手势（tap/click）的同步调用链中。</strong>
放到 <code>setTimeout</code>、Promise、异步回调里，即使焦点看起来切过去了，键盘也可能不弹、或者行为变得不一致。</p>
</blockquote>
<p>这不是玄学，社区里有大量案例：</p>
<ul>
<li>iOS Safari 里 <code>setTimeout(... focus())</code> 键盘不出现（[Stack Overflow][4]）</li>
<li>WKWebView 在 iOS 11.3 之后尤其明显：<code>focus()</code> 不再可靠，需要真实 tap 触发（[Ionic Forum][5]）</li>
<li>WebKit 的相关 bug 讨论明确提到：脱离触摸事件的 JS focus 可能不弹键盘（[WebKit Bugzilla][6]）</li>
</ul>
<p><strong>这条约束直接决定了方案形态：</strong> 你不能指望"键盘快出来了我再补救"，因为补救往往发生在异步时机；你必须在用户的触摸/点击回调那一刻，就把后续布局和滚动的"轨道"铺好。</p>
<hr/>
<h2 data-id="heading-6">传统方案及其局限</h2>
<h3 data-id="heading-7">公司之前的做法</h3>
<p>我们公司之前的处理方法是：在有表单的页面里插入一个垫片（adapter）组件，监听键盘弹起，垫片高度变高，然后滚动页面到合适位置使输入框不被遮挡。</p>
<pre><code class="hljs language-css" lang="css">键盘弹起 → 监听到 <span class="hljs-attribute">resize</span> → adapter 变高 → scrollTo 到目标位置
</code></pre>
<p>这个方案的思路很直接：既然键盘弹起后可视区域变小了，就在页面底部垫一个和键盘等高的元素，让页面可以多滚一段距离，然后通过 <code>scrollTo</code> 把输入框滚到可视区域内。</p>
<h3 data-id="heading-8">遇到的问题</h3>
<p>但这样在两个场景下必然会出问题：</p>
<ol>
<li><strong>input 太靠近底部</strong>：页面还没滚到位，键盘已经弹出来了，浏览器为了保证输入可见，自己先滚了 visual viewport。你后续的 scrollTo 和浏览器的自动滚动叠加，就出现了"两次滚动"的抖动。</li>
<li><strong>页面本来不可滚动</strong>：键盘出来前 <code>scrollHeight == clientHeight</code>，几乎没有滚动空间，<code>scrollTo</code> 等于对空气挥拳；等键盘出来、可视区域变小才"突然可滚"，但此时浏览器已经完成它的自动滚动了。</li>
</ol>
<p>本质上是 <strong>时序问题</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A["用户点击"] --&gt; B["键盘弹起 ⚠️&lt;br/&gt;浏览器自动滚了"]
  B --&gt; C["收到 resize"]
  C --&gt; D["adapter 变高"]
  D --&gt; E["scrollTo ⚠️&lt;br/&gt;你的滚动来晚了"]
</code></pre>
<p>你拿到可靠数据时，浏览器可能已经滚了。</p>
<h3 data-id="heading-9">页面结构的坑</h3>
<p>还有一个问题困扰了我很久：应用里所有输入框用的是封装好的组件，但有的页面有效，有的无效。</p>
<p>后来仔细分析了代码，找出了原因：我们用 Taro 开发，调用 <code>Taro.pageScrollTo</code> 滚动页面。这个方法的原理是修改当前路由对应元素的 <code>scrollTop</code>。那些不生效的页面，可滚动容器不是最外层，而是里层——自然就和没滚动一样。</p>
<p>这其实是做手机端 C 端产品的一个普遍感受：flex 盒子经常发生压缩情况，屏幕大小又不够，所以嵌套滚动容器非常常见。如果你的滚动 API 操作的不是实际可滚动的那个容器，一切都是白费功夫。调整页面结构后，这个问题解决了。</p>
<hr/>
<h2 data-id="heading-10">探索过程</h2>
<h3 data-id="heading-11">尝试一：打时间差</h3>
<p>一开始我想打时间差：根据事件机制的原理，监听父元素的 <code>touchStart</code> 捕获事件，抢在 input focus 事件触发之前先行滚动。</p>
<p>理论上触摸事件的传播顺序是 <code>touchstart</code>（捕获）→ <code>touchstart</code>（冒泡）→ <code>touchend</code> → <code>focus</code>，所以在 <code>touchstart</code> 的捕获阶段就能比 <code>focus</code> 更早执行。</p>
<p>但问题是：<strong>用户只是触摸到就会触发滚动，但他可能只是想滑动页面，而不是点击输入框</strong>。这显然不符合预期。改为监听 <code>touchend</code> 的话，<code>touchend</code> 和 <code>focus</code> 几乎同时触发，打不出时间差了。</p>
<p>所以如果只监听 <code>touchstart</code> 能生效，但行为不正确。</p>
<h3 data-id="heading-12">尝试二：先滚动再聚焦</h3>
<p>调整事件顺序，先 <code>preventDefault</code> 阻止默认的 focus 行为，然后自己先滚动、再手动 focus。</p>
<p>但 <code>Taro.pageScrollTo</code> 是异步方法——我读了 Taro 的源码，发现它内部会分多个时间片（<code>requestAnimationFrame</code> 或 <code>setTimeout</code>）逐步修改 <code>scrollTop</code> 来实现平滑滚动。所以很可能滚到一半，键盘就弹出来了。</p>
<p>如果在 <code>Taro.pageScrollTo</code> 的 <code>onSuccess</code> 回调里再 focus 也有问题——前面提到 <strong>iOS 要求 focus 必须在用户手势的同步调用链中触发</strong>，此时 focus 的调用已经不在当前事件循环里了。网上说可以通过 native 层修改 WKWebView 的 <code>keyboardDisplayRequiresUserAction</code> 属性来允许手动调用，但实测部分机型无法生效——改过之后我手机能用，一些老测试机用不了。</p>
<p>用 Web 原生的 <code>scrollTo</code> 也是一个道理——它不会阻塞后续代码的运行，但滚动动画是异步的。用 <code>setTimeout</code> 就进入了下一个事件循环。除非直接修改 <code>scrollTop</code>（<code>element.scrollTop = xxx</code>），这是同步的，但没有动画效果，页面会"闪"一下跳到目标位置，非常生硬。</p>
<h3 data-id="heading-13">转折：发现 <code>focus({ preventScroll: true })</code></h3>
<p>这个问题一度难住了我。我在 StackOverflow 上查了很多帖子，里面有各种"欺骗"浏览器的方法——比如先创建一个隐藏的 input 元素偷偷 focus，再转移到目标 input 上之类的。</p>
<p>偶然间看到一个帖子提到某组件库依赖了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FtheKashey%2Ffocus-lock" target="_blank" title="https://github.com/theKashey/focus-lock" ref="nofollow noopener noreferrer">focus-lock</a> 这个库来锁定焦点。出于好奇我去读了它的源码，猛然发现代码里这么写着：</p>
<pre><code class="hljs language-js" lang="js">element.<span class="hljs-title function_">focus</span>(focusOptions);
</code></pre>
<p><code>focus</code> 还能传参数？！</p>
<p>在我的认知里 <code>focus()</code> 就是一个无参数方法。于是立刻去 MDN 查文档，发现 <code>focus</code> 能传一个 <code>FocusOptions</code> 配置对象，其中有一项叫 <code>preventScroll</code>，默认为 <code>false</code>。配置为 <code>true</code> 时，<strong>可以防止聚焦时浏览器的自动滚动行为</strong>。</p>
<p>这个属性 Chrome 从 2018 年就支持了，但 iOS Safari / WebView 直到 2022 年（iOS 15.5）才加入支持。这也解释了为什么很多老教程和 StackOverflow 答案里没有提到它——因为在 iOS 上它确实长期不可用。</p>
<p>这一发现帮了大忙。自此 focus 何时调用都无所谓了——只需要带上 <code>{ preventScroll: true }</code> 阻止浏览器的自动滚动，然后自己完全控制滚动行为就好。前面纠结的"先滚还是先 focus"的时序问题，一下子不存在了。</p>
<hr/>
<h2 data-id="heading-14">核心方案：预告键盘，先造出滚动空间</h2>
<p>经过测试，使用 <code>preventScroll</code> 后大部分场景已经正常。但一些页面还是有问题：页面本来不可滚动，或 input 太靠底部需要滚的距离额外多——这些都依赖垫片变高后才有足够的滚动空间。而垫片要检测到键盘弹出后才会变高，这就产生了时序上的卡顿或滚动不到位。</p>
<p>为了解决这个问题，我想到一个办法：<strong>在聚焦的同时，提前"预告"键盘将弹起</strong>，让 adapter 在同一时机同步变高，先把滚动空间"造出来"。</p>
<h3 data-id="heading-15">方案拆解</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A["用户点击"] --&gt; B["preventDefault"]
  B --&gt; C["focus&lt;br/&gt;{ preventScroll: true }"]
  C --&gt; D["keyboardWillPopUp()&lt;br/&gt;adapter 立即变高"]
  D --&gt; E["等一帧布局更新"]
  E --&gt; F["手动 scrollTo"]
  F --&gt; G["键盘弹出&lt;br/&gt;浏览器无需抢滚动 ✅"]
</code></pre>
<p>对比传统方案，时序完全不同：</p>
<pre><code class="hljs language-css" lang="css">传统方案：
<span class="hljs-selector-attr">[点击]</span> → <span class="hljs-selector-attr">[focus（触发自动滚动）]</span> → <span class="hljs-selector-attr">[键盘弹起]</span> → <span class="hljs-selector-attr">[resize]</span> → <span class="hljs-selector-attr">[adapter 变高]</span> → <span class="hljs-selector-attr">[scrollTo]</span>
                  ↑                    ↑                                         ↑
          浏览器自动滚了            已经晚了                               你的滚动更晚

本文方案：
<span class="hljs-selector-attr">[点击]</span> → <span class="hljs-selector-attr">[preventDefault]</span> → <span class="hljs-selector-attr">[focus(preventScroll)]</span> → <span class="hljs-selector-attr">[预告键盘]</span> → <span class="hljs-selector-attr">[adapter 变高]</span> → <span class="hljs-selector-attr">[scrollTo]</span> → <span class="hljs-selector-attr">[键盘弹起]</span>
                                    ↑                     ↑              ↑              ↑
                              不触发自动滚动         立即变高         空间已有       你先占位
</code></pre>
<p><strong>对于不可滚动页面</strong>：在键盘出现前就把 adapter 顶高，让页面从 <code>scrollHeight == clientHeight</code> 变成 <code>scrollHeight &gt; clientHeight</code>，滚动指令变得有效。</p>
<p><strong>对于底部 input</strong>：在键盘真正改变 visual viewport 之前就把 input 滚到"未来可见"的位置，Safari 就更少理由去做自动滚动。</p>
<hr/>
<h2 data-id="heading-16">实现细节</h2>
<h3 data-id="heading-17">整体架构</h3>
<p>方案涉及四个模块的协作：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  InputCell["InputCell&lt;br/&gt;（输入框组件）"] -- "keyboardWillPopUp()" --&gt; Hook["useKeyboardDetection&lt;br/&gt;（键盘检测 Hook）"]
  Hook -- "isKeyboardVisible&lt;br/&gt;keyboardHeight" --&gt; Adapter["KeyboardAdapter&lt;br/&gt;（垫片组件）"]
  InputCell -. "handleFocus()&lt;br/&gt;focus · scrollTo" .-&gt; TopView["TopView&lt;br/&gt;（固定顶栏）"]
</code></pre>
<p>数据流是单向的：<code>InputCell</code> 在用户点击时通过 <code>keyboardWillPopUp()</code> 发出信号，<code>useKeyboardDetection</code> 接收到信号后更新状态，<code>KeyboardAdapter</code> 读取状态后改变高度。</p>
<h3 data-id="heading-18">重写键盘检测 Hook</h3>
<p>既然要向键盘检测模块发送"即将弹起"的事件，检测就需要变成单例模式，便于跨页面、跨组件做事件的发送与收集。</p>
<p>之前的检测 hook 用的 <code>useState</code> + <code>useEffect</code>，<code>useEffect</code> 里挂载事件监听。全局调用 n 次就有 n 个 state 加 n 个事件监听，没法向其发送事件：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 旧方案的问题</span>
组件 <span class="hljs-selector-tag">A</span> 调用 <span class="hljs-built_in">useKeyboardDetect</span>() → state_A + listener_A
组件 <span class="hljs-selector-tag">B</span> 调用 <span class="hljs-built_in">useKeyboardDetect</span>() → state_B + listener_B
组件 C 调用 <span class="hljs-built_in">useKeyboardDetect</span>() → state_C + listener_C
<span class="hljs-comment">// 三份独立的状态，三个事件监听，互不相通</span>
<span class="hljs-comment">// 想从外部发送"键盘即将弹起"的信号？做不到</span>
</code></pre>
<p>我的改造思路：</p>
<ol>
<li><strong>状态放 Context</strong>：通过在应用外层包裹 Provider，全局共享一个 state。所有组件读到的都是同一份键盘状态。</li>
<li><strong>用 <code>useSyncExternalStore</code> 替代 <code>useEffect</code></strong>：这是 React 18 新增的 Hook，从语义上讲就是"订阅外部状态"。它的两个参数是 <code>subscribe</code>（注册监听）和 <code>getSnapshot</code>（获取当前状态），天然就将"订阅"与"状态获取"分离了。相比 <code>useEffect</code> + <code>setState</code> 的方式，它不会产生多余的 re-render，并且能保证并发模式下的一致性。</li>
<li><strong>利用闭包暴露更新能力</strong>：这是整个设计最巧妙的地方。<code>useSyncExternalStore</code> 的 <code>subscribe</code> 函数会接收一个 <code>callback</code> 参数——当你调用这个 callback 时，React 就会重新执行 <code>getSnapshot</code> 来获取最新状态。我把这个 callback 存到模块作用域变量里，这样外部调用 <code>keyboardWillPopUp()</code> 时就能主动触发更新。</li>
</ol>
<p>核心的"预告"机制：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 模块作用域变量</span>
<span class="hljs-keyword">let</span> willPopup = { <span class="hljs-attr">signal</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">0</span> };
<span class="hljs-keyword">let</span> <span class="hljs-title function_">keyboardDetectCallback</span> = (<span class="hljs-params"/>) =&gt; {};

<span class="hljs-comment">// 外部调用此函数"预告"键盘即将弹起</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">keyboardWillPopUp</span>(<span class="hljs-params"/>) {
  willPopup.<span class="hljs-property">signal</span> = <span class="hljs-literal">true</span>;
  willPopup.<span class="hljs-property">timestamp</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-title function_">keyboardDetectCallback</span>(); <span class="hljs-comment">// 触发 useSyncExternalStore 重新调用 getSnapshot</span>
}

<span class="hljs-comment">// subscribe 里把 callback 存起来</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">subscribe</span> = (<span class="hljs-params">callback</span>) =&gt; {
  keyboardDetectCallback = callback; <span class="hljs-comment">// ← 就是这一行，让外部有了触发更新的能力</span>
  <span class="hljs-comment">// ... 挂载 resize / visualViewport 等事件监听</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/* cleanup */</span>
  };
};
</code></pre>
<p>在 <code>getSnapshot()</code> 里的逻辑：</p>
<ul>
<li>如果 <code>willPopup.signal</code> 为 <code>true</code>，哪怕还没收到 resize / visualViewport 变化，也先把 <code>isKeyboardVisible</code> 置为 <code>true</code></li>
<li>键盘高度先复用之前记录的值，如果没有就给一个 340 的估算高度（iPhone 上键盘高度通常在 300～360 之间），后续 resize 事件到来时再校准</li>
<li>这样 adapter 就能立即变高，先把滚动空间造出来</li>
</ul>
<p>另外还有一个防抖细节：<code>willPopup.timestamp</code> 记录了预告发出的时间。在 <code>getSnapshot</code> 里会检查，如果距离上次预告不到 30ms 且键盘已经是可见状态，就忽略本次 snapshot——这是为了防止预告信号和真实的 resize 事件在极短时间内连续触发，导致状态跳变。</p>
<h3 data-id="heading-19">多平台检测策略</h3>
<p>键盘检测在不同平台上需要使用不同的策略：</p>

























<table><thead><tr><th>平台</th><th>检测方式</th><th>原因</th></tr></thead><tbody><tr><td><strong>iOS</strong></td><td><code>visualViewport.resize</code></td><td>iOS 键盘弹起不会改变 <code>window.innerHeight</code>，只会改变 visual viewport 的高度</td></tr><tr><td><strong>Android</strong></td><td><code>window.resize</code></td><td>Android 键盘弹起会触发 layout viewport 变化，<code>window.innerHeight</code> 会改变</td></tr><tr><td><strong>桌面端</strong></td><td><code>focusin</code> / <code>focusout</code></td><td>没有软键盘，只能通过焦点事件判断是否在输入状态</td></tr></tbody></table>
<p>键盘高度的计算方式也因此不同：</p>
<ul>
<li>iOS / Android：<code>maxViewportHeight - currentViewportHeight</code>（最大视口高度减去当前视口高度）</li>
<li>桌面端：固定 340（因为没有软键盘，这个值只用于兜底）</li>
</ul>
<p><code>deviceInfo.trusted</code> 标记用于优化：当连续两次计算出的键盘高度不再变化时，认为参数已经稳定（键盘完全弹出），之后就不再更新，避免不必要的计算。</p>
<h3 data-id="heading-20">聚焦处理函数</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFocus</span>(<span class="hljs-params">
  inputElement: HTMLInputElement | <span class="hljs-literal">undefined</span>,
  inputCellElement: HTMLDivElement | <span class="hljs-literal">null</span>,
  scrollOffsetCalFuc: (offsetTop: <span class="hljs-built_in">number</span>) =&gt; <span class="hljs-built_in">number</span>,
  event?: React.TouchEvent&lt;HTMLElement&gt;,
</span>) {
  <span class="hljs-keyword">const</span> offsetTop = inputCellElement?.<span class="hljs-property">offsetTop</span> || <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> toScrollTop = <span class="hljs-title function_">scrollOffsetCalFuc</span>(offsetTop);

  <span class="hljs-comment">// 1. 阻止浏览器默认的聚焦行为（包括自动滚动）</span>
  event?.<span class="hljs-title function_">preventDefault</span>();

  <span class="hljs-comment">// 2. 在用户手势的同步链路中立即 focus（iOS 硬约束）</span>
  <span class="hljs-comment">//    preventScroll: true 阻止聚焦时的自动滚动</span>
  inputElement?.<span class="hljs-title function_">focus</span>({ <span class="hljs-attr">preventScroll</span>: <span class="hljs-literal">true</span> });

  <span class="hljs-keyword">if</span> (toScrollTop) {
    <span class="hljs-comment">// 3. 预告键盘，让 adapter 立即变高</span>
    <span class="hljs-title function_">keyboardWillPopUp</span>();

    <span class="hljs-comment">// 4. 延迟 100ms 再滚动</span>
    <span class="hljs-comment">//    为什么是 100ms？需要等 React 处理完 state 更新 + DOM 重绘</span>
    <span class="hljs-comment">//    adapter 变高后才有足够的 scrollHeight 可以滚动</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">pageScrollTo</span>({
        <span class="hljs-attr">scrollTop</span>: toScrollTop,
        <span class="hljs-attr">duration</span>: <span class="hljs-number">225</span>, <span class="hljs-comment">// 225ms 滚动动画，体感平滑</span>
      });
    }, <span class="hljs-number">100</span>);

    <span class="hljs-comment">// 5. 兜底：350ms 后清理 documentElement 的 scrollTop</span>
    <span class="hljs-comment">//    preventScroll 在 iOS 15.5 才支持，如果老设备不支持，</span>
    <span class="hljs-comment">//    focus 时 document.documentElement 可能被滚上去了</span>
    <span class="hljs-comment">//    100ms(等待) + 225ms(滚动动画) ≈ 325ms，取 350ms 确保动画完成后再清理</span>
    <span class="hljs-built_in">setTimeout</span>(scrollHtmlToTop, <span class="hljs-number">350</span>);
  }
}
</code></pre>
<p>关键的时序约束：<strong>focus 必须同步发生在手势回调中</strong>，<code>setTimeout</code> 只用来延迟滚动。如果把 focus 也放到 <code>setTimeout</code> 里，iOS 上键盘就可能不弹。</p>
<p>滚动偏移的计算逻辑 <code>scrollOffsetCalFuc</code> 也值得说明：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">defaultScrollOffsetCalFuc</span> = (<span class="hljs-params">offsetTop: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> { viewportHeight, keyboardHeight } = <span class="hljs-title function_">getKeyboardInfo</span>();
  <span class="hljs-comment">// 目标：让 input 出现在键盘上方 150px 的位置</span>
  <span class="hljs-comment">// viewportHeight - keyboardHeight = 键盘弹起后的可视高度</span>
  <span class="hljs-comment">// 再减去 150px 的缓冲区，作为 input 的目标 Y 坐标</span>
  <span class="hljs-keyword">const</span> target = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(viewportHeight - keyboardHeight - <span class="hljs-number">150</span>, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(offsetTop - target, <span class="hljs-number">0</span>);
};
</code></pre>
<p>这里的 150px 是一个经验值——让输入框出现在可视区域偏上的位置，而不是紧贴键盘顶部，给用户留出一些上下文空间来看到周围的表单内容。</p>
<hr/>
<h2 data-id="heading-21">边界问题与处理</h2>
<p>实现初版后还遇到了一些细节问题。移动端开发就是这样：核心逻辑写完了只是开始，真正的工作量在处理各种边界情况。</p>
<h3 data-id="heading-22">1. 误触发：用户只想滑动，不想输入</h3>
<p>用户触摸到 Input 组件但本意是拖拽滑动页面，不作处理就会一滑到就唤起键盘。这在表单页面尤其常见——用户想往下滑看更多表单项，手指恰好落在某个 input 上。</p>
<p><strong>解决</strong>：从监听单一的 tap 事件改为监听 <code>touchStart</code> + <code>touchEnd</code>，在 <code>touchEnd</code> 时计算手指的位移距离。如果 X 或 Y 方向的位移超过 10px，就判定为滑动意图，不触发聚焦。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">onTouchStart</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> touch = e.<span class="hljs-property">touches</span>?.[<span class="hljs-number">0</span>];
  touchStartXRef.<span class="hljs-property">current</span> = touch?.<span class="hljs-property">clientX</span> || <span class="hljs-number">0</span>;
  touchStartYRef.<span class="hljs-property">current</span> = touch?.<span class="hljs-property">clientY</span> || <span class="hljs-number">0</span>;
},
<span class="hljs-attr">onTouchEnd</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> touch = e.<span class="hljs-property">changedTouches</span>?.[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> deltaX = (touch?.<span class="hljs-property">clientX</span> || <span class="hljs-number">0</span>) - touchStartXRef.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">const</span> deltaY = (touch?.<span class="hljs-property">clientY</span> || <span class="hljs-number">0</span>) - touchStartYRef.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(deltaX) &gt; <span class="hljs-number">10</span> || <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(deltaY) &gt; <span class="hljs-number">10</span>) {
    <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 手指移动距离超过阈值，判定为滑动，不聚焦</span>
  }
  <span class="hljs-title function_">handleFocus</span>(e.<span class="hljs-property">currentTarget</span>, ...);
}
</code></pre>
<p>10px 的阈值是一个经验值。太小（比如 3px）会导致手指微小抖动就误判为滑动；太大（比如 20px）则用户明显在滑动了还是会触发聚焦。</p>
<h3 data-id="heading-23">2. 已聚焦时不应接管触摸事件</h3>
<p>聚焦状态下继续接管浏览器默认行为，会产生两个问题：</p>
<ul>
<li><strong>文字光标拖拽失效</strong>：因为 <code>preventDefault</code> 了 touch 事件，用户没办法在已输入的文字上拖拽来移动光标</li>
<li><strong>重复触发聚焦逻辑</strong>：键盘弹起后用户想滑动屏幕浏览其他内容，手指落在 input 上时又会触发一次完整的 handleFocus 流程</li>
</ul>
<p><strong>解决</strong>：已聚焦或禁用时，不绑定自定义的 touch handler，让浏览器保持默认行为。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// {} 不是稳定引用，但无所谓——isFocused 变化时组件肯定会重新渲染</span>
<span class="hljs-keyword">const</span> onTouchHandler = disabled || isFocused ? {} : onTouchHandlerBase;
</code></pre>
<h3 data-id="heading-24">3. 键盘弹起/收回的过渡卡顿</h3>
<p>垫片高度变化如果没有过渡效果，用户会看到页面"闪"一下——adapter 突然从 0 变成 300 多像素，内容区域瞬间跳动。</p>
<p><strong>解决</strong>：给垫片的高度变化加 CSS transition。但弹起和收回需要不同的过渡时长：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 弹起时用极短的过渡（25ms）</span>
<span class="hljs-comment">// 需要尽快变高来给 scrollTo 提供空间，过渡太长反而影响滚动效果</span>
<span class="hljs-selector-class">.keyboard-adapter-content</span><span class="hljs-selector-attr">[data-keyboard-visible=<span class="hljs-string">"true"</span>]</span> {
  <span class="hljs-attribute">transition</span>: height <span class="hljs-number">25ms</span> ease-out;
}

<span class="hljs-comment">// 收回时用稍长的过渡（200ms）</span>
<span class="hljs-comment">// 让内容区域平缓地回到原位，不会有突然"跌落"的感觉</span>
<span class="hljs-selector-class">.keyboard-adapter-content</span><span class="hljs-selector-attr">[data-keyboard-visible=<span class="hljs-string">"false"</span>]</span> {
  <span class="hljs-attribute">transition</span>: height <span class="hljs-number">0.2s</span> ease-out;
}
</code></pre>
<p>这两个数值是试了很多组合后达到的满意效果。弹起时 25ms 几乎是"瞬间"，但比 0ms 多了一点点缓冲，能避免布局计算和渲染之间的闪烁。收回时 200ms 和 iOS 原生键盘的收回动画时长接近，体感上比较协调。</p>
<p>使用 <code>data-keyboard-visible</code> 属性而不是 className 来切换样式，是为了利用 CSS 属性选择器的简洁性，同时也方便调试——在 DevTools 里直接能看到当前状态。</p>
<h3 data-id="heading-25">4. 老设备不支持 <code>preventScroll</code></h3>
<p>iOS 15.5 之前的设备不支持 <code>focus({ preventScroll: true })</code>。这些设备占比不大，不做完整适配，只做兜底：在键盘弹起完成后（约 350ms），检查 <code>document.documentElement.scrollTop</code> 是否被意外修改了，如果是就平滑滚回 0。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollHtmlToTop</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 只在 documentElement 确实被滚动了的情况下才还原</span>
  <span class="hljs-comment">// 避免不必要的 scrollTo 调用</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">scrollTop</span> &amp;&amp;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">behavior</span>: <span class="hljs-string">"smooth"</span> });
};
</code></pre>
<p>这里检查的是 <code>document.documentElement</code>（即 <code>&lt;html&gt;</code> 元素）的 <code>scrollTop</code>，而不是页面容器的。因为在不支持 <code>preventScroll</code> 的设备上，<code>focus()</code> 触发的自动滚动会作用在 documentElement 上，而我们的业务滚动是通过 Taro 控制的页面容器，两者互不影响。</p>
<h3 data-id="heading-26">5. 固定定位元素上的滑动问题</h3>
<p>标题导航栏等 sticky/fixed 元素，在键盘弹起时，用户可以通过在它上面滑动使整个页面在 visual viewport 里发生偏移。这是因为 iOS 允许用户通过触摸手势来调整 visual viewport 的位置（类似于缩放后的平移）。</p>
<p><strong>解决</strong>：这类元素本身不需要承载滚动行为，直接对其 <code>touchmove</code> 事件 <code>preventDefault</code> 即可。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTouchMove</span>(<span class="hljs-params">e: TouchEvent</span>) {
  e.<span class="hljs-title function_">preventDefault</span>();
  e.<span class="hljs-title function_">stopPropagation</span>();
}

<span class="hljs-comment">// 在 useEffect 里绑定（用 AbortController 方便清理）</span>
topViewRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"touchmove"</span>, handleTouchMove, {
  <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>,
});
</code></pre>
<hr/>
<h2 data-id="heading-27">效果和完整代码</h2>













<table><thead><tr><th>before</th><th>after</th></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d75c21df70ce4cbc97733ff4b11cb1a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGlsZXR0YW50ZTI1OA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217938&amp;x-signature=6vLmk40ck4W0AOpuuJmF7CCGxfo%3D" alt="before.webp" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0daed865d6fe41ae939f39940ec70e78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGlsZXR0YW50ZTI1OA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217938&amp;x-signature=crXzl97Swz4Gyo7Xcrt65OMPswY%3D" alt="after.webp" loading="lazy"/></td></tr></tbody></table>
<p>以下是涉及的三个模块的完整代码。</p>
<h3 data-id="heading-28">useKeyboardDetection.ts —— 键盘检测 Hook</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { getDeviceType } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/device'</span>;
<span class="hljs-keyword">import</span> noop <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash/noop'</span>;
<span class="hljs-keyword">import</span> debounce <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash/debounce'</span>;
<span class="hljs-keyword">import</span> isEqual <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash/isEqual'</span>;
<span class="hljs-keyword">import</span> {
  useEffect,
  useSyncExternalStore,
  createContext,
  useContext,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">KeyboardDetectionResult</span> {
  <span class="hljs-attr">isKeyboardVisible</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">viewportHeight</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">maxViewportHeight</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">keyboardHeight</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">enum</span> <span class="hljs-variable constant_">METHOD</span> {
  <span class="hljs-title class_">VisualViewport</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">// iOS：监听 visualViewport.resize</span>
  <span class="hljs-title class_">Resize</span> = <span class="hljs-number">2</span>,         <span class="hljs-comment">// Android：监听 window.resize</span>
  <span class="hljs-title class_">FocusEvent</span> = <span class="hljs-number">3</span>,     <span class="hljs-comment">// 桌面端、旧版浏览器：监听 focusin/focusout</span>
}

<span class="hljs-keyword">let</span> <span class="hljs-attr">currentMethod</span>: <span class="hljs-variable constant_">METHOD</span> = <span class="hljs-variable constant_">METHOD</span>.<span class="hljs-property">FocusEvent</span>;
<span class="hljs-keyword">let</span> willPopup = { <span class="hljs-attr">signal</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-number">0</span> };
<span class="hljs-keyword">const</span> deviceType = <span class="hljs-title function_">getDeviceType</span>();

<span class="hljs-keyword">let</span> <span class="hljs-attr">keyboardStatus</span>: <span class="hljs-title class_">KeyboardDetectionResult</span> = {
  <span class="hljs-attr">isKeyboardVisible</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">keyboardHeight</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">viewportHeight</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">maxViewportHeight</span>: <span class="hljs-number">0</span>,
};

<span class="hljs-keyword">let</span> <span class="hljs-attr">keyboardDetectCallback</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> = noop;

<span class="hljs-comment">// 预告键盘即将弹起</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> keyboardWillPopUp = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  willPopup.<span class="hljs-property">signal</span> = <span class="hljs-literal">true</span>;
  willPopup.<span class="hljs-property">timestamp</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-title function_">keyboardDetectCallback</span>();
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (deviceType === <span class="hljs-string">'ios'</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">visualViewport</span>) {
    currentMethod = <span class="hljs-variable constant_">METHOD</span>.<span class="hljs-property">VisualViewport</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (deviceType === <span class="hljs-string">'android'</span> &amp;&amp; navigator.<span class="hljs-property">maxTouchPoints</span> &gt; <span class="hljs-number">1</span>) {
    currentMethod = <span class="hljs-variable constant_">METHOD</span>.<span class="hljs-property">Resize</span>;
  } <span class="hljs-keyword">else</span> {
    currentMethod = <span class="hljs-variable constant_">METHOD</span>.<span class="hljs-property">FocusEvent</span>;
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-keyword">typeof</span> useSyncExternalStore&gt;[<span class="hljs-number">0</span>] = <span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> abort = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">AddEventListenerOptions</span> = {
    <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">capture</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">signal</span>: abort.<span class="hljs-property">signal</span>,
  };
  keyboardDetectCallback = callback;
  <span class="hljs-keyword">const</span> debounceCallback = <span class="hljs-title function_">debounce</span>(callback, <span class="hljs-number">300</span>);

  <span class="hljs-keyword">if</span> (currentMethod === <span class="hljs-variable constant_">METHOD</span>.<span class="hljs-property">VisualViewport</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">visualViewport</span>!.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, debounceCallback, options);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentMethod === <span class="hljs-variable constant_">METHOD</span>.<span class="hljs-property">Resize</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, debounceCallback, options);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'focusin'</span>, debounceCallback, options);
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'focusout'</span>, debounceCallback, options);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> abort.<span class="hljs-title function_">abort</span>();
};

<span class="hljs-keyword">let</span> deviceInfo = {
  <span class="hljs-attr">maxViewportHeight</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">keyboardHeight</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">trusted</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 连续两次相同则标记为稳定</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getKeyboardInfo</span> = (<span class="hljs-params"/>) =&gt; ({
  <span class="hljs-attr">keyboardHeight</span>: deviceInfo.<span class="hljs-property">trusted</span> ? deviceInfo.<span class="hljs-property">keyboardHeight</span> : <span class="hljs-number">340</span>,
  <span class="hljs-attr">viewportHeight</span>: deviceInfo.<span class="hljs-property">maxViewportHeight</span>,
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">deviceInfoInit</span>(<span class="hljs-params">currentViewportHeight: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">if</span> (deviceInfo.<span class="hljs-property">trusted</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">const</span> maxViewportHeight = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(currentViewportHeight, deviceInfo.<span class="hljs-property">maxViewportHeight</span>);
  <span class="hljs-keyword">const</span> keyboardHeight =
    currentMethod === <span class="hljs-variable constant_">METHOD</span>.<span class="hljs-property">FocusEvent</span>
      ? <span class="hljs-number">340</span>
      : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(deviceInfo.<span class="hljs-property">keyboardHeight</span>, maxViewportHeight - currentViewportHeight);
  <span class="hljs-keyword">const</span> newDeviceInfo = { maxViewportHeight, keyboardHeight, <span class="hljs-attr">trusted</span>: <span class="hljs-literal">false</span> };
  deviceInfo = newDeviceInfo;
  <span class="hljs-title function_">isEqual</span>(deviceInfo, newDeviceInfo) &amp;&amp; keyboardHeight !== <span class="hljs-number">0</span>
    ? (deviceInfo.<span class="hljs-property">trusted</span> = <span class="hljs-literal">true</span>)
    : (deviceInfo = newDeviceInfo);
}

<span class="hljs-keyword">const</span> getSnapshot = (): <span class="hljs-function"><span class="hljs-params">KeyboardDetectionResult</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> viewportHeight =
    currentMethod === <span class="hljs-variable constant_">METHOD</span>.<span class="hljs-property">VisualViewport</span>
      ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">visualViewport</span>!.<span class="hljs-property">height</span>
      : <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
  <span class="hljs-title function_">deviceInfoInit</span>(viewportHeight);

  <span class="hljs-keyword">let</span> realKeyboardVisibility = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">if</span> (currentMethod === <span class="hljs-variable constant_">METHOD</span>.<span class="hljs-property">FocusEvent</span>) {
    <span class="hljs-keyword">const</span> activeEl = <span class="hljs-variable language_">document</span>.<span class="hljs-property">activeElement</span>;
    <span class="hljs-keyword">const</span> isInput =
      activeEl &amp;&amp;
      (activeEl.<span class="hljs-property">tagName</span> === <span class="hljs-string">'INPUT'</span> ||
        activeEl.<span class="hljs-property">tagName</span> === <span class="hljs-string">'TEXTAREA'</span> ||
        (activeEl <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>).<span class="hljs-property">isContentEditable</span>);
    realKeyboardVisibility = !!isInput;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 视口高度差超过 150px 认为键盘已弹起</span>
    realKeyboardVisibility = deviceInfo.<span class="hljs-property">maxViewportHeight</span> - viewportHeight &gt; <span class="hljs-number">150</span>;
  }

  <span class="hljs-keyword">const</span> shouldUpdate =
    realKeyboardVisibility !== keyboardStatus.<span class="hljs-property">isKeyboardVisible</span> ||
    viewportHeight !== keyboardStatus.<span class="hljs-property">viewportHeight</span> ||
    willPopup.<span class="hljs-property">signal</span>;
  <span class="hljs-comment">// 防抖：预告信号发出后 30ms 内的 snapshot 不覆盖预告状态</span>
  <span class="hljs-keyword">const</span> shouldIgnore =
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - willPopup.<span class="hljs-property">timestamp</span>) &lt; <span class="hljs-number">30</span> &amp;&amp;
    keyboardStatus.<span class="hljs-property">isKeyboardVisible</span>;

  <span class="hljs-keyword">if</span> (shouldUpdate &amp;&amp; !shouldIgnore) {
    keyboardStatus = {
      <span class="hljs-attr">isKeyboardVisible</span>: realKeyboardVisibility || willPopup.<span class="hljs-property">signal</span>,
      viewportHeight,
      <span class="hljs-attr">keyboardHeight</span>: deviceInfo.<span class="hljs-property">keyboardHeight</span>,
      <span class="hljs-attr">maxViewportHeight</span>: deviceInfo.<span class="hljs-property">maxViewportHeight</span>,
    };
    willPopup.<span class="hljs-property">signal</span> = <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> keyboardStatus;
};

<span class="hljs-keyword">const</span> <span class="hljs-title class_">KeyboardDetectionContext</span> =
  createContext&lt;<span class="hljs-title class_">KeyboardDetectionResult</span>&gt;(keyboardStatus);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">KeyboardDetectionProvider</span>(<span class="hljs-params">{
  children,
}: {
  children: React.ReactNode;
}</span>) {
  <span class="hljs-title function_">useEffect</span>(init, []);
  <span class="hljs-keyword">const</span> value = useSyncExternalStore&lt;<span class="hljs-title class_">KeyboardDetectionResult</span>&gt;(
    subscribe,
    getSnapshot
  );
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeyboardDetectionContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">KeyboardDetectionContext.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useKeyboardStatus</span>(<span class="hljs-params"/>): <span class="hljs-title class_">KeyboardDetectionResult</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">KeyboardDetectionContext</span>);
}
</code></pre>
<h3 data-id="heading-29">KeyboardAdapter —— 垫片组件</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useKeyboardStatus } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hooks/useKeyboardDetection"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tarojs/components"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./index.scss"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">KeyboardAdapter</span>(<span class="hljs-params">{
  height = <span class="hljs-number">0</span>,
  extraHeight = <span class="hljs-number">0</span>,
}: {
  height?: <span class="hljs-built_in">number</span>;
  extraHeight?: <span class="hljs-built_in">number</span>;
}</span>) {
  <span class="hljs-keyword">const</span> { isKeyboardVisible, keyboardHeight } = <span class="hljs-title function_">useKeyboardStatus</span>();
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"keyboard-adapter"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">View</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"keyboard-adapter-content"</span>
        <span class="hljs-attr">data-keyboard-visible</span>=<span class="hljs-string">{isKeyboardVisible}</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{</span>
          <span class="hljs-attr">isKeyboardVisible</span>
            ? { <span class="hljs-attr">height:</span> <span class="hljs-attr">Math.max</span>(<span class="hljs-attr">0</span>, <span class="hljs-attr">keyboardHeight</span> ?? <span class="hljs-attr">300</span> <span class="hljs-attr">-</span> <span class="hljs-attr">167</span> + <span class="hljs-attr">extraHeight</span>) }
            <span class="hljs-attr">:</span> { <span class="hljs-attr">height</span> }
        }
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  );
}
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.keyboard-adapter</span> {
  &amp;-<span class="hljs-attribute">content</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
    <span class="hljs-attribute">will-change</span>: height;
  }
}
<span class="hljs-selector-class">.keyboard-adapter-content</span><span class="hljs-selector-attr">[data-keyboard-visible=<span class="hljs-string">"true"</span>]</span> {
  <span class="hljs-attribute">transition</span>: height <span class="hljs-number">25ms</span> ease-out;
}
<span class="hljs-selector-class">.keyboard-adapter-content</span><span class="hljs-selector-attr">[data-keyboard-visible=<span class="hljs-string">"false"</span>]</span> {
  <span class="hljs-attribute">transition</span>: height <span class="hljs-number">0.2s</span> ease-out;
}
</code></pre>
<h3 data-id="heading-30">InputCell —— 输入框组件（核心逻辑）</h3>
<p>以下代码省略了业务 UI（图标、TextArea 变体、清除按钮等），只保留与滚动控制直接相关的核心逻辑。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Input</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@nutui/nutui-react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tarojs/components"</span>;
<span class="hljs-keyword">import</span> { useState, useCallback, useMemo, useRef, <span class="hljs-title class_">TouchEventHandler</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Taro</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"@tarojs/taro"</span>;
<span class="hljs-keyword">import</span> { getKeyboardInfo, keyboardWillPopUp } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hooks/useKeyboardDetection"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">preventScrollOption</span>: <span class="hljs-title class_">FocusOptions</span> = { <span class="hljs-attr">preventScroll</span>: <span class="hljs-literal">true</span> };

<span class="hljs-comment">// ① 计算滚动目标：让输入框出现在键盘上方 150px 处</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">defaultScrollOffsetCalFuc</span> = (<span class="hljs-params">offsetTop: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> { viewportHeight, keyboardHeight } = <span class="hljs-title function_">getKeyboardInfo</span>();
  <span class="hljs-keyword">const</span> target = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(viewportHeight - keyboardHeight - <span class="hljs-number">150</span>, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(offsetTop - target, <span class="hljs-number">0</span>);
};

<span class="hljs-comment">// ② 旧设备兜底：focus 后 html.scrollTop 可能被系统篡改，强制归零</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollHtmlToTop</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">scrollTop</span> &amp;&amp;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">behavior</span>: <span class="hljs-string">"smooth"</span> });
};

<span class="hljs-comment">// ③ 核心聚焦流程</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFocus</span>(<span class="hljs-params">
  inputElement: HTMLInputElement | <span class="hljs-literal">undefined</span>,
  inputCellElement: HTMLDivElement | <span class="hljs-literal">null</span>,
  scrollOffsetCalFuc: (offsetTop: <span class="hljs-built_in">number</span>) =&gt; <span class="hljs-built_in">number</span>,
  event?: React.TouchEvent&lt;HTMLElement&gt;,
</span>) {
  <span class="hljs-keyword">const</span> offsetTop = inputCellElement?.<span class="hljs-property">offsetTop</span> || <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> toScrollTop = <span class="hljs-title function_">scrollOffsetCalFuc</span>(offsetTop);
  event?.<span class="hljs-title function_">preventDefault</span>();                          <span class="hljs-comment">// 阻止系统默认滚动</span>
  inputElement?.<span class="hljs-title function_">focus</span>(preventScrollOption);          <span class="hljs-comment">// 聚焦但禁止浏览器自动滚动</span>
  <span class="hljs-keyword">if</span> (toScrollTop) {
    <span class="hljs-title function_">keyboardWillPopUp</span>();                             <span class="hljs-comment">// 通知 TopView 提前让出键盘空间</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">pageScrollTo</span>({ <span class="hljs-attr">scrollTop</span>: toScrollTop, <span class="hljs-attr">duration</span>: <span class="hljs-number">225</span> }); <span class="hljs-comment">// 我们自己滚</span>
    }, <span class="hljs-number">100</span>);
    <span class="hljs-built_in">setTimeout</span>(scrollHtmlToTop, <span class="hljs-number">350</span>);                <span class="hljs-comment">// 兜底：修正 html.scrollTop</span>
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">InputCell</span>(<span class="hljs-params">{ value, onChange, label, disabled = <span class="hljs-literal">false</span> }</span>) {
  <span class="hljs-keyword">const</span> [isFocused, setIsFocused] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> inputCellRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// ④ 自定义触摸处理：区分"点击"与"滑动"</span>
  <span class="hljs-keyword">const</span> touchStartXRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> touchStartYRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> onTouchHandlerBase = useMemo&lt;{
    <span class="hljs-attr">onTouchStart</span>: <span class="hljs-title class_">TouchEventHandler</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;;
    <span class="hljs-attr">onTouchEnd</span>: <span class="hljs-title class_">TouchEventHandler</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;;
  }&gt;(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">onTouchStart</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> touch = e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>];
      touchStartXRef.<span class="hljs-property">current</span> = touch.<span class="hljs-property">clientX</span>;
      touchStartYRef.<span class="hljs-property">current</span> = touch.<span class="hljs-property">clientY</span>;
    },
    <span class="hljs-attr">onTouchEnd</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> touch = e.<span class="hljs-property">changedTouches</span>[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">const</span> deltaX = touch.<span class="hljs-property">clientX</span> - touchStartXRef.<span class="hljs-property">current</span>;
      <span class="hljs-keyword">const</span> deltaY = touch.<span class="hljs-property">clientY</span> - touchStartYRef.<span class="hljs-property">current</span>;
      <span class="hljs-comment">// 移动 &gt; 10px 视为滑动，放弃聚焦</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(deltaX) &gt; <span class="hljs-number">10</span> || <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(deltaY) &gt; <span class="hljs-number">10</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-title function_">handleFocus</span>(e.<span class="hljs-property">currentTarget</span>, inputCellRef.<span class="hljs-property">current</span>, defaultScrollOffsetCalFuc, e);
    },
  }), []);

  <span class="hljs-comment">// ⑤ 已聚焦时走浏览器默认行为，避免重复触发</span>
  <span class="hljs-keyword">const</span> touchHandler = disabled || isFocused ? {} : onTouchHandlerBase;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputCellRef}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Input</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{value</span> || ""}
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{onChange}</span>
        <span class="hljs-attr">onFocus</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsFocused(true)}
        onBlur={() =&gt; setIsFocused(false)}
        disabled={disabled}
        {...touchHandler}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-31">兼容性提示</h2>
<ol>
<li><strong><code>preventScroll</code></strong>：iOS 15.5 才支持，且存在"看似支持但不生效"的 WebKit bug。保留老设备兜底（focus 后把 <code>documentElement.scrollTop</code> 拉回）是合理的工程策略。（[Can I Use][2]）</li>
<li><strong>visualViewport 偏移残留</strong>：极端情况下键盘收起后 <code>visualViewport.offsetTop</code> 仍不为 0，导致 sticky/fixed 永久错位，需要在键盘收起阶段做校正或强制重排。（[WebKit Bugzilla][3]）</li>
<li><strong>键盘高度估算</strong>：在真正的 resize 数据到来前，用 300～360 的估算值顶高是务实的；数据到来后再校准。iPhone 的键盘高度因机型、语言、是否带预测栏而有差异，但绝大多数落在这个区间。</li>
</ol>
<hr/>
<h2 data-id="heading-32">总结</h2>
<p>iOS 键盘问题的难点从来不是"算不算得出 keyboardHeight"，而是：</p>
<ul>
<li><strong>你拿到可靠数据时，浏览器可能已经滚了</strong></li>
<li><strong>你想 focus 的时机，iOS 又要求必须在用户手势同步链路里</strong></li>
</ul>
<p>这里的方案把关键动作前移：<strong>把"键盘可见"当作可以被"预测"的状态，而不是只能被"检测"的结果</strong>。通过在用户手势链路中同步完成 <code>preventDefault → focus({ preventScroll: true }) → 预告键盘 → 手动滚动</code>，将体验从"偶现抖动/错位"拉回到"稳定可控"。</p>
<p>文章（非代码）的Co-author: Claude Opus 4.5GPT-5.1-Codex</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android App 开发基础知识（1） —— Gradle 如何编译你的 Kotlin 代码]]></title>    <link>https://juejin.cn/post/7600292312216059956</link>    <guid>https://juejin.cn/post/7600292312216059956</guid>    <pubDate>2026-01-28T12:12:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600292312216059956" data-draft-id="7600265780349403176" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android App 开发基础知识（1） —— Gradle 如何编译你的 Kotlin 代码"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-28T12:12:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="乐乐小王"/> <meta itemprop="url" content="https://juejin.cn/user/970216457113501"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android App 开发基础知识（1） —— Gradle 如何编译你的 Kotlin 代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/970216457113501/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    乐乐小王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:12:49.000Z" title="Wed Jan 28 2026 12:12:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android App 开发基础知识（1） —— Gradle 如何编译你的 Kotlin 代码</h2>
<h2 data-id="heading-1">1. 前言</h2>
<p>我们都知道基于 Gradle 构建框架做 Android 开发需要引入 Android Gradle Plugin（后文简写为 AGP）。但是该插件并不负责编译 Kotlin 源码相关内容。如果我们只引入 AGP，是无法写 Kotlin 代码的。</p>
<p>于是我们有 Kotlin Gradle Plugin 来帮忙编译 Kotlin 源码，这个插件和 AGP 是互相独立的，不要混淆</p>
<p><strong>本文只是引导，想具体了解请看源码，没有想象中那么困难！</strong></p>
<h2 data-id="heading-2">2. 如何在 Gradle 中引入 Kotlin 插件？</h2>
<h3 data-id="heading-3">2.1 在 Gradle 构建环境中引入 Kotlin 插件的 classpath</h3>
<p>app/build.gradle 中写：</p>
<pre><code class="hljs language-bash" lang="bash">buildscript {
    dependencies {
        classpath “`org.jetbrains.kotlin:kotlin-gradle-plugin:<span class="hljs-variable">$kotlin_version</span>`”
    }
}
</code></pre>
<h3 data-id="heading-4">2.2 引入 Kotlin 插件</h3>
<p>app/build.gradle 中写：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">apply: plugin “kotlin-android”</span>
</code></pre>
<p><strong>此时你就可以在 src 中写 Kotlin 代码了，src/java 和 src/kotlin 都可以，但是更建议 java，因为 java 下面也可以写 Kotlin，反之则不行</strong></p>
<h2 data-id="heading-5">3. Kotlin Gradle Plugin 是如何注册 Kotlin 编译任务的？</h2>
<p>KGP 本质也是一个普通的 Gradle Plugin 插件而已，和 AGP 一样。因为只需要负责 Kotlin 相关的任务，所以会比 AGP 实现简单很多</p>
<p>在正式分析源码之前，我们先思考一个问题：<strong>如果让你实现一个 KGP，你会怎么实现？</strong></p>
<p>如果是我来实现，我会这么考虑：</p>
<p>首先我们要继承这个接口（这是所有 Gradle 插件的入口）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * &lt;p&gt;A &lt;code&gt;Plugin&lt;/code&gt; represents an extension to Gradle. A plugin applies some configuration to a target object.
 * Usually, this target object is a {<span class="hljs-doctag">@link</span> org.gradle.api.Project}, but plugins can be applied to any type of
 * objects.&lt;/p&gt;
 *
 * <span class="hljs-doctag">@param</span> &lt;T&gt; The type of object which this plugin can configure.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Plugin</span>&lt;T&gt; {
    <span class="hljs-comment">/**
     * Apply this plugin to the given target object.
     *
     * <span class="hljs-doctag">@param</span> target The target object
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(T target)</span>;
}
</code></pre>
<p>然后在 apply 里实现具体的逻辑，主要是实现
<strong>注册 Kotlin 编译相关的任务（compileKotlin？ kaptGenerateStub？…)</strong></p>
<p>听起来似乎非常简单，我们可以看下真正的 KGP 是否如我们思考的一样简单</p>
<p>让我们开始阅读 Kotlin 源码吧！</p>
<p>第一个难题是怎么找到入口</p>
<p>结合前面的 apply: plugin “kotlin-android”</p>
<p>了解 Gradle 原理的同学应该知道这意味着 Kotlin 源码下一定有一个名为 <a href="https://link.juejin.cn?target=http%3A%2F%2Fkotlin-android.properties" target="_blank" title="http://kotlin-android.properties" ref="nofollow noopener noreferrer">kotlin-android.properties</a> 的文件记载了该插件的入口</p>
<p>我们找到这个文件，查看内容：
<code>implementation-class=org.jetbrains.kotlin.gradle.plugin.KotlinAndroidPluginWrapper</code></p>
<p>可以知道 KGP 的入口是</p>
<p><code>org.jetbrains.kotlin.gradle.plugin.KotlinAndroidPluginWrapper</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KotlinAndroidPluginWrapper</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    registry: ToolingModelBuilderRegistry
) : AbstractKotlinAndroidPluginWrapper(registry) {

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> pluginVariant: String = PLUGIN_VARIANT_NAME

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> {
        project.registerVariantImplementations()
        <span class="hljs-keyword">super</span>.apply(project)
    }
}
</code></pre>
<p>Kotlin 源码代码风格就喜欢层层依赖，通过各种继承复用代码。因为我们只考虑 Kotlin JVM 平台，实际上 Kotlin 还能被编译到其他平台，所以 Kotlin 源码里有很多我们不需要关注的，比如 JS 平台之类的</p>
<p>但我们知道 KotlinAndroidPluginWrapper 一定会继承到 Gradle 的 Plugin</p>
<p>我把继承链画出来：</p>
<p><code>KotlinAndroidPluginWrapper</code></p>
<p>→
<code>AbstractKotlinAndroidPluginWrapper</code></p>
<p>→
<code>KotlinBasePluginWrapper</code></p>
<p>→
<code>DefaultKotlinBasePlugin</code></p>
<p>→
<code>KotlinBasePlugin</code></p>
<p>到最后一层其实就一个成员：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * The base interface for all Kotlin Gradle plugins.
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">KotlinBasePlugin</span> : <span class="hljs-type">Plugin</span>&lt;<span class="hljs-type">Project</span>&gt; {

    <span class="hljs-comment">/**
     * The current plugin version.
     */</span>
    <span class="hljs-keyword">val</span> pluginVersion: String
}
</code></pre>
<p>Kotlin 就为了明确一下这个 plugin 有个 version 这个语义多做了一层继承…</p>
<p><code>DefaultKotlinBasePlugin</code></p>
<p>主要做了一些和注册编译任务本身无关的操作，注册了一些服务和后面可能用到的 extension，可以简单看下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> {

				<span class="hljs-comment">/*
				 * 这一部分就是在检查运行环境，如果运行环境不符合预期直接抛出错误，
				 * 避免后续出现更多因为运行环境不正确，莫名其妙的问题
				 */</span>
        project.checkCompilerEmbeddableInClasspath()
        project.registerDefaultVariantImplementations()
        <span class="hljs-keyword">if</span> (!project.kotlinPropertiesProvider.buildDisableGradleVersionCheck) {
            project.runGradleCompatibilityCheck()
            project.runAgpCompatibilityCheckIfAgpIsApplied()
        }

				<span class="hljs-comment">/*
				 * 注册乱七八糟的服务
				 */</span>
        <span class="hljs-keyword">val</span> buildUidService = BuildUidService.registerIfAbsent(project)
        BuildFusService.registerIfAbsent(project, pluginVersion, buildUidService)
        PropertiesBuildService.registerIfAbsent(project)

        project.gradle.projectsEvaluated {
            whenBuildEvaluated(project)
        }
        
        
				<span class="hljs-comment">/*
				 * 比较深度的使用 Gradle 接口，给 project 添加 configurations
				 * configurations 简单理解就是 JAR
				 * 这里是需要 Kotlin Compiler 的相关 JAR 用于编译任务
				 * 注册给 Gradle，后面需要调用编译器可以直接调用
				 * 这一块主要和 Gradle 底层关系比较大，后续可以考虑出博客介绍 Gradle
				 */</span>
        addKotlinCompilerConfiguration(project)

        project.configurations.maybeCreateResolvable(PLUGIN_CLASSPATH_CONFIGURATION_NAME).apply {
            isVisible = <span class="hljs-literal">false</span>
            addGradlePluginMetadataAttributes(project)
        }

        <span class="hljs-keyword">val</span> kotlinGradleBuildServices = KotlinGradleBuildServices.registerIfAbsent(project).<span class="hljs-keyword">get</span>()
        <span class="hljs-keyword">if</span> (!project.isProjectIsolationEnabled) {
            kotlinGradleBuildServices.detectKotlinPluginLoadedInMultipleProjects(project, pluginVersion)
        }

        BuildMetricsService.registerIfAbsent(project)
        KotlinNativeBundleBuildService.registerIfAbsent(project)
    }
</code></pre>
<p><code>KotlinBasePluginWrapper</code></p>
<p>中间层，因为这一层不是 Kotlin Android 专属的，同样有很多无关内容</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> {
        <span class="hljs-keyword">super</span>.apply(project)
				....
				<span class="hljs-comment">/*
				 * 重点关注这里的 plugin，就是 KotlinAndroidPlugin
				 */</span>
        <span class="hljs-keyword">val</span> plugin = getPlugin(project)
        plugin.apply(project)
        
        ....
    }
</code></pre>
<p><code>KotlinAndroidPlugin</code></p>
<p>这里才是主要的注册 Kotlin Android 相关任务的内容</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> {
    project.dynamicallyApplyWhenAndroidPluginIsApplied(
        {
		        <span class="hljs-comment">/*
		         * 这里先构建了一个 target
		         * 这段代码比较坑的点是 target 作为参数的方法基本都是在写 target
		         * 就是这个 target 是在慢慢变得完整的，一开始是个空的...
		         */</span>
            <span class="hljs-keyword">val</span> target = project.objects.KotlinAndroidTarget(project)
            <span class="hljs-keyword">val</span> kotlinAndroidExtension = project.kotlinExtension <span class="hljs-keyword">as</span> KotlinAndroidProjectExtension
            kotlinAndroidExtension.targetFuture.complete(target)
            project.configureCompilerOptionsForTarget(
                kotlinAndroidExtension.compilerOptions,
                target.compilerOptions
            )
            kotlinAndroidExtension.compilerOptions.noJdk.value(<span class="hljs-literal">true</span>).disallowChanges()

            <span class="hljs-meta">@Suppress(<span class="hljs-string">"DEPRECATION"</span>)</span> <span class="hljs-keyword">val</span> kotlinOptions = <span class="hljs-keyword">object</span> : KotlinJvmOptions {
                <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> options: KotlinJvmCompilerOptions
                    <span class="hljs-keyword">get</span>() = kotlinAndroidExtension.compilerOptions
            }
            <span class="hljs-comment">/*
             * Kotlin Android 必须和 AGP 一起使用，这里给 AGP 的拓展添加字段 
             * kotlinOptions
             */</span>
            <span class="hljs-keyword">val</span> ext = project.extensions.getByName(<span class="hljs-string">"android"</span>) <span class="hljs-keyword">as</span> BaseExtension
            ext.addExtension(KOTLIN_OPTIONS_DSL_NAME, kotlinOptions)
            target
        }
    ) { androidTarget -&gt;
        registry.register(KotlinModelBuilder(project.getKotlinPluginVersion(), androidTarget))
        project.whenEvaluated { project.components.addAll(androidTarget.components) }
    }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin">androidPluginIds.forEach { pluginId -&gt;
    plugins.withId(pluginId) {
        wasConfigured = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">val</span> target = kotlinAndroidTargetProvider()
        <span class="hljs-comment">/*
         * 这里就是最主要的填充 target 的地方
         */</span>
        androidTargetHandler().configureTarget(target)
        additionalConfiguration(target)
    }
}
</code></pre>
<p>重点看 configureTarget 的源码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">configureTarget</span><span class="hljs-params">(kotlinAndroidTarget: <span class="hljs-type">KotlinAndroidTarget</span>)</span></span> {
    <span class="hljs-keyword">val</span> project = kotlinAndroidTarget.project
    <span class="hljs-keyword">val</span> ext = project.extensions.getByName(<span class="hljs-string">"android"</span>) <span class="hljs-keyword">as</span> BaseExtension

		<span class="hljs-comment">/*
		 * 深入绑定 AGP 和 KGP 的 source
		 * 比如 KGP 为什么能识别 src/main/java 中的 kotlin 文件？
		 * PS: src/main/kotlin 里的 Java 文件不会被编译
		 */</span>
    applyKotlinAndroidSourceSetLayout(kotlinAndroidTarget)

	  <span class="hljs-comment">/*
	   * 再检查一波：这个 module（project） 一定要引入了 AGP
	   */</span>
    androidPluginIds
        .asSequence()
        .mapNotNull { project.plugins.findPlugin(it) <span class="hljs-keyword">as</span>? BasePlugin }
        .firstOrNull()
        ?: <span class="hljs-keyword">throw</span> InvalidPluginException(
            <span class="hljs-string">"'kotlin-android' expects one of the Android Gradle "</span> +
                    <span class="hljs-string">"plugins to be applied to the project:\n\t"</span> +
                    androidPluginIds.joinToString(<span class="hljs-string">"\n\t"</span>) { <span class="hljs-string">"* <span class="hljs-variable">$it</span>"</span> }
        )
        
		<span class="hljs-comment">/*
		 * 构建 Kotlin 编译任务
		 */</span>
    project.forAllAndroidVariants { variant -&gt;
		    <span class="hljs-comment">// compilation 的工厂集合，里面包含了很多工厂</span>
		    <span class="hljs-comment">// 比如 KotlinCompilationOutputFactory 用于生成编译的输出位置</span>
		    <span class="hljs-comment">// 我认为这里明显是有些过度设计的！！！不要太纠结这里，Kotlin 源码很喜欢搞这样的</span>
        <span class="hljs-keyword">val</span> compilationFactory = KotlinJvmAndroidCompilationFactory(kotlinAndroidTarget, variant)
        <span class="hljs-keyword">val</span> variantName = getVariantName(variant)

        <span class="hljs-comment">// Create the compilation and configure it first, then add to the compilations container. As this code is executed</span>
        <span class="hljs-comment">// in afterEvaluate, a user's build script might have already attached item handlers to the compilations container, and those</span>
        <span class="hljs-comment">// handlers might break when fired on a compilation that is not yet properly configured (e.g. KT-29964):</span>
        compilationFactory.create(variantName).let { compilation -&gt;
            setUpDependencyResolution(variant, compilation)
            
            <span class="hljs-comment">/*
             * 这里创建 Kotlin 编译任务，就是 Gradle 构建流程中可以看见的 compileKotlin 之类的任务
             */</span>
            preprocessVariant(variant, compilation, project, kotlinTasksProvider)

            <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
            (kotlinAndroidTarget.compilations <span class="hljs-keyword">as</span> NamedDomainObjectCollection&lt;<span class="hljs-keyword">in</span> KotlinJvmAndroidCompilation&gt;).add(compilation)
        }
    }
    
		<span class="hljs-comment">/*
		 * Kotlin 编译任务
		 */</span>
    project.whenEvaluated {
        forAllAndroidVariants { variant -&gt;
            <span class="hljs-keyword">val</span> compilation = kotlinAndroidTarget.compilations.getByName(getVariantName(variant))
            postprocessVariant(variant, compilation, project, ext)

            <span class="hljs-keyword">val</span> subpluginEnvironment = SubpluginEnvironment.loadSubplugins(project)
            subpluginEnvironment.addSubpluginOptions(project, compilation)
        }
        checkAndroidAnnotationProcessorDependencyUsage(project)

        addKotlinDependenciesToAndroidSourceSets(project)
    }

    project.includeKotlinToolingMetadataInApk()

    addAndroidUnitTestTasksAsDependenciesToAllTest(project)
}
</code></pre>
<p>我们在这里主要关注</p>
<p><strong>preprocessVariant</strong></p>
<p>和</p>
<p><strong>preprocessVariant</strong> 即可</p>
<p>前者负责创建 Kotlin 任务，后者负责协调 Kotlin 任务和 Java 任务的先后顺序</p>
<p>PS：AGP 本身就支持 Java 任务，KGP 这里就是在适配 AGP 的 Java 任务</p>
<p><strong>preprocessVariant</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preprocessVariant</span><span class="hljs-params">(
        <span class="hljs-meta">@Suppress(<span class="hljs-string">"TYPEALIAS_EXPANSION_DEPRECATION"</span>)</span> variantData: <span class="hljs-type">DeprecatedAndroidBaseVariant</span>,
        compilation: <span class="hljs-type">KotlinJvmAndroidCompilation</span>,
        project: <span class="hljs-type">Project</span>,
        tasksProvider: <span class="hljs-type">KotlinTasksProvider</span>
    )</span></span> {
	       ...
				<span class="hljs-comment">/*
				 * 这里就是 Kotlin 编译任务，主要要关注这个任务的 configure 包括什么动作
				 */</span>
        <span class="hljs-keyword">val</span> configAction = KotlinCompileConfig(KotlinCompilationInfo(compilation))
        configAction.configureTask { task -&gt;
            task.useModuleDetection.value(<span class="hljs-literal">true</span>).disallowChanges()
            <span class="hljs-comment">// store kotlin classes in separate directory. They will serve as class-path to java compiler</span>
            task.destinationDirectory.<span class="hljs-keyword">set</span>(project.layout.buildDirectory.dir(<span class="hljs-string">"tmp/kotlin-classes/<span class="hljs-variable">$variantDataName</span>"</span>))
            task.description = <span class="hljs-string">"Compiles the <span class="hljs-variable">$variantDataName</span> kotlin."</span>
        }
        ...
        
    }
</code></pre>
<p>configure 主要是两个类的 init
<code>BaseKotlinCompileConfig</code></p>
<p>→
<code>AbstractKotlinCompileConfig</code></p>
<p>Kotlin 中父类的 init 会先执行，我们先看 <code>AbstractKotlinCompileConfig</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">init</span> {
  ...
  <span class="hljs-comment">/*
   * 这下面都是 task 的 configure 流程
   * 其实看到这里后面一堆 
   * disallowChanges finalizeValueOnRead 之类的东西
   * 大概就能看出来 Gradle 的生命周期设计的多复杂。。。
   * 这里简单说一下 task 的类型是 KotlinCompile，这里就是填充这个类的字段而已
   * 不需要详细看每一个 field 是在干啥
   */</span>
  configureTask { task -&gt;
      <span class="hljs-keyword">val</span> propertiesProvider = project.kotlinPropertiesProvider

      task.taskBuildCacheableOutputDirectory
          .value(getKotlinBuildDir(task).map { it.dir(<span class="hljs-string">"cacheable"</span>) })
          .disallowChanges()
      task.taskBuildLocalStateDirectory
          .value(getKotlinBuildDir(task).map { it.dir(<span class="hljs-string">"local-state"</span>) })
          .disallowChanges()

      task.localStateDirectories.from(task.taskBuildLocalStateDirectory).disallowChanges()
      task.systemPropertiesService.value(compilerSystemPropertiesService).disallowChanges()

      task.kotlinCompilerArgumentsLogLevel.value(propertiesProvider.kotlinCompilerArgumentsLogLevel).disallowChanges()

      propertiesProvider.kotlinDaemonJvmArgs?.let { kotlinDaemonJvmArgs -&gt;
          task.kotlinDaemonJvmArguments.<span class="hljs-keyword">set</span>(providers.provider {
              kotlinDaemonJvmArgs.split(<span class="hljs-string">"\\s+"</span>.toRegex())
          })
      }
      task.compilerExecutionStrategy.convention(propertiesProvider.kotlinCompilerExecutionStrategy).finalizeValueOnRead()
      task.useDaemonFallbackStrategy.convention(propertiesProvider.kotlinDaemonUseFallbackStrategy).finalizeValueOnRead()
      task.suppressKotlinOptionsFreeArgsModificationWarning
          .convention(propertiesProvider.kotlinOptionsSuppressFreeArgsModificationWarning)
          .finalizeValueOnRead()

      task.preciseCompilationResultsBackup
          .convention(propertiesProvider.preciseCompilationResultsBackup)
          .finalizeValueOnRead()
      task.taskOutputsBackupExcludes.addAll(task.preciseCompilationResultsBackup.map {
          <span class="hljs-keyword">if</span> (it) listOf(task.destinationDirectory.<span class="hljs-keyword">get</span>().asFile, task.taskBuildLocalStateDirectory.<span class="hljs-keyword">get</span>().asFile) <span class="hljs-keyword">else</span> emptyList()
      })
      task.keepIncrementalCompilationCachesInMemory
          .convention(
              task.preciseCompilationResultsBackup.zip(propertiesProvider.keepIncrementalCompilationCachesInMemory) { thisTaskPreciseCompilationResultsBackup, defaultKeepIncrementalCompilationCachesInMemory -&gt;
                  thisTaskPreciseCompilationResultsBackup &amp;&amp; defaultKeepIncrementalCompilationCachesInMemory
              }
          )
          .finalizeValueOnRead()
      task.taskOutputsBackupExcludes.addAll(task.keepIncrementalCompilationCachesInMemory.map {
          <span class="hljs-keyword">if</span> (it) listOf(task.taskBuildCacheableOutputDirectory.<span class="hljs-keyword">get</span>().asFile) <span class="hljs-keyword">else</span> emptyList()
      })
      task.enableUnsafeIncrementalCompilationForMultiplatform
          .convention(propertiesProvider.enableUnsafeOptimizationsForMultiplatform)
          .finalizeValueOnRead()
      task.enableMonotonousIncrementalCompileSetExpansion
          .convention(propertiesProvider.enableMonotonousIncrementalCompileSetExpansion)
          .finalizeValueOnRead()
      task.buildFinishedListenerService.value(buildFinishedListenerService).disallowChanges()
      task.buildIdService.value(buildIdService).disallowChanges()

      task.incremental = <span class="hljs-literal">false</span>
      task.useModuleDetection.convention(<span class="hljs-literal">false</span>)
      task.runViaBuildToolsApi.convention(propertiesProvider.runKotlinCompilerViaBuildToolsApi).finalizeValueOnRead()

      task.explicitApiMode
          .value(explicitApiMode)
          .finalizeValueOnRead()
  }
}
</code></pre>
<p><code>BaseKotlinCompileConfig</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">init</span> {
  configureTaskProvider { taskProvider -&gt;
		  <span class="hljs-comment">/*
		   * 这个 propertiesProvider 写的挺有意思的，一个负责 property set 和 get 服务的 service
		   */</span>
      <span class="hljs-keyword">val</span> useClasspathSnapshot = propertiesProvider.useClasspathSnapshot.<span class="hljs-keyword">get</span>()
      
      
			<span class="hljs-comment">/*
			 * 可以关注一下这个 snapshot，这个是为了方便 Kotlin 增量编译引入的操作
			 * 后续会出博客单独讲述这个 snapshot
			 * 没有它也能增量编译，但是有了它效率更高
			 */</span>
      <span class="hljs-keyword">val</span> classpathConfiguration = <span class="hljs-keyword">if</span> (useClasspathSnapshot) {
          <span class="hljs-keyword">val</span> jvmToolchain = taskProvider.flatMap { it.defaultKotlinJavaToolchain }
          <span class="hljs-keyword">val</span> runKotlinCompilerViaBuildToolsApi = propertiesProvider.runKotlinCompilerViaBuildToolsApi
          registerTransformsOnce(project, jvmToolchain, runKotlinCompilerViaBuildToolsApi)
          <span class="hljs-comment">// Note: Creating configurations should be done during build configuration, not task configuration, to avoid issues with</span>
          <span class="hljs-comment">// composite builds (e.g., https://issuetracker.google.com/183952598).</span>
          project.configurations.detachedResolvable(
              project.dependencies.create(objectFactory.fileCollection().from(project.provider { taskProvider.<span class="hljs-keyword">get</span>().libraries }))
          )
      } <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>

      <span class="hljs-keyword">if</span> (useClasspathSnapshot) {
          taskProvider.configure { it.incrementalModuleInfoProvider.disallowChanges() }
      } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">val</span> incrementalModuleInfoProvider = IncrementalModuleInfoBuildService.registerIfAbsent(
              project,
              objectFactory.providerWithLazyConvention { GradleCompilerRunner.buildModulesInfo(project.gradle) },
          )
          taskProvider.configure { it.incrementalModuleInfoProvider.value(incrementalModuleInfoProvider).disallowChanges() }
      }

      taskProvider.configure { task -&gt;
          task.incremental = propertiesProvider.incrementalJvm ?: <span class="hljs-literal">true</span>
          task.usePreciseJavaTracking = propertiesProvider.usePreciseJavaTracking ?: <span class="hljs-literal">true</span>
          task.jvmTargetValidationMode.convention(propertiesProvider.jvmTargetValidationMode).finalizeValueOnRead()

          task.classpathSnapshotProperties.useClasspathSnapshot.value(useClasspathSnapshot).disallowChanges()
          <span class="hljs-keyword">if</span> (useClasspathSnapshot) {
              <span class="hljs-keyword">val</span> classpathEntrySnapshotFiles = classpathConfiguration!!.incoming.artifactView {
                  it.attributes.setAttribute(ARTIFACT_TYPE_ATTRIBUTE, CLASSPATH_ENTRY_SNAPSHOT_ARTIFACT_TYPE)
              }.files
              task.classpathSnapshotProperties.classpathSnapshot.from(classpathEntrySnapshotFiles).disallowChanges()
              task.classpathSnapshotProperties.classpathSnapshotDir.value(getClasspathSnapshotDir(task)).disallowChanges()
          } <span class="hljs-keyword">else</span> {
              task.classpathSnapshotProperties.classpath.from(task.project.provider { task.libraries }).disallowChanges()
          }
          task.taskOutputsBackupExcludes.addAll(
              task.classpathSnapshotProperties.classpathSnapshotDir.asFile.flatMap {
                  <span class="hljs-comment">// it looks weird, but it's required to work around this issue: https://github.com/gradle/gradle/issues/17704</span>
                  objectFactory.providerWithLazyConvention { listOf(it) }
              }.orElse(emptyList())
          )
      }
  }
}
</code></pre>
<p>到这里我们已经注册好了 KotlinCompile 这个任务，下一节具体来看这个任务的执行流程是什么样</p>
<h2 data-id="heading-6">4. KotlinCompile —— Kotlin 编译任务是如何调度 Kotlin 编译器编译 Kotlin 源码的</h2>
<p>坐标  <code>org.jetbrains.kotlin.gradle.tasks.KotlinCompile</code></p>
<p>这个任务的入口找  <code>TaskAction</code> 注解即可</p>
<p>继承链</p>
<p><code>KotlinCompile</code></p>
<p>→
<code>AbstractKotlinCompile</code></p>
<p>→
<code>AbstractKotlinCompileTool</code></p>
<p>→
<code>DefaultTask</code></p>
<p>TaskAction 注解在 <code>AbstractKotlinCompile</code></p>
<p>所以我们从这里看起</p>
<p><code>AbstractKotlinCompile.execute() -&gt;</code></p>
<p><code>AbstractKotlinCompile.executeImpl() -&gt;</code></p>
<p><code>KotlinCompile.callCompilerAsync() -&gt;</code></p>
<p><code>GradleCompilerRunner.runJvmCompilerAsync() -&gt;</code></p>
<p><code>GradleCompilerRunner.runCompilerAsync() -&gt;</code></p>
<p><code>GradleCompilerRunnerWithWorkers.runCompilerAsync() -&gt;</code></p>
<p><code>GradleCompilerRunnerWithWorkers.runCompilerAsync()</code> 没有直接实行任务，而是给 Gradle 的</p>
<p><code>WorkerExecutor</code> 执行，是异步的过程</p>
<p>执行的 Action 是 <code>GradleKotlinCompilerWorkAction</code>
<code>GradleKotlinCompilerWork.run() -&gt;</code></p>
<p><code>GradleKotlinCompilerWork.compileWithDaemonOrFallbackImpl()</code>
这里根据 strategy 可能调用三种 compile，分别是：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
     * Execute Kotlin compiler in its own daemon. Default strategy.
     *
     * Daemon may be shared across multiple compile tasks if it's considered compatible
     */</span>
    DAEMON(<span class="hljs-string">"daemon"</span>),

    <span class="hljs-comment">/**
     * Execute Kotlin compiler inside the Gradle process
     *
     * Note: currently this strategy doesn't support incremental compilation
     */</span>
    IN_PROCESS(<span class="hljs-string">"in-process"</span>),

    <span class="hljs-comment">/**
     * Execute Kotlin compiler in a new forked process for each compilation
     *
     * Note: currently this strategy doesn't support incremental compilation
     */</span>
    OUT_OF_PROCESS(<span class="hljs-string">"out-of-process"</span>),
    ;
</code></pre>
<p><code>kotlin.compiler.execution.strategy</code> 可以用来设置编译的模式，默认是 daemon 模式</p>
<p>这里可以看见 daemon 是唯一可以增量编译的模式，所以对于超大型工程而言，尽量使用默认模式</p>
<p><code>GradleKotlinCompilerWork.compileWithDaemonOrFallbackImpl() -&gt;</code></p>
<p><code>GradleKotlinCompilerWork.compileWithDaemon() -&gt;</code></p>
<p><code>GradleKotlinCompilerWork.incrementalCompilationWithDaemon() -&gt;</code>
从这里开始就是 kotlin daemon
<code>CompileServiceImpl.compile()</code></p>
<p>这里实际上是一个类似 RPC 的东西，看起来就像 client 直接调用函数一样，实际上是让 kotlin daemon（server） 执行的</p>
<p>最终会调用到</p>
<p><code>IncrementalJvmCompilerRunner.compile()</code></p>
<p>在这里面处理增量和实际编译的逻辑</p>
<p>如果想了解编译内部是怎么运行的，请查看：</p>
<p><code>org.jetbrains.kotlin.cli.jvm.K2JVMCompiler</code></p>
<h2 data-id="heading-7">5. 其他内容</h2>
<p>后面的博客方向：</p>
<ol>
<li>Gradle 深入分析</li>
<li>Kotlin 编译器增量流程</li>
<li>Java RMI 的实现原理</li>
</ol>
<p>联系方式：<a href="https://link.juejin.cn?target=mailto%3Axiongzile%40bytedance.com" target="_blank" title="mailto:xiongzile@bytedance.com" ref="nofollow noopener noreferrer">xiongzile@bytedance.com</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[协程取消全攻略：掌握“协作式”资源回收的艺术]]></title>    <link>https://juejin.cn/post/7600219080046051371</link>    <guid>https://juejin.cn/post/7600219080046051371</guid>    <pubDate>2026-01-28T12:44:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600219080046051371" data-draft-id="7600219080046034987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="协程取消全攻略：掌握“协作式”资源回收的艺术"/> <meta itemprop="keywords" content="Kotlin"/> <meta itemprop="datePublished" content="2026-01-28T12:44:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Ehtan_Zheng"/> <meta itemprop="url" content="https://juejin.cn/user/413072099642478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            协程取消全攻略：掌握“协作式”资源回收的艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/413072099642478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Ehtan_Zheng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:44:24.000Z" title="Wed Jan 28 2026 12:44:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在并发编程中，强行停止一个线程是极度危险且已过时的做法（如 <code>Thread.stop()</code>）。Kotlin 协程采取了完全不同的哲学：<strong>协作式取消（Cooperative Cancellation）</strong> 。这意味着取消不是一种命令，而是一次“请求”——协程需要主动检查自己是否被取消，并优雅地交出执行权。</p>
<hr/>
<h2 data-id="heading-0">一、 取消的触发：Scope 与 Job 的联动</h2>
<p>在协程中，取消是沿着 <strong>Job 层级结构</strong> 传播的。</p>
<ol>
<li><strong>取消作用域 (Scope)：</strong> 调用 <code>scope.cancel()</code> 会取消该作用域启动的所有子协程。</li>
<li><strong>取消特定 Job：</strong> 调用 <code>job.cancel()</code> 只会取消该 Job 及其子项，不影响父级及兄弟级。</li>
</ol>
<h3 data-id="heading-1">关键操作符对比</h3>





















<table><thead><tr><th><strong>方法</strong></th><th><strong>行为说明</strong></th></tr></thead><tbody><tr><td><strong><code>job.cancel()</code></strong></td><td>发出取消请求，但<strong>不等待</strong>协程真正结束。</td></tr><tr><td><strong><code>job.join()</code></strong></td><td>挂起当前协程，直到该任务运行结束。</td></tr><tr><td><strong><code>job.cancelAndJoin()</code></strong></td><td>发出取消请求并挂起，直到该任务彻底清理完毕。推荐用于确保资源释放的场景。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">二、 取消的核心：协作原则</h2>
<p><strong>划重点：如果协程正在执行繁重的 CPU 计算任务且没有检查取消状态，它将无法被取消。</strong></p>
<h3 data-id="heading-3">如何让你的协程“可被取消”？</h3>
<p>要让协程具备协作性，你有两种主流方案：</p>
<h4 data-id="heading-4">1. 周期性检查 <code>isActive</code></h4>
<p>这是最直接的办法。在 <code>while</code> 循环或耗时逻辑中检查协程的存活状态。</p>
<p>Kotlin</p>
<pre><code class="hljs language-javascript" lang="javascript">val job = scope.<span class="hljs-title function_">launch</span>(<span class="hljs-params">Dispatchers.Default</span>) {
    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> (i &lt; <span class="hljs-number">5</span> &amp;&amp; isActive) { <span class="hljs-comment">// 检查 isActive 标志位</span>
        <span class="hljs-comment">// 模拟耗时计算</span>
        <span class="hljs-title function_">println</span>(<span class="hljs-string">"Hello $i"</span>)
        i++
    }
}
</code></pre>
<h4 data-id="heading-5">2. 使用 <code>ensureActive()</code> 或 <code>yield()</code></h4>
<ul>
<li><strong><code>ensureActive()</code></strong> ：如果 Job 已取消，它会立即抛出 <code>CancellationException</code>。</li>
<li><strong><code>yield()</code></strong> ：不仅检查取消状态，还会让出 CPU 执行权，让其他协程有机会运行，是处理重度循环的推荐方式。</li>
</ul>
<p>Kotlin</p>
<pre><code class="hljs language-scss" lang="scss">val job = scope<span class="hljs-selector-class">.launch</span>(Dispatchers.Default) {
    for (i in <span class="hljs-number">1</span>..<span class="hljs-number">1000</span>) {
        <span class="hljs-built_in">ensureActive</span>() <span class="hljs-comment">// 如果已取消，直接抛出异常结束</span>
        <span class="hljs-comment">// 或者使用 yield()</span>
        <span class="hljs-comment">// yield() </span>
        <span class="hljs-built_in">executeComputation</span>()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-6">三、 挂起函数：天生支持取消</h2>
<p>绝大多数官方提供的挂起函数（如 <code>withContext</code>、<code>delay</code> 等）都是<strong>可取消的</strong>。它们在执行前都会检查当前协程的状态，并在取消时抛出 <code>CancellationException</code>。</p>
<p>如果你在 <code>try-catch</code> 中捕获了 <code>Exception</code>，请务必注意：<strong>不要吞掉 <code>CancellationException</code></strong>。</p>
<p>Kotlin</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// ❌ 错误示范：吞掉取消异常</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-title function_ invoke__">work</span>()
} <span class="hljs-keyword">catch</span> (e: <span class="hljs-built_in">Exception</span>) {
    <span class="hljs-comment">// 捕获了所有异常，包括 CancellationException</span>
    <span class="hljs-comment">// 导致协程无法正常进入取消状态</span>
    <span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"Error: <span class="hljs-subst">$e</span>"</span>)
}

<span class="hljs-comment">// ✅ 正确示范：重新抛出</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-title function_ invoke__">work</span>()
} <span class="hljs-keyword">catch</span> (e: CancellationException) {
    <span class="hljs-keyword">throw</span> e <span class="hljs-comment">// 必须重新抛出，让协程机制正常运行</span>
} <span class="hljs-keyword">catch</span> (e: <span class="hljs-built_in">Exception</span>) {
    <span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"Real error: <span class="hljs-subst">$e</span>"</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-7">四、 清理收尾：<code>finally</code> 与 <code>NonCancellable</code></h2>
<p>当协程被取消时，它会进入 <code>Cancelling</code> 状态并执行 <code>finally</code> 块中的逻辑（例如关闭数据库连接）。</p>
<h3 data-id="heading-8">陷阱：在 <code>finally</code> 中调用挂起函数</h3>
<p>当协程处于 <code>Cancelling</code> 状态时，普通的挂起函数会直接失效并继续抛出 <code>CancellationException</code>。如果你必须在清理时执行挂起操作（如：向服务器发送“取消成功”的通知），你需要使用特殊的上下文。</p>
<p>Kotlin</p>
<pre><code class="hljs language-scss" lang="scss">val job = scope<span class="hljs-selector-class">.launch</span> {
    try {
        <span class="hljs-built_in">doWork</span>()
    } finally {
        <span class="hljs-comment">// ❌ 这里直接调用挂起函数会失败</span>
        <span class="hljs-comment">// cleanupWork() </span>

        <span class="hljs-comment">// ✅ 使用 NonCancellable 上下文</span>
        <span class="hljs-built_in">withContext</span>(NonCancellable) {
            <span class="hljs-built_in">println</span>("正在执行最后的清理工作...")
            <span class="hljs-built_in">delay</span>(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 现在可以正常执行挂起操作了</span>
            <span class="hljs-built_in">println</span>("清理完毕")
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-9">五、 最佳实践总结</h2>
<ol>
<li><strong>保持协作：</strong> 确保耗时的计算逻辑中包含 <code>isActive</code> 检查或调用 <code>yield()</code>。</li>
<li><strong>不滥用 <code>NonCancellable</code>：</strong> 它非常强大但也危险，仅用于资源释放逻辑，不要在里面执行核心业务逻辑。</li>
<li><strong>理解异常模型：</strong> <code>CancellationException</code> 不会导致应用崩溃，它是协程用来正常终止流程的信号。</li>
<li><strong>优先使用封装：</strong> 尽量利用官方提供的 <code>withTimeout</code> 等自带取消机制的函数。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose原理六之Kotlin协程上下文]]></title>    <link>https://juejin.cn/post/7600291308409716790</link>    <guid>https://juejin.cn/post/7600291308409716790</guid>    <pubDate>2026-01-28T14:30:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600291308409716790" data-draft-id="7599917711792947210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose原理六之Kotlin协程上下文"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-28T14:30:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="裴云飞"/> <meta itemprop="url" content="https://juejin.cn/user/3734361144570285"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose原理六之Kotlin协程上下文
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3734361144570285/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    裴云飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:30:21.000Z" title="Wed Jan 28 2026 14:30:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是上下文</h2>
<p>Kotlin协程中，上下文就是这样一个<strong>不可变的上下文元素集合</strong>，它携带了协程运行所需的各种配置和服务。</p>
<h3 data-id="heading-1">1、1 技术定义</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// kotlin.coroutines.CoroutineContext.kt</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoroutineContext</span> {
    <span class="hljs-comment">/**
     * 通过 Key 获取上下文中的元素
     * 类似于：context[Job.Key] 获取 Job 对象
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;E : Element&gt;</span> <span class="hljs-title">get</span><span class="hljs-params">(key: <span class="hljs-type">Key</span>&lt;<span class="hljs-type">E</span>&gt;)</span></span>: E?
    
    <span class="hljs-comment">/**
     * 合并两个上下文
     * 类似于：context1 + context2
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">plus</span><span class="hljs-params">(context: <span class="hljs-type">CoroutineContext</span>)</span></span>: CoroutineContext
    
    <span class="hljs-comment">/**
     * 遍历所有元素
     * 用于内部实现，一般不直接使用
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">fold</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">R</span>, <span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R
    
    <span class="hljs-comment">/**
     * 移除某个元素
     * 类似于：context.minusKey(Job.Key) 移除 Job
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">minusKey</span><span class="hljs-params">(key: <span class="hljs-type">Key</span>&lt;*&gt;)</span></span>: CoroutineContext
}
</code></pre>
<p><strong>核心特点：</strong></p>
<ol>
<li><strong>不可变性</strong>：一旦创建就不能修改，只能通过 <code>+</code> 操作符创建新的上下文</li>
<li><strong>元素集合</strong>：包含多个不同类型的元素</li>
<li><strong>类型安全</strong>：通过 Key 确保类型安全</li>
</ol>
<h3 data-id="heading-2">1、2 Element的定义</h3>
<p>每个上下文元素必须实现 <code>CoroutineContext.Element</code> 接口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Element</span> : <span class="hljs-type">CoroutineContext</span> {
    <span class="hljs-comment">/**
     * 用于在上下文中查找此元素的唯一 Key
     * 每个 Element 类型都有一个对应的 Key 单例对象
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> key: Key&lt;*&gt;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Key</span>&lt;<span class="hljs-type">E : Element</span>&gt;
</code></pre>
<h3 data-id="heading-3">1、3 Key的作用</h3>
<p><code>Key</code> 就像是元素的"身份证号"，用于在上下文中唯一标识一个元素类型。</p>
<h3 data-id="heading-4">1、4 实际示例：Job 的实现</h3>
<p>让我们看看 <code>Job</code> 是如何实现 <code>Element</code> 的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Job.kt (简化版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Job</span> : <span class="hljs-type">CoroutineContext.Element</span> {
    <span class="hljs-comment">// Job 的 Key 是一个单例对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> Key : CoroutineContext.Key&lt;Job&gt;
    
    <span class="hljs-comment">// 实现 Element 接口，返回 Key</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> key: CoroutineContext.Key&lt;*&gt;
        <span class="hljs-keyword">get</span>() = Key
    
    <span class="hljs-comment">// Job 的其他方法...</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> isActive: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> isCompleted: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> isCancelled: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cancel</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>关键理解：</strong></p>
<ol>
<li><strong>每种 Element 类型都有一个唯一的 Key</strong>：<code>Job.Key</code>、<code>CoroutineName.Key</code> 等</li>
<li><strong>一个 CoroutineContext 中每种 Key 最多只有一个对应的 Element</strong>：你不能在同一个上下文中有两个 Job</li>
<li><strong>使用 <code>context[Key]</code> 可以获取对应的 Element</strong>：<code>context[Job.Key]</code> 返回 Job 对象</li>
</ol>
<h3 data-id="heading-5">1、5 使用示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建一个包含多个元素的上下文</span>
<span class="hljs-keyword">val</span> context = Dispatchers.Main + Job() + CoroutineName(<span class="hljs-string">"MyCoroutine"</span>)

<span class="hljs-comment">// 通过 Key 获取元素</span>
<span class="hljs-keyword">val</span> job = context[Job.Key]  <span class="hljs-comment">// 获取 Job 对象</span>
<span class="hljs-keyword">val</span> name = context[CoroutineName.Key]  <span class="hljs-comment">// 获取 CoroutineName 对象</span>
<span class="hljs-keyword">val</span> dispatcher = context[ContinuationInterceptor.Key]  <span class="hljs-comment">// 获取 Dispatcher</span>

println(job)  <span class="hljs-comment">// 输出：JobImpl{Active}@12345678</span>
println(name)  <span class="hljs-comment">// 输出：CoroutineName(MyCoroutine)</span>
println(dispatcher)  <span class="hljs-comment">// 输出：HandlerDispatcher@Main</span>
</code></pre>
<h2 data-id="heading-6">二、常见的上下文元素详解</h2>
<h3 data-id="heading-7">2、1 Job - 协程的生命周期控制器</h3>
<p><strong>作用：</strong> 控制协程的生命周期，包括取消、等待完成等。</p>
<p><strong>Key：</strong> <code>Job.Key</code></p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建一个 Job</span>
<span class="hljs-keyword">val</span> job = Job()

<span class="hljs-comment">// 创建一个包含 Job 的上下文</span>
<span class="hljs-keyword">val</span> context = Dispatchers.Main + job

<span class="hljs-comment">// 使用 Job 控制协程</span>
<span class="hljs-keyword">val</span> scope = CoroutineScope(context)

scope.launch {
    println(<span class="hljs-string">"协程开始执行"</span>)
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"协程执行完毕"</span>)
}

<span class="hljs-comment">// 取消协程</span>
job.cancel()  <span class="hljs-comment">// 这会取消所有使用这个 Job 的协程</span>
</code></pre>
<p><strong>Job 的状态：</strong></p>
<ul>
<li><code>isActive</code>：协程是否活跃</li>
<li><code>isCompleted</code>：协程是否已完成</li>
<li><code>isCancelled</code>：协程是否被取消</li>
</ul>
<h3 data-id="heading-8">2、2 CoroutineDispatcher - 协程的执行器</h3>
<p><strong>作用：</strong> 决定协程在哪个线程或线程池中执行。</p>
<p><strong>Key：</strong> <code>ContinuationInterceptor.Key</code>（注意：Dispatcher 实际上是 ContinuationInterceptor 的子类）</p>
<p><strong>常见的 Dispatcher：</strong></p>






























<table><thead><tr><th>Dispatcher</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td><code>Dispatchers.Main</code></td><td>主线程</td><td>UI 操作、Android 界面更新</td></tr><tr><td><code>Dispatchers.IO</code></td><td>IO 线程池</td><td>网络请求、文件读写、数据库操作</td></tr><tr><td><code>Dispatchers.Default</code></td><td>CPU 密集型线程池</td><td>计算密集型任务</td></tr><tr><td><code>Dispatchers.Unconfined</code></td><td>不限制线程</td><td>特殊场景，一般不使用</td></tr></tbody></table>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在主线程执行</span>
launch(Dispatchers.Main) {
    <span class="hljs-comment">// 更新 UI</span>
    textView.text = <span class="hljs-string">"Hello"</span>
}

<span class="hljs-comment">// 在 IO 线程执行</span>
launch(Dispatchers.IO) {
    <span class="hljs-comment">// 网络请求</span>
    <span class="hljs-keyword">val</span> response = httpClient.<span class="hljs-keyword">get</span>(<span class="hljs-string">"https://api.example.com"</span>)
}

<span class="hljs-comment">// 在默认线程池执行</span>
launch(Dispatchers.Default) {
    <span class="hljs-comment">// 计算密集型任务</span>
    <span class="hljs-keyword">val</span> result = heavyComputation()
}
</code></pre>
<h3 data-id="heading-9">2、3 CoroutineName - 协程的名称</h3>
<p><strong>作用：</strong> 为协程命名，方便调试和日志追踪。</p>
<p><strong>Key：</strong> <code>CoroutineName.Key</code></p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建一个带名称的协程</span>
launch(CoroutineName(<span class="hljs-string">"DataLoader"</span>)) {
    println(<span class="hljs-string">"协程名称: <span class="hljs-subst">${coroutineContext[CoroutineName]}</span>"</span>)
    <span class="hljs-comment">// 输出：协程名称: CoroutineName(DataLoader)</span>
}

<span class="hljs-comment">// 在调试时，协程名称会显示在日志中</span>
<span class="hljs-comment">// 例如：[DataLoader @coroutine#1] Loading data...</span>
</code></pre>
<h3 data-id="heading-10">2、4 CoroutineExceptionHandler - 异常处理器</h3>
<p><strong>作用：</strong> 处理协程中未捕获的异常。</p>
<p><strong>Key：</strong> <code>CoroutineExceptionHandler.Key</code></p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建异常处理器</span>
<span class="hljs-keyword">val</span> handler = CoroutineExceptionHandler { context, exception -&gt;
    println(<span class="hljs-string">"协程异常: <span class="hljs-variable">$exception</span>"</span>)
    println(<span class="hljs-string">"协程上下文: <span class="hljs-variable">$context</span>"</span>)
}

<span class="hljs-comment">// 使用异常处理器</span>
<span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.Main + handler)

scope.launch {
    <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"出错了！"</span>)
}
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 协程异常: java.lang.RuntimeException: 出错了！</span>
<span class="hljs-comment">// 协程上下文: [CoroutineExceptionHandler@12345678, JobImpl{Cancelled}@87654321]</span>
</code></pre>
<h2 data-id="heading-11">三、上下文的 + 操作符详解</h2>
<h3 data-id="heading-12">3、1 基本用法</h3>
<p>使用 <code>+</code> 操作符可以合并两个上下文：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例 1：逐步构建上下文</span>
<span class="hljs-keyword">val</span> context1 = Dispatchers.Main
<span class="hljs-keyword">val</span> context2 = context1 + Job()
<span class="hljs-keyword">val</span> context3 = context2 + CoroutineName(<span class="hljs-string">"MyCoroutine"</span>)

<span class="hljs-comment">// context3 包含：Dispatchers.Main, Job, CoroutineName</span>

<span class="hljs-comment">// 示例 2：一次性构建</span>
<span class="hljs-keyword">val</span> context = Dispatchers.Main + Job() + CoroutineName(<span class="hljs-string">"MyCoroutine"</span>)
</code></pre>
<h3 data-id="heading-13">3、2 覆盖规则</h3>
<p>如果两个上下文包含相同 Key 的元素，<strong>右边的元素会覆盖左边的</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 覆盖示例</span>
<span class="hljs-keyword">val</span> context1 = Dispatchers.Main + Job() + CoroutineName(<span class="hljs-string">"Parent"</span>)
<span class="hljs-keyword">val</span> context2 = context1 + Dispatchers.IO

<span class="hljs-comment">// context2 中的 Dispatcher 变成了 Dispatchers.IO（覆盖了 Dispatchers.Main）</span>
<span class="hljs-comment">// 但 Job 和 CoroutineName 保持不变</span>

println(context2[ContinuationInterceptor])  <span class="hljs-comment">// 输出：Dispatchers.IO</span>
println(context2[Job])  <span class="hljs-comment">// 输出：原来的 Job</span>
println(context2[CoroutineName])  <span class="hljs-comment">// 输出：CoroutineName(Parent)</span>
</code></pre>
<h3 data-id="heading-14">3、3 为什么右边覆盖左边？</h3>
<p>这是为了提供灵活性。想象一下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 基础上下文</span>
<span class="hljs-keyword">val</span> baseContext = Dispatchers.Main + Job() + CoroutineName(<span class="hljs-string">"Base"</span>)

<span class="hljs-comment">// 在特定场景下，我们想改变 Dispatcher，但保留其他配置</span>
<span class="hljs-keyword">val</span> specialContext = baseContext + Dispatchers.IO

<span class="hljs-comment">// specialContext 现在包含：</span>
<span class="hljs-comment">// - Dispatchers.IO（覆盖了 Main）</span>
<span class="hljs-comment">// - Job（继承自 baseContext）</span>
<span class="hljs-comment">// - CoroutineName("Base")（继承自 baseContext）</span>
</code></pre>
<h3 data-id="heading-15">3、4 实际应用示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建一个基础作用域</span>
<span class="hljs-keyword">val</span> baseScope = CoroutineScope(
    Dispatchers.Main +
    Job() +
    CoroutineName(<span class="hljs-string">"BaseScope"</span>) +
    CoroutineExceptionHandler { _, e -&gt;
        println(<span class="hljs-string">"全局异常处理: <span class="hljs-variable">$e</span>"</span>)
    }
)

<span class="hljs-comment">// 在基础作用域中启动协程</span>
baseScope.launch {
    <span class="hljs-comment">// 这个协程继承了所有基础配置</span>
    println(<span class="hljs-string">"协程名称: <span class="hljs-subst">${coroutineContext[CoroutineName]}</span>"</span>)
    <span class="hljs-comment">// 输出：协程名称: CoroutineName(BaseScope)</span>
    
    <span class="hljs-comment">// 但我们可以覆盖某些配置</span>
    launch(Dispatchers.IO + CoroutineName(<span class="hljs-string">"Child"</span>)) {
        <span class="hljs-comment">// 这个子协程覆盖了 Dispatcher 和 CoroutineName</span>
        println(<span class="hljs-string">"子协程名称: <span class="hljs-subst">${coroutineContext[CoroutineName]}</span>"</span>)
        println(<span class="hljs-string">"子协程 Dispatcher: <span class="hljs-subst">${coroutineContext[ContinuationInterceptor]}</span>"</span>)
        <span class="hljs-comment">// 输出：</span>
        <span class="hljs-comment">// 子协程名称: CoroutineName(Child)</span>
        <span class="hljs-comment">// 子协程 Dispatcher: Dispatchers.IO</span>
    }
}
</code></pre>
<h2 data-id="heading-16">四、子协程的上下文继承机制</h2>
<h3 data-id="heading-17">4、1 继承规则</h3>
<p>当使用 <code>launch</code> 或 <code>async</code> 启动子协程时：</p>
<ol>
<li><strong>默认继承父协程的完整上下文</strong></li>
<li><strong>可以覆盖特定元素</strong></li>
<li><strong>未覆盖的元素保持不变</strong></li>
</ol>
<h3 data-id="heading-18">4、2 详细示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建父协程作用域</span>
<span class="hljs-keyword">val</span> scope = CoroutineScope(
    Dispatchers.Main +
    Job() +
    CoroutineName(<span class="hljs-string">"Parent"</span>) +
    CoroutineExceptionHandler { _, e -&gt; println(<span class="hljs-string">"父异常: <span class="hljs-variable">$e</span>"</span>) }
)

scope.launch {
    <span class="hljs-comment">// 这个协程继承了父作用域的所有配置</span>
    println(<span class="hljs-string">"=== 父协程 ==="</span>)
    println(<span class="hljs-string">"名称: <span class="hljs-subst">${coroutineContext[CoroutineName]}</span>"</span>)
    println(<span class="hljs-string">"Dispatcher: <span class="hljs-subst">${coroutineContext[ContinuationInterceptor]}</span>"</span>)
    println(<span class="hljs-string">"Job: <span class="hljs-subst">${coroutineContext[Job]}</span>"</span>)
    println(<span class="hljs-string">"异常处理器: <span class="hljs-subst">${coroutineContext[CoroutineExceptionHandler]}</span>"</span>)
    
    <span class="hljs-comment">// 启动子协程，覆盖部分配置</span>
    launch(
        context = Dispatchers.IO + CoroutineName(<span class="hljs-string">"Child"</span>),
        block = {
            println(<span class="hljs-string">"\n=== 子协程 ==="</span>)
            println(<span class="hljs-string">"名称: <span class="hljs-subst">${coroutineContext[CoroutineName]}</span>"</span>)
            println(<span class="hljs-string">"Dispatcher: <span class="hljs-subst">${coroutineContext[ContinuationInterceptor]}</span>"</span>)
            println(<span class="hljs-string">"Job: <span class="hljs-subst">${coroutineContext[Job]}</span>"</span>)
            println(<span class="hljs-string">"异常处理器: <span class="hljs-subst">${coroutineContext[CoroutineExceptionHandler]}</span>"</span>)
        }
    )
}
</code></pre>
<p><strong>输出：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">=== 父协程 ===
<span class="hljs-section">名称: CoroutineName(Parent)</span>
<span class="hljs-section">Dispatcher: Dispatchers.Main</span>
<span class="hljs-section">Job: JobImpl{Active}@12345678</span>
<span class="hljs-section">异常处理器: CoroutineExceptionHandler@87654321</span>

=== 子协程 ===
<span class="hljs-section">名称: CoroutineName(Child)  ← 被覆盖</span>
<span class="hljs-section">Dispatcher: Dispatchers.IO  ← 被覆盖</span>
<span class="hljs-section">Job: JobImpl{Active}@12345678  ← 继承自父协程</span>
<span class="hljs-section">异常处理器: CoroutineExceptionHandler@87654321  ← 继承自父协程</span>
</code></pre>
<h3 data-id="heading-19">4、3 继承链图</h3>
<pre><code class="hljs language-scss" lang="scss">父作用域上下文
┌─────────────────────────────────────┐
│ Dispatchers<span class="hljs-selector-class">.Main</span>                    │
│ <span class="hljs-built_in">Job</span>(parent)                         │
│ <span class="hljs-built_in">CoroutineName</span>("Parent")             │
│ CoroutineExceptionHandler           │
└─────────────────────────────────────┘
              ↓ 继承
子协程上下文（未覆盖）
┌─────────────────────────────────────┐
│ Dispatchers<span class="hljs-selector-class">.Main</span>  ← 继承            │
│ <span class="hljs-built_in">Job</span>(child) ← 新创建，parent=parent   │
│ <span class="hljs-built_in">CoroutineName</span>("Parent")  ← 继承      │
│ CoroutineExceptionHandler  ← 继承    │
└─────────────────────────────────────┘

子协程上下文（覆盖部分）
┌─────────────────────────────────────┐
│ Dispatchers<span class="hljs-selector-class">.IO</span>  ← 覆盖               │
│ <span class="hljs-built_in">Job</span>(child)  ← 新创建，parent=parent   │
│ <span class="hljs-built_in">CoroutineName</span>("Child")  ← 覆盖       │
│ CoroutineExceptionHandler  ← 继承    │
└─────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-20">4、4 Job 的特殊继承规则</h3>
<p><strong>重要：</strong> 子协程的 Job 总是新的，但它的 parent 是父协程的 Job。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> parentJob = Job()
<span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.Main + parentJob)

scope.launch {
    <span class="hljs-keyword">val</span> childJob = coroutineContext[Job]!!
    
    println(<span class="hljs-string">"父 Job: <span class="hljs-variable">$parentJob</span>"</span>)
    println(<span class="hljs-string">"子 Job: <span class="hljs-variable">$childJob</span>"</span>)
    println(<span class="hljs-string">"子 Job 的父 Job: <span class="hljs-subst">${childJob.parent}</span>"</span>)
    
    <span class="hljs-comment">// 输出：</span>
    <span class="hljs-comment">// 父 Job: JobImpl{Active}@12345678</span>
    <span class="hljs-comment">// 子 Job: JobImpl{Active}@87654321</span>
    <span class="hljs-comment">// 子 Job 的父 Job: JobImpl{Active}@12345678</span>
}
</code></pre>
<p><strong>这意味着：</strong></p>
<ul>
<li>取消父 Job 会取消所有子 Job</li>
<li>子 Job 失败会影响父 Job（除非使用 <code>SupervisorJob</code>）</li>
</ul>
<h2 data-id="heading-21">五、上下文的其他操作</h2>
<h3 data-id="heading-22">5、1 minusKey - 移除元素</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> context = Dispatchers.Main + Job() + CoroutineName(<span class="hljs-string">"MyCoroutine"</span>)

<span class="hljs-comment">// 移除 Job</span>
<span class="hljs-keyword">val</span> contextWithoutJob = context.minusKey(Job.Key)

println(context[Job])  <span class="hljs-comment">// 输出：JobImpl{Active}@12345678</span>
println(contextWithoutJob[Job])  <span class="hljs-comment">// 输出：null</span>
</code></pre>
<h3 data-id="heading-23">5、2 fold - 遍历元素</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> context = Dispatchers.Main + Job() + CoroutineName(<span class="hljs-string">"MyCoroutine"</span>)

<span class="hljs-comment">// 遍历所有元素</span>
context.fold(<span class="hljs-string">"元素列表: "</span>) { acc, element -&gt;
    <span class="hljs-string">"<span class="hljs-variable">$acc</span>, <span class="hljs-subst">${element.key}</span>"</span>
}
<span class="hljs-comment">// 输出：元素列表: , ContinuationInterceptor.Key, Job.Key, CoroutineName.Key</span>
</code></pre>
<h2 data-id="heading-24">六、实际应用场景</h2>
<h3 data-id="heading-25">6、1 创建自定义协程作用域</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建一个专门用于网络请求的作用域</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkScope</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> job = SupervisorJob()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> handler = CoroutineExceptionHandler { _, e -&gt;
        println(<span class="hljs-string">"网络请求失败: <span class="hljs-variable">$e</span>"</span>)
    }
    
    <span class="hljs-keyword">val</span> scope = CoroutineScope(
        Dispatchers.IO +
        job +
        CoroutineName(<span class="hljs-string">"NetworkScope"</span>) +
        handler
    )
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cleanup</span><span class="hljs-params">()</span></span> {
        job.cancel()
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> networkScope = NetworkScope()

networkScope.scope.launch {
    <span class="hljs-comment">// 网络请求</span>
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = fetchData()
    println(<span class="hljs-keyword">data</span>)
}

<span class="hljs-comment">// 清理</span>
networkScope.cleanup()
</code></pre>
<h2 data-id="heading-26">七、总结</h2>
<p><strong>上下文的核心概念：</strong></p>
<ol>
<li><strong>不可变的元素集合</strong>：类似于一个不可变的 Map，Key 是元素类型，Value 是元素实例</li>
<li><strong>Element 和 Key</strong>：每个 Element 类型都有一个唯一的 Key，用于标识和查找</li>
<li><strong>+ 操作符</strong>：用于合并上下文，右边的元素会覆盖左边的相同 Key 的元素</li>
<li><strong>上下文继承</strong>：子协程默认继承父协程的上下文，但可以覆盖特定元素</li>
<li><strong>常见元素</strong>：
<ul>
<li><code>Job</code>：控制生命周期</li>
<li><code>CoroutineDispatcher</code>：决定执行线程</li>
<li><code>CoroutineName</code>：协程名称</li>
<li><code>CoroutineExceptionHandler</code>：异常处理</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PausableComposition 如何提升 Compose 滑动性能]]></title>    <link>https://juejin.cn/post/7600293373475373056</link>    <guid>https://juejin.cn/post/7600293373475373056</guid>    <pubDate>2026-01-28T15:21:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600293373475373056" data-draft-id="7600242248861990952" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PausableComposition 如何提升 Compose 滑动性能"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-28T15:21:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XDMrWu"/> <meta itemprop="url" content="https://juejin.cn/user/395479914649933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PausableComposition 如何提升 Compose 滑动性能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479914649933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XDMrWu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:21:03.000Z" title="Wed Jan 28 2026 15:21:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 Android 开发中，列表滑动的流畅度是衡量用户体验的核心指标。长期以来，RecyclerView 围绕滑动场景进行了大量针对性的性能优化，在实际性能表现上始终优于 Compose 的 LazyList。然而官方最新的 Benchmark 数据显示，Compose 在 1.9 版本上的列表滑动性能已经追平传统 View 体系，这一优化背后的核心机制就是 <strong>PausableComposition。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70f3e57c8f2449c99e52cc197148a7ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWERNcld1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218469&amp;x-signature=67hhfa4k8r2k8CgN33rA4y%2By%2FcY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">Compose 现有的滑动优化机制</h2>
<p>在介绍基于 PausableComposition 的优化策略之前，我们先来了解一下 Compose 中现有的优化机制 - <strong>LazyLayout Prefetch</strong>。</p>
<p>Compose 中的 LazyColumn、LazyRow 等组件都是基于 <code>LazyLayout</code> 实现，通过按需渲染屏幕中的子组件减少性能损耗。然而这种策略在滑动场景下会有一个明显的问题：<strong>子组件只会在快要进入屏幕时进行组合、布局、渲染，容易造成滑动卡顿。</strong></p>
<p>Compose 采用了 Prefetch 机制来优化这个问题，核心策略是：<strong>在当前帧的空闲时间内提前执行下一个子组件的 Compose、Measure 两个阶段，减少该组件后续上屏时的耗时。</strong> 如果子组件的 Compose、Measure 耗时较长，仍然会导致列表卡顿，因此Compose 在 Prefetch 过程中会记录过往每次 PreCompose、PreMeasure 执行的耗时，并基于此计算出平均耗时 <strong>averageTime</strong>，后续每次 Prefetch 都只会在当前帧的剩余时间 <strong>leftTime</strong> 大于<strong>averageTime</strong>时执行，如果时间不够则等待下一帧再进行判断。整体流程如下图所示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52e456527dd84da3864a9cad67b98ba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWERNcld1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218469&amp;x-signature=fqdaSEuPEzm9bEz2toC%2B5wciuyg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">基于 PausableComposition 的优化机制</h2>
<h3 data-id="heading-3">什么是 PausableComposition</h3>
<p>普通 <code>Composition</code> 会在一次调用中完成整个 Compose 阶段的执行，而 <code>PausableComposition</code> 允许外部控制 Compose 阶段的执行与暂停，也就说我们可以将 Compose 阶段拆分为更小的粒度增量执行。</p>
<p><code>PausableComposition</code> 接口定义如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PausableComposition</span> : <span class="hljs-type">ReusableComposition</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setPausableContent</span><span class="hljs-params">(content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>)</span></span>: PausedComposition
}
</code></pre>
<p>通过调用<code>PausableComposition#setPausableContent</code>方法启动 PausableComposition，并返回一个<code>PausedComposition</code>，可以将<code>PausedComposition</code>理解为<code>PausableComposition</code> 的控制器，通过它来控制<code>PausableComposition</code>的执行与暂停。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PausedComposition</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> isComplete: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">resume</span><span class="hljs-params">(shouldPause: <span class="hljs-type">ShouldPauseCallback</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">()</span></span>
}
</code></pre>
<p><code>PausableComposition</code> 不会立刻启动 Compose ，而是等待 <code>resume</code> 方法被调用。从整体上看，PausableComposition 的执行可以理解为一个「可被多次 resume 的 Compose 任务」，直到最终完成并一次性 apply。大致执行流程如下：</p>
<ol>
<li>调用 resume，开始执行 Compose</li>
<li>在执行过程中，通过 <code>ShouldPauseCallback</code> 判断是否需要暂停当前 Composition</li>
<li>若当前Composition完成执行， resume 返回 true</li>
<li>若未完成，则需要后续再次触发 resume 直至完成执行</li>
<li>当 Composition 完成后，调用 <code>apply</code>将变更提交到 Applier</li>
</ol>
<p>简化后的流程如图所示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a46358a630524d8d8c828b80ec40a992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWERNcld1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218469&amp;x-signature=g9CYTP1NfNNBDlVB4S%2FbNhfrdB8%3D" alt="image.png" loading="lazy"/>
<code>PausableComposition</code> 将 Compose 拆分为了更小的执行单元，并基于此实现 Compose 增量执行，将上图中的 <code>Do Compose</code>部分展开后，大致的流程如下图所示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd9279ea87514721af8950d12501b40d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWERNcld1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218469&amp;x-signature=z0ialgGH%2FDXyBo1XMP5o2Lztl48%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">基于 PausableComposition 优化</h3>
<p>现有 Prefetch 机制在 Compose UI 比较复杂的场景下，单个组件的 Compose 耗时会比较长，很容易超过每一帧的剩余时间(leftTime)，此时 Prefetch 的触发成功率会显著下降，效果接近于未开启状态。之所以会有这样的问题，根本上来说是因为 Compose 需要一次性完成执行，而 <strong>PausableComposition</strong> 支持增量执行的能力则为这一问题提供了一种有效的解决思路。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9126f4bd05f4745942b6b195455f3bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWERNcld1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218469&amp;x-signature=FOEa5GGs9UfZ14x7kKxx42XOFj8%3D" alt="" loading="lazy"/></p>
<p>核心优化思路是：<strong>Prefetch 阶段不再完整执行 Compose，而是通过 PausableComposition 增量执行拆分后的子 Composable</strong>。具体策略如下</p>
<ol>
<li>在 Prefetch 阶段，使用 PausableComposition 执行子 Composable</li>
<li>每一帧仅执行一部分 Compose</li>
<li>当检测到当前帧剩余时间不足时，暂停 Composition</li>
<li>在下一帧继续执行，直到完成</li>
</ol>
<p>这样一来，Compose 的执行粒度由原先以<strong>完整 Compose 为单位的一次性执行</strong>，拆分为<strong>以更小粒度子 Composable 为单位的增量执行</strong>；相应地，Prefetch 的触发条件也从“当前帧剩余时间需大于整个 Compose 的平均耗时”，转变为“当前帧剩余时间只需大于单个子 Composable 的平均执行耗时”。显然后者更容易被满足，从而显著提升 Prefetch 的触发成功率，并进一步降低对主线程耗时的影响。</p>
<h3 data-id="heading-5">支持自定义 CacheWindow</h3>
<p>在 Compose 1.9 中，LazyLayout 还引入了 <strong>LazyLayoutCacheWindow</strong>，允许开发者自定义 Prefetch 的覆盖范围。该能力与 <strong>PausableComposition</strong> 配合使用，可以进一步提升列表在高强度滑动场景下的稳定性。</p>
<p>考虑这样一种情况：当用户快速上滑列表时，当前帧可能需要立即展示多个新的 Item（例如 3 个）。然而默认的 Prefetch 机制仅会提前创建 1 个 Item，那么剩余的 Item 就只能在滑动过程中同步创建；一旦 Item 的 Compose 或布局开销较大，就很容易引发瞬时卡顿。</p>
<p>借助 <strong>LazyLayoutCacheWindow</strong>，我们可以显式扩大 Cache Window 的范围，确保在 Prefetch 阶段能够提前准备更多的 Item（例如 3 个）。这样即使遇到上述极端滑动场景，也能通过已完成 Prefetch 的内容直接完成展示，从而避免因同步创建 Item 带来的性能波动，显著提升滑动过程的稳定性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02637697049f41949e89490f9eb09c6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWERNcld1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218469&amp;x-signature=HC3zedLVViBOYWEgaLVdAFpgD9Y%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">PausableComposition 实现原理</h2>
<h3 data-id="heading-7">Composable 拆分</h3>
<p>PausableComposition 之所以能够实现 Compose 的增量执行，并不是在运行期简单地暂停 Composable 的执行流程，而是建立在编译期与运行期协同工作的基础之上。</p>
<p>回顾之前的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyCqkGNPfngHGUx9BlhGFdQ%3Fclick_id%3D5" target="_blank" title="https://mp.weixin.qq.com/s/yCqkGNPfngHGUx9BlhGFdQ?click_id=5" ref="nofollow noopener noreferrer">文章</a>，Compose 编译器会在每一个 <code>@Composable</code> 函数中插入一系列辅助代码，用于在运行期动态判断当前方法是否可以被跳过执行。PausableComposition 在这一机制上做了一些改动，下面我们结合高版本 Compose Compiler 的编译结果，来看这一变化具体是什么。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ComposeUI</span><span class="hljs-params">(param: <span class="hljs-type">Int</span>)</span></span> {
    println(param)
}

<span class="hljs-comment">// 编译后代码</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ComposeUI</span><span class="hljs-params">(param: <span class="hljs-type">Int</span>, $composer: <span class="hljs-type">Composer</span>?, $changed: <span class="hljs-type">Int</span>)</span></span> {
  $composer = $composer.startRestartGroup(-<span class="hljs-number">1995069302</span>)
  <span class="hljs-keyword">val</span> $dirty = $changed
  <span class="hljs-keyword">if</span> ($changed and <span class="hljs-number">0b0110</span> == <span class="hljs-number">0</span>) {
    $dirty = $dirty or <span class="hljs-keyword">if</span> ($composer.changed(param)) <span class="hljs-number">0b0100</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0b0010</span>
  }
  <span class="hljs-keyword">if</span> ($composer.shouldExecute($dirty and <span class="hljs-number">0b0011</span> != <span class="hljs-number">0b0010</span>, $dirty and <span class="hljs-number">0b0001</span>)) {
    println(param)
  } <span class="hljs-keyword">else</span> {
    $composer.skipToGroupEnd()
  }
  $composer.endRestartGroup()?.updateScope { $composer: Composer?, $force: <span class="hljs-built_in">Int</span> -&gt;
    ComposeUI(param, $composer, updateChangedFlags($changed or <span class="hljs-number">0b0001</span>))
  }
}
</code></pre>
<p>从编译后的代码可以看到，相比早期版本，是否执行 Composable 的判断逻辑不再直接写在生成代码中，而是被统一收敛到了 <code>Composer#shouldExecute</code> 方法内部，这一调整是 PausableComposition 能够实现的关键。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f29996b840df43248bdd33ab7879ef83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWERNcld1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218469&amp;x-signature=LK2ifvZoIpm2rttSJTAWkW5%2FU7g%3D" alt="" loading="lazy"/></p>
<p><code>shouldExecute</code> 核心逻辑为:</p>
<ul>
<li>
<p>如果当前不是插入新UI 或复用 UI，则正常走原有逻辑（判断参数是否变更）</p>
</li>
<li>
<p>通过 <code>shouldPause</code> 判断当前是否应该暂停</p>
<ul>
<li>如果是，则将当前 <strong>RecomposeScope</strong> 保存下来，同时返回 false 跳过本次执行</li>
<li>反之则返回 true 正常执行 Compose 逻辑</li>
</ul>
</li>
</ul>
<p>这样一来，Compose 的执行就可以在 Composable 之间暂停，并且能够在后续合适时机从保存的<code>RecomposeScope</code> 处继续恢复执行。</p>
<h3 data-id="heading-8">Apply Changes</h3>
<p>由于 PausableComposition 将 Compose 阶段拆开执行，使得一次 Composable 的执行过程不再具备“不可中断、立即生效”的语义。为了避免在中途暂停或取消时将 UI 置于不可靠的中间状态， Compose 执行阶段必须与 Apply Changes 解耦，也就是说要等 PausableComposition 完成执行后再一次性提交变更。</p>
<p>PausableComposition的解决方案是采用 <code>RecordingApplier</code>来记录执行过程中的所有变更，并在完成执行后统一更新到真正的 Applier 上</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecordingApplier</span>&lt;<span class="hljs-type">N</span>&gt;(root: N) : Applier&lt;N&gt; {
    <span class="hljs-comment">// 保存变更操作</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> operations = mutableIntListOf()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> instances = mutableObjectListOf&lt;Any?&gt;()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">down</span><span class="hljs-params">(node: <span class="hljs-type">N</span>)</span></span> {
        operations.add(DOWN)
        instances.add(node)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">up</span><span class="hljs-params">()</span></span> {
        operations.add(UP)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">remove</span><span class="hljs-params">(index: <span class="hljs-type">Int</span>, count: <span class="hljs-type">Int</span>)</span></span> {
        operations.add(REMOVE)
        operations.add(index)
        operations.add(count)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">move</span><span class="hljs-params">(from: <span class="hljs-type">Int</span>, to: <span class="hljs-type">Int</span>, count: <span class="hljs-type">Int</span>)</span></span> {
        operations.add(MOVE)
        operations.add(from)
        operations.add(to)
        operations.add(count)
    }
    
    <span class="hljs-comment">// 将变更同步至真正的 Applier</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">playTo</span><span class="hljs-params">(applier: <span class="hljs-type">Applier</span>&lt;<span class="hljs-type">N</span>&gt;, rememberManager: <span class="hljs-type">RememberEventDispatcher</span>)</span></span> {
            <span class="hljs-comment">// ...</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">while</span> (currentOperation &lt; size) {
                    <span class="hljs-keyword">val</span> operation = operations[currentOperation++]
                    <span class="hljs-keyword">when</span> (operation) {
                        UP -&gt; {
                            applier.up()
                        }
                        DOWN -&gt; {
                            applier.down(node)
                        }
                        REMOVE -&gt; {
                            applier.remove(index, count)
                        }
                        MOVE -&gt; {
                            applier.move(from, to, count)
                        }
                        CLEAR -&gt; {
                            applier.clear()
                        }
                        INSERT_TOP_DOWN -&gt; {
                            applier.insertTopDown(index, instance)
                        }
                        INSERT_BOTTOM_UP -&gt; {
                            applier.insertBottomUp(index, instance)
                        }
                        APPLY -&gt; {
                            applier.apply(block, value)
                        }
                        REUSE -&gt; {
                            applier.reuse()
                        }
                    }
                }
            }
            <span class="hljs-comment">// ...</span>
        }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NSProcessInfoThermalState 的作用]]></title>    <link>https://juejin.cn/post/7600293373475340288</link>    <guid>https://juejin.cn/post/7600293373475340288</guid>    <pubDate>2026-01-28T14:59:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600293373475340288" data-draft-id="7600314093293223974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NSProcessInfoThermalState 的作用"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-01-28T14:59:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS在入门"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426627758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NSProcessInfoThermalState 的作用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426627758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS在入门
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:59:20.000Z" title="Wed Jan 28 2026 14:59:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>借助AI辅助。</p>
</blockquote>
<h2 data-id="heading-0">NSProcessInfoThermalState 的作用</h2>
<p><code>NSProcessInfoThermalState</code> 是一个用于表示设备<strong>散热状态</strong>的枚举类型。它帮助应用程序了解设备当前的温度水平,从而采取适当的措施来防止设备过热。</p>
<h3 data-id="heading-1">枚举值及含义</h3>
<p>这个枚举包含四个级别:</p>
<ol>
<li>
<p><strong>Nominal</strong>(正常) - 设备温度处于可接受水平,对用户无负面影响</p>
</li>
<li>
<p><strong>Fair</strong>(一般) - 设备温度略有升高,风扇可能开始工作并发出声音</p>
</li>
<li>
<p><strong>Serious</strong>(严重) - 设备温度明显升高,风扇全速运转,系统性能可能受到影响</p>
</li>
<li>
<p><strong>Critical</strong>(临界) - 设备温度显著升高,设备需要冷却降温</p>
</li>
</ol>
<h3 data-id="heading-2">使用方式</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 获取当前散热状态</span>
<span class="hljs-keyword">let</span> thermalState <span class="hljs-operator">=</span> <span class="hljs-type">ProcessInfo</span>.processInfo.thermalState

<span class="hljs-comment">// 监听散热状态变化通知</span>
<span class="hljs-type">NotificationCenter</span>.default.addObserver(
    forName: <span class="hljs-type">ProcessInfo</span>.thermalStateDidChangeNotification,
    object: <span class="hljs-literal">nil</span>,
    queue: <span class="hljs-literal">nil</span>
) { notification <span class="hljs-keyword">in</span>
    <span class="hljs-comment">// 处理散热状态变化</span>
}
</code></pre>
<h3 data-id="heading-3">应用场景</h3>
<p>当散热状态升高时,应用程序应该采取措施降低系统负载:</p>
<ul>
<li>减少 CPU/GPU 使用率</li>
<li>降低帧率</li>
<li>减少 I/O 操作</li>
<li>使用低质量的视觉效果</li>
<li>暂停后台任务</li>
</ul>
<p>这对于保护设备硬件、提升用户体验(避免设备过热导致的性能下降或风扇噪音)非常重要,特别是在进行密集计算或图形渲染的应用中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[⏰前端周刊第 450 期（2026年1月18日-1月24日）]]></title>    <link>https://juejin.cn/post/7600284420634460201</link>    <guid>https://juejin.cn/post/7600284420634460201</guid>    <pubDate>2026-01-29T01:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600284420634460201" data-draft-id="7600326291552731142" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="⏰前端周刊第 450 期（2026年1月18日-1月24日）"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-29T01:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ⏰前端周刊第 450 期（2026年1月18日-1月24日）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T01:59:42.000Z" title="Thu Jan 29 2026 01:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>📢 <strong>宣言</strong>：<strong>每周更新国外论坛的前端热门文章，推荐大家阅读/翻译，紧跟时事，掌握前端技术动态，也为写作或突破新领域提供灵感~</strong></p>
<p>欢迎大家访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">github.com/TUARAN/fron…</a>
顺手点个 ⭐ star 支持，是我们持续输出的续航电池🔋✨！</p>
<p>在线网址：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendweekly.cn%2F" target="_blank" title="https://frontendweekly.cn/" ref="nofollow noopener noreferrer">frontendweekly.cn/</a></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44c2632a6a7a466ea57cf16f05d10434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770256785&amp;x-signature=CtKqyWUQW15PMea5uz5YvjE2RzM%3D" alt="前端周刊封面" loading="lazy"/></p>
<hr/>
<p>💬 <strong>推荐语</strong></p>
<p>本期主题偏向“细节工程化 + 新能力落地”。Web 开发部分从 2026 年 favicon 的最小配置、ARIA 经验教训与“像素级还原”的再思考出发，延伸到平台公司为何持续收购前端框架团队的产业视角；工具与动效则涵盖 Vercel 的 json-render（面向生成式 UI 的新尝试）、Turbopack 的增量计算思路，以及 GSAP Flip 的响应式网格过渡、View Transitions 播放视频的注意点与 ASCII 渲染的深入拆解。CSS 部分集中盘点 AIM（Anchor Interpolated Morph）、现代 CSS 新特性与布局基础，同时给到六边形网格、视觉错觉、SVG 动画、Tailwind 2026 指南与 fieldset/legend 替代方案等可直接落地的技巧。JavaScript 方面补充 TanStack Start 的 Single Flight Mutations 与 WebAssembly 对比测试；React 分栏则覆盖 Server Actions 数据获取、状态管理、动画库选型与 React Compiler 适配。</p>
<hr/>
<h2 data-id="heading-0">🗂 本期精选目录</h2>
<h3 data-id="heading-1">🧭 Web 开发</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fevilmartians.com%2Fchronicles%2Fhow-to-favicon-in-2021-six-files-that-fit-most-needs" target="_blank" title="https://evilmartians.com/chronicles/how-to-favicon-in-2021-six-files-that-fit-most-needs" ref="nofollow noopener noreferrer">How to Favicon in 2026: Three files that fit most needs</a>：2026 年 favicon 最小实践：用 3 个文件覆盖大多数站点需求，并解释为什么不再需要堆一堆尺寸与格式。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcss-tricks.com%2Fi-learned-the-first-rule-of-aria-the-hard-way%2F" target="_blank" title="https://css-tricks.com/i-learned-the-first-rule-of-aria-the-hard-way/" ref="nofollow noopener noreferrer">I Learned The First Rule of ARIA the Hard Way</a>：ARIA 的第一原则“不要用 ARIA”并非口号：作者用踩坑经历说明滥用 ARIA 反而会降低可访问性。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.smashingmagazine.com%2F2026%2F01%2Frethinking-pixel-perfect-web-design%2F" target="_blank" title="https://www.smashingmagazine.com/2026/01/rethinking-pixel-perfect-web-design/" ref="nofollow noopener noreferrer">Rethinking “Pixel Perfect” Web Design</a>：重新审视“像素级还原”：在响应式、动态内容与可访问性约束下，如何用更现实的标准评估设计一致性。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fwhy-platform-companies-keep-buying-frontend-framework-teams%2F" target="_blank" title="https://thenewstack.io/why-platform-companies-keep-buying-frontend-framework-teams/" ref="nofollow noopener noreferrer">Why platform companies keep buying frontend framework teams</a>：为什么平台型公司不断收购前端框架团队：从生态绑定、开发者入口、云产品协同等角度拆解背后的商业逻辑。</li>
</ul>
<h4 data-id="heading-2">🛠 工具</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fvercels-json-render-a-step-toward-generative-ui%2F" target="_blank" title="https://thenewstack.io/vercels-json-render-a-step-toward-generative-ui/" ref="nofollow noopener noreferrer">Vercel’s json-render: A step toward generative UI</a>：Vercel 的 json-render：以 JSON 描述 UI 的渲染层尝试，面向生成式界面的可组合/可验证输出。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fblog%2Fturbopack-incremental-computation" target="_blank" title="https://nextjs.org/blog/turbopack-incremental-computation" ref="nofollow noopener noreferrer">Inside Turbopack: Building Faster by Building Less</a>：深入 Turbopack 的增量计算：通过“少做事”来更快构建，理解其缓存、依赖图与失效策略。</li>
</ul>
<h4 data-id="heading-3">✨ 动效/特效</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftympanus.net%2Fcodrops%2F2026%2F01%2F20%2Fanimating-responsive-grid-layout-transitions-with-gsap-flip%2F" target="_blank" title="https://tympanus.net/codrops/2026/01/20/animating-responsive-grid-layout-transitions-with-gsap-flip/" ref="nofollow noopener noreferrer">Animating Responsive Grid Layout Transitions with GSAP Flip</a>：用 GSAP Flip 做响应式网格布局过渡：在布局变化时保持动画连贯，并兼顾性能。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fview-transitions-playing-video%2F" target="_blank" title="https://frontendmasters.com/blog/view-transitions-playing-video/" ref="nofollow noopener noreferrer">View Transitions &amp; Playing Video</a>：View Transitions 遇到视频播放的细节：如何避免切换时的闪烁、解码重置与交互中断。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Falexharri.com%2Fblog%2Fascii-rendering" target="_blank" title="https://alexharri.com/blog/ascii-rendering" ref="nofollow noopener noreferrer">ASCII characters are not pixels: a deep dive into ASCII rendering</a>：ASCII 渲染并不是“用字符当像素”：深入讲清字符比例、亮度映射、采样与渲染管线的关键误区。</li>
</ul>
<h3 data-id="heading-4">🎨 CSS</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnerdy.dev%2Fanchor-interpolated-morphing" target="_blank" title="https://nerdy.dev/anchor-interpolated-morphing" ref="nofollow noopener noreferrer">Anchor Interpolated Morph (AIM)</a>：AIM（Anchor Interpolated Morph）简介：用锚点驱动插值变形，让元素在形态变化时保持更自然的过渡。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fcss-in-2026%2F%23utm_source%253DCSS-Weekly%2526utm_campaign%253DIssue-%2526utm_medium%253Dweb" target="_blank" title="https://blog.logrocket.com/css-in-2026/#utm_source%3DCSS-Weekly%26utm_campaign%3DIssue-%26utm_medium%3Dweb" ref="nofollow noopener noreferrer">CSS in 2026: The new features reshaping frontend development</a>：2026 年 CSS 新能力盘点：从新选择器、布局能力到可维护性特性，梳理哪些值得优先在项目里试。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcss-tricks.com%2Fresponsive-hexagon-grid-using-modern-css%2F" target="_blank" title="https://css-tricks.com/responsive-hexagon-grid-using-modern-css/" ref="nofollow noopener noreferrer">Responsive Hexagon Grid Using Modern CSS</a>：用现代 CSS 实现响应式六边形网格：覆盖几何计算、布局策略与实用的实现细节。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Falvaromontoro.com%2Fblog%2F68091%2Fcss-optical-illusions" target="_blank" title="https://alvaromontoro.com/blog/68091/css-optical-illusions" ref="nofollow noopener noreferrer">CSS Optical Illusions</a>：用 CSS 制作视觉错觉：通过渐变、对比与形状组合，快速做出有趣的视觉效果。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwebkit.org%2Fblog%2F17758%2Fwhen-will-css-grid-lanes-arrive-how-long-until-we-can-use-it%2F" target="_blank" title="https://webkit.org/blog/17758/when-will-css-grid-lanes-arrive-how-long-until-we-can-use-it/" ref="nofollow noopener noreferrer">When will CSS Grid Lanes arrive? How long until we can use it?</a>：CSS Grid Lanes 何时可用：从标准进度与浏览器实现现状评估落地时间与渐进增强策略。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpolypane.app%2Fblog%2Funderstanding-the-fundamentals-of-css-layout%2F" target="_blank" title="https://polypane.app/blog/understanding-the-fundamentals-of-css-layout/" ref="nofollow noopener noreferrer">Understanding the fundamentals of CSS Layout</a>：CSS 布局基础回顾：把流式布局、定位、Flex、Grid 的核心心智模型串起来，适合查漏补缺。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fhow-to-animate-svg-css-tutorial-examples%2F" target="_blank" title="https://blog.logrocket.com/how-to-animate-svg-css-tutorial-examples/" ref="nofollow noopener noreferrer">How to animate SVG with CSS: Tutorial with examples</a>：用 CSS 动画化 SVG：从 stroke/填充、transform 到关键帧的实战示例与注意点。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Ftailwind-css-guide%2F" target="_blank" title="https://blog.logrocket.com/tailwind-css-guide/" ref="nofollow noopener noreferrer">A dev’s guide to Tailwind CSS in 2026</a>：2026 年 Tailwind 使用指南：配置、组件化组织、性能与团队协作的实践建议。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloudfour.com%2Fthinks%2Ffaking-a-fieldset-legend%2F" target="_blank" title="https://cloudfour.com/thinks/faking-a-fieldset-legend/" ref="nofollow noopener noreferrer">Faking a Fieldset-Legend</a>：当原生 <code>fieldset/legend</code> 难以控制样式时，如何“拟态”实现同等语义与视觉效果。</li>
</ul>
<h3 data-id="heading-5">💡 JavaScript</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fsingle-flight-mutations-in-tanstack-start-part-1%2F" target="_blank" title="https://frontendmasters.com/blog/single-flight-mutations-in-tanstack-start-part-1/" ref="nofollow noopener noreferrer">Single Flight Mutations in TanStack Start: Part 1</a>：TanStack Start 的 Single Flight Mutations：解决重复提交/并发更新的状态一致性问题，降低竞态与回滚成本。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fwebassembly-vs-javascript-testing-side-by-side-performance%2F" target="_blank" title="https://thenewstack.io/webassembly-vs-javascript-testing-side-by-side-performance/" ref="nofollow noopener noreferrer">WebAssembly vs. JavaScript: Testing Side-by-Side Performance</a>：WebAssembly vs JavaScript 性能对比测试：在不同工作负载下，Wasm 是否真能带来确定性的收益。</li>
</ul>
<h4 data-id="heading-6">⚛️ React</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.developerway.com%2Fposts%2Fserver-actions-for-data-fetching" target="_blank" title="https://www.developerway.com/posts/server-actions-for-data-fetching" ref="nofollow noopener noreferrer">Can You Fetch Data with React Server Actions?</a>：用 React Server Actions 做数据获取可行吗：边界、适用场景与容易踩坑的地方。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjsdev.space%2Freact-state-management%2F" target="_blank" title="https://jsdev.space/react-state-management/" ref="nofollow noopener noreferrer">How to Master State Management in Modern React</a>：现代 React 状态管理思路：从本地状态到全局与服务端状态，如何按复杂度选择工具。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fbest-react-animation-libraries%2F" target="_blank" title="https://blog.logrocket.com/best-react-animation-libraries/" ref="nofollow noopener noreferrer">Comparing the best React animation libraries for 2026</a>：2026 年 React 动画库对比：从能力覆盖、性能与 DX 角度帮助选型。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplayfulprogramming.com%2Fposts%2Freact-compiler-library-support%2F" target="_blank" title="https://playfulprogramming.com/posts/react-compiler-library-support/" ref="nofollow noopener noreferrer">Adapting Library Logic for React Compiler</a>：为 React Compiler 适配库逻辑：哪些写法会阻碍编译器优化，以及如何改造以获得更稳定的性能收益。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain V1.0 核心解析（三）：Tools组件——AI的"瑞士军刀"：如何让大模型拥有调用API、操作数据、执行任务的能力]]></title>    <link>https://juejin.cn/post/7600240045366460470</link>    <guid>https://juejin.cn/post/7600240045366460470</guid>    <pubDate>2026-01-28T11:53:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600240045366460470" data-draft-id="7599483794657607721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain V1.0 核心解析（三）：Tools组件——AI的&quot;瑞士军刀&quot;：如何让大模型拥有调用API、操作数据、执行任务的能力"/> <meta itemprop="keywords" content="人工智能,算法,后端"/> <meta itemprop="datePublished" content="2026-01-28T11:53:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="16_one"/> <meta itemprop="url" content="https://juejin.cn/user/2802034986197256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain V1.0 核心解析（三）：Tools组件——AI的"瑞士军刀"：如何让大模型拥有调用API、操作数据、执行任务的能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2802034986197256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    16_one
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:53:28.000Z" title="Wed Jan 28 2026 11:53:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">自定义tool工具使用</h2>
<h3 data-id="heading-1">@too装饰器</h3>
<blockquote>
<p>@tool装饰器最简单、最直观的工具创建方式。</p>
</blockquote>
<p><strong>概述</strong></p>
<ul>
<li><strong>自动参数推断</strong>：基于函数签名自动生成工具的参数schema</li>
<li><strong>简化配置</strong>：只需提供工具名称和描述即可快速创建</li>
<li><strong>同步执行</strong>：默认支持同步函数调用，异步需要单独定义</li>
<li><strong>快速验证</strong>：适合概念验证和快速迭代开发</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent

<span class="hljs-keyword">from</span> base <span class="hljs-keyword">import</span> load_chat_model


<span class="hljs-comment"># 1. 定义一个简单的 Tool (Runnable)</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""Multiplies a and b."""</span>
    <span class="hljs-keyword">return</span> a * b

<span class="hljs-comment"># 2.导入模型</span>
model = load_chat_model(
    model=<span class="hljs-string">"glm-4.7"</span>,    <span class="hljs-comment"># 指定OpenAI的gpt-4o-mini模型</span>
    provider=<span class="hljs-string">"openai"</span>,      <span class="hljs-comment"># 指定模型提供商为openai</span>
)

<span class="hljs-comment"># 3.创建Agent</span>
agent = create_agent(model=model,tools=[multiply])

<span class="hljs-comment"># 4. 调用Agent</span>
response = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: <span class="hljs-string">"帮我计算12乘以6等于多少？"</span>
    }]
})

result = response[<span class="hljs-string">"messages"</span>]

<span class="hljs-built_in">print</span>(response)
</code></pre>
<h3 data-id="heading-2">StructuredTool</h3>
<blockquote>
<p><code>StructuredTool.from_function()</code>方法提供了更强大的工具创建能力，支持完整的参数校验和异步执行，适合生产环境使用。</p>
</blockquote>
<p><strong>概述</strong></p>
<ul>
<li><strong>强类型校验</strong>：支持Pydantic模型进行参数验证</li>
<li><strong>异步支持</strong>：通过<code>coroutine</code>参数支持异步函数</li>
<li><strong>完整元数据</strong>：支持name、description、return_direct等完整配置</li>
<li><strong>生产就绪</strong>：内置错误处理和参数校验机制</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> StructuredTool

<span class="hljs-string">"""
1. 通过 Pydantic BaseModel 定义参数，提供：
- 参数描述（description）
- 必填/可选约束
- 更清晰的 Schema 文档
"""</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DivideInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""除法工具输入参数"""</span>
    dividend: <span class="hljs-built_in">float</span> = Field(description=<span class="hljs-string">"被除数"</span>)
    divisor: <span class="hljs-built_in">float</span> = Field(description=<span class="hljs-string">"除数，不能为零"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">dividend: <span class="hljs-built_in">float</span>, divisor: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""执行除法运算，支持浮点数"""</span>
    <span class="hljs-keyword">if</span> divisor == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"除数不能为零"</span>)
    <span class="hljs-keyword">return</span> dividend / divisor

<span class="hljs-comment"># 2. 创建带参数校验的工具</span>
division_tool = StructuredTool.from_function(
    func=divide,
    name=<span class="hljs-string">"DivisionTool"</span>,
    description=<span class="hljs-string">"安全执行除法运算，自动处理除零错误"</span>,
    args_schema=DivideInput,  <span class="hljs-comment"># 显式指定参数模式</span>
    return_direct=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 是否直接返回工具结果（不经过 LLM 再次处理）</span>
)

<span class="hljs-comment"># 3. 测试参数校验（触发 Pydantic 验证）</span>
<span class="hljs-keyword">try</span>:
    division_tool.invoke({<span class="hljs-string">"a"</span>: <span class="hljs-number">10</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">2</span>})  <span class="hljs-comment"># 错误：参数名不匹配</span>
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"参数校验失败：<span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 4. 正确调用</span>
result = division_tool.invoke({<span class="hljs-string">"dividend"</span>: <span class="hljs-number">10</span>, <span class="hljs-string">"divisor"</span>: <span class="hljs-number">2</span>})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"除法结果：<span class="hljs-subst">{result}</span>"</span>)
</code></pre>
<h3 data-id="heading-3">继承structuredTool</h3>
<blockquote>
<p>继承<code>StructuredTool</code>类创建工具提供了最大的灵活性和控制力，适合复杂业务逻辑和状态管理需求。</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> StructuredTool
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Type</span>

<span class="hljs-comment"># 1. 定义包含业务逻辑的工具</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderQueryInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):          <span class="hljs-comment"># 此处继承BaseModel</span>
    <span class="hljs-string">"""订单查询参数"""</span>
    order_id: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"订单编号，格式：ORD-2024-XXXX"</span>)
    include_details: <span class="hljs-built_in">bool</span> = Field(default=<span class="hljs-literal">False</span>, description=<span class="hljs-string">"是否包含商品明细"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderQueryTool</span>(<span class="hljs-title class_ inherited__">StructuredTool</span>):     <span class="hljs-comment"># 此处继承StructuredTool</span>
    <span class="hljs-string">"""订单查询工具"""</span>
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"query_order"</span>
    description: <span class="hljs-built_in">str</span> = <span class="hljs-string">"查询电商平台订单状态和物流信息"</span>
    args_schema: <span class="hljs-type">Type</span>[BaseModel] = OrderQueryInput
    return_direct: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>

    <span class="hljs-comment"># 实现父类方法_run()</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_run</span>(<span class="hljs-params">self, order_id: <span class="hljs-built_in">str</span>, include_details: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-comment"># 模拟数据库查询</span>
        order_db = {
            <span class="hljs-string">"ORD-2024-1234"</span>: {<span class="hljs-string">"status"</span>: <span class="hljs-string">"已发货"</span>, <span class="hljs-string">"express"</span>: <span class="hljs-string">"顺丰"</span>, <span class="hljs-string">"amount"</span>: <span class="hljs-number">299</span>},
            <span class="hljs-string">"ORD-2024-5678"</span>: {<span class="hljs-string">"status"</span>: <span class="hljs-string">"待付款"</span>, <span class="hljs-string">"express"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"amount"</span>: <span class="hljs-number">149</span>},
        }

        <span class="hljs-comment"># 处理查询逻辑</span>
        <span class="hljs-keyword">if</span> order_id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> order_db:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"error"</span>: <span class="hljs-string">f"订单 <span class="hljs-subst">{order_id}</span> 不存在"</span>}
        result = order_db[order_id]

        <span class="hljs-comment"># 处理包含明细的情况</span>
        <span class="hljs-keyword">if</span> include_details:
            result[<span class="hljs-string">"items"</span>] = [<span class="hljs-string">"商品A × 2"</span>, <span class="hljs-string">"商品B × 1"</span>]

        <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># 2. 初始化模型</span>
model = init_chat_model(
    model=<span class="hljs-string">"openai:gpt-4o-mini"</span>,
    temperature=<span class="hljs-number">0</span>,
    api_key=os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>)
)

<span class="hljs-comment"># 3. 创建 ReAct Agent（自动处理工具调用）</span>
agent = create_agent(
    model=model,
    tools=[OrderQueryTool()],  <span class="hljs-comment"># 直接传入 StructuredTool 实例</span>
    system_prompt=<span class="hljs-string">"你是一个电商客服助手，使用工具查询订单信息，回答要友好且准确"</span>,
    checkpointer=InMemorySaver()
)

<span class="hljs-comment"># 4. 执行并观察 ReAct 过程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_agent</span>():
    config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"customer_001"</span>},<span class="hljs-string">"recursion_limit"</span>: <span class="hljs-number">15</span>}<span class="hljs-comment"># 最大 15 次迭代</span>

    query = <span class="hljs-string">"请帮我查订单 ORD-2024-1234 的详细状态，包括商品明细"</span>

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> agent.astream(
        {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: query}]},
        config=config,
        stream_mode=<span class="hljs-string">"values"</span>  <span class="hljs-comment"># 流式输出模式，返回每一步的完整状态</span>
    ):
        message = step[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
        message.pretty_print()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)

<span class="hljs-comment"># 运行</span>
<span class="hljs-keyword">await</span> run_agent()
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7362242a82554a04b7ae2e34d639c42d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMTZfb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770206007&amp;x-signature=bOYPhHW9liP%2Fr5ii9X1YSugGTuk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">MCP</h2>
<h3 data-id="heading-5">远程连接MCP服务器</h3>
<blockquote>
<p>魔搭社区高德地图mcp服务器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.cn%2Fmcp%2Fservers%2F%40amap%2Famap-maps%2Ftools" target="_blank" title="https://www.modelscope.cn/mcp/servers/@amap/amap-maps/tools" ref="nofollow noopener noreferrer">www.modelscope.cn/mcp/servers…</a></p>
<p>申请高德地图的api地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.amap.com%2Fdev%2Fkey%2Fapp" target="_blank" title="https://console.amap.com/dev/key/app" ref="nofollow noopener noreferrer">console.amap.com/dev/key/app</a></p>
</blockquote>
<ul>
<li>Stdio</li>
</ul>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"mcpServers"</span>: {
    <span class="hljs-string">"amap-maps"</span>: {
      <span class="hljs-string">"args"</span>: [
        <span class="hljs-string">"-y"</span>,
        <span class="hljs-string">"@amap/amap-maps-mcp-server"</span>
      ],
      <span class="hljs-string">"command"</span>: <span class="hljs-string">"npx"</span>,
      <span class="hljs-string">"env"</span>: {
        <span class="hljs-string">"AMAP_MAPS_API_KEY"</span>: <span class="hljs-string">""</span>
      }
    }
  }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/774b70e089ad4f2fafaade23e4c4e8ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMTZfb25l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770206007&amp;x-signature=jGWc83Aw%2BodD%2FkCAXFZpG1Zv6%2BY%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_mcp_adapters.client <span class="hljs-keyword">import</span> MultiServerMCPClient
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent

<span class="hljs-comment"># 1. 正确的 MCP 配置格式（适用于 langchain_mcp_adapters）</span>
<span class="hljs-comment"># MultiServerMCPClient 需要的是扁平的字典结构，每个服务器是一个键值对</span>
mcp_config = {
    <span class="hljs-comment"># 本地 Python MCP 服务器</span>
    <span class="hljs-string">"math"</span>: {
        <span class="hljs-string">"transport"</span>: <span class="hljs-string">"stdio"</span>,
        <span class="hljs-string">"command"</span>: <span class="hljs-string">"python"</span>,
        <span class="hljs-string">"args"</span>: [<span class="hljs-string">"mcp_server.py"</span>]
    },
    <span class="hljs-comment"># 高德地图 MCP 服务器</span>
    <span class="hljs-string">"amap-maps"</span>: {
        <span class="hljs-string">"transport"</span>: <span class="hljs-string">"stdio"</span>,
        <span class="hljs-string">"command"</span>: <span class="hljs-string">"npx"</span>,
        <span class="hljs-string">"args"</span>: [<span class="hljs-string">"-y"</span>, <span class="hljs-string">"@amap/amap-maps-mcp-server"</span>],
        <span class="hljs-string">"env"</span>: {
            <span class="hljs-string">"AMAP_MAPS_API_KEY"</span>: os.getenv(<span class="hljs-string">"AMAP_MAPS_API_KEY"</span>),
        }
    }
}

<span class="hljs-comment"># 2. 创建 MCP 客户端</span>
client = MultiServerMCPClient(mcp_config)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"正在连接 MCP 服务器..."</span>)

<span class="hljs-comment"># 3. client.get_tools() 会自动：</span>
<span class="hljs-comment">#   1. 调用所有服务器的 list_tools 接口</span>
<span class="hljs-comment">#   2. 将 MCP Tool Schema 转换为 LangChain StructuredTool</span>
tools = <span class="hljs-keyword">await</span> client.get_tools()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功加载 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tools)}</span> 个工具: <span class="hljs-subst">{[t.name <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tools]}</span>"</span>)

<span class="hljs-comment"># 4. 创建 Agent</span>
llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>, temperature=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 直接将转换好的 tools 传给 create_agent</span>
agent = create_agent(llm, tools,system_prompt=<span class="hljs-string">"你是会调用工具进行天气查询、地图查询、网页部署的智能助手"</span>)

<span class="hljs-comment"># 5. 运行 Agent</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 开始测试 Agent ---"</span>)

<span class="hljs-comment"># 6. 这里我们模拟一个请求（具体 prompt 取决于你的工具功能）</span>
query = <span class="hljs-string">"请帮我搜索查询一下北京市今天的天气，并计算一下最大温差是多少度？"</span>

inputs = {<span class="hljs-string">"messages"</span>: [HumanMessage(content=query)]}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> agent.astream(inputs, stream_mode=<span class="hljs-string">"values"</span>):
    last_msg = chunk[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n[<span class="hljs-subst">{<span class="hljs-built_in">type</span>(last_msg).__name__}</span>]:"</span>)
    <span class="hljs-built_in">print</span>(last_msg.content)

    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(last_msg, <span class="hljs-string">"tool_calls"</span>) <span class="hljs-keyword">and</span> last_msg.tool_calls:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"&gt;&gt;&gt; 调用工具详情: <span class="hljs-subst">{last_msg.tool_calls}</span>"</span>)

</code></pre>
<h2 data-id="heading-6">工具调用错误或者乱调情况</h2>
<h3 data-id="heading-7">Tool Router (最有效)</h3>
<blockquote>
<p><code>Tool Router</code>是解决工具调用混乱的最有效方法，它通过专门的工具路由机制来精确匹配用户意图与可用工具。</p>
</blockquote>
<p><strong>实现</strong></p>
<ul>
<li><strong>意图识别</strong>：使用专门的分类器识别用户意图</li>
<li><strong>工具匹配</strong>：基于意图选择最合适的工具</li>
<li><strong>参数验证</strong>：在调用前验证参数有效性</li>
<li><strong>错误处理</strong>：提供优雅的降级策略</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义意图分类系统提示</span>
INTENT_SYSTEM_PROMPT = <span class="hljs-string">"""
你是一个专业的意图分类器，请只返回以下类别之一：
- search
- pdf
- database
- math
- none

并严格只返回类别名，不要输出其它内容。
"""</span>
</code></pre>
<h3 data-id="heading-8">引入“意图分类模型” (工程最佳方案)</h3>
<blockquote>
<p>意图分类模型通过机器学习方法识别用户请求的真实意图，从根本上解决工具误用问题。</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建一个意图识别模型</span>
intent_llm = load_chat_model(
    model=<span class="hljs-string">"gpt-4o-mini"</span>,    <span class="hljs-comment"># 指定OpenAI的gpt-4o-mini模型</span>
    provider=<span class="hljs-string">"openai"</span>,      <span class="hljs-comment"># 指定模型提供商为openai</span>
)
</code></pre>
<h3 data-id="heading-9">动态加载工具（避免上下过长）</h3>
<blockquote>
<p>动态工具加载机制根据当前对话上下文和用户意图，按需加载相关工具，避免一次性加载所有工具导致的上下文过长问题。</p>
<p>模型根据"意图"动态读取特定工具，不把所有工具一次性喂给模型。</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 通过Tool 工具分组</span>
TOOL_GROUPS = {
    <span class="hljs-string">"search"</span>: [search_web],
    <span class="hljs-string">"pdf"</span>: [extract_pdf_text],
    <span class="hljs-string">"database"</span>: [query_database],
    <span class="hljs-string">"math"</span>: [calculate],
}
</code></pre>
<h3 data-id="heading-10">统一工具规范（提高准确率）</h3>
<blockquote>
<p>通过强制化Schema和规范化提示词，建立统一的工具使用规范。</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_database</span>(<span class="hljs-params">sql: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
        执行 SQL 查询，仅限内部业务数据库。
        参数：sql Sql语句。
        示例：如 select * from users limit 5
    """</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"模拟 SQL 执行：<span class="hljs-subst">{sql}</span>"</span>
</code></pre>
<h3 data-id="heading-11">采用“工具过滤Prompt”修饰模型行为（成本最低）</h3>
<blockquote>
<p>通过系统Prompt显式指导模型行为，设置工具使用边界。</p>
</blockquote>
<p><strong>Prompt示例</strong></p>
<blockquote>
<p>你必须严格根据工具描述选择工具。
不能猜测工具功能。
如果没有合适的工具，请回答"无合适工具"。</p>
</blockquote>
<pre><code class="hljs language-python" lang="python">agent = create_agent(
        model=model,
        tools=tools,
        system_prompt=<span class="hljs-string">"你是一个 helpful assistant，可以使用工具回答问题。你必须严格根据工具描述选择工具！如果没有合适的工具，请回答“无合适工具”"</span>
    )
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战记录：用 LangChain + 智谱GLM-4 搭建 Agent]]></title>    <link>https://juejin.cn/post/7600234310965493798</link>    <guid>https://juejin.cn/post/7600234310965493798</guid>    <pubDate>2026-01-28T13:51:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310965493798" data-draft-id="7600238071038558217" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战记录：用 LangChain + 智谱GLM-4 搭建 Agent "/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2026-01-28T13:51:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户84610314727"/> <meta itemprop="url" content="https://juejin.cn/user/2527105568745866"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战记录：用 LangChain + 智谱GLM-4 搭建 Agent 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2527105568745866/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户84610314727
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T13:51:22.000Z" title="Wed Jan 28 2026 13:51:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近在跟着官方教程学习 LangChain ，原本使用的是 Claude（Anthropic），但考虑到国内访问稳定性和成本，想把模型替换成国产之光 <strong>智谱 AI (GLM-4)</strong> 。</p>
<p>本以为只是换个 API Key 和 Model Name 的事，结果硬是踩了 <strong>5 个坑</strong> 才把流程跑通。为了让大家少走弯路，特此记录这次从环境配置到 Prompt 调优的全过程。</p>
<hr/>
<h2 data-id="heading-1">坑一：PyCharm 读取不到环境变量</h2>
<p><strong>现象</strong>： 在终端里明明执行了 <code>set ANTHROPIC_API_KEY=xxx</code> 或者配置了系统环境变量，但运行后直接报错：</p>
<blockquote>
<p><code>TypeError: Could not resolve authentication method... Expected api_key...</code></p>
</blockquote>
<p><strong>解决方案</strong>： 在代码入口文件的最顶部（Import 之前）显式注入：</p>
<pre><code class="hljs language-lua" lang="lua">import <span class="hljs-built_in">os</span>
# 简单粗暴，但有效
<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"ZHIPUAI_API_KEY"</span>] = <span class="hljs-string">"你的Key_ID.Secret"</span> 
</code></pre>
<hr/>
<h2 data-id="heading-2">坑二：<code>init_chat_model</code> 不支持智谱</h2>
<p><strong>现象</strong>： LangChain 0.3 推出了一个很方便的工厂函数 <code>init_chat_model</code>，我尝试这样写：</p>
<pre><code class="hljs language-Python" lang="Python">model = init_chat_model(<span class="hljs-string">"glm-4"</span>, model_provider=<span class="hljs-string">"zhipuai"</span>, ...)
</code></pre>
<p>结果报错：</p>
<blockquote>
<p><code>ValueError: Unsupported provider='zhipuai'. Supported model providers are: anthropic, openai...</code></p>
</blockquote>
<p><strong>原因</strong>： 截止目前，LangChain 的通用工厂函数白名单里还没有集成智谱的适配器。</p>
<p><strong>解决方案</strong>： 放弃通用工厂函数，直接调用社区包的专用类：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 1. 安装社区包</span>
<span class="hljs-comment"># pip install -qU langchain-community zhipuai</span>

<span class="hljs-comment"># 2. 显式导入</span>
<span class="hljs-keyword">from</span> langchain_community.chat_models <span class="hljs-keyword">import</span> ChatZhipuAI

model = ChatZhipuAI(model=<span class="hljs-string">"glm-4"</span>, temperature=<span class="hljs-number">0.5</span>)
</code></pre>
<hr/>
<h2 data-id="heading-3">坑三：结构化输出 (<code>response_format</code>) 兼容性问题</h2>
<p><strong>现象</strong>： 我希望 Agent 返回格式化的 JSON 数据，于是使用了 <code>response_format</code> 参数：</p>
<pre><code class="hljs language-Python" lang="Python">agent = create_agent(
    ...,
    response_format=ToolStrategy(ResponseFormat), <span class="hljs-comment"># 强制结构化</span>
)
</code></pre>
<p>报错：</p>
<blockquote>
<p><code>ValueError: ChatZhipuAI currently only supports 'auto' tool choice</code></p>
</blockquote>
<p><strong>原因</strong>： LangChain 的 <code>ToolStrategy</code> 往往通过强制模型调用特定工具（<code>tool_choice="tool_name"</code>）来实现结构化输出。但智谱的 API 目前对 <code>tool_choice</code> 参数比较严格，只支持 <code>auto</code>，不支持强制指定。</p>
<p><strong>解决方案</strong>： 暂时放弃在 <code>create_agent</code> 层面强制结构化，改为<strong>自然语言交互</strong>，从 <code>messages</code> 中提取内容：</p>
<ol>
<li>
<p>删除 <code>response_format</code> 参数。</p>
</li>
<li>
<p>获取结果的方式改为：</p>
<pre><code class="hljs language-Python" lang="Python">response = agent.invoke(...)
<span class="hljs-comment"># 获取最后一条回复的内容</span>
<span class="hljs-built_in">print</span>(response[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].content)
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-4">坑四：429 Too Many Requests (API 限流)</h2>
<p><strong>现象</strong>： 代码逻辑没问题了，刚运行就报错：</p>
<blockquote>
<p><code>httpx.HTTPStatusError: Client error '429 Too Many Requests'</code></p>
</blockquote>
<p><strong>原因</strong>： 我使用的是 <code>glm-4</code> 模型。对于免费或普通开发者账号，主模型的 QPS（每秒请求数）限制非常严格，Agent 运行过程中可能会连续触发多次推理，瞬间超限。</p>
<p><strong>解决方案</strong>： 切换到 <strong>Flash</strong> 模型，速度快、耐造且便宜（甚至免费）：</p>
<pre><code class="hljs language-Python" lang="Python">model = ChatZhipuAI(
    model=<span class="hljs-string">"glm-4-flash"</span>, <span class="hljs-comment"># &lt;--- 神器</span>
    temperature=<span class="hljs-number">0.1</span>
)
</code></pre>
<hr/>
<h2 data-id="heading-5">坑五：模型“偷懒”与逻辑中断 (Prompt Engineering)</h2>
<p><strong>现象</strong>： 这是最头疼的。代码不报错了，但 Agent 智商掉线：</p>
<ol>
<li><strong>死循环追问</strong>：我让它查“我的位置”，工具定义里写了需要 <code>user_id</code>（其实代码里有上下文），但模型非要反问我：“请提供你的 User ID”。</li>
<li><strong>推理中断</strong>：模型查到了位置（如 "Florida"），然后直接停止工作，说：“我知道你在佛罗里达了，但我没法提供实时天气，再见。”</li>
</ol>
<p><strong>原因</strong>： 相比于 Claude 3.5 或 GPT-4，GLM-4-Flash 的指令遵循能力和多步推理（Chain of Thought）能力稍弱，需要更明确的引导。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li>
<p><strong>修改工具文档（Docstring）</strong> ：也就是“欺骗”模型。</p>
<ul>
<li><em>原文档</em>：<code>Retrieve user info based on user ID.</code></li>
<li><em>新文档</em>：<code>IMPORTANT: This tool requires NO arguments. The system handles ID automatically.</code></li>
</ul>
</li>
<li>
<p><strong>System Prompt 增加“工作流”指令</strong>： 在 System Prompt 中手把手教它做事：</p>
</li>
</ol>
<pre><code class="hljs language-python" lang="python">SYSTEM_PROMPT = <span class="hljs-string">"""You are a helpful assistant acting as a weather forecaster, who speaks in puns.

YOUR WORKFLOW (MUST FOLLOW STRICTLY):
1. User asks for weather -&gt; Call tool "get_user_location" (No arguments needed).
2. "get_user_location" returns a place (e.g., "Florida") -&gt; IMMEDIATELY call tool "get_weather_for_location" with that place.
3. "get_weather_for_location" returns the forecast -&gt; Output the final answer.

CRITICAL:
- Do NOT say "I cannot provide real-time weather". You HAVE a tool for that. USE IT.
- Do NOT stop after getting the location. Keep going until you get the weather.
"""</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">最终成果代码</h2>
<p>经过上述 5 步填坑，终于得到了一个稳定运行的 Agent：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> langchain_community.chat_models <span class="hljs-keyword">import</span> ChatZhipuAI
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool, ToolRuntime
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver

<span class="hljs-comment"># 在此处设置密钥</span>
os.environ[<span class="hljs-string">"ZHIPUAI_API_KEY"</span>] = <span class="hljs-string">""</span>

SYSTEM_PROMPT = <span class="hljs-string">"""You are a helpful assistant acting as a weather forecaster, who speaks in puns.

YOUR WORKFLOW (MUST FOLLOW STRICTLY):
1. User asks for weather -&gt; Call tool "get_user_location" (No arguments needed).
2. "get_user_location" returns a place (e.g., "Florida") -&gt; IMMEDIATELY call tool "get_weather_for_location" with that place.
3. "get_weather_for_location" returns the forecast -&gt; Output the final answer.

CRITICAL:
- Do NOT say "I cannot provide real-time weather". You HAVE a tool for that. USE IT.
- Do NOT stop after getting the location. Keep going until you get the weather.
"""</span>

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather_for_location</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    Get the weather for a specific location.
    Args:
        location: The city, state, or region name (e.g., "Florida", "New York").
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"DEBUG: 正在查询 <span class="hljs-subst">{location}</span> 的天气..."</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"It's always sunny in <span class="hljs-subst">{location}</span>!"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_location</span>(<span class="hljs-params">runtime: ToolRuntime[Context]</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    Get the current user's location.
    IMPORTANT: This tool requires NO arguments.
    """</span>
    user_id = runtime.context.user_id
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"DEBUG: 正在查找用户 <span class="hljs-subst">{user_id}</span> 的位置..."</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Florida"</span> <span class="hljs-keyword">if</span> user_id == <span class="hljs-string">"1"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"SF"</span>

model = ChatZhipuAI(
    model=<span class="hljs-string">"glm-4.7"</span>,
    temperature=<span class="hljs-number">0.01</span>,
)

checkpointer = InMemorySaver()

agent = create_agent(
    model=model,
    system_prompt=SYSTEM_PROMPT,
    tools=[get_user_location, get_weather_for_location],
    context_schema=Context,
    checkpointer=checkpointer,
)

config = {
    <span class="hljs-string">"configurable"</span>: {
        <span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"1"</span>
    }
}

<span class="hljs-built_in">print</span>(<span class="hljs-string">"正在调用 Agent..."</span>)

response = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Execute the workflow to find my location and then check the weather there."</span>}]},
    config=config,
    context=Context(user_id=<span class="hljs-string">"1"</span>),
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 运行结果 ==="</span>)
<span class="hljs-built_in">print</span>(response[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].content)
</code></pre>
<p>运行结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2e7c214746e4465a686abfb76c5856b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODQ2MTAzMTQ3Mjc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254936&amp;x-signature=snH6%2B42ayJGJ2hxPfNRSLrSVx00%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">总结</h2>
<p>从 Claude 迁移到国产模型时，<strong>代码层面的适配只是第一步</strong>。最大的挑战往往在于<strong>模型能力的差异</strong>，这需要我们通过更精细的 Prompt Engineering 和工具描述优化来弥补。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-70、把数字翻译成为字符串]]></title>    <link>https://juejin.cn/post/7600260767687196698</link>    <guid>https://juejin.cn/post/7600260767687196698</guid>    <pubDate>2026-01-29T00:14:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600260767687196698" data-draft-id="7598459769238552610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 剑指offer-70、把数字翻译成为字符串"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-29T00:14:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             剑指offer-70、把数字翻译成为字符串
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T00:14:03.000Z" title="Thu Jan 29 2026 00:14:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>有⼀种将字⺟编码成数字的⽅式：'a'-&gt;1, 'b-&gt;2', ... , 'z-&gt;26'。</p>
<p>现在给⼀串数字，返回有多少种可能的译码结果</p>
<p>示例1
输⼊："12"
返回值：2
说明：2种可能的译码结果（”ab” 或”l”）</p>
<p>示例2
输⼊："31717126241541717"
返回值：192
说明：192种可能的译码结果</p>
<p>仔细观察，就会发现上⾯的编码从 1 到 26，也就是可能⼀次译码使⽤是 1 位，也可能是⼀次译码⽤了 2位，⽐如 12 ，可以第⼀次⽤ 1，2 分开分别译码，也可以把 1，2 合并起来进⾏译码。</p>
<h2 data-id="heading-1">思路及解法</h2>
<h3 data-id="heading-2">暴力递归</h3>
<p>假设⼀个字符是S，第⼀次拆解就有两种情况，然后分别对后⾯的部分分别译码，使⽤递归即可：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/267dbb39aa15443fa280beb787c9e8ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250443&amp;x-signature=uldx8tdz1ZtqEHub%2FH69MdoQhsY%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution46</span> {
     <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">solve</span> <span class="hljs-params">(String nums)</span> {
     	<span class="hljs-keyword">return</span> recursion(nums.toCharArray(), <span class="hljs-number">0</span>);
     }
    
     <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">char</span>[] nums, <span class="hljs-type">int</span> start)</span>{
         <span class="hljs-keyword">if</span>(start == nums.length){
         	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
         }
         
         <span class="hljs-keyword">if</span>(nums[start] == <span class="hljs-string">'0'</span>)
         	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
         
         <span class="hljs-comment">// 使⽤⼀位字符译码</span>
         <span class="hljs-type">int</span> <span class="hljs-variable">count1</span> <span class="hljs-operator">=</span> recursion(nums,start+<span class="hljs-number">1</span>);
         <span class="hljs-type">int</span> <span class="hljs-variable">count2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
         <span class="hljs-comment">// 符合两位字符的译码</span>
         <span class="hljs-keyword">if</span>((start &lt; nums.length-<span class="hljs-number">1</span>) &amp;&amp; (nums[start] == <span class="hljs-string">'1'</span> || (nums[start] == <span class="hljs-string">'2'</span> &amp;&amp;nums[start+<span class="hljs-number">1</span>] &lt;= <span class="hljs-string">'6'</span>))){
         	count2 = recursion(nums,start+<span class="hljs-number">2</span>);
         }
         <span class="hljs-keyword">return</span> count1 + count2;
     }
}
</code></pre>
<p>但是上⾯的代码时间复杂度太⾼了，只要字符稍微⻓⼀点，运⾏时间就容易超过限制了：</p>
<h3 data-id="heading-3">记忆化递归</h3>
<p>为了避免重复计算子问题，我们使用一个备忘录（<code>memo</code>）来存储已经计算过的结果。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">numDecodings</span><span class="hljs-params">(String s)</span> {
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.length() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-comment">// 备忘录，初始化为-1表示未计算</span>
        Integer[] memo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>[s.length()];
        <span class="hljs-keyword">return</span> dfs(s, <span class="hljs-number">0</span>, memo);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">dfs</span><span class="hljs-params">(String s, <span class="hljs-type">int</span> index, Integer[] memo)</span> {
        <span class="hljs-comment">// 基准情况1：成功解码到末尾，算作一种有效方法</span>
        <span class="hljs-keyword">if</span> (index == s.length()) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
        <span class="hljs-comment">// 基准情况2：当前字符是'0'，无法解码，此路径无效</span>
        <span class="hljs-keyword">if</span> (s.charAt(index) == <span class="hljs-string">'0'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        <span class="hljs-comment">// 如果当前子问题已经计算过，直接返回结果</span>
        <span class="hljs-keyword">if</span> (memo[index] != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> memo[index];
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">ways</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-comment">// 选择1：解码当前1位数字</span>
        ways += dfs(s, index + <span class="hljs-number">1</span>, memo);
        
        <span class="hljs-comment">// 选择2：如果存在下一位，并且当前两位数字在10-26之间，则解码当前2位数字</span>
        <span class="hljs-keyword">if</span> (index + <span class="hljs-number">1</span> &lt; s.length()) {
            <span class="hljs-type">int</span> <span class="hljs-variable">twoDigits</span> <span class="hljs-operator">=</span> (s.charAt(index) - <span class="hljs-string">'0'</span>) * <span class="hljs-number">10</span> + (s.charAt(index + <span class="hljs-number">1</span>) - <span class="hljs-string">'0'</span>);
            <span class="hljs-keyword">if</span> (twoDigits &gt;= <span class="hljs-number">10</span> &amp;&amp; twoDigits &lt;= <span class="hljs-number">26</span>) {
                ways += dfs(s, index + <span class="hljs-number">2</span>, memo);
            }
        }
        
        <span class="hljs-comment">// 将结果存入备忘录</span>
        memo[index] = ways;
        <span class="hljs-keyword">return</span> ways;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，每个子问题最多被计算一次。</li>
<li><strong>空间复杂度</strong>：O(n)，递归栈的深度和备忘录的空间</li>
</ul>
<h3 data-id="heading-4">动态规划</h3>
<p>将过程逆推，要想求得当前的字符串的译码类型，其实有两种，最后⼀个单独翻译，另外⼀种是倒数最后两个字符合起来翻译，这两者之和就是我们所要求的结果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f516444015464593b28bf49ea453996c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250443&amp;x-signature=LBeqh8teE%2Fi6q3LehxeoM8FA%2Fi4%3D" alt="" loading="lazy"/></p>
<p>⽽要求前⾯的值，需要求更前⾯的值，最后⼀定会求得⼀个字符和两个字符的结果。其实这就是动态规划⾥⾯说的状态变化。递归其实就是逆推，这样会导致很多重复的计算。动态规划,则是从⼩数值计算到⼤数值。</p>
<p>既然我们知道是动态规划，定义 dp[i] 为数字串从左到右第i个数字结尾的当前数字串所拥有的翻译⽅法数，接着就需要找出状态转移⽅程：</p>
<ul>
<li>如果 i=0 , dp[i]=1</li>
<li>否则
<ul>
<li>如果nums[i]=0，说明需要和前⾯⼀个字符⼀起翻译
<ul>
<li>如果i == 1，以10或者20开头， dp[i] = 1</li>
<li>否则，数字串中存在10或者20的情况下，当前译码数等于后退两步的译码数， dp[i] =dp[i-2];</li>
</ul>
</li>
<li>否则，在符合字符范围内， dp[i]=dp[i-1]+dp[i-2]</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">numDecodings</span><span class="hljs-params">(String s)</span> {
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.length() == <span class="hljs-number">0</span> || s.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">'0'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 处理空串或以'0'开头的无效情况</span>
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> s.length();
        <span class="hljs-type">int</span>[] dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n + <span class="hljs-number">1</span>];
        <span class="hljs-comment">// 初始化</span>
        dp[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// 空字符串有一种解码方式（解码为空）</span>
        dp[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// 第一个字符只要不是'0'（前面已判断），就有1种解码方式</span>

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt;= n; i++) {
            <span class="hljs-type">int</span> <span class="hljs-variable">oneDigit</span> <span class="hljs-operator">=</span> s.charAt(i - <span class="hljs-number">1</span>) - <span class="hljs-string">'0'</span>;  <span class="hljs-comment">// 看最后一个字符（1位数字）</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">twoDigits</span> <span class="hljs-operator">=</span> (s.charAt(i - <span class="hljs-number">2</span>) - <span class="hljs-string">'0'</span>) * <span class="hljs-number">10</span> + oneDigit; <span class="hljs-comment">// 看最后两个字符（2位数字）</span>

            <span class="hljs-comment">// 情况1：最后一个字符可以单独解码（必须是1-9）</span>
            <span class="hljs-keyword">if</span> (oneDigit &gt;= <span class="hljs-number">1</span> &amp;&amp; oneDigit &lt;= <span class="hljs-number">9</span>) {
                dp[i] += dp[i - <span class="hljs-number">1</span>];
            }
            <span class="hljs-comment">// 情况2：最后两个字符可以组合解码（必须是10-26）</span>
            <span class="hljs-keyword">if</span> (twoDigits &gt;= <span class="hljs-number">10</span> &amp;&amp; twoDigits &lt;= <span class="hljs-number">26</span>) {
                dp[i] += dp[i - <span class="hljs-number">2</span>];
            }
        }
        <span class="hljs-keyword">return</span> dp[n];
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，需要遍历整个字符串一次。</li>
<li><strong>空间复杂度</strong>：O(n)，用于存储 <code>dp</code>数组。</li>
</ul>
<h3 data-id="heading-5">空间优化动态规划（推荐）</h3>
<p>观察上面的代码可以发现，计算 <code>dp[i]</code>时只依赖于 <code>dp[i-1]</code>和 <code>dp[i-2]</code>。因此，我们可以不用维护整个数组，只用两个变量来滚动记录之前的状态即可，从而将空间复杂度优化到常数级别。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">numDecodings</span><span class="hljs-params">(String s)</span> {
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.length() == <span class="hljs-number">0</span> || s.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">'0'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> s.length();
        <span class="hljs-comment">// 使用变量替代dp数组</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">prevPrev</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 对应于 dp[i-2]，初始化为dp[0]=1</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;     <span class="hljs-comment">// 对应于 dp[i-1]，初始化为dp[1]=1</span>

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt;= n; i++) {
            <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">oneDigit</span> <span class="hljs-operator">=</span> s.charAt(i - <span class="hljs-number">1</span>) - <span class="hljs-string">'0'</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">twoDigits</span> <span class="hljs-operator">=</span> (s.charAt(i - <span class="hljs-number">2</span>) - <span class="hljs-string">'0'</span>) * <span class="hljs-number">10</span> + oneDigit;

            <span class="hljs-comment">// 情况1：单独解码最后一个字符</span>
            <span class="hljs-keyword">if</span> (oneDigit &gt;= <span class="hljs-number">1</span> &amp;&amp; oneDigit &lt;= <span class="hljs-number">9</span>) {
                current += prev; <span class="hljs-comment">// 相当于 dp[i] += dp[i-1]</span>
            }
            <span class="hljs-comment">// 情况2：组合解码最后两个字符</span>
            <span class="hljs-keyword">if</span> (twoDigits &gt;= <span class="hljs-number">10</span> &amp;&amp; twoDigits &lt;= <span class="hljs-number">26</span>) {
                current += prevPrev; <span class="hljs-comment">// 相当于 dp[i] += dp[i-2]</span>
            }
            
            <span class="hljs-comment">// 滚动更新变量，为下一次迭代做准备</span>
            prevPrev = prev;
            prev = current;
        }
        <span class="hljs-keyword">return</span> prev;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)。</li>
<li><strong>空间复杂度</strong>：O(1)，只使用了固定数量的变量</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？]]></title>    <link>https://juejin.cn/post/7600265780349861928</link>    <guid>https://juejin.cn/post/7600265780349861928</guid>    <pubDate>2026-01-29T00:17:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600265780349861928" data-draft-id="7600296037542674432" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T00:17:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T00:17:20.000Z" title="Thu Jan 29 2026 00:17:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>SpringBoot 作为 Java 生态中最流行的微服务框架之一，以其“约定优于配置”的理念和丰富的 Starter 依赖极大地简化了开发流程。然而，很多开发者仅停留在基础用法上，忽略了 SpringBoot 提供的一些隐藏技巧。这些技巧不仅能减少样板代码，还能显著提升开发效率。本文将深入剖析 <strong>5 个鲜为人知但极其实用的 SpringBoot 技巧</strong>，帮助你从“会用”进阶到“精通”。</p>
<hr/>
<h3 data-id="heading-2">1. Lombok + @Builder.Default：优雅处理默认值</h3>
<h4 data-id="heading-3">问题场景</h4>
<p>在实体类或 DTO 中，我们经常需要为字段设置默认值。传统做法是在构造函数或 <code>@Data</code> 注解生成的 <code>setter</code> 方法中硬编码，但这会导致代码冗余且难以维护。</p>
<h4 data-id="heading-4">解决方案</h4>
<p>结合 Lombok 的 <code>@Builder</code> 和 <code>@Builder.Default</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Builder</span>.Default
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ACTIVE"</span>;
    
    <span class="hljs-meta">@Builder</span>.Default
    <span class="hljs-keyword">private</span> <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">createdAt</span> <span class="hljs-operator">=</span> LocalDateTime.now();
}
</code></pre>
<ul>
<li><strong>优势</strong>：
<ol>
<li><strong>清晰直观</strong>：通过注解显式声明默认值。</li>
<li><strong>线程安全</strong>：每次构建对象时会重新计算默认值（如 <code>LocalDateTime.now()</code>）。</li>
<li><strong>与 Jackson 无缝集成</strong>：反序列化时自动应用默认值。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">注意事项</h4>
<ul>
<li>Lombok v1.18.4+ 版本支持此特性。</li>
<li>避免在 <code>@Builder.Default</code> 中使用可变对象（如 <code>List</code>），建议用不可变集合（如 <code>Collections.unmodifiableList</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. @ConfigurationProperties + Validation：强类型的配置管理</h3>
<h4 data-id="heading-7">问题场景</h4>
<p>SpringBoot 的 <code>application.properties</code>/<code>.yml</code> 通常通过 <code>@Value</code>注入，但这种方式缺乏类型安全和结构化验证。</p>
<h4 data-id="heading-8">解决方案</h4>
<p>使用 <code>@ConfigurationProperties</code> + JSR-303 Validation：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">app:</span>
   <span class="hljs-attr">max-retry:</span> <span class="hljs-number">3</span>
   <span class="hljs-attr">endpoints:</span>
     <span class="hljs-bullet">-</span> <span class="hljs-string">"/api/v1/users"</span>
     <span class="hljs-bullet">-</span> <span class="hljs-string">"/api/v1/products"</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app")</span>
<span class="hljs-meta">@Validated</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> {
    <span class="hljs-meta">@Min(1)</span> <span class="hljs-meta">@Max(10)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxRetry;
    
    <span class="hljs-meta">@NotEmpty</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; endpoints;
    
    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<ul>
<li><strong>优势</strong>：
<ol>
<li><strong>类型安全</strong>：避免拼写错误和类型转换问题。</li>
<li><strong>自动补全支持</strong>：IDE（如 IntelliJ）能识别配置项。</li>
<li><strong>启动时验证</strong>：配置错误会直接抛出异常。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-9">进阶技巧</h4>
<p>通过 <code>spring-boot-configuration-processor</code>生成元数据文件，实现配置提示：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">3. Spring DevTools + LiveReload：极速热部署</h3>
<h4 data-id="heading-11">Why DevTools?</h4>
<p>传统的重启式热部署（如 JRebel）需要付费或复杂配置。Spring DevTools是官方提供的免费方案：</p>
<ol>
<li><strong>快速重启</strong>：仅重载变更的类（比冷启动快5-10倍）。</li>
<li><strong>LiveReload集成</strong>：自动刷新浏览器（需安装LiveReload插件）。</li>
</ol>
<h4 data-id="heading-12">Hidden Features:</h4>
<ul>
<li><strong>排除静态资源重启</strong>：</li>
</ul>
<pre><code class="hljs language-properties" lang="properties">spring.devtools.restart.exclude=static/**
</code></pre>
<ul>
<li><strong>远程调试支持</strong>：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run -Dspring.devtools.restart.enabled=<span class="hljs-literal">true</span> 
</code></pre>
<h4 data-id="heading-13">Profiling结果对比：</h4>

















<table><thead><tr><th>Method</th><th>Avg Restart Time</th></tr></thead><tbody><tr><td>Cold Start</td><td>~8s</td></tr><tr><td>With DevTools</td><td>~1s</td></tr></tbody></table>
<hr/>
<p>###4 .自定义FailureAnalyzer ：让启动错误一目了然</p>
<p>当SpringBoot应用启动失败时,默认的错误日志可能晦涩难懂 。通过实现FailureAnalyzer接口,可以将底层异常转换为友好的错误提示 :</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBeanFailureAnalyzer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FailureAnalyzer</span> {
<span class="hljs-meta">@Override</span> 
<span class="hljs-keyword">public</span> FailureAnalysis <span class="hljs-title function_">analyze</span><span class="hljs-params">(Throwable failure)</span> { 
<span class="hljs-keyword">if</span> (failure <span class="hljs-keyword">instanceof</span> UnsatisfiedDependencyException ex) { 
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FailureAnalysis</span>(
<span class="hljs-string">"Bean依赖注入失败: "</span>+ex.getInjectionPoint(),
<span class="hljs-string">"检查是否存在对应的Bean定义"</span>, 
failure); } <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; } }
</code></pre>
<p>注册到META-INF/spring.factories :</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">org.springframework.boot.diagnostics.FailureAnalyzer</span>=\ com.example.MyBeanFailureAnalyzer 
</code></pre>
<p>效果对比 :</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Before : NoSuchBeanDefinitionException ... 
After : [ACTION REQUIRED] Bean依赖注入失败: UserService.userDao → Check <span class="hljs-keyword">if</span> <span class="hljs-meta">@Repository</span> <span class="hljs-keyword">is</span> missing!
</code></pre>
<hr/>
<p>###5 .Smart Initialization ：优化启动性能</p>
<p>SpringBoot默认按顺序初始化所有Bean,导致启动慢 。通过以下方式优化 :</p>
<p>1 .懒加载特定Bean :</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Lazy</span> <span class="hljs-meta">@Service</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeavyService</span> { ... } 
</code></pre>
<p>2 .分批初始化 (Spring Boot2.4+) :</p>
<pre><code class="hljs language-properties" lang="properties">spring.main.lazy-initialization=true #全局懒加载 spring.main.eager-init-beans[0]=criticalService #强制提前加载关键Bean 
</code></pre>
<p>3 .使用ApplicationRunner控制顺序 :</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Order(1)</span> <span class="hljs-meta">@Bean</span> <span class="hljs-keyword">public</span> ApplicationRunner <span class="hljs-title function_">initDB</span><span class="hljs-params">()</span> { .. } 

实测效果 (基于<span class="hljs-number">100</span>个Bean的项目 ):
| Configuration       | Startup Time |
|----------------------|--------------|
| Default              | ~12s         |
| Smart Initialization | ~6s          |
</code></pre>
<hr/>
<p>###总结</p>
<p>本文揭示的五个技巧覆盖了从编码 、配置到调试 、优化的完整链路 :</p>
<p>• Lombok的 Builder.Default →减少样板代码 • ConfigurationProperties →强化配置管理 • DevTools深度使用 →加速开发循环 • Custom FailureAnalyzer →提升可维护性 • Smart Initialization →优化运行时性能</p>
<p>掌握这些鲜为人知却至关重要的技术 ,你的SpringBoot开发效率将产生质的飞跃 。建议收藏本文并实践每一个案例 ,它们都来自真实项目的最佳实践 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你知道 Android 有哪些 Drawable 吗？]]></title>    <link>https://juejin.cn/post/7600292312216600628</link>    <guid>https://juejin.cn/post/7600292312216600628</guid>    <pubDate>2026-01-29T00:14:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600292312216600628" data-draft-id="7598537377472200742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你知道 Android 有哪些 Drawable 吗？"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-01-29T00:14:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你知道 Android 有哪些 Drawable 吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T00:14:35.000Z" title="Thu Jan 29 2026 00:14:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为小说《逆袭西二旗》的技术讲解，用于详细说明<a href="https://juejin.cn/post/7599600549763629091" target="_blank" title="https://juejin.cn/post/7599600549763629091">剧情</a>里涉及的开发细节。</em></p>
<h2 data-id="heading-0">如何使用 Drawable</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eebcd1bc50d476b989dc0b70fb8f785~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250474&amp;x-signature=Y%2FhSaTw%2BJh4nB6S6wnz%2FfR8J0%2FM%3D" alt="00.png" loading="lazy"/></p>
<p><code>Drawable</code> 是一个通用抽象概念，代表任何可以绘制在屏幕上的内容。它是各种图形内容（如图像、矢量图形和基于形状的元素）的基类。</p>
<p><code>Drawable</code> 广泛用于 UI 组件中，包括背景、按钮、图标和自定义视图。</p>
<p>Android 提供了不同类型的 <code>Drawable</code> 对象，每种都针对特定的使用场景设计。</p>
<h3 data-id="heading-1">面试问题</h3>
<p>如何仅使用 <code>Drawable</code> 创建一个动态背景，使其能根据用户交互改变形状和颜色？</p>
<h3 data-id="heading-2">BitmapDrawable</h3>
<p><code>BitmapDrawable</code> 用于显示 <strong>PNG</strong>、<strong>JPG</strong> 或 <strong>GIF</strong> 等光栅图像。它支持对 Bitmap 图像进行缩放、平铺和过滤。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">bitmap</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/sample_image"</span>
    <span class="hljs-attr">android:tileMode</span>=<span class="hljs-string">"repeat"</span> /&gt;</span>
</code></pre>
<p>这通常用于在 <code>ImageView</code> 组件中显示图像或作为背景（对于列表的分割线，极为有用）。</p>
<h3 data-id="heading-3">VectorDrawable</h3>
<p><code>VectorDrawable</code> 使用 XML 路径表示可缩放矢量图形（类 SVG）。与位图不同，矢量图形在任何分辨率下都能保持质量。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">vector</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:width</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:height</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:viewportWidth</span>=<span class="hljs-string">"24"</span>
    <span class="hljs-attr">android:viewportHeight</span>=<span class="hljs-string">"24"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">path</span>
        <span class="hljs-attr">android:fillColor</span>=<span class="hljs-string">"#FF0000"</span>
        <span class="hljs-attr">android:pathData</span>=<span class="hljs-string">"M12,2L15,8H9L12,2Z"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">vector</span>&gt;</span>
</code></pre>
<p><code>VectorDrawable</code> 非常适合图标、Logo 和可缩放 UI 元素，以避免在不同屏幕密度下出现像素化问题。</p>
<h3 data-id="heading-4">NinePatchDrawable</h3>
<p><code>NinePatchDrawable</code> 是一种特殊的 <code>bitmap</code>，允许在调整大小时保留特定区域（如四周的角）。它非常适合创建可拉伸的 UI 组件，如聊天气泡和按钮。</p>
<p><em>你的 <code>.9</code> 在运行的时会自动转换成 <code>NinePatchDrawable</code>，开发者自己一般不手动创建 <code>NinePatchDrawable</code>。</em></p>
<p>一个 <code>.9</code> 图片包含额外的 1 像素边框，用于定义可拉伸区域和固定区域。</p>
<p>要创建 <code>.9.png</code> 文件，请使用 Android Studio 的工具定义可拉伸区域。</p>
<p><em>我工作中发现很多开发不知道 Android Studio 有 <code>.9</code> 制作工具，很多时候都是让 UI 去做的。这样做合理，但是沟通成本太高了，很多 UI 不明白 <code>.9</code> 的工作原理，导致做出来的 <code>.9</code> 反而不满足 UI 的设计。</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82f3304df99f42a9a5b335bac16b934d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250474&amp;x-signature=y7vcLJu8OHYnOrp6TUu3G6wisws%3D" alt="33.png" loading="lazy"/></p>
<p><em>如图所示，在图片上右键，会出现 <strong>Create 9-Patch file</strong> 选项。</em></p>
<h3 data-id="heading-5">ShapeDrawable</h3>
<p><code>ShapeDrawable</code> 在 XML 中定义，可用于创建圆角矩形、椭圆或其他简单形状，而无需使用图像。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">shape</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:shape</span>=<span class="hljs-string">"rectangle"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">solid</span> <span class="hljs-attr">android:color</span>=<span class="hljs-string">"#FF5733"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">corners</span> <span class="hljs-attr">android:radius</span>=<span class="hljs-string">"8dp"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">shape</span>&gt;</span>
</code></pre>
<p><code>ShapeDrawable</code> 可用于按钮、背景和自定义 UI 组件。</p>
<p>因为 <code>ShapeDrawable</code> 不需要 UI 参与制作，所以它对研发来讲，能迅速的完成 UI 实现，同时还能显著的缩小 APK 大小。</p>
<h3 data-id="heading-6">LayerDrawable</h3>
<p><code>LayerDrawable</code> 用于将多个 <code>Drawable</code> 组合成一个单层结构，适用于复杂的 UI 背景。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">layer-list</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">shape</span> <span class="hljs-attr">android:shape</span>=<span class="hljs-string">"rectangle"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">solid</span> <span class="hljs-attr">android:color</span>=<span class="hljs-string">"#000000"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">shape</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">"@drawable/icon"</span> <span class="hljs-attr">android:top</span>=<span class="hljs-string">"10dp"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">layer-list</span>&gt;</span>
</code></pre>
<p>这可用于创建叠加效果和堆叠视觉元素。</p>
<h3 data-id="heading-7">总结</h3>
<p><code>Drawable</code> 类提供了一种灵活的方式来处理 Android 中的不同类型图形。</p>
<p>选择合适的 <code>Drawable</code> 取决于使用场景，例如设计需求、可扩展性和 UI 复杂度。通过利用这些不同的 <code>Drawable</code> 类型，开发者可以在 <code>Android</code> 应用中创建经过优化且视觉吸引人的 UI 组件。</p>
<h2 data-id="heading-8">如何高效处理大型 Bitmap？</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b9f656af6dc4159a6424e6c45adee50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250474&amp;x-signature=G3EGaGib5wvNwaASrW4eA%2F7Mk3Q%3D" alt="11.png" loading="lazy"/></p>
<p>Bitmap 是内存中图像的表示形式。它存储像素数据，通常用于在屏幕上渲染图像，无论这些图像来自资源、文件还是远程源。</p>
<p>由于 Bitmap 对象会保存大量像素数据，尤其是高分辨率图像，处理不当很容易导致内存耗尽和 <code>OutOfMemoryError</code>。</p>
<h3 data-id="heading-9">面试问题</h3>
<p>将大型 Bitmap 加载到内存中有哪些风险？</p>
<p>如何避免这些风险？</p>
<h3 data-id="heading-10">大型 Bitmap 的问题</h3>
<p>许多图像（例如来自相机或从互联网下载的图像）比显示它们的 UI 组件所需的尺寸大得多。不必要地加载这些全分辨率图像会：</p>
<ul>
<li>消耗过多内存</li>
<li>带来性能开销</li>
<li>导致应用因内存压力而崩溃</li>
</ul>
<h3 data-id="heading-11">不分配内存读取 Bitmap 尺寸</h3>
<p>在加载 Bitmap 之前，检查其尺寸以决定是否需要完整加载非常重要。<code>BitmapFactory.Options</code> 类允许你设置 <code>inJustDecodeBounds = true</code>，这样可以在不分配内存存储像素数据的情况下解码图像元数据：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> options = BitmapFactory.Options().apply {
    inJustDecodeBounds = <span class="hljs-literal">true</span>
}
BitmapFactory.decodeResource(resources, R.id.myimage, options)

<span class="hljs-keyword">val</span> imageWidth = options.outWidth
<span class="hljs-keyword">val</span> imageHeight = options.outHeight
<span class="hljs-keyword">val</span> imageType = options.outMimeType
</code></pre>
<p><em><code>inJustDecodeBounds</code> 这个参数的意思就是仅解析图片的元数据（如宽高、MIME 类型等），而不实际加载像素数据到内存中。</em></p>
<p>这一步有助于评估图像尺寸是否符合你的显示需求，从而避免不必要的内存分配。</p>
<h3 data-id="heading-12">使用采样加载缩小的 Bitmap</h3>
<p>一旦知道了尺寸，你可以使用 <code>inSampleSize</code> 选项将 Bitmap 缩小到适合目标尺寸。这会通过以 2、4 等因子（一般给 2 的 N 次方）对图像进行下采样来减少内存使用。例如，一个 2048×1536 的图像在 <code>inSampleSize = 4</code> 时会被加载为 512×384 的 Bitmap：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateInSampleSize</span><span class="hljs-params">(options: <span class="hljs-type">BitmapFactory</span>.<span class="hljs-type">Options</span>, reqWidth: <span class="hljs-type">Int</span>, reqHeight: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">var</span> inSampleSize = <span class="hljs-number">1</span>
    <span class="hljs-keyword">val</span> (height, width) = options.run { outHeight to outWidth }

    <span class="hljs-keyword">if</span> (height &gt; reqHeight || width &gt; reqWidth) {
        <span class="hljs-keyword">val</span> halfHeight = height / <span class="hljs-number">2</span>
        <span class="hljs-keyword">val</span> halfWidth = width / <span class="hljs-number">2</span>
        <span class="hljs-keyword">while</span> (halfHeight / inSampleSize &gt;= reqHeight &amp;&amp; halfWidth / inSampleSize &gt;= reqWidth) {
            inSampleSize *= <span class="hljs-number">2</span>
        }
    }
    <span class="hljs-keyword">return</span> inSampleSize
}
</code></pre>
<p>这有助于在图像质量和内存效率之间取得平衡。</p>
<h3 data-id="heading-13">完整解码流程</h3>
<p>使用 <code>calculateInSampleSize</code>，你可以分两步解码 Bitmap：</p>
<ol>
<li>仅解码边界。</li>
<li>设置计算出的 <code>inSampleSize</code> 并解码缩放后的 Bitmap。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">decodeSampledBitmapFromResource</span><span class="hljs-params">(
    res: <span class="hljs-type">Resources</span>,
    resId: <span class="hljs-type">Int</span>,
    reqWidth: <span class="hljs-type">Int</span>,
    reqHeight: <span class="hljs-type">Int</span>
)</span></span>: Bitmap {
    <span class="hljs-keyword">return</span> BitmapFactory.Options().run {
        inJustDecodeBounds = <span class="hljs-literal">true</span>
        BitmapFactory.decodeResource(res, resId, <span class="hljs-keyword">this</span>)

        inSampleSize = calculateInSampleSize(<span class="hljs-keyword">this</span>, reqWidth, reqHeight)
        inJustDecodeBounds = <span class="hljs-literal">false</span>

        BitmapFactory.decodeResource(res, resId, <span class="hljs-keyword">this</span>)
    }
}
</code></pre>
<p>要在 <code>ImageView</code> 中使用它，只需调用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">imageview.setImageBitmap(
    decodeSampledBitmapFromResource(resources, R.id.myimage, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>)
)
</code></pre>
<p>这种方法确保你的 UI 获得尺寸合适的图像，同时优化了内存使用。</p>
<h3 data-id="heading-14">总结</h3>
<p>Bitmap 是 Android 中内存密集型的图像表示形式。为避免性能问题和崩溃，首先使用 <code>inJustDecodeBounds</code> 检查图像尺寸，然后使用 <code>inSampleSize</code> 对大型 Bitmap 进行下采样，只加载需要的部分，最后使用两步策略进行高效解码和缩放。</p>
<p>这个过程对于在内存受限的设备上构建处理大量图像的稳健应用至关重要。</p>
<h3 data-id="heading-15">进阶：为大型 Bitmap 实现缓存</h3>
<p>高效管理大型 Bitmap 对于构建流畅、内存安全的 Android 应用至关重要——尤其是在处理图像列表、网格或轮播时。
Android 提供了两种有效的策略：使用 <code>LruCache</code> 进行内存缓存，以及使用 <code>DiskLruCache</code> 进行基于磁盘的缓存。</p>
<p>大名鼎鼎的 <code>Glide</code> 广泛使用了 <code>LruCache</code> 和 <code>DiskLruCache</code> 相关技术，不过其实现比直接使用这两个类更复杂、更模块化，并且做了大量优化。</p>
<p>先来看看如何使用 <code>LruCache</code> 进行内存缓存。</p>
<p><code>LruCache</code> 是 Bitmap 的首选内存缓存解决方案。它会保留对最近使用项的强引用，并在内存紧张时自动回收最少使用的项。工作原理如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> LruCacheManager {
    <span class="hljs-keyword">val</span> maxMemory = (Runtime.getRuntime().maxMemory() / <span class="hljs-number">1024</span>).toInt()
    <span class="hljs-keyword">val</span> cacheSize = maxMemory / <span class="hljs-number">8</span>

    <span class="hljs-keyword">val</span> memoryCache = <span class="hljs-keyword">object</span> : LruCache&lt;String, Bitmap&gt;(cacheSize) {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sizeOf</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, bitmap: <span class="hljs-type">Bitmap</span>)</span></span>: <span class="hljs-built_in">Int</span> {
            <span class="hljs-keyword">return</span> bitmap.byteCount / <span class="hljs-number">1024</span>
        }
    }
}
</code></pre>
<p>分配约 1/8 的可用内存以确保安全。此设置可快速访问图像并避免重复解码。使用方式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadBitmap</span><span class="hljs-params">(imageId: <span class="hljs-type">Int</span>, imageView: <span class="hljs-type">ImageView</span>)</span></span> {
    <span class="hljs-keyword">val</span> key = imageId.toString()
    LruCacheManager.memoryCache.<span class="hljs-keyword">get</span>(key)?.let {
        imageView.setImageBitmap(it)
    } ?: run {
        imageView.setImageResource(R.drawable.image_placeholder)

        <span class="hljs-keyword">val</span> workRequest = OneTimeWorkRequestBuilder&lt;BitmapDecodeWorker&gt;()
            .setInputData(workDataOf(<span class="hljs-string">"imageId"</span> to imageId))
            .build()
        WorkManager.getInstance(context).enqueue(workRequest)
    }
}
</code></pre>
<p>在 <code>Worker</code> 中实现如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BitmapDecodeWorker</span>(
    context: Context,
    workerParams: WorkerParameters
) : CoroutineWorker(context, workerParams) {

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doWork</span><span class="hljs-params">()</span></span>: Result {
        <span class="hljs-keyword">val</span> imageId = inputData.getInt(<span class="hljs-string">"imageId"</span>, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">if</span> (imageId == -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> Result.failure()

        <span class="hljs-keyword">val</span> bitmap = decodeSampledBitmapFromResource(
            applicationContext.resources,
            imageId,
            reqWidth = <span class="hljs-number">100</span>,
            reqHeight = <span class="hljs-number">100</span>
        )

        bitmap?.let {
            LruCacheManager.memoryCache.put(imageId.toString(), it)
            <span class="hljs-keyword">return</span> Result.success()
        }
        <span class="hljs-keyword">return</span> Result.failure()
    }
}
</code></pre>
<p>接下来，使用 DiskLruCache 进行磁盘缓存。</p>
<p>在 Android 中，内存是有限且易失的。为确保 Bitmap 在应用会话之间持久化并避免重新计算，你可以使用 <code>DiskLruCache</code> 库将 Bitmap 存储在磁盘上。</p>
<p>这对于资源密集型图像或处理可滚动图像列表特别有用。</p>
<p>首先，编写 <code>DiskCacheManager</code>，它包装 <code>DiskLruCache</code>，提供安全的哈希和 I/O 逻辑来持久化解码后的 Bitmap：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DiskCacheManager</span>(<span class="hljs-keyword">val</span> context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cachePath = context.cacheDir.path + File.separator + <span class="hljs-string">"images"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cacheFile = File(cachePath)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> diskLruCache = DiskLruCache.<span class="hljs-keyword">open</span>(cacheFile, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span> <span class="hljs-comment">/* 10 megabytes */</span>)

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">filenameForKey</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> MessageDigest
            .getInstance(<span class="hljs-string">"SHA-1"</span>)
            .digest(key.toByteArray())
            .joinToString(separator = <span class="hljs-string">""</span>, transform = { Integer.toHexString(<span class="hljs-number">0xFF</span> and it.toInt()) })
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">get</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span>: Bitmap? {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> filename = filenameForKey(key)
            <span class="hljs-keyword">val</span> inputStream = diskLruCache.<span class="hljs-keyword">get</span>(filename).getInputStream(<span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> BitmapFactory.decodeStream(inputStream)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">set</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, bitmap: <span class="hljs-type">Bitmap</span>)</span></span> {
        <span class="hljs-keyword">val</span> filename = filenameForKey(key)
        <span class="hljs-keyword">val</span> snapshot = diskLruCache.<span class="hljs-keyword">get</span>(filename)
        <span class="hljs-keyword">if</span> (snapshot == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">val</span> editor = diskLruCache.edit(filename)
            <span class="hljs-keyword">val</span> outputStream = editor.newOutputStream(<span class="hljs-number">0</span>)
            bitmap.compress(Bitmap.CompressFormat.JPEG, <span class="hljs-number">100</span>, outputStream)
            editor.commit()
            outputStream.close()
        }
        snapshot?.getInputStream(<span class="hljs-number">0</span>)?.close()
    }
}
</code></pre>
<p>这个类确保：</p>
<ul>
<li>基于 SHA-1 的安全文件名生成</li>
<li>安全的 I/O 操作</li>
<li>避免重复写入</li>
</ul>
<p>接下来，使用 <strong>WorkManager</strong> 的 <code>CoroutineWorker</code> 在主线程之外执行磁盘缓存，安全地结合内存和磁盘策略：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BitmapWorker</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context,
    workerParams: WorkerParameters
) : CoroutineWorker(context, workerParams) {

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doWork</span><span class="hljs-params">()</span></span>: Result {
        <span class="hljs-keyword">val</span> key = inputData.getString(<span class="hljs-string">"imageKey"</span>) ?: <span class="hljs-keyword">return</span> Result.failure()
        <span class="hljs-keyword">val</span> resId = inputData.getInt(<span class="hljs-string">"resId"</span>, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">if</span> (resId == -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> Result.failure()

        <span class="hljs-comment">// 先尝试磁盘缓存</span>
        <span class="hljs-keyword">val</span> bitmapFromDisk = getBitmapFromDiskCache(key)
        <span class="hljs-keyword">if</span> (bitmapFromDisk != <span class="hljs-literal">null</span>) {
            LruCacheManager.memoryCache.put(key, bitmapFromDisk)
            <span class="hljs-keyword">return</span> Result.success()
        }

        <span class="hljs-comment">// 如果未找到则解码并缓存</span>
        <span class="hljs-keyword">val</span> bitmap = decodeSampledBitmapFromResource(
            applicationContext.resources,
            resId,
            reqWidth = <span class="hljs-number">100</span>,
            reqHeight = <span class="hljs-number">100</span>
        )

        <span class="hljs-comment">// 你必须将此移到 Application 类中，或者从依赖注入获取实例。</span>
        <span class="hljs-comment">// 如果每次 Worker 执行时都创建实例，磁盘缓存就失去了意义。</span>
        <span class="hljs-keyword">val</span> diskCacheManager = DiskCacheManager(context)
        <span class="hljs-keyword">try</span> {
            addBitmapToCache(diskCacheManager, key, bitmap)
            <span class="hljs-keyword">return</span> Result.success()
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-keyword">return</span> Result.failure()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addBitmapToCache</span><span class="hljs-params">(diskCacheManager: <span class="hljs-type">DiskCacheManager</span>, key: <span class="hljs-type">String</span>, bitmap: <span class="hljs-type">Bitmap</span>)</span></span> {
        <span class="hljs-keyword">if</span> (LruCacheManager.memoryCache.<span class="hljs-keyword">get</span>(key) == <span class="hljs-literal">null</span>) {
            LruCacheManager.memoryCache.put(key, bitmap)
        }

        <span class="hljs-keyword">if</span> (diskCacheManager.<span class="hljs-keyword">get</span>(key) != <span class="hljs-literal">null</span>) {
            diskCacheManager.<span class="hljs-keyword">set</span>(key, bitmap)
        }
    }
}
</code></pre>
<p>这个 <code>Worker</code>：</p>
<ul>
<li>尽可能从磁盘读取</li>
<li>如果未找到则回退到解码</li>
<li>将结果存储到内存和磁盘缓存中</li>
<li>在主线程之外安全运行</li>
</ul>
<p>总之。</p>
<p>要在 Android 中高效缓存大型 Bitmap，请使用 <code>LruCache</code> 进行快速的最近访问内存缓存，并使用 <code>DiskLruCache</code> 在应用会话之外持久化 Bitmap。</p>
<p>结合这两种策略，并在配置更改时保留内存缓存，以获得无缝体验。</p>
<p>通过使用 <strong>WorkManager</strong> 进行适当的初始化和后台工作，这种混合功能可以提高处理大型 Bitmap 时的应用性能和用户体验。</p>
<p><em>使用 <strong>WorkManager</strong> 是可选项，你可以使用协程，后台现成来完成这工作。不过各位有兴趣可以看看 <strong>WorkManager</strong>，在运行长时间的，不确定的后台任务时，<strong>WorkManager</strong> 是非常棒的选择。</em></p>
<h2 data-id="heading-16">如何实现动画</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ebfc21301be4334b2d43cb7874ce147~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250474&amp;x-signature=M3bwKODSl8RCBG0hYH89ej0sSlY%3D" alt="22.png" loading="lazy"/></p>
<p>动画通过创建平滑过渡、吸引对变化的注意力并提供视觉反馈来增强用户体验。Android 提供了多种实现动画的机制，从基本的属性变化到复杂的布局动画。</p>
<h3 data-id="heading-17">面试问题</h3>
<p>如何实现按钮在点击时平滑地展开和收缩，并确保其高效运行？</p>
<p>何时使用 <code>MotionLayout</code> 而不是传统的 <code>View</code> 动画？它有哪些优势？</p>
<h3 data-id="heading-18">View 属性动画</h3>
<p>在 API 级别 11 中引入，<code>View</code> 属性动画允许你为 <code>View</code> 对象的属性（如 <code>alpha</code>、<code>translationX</code>、<code>translationY</code>、<code>rotation</code> 和 <code>scaleX</code>）设置动画。</p>
<p>这种方法非常适合简单的变换。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> view: View = findViewById(R.id.my_view)
view.animate()
    .alpha(<span class="hljs-number">0.5f</span>)
    .translationX(<span class="hljs-number">100f</span>)
    .setDuration(<span class="hljs-number">500</span>)
    .start()
</code></pre>
<h3 data-id="heading-19">ObjectAnimator</h3>
<p><code>ObjectAnimator</code> 允许你为任何具有 <code>setter</code> 方法的对象的属性设置动画，而不仅仅是 <code>View</code> 对象（有  <code>setter</code> 方法皆可，可以是一个普通类）。它为动画自定义属性提供了更大的灵活性。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> animator = ObjectAnimator.ofFloat(view, <span class="hljs-string">"translationX"</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">300f</span>)
animator.duration = <span class="hljs-number">500</span>
animator.start()
</code></pre>
<h3 data-id="heading-20">AnimatorSet</h3>
<p><code>AnimatorSet</code> 可以组合多个动画，使其按顺序或同时运行，非常适合协调复杂的动画。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> fadeAnimator = ObjectAnimator.ofFloat(view, <span class="hljs-string">"alpha"</span>, <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>)
<span class="hljs-keyword">val</span> moveAnimator = ObjectAnimator.ofFloat(view, <span class="hljs-string">"translationX"</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">200f</span>)

<span class="hljs-keyword">val</span> animatorSet = AnimatorSet()
animatorSet.playSequentially(fadeAnimator, moveAnimator)
animatorSet.duration = <span class="hljs-number">1000</span>
animatorSet.start()
</code></pre>
<h3 data-id="heading-21">ValueAnimator</h3>
<p><code>ValueAnimator</code> 提供了在任意值之间进行动画的功能，可高度定制且灵活。
通过使用插值器控制动画进度，它可以适应各种使用场景，例如为宽度、高度、alpha 或任何其他属性设置动画。
这使其成为为特定需求定制精确且动态动画的绝佳选择。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> valueAnimator = ValueAnimator.ofInt(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>)
valueAnimator.duration = <span class="hljs-number">500</span>
valueAnimator.addUpdateListener { animation -&gt;
    <span class="hljs-keyword">val</span> animatedValue = animation.animatedValue <span class="hljs-keyword">as</span> <span class="hljs-built_in">Int</span>
    binding.progressbar.updateLayoutParams {
        width = (screenSize / <span class="hljs-number">100</span>) * animatedValue.toInt()
    }
}
valueAnimator.start()
</code></pre>
<h3 data-id="heading-22">基于 XML 的 View 动画</h3>
<p>基于 XML 的动画在资源文件中定义，以实现简洁性和可重用性。这些动画可以影响位置、缩放、旋转和透明度。</p>
<p>下面是一个 XML 示例：<code>res/anim/slide_in.xml</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">translate</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:fromXDelta</span>=<span class="hljs-string">"-100%"</span>
    <span class="hljs-attr">android:toXDelta</span>=<span class="hljs-string">"0%"</span>
    <span class="hljs-attr">android:duration</span>=<span class="hljs-string">"500"</span> /&gt;</span>
</code></pre>
<p>使用方法也非常简单：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> animation = AnimationUtils.loadAnimation(<span class="hljs-keyword">this</span>, R.anim.slide_in)
view.startAnimation(animation)
</code></pre>
<h3 data-id="heading-23">MotionLayout</h3>
<p><code>MotionLayout</code> 是 Android 中创建复杂运动和布局动画的强大工具。它构建在 <code>ConstraintLayout</code> 之上，允许你使用 XML 定义动画和状态之间的过渡。</p>
<p>XML 示例：<code>res/layout/motion_scene.xml</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MotionScene</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Transition</span>
        <span class="hljs-attr">app:constraintSetStart</span>=<span class="hljs-string">"@id/start"</span>
        <span class="hljs-attr">app:constraintSetEnd</span>=<span class="hljs-string">"@id/end"</span>
        <span class="hljs-attr">app:duration</span>=<span class="hljs-string">"500"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">OnSwipe</span>
            <span class="hljs-attr">app:touchAnchorId</span>=<span class="hljs-string">"@id/box"</span>
            <span class="hljs-attr">app:touchAnchorSide</span>=<span class="hljs-string">"top"</span>
            <span class="hljs-attr">app:dragDirection</span>=<span class="hljs-string">"dragDown"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Transition</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">MotionScene</span>&gt;</span>
</code></pre>
<p>在布局中使用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.motion.widget.MotionLayout</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">app:layoutDescription</span>=<span class="hljs-string">"@xml/motion_scene"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">View</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/box"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"100dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"100dp"</span>
        <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/blue"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.motion.widget.MotionLayout</span>&gt;</span>
</code></pre>
<p><code>MotionLayout</code> 非常适合创建复杂的动画，可精确控制过渡和状态。</p>
<h3 data-id="heading-24">Drawable 动画</h3>
<p><code>Drawable</code> 动画涉及使用 <code>AnimationDrawable</code> 进行逐帧过渡，适合创建简单的动画，如加载 spinner。</p>
<p>XML 示例：<code>res/drawable/animation_list.xml</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">animation-list</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span> <span class="hljs-attr">android:oneshot</span>=<span class="hljs-string">"false"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">"@drawable/frame1"</span> <span class="hljs-attr">android:duration</span>=<span class="hljs-string">"100"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">"@drawable/frame2"</span> <span class="hljs-attr">android:duration</span>=<span class="hljs-string">"100"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">animation-list</span>&gt;</span>
</code></pre>
<p>使用方法如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> animationDrawable = imageView.background <span class="hljs-keyword">as</span> AnimationDrawable
animationDrawable.start()
</code></pre>
<p>注意，只设置 <code>background</code> 为 <code>AnimationDrawable</code> 是不会工作的，一定不要忘了 <code>start</code>。</p>
<h3 data-id="heading-25">基于物理的动画</h3>
<p>基于物理的动画模拟现实世界的动力学效果。Android 提供了 <code>SpringAnimation</code> 和 <code>FlingAnimation</code> API，用于创建自然且动态的运动效果。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> springAnimation = SpringAnimation(view, DynamicAnimation.TRANSLATION_Y, <span class="hljs-number">0f</span>)
springAnimation.spring.stiffness = SpringForce.STIFFNESS_LOW
springAnimation.spring.dampingRatio = SpringForce.DAMPING_RATIO_HIGH_BOUNCY
springAnimation.start()
</code></pre>
<h3 data-id="heading-26">总结</h3>
<p>Android 提供了一系列实现动画的工具，从简单的属性变化到复杂的状态驱动过渡。</p>
<p>对于缩放或平移等简单变换，<code>View</code> 属性动画 和 <code>ObjectAnimator</code> 是有效的选择。</p>
<p>对于更复杂的场景，<code>AnimatorSet</code> 可以协调多个动画，而 <code>ValueAnimator</code> 提供了灵活的方式来为任意值设置动画。</p>
<p>不过这种传统的动画有个开发上的痛点，就是取消！</p>
<p>传动的动画把控取消的合适位置是很难的，所以如果你使用 Compose 进行开发，就直接使用 Compose 的动画，忘记这些传统动画吧！</p>
<h3 data-id="heading-27">进阶：插值器是如何工作的</h3>
<p>插值器通过修改动画值随时间变化的速率来定义动画的进度。它控制动画的加速、减速或匀速运动，使动画看起来更自然或更具视觉吸引力。</p>
<p>插值器用于定义动画在起始值和结束值之间的行为。例如，你可以让动画开始时缓慢，然后加速，最后在停止前减速。
这提供了对动画执行方式的灵活性和控制，超越了线性进度。</p>
<p>Android 提供了几种预定义的插值器，你可以根据所需效果选择：</p>
<ol>
<li><code>LinearInterpolator</code>：以恒定速率动画，没有加速或减速。</li>
<li><code>AccelerateInterpolator</code>：开始时缓慢，然后逐渐加速。</li>
<li><code>DecelerateInterpolator</code>：开始时快速，然后向结束时减速。</li>
<li><code>AccelerateDecelerateInterpolator</code>：结合了加速和减速，以获得平滑效果。</li>
<li><code>BounceInterpolator</code>：使动画看起来像在弹跳，模拟物理弹跳效果。</li>
<li><code>OvershootInterpolator</code>：动画会超出最终值，然后再回退到最终值。</li>
</ol>
<p>你可以将插值器应用于任何动画对象，如 <code>ObjectAnimator</code>、<code>ValueAnimator</code> 或 <code>ViewPropertyAnimator</code>。
插值器通过 <code>setInterpolator()</code> 方法设置。</p>
<p>下面举例，将插值器应用于 <code>ObjectAnimator</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> animator = ObjectAnimator.ofFloat(view, <span class="hljs-string">"translationX"</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">500f</span>)
animator.duration = <span class="hljs-number">1000</span>
animator.interpolator = OvershootInterpolator()
animator.start()
</code></pre>
<p>在这个示例中，<code>OvershootInterpolator</code> 会让视图在最终位置上过度动画，然后再回到最终位置，创造出动态且吸引人的效果。</p>
<p>你还可以通过扩展 <code>Interpolator</code> 接口并覆盖 <code>getInterpolation()</code> 方法来创建自己的插值器。这允许你完全自定义动画的时间曲线。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomInterpolator</span> : <span class="hljs-type">Interpolator</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInterpolation</span><span class="hljs-params">(input: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
        <span class="hljs-comment">// 自定义动画时间逻辑</span>
        <span class="hljs-keyword">return</span> input * input
    }
}

<span class="hljs-comment">// 使用自定义插值器</span>
animator.interpolator = CustomInterpolator()
</code></pre>
<p>这个自定义插值器会让动画呈二次方进度，开始缓慢，然后随时间加速。</p>
<p>总之。</p>
<p>插值器通过控制动画的时间和进度来增强 Android 动画，提供了创建更视觉上吸引人且逼真效果的方法。</p>
<p>Android 提供了几种内置插值器用于常见场景，你也可以定义自定义插值器来实现独特的行为。</p>
<p>通过有效利用插值器，你可以显著提升用户体验，实现平滑自然的动画。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第二十四章(Prisma)]]></title>    <link>https://juejin.cn/post/7600489282821783602</link>    <guid>https://juejin.cn/post/7600489282821783602</guid>    <pubDate>2026-01-29T00:35:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282821783602" data-draft-id="7600224355295199259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第二十四章(Prisma)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2026-01-29T00:35:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第二十四章(Prisma)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T00:35:01.000Z" title="Thu Jan 29 2026 00:35:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ORM框架(Object-Relational Mapping)</h2>
<p>在传统开发模式中，我们需要把数据存储到<code>数据库</code>，所以需要通过SQL语句来进行操作，例如<code>查询</code> <code>新增</code> <code>修改</code> <code>删除</code>等操作，但是SQL语句太多了，还比较繁琐，所以就有了ORM框架。</p>
<p>ORM框架简单来说就是让我们通过熟悉的语法来操作数据库，我们可以直接使用面向对象的方式来操作数据库，ORM会把我们的操作映射成SQL语句，然后执行。</p>
<p>面向对象查询:</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({
    <span class="hljs-attr">where</span>: {
        <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>
    },
    <span class="hljs-attr">select</span>: {
        <span class="hljs-attr">id</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-literal">true</span>
    }
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user)
</code></pre>
<p>SQL查询:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, name, email <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
<h4 data-id="heading-1">Prisma</h4>
<p>ORM框架比较多，这里我选择使用<code>Prisma</code>，因为<code>Prisma</code>是<code>TypeScript</code>优先的ORM框架，并且支持多种数据库，包括<code>MySQL</code> <code>PostgreSQL</code> <code>SQLite</code> <code>MongoDB</code>等。它以其出色的性能、类型安全性以及与 GraphQL 和 REST API 的集成而闻名</p>
<blockquote>
<p>注：我们当前使用的prisma版本是<code>7.3.0</code>为目前最新版(2026-01-29)，他每个大版本是有很大差异的，所以建议大家跟我安装一样的版本。</p>
</blockquote>
<h4 data-id="heading-2">Postgresql</h4>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f64c74fd0c6647ef9c2ad6856c7de1e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=4jWy95vOyw7mS7ypt2Gg8UUbH2w%3D" alt="image.png" width="20%" loading="lazy"/>
<p>数据库的种类也是非常多的，这里我选择使用<code>PostgreSQL</code>，完全开源免费，我称为世界第一数据库(个人言论)，因为他有非常强大的功能，例如支持高级数据类型，<code>JSON</code> <code>数组</code> <code>枚举</code> <code>布尔值</code> <code>地理空间GIS</code>,事务与并发能力更强，并且还支持自定义扩展其功能。</p>
<h4 data-id="heading-3">PostgresSQL安装教程</h4>
<ol>
<li>简单粗暴，访问官网<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.postgresql.org%2Fdownload%2F" target="_blank" title="https://www.postgresql.org/download/" ref="nofollow noopener noreferrer">www.postgresql.org/download/</a>，选择适合你操作系统的版本，然后下载安装即可。</li>
</ol>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e4d4fb089d648c09885924b6c25316a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=ok3l5Dm%2BhMlIznu%2Busw%2BPPhhchs%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39108fde6606498ba9aeb7c68d3e613a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=DpATMGTq1EJjeJ%2F0PEYV2o2LfDw%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/950307e147f94d72a38206e8fd46dd56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=GuoeHtXjgF8CI66AzjM4lvPN7NY%3D" alt="image.png" width="100%" loading="lazy"/>
<ol start="2">
<li>使用<code>docker</code>安装</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">docker pull postgres:18
docker run -d --name postgresServer -p 6666:5432 -e POSTGRES_PASSWORD=123456 postgres:18
</code></pre>
<p>账号默认为<code>postgres</code>，密码为<code>123456</code>，端口号为<code>6666</code>。</p>
<p>安装数据库可视化工具：打开<code>vsCode</code> / <code>Cursor</code> / <code>WebStorm</code>等代码编辑器，安装<code>Database Client</code>插件，然后连接数据库即可。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e105526bdfea4b1fbf1d58036b515637~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=SF4ODw4vO807RMyEf1aW0MKUMoA%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27b94da3c538456d8522aabefcd79e3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=InKY0%2FiKQP%2FdrFjuTagJz1k82yM%3D" alt="image.png" width="100%" loading="lazy"/>
<h4 data-id="heading-4">开始使用Prisma</h4>
<p>安装prisma:</p>
<pre><code class="hljs language-bash" lang="bash">npm i prisma -D
</code></pre>
<p>安装prisma客户端:</p>
<pre><code class="hljs language-bash" lang="bash">npm install @prisma/client @prisma/adapter-pg pg dotenv
</code></pre>
<blockquote>
<p>注: prisma7版本需要独立安装适配器</p>
</blockquote>
<p>例如<code>postgresql</code>需要安装<code>@prisma/adapter-pg</code>，<code>mysql</code>需要安装<code>@prisma/adapter-mariadb</code>。</p>
<p>其他数据库请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2Fdocs%2Fgetting-started%2Fprisma-orm%2Fquickstart%2Fprisma-postgres" target="_blank" title="https://www.prisma.io/docs/getting-started/prisma-orm/quickstart/prisma-postgres" ref="nofollow noopener noreferrer">www.prisma.io/docs/gettin…</a></p>
<p>在Next.js项目根目录执行以下命令，初始化<code>prisma</code>:</p>
<pre><code class="hljs language-bash" lang="bash">npx prisma init
</code></pre>
<p>执行完成之后他会自动生成<code>prisma</code>文件夹，并且生成<code>schema.prisma</code>文件，以及创建一个<code>env</code>文件和<code>prisma.config.ts</code>文件。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/546b5109d7b741e38f427901e2ffad92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=SzkakRbzzdwxHet6naiAIGYKilc%3D" alt="image.png" width="100%" loading="lazy"/>
<p>打开prisma/schema.prisma文件，添加以下内容：</p>
<pre><code class="hljs language-prisma" lang="prisma">generator client {
  provider = "prisma-client" //使用什么客户端
  output   = "../src/generated/prisma" //生成客户端代码的目录
}

datasource db {
  provider = "postgresql" //连接什么数据库
}

model User {
  id        String   @id @default(cuid()) //主键 
  name      String //用户名
  email     String   @unique //邮箱
  password  String //密码
  createdAt DateTime @default(now()) //创建时间
  updatedAt DateTime @updatedAt //更新时间
  posts     Post[] //关联文章
}

model Post {
  id        String   @id @default(cuid()) //主键
  title     String //标题
  content   String //内容
  createdAt DateTime @default(now()) //创建时间
  updatedAt DateTime @updatedAt //更新时间
  authorId  String //作者ID
  author    User     @relation(fields: [authorId], references: [id],onDelete: Cascade,onUpdate: Cascade) //一对多关联
}
</code></pre>
<ul>
<li>@id:主键对应sql语句的<code>PRIMARY KEY</code></li>
<li>@default(cuid()):默认生成一个唯一ID 类似于sql语句的<code>AUTO_INCREMENT</code></li>
<li>@unique:唯一约束对应sql语句的<code>UNIQUE</code></li>
<li>@relation:一对多关联对应sql语句的<code>FOREIGN KEY</code></li>
<li>@relation(fields: [authorId], references: [id],onDelete: Cascade,onUpdate: Cascade):一对多关联对应sql语句的<code>FOREIGN KEY</code></li>
<li>@default(now()):默认生成当前时间 类似于sql语句的<code>CURRENT_TIMESTAMP</code></li>
<li>@updatedAt:更新时间 类似于sql语句的<code>UPDATE CURRENT_TIMESTAMP</code></li>
<li>onDelete: Cascade:级联删除(表示删除主表的时候，从表也删除，非常的方便啊)</li>
<li>onUpdate: Cascade:级联更新(表示更新主表的时候，从表也更新，非常的方便啊)</li>
</ul>
<p>打开<code>.env</code>文件，修改数据库连接信息：</p>
<p>连接规则:DATABASE_URL="postgresql://username:password@localhost:5432/mydb?schema=public"</p>
<ul>
<li><code>postgresql</code>:数据库类型</li>
<li><code>username</code>:用户名</li>
<li><code>password</code>:密码</li>
<li><code>localhost</code>:主机名</li>
<li><code>5432</code>:端口号</li>
<li><code>mydb</code>:数据库名</li>
<li><code>schema=public</code>:模式</li>
</ul>
<pre><code class="hljs language-env" lang="env">DATABASE_URL="postgresql://postgres:123456@localhost:6666/test_db"
</code></pre>
<p>执行数据库迁移命令:</p>
<pre><code class="hljs language-bash" lang="bash">npx prisma migrate dev --name init
</code></pre>
<p>执行完成之后他会在<code>prisma/migrations</code>文件夹中生成一个<code>migration</code>文件，并且生成一个sql文件，然后自动执行sql文件，创建表结构。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65a440849a2140cba2ba53a718d3b064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=l8C5hYa3wLJeragmwV%2BGCzotN0g%3D" alt="image.png" loading="lazy"/></p>
<p>接着执行生成客户端代码命令：</p>
<pre><code class="hljs language-bash" lang="bash">npx prisma generate
<span class="hljs-comment">#生成路径是 schema.prisma 文件中client output的目录</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ff63983a8e1419fa56fc0b81bad85ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=BcTRigPCQr0M14MzFVHv%2BfVKMDY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">编写增删改查</h4>
<p>src/lib/prisma.ts</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../generated/prisma/client'</span> <span class="hljs-comment">//引入生成客户端代码</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaPg</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/adapter-pg'</span> <span class="hljs-comment">//引入适配器</span>
<span class="hljs-keyword">const</span> pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaPg</span>({ <span class="hljs-attr">connectionString</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DATABASE_URL</span> }) <span class="hljs-comment">//创建连接池</span>
<span class="hljs-keyword">const</span> prisma = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaClient</span>({ <span class="hljs-attr">adapter</span>: pool }) <span class="hljs-comment">//创建客户端</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> prisma <span class="hljs-comment">//导出客户端</span>
</code></pre>
<p>src/app/api/route.ts</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> prisma <span class="hljs-keyword">from</span> <span class="hljs-string">"@/lib/prisma"</span>; <span class="hljs-comment">//@lib是我在tsconfig.json中配置的别名，表示src目录下的lib文件夹</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>; <span class="hljs-comment">//引入NextRequest, NextResponse</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>() <span class="hljs-comment">//查询所有用户</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>(users) <span class="hljs-comment">//返回用户列表</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> { name, email, password } = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">json</span>() <span class="hljs-comment">//获取请求体</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">create</span>({
        <span class="hljs-attr">data</span>: { name, email, password } <span class="hljs-comment">//创建用户</span>
    })
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>(user) <span class="hljs-comment">//返回创建的用户</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PATCH</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> { id, name, email, password } = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">json</span>() <span class="hljs-comment">//获取请求体</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">update</span>({
        <span class="hljs-attr">where</span>: { id },
        <span class="hljs-attr">data</span>: { name, email, password } <span class="hljs-comment">//更新用户</span>
    })
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>(user) <span class="hljs-comment">//返回更新后的用户</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DELETE</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> { id } = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">json</span>() <span class="hljs-comment">//获取请求体</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">delete</span>({
        <span class="hljs-attr">where</span>: { id } <span class="hljs-comment">//删除用户</span>
    })
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>(user) <span class="hljs-comment">//返回删除后的用户</span>
}
</code></pre>
<p>index.http</p>
<p>执行http文件需要在插件市场安装<code>REST Client</code>，然后打开http文件，点击<code>Send Request</code>按钮即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45782deca2d74a0db1da3fe702262d59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=3pN5JoTZIxoQ7K3R%2FL7BwtNrl38%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-http" lang="http">### 创建用户
POST http://localhost:8888/api
Content-Type: application/json

{
    "name": "test",
    "email": "1test@test.com",
    "password": "123456"
}

### 查询所有用户
GET http://localhost:8888/api


### 更新用户
PATCH http://localhost:8888/api
Content-Type: application/json

{
    "id": "cmkyoxflr00004ck82ywc6joi",
    "name": "xiaoman",
    "email": "xiaomansdasdas",
    "password": "dasdasda"
}

### 删除用户
DELETE http://localhost:8888/api
Content-Type: application/json

{
    "id": "cmkyoxflr00004ck82ywc6joi"
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot + JPackage：构建独立安装包]]></title>    <link>https://juejin.cn/post/7600284420633952297</link>    <guid>https://juejin.cn/post/7600284420633952297</guid>    <pubDate>2026-01-28T23:58:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600284420633952297" data-draft-id="7600296037542428672" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Spring Boot + JPackage：构建独立安装包"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T23:58:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Spring Boot + JPackage：构建独立安装包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T23:58:11.000Z" title="Wed Jan 28 2026 23:58:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>从 JDK 14 开始，Java 官方引入了 <strong>JPackage</strong> 工具（在 JDK 16 正式成为标准功能），它能够将 Java 应用打包成特定平台的原生安装包，<strong>自带定制化的 JRE 运行环境</strong>。这意味着用户无需提前安装 Java 环境，双击安装包即可完成应用部署，极大地简化了交付流程。</p>
<p>本文将介绍如何使用 JPackage 工具将 Spring Boot 项目打包成 Windows、macOS 或 Linux 平台的原生安装包。</p>
<h2 data-id="heading-1">一、JPackage 简介</h2>
<h4 data-id="heading-2">1.1 什么是 JPackage</h4>
<p>JPackage 是 JDK 自带的打包工具，位于 <code>$JAVA_HOME/bin</code> 目录下。它的核心功能是：</p>
<p><strong>生成平台原生安装包</strong>：Windows 的 <code>.exe</code>/<code>.msi</code>、macOS 的 <code>.dmg</code>/<code>.pkg</code>、Linux 的 <code>.deb</code>/<code>.rpm</code></p>
<p><strong>自定义 JRE</strong>：使用 <code>jlink</code> 工具裁剪 JDK，仅打包应用所需的模块，大幅减小安装包体积</p>
<p><strong>简化部署</strong>：用户无需预装 Java 环境，安装包自带运行时</p>
<h4 data-id="heading-3">1.2 JPackage 的优势</h4>

























<table><thead><tr><th>传统部署方式</th><th>JPackage 方式</th></tr></thead><tbody><tr><td>需要预装 JRE/JDK</td><td>自带 JRE，无需额外安装</td></tr><tr><td>环境版本可能不匹配</td><td>绑定特定 JRE 版本，环境一致</td></tr><tr><td>手动编写启动脚本</td><td>自动生成启动器</td></tr><tr><td>跨平台需要多套脚本</td><td>一键生成各平台安装包</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、环境准备</h2>
<h4 data-id="heading-5">2.1 JDK 版本要求</h4>
<p><strong>推荐使用 JDK 17 或更高版本</strong>（JPackage 在 JDK 16 才成为标准功能，JDK 17 是 LTS 版本）</p>
<p>确认 JPackage 可用：</p>
<pre><code class="hljs language-bash" lang="bash">jpackage --version
</code></pre>
<h4 data-id="heading-6">2.2 平台特定工具</h4>
<p>根据目标操作系统，需要安装对应的打包工具：</p>
<h5 data-id="heading-7">Windows</h5>
<p><strong>WiX Toolset 3.11+</strong>（用于生成 <code>.msi</code> 安装包）<br/>
下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwixtoolset.org%2F" target="_blank" title="https://wixtoolset.org/" ref="nofollow noopener noreferrer">wixtoolset.org/</a><br/>
安装后将 <code>bin</code> 目录添加到系统环境变量 <code>PATH</code></p>
<h5 data-id="heading-8">macOS</h5>
<p>Xcode 命令行工具（用于生成 <code>.dmg</code>/<code>.pkg</code>）</p>
<pre><code class="hljs language-bash" lang="bash">xcode-select --install
</code></pre>
<h5 data-id="heading-9">Linux</h5>
<p><strong>Debian/Ubuntu</strong>：安装 <code>fakeroot</code></p>
<pre><code class="hljs language-bash" lang="bash">sudo apt-get install fakeroot
</code></pre>
<p><strong>RedHat/CentOS</strong>：安装 <code>rpm-build</code></p>
<pre><code class="hljs language-bash" lang="bash">sudo yum install rpm-build
</code></pre>
<h2 data-id="heading-10">三、Spring Boot 项目准备</h2>
<h4 data-id="heading-11">3.1 示例项目结构</h4>
<p>假设我们有一个标准的 Spring Boot 项目：</p>
<pre><code class="hljs language-css" lang="css">my-springboot-app/
├── <span class="hljs-attribute">src</span>/
│   └── <span class="hljs-selector-tag">main</span>/
│       ├── java/
│       └── resources/
├── pom<span class="hljs-selector-class">.xml</span>
└── target/
    └── my-app-<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span><span class="hljs-selector-class">.jar</span>
</code></pre>
<h4 data-id="heading-12">3.2 构建可执行 JAR</h4>
<p>首先使用 Maven 或 Gradle 构建项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Maven</span>
mvn clean package

<span class="hljs-comment"># Gradle</span>
gradle clean build
</code></pre>
<p>确保生成的 JAR 包是可执行的（Spring Boot 默认打包方式）。</p>
<h2 data-id="heading-13">四、使用 JPackage 打包</h2>
<h4 data-id="heading-14">4.1 基础打包命令</h4>
<p>以下是一个基础的 JPackage 命令示例（以 Windows 为例）：</p>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MySpringBootApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --app-version 1.0.0 \
  --vendor <span class="hljs-string">"我的公司"</span> \
  --description <span class="hljs-string">"基于 Spring Boot 的企业级应用"</span> \
  --icon src/main/resources/app-icon.ico \
  --win-dir-chooser \
  --win-menu \
  --win-shortcut
</code></pre>
<h5 data-id="heading-15">参数说明</h5>

















































<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>--input</code></td><td>输入目录，包含 JAR 包和依赖</td></tr><tr><td><code>--name</code></td><td>应用名称</td></tr><tr><td><code>--main-jar</code></td><td>主 JAR 包文件名</td></tr><tr><td><code>--main-class</code></td><td>主类（Spring Boot 使用 <code>JarLauncher</code>）</td></tr><tr><td><code>--type</code></td><td>安装包类型（<code>msi</code>/<code>exe</code>/<code>dmg</code>/<code>pkg</code>/<code>deb</code>/<code>rpm</code>）</td></tr><tr><td><code>--app-version</code></td><td>应用版本号</td></tr><tr><td><code>--icon</code></td><td>应用图标（Windows 用 <code>.ico</code>，macOS 用 <code>.icns</code>）</td></tr><tr><td><code>--win-dir-chooser</code></td><td>允许用户选择安装目录</td></tr><tr><td><code>--win-menu</code></td><td>创建开始菜单项</td></tr><tr><td><code>--win-shortcut</code></td><td>创建桌面快捷方式</td></tr></tbody></table>
<h4 data-id="heading-16">4.2 自定义 JRE（使用 jlink）</h4>
<p>为了减小安装包体积，可以使用 <code>jlink</code> 裁剪 JRE，仅包含必要的模块。</p>
<h5 data-id="heading-17">步骤 1：查找应用依赖的模块</h5>
<pre><code class="hljs language-bash" lang="bash">jdeps --list-deps target/my-app-1.0.0.jar
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-csharp" lang="csharp">java.<span class="hljs-keyword">base</span>
java.logging
java.sql
java.naming
java.desktop
...
</code></pre>
<h5 data-id="heading-18">步骤 2：使用 jlink 创建自定义 JRE</h5>
<pre><code class="hljs language-bash" lang="bash">jlink \
  --add-modules java.base,java.logging,java.sql,java.naming,java.desktop,java.xml,java.management \
  --output custom-jre \
  --strip-debug \
  --no-header-files \
  --no-man-pages \
  --compress=2
</code></pre>
<h5 data-id="heading-19">步骤 3：使用自定义 JRE 打包</h5>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MySpringBootApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --runtime-image custom-jre \
  --app-version 1.0.0 \
  --vendor <span class="hljs-string">"我的公司"</span>
</code></pre>
<blockquote>
<p><strong>注意</strong>：Spring Boot 应用通常依赖较多模块，建议先不裁剪 JRE，确保功能正常后再优化。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">五、不同平台的打包示例</h2>
<h4 data-id="heading-21">5.1 Windows 平台（MSI）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MyApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --app-version 1.0.0 \
  --icon src/main/resources/app.ico \
  --win-dir-chooser \
  --win-menu \
  --win-shortcut \
  --win-menu-group <span class="hljs-string">"我的应用"</span>
</code></pre>
<h4 data-id="heading-22">5.2 macOS 平台（DMG）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MyApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> dmg \
  --app-version 1.0.0 \
  --icon src/main/resources/app.icns \
  --mac-package-name <span class="hljs-string">"com.mycompany.myapp"</span> \
  --mac-package-identifier <span class="hljs-string">"com.mycompany.myapp"</span>
</code></pre>
<h4 data-id="heading-23">5.3 Linux 平台（DEB）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name myapp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> deb \
  --app-version 1.0.0 \
  --icon src/main/resources/app.png \
  --linux-shortcut \
  --linux-menu-group <span class="hljs-string">"Development"</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">六、集成到 Maven 构建流程</h2>
<p>为了自动化打包流程，可以将 JPackage 命令集成到 Maven 的 <code>pom.xml</code> 中。</p>
<h4 data-id="heading-25">6.1 使用 exec-maven-plugin</h4>
<p>在 <code>pom.xml</code> 中添加以下插件配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- Spring Boot Maven 插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- JPackage 打包插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.mojo<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>exec-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>jpackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>exec<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">executable</span>&gt;</span>jpackage<span class="hljs-tag">&lt;/<span class="hljs-name">executable</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">arguments</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--input<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>target<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--name<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>MySpringBootApp<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--main-jar<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>${project.build.finalName}.jar<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--main-class<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>org.springframework.boot.loader.JarLauncher<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--type<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>msi<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--app-version<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>${project.version}<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--vendor<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>我的公司<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-dir-chooser<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-menu<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-shortcut<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">arguments</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h4 data-id="heading-26">6.2 执行构建</h4>
<pre><code class="hljs language-bash" lang="bash">mvn clean package
</code></pre>
<p>构建完成后，安装包将生成在项目根目录下。</p>
<h2 data-id="heading-27">七、总结</h2>
<p>JPackage 工具为 Java 应用的分发提供了强大的支持，从简单的命令行操作到集成到自动化构建流程，JPackage 都能很好地满足需求。</p>
<p>在实际项目中，建议根据应用特点选择合适的打包策略，平衡安装包体积、部署便利性和运行性能，为用户提供最佳的使用体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别碎片化学习：这个开源项目如何用38万star，重塑编程知识体系]]></title>    <link>https://juejin.cn/post/7600296037542526976</link>    <guid>https://juejin.cn/post/7600296037542526976</guid>    <pubDate>2026-01-28T15:14:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600296037542526976" data-draft-id="7600292312216387636" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别碎片化学习：这个开源项目如何用38万star，重塑编程知识体系"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-28T15:14:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别碎片化学习：这个开源项目如何用38万star，重塑编程知识体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:14:54.000Z" title="Wed Jan 28 2026 15:14:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>简介</strong>：在茫茫编程资源中寻宝？免费、优质、全球化的学习资料其实触手可及！🌟 今天要推荐GitHub上拥有38万星标的开源宝库——free-programming-books。这里汇聚了全球40多种语言的编程书籍，涵盖Python、JavaScript、算法、机器学习等全领域，完全免费且持续更新。 无论你是编程新手还是资深开发者，这个由开源社区共同维护的知识库，都能为你提供系统化的学习路径。告别碎片化知识，从这里开始构建坚实的技能体系！ 立即探索这个知识无国界的编程学习殿堂吧！ #编程学习 #开源项目 #免费资源 #技术提升 #开发者工具</p>
</blockquote>
<p>在这个信息爆炸的时代，编程学习者往往面临一种“幸福的烦恼”：资源繁多，却不知从何入手。付费课程价格不菲，而网络上的免费资源又良莠不齐。有没有一个地方，能够汇聚全球优质的免费编程学习资料，并且保持持续更新与维护？</p>
<p>答案是肯定的。今天要介绍的，正是 GitHub 上被誉为“程序员学习宝库”的明星项目——<strong>free-programming-books</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6d171a2235d42998ba6db1f1b523d3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218094&amp;x-signature=FhRSxC3vQBGl1oVgZpBoVgfe8Ms%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">🔍项目概览：一个开源学习的典范</h2>
<p>free-programming-books 始于 2013 年，最初源自 Stack Overflow 上一个关于免费编程书籍的列表。随着时间推移，项目迁移至 GitHub，在开源社区的共同努力下，它已成长为 <strong>GitHub 上最受欢迎的知识库之一</strong>。</p>
<p>该项目由非营利组织 <strong>Free Ebook Foundation</strong> 负责维护，致力于推动免费电子书的创作、分发、存档与可持续发展。</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEbookFoundation%2Ffree-programming-books" target="_blank" title="https://github.com/EbookFoundation/free-programming-books" ref="nofollow noopener noreferrer">github.com/EbookFounda…</a></p>
<p>在线地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Febookfoundation.github.io%2Ffree-programming-books%2F" target="_blank" title="https://ebookfoundation.github.io/free-programming-books/" ref="nofollow noopener noreferrer">ebookfoundation.github.io/free-progra…</a></p>
<p>目前，该项目在 GitHub 上已获得 <strong>381k</strong> ⭐ star 关注。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/306377a4814b46e780932eee222daaa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218094&amp;x-signature=8RT3dv%2BnUeyZ52yLOhAwPfEyl9Q%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">📚 丰富的资源体系</h2>
<ul>
<li><strong>按编程语言分类</strong>：涵盖 Python、JavaScript、Rust、Go 等几乎所有主流语言</li>
<li><strong>按主题分类</strong>：包括算法、数据结构、网络安全、机器学习等专业方向</li>
<li><strong>多语言支持</strong>：收录 <strong>40 多种语言</strong> 的编程书籍，如中文、日文、韩文、法文、德文等</li>
</ul>
<h2 data-id="heading-2">🚀如何使用这个宝库？</h2>
<p>项目提供了两个便捷的访问途径：</p>
<ul>
<li>
<p><strong>动态搜索网站</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Febookfoundation.github.io%2Ffree-programming-books-search%2F%3F%26sect%3Dbooks%26file%3Dfree-programming-books-zh.md" target="_blank" title="https://ebookfoundation.github.io/free-programming-books-search/?&amp;sect=books&amp;file=free-programming-books-zh.md" ref="nofollow noopener noreferrer">ebookfoundation.github.io/free-progra…</a></p>
<ul>
<li>支持按书名或作者搜索</li>
<li>界面简洁，查找高效</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb2adce3dc9b463bb495ca3a9703b934~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218094&amp;x-signature=6heA%2BraHEptKlRypuSHL1MuISvs%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>静态浏览网站</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Febookfoundation.github.io%2Ffree-programming-books%2Fbooks%2Ffree-programming-books-zh.html" target="_blank" title="https://ebookfoundation.github.io/free-programming-books/books/free-programming-books-zh.html" ref="nofollow noopener noreferrer">ebookfoundation.github.io/free-progra…</a></p>
<ul>
<li>按分类浏览全部资源</li>
<li>适合探索与发现式学习</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afcdde9580a8474881c20ef6057953dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218094&amp;x-signature=fN1E7fHkkTDiTVYVcXCuCudbB1I%3D" alt="" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-3">🎖️项目的独特价值</h2>
<h3 data-id="heading-4">🌍 真正的全球化视野</h3>
<p>不同于许多仅聚焦英语内容的资源，该项目积极收录多语种资料，让非英语母语的学习者也能获得高质量学习资源。</p>
<h3 data-id="heading-5">🔄 持续维护与更新</h3>
<p>依托开源社区的协作力量，项目始终保持活力。每天都有新资源加入，过时链接也会及时清理。</p>
<h3 data-id="heading-6">✅ 严格的质量管控</h3>
<p>尽管资源数量庞大，但项目设有清晰的贡献指南与质量标准，确保列表中的内容具备真正的学习价值。</p>
<h3 data-id="heading-7">🆓 完全免费与合法</h3>
<p>所有收录资源均为合法免费提供，用户无需担心版权风险。</p>
<h2 data-id="heading-8">📌为什么推荐系统性学习？</h2>
<p>尽管网络上充斥着大量技术博文，能够快速解答特定问题，但这些知识往往是零散和碎片化的。相比之下，通过书籍或完整项目进行系统性学习，有助于构建起完整的知识体系。</p>
<p>网络博文如同知识的拼图碎片，虽然能呈现某个局部细节，却难以展示完整的知识图景。它们通常针对特定场景或最新技术，缺乏前后逻辑的串联，容易让人陷入“只见树木，不见森林”的困境。</p>
<p>系统性学习——无论通过结构严谨的书籍，还是设计完整的项目——能够帮助学习者：</p>
<ul>
<li><strong>构建知识框架</strong>：从基础到进阶，层层递进，形成完整的认知体系</li>
<li><strong>理解内在逻辑</strong>：掌握知识间的关联与演变脉络，做到既知其然，也知其所以然</li>
<li><strong>培养系统思维</strong>：在解决复杂问题时，能从整体视角分析，而非仅仅局部应对</li>
<li><strong>建立长期记忆</strong>：系统化的知识更易于大脑组织和存储，转化为持久的专业能力</li>
</ul>
<p>在技术领域尤其如此：一个看似简单的功能背后，往往涉及算法优化、设计模式、性能考量等多重维度。唯有通过系统性学习，才能深入理解技术本质，而非停留于表层使用。</p>
<p>因此，虽然碎片化学习能快速应对眼前问题，但若想真正深入某一领域，建立扎实的专业基础，系统性学习依然是更可靠、更有效的路径。它不仅传授知识，更塑造一种能够持续学习与自我更新的能力结构。</p>
<h2 data-id="heading-9">📢缺点与局限</h2>
<p>如同任何项目一样，free-programming-books 也并非完美，存在一些客观的局限性：</p>
<ul>
<li>内容虽丰，但良莠需自辨：作为社区驱动的链接集合，其收录的资源质量仍依赖用户自行判断与筛选。</li>
<li>更新依赖社区：部分冷门主题或链接的更新和维护可能不够及时，需要使用者留意。</li>
<li>AI等前沿领域覆盖有限：对于人工智能、大语言模型等近年爆发式发展的前沿领域，其收录的免费、系统性的经典书籍或最新资源相对较少，学习者需结合其他渠道（如官方文档、前沿论文、专业课程）进行补充。</li>
</ul>
<h2 data-id="heading-10">📝结语</h2>
<p>在知识付费日益普遍的今天，free-programming-books 项目如同一股清流，始终秉持“知识共享、教育平等”的开源精神。它不只是一个资源列表，更是全球编程学习者互助共进的社区象征。</p>
<p>无论你是刚刚入门的编程新手，还是希望拓展技能的经验开发者，或是正在寻找教学材料的教育工作者，这个宝库都能为你提供宝贵的支持。</p>
<p><strong>知识不应设有门槛，学习不该存在障碍</strong>——这正是 free-programming-books 项目带给我们的深刻启示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e7c436891f4450a8856e3610e1da439~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218094&amp;x-signature=xh7t5D4S7hlVqq1ga9vk6KdPsXs%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建无障碍组件之Link Pattern]]></title>    <link>https://juejin.cn/post/7600060691350552618</link>    <guid>https://juejin.cn/post/7600060691350552618</guid>    <pubDate>2026-01-28T15:18:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350552618" data-draft-id="7600240045366657078" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建无障碍组件之Link Pattern"/> <meta itemprop="keywords" content="前端,HTML,交互设计"/> <meta itemprop="datePublished" content="2026-01-28T15:18:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="anOnion"/> <meta itemprop="url" content="https://juejin.cn/user/553809592722589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建无障碍组件之Link Pattern
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/553809592722589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    anOnion
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:18:10.000Z" title="Wed Jan 28 2026 15:18:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Link Pattern 详解：构建无障碍链接组件</h2>
<p>链接是 Web 页面中最核心的导航元素，它将用户从一个资源引导到另一个资源。根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpatterns%2Flink%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/patterns/link/" ref="nofollow noopener noreferrer">W3C WAI-ARIA Link Pattern 规范</a>，正确实现的链接组件不仅要提供清晰的导航功能，更要确保所有用户都能顺利访问，包括依赖屏幕阅读器等辅助技术的用户。本文将深入探讨 Link Pattern 的核心概念、实现要点以及最佳实践。</p>
<h3 data-id="heading-1">一、链接的定义与核心功能</h3>
<p>链接是一个允许用户导航到另一个页面、页面位置或其他资源的界面组件。链接的本质是<strong>超文本引用</strong>，它告诉用户<strong>这里有你可能感兴趣的另一个资源</strong>。与按钮执行动作不同，链接的作用是导航，这是两者最本质的区别。</p>
<p>在实际开发中，浏览器为原生 HTML 链接提供了丰富的功能支持，例如在新窗口中打开目标页面、将目标 URL 复制到系统剪贴板等。因此，<strong>应尽可能使用 HTML a 元素创建链接</strong>。</p>
<h3 data-id="heading-2">二、何时需要自定义链接实现</h3>
<p>在某些情况下，需要使用非 a 元素实现链接功能，例如：</p>
<ul>
<li>图片作为导航入口</li>
<li>使用 CSS 伪元素创建的可视化链接</li>
<li>复杂的 UI 组件中需要链接行为的元素</li>
</ul>
<p>根据 WAI-ARIA 规范，当必须使用非 a 元素时，需要手动添加必要的 ARIA 属性和键盘支持。</p>
<h3 data-id="heading-3">三、键盘交互规范</h3>
<p>键盘可访问性是 Web 无障碍设计的核心要素之一。链接组件必须支持完整的键盘交互，确保无法使用鼠标的用户也能顺利操作。根据 Link Pattern 规范：</p>
<p><strong>回车键</strong>是激活链接的主要方式。当用户按下回车键时，链接被触发执行导航操作。</p>
<p><strong>上下文菜单</strong>（可选）：按 <code>Shift + F10</code> 键可以打开链接的上下文菜单，提供复制链接地址、在新窗口中打开等选项。</p>

















<table><thead><tr><th>操作系统</th><th>打开上下文菜单</th></tr></thead><tbody><tr><td>Windows</td><td><code>Shift + F10</code> 或 <code>Menu</code> 键</td></tr><tr><td>macOS</td><td><code>Control + 点击</code></td></tr></tbody></table>
<h3 data-id="heading-4">四、WAI-ARIA 角色、状态和属性</h3>
<p>正确使用 WAI-ARIA 属性是构建无障碍链接组件的技术基础。</p>
<p><strong>角色声明</strong>是基础要求。非 a 元素的链接需要将 role 属性设置为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23link" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#link" ref="nofollow noopener noreferrer">link</a>，向辅助技术表明这是一个链接组件。</p>
<p>示例：使用 span 元素模拟链接：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>&gt;</span>
  示例网站
<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
</code></pre>
<p><strong>可访问名称</strong>是链接最重要的可访问性特征之一。链接必须有可访问的名称，可以通过元素文本内容、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-label" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-label" ref="nofollow noopener noreferrer">aria-label</a> 或 alt 属性提供。</p>
<p>示例 1：使用 img 元素作为链接时，通过 alt 属性提供可访问名称：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"logo.png"</span>
  <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例网站"</span> /&gt;</span>
</code></pre>
<p>示例 2：使用 aria-label 为链接提供可访问名称：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"text-link"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>
  <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"访问示例网站"</span>
  &gt;</span>🔗&lt;/span
&gt;
</code></pre>
<p><strong>焦点管理</strong>需要使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23tabindex" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#tabindex" ref="nofollow noopener noreferrer">tabindex="0"</a>，将链接元素包含在页面 Tab 序列中，使其可通过键盘聚焦。</p>
<h3 data-id="heading-5">五、完整示例</h3>
<p>以下是使用不同元素实现链接的完整示例：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 示例 1：span 元素作为链接 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>&gt;</span>
  W3C 网站
<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 示例 2：img 元素作为链接 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"logo.svg"</span>
  <span class="hljs-attr">alt</span>=<span class="hljs-string">"W3C 网站"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 示例 3：使用 aria-label 的链接 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"link-styled"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>
  <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"W3C 网站"</span>
  &gt;</span>🔗&lt;/span
&gt;

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">goToLink</span>(<span class="hljs-params">event, url</span>) {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">type</span> === <span class="hljs-string">'keydown'</span> &amp;&amp; event.<span class="hljs-property">key</span> !== <span class="hljs-string">'Enter'</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(url, <span class="hljs-string">'_blank'</span>);
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.link-styled</span> {
    <span class="hljs-attribute">color</span>: blue;
    <span class="hljs-attribute">text-decoration</span>: underline;
    <span class="hljs-attribute">cursor</span>: pointer;
  }
  <span class="hljs-selector-class">.link-styled</span><span class="hljs-selector-pseudo">:focus</span> {
    <span class="hljs-attribute">outline</span>: <span class="hljs-number">2px</span> solid blue;
    <span class="hljs-attribute">outline-offset</span>: <span class="hljs-number">2px</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">六、最佳实践</h3>
<h4 data-id="heading-7">6.1 优先使用原生元素</h4>
<p>尽可能使用原生 HTML a 元素创建链接。浏览器为原生链接提供了丰富的功能和更好的兼容性，无需额外添加 ARIA 属性。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 推荐做法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span>
  <span class="hljs-attr">href</span>=<span class="hljs-string">"https://example.com/"</span>
  <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>
  &gt;</span>访问示例&lt;/a
&gt;

<span class="hljs-comment">&lt;!-- 不推荐做法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  &gt;</span>访问示例&lt;/span
&gt;
</code></pre>
<h4 data-id="heading-8">6.2 正确处理键盘事件</h4>
<p>自定义链接需要同时处理 onclick 和 onkeydown 事件，确保用户可以通过回车键激活链接。</p>
<pre><code class="hljs language-javascript" lang="javascript">element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-comment">// 执行导航操作</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">url</span>;
  }
});
</code></pre>
<h4 data-id="heading-9">6.3 提供视觉反馈</h4>
<p>链接应该有明确的视觉样式，让用户能够识别这是一个可交互的元素。同时，应该提供键盘焦点样式。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span>,
<span class="hljs-selector-attr">[role=<span class="hljs-string">'link'</span>]</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#0066cc</span>;
  <span class="hljs-attribute">text-decoration</span>: underline;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-comment">/* 焦点状态：仅对键盘 Tab 导航显示焦点框，鼠标点击时不显示 */</span>
<span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:focus</span>-visible,
<span class="hljs-selector-attr">[role=<span class="hljs-string">'link'</span>]</span><span class="hljs-selector-pseudo">:focus</span>-visible {
  <span class="hljs-attribute">outline</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#0066cc</span>;
  <span class="hljs-attribute">outline-offset</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
}

<span class="hljs-comment">/* 悬停状态：加深颜色并加粗下划线，提供鼠标交互反馈 */</span>
<span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span>,
<span class="hljs-selector-attr">[role=<span class="hljs-string">'link'</span>]</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#004499</span>;
  <span class="hljs-attribute">text-decoration</span>-thickness: <span class="hljs-number">2px</span>;
}

<span class="hljs-comment">/* 已访问状态：使用紫色标识用户已访问的链接 */</span>
<span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:visited</span>,
<span class="hljs-selector-attr">[role=<span class="hljs-string">'link'</span>]</span><span class="hljs-selector-pseudo">:visited</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#551a8b</span>;
}

<span class="hljs-comment">/* 激活状态：点击瞬间的颜色变化 */</span>
<span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:active</span>,
<span class="hljs-selector-attr">[role=<span class="hljs-string">'link'</span>]</span><span class="hljs-selector-pseudo">:active</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#ff0000</span>;
}
</code></pre>
<h4 data-id="heading-10">6.4 避免过度使用 ARIA</h4>
<p>WAI-ARIA 有一条重要原则：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpractices%2Fread-me-first%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/practices/read-me-first/" ref="nofollow noopener noreferrer"><strong>没有 ARIA 比糟糕的 ARIA 更好</strong></a>。在某些情况下，错误使用 ARIA 可能会导致比不使用更糟糕的可访问性体验。只有在确实需要时才使用自定义链接实现。</p>
<h3 data-id="heading-11">七、链接与按钮的区别</h3>
<p>在 Web 开发中，正确区分按钮和链接至关重要。</p>



































<table><thead><tr><th>特性</th><th>链接</th><th>按钮</th></tr></thead><tbody><tr><td>功能</td><td>导航到其他资源</td><td>触发动作</td></tr><tr><td>HTML 元素</td><td><code>&lt;a&gt;</code></td><td><code>&lt;button&gt;</code>、<code>&lt;input type="button"&gt;</code></td></tr><tr><td>键盘激活</td><td>Enter</td><td>Space、Enter</td></tr><tr><td>role 属性</td><td>link</td><td>button</td></tr><tr><td>典型用途</td><td>页面跳转、锚点导航</td><td>提交表单、打开对话框</td></tr></tbody></table>
<h3 data-id="heading-12">八、总结</h3>
<p>构建无障碍的链接组件需要关注多个层面的细节。从语义化角度，应优先使用原生 HTML a 元素；从键盘交互角度，必须支持回车键激活；从 ARIA 属性角度，需要正确使用 role="link" 和可访问名称。</p>
<p>WAI-ARIA Link Pattern 为我们提供了清晰的指导方针，遵循这些规范能够帮助我们创建更加包容和易用的 Web 应用。每一个正确实现的链接组件，都是构建无障碍网络环境的重要一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[耗时 20 天，AI 漫剧 APP 和 Web 全部开源， 已斩获 764 星！]]></title>    <link>https://juejin.cn/post/7600240045366738998</link>    <guid>https://juejin.cn/post/7600240045366738998</guid>    <pubDate>2026-01-28T15:35:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600240045366738998" data-draft-id="7600219080046247979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="耗时 20 天，AI 漫剧 APP 和 Web 全部开源， 已斩获 764 星！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-28T15:35:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            耗时 20 天，AI 漫剧 APP 和 Web 全部开源， 已斩获 764 星！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:35:24.000Z" title="Wed Jan 28 2026 15:35:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 474 篇原创！</p>
<p>大家好，我是消失了一段时间的苍何。</p>
<p>1 月 5 号，我写了篇文章，并开源了 AI 漫剧 APP，获得了很多朋友的喜欢。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87d1b268437f4324bdbf6cc2b867ff67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=wru5ixN9hLIu1MN5zQalUj2yY0Q%3D" alt="图片" loading="lazy"/></p>
<p>然后在 GitHub 上一共获得了 764 星和 181 fork，让我有些吃惊。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6674bf206b3f4bb38f4adccfdd09375c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=SYrmRRTnpOhFG7NbwNVsqjZFMyI%3D" alt="图片" loading="lazy"/></p>
<p>说实话，这个项目远超我们的预期，甚至连歪果哥都来给我们提 issue，希望支持双语。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6068bebc4f5048b4b9c9062b24940633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=roJqrc69eBmVHXysNBnR7Y5HBhY%3D" alt="图片" loading="lazy"/></p>
<p>甚至还有老板来咨询问我卖不卖这个 APP，我说，大哥，咱都开源了，自己去整吧，不用付费，哈哈哈。</p>
<p><strong>这或许就是开源的魅力吧。</strong></p>
<p>但我发现，APP 还是不大方便，评论区也不少求 web 版本的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b78ec091807f4a089db97d69f55b5cd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=l7rtxD%2B8qnJIhStNYhIUo08a0Oo%3D" alt="图片" loading="lazy"/></p>
<p>于是，我们又花了 20 天，开源了个 Web 版本的 AI 漫剧平台，他是长这个样子的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0205d2082434fc89b6e92c1a19fba93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=jdip%2FzjUkIkdV1DIf6Y2fA9YNgY%3D" alt="图片" loading="lazy"/></p>
<p>主打的人群还是对 AI 漫剧感兴趣的小白群体，能够<strong>一句话生成漫剧故事</strong>。</p>
<p>如果你不知道生成什么故事，也可以使用系统内置的模板，比如「马到成功送祝福」、「马上有美食」等新年主题的故事。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cac2544976284a41b186b16ac1e0bfa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=EyQVLECXjpe8ZIph6Q0Ezb69e1M%3D" alt="图片" loading="lazy"/></p>
<p>为了照顾一些朋友想要自由发挥的需求，我们还添加了自定义工作流选项，也就是从创建角色到分镜编排，再到生成镜头，最后导出，都可以自定义。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1aa206712bf4a36a5b9d4fa6b9000be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=rhmPqtV%2B5b555wO7IK4HOwC4SBg%3D" alt="图片" loading="lazy"/></p>
<p>在编排的时候，你可以自定义不同的镜头，比如全景、中景、特写，可以添加镜头和场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ece00e56e15345608d75dc9ea353f5ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=bLSu54he7zFZwSe%2FAGrX30oLFuA%3D" alt="图片" loading="lazy"/></p>
<p>可以生成不同的镜头视频。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3146fb151034b4fbbf9eee72ab10124~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=9nurWApTwE%2FJB%2Fc8xrz%2FNhcUdg8%3D" alt="图片" loading="lazy"/></p>
<p>在底层，做了很多的处理，能保证角色的一致性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01a7a94705de4463836abaab3b721382~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=IuST1eYsWgUD%2BPlytFmmmceWWtE%3D" alt="图片" loading="lazy"/></p>
<p>做了几个系列，分别对应 2D、3D、写实等场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/166ac7c0a2d54678af353579a371cb5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=BucbT97AJDc7BM8BzC%2FR%2BhF9VbU%3D" alt="图片" loading="lazy"/></p>
<p>我们做了非常多深度的调优，在保持人物一致性的同时也添加了不少细节去优化生成的效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98ff76835c664810bc245cc2244f4319~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=laGNqRNZ0MLpE6QLUZrA1HS3fWs%3D" alt="图片" loading="lazy"/></p>
<p>下面，我来分享下在开发这个项目过程中，我们踩过的坑，和一些可能算不上什么经验的经验，另外也教下大家怎么使用。</p>
<blockquote>
<p>创作和开源不易，如果文章对你有帮助，欢迎点赞转发。</p>
</blockquote>
<h2 data-id="heading-0">经验分享</h2>
<p>我感觉最头疼的问题之一是角色一致性问题，也就是角色在不同画面中长得不一样，该如何很好的解决。</p>
<p>我们尝试使用了不少办法，甚至引入了本地 ComfyUI，开启锁定种子，第一张图的种子会被记录，后续所有图使用相同的种子，以保持整体风格的一致性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbed639d07dc4c9ca140e878907f7b30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=vn45dDXvs0eqQ5wiElt9TY9rYYE%3D" alt="图片" loading="lazy"/></p>
<p>总结出角色一致性最佳实践如下：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- 参考图选择：清晰、无遮挡、多角度</span>
<span class="hljs-deletion">- 描述格式：「性别+年龄+发型+发色+眼睛+服装+特征」</span>
<span class="hljs-deletion">- 示例：「25岁女性，黑色长直发，棕色大眼睛，穿白色衬衫和黑色西装裙，戴细框眼镜」</span>
</code></pre>
<p>对于镜头，考虑很多像我一样对运镜不大熟悉的小白，我们内置了 9 种标准镜头模板，AI 根据故事自动选择不同分镜的镜头。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1e8ae7f5e1a4ddb8fa3985ff66253d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=lhRgiIWCOfgJQSHWDwno7XEHUc4%3D" alt="图片" loading="lazy"/></p>
<p>对于生成质量上，有以下几点可以给大家分享：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- 画面描述要具体，避免模糊词汇</span>
<span class="hljs-deletion">- 使用「锁定种子」保持风格统一</span>
<span class="hljs-deletion">- 负面提示词排除不想要的元素</span>
<span class="hljs-deletion">- 多生成几次，选择最满意的</span>
</code></pre>
<p>在镜头节奏上，建议采用如下方式：</p>
<pre><code class="hljs language-markdown" lang="markdown">基本原则：

<span class="hljs-bullet">-</span> 全景→中景→特写（渐进式）
<span class="hljs-bullet">-</span> 对话场景用过肩镜头正反打
<span class="hljs-bullet">-</span> 情绪高潮用特写
<span class="hljs-bullet">-</span> 场景转换用全景或框中框

示例分镜节奏：
<span class="hljs-bullet">1.</span> T1 全景俯瞰 - 城市远景（建立环境）
<span class="hljs-bullet">2.</span> T2 环境中景 - 主角走在街上（角色入场）
<span class="hljs-bullet">3.</span> T4 标准中景 - 主角看手机（日常动作）
<span class="hljs-bullet">4.</span> T6 特写 - 手机屏幕显示消息（信息传递）
<span class="hljs-bullet">5.</span> T6 特写 - 主角惊讶表情（情绪反应）
<span class="hljs-bullet">6.</span> T8 跟随视角 - 主角奔跑（动态转场）
</code></pre>
<h2 data-id="heading-1">如何使用</h2>
<p>我们整理了一份详细的使用指南，还没放到 GitHub，大家如果需要可以评论区留言，或者等我们推到 GitHub 哈。</p>
<p>先来看下整体流程：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[导入剧本]</span> → <span class="hljs-selector-attr">[创建角色]</span> → <span class="hljs-selector-attr">[创建场景]</span> → <span class="hljs-selector-attr">[编排分镜]</span> → <span class="hljs-selector-attr">[生成图片]</span> → <span class="hljs-selector-attr">[生成视频]</span> → <span class="hljs-selector-attr">[导出]</span>
    ↓            ↓            ↓            ↓            ↓            ↓
  (可选)      上传参考图    上传参考图    选择模板      AI生成       (可选)
             填写描述      填写描述      写画面描述    保持一致性
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32bee0c912914af29029f56c3588326f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=Rq4HiXXh37%2B2%2Br%2BMhqllw%2F4yEqQ%3D" alt="图片" loading="lazy"/></p>
<p>生图这里你可以选择本地 ComfyUI 的方式，也可以选择 API 的方式。</p>
<p>这里以 API 为例，如果你希望稳定，性价比高的 API 平台，可以试试 Atlas Cloud。</p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.atlascloud.ai%3Fref%3DAXZ9S7" target="_blank" title="https://www.atlascloud.ai?ref=AXZ9S7" ref="nofollow noopener noreferrer">www.atlascloud.ai?ref=AXZ9S7</a></p>
<p>在漫剧场景中稳定出图出视频很重要，而且对于内容角色的生成，最好避开接口的审查和限制规则。</p>
<p>Atlas Cloud 这个 API 聚合平台能很好的满足漫剧这个场景的需求，毕竟它主打的是企业级 API 聚合，拥有 300+ 知名大模型，总结下来是：<strong>稳定、易用、低价</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee96dd3cb999461e8f9e2b9e5d6ad30b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=vPmg9qd%2BhxGi8TRfp19kOXb3yaE%3D" alt="图片" loading="lazy"/></p>
<p>那该如何使用呢？注册登录后，打开控制台，新建 API 密钥。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2433e95becd4b56960d845bb31e1996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=FaX3ZWMhFWLqHtcP4nzx0TZmuAo%3D" alt="图片" loading="lazy"/></p>
<p>多说一嘴，Atlas Cloud 目前注册绑卡即可白嫖 1 美元使用额度，可以免费生成不少图了。</p>
<p>填写名称后，点击创建：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/700a454d98bd40c3b504fe13ecc444a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=VHNPxkFbb4m%2BzJeIDFtFFYSRLoE%3D" alt="图片" loading="lazy"/></p>
<p>然后复制这个 API，填入到环境变量中：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b6756b1984b4e4e917bf3ef1af8baae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=sfSByKjzlrTQP7Wa8fEtGjejVDU%3D" alt="图片" loading="lazy"/></p>
<p>需要复制一份 env，然后把改调用方式为使用云端 API 的方式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1a3a6f95c854df399f7ff3697c16d41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=eME%2BYM90yPpxiCaO0%2BK8OW5aHz8%3D" alt="图片" loading="lazy"/></p>
<p>然后就可以启动项目，项目启动后，你可以一句话生成故事，也可以按照流程自定义，你可以先创建一个角色并添加场景：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46014f2a1b78445891faf66be2df7ddb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=oJNZxwKrOjglH%2BBrNPRJ5aDpzaY%3D" alt="图片" loading="lazy"/></p>
<p>角色描述和场景描述都可以用 AI 生成，也可以自定义更改。</p>
<p>然后就是对镜头进行编排，可以添加自定义镜头，描述同样也可以 AI 一键生成，不满意可以改。在这里你可以选择需要出镜的角色：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3325638652334daeab18ee3dc5c6b71c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=IVI9xbarxI2E0cKMgv78Ikat3Zg%3D" alt="图片" loading="lazy"/></p>
<p>可以看到已经添加的镜头列表，有专业分镜格式的标准提示语，对于分镜的生成效果会更好。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/364cb87ca8a4446fb1464380bbf1bdc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=6cMEKUkijbH045m02vFxnH8%2Bed0%3D" alt="图片" loading="lazy"/></p>
<p>然后就可以生成镜头和对应的分镜视频：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39b947c6f4914eccbf4e4223e66a6957~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=Jb4NULMnwdlmpFoR0REXBruT5p8%3D" alt="图片" loading="lazy"/></p>
<p>可以选择一键生成全部视频，这里选择 API 的方式来生成。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34791f33acf844f28ae38fa3ae7a001e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=5OLHjRzMJdRA4NyYEN7af%2BAueKM%3D" alt="图片" loading="lazy"/></p>
<p>最后，你可以导出所有的图片包、视频包、分镜脚本，做素材备份，最后就是做视频的合成。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ad26ec3c95d42728246a7a836950836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=0e7Ld8mvV7oLKESbaGhRO0YPdgY%3D" alt="图片" loading="lazy"/></p>
<p>我们做了比较详细的产品特点说明说和使用说明书，目前还在优化中，如果你想提前看看，可以评论区告诉我。</p>
<p>说真的，这套系统，我认为，还是又再次满足了我做漫剧的激情，虽然我们不是专业的漫导，也非该行业的从业者。</p>
<p>但通过 AI 编程，我们也能做出一个，算是能满足我们需求的工具，然后去满足我们做漫剧的心。</p>
<p>因为是开源平台，你可以自定义各种花式玩法，觉得哪儿不满意，甚至可以让 Claude Code 帮你改。</p>
<p>有时候，我觉得 AI 编程最大的价值，或许在于：</p>
<p><strong>满足自己的灵魂，而非取悦别人。</strong></p>
<p>如果你喜欢我们的作品，也欢迎给我们 star，如果你想加入我们平台共建，也欢迎联系我。</p>
<p>目前平台有三个核心贡献者，分别是猫哥，蜗牛和苍何。</p>
<p>我们会在深夜畅聊产品的，沟通如何优化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d276de74e3e9459a88d3a7a83254a22b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=FEj0VG8UoLeIuJUy9yhg%2BjC6v3A%3D" alt="图片" loading="lazy"/></p>
<p>每当在 GitHub 上有新的进步，我们会为此而欢呼，当然，我们今年的目标是破千 star，也不知道能不能完成，哈哈哈。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d676c13181c7475caf6fa9077b9a7733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=%2B1917ZJZYcZ3s5dMsOlFHmZCXtk%3D" alt="图片" loading="lazy"/></p>
<p>当然我知道，我们做的远远不足，很多想要优化的点都还没优化，一方面是因为我们时间精力问题，另一方面，我们对漫剧这个行业的 know how 还有限。</p>
<p>当然了，我也在不断的学习，学习优秀的产品，学习他们如何做出精品的漫剧。</p>
<p>最近也在用 oiioii 来学做精品漫剧，到时候再来和大家分享了。</p>
<p>好啦，最后，如果你有一定的 vibe coding 能力，同时也是 AI 漫剧的热爱者，欢迎加入我们 GitHub 开源项目的共建。</p>
<p>感谢你喜欢我的文章，我们下一期见啦。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥别再用递归了！WeakMap 的影子索引“让树不再是树！”]]></title>    <link>https://juejin.cn/post/7600248718361083946</link>    <guid>https://juejin.cn/post/7600248718361083946</guid>    <pubDate>2026-01-28T15:57:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600248718361083946" data-draft-id="7600223321041862662" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥别再用递归了！WeakMap 的影子索引“让树不再是树！”"/> <meta itemprop="keywords" content="前端,JavaScript,设计模式"/> <meta itemprop="datePublished" content="2026-01-28T15:57:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vilan_微澜"/> <meta itemprop="url" content="https://juejin.cn/user/2225067267199320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥别再用递归了！WeakMap 的影子索引“让树不再是树！”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067267199320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vilan_微澜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:57:10.000Z" title="Wed Jan 28 2026 15:57:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">一、前言</h2>
<p>大家好，我是微澜。今天来分享一个基于 <strong>WeakMap</strong> 实现的<strong>快速对树形结构数据进行增删改查操作</strong>的<code>useTree hook</code>函数，它是基于<code>JavaScript</code> 的 <code>WeakMap</code> 特性，在不改动原始数据的前提下，实现了一套 <strong>O(1)</strong> 查找的<strong>影子索引结构</strong>，这个<strong>影子</strong>其实就是对象的<strong>引用地址</strong>，让树形数据操作像操作数组一样简单！</p>
<h2 data-id="heading-1">二、为什么选择 WeakMap？</h2>
<h3 data-id="heading-2">1. 非侵入性 (Non-invasive)</h3>
<p>通过 <code>WeakMap</code> 在内存中构建了一套 <code>Node -&gt; Parent</code> 的映射。原始数据对象保持纯净，没有任何多余属性，完美支持序列化。</p>
<h3 data-id="heading-3">2. 内存安全 (Memory Safety)</h3>
<p>这是最关键的一点。<code>WeakMap</code> 对键（对象）是<strong>弱引用</strong>的。</p>
<ul>
<li>
<p>如果你删除了原始树中的某个节点，且没有其他地方引用它，垃圾回收器（GC）会自动清理索引表中的对应项。</p>
</li>
<li>
<p>这种特性非常适合处理大型动态树，完全不用担心手动维护索引带来的内存泄漏。</p>
</li>
</ul>
<h3 data-id="heading-4">3、不同实现方案对比</h3>
<p>在开始之前，我们先看看为什么选择 <strong>WeakMap</strong>。我们可以通过一个综合对比来看看<strong>操作树形数据</strong>不同方案的差异：</p>






















































<table><thead><tr><th align="left"><strong>维度 / 方案</strong></th><th align="left"><strong>传统递归遍历</strong></th><th align="left"><strong>节点注入 parent</strong></th><th align="left"><strong>Map 缓存方案</strong></th><th align="left"><strong>WeakMap 优化方案 (本项目)</strong></th></tr></thead><tbody><tr><td align="left"><strong>初始化复杂度</strong></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> (双层循环)</td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span> (单次递归)</strong></td></tr><tr><td align="left"><strong>溯源时间复杂度</strong></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span></span> (D为深度，极快)</strong></td></tr><tr><td align="left"><strong>数据污染</strong></td><td align="left">无</td><td align="left">高（直接修改对象）</td><td align="left">无</td><td align="left"><strong>无（外部映射，保持纯净）</strong></td></tr><tr><td align="left"><strong>内存管理</strong></td><td align="left">差</td><td align="left">一般</td><td align="left">一般 (强引用，需手动清理)</td><td align="left"><strong>优秀（弱引用自动 GC）</strong></td></tr><tr><td align="left"><strong>序列化友好度</strong></td><td align="left">友好</td><td align="left">极差（循环引用）</td><td align="left">友好</td><td align="left"><strong>友好</strong></td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">极小数据量</td><td align="left">中等数据量</td><td align="left">中等数据量</td><td align="left"><strong>大规模数据、高频转换</strong></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">三、核心实现原理</h2>
<h3 data-id="heading-6">1. 整体架构图</h3>
<p>我们通过一个外部的 <code>WeakMap</code> 来存储<strong>节点与其父级的对应关系</strong>。这种设计最大的好处是：“不改变原始树结构，不产生循环引用，且能实现 O(1) 的溯源。”</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[原始树形数据] --&gt; B{useTree Hook}
    B -- "1. 递归扫描" --&gt; C[WeakMap 存储库]

    subgraph "WeakMap 存储策略"
    C -- "Key: 根节点" --&gt; D["Value: 整个 Tree 数组 (方便删除)"]
    C -- "Key: 子节点" --&gt; E["Value: 直接父节点对象 (实现溯源)"]
    end

    F[业务请求: 查找/删除] --&gt; C
    C -- "返回父级引用" --&gt; G[完成操作]
</code></pre>
<h3 data-id="heading-7">2. 数据映射图解 (核心逻辑)</h3>
<p>为了让大家更直观地看到 <code>WeakMap</code> 里到底存了什么，我们看下面这个例子：</p>
<p><strong>示例数据：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> list = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'掘金'</span>,
    <span class="hljs-attr">children</span>: [ { <span class="hljs-attr">id</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'前端组'</span> } ]
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'社区'</span>,
    <span class="hljs-attr">children</span>: []
  }
];
</code></pre>
<p><strong>WeakMap 内部映射关系：</strong></p>





























<table><thead><tr><th align="left">节点 (Key)</th><th align="left">映射值 (Value)</th><th align="left">Value类型</th><th align="left">存储逻辑说明</th></tr></thead><tbody><tr><td align="left"><code>{ id: 11, name: '前端组' }</code></td><td align="left"><code>{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }</code></td><td align="left"><strong>Object (父节点)</strong></td><td align="left"><strong>非根节点</strong>：指向它的直接父对象</td></tr><tr><td align="left"><code>{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }</code></td><td align="left"><code>[{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }, { id: 2, name: '社区', children: [] }]</code></td><td align="left"><strong>Array (根数组)</strong></td><td align="left"><strong>根节点</strong>：指向它所属的整棵树数组</td></tr><tr><td align="left"><code>{ id: 2, name: '社区', children: [] }</code></td><td align="left"><code>[{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }, { id: 2, name: '社区', children: [] }]</code></td><td align="left"><strong>Array (根数组)</strong></td><td align="left"><strong>根节点</strong>：指向它所属的整棵树数组</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>核心秘诀</strong>：
以上设计了一套巧妙的判断规则：如果节点是<strong>根节点</strong>，其映射值就是<strong>数组</strong>；如果节点是<strong>子节点</strong>，其映射值就是<strong>父对象</strong>。
这样在执行 <code>removeChild</code> 时，我们只需要判断 <code>Array.isArray(parent)</code>，就能自动切换“从数组中删除”<strong>根节点</strong>或“从 <code>children</code> 属性中删除”<strong>子节点</strong>的逻辑，极其优雅！</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">四、useTree()实现方法逐一拆解</h2>
<p>接下来，我们看看 <code>useTree</code> 内部每个方法的具体实现原理。</p>
<h3 data-id="heading-9">1. <code>initTree</code> - 初始化索引</h3>
<p><strong>功能</strong>：递归遍历整棵树，建立 <code>WeakMap</code> 映射。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 数据索引对象</span>
<span class="hljs-keyword">const</span> _treeWeakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;<span class="hljs-title class_">TreeNode</span>, <span class="hljs-title class_">TreeNode</span> | <span class="hljs-title class_">TreeNode</span>[]&gt;();

<span class="hljs-keyword">const</span> useTree = (
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">Props</span> = {
    <span class="hljs-comment">// 外部数据对象字段映射</span>
    <span class="hljs-attr">treeNodeProp</span>: {
      <span class="hljs-attr">value</span>: <span class="hljs-string">'value'</span>,
      <span class="hljs-attr">label</span>: <span class="hljs-string">'label'</span>,
      <span class="hljs-attr">children</span>: <span class="hljs-string">'children'</span>,
    }
  }
){
    <span class="hljs-comment">// 初始化树结构索引</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">initTree</span>(<span class="hljs-params">list, parent</span>){...}
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 初始化树结构索引</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">initTree</span>(<span class="hljs-params">list: TreeNode[], parent?: TreeNode</span>) {
    list.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-comment">// 根节点的父级为完整的树数据，在删除根节点时需要通过完整的数组删除</span>
      _treeWeakMap.<span class="hljs-title function_">set</span>(item, parent || list);
      <span class="hljs-keyword">if</span> (item[treeNodeProp.<span class="hljs-property">children</span>]) {
        <span class="hljs-comment">// 删除子节点只需要通过对应子节点的children数组删除</span>
        <span class="hljs-title function_">initTree</span>(item[treeNodeProp.<span class="hljs-property">children</span>], item);
      }
    });
  }
</code></pre>
<p><strong>原理</strong>：在组件挂载或数据更新时调用。通过这种“差异化映射”，我们让每个节点都拥有了一个指向其“归属集合”的指针，也就是指向了<strong>父级的引用地址</strong>。</p>
<p>以上文的表格列出的示例数据为例，调用<code>initTree</code>方法初始化后，可以得到以下对应关系：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph Keys [节点对象 - Key]
        K11("前端组 (id:11)")
        K1("掘金 (id:1)")
        K2("社区 (id:2)")
    end

    subgraph Values [映射值 - Value]
        V_Obj1["父节点对象 (id:1)"]
        V_Arr["根数据数组 [Tree]"]
    end

    K11 -- "指向直接父级" --&gt; V_Obj1
    K1 -- "指向所属根数组" --&gt; V_Arr
    K2 -- "指向所属根数组" --&gt; V_Arr

    style K11 fill:#f9f,stroke:#333
    style K1 fill:#bbf,stroke:#333
    style K2 fill:#bbf,stroke:#333
    style V_Arr fill:#dfd,stroke:#333
    style V_Obj1 fill:#fff,stroke:#333
</code></pre>
<h3 data-id="heading-10">2. <code>_setParent</code> - 节点索引设置</h3>
<p><strong>功能</strong>：建立节点与其所属容器（父节点对象或根数组）的映射关系。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 设置节点的父节点映射。为防止用户错误使用，不向外暴露，内部使用</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_setParent</span>(<span class="hljs-params">node: TreeNode, parent: TreeNode | TreeNode[]</span>) {
    _treeWeakMap.<span class="hljs-title function_">set</span>(node, parent);
  }
</code></pre>
<p><strong>原理</strong>：这是对 <code>WeakMap.set</code> 的一层简单封装。通过这种方式，我们将节点对象引用作为 <code>Key</code>，其父级引用作为 <code>Value</code> 存入索引库。通过<code>_</code>前缀标记为<strong>私有</strong>是为了防止外部直接篡改映射关系，保证索引的单一可靠性。</p>
<h3 data-id="heading-11">3. <code>getParent</code> - 获取父节点</h3>
<p><strong>功能</strong>：获取指定节点的直接父节点。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 获取节点的父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParent</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-keyword">return</span> _treeWeakMap.<span class="hljs-title function_">get</span>(node);
  }
</code></pre>
<ul>
<li><strong>原理</strong>：利用 <code>WeakMap.get</code> 直接获取。时间复杂度为 <strong>O(1)</strong>。</li>
</ul>
<h3 data-id="heading-12">4. <code>getParents</code> - 获取全路径父节点</h3>
<p><strong>功能</strong>：递归向上检索父级，获取从当前节点到根部的所有父节点数组。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 获取节点的所有父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParents</span>(<span class="hljs-params">item: TreeNode, parentList: (TreeNode | <span class="hljs-built_in">string</span>)[] = [], key?: <span class="hljs-built_in">string</span></span>): (<span class="hljs-title class_">TreeNode</span> | <span class="hljs-built_in">string</span>)[] {
    <span class="hljs-keyword">const</span> parent = _treeWeakMap.<span class="hljs-title function_">get</span>(item);
    <span class="hljs-comment">// 递归到根节点数组时停止</span>
    <span class="hljs-keyword">if</span> (parent &amp;&amp; !<span class="hljs-title function_">_isRootNode</span>(parent)) {
      parentList.<span class="hljs-title function_">push</span>(key ? parent[key] : parent);
      <span class="hljs-title function_">getParents</span>(parent, parentList, key);
    }
    <span class="hljs-keyword">return</span> parentList;
  }
  
  <span class="hljs-comment">// 判断是否根节点，下文都用这个方法判断是否根节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_isRootNode</span>(<span class="hljs-params">node: TreeNode | TreeNode[]</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(node);
  }
</code></pre>
<p><strong>原理</strong>：通过节点自身的引用地址在<code>WeakMap</code>中查找父级。相比于<code>DFS</code>(深度优先遍历)全树，这种<strong>垂直爬升</strong>的方式效率极高。
什么是<strong>垂直爬升</strong>？</p>
<p><strong>类似于：</strong></p>
<blockquote>
<p><code>show code is me.parent.parent.  ......</code></p>
</blockquote>
<p>就这样，连祖宗十八代都能给你扒出来！</p>
<h3 data-id="heading-13">5. <code>addChild</code> - 动态添加节点</h3>
<p><strong>功能</strong>：向指定节点添加子节点，并自动更新索引。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 添加子节点或根节点，节点不存在.children时，代表添加到根节点数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">addChild</span>(<span class="hljs-params">node: TreeNode, child: TreeNode</span>) {
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(node)) {
      <span class="hljs-comment">// 根节点数组直接添加</span>
      <span class="hljs-keyword">const</span> i = node.<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">/**
       * 为新增加的子节点构建一个WeakMap索引，指向父节点
       * 注意：注册为key的引用地址是经过proxy处理后的节点
       */</span>
      node[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node[i], node);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 非根节点，添加到children数组</span>
      <span class="hljs-keyword">if</span> (!node[treeNodeProp.<span class="hljs-property">children</span>]) {
        node[treeNodeProp.<span class="hljs-property">children</span>] = [];
      }
      <span class="hljs-keyword">const</span> i = node[treeNodeProp.<span class="hljs-property">children</span>].<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">// 和上面设置根节点同理</span>
      node.<span class="hljs-property">children</span>[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node.<span class="hljs-property">children</span>[i], node);
    }
  }
</code></pre>
<p><strong>原理</strong>：在操作原始数据的同时，同步更新 <code>WeakMap</code>索引。也就是为新增的对象建立父级索引。</p>
<p><strong>注意</strong>：这里不能把新添加的<code>child</code>对象当做<code>WeakMap</code>的<code>Key</code>，因为<code>child</code>只是一个外部传入的一个<strong>临时变量</strong>，还没有和整棵树建立联系，需要在添加到树当中后，获取<strong>树当中的对象地址</strong>作为<code>Key</code>建立索引。</p>
<h3 data-id="heading-14">6. <code>removeChild</code> - 删除指定节点</h3>
<p><strong>功能</strong>：无痛删除任意节点，无需手动遍历查找。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 删除指定子节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">removeChild</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-comment">// 找到父节点，通过父节点删除</span>
    <span class="hljs-keyword">const</span> parent = <span class="hljs-title function_">getParent</span>(node);
    <span class="hljs-keyword">if</span>(!parent) {
      <span class="hljs-comment">// 没有找到父级节点，抛出错误</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到父级节点！'</span>);
    }
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(parent)) {
      <span class="hljs-comment">// 删除根节点</span>
      <span class="hljs-keyword">const</span> index = parent.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item === node);
      <span class="hljs-keyword">if</span>(index &gt;= <span class="hljs-number">0</span>) {
        parent.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有找到要删除的根节点，抛出错误</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到要删除的根节点！'</span>);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 通过找到父级删除自己</span>
      parent.<span class="hljs-property">children</span> = parent.<span class="hljs-property">children</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item !== node);
    }
  }
</code></pre>
<p><strong>原理</strong>：这是该方案最精妙的地方！通过 <code>initTree</code> 建立的差异化映射，我们只需要简单的 <code>Array.isArray</code> 判断，就能准确找到节点所在的“容器”，实现秒删。</p>
<hr/>
<h2 data-id="heading-15">五、完整代码实现</h2>
<p>代码不多，却能<strong>快速~</strong>实现对树形数据的增删改查操作。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// useTree.ts</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Props</span> = {
  <span class="hljs-comment">// 树形数据字段名映射类型</span>
  <span class="hljs-attr">treeNodeProp</span>: <span class="hljs-title class_">TreeNodeProp</span>
}

<span class="hljs-comment">// 树节点属性映射类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TreeNodeProp</span> = {
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">children</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 数节点</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TreeNode</span> = <span class="hljs-built_in">any</span>

<span class="hljs-comment">/**
 * 树结构索引数据
 * key为节点本身，value为父节点或根节点数组(即整棵树)
 * 如果value为Array，代表根节点数组
 * 如果value为Object，代表子节点
 */</span>
<span class="hljs-keyword">const</span> _treeWeakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;<span class="hljs-title class_">TreeNode</span>, <span class="hljs-title class_">TreeNode</span> | <span class="hljs-title class_">TreeNode</span>[]&gt;();

<span class="hljs-comment">// 使用weakmap构建树形数据数据索引</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTree</span> = (<span class="hljs-params">
  props: Props = {
    // 外部数据对象字段映射
    treeNodeProp: {
      value: <span class="hljs-string">'value'</span>,
      label: <span class="hljs-string">'label'</span>,
      children: <span class="hljs-string">'children'</span>,
    }
  }
</span>) =&gt; {
  <span class="hljs-keyword">const</span> { treeNodeProp } = props;

  <span class="hljs-comment">// 设置节点的父节点映射。为防止用户错误使用，不向外暴露，内部使用</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_setParent</span>(<span class="hljs-params">node: TreeNode, parent: TreeNode | TreeNode[]</span>) {
    _treeWeakMap.<span class="hljs-title function_">set</span>(node, parent);
  }

  <span class="hljs-comment">// 判断是否根节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_isRootNode</span>(<span class="hljs-params">node: TreeNode | TreeNode[]</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(node);
  }

  <span class="hljs-comment">// 初始化树结构索引</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">initTree</span>(<span class="hljs-params">list: TreeNode[], parent?: TreeNode</span>) {
    list.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-comment">// 根节点的父级为完整的树数据，在删除根节点时需要通过完整的数组删除</span>
      _treeWeakMap.<span class="hljs-title function_">set</span>(item, parent || list);
      <span class="hljs-keyword">if</span> (item[treeNodeProp.<span class="hljs-property">children</span>]) {
        <span class="hljs-comment">// 删除子节点只需要通过对应子节点的children数组删除</span>
        <span class="hljs-title function_">initTree</span>(item[treeNodeProp.<span class="hljs-property">children</span>], item);
      }
    });
  }

  <span class="hljs-comment">// 添加子节点或根节点，节点不存在.children时，代表添加到根节点数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">addChild</span>(<span class="hljs-params">node: TreeNode, child: TreeNode</span>) {
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(node)) {
      <span class="hljs-comment">// 根节点数组直接添加</span>
      <span class="hljs-keyword">const</span> i = node.<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">/**
       * 为新增加的子节点构建一个WeakMap索引，指向父节点
       * 注意：注册为key的引用地址是经过proxy处理后的节点
       */</span>
      node[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node[i], node);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 非根节点，添加到children数组</span>
      <span class="hljs-keyword">if</span> (!node[treeNodeProp.<span class="hljs-property">children</span>]) {
        node[treeNodeProp.<span class="hljs-property">children</span>] = [];
      }
      <span class="hljs-keyword">const</span> i = node[treeNodeProp.<span class="hljs-property">children</span>].<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">// 和上面设置根节点同理</span>
      node.<span class="hljs-property">children</span>[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node.<span class="hljs-property">children</span>[i], node);
    }
  }

  <span class="hljs-comment">// 删除指定子节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">removeChild</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-comment">// 找到父节点，通过父节点删除</span>
    <span class="hljs-keyword">const</span> parent = <span class="hljs-title function_">getParent</span>(node);
    <span class="hljs-keyword">if</span>(!parent) {
      <span class="hljs-comment">// 没有找到父级节点，抛出错误</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到父级节点！'</span>);
    }
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(parent)) {
      <span class="hljs-comment">// 删除根节点</span>
      <span class="hljs-keyword">const</span> index = parent.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item === node);
      <span class="hljs-keyword">if</span>(index &gt;= <span class="hljs-number">0</span>) {
        parent.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有找到要删除的根节点，抛出错误</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到要删除的根节点！'</span>);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 通过找到父级删除自己</span>
      parent.<span class="hljs-property">children</span> = parent.<span class="hljs-property">children</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item !== node);
    }
  }

  <span class="hljs-comment">// 获取节点的父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParent</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-keyword">return</span> _treeWeakMap.<span class="hljs-title function_">get</span>(node);
  }

  <span class="hljs-comment">// 获取节点的所有父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParents</span>(<span class="hljs-params">item: TreeNode, parentList: (TreeNode | <span class="hljs-built_in">string</span>)[] = [], key?: <span class="hljs-built_in">string</span></span>): (<span class="hljs-title class_">TreeNode</span> | <span class="hljs-built_in">string</span>)[] {
    <span class="hljs-keyword">const</span> parent = _treeWeakMap.<span class="hljs-title function_">get</span>(item);
    <span class="hljs-comment">// 递归到根节点数组时停止</span>
    <span class="hljs-keyword">if</span> (parent &amp;&amp; !<span class="hljs-title function_">_isRootNode</span>(parent)) {
      parentList.<span class="hljs-title function_">push</span>(key ? parent[key] : parent);
      <span class="hljs-title function_">getParents</span>(parent, parentList, key);
    }
    <span class="hljs-keyword">return</span> parentList;
  }

  <span class="hljs-comment">// 获取节点的所有父节点label数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParentLabels</span>(<span class="hljs-params">item: TreeNode, labelList: <span class="hljs-built_in">string</span>[] = []</span>): <span class="hljs-built_in">string</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getParents</span>(item, labelList, treeNodeProp.<span class="hljs-property">label</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[];
  }

  <span class="hljs-comment">// 获取节点的所有父节点value数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParentValues</span>(<span class="hljs-params">item: TreeNode, valueList: <span class="hljs-built_in">string</span>[] = []</span>): <span class="hljs-built_in">string</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getParents</span>(item, valueList, treeNodeProp.<span class="hljs-property">value</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[];
  }

  <span class="hljs-keyword">return</span> {
    getParents,
    getParentLabels,
    getParentValues,
    getParent,
    initTree,
    addChild,
    removeChild,
  };
};

</code></pre>
<h2 data-id="heading-16">六、总结</h2>
<p>通过 <code>WeakMap</code> 实现的 <code>useTree</code>，核心优势在于<strong>解耦</strong>。它将“业务数据”与“层级关系”分离开来，既保证了数据的纯净，又获得了极高的查找性能。</p>
<p><code>WeakMap</code> 作为一个<strong>容易被忽视</strong>的原生特性，在处理这类关联<strong>关系映射</strong>时有着天然的优势。</p>
<p>如果你也在为<strong>复杂树结构</strong>的管理发愁，不妨尝试下这种“<strong>影子索引</strong>”的思路。</p>
<p>如有不足或可优化的地方，欢迎在评论区交流讨论，如果觉得有用，点个👍也挺好的！👏</p>
<p><strong>如果你在处理大型树形表格或复杂的组织架构，这个 Hook 绝对是你的提效神器！</strong></p>
<h2 data-id="heading-17">七、预览和源码地址</h2>
<h4 data-id="heading-18">多场景演示 (Demo)</h4>
<ul>
<li>
<p><strong>项目预览总入口</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2F" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
<li>
<p><strong>原生 HTML 版本</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2Fhtml%2Findex.html" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/html/index.html" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
<li>
<p><strong>Vue 3 + Element+ 版本</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2Fvue%2Findex.html" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/vue/index.html" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
<li>
<p><strong>React + AntD 版本</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2Freact%2Findex.html" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/react/index.html" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
</ul>
<h4 data-id="heading-19">项目源码地址</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjava6688%2FTree_By_WeakMap" target="_blank" title="https://github.com/java6688/Tree_By_WeakMap" ref="nofollow noopener noreferrer">github：https://github.com/java6688/Tree_By_WeakMap</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ从实战到源码：SpringBoot整合RocketMQ]]></title>    <link>https://juejin.cn/post/7600060691350470698</link>    <guid>https://juejin.cn/post/7600060691350470698</guid>    <pubDate>2026-01-28T14:18:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350470698" data-draft-id="7600240045366591542" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ从实战到源码：SpringBoot整合RocketMQ"/> <meta itemprop="keywords" content="后端,RocketMQ"/> <meta itemprop="datePublished" content="2026-01-28T14:18:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怒放吧德德"/> <meta itemprop="url" content="https://juejin.cn/user/2502950820787672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ从实战到源码：SpringBoot整合RocketMQ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2502950820787672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怒放吧德德
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:18:42.000Z" title="Wed Jan 28 2026 14:18:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RocketMQ从实战到源码：SpringBoot整合RocketMQ</h2>
<blockquote>
<p>😄生命不息，写作不止</p>
<p>🔥 继续踏上学习之路，学之分享笔记</p>
<p>👊 总有一天我也能像各位大佬一样</p>
<p>🏆 <a href="https://juejin.cn/user/2502950820787672" target="_blank" title="https://juejin.cn/user/2502950820787672">博客首页</a>   <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Flyd-code%2F" target="_blank" title="https://www.cnblogs.com/lyd-code/" ref="nofollow noopener noreferrer">@怒放吧德德</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Flydandtry.github.io%2F" target="_blank" title="https://lydandtry.github.io/" ref="nofollow noopener noreferrer">To记录领地</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43843951%3Ftype%3Dblog" target="_blank" title="https://blog.csdn.net/qq_43843951?type=blog" ref="nofollow noopener noreferrer">@一个有梦有戏的人</a></p>
<p>🌝分享学习心得，欢迎指正，大家一起学习成长！</p>
</blockquote>
<p><em>转发请携带作者信息</em>  <strong>@怒放吧德德(掘金) @一个有梦有戏的人(CSDN)</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c33ed4ee428469db4621f0d3f673b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770214722&amp;x-signature=GbDQMs9j51WT9%2BOtBqvLxwFWMVI%3D" alt="rocketmq封面.png" loading="lazy"/></p>
<h3 data-id="heading-1">前言</h3>
<p>在微服务架构中，消息中间件是实现服务解耦、削峰填谷、异步通信的核心组件，而 RocketMQ 作为阿里开源的高性能、高可靠分布式消息中间件，凭借高吞吐量、低延迟、强一致性等特性，广泛应用于各类分布式系统。SpringBoot 则以“约定大于配置”的理念，极大简化了第三方组件的整合成本。本文将从实操角度出发，详细讲解 RocketMQ 与 SpringBoot 的完整整合流程，包含环境准备、依赖配置、生产者/消费者实现、测试验证，以及常见问题排查，适合新手快速上手，也可作为开发参考手册。</p>
<h3 data-id="heading-2">1 整合 SpringBoot</h3>
<h4 data-id="heading-3">1.1 环境</h4>
<p>rocketmq: 2.2.3 RocketMQ 与 SpringBoot 的整合依赖官方提供的 starter 组件，版本适配至关重要，否则会出现自动配置失效、Bean 注入失败等问题。本文选用业内稳定兼容版本组合（新手直接照搬即可），版本对应关系参考 Apache RocketMQ 官方兼容性矩阵：</p>
<ul>
<li>JDK：17（需要 1.8+，RocketMQ 对 JDK 11+ 兼容性一般，生产环境优先选用 JDK 8，避免踩坑）</li>
<li>SpringBoot：2.7.x（稳定版，避免使用 3.x 版本，与 RocketMQ starter 存在兼容断点）</li>
<li>RocketMQ：4.9.7（稳定版，社区长期维护，适配 SpringBoot 2.7.x）</li>
<li>RocketMQ SpringBoot Starter：2.2.3（如果使用 2.3 的版本，jdk 需要 17，并且 springboot 需要 3.0 以上）</li>
<li>Maven：3.6+（项目构建工具）</li>
</ul>
<h4 data-id="heading-4">1.2 引入依赖</h4>
<p>创建 SpringBoot 项目，引入 RocketMQ 整合依赖，核心是 RocketMQ 官方提供的 spring-boot-starter，无需手动引入原生 RocketMQ 客户端依赖，starter 会自动完成依赖管理和自动配置。</p>
<pre><code class="hljs language-java" lang="java">&lt;!-- RocketMQ 依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;
    &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;<span class="hljs-number">2.2</span><span class="hljs-number">.3</span>&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h4 data-id="heading-5">1.3 配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># rocketmq 配置项，对应 RocketMQProperties 配置类</span>
<span class="hljs-attr">rocketmq:</span>
  <span class="hljs-attr">name-server:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.109</span><span class="hljs-number">.134</span><span class="hljs-string">:9876</span> <span class="hljs-comment"># RocketMQ Namesrv</span>
  <span class="hljs-comment"># Producer 配置项 （只有配置了生产者，才会初始化RocketMQTemplate）</span>
  <span class="hljs-attr">producer:</span>
    <span class="hljs-attr">group:</span> <span class="hljs-string">demo-spring-group</span> <span class="hljs-comment"># 生产者分组(自定义)</span>
    <span class="hljs-attr">send-message-timeout:</span> <span class="hljs-number">3000</span> <span class="hljs-comment"># 发送消息超时时间，单位：毫秒。默认为 3000 。</span>
    <span class="hljs-attr">compress-message-body-threshold:</span> <span class="hljs-number">4096</span> <span class="hljs-comment"># 消息压缩阀值，当消息体的大小超过该阀值后，进行消息压缩。默认为 4 * 1024B</span>
    <span class="hljs-attr">max-message-size:</span> <span class="hljs-number">4194304</span> <span class="hljs-comment"># 消息体的最大允许大小。。默认为 4 * 1024 * 1024B</span>
    <span class="hljs-attr">retry-times-when-send-failed:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 同步发送消息时，失败重试次数。默认为 2 次。</span>
    <span class="hljs-attr">retry-times-when-send-async-failed:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 异步发送消息时，失败重试次数。默认为 2 次。</span>
    <span class="hljs-attr">retry-next-server:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 发送消息给 Broker 时，如果发送失败，是否重试另外一台 Broker 。默认为 false</span>
    <span class="hljs-attr">access-key:</span> <span class="hljs-comment"># Access Key ，可阅读 https://github.com/apache/rocketmq/blob/master/docs/cn/acl/user_guide.md 文档</span>
    <span class="hljs-attr">secret-key:</span> <span class="hljs-comment"># Secret Key</span>
    <span class="hljs-attr">enable-msg-trace:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 是否开启消息轨迹功能。默认为 true 开启。可阅读 https://github.com/apache/rocketmq/blob/master/docs/cn/msg_trace/user_guide.md 文档</span>
    <span class="hljs-attr">customized-trace-topic:</span> <span class="hljs-string">RMQ_SYS_TRACE_TOPIC</span> <span class="hljs-comment"># 自定义消息轨迹的 Topic 。默认为 RMQ_SYS_TRACE_TOPIC 。</span>
  <span class="hljs-comment"># Consumer 配置项 (可以不在这里配置，不在这里配置需要在注解中配置)</span>

</code></pre>
<p>启动类不需要配置，就跟使用 redis 一样。</p>
<h4 data-id="heading-6">1.4 代码</h4>
<p>简单进行操作，做个简单的消费者和生产者进行测试。</p>
<p>构建一个消息类，实际开发中常发送对象消息（如订单信息、用户信息），需创建实体类并实现 Serializable 接口（避免序列化失败）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo01Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SPRING-DEMO-01"</span>;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Demo01Message{"</span> +
        <span class="hljs-string">"id="</span> + id +
        <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<p>生产者代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;

    <span class="hljs-comment">/**
     * 同步
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> SendResult <span class="hljs-title function_">syncSend</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-comment">// 创建 Demo01Message 消息</span>
        <span class="hljs-type">Demo01Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo01Message</span>();
        message.setId(id);
        <span class="hljs-comment">// 同步发送消息</span>
        <span class="hljs-keyword">return</span> rocketMQTemplate.syncSend(Demo01Message.TOPIC, message);
    }

    <span class="hljs-comment">/**
     * 异步
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@param</span> callback 回调
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncSend</span><span class="hljs-params">(Integer id, SendCallback callback)</span> {
        <span class="hljs-comment">// 创建 Demo01Message 消息</span>
        <span class="hljs-type">Demo01Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo01Message</span>();
        message.setId(id);
        rocketMQTemplate.asyncSend(Demo01Message.TOPIC, message, callback);
    }

    <span class="hljs-comment">/**
     * 单向发送
     * <span class="hljs-doctag">@param</span> id
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onewaySend</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-comment">// 创建 Demo01Message 消息</span>
        <span class="hljs-type">Demo01Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo01Message</span>();
        message.setId(id);
        rocketMQTemplate.sendOneWay(Demo01Message.TOPIC, message);
    }

}
</code></pre>
<p>通过使用 <code>RocketMQTemplate</code>进行发送消息，以上案例测试了 3 种消息发送方式（同步、异步、单向）。</p>
<p>消费者代码</p>
<p>:::info
SpringBoot 整合 RocketMQ 后，消费者无需手动启动监听，只需创建一个监听类，实现 RocketMQListener 接口，并用 @RocketMQMessageListener 注解指定订阅的主题和消费者组，Spring 会自动扫描并启动监听。</p>
<p>:::</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RocketMQMessageListener(topic = Demo01Message.TOPIC,
        consumerGroup = "GROUP-" + Demo01Message.TOPIC)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;Demo01Message&gt; {
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        log.info(<span class="hljs-string">"消费者监听已启动..."</span>);
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Demo01Message messageExt)</span> {
        log.info(<span class="hljs-string">"[消费者][线程号:{} 监听到消息：{}]"</span>, Thread.currentThread().getId(), messageExt);
    }
}
</code></pre>
<blockquote>
<p>注：这个 onMessage 的类型 Demo01Message 可以放原来的类 MessageExt</p>
</blockquote>
<p>消费者的声明的所有属性通过@RocketMQMessageListener注解声明，实现 RocketMQListener 接口。</p>
<p>我们构建一个测试类进行擦看测试结果</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RocketProducerTest</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Producer producer;

    <span class="hljs-comment">/**
     * 测试同步发送
     */</span>
    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSyncSend</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (System.currentTimeMillis() / <span class="hljs-number">1000</span>);
        <span class="hljs-type">SendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> producer.syncSend(id);
        log.info(<span class="hljs-string">"[测试同步发送][发送编号：[{}] 发送结果：[{}]]"</span>, id, result);

        <span class="hljs-comment">// 阻塞等待，保证消费</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>).await();
    }

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAsyncSend</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (System.currentTimeMillis() / <span class="hljs-number">1000</span>);
        producer.asyncSend(id, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendCallback</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(SendResult sendResult)</span> {
                log.info(<span class="hljs-string">"[测试异步发送][发送编号：[{}] 发送成功，结果为：[{}]]"</span>, id, sendResult);
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onException</span><span class="hljs-params">(Throwable throwable)</span> {
                log.info(<span class="hljs-string">"[testASyncSend][发送编号：[{}] 发送异常]]"</span>, id, throwable);
            }
        });


        <span class="hljs-comment">// 阻塞等待，保证消费</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>).await();
    }

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOnewaySend</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (System.currentTimeMillis() / <span class="hljs-number">1000</span>);

        producer.onewaySend(id);
        log.info(<span class="hljs-string">"[测试异步发送][发送编号：[{}] 发送成功, 不关心是否被消费！"</span>, id);
        <span class="hljs-comment">// 阻塞等待，保证消费</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>).await();
    }

}
</code></pre>
<p>运行结果</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3dd8b8eab8b4270bcaee5d0eb36d0e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770214722&amp;x-signature=PSumvrNM84PaFXFGvRDE7kGcMIk%3D" alt="" loading="lazy"/></p>
<p>更多案例查看 gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fliyongde%2Fjava-trial%2Ftree%2Fmaster%2FTrial1-RocketMQ%2FTrial1-RocketMQ-Demo1" target="_blank" title="https://gitee.com/liyongde/java-trial/tree/master/Trial1-RocketMQ/Trial1-RocketMQ-Demo1" ref="nofollow noopener noreferrer">rocketmq-demo</a></p>
<h3 data-id="heading-7">2 相关配置</h3>
<p>结合前文配置文件，补充 RocketMQ 与 SpringBoot 整合的核心配置说明（对应 application.yml），帮助大家根据业务场景灵活调整，避免盲目配置：</p>















































<table><thead><tr><th><strong>配置项</strong></th><th><strong>含义</strong></th><th><strong>默认值</strong></th><th><strong>使用场景</strong></th></tr></thead><tbody><tr><td>rocketmq.name-server</td><td>NameServer 地址，生产者/消费者通过该地址找到 Broker</td><td>无（必配）</td><td>单机/集群部署均需配置，集群用分号分隔多个地址</td></tr><tr><td>rocketmq.producer.group</td><td>生产者组名称，同类生产者归为一组</td><td>无（必配）</td><td>用于容错和负载均衡，不可与消费者组重名</td></tr><tr><td>rocketmq.consumer.group</td><td>消费者组名称，同类消费者归为一组</td><td>无（必配）</td><td>集群模式下分摊消费，广播模式下仅用于标识</td></tr><tr><td>rocketmq.consumer.message-model</td><td>消费模式，CLUSTERING（集群）/BROADCASTING（广播）</td><td>CLUSTERING</td><td>集群模式：一条消息仅被组内一个消费者消费；广播模式：组内所有消费者都能收到</td></tr><tr><td>rocketmq.producer.retry-times-when-send-failed</td><td>同步发送失败重试次数（不含第一次发送）</td><td>2</td><td>网络波动、Broker 繁忙时，提高消息发送成功率</td></tr><tr><td>rocketmq.consumer.consume-message-batch-max-size</td><td>每次批量消费的消息数量</td><td>1</td><td>消息量大时，调大该值提高消费效率（不宜过大，避免内存溢出）</td></tr></tbody></table>
<h3 data-id="heading-8">3 常见问题与注意事项（避坑重点）</h3>
<p>整合过程中，新手容易遇到各类问题，以下是高频问题及解决方案，结合参考资料中的兼容问题和实操踩坑经验整理：</p>
<h4 data-id="heading-9">3.1 常见问题及解决方案</h4>
<ul>
<li>问题1：项目启动失败，提示“Could not autowire. No beans of 'RocketMQTemplate' type found” 解决方案：检查 RocketMQ starter 依赖是否引入，版本是否与 SpringBoot 适配（SpringBoot 2.7.x 对应 starter 2.2.3+）；检查配置文件中 rocketmq.name-server 是否配置正确。</li>
<li>问题2：消息发送成功，但消费者收不到消息 解决方案：① 检查生产者和消费者的 topic 是否一致；② 检查消费者组名称是否与 application.yml 中配置的一致；③ 检查消费模式是否正确，集群模式下若多个消费者实例，消息会分摊消费，可关闭其他实例重试；④ 检查 RocketMQ 服务是否正常运行，NameServer 与 Broker 连接是否正常。</li>
<li>问题3：发送对象消息时，消费者接收失败，提示“序列化失败” 解决方案：实体类必须实现 Serializable 接口；确保生产者和消费者的实体类全路径一致（包名、类名完全相同）；避免实体类中存在不可序列化的字段（如 transient 修饰的字段）。</li>
<li>问题4：项目启动失败，提示“ApplicationContext 初始化失败” 解决方案：大概率是版本不兼容，SpringBoot 2.7.x 不可使用低于 2.2.3 版本的 RocketMQ starter；避免混合使用不同版本的 Spring 相关依赖。</li>
<li>问题5：消息消费失败，无法触发重试 解决方案：消费方法中若出现异常，需手动抛出 RuntimeException（不可捕获后不抛出），Spring 会感知异常并触发重试；检查重试次数配置（默认16次），重试达到上限后消息会进入死信队列。</li>
</ul>
<h4 data-id="heading-10">3.2 注意事项</h4>
<ul>
<li>版本适配是关键：严格按照本文推荐的版本组合配置，避免因版本不兼容导致各类异常，具体可参考 Apache RocketMQ 官方兼容性矩阵。</li>
<li>组名称规范：生产者组和消费者组不可重名，同一业务场景的生产者/消费者归为同一组，不同业务场景使用不同的组名称。</li>
<li>生产环境配置：生产环境中，需关闭 Broker 的 autoCreateTopicEnable 配置，提前手动创建主题和队列；消息发送失败需做降级处理（如存入数据库，后续补偿发送），避免消息丢失。</li>
<li>消息重试与死信队列：消费失败会触发重试，重试达到上限后消息进入死信队列（DLQ），需手动处理死信队列中的消息，避免数据丢失。</li>
<li>配置文件规范：尽量避免硬编码，消费者组、主题等可通过配置文件读取，方便后续环境切换（开发/测试/生产）。</li>
</ul>
<blockquote>
<p>整合 springboot 是很简单的，使用方法跟 redis 类似，主要是需要了解在什么场景用什么消息发送机制，以及消息发送机制可能会影响的效率。</p>
</blockquote>
<h3 data-id="heading-11">4 总结</h3>
<p>本文详细讲解了 RocketMQ 与 SpringBoot 的完整整合流程，从环境准备、依赖配置、生产者/消费者实现，到测试验证和避坑指南，全程贴合开发实际场景，突出实操性。核心亮点是利用 SpringBoot 的自动配置特性，通过 RocketMQTemplate 和 @RocketMQMessageListener 注解，摒弃了原生 API 繁琐的实例创建和配置，让开发者能够快速实现消息的发送与接收。</p>
<p>整合的核心要点的是“版本适配”和“配置规范”，只要严格遵循本文的版本组合和配置要求，就能顺利完成整合。后续可基于本文的基础，扩展 RocketMQ 的高级功能，如事务消息、延迟消息、消息过滤等，适配更复杂的业务场景（如分布式事务、定时任务通知等）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderAgent Nexus 版本核心场景测试报告]]></title>    <link>https://juejin.cn/post/7600060691350487082</link>    <guid>https://juejin.cn/post/7600060691350487082</guid>    <pubDate>2026-01-28T14:31:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350487082" data-draft-id="7600248718360936490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderAgent Nexus 版本核心场景测试报告"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-28T14:31:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderAgent Nexus 版本核心场景测试报告
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:31:28.000Z" title="Wed Jan 28 2026 14:31:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ooderAgent Nexus 版本核心场景测试报告</h2>
<h3 data-id="heading-1">报告概述</h3>
<p>本报告基于 ooderAgent Nexus 版本（v0.6.5）的核心功能测试，涵盖了 5 个关键场景的验证结果。旨在为系统的生产环境落地提供技术依据。</p>
<h3 data-id="heading-2">一、服务发现测试：P2P 网络基础能力</h3>
<h4 data-id="heading-3">测试目的</h4>
<p>验证基于 UDP 广播的服务发现机制在局域网环境下的可靠性和效率。</p>
<h4 data-id="heading-4">测试内容</h4>
<ol>
<li>单台 End Agent 服务发现测试</li>
<li>10 台 End Agent 同时服务发现测试</li>
<li>网络波动场景下的服务发现恢复测试</li>
</ol>
<h4 data-id="heading-5">测试流程图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dff04e953411426b95c71b9b02fb27a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216461&amp;x-signature=CWojqBzNvk8Yvh%2FMlQ2Zgw7UY6A%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-6">测试结果</h4>





























<table><thead><tr><th align="left">测试项</th><th align="left">测试结果</th><th align="left">响应时间</th><th align="left">成功率</th></tr></thead><tbody><tr><td align="left">单台 End Agent 发现</td><td align="left">✅ 通过</td><td align="left">127ms</td><td align="left">100%</td></tr><tr><td align="left">10 台 End Agent 同时发现</td><td align="left">✅ 通过</td><td align="left">平均 183ms</td><td align="left">100%</td></tr><tr><td align="left">网络波动恢复</td><td align="left">✅ 通过</td><td align="left">231ms</td><td align="left">100%</td></tr></tbody></table>
<h4 data-id="heading-7">技术验证</h4>
<p>服务发现机制在局域网环境下表现稳定，响应时间符合预期，能够快速发现和加入网络。UDP 广播方式实现简单、轻量，适合个人和小型企业部署。</p>
<h3 data-id="heading-8">二、代理层次测试：三层架构协同能力</h3>
<h4 data-id="heading-9">测试目的</h4>
<p>验证 MCP Agent → Route Agent → End Agent 三层架构的协同工作能力和消息传递机制。</p>
<h4 data-id="heading-10">测试内容</h4>
<ol>
<li>三层 Agent 消息传递测试</li>
<li>Route Agent 场景管理测试</li>
<li>MCP Agent 资源管理测试</li>
</ol>
<h4 data-id="heading-11">测试流程图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0395ff4b3cf4b7680bb6ad745d0f325~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216461&amp;x-signature=MblbUFa86xBoxHwOXDJO%2FPqmnR0%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-12">测试结果</h4>





























<table><thead><tr><th align="left">测试项</th><th align="left">测试结果</th><th align="left">消息传递延迟</th><th align="left">成功率</th></tr></thead><tbody><tr><td align="left">三层消息传递</td><td align="left">✅ 通过</td><td align="left">平均 68ms</td><td align="left">100%</td></tr><tr><td align="left">场景管理</td><td align="left">✅ 通过</td><td align="left">平均 45ms</td><td align="left">100%</td></tr><tr><td align="left">资源管理</td><td align="left">✅ 通过</td><td align="left">平均 82ms</td><td align="left">100%</td></tr></tbody></table>
<h4 data-id="heading-13">技术验证</h4>
<p>三层 Agent 架构职责清晰，消息传递高效，场景管理和资源调度功能正常。架构设计具备横向扩展能力，为后续企业级应用预留了接口。</p>
<h3 data-id="heading-14">三、网络环境测试：多网络场景适配能力</h3>
<h4 data-id="heading-15">测试目的</h4>
<p>验证系统在本地网络和局域网环境下的性能表现和稳定性。</p>
<h4 data-id="heading-16">测试内容</h4>
<ol>
<li>本地网络（同一主机）测试</li>
<li>局域网（同一网段）测试</li>
<li>网络环境切换测试</li>
</ol>
<h4 data-id="heading-17">测试流程图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6eb72ed8fba48458e333d02ddd1fdfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216461&amp;x-signature=GytE%2BFe8t1dCidN6cp2949M7sNA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-18">测试结果</h4>





























<table><thead><tr><th align="left">网络环境</th><th align="left">服务发现成功率</th><th align="left">平均通信延迟</th><th align="left">稳定性评分</th></tr></thead><tbody><tr><td align="left">本地网络</td><td align="left">✅ 100%</td><td align="left">42ms</td><td align="left">9.8/10</td></tr><tr><td align="left">局域网</td><td align="left">✅ 99.5%</td><td align="left">115ms</td><td align="left">9.5/10</td></tr><tr><td align="left">网络切换</td><td align="left">✅ 99%</td><td align="left">158ms</td><td align="left">9.2/10</td></tr></tbody></table>
<h4 data-id="heading-19">技术验证</h4>
<p>系统能够自动检测网络环境并调整配置，在本地网络和局域网环境下表现稳定。网络环境切换功能正常，能够适应不同网络场景的需求。</p>
<h3 data-id="heading-20">四、性能测试：常规并发处理能力</h3>
<h4 data-id="heading-21">测试目的</h4>
<p>验证系统在常规并发场景下的响应速度和吞吐量。</p>
<h4 data-id="heading-22">测试内容</h4>
<ol>
<li>10 并发请求测试</li>
<li>50 并发请求测试</li>
<li>并发场景下的资源占用测试</li>
</ol>
<h4 data-id="heading-23">测试流程图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/990d44d7925c4fd3b7678caf6deb3777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216461&amp;x-signature=u1LdT39NV%2F19EzQ8D3JtcmDIBO8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-24">测试结果</h4>


























<table><thead><tr><th align="left">并发数</th><th align="left">平均响应时间</th><th align="left">吞吐量</th><th align="left">CPU使用率</th><th align="left">内存使用率</th></tr></thead><tbody><tr><td align="left">10</td><td align="left">87ms</td><td align="left">114.9 requests/sec</td><td align="left">12%</td><td align="left">28%</td></tr><tr><td align="left">50</td><td align="left">143ms</td><td align="left">349.7 requests/sec</td><td align="left">35%</td><td align="left">35%</td></tr></tbody></table>
<h4 data-id="heading-25">技术验证</h4>
<p>系统在常规并发场景下表现良好，响应时间和吞吐量符合预期，资源占用合理。能够满足个人和小型企业的日常使用需求。</p>
<h3 data-id="heading-26">五、可靠性测试：常见异常恢复能力</h3>
<h4 data-id="heading-27">测试目的</h4>
<p>验证系统在常见网络波动和 Agent 重启场景下的恢复能力。</p>
<h4 data-id="heading-28">测试内容</h4>
<ol>
<li>短暂网络中断恢复测试（30秒）</li>
<li>End Agent 重启恢复测试</li>
<li>Route Agent 重启恢复测试</li>
</ol>
<h4 data-id="heading-29">测试流程图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55e6c9c63cdb4f29828e67b48e42d6f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216461&amp;x-signature=tpWoA1w8SQp6fLa4%2Fz%2FoX9shpRs%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-30">测试结果</h4>





























<table><thead><tr><th align="left">测试项</th><th align="left">测试结果</th><th align="left">恢复时间</th><th align="left">成功率</th></tr></thead><tbody><tr><td align="left">网络中断恢复</td><td align="left">✅ 通过</td><td align="left">2.1秒</td><td align="left">100%</td></tr><tr><td align="left">End Agent 重启恢复</td><td align="left">✅ 通过</td><td align="left">3.5秒</td><td align="left">100%</td></tr><tr><td align="left">Route Agent 重启恢复</td><td align="left">✅ 通过</td><td align="left">4.8秒</td><td align="left">100%</td></tr></tbody></table>
<h4 data-id="heading-31">技术验证</h4>
<p>系统在常见异常场景下能够快速恢复，保持稳定运行。恢复时间符合预期，能够满足日常使用中的稳定性要求。</p>
<h3 data-id="heading-32">技术验证总结</h3>
<h4 data-id="heading-33">核心技术能力验证</h4>
<ol>
<li><strong>服务发现能力</strong>：UDP 广播服务发现机制在局域网环境下可靠高效，响应时间快</li>
<li><strong>三层架构协同</strong>：MCP → Route → End 三层架构职责清晰，消息传递高效</li>
<li><strong>网络环境适配</strong>：能够自动检测网络环境并调整配置，适应不同网络场景</li>
<li><strong>性能处理能力</strong>：常规并发场景下表现良好，资源占用合理</li>
<li><strong>可靠性保障</strong>：常见异常场景下能够快速恢复，保持系统稳定</li>
</ol>
<h4 data-id="heading-34">技术优化建议</h4>
<ol>
<li><strong>UDP 服务发现优化</strong>：
<ul>
<li>增加静态注册中心作为跨网段场景的兜底方案</li>
<li>实现请求-响应确认机制，提高传输可靠性</li>
</ul>
</li>
<li><strong>消息路由优化</strong>：
<ul>
<li>实现消息定向转发，减少冗余消息</li>
<li>引入轻量级消息队列，提升并发处理能力</li>
</ul>
</li>
<li><strong>网络环境适配优化</strong>：
<ul>
<li>补充网络质量检测指标，动态调整系统配置</li>
<li>实现网络切换实时适配，提升系统稳定性</li>
</ul>
</li>
<li><strong>工程化落地优化</strong>：
<ul>
<li>建立日志监控体系，方便问题排查</li>
<li>加强安全加固，提升系统安全性</li>
<li>实现配置持久化，确保系统重启后配置不丢失</li>
</ul>
</li>
</ol>
<h3 data-id="heading-35">结论与建议</h3>
<h4 data-id="heading-36">测试结论</h4>
<p>ooderAgent Nexus 版本（v0.6.5）的核心功能测试全部通过，验证了系统在局域网环境下的可靠性、稳定性和性能表现。系统具备个人和小型企业生产环境初步落地的技术基础，能够满足日常使用需求。</p>
<h4 data-id="heading-37">落地建议</h4>
<ol>
<li><strong>适用场景</strong>：推荐在个人、家庭和小型企业的局域网环境下部署使用</li>
<li><strong>部署建议</strong>：
<ul>
<li>局域网环境优先使用 UDP 广播服务发现</li>
<li>确保网络设备允许 UDP 广播包传输</li>
<li>合理规划 Route Agent 部署位置，确保网络覆盖</li>
</ul>
</li>
<li><strong>后续优化</strong>：
<ul>
<li>优先实现跨网段服务发现能力</li>
<li>加强系统安全性和监控能力</li>
<li>完善文档和部署指南，降低使用门槛</li>
</ul>
</li>
</ol>
<p>ooderAgent Nexus 版本已经具备了核心功能的技术验证基础，通过持续的优化和完善，有望成为分布式 AI 代理系统的优秀解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Akamai Cloud客户案例 | Multivrse 信赖 Akamai 为其业务增长提供动力]]></title>    <link>https://juejin.cn/post/7600229327436906546</link>    <guid>https://juejin.cn/post/7600229327436906546</guid>    <pubDate>2026-01-28T14:22:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600229327436906546" data-draft-id="7600229327436890162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Akamai Cloud客户案例 | Multivrse 信赖 Akamai 为其业务增长提供动力"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2026-01-28T14:22:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Akamai Cloud客户案例 | Multivrse 信赖 Akamai 为其业务增长提供动力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:22:07.000Z" title="Wed Jan 28 2026 14:22:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“只要 Multivrse 存在，我们就会使用 Akamai。这份合作关系至关重要。”</p>
<p>——Amol Patankar，Multivrse 创始人</p>
</blockquote>
<p><strong><strong>赋能全球对话</strong></strong></p>
<p>澳大利亚多语言服务公司 Multivrse Digital 面临着一个常见而紧迫的挑战：持续攀升的云成本、不够稳定的技术支持，以及AWS本身的复杂性，正逐渐阻碍其业务发展的脚步。在其大规模提供快速、准确且符合文化背景的内容的使命中，敏捷性和基础设施的简洁性至关重要。通过迁移至 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fcloud%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external1_blogarticles246" target="_blank" title="https://www.akamai.com/zh/cloud?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external1_blogarticles246" ref="nofollow noopener noreferrer">Akamai 云计算服务</a>，Multivrse 实现了更快速的资源调配，节省高达 70% 的成本，并获得了始终如一的支持，从而能够安心地向全球扩展业务。</p>
<p><strong><strong>亟需克服云复杂性与成本压力</strong></strong></p>
<p>Multivrse 由 Amol Patankar 创立，致力于帮助企业以受众偏好的语言连接全球用户。其采用的混合方法结合了 AI 驱动的翻译与母语语言专家。结果如何？内容不仅准确，更契合文化背景并保持品牌一致性。“我们不仅是翻译服务提供商，” Patankar 解释道，“更是帮助品牌全球化扩张并深化客户参与的战略合作伙伴。”</p>
<p>作为一家精益初创企业，Multivrse 需要的云平台不仅技术过硬，还需具备成本效益、用户友好，并有响应迅速的供应商支持。“在 AWS 时，我们没有专属联系人。获取回复需要数天时间。这种延迟对成长中的企业是行不通的，” Patankar 表示。</p>
<p>Multivrse 技术与运营主管 Vivek Sathyaganesh 指出：“此外，AWS 的定价难以预测。每项功能都是额外收费。而且定价因地区而异，导致我们每月都无法预估开支。”</p>
<p>随着业务增长和客户需求跨地域扩展，Multivrse 不得不重新评估其基础设施。</p>
<p><strong><strong>信赖 Akamai 的定价透明度、技术匹配与战略指导</strong></strong></p>
<p>迁移至 Akamai 的决定源于长达十年的信任。Patankar 此前在航空和零售行业担任企业职位时曾与 Akamai 合作，亲身见证了 Akamai 在性能、安全性和指导方面的价值。</p>
<p>“当我创立 Multivrse 时，我就知道我们最终会迁移到 Akamai，” 他说，“Akamai 的团队始终随时可用，善于协作且以解决方案为导向。这样的支持是无价的。”</p>
<p>对于负责 Multivrse 平台管理的 Sathyaganesh 而言，Akamai 的以下能力尤为突出：直接明了的资源调配、透明的定价、对开发者友好的工具，以及边缘与计算集成。“AWS 将出口流量分为不同层级、区域和数据类型，导致定价过于复杂，” 他强调说。</p>
<p><strong><strong>轻松从 AWS 迁移至 Akamai 云计算服务</strong></strong></p>
<p>从一开始，Akamai 的协作方式就给 Multivrse 留下了深刻印象。Akamai 使从 AWS 的迁移变得无忧无虑。这一体验与 AWS 截然不同，后者在不同区域间迁移十分复杂。“迁移到 Akamai 非常容易，并且管理起来立即变得更为简便，” Sathyaganesh 表示。</p>
<p>具体而言，Multivrse 使用以下 Akamai 云计算服务替代了 EC2、RDS、S3 和 Route53：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-cloud-computing%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external2_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-cloud-computing?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external2_blogarticles246" ref="nofollow noopener noreferrer">Cloud Firewall</a>：内置规则的防火墙帮助 Multivrse 保护工作负载，无需外部工具。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-container%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external3_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-container?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external3_blogarticles246" ref="nofollow noopener noreferrer">DNS Manager</a>：Akamai Cloud Manager 中的这一综合界面使全球域名管理变得轻松便捷。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-firewall%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external4_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-firewall?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external4_blogarticles246" ref="nofollow noopener noreferrer">NodeBalancers</a>：这些完全托管、高可用的负载均衡器可在数分钟内部署，确保高可用性和性能。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-are-cloud-resources%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external5_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/what-are-cloud-resources?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external5_blogarticles246" ref="nofollow noopener noreferrer">Managed Databases</a>：这项完全托管的数据库服务提供自动备份和更新，使 Multivrse 能够轻松部署高性能数据库集群。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fhow-do-apis-work%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external6_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/how-do-apis-work?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external6_blogarticles246" ref="nofollow noopener noreferrer">Object Storage</a>：这种持久、可扩展且经济高效的存储与 S3 兼容，定价简化，访问容易。</li>
<li>Longview：Multivrse 使用这一集成监控与分析工具来了解云计算服务器的健康状况和性能。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-are-databases%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external7_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/what-are-databases?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external7_blogarticles246" ref="nofollow noopener noreferrer">Essential Compute</a>：这种简化的虚拟机托管可以快速调配，并提供统一透明的定价。</li>
<li>Private Networking：Multivrse 使用此云计算服务建立虚拟网络，隔离流量以实现安全的多层部署。</li>
</ul>
<p><strong><strong>实现关键成果：更快的资源调配、成本节约与更低延迟</strong></strong></p>
<p>迁移至 Akamai 带来了定量与定性的双重收益。用 Akamai 云计算服务替代 AWS 实现了：</p>
<ul>
<li>计算和存储成本降低 <strong><strong>50%–70%</strong></strong>，特别是针对内存优化和高需求工作负载</li>
<li>虚拟机资源调配速度提升 <strong><strong>30%–40%</strong></strong></li>
<li>通过 Akamai 的分布式骨干网，全球用户延迟降低 <strong><strong>20%–50%</strong></strong></li>
</ul>
<p>Sathyaganesh 表示：“Akamai 云计算服务对开发者非常友好。其控制面板和命令行界面清晰、直观，相比 AWS 或 Azure 更易于操作。启动虚拟机、对象存储和 NodeBalancers 只需点击几下，过程简单明了。”</p>
<p>“与 Akamai 相比，AWS 的成本异常高昂。” Patankar 补充道，“在 Akamai 上，我们过去为一个 AWS 实例支付的费用现在能获得三个实例。这对我们这样的初创企业来说是颠覆性的改变。”</p>
<p><strong><strong>凭借企业级指导与支持做出明智的基础设施选择</strong></strong></p>
<p>一个关键差异在于 Akamai 的咨询式方法和协作式技术评审，这帮助 Multivrse 做出了更智能的基础设施决策。“Akamai 娴熟而清晰地指导我们避免了不必要的 Kubernetes 复杂性，转而采用适合我们需求的标准模型，” Sathyaganesh 解释道，“在当前阶段建议我们暂不使用 Kubernetes，为我们节省了时间和成本，并提供了一条更清晰的技术路径。”</p>
<p>Multivrse 同样看重 Akamai 的可用性和响应速度。“我们可以随时拨打电话，联系到理解我们业务和技术需求的人，并及时获得建议，” Patankar 说，“这很难得——而这是我们在 AWS 未曾获得的体验。”</p>
<p><strong><strong>赋能全球扩展与未来增长</strong></strong></p>
<p>基于 Akamai 稳健的基础设施，Multivrse 的多语言平台利用先进的计算能力，结合专有算法和流程，提供更快速、更个性化的客户体验——使公司能够在覆盖范围和创新能力上实现全球扩展。以 Akamai 作为云合作伙伴，Multivrse 定位于持续实现其愿景：帮助品牌快速、高效且有意义地讲述每一位客户的语言。</p>
<p>“随着我们的成长，我们计划根据客户需求扩展至更多地区。我们知道，有了 Akamai，我们前进的每一步都将获得支持，” Patankar 总结道。</p>
<p><strong><strong>关于 Multivrse Digital</strong></strong></p>
<p>Multivrse 是一家技术驱动的多语言服务公司，致力于帮助品牌跨越语言和文化，与客户建立更有意义的连接。通过将基于 AI 的翻译技术与母语专家经验相结合，Multivrse 为网站、营销活动和客户沟通提供可扩展的高质量多语言解决方案。我们的使命是让数字体验更具包容性、可访问性和吸引力——帮助组织扩大影响范围、增强客户忠诚度、推动全球增长，并最终更贴近客户。</p>
<p><strong><strong>关于 Akamai</strong></strong></p>
<p>Akamai 是一家为在线业务提供动力并予以保护的网络安全和云计算公司。我们市场领先的安全解决方案、卓越的威胁情报和全球运营团队提供深度防御，随时随地保护企业数据和应用程序。Akamai 的全栈云计算解决方案在全球分布最广的平台上提供高性能与高性价比。全球企业信赖 Akamai 提供行业领先的可靠性、规模与专业能力，以自信地发展业务。了解更多信息，请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external8_blogarticles246" target="_blank" title="https://www.akamai.com/zh?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external8_blogarticles246" ref="nofollow noopener noreferrer">akamai.com</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fblog%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external9_blogarticles246" target="_blank" title="https://www.akamai.com/zh/blog?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external9_blogarticles246" ref="nofollow noopener noreferrer">akamai.com/blog</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[type-challenges（ts类型体操）: 7 - 对象属性只读]]></title>    <link>https://juejin.cn/post/7600224355294822427</link>    <guid>https://juejin.cn/post/7600224355294822427</guid>    <pubDate>2026-01-28T14:45:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600224355294822427" data-draft-id="7600245693997776906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="type-challenges（ts类型体操）: 7 - 对象属性只读"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-28T14:45:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fxss"/> <meta itemprop="url" content="https://juejin.cn/user/3702810892856808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            type-challenges（ts类型体操）: 7 - 对象属性只读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810892856808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fxss
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:45:17.000Z" title="Wed Jan 28 2026 14:45:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">7 - 对象属性只读</h2>
<p>by Anthony Fu (@antfu) #简单 #built-in #readonly #object-keys</p>
<h3 data-id="heading-1">题目</h3>
<p>不要使用内置的<code>Readonly&lt;T&gt;</code>，自己实现一个。</p>
<p>泛型 <code>Readonly&lt;T&gt;</code> 会接收一个 <em>泛型参数</em>，并返回一个完全一样的类型，只是所有属性都会是只读 (readonly) 的。</p>
<p>也就是不可以再对该对象的属性赋值。</p>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">todo</span>: <span class="hljs-title class_">MyReadonly</span>&lt;<span class="hljs-title class_">Todo</span>&gt; = {
  <span class="hljs-attr">title</span>: <span class="hljs-string">"Hey"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"foobar"</span>
}

todo.<span class="hljs-property">title</span> = <span class="hljs-string">"Hello"</span> <span class="hljs-comment">// Error: cannot reassign a readonly property</span>
todo.<span class="hljs-property">description</span> = <span class="hljs-string">"barFoo"</span> <span class="hljs-comment">// Error: cannot reassign a readonly property</span>
</code></pre>
<blockquote>
<p>在 Github 上查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F7%2Fzh-CN" target="_blank" title="https://tsch.js.org/7/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/7/zh-CN</a></p>
</blockquote>
<h3 data-id="heading-2">代码</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/* _____________ 你的代码 _____________ */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyReadonly</span>&lt;T&gt; = {
  <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P]
}

</code></pre>
<p>关键解释：</p>
<ul>
<li><code>readonly</code> 关键字用于将属性设置为只读，即不能对其进行赋值操作；</li>
<li><code>[P in keyof T]</code> 用于遍历泛型 <code>T</code> 的所有属性键；</li>
<li><code>T[P]</code> 用于获取属性 <code>P</code> 的类型。</li>
</ul>
<h3 data-id="heading-3">相关知识点</h3>
<h4 data-id="heading-4"><code>readonly</code></h4>
<ul>
<li>核心作用：标记后，目标（属性 / 数组 / 元组）只能在初始化阶段赋值（比如接口实例化、类构造函数、变量声明时），后续任何修改操作都会被 TS 编译器拦截报错；</li>
<li>运行时特性：<code>readonly</code> 仅做编译时检查，不会生成任何额外 JS 代码，也无法真正阻止运行时的修改（比如通过类型断言绕开的话，运行时仍能改）；</li>
<li>与 <code>const</code> 的区别：<code>const</code> 是变量层面的不可重新赋值（但变量指向的对象 / 数组内部属性仍可改），<code>readonly</code> 是属性 / 类型层面的不可修改（变量本身可重新赋值，除非变量也用 <code>const</code>）。</li>
</ul>
<p>常用使用场景：</p>
<ol>
<li>作用于接口 / 类型别名的属性（最基础）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义带只读属性的接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 只读属性：只能初始化赋值，后续不可改</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 普通属性：可修改</span>
}

<span class="hljs-comment">// 初始化时赋值（合法）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span> };

<span class="hljs-comment">// 尝试修改只读属性（报错）</span>
user.<span class="hljs-property">id</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// ❌ 报错：无法分配到 "id"，因为它是只读属性</span>
<span class="hljs-comment">// 修改普通属性（合法）</span>
user.<span class="hljs-property">name</span> = <span class="hljs-string">"李四"</span>; <span class="hljs-comment">// ✅ 合法</span>
</code></pre>
<ol start="2">
<li>作用于类的属性: 类中使用 <code>readonly</code> 标记属性，只能在<strong>声明时</strong>或<strong>构造函数中</strong>赋值，后续无法修改</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 只读属性</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-comment">// 构造函数中给 readonly 属性赋值（唯一合法的后续赋值方式）</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-title function_">updateInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// ❌ 报错：id 是只读属性</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">"王五"</span>; <span class="hljs-comment">// ✅ 合法</span>
  }
}

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"赵六"</span>);
person.<span class="hljs-property">id</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// ❌ 报错：只读属性不可修改</span>
</code></pre>
<ol start="3">
<li>作用于数组 / 元组（只读数组）: <code>readonly</code> 可标记数组为 “只读数组”，禁止修改数组元素、调用 <code>push/pop</code> 等修改方法</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 方式1：使用 readonly 修饰数组类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">arr1</span>: <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
arr1.<span class="hljs-title function_">push</span>(<span class="hljs-number">4</span>); <span class="hljs-comment">// ❌ 报错：readonly 数组不存在 push 方法</span>
arr1[<span class="hljs-number">0</span>] = <span class="hljs-number">10</span>; <span class="hljs-comment">// ❌ 报错：无法修改只读数组的元素</span>

<span class="hljs-comment">// 方式2：使用 ReadonlyArray&lt;T&gt; 类型（等价于 readonly T[]）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">arr2</span>: <span class="hljs-title class_">ReadonlyArray</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>];
arr2.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// ❌ 报错</span>

<span class="hljs-comment">// 作用于元组（只读元组）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Point</span> = <span class="hljs-keyword">readonly</span> [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>];
<span class="hljs-keyword">const</span> <span class="hljs-attr">point</span>: <span class="hljs-title class_">Point</span> = [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>];
point[<span class="hljs-number">0</span>] = <span class="hljs-number">30</span>; <span class="hljs-comment">// ❌ 报错：只读元组元素不可修改</span>
</code></pre>
<ol start="4">
<li>结合 <code>keyof</code> + <code>in</code> 批量创建只读类型（映射类型）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Product</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">stock</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 批量创建只读版本的 Product（TS 内置的 Readonly&lt;T&gt; 就是这么实现的）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyProduct</span> = {
  <span class="hljs-keyword">readonly</span> [K <span class="hljs-keyword">in</span> keyof <span class="hljs-title class_">Product</span>]: <span class="hljs-title class_">Product</span>[K];
};

<span class="hljs-keyword">const</span> <span class="hljs-attr">product</span>: <span class="hljs-title class_">ReadonlyProduct</span> = { <span class="hljs-attr">name</span>: <span class="hljs-string">"手机"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2999</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">100</span> };
product.<span class="hljs-property">price</span> = <span class="hljs-number">3999</span>; <span class="hljs-comment">// ❌ 报错：price 是只读属性</span>

<span class="hljs-comment">// TS 内置了 Readonly&lt;T&gt;，可直接使用（无需手动写映射类型）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">product2</span>: <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Product</span>&gt; = { <span class="hljs-attr">name</span>: <span class="hljs-string">"电脑"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">5999</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">50</span> };
product2.<span class="hljs-property">stock</span> = <span class="hljs-number">60</span>; <span class="hljs-comment">// ❌ 报错</span>
</code></pre>
<ol start="5">
<li>只读索引签名：如果类型使用索引签名，也可以标记为 <code>readonly</code>，禁止通过索引修改属性</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 只读索引签名：只能读取，不能修改</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyDict</span> = {
  <span class="hljs-keyword">readonly</span> [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-attr">dict</span>: <span class="hljs-title class_">ReadonlyDict</span> = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
dict[<span class="hljs-string">"a"</span>] = <span class="hljs-number">3</span>; <span class="hljs-comment">// ❌ 报错：索引签名是只读的</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dict[<span class="hljs-string">"b"</span>]); <span class="hljs-comment">// ✅ 合法：仅读取</span>
</code></pre>
<h4 data-id="heading-5"><code>keyof</code></h4>
<p><code>keyof</code> 操作符用于获取对象类型的所有属性名（包括索引签名），并将其转换为联合类型。</p>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TodoKeys</span> = keyof <span class="hljs-title class_">Todo</span> <span class="hljs-comment">// "title" | "description" | "completed"</span>
</code></pre>
<h4 data-id="heading-6"><code>in</code></h4>
<p><code>in</code> 操作符用于遍历联合类型中的每个成员。</p>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TodoKeys</span> = <span class="hljs-string">'title'</span> | <span class="hljs-string">'description'</span> | <span class="hljs-string">'completed'</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TodoPreview</span> = {
  [P <span class="hljs-keyword">in</span> <span class="hljs-title class_">TodoKeys</span>]: <span class="hljs-title class_">Todo</span>[P]
}
<span class="hljs-comment">// TodoPreview 类型为：</span>
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   title: string</span>
<span class="hljs-comment">//   description: string</span>
<span class="hljs-comment">//   completed: boolean</span>
<span class="hljs-comment">// }</span>
</code></pre>
<h3 data-id="heading-7">测试用例</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/* _____________ 测试用例 _____________ */</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Equal</span>, <span class="hljs-title class_">Expect</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-challenges/utils'</span>

<span class="hljs-keyword">type</span> cases = [
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">MyReadonly</span>&lt;<span class="hljs-title class_">Todo1</span>&gt;, <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Todo1</span>&gt;&gt;&gt;,
]

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo1</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>
  <span class="hljs-attr">meta</span>: {
    <span class="hljs-attr">author</span>: <span class="hljs-built_in">string</span>
  }
}

</code></pre>
<h3 data-id="heading-8">相关链接</h3>
<blockquote>
<p>分享你的解答：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F7%2Fanswer%2Fzh-CN" target="_blank" title="https://tsch.js.org/7/answer/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/7/answer/zh…</a>
查看解答：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F7%2Fsolutions" target="_blank" title="https://tsch.js.org/7/solutions" ref="nofollow noopener noreferrer">tsch.js.org/7/solutions</a>
更多题目：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2Fzh-CN" target="_blank" title="https://tsch.js.org/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/zh-CN</a></p>
</blockquote>
<p>下面是我的公众号，欢迎关注。关注后有新的功能点会及时收到推送。</p>
<blockquote>
<p>实战为王！专注于汇总各种功能点，致力于打造一系列能够帮助工程师实现各种功能的想法思路的优质文章。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bdeec99a0154e7aa73c1c6765f3dcf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnhzcw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216317&amp;x-signature=RuBFNnp%2BFwjiDs0CLPw5aBOdr00%3D" alt="前端功能点" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从理论到实战，一期彻底搞懂 Agent Skills！]]></title>    <link>https://juejin.cn/post/7600296037542477824</link>    <guid>https://juejin.cn/post/7600296037542477824</guid>    <pubDate>2026-01-28T14:56:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600296037542477824" data-draft-id="7600296037542461440" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从理论到实战，一期彻底搞懂 Agent Skills！"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-28T14:56:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ConardLi"/> <meta itemprop="url" content="https://juejin.cn/user/3949101466785709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从理论到实战，一期彻底搞懂 Agent Skills！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3949101466785709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ConardLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:56:04.000Z" title="Wed Jan 28 2026 14:56:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>本期视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1GXzaByEEo%2F" target="_blank" title="https://www.bilibili.com/video/BV1GXzaByEEo/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1GX…</a></strong></p>
<p>Agent Skills 最近非常的火，它是既 MCP 后 Anthropic 推出的又一个 Agent 领域的行业标准。</p>
<p>它的成长路线和 MCP 也非常像，25 年 10 月份发布时只有 Anthropic 自家产品支持，后来 Cursor、Codex、Opencode、Gemini CLI 等产品看到了 Skills 的优势于是纷纷开始支持。</p>
<p>再后来社区开始涌现大量的开源 Skills 以及 Skills 开放市场，当下大家已经默认 Skills 成为了又一个扩展 Agent 能力的标准实践。</p>
<p>简单来说，Skills 的作用就是将那些重复性的、专业的流程进行打包封装。当你需要使用某种能力时，不再需要像过去那样每次都去查阅手册或重新输入冗长的提示词，而是像调用工具一样直接使用。</p>
<p>在本篇文章中，我们将从浅入深，和大家一起学习以下知识：</p>
<ol>
<li>Skills 入门理解：Skills 到底是什么？长什么样？怎么工作的？</li>
<li>Skills VS MCP：Skills 和 MCP 的区别是什么，MCP 会被淘汰吗？</li>
<li>Skills 初步尝试：去哪里找 Skill？怎么使用 Skill？怎么自己创建一个 Skill？</li>
<li>Skills 实战使用：如何用 Skills 实现外部知识检索？比传统 RAG 的优势在哪？</li>
<li>Skills 安全分析：Skills 的安全性如何？使用它有哪些风险？</li>
</ol>
<h2 data-id="heading-0">一、 Skills 入门理解</h2>
<h3 data-id="heading-1">1.1 Skills 到底是什么？</h3>
<p>在传统的 AI 聊天模式中，AI 的能力取决于：</p>
<ul>
<li>它原本学过什么（训练数据）</li>
<li>你临时在对话框里告诉它什么（提示词、工具、记忆）</li>
</ul>
<p>这就像你招了个什么都懂一点的实习生，每次干活你都得重新教一遍。</p>
<p>而 Agent Skills 带来了一种全新的玩法：模块化能力插件。</p>
<p>你可以把 Claude（支持 Skills 的客户端）想象成一个超级大脑，而 Agent Skills 就是给这个大脑安装的外接工具箱。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbd5bf7a07e0403fa28be4c59f879816~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=PsoI3q%2FQFDSzfUQRN%2BHJ3JSp3qs%3D" alt="" loading="lazy"/></p>
<p>这个工具箱里不仅有工具本身，还包含了详细的 “官方使用说明书”，大脑不需要理解具体有哪些工具以及工具的用法是什么，只需要在需要使用某个工具时查看工具说明书，再把工具拿出来用。</p>
<h3 data-id="heading-2">1.2 Skills 长什么样？</h3>
<p>Agent Skills 的官方文档中强调了一个核心关键词：File-system based（基于文件系统）。</p>
<p>如果你写过代码，可能很容易理解。</p>
<p>要编写一个程序，并不一定所有代码都是我们自己写的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afcd5073dd804f8f8302c34627be0920~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=zsINEVF8pG4I72rBZxZqG%2FngYAo%3D" alt="" loading="lazy"/></p>
<p>我们可能会通过 import xxx 来引入一些外部包，这些包存放在固定的位置（如 node_modules）。</p>
<p>当程序需要调用这些包的能力时，就会从指定文件夹取出对应的代码然后执行。</p>
<p>Agent Skills 也是类似的逻辑，每个 Skill 都是一个实实在在存在的文件夹，它存放在一个固定的位置（如 .claude/skills）这个文件夹里装着下面几样东西：</p>
<ol>
<li>指令（SKILL.md）： 告诉 AI 怎么干活的 SOP。</li>
<li>参考（reference）： 更详细的参考文档（可选）。</li>
<li>脚本（scripts）： 比如 Python 代码，让 Skill 也能调用外部能力（可选）。</li>
<li>资源（assets）：图片、模版等可能使用到的资源（可选）。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/335192c6069042bbbcb02b518a0ad6e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=qf5QYfctQbbaHXE75AprDVq2DRo%3D" alt="" loading="lazy"/></p>
<p>如果你在你的 Agent（如 Claude Code）执行目录（如你的项目代码目录）下放了这个文件夹，</p>
<p>那下次和 Agent 对话的时候就能自动根据你的需求匹配到这个 Skill，不需要再进行任何额外的配置。</p>
<p>比如，你希望 Agent 帮你润色文章，就可以编写一个下面这样的 Skill：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97a311faa36846e482f443b125c6938f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=K979LbaPu%2Fv5WfMuuYtPRnsZaxw%3D" alt="" loading="lazy"/></p>
<p>上面的三根短横线部分相当于 Skill 的「身份证」：</p>
<ul>
<li>name 是它的唯一标识，起个简单好记的英文名字就行</li>
<li>description 则决定什么时候会触发这个 Skill，描述这个 Skills 是做什么的、遇到什么样的用户请求应该用它、提醒读者：描述越具体，越容易在正确场景被调用</li>
</ul>
<p>下面就是 Skill 的正文部分：</p>
<ul>
<li>目标：简单描述清楚这个 Skill 要做的事情</li>
<li>使用步骤：列出 Skill 的操作流程（先搞清楚想要什么风格、再读原文、再改写、最后规定输出格式）</li>
<li>注意事项：告诉模型「什么不要做」（不要乱加内容、不要替用户做决定、有歧义要提醒）</li>
</ul>
<hr/>
<p>看起来挺普通的？似乎很多能力都可以做这件事？</p>
<ul>
<li>可以把这段文字和要润色的文章直接发给大模型？</li>
<li>可以把这段文字放到系统提示词？</li>
<li>可以把这段固定的流程封装为一个 Workflow？</li>
<li>可以把这段文字编写为一个 Agent.md 或者项目级的 Rules？</li>
</ul>
<p>这些方式看似不同，但本质上只是把提示词放在了不同的位置，你给 AI 的每次对话都会带上这些提示词。</p>
<p>在真实的业务场景中，一个 Agent 不可能只干一件这么简单的事。大家试想一下，如果你要给 AI 装 50 个技能，每个技能都有几千字的说明书，要是系统一启动就把这些全塞进 AI 的脑子（Context Window）里，那么就会：</p>
<ul>
<li>成本爆炸，每次对话可能都会消耗几万 Token。</li>
<li>AI 的注意力也会被分散，变得“这也想干，那也想干”。</li>
</ul>
<p>Skill 的出现就是为了解决这种问题，它有一个非常核心的机制，叫渐进式披露（Progressive Disclosure）。说人话就是：按需加载，用多少拿多少。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a3edef71fbc44839ab60fae6780ac28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=7VqkVFiLdSWnv0tLQjlWjlOwjIs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">1.3 Skills 的核心机制</h3>
<p>这是我觉得 Agent Skills 设计得最聪明的地方。你可以把它想象成我们在图书馆查资料的三个步骤，非常直观：</p>
<p>第一层：先看目录（元数据 Metadata）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e08b156bd28438faa15a528d77c9f5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=GRZR1ZtZ0hQLOXfcOYDDA%2BGO5F4%3D" alt="" loading="lazy"/></p>
<ul>
<li>什么时候加载？ 系统刚启动的时候。</li>
<li>加载什么？ 只加载每个技能的名字和一段简短的描述。</li>
<li>有什么用？ 这一层占用的资源极少，可能就几百个 Token。它的作用就是告诉 Claude：“嘿，你的工具箱里有‘查周报’、‘处理 Excel’ 这几个工具哦。”</li>
<li>结果： Claude 知道自己 “会什么”，但还不知道 “具体怎么做”。</li>
</ul>
<hr/>
<p>第二层：翻开手册（指令 Instructions）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/194d42e19c31488a9dbf9f937a752d8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=oQzJ8xml2gYEVbGNCc4ix0JB610%3D" alt="" loading="lazy"/></p>
<ul>
<li>什么时候加载？ 当你说 “帮我把这个 Excel 处理一下” 的时候。</li>
<li>加载什么？ Claude 发现这事儿归 “Excel 处理” 这个技能管，于是它才会通过后台命令，去读取那个文件夹里的 SKILL.md 文件。</li>
<li>有什么用？ 只有在这个时候，那些详细的操作步骤、注意事项才会进入 AI 的脑子。</li>
</ul>
<p>第三层：动手干活（运行时资源 Runtime Resources）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8ee8c38563644ca94b83c9df1fc98b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=Yc1SKtgWUcx7hDlNGzxwqXWKDEg%3D" alt="" loading="lazy"/></p>
<ul>
<li>什么时候加载？ 真正执行具体步骤的时候。加载什么？
<ul>
<li>参考（reference）： 用户下达的任务可能是分析 Excel，也可能是创建 Excel，这两个操作可能有完全不同的处理步骤，详细的步骤不一定都在 SKILL.md 中，可以分开放在不同的参考文献（reference）下，当 Claude 识别到你要做的是分析 Excel 时，才会去查阅分析 Excel 的 reference。</li>
<li>脚本（scripts）：Skill 中可以内置一些可执行的 Excel 处理脚本，在  SKILL.md 或者具体的参考文献（reference）下会告诉你应该调用以及如何调用这些脚本。还有最重要的一点，Claude 只需要按照指引执行脚本，而脚本本身的代码是不会塞给 AI 去读的，你完全不用担心一个超大代码文件会消耗 Token。</li>
</ul>
</li>
</ul>
<blockquote>
<p>这意味着：一个 Skill 可以打包整套说明文档、大量的执行脚本，但只要任务不需要，这些内容就永远不会占用上下文。</p>
</blockquote>
<h2 data-id="heading-4">二、Skills VS MCP</h2>
<p>看到这，你可能会觉得 Skills 和 MCP 有点像？</p>
<p>它们似乎都可以做到按需加载、给 AI 扩展外部能力？</p>
<p>这也是很多同学可能会弄混的问题。</p>
<h3 data-id="heading-5">2.1 MCP 有什么问题</h3>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyP6D_mnxwFsL3SbC4qZnYg%3Ftoken%3D1267907119%26lang%3Dzh_CN" target="_blank" title="https://mp.weixin.qq.com/s/yP6D_mnxwFsL3SbC4qZnYg?token=1267907119&amp;lang=zh_CN" ref="nofollow noopener noreferrer">全网最细，一文带你弄懂 MCP 的核心原理！</a> 中，我们介绍了 MCP 出现的意义和执行原理：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f61586c73d3c4011aaec7f33f3744867~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=TApcRtcMBWw2R95mkxL7ZLsacf4%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>MCP（Model Context Protocol，模型上下文协议）是由 Anthropic 公司推出的一个开放标准协议，它就像是一个 “通用插头” 或者 “USB 接口”，制定了统一的规范，不管是连接数据库、第三方 API，还是本地文件等各种外部资源，都可以通过这个 “通用接口” 来完成，让 AI 模型与外部工具或数据源之间的交互更加标准化、可复用。</p>
</blockquote>
<p>所以 MCP 的本质，还是在做 “标准化”，它让给 AI 扩展外部能力这件事更 “标准化”。</p>
<p>假如你的 Agent 连接了多个 MCP，它似乎也能实现 “按需加载”（根据用户的意图决定调用哪个工具）。</p>
<p>但这个 “按需加载” 背后的代价是非常巨大的，在 MCP 的架构下，仅仅是“连接”这个动作，就已经在透支你的额度了。</p>
<p>这是由 LLM 的工具调用机制决定的。为了让 AI 知道它有哪些能力可用，每一个连接的 MCP Server 必须在对话开始前，将其所有工具的完整定义（名称、详细描述、参数 Schema、使用示例）一次性注入 LLM 的上下文中。</p>
<p>每个 MCP Server 一般都会包含大量的工具，比如 Github MCP ，它自己就包含了 30 多个工具：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe45f4124831425894e7f07f23c1e1d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=k14tPumkaPhlak0Kiv7r%2FDLJ1IY%3D" alt="" loading="lazy"/></p>
<p>假如每个工具消耗 500 个 Token，那只链接这一个工具就需要消耗将近 20000 Token。</p>
<p>在真实环境下，一个 Agent 不会仅链接一个 MCP Server。</p>
<p>假如你只问了 AI 一个非常简单的问题（1+1=？），Agent 已经烧掉了大几万的 Token，这个成本是非常恐怖的。</p>
<p>更深层的问题在于链接过多的 MCP Server 可能导致 LLM 的 “注意力” 下降，从而降低工具调用的准确性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6021a9e48a94ec782b79782618085bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=ryfkjkCQ5A3pCJddBwCSJlkJ96U%3D" alt="" loading="lazy"/></p>
<p>我在之前的文章中有讲过一个专门测试 MCP Server 调用准确度的基准：MCP Atlas（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FkQIcb6gggF5wf08qjuJcyQ%3Ftoken%3D1267907119%26lang%3Dzh_CN" target="_blank" title="https://mp.weixin.qq.com/s/kQIcb6gggF5wf08qjuJcyQ?token=1267907119&amp;lang=zh_CN" ref="nofollow noopener noreferrer">世界最顶级的大模型，都在 PK 些啥？ （大模型评估完全指南）</a>），在这个基准中包含了 40 多个不同服务器、300 多个工具的复杂环境。</p>
<p>模型必须自己发现合适的工具、正确调用，并把多步结果汇总成最终答案。目前最强的 Claude Opus 4.5 也只能拿到 62% 的准确率，这个值还会随着工具的增多而进一步下降。</p>
<p>而我们上面讲到的 Skills 的核心机制：渐进式披露 ，恰好可以解决这两个问题：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0efd5e659a84e1c9567f5d68821fd1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=q6y5ig6pl%2BvXV0gtIVHyjA4x7Fw%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>节省 Token：首次链接时，相比 MCP 需要将 40 多个 MCP Server 下 300 个工具全部塞进模型上下文（消耗数万 Token），模型只需要加载 40 个 Skills 的元数据（几千 Token）。</p>
</li>
<li>
<p>提升注意力： 面对几百个工具，AI 很容易分心。Skills 采用的是“漏斗式”引导：先通过目录判断大方向，确认要干活了，再加载具体的说明，最后通过说明找到详细的文档和脚本最后再执行。让 AI 每次只专注于当前任务。即使是能力稍弱的模型，在这种机制下也能保持极高的调用准确率。</p>
</li>
</ul>
<h3 data-id="heading-6">2.2 MCP 会被淘汰吗？</h3>
<p>看到这你可能会问了，Skills 看起来更智能、更节省资源，那 MCP 会被淘汰吗？</p>
<blockquote>
<p>结论是：MCP 不会被完全淘汰，但对它的需求会大幅减少！</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b60e1a4520a4a25bf576029b34db8bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=rB6WRaBkl2FAII0NxN8EBF9fqXE%3D" alt="" loading="lazy"/></p>
<p>首先，MCP 协议层的价值不可替代： MCP 的真正价值不在于它如何把文本塞进 Prompt，而在于它制定了一套标准接口。</p>
<p>它统一了 AI 连接世界的方式。如果你是一个通用的三方平台（高德地图、Notion 等），想发布一个工具让其他 Agent 都能用上你的能力，那首先选择的还是 MCP。</p>
<p>但是，如果你有一些重复性的工作流，比如要以固定的流程读写本地文件、要用一个标准的范式来 Review 代码、有一套固定的风格来编写文章，这些场景都推荐使用 Skill 来实现。</p>
<p>在过去这几个需求中的本地文件读写、链接 Github、给文章生成图片这些需要链接外部世界的能力都得通过 MCP 去实现，但现在你可以都把它们打包到 Skill 里。</p>
<p>未来的格局可能是这样的（来自宝玉老师）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44b4c2ab83df4aa7acc86c6c698f6564~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=kAIHjl9bX3C4JEiWFD3sdICD%2BeQ%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>Agent 本身内置部分核心能力（bash、read、edit、write）</p>
</li>
<li>
<p>少数通用 MCP Server 负责远程连接（数据库、云 API、SaaS 集成）</p>
</li>
<li>
<p>大量 Skills 负责封装标准工作流、连接本地知识库</p>
</li>
<li>
<p>两者在必要时协作，但 Skills 会承担绝大部分 “教 AI 怎么做事” 的工作（这其中也包含教 AI 怎么用 McpServer、怎么用其他 Skills、怎么更好的调用核心能力）</p>
</li>
</ul>
<h2 data-id="heading-7">三、Skills 的初步尝试</h2>
<h3 data-id="heading-8">3.1 去哪找 Skills？</h3>
<p>和 MCP 一样，Skills 成了开放标准后开始爆发式增长，社区出现了大量的开源 Skills，很多 Skills 开放市场也应运而生，之前大部分 MCP Market 也都增加了 Skills 的分类：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6f9e0d0fa634d93b0ed13cc7437bee6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=j63UkXDBLUcAFd2tS4B1S9WY9vM%3D" alt="https://skillsmp.com/" loading="lazy"/></p>
<p>我们可以看到 skillsmp 中的 Skills 数量在最近经历着爆发式增长，这个增长速度要比之前的 MCP 爆火的时候还要快。这就不得不提 Skills 的另一大优点：编写门槛低！</p>
<p>MCP 虽然有一套标准的规范，但终究还是要靠代码编写的，即便有了 AI 辅助，对于小白来讲还是有一定的门槛的。</p>
<p>而 Skills 就不一样了，只要你会写提示词，就能写 Skill，可以预见的是，之前那些大量的固定工作流在未来可能都会被编写为 Skill，这也意味着 Agent 的编写门槛被再一次大幅降低了！</p>
<h3 data-id="heading-9">3.2 怎么使用 Skills？</h3>
<p>我们随便进入一个 MCP 市场，然后搜索我们要使用的 Skills，比如这里我们还以绘图软件 Excalidraw 为例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/381b6b22dbce4bd0b0985d4d9790fbec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=yrEldzKmOu%2BOWltsHtKjF%2FV3bu4%3D" alt="" loading="lazy"/></p>
<p>可以看到社区已经有大量 Excalidraw 的 Skill 了，我们这里选择 Star 最多的一款：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a71b7f5d7c9d41118bafc6753b5eae53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=BABGXdm3reRs0QDNVFG6AsVCxek%3D" alt="" loading="lazy"/></p>
<p>进入详情后，我们选择一个最简单的安装方式，直接把这个 Skill 下载到本地，点击 wget skill.zip：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eea9076dce84a829c4190159a1fb4a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=oWOx%2BNLsEGh68ks4bfwOM9fGBz4%3D" alt="" loading="lazy"/></p>
<p>然后我们把这个压缩包解压，你就会看到熟悉的目录。接下来，你只需要把这个目录下载到指定的位置：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/560d95454fa7433cbeed63806a92cd52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=lI5OU%2BLKvcePSj6ODY7C%2F%2BNvIa0%3D" alt="" loading="lazy"/></p>
<p>不同客户端的目录大同小异，基本上都是  .agentName/skills 目录，这里我们使用最近比较火的 OpenCode 进行演示（大家看可以自行选择 Cusor、Codex 等支持 skills 的客户端），所以我们创建一个新的文件夹，然后把刚刚下载的文件夹放到 .opencode/skills 目录下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e906cc5be0543fcbb04dfa38a2c5d13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=fNvojl%2BAffOXEYYzGgdF84DbfDE%3D" alt="" loading="lazy"/></p>
<p>接下来，我们在这个目录下打开 opencode 客户端，输入下面的提示词：</p>
<blockquote>
<p>帮我绘制一个架构图，讲解什么是 5W2H 分析法，直接帮我在当前目录下生成一个 excalidraw 文件。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac281475695a44f9afc1c4ab80c42ead~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=Ti%2FwNax1uHB0Hn71z268MrDEYh0%3D" alt="" loading="lazy"/></p>
<p>你不需要手动去 “安装” 或 “运行” Skill，只要文件放对位置了，OpenCode 的 AI 就会自动根据用户的需求判断要调用这个 Skill，然后帮我生成了代码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e64c284bb1cd487facff3a48ad791100~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=XFrSu3szoiZ2fOV6nTfGd8e5Daw%3D" alt="" loading="lazy"/></p>
<p>我们将生成的代码粘贴到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fexcalidraw.com%2F%25EF%25BC%258C%25E5%25B0%25B1%25E5%258F%25AF%25E4%25BB%25A5%25E7%259C%258B%25E5%2588%25B0%25E5%25B7%25B2%25E7%25BB%258F%25E7%2594%259F%25E6%2588%2590%25E5%25A5%25BD%25E7%259A%2584%25E6%259E%25B6%25E6%259E%2584%25E5%259B%25BE%25EF%25BC%259A" target="_blank" title="https://excalidraw.com/%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%B7%B2%E7%BB%8F%E7%94%9F%E6%88%90%E5%A5%BD%E7%9A%84%E6%9E%B6%E6%9E%84%E5%9B%BE%EF%BC%9A" ref="nofollow noopener noreferrer">excalidraw.com/，就可以看到已经生成好…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f1a3a2134074c44b8af3a750724df63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=QQ0iZ2oHlIqNNMhP%2FmX07tfpjv8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">3.3 创建你的第一个 Skill</h3>
<p>下面，我们一起来尝试做第一个 Skill，虽然 Skill 的开发门槛低，但这不意味着我们就要自己写！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d52327788e2c48978b4eb4479a793131~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=42sJ5XeD8Dt95sOrZeVnpz0ZLhA%3D" alt="" loading="lazy"/></p>
<p>Anthropic 官方直接给我们提供了一个 生产 Skills 的 Skill：Skill Creator。你不需要写一行代码或配置文件，只需要用自然语言告诉它你想做什么，它就会自动为你生成一个符合标准的 Skill 包。</p>
<p>接下来，按照刚才的流程，我们把这个 Skill 下载下来，放到 .opencode/skills 目录下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb224af2da5044e3b13892932bfbd5a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=4bvQ3I0ylcGrAdqoclUY8rc9vfQ%3D" alt="" loading="lazy"/></p>
<p>然后我们给出下面的提示词：</p>
<blockquote>
<p>帮我创建一个可以准确获取当前系统时间的 Skill，描述使用中文，脚本使用 Node.js。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1438eb4a744798af212af05b1570b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=faeXrM6LUqYCZ05ApFO0Vrhh%2BTw%3D" alt="" loading="lazy"/></p>
<p>然后，opencode 识别到我们的需求，开始调用 skill-creator：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c848b3ecaf1e4d408db8483feb7b6bd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=8S1q5TjcJi8LH1orzV7vxel9GrM%3D" alt="" loading="lazy"/></p>
<p>然后我们打开本地的 .opencode/skills  目录，发现多了一个 current-time-node skill，包含一个 SKILL.md 加一个获取准确时间的 Node.js 脚本：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce1633c10d444cdbb95d845c03d6263c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=B4w67RLm7sz9O6jpczRxJ%2FlBK%2Fg%3D" alt="" loading="lazy"/></p>
<p>接下来，我们询问 opencode：“获取当前系统时间”，然后它就会自动找到刚刚生成的 Skill 并调用里面的脚本：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c37a692f34e243e9b3bff1ecd04248db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=ZiBUairT8WmZeid2loH%2FVV0%2BG8k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">最后</h2>
<p>本期教程我们就先讲到这。</p>
<p>大家已经了解了 Agent Skill 的基本原理，以及如何使用和创建一个 Skill。</p>
<p>如果本期教程对你有所帮助，希望得到一个免费的三连和关注。</p>
<p>下一期，我们会进入实战章节，一期来使用 Agent Skill 实现一个知识库检索的功能，相比传统的 RAG ，它的效果究竟怎么样呢，我们下期见。</p>
<p>关注《code秘密花园》从此学习 AI 不迷路，相关链接：</p>
<ul>
<li>AI 教程完整汇总：<a href="https://link.juejin.cn?target=https%3A%2F%2Frncg5jvpme.feishu.cn%2Fwiki%2FU9rYwRHQoil6vBkitY8cbh5tnL9" target="_blank" title="https://rncg5jvpme.feishu.cn/wiki/U9rYwRHQoil6vBkitY8cbh5tnL9" ref="nofollow noopener noreferrer">rncg5jvpme.feishu.cn/wiki/U9rYwR…</a></li>
<li>相关学习资源汇总在：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Feasy-learn-ai" target="_blank" title="https://github.com/ConardLi/easy-learn-ai" ref="nofollow noopener noreferrer">github.com/ConardLi/ea…</a></li>
<li>本期视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1GXzaByEEo%2F" target="_blank" title="https://www.bilibili.com/video/BV1GXzaByEEo/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1GX…</a></li>
</ul>
<p>如果本期对你有所帮助，希望得到一个免费的三连，感谢大家支持！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native新架构之iOS端初始化源码分析]]></title>    <link>https://juejin.cn/post/7600223321041879046</link>    <guid>https://juejin.cn/post/7600223321041879046</guid>    <pubDate>2026-01-28T13:41:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041879046" data-draft-id="7594000527509274665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native新架构之iOS端初始化源码分析"/> <meta itemprop="keywords" content="React Native,iOS,源码阅读"/> <meta itemprop="datePublished" content="2026-01-28T13:41:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="编程之路从0到1"/> <meta itemprop="url" content="https://juejin.cn/user/4125023359744296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native新架构之iOS端初始化源码分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023359744296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    编程之路从0到1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T13:41:51.000Z" title="Wed Jan 28 2026 13:41:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React Native新架构之iOS端初始化源码分析</h2>
<h3 data-id="heading-1">前言</h3>
<p>注意，本文是基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact-native%2Ftree%2Fv0.83.0" target="_blank" title="https://github.com/facebook/react-native/tree/v0.83.0" ref="nofollow noopener noreferrer">React Native</a> 0.83版本源码进行分析。有了前面几篇Android端分析文章打基础，再来理解iOS端就易如反掌了。总的来说，iOS端的实现要比Android端简单太多了，这是因为Android端的Java/Kotlin 都是运行在Java的虚拟机环境中，其与C++通信要经过JNI，并不如OC与C++互调那么简单直接。此外，RN基于Android的Gradle构建机制，也使问题更加复杂。</p>
<h3 data-id="heading-2">初始化流程</h3>
<p>React Native的iOS端相比于安卓端要简单很多。现在我们基于Swift入口来分析一下初始化流程。首先找到RN源码工程中的测试工程，打开源码<code>react-native/private/helloworld/ios/HelloWorld/AppDelegate.swift</code>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> React                          <span class="hljs-comment">// React Native 核心模块</span>
<span class="hljs-keyword">import</span> ReactAppDependencyProvider     <span class="hljs-comment">// Codegen 生成的依赖提供者</span>
<span class="hljs-keyword">import</span> React_RCTAppDelegate           <span class="hljs-comment">// AppDelegate 相关类</span>
<span class="hljs-keyword">import</span> UIKit

<span class="hljs-keyword">@main</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {
  <span class="hljs-keyword">var</span> window: <span class="hljs-type">UIWindow</span>?

  <span class="hljs-keyword">var</span> reactNativeDelegate: <span class="hljs-type">ReactNativeDelegate</span>?
  <span class="hljs-keyword">var</span> reactNativeFactory: <span class="hljs-type">RCTReactNativeFactory</span>?

  <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(
    <span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>,
    <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span> <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
  ) -&gt; <span class="hljs-type">Bool</span> {
    <span class="hljs-comment">// 1: 创建 ReactNativeDelegate</span>
    <span class="hljs-keyword">let</span> delegate <span class="hljs-operator">=</span> <span class="hljs-type">ReactNativeDelegate</span>()
    <span class="hljs-comment">// 2: 创建 RCTReactNativeFactory</span>
    <span class="hljs-keyword">let</span> factory <span class="hljs-operator">=</span> <span class="hljs-type">RCTReactNativeFactory</span>(delegate: delegate)
    <span class="hljs-comment">// 3: 配置依赖提供者（Codegen 生成的模块）</span>
    delegate.dependencyProvider <span class="hljs-operator">=</span> <span class="hljs-type">RCTAppDependencyProvider</span>()

    <span class="hljs-comment">// 保持强引用</span>
    reactNativeDelegate <span class="hljs-operator">=</span> delegate
    reactNativeFactory <span class="hljs-operator">=</span> factory

    <span class="hljs-comment">// 4: 配置开发菜单（仅 DEBUG 模式）</span>
    <span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
    <span class="hljs-keyword">let</span> devMenuConfiguration <span class="hljs-operator">=</span> <span class="hljs-type">RCTDevMenuConfiguration</span>(
      devMenuEnabled: <span class="hljs-literal">true</span>,
      shakeGestureEnabled: <span class="hljs-literal">true</span>,
      keyboardShortcutsEnabled: <span class="hljs-literal">true</span>
    )
    reactNativeFactory<span class="hljs-operator">?</span>.devMenuConfiguration <span class="hljs-operator">=</span> devMenuConfiguration
    <span class="hljs-keyword">#endif</span>

    <span class="hljs-comment">// 5: 创建主窗口</span>
    window <span class="hljs-operator">=</span> <span class="hljs-type">UIWindow</span>(frame: <span class="hljs-type">UIScreen</span>.main.bounds)

    <span class="hljs-comment">// 6: 启动 React Native</span>
    factory.startReactNative(
      withModuleName: <span class="hljs-string">"HelloWorld"</span>,
      in: window,
      launchOptions: launchOptions
    )

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactNativeDelegate</span>: <span class="hljs-title class_">RCTDefaultReactNativeFactoryDelegate</span> {
  <span class="hljs-comment">// 旧架构兼容（新架构中会调用 bundleURL）</span>
  <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">sourceURL</span>(<span class="hljs-params">for</span> <span class="hljs-params">bridge</span>: <span class="hljs-type">RCTBridge</span>) -&gt; <span class="hljs-type">URL</span>? {
    <span class="hljs-keyword">self</span>.bundleURL()
  }

  <span class="hljs-comment">// 提供 JS Bundle 的 URL</span>
  <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">bundleURL</span>() -&gt; <span class="hljs-type">URL</span>? {
    <span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
    <span class="hljs-comment">// 开发模式：从 Metro 开发服务器加载</span>
    <span class="hljs-type">RCTBundleURLProvider</span>.sharedSettings().jsBundleURL(forBundleRoot: <span class="hljs-string">"index"</span>)
    <span class="hljs-keyword">#else</span>
    <span class="hljs-comment">// 生产模式：从 App Bundle 加载</span>
    <span class="hljs-type">Bundle</span>.main.url(forResource: <span class="hljs-string">"main"</span>, withExtension: <span class="hljs-string">"jsbundle"</span>)
    <span class="hljs-keyword">#endif</span>
  }
}
</code></pre>
<p>Swift 新架构使用 <code>@main</code> 注解作为应用入口，无需 <code>main.m</code> 或 <code>main.swift</code> 文件。<code>ReactNativeDelegate</code> 继承自 <code>RCTDefaultReactNativeFactoryDelegate</code>，负责提供 Bundle URL 和自定义配置。</p>
<p>这里<code>RCTAppDependencyProvider</code>是Objective-C++代码，这是为了方便与C++互调。源码<code>tcode/react-native/packages/react-native/Libraries/AppDelegate/RCTReactNativeFactory.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">RCTReactNativeFactory</span> () &lt;</span>
    RCTComponentViewFactoryComponentProvider, <span class="hljs-comment">// Fabric 组件提供者</span>
    RCTHostDelegate,                          <span class="hljs-comment">// RCTHost 代理</span>
    RCTJSRuntimeConfiguratorProtocol,         <span class="hljs-comment">// JS Runtime 配置</span>
    RCTTurboModuleManagerDelegate&gt;            <span class="hljs-comment">// TurboModule 管理器代理</span>
<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RCTReactNativeFactory</span></span>

- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTReactNativeFactoryDelegate&gt;)delegate
{
  <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> initWithDelegate:delegate releaseLevel:Stable];
}

- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTReactNativeFactoryDelegate&gt;)delegate releaseLevel:(RCTReleaseLevel)releaseLevel
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) {
    <span class="hljs-keyword">self</span>.delegate = delegate;
    [<span class="hljs-keyword">self</span> _setUpFeatureFlags:releaseLevel];
    <span class="hljs-comment">// 设置默认颜色空间</span>
    [RCTColorSpaceUtils applyDefaultColorSpace:[<span class="hljs-keyword">self</span> defaultColorSpace]];
    RCTEnableTurboModule(<span class="hljs-literal">YES</span>);

    <span class="hljs-comment">// 创建 RCTRootViewFactory</span>
    <span class="hljs-keyword">self</span>.rootViewFactory = [<span class="hljs-keyword">self</span> createRCTRootViewFactory];
    <span class="hljs-comment">// 设置第三方 Fabric 组件提供者</span>
    [RCTComponentViewFactory currentComponentViewFactory].thirdPartyFabricComponentsProvider = <span class="hljs-keyword">self</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;
}
</code></pre>
<p>可以看到RCTReactNativeFactory的构造逻辑非常简单，但它实现了四个关键协议，这使得它可以作为多个子系统的代理。</p>
<p>先重点看一下<code>createRCTRootViewFactory</code>方法的实现，这是一个关键方法，同时设置了大量的回调 Block 来桥接代理模式：</p>
<pre><code class="hljs language-objc" lang="objc">- (RCTRootViewFactory *)createRCTRootViewFactory
{
  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 1. 创建 Bundle URL 提供者 Block</span>
  RCTBundleURLBlock bundleUrlBlock = ^{
    auto *strongSelf = weakSelf;
    <span class="hljs-keyword">return</span> strongSelf.bundleURL;
  };

  <span class="hljs-comment">// 2. 创建配置对象（新架构默认全部启用）</span>
  RCTRootViewFactoryConfiguration *configuration =
      [[RCTRootViewFactoryConfiguration alloc] initWithBundleURLBlock:bundleUrlBlock
                                                       newArchEnabled:<span class="hljs-literal">YES</span>
                                                   turboModuleEnabled:<span class="hljs-literal">YES</span>
                                                    bridgelessEnabled:<span class="hljs-literal">YES</span>];

  <span class="hljs-comment">// 省略旧架构代码......</span>

  <span class="hljs-comment">// 3.配置根视图自定义回调</span>
  configuration.customizeRootView = ^(<span class="hljs-built_in">UIView</span> *_Nonnull rootView) {
    [weakSelf.delegate customizeRootView:(RCTRootView *)rootView];
  };

  <span class="hljs-comment">// 4.配置 Bundle URL 获取回调</span>
  configuration.sourceURLForBridge = ^<span class="hljs-built_in">NSURL</span> *_Nullable(RCTBridge *_Nonnull bridge)
  {
    <span class="hljs-comment">// 新架构：直接使用 bundleURL，不再依赖 bridge</span>
    <span class="hljs-keyword">return</span> [weakSelf.delegate bundleURL];
  };

  <span class="hljs-comment">// 5.配置 Bundle 加载回调（支持进度）</span>
  <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(loadSourceForBridge:onProgress:onComplete:)]) {
    configuration.loadSourceForBridgeWithProgress =
        ^(RCTBridge *_Nonnull bridge,
          RCTSourceLoadProgressBlock _Nonnull onProgress,
          RCTSourceLoadBlock _Nonnull loadCallback) {
          <span class="hljs-comment">// 新架构：使用 loadBundleAtURL 替代旧的 loadSourceForBridge</span>
          [weakSelf.delegate loadBundleAtURL:<span class="hljs-keyword">self</span>.bundleURL onProgress:onProgress onComplete:loadCallback];
        };
  }

  <span class="hljs-comment">// 6.配置无进度的 Bundle 加载回调</span>
  <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(loadSourceForBridge:withBlock:)]) {
    configuration.loadSourceForBridge = ^(RCTBridge *_Nonnull bridge, RCTSourceLoadBlock _Nonnull loadCallback) {
      <span class="hljs-comment">// 新架构：使用 loadBundleAtURL，进度回调为空</span>
      [weakSelf.delegate loadBundleAtURL:<span class="hljs-keyword">self</span>.bundleURL
                              onProgress:^(RCTLoadingProgress *progressData) {
                              }
                              onComplete:loadCallback];
    };
  }

  <span class="hljs-comment">// 7.设置 JS Runtime 代理</span>
  configuration.jsRuntimeConfiguratorDelegate = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 8.创建并返回 RCTRootViewFactory</span>
  <span class="hljs-keyword">return</span> [[RCTRootViewFactory alloc] initWithTurboModuleDelegate:<span class="hljs-keyword">self</span> hostDelegate:<span class="hljs-keyword">self</span> configuration:configuration];
}
</code></pre>
<p>这里的大概流程是非常清楚的，主要就是设置了四个协议的代理。我们将流程绘制成一个关系图：</p>
<pre><code class="hljs language-lua" lang="lua">┌─────────────────────────────────────────────────────────────────────────┐
│                        RCTReactNativeFactory                             │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 实现协议:                                                          │  │
│  │  • RCTTurboModuleManagerDelegate    → TurboModule 类/实例查找      │  │
│  │  • RCTHostDelegate                  → Host 生命周期 + Bundle 加载  │  │
│  │  • RCTJSRuntimeConfiguratorProtocol → JS Runtime 工厂创建         │  │
│  │  • RCTComponentViewFactoryComponentProvider → Fabric 组件注册     │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ createRCTRootViewFactory() 中设置:                                 │  │
│  │  • initWithTurboModuleDelegate: <span class="hljs-built_in">self</span>  ← RCTTurboModuleManagerDelegate│
│  │  • hostDelegate: <span class="hljs-built_in">self</span>                 ← RCTHostDelegate              │
│  │  • jsRuntimeConfiguratorDelegate: <span class="hljs-built_in">self</span> ← RCTJSRuntimeConfiguratorProtocol│
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 初始化时设置:                                                       │  │
│  │  • thirdPartyFabricComponentsProvider = <span class="hljs-built_in">self</span>                       │  │
│  │    ← RCTComponentViewFactoryComponentProvider                      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-3">RCTTurboModuleManagerDelegate</h4>
<p>主要负责 TurboModule 的类查找和实例创建，源码<code>react-native/packages/react-native/ReactCommon/react/nativemodule/core/platform/ios/ReactCommon/RCTTurboModuleManager.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTBridgeProxy</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTTurboModuleManager</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTDevMenuConfigurationDecorator</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTTurboModuleManagerDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>

<span class="hljs-comment">/**
 * 给定模块名称，返回其实际类。如果返回 nil，则执行基本的 ObjC 类查找
 */</span>
- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name;

<span class="hljs-comment">/**
 * 给定一个模块类，为其提供一个实例。如果返回值为 nil，则使用默认初始化器
 */</span>
- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass;

<span class="hljs-keyword">@optional</span>

<span class="hljs-comment">/**
 * 此方法用于获取一个工厂对象，该对象可以创建 `facebook::react::TurboModule` 实例。
 * 实现 `RCTTurboModuleProvider` 接口的类必须是 Objective-C 类，以便我们可以使用代码生成工具对其进行动态初始化。
 */</span>
- (<span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name;

<span class="hljs-comment">/**
 * 创建一个 TurboModule 实例，而无需依赖任何 ObjC++ 模块实例
 */</span>
- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:
                                                          (std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker;

- (<span class="hljs-type">void</span>)installJSBindings:(facebook::jsi::Runtime &amp;)runtime;

- (<span class="hljs-type">void</span>)invalidate;

<span class="hljs-keyword">@end</span>
</code></pre>
<p>再来看看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTTurboModuleManagerDelegate</span>

- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RN_DISABLE_OSS_PLUGIN_HEADER</span>
  <span class="hljs-keyword">return</span> RCTTurboModulePluginClassProvider(name);
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-comment">// 先尝试从 delegate 获取</span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleClassFromName:)]) {
    Class moduleClass = [_delegate getModuleClassFromName:name];
    <span class="hljs-keyword">if</span> (moduleClass != <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> moduleClass;
    }
  }
  <span class="hljs-keyword">return</span> RCTCoreModulesClassProvider(name);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}

- (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleProvider:)]) {
    <span class="hljs-keyword">return</span> [_delegate getModuleProvider:name];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
}

<span class="hljs-comment">// 创建纯 C++ TurboModule</span>
- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:(std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getTurboModule:jsInvoker:)]) {
    <span class="hljs-keyword">return</span> [_delegate getTurboModule:name jsInvoker:jsInvoker];
  }

  <span class="hljs-keyword">return</span> facebook::react::DefaultTurboModules::getTurboModule(name, jsInvoker);
}

- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_OSS_CODEGEN</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.delegate.dependencyProvider == <span class="hljs-literal">nil</span>) {
    [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"ReactNativeFactoryDelegate dependencyProvider is nil"</span>
                format:<span class="hljs-string">@"Delegate must provide a valid dependencyProvider"</span>];
  }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleInstanceFromClass:)]) {
    <span class="hljs-type">id</span>&lt;RCTTurboModule&gt; moduleInstance = [_delegate getModuleInstanceFromClass:moduleClass];
    <span class="hljs-keyword">if</span> (moduleInstance != <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> moduleInstance;
    }
  }
  <span class="hljs-comment">// 使用默认方式创建（通过 dependencyProvider）</span>
  <span class="hljs-keyword">return</span> RCTAppSetupDefaultModuleFromClass(moduleClass, <span class="hljs-keyword">self</span>.delegate.dependencyProvider);
}
</code></pre>
<h4 data-id="heading-4">RCTHostDelegate</h4>
<p>主要负责 RCTHost 的生命周期和 Bundle 加载。源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTHost.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-built_in">NS_ASSUME_NONNULL_BEGIN</span>

<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTFabricSurface</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTHost</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTModuleRegistry</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTDevMenuConfiguration</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTTurboModuleManagerDelegate</span>;</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-built_in">NSURL</span> *_Nullable (^RCTHostBundleURLProvider)(<span class="hljs-type">void</span>);

<span class="hljs-comment">// Runtime API</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTHostDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>
<span class="hljs-comment">// Host 启动完成通知</span>
- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host;

<span class="hljs-keyword">@optional</span>
<span class="hljs-comment">// 需要在主线程初始化的模块列表</span>
- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup;

<span class="hljs-comment">// 加载 Bundle（支持进度回调）</span>
- (<span class="hljs-type">void</span>)loadBundleAtURL:(<span class="hljs-built_in">NSURL</span> *)sourceURL
             onProgress:(RCTSourceLoadProgressBlock)onProgress
             onComplete:(RCTSourceLoadBlock)loadCallback;

<span class="hljs-keyword">@end</span>


<span class="hljs-built_in">NS_ASSUME_NONNULL_END</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTHostDelegate</span>

- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(hostDidStart:)]) {
    [_delegate hostDidStart:host];
  }
}

- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RN_DISABLE_OSS_PLUGIN_HEADER</span>
  <span class="hljs-keyword">return</span> RCTTurboModulePluginUnstableModulesRequiringMainQueueSetup();
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.delegate.dependencyProvider
      ? RCTAppSetupUnstableModulesRequiringMainQueueSetup(<span class="hljs-keyword">self</span>.delegate.dependencyProvider)
      : @[];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}
</code></pre>
<h4 data-id="heading-5">RCTJSRuntimeConfiguratorProtocol</h4>
<p>主要负责创建 JS Runtime 工厂，源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTJSRuntimeConfiguratorProtocol.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-built_in">NS_ASSUME_NONNULL_BEGIN</span>

<span class="hljs-comment">// Forward declarations for umbrella headers.</span>
<span class="hljs-comment">// In implementations, import `&lt;react/runtime/JSRuntimeFactoryCAPI.h&gt;` to obtain the actual type.</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> *JSRuntimeFactoryRef;

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTJSRuntimeConfiguratorProtocol</span></span>

<span class="hljs-comment">// 创建 JS Runtime 工厂（通常返回 Hermes）</span>
- (JSRuntimeFactoryRef)createJSRuntimeFactory;

<span class="hljs-keyword">@end</span>

<span class="hljs-built_in">NS_ASSUME_NONNULL_END</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTJSRuntimeConfiguratorProtocol</span>

- (JSRuntimeFactoryRef)createJSRuntimeFactory
{
  <span class="hljs-comment">// 委托给用户的 delegate</span>
  <span class="hljs-keyword">return</span> [_delegate createJSRuntimeFactory];
}
</code></pre>
<h4 data-id="heading-6">RCTComponentViewFactoryComponentProvider</h4>
<p>主要负责提供第三方 Fabric 组件，源码<code>react-native/packages/react-native/React/Fabric/Mounting/RCTComponentViewFactory.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">/**
 * 可用于向 Fabric 提供第三方组件的协议。
 * Fabric 将检查此映射表，以确定是否存在需要注册的组件。
 */</span>
<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTComponentViewFactoryComponentProvider</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>

<span class="hljs-comment">/**
 * 返回一个第三方组件字典，其中 `key` 是组件处理程序，`value` 是一个符合 `RCTComponentViewProtocol` 协议的类
 */</span>
- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents;

<span class="hljs-keyword">@end</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTComponentViewFactoryComponentProvider</span>

- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents
{
  <span class="hljs-comment">// 先尝试从 delegate 获取</span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(thirdPartyFabricComponents)]) {
    <span class="hljs-keyword">return</span> _delegate.thirdPartyFabricComponents;
  }
  <span class="hljs-comment">// 回退到 dependencyProvider（Codegen 生成）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.delegate.dependencyProvider ? <span class="hljs-keyword">self</span>.delegate.dependencyProvider.thirdPartyFabricComponents : @{};
}
</code></pre>
<h4 data-id="heading-7">RCTDefaultReactNativeFactoryDelegate</h4>
<p>以上协的很多方法的实现，其实也是代理给<strong>RCTReactNativeFactory</strong> 中的<code>delegate</code>对象。此<code>delegate</code>也就是我们最开始自定义的<code>ReactNativeDelegate</code>实例。其也是继承自<code>RCTDefaultReactNativeFactoryDelegate</code>，现在分析一下此类的实现，源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTDefaultReactNativeFactoryDelegate.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RCTDefaultReactNativeFactoryDelegate</span></span>

<span class="hljs-keyword">@synthesize</span> dependencyProvider;
<span class="hljs-comment">// 抽象方法：子类必须实现</span>
- (<span class="hljs-built_in">NSURL</span> *_Nullable)sourceURLForBridge:(<span class="hljs-keyword">nonnull</span> RCTBridge *)bridge
{
  [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"RCTBridgeDelegate::sourceURLForBridge not implemented"</span>
              format:<span class="hljs-string">@"Subclasses must implement a valid sourceURLForBridge method"</span>];
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
}

- (<span class="hljs-built_in">UIViewController</span> *)createRootViewController
{
  <span class="hljs-keyword">return</span> [<span class="hljs-built_in">UIViewController</span> new];
}

- (<span class="hljs-type">void</span>)setRootView:(<span class="hljs-built_in">UIView</span> *)rootView toRootViewController:(<span class="hljs-built_in">UIViewController</span> *)rootViewController
{
  rootViewController.view = rootView;
}

- (JSRuntimeFactoryRef)createJSRuntimeFactory
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_THIRD_PARTY_JSC != 1</span>
  <span class="hljs-keyword">return</span> jsrt_create_hermes_factory();
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}

- (<span class="hljs-type">void</span>)customizeRootView:(RCTRootView *)rootView
{
  <span class="hljs-comment">// Override point for customization after application launch.</span>
}

- (RCTColorSpace)defaultColorSpace
{
  <span class="hljs-keyword">return</span> RCTColorSpaceSRGB;
}

- (<span class="hljs-built_in">NSURL</span> *_Nullable)bundleURL
{
  [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"RCTAppDelegate::bundleURL not implemented"</span>
              format:<span class="hljs-string">@"Subclasses must implement a valid getBundleURL method"</span>];
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents
{
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr) ? <span class="hljs-keyword">self</span>.dependencyProvider.thirdPartyFabricComponents : @{};
}

- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host
{
}

- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup
{
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr)
      ? RCTAppSetupUnstableModulesRequiringMainQueueSetup(<span class="hljs-keyword">self</span>.dependencyProvider)
      : @[];
}

- (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-built_in">NSString</span> *providerName = [<span class="hljs-built_in">NSString</span> stringWithCString:name encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr) ? <span class="hljs-keyword">self</span>.dependencyProvider.moduleProviders[providerName] : nullptr;
}

- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:(std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker
{
  <span class="hljs-keyword">return</span> facebook::react::DefaultTurboModules::getTurboModule(name, jsInvoker);
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTArchConfiguratorProtocol</span>

- (<span class="hljs-type">BOOL</span>)newArchEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)bridgelessEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)fabricEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)turboModuleEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass
{
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-type">void</span>)loadSourceForBridge:(RCTBridge *)bridge
                 onProgress:(RCTSourceLoadProgressBlock)onProgress
                 onComplete:(RCTSourceLoadBlock)loadCallback
{
  [RCTJavaScriptLoader loadBundleAtURL:[<span class="hljs-keyword">self</span> sourceURLForBridge:bridge] onProgress:onProgress onComplete:loadCallback];
}

<span class="hljs-keyword">@end</span>
</code></pre>
<h4 data-id="heading-8">React Native 启动</h4>
<p>对于以上四个协议以及代理，我们已经有了大概认识，现在应该把视线拉回<strong>AppDelegate</strong>中的初始化流程，继续分析<code>startReactNative</code>方法的实现，它对应的OC方法名应该是<code>startReactNativeWithModuleName</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)startReactNativeWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                              inWindow:(<span class="hljs-built_in">UIWindow</span> *_Nullable)window
                         launchOptions:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)launchOptions
{
  [<span class="hljs-keyword">self</span> startReactNativeWithModuleName:moduleName inWindow:window initialProperties:<span class="hljs-literal">nil</span> launchOptions:launchOptions];
}

- (<span class="hljs-type">void</span>)startReactNativeWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                              inWindow:(<span class="hljs-built_in">UIWindow</span> *_Nullable)window
                     initialProperties:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)initialProperties
                         launchOptions:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)launchOptions
{
  <span class="hljs-comment">// 1. 通过 RootViewFactory 创建根视图</span>
  <span class="hljs-built_in">UIView</span> *rootView = [<span class="hljs-keyword">self</span>.rootViewFactory viewWithModuleName:moduleName
                                            initialProperties:initialProperties
                                                launchOptions:launchOptions
                                         devMenuConfiguration:<span class="hljs-keyword">self</span>.devMenuConfiguration];
  <span class="hljs-comment">// 2. 创建 RootViewController</span>
  <span class="hljs-built_in">UIViewController</span> *rootViewController = [_delegate createRootViewController];
  <span class="hljs-comment">// 3. 设置根视图</span>
  [_delegate setRootView:rootView toRootViewController:rootViewController];
  <span class="hljs-comment">// 4. 配置窗口并显示</span>
  window.rootViewController = rootViewController;
  [window makeKeyAndVisible];
}
</code></pre>
<p>可以看到，流程十分清楚，我们继续跟踪<code>viewWithModuleName</code>方法实现。</p>
<h5 data-id="heading-9">RCTHost  (ReactHost)初始化</h5>
<p>查看源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTRootViewFactory.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-built_in">UIView</span> *)viewWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
             initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)initProps
                 launchOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
          devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-comment">// 1. 初始化 ReactHost</span>
  [<span class="hljs-keyword">self</span> initializeReactHostWithLaunchOptions:launchOptions devMenuConfiguration:devMenuConfiguration];

  <span class="hljs-comment">// 2. 创建 Fabric Surface</span>
  RCTFabricSurface *surface = [<span class="hljs-keyword">self</span>.reactHost createSurfaceWithModuleName:moduleName
                                                        initialProperties:initProps ? initProps : @{}];
   <span class="hljs-comment">// 3. 创建 SurfaceHostingProxyRootView</span>
  RCTSurfaceHostingProxyRootView *surfaceHostingProxyRootView =
      [[RCTSurfaceHostingProxyRootView alloc] initWithSurface:surface];

  surfaceHostingProxyRootView.backgroundColor = [<span class="hljs-built_in">UIColor</span> systemBackgroundColor];
  <span class="hljs-keyword">if</span> (_configuration.customizeRootView != <span class="hljs-literal">nil</span>) {
    <span class="hljs-comment">// 4. 自定义根视图</span>
    _configuration.customizeRootView(surfaceHostingProxyRootView);
  }
  <span class="hljs-keyword">return</span> surfaceHostingProxyRootView;
}


- (<span class="hljs-type">void</span>)initializeReactHostWithLaunchOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
                        devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-comment">// Enable TurboModule interop by default in Bridgeless mode</span>
  RCTEnableTurboModuleInterop(<span class="hljs-literal">YES</span>);
  RCTEnableTurboModuleInteropBridgeProxy(<span class="hljs-literal">YES</span>);

  [<span class="hljs-keyword">self</span> createReactHostIfNeeded:launchOptions devMenuConfiguration:devMenuConfiguration];
  <span class="hljs-keyword">return</span>;
}

- (<span class="hljs-type">void</span>)createReactHostIfNeeded:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
           devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.reactHost) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">self</span>.reactHost = [<span class="hljs-keyword">self</span> createReactHost:launchOptions devMenuConfiguration:devMenuConfiguration];
}


- (RCTHost *)createReactHost:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
        devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  RCTHost *reactHost =
      [[RCTHost alloc] initWithBundleURLProvider:<span class="hljs-keyword">self</span>-&gt;_configuration.bundleURLBlock
                                    hostDelegate:_hostDelegate
                      turboModuleManagerDelegate:_turboModuleManagerDelegate
                                jsEngineProvider:^std::shared_ptr&lt;facebook::react::JSRuntimeFactory&gt;() {
                                  <span class="hljs-keyword">return</span> [weakSelf createJSRuntimeFactory];
                                }
                                   launchOptions:launchOptions
                            devMenuConfiguration:devMenuConfiguration];
  <span class="hljs-comment">// 设置 Bundle URL 提供者</span>
  [reactHost setBundleURLProvider:^<span class="hljs-built_in">NSURL</span> *() {
    <span class="hljs-keyword">return</span> [weakSelf bundleURL];
  }];
  <span class="hljs-comment">// 启动 ReactHost</span>
  [reactHost start];
  <span class="hljs-keyword">return</span> reactHost;
}
</code></pre>
<h5 data-id="heading-10">RCTInstance 初始化</h5>
<p>继续跟踪<code>RCTHost</code>的<code>start</code>方法。源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTHost.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)start
{
  <span class="hljs-comment">// 1. 设置 Bundle URL</span>
  <span class="hljs-keyword">if</span> (_bundleURLProvider) {
    [<span class="hljs-keyword">self</span> _setBundleURL:_bundleURLProvider()];
  }

  <span class="hljs-comment">// 2. 设置 Inspector Target（用于调试）</span>
  auto &amp;inspectorFlags = jsinspector_modern::InspectorFlags::getInstance();
  <span class="hljs-keyword">if</span> (inspectorFlags.getFuseboxEnabled() &amp;&amp; !_inspectorPageId.has_value()) {
    _inspectorTarget =
        facebook::react::jsinspector_modern::HostTarget::create(*_inspectorHostDelegate, [](auto callback) {
          RCTExecuteOnMainQueue(^{
            callback();
          });
        });
    __<span class="hljs-keyword">weak</span> RCTHost *weakSelf = <span class="hljs-keyword">self</span>;
    _inspectorPageId = facebook::react::jsinspector_modern::getInspectorInstance().addPage(
        <span class="hljs-string">"React Native Bridgeless"</span>,
        <span class="hljs-comment">/* vm */</span> <span class="hljs-string">""</span>,
        [weakSelf](std::unique_ptr&lt;facebook::react::jsinspector_modern::IRemoteConnection&gt; remote)
            -&gt; std::unique_ptr&lt;facebook::react::jsinspector_modern::ILocalConnection&gt; {
          RCTHost *strongSelf = weakSelf;
          <span class="hljs-keyword">if</span> (!strongSelf) {
            <span class="hljs-comment">// This can happen if we're about to be dealloc'd. Reject the connection.</span>
            <span class="hljs-keyword">return</span> nullptr;
          }
          <span class="hljs-keyword">return</span> strongSelf-&gt;_inspectorTarget-&gt;connect(std::move(remote));
        },
        {.nativePageReloads = <span class="hljs-literal">true</span>, .prefersFuseboxFrontend = <span class="hljs-literal">true</span>});
  }
  <span class="hljs-keyword">if</span> (_instance) {
    RCTLogWarn(
        <span class="hljs-string">@"RCTHost should not be creating a new instance if one already exists. This implies there is a bug with how/when this method is being called."</span>);
    [_instance invalidate];
  }

  <span class="hljs-comment">// 3. 创建 RCTInstance</span>
  _instance = [[RCTInstance alloc] initWithDelegate:<span class="hljs-keyword">self</span>
                                   jsRuntimeFactory:[<span class="hljs-keyword">self</span> _provideJSEngine]
                                      bundleManager:_bundleManager
                         turboModuleManagerDelegate:_turboModuleManagerDelegate
                                     moduleRegistry:_moduleRegistry
                              parentInspectorTarget:_inspectorTarget.get()
                                      launchOptions:_launchOptions
                               devMenuConfiguration:_devMenuConfiguration];
  <span class="hljs-comment">// 4. 通知代理 Host 已启动</span>
  [_hostDelegate hostDidStart:<span class="hljs-keyword">self</span>];
}
</code></pre>
<p>继续查看<code>RCTInstance</code>的构造实现，源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTInstance.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTInstanceDelegate&gt;)delegate
                jsRuntimeFactory:(std::shared_ptr&lt;facebook::react::JSRuntimeFactory&gt;)jsRuntimeFactory
                   bundleManager:(RCTBundleManager *)bundleManager
      turboModuleManagerDelegate:(<span class="hljs-type">id</span>&lt;RCTTurboModuleManagerDelegate&gt;)tmmDelegate
                  moduleRegistry:(RCTModuleRegistry *)moduleRegistry
           parentInspectorTarget:(jsinspector_modern::HostTarget *)parentInspectorTarget
                   launchOptions:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span> *)launchOptions
            devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) {
    <span class="hljs-comment">// 性能监控初始化</span>
    _performanceLogger = [RCTPerformanceLogger new];
    registerPerformanceLoggerHooks(_performanceLogger);
    [_performanceLogger markStartForTag:RCTPLReactInstanceInit];

    <span class="hljs-comment">// 保存外部传入的关键依赖</span>
    _delegate = delegate;
    _jsRuntimeFactory = jsRuntimeFactory;
    _appTMMDelegate = tmmDelegate;
    _jsThreadManager = [RCTJSThreadManager new];

    <span class="hljs-comment">// 开发菜单配置</span>
    _devMenuConfigurationDecorator =
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU</span>
        [[RCTDevMenuConfigurationDecorator alloc] initWithDevMenuConfiguration:devMenuConfiguration];
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
        <span class="hljs-literal">nil</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

    _parentInspectorTarget = parentInspectorTarget;

    <span class="hljs-comment">// JS 模块调用器配置(设置 Bridgeless 模式下的 JS 模块方法调用器)</span>
    {
      __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
      [_bridgeModuleDecorator.callableJSModules
          setBridgelessJSModuleMethodInvoker:^(
              <span class="hljs-built_in">NSString</span> *moduleName, <span class="hljs-built_in">NSString</span> *methodName, <span class="hljs-built_in">NSArray</span> *args, dispatch_block_t onComplete) {
            [weakSelf callFunctionOnJSModule:moduleName method:methodName args:args];
            <span class="hljs-keyword">if</span> (onComplete) {
              [weakSelf
                  callFunctionOnBufferedRuntimeExecutor:[onComplete](facebook::jsi::Runtime &amp;_) { onComplete(); }];
            }
          }];
    }
    _launchOptions = launchOptions;

    <span class="hljs-comment">// 内存警告监听</span>
    [[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="hljs-keyword">self</span>
                                             selector:<span class="hljs-keyword">@selector</span>(_handleMemoryWarning)
                                                 name:<span class="hljs-built_in">UIApplicationDidReceiveMemoryWarningNotification</span>
                                               object:<span class="hljs-literal">nil</span>];
    <span class="hljs-comment">// 启动核心初始化</span>
    [<span class="hljs-keyword">self</span> _start];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;
}
</code></pre>
<p>接下来，我们来看整个初始化过程的核心方法<code>_start</code>实现：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)_start
{
  <span class="hljs-comment">// 1.设置定时器系统</span>
  auto objCTimerRegistry = std::make_unique&lt;ObjCTimerRegistry&gt;();
  auto timing = objCTimerRegistry-&gt;timing;
  auto *objCTimerRegistryRawPtr = objCTimerRegistry.get();

  auto timerManager = std::make_shared&lt;TimerManager&gt;(std::move(objCTimerRegistry));
  objCTimerRegistryRawPtr-&gt;setTimerManager(timerManager);

  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  auto onJsError = [=](jsi::Runtime &amp;runtime, <span class="hljs-keyword">const</span> JsErrorHandler::ProcessedError &amp;error) {
    [weakSelf _handleJSError:error withRuntime:runtime];
  };

  <span class="hljs-comment">// 2.创建 ReactInstance (C++ 层)</span>
  _reactInstance = std::make_unique&lt;ReactInstance&gt;(
      _jsRuntimeFactory-&gt;createJSRuntime(_jsThreadManager.jsMessageThread),
      _jsThreadManager.jsMessageThread,
      timerManager,
      onJsError,
      _parentInspectorTarget);
  _valid = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// 3.设置 RuntimeExecutor</span>
  RuntimeExecutor bufferedRuntimeExecutor = _reactInstance-&gt;getBufferedRuntimeExecutor();
  timerManager-&gt;setRuntimeExecutor(bufferedRuntimeExecutor);

  auto jsCallInvoker = make_shared&lt;RuntimeSchedulerCallInvoker&gt;(_reactInstance-&gt;getRuntimeScheduler());
  <span class="hljs-comment">// 省略旧架构......</span>

  <span class="hljs-comment">// 4.创建 TurboModuleManager</span>
  _turboModuleManager = [[RCTTurboModuleManager alloc] initWithBridgeProxy:bridgeProxy
                                                     bridgeModuleDecorator:_bridgeModuleDecorator
                                                                  delegate:<span class="hljs-keyword">self</span>
                                                                 jsInvoker:jsCallInvoker
                                             devMenuConfigurationDecorator:_devMenuConfigurationDecorator];

<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV</span>
  <span class="hljs-comment">/**
    * 实例化 DevMenu 会产生副作用，即通过 RCTDevMenu 注册
    * CMD + d、CMD + i 和 CMD + n 的快捷键。 
    * 因此，启用 TurboModules 时，我们必须手动创建此NativeModule。
   */</span>
  [_turboModuleManager moduleForName:<span class="hljs-string">"RCTDevMenu"</span>];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// end RCT_DEV</span></span>

  <span class="hljs-comment">// 初始化 RCTModuleRegistry，以便 TurboModules 可以引用其他 TurboModules</span>
  [_bridgeModuleDecorator.moduleRegistry setTurboModuleRegistry:_turboModuleManager];

  <span class="hljs-keyword">if</span> (ReactNativeFeatureFlags::enableEagerMainQueueModulesOnIOS()) {
    <span class="hljs-comment">/**
     * 某些原生模块需要在主线程上捕获 UIKit 对象。
     * 因此，请在此处的主队列上开始初始化这些模块。JavaScript 线程将等待这些模块初始化完成后，才会执行 JavaScript 代码包。
     */</span>
    <span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *modulesRequiringMainQueueSetup = [_delegate unstableModulesRequiringMainQueueSetup];

    std::shared_ptr&lt;std::mutex&gt; mutex = std::make_shared&lt;std::mutex&gt;();
    std::shared_ptr&lt;std::condition_variable&gt; cv = std::make_shared&lt;std::condition_variable&gt;();
    std::shared_ptr&lt;<span class="hljs-type">bool</span>&gt; isReady = std::make_shared&lt;<span class="hljs-type">bool</span>&gt;(<span class="hljs-literal">false</span>);

    _waitUntilModuleSetupComplete = ^{
      std::unique_lock&lt;std::mutex&gt; lock(*mutex);
      cv-&gt;wait(lock, [isReady] { <span class="hljs-keyword">return</span> *isReady; });
    };

    <span class="hljs-comment">// TODO(T218039767): 将性能日志记录功能集成到主队列模块初始化过程中</span>
    RCTExecuteOnMainQueue(^{
      <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSString</span> *moduleName <span class="hljs-keyword">in</span> modulesRequiringMainQueueSetup) {
        [<span class="hljs-keyword">self</span>-&gt;_bridgeModuleDecorator.moduleRegistry moduleForName:[moduleName UTF8String]];
      }

      RCTScreenSize();
      RCTScreenScale();
      RCTSwitchSize();

      std::lock_guard&lt;std::mutex&gt; lock(*mutex);
      *isReady = <span class="hljs-literal">true</span>;
      cv-&gt;notify_all();
    });
  }

  RCTLogSetBridgelessModuleRegistry(_bridgeModuleDecorator.moduleRegistry);
  RCTLogSetBridgelessCallableJSModules(_bridgeModuleDecorator.callableJSModules);

  <span class="hljs-comment">// 5.创建 ContextContainer</span>
  auto contextContainer = std::make_shared&lt;ContextContainer&gt;();
  [_delegate didCreateContextContainer:contextContainer];
  <span class="hljs-comment">// 插入核心模块</span>
  contextContainer-&gt;insert(
      <span class="hljs-string">"RCTImageLoader"</span>, facebook::react::wrapManagedObject([_turboModuleManager moduleForName:<span class="hljs-string">"RCTImageLoader"</span>]));
  contextContainer-&gt;insert(
      <span class="hljs-string">"RCTEventDispatcher"</span>,
      facebook::react::wrapManagedObject([_turboModuleManager moduleForName:<span class="hljs-string">"RCTEventDispatcher"</span>]));
  contextContainer-&gt;insert(<span class="hljs-string">"RCTBridgeModuleDecorator"</span>, facebook::react::wrapManagedObject(_bridgeModuleDecorator));
  contextContainer-&gt;insert(RuntimeSchedulerKey, std::weak_ptr&lt;RuntimeScheduler&gt;(_reactInstance-&gt;getRuntimeScheduler()));
  contextContainer-&gt;insert(<span class="hljs-string">"RCTBridgeProxy"</span>, facebook::react::wrapManagedObject(bridgeProxy));

  <span class="hljs-comment">// 6.创建 SurfacePresenter</span>
  _surfacePresenter = [[RCTSurfacePresenter alloc]
        initWithContextContainer:contextContainer
                 runtimeExecutor:bufferedRuntimeExecutor
      bridgelessBindingsExecutor:std::optional(_reactInstance-&gt;getUnbufferedRuntimeExecutor())];

  <span class="hljs-comment">// 这使得模块中的 RCTViewRegistry 能够通过其 viewForReactTag 方法返回 UIView 对象</span>
  __<span class="hljs-keyword">weak</span> RCTSurfacePresenter *weakSurfacePresenter = _surfacePresenter;
  [_bridgeModuleDecorator.viewRegistry_DEPRECATED setBridgelessComponentViewProvider:^<span class="hljs-built_in">UIView</span> *(<span class="hljs-built_in">NSNumber</span> *reactTag) {
    RCTSurfacePresenter *strongSurfacePresenter = weakSurfacePresenter;
    <span class="hljs-keyword">if</span> (strongSurfacePresenter == <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
    }

    <span class="hljs-keyword">return</span> [strongSurfacePresenter findComponentViewWithTag_DO_NOT_USE_DEPRECATED:reactTag.integerValue];
  }];

  <span class="hljs-comment">// 7.创建DisplayLink （用于调用计时器回调函数）</span>
  _displayLink = [RCTDisplayLink new];

  auto &amp;inspectorFlags = jsinspector_modern::InspectorFlags::getInstance();

  ReactInstance::JSRuntimeFlags options = {
      .isProfiling = inspectorFlags.getIsProfilingBuild(),
      .runtimeDiagnosticFlags = [RCTInstanceRuntimeDiagnosticFlags() UTF8String]};

  <span class="hljs-comment">// 8.初始化 JS Runtime 并加载 Bundle</span>
  _reactInstance-&gt;initializeRuntime(options, [=](jsi::Runtime &amp;runtime) {
    __<span class="hljs-keyword">strong</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
    <span class="hljs-keyword">if</span> (!strongSelf) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 安装 TurboModule JS 绑定</span>
    [strongSelf-&gt;_turboModuleManager installJSBindings:runtime];
    <span class="hljs-comment">// 绑定 Native Logger</span>
    facebook::react::bindNativeLogger(runtime, [](<span class="hljs-keyword">const</span> std::string &amp;message, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> logLevel) {
      _RCTLogJavaScriptInternal(static_cast&lt;RCTLogLevel&gt;(logLevel), [<span class="hljs-built_in">NSString</span> stringWithUTF8String:message.c_str()]);
    });

    <span class="hljs-comment">// 安装 Native Component Registry 绑定</span>
    RCTInstallNativeComponentRegistryBinding(runtime);

    <span class="hljs-comment">// 通知代理 Runtime 已初始化</span>
    [strongSelf-&gt;_delegate instance:strongSelf didInitializeRuntime:runtime];

    <span class="hljs-comment">// 设置 DisplayLink</span>
    <span class="hljs-type">id</span>&lt;RCTDisplayLinkModuleHolder&gt; moduleHolder = [[RCTBridgelessDisplayLinkModuleHolder alloc] initWithModule:timing];
    [strongSelf-&gt;_displayLink registerModuleForFrameUpdates:timing withModuleHolder:moduleHolder];
    [strongSelf-&gt;_displayLink addToRunLoop:[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]];

    <span class="hljs-comment">// 尝试同步加载bundle包，如果失败则回退到异步加载。</span>
    [strongSelf-&gt;_performanceLogger markStartForTag:RCTPLScriptDownload];
    [strongSelf _loadJSBundle:[strongSelf-&gt;_bridgeModuleDecorator.bundleManager bundleURL]];
  });

  [_performanceLogger markStopForTag:RCTPLReactInstanceInit];
}
</code></pre>
<h5 data-id="heading-11">JS Bundle 加载</h5>
<p>继续查看<code>_loadJSBundle</code>方法的实现：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)_loadJSBundle:(<span class="hljs-built_in">NSURL</span> *)sourceURL
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU &amp;&amp; __has_include(<span class="hljs-string">&lt;React/RCTDevLoadingViewProtocol.h&gt;)</span></span>
  {
    <span class="hljs-comment">// 显示加载视图</span>
    <span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt; loadingView =
        (<span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt;)[_turboModuleManager moduleForName:<span class="hljs-string">"DevLoadingView"</span>];
    [loadingView showWithURL:sourceURL];
  }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 通过代理加载 Bundle</span>
  [_delegate loadBundleAtURL:sourceURL
      onProgress:^(RCTLoadingProgress *progressData) {
        __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
        <span class="hljs-keyword">if</span> (!strongSelf) {
          <span class="hljs-keyword">return</span>;
        }

<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU &amp;&amp; __has_include(<span class="hljs-string">&lt;React/RCTDevLoadingViewProtocol.h&gt;)</span></span>
        <span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt; loadingView =
            (<span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt;)[strongSelf-&gt;_turboModuleManager moduleForName:<span class="hljs-string">"DevLoadingView"</span>];
        [loadingView updateProgress:progressData];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
      }
      onComplete:^(<span class="hljs-built_in">NSError</span> *error, RCTSource *source) {
        __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
        <span class="hljs-keyword">if</span> (!strongSelf) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (error) {
          [strongSelf handleBundleLoadingError:error];
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// _loadScriptFromSource 函数的回调函数需要 DevSettings 模块，因此需要提前进行初始化。</span>
        RCTDevSettings *<span class="hljs-keyword">const</span> devSettings =
            (RCTDevSettings *)[strongSelf-&gt;_turboModuleManager moduleForName:<span class="hljs-string">"DevSettings"</span>];

        <span class="hljs-comment">// 加载脚本</span>
        [strongSelf _loadScriptFromSource:source];
        <span class="hljs-comment">// 仅在开发环境中启用热模块重载功能。</span>
        [strongSelf-&gt;_performanceLogger markStopForTag:RCTPLScriptDownload];
        [devSettings setupHMRClientWithBundleURL:sourceURL];
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV</span>
        [strongSelf _logOldArchitectureWarnings];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
      }];
}


- (<span class="hljs-type">void</span>)_loadScriptFromSource:(RCTSource *)source
{
  std::lock_guard&lt;std::mutex&gt; lock(_invalidationMutex);
  <span class="hljs-keyword">if</span> (!_valid) {
    <span class="hljs-keyword">return</span>;
  }

  auto script = std::make_unique&lt;<span class="hljs-built_in">NSDataBigString</span>&gt;(source.data);
  <span class="hljs-keyword">const</span> auto *url = deriveSourceURL(source.url).UTF8String;

  auto beforeLoad = [waitUntilModuleSetupComplete = <span class="hljs-keyword">self</span>-&gt;_waitUntilModuleSetupComplete](jsi::Runtime &amp;_) {
    <span class="hljs-keyword">if</span> (waitUntilModuleSetupComplete) {
      waitUntilModuleSetupComplete();
    }
  };
  auto afterLoad = [](jsi::Runtime &amp;_) {
    [[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:<span class="hljs-string">@"RCTInstanceDidLoadBundle"</span> object:<span class="hljs-literal">nil</span>];
  };
  <span class="hljs-comment">// 在 ReactInstance 中执行脚本</span>
  _reactInstance-&gt;loadScript(std::move(script), url, beforeLoad, afterLoad);
}
</code></pre>
<h5 data-id="heading-12">Surface 创建与启动</h5>
<p>现在，我们把视线拉回<code>viewWithModuleName</code>方法中，继续分析后面的<code>createSurfaceWithModuleName</code>方法的实现。源码<code>RCTHost.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (RCTFabricSurface *)createSurfaceWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)properties
{
  <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> createSurfaceWithModuleName:moduleName mode:DisplayMode::Visible initialProperties:properties];
}

- (RCTFabricSurface *)createSurfaceWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                                             mode:(DisplayMode)displayMode
                                initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)properties
{
  <span class="hljs-comment">// 1. 创建 FabricSurface</span>
  RCTFabricSurface *surface = [[RCTFabricSurface alloc] initWithSurfacePresenter:<span class="hljs-keyword">self</span>.surfacePresenter
                                                                      moduleName:moduleName
                                                               initialProperties:properties];
  <span class="hljs-comment">// 2. 设置显示模式</span>
  surface.surfaceHandler.setDisplayMode(displayMode);

  <span class="hljs-comment">// 3. 附加 Surface</span>
  [<span class="hljs-keyword">self</span> _attachSurface:surface];

  __<span class="hljs-keyword">weak</span> RCTFabricSurface *weakSurface = surface;
  <span class="hljs-comment">// 在 JS Bundle 执行完成后，使用BufferedRuntimeExecutor启动Surface</span>
  [_instance callFunctionOnBufferedRuntimeExecutor:[weakSurface](facebook::jsi::Runtime &amp;_) { [weakSurface start]; }];
  <span class="hljs-keyword">return</span> surface;
}
</code></pre>
<h3 data-id="heading-13">总结</h3>
<p>初始化的大概流程：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">Swift</span> <span class="hljs-string">应用层</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">AppDelegate</span>                                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactNativeDelegate:</span> <span class="hljs-string">ReactNativeDelegate</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-attr">reactNativeFactory:</span> <span class="hljs-string">RCTReactNativeFactory</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-attr">ReactNativeDelegate :</span> <span class="hljs-string">RCTDefaultReactNativeFactoryDelegate</span>  <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">bundleURL()</span> <span class="hljs-string">→</span> <span class="hljs-string">URL?</span>                                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-attr">dependencyProvider:</span> <span class="hljs-string">RCTAppDependencyProvider</span>          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">Factory</span> <span class="hljs-string">层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTReactNativeFactory</span>                                       <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">delegate:</span> <span class="hljs-string">RCTReactNativeFactoryDelegate</span>               <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">rootViewFactory:</span> <span class="hljs-string">RCTRootViewFactory</span>                   <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">startReactNative(withModuleName:in:)</span>                  <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTRootViewFactory</span>                                          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactHost:</span> <span class="hljs-string">RCTHost</span>                                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">view(withModuleName:)</span> <span class="hljs-string">→</span> <span class="hljs-string">UIView</span>                        <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">createReactHost()</span> <span class="hljs-string">→</span> <span class="hljs-string">RCTHost</span>                           <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                         <span class="hljs-string">Host</span> <span class="hljs-string">层</span>                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTHost</span>                                                     <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">instance:</span> <span class="hljs-string">RCTInstance</span>                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">bundleManager:</span> <span class="hljs-string">RCTBundleManager</span>                       <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">start()</span>                                               <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">createSurface(withModuleName:)</span> <span class="hljs-string">→</span> <span class="hljs-string">RCTFabricSurface</span>     <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                       <span class="hljs-string">Instance</span> <span class="hljs-string">层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTInstance</span>                                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactInstance:</span> <span class="hljs-string">ReactInstance</span> <span class="hljs-string">(C++)</span>                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">turboModuleManager:</span> <span class="hljs-string">RCTTurboModuleManager</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">surfacePresenter:</span> <span class="hljs-string">RCTSurfacePresenter</span>                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">displayLink:</span> <span class="hljs-string">RCTDisplayLink</span>                           <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">_start()</span>                                              <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">C++</span> <span class="hljs-string">Runtime</span> <span class="hljs-string">层</span>                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">ReactInstance</span> <span class="hljs-string">(C++)</span>                                         <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">jsRuntime:</span> <span class="hljs-string">jsi::Runtime</span> <span class="hljs-string">(Hermes)</span>                      <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">runtimeScheduler:</span> <span class="hljs-string">RuntimeScheduler</span>                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">timerManager:</span> <span class="hljs-string">TimerManager</span>                            <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">initializeRuntime()</span>                                   <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">loadScript()</span>                                          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawdbot是否才是真正的AI入口产品？一文带你搞懂Clawdbot架构！]]></title>    <link>https://juejin.cn/post/7600229327436709938</link>    <guid>https://juejin.cn/post/7600229327436709938</guid>    <pubDate>2026-01-28T13:45:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600229327436709938" data-draft-id="7600245693997547530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawdbot是否才是真正的AI入口产品？一文带你搞懂Clawdbot架构！"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-28T13:45:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="moshuying"/> <meta itemprop="url" content="https://juejin.cn/user/2700056289356936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawdbot是否才是真正的AI入口产品？一文带你搞懂Clawdbot架构！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056289356936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    moshuying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T13:45:02.000Z" title="Wed Jan 28 2026 13:45:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>由于Anthropic认为Clawdbot这个名字太容易被市场误解为Claude Code的产品，所以要求改名，目前Clawdbot刚改名为Moltbot，以下皆用Clawdbot代替。</p>
</blockquote>
<h2 data-id="heading-0">它是什么</h2>
<p>不是聊天机器人。是一个<strong>拥有键盘、屏幕和身份的高权限代理</strong>。</p>
<p>它运行在你的 Mac 或服务器上，通过 Telegram、Slack、iMessage 这些你已经在用的聊天软件作为入口，直接操控本地文件、终端、浏览器。你在手机上说一句"帮我把桌面的报告发给老板"，它真的会去读文件、打开邮件客户端、发送出去。</p>
<p>传统 AI 是"对话框里的聊天伴侣"，你得跳出工作流去迁就它。Moltbot 把自己变成后台进程，<strong>你不需要打开任何新 App，它就在你的聊天窗口里等着</strong>。</p>
<p>技术上，这是一个<strong>本地优先、统一控制平面</strong>的架构：Gateway 进程独占所有消息通道和工具权限，通过 WebSocket 协议管理多 Agent、多会话、多设备。数据不出本地，执行不经云端。</p>
<h2 data-id="heading-1">整体架构</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4b807f8e76b41e5b7bf1f38380b0f23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9zaHV5aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770212701&amp;x-signature=LvHg88uI0jcOpZtd1eDFQRxc4PU%3D" alt="26n5y12000rb4n79dE78D.png" loading="lazy"/></p>
<p>假设你在 Telegram 给 Clawdbot 发了一条消息："帮我看看桌面有哪些 PDF 文件"。</p>
<p><strong>第一站：Channel Layer</strong></p>
<p>Telegram 的消息被 <code>grammY</code> SDK 捕获，进入 Channel 适配层。这一层的职责是<strong>抹平差异</strong>——WhatsApp 用 Baileys、Discord 用 discord.js、Signal 用 signal-cli，每个平台 SDK 不同、消息格式不同、认证方式不同。Channel Layer 把它们统一成一个结构：谁发的、从哪来、内容是什么。</p>
<p>为什么要这样？因为 AI 不应该关心消息是从 Telegram 还是 iMessage 来的，它只需要知道"用户说了什么"。</p>
<p><strong>第二站：Routing System</strong></p>
<p>消息到了 Gateway，但 Gateway 可能管理着多个 Agent（比如一个工作助手、一个生活助手）。Routing 系统决定这条消息交给谁处理。</p>
<p>路由规则是多级的：先看发送者（peer）、再看群组（guild）、再看账号（account）、再看通道（channel），最后才是默认。这意味着你可以配置"来自老板的消息走工作 Agent，来自家人的消息走生活 Agent"。</p>
<p>同时，Routing 还生成 <code>sessionKey</code>——这条消息属于哪个会话。会话隔离是核心设计：不同对话的上下文不会串，A 群的聊天历史不会出现在 B 群。</p>
<p><strong>第三站：Agent Runtime</strong></p>
<p>消息和会话上下文一起交给 Agent。Agent 的核心是 Pi Agent Core 框架，负责：</p>
<ol>
<li>构建 prompt（系统提示 + 历史消息 + 当前输入）</li>
<li>调用 AI 模型（Ollama 本地、OpenAI 云端，或其他）</li>
<li>解析模型响应，判断是直接回复还是需要调用工具</li>
</ol>
<p>对于"看桌面 PDF"这个请求，模型会判断需要调用 <code>bash</code> 工具。</p>
<p><strong>第四站：Tools System</strong></p>
<p>Agent 发起工具调用：<code>ls ~/Desktop/*.pdf</code>。</p>
<p>工具系统不是简单地执行命令——它有权限控制（哪些目录可访问）、沙箱隔离（非 main 会话在 Docker 里跑）、超时管理（防止命令卡死）。执行结果返回给 Agent，Agent 把结果组织成自然语言回复。</p>
<p><strong>回程</strong></p>
<p>回复沿着原路返回：Agent → Gateway → Channel → Telegram → 你的手机。</p>
<p>整个过程，Gateway 是唯一的调度中心。为什么单点？因为消息通道（WhatsApp session、Telegram bot）的状态是独占的，多进程会冲突。单一 Gateway 确保所有状态一致。</p>
<h2 data-id="heading-2">全局数据流</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Channel as 消息通道
    participant Gateway as Gateway
    participant Router as 路由系统
    participant Agent as Agent Runtime
    participant Model as AI 模型
    participant Tool as 工具系统

    User-&gt;&gt;Channel: 发送消息
    Channel-&gt;&gt;Gateway: 接收消息
    Gateway-&gt;&gt;Router: 解析路由
    Router-&gt;&gt;Gateway: 返回 agent + sessionKey
    Gateway-&gt;&gt;Agent: 调用 agent.run()
    Agent-&gt;&gt;Model: 调用 AI 模型
    Model--&gt;&gt;Agent: 流式响应
    Agent-&gt;&gt;Tool: 工具调用（如有）
    Tool--&gt;&gt;Agent: 工具结果
    Agent--&gt;&gt;Gateway: 最终响应
    Gateway-&gt;&gt;Channel: 发送回复
    Channel-&gt;&gt;User: 显示消息
</code></pre>
<h2 data-id="heading-3">完全内网部署（Ollama）</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装</span>
git <span class="hljs-built_in">clone</span> https://github.com/moltbot/moltbot.git &amp;&amp; <span class="hljs-built_in">cd</span> moltbot
pnpm install &amp;&amp; pnpm build &amp;&amp; pnpm ui:build

<span class="hljs-comment"># 2. 配置 Ollama</span>
ollama pull llama3.3
<span class="hljs-built_in">export</span> OLLAMA_API_KEY=<span class="hljs-string">"ollama-local"</span>  <span class="hljs-comment"># 自动发现本地模型</span>

<span class="hljs-comment"># 3. 启动</span>
pnpm moltbot gateway  <span class="hljs-comment"># Gateway 启动后访问 http://127.0.0.1:18789</span>
</code></pre>
<p><strong>Ollama 配置要点</strong>：</p>
<ul>
<li>设置 <code>OLLAMA_API_KEY</code> 后，Clawdbot 自动发现本地模型（查询 <code>/api/tags</code>）</li>
<li>只有报告 <code>tools</code> 能力的模型才会被识别</li>
<li>推荐模型：<code>llama3.3</code>、<code>qwen2.5-coder:32b</code>、<code>deepseek-r1:32b</code></li>
</ul>
<p>三、产品层面思考</p>
<p>你有没有想过，为什么这一年冒出来这么多 AI App，但你手机里真正留下的没几个？</p>
<p>豆包、Kimi、ChatGPT……每个都想成为你的"AI 入口"，每个都让你下载、注册、记住一个新地方。但说实话，微信已经够好用了，Telegram 已经够好用了。用户不缺聊天工具，缺的是聊天工具里<strong>能帮他干活的东西</strong>。</p>
<p>Clawdbot 选了一条不一样的路：不做独立 App，直接"住进"你已有的聊天软件里。Telegram 里的一个 bot，Slack 里的一个 integration，iMessage 里的一个联系人。你不用切换任何东西，在原来的地方说话就行。</p>
<p>这让我想，也许 AI 产品的竞争，最后不是"谁的模型更强"，而是"谁能更无缝地嵌入用户已有的生活"。</p>
<p>大部分 AI 产品把你的聊天记录、记忆、偏好全存在云端。你不知道它存了什么，怎么用，会不会泄露。Clawdbot 做了个很"硬核"的决定：所有数据都以 Markdown 文件存在你本地。你可以像翻笔记一样查看 AI 的"思考过程"，随时删、改、备份。</p>
<p>对企业用户来说，这意味着数据合规问题天然解决。对个人用户来说，这意味着"我的 AI 只属于我"。</p>
<p>在 AI 时代，"数据主权"会不会成为一个真正的卖点？我不确定，但这个方向值得琢磨。</p>
<p>五、安全风险</p>
<p>这东西本质上是一个<strong>拥有你电脑完整控制权的代理</strong>。能读文件、执行命令、用你的身份发消息。配置失误、边界失守，泄露的不只是数据，而是你的身份和整台机器的控制权。</p>
<p>部署前，白名单一定要配（<code>allowFrom</code>），群组里 mention 门控一定要开，敏感操作最好用 Docker 沙箱隔离。绝对不要暴露到公网，绝对不要让不信任的人能访问。</p>
<p>现阶段，它还是个高危实验品。适合技术敏感度高、愿意折腾、能自己兜底的人。</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclawd.bot" target="_blank" title="https://clawd.bot" ref="nofollow noopener noreferrer">clawd.bot</a>
GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclawdbot%2Fclawdbot" target="_blank" title="https://github.com/clawdbot/clawdbot" ref="nofollow noopener noreferrer">github.com/clawdbot/cl…</a>
文档 ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.clawd.bot" target="_blank" title="https://docs.clawd.bot" ref="nofollow noopener noreferrer">docs.clawd.bot</a>
技能市场 ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclawdhub.com" target="_blank" title="https://clawdhub.com" ref="nofollow noopener noreferrer">clawdhub.com</a>
Discord社区：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2Fclawd" target="_blank" title="https://discord.gg/clawd" ref="nofollow noopener noreferrer">discord.gg/clawd</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderAgent Nexus 版本分支正式提交[号外]—核心四问]]></title>    <link>https://juejin.cn/post/7600032104249311295</link>    <guid>https://juejin.cn/post/7600032104249311295</guid>    <pubDate>2026-01-28T14:02:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104249311295" data-draft-id="7600219080046100523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderAgent Nexus 版本分支正式提交[号外]—核心四问"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-28T14:02:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderAgent Nexus 版本分支正式提交[号外]—核心四问
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:02:39.000Z" title="Wed Jan 28 2026 14:02:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ooderAgent Nexus 版本分支已正式完成提交，经多维度严苛验证，5 大全场景测试全部通过，标志着这一年轻开源项目正式从技术原型迈入有实际场景、有核心价值的产品级新阶段。本次 Nexus 版本围绕 “AIGC 时代 AI 能力枢纽” 的核心定位完成全维度升级，核心更新覆盖技术底座、生态落地、工具创新、核心模式四大维度，配套推出 SkillCenter 多中心设计，实现技术与价值的双闭环。以下为本次版本核心疑问的深度解答，精准诠释 Nexus 版本的核心升级与创新价值。</p>
<h2 data-id="heading-0">1. 本次更新都包含了什么？为什么被称为 Nexus 版本？</h2>
<p>本次 Nexus 版本是 ooderAgent 的关键产品级迭代，核心更新覆盖四大维度，且全量功能均通过 5 大全场景实战验证：技术侧完成 A2UI 工程化升级、VFS 分布式事务存储搭建、协议标准化落地及 mcpAgent SDK 易用性优化，筑牢 AI 能力枢纽的技术底座；生态侧打通 trae-solo skills 生态，实现个人用户零门槛接入 AI 资源，完成生态连接的核心突破；创新侧推出全新 RAD 可视化开发工具，验证 OneCode 全栈技术与 AI 的深度融合，实现工具链的创新升级；核心模式侧落地 Nexus P2P 能力分发体系，重构 AI 能力与用户需求的连接逻辑，同时配套推出 SkillCenter 多中心设计，形成 “能力枢纽 - 能力分发 - 能力落地 - 能力协同” 的完整闭环。</p>
<p>将该版本命名为 Nexus（枢纽），核心源于本次更新实现了技术与价值的双闭环，让 ooderAgent 从单一的 AI Agent 开发框架，进化为 AIGC 时代下连接 AI 能力、开发者、个人及企业用户的核心枢纽。本版本以高速发展的 AIGC 为核心驱动力，向上无缝对接各类 LLM 模型与 AI 能力，向下全面支撑个人开发、企业落地等多样化需求，中间通过标准化协议、分布式存储、SkillCenter、P2P 模式实现能力的高效调度、分发与协同，所有更新均围绕 “打造 AI 能力核心枢纽” 展开。而 5 大全场景测试的全部通过，更是为这一枢纽能力的商业化、规模化落地提供了坚实的质量保障，Nexus 的称号也因此成为该版本最贴切的诠释。</p>
<h2 data-id="heading-1">2. 本次更新的 SkillCenter 看似无所不能，它实际解决了哪些问题？</h2>
<p>SkillCenter 并非全能型工具，而是 ooderAgent 在 AI 能力落地实战中的核心总结与针对性解决方案，经全场景验证后正式落地，直击 AI 应用落地过程中的不确定性、可控性、规模化三大核心痛点，推动 AI 能力从 “随机生成” 走向 “规范、稳定落地”。</p>
<p>AI 的 “生成能力” 虽能快速响应需求，甚至仅凭一句话就能输出贴合需求的结果，但这份便捷背后存在天然的不确定性 —— 即便在 AI 编程这类确定性较强的领域，也会因输出的 “朝秦暮楚” 导致实际落地困难。skills 技术理念的推出，让 AI 重回确定性发展路线，而要打造 100% 避免无依据幻想的确定性产品，需在兼顾 AI 能力与创造力的同时，做好落地的规范约束，SkillCenter 正是这一需求的核心落地载体。</p>
<p>其核心解决的问题体现在两大维度：一是通过Remote Skills 远程技能服务，将 AI 能力落地全流程中确定性的问题抽象为标准化、确定性的结果服务，让这些结果摆脱本地 skills 框架的约束，在 AI 天然的道德约束之外，搭建起一层 “法律式” 的规则约束，确保 AI 能力稳定、可控发挥，从根源上解决 AI 输出的不确定性问题；二是通过多中心设计，构建起 AI 能力落地的标准化规范体系，让分散、个性化的 skills 能力能在统一体系中实现调度、分发与管理，解决了 AI 能力规模化落地的规范难题，成为 AI 能力从技术走向实际场景的核心桥梁。且这一设计已在 5 大全场景中完成实战验证，具备规模化落地的成熟条件。</p>
<h2 data-id="heading-2">3. 本次重要更新的 RAD 版本有什么特殊之处？</h2>
<p>RAD（快速应用开发）工具的更新，是 ooderAgent 一次跳出传统认知、颠覆式的技术创新，并非简单的 “旧瓶装新酒”，该功能经全场景测试验证后正式推出，其特殊性体现在技术选型、设计目标、AI 融合三大维度，核心验证了 OneCode 全栈技术与 AI 的深度结合，以及 ooderAgent 工具链为 AI 定制化设计的技术优势。</p>
<p>从技术选型来看，RAD 打破了行业固有认知：与人交互的可视化交互软件，本是工程与技术长期磨合的产物，而设计器作为软件技术的 “皇冠”，历来被认为需要高灵活性的技术架构，本次 RAD 却首次采用被认为 “灵活性、扩展性相对受限” 的 OneCode 全栈技术开发，技术实现难度不言而喻。但在 AI 的辅助下，OneCode 的优势被充分释放，短期内突破了其旧有架构的边界，实现了全套全新 UI、全套样式图标体系、多语言支持、渐进式整体升级、响应式 UI 设计等一系列此前难以完成的任务，完成了技术选型的反向验证，且所有功能均在全场景测试中实现稳定运行。</p>
<p>从设计目标来看，传统 RAD 与 AI 的确定性技术路线相悖，而本次 ooderAgent 的 RAD 设计，核心是打造AI 原生的可视化开发工具，将 AI 能力深度融入开发全流程。在已放出的演示视频中，能清晰看到 AI 与工具链的协同创新：LLM 可通过浏览器 debug 日志实时诊断脚本错误，通过实时截图获取定位信息偏差，运算输出 JavaScript 后通过浏览器预览实时调整布局，定位效果达标后再分析样式语法，精准找到需要修改的 OneCode 注解并完成精确修改。这一过程中，不仅验证了 LLM 的核心能力，更体现了 ooderAgent 强大的工具链支撑，以及框架层面对 AI 的专属定制化设计，让 RAD 成为 AI 辅助开发的核心载体。</p>
<p>从技术创新来看，本次 RAD 实现了实时反馈、自主编程等新技术的实战验证，将 AI 从 “辅助生成” 推向 “主动开发”，是对传统 RAD 工具的彻底重构，让可视化开发与 AI 能力实现无缝融合，成为 ooderAgent 技术创新的重要标杆。且该创新模式已在 5 大全场景中完成落地验证，具备实际应用价值，也为行业提供了 AI 与可视化开发融合的全新思路。</p>
<h2 data-id="heading-3">4. 本次更新支持的 P2P 模式是什么背景下的？为什么会反复宣传？</h2>
<p>Nexus P2P 是本次版本发布的核心核心，作为 ooderAgent 打造 AI 能力枢纽的核心模式，该功能经 5 大全场景严苛测试后正式落地，其推出的背景，源于 AI 能力落地的 “第一性原理”：在真实的用户需求中，永远只有 AI 与本质性的用户需求两大核心，二者之间的任何中间环节、包装层级，最终都会被需求跨越、击穿。而当前 AI 生态中，存在大量的能力包装、层级冗余问题，导致 AI 能力与用户需求之间的连接效率低下，这一行业痛点成为 P2P 模式推出的核心背景。</p>
<p>之所以反复宣传 Nexus P2P，核心在于它是一场AI 能力分发的革命，彻底重构了 AI 能力与用户需求的连接逻辑：让需求和能力之间，只存在 “AI” 与 “Agent Nexus”，砍掉了所有冗余的中间环节，实现了 AI 能力的直连式分发，且这一直连模式已在全场景中完成实战验证，确保高效、稳定运行。</p>
<p>Agent Nexus 围绕 “需求与能力直连” 这一核心需求，对 AI 能力落地的全流程进行层层拆解，剥去了所有非必要的包装与层级，但同时又通过标准化的规则与节奏，保障了能力分发的有序性与可控性 —— 这正是 “Agent Nexus” 的核心价值：既实现了 AI 能力与用户本质需求的无阻碍连接，又避免了无规则直连带来的混乱，让 AI 能力能高效、规范地触达用户。这种模式彻底打破了传统的能力分发逻辑，让 AI 能力落地回归本质，是 ooderAgent 从 “AI 能力枢纽” 走向 “AI 生态核心” 的关键，也是其区别于其他 AI Agent 框架的核心竞争力，更是本次 Nexus 版本能实现技术与价值双闭环的核心支撑，因此成为本次版本发布的核心宣传点。</p>
<h3 data-id="heading-4">写在最后</h3>
<p>ooderAgent Nexus 版本分支的正式提交与 5 大全场景测试的全部通过，是这一年轻开源项目的重要里程碑。从技术原型到产品级形态，从单一框架到 AI 能力枢纽，Nexus 版本的每一次升级、每一项创新，都围绕 “AIGC 时代让 AI 能力更高效、更规范、更普惠地落地” 这一核心目标。而 SkillCenter、RAD、Nexus P2P 的创新落地，不仅为 ooderAgent 自身生态奠定了基础，也为 AI Agent 行业的发展提供了全新的实践思路。未来，ooderAgent 将继续以技术创新为核心，完善生态布局，让 AI 能力真正服务于每一个开发者、每一个实际需求场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一天一个开源项目（第5篇）：最近火爆硅谷的ClaudBot，真不是什么不得了的事]]></title>    <link>https://juejin.cn/post/7600223321041682438</link>    <guid>https://juejin.cn/post/7600223321041682438</guid>    <pubDate>2026-01-28T12:13:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041682438" data-draft-id="7600223321041666054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一天一个开源项目（第5篇）：最近火爆硅谷的ClaudBot，真不是什么不得了的事"/> <meta itemprop="keywords" content="AI编程,人工智能,开源"/> <meta itemprop="datePublished" content="2026-01-28T12:13:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一天一个开源项目（第5篇）：最近火爆硅谷的ClaudBot，真不是什么不得了的事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:13:51.000Z" title="Wed Jan 28 2026 12:13:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>"当技术圈的狂欢遇到冷静的理性分析，真相往往比营销更值得关注。"</p>
</blockquote>
<p>这是"一天一个开源项目"系列的第5篇文章。今天带你了解的项目是 <strong>Moltbot</strong>（原名 Clawdbot，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">GitHub</a>）。</p>
<p>最近这个项目在技术圈刷屏了：GitHub 星标狂飙到 72k+，被吹成"7×24小时AI员工""开源贾维斯"，甚至有人说它"带火了Mac mini销量"。但冷静分析后会发现，它的火爆更多是踩中了情绪，而非技术上的颠覆性创新。</p>
<h2 data-id="heading-1">项目背景</h2>
<h3 data-id="heading-2">项目简介</h3>
<p><strong>Moltbot</strong>（原名 Clawdbot）是一个<strong>开源的个人AI助手</strong>，支持多平台、多渠道运行。它通过 Gateway（网关）架构，将AI能力与桌面系统、社交软件、办公工具等连接起来，实现从"聊天"到"执行"的闭环。</p>
<p><strong>项目解决的核心问题</strong>：</p>
<ul>
<li>AI助手只能聊天，无法执行实际任务</li>
<li>需要统一的接口来连接各种服务和工具</li>
<li>个人数据隐私和本地部署的需求</li>
<li>开发者需要可定制的AI代理框架</li>
</ul>
<p><strong>面向的用户群体</strong>：</p>
<ul>
<li>技术极客和开发者</li>
<li>对隐私敏感的用户</li>
<li>需要高度定制化AI助手的用户</li>
<li>愿意折腾配置的技术爱好者</li>
</ul>
<h3 data-id="heading-3">作者/团队介绍</h3>
<p><strong>作者：Peter Steinberger (@steipete)</strong></p>
<ul>
<li><strong>背景</strong>：专注于AI和开发者工具的开源开发者</li>
<li><strong>理念</strong>：为 Molty（一只空间龙虾AI助手）构建个人AI代理</li>
<li><strong>项目起源</strong>：最初为个人需求开发，后开源给社区</li>
</ul>
<p><strong>项目创建时间</strong>：2024年（从 GitHub 提交历史可以看出项目持续活跃）</p>
<h3 data-id="heading-4">项目数据</h3>
<ul>
<li>⭐ <strong>GitHub Stars</strong>: 72.3k+（持续快速增长）</li>
<li>🍴 <strong>Forks</strong>: 9.2k+</li>
<li>📦 <strong>版本</strong>: Clawdbot 2026.1.24（最新版本，2026年1月25日发布）</li>
<li>📄 <strong>License</strong>: MIT（完全开源，自由使用）</li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmolt.bot" target="_blank" title="https://molt.bot" ref="nofollow noopener noreferrer">molt.bot</a></li>
<li>📚 <strong>文档</strong>: 包含详细的文档和平台指南</li>
<li>💬 <strong>社区</strong>: GitHub Issues 和 Discussions 活跃</li>
</ul>
<p><strong>项目发展历程</strong>：</p>
<ul>
<li>2024年：项目启动，最初名为 Clawdbot</li>
<li>2024-2025年：快速发展，添加多平台支持</li>
<li>2025年底：项目更名，从 Clawdbot 改为 Moltbot</li>
<li>2026年：持续优化，社区活跃度极高</li>
</ul>
<hr/>
<h2 data-id="heading-5">主要功能</h2>
<h3 data-id="heading-6">核心作用</h3>
<p>Moltbot 的核心作用是<strong>将AI大模型的能力与桌面系统、各种服务连接起来</strong>，实现从自然语言指令到实际任务执行的完整闭环。它通过 Gateway 架构，统一管理各种渠道（Telegram、Slack、Discord、iMessage等）和工具（浏览器控制、文件操作、系统调用等）。</p>
<h3 data-id="heading-7">使用场景</h3>
<ol>
<li>
<p><strong>多渠道AI助手</strong></p>
<ul>
<li>通过 Telegram、Slack、Discord 等渠道与AI对话</li>
<li>统一管理多个社交和办公平台</li>
<li>实现跨平台的任务执行</li>
</ul>
</li>
<li>
<p><strong>桌面自动化</strong></p>
<ul>
<li>通过自然语言控制浏览器</li>
<li>自动化文件操作和系统任务</li>
<li>实现复杂的多步骤工作流</li>
</ul>
</li>
<li>
<p><strong>本地AI代理</strong></p>
<ul>
<li>本地部署，数据不上云</li>
<li>长期记忆和上下文管理</li>
<li>可对接本地大模型</li>
</ul>
</li>
<li>
<p><strong>智能家居集成</strong></p>
<ul>
<li>通过开源生态整合智能家居</li>
<li>自定义Agent和技能</li>
<li>实现个性化的自动化场景</li>
</ul>
</li>
<li>
<p><strong>开发者工具</strong></p>
<ul>
<li>作为AI代理开发框架</li>
<li>支持自定义扩展和插件</li>
<li>用于构建专属AI应用</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">快速开始</h3>
<h4 data-id="heading-9">安装方式</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 npm/pnpm/yarn 安装</span>
npm install -g @moltbot/cli

<span class="hljs-comment"># 或使用 Docker</span>
docker run -it --<span class="hljs-built_in">rm</span> moltbot/moltbot

<span class="hljs-comment"># 或从源码构建</span>
git <span class="hljs-built_in">clone</span> https://github.com/moltbot/moltbot.git
<span class="hljs-built_in">cd</span> moltbot
pnpm install
pnpm build
</code></pre>
<h4 data-id="heading-10">基本配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config.yaml</span>
<span class="hljs-attr">channels:</span>
  <span class="hljs-attr">telegram:</span>
    <span class="hljs-attr">botToken:</span> <span class="hljs-string">"YOUR_BOT_TOKEN"</span>
  
  <span class="hljs-attr">discord:</span>
    <span class="hljs-attr">token:</span> <span class="hljs-string">"YOUR_DISCORD_TOKEN"</span>
  
  <span class="hljs-attr">slack:</span>
    <span class="hljs-attr">botToken:</span> <span class="hljs-string">"YOUR_SLACK_BOT_TOKEN"</span>
    <span class="hljs-attr">appToken:</span> <span class="hljs-string">"YOUR_SLACK_APP_TOKEN"</span>

<span class="hljs-attr">browser:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">color:</span> <span class="hljs-string">"#FF4500"</span>

<span class="hljs-attr">ai:</span>
  <span class="hljs-attr">provider:</span> <span class="hljs-string">"openai"</span>  <span class="hljs-comment"># 或 "anthropic", "local" 等</span>
  <span class="hljs-attr">model:</span> <span class="hljs-string">"gpt-4"</span>
  <span class="hljs-attr">apiKey:</span> <span class="hljs-string">"YOUR_API_KEY"</span>
</code></pre>
<h3 data-id="heading-11">核心特性</h3>
<ol>
<li>
<p><strong>Gateway 架构</strong></p>
<ul>
<li>统一的网关管理所有渠道和工具</li>
<li>支持多平台（Windows、macOS、Linux、iOS、Android）</li>
<li>可扩展的插件系统</li>
</ul>
</li>
<li>
<p><strong>多渠道支持</strong></p>
<ul>
<li>Telegram、Slack、Discord、Signal、iMessage、Microsoft Teams</li>
<li>WebChat 界面</li>
<li>统一的对话接口</li>
</ul>
</li>
<li>
<p><strong>浏览器控制</strong></p>
<ul>
<li>通过自然语言控制浏览器</li>
<li>支持网页操作、表单填写、数据提取</li>
<li>可视化操作反馈</li>
</ul>
</li>
<li>
<p><strong>本地记忆系统</strong></p>
<ul>
<li>每日日志和长期记忆</li>
<li>本地MD文件存储</li>
<li>人类可编辑和审查</li>
</ul>
</li>
<li>
<p><strong>技能系统（Skills）</strong></p>
<ul>
<li>可组合的技能库</li>
<li>支持自定义技能开发</li>
<li>自动触发和执行</li>
</ul>
</li>
<li>
<p><strong>远程访问</strong></p>
<ul>
<li>支持SSH隧道和Tailnet</li>
<li>安全的远程控制</li>
<li>多设备同步</li>
</ul>
</li>
<li>
<p><strong>开源生态</strong></p>
<ul>
<li>MIT协议，完全开源</li>
<li>支持本地大模型对接</li>
<li>可定制和扩展</li>
</ul>
</li>
<li>
<p><strong>安全控制</strong></p>
<ul>
<li>访问权限管理</li>
<li>认证和授权机制</li>
<li>可配置的安全策略</li>
</ul>
</li>
</ol>
<h2 data-id="heading-12">项目详细剖析</h2>
<h3 data-id="heading-13">核心差异分析：被过度炒作的"亮点"背后</h3>
<h4 data-id="heading-14">❶ 桌面系统高权限操作：不是做不到，而是敢不敢</h4>
<p><strong>被吹捧的说法</strong>：</p>
<blockquote>
<p>"Moltbot 实现了AI对桌面系统的完全控制，这是其他工具做不到的！"</p>
</blockquote>
<p><strong>真相分析</strong>：</p>
<p>这不是技术壁垒，而是<strong>产品定位和风险承担的选择</strong>。</p>
<p><strong>技术层面</strong>：</p>
<ul>
<li>豆包、千问App等成熟产品<strong>完全有技术能力</strong>实现全量桌面权限</li>
<li>macOS 的 Accessibility API、Windows 的 UI Automation、Linux 的 D-Bus 都是公开的系统接口</li>
<li>任何有系统编程能力的开发者都能实现类似功能</li>
</ul>
<p><strong>为什么闭源产品不这么做？</strong></p>
<ol>
<li><strong>合规风险</strong>：面向大众用户，开放高权限意味着巨大的合规和隐私风险</li>
<li><strong>安全责任</strong>：厂商需要为安全漏洞承担责任，而开源项目由用户自行承担</li>
<li><strong>用户教育成本</strong>：普通用户难以正确配置安全策略，容易造成隐私泄露</li>
<li><strong>法律风险</strong>：高权限操作可能涉及法律边界，厂商需要谨慎</li>
</ol>
<p><strong>Moltbot 的选择</strong>：</p>
<ul>
<li>把权限交给用户，让技术党自己承担风险</li>
<li>这是<strong>人群定位的选择</strong>，而非技术鸿沟</li>
<li>适合技术极客，不适合普通用户</li>
</ul>
<p><strong>结论</strong>：这不是技术优势，而是<strong>风险转移</strong>。</p>
<h4 data-id="heading-15">❷ 全渠道打通社交/办公软件：本质是提前配置的结果</h4>
<p><strong>被吹捧的说法</strong>：</p>
<blockquote>
<p>"Moltbot 无缝打通了所有社交和办公软件，实现了真正的统一入口！"</p>
</blockquote>
<p><strong>真相分析</strong>：</p>
<p>这本质上是<strong>提前配置的结果</strong>，而非独家技术。</p>
<p><strong>技术实现</strong>：</p>
<ul>
<li>Telegram Bot API、Slack API、Discord API 都是公开的</li>
<li>需要的是：Bot Token、App Token、Webhook URL 等配置信息</li>
<li>配置流程：注册应用 → 获取Token → 配置到Moltbot</li>
</ul>
<p><strong>类比理解</strong>：
就像给豆包配置好邮箱账号，它就能自动发邮件一样。Moltbot 的"无缝体验"来自：</p>
<ol>
<li><strong>部署时的账号对接</strong>：用户需要手动配置各种服务的Token</li>
<li><strong>统一的接口封装</strong>：Moltbot 把这些API调用封装成了统一的接口</li>
<li><strong>配置流程整合</strong>：把配置流程整合到了开源框架里</li>
</ol>
<p><strong>这不是技术突破，而是"一站式折腾"</strong>：</p>
<ul>
<li>用户需要：注册多个服务、获取多个Token、配置多个参数</li>
<li>对于普通用户，这个配置成本可能比使用多个独立工具还高</li>
<li>对于技术极客，这种统一管理确实有价值</li>
</ul>
<p><strong>结论</strong>：这是<strong>工程整合</strong>，不是技术创新。</p>
<h4 data-id="heading-16">❸ 本地长期记忆：真正的亮点，但没那么神</h4>
<p><strong>被吹捧的说法</strong>：</p>
<blockquote>
<p>"Moltbot 的本地记忆系统比云端AI的上下文窗口更强大，实现了真正的长期记忆！"</p>
</blockquote>
<p><strong>真相分析</strong>：</p>
<p>这确实是 Moltbot <strong>为数不多的真正亮点</strong>，但也没那么神。</p>
<p><strong>技术实现</strong>：</p>
<ul>
<li>记忆存储在本地MD文件中</li>
<li>分两层：每日日志（daily logs）和长期沉淀（long-term memory）</li>
<li>重启不丢失，人类可编辑和审查</li>
</ul>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 比云端AI的上下文窗口更持久（不受Token限制）</li>
<li>✅ 成本更低（不需要为长上下文付费）</li>
<li>✅ 隐私可控（数据不上云）</li>
<li>✅ 人类可审查和编辑（透明度高）</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>❌ 这种本地存储的思路，闭源产品<strong>只要想做，完全可以复刻</strong></li>
<li>❌ 只是会增加开发和维护成本，但不存在技术壁垒</li>
<li>❌ 记忆检索和关联能力，相比向量数据库等专业方案，可能还有差距</li>
</ul>
<p><strong>结论</strong>：这是<strong>产品设计亮点</strong>，但不是不可复制的技术壁垒。</p>
<h4 data-id="heading-17">❹ 真正的核心差异：开源生态</h4>
<p><strong>唯一不可替代的优势</strong>：</p>
<p>Moltbot 真正的核心差异，<strong>只有一个：开源生态</strong>。</p>
<p><strong>开源带来的价值</strong>：</p>
<ol>
<li>
<p><strong>按需定制</strong></p>
<ul>
<li>可以修改代码，对接本地大模型</li>
<li>可以开发专属Agent和技能</li>
<li>可以整合智能家居、IoT设备</li>
</ul>
</li>
<li>
<p><strong>数据主权</strong></p>
<ul>
<li>代码完全透明，可审计</li>
<li>数据完全本地，不上云</li>
<li>不依赖任何第三方服务</li>
</ul>
</li>
<li>
<p><strong>社区生态</strong></p>
<ul>
<li>72k+ Stars，活跃的社区贡献</li>
<li>丰富的扩展和插件</li>
<li>持续的功能迭代</li>
</ul>
</li>
<li>
<p><strong>学习价值</strong></p>
<ul>
<li>可以学习AI代理的实现</li>
<li>可以理解Gateway架构设计</li>
<li>可以作为开发框架使用</li>
</ul>
</li>
</ol>
<p><strong>但这个优势的受众极窄</strong>：</p>
<ul>
<li>普通用户根本折腾不动</li>
<li>需要技术背景和开发能力</li>
<li>配置和维护成本高</li>
</ul>
<p><strong>结论</strong>：开源生态是 Moltbot 的<strong>唯一不可替代优势</strong>，但受众面窄。</p>
<h3 data-id="heading-18">为什么能火出圈？营销与情绪的双重作用</h3>
<h4 data-id="heading-19">✅ 踩中了"AI从聊天到执行"的趋势</h4>
<ul>
<li>把大模型的"嘴"接上了桌面系统的"手"</li>
<li>实现了任务闭环，戳中了大家对"全能AI管家"的期待</li>
<li>这是技术趋势，不是 Moltbot 的独家能力</li>
</ul>
<h4 data-id="heading-20">✅ 开源+本地部署的标签</h4>
<ul>
<li>精准击中了技术党对数据主权、隐私可控的需求</li>
<li>在AI隐私担忧的背景下，这个标签自带传播力</li>
<li>但普通用户可能并不关心这些</li>
</ul>
<h4 data-id="heading-21">✅ 营销造势到位</h4>
<ul>
<li>"贾维斯平替""7×24小时AI员工"等话题自带传播度</li>
<li>"带火Mac mini销量"等话题放大了实际价值</li>
<li>技术圈的集体狂欢，放大了项目影响力</li>
</ul>
<h3 data-id="heading-22">狂欢背后的槽点：理性看待风险</h3>
<h4 data-id="heading-23">☑ 上手门槛高</h4>
<p><strong>看似开箱即用，实则复杂需求需要大量调试</strong>：</p>
<ul>
<li>基础配置需要：安装、配置Token、设置权限</li>
<li>复杂需求需要：编写自定义技能、调试Agent逻辑</li>
<li>那些"躺床上重构网站"的案例，都是开发者的秀操作</li>
<li>小白照搬只会全是报错</li>
</ul>
<p><strong>真实使用体验</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">用户：<span class="hljs-string">"帮我整理一下桌面文件"</span>
Moltbot：<span class="hljs-string">"我需要访问文件系统权限..."</span>
用户：<span class="hljs-string">"好的，怎么配置？"</span>
Moltbot：<span class="hljs-string">"请修改 config.yaml，设置 fileSystem.accessLevel: 'full'..."</span>
用户：<span class="hljs-string">"然后呢？"</span>
Moltbot：<span class="hljs-string">"请确保系统权限已授予..."</span>
用户：<span class="hljs-string">"系统提示权限被拒绝..."</span>
Moltbot：<span class="hljs-string">"请检查系统设置 → 隐私与安全性 → 辅助功能..."</span>
用户：<span class="hljs-string">"算了，我还是手动整理吧..."</span>
</code></pre>
<h4 data-id="heading-24">☑ 安全风险拉满</h4>
<p><strong>默认开放高权限，配置不当就是隐私定时炸弹</strong>：</p>
<ul>
<li>目前已有大量实例存在认证漏洞</li>
<li>配置不当可能导致：
<ul>
<li>文件系统被恶意访问</li>
<li>敏感信息泄露</li>
<li>系统被远程控制</li>
<li>社交账号被盗用</li>
</ul>
</li>
</ul>
<p><strong>安全建议</strong>：</p>
<ul>
<li>仅在可信网络环境使用</li>
<li>严格配置访问权限</li>
<li>定期审查日志和记忆文件</li>
<li>不要在生产环境使用</li>
</ul>
<h4 data-id="heading-25">☑ 并非大众产品</h4>
<p><strong>轻度使用的自动化需求，现有闭源工具更省心</strong>：</p>
<ul>
<li>为了整理文件开放全量权限，性价比太低</li>
<li>普通用户的自动化需求，Mac Automator、Windows Task Scheduler 更简单</li>
<li>轻度AI助手需求，豆包、千问App 更省心</li>
</ul>
<p><strong>适用场景对比</strong>：</p>








































<table><thead><tr><th align="left">使用场景</th><th align="left">Moltbot</th><th align="left">闭源工具</th></tr></thead><tbody><tr><td align="left"><strong>重度定制需求</strong></td><td align="left">⭐⭐⭐⭐⭐</td><td align="left">⭐⭐</td></tr><tr><td align="left"><strong>隐私敏感用户</strong></td><td align="left">⭐⭐⭐⭐⭐</td><td align="left">⭐⭐</td></tr><tr><td align="left"><strong>技术极客</strong></td><td align="left">⭐⭐⭐⭐⭐</td><td align="left">⭐⭐⭐</td></tr><tr><td align="left"><strong>普通用户轻度使用</strong></td><td align="left">⭐⭐</td><td align="left">⭐⭐⭐⭐⭐</td></tr><tr><td align="left"><strong>快速上手</strong></td><td align="left">⭐⭐</td><td align="left">⭐⭐⭐⭐⭐</td></tr><tr><td align="left"><strong>安全可控</strong></td><td align="left">⭐⭐（需自行保障）</td><td align="left">⭐⭐⭐⭐⭐（厂商保障）</td></tr></tbody></table>
<h3 data-id="heading-26">与其他AI桌面操作工具的深度对比</h3>
<h4 data-id="heading-27">vs 豆包/千问App：定位差异</h4>
<p><strong>豆包/千问App</strong>：</p>
<ul>
<li>定位：面向大众的AI助手</li>
<li>权限：受限，以安全为先</li>
<li>部署：云端为主，部分本地</li>
<li>定制：有限，依赖厂商能力</li>
<li>适用：普通用户日常使用</li>
</ul>
<p><strong>Moltbot</strong>：</p>
<ul>
<li>定位：面向技术极客的AI代理框架</li>
<li>权限：全量，用户自行承担风险</li>
<li>部署：完全本地，数据不上云</li>
<li>定制：高度可定制，开源生态</li>
<li>适用：技术极客、隐私敏感用户</li>
</ul>
<p><strong>核心差异</strong>：不是技术差异，而是<strong>产品定位和用户群体的差异</strong>。</p>
<h4 data-id="heading-28">vs AutoGPT/AutoGen：架构差异</h4>
<p><strong>AutoGPT/AutoGen</strong>：</p>
<ul>
<li>架构：Agent框架，专注于任务规划</li>
<li>能力：AI推理和规划能力强</li>
<li>工具：需要自行集成桌面操作能力</li>
<li>适用：研究和实验场景</li>
</ul>
<p><strong>Moltbot</strong>：</p>
<ul>
<li>架构：Gateway + Protocol，专注于系统集成</li>
<li>能力：系统集成和工具调用能力强</li>
<li>工具：内置丰富的桌面操作能力</li>
<li>适用：实际生产场景</li>
</ul>
<p><strong>核心差异</strong>：Moltbot 更注重<strong>系统集成</strong>，AutoGPT 更注重<strong>AI推理</strong>。</p>
<h4 data-id="heading-29">vs 传统自动化工具：AI能力差异</h4>
<p><strong>传统自动化工具</strong>（Mac Automator、Windows Task Scheduler）：</p>
<ul>
<li>能力：基于规则的自动化</li>
<li>灵活性：需要预先定义规则</li>
<li>AI能力：无，无法理解自然语言</li>
<li>适用：固定流程的自动化</li>
</ul>
<p><strong>Moltbot</strong>：</p>
<ul>
<li>能力：基于AI的智能自动化</li>
<li>灵活性：可以理解自然语言，动态规划任务</li>
<li>AI能力：强，可以处理复杂和不确定的任务</li>
<li>适用：需要智能决策的自动化</li>
</ul>
<p><strong>核心差异</strong>：Moltbot 的<strong>AI能力</strong>是传统工具无法替代的。</p>
<h3 data-id="heading-30">技术实现深度剖析</h3>
<h4 data-id="heading-31">Gateway 架构的优势与局限</h4>
<p><strong>优势</strong>：</p>
<ul>
<li>解耦设计，易于扩展</li>
<li>统一协议，降低复杂度</li>
<li>状态管理，支持多设备同步</li>
</ul>
<p><strong>局限</strong>：</p>
<ul>
<li>Gateway 成为单点故障</li>
<li>协议转换可能带来性能损耗</li>
<li>状态同步在复杂场景下可能不一致</li>
</ul>
<h4 data-id="heading-32">本地记忆系统的设计</h4>
<p><strong>存储结构</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">.moltbot/</span>
<span class="hljs-string">├──</span> <span class="hljs-string">memory/</span>
<span class="hljs-string">│</span>   <span class="hljs-string">├──</span> <span class="hljs-string">daily/</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>   <span class="hljs-string">├──</span> <span class="hljs-number">2026-01-27.</span><span class="hljs-string">md</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-number">2026-01-28.</span><span class="hljs-string">md</span>
<span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">long-term/</span>
<span class="hljs-string">│</span>       <span class="hljs-string">├──</span> <span class="hljs-string">facts.md</span>
<span class="hljs-string">│</span>       <span class="hljs-string">├──</span> <span class="hljs-string">preferences.md</span>
<span class="hljs-string">│</span>       <span class="hljs-string">└──</span> <span class="hljs-string">relationships.md</span>
</code></pre>
<p><strong>检索机制</strong>：</p>
<ul>
<li>基于关键词匹配</li>
<li>结合时间戳和相关性</li>
<li>人类可编辑和审查</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>相比向量数据库，检索精度可能不足</li>
<li>大规模记忆管理可能成为瓶颈</li>
<li>需要人工维护和清理</li>
</ul>
<h4 data-id="heading-33">技能系统的扩展性</h4>
<p><strong>技能结构</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># skill.yaml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">"file-organizer"</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">"自动整理文件"</span>
<span class="hljs-attr">triggers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"整理文件"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"organize files"</span>
<span class="hljs-attr">actions:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">"file-system"</span>
    <span class="hljs-attr">operation:</span> <span class="hljs-string">"organize"</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pattern:</span> <span class="hljs-string">"*.pdf"</span>
        <span class="hljs-attr">destination:</span> <span class="hljs-string">"Documents/PDFs"</span>
</code></pre>
<p><strong>扩展能力</strong>：</p>
<ul>
<li>支持自定义技能开发</li>
<li>技能可以组合和复用</li>
<li>社区贡献丰富的技能库</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>技能开发需要技术背景</li>
<li>技能之间的冲突处理机制不完善</li>
<li>缺乏技能市场和审核机制</li>
</ul>
<hr/>
<h2 data-id="heading-34">项目地址与资源</h2>
<h3 data-id="heading-35">官方资源</h3>
<ul>
<li>🌟 <strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">github.com/moltbot/mol…</a></li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmolt.bot" target="_blank" title="https://molt.bot" ref="nofollow noopener noreferrer">molt.bot</a></li>
<li>📚 <strong>文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.molt.bot" target="_blank" title="https://docs.molt.bot" ref="nofollow noopener noreferrer">docs.molt.bot</a></li>
<li>🐛 <strong>Issues</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fissues" target="_blank" title="https://github.com/moltbot/moltbot/issues" ref="nofollow noopener noreferrer">GitHub Issues</a></li>
<li>💬 <strong>Discussions</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fdiscussions" target="_blank" title="https://github.com/moltbot/moltbot/discussions" ref="nofollow noopener noreferrer">GitHub Discussions</a></li>
<li>📦 <strong>Releases</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Freleases" target="_blank" title="https://github.com/moltbot/moltbot/releases" ref="nofollow noopener noreferrer">GitHub Releases</a></li>
</ul>
<h3 data-id="heading-36">相关资源</h3>
<ul>
<li><strong>作者博客</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fsteipete.me" target="_blank" title="https://steipete.me" ref="nofollow noopener noreferrer">steipete.me</a></li>
<li><strong>Molty介绍</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fclawd.me" target="_blank" title="https://clawd.me" ref="nofollow noopener noreferrer">clawd.me</a></li>
<li><strong>社区贡献</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fgraphs%2Fcontributors" target="_blank" title="https://github.com/moltbot/moltbot/graphs/contributors" ref="nofollow noopener noreferrer">GitHub Contributors</a></li>
<li><strong>安全报告</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fsecurity" target="_blank" title="https://github.com/moltbot/moltbot/security" ref="nofollow noopener noreferrer">GitHub Security</a></li>
</ul>
<h3 data-id="heading-37">适用人群</h3>
<p><strong>强烈推荐</strong>：</p>
<ul>
<li>✅ 技术极客和开发者</li>
<li>✅ 对隐私敏感的用户</li>
<li>✅ 需要高度定制化AI助手的用户</li>
<li>✅ 愿意折腾配置的技术爱好者</li>
<li>✅ 想要学习AI代理实现的研究者</li>
</ul>
<p><strong>不推荐</strong>：</p>
<ul>
<li>❌ 普通用户（配置成本太高）</li>
<li>❌ 轻度使用需求（现有工具更省心）</li>
<li>❌ 对安全要求极高的生产环境（风险自行承担）</li>
<li>❌ 缺乏技术背景的用户（上手难度高）</li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析]]></title>    <link>https://juejin.cn/post/7600060691350405162</link>    <guid>https://juejin.cn/post/7600060691350405162</guid>    <pubDate>2026-01-28T12:20:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350405162" data-draft-id="7600219080046002219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析"/> <meta itemprop="keywords" content="Android,源码阅读,性能优化"/> <meta itemprop="datePublished" content="2026-01-28T12:20:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:20:27.000Z" title="Wed Jan 28 2026 12:20:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>网络连接是现代移动设备最核心的功能之一。从打开网页、收发消息，到视频通话、在线游戏，每一个网络操作背后，都有Android网络子系统在默默工作。而<strong>ConnectivityService</strong>，正是这个庞大系统的"中枢大脑"。</p>
<p>在本系列的第一篇文章中，我们将深入探索：</p>
<h3 data-id="heading-1">为什么ConnectivityService如此重要？</h3>
<p>想象这样一个场景：你正在用WiFi观看高清视频，突然WiFi信号变弱。Android系统需要在1秒内完成以下复杂操作：</p>
<ol>
<li><strong>监测WiFi质量下降</strong> - NetworkMonitor持续验证网络</li>
<li><strong>评估切换时机</strong> - NetworkRanker对比WiFi和移动网络得分</li>
<li><strong>准备移动网络</strong> - TelephonyNetworkFactory激活移动数据</li>
<li><strong>无缝切换</strong> - 在不中断视频的情况下迁移连接</li>
<li><strong>通知应用</strong> - 通过NetworkCallback告知网络变更</li>
</ol>
<p>这一切，都由ConnectivityService协调完成。它就像交通指挥中心，管理着设备上所有网络的"交通"。</p>
<h3 data-id="heading-2">本文内容概览</h3>
<ol>
<li>
<p><strong>ConnectivityService架构总览</strong></p>
<ul>
<li>核心职责与设计理念</li>
<li>与其他系统服务的关系</li>
<li>Android 15的架构演进</li>
</ul>
</li>
<li>
<p><strong>NetworkAgent机制深度解析</strong></p>
<ul>
<li>NetworkAgent生命周期</li>
<li>网络状态上报流程</li>
<li>WiFi/Cellular的Agent实现</li>
</ul>
</li>
<li>
<p><strong>NetworkFactory工作原理</strong></p>
<ul>
<li>网络请求匹配机制</li>
<li>Factory评分与竞争</li>
<li>按需网络激活</li>
</ul>
</li>
<li>
<p><strong>网络状态管理</strong></p>
<ul>
<li>9种网络状态详解</li>
<li>状态机转换流程</li>
<li>Linger机制</li>
</ul>
</li>
<li>
<p><strong>WiFi与移动网络切换</strong></p>
<ul>
<li>切换决策算法</li>
<li>NetworkRanker评分机制</li>
<li>无缝切换实现</li>
</ul>
</li>
<li>
<p><strong>实战：网络问题诊断</strong></p>
<ul>
<li>WiFi连接失败排查</li>
<li>网络切换异常定位</li>
<li>性能优化技巧</li>
</ul>
</li>
</ol>
<p>让我们开始这段深入Android网络核心的旅程！</p>
<hr/>
<h2 data-id="heading-3">一、ConnectivityService架构总览</h2>
<h3 data-id="heading-4">1.1 ConnectivityService的核心职责</h3>
<p>ConnectivityService是Android网络栈的"总管家"，负责：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">┌────────────────────────────────────────┐
│      ConnectivityService核心职责        │
├────────────────────────────────────────┤
│ <span class="hljs-number">1.</span> 网络生命周期管理                     │
│    - 创建/销毁网络                      │
│    - 监控网络状态                       │
│    - 处理网络切换                       │
│                                        │
│ <span class="hljs-number">2.</span> 网络请求调度                         │
│    - 接收NetworkRequest                │
│    - 分发到对应NetworkFactory          │
│    - 管理请求优先级                     │
│                                        │
│ <span class="hljs-number">3.</span> 网络能力管理                         │
│    - NetworkCapabilities匹配           │
│    - 网络评分(NetworkScore)            │
│    - 默认网络选择                       │
│                                        │
│ <span class="hljs-number">4.</span> 网络验证                            │
│    - 触发NetworkMonitor验证            │
│    - 处理Captive Portal               │
│    - 管理部分连接状态                   │
│                                        │
│ <span class="hljs-number">5.</span> 应用网络权限                         │
│    - <span class="hljs-built_in">UID</span>网络访问控制                    │
│    - 后台数据限制                       │
│    - VPN隧道管理                       │
└────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-5">1.2 整体架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/424ee010e395475da12c022ee30aad87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770207627&amp;x-signature=tjXJzYy5buG2mXRro1kDAt7b2co%3D" alt="07-01-connectivityservice-architecture.png" loading="lazy"/></p>
<p><strong>架构分层说明</strong>：</p>
<h4 data-id="heading-6"><strong>应用层（Application Layer）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用使用ConnectivityManager API</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> (ConnectivityManager)
    context.getSystemService(Context.CONNECTIVITY_SERVICE);

<span class="hljs-comment">// 请求网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET)
    .addTransportType(NetworkCapabilities.TRANSPORT_WIFI)
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络可用</span>
    }
});
</code></pre>
<h4 data-id="heading-7"><strong>Framework层（ConnectivityService核心）</strong></h4>
<p>ConnectivityService源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/Connectivity/service/src/com/android/server/ConnectivityService.java
</code></pre>
<p><strong>核心数据结构</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/.../ConnectivityService.java (精简版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectivityService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IConnectivityManager</span>.Stub {

    <span class="hljs-comment">// 所有NetworkAgent的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;Messenger, NetworkAgentInfo&gt; mNetworkAgentInfos =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 所有NetworkRequest的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SparseArray&lt;NetworkRequestInfo&gt; mNetworkRequests =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparseArray</span>&lt;&gt;();

    <span class="hljs-comment">// 所有NetworkFactory的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;NetworkFactoryInfo&gt; mNetworkFactoryInfos =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">// 当前默认网络</span>
    <span class="hljs-keyword">private</span> NetworkAgentInfo mDefaultNetwork;

    <span class="hljs-comment">// 网络评分器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NetworkRanker mNetworkRanker;

    <span class="hljs-comment">// 权限监控</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PermissionMonitor mPermissionMonitor;

    <span class="hljs-comment">// 核心方法：注册NetworkAgent</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerNetworkAgent</span><span class="hljs-params">(Messenger messenger,
                                     NetworkInfo networkInfo,
                                     LinkProperties linkProperties,
                                     NetworkCapabilities networkCapabilities,
                                     <span class="hljs-type">int</span> currentScore,
                                     NetworkAgentConfig networkAgentConfig,
                                     <span class="hljs-type">int</span> factorySerialNumber)</span> {

        <span class="hljs-comment">// 1. 创建NetworkAgentInfo</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">nai</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkAgentInfo</span>(
            messenger, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncChannel</span>(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Network</span>(mNextNetworkId++),
            networkInfo, linkProperties,
            networkCapabilities, currentScore,
            mContext, mHandler,
            networkAgentConfig, <span class="hljs-built_in">this</span>,
            mNetd, mDnsResolver,
            mNMS, factorySerialNumber);

        <span class="hljs-comment">// 2. 分配NetId</span>
        <span class="hljs-keyword">try</span> {
            mNetd.networkCreate(nai.network.netId,
                               NativeNetworkType.PHYSICAL);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            loge(<span class="hljs-string">"Error creating network "</span> + nai.network.netId);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 3. 添加到管理列表</span>
        mNetworkAgentInfos.put(messenger, nai);

        <span class="hljs-comment">// 4. 通知NetworkMonitor开始验证</span>
        nai.networkMonitor.start();

        <span class="hljs-comment">// 5. 匹配NetworkRequest</span>
        rematchNetworkAndRequests(nai, ReapUnvalidatedNetworks.DONT_REAP);
    }

    <span class="hljs-comment">// 核心方法：处理NetworkRequest</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestNetwork</span><span class="hljs-params">(NetworkCapabilities nc,
                               Messenger messenger,
                               <span class="hljs-type">int</span> timeoutMs,
                               IBinder binder,
                               <span class="hljs-type">int</span> legacyType,
                               <span class="hljs-meta">@CallbackFlags</span> <span class="hljs-type">int</span> callbackFlags)</span> {

        <span class="hljs-comment">// 1. 权限检查</span>
        enforceAccessPermission();

        <span class="hljs-comment">// 2. 创建NetworkRequestInfo</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkRequestInfo</span> <span class="hljs-variable">nri</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequestInfo</span>(
            messenger, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>(nc, legacyType,
            nextNetworkRequestId(), NetworkRequest.Type.REQUEST),
            binder);

        <span class="hljs-comment">// 3. 保存请求</span>
        mNetworkRequests.put(nri.request.requestId, nri);

        <span class="hljs-comment">// 4. 发送给所有NetworkFactory</span>
        <span class="hljs-keyword">for</span> (NetworkFactoryInfo nfi : mNetworkFactoryInfos) {
            nfi.asyncChannel.sendMessage(
                android.net.NetworkFactory.CMD_REQUEST_NETWORK,
                nri.request);
        }

        <span class="hljs-comment">// 5. 尝试匹配现有网络</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">bestNetwork</span> <span class="hljs-operator">=</span>
            getBestNetwork(nri.request, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">if</span> (bestNetwork != <span class="hljs-literal">null</span>) {
            callCallbackForRequest(nri, bestNetwork,
                                  ConnectivityManager.CALLBACK_AVAILABLE);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">1.3 与其他系统服务的关系</h3>
<pre><code class="hljs language-arduino" lang="arduino">┌──────────────────────────────────────────────┐
│           ConnectivityService                │
│              (核心协调者)                      │
└─────────────┬────────────────────────────────┘
              │
    ┌─────────┼─────────┬──────────┬──────────┐
    │         │         │          │          │
    ▼         ▼         ▼          ▼          ▼
┌────────┐ ┌──────┐ ┌────────┐ ┌──────┐ ┌────────┐
│NetworkStack│Netd │ │Telephony│ <span class="hljs-built_in">WiFi</span> │ │VpnManager
│        │ │      │ │Service │ |Service│ │        │
│验证网络  │ │路由  │ │蜂窝网络 │ |无线   │  │VPN隧道  │
│        │ │配置   │ │        │|      │  │        │
└────────┘ └──────┘ └────────┘ └──────┘ └────────┘
</code></pre>
<p><strong>关键交互</strong>：</p>
<ol>
<li><strong>与NetworkStack交互</strong> - 网络验证</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService触发验证</span>
nai.networkMonitor.notifyNetworkConnected(
    nai.linkProperties, nai.networkCapabilities);

<span class="hljs-comment">// NetworkStack执行HTTP探测</span>
<span class="hljs-comment">// 返回验证结果(VALID/PORTAL/INVALID)</span>
</code></pre>
<ol start="2">
<li><strong>与Netd交互</strong> - 路由配置</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置默认网络</span>
mNetd.networkSetDefault(nai.network.netId);

<span class="hljs-comment">// 添加路由规则</span>
mNetd.networkAddRoute(netId, ifname, destination, nexthop);
</code></pre>
<ol start="3">
<li><strong>与TelephonyService交互</strong> - 移动网络</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 请求移动数据连接</span>
telephonyNetworkFactory.needNetworkFor(request);

<span class="hljs-comment">// 接收数据连接状态变化</span>
onDataConnectionStateChanged(state, networkType);
</code></pre>
<h3 data-id="heading-9">1.4 Android 15的架构改进</h3>
<h4 data-id="heading-10"><strong>改进1：模块化NetworkStack</strong></h4>
<p>Android 10开始，NetworkStack从system_server独立为单独进程：</p>
<pre><code class="hljs language-markdown" lang="markdown">Android 9及之前:
┌────────────────────────┐
│    system<span class="hljs-emphasis">_server       │
│  ┌──────────────────┐  │
│  │ConnectivityService│  │
│  │  + NetworkMonitor │  │ ← 验证逻辑耦合
│  └──────────────────┘  │
└────────────────────────┘

Android 10+:
┌────────────────────────┐     ┌──────────────┐
│    system_</span>server       │     │NetworkStack  │
│  ┌──────────────────┐  │     │  进程         │
│  │ConnectivityService│◄─────►│┌────────────┐│
│  └──────────────────┘  │ AIDL││NetworkMonitor│
└────────────────────────┘     │└────────────┘│
<span class="hljs-code">                              └──────────────┘
                              ↑ 可独立更新
</span></code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>NetworkStack可通过APK更新，无需OTA</li>
<li>隔离故障，NetworkStack崩溃不影响system_server</li>
<li>更好的安全边界</li>
</ul>
<h4 data-id="heading-11"><strong>改进2：eBPF网络策略</strong></h4>
<p>Android 15使用eBPF替代iptables：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel BPF程序 - 快速数据包过滤</span>
SEC(<span class="hljs-string">"cgroup/sock"</span>)
<span class="hljs-type">int</span> <span class="hljs-title function_">bpf_cgroup_sock_filter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_sock *sk)</span> {
    __u32 uid = bpf_get_current_uid_gid();

    <span class="hljs-comment">// 查询UID是否允许访问网络</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uid_permission_value</span> *<span class="hljs-title">value</span> =</span>
        bpf_map_lookup_elem(&amp;uid_permission_map, &amp;uid);

    <span class="hljs-keyword">if</span> (value &amp;&amp; value-&gt;permission == PERMISSION_DENIED)
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 拒绝连接</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// 允许连接</span>
}
</code></pre>
<p><strong>性能提升</strong>：</p>
<ul>
<li>iptables规则匹配：O(n)</li>
<li>eBPF哈希查找：O(1)</li>
<li>延迟降低：~100μs → ~10μs</li>
</ul>
<h4 data-id="heading-12"><strong>改进3：Multi-Network API增强</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 15新增：网络切片(Network Slicing)支持</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_ENTERPRISE)  <span class="hljs-comment">// 企业专网</span>
    .setEnterpriseId(NET_ENTERPRISE_ID_1)      <span class="hljs-comment">// 切片ID</span>
    .build();

<span class="hljs-comment">// 5G网络切片可以为不同业务提供差异化QoS</span>
</code></pre>
<hr/>
<h2 data-id="heading-13">二、NetworkAgent机制深度解析</h2>
<h3 data-id="heading-14">2.1 NetworkAgent是什么？</h3>
<p><strong>NetworkAgent</strong>是网络提供者（如WiFi、Cellular、Ethernet、VPN）与ConnectivityService之间的"信使"。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">WiFi</span>底层驱动
    ↓
<span class="hljs-built_in">WiFiNetworkAgent</span> (继承NetworkAgent)
    ↓ Messenger通信
ConnectivityService
</code></pre>
<h3 data-id="heading-15">2.2 NetworkAgent生命周期</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7e77cfb92d4126a7313de48768dae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770207627&amp;x-signature=gKkU%2FnrZvJp7TwzFeV%2B%2FRB9HLPU%3D" alt="07-02-network-state-machine.png" loading="lazy"/></p>
<p><strong>9种核心状态详解</strong>：</p>
<h4 data-id="heading-16"><strong>1. DISCONNECTED（断开）</strong></h4>
<ul>
<li>初始状态，NetworkAgent尚未创建</li>
<li>或网络已完全销毁</li>
</ul>
<h4 data-id="heading-17"><strong>2. CONNECTING（连接中）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// WiFiNetworkAgent创建时</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WiFiNetworkAgent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkAgent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WiFiNetworkAgent</span><span class="hljs-params">(Context context, ...)</span> {
        <span class="hljs-built_in">super</span>(context, looper, TAG,
              networkInfo,        <span class="hljs-comment">// 初始状态：CONNECTING</span>
              networkCapabilities,
              linkProperties,
              networkScore,
              config);
    }
}
</code></pre>
<h4 data-id="heading-18"><strong>3. CONNECTED（已连接）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 物理连接建立后，Agent上报</span>
sendLinkProperties(linkProperties);
sendNetworkCapabilities(networkCapabilities);
sendNetworkScore(score);

<span class="hljs-comment">// ConnectivityService收到后更新状态 → CONNECTED</span>
</code></pre>
<h4 data-id="heading-19"><strong>4. VALIDATING（验证中）</strong></h4>
<p>ConnectivityService自动触发NetworkMonitor：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/NetworkStack/.../NetworkMonitor.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyNetworkConnected</span><span class="hljs-params">(LinkProperties lp,
                                   NetworkCapabilities nc)</span> {
    <span class="hljs-comment">// 1. HTTP探测</span>
    <span class="hljs-type">ValidationProbeEvent</span> <span class="hljs-variable">probeResult</span> <span class="hljs-operator">=</span>
        isCaptivePortal(mCleartextDnsNetwork);

    <span class="hljs-comment">// 2. HTTPS探测</span>
    probeResult = httpsProbe();

    <span class="hljs-comment">// 3. DNS探测</span>
    probeResult = sendDnsProbe(mPrivateDnsProviderHostname);

    <span class="hljs-comment">// 4. 返回验证结果</span>
    <span class="hljs-keyword">if</span> (allProbesSucceeded) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationResult</span>(
            NetworkValidationResult.VALID, ...);
    }
}
</code></pre>
<p><strong>验证URL（可配置）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># HTTP</span>
http://connectivitycheck.gstatic.com/generate_204

<span class="hljs-comment"># HTTPS</span>
https://www.google.com/generate_204

<span class="hljs-comment"># 返回HTTP 204表示验证通过</span>
</code></pre>
<h4 data-id="heading-20"><strong>5. VALIDATED（已验证）</strong></h4>
<p>验证通过后，网络成为"候选默认网络"：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateNetworkInfo</span><span class="hljs-params">(NetworkAgentInfo nai, NetworkInfo info)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">oldScore</span> <span class="hljs-operator">=</span> nai.getCurrentScore();

    <span class="hljs-keyword">if</span> (info.getDetailedState() == NetworkInfo.DetailedState.CONNECTED) {
        <span class="hljs-comment">// 网络验证通过，提升评分</span>
        nai.setScore(oldScore + <span class="hljs-number">10</span>);

        <span class="hljs-comment">// 重新评估默认网络</span>
        rematchAllNetworksAndRequests();
    }
}
</code></pre>
<h4 data-id="heading-21"><strong>6. CAPTIVE_PORTAL（强制门户）</strong></h4>
<p>检测到需要网页登录（如公共WiFi）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor检测到HTTP 302重定向</span>
<span class="hljs-keyword">if</span> (probeResult.isPortal()) {
    <span class="hljs-comment">// 显示登录通知</span>
    showSignInNotification(nai);

    <span class="hljs-comment">// 等待用户登录后重新验证</span>
    scheduleReevaluation(REEVALUATION_DELAY_MS);
}
</code></pre>
<p>用户体验：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 连接WiFi
<span class="hljs-bullet">2.</span> 系统检测到强制门户
<span class="hljs-bullet">3.</span> 弹出通知："需要登录WiFi网络"
<span class="hljs-bullet">4.</span> 点击通知打开登录页面
<span class="hljs-bullet">5.</span> 登录成功后自动重新验证
<span class="hljs-bullet">6.</span> 状态变为VALIDATED
</code></pre>
<h4 data-id="heading-22"><strong>7. LOSING（即将丢失）</strong></h4>
<p>Linger机制 - 给应用迁移时间：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Connectivity/.../ConnectivityService.java</span>

<span class="hljs-comment">// 当更好的网络出现时</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLingerComplete</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
    <span class="hljs-comment">// Linger倒计时开始（默认30秒）</span>
    nai.lingerExpiryMs = SystemClock.elapsedRealtime()
                        + mLingerDelayMs;

    <span class="hljs-comment">// 通知应用网络即将失去</span>
    <span class="hljs-keyword">for</span> (NetworkRequestInfo nri : nai.networkRequests) {
        callCallbackForRequest(nri, nai,
            ConnectivityManager.CALLBACK_LOSING,
            mLingerDelayMs);
    }
}
</code></pre>
<p>应用可以：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用收到CALLBACK_LOSING</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLosing</span><span class="hljs-params">(Network network, <span class="hljs-type">int</span> maxMsToLive)</span> {
    <span class="hljs-comment">// 还有maxMsToLive毫秒，快速迁移连接</span>
    <span class="hljs-keyword">if</span> (maxMsToLive &gt; <span class="hljs-number">0</span> &amp;&amp; maxMsToLive &lt; <span class="hljs-number">30000</span>) {
        <span class="hljs-comment">// 将TCP连接迁移到新网络</span>
        migrateConnectionsToNewNetwork();
    }
}
</code></pre>
<h4 data-id="heading-23"><strong>8. SUSPENDED（暂停）</strong></h4>
<p>网络物理可用但逻辑暂停（如飞行模式）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 进入飞行模式</span>
when (Intent.ACTION_AIRPLANE_MODE_CHANGED) {
    <span class="hljs-keyword">if</span> (isAirplaneModeOn) {
        <span class="hljs-comment">// 暂停所有网络（除了local-only）</span>
        <span class="hljs-keyword">for</span> (NetworkAgentInfo nai : mNetworkAgentInfos.values()) {
            <span class="hljs-keyword">if</span> (!nai.isLocalNetwork()) {
                nai.networkInfo.setDetailedState(
                    NetworkInfo.DetailedState.SUSPENDED,
                    <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-24"><strong>9. DISCONNECTING（断开中）</strong></h4>
<p>主动或被动断开：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 主动断开</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// Agent通知ConnectivityService</span>
    mAsyncChannel.sendMessage(CMD_NETWORK_DISCONNECT);
}

<span class="hljs-comment">// ConnectivityService处理</span>
<span class="hljs-keyword">case</span> CMD_NETWORK_DISCONNECT:
    <span class="hljs-comment">// 1. 移除路由</span>
    mNetd.networkDestroy(nai.network.netId);

    <span class="hljs-comment">// 2. 通知应用</span>
    callCallbackForRequest(nri, nai, CALLBACK_LOST);

    <span class="hljs-comment">// 3. 清理Agent</span>
    mNetworkAgentInfos.remove(nai.messenger);
    <span class="hljs-keyword">break</span>;
</code></pre>
<h3 data-id="heading-25">2.3 NetworkAgent实现示例：WiFiNetworkAgent</h3>
<p>源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/Wifi/service/java/com/android/server/wifi/WifiNetworkAgent.java
</code></pre>
<p><strong>创建过程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/.../WifiNetworkAgent.java (简化版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WifiNetworkAgent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkAgent</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WifiInfo mWifiInfo;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WifiNetworkAgent</span><span class="hljs-params">(Context context, Looper looper,
                           WifiInfo wifiInfo,
                           NetworkCapabilities nc,
                           LinkProperties lp,
                           NetworkScore score)</span> {
        <span class="hljs-built_in">super</span>(context, looper, <span class="hljs-string">"WifiNetworkAgent"</span>,
              nc, lp, score, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkAgentConfig</span>.Builder().build(),
              NetworkProvider.ID_WIFI);

        mWifiInfo = wifiInfo;
        register();  <span class="hljs-comment">// 向ConnectivityService注册</span>
    }

    <span class="hljs-comment">// 当WiFi连接信息变化时</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendNetworkCapabilities</span><span class="hljs-params">(NetworkCapabilities nc)</span> {
        <span class="hljs-comment">// 更新WiFi特定能力</span>
        nc.setSignalStrength(mWifiInfo.getRssi());
        nc.setLinkUpstreamBandwidthKbps(
            mWifiInfo.getLinkSpeed() * <span class="hljs-number">1000</span>);

        <span class="hljs-built_in">super</span>.sendNetworkCapabilities(nc);
    }

    <span class="hljs-comment">// 当IP配置完成时</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendLinkProperties</span><span class="hljs-params">(LinkProperties lp)</span> {
        <span class="hljs-comment">// WiFi接口名</span>
        lp.setInterfaceName(mWifiInfo.getInterfaceName());

        <span class="hljs-comment">// IP地址</span>
        lp.addLinkAddress(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkAddress</span>(ipAddress, prefixLength));

        <span class="hljs-comment">// DNS服务器</span>
        <span class="hljs-keyword">for</span> (InetAddress dns : dnsServers) {
            lp.addDnsServer(dns);
        }

        <span class="hljs-comment">// 路由</span>
        lp.addRoute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RouteInfo</span>(destination, gateway, ifname));

        <span class="hljs-built_in">super</span>.sendLinkProperties(lp);
    }
}
</code></pre>
<p><strong>状态上报流程</strong>：</p>
<pre><code class="hljs language-css" lang="css">WiFi驱动: DHCP成功获取IP
    ↓
WifiStateMachine: 解析IP配置
    ↓
WifiNetworkAgent.<span class="hljs-built_in">sendLinkProperties</span>(lp)
    ↓
NetworkAgent.<span class="hljs-built_in">sendMessage</span>(EVENT_NETWORK_PROPERTIES_CHANGED, lp)
    ↓
ConnectivityService收到消息
    ↓
<span class="hljs-built_in">updateLinkProperties</span>(nai, lp)
    ↓
触发NetworkMonitor验证
    ↓
<span class="hljs-built_in">notifyNetworkCallbacks</span>(CALLBACK_IP_CHANGED)
    ↓
应用收到<span class="hljs-built_in">onLinkPropertiesChanged</span>()回调
</code></pre>
<hr/>
<h2 data-id="heading-26">三、NetworkFactory工作原理</h2>
<h3 data-id="heading-27">3.1 NetworkFactory的角色</h3>
<p><strong>NetworkFactory</strong>是"网络工厂"，负责按需创建网络连接。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">应用请求：<span class="hljs-string">"我需要WiFi网络"</span>
    ↓
<span class="hljs-symbol">ConnectivityService:</span> <span class="hljs-string">"哪个Factory能提供WiFi?"</span>
    ↓
<span class="hljs-symbol">WiFiNetworkFactory:</span> <span class="hljs-string">"我可以！"</span>
    ↓
WiFiNetworkFactory激活WiFi连接
    ↓
创建WifiNetworkAgent并注册
</code></pre>
<h3 data-id="heading-28">3.2 Factory注册与评分</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Wifi/.../WifiNetworkFactory.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WifiNetworkFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkFactory</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WifiNetworkFactory</span><span class="hljs-params">(Looper looper, Context context, ...)</span> {
        <span class="hljs-built_in">super</span>(looper, context, <span class="hljs-string">"WifiNetworkFactory"</span>,
              <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCapabilities</span>.Builder()
                  .addTransportType(TRANSPORT_WIFI)
                  .addCapability(NET_CAPABILITY_INTERNET)
                  .addCapability(NET_CAPABILITY_NOT_RESTRICTED)
                  .build());

        <span class="hljs-comment">// 注册到ConnectivityService</span>
        register();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">needNetworkFor</span><span class="hljs-params">(NetworkRequest request)</span> {
        <span class="hljs-comment">// 收到ConnectivityService的网络请求</span>

        <span class="hljs-comment">// 1. 检查是否能满足请求</span>
        <span class="hljs-keyword">if</span> (!request.hasCapability(NET_CAPABILITY_INTERNET)) {
            <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 不处理</span>
        }

        <span class="hljs-comment">// 2. 启动WiFi扫描</span>
        mWifiManager.startScan();

        <span class="hljs-comment">// 3. 连接最佳AP</span>
        <span class="hljs-type">WifiConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> selectBestNetwork(scanResults);
        mWifiManager.connect(config, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseNetworkFor</span><span class="hljs-params">(NetworkRequest request)</span> {
        <span class="hljs-comment">// NetworkRequest被取消，可以断开WiFi</span>
        <span class="hljs-keyword">if</span> (noMoreRequests()) {
            mWifiManager.disconnect();
        }
    }
}
</code></pre>
<h3 data-id="heading-29">3.3 NetworkRequest匹配机制</h3>
<p><strong>NetworkCapabilities匹配规则</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkCapabilities.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">satisfiedByNetworkCapabilities</span><span class="hljs-params">(NetworkCapabilities nc)</span> {
    <span class="hljs-comment">// 1. Transport类型必须匹配</span>
    <span class="hljs-keyword">if</span> ((mTransportTypes &amp; nc.mTransportTypes) != mTransportTypes) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 2. 必须的Capability都要有</span>
    <span class="hljs-keyword">if</span> ((mNetworkCapabilities &amp; nc.mNetworkCapabilities)
        != mNetworkCapabilities) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 3. 禁止的Capability不能有</span>
    <span class="hljs-keyword">if</span> ((mUnwantedNetworkCapabilities &amp; nc.mNetworkCapabilities) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 4. 链路上下行带宽满足要求</span>
    <span class="hljs-keyword">if</span> (getLinkDownstreamBandwidthKbps() &gt;
        nc.getLinkDownstreamBandwidthKbps()) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>示例：复杂NetworkRequest</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用请求：高速、非计费、WiFi直连网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_INTERNET)
    .addCapability(NET_CAPABILITY_NOT_METERED)  <span class="hljs-comment">// 非计费</span>
    .addTransportType(TRANSPORT_WIFI)           <span class="hljs-comment">// 必须WiFi</span>
    .setLinkDownstreamBandwidthKbps(<span class="hljs-number">10000</span>)      <span class="hljs-comment">// 至少10Mbps</span>
    .setNetworkSpecifier(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WifiNetworkSpecifier</span>.Builder()
        .setSsid(<span class="hljs-string">"MyNetwork"</span>)                   <span class="hljs-comment">// 指定SSID</span>
        .build())
    .build();

cm.requestNetwork(request, callback);
</code></pre>
<p><strong>ConnectivityService匹配过程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendUpdatedScoreToFactories</span><span class="hljs-params">(NetworkRequest request)</span> {
    <span class="hljs-comment">// 遍历所有Factory</span>
    <span class="hljs-keyword">for</span> (NetworkFactoryInfo nfi : mNetworkFactoryInfos) {

        <span class="hljs-comment">// 计算该Factory对这个Request的匹配得分</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> nfi.networkCapabilities
            .calculateScore(request.networkCapabilities);

        <span class="hljs-comment">// 发送REQUEST_NETWORK消息，附带分数</span>
        nfi.asyncChannel.sendMessage(CMD_REQUEST_NETWORK,
                                     score, <span class="hljs-number">0</span>, request);
    }
}
</code></pre>
<h3 data-id="heading-30">3.4 Factory竞争机制</h3>
<p>当多个Factory都能满足请求时，通过评分竞争：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkFactory.java</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
    <span class="hljs-keyword">switch</span> (msg.what) {
        <span class="hljs-keyword">case</span> CMD_REQUEST_NETWORK:
            <span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (NetworkRequest) msg.obj;
            <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> msg.arg1;

            <span class="hljs-comment">// 如果分数为0，说明不匹配，释放网络</span>
            <span class="hljs-keyword">if</span> (score == <span class="hljs-number">0</span>) {
                releaseNetworkFor(request);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 分数越高，越应该积极响应</span>
                <span class="hljs-keyword">if</span> (score &gt; mCurrentScore) {
                    needNetworkFor(request);
                }
            }
            <span class="hljs-keyword">break</span>;
    }
}
</code></pre>
<p><strong>实际场景</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">用户请求：联网但不指定类型

WiFiNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">60</span> (WiFi已连接)
  - 无需操作，WiFi已激活

TelephonyNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">50</span> (移动数据可用但未连接)
  - score &lt; WiFi，不激活移动数据

VpnNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">0</span> (VPN无法满足普通请求)
  - 释放VPN请求(如果有)

最终：使用WiFi网络
</code></pre>
<hr/>
<h2 data-id="heading-31">四、WiFi与移动网络切换</h2>
<h3 data-id="heading-32">4.1 切换触发条件</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rematchAllNetworksAndRequests</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 重新评估所有网络</span>
    <span class="hljs-keyword">for</span> (NetworkAgentInfo nai : mNetworkAgentInfos.values()) {
        updateNetworkScore(nai);
    }

    <span class="hljs-comment">// 2. 重新选择最佳网络</span>
    <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">newDefault</span> <span class="hljs-operator">=</span> getBestNetwork();

    <span class="hljs-comment">// 3. 如果默认网络变化</span>
    <span class="hljs-keyword">if</span> (newDefault != mDefaultNetwork) {
        <span class="hljs-comment">// 触发切换</span>
        makeDefault(newDefault);
    }
}
</code></pre>
<p><strong>常见触发场景</strong>：</p>



































<table><thead><tr><th align="left">场景</th><th align="left">触发条件</th><th align="left">切换方向</th></tr></thead><tbody><tr><td align="left">WiFi信号变弱</td><td align="left">RSSI &lt; -75dBm</td><td align="left">WiFi → 移动网络</td></tr><tr><td align="left">WiFi验证失败</td><td align="left">HTTP探测失败</td><td align="left">WiFi → 移动网络</td></tr><tr><td align="left">移动数据打开</td><td align="left">用户手动启用</td><td align="left">无 → 移动网络</td></tr><tr><td align="left">连接到更好的WiFi</td><td align="left">新WiFi RSSI更高</td><td align="left">移动网络 → WiFi</td></tr><tr><td align="left">移出WiFi覆盖</td><td align="left">WiFi断开</td><td align="left">WiFi → 移动网络</td></tr></tbody></table>
<h3 data-id="heading-33">4.2 NetworkRanker评分算法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Connectivity/.../NetworkRanker.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkRanker</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">rankNetwork</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-comment">// 1. 基础分数（Transport类型）</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_WIFI)) {
            score += <span class="hljs-number">60</span>;  <span class="hljs-comment">// WiFi基础分60</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_CELLULAR)) {
            score += <span class="hljs-number">50</span>;  <span class="hljs-comment">// 移动网络基础分50</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_ETHERNET)) {
            score += <span class="hljs-number">70</span>;  <span class="hljs-comment">// 以太网基础分70</span>
        }

        <span class="hljs-comment">// 2. 验证状态加分</span>
        <span class="hljs-keyword">if</span> (nai.everValidated) {
            score += <span class="hljs-number">10</span>;  <span class="hljs-comment">// 曾经验证通过+10分</span>
        }
        <span class="hljs-keyword">if</span> (nai.lastValidated) {
            score += <span class="hljs-number">20</span>;  <span class="hljs-comment">// 最近验证通过+20分</span>
        }

        <span class="hljs-comment">// 3. 网络能力加分</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasCapability(
            NET_CAPABILITY_NOT_METERED)) {
            score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 非计费网络+5分</span>
        }
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasCapability(
            NET_CAPABILITY_NOT_ROAMING)) {
            score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 非漫游+5分</span>
        }

        <span class="hljs-comment">// 4. 信号强度影响(WiFi)</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_WIFI)) {
            <span class="hljs-type">int</span> <span class="hljs-variable">rssi</span> <span class="hljs-operator">=</span> nai.networkCapabilities.getSignalStrength();
            <span class="hljs-keyword">if</span> (rssi &gt; -<span class="hljs-number">60</span>) score += <span class="hljs-number">10</span>;      <span class="hljs-comment">// 优秀信号</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rssi &gt; -<span class="hljs-number">70</span>) score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 良好信号</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rssi &lt; -<span class="hljs-number">80</span>) score -= <span class="hljs-number">10</span>; <span class="hljs-comment">// 差信号扣分</span>
        }

        <span class="hljs-comment">// 5. 链路速度影响</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">linkSpeed</span> <span class="hljs-operator">=</span> nai.networkCapabilities
            .getLinkDownstreamBandwidthKbps();
        <span class="hljs-keyword">if</span> (linkSpeed &gt; <span class="hljs-number">100000</span>) score += <span class="hljs-number">10</span>;  <span class="hljs-comment">// &gt;100Mbps</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (linkSpeed &gt; <span class="hljs-number">10000</span>) score += <span class="hljs-number">5</span>; <span class="hljs-comment">// &gt;10Mbps</span>

        <span class="hljs-comment">// 6. VPN特殊处理</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_VPN)) {
            score += <span class="hljs-number">101</span>;  <span class="hljs-comment">// VPN总是优先</span>
        }

        <span class="hljs-keyword">return</span> score;
    }
}
</code></pre>
<p><strong>示例计算</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">场景：<span class="hljs-built_in">WiFi</span>和LTE同时可用

<span class="hljs-built_in">WiFi</span>网络:
  基础分: <span class="hljs-number">60</span>
  验证通过: +<span class="hljs-number">20</span>
  非计费: +<span class="hljs-number">5</span>
  信号强度(<span class="hljs-number">-65</span>dBm): +<span class="hljs-number">5</span>
  速度(<span class="hljs-number">50</span>Mbps): +<span class="hljs-number">5</span>
  总分: <span class="hljs-number">95</span>

LTE网络:
  基础分: <span class="hljs-number">50</span>
  验证通过: +<span class="hljs-number">20</span>
  漫游: <span class="hljs-number">0</span>
  总分: <span class="hljs-number">70</span>

结果：<span class="hljs-built_in">WiFi</span>得分更高，成为默认网络
</code></pre>
<h3 data-id="heading-34">4.3 无缝切换实现</h3>
<p><strong>第一阶段：准备新网络</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeDefault</span><span class="hljs-params">(NetworkAgentInfo newDefault)</span> {
    <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">oldDefault</span> <span class="hljs-operator">=</span> mDefaultNetwork;

    <span class="hljs-keyword">if</span> (oldDefault == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 首次建立默认网络</span>
        setDefaultNetwork(newDefault);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 1. 配置新网络路由（但不设为默认）</span>
    mNetd.networkAddRoute(newDefault.network.netId,
                         newDefault.linkProperties.getInterfaceName(),
                         <span class="hljs-string">"0.0.0.0/0"</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 2. 通知应用新网络可用</span>
    callCallbackForRequest(nri, newDefault, CALLBACK_AVAILABLE);

    <span class="hljs-comment">// 3. 给旧网络30秒Linger时间</span>
    handleLingerComplete(oldDefault);
}
</code></pre>
<p><strong>第二阶段：迁移连接</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用收到onAvailable回调</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
    <span class="hljs-comment">// 主动将Socket绑定到新网络</span>
    network.bindSocket(mySocket);

    <span class="hljs-comment">// 或使用Network.openConnection</span>
    <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection)
        network.openConnection(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">"https://example.com"</span>));
}
</code></pre>
<p><strong>第三阶段：切换默认网络</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Linger超时后，切换默认路由</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLingered</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
    <span class="hljs-comment">// 1. 移除旧网络默认路由</span>
    mNetd.networkClearDefault();

    <span class="hljs-comment">// 2. 设置新网络为默认</span>
    mNetd.networkSetDefault(mDefaultNetwork.network.netId);

    <span class="hljs-comment">// 3. 通知应用旧网络已丢失</span>
    callCallbackForRequest(nri, nai, CALLBACK_LOST);

    <span class="hljs-comment">// 4. 销毁旧NetworkAgent</span>
    nai.networkMonitor.stop();
    mNetworkAgentInfos.remove(nai.messenger);
}
</code></pre>
<p><strong>用户体验</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">时刻<span class="hljs-number">0</span>s: <span class="hljs-built_in">WiFi</span>信号变弱
  → NetworkMonitor检测到验证失败
  → NetworkRanker重新评分
  → LTE得分超过<span class="hljs-built_in">WiFi</span>

时刻<span class="hljs-number">0.1</span>s: 准备LTE网络
  → TelephonyNetworkFactory激活数据连接
  → <span class="hljs-number">3</span><span class="hljs-number">-5</span>秒后LTE连接建立

时刻<span class="hljs-number">5</span>s: 通知应用
  → 发送<span class="hljs-built_in">CALLBACK_AVAILABLE</span>(LTE)
  → 应用开始迁移连接

时刻<span class="hljs-number">5</span><span class="hljs-number">-35</span>s: Linger期
  → <span class="hljs-built_in">WiFi</span>和LTE并存
  → 新连接使用LTE
  → 旧连接仍用<span class="hljs-built_in">WiFi</span>

时刻<span class="hljs-number">35</span>s: 完成切换
  → <span class="hljs-built_in">WiFi</span>成为默认网络
  → 发送<span class="hljs-built_in">CALLBACK_LOST</span>(<span class="hljs-built_in">WiFi</span>)
  → <span class="hljs-built_in">WiFi</span>断开

用户感知：几乎无感知切换
</code></pre>
<h3 data-id="heading-35">4.4 避免频繁切换</h3>
<p><strong>问题</strong>：WiFi信号在临界值附近波动导致频繁切换</p>
<p><strong>解决方案：Hysteresis（滞后）机制</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkRanker.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldSwitchToNewNetwork</span><span class="hljs-params">(NetworkAgentInfo oldNai,
                                        NetworkAgentInfo newNai)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">oldScore</span> <span class="hljs-operator">=</span> rankNetwork(oldNai);
    <span class="hljs-type">int</span> <span class="hljs-variable">newScore</span> <span class="hljs-operator">=</span> rankNetwork(newNai);

    <span class="hljs-comment">// 新网络必须显著优于旧网络才切换</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HYSTERESIS</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;  <span class="hljs-comment">// 滞后阈值</span>

    <span class="hljs-keyword">if</span> (newScore &gt; oldScore + HYSTERESIS) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 新网络显著更好</span>
    }

    <span class="hljs-comment">// 避免抖动：仅当新网络远优于旧网络时才切换</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><strong>效果</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">不使用滞后:
时间  <span class="hljs-built_in">WiFi</span> RSSI  分数  默认网络
<span class="hljs-number">0</span>s    <span class="hljs-number">-71</span>dBm    <span class="hljs-number">65</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">1</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">2</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    → 切换到LTE
<span class="hljs-number">3</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    → 切换到<span class="hljs-built_in">WiFi</span>
<span class="hljs-number">4</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    → 切换到<span class="hljs-built_in">LTE</span>  (频繁抖动)

使用滞后(阈值<span class="hljs-number">10</span>):
<span class="hljs-number">0</span>s    <span class="hljs-number">-71</span>dBm    <span class="hljs-number">65</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">1</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">2</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    <span class="hljs-built_in">WiFi</span>  (<span class="hljs-number">60</span> vs <span class="hljs-number">50</span>+<span class="hljs-number">10</span>=<span class="hljs-number">60</span>, 不切换)
<span class="hljs-number">3</span>s    <span class="hljs-number">-77</span>dBm    <span class="hljs-number">55</span>    → 切换到<span class="hljs-built_in">LTE</span> (<span class="hljs-number">55</span> &lt; <span class="hljs-number">50</span>+<span class="hljs-number">10</span>)
<span class="hljs-number">4</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">LTE</span>   (<span class="hljs-number">63</span> &lt; <span class="hljs-number">50</span>+<span class="hljs-number">10</span>, 仍用LTE)
</code></pre>
<hr/>
<h2 data-id="heading-36">五、网络验证与Captive Portal处理</h2>
<h3 data-id="heading-37">5.1 NetworkMonitor验证流程</h3>
<p>源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/NetworkStack/src/android/net/captiveportal/CaptivePortalProbeResult.java
packages/modules/NetworkStack/src/android/net/NetworkMonitor.java
</code></pre>
<p><strong>完整验证流程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor.java (简化版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkMonitor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StateMachine</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_HTTP_URL</span> <span class="hljs-operator">=</span>
        <span class="hljs-string">"http://connectivitycheck.gstatic.com/generate_204"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_HTTPS_URL</span> <span class="hljs-operator">=</span>
        <span class="hljs-string">"https://www.google.com/generate_204"</span>;

    <span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">isCaptivePortal</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. HTTP探测</span>
        <span class="hljs-type">CaptivePortalProbeResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> sendHttpProbe(
            mCleartextDnsNetwork, VALIDATION_TYPE_HTTP);

        <span class="hljs-keyword">if</span> (result.isSuccessful()) {
            <span class="hljs-comment">// HTTP 204返回，说明可以访问互联网</span>
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">if</span> (result.isPortal()) {
            <span class="hljs-comment">// HTTP重定向，说明是Captive Portal</span>
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-comment">// 2. HTTPS探测（更可靠）</span>
        result = sendHttpProbe(
            mCleartextDnsNetwork, VALIDATION_TYPE_HTTPS);

        <span class="hljs-keyword">if</span> (result.isSuccessful()) {
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-comment">// 3. DNS探测（检查DNS是否被劫持）</span>
        result = sendDnsProbe(mPrivateDnsProviderHostname);

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">sendHttpProbe</span><span class="hljs-params">(
            Network network, <span class="hljs-type">int</span> validationType)</span> {

        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> (validationType == VALIDATION_TYPE_HTTPS)
                ? mHttpsUrl : mHttpUrl;

        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            conn = (HttpURLConnection) network.openConnection(url);
            conn.setInstanceFollowRedirects(<span class="hljs-literal">false</span>);
            conn.setConnectTimeout(SOCKET_TIMEOUT_MS);
            conn.setReadTimeout(SOCKET_TIMEOUT_MS);
            conn.setUseCaches(<span class="hljs-literal">false</span>);
            conn.addRequestProperty(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"close"</span>);

            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> SystemClock.elapsedRealtime();
            conn.getInputStream();
            <span class="hljs-type">long</span> <span class="hljs-variable">latency</span> <span class="hljs-operator">=</span> SystemClock.elapsedRealtime() - start;

            <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> conn.getResponseCode();
            <span class="hljs-type">String</span> <span class="hljs-variable">location</span> <span class="hljs-operator">=</span> conn.getHeaderField(<span class="hljs-string">"Location"</span>);

            <span class="hljs-comment">// HTTP 204 = 验证通过</span>
            <span class="hljs-keyword">if</span> (responseCode == <span class="hljs-number">204</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                    CaptivePortalProbeResult.SUCCESS, latency);
            }

            <span class="hljs-comment">// HTTP 200 = 可能是Captive Portal</span>
            <span class="hljs-keyword">if</span> (responseCode &gt;= <span class="hljs-number">200</span> &amp;&amp; responseCode &lt;= <span class="hljs-number">399</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                    CaptivePortalProbeResult.PORTAL,
                    location, latency);
            }

            <span class="hljs-comment">// 其他 = 验证失败</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, latency);

        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, <span class="hljs-number">0</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) conn.disconnect();
        }
    }
}
</code></pre>
<h3 data-id="heading-38">5.2 Captive Portal登录流程</h3>
<p><strong>场景：连接星巴克WiFi</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Step 1:</span> <span class="hljs-string">物理连接</span>
  <span class="hljs-string">用户:</span> <span class="hljs-string">选择"Starbucks</span> <span class="hljs-string">WiFi"</span>
  <span class="hljs-attr">WiFi:</span> <span class="hljs-string">DHCP获取IP</span> <span class="hljs-string">(192.168.1.100)</span>
  <span class="hljs-attr">WiFiNetworkAgent:</span> <span class="hljs-string">上报CONNECTED状态</span>

<span class="hljs-attr">Step 2:</span> <span class="hljs-string">NetworkMonitor验证</span>
  <span class="hljs-string">HTTP探测</span> <span class="hljs-string">→</span> <span class="hljs-string">http://connectivitycheck.gstatic.com/generate_204</span>
  <span class="hljs-string">服务器返回:</span> <span class="hljs-string">HTTP</span> <span class="hljs-number">302</span> <span class="hljs-string">Redirect</span>
  <span class="hljs-attr">Location:</span> <span class="hljs-string">http://星巴克登录页面.com/login</span>

  <span class="hljs-string">结论:</span> <span class="hljs-string">检测到Captive</span> <span class="hljs-string">Portal</span>

<span class="hljs-attr">Step 3:</span> <span class="hljs-string">通知用户</span>
  <span class="hljs-string">系统通知:</span> <span class="hljs-string">"需要登录WiFi网络"</span>
  <span class="hljs-string">点击后打开:</span> <span class="hljs-string">CaptivePortalLoginActivity</span>

<span class="hljs-attr">Step 4:</span> <span class="hljs-string">用户登录</span>
  <span class="hljs-string">WebView加载登录页</span>
  <span class="hljs-string">用户输入信息</span> <span class="hljs-string">/</span> <span class="hljs-string">同意条款</span>
  <span class="hljs-string">登录成功</span>

<span class="hljs-attr">Step 5:</span> <span class="hljs-string">重新验证</span>
  <span class="hljs-attr">NetworkMonitor:</span> <span class="hljs-string">再次发送HTTP探测</span>
  <span class="hljs-string">服务器返回:</span> <span class="hljs-string">HTTP</span> <span class="hljs-number">204</span> <span class="hljs-string">(验证通过)</span>
  <span class="hljs-string">状态:</span> <span class="hljs-string">CAPTIVE_PORTAL</span> <span class="hljs-string">→</span> <span class="hljs-string">VALIDATED</span>
</code></pre>
<p><strong>代码实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CaptivePortalLoginActivity.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaptivePortalLoginActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> {

    <span class="hljs-keyword">private</span> WebView mWebView;
    <span class="hljs-keyword">private</span> Network mNetwork;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);

        <span class="hljs-comment">// 获取要验证的网络</span>
        mNetwork = getIntent().getParcelableExtra(
            ConnectivityManager.EXTRA_NETWORK);

        <span class="hljs-comment">// 设置WebView使用该网络</span>
        mWebView = findViewById(R.id.webview);
        mWebView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PortalWebViewClient</span>());

        <span class="hljs-comment">// 加载登录页面</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> getIntent().getStringExtra(
            ConnectivityManager.EXTRA_CAPTIVE_PORTAL_URL);
        mWebView.loadUrl(url);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PortalWebViewClient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebViewClient</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, String url)</span> {
            <span class="hljs-comment">// 检查是否登录成功</span>
            <span class="hljs-keyword">if</span> (isSuccessUrl(url)) {
                <span class="hljs-comment">// 通知系统重新验证</span>
                notifyPortalLoginSuccess();
                finish();
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyPortalLoginSuccess</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> getSystemService(
            ConnectivityManager.class);
        cm.reportNetworkConnectivity(mNetwork, <span class="hljs-literal">true</span>);
    }
}
</code></pre>
<h3 data-id="heading-39">5.3 Android 15 Private DNS支持</h3>
<p><strong>DoT (DNS over TLS)</strong> - 加密DNS查询：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor.java - Android 15新增</span>
<span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">sendDnsProbe</span><span class="hljs-params">(String hostname)</span> {
    <span class="hljs-keyword">if</span> (isPrivateDnsValidationRequired()) {
        <span class="hljs-comment">// 使用TLS加密的DNS查询</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">SSLSocket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> (SSLSocket)
                SSLSocketFactory.getDefault()
                    .createSocket(mPrivateDnsServerIp, <span class="hljs-number">853</span>);

            socket.startHandshake();

            <span class="hljs-comment">// 发送DNS查询</span>
            <span class="hljs-type">DnsPacket</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> DnsPacket.createQuery(
                hostname, TYPE_A);
            socket.getOutputStream().write(query.getBytes());

            <span class="hljs-comment">// 接收响应</span>
            <span class="hljs-type">DnsPacket</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> DnsPacket.parse(
                socket.getInputStream());

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.SUCCESS, <span class="hljs-number">0</span>);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, <span class="hljs-number">0</span>);
        }
    }
}
</code></pre>
<p><strong>配置Private DNS</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 → 网络和互联网 → 私人DNS</span>
adb shell settings put global private_dns_mode hostname
adb shell settings put global private_dns_specifier dns.google

<span class="hljs-comment"># 验证</span>
adb shell getprop net.dns1
<span class="hljs-comment"># 输出: 8.8.8.8 (使用Google Public DNS)</span>
</code></pre>
<hr/>
<h2 data-id="heading-40">六、实战：网络问题诊断</h2>
<h3 data-id="heading-41">6.1 WiFi连接失败排查</h3>
<p><strong>症状</strong>：WiFi显示"已连接"但无法上网</p>
<p><strong>诊断步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 1: 检查网络状态</span>
adb shell dumpsys connectivity | grep -A 30 <span class="hljs-string">"Active networks"</span>

<span class="hljs-comment"># 输出示例:</span>
<span class="hljs-comment"># NetworkAgentInfo{ ni{[WIFI () - 100]}</span>
<span class="hljs-comment">#   network{151}  handle{151}</span>
<span class="hljs-comment">#   lp{{InterfaceName: wlan0</span>
<span class="hljs-comment">#       LinkAddresses: [ 192.168.1.100/24 ]</span>
<span class="hljs-comment">#       DnsAddresses: [ 192.168.1.1 ]</span>
<span class="hljs-comment">#       Routes: [ 0.0.0.0/0 -&gt; 192.168.1.1 wlan0 ]}}</span>
<span class="hljs-comment">#   nc{[ Transports: WIFI</span>
<span class="hljs-comment">#        Capabilities: NOT_METERED</span>
<span class="hljs-comment">#        NOT_ROAMING INTERNET NOT_SUSPENDED VALIDATED]}  ← 注意这里</span>
<span class="hljs-comment">#   Score{current=60 validated=true}}</span>

<span class="hljs-comment"># 关键字段:</span>
<span class="hljs-comment"># - VALIDATED: 网络已验证 (如果没有此字段，说明验证失败)</span>
<span class="hljs-comment"># - DnsAddresses: DNS服务器 (检查是否正确)</span>
<span class="hljs-comment"># - LinkAddresses: 本机IP (检查是否在合理范围)</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 2: 检查网络验证结果</span>
adb shell dumpsys network_stack | grep -i <span class="hljs-string">"validation"</span>

<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment"># ValidationProbeEvent{latency=234 result=204 ...}  ← HTTP 204表示通过</span>
<span class="hljs-comment"># 或</span>
<span class="hljs-comment"># ValidationProbeEvent{latency=5000 result=timeout ...}  ← 超时</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 3: 手动测试连通性</span>
adb shell

<span class="hljs-comment"># Ping网关</span>
ping -c 4 192.168.1.1
<span class="hljs-comment"># 如果不通，说明局域网问题</span>

<span class="hljs-comment"># Ping DNS</span>
ping -c 4 8.8.8.8
<span class="hljs-comment"># 如果不通，说明路由问题</span>

<span class="hljs-comment"># Ping域名</span>
ping -c 4 www.google.com
<span class="hljs-comment"># 如果不通，说明DNS问题</span>

<span class="hljs-comment"># HTTP测试</span>
curl -I http://connectivitycheck.gstatic.com/generate_204
<span class="hljs-comment"># 应该返回 HTTP/1.1 204 No Content</span>
</code></pre>
<p><strong>常见原因与解决方案</strong>：</p>



































<table><thead><tr><th align="left">现象</th><th align="left">原因</th><th align="left">解决方案</th></tr></thead><tbody><tr><td align="left">Ping网关不通</td><td align="left">WiFi驱动/硬件问题</td><td align="left">重启WiFi，检查驱动日志</td></tr><tr><td align="left">Ping DNS不通</td><td align="left">路由器未设置默认网关</td><td align="left">检查DHCP配置</td></tr><tr><td align="left">Ping域名不通</td><td align="left">DNS服务器故障</td><td align="left">手动设置DNS为8.8.8.8</td></tr><tr><td align="left">HTTP返回302</td><td align="left">Captive Portal</td><td align="left">打开浏览器完成登录</td></tr><tr><td align="left">HTTP超时</td><td align="left">防火墙拦截</td><td align="left">检查iptables规则</td></tr></tbody></table>
<h3 data-id="heading-42">6.2 网络切换异常定位</h3>
<p><strong>症状</strong>：从WiFi切换到移动网络后，应用无法联网</p>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看当前默认网络</span>
adb shell dumpsys connectivity | grep <span class="hljs-string">"Active default"</span>
<span class="hljs-comment"># 输出: Active default network: 151</span>

<span class="hljs-comment"># 2. 查看该网络详情</span>
adb shell dumpsys connectivity networks 151
<span class="hljs-comment"># 确认是否是期望的网络(WiFi/LTE)</span>

<span class="hljs-comment"># 3. 检查应用是否绑定了旧网络</span>
adb shell dumpsys connectivity requests | grep <span class="hljs-string">"YOUR_PACKAGE"</span>
<span class="hljs-comment"># 输出会显示应用的NetworkRequest和绑定的Network</span>

<span class="hljs-comment"># 4. 抓取网络切换日志</span>
adb logcat -b all | grep -E <span class="hljs-string">"ConnectivityService|NetworkAgent"</span>
</code></pre>
<p><strong>典型日志分析</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"># 正常切换日志:
<span class="hljs-symbol">ConnectivityService:</span> NetworkAgentInfo [WIFI] validation passed
<span class="hljs-symbol">ConnectivityService:</span> Setting <span class="hljs-keyword">default</span> network <span class="hljs-keyword">to</span> <span class="hljs-number">151</span> (WIFI)
<span class="hljs-symbol">ConnectivityService:</span> Lingering network <span class="hljs-number">149</span> (MOBILE)
... (<span class="hljs-number">30</span>秒后)
<span class="hljs-symbol">ConnectivityService:</span> Tearing down network <span class="hljs-number">149</span>

# 异常切换日志:
<span class="hljs-symbol">ConnectivityService:</span> NetworkAgentInfo [MOBILE] validation failed
<span class="hljs-symbol">ConnectivityService:</span> <span class="hljs-built_in">Not</span> setting <span class="hljs-keyword">default</span> <span class="hljs-keyword">to</span> unvalidated network
← 移动网络验证失败，未切换
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用代码修复：使用ConnectivityManager.NetworkCallback</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> ...;
<span class="hljs-type">NetworkCallback</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络可用时，将Socket绑定到新网络</span>
        <span class="hljs-keyword">try</span> {
            network.bindSocket(mySocket);
            <span class="hljs-comment">// 或重新创建连接</span>
            recreateConnection(network);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            Log.e(TAG, <span class="hljs-string">"Failed to bind socket"</span>, e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLost</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络丢失时，清理资源</span>
        closeConnection();
    }
};

<span class="hljs-comment">// 注册监听</span>
cm.registerDefaultNetworkCallback(callback);
</code></pre>
<h3 data-id="heading-43">6.3 性能优化：减少网络切换延迟</h3>
<p><strong>问题</strong>：WiFi→LTE切换需要5-8秒</p>
<p><strong>优化方案</strong>：</p>
<h4 data-id="heading-44"><strong>方案1：预连接移动网络</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 12引入的MultiPath API</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> ...;

<span class="hljs-comment">// 请求同时使用WiFi和LTE</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_INTERNET)
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 保持LTE连接处于激活状态</span>
        <span class="hljs-comment">// 当WiFi断开时，可立即切换</span>
    }
}, MULTI_PATH_PREFERENCE_PERFORMANCE);
</code></pre>
<h4 data-id="heading-45"><strong>方案2：快速失败检测</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 缩短验证超时时间</span>
adb shell settings put global captive_portal_http_url_timeout_ms <span class="hljs-number">3000</span>

<span class="hljs-comment">// 默认值：10000ms (10秒)</span>
<span class="hljs-comment">// 优化后：3000ms (3秒)</span>
</code></pre>
<h4 data-id="heading-46"><strong>方案3：应用层优化 - Happy Eyeballs</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RFC 8305: 同时尝试IPv4和IPv6，使用最快响应的</span>
<span class="hljs-keyword">public</span> Socket <span class="hljs-title function_">connectWithHappyEyeballs</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port)</span> {
    List&lt;InetAddress&gt; addresses =
        InetAddress.getAllByName(host);  <span class="hljs-comment">// 获取所有IP</span>

    List&lt;Future&lt;Socket&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();

    <span class="hljs-comment">// 并发连接所有地址</span>
    <span class="hljs-keyword">for</span> (InetAddress addr : addresses) {
        futures.add(executor.submit(() -&gt; {
            <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>();
            socket.connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(addr, port), <span class="hljs-number">1000</span>);
            <span class="hljs-keyword">return</span> socket;
        }));
    }

    <span class="hljs-comment">// 返回第一个成功的连接</span>
    <span class="hljs-keyword">for</span> (Future&lt;Socket&gt; future : futures) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> future.get(<span class="hljs-number">2</span>, TimeUnit.SECONDS);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 继续尝试下一个</span>
        }
    }

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">"All connection attempts failed"</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-47">七、Android 15新特性</h2>
<h3 data-id="heading-48">7.1 Satellite Connectivity（卫星连接）</h3>
<p>Android 15新增卫星网络支持：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检测卫星网络可用性</span>
<span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">nc</span> <span class="hljs-operator">=</span> cm.getNetworkCapabilities(network);

<span class="hljs-keyword">if</span> (nc.hasTransport(NetworkCapabilities.TRANSPORT_SATELLITE)) {
    <span class="hljs-comment">// 这是卫星连接</span>
    <span class="hljs-comment">// 特点：高延迟(500-800ms)、低带宽(几Kbps)、高成本</span>

    <span class="hljs-comment">// 应用应该:</span>
    <span class="hljs-comment">// 1. 使用文本通信而非语音/视频</span>
    <span class="hljs-comment">// 2. 压缩数据</span>
    <span class="hljs-comment">// 3. 减少请求频率</span>
}
</code></pre>
<h3 data-id="heading-49">7.2 Network Slicing (5G网络切片)</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 请求特定的5G切片</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_ENTERPRISE)
    .setEnterpriseId(NET_ENTERPRISE_ID_1)  <span class="hljs-comment">// 企业专网切片</span>
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 使用企业专网，享受:</span>
        <span class="hljs-comment">// - 更低延迟 (&lt;10ms)</span>
        <span class="hljs-comment">// - 更高带宽保证</span>
        <span class="hljs-comment">// - 更好的QoS</span>
    }
});
</code></pre>
<h3 data-id="heading-50">7.3 Thread Network Support</h3>
<p>Android 15支持Thread协议（用于智能家居）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 连接Thread网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addTransportType(NetworkCapabilities.TRANSPORT_THREAD)
    .build();

<span class="hljs-comment">// Thread特点:</span>
<span class="hljs-comment">// - 低功耗</span>
<span class="hljs-comment">// - Mesh网络</span>
<span class="hljs-comment">// - IPv6 only</span>
<span class="hljs-comment">// - 用于IoT设备</span>
</code></pre>
<hr/>
<h2 data-id="heading-51">八、总结与展望</h2>
<h3 data-id="heading-52">8.1 核心要点回顾</h3>
<ol>
<li>
<p><strong>ConnectivityService架构</strong></p>
<ul>
<li>系统网络管理中枢</li>
<li>协调NetworkAgent和NetworkFactory</li>
<li>管理网络生命周期</li>
</ul>
</li>
<li>
<p><strong>NetworkAgent机制</strong></p>
<ul>
<li>9种网络状态</li>
<li>状态机驱动</li>
<li>基于Messenger通信</li>
</ul>
</li>
<li>
<p><strong>NetworkFactory工作原理</strong></p>
<ul>
<li>按需激活网络</li>
<li>Capability匹配</li>
<li>评分竞争机制</li>
</ul>
</li>
<li>
<p><strong>网络切换</strong></p>
<ul>
<li>NetworkRanker评分算法</li>
<li>Linger优雅断开</li>
<li>Hysteresis防抖动</li>
</ul>
</li>
<li>
<p><strong>网络验证</strong></p>
<ul>
<li>HTTP/HTTPS探测</li>
<li>Captive Portal处理</li>
<li>Private DNS支持</li>
</ul>
</li>
</ol>
<h3 data-id="heading-53">8.2 ConnectivityService演进史</h3>













































<table><thead><tr><th align="left">版本</th><th align="left">关键变化</th><th align="left">影响</th></tr></thead><tbody><tr><td align="left">Android 5.0</td><td align="left">引入NetworkRequest/NetworkCallback</td><td align="left">应用可主动请求网络</td></tr><tr><td align="left">Android 7.0</td><td align="left">MultiNetwork API</td><td align="left">应用可同时使用多个网络</td></tr><tr><td align="left">Android 9.0</td><td align="left">强制使用HTTPS</td><td align="left">安全性提升</td></tr><tr><td align="left">Android 10.0</td><td align="left">NetworkStack模块化</td><td align="left">可独立更新</td></tr><tr><td align="left">Android 11.0</td><td align="left">eBPF网络策略</td><td align="left">性能大幅提升</td></tr><tr><td align="left">Android 12.0</td><td align="left">Network Slicing</td><td align="left">5G网络切片支持</td></tr><tr><td align="left">Android 15.0</td><td align="left">Satellite + Thread</td><td align="left">扩展连接场景</td></tr></tbody></table>
<h3 data-id="heading-54">8.3 未来展望</h3>
<p><strong>趋势1：AI驱动的网络管理</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 未来可能的实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AINetworkRanker</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.model = load_ml_model(<span class="hljs-string">"network_predictor.tflite"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict_network_quality</span>(<span class="hljs-params">self, nai</span>):
        features = extract_features(nai)  <span class="hljs-comment"># RSSI, 速度, 延迟等</span>
        score = self.model.predict(features)
        <span class="hljs-keyword">return</span> score
</code></pre>
<p><strong>趋势2：Seamless Multi-Path</strong></p>
<ul>
<li>同时使用WiFi+5G，自动负载均衡</li>
<li>关键数据走5G（低延迟），大数据走WiFi（省流量）</li>
</ul>
<p><strong>趋势3：边缘计算集成</strong></p>
<ul>
<li>ConnectivityService感知MEC(多接入边缘计算)节点</li>
<li>自动将流量路由到最近的边缘服务器</li>
</ul>
<hr/>
<h2 data-id="heading-55">九、参考资源</h2>
<h3 data-id="heading-56">9.1 源码路径</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ConnectivityService核心</span>
packages/modules/Connectivity/service/src/com/android/server/
├── ConnectivityService.java          <span class="hljs-comment"># 核心服务</span>
├── NetworkAgentInfo.java             <span class="hljs-comment"># Agent信息</span>
├── NetworkRequestInfo.java           <span class="hljs-comment"># 请求信息</span>
└── connectivity/
    ├── NetworkRanker.java            <span class="hljs-comment"># 网络排名</span>
    └── PermissionMonitor.java        <span class="hljs-comment"># 权限监控</span>

<span class="hljs-comment"># NetworkStack</span>
packages/modules/NetworkStack/src/
├── android/net/NetworkMonitor.java    <span class="hljs-comment"># 网络验证</span>
├── android/net/apf/                   <span class="hljs-comment"># APF包过滤</span>
└── android/net/ip/IpClient.java       <span class="hljs-comment"># IP配置</span>

<span class="hljs-comment"># NetworkAgent实现</span>
packages/modules/Wifi/service/java/com/android/server/wifi/
└── WifiNetworkAgent.java              <span class="hljs-comment"># WiFi Agent</span>

frameworks/opt/telephony/src/java/com/android/internal/telephony/
└── dataconnection/DcNetworkAgent.java <span class="hljs-comment"># Cellular Agent</span>
</code></pre>
<h3 data-id="heading-57">9.2 调试命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有网络</span>
adb shell dumpsys connectivity networks

<span class="hljs-comment"># 查看默认网络</span>
adb shell dumpsys connectivity | grep <span class="hljs-string">"Active default"</span>

<span class="hljs-comment"># 查看NetworkRequest</span>
adb shell dumpsys connectivity requests

<span class="hljs-comment"># 查看NetworkFactory</span>
adb shell dumpsys connectivity factories

<span class="hljs-comment"># 触发网络验证</span>
adb shell cmd connectivity force-network-validation &lt;netId&gt;

<span class="hljs-comment"># 模拟网络切换</span>
adb shell svc wifi <span class="hljs-built_in">disable</span> &amp;&amp; <span class="hljs-built_in">sleep</span> 2 &amp;&amp; adb shell svc wifi <span class="hljs-built_in">enable</span>

<span class="hljs-comment"># 查看eBPF统计</span>
adb shell dumpsys connectivity trafficcontroller
</code></pre>
<h3 data-id="heading-58">9.3 官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fcore%2Fconnect" target="_blank" title="https://source.android.com/docs/core/connect" ref="nofollow noopener noreferrer">Connectivity Overview</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fnet%2FConnectivityManager" target="_blank" title="https://developer.android.com/reference/android/net/ConnectivityManager" ref="nofollow noopener noreferrer">ConnectivityManager API</a></li>
</ul>
<h3 data-id="heading-59">9.4 相关RFC</h3>
<ul>
<li>RFC 3093: DHCP</li>
<li>RFC 8305: Happy Eyeballs v2</li>
<li>RFC 7858: DNS over TLS</li>
<li>RFC 8910: Captive Portal API</li>
</ul>
<hr/>
<h2 data-id="heading-60">后记</h2>
<p>ConnectivityService是Android系统中最复杂的服务之一，管理着设备与外界的所有网络连接。从简单的WiFi连接，到复杂的多网络并发、VPN隧道、5G切片，ConnectivityService都能游刃有余地处理。</p>
<h3 data-id="heading-61">系列文章</h3>
<ul>
<li><a href="https://juejin.cn/post/7599330434427158579" target="_blank" title="https://juejin.cn/post/7599330434427158579">上一篇：Android 15存储子系统深度解析（三）：FBE加密文件系统与存储性能优化实战</a></li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别AI塑料感？通义Z-Image开源：6B参数要把“大众脸”送进历史堆]]></title>    <link>https://juejin.cn/post/7600223321041780742</link>    <guid>https://juejin.cn/post/7600223321041780742</guid>    <pubDate>2026-01-28T12:43:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041780742" data-draft-id="7600223321041764358" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别AI塑料感？通义Z-Image开源：6B参数要把“大众脸”送进历史堆"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-28T12:43:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别AI塑料感？通义Z-Image开源：6B参数要把“大众脸”送进历史堆
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:43:25.000Z" title="Wed Jan 28 2026 12:43:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>老实说，在AI绘画圈子里摸爬滚打了这么久，大家是不是都有点审美疲劳了？</p>
<p>不管是用哪个主流模型，跑多了你总能发现某种“诡异的默契”：千篇一律的完美光影，像是同一个整容医生刀下的“网红脸”，还有那种一眼就能看穿的塑料质感。这种“同质化”就像是AI绘画头顶的一层玻璃天花板，好看是好看，但总觉得少了点灵魂。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-28_20.34.07.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-28_20.34.07.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9204d8f4eb934554a925c3c99c74110b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209008&amp;x-signature=rq8skxf9Fxb%2FDMQ8H778w8AVheE%3D" alt="iShot_2026-01-28_20.34.07" loading="lazy"/></a></p>
<p>不过，就在2026年1月28日，阿里云通义团队搞了个大动作，开源了名为 <strong>Z-Image</strong> 的基座模型。看完这波技术细节，我感觉这层天花板可能要被敲出裂缝了。</p>
<h3 data-id="heading-0">不止是快，更重要的是“原生”</h3>
<p>这次发布的 Z-Image 是一个 6B（60亿）参数量的模型。在这个百亿甚至千亿参数横行的年代，6B听起来似乎不算庞然大物，但它的定位非常精准：<strong>做一个完美的“底座”</strong>。</p>
<p>这就得聊聊这次发布的一个核心关键词——<strong>非蒸馏</strong>。</p>
<p>之前的很多模型为了追求极速出图（比如所谓的Turbo版），往往使用了蒸馏技术。这就像是把浓缩咖啡兑水变成了速溶，速度是快了，但很多细腻的风味（权重分布）丢失了。而这次开源的 Z-Image Base 版本，保留了全量的权重分布。</p>
<p>这对我们这些喜欢折腾的人来说意味着什么？意味着它的可塑性极强。它原生支持 CFG 引导机制，更是 LoRA 和 ControlNet 的绝佳温床。如果你想训练一个属于自己独特画风的模型，或者要把自家猫主子炼进去，这个“非蒸馏”的底子绝对比那些为了速度而阉割过的模型要好用得多。</p>
<h3 data-id="heading-1">向“AI大众脸”宣战</h3>
<p>Z-Image 最让我感兴趣的，是它试图解决“人像同质化”的野心。</p>
<p>官方在技术文档里提到，他们优化了采样空间的分布。翻译成人话就是：它不再总是偷懒去抄那几张最稳妥的“标准脸”作业了。</p>
<p>以前我们抽卡，十张图里有八张脸型差不多，但在 Z-Image 的逻辑里，不同的种子和提示词会真的导向截然不同的面孔特征和构图逻辑。它不仅能驾驭从写实摄影到二次元动漫的跨度，更重要的是，它试图在多人场景中剥离那种“克隆人军团”的感觉。这对于需要做连环画、游戏资产或者故事绘本的创作者来说，简直是刚需中的刚需。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-28_20.34.13.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-28_20.34.13.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/305ccea409aa47f782969f9966ea046a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209008&amp;x-signature=5cwQ73kG%2Fi5IQaL%2FBVmDZoeIPj0%3D" alt="iShot_2026-01-28_20.34.13" loading="lazy"/></a></p>
<h3 data-id="heading-2">门槛打下来了，玩法升上去了</h3>
<p>聊聊配置。6B 的参数量，显存占用控制得相当克制。根据目前的测试，主流的消费级显卡（16GB显存就是一个很舒服的甜点区，甚至更低配置通过量化也能跑）完全能扛得住。</p>
<p>这意味着你不需要租昂贵的A100服务器，在自己的本地电脑上就能跑起来。对于开发者而言，它基于 S³-DiT（单流扩散Transformer）架构，推理效率本身就很高。</p>
<h3 data-id="heading-3">写在最后</h3>
<p>目前的AI绘图圈，缺的其实不是那种能一秒钟出图的工具，而是缺一个能真正理解“差异化”、能让创作者深度定制的扎实地基。</p>
<p>阿里云通义这次把 Z-Image 的基座开源，显然是想走“生态包围”的路子。虽然官方目前还没把牛吹上天，但作为开源社区的一员，我能预感到，很快 ModelScope 和 Hugging Face 上就会涌现出一大批基于 Z-Image 微调的惊艳模型。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-28_20.34.19-741x1024.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-28_20.34.19-741x1024.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55ca5d878d684de0b4c5186d119efbf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209008&amp;x-signature=WLZOeM%2BzyhQHG7AeNp1trvq85bg%3D" alt="iShot_2026-01-28_20.34.19" loading="lazy"/></a></p>
<p>如果你也受够了千篇一律的AI脸，或者想亲手炼制一个真正听话的模型，不妨去魔搭社区或者 GitHub 上把这个权重拉下来试试。毕竟，工具只是画笔，真正的艺术，还得看握笔的人怎么用。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这10个隐藏扣子skills，每一个都能让你封神]]></title>    <link>https://juejin.cn/post/7600238071038345225</link>    <guid>https://juejin.cn/post/7600238071038345225</guid>    <pubDate>2026-01-28T11:22:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600238071038345225" data-draft-id="7600245693997006858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这10个隐藏扣子skills，每一个都能让你封神"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-28T11:22:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿星AI工作室"/> <meta itemprop="url" content="https://juejin.cn/user/2250051536050763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这10个隐藏扣子skills，每一个都能让你封神
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250051536050763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿星AI工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:22:04.000Z" title="Wed Jan 28 2026 11:22:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97c7a06ce0fa45b1a46f6e6866d2d5d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=wZoI9IkNjg7nu7mLeJ19HtJoGxI%3D" alt="图片" loading="lazy"/></p>
<p> </p>
<p>哈喽，大家好</p>
<p>我是阿星👋</p>
<p>自从扣子出了skills，阿星就在商店里各种收藏。</p>
<p>其中10个分享给大家。</p>
<p>（首先你需要下载个扣子app/去官网才能继续）——</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ce5464243744156be0715faca3cc1c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=PTvm1vSq2FgU%2FShtz8R1mO7VD%2Fo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">1、新年绘本</h2>
<p>扣子新年绘本sklls是真的打印实体的画册啊，不是pdf啊。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/463d91fe32ec426dac2993febedf7feb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=35cT%2Bncf1CXsjwQl%2FNuqe26DBCw%3D" alt="图片" loading="lazy"/></p>
<p>其实就是用这个新年绘本skills做的，很傻瓜的操作。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ed547c80e04ffdb58bcd778f5294e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=3XrRMEDGgu1vqu%2Bhra5AIEMun24%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38096c95ce004e9bacc9b8f4fa7b175d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=cIlcky7M2CNSYAyHywQ%2FhBCk1tI%3D" alt="图片" loading="lazy"/></p>
<p>把提示词发它，你可以改成自己或者宝宝的成长日记，</p>
<p>这样就更有纪念意义了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/446077a7b5844c08a04980dbaf239aed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=LXFx58ZD%2Fp7CK2ISIRX80qGma2E%3D" alt="图片" loading="lazy"/></p>
<p>然后它就开始生成了，</p>
<p>一顿代码输出，</p>
<p>播放起来竟然还是带音频的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85bf515b373245d182d015ce093318dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=mPYNAShEVl0kninMm1EGVDloHZc%3D" alt="图片" loading="lazy"/></p>
<p>最后，一键打印坐等就ok啦~而且可以保存成pdf自己留个底儿。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/924b74fcdd7545ccbef28c16ad06a6c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=UT5672LYt15XsQVj2mf8g4fEMcA%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1edd4df6b80a42ebb532e3e83d2287ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=5wJsulfVModvA426HTcGPB9bwvA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">2、快速榨干一本书</h2>
<p>一款为AI提供的书籍内容深度处理工具，能提取核心知识并给出执行建议。</p>
<p>阿星用《理解媒介》试了试，可能因为这本书太长了（444页）只能先给大家展示一部分效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed66c22ba8f44404adc063068a6d86c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=masWyQlzqysQSrfmjHAGKAlkh54%3D" alt="图片" loading="lazy"/></p>
<p>这个工具最核心的提示词是四层榨取法—— <strong>通过骨架提取（定义核心概念）、肉质挖掘（配置3类案例）、精华萃取（跨行业迁移和执行SOP）、残渣利用（批判性视角）四个层次来解读。</strong></p>
<p>要求每个知识点必须包含： <strong>定义+逻辑+3个案例+跨行业迁移矩阵+执行</strong> SOP+批判性视角，每个案例还要80-150字加50-100字解读。主要文件如下，大家可以按照自己的理解尝试复现一个。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62050228aed64ee9a4cef3c7e7d6f673~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=v9FxL4FUI5eW3wYc7pPJznSBwLI%3D" alt="图片" loading="lazy"/></p>
<p>从参考文件（references/）可以看出，作者对文章的结构进行了深层级、格式、 给样例等辅助操作才完成了内容结构的规划。</p>
<p>然后又通过脚本文件（scripts/）做了一些格式上的处理。比如markdown转pdf，但是我不建议大家用因为它要安装的包太多了。非常慢。直接看markdown就行了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a8a185291984d5fbdb3b47dde66b5af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=vnL2ickTJy4cQyQ1uW8%2FImlKAGA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">3、AI漫剧分镜提示词</h2>
<p>看到这个漫剧skills我一下就被吸引住了，</p>
<p>因为最近漫剧实在是太火了奈何阿星自己没学过编剧，</p>
<p>我还以为是随便给我生成个表格，结果它咔咔生成了好几分钟真的太专业了。</p>
<p>然后可以得到用来做整个漫剧图片的提示词。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21775308dd1a426ca3e2f45d766f488a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=Z9EejsKkTRNFE5KKjSNqqxgRi7Q%3D" alt="图片" loading="lazy"/></p>
<p>我们来看看产出物怎么样。</p>
<p>我惊喜的是它连人物一致性的关键词都给了。</p>
<p>阿星之前一直不想尝试漫剧就是因为定角色太麻烦了，这个skills竟然连主角的关键词都给我定好了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6cd0cf004f479ba33420130d7c1640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=rc3Ys1LkrLUFRhPxw4df4CJ52xA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">4、答案之书</h2>
<p>看到这个答案之书sklls阿星要笑出猪叫，我最近正在疯狂搜集这类视觉。</p>
<p>它的用法就是你跟他提问，它直接让你抽卡来回答你。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebae3e3c83a6400b9d32d07de340848d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=Wom13pGRhAdFrP15EoFHOOxGLxE%3D" alt="图片" loading="lazy"/></p>
<p>大家也可以利用media pipe</p>
<p>做一个类似的演示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bbe519dda21467dadfb9ce5eb6e6796~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=76ibMNFEAIANQ1G0oEpWvHNgvMo%3D" alt="图片" loading="lazy"/></p>
<p>这个sklls我建议大家在PC端用。因为它涉及到手势调用。手机摄像头是启动失败的无法感受神奇交互。</p>
<p>我问它我是否会成为中国AI赛道第一IP，他就会生成一个脚本，结果还不错必然登顶。棒！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0152a08effca4e91a8ab07c8dc9ecb25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=yfS1RFpL2hW%2BaEDMGmnQieDx5SE%3D" alt="图片" loading="lazy"/></p>
<p>原理是里面预制了不少答案，随机给我抽了一个。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd26d7218a044baeb3556cda7e5bbecf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=xAifP9vuesyBZMrHRrubg4CthY4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">5、二次元谷子定制助手</h2>
<p>二次元们可以用它定制周边，让心爱角色触手可及。</p>
<p>重点是生成完了还能直接变视频，擦除背景，</p>
<p>主要优点是比较方便我们二次修改。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b1a09c5b5be4a8397bf643db0da52c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=9rnRxjovGTdsBSw3MMFXkLqIagU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">6、Obsidian入门</h2>
<p>众所周知Obsidian摸索起来费老大劲，要学的实在太多了。</p>
<p>之前我还看看到过类似的书专门讲Obsidian的。那也太痛苦了，学个Obsidian还得看书。</p>
<p>这个技能提供Obsidian咋用的知识，适合老baby们入坑。</p>
<p>像我很久没用这个Obsidian都是因为学习成本太高，现在好了，需要什么学什么吧～</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f0f6d6287204dc680d4a72660b76889~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=DaJR1jZA6R8do54ZOjG2KgmFfIM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-6">7、DanKoe爆文写作</h2>
<p>Dan Koe风格爆文生成skills适合实在不会写作的同学，</p>
<p>可以一键生成标题、深度内容、封面及网页。</p>
<p>我建议大家但凡会写作就要自己动手写，让AI只是做辅助</p>
<p><strong>大神的写作模板只适合完全没有基础的同学模仿</strong> ，不适合想打造个人特色的同学。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75116bdf149144e598dde90c1b402035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=7WqTsu5AkFdpMU6PM7JgR0Np81g%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">8、SEO专家</h2>
<p>SEO专家是一个搜索引擎优化辅助skills。</p>
<p>它本质上是两个脚本构成的，</p>
<ol>
<li>
<ol>
<li>seo_analyzer.py - 自动化 SEO 分析脚本</li>
</ol>
</li>
<li>
<ol start="2">
<li>generate_sitemap.py - XML 站点地图生成器</li>
</ol>
</li>
</ol>
<p>特别跟小白同学说下，它和我们平常理解的seo标题文章生成不一样，</p>
<p>是针对项目工程本身的代码结构的检查，并且会给出详细的建议。</p>
<p>甚至帮你生成站点地图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8a3979d1258412b930dff4224347390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=iZRK%2FbRe5zIrh0CI%2FkwvTs5SRD4%3D" alt="图片" loading="lazy"/></p>
<p>特别是站点地图，初学者可能不知道这个东西。但是这个skills可以直接生成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b25df68e0da0453d8955cd92714f5fde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=N2HaviMPHxNjrlSdMScxN0zQcXY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">9、文章一键转PPT</h2>
<p>将长篇文章智能转化为专业级HTML演示文稿，</p>
<p>支持商务、科技、极客等多维视觉风格。可以体验一下，</p>
<p>正儿八经做大家最好还是在本地编辑一下再。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/920dc1bf98414d218ad1369da5df8e00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=spr25VACUtk%2B3bw5795dahf759U%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-9">10、新年人生四宫格</h2>
<p>新年人生四宫格技能是我最喜欢的一个。</p>
<p>过年的时候用它当头像太方便啦～</p>
<p>新的一年换上红红的头像，感觉寓意也很好。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/845792dd7cc84b698e34ee46de366003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=XPOs5lQfx8bVfLn2PPUqoIqoKI0%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ba8571d32984c2eaa760bc7b3d16e37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=1Rp6wK7ehUbM1MY9shhHorAvRKo%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c944ecc39d0445ca9ff653cb8a4b47e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=UHRm0ccz%2BwIn4qXjfck%2Bh08WoXQ%3D" alt="图片" loading="lazy"/></p>
<p>ok，我是阿星，更多AI应用，我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 从入门到精通（一）：初识 Compose]]></title>    <link>https://juejin.cn/post/7600032104249032767</link>    <guid>https://juejin.cn/post/7600032104249032767</guid>    <pubDate>2026-01-28T11:22:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104249032767" data-draft-id="7600060691350290474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 从入门到精通（一）：初识 Compose"/> <meta itemprop="keywords" content="Android,Kotlin,JetBrains"/> <meta itemprop="datePublished" content="2026-01-28T11:22:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邹阿涛涛涛涛涛涛涛涛"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009106839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 从入门到精通（一）：初识 Compose
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009106839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邹阿涛涛涛涛涛涛涛涛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:22:16.000Z" title="Wed Jan 28 2026 11:22:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>声明式 UI 的时代来临，让我们一起开启 Compose 学习之旅！</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言</h2>
<p>如果你还在用 XML 写布局、用 <code>findViewById</code> 查找视图、用 <code>setOnClickListener</code> 设置点击事件，那么你可能已经落后于时代了。</p>
<p>2021 年，Google 正式发布 <strong>Jetpack Compose 1.0</strong> 稳定版，标志着 Android 开发进入了<strong>声明式 UI</strong> 的新时代。今天，无论是 Google 官方应用、全新的 Android Studio，还是各大互联网厂的新项目，Compose 已经成为首选方案。</p>
<p>作为 Android 开发者，学习 Compose 不再是"可选项"，而是"必修课"。</p>
<p>本系列文章将带你从入门到精通，系统掌握 Jetpack Compose。今天的第一篇，我们先来打好基础，了解 Compose 是什么，并完成环境搭建。</p>
<hr/>
<h2 data-id="heading-1">一、Compose 是什么？</h2>
<h3 data-id="heading-2">1.1 官方定义</h3>
<p><strong>Jetpack Compose</strong> 是 Google 推出的用于构建 Android 界面的<strong>现代声明式 UI 工具包</strong>。它基于 Kotlin 语言，采用函数式编程思想，让界面开发变得更加简洁、直观和高效。</p>
<h3 data-id="heading-3">1.2 传统方式 vs Compose</h3>
<p>让我们用一段代码直观感受两者的区别：</p>
<p><strong>传统 View 系统（命令式）：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// XML 布局文件</span>
&lt;TextView
    android:id=<span class="hljs-string">"@+id/textView"</span>
    android:layout_width=<span class="hljs-string">"wrap_content"</span>
    android:layout_height=<span class="hljs-string">"wrap_content"</span> /&gt;

<span class="hljs-comment">// Kotlin 代码</span>
<span class="hljs-keyword">val</span> textView = findViewById&lt;TextView&gt;(R.id.textView)
textView.text = <span class="hljs-string">"Hello World"</span>
textView.setTextColor(Color.BLUE)
textView.setOnClickListener {
    <span class="hljs-comment">// 处理点击</span>
}
</code></pre>
<p><strong>Compose（声明式）：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Greeting</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span></span> {
    Text(
        text = <span class="hljs-string">"Hello <span class="hljs-variable">$name</span>"</span>,
        color = Color.Blue,
        modifier = Modifier.clickable {
            <span class="hljs-comment">// 处理点击</span>
        }
    )
}
</code></pre>
<p>可以看到，Compose 的代码更加简洁，布局与逻辑写在一起，无需在 XML 和 Kotlin 之间来回切换。</p>
<h3 data-id="heading-4">1.3 核心特性</h3>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>声明式语法</strong></td><td>描述"界面应该是什么样子"，而不是"如何创建界面"</td></tr><tr><td><strong>纯 Kotlin 实现</strong></td><td>无需 XML，类型安全、智能提示更好</td></tr><tr><td><strong>组合而非继承</strong></td><td>通过组合小型组件构建复杂界面，符合单一职责原则</td></tr><tr><td><strong>智能重组</strong></td><td>系统自动跟踪状态变化，只更新必要的部分</td></tr><tr><td><strong>实时预览</strong></td><td>Android Studio 实时预览，无需运行应用</td></tr></tbody></table>
<h3 data-id="heading-5">1.4 为什么要学 Compose？</h3>
<p><strong>传统 View 系统的痛点：</strong></p>
<ol>
<li><strong>命令式编程复杂</strong> - 手动管理视图状态，<code>findViewById</code> 容易出错</li>
<li><strong>XML 与代码分离</strong> - 布局在 XML，逻辑在 Kotlin，维护困难</li>
<li><strong>状态管理困难</strong> - 状态分散在各个 View 中，数据流难以追踪</li>
<li><strong>重复代码多</strong> - 自定义 View 需要继承并重写多个方法</li>
</ol>
<p><strong>Compose 的优势：</strong></p>
<ul>
<li>代码量减少 <strong>50%+</strong></li>
<li>开发效率大幅提升</li>
<li>状态管理更加清晰</li>
<li>跨平台支持（Compose Multiplatform）</li>
</ul>
<p><strong>行业趋势：</strong></p>
<ul>
<li>iOS：SwiftUI 已成为推荐方案</li>
<li>Web：React、Vue 早已普及声明式开发</li>
<li>Android：Compose 正在快速普及，成为默认选择</li>
</ul>
<hr/>
<h2 data-id="heading-6">二、环境搭建</h2>
<h3 data-id="heading-7">2.1 系统要求</h3>
<ul>
<li><strong>Android Studio</strong>：Arctic Fox (2020.3.1) 或更高版本（推荐最新稳定版）</li>
<li><strong>Kotlin</strong>：1.5.10 或更高版本</li>
<li><strong>minSdk</strong>：API 21 (Android 5.0) 或更高</li>
</ul>
<h3 data-id="heading-8">2.2 创建新项目</h3>
<p><strong>步骤 1：新建项目</strong></p>
<p>打开 Android Studio，选择 <strong>New Project</strong> → <strong>Empty Activity</strong>（注意选择 Compose 模板）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87899d9bc93c46ec90113fad7f9f47f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YK56Zi_5rab5rab5rab5rab5rab5rab5rab5rab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204608&amp;x-signature=7m36cG41AEg1t2e%2BTuXXW1G4dSM%3D" alt="image.png" loading="lazy"/>
<strong>步骤 2：配置项目</strong></p>
<ul>
<li><strong>Name</strong>：ComposeDemo</li>
<li><strong>Package name</strong>：com.example.composedemo</li>
<li><strong>Minimum SDK</strong>：API 21: Android 5.0 (Lollipop)</li>
<li><strong>Build configuration language</strong>：Kotlin DSL (build.gradle.kts)</li>
</ul>
<blockquote>
<p>💡 <strong>注意</strong>：确保勾选 "Use Compose" 选项（新版 Android Studio 默认启用）。</p>
</blockquote>
<p><strong>步骤 3：查看自动生成的配置</strong></p>
<p>项目创建完成后，<code>build.gradle.kts</code> (Module: app) 会自动包含以下配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {
    buildFeatures {
        compose = <span class="hljs-literal">true</span>
    }

    composeOptions {
        kotlinCompilerExtensionVersion = <span class="hljs-string">"1.5.10"</span> <span class="hljs-comment">// 根据实际版本调整</span>
    }

    kotlinOptions {
        jvmTarget = <span class="hljs-string">"1.8"</span>
    }
}

dependencies {
    <span class="hljs-comment">// Compose BOM（物料清单）</span>
    <span class="hljs-keyword">val</span> composeBom = platform(<span class="hljs-string">"androidx.compose:compose-bom:2024.02.00"</span>)
    implementation(composeBom)
    androidTestImplementation(composeBom)

    <span class="hljs-comment">// 核心库</span>
    implementation(<span class="hljs-string">"androidx.compose.ui:ui"</span>)
    implementation(<span class="hljs-string">"androidx.compose.ui:ui-graphics"</span>)
    implementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling-preview"</span>)
    
    <span class="hljs-comment">// Material Design 3</span>
    implementation(<span class="hljs-string">"androidx.compose.material3:material3"</span>)
    
    <span class="hljs-comment">// 调试工具</span>
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling"</span>)
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-test-manifest"</span>)
}
</code></pre>
<h3 data-id="heading-9">2.3 现有项目添加 Compose</h3>
<p>如果是现有项目，需要手动添加配置：</p>
<p><strong>build.gradle.kts (Module: app)：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {
    buildFeatures {
        compose = <span class="hljs-literal">true</span>
    }
    
    composeOptions {
        kotlinCompilerExtensionVersion = <span class="hljs-string">"1.5.10"</span>
    }
}

dependencies {
    <span class="hljs-keyword">val</span> composeBom = platform(<span class="hljs-string">"androidx.compose:compose-bom:2024.02.00"</span>)
    implementation(composeBom)
    
    implementation(<span class="hljs-string">"androidx.compose.ui:ui"</span>)
    implementation(<span class="hljs-string">"androidx.compose.material3:material3"</span>)
    implementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling-preview"</span>)
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling"</span>)
}
</code></pre>
<h3 data-id="heading-10">2.4 第一个 Compose 应用</h3>
<p>创建项目后，<code>MainActivity.kt</code> 已经自动生成基础代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {
            ComposeDemoTheme {
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    Greeting(<span class="hljs-string">"Android"</span>)
                }
            }
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Greeting</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    Text(
        text = <span class="hljs-string">"Hello <span class="hljs-variable">$name</span>!"</span>,
        modifier = modifier
    )
}

<span class="hljs-meta">@Preview(showBackground = true)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GreetingPreview</span><span class="hljs-params">()</span></span> {
    ComposeDemoTheme {
        Greeting(<span class="hljs-string">"Android"</span>)
    }
}
</code></pre>
<p><strong>运行应用：</strong></p>
<p>点击 Android Studio 的 <strong>Run</strong> 按钮（▶），即可在模拟器或真机上看到 "Hello Android!" 的界面。</p>
<p><strong>实时预览：</strong></p>
<p>在 <code>GreetingPreview</code> 函数右侧，点击 <strong>Split</strong> 或 <strong>Design</strong> 模式，即可看到实时预览效果，无需运行应用！</p>
<hr/>
<h2 data-id="heading-11">三、Composable 函数基础</h2>
<h3 data-id="heading-12">3.1 什么是 Composable 函数？</h3>
<p><strong>Composable 函数</strong>是 Compose 的基本构建块，用 <code>@Composable</code> 注解标记。它描述了 UI 的某一部分，类似于传统 View 系统中的自定义 View。</p>
<p><strong>基本结构：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyComponent</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// UI 描述</span>
}
</code></pre>
<h3 data-id="heading-13">3.2 命名规范</h3>
<ul>
<li>Composable 函数名使用<strong>大驼峰命名法</strong>（PascalCase）</li>
<li>名词或名词短语，描述 UI 的功能</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">()</span></span> { }

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginButton</span><span class="hljs-params">()</span></span> { }

<span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">userProfile</span><span class="hljs-params">()</span></span> { }  <span class="hljs-comment">// 小写开头</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showButton</span><span class="hljs-params">()</span></span> { }   <span class="hljs-comment">// 动词开头</span>
</code></pre>
<h3 data-id="heading-14">3.3 参数传递</h3>
<p>Composable 函数可以接受参数，实现数据驱动的 UI：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Greeting</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, age: <span class="hljs-type">Int</span>)</span></span> {
    Text(text = <span class="hljs-string">"Hello, <span class="hljs-variable">$name</span>! You are <span class="hljs-variable">$age</span> years old."</span>)
}

<span class="hljs-comment">// 使用</span>
Greeting(name = <span class="hljs-string">"张三"</span>, age = <span class="hljs-number">25</span>)
</code></pre>
<h3 data-id="heading-15">3.4 Modifier 基础</h3>
<p><strong>Modifier</strong> 是 Compose 中用于修饰 UI 元素的重要工具，可以设置尺寸、边距、点击事件等。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StyledText</span><span class="hljs-params">()</span></span> {
    Text(
        text = <span class="hljs-string">"Hello Compose"</span>,
        modifier = Modifier
            .padding(<span class="hljs-number">16.</span>dp)           <span class="hljs-comment">// 内边距</span>
            .fillMaxWidth()           <span class="hljs-comment">// 宽度填满父容器</span>
            .height(<span class="hljs-number">50.</span>dp)            <span class="hljs-comment">// 高度</span>
            .background(Color.LightGray) <span class="hljs-comment">// 背景色</span>
            .clickable {              <span class="hljs-comment">// 点击事件</span>
                <span class="hljs-comment">// 处理点击</span>
            }
    )
}
</code></pre>
<p><strong>常用 Modifier：</strong></p>

































<table><thead><tr><th>Modifier</th><th>作用</th></tr></thead><tbody><tr><td><code>padding()</code></td><td>设置内边距</td></tr><tr><td><code>fillMaxWidth()</code> / <code>fillMaxHeight()</code></td><td>填满父容器宽度/高度</td></tr><tr><td><code>size()</code> / <code>width()</code> / <code>height()</code></td><td>设置尺寸</td></tr><tr><td><code>background()</code></td><td>设置背景色</td></tr><tr><td><code>clickable()</code></td><td>添加点击事件</td></tr><tr><td><code>border()</code></td><td>添加边框</td></tr></tbody></table>
<h3 data-id="heading-16">3.5 预览注解</h3>
<p><code>@Preview</code> 注解用于在 Android Studio 中显示 Composable 的预览效果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Preview(
    name = <span class="hljs-string">"默认预览"</span>,
    showBackground = true,      // 显示背景
    backgroundColor = 0xFFFFFFFF, // 背景颜色（白色）
    widthDp = 360,              // 预览宽度
    heightDp = 640              // 预览高度
)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyPreview</span><span class="hljs-params">()</span></span> {
    MyComponent()
}
</code></pre>
<p><strong>多个预览：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Preview(name = <span class="hljs-string">"浅色模式"</span>, uiMode = Configuration.UI_MODE_NIGHT_NO)</span>
<span class="hljs-meta">@Preview(name = <span class="hljs-string">"深色模式"</span>, uiMode = Configuration.UI_MODE_NIGHT_YES)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ThemePreview</span><span class="hljs-params">()</span></span> {
    MyAppTheme {
        MyComponent()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-17">四、Material Design 3 组件初探</h2>
<h3 data-id="heading-18">4.1 什么是 Material Design 3？</h3>
<p><strong>Material Design 3</strong>（简称 M3）是 Google 最新的设计系统，提供了丰富的预构建组件，帮助开发者快速构建美观、一致的界面。</p>
<h3 data-id="heading-19">4.2 常用基础组件</h3>
<h4 data-id="heading-20">Text（文本）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TextDemo</span><span class="hljs-params">()</span></span> {
    Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
        <span class="hljs-comment">// 基础文本</span>
        Text(<span class="hljs-string">"Hello World"</span>)
        
        <span class="hljs-comment">// 样式设置</span>
        Text(
            text = <span class="hljs-string">"Styled Text"</span>,
            fontSize = <span class="hljs-number">20.</span>sp,
            fontWeight = FontWeight.Bold,
            color = Color.Blue
        )
        
        <span class="hljs-comment">// 多行文本</span>
        Text(
            text = <span class="hljs-string">"这是一段很长的文本，可能会自动换行显示。"</span>,
            maxLines = <span class="hljs-number">2</span>,
            overflow = TextOverflow.Ellipsis
        )
    }
}
</code></pre>
<h4 data-id="heading-21">Button（按钮）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ButtonDemo</span><span class="hljs-params">()</span></span> {
    Column(
        modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),
        verticalArrangement = Arrangement.spacedBy(<span class="hljs-number">8.</span>dp)
    ) {
        <span class="hljs-comment">// 基础按钮</span>
        Button(onClick = { <span class="hljs-comment">/* 点击处理 */</span> }) {
            Text(<span class="hljs-string">"点击我"</span>)
        }
        
        <span class="hljs-comment">// 带图标的按钮</span>
        Button(onClick = { }) {
            Icon(Icons.Default.Add, contentDescription = <span class="hljs-string">"添加"</span>)
            Spacer(modifier = Modifier.width(<span class="hljs-number">8.</span>dp))
            Text(<span class="hljs-string">"添加"</span>)
        }
        
        <span class="hljs-comment">// 描边按钮</span>
        OutlinedButton(onClick = { }) {
            Text(<span class="hljs-string">"描边按钮"</span>)
        }
        
        <span class="hljs-comment">// 文本按钮</span>
        TextButton(onClick = { }) {
            Text(<span class="hljs-string">"文本按钮"</span>)
        }
    }
}
</code></pre>
<h4 data-id="heading-22">Card（卡片）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CardDemo</span><span class="hljs-params">()</span></span> {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(<span class="hljs-number">16.</span>dp),
        elevation = CardDefaults.cardElevation(defaultElevation = <span class="hljs-number">4.</span>dp)
    ) {
        Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Text(
                text = <span class="hljs-string">"卡片标题"</span>,
                style = MaterialTheme.typography.titleLarge
            )
            Spacer(modifier = Modifier.height(<span class="hljs-number">8.</span>dp))
            Text(
                text = <span class="hljs-string">"这是卡片的内容描述文本。"</span>,
                style = MaterialTheme.typography.bodyMedium
            )
        }
    }
}
</code></pre>
<h4 data-id="heading-23">TextField（输入框）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TextFieldDemo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    OutlinedTextField(
        value = text,
        onValueChange = { text = it },
        label = { Text(<span class="hljs-string">"用户名"</span>) },
        placeholder = { Text(<span class="hljs-string">"请输入用户名"</span>) },
        leadingIcon = {
            Icon(Icons.Default.Person, contentDescription = <span class="hljs-literal">null</span>)
        },
        modifier = Modifier.fillMaxWidth()
    )
}
</code></pre>
<h3 data-id="heading-24">4.3 基础布局</h3>
<h4 data-id="heading-25">Column（垂直排列）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ColumnDemo</span><span class="hljs-params">()</span></span> {
    Column(
        modifier = Modifier.fillMaxSize(),
        verticalArrangement = Arrangement.Center,  <span class="hljs-comment">// 垂直居中</span>
        horizontalAlignment = Alignment.CenterHorizontally  <span class="hljs-comment">// 水平居中</span>
    ) {
        Text(<span class="hljs-string">"第一行"</span>)
        Text(<span class="hljs-string">"第二行"</span>)
        Text(<span class="hljs-string">"第三行"</span>)
    }
}
</code></pre>
<h4 data-id="heading-26">Row（水平排列）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RowDemo</span><span class="hljs-params">()</span></span> {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceEvenly,  <span class="hljs-comment">// 均匀分布</span>
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(<span class="hljs-string">"左侧"</span>)
        Text(<span class="hljs-string">"中间"</span>)
        Text(<span class="hljs-string">"右侧"</span>)
    }
}
</code></pre>
<h4 data-id="heading-27">Box（层叠布局）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BoxDemo</span><span class="hljs-params">()</span></span> {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        <span class="hljs-comment">// 底层</span>
        CircularProgressIndicator()
        
        <span class="hljs-comment">// 上层</span>
        Text(<span class="hljs-string">"加载中..."</span>)
    }
}
</code></pre>
<h3 data-id="heading-28">4.4 完整示例：登录界面</h3>
<p>让我们用学到的组件组合一个简单的登录界面：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> username <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    <span class="hljs-keyword">var</span> password <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(<span class="hljs-number">24.</span>dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        <span class="hljs-comment">// 标题</span>
        Text(
            text = <span class="hljs-string">"欢迎登录"</span>,
            style = MaterialTheme.typography.headlineLarge,
            modifier = Modifier.padding(bottom = <span class="hljs-number">32.</span>dp)
        )
        
        <span class="hljs-comment">// 用户名输入</span>
        OutlinedTextField(
            value = username,
            onValueChange = { username = it },
            label = { Text(<span class="hljs-string">"用户名"</span>) },
            leadingIcon = {
                Icon(Icons.Default.Person, contentDescription = <span class="hljs-literal">null</span>)
            },
            modifier = Modifier.fillMaxWidth()
        )
        
        Spacer(modifier = Modifier.height(<span class="hljs-number">16.</span>dp))
        
        <span class="hljs-comment">// 密码输入</span>
        OutlinedTextField(
            value = password,
            onValueChange = { password = it },
            label = { Text(<span class="hljs-string">"密码"</span>) },
            leadingIcon = {
                Icon(Icons.Default.Lock, contentDescription = <span class="hljs-literal">null</span>)
            },
            visualTransformation = PasswordVisualTransformation(),
            modifier = Modifier.fillMaxWidth()
        )
        
        Spacer(modifier = Modifier.height(<span class="hljs-number">24.</span>dp))
        
        <span class="hljs-comment">// 登录按钮</span>
        Button(
            onClick = { <span class="hljs-comment">/* 登录逻辑 */</span> },
            modifier = Modifier.fillMaxWidth()
        ) {
            Text(<span class="hljs-string">"登录"</span>)
        }
        
        Spacer(modifier = Modifier.height(<span class="hljs-number">16.</span>dp))
        
        <span class="hljs-comment">// 注册链接</span>
        TextButton(onClick = { }) {
            Text(<span class="hljs-string">"还没有账号？立即注册"</span>)
        }
    }
}

<span class="hljs-meta">@Preview(showBackground = true)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginScreenPreview</span><span class="hljs-params">()</span></span> {
    MaterialTheme {
        LoginScreen()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-29">五、本篇小结</h2>
<p>今天我们完成了 Compose 的入门学习：</p>
<ol>
<li><strong>了解了 Compose 是什么</strong> - 现代声明式 UI 工具包，代码简洁、开发高效</li>
<li><strong>完成了环境搭建</strong> - 创建项目、配置依赖、运行第一个应用</li>
<li><strong>学习了 Composable 基础</strong> - 函数定义、参数传递、Modifier 使用、预览注解</li>
<li><strong>初探 Material Design 3 组件</strong> - Text、Button、Card、TextField 等常用组件，以及 Column、Row、Box 基础布局</li>
</ol>
<hr/>
<h2 data-id="heading-30">下篇预告</h2>
<p><strong>第二篇：核心基石</strong> 将深入讲解：</p>
<ul>
<li>Modifier 修饰符全解析</li>
<li>Column、Row、Box 布局详解</li>
<li>LazyColumn 与列表性能优化</li>
<li>ConstraintLayout in Compose</li>
</ul>
<p>敬请期待！</p>
<hr/>
<h2 data-id="heading-31">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose" target="_blank" title="https://developer.android.com/jetpack/compose" ref="nofollow noopener noreferrer">Jetpack Compose 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fm3.material.io%2Fcomponents" target="_blank" title="https://m3.material.io/components" ref="nofollow noopener noreferrer">Material Design 3 组件库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcompose-samples" target="_blank" title="https://github.com/android/compose-samples" ref="nofollow noopener noreferrer">Compose 示例代码</a></li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>系列文章导航</strong></p>
<ul>
<li>第一篇：初识 Compose（当前）✅</li>
<li>第二篇：核心基石</li>
<li>第三篇：状态管理</li>
<li>第四篇：Material 组件与主题</li>
<li>第五篇：动画与交互</li>
<li>第六篇：架构与工程化</li>
<li>第七篇：高级特性与实战</li>
</ul>
</blockquote>
<hr/>
<p>如果这篇文章对你有帮助，欢迎 <strong>点赞</strong>、<strong>收藏</strong>、<strong>关注</strong>！有任何问题可以在评论区留言，我会及时回复。</p>
<p><del>Generated by Kimi K2.5 Agent</del></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[（新手推荐）教你如何安装和使用 Clawdbot 的保姆级教程，另外 Clawdbot 已被迫改名为 Moltbot]]></title>    <link>https://juejin.cn/post/7600240045366411318</link>    <guid>https://juejin.cn/post/7600240045366411318</guid>    <pubDate>2026-01-28T11:35:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600240045366411318" data-draft-id="7600240045366394934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="（新手推荐）教你如何安装和使用 Clawdbot 的保姆级教程，另外 Clawdbot 已被迫改名为 Moltbot"/> <meta itemprop="keywords" content="程序员,人工智能,开源"/> <meta itemprop="datePublished" content="2026-01-28T11:35:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摆烂工程师"/> <meta itemprop="url" content="https://juejin.cn/user/1552933235470589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            （新手推荐）教你如何安装和使用 Clawdbot 的保姆级教程，另外 Clawdbot 已被迫改名为 Moltbot
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1552933235470589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摆烂工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:35:39.000Z" title="Wed Jan 28 2026 11:35:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近几天相信大家都被 <strong>Clawdbot</strong> 疯狂的刷屏了，跟去年的 <strong>Manus</strong> 发布时差不多一样，在互联网上爆发式的展开。</p>
<p>原先是小龙虾，现在的 Logo 是脱了壳的小龙虾，已命名为：<strong>Moltbot</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d0bfe9a8a564a59b43f1853bfc4da66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=Ql3%2FdtDavHHy6qmkLkKsFl2nLwU%3D" alt="" loading="lazy"/></p>
<p>这是因为 Clawd 的读音跟 Claude 商标冲突，被 Anthropic 给告了，被迫改为 <strong>Moltbot</strong> 。</p>
<p>Anthropic 认为 Clawdbot 这个名字太容易被市场误解为 Claude Code的衍生产品，所以 Clawdbot 已改名为 Moltbot。</p>
<blockquote>
<p>Moltbot 取自龙虾的脱壳行为，符合原本的龙虾元素，并且规避了 Claude 的商标问题。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2839fdcbb72b4629b880547da12d5c5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=VurR58pCHiA3IoiiO5dnwtEd%2FBk%3D" alt="" loading="lazy"/></p>
<p><strong>什么是 Clawdbot 呢？</strong></p>
<p>Clawdbot 是一个 AI 助手，可以部署在本地电脑上或者服务器，可以理解为是一个拥有系统超级权限（root）的 Agent。</p>
<p>如果你用过 Claude Code， 就可以把它理解为拥有各种 skills 以及可以调用各种 MCP 服务协助完成任务的闭环。</p>
<p>可以让它帮你整理邮件、管理日程、炒股、写推文、读PPT等，在后台24小时运行，但这是非常耗 Token。</p>
<p><strong>因为 Clawdbot 拥有的权限比较高，一不小心可能会把电脑系统的东西删除了就麻烦啦！！！</strong></p>
<blockquote>
<p>另外 Clawdbot 的安全性堪忧，直接部署和一些线上服务联合在一起，你的 Clawdbot 大部分网关可是暴露在公网上的，没有任何身份验证，就可以拥有完整的 Shell 访问权限。 小心黑客直接偷家了哦</p>
</blockquote>
<p>需要尝试的伙伴，建议在虚拟机上部署，或者在一台不怎么用的 Mac 电脑也行。</p>
<h2 data-id="heading-0">如何安装使用 Clawdbot</h2>
<p>电脑系统需要的<strong>环境要求：</strong></p>
<ul>
<li>Node.js 版本 &gt;= 22 以上。</li>
<li>Git</li>
</ul>
<p><strong>Windows 电脑用户建议优先选择 WSL2 （推荐 Ubuntu 系统）</strong>，Mac 电脑用户直接开箱即用。</p>
<p>安装 Clawdbot 相对比较简单，只需要用到一条 shell 命令就行。</p>
<ul>
<li>macOS / Linux / Ubuntu / Debian安装使用下面命令**（推荐）**：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">curl -fsSL https://molt.bot/install.sh | bash
</code></pre>
<ul>
<li>Windows (PowerShell) 安装使用下面命令**（推荐）**：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">iwr -useb https://molt.bot/install.ps1 | iex
</code></pre>
<ul>
<li>如果你需要用最新 beta 版本，可以用最新的指令：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">curl -fsSL https://molt.bot/install.sh | bash -s -- --beta
</code></pre>
<p>当然了，可以使用 Npm 包管理进行安装，你安装了 Node.js 环境之后，都有 Npm 工具的。</p>
<p>不管是 Mac / Linux / Ubuntu / Windows 都可以直接用 Npm 工具进行管理版本和安装：</p>
<ul>
<li>支持所有系统，全局安装的指令（对npm不熟悉的，不要使用这种方式安装）：</li>
</ul>
<p>因为 npm 是官方刚发布的，可能运行有点问题，建议还是使用上面的其他指令安装。 这边知道一下就行哈。</p>
<pre><code class="hljs language-shell" lang="shell">npm i -g moltbot@latest
</code></pre>
<p>npm 安装后，如果执行 moltbot 找不到指令的话，可以改为 clawdbot 指令。</p>
<blockquote>
<p>上面的指令，使用其中一条就行，按照自己的系统使用对应的指令。</p>
</blockquote>
<h2 data-id="heading-1">当前是 Mac 苹果电脑进行安装</h2>
<p>目前我是 Node.js 22.15 版本，执行指令后，等待一段时间，会进行克隆 Github 上的仓库。</p>
<p><code>curl -fsSL https://molt.bot/install.sh | bash</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1e8fdb9cc2c43879ff01bba523b9c6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=WMJSYQVEyvMZB6WaVWhGmZUdCyE%3D" alt="" loading="lazy"/></p>
<p>当你安装成功之后，会问你是否知道 Clawdbot 的风险很高，选择 yes 之后，就可以继续。</p>
<p>如果你选择 no，那么就会直接退出安装向导。</p>
<p>这边选择 <strong>QuickStart</strong> 模式，可以默认使用 Clawdbot 的配置。</p>
<p>这是分配的默认端口：18789， <strong>然后 Clawdbot 是支持 ChatGPT 和 Claude 的 OAuth 授权登录方式。</strong></p>
<p>也就是你可以不需要去购买API，使用会员的 Codex 或者 Claude Code。</p>
<blockquote>
<p>但是，这里建议别用 Claude 授权登录，因为 Claude 是小气鬼，会阻止你使用非 Claude Code 的服务去调用 Claude。 如果你非要用 Claude 的话，但是没有 Claude 账号，可以在这里申请一个：chatshare.cc</p>
</blockquote>
<p>因为我平时的主力是 Codex，所以我选择 OpenAI, 使用 Codex 的 OAuth 就行，<strong>另外你只要是 GPT 会员（Plus、Business、Pro）就可以用这个方式。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4490e61ad95407c9a125678b42b8346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=WaquS0Hr%2FJDQmmHqLnUk8kjIdnE%3D" alt="" loading="lazy"/></p>
<p>虽然我本地有 Codex CLI，为了方便大家了解 ChatGPT 授权登录的方式，这边我先选择第 2 种。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43675a47b5004b6c8dbef9d60caf3745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=7mteplvYFCnbdB3RWWm%2B39U8zYA%3D" alt="" loading="lazy"/></p>
<p>会给你一条 ChatGPT 授权登录的链接，正常你的电脑会自动弹起浏览器，你只需要选择对应的会员进行登录即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0678374324a94ef6a1dcf1e6b0f6f43e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=9gGVRHn2WWsGXfJHr%2BnH2%2BB9AtU%3D" alt="" loading="lazy"/></p>
<p>这边我是开通了 ChatGPT Businss 会员 和 Plus 会员，不过平时我会优先消耗 Business 会员的 额度，这里我就选择 Business 会员。</p>
<p><strong>因为 ChatGPT Business 会员比较便宜，目前有优惠活动价，几十块钱就可以用跟 Plus 会员一样的 Codex 额度。</strong></p>
<p><strong>高性价比体验 Clawdbot 的方式：</strong></p>
<blockquote>
<p><strong>ChatGPT Business 优惠开通的地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fupchatgpt.com" target="_blank" title="https://upchatgpt.com" ref="nofollow noopener noreferrer">upchatgpt.com</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0824fc26cda544bbb36d2a55c4a76c16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=gtNaiOfZAXdZXp1OPSySFGHrmjM%3D" alt="" loading="lazy"/></p>
<p>点击继续后，就会进行回调，告诉你授权成功后，你就可以回到终端查看安装状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7dbb5a91f0f4292922de728f4d74ff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=SnIA8C08XWZ6zh8swqkcgmP2FXY%3D" alt="" loading="lazy"/></p>
<p>PS：<strong>如果你的终端没有自动回调获取到 Code 的话，你就把当前这条回调地址，localhost 开头的，全部复制，粘贴到终端就成功登录啦</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb84ce3d4da48e6bdf326f2cbfedf92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=%2FY4MUkwa4i0yF9dY8oU9YUEy1Go%3D" alt="" loading="lazy"/></p>
<p>我选择了默认 GPT-5.2-Codex 模型，然后就会进入选择频道，我是测试了 TG 的机器人，这里教程的话，我就先跳过啦。</p>
<p>你可以跳过，后续再选择，或者配置其他的频道。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d543e1bf06204d12b7dedc983b14b8ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=LW0%2BQhscCyqYi6VFkZD0%2Fo6p%2FvI%3D" alt="" loading="lazy"/></p>
<p>接下来就是配置 <strong>skills</strong>，是的，这个 skills 就是你平时听到的那个 skills。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78101277044e495fad74c71229b7fe69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=SdFTTDb3z4rRkrLFwMeJKpeAbvs%3D" alt="" loading="lazy"/></p>
<p>接着就是包管理工具，这里选择平时自己喜欢的就行，默认用的 npm 就行。</p>
<p>后面就会给你一些 Skills，你可以按需选择，或者先跳过也可以。 后续都可以安装的，直接跟 Clawdbot 说安装对应的 skills 就行。</p>
<p>无需手动哦，只需对话。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514d371d47234936adb2a0f2faebf961~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=c7EdvsnhV428UfUHmLhsFQWS174%3D" alt="" loading="lazy"/></p>
<p>后续出现一些 API KEY 的设置，如果你没有，直接回车：No 就行。 这里是一些图片生成之类的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21d63748cf3c44e68217e78254c1386e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=SevMG2GO%2FoO9M3yWG1JEqib9YtI%3D" alt="" loading="lazy"/></p>
<p>最后，问你需不需要开启钩子，这三个都是 <strong>Moltbot 的内置 hooks（钩子脚本）</strong>，用来在特定事件发生时自动做事：</p>
<ul>
<li>boot-md：网关（gateway）启动后自动读取并执行工作区里的 BOOT.md 里的引导/启动指令。</li>
<li>command-logger：把所有命令事件记录到本地审计日志文件（默认 ~/.clawdbot/logs/commands.log）</li>
<li>session-memory：当你发出 /new 时，把当前会话上下文保存成一份“记忆快照”到工作区（默认 ~/clawd/memory/ 相关路径）。</li>
</ul>
<p>建议直接三个都钩上开启。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7eb6b2317ae496a8a56a80d39040cca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=Vz%2FxXPCYujTmweTKnzVaZzKLiIY%3D" alt="" loading="lazy"/></p>
<p>接下来会问你用什么方式开启使用你的 AI 助手。对于新手的话，<strong>建议选择 web ui</strong> ，就是有页面可以操作，不需要输入各种指令进行操作。</p>
<p>配置基本都完成啦，现在可以运行你的 Clawdbot 。</p>
<p>可以执行下面指令，就会自动打开 web ui 控制页面啦：</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot dashboard
</code></pre>
<p>默认本地服务运行的端口和地址：<code>http://127.0.0.1:18789</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db3222e815f24cd5ba25a8b50d41220a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=Y6n8T6EesiVXeSJxmu2XKmddN60%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>提示：虽然 Clawdbot 改名为 Moltbot，但是目前的工具的指令还没有更新为 moltbot，所以你用官方的指令可能无法确认自己是否成功安装！ 那么，你可以直接把 moltbot 相关 改为 clawdbot 去运行指令，就可以啦！</p>
</blockquote>
<h2 data-id="heading-2">一些常用的 Clawdbot 指令说明</h2>
<ul>
<li>快速诊断当前 clawdbot 的状态（含模型提供商用量/配额等信息）</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot status
</code></pre>
<ul>
<li>打开 clawdbot 浏览器 Web UI（最快开始聊天/看状态）的管理页面：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot dashboard
</code></pre>
<ul>
<li>查看频道配置、探测频道健康、看频道日志。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot channels list|status|logs
</code></pre>
<ul>
<li>直接在终端里开 TUI 聊天（没浏览器/远程机很爽）。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot tui
</code></pre>
<ul>
<li>重新跑配置向导（改模型/频道/技能时很好用）</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot configure
</code></pre>
<ul>
<li>管理网关（ <strong>Clawdbot 服务</strong> ） 服务的状态/安装/停/重启。</li>
</ul>
<p>如果要关闭你现在在运行的 clawdbot，直接用 <code>clawdbot gateway stop</code> 就可以啦～</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot gateway status|install|stop|restart
</code></pre>
<p>现在你可以去体验 Clawdbot 啦！当然，如果你不使用 Codex、Claude 这些服务运行 Clawdbot 的话，也可以配置第三方 API 和 KEY，就是可以用国内模型运行 Clawdbot。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（69）Hibernate与JPA的关系]]></title>    <link>https://juejin.cn/post/7600229327436382258</link>    <guid>https://juejin.cn/post/7600229327436382258</guid>    <pubDate>2026-01-28T11:42:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600229327436382258" data-draft-id="7600068892989079562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（69）Hibernate与JPA的关系"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T11:42:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（69）Hibernate与JPA的关系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:42:44.000Z" title="Wed Jan 28 2026 11:42:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hibernate和JPA（Java Persistence API）密切相关，Hibernate是JPA的一种实现。JPA是一种Java EE规范，定义了一组用于对象关系映射（ORM）的标准接口，而Hibernate是一个流行的ORM框架，它实现了JPA规范并扩展了其功能。</p>
<p>以下是详细解释它们关系的步骤：</p>
<h3 data-id="heading-0">1. JPA概述</h3>
<p>JPA是一种Java EE规范，Java EE 5引入了它，用于简化开发持久化层。JPA定义了一组标准接口，使开发人员可以使用不同的持久化提供程序而不需要改变应用程序代码。JPA提供了以下功能：</p>
<ul>
<li>实体（Entity）类：持久化的Java对象。</li>
<li>实体管理器（EntityManager）：用于管理实体的生命周期。</li>
<li>查询语言（JPQL）：一种面向对象的查询语言。</li>
</ul>
<h3 data-id="heading-1">2. Hibernate概述</h3>
<p>Hibernate是一个广泛使用的ORM框架，它实现了JPA规范并增加了许多额外的功能。Hibernate允许开发人员通过使用持久化类和映射来与数据库进行交互。</p>
<h3 data-id="heading-2">3. JPA与Hibernate的关系</h3>
<ul>
<li><strong>JPA是规范，Hibernate是实现</strong>：JPA定义了一组接口和规则，而Hibernate是一个具体的实现。</li>
<li><strong>标准化和灵活性</strong>：通过使用JPA接口，开发人员可以轻松地更换持久化提供程序，而不需要改变业务逻辑代码。Hibernate作为JPA的实现，提供了标准化的接口和额外的功能。</li>
</ul>
<h3 data-id="heading-3">4. 代码示例</h3>
<p>以下是一个使用JPA和Hibernate的完整代码示例，展示了如何配置和使用它们。</p>
<h4 data-id="heading-4">4.1. 项目依赖</h4>
<p>使用Maven进行依赖管理，在<code>pom.xml</code>中添加JPA和Hibernate的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- JPA API --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.persistence<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.persistence-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Hibernate JPA Implementation --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.32.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Data JPA if using Spring Boot --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">4.2. 配置数据源</h4>
<p>在<code>application.properties</code>中配置数据源和JPA属性：</p>
<pre><code class="hljs language-properties" lang="properties">spring.datasource.url=jdbc:mysql://localhost:3306/mydatabase
spring.datasource.username=root
spring.datasource.password=rootpassword
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
</code></pre>
<h4 data-id="heading-6">4.3. 定义实体类</h4>
<p>定义一个简单的实体类，例如<code>User</code>：</p>
<h5 data-id="heading-7"><code>User.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }
}
</code></pre>
<h4 data-id="heading-8">4.4. 创建DAO层</h4>
<p>创建一个数据访问对象（DAO）接口，用于访问数据库。如果使用Spring Data JPA，可以简化为一个接口。</p>
<h5 data-id="heading-9"><code>UserRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
    User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span>;
}
</code></pre>
<h4 data-id="heading-10">4.5. 创建服务层</h4>
<p>创建一个服务类，用于处理业务逻辑。</p>
<h5 data-id="heading-11"><code>UserService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userRepository.findAll();
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userRepository.deleteById(id);
    }
}
</code></pre>
<h4 data-id="heading-12">4.6. 编写控制器</h4>
<p>利用上述服务类来编写RESTful API控制器。</p>
<h5 data-id="heading-13"><code>UserController.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">(UserService userService)</span> {
        <span class="hljs-built_in">this</span>.userService = userService;
    }

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">createdUser</span> <span class="hljs-operator">=</span> userService.createUser(user);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdUser);
    }

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getUserById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
    }

    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;User&gt;&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        List&lt;User&gt; users = userService.getAllUsers();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(users);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@RequestBody</span> User user)</span> {
        user.setId(id); <span class="hljs-comment">// Ensure the user ID is set correctly</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">updatedUser</span> <span class="hljs-operator">=</span> userService.updateUser(user);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedUser);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        userService.deleteUser(id);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</code></pre>
<h3 data-id="heading-14">5. 运行应用</h3>
<ol>
<li><strong>启动MySQL数据库</strong>：确保你的MySQL数据库运行在<code>localhost:3306</code>，并且已创建了名为<code>mydatabase</code>的数据库。</li>
<li><strong>启动Spring Boot应用</strong>：运行Spring Boot应用程序。</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run
</code></pre>
<h3 data-id="heading-15">6. 访问API</h3>
<p>通过以下API访问用户数据：</p>
<ul>
<li><code>POST /users</code>：创建用户。</li>
<li><code>GET /users/{id}</code>：按ID获取用户。</li>
<li><code>GET /users</code>：获取所有用户。</li>
<li><code>PUT /users/{id}</code>：更新用户。</li>
<li><code>DELETE /users/{id}</code>：删除用户。</li>
</ul>
<h3 data-id="heading-16">总结</h3>
<p>通过上述步骤，我们展示了如何使用Hibernate和JPA，从配置项目依赖、设置数据源、定义实体类、创建DAO层和服务层，并编写RESTful API控制器。此外，我们解释了Hibernate和JPA的关系，JPA作为规范提供了接口和规则，而Hibernate作为实现提供了实际的ORM功能。这样，应用程序可以利用Hibernate实现JPA规范，进行高效的数据库操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（70）如何在多数据库环境中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600234310965198886</link>    <guid>https://juejin.cn/post/7600234310965198886</guid>    <pubDate>2026-01-28T11:43:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310965198886" data-draft-id="7600245693997137930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（70）如何在多数据库环境中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T11:43:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（70）如何在多数据库环境中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:43:43.000Z" title="Wed Jan 28 2026 11:43:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在多数据库环境中使用Hibernate，需要配置多个数据源（DataSource）和多个实体管理器（EntityManager）。通常情况下，你可能需要在Spring Boot项目中使用Hibernate来连接多个数据库。下面是详细步骤和代码示例，展示如何在Spring Boot项目中配置和使用多个数据库。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置多个数据源</h3>
<p>需要在<code>application.properties</code>或<code>application.yml</code>文件中配置多个数据源。</p>
<h4 data-id="heading-2"><code>application.properties</code></h4>
<pre><code class="hljs language-properties" lang="properties"># Primary DataSource
spring.datasource.primary.url=jdbc:mysql://localhost:3306/primarydb
spring.datasource.primary.username=root
spring.datasource.primary.password=rootpassword
spring.datasource.primary.driver-class-name=com.mysql.cj.jdbc.Driver

# Secondary DataSource
spring.datasource.secondary.url=jdbc:mysql://localhost:3306/secondarydb
spring.datasource.secondary.username=root
spring.datasource.secondary.password=rootpassword
spring.datasource.secondary.driver-class-name=com.mysql.cj.jdbc.Driver

# Hibernate properties
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
</code></pre>
<h3 data-id="heading-3">3. 配置多数据源与实体管理器</h3>
<p>需要创建配置类来配置多个数据源与对应的实体管理器。</p>
<h4 data-id="heading-4"><code>PrimaryDataSourceConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
<span class="hljs-keyword">import</span> org.springframework.transaction.PlatformTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;

<span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;
<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-meta">@EnableJpaRepositories(
        basePackages = "com.example.primary",
        entityManagerFactoryRef = "primaryEntityManagerFactory",
        transactionManagerRef = "primaryTransactionManager"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrimaryDataSourceConfig</span> {

    <span class="hljs-meta">@Bean(name = "primaryDataSource")</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.primary")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">primaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DataSourceBuilder.create().build();
    }

    <span class="hljs-meta">@Bean(name = "primaryEntityManagerFactory")</span>
    <span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title function_">primaryEntityManagerFactory</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("primaryDataSource")</span> DataSource dataSource)</span> {
        <span class="hljs-type">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-variable">em</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalContainerEntityManagerFactoryBean</span>();
        em.setDataSource(dataSource);
        em.setPackagesToScan(<span class="hljs-string">"com.example.primary"</span>);
        em.setJpaVendorAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateJpaVendorAdapter</span>());
        <span class="hljs-keyword">return</span> em;
    }

    <span class="hljs-meta">@Bean(name = "primaryTransactionManager")</span>
    <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">primaryTransactionManager</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("primaryEntityManagerFactory")</span> EntityManagerFactory entityManagerFactory)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h4 data-id="heading-5"><code>SecondaryDataSourceConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
<span class="hljs-keyword">import</span> org.springframework.transaction.PlatformTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;

<span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;
<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-meta">@EnableJpaRepositories(
        basePackages = "com.example.secondary",
        entityManagerFactoryRef = "secondaryEntityManagerFactory",
        transactionManagerRef = "secondaryTransactionManager"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondaryDataSourceConfig</span> {

    <span class="hljs-meta">@Bean(name = "secondaryDataSource")</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.secondary")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">secondaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DataSourceBuilder.create().build();
    }

    <span class="hljs-meta">@Bean(name = "secondaryEntityManagerFactory")</span>
    <span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title function_">secondaryEntityManagerFactory</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("secondaryDataSource")</span> DataSource dataSource)</span> {
        <span class="hljs-type">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-variable">em</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalContainerEntityManagerFactoryBean</span>();
        em.setDataSource(dataSource);
        em.setPackagesToScan(<span class="hljs-string">"com.example.secondary"</span>);
        em.setJpaVendorAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateJpaVendorAdapter</span>());
        <span class="hljs-keyword">return</span> em;
    }

    <span class="hljs-meta">@Bean(name = "secondaryTransactionManager")</span>
    <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">secondaryTransactionManager</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("secondaryEntityManagerFactory")</span> EntityManagerFactory entityManagerFactory)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h3 data-id="heading-6">4. 定义实体类和DAO层</h3>
<p>根据不同的数据源，将实体类和DAO层放在不同的包中。</p>
<h4 data-id="heading-7">主数据源实体类和DAO层</h4>
<h5 data-id="heading-8"><code>com.example.primary.entity.User.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.entity;

<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }
}
</code></pre>
<h5 data-id="heading-9"><code>com.example.primary.repository.UserRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.repository;

<span class="hljs-keyword">import</span> com.example.primary.entity.User;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
    User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span>;
}
</code></pre>
<h4 data-id="heading-10">次数据源实体类和DAO层</h4>
<h5 data-id="heading-11"><code>com.example.secondary.entity.Order.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.entity;

<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String orderNumber;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getOrderNumber</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderNumber;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOrderNumber</span><span class="hljs-params">(String orderNumber)</span> {
        <span class="hljs-built_in">this</span>.orderNumber = orderNumber;
    }
}
</code></pre>
<h5 data-id="heading-12"><code>com.example.secondary.repository.OrderRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.repository;

<span class="hljs-keyword">import</span> com.example.secondary.entity.Order;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Order, Long&gt; {
    Order <span class="hljs-title function_">findByOrderNumber</span><span class="hljs-params">(String orderNumber)</span>;
}
</code></pre>
<h3 data-id="heading-13">5. 创建服务层</h3>
<h4 data-id="heading-14">主数据源服务层</h4>
<h5 data-id="heading-15"><code>com.example.primary.service.UserService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.service;

<span class="hljs-keyword">import</span> com.example.primary.entity.User;
<span class="hljs-keyword">import</span> com.example.primary.repository.UserRepository;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userRepository.findAll();
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userRepository.deleteById(id);
    }
}
</code></pre>
<h4 data-id="heading-16">次数据源服务层</h4>
<h5 data-id="heading-17"><code>com.example.secondary.service.OrderService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.service;

<span class="hljs-keyword">import</span> com.example.secondary.entity.Order;
<span class="hljs-keyword">import</span> com.example.secondary.repository.OrderRepository;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderRepository orderRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(OrderRepository orderRepository)</span> {
        <span class="hljs-built_in">this</span>.orderRepository = orderRepository;
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> orderRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">getAllOrders</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderRepository.findAll();
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(Long id)</span> {
        orderRepository.deleteById(id);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kimi 开源新模型，不输 Gemini 3，太有眼力见了！]]></title>    <link>https://juejin.cn/post/7600216277426864162</link>    <guid>https://juejin.cn/post/7600216277426864162</guid>    <pubDate>2026-01-28T10:09:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600216277426864162" data-draft-id="7600265780349173800" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kimi 开源新模型，不输 Gemini 3，太有眼力见了！"/> <meta itemprop="keywords" content="前端,AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-28T10:09:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿杆"/> <meta itemprop="url" content="https://juejin.cn/user/4182956056773160"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kimi 开源新模型，不输 Gemini 3，太有眼力见了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4182956056773160/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿杆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:09:54.000Z" title="Wed Jan 28 2026 10:09:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就在昨天，Kimi 正式发布了 K2.5 版本。点开公告一看，好家伙，这是要 “掀桌子” 啊！</p>
<p>这次 Kimi 不仅把模型能力拉满了（Lookahead 推理、长上下文），还直接开源了 K2.5 模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a62ffddd77d49b08b764ef190ce6e3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=AeL41udDxlmOsTonNUhItVBS7G8%3D" alt="" loading="lazy"/></p>
<p>不过，数据好不代表用起来好，是骡子是马还得先拉出来溜溜。</p>
<p>这次更新最大的两个亮点：<strong>Visual Coding（视觉编程）</strong> 和 <strong>Agent 集群</strong>。简单说，就是 AI 不仅能看懂你的屏幕，还能分身成一支团队帮你干活。</p>
<p>刚好我有个 idea 想试试，做一个 <strong>赛博朋克风格的番茄钟</strong>。</p>
<p>为了验证 K2.5 的真实实力，我给它定了个小目标：我全程不碰代码，只靠动嘴和截图，看这玩意儿到底能不能真落地。</p>
<h2 data-id="heading-0">Agent 集群初体验</h2>
<p>在开始大项目之前，我先拿 Kimi 试了个开胃菜 。</p>
<p>以前我们用 AI，都是一问一答模式。但 Kimi K2.5 的 Agent 集群打破了这个限制，<strong>它可以瞬间拆解任务，同时调度多个 Agent 协同工作</strong>。</p>
<p>我发了一条指令试水：</p>
<blockquote>
<p>帮我批量调研过去 10 年最奇葩的“搞笑诺贝尔奖”（Ig Nobel Prize），生成一个 Markdown 表格，列出年份、奖项、获奖者和搞笑理由。</p>
</blockquote>
<p>整个过程大约持续了8分钟，我看到它分配了10个Agent，然后每个人分别去查一年的资料，最后刷刷刷给我列出了一个表格！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40b7ed39f0fc43c28efe816060fab457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=vkreW16EVOeG1tlGAW2w6MNmvXk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a30f21e5b9b6453ea8ddb4c19650aa18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=I9JWXTlB2NBooLU%2BL8zwbNWLdTw%3D" alt="" loading="lazy"/></p>
<p>以前这种活，我得自己搜完一个，再搜下一个，或者不停点 “继续生成”。</p>
<p>现在 Kimi 瞬间理解了批量意图，后台自动拆分任务去查资料，然后汇总给我。</p>
<p>这种高效率的爽感，让我对后面的项目充满了信心！</p>
<p>而且它的工作过程，让我看到，确实是一步步脚踏实地去做的，每一个 SubAgent 都真实的去做了调研，而不是随便找一个别人整理的不确定真实性的那种结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79b5b723128b45e0a9a879d622418d03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=6ATvcYxYxTMyKIBHZS0fjw0ZVZQ%3D" alt="" loading="lazy"/></p>
<p>这种能力，对于做产品或者做科研来说，都是相当有用的。</p>
<p><strong>那么接下来，要开始做我们的番茄钟了！</strong></p>
<h2 data-id="heading-1">第一步：调研</h2>
<p>要开发产品，绝不能拍脑袋。以前做竞品调研、查文献，少说得花一下午。现在？交给 Agent 集群。</p>
<p>我直接给它下了这个任务：</p>
<blockquote>
<p>帮我调研 50 篇关于“番茄工作法与专注力提升”的心理学论文或高引用文章，总结出最科学的专注时间、休息间隔，以及什么样的白噪音最能提升效率。</p>
</blockquote>
<p>在 Kimi 的任务管理器里，瞬间爆出了几个子任务，这就好比你手下多了几个实习生，每个人领了几篇论文去读。</p>
<p>看着后台刷刷刷全是它干活的记录，而我只能在一旁摸鱼，这种 <strong>一人成军</strong> 的感觉太棒了！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89c8ed865712406ba2b767360d8a446c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=7vW7%2FRz69Jgo2RGWyAoXlxQC1ww%3D" alt="" loading="lazy"/></p>
<p>几分钟后，一份深度报告出来了：</p>
<ul>
<li><strong>最佳节奏</strong>：25-30分钟专注+5分钟休息</li>
<li><strong>意外发现</strong>：<strong>粉红噪音/自然声音（45-55dB）</strong> 对提升专注力有显著效果</li>
</ul>
<p>而且还整理了很多的报告文档，以及它阅读了哪些论文，论文链接、摘要之类的都给整理出来了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcb2ca7714104d948c96c67442747db8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=nUv87Yizkt3PNyhE%2BE75TvLBuCk%3D" alt="" loading="lazy"/></p>
<p>（右侧是它整理的文档内容）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb009058544a4d9d8faa5e279a720ee9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=OEj5t%2BiDZAC%2BizKk4S2D%2BmAZbyw%3D" alt="" loading="lazy"/></p>
<p>这调研能力真的很强，普通人依靠它也完全可以做好一个初步的调研。</p>
<h2 data-id="heading-2">Visual Coding</h2>
<p>有了需求，接下来就是开发。</p>
<p>这次，我选择不碰代码，而是试试 K2.5 的新功能，<strong>Video-to-Code（视频生成代码）</strong> 。</p>
<h3 data-id="heading-3">视频复刻</h3>
<p>既然要做赛博朋克风，那种故障艺术（Glitch）的动效是灵魂。但这种效果很难用文字描述清楚，“滋滋啦啦的”、   “有点跳变”，AI 哪能听懂这个？</p>
<p>所以我直接去 CodePen 上找了一个 <strong>Glitch 文字效果的 Demo</strong>，录了段屏丢给了 Kimi：</p>
<blockquote>
<p>看这个视频里的文字效果。帮我做一个番茄钟网页：</p>
<ol>
<li>倒计时 25 分钟，支持开始、暂停、重置</li>
<li>倒计时数字要有这种故障抖动、颜色闪烁的效果</li>
<li>背景播放 45Hz 双耳节拍白噪音</li>
<li>整体风格要赛博朋克，霓虹配色</li>
</ol>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8c729010027465e8b9db4611e82453b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=Eo6DN5m%2Bvcq0%2B3k5yhdNSwh9U%2BQ%3D" alt="" loading="lazy"/></p>
<p>（这是我找的效果）</p>
<p>很快啊，大概3分钟就做完了，结果让我有些惊讶。</p>
<p>仅仅凭借视觉信息，Kimi 就复刻出了几乎一模一样的 CSS 关键帧动画。倒计时数字开始随机抖动、变色，还原度相当高，非常有赛博朋克的感觉。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f533ea413d64fd58792ffce47172ab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=UPmFXNqmjyNOEPGdv%2FSRGHV%2F6U0%3D" alt="" loading="lazy"/></p>
<p>然后我又尝试了不同风格的番茄钟，科技风、毛玻璃风……我发现这种简单页面对它来说简直小儿科。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/521b7f3e94fa4ec9ace88a8d83a91fbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=6vNWpCLreqDP5zt%2BrNBII7bPR8Y%3D" alt="" loading="lazy"/></p>
<p>既然这样，我决定给它上点难度，整点复杂度更高的东西试试。</p>
<h3 data-id="heading-4">复刻高端动效</h3>
<p>我找了一个觉得不错的交互效果，录了一段它的 Tab 切换动效，那种有层次的物理感交互。</p>
<p>然后<strong>我直接把视频丢给了 K2.5</strong>，让它参照视频给我复刻一个一样的。</p>
<p>结果 Kimi 不仅复刻了布局和画风，还捕捉到了很多细节：</p>
<ul>
<li>半透明毛玻璃卡片边框</li>
<li>三张卡片以不同的节奏上下浮动</li>
<li><strong>卡片内部元素的延迟加载和弹跳动画</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/077c36e966cb4539ae12902557b03af5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=TvhPkUPPZRXyXPTKTYOnFXlE0YM%3D" alt="" loading="lazy"/></p>
<p>整体都还原得相当到位👍🏻。</p>
<h3 data-id="heading-5">完整 Landing Page</h3>
<p>既然单个组件没问题，那整页呢？我又找了一个设计感很强的 Landing Page，这次我直接把网站URL丢给了它，让它帮我复刻。</p>
<p>它首先打开并且查看了网站的内容，分析网站的设计风格，然后生成需要的素材图片，最后开始复刻网站。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22e568d93df04e219134e109e999c218~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=TBysWlGWKHdlrJETThg5C%2Fy%2FUu4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/645f107324a645688d1f8cf2e85a7af7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=Bbpqx2dsfqxBwGsHbS4BAFyBtbY%3D" alt="" loading="lazy"/></p>
<p>大概花了 10 分钟，生成了一个完整的 Landing Page。虽然细节上还需要微调，但整体框架和动效已经有模有样了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3638b200ce54763a8b04c99f668d168~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=UcvmC6um6VaBnAQ8WE9MYGjnC9I%3D" alt="" loading="lazy"/></p>
<p>这让我想到，以前做一个这样的页面，光是切图加写样式就得半天。现在？录个屏或者丢个链接，剩下的交给 Kimi。</p>
<h2 data-id="heading-6">Visual Edit：哪里不爽圈哪里</h2>
<p>不管是番茄钟还是 Landing Page，生成的初版总会有些小瑕疵。</p>
<p>换做以前，改这种细节是比较麻烦的。我得去 F12 里找到对应元素，然后跟 AI 描述“把第三个 div 的 margin-top 改成 20px”之类的。</p>
<p>现在？Kimi 支持 <strong>Visual Edit（视觉调整）</strong> 。直接在预览界面用鼠标圈选不满意的地方，然后让它改就行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b8bd564c6e4445c85b989695d4c065b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=cS5Q%2ByjNo80Z40pRM5Yr4eceTEo%3D" alt="" loading="lazy"/></p>
<p>Kimi 精准定位代码，很快就能修改完成。这种"圈哪里改哪里"的交互方式，用起来确实很爽。</p>
<p>而且代码可以直接下载，或者一键部署到 Kimi 的托管服务上。</p>
<h2 data-id="heading-7">尾声</h2>
<p>捣鼓了一上午，我用 Kimi K2.5 做出了赛博朋克番茄钟，还顺手复刻了几个高端网页动效。</p>
<p>整个过程，我连一行代码都没碰，只充当了产品经理和审美把关人的角色：</p>
<ul>
<li><strong>调研</strong>：交给 Agent 集群，50 篇论文分钟级消化</li>
<li><strong>开发</strong>：交给 Visual Coding，看视频直接生成代码</li>
<li><strong>调整</strong>：交给 Visual Edit，圈选即改</li>
</ul>
<p>除了这些，你还可以让它帮你批量生成图片，比如请 10 个风格截然不同的知名艺术家，每人为我设计一张马年主题微信表情包。也可以给它一张风景图让它识别地点，甚至丢一道行测图形推理题让它帮你分析。</p>
<p>整体体验下来，Kimi K2.5 这次的升级确实有看点：<strong>Agent 集群的并发效率、Visual Coding 的所见即所得、还有开源模型带来的想象空间</strong>。</p>
<p>尤其是 Visual Edit，对于开发者来说简直是福音。以前改个样式要翻代码半天，现在圈一下说句话就搞定。</p>
<p>当然，K2.5 的全部能力还需要更多场景来验证。比如生成的代码在复杂项目里能不能直接用、长期维护性如何，这些都有待观察。但作为一个快速验证想法、做 Demo 的工具，它已经相当能打了。</p>
<blockquote>
<p><strong>参考链接</strong></p>
<p>K2.5 开源模型：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmoonshotai%2FKimi-K2.5" target="_blank" title="https://huggingface.co/moonshotai/Kimi-K2.5" ref="nofollow noopener noreferrer">huggingface.co/moonshotai/…</a></p>
<p>K2.5 发布公告：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2Fblog%2Fkimi-k2-5.html" target="_blank" title="https://www.kimi.com/blog/kimi-k2-5.html" ref="nofollow noopener noreferrer">www.kimi.com/blog/kimi-k…</a></p>
<p>Kimi 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2F" target="_blank" title="https://www.kimi.com/" ref="nofollow noopener noreferrer">www.kimi.com/</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Fiber 架构全方位梳理]]></title>    <link>https://juejin.cn/post/7600219080045756459</link>    <guid>https://juejin.cn/post/7600219080045756459</guid>    <pubDate>2026-01-28T10:00:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600219080045756459" data-draft-id="7599970244787879999" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Fiber 架构全方位梳理"/> <meta itemprop="keywords" content="前端,React.js,前端框架"/> <meta itemprop="datePublished" content="2026-01-28T10:00:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sophie旭"/> <meta itemprop="url" content="https://juejin.cn/user/2559318799692952"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Fiber 架构全方位梳理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2559318799692952/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sophie旭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:00:41.000Z" title="Wed Jan 28 2026 10:00:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读43分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>作为 react 高频考点，React Fiber反复出现，为啥会成为高频考点，我觉得，很大程度上是因为 React Fiber架构真的解决了问题，并且巧妙的思想或许在未来可以给我们一些性能优化的启发，所以我们今天一起来走进 React Fiber，感受它的</p>
<h2 data-id="heading-1">一、先理解：为什么需要 Fiber 架构？</h2>
<p>React 15 及之前使用的是 <strong>Stack Reconciler（栈协调器）</strong>，它采用递归方式遍历虚拟 DOM 树，一旦开始渲染就无法中断。JS 线程是单线程的，如果渲染任务（比如复杂组件树的更新）耗时超过 16.6ms（浏览器 60fps 下每帧的时长），就会阻塞浏览器的渲染、布局、用户交互（如点击/输入），导致页面卡顿。</p>
<p>Fiber 架构的核心目标就是<strong>将同步的、不可中断的递归渲染，改成异步的、可中断的迭代渲染</strong>，彻底解决渲染阻塞问题。</p>
<h4 data-id="heading-2">一、先明确：Stack Reconciler 是什么？</h4>
<p>Stack Reconciler（栈协调器）是 React 15 及之前版本的核心渲染引擎，负责两大核心工作：</p>
<ol>
<li><strong>Reconciliation（协调）</strong>：对比新旧虚拟 DOM 树（Virtual DOM），找出需要更新的节点（即「差异（diff）」）；</li>
<li><strong>Commit（提交）</strong>：将找到的差异同步应用到真实 DOM 上。</li>
</ol>
<p>它的核心特征是：<strong>基于 JavaScript 调用栈的同步递归遍历</strong> —— 这也是「Stack（栈）」这个名字的由来（完全依赖 JS 函数调用栈完成遍历）。</p>
<h4 data-id="heading-3">二、Stack Reconciler 的递归执行流程</h4>
<p>虚拟 DOM 是树形结构，递归是最直观的遍历方式，但也埋下了「无法中断」的隐患。我们先通过一个简化的示例，还原它的执行逻辑：</p>
<h5 data-id="heading-4">1. 模拟 Stack Reconciler 的递归遍历代码</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟 React 15 的虚拟 DOM 节点</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tag, children = []</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag; <span class="hljs-comment">// 组件/标签名</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span> = children; <span class="hljs-comment">// 子节点</span>
  }
}

<span class="hljs-comment">// 模拟 Stack Reconciler 的核心递归遍历方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcile</span>(<span class="hljs-params">oldVNode, newVNode</span>) {
  <span class="hljs-comment">// 1. 对比当前节点：如果标签不同，直接标记为替换</span>
  <span class="hljs-keyword">if</span> (oldVNode.<span class="hljs-property">tag</span> !== newVNode.<span class="hljs-property">tag</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`标记替换节点: <span class="hljs-subst">${oldVNode.tag}</span> → <span class="hljs-subst">${newVNode.tag}</span>`</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 2. 递归遍历子节点（核心：深度优先递归）</span>
  <span class="hljs-keyword">const</span> oldChildren = oldVNode.<span class="hljs-property">children</span>;
  <span class="hljs-keyword">const</span> newChildren = newVNode.<span class="hljs-property">children</span>;
  <span class="hljs-keyword">const</span> maxLen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(oldChildren.<span class="hljs-property">length</span>, newChildren.<span class="hljs-property">length</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLen; i++) {
    <span class="hljs-keyword">const</span> oldChild = oldChildren[i];
    <span class="hljs-keyword">const</span> newChild = newChildren[i];
    
    <span class="hljs-comment">// 递归处理每个子节点 —— 每递归一次，就向 JS 调用栈压入一层</span>
    <span class="hljs-keyword">if</span> (oldChild &amp;&amp; newChild) {
      <span class="hljs-title function_">reconcile</span>(oldChild, newChild); <span class="hljs-comment">// 子节点存在，继续递归</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newChild) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`标记新增节点: <span class="hljs-subst">${newChild.tag}</span>`</span>); <span class="hljs-comment">// 新节点，标记新增</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldChild) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`标记删除节点: <span class="hljs-subst">${oldChild.tag}</span>`</span>); <span class="hljs-comment">// 旧节点，标记删除</span>
    }
  }
}

<span class="hljs-comment">// 模拟一个复杂的组件树（多层嵌套）</span>
<span class="hljs-keyword">const</span> oldTree = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'App'</span>, [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Header'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Logo'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Nav'</span>)]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Content'</span>, [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Article'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Title'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Text'</span>)]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Sidebar'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Menu'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Ad'</span>)])
  ]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Footer'</span>)
]);

<span class="hljs-keyword">const</span> newTree = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'App'</span>, [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Header'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Logo'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Nav'</span>)]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Content'</span>, [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Article'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Title'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Text'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Span'</span>)])]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Sidebar'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Menu'</span>)])
  ]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Footer'</span>)
]);

<span class="hljs-comment">// 触发渲染：一旦调用，必须执行完整个递归流程</span>
<span class="hljs-title function_">reconcile</span>(oldTree, newTree);
</code></pre>
<h5 data-id="heading-5">2. 递归执行的关键特点</h5>
<p>从代码中能看到，<code>reconcile</code> 函数的执行完全依赖 JS 调用栈：</p>
<ul>
<li>每递归处理一个子节点，就会向调用栈<strong>压入一层</strong> <code>reconcile</code> 函数；</li>
<li>只有当某个节点的所有子节点都处理完毕（递归返回），该层函数才会从调用栈<strong>弹出</strong>；</li>
<li><strong><code>整个遍历过程必须「一气呵成」—— 从根节点到最深层节点，再逐层返回，中间没有任何暂停的可能。</code></strong></li>
</ul>
<h4 data-id="heading-6">三、为什么递归遍历「无法中断」？</h4>
<p>核心原因是 <strong>JavaScript 单线程 + 调用栈的同步特性</strong>：</p>
<ol>
<li><strong>JS 单线程模型</strong>：浏览器中 JS 线程和渲染线程（布局、绘制）是互斥的 —— 只要 JS 线程在执行代码，渲染线程就会被阻塞；</li>
<li><strong>调用栈不可中断</strong>：<strong><code>JS 引擎的调用栈是「同步执行」的，一旦函数开始执行，必须等到函数体完全执行完毕、调用栈清空，才会释放主线程。</code></strong></li>
</ol>
<p>举个实际场景：如果你的组件树有 1000 个节点，<code>reconcile</code> 递归遍历需要 50ms 才能完成。这 50ms 内：</p>
<ul>
<li>JS 线程被完全占用，浏览器无法处理任何用户交互（点击、输入、滚动）；</li>
<li>渲染线程被阻塞，页面无法更新，用户会明显感觉到「卡顿」（60fps 下每帧只有 16.6ms，50ms 会丢失 3 帧）；</li>
<li>即使中途用户触发了更紧急的操作（比如点击按钮），也必须等这 50ms 的递归完成后才能响应 —— 因为调用栈没有「暂停」「插队」的机制。</li>
</ul>
<h4 data-id="heading-7">四、Stack Reconciler 的核心问题</h4>
<p>除了「无法中断」，递归遍历还带来两个关键问题：</p>
<ol>
<li><strong>无优先级调度</strong>：所有更新任务（比如用户输入的高优先级更新、数据请求的低优先级更新）都被同等对待，同步排队执行 —— 比如用户输入框打字（需要即时响应），却要等一个耗时的列表渲染完成，体验极差；</li>
<li><strong>调用栈溢出风险</strong>：如果组件树嵌套过深（比如 1000 层），递归遍历会导致调用栈层数过多，直接触发 <code>Maximum call stack size exceeded</code> 错误（栈溢出）。</li>
</ol>
<h4 data-id="heading-8">总结（核心关键点）</h4>
<ol>
<li>Stack Reconciler 依赖 <strong>JS 调用栈的同步递归</strong> 遍历虚拟 DOM 树，递归的特性决定了渲染过程「一旦开始就必须执行到底」；</li>
<li>无法中断的根源是 <strong>JS 单线程 + 调用栈不可中断</strong> —— 递归过程中主线程被完全占用，阻塞渲染和用户交互；</li>
<li>直接后果是 <strong>长任务导致页面卡顿</strong>，且无法区分任务优先级，无法优先响应用户交互等关键操作（这也是 Fiber 架构要解决的核心痛点）。</li>
</ol>
<p>简单来说，React 15 的 Stack Reconciler 就像「一口气跑完马拉松」，不管中途有没有突发情况，都不能停；而 Fiber 架构则是「分段跑马拉松」，跑一段歇一下，还能优先处理紧急的事（比如喝水、接电话），这也是两者最核心的区别。</p>
<h2 data-id="heading-9">二、核心原理拆解</h2>
<h3 data-id="heading-10">1. Fiber 解决渲染阻塞的核心逻辑</h3>
<p>Fiber 解决阻塞的核心是 <strong>“任务拆分 + 时间切片 + 优先级调度”</strong>，核心逻辑可总结为 3 点：</p>
<ul>
<li><strong>任务拆分</strong>：将原本一次性完成的“整棵组件树的渲染更新”拆成无数个小任务（每个小任务只处理一个 Fiber 节点）；</li>
<li><strong>时间切片（Time Slicing）</strong>：每次只执行一个小任务，且执行时长不超过浏览器预留的空闲时间，执行完就把控制权还给浏览器；</li>
<li><strong>中断与恢复</strong>：如果当前帧的空闲时间用完，就暂停渲染任务，记录当前执行到的 Fiber 节点，等浏览器下一次空闲时再从该节点继续执行。</li>
</ul>
<p>支撑这个逻辑的两个关键基础：</p>
<ul>
<li><strong>Fiber 数据结构</strong>：每个 Fiber 节点对应一个组件，除了保存组件的 props/state 外，还增加了 <code>return</code>（父节点）、<code>child</code>（子节点）、<code>sibling</code>（兄弟节点）等指针，形成链表结构——这是“中断后能恢复”的关键（递归栈无法记录中断点，链表可以）；</li>
<li><strong>Scheduler 调度器</strong>：React 自研的调度模块，负责给任务分配优先级、计算空闲时间、控制任务的执行/暂停。</li>
</ul>
<h4 data-id="heading-11">一、拆分的核心基础：Fiber 节点是「可独立处理的最小单元」</h4>
<p>要拆分任务，首先得有「可拆分的最小单元」—— Fiber 节点就是这个单元。
React 把每一个组件（无论是类组件、函数组件还是原生标签）都对应成一个 Fiber 节点，并且给每个节点设计了<strong>链表指针</strong>（<code>child</code>/<code>sibling</code>/<code>return</code>），替代了原来的递归树结构。</p>
<p>每个 Fiber 节点都包含了「处理该节点所需的全部信息」，比如：</p>
<ul>
<li>组件的 <code>props</code>/<code>state</code>；</li>
<li>对应的真实 DOM 节点；</li>
<li>要执行的操作（比如「更新」「新增」「删除」）；</li>
<li>链表指针（找到下一个要处理的节点）。</li>
</ul>
<p>这意味着：<strong>处理单个 Fiber 节点不需要依赖其他节点的执行结果</strong>，可以单独作为一个「小任务」来执行——这是任务能被拆分的核心前提。</p>
<h4 data-id="heading-12">二、任务拆分的核心逻辑：从「递归整树处理」→「迭代逐个节点处理」</h4>
<p>Stack Reconciler 是「一次性递归遍历整棵树」，而 Fiber 架构则是把「整树处理」拆成「处理单个节点」的小任务，通过<strong>迭代 + 链表遍历</strong>的方式逐个执行，具体拆分逻辑如下：</p>
<h5 data-id="heading-13">1. 拆分原则</h5>
<ul>
<li>大任务：整棵组件树的渲染更新（Reconciliation 阶段）；</li>
<li>小任务：处理<strong>一个 Fiber 节点</strong>（包括：对比新旧节点、标记副作用、确定下一个要处理的节点）；</li>
<li>拆分方式：按「深度优先 + 链表遍历」的顺序，把整树的处理拆成一个个独立的「单个节点处理任务」。</li>
</ul>
<h5 data-id="heading-14">2. 链表遍历的顺序（决定小任务的执行顺序）</h5>
<p>Fiber 链表的遍历遵循「深度优先」，但通过指针实现迭代（而非递归），顺序是：</p>
<ol>
<li>先处理当前节点（小任务 1）；</li>
<li>如果有子节点（<code>child</code>），下一个处理子节点（小任务 2）；</li>
<li>如果没有子节点，但有兄弟节点（<code>sibling</code>），下一个处理兄弟节点（小任务 3）；</li>
<li>如果既没有子节点也没有兄弟节点，回到父节点（<code>return</code>），再找父节点的兄弟节点（小任务 4）；</li>
<li>直到回到根节点，所有小任务执行完毕。</li>
</ol>
<p>这个过程就像「走迷宫」：先往深走（子节点），走到底就往旁边走（兄弟节点），旁边也走完就退回去（父节点），再往旁边走——每走一步，就是执行一个小任务。</p>
<h4 data-id="heading-15">三、代码模拟：直观看到任务是怎么拆分的</h4>
<p>下面用简化代码模拟 Fiber 的任务拆分和执行过程，你能清晰看到「整树任务」是如何被拆成「单个节点任务」的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 定义 Fiber 节点（最小任务单元）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FiberNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tag, props</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag; <span class="hljs-comment">// 组件/标签名（如 App、Div）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span> = props; <span class="hljs-comment">// 组件 props</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 第一个子节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 下一个兄弟节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">return</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 父节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">effectTag</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 要执行的操作（新增/更新/删除）</span>
  }
}

<span class="hljs-comment">// 2. 构建 Fiber 链表（模拟组件树）</span>
<span class="hljs-comment">// 结构：App → Header → Logo → Nav → Content → Article → Footer</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'App'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Header</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Header'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Logo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Logo'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Nav</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Nav'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Content</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Content'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Article</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Article'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Footer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Footer'</span>, {});

<span class="hljs-comment">// 设置链表指针（构建依赖关系）</span>
<span class="hljs-title class_">App</span>.<span class="hljs-property">child</span> = <span class="hljs-title class_">Header</span>;
<span class="hljs-title class_">Header</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">App</span>;
<span class="hljs-title class_">Header</span>.<span class="hljs-property">child</span> = <span class="hljs-title class_">Logo</span>;
<span class="hljs-title class_">Logo</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">Header</span>;
<span class="hljs-title class_">Logo</span>.<span class="hljs-property">sibling</span> = <span class="hljs-title class_">Nav</span>;
<span class="hljs-title class_">Nav</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">Header</span>;
<span class="hljs-title class_">Header</span>.<span class="hljs-property">sibling</span> = <span class="hljs-title class_">Content</span>;
<span class="hljs-title class_">Content</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">App</span>;
<span class="hljs-title class_">Content</span>.<span class="hljs-property">child</span> = <span class="hljs-title class_">Article</span>;
<span class="hljs-title class_">Article</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">Content</span>;
<span class="hljs-title class_">Content</span>.<span class="hljs-property">sibling</span> = <span class="hljs-title class_">Footer</span>;
<span class="hljs-title class_">Footer</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">App</span>;
</code></pre>
<h4 data-id="heading-16">总结（核心关键点）</h4>
<ol>
<li><strong>拆分基础</strong>：Fiber 节点是「可独立处理的最小单元」，链表指针（<code>child</code>/<code>sibling</code>/<code>return</code>）让节点能被逐个遍历，无需依赖递归栈；</li>
<li><strong>拆分方式</strong>：把「整棵组件树的渲染更新」拆成「处理单个 Fiber 节点」的原子小任务，按「深度优先 + 链表遍历」的顺序逐个执行；</li>
<li><strong>可中断核心</strong>：工作循环每次只执行一个小任务，执行前检查时间，不足则中断并记录断点，恢复时从断点继续——这也是拆分的最终目的：让长任务变可中断。</li>
</ol>
<p><strong><code>简单来说，Fiber 的任务拆分就像「把一本厚书拆成一页页来读」：原来的 Stack Reconciler 是「一口气读完整本书」，而 Fiber 是「读一页，看看有没有时间，有就继续读下一页，没有就合上书记下页码，下次从这页继续读」。</code></strong></p>
<h3 data-id="heading-17">为什么 Stack Reconciler 的「一次性递归遍历整棵树」做不到像 Fiber 那样把节点处理拆成独立小任务</h3>
<h4 data-id="heading-18">一、核心差异：递归遍历中「节点处理不具备独立性」</h4>
<p>Fiber 能拆分任务的关键是「单个节点的处理不依赖其他节点的执行上下文」，但 Stack Reconciler 的递归遍历中，<strong>处理子节点是父节点处理逻辑的「嵌套部分」，完全依赖父节点的调用上下文，无法单独拆分</strong>。</p>
<h5 data-id="heading-19">1. 先看 Stack Reconciler 的递归代码（核心片段）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Stack Reconciler 处理父节点的逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcile</span>(<span class="hljs-params">oldVNode, newVNode</span>) {
  <span class="hljs-comment">// 1. 处理当前父节点的逻辑</span>
  <span class="hljs-keyword">if</span> (oldVNode.<span class="hljs-property">tag</span> !== newVNode.<span class="hljs-property">tag</span>) { <span class="hljs-comment">/* 标记替换 */</span> }

  <span class="hljs-comment">// 2. 遍历子节点 —— 这是父节点处理逻辑的「一部分」</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLen; i++) {
    <span class="hljs-keyword">const</span> oldChild = oldVNode.<span class="hljs-property">children</span>[i];
    <span class="hljs-keyword">const</span> newChild = newVNode.<span class="hljs-property">children</span>[i];
    
    <span class="hljs-comment">// 3. 递归处理子节点 —— 这个调用「嵌套在父节点的函数体中」</span>
    <span class="hljs-keyword">if</span> (oldChild &amp;&amp; newChild) {
      <span class="hljs-title function_">reconcile</span>(oldChild, newChild); <span class="hljs-comment">// 子节点处理依赖父节点的循环上下文</span>
    }
  }
}
</code></pre>
<h5 data-id="heading-20">2. 递归模式下的「依赖陷阱」</h5>
<p>从代码能清晰看到：</p>
<ul>
<li>「处理子节点」不是一个「独立任务」，而是父节点 <code>reconcile</code> 函数执行过程中的<strong>嵌套步骤</strong>；</li>
<li>要处理子节点，必须先进入父节点的 <code>reconcile</code> 函数，且父节点的 <code>for</code> 循环必须执行到对应子节点的索引；</li>
<li><strong><code>子节点的递归调用「依附于父节点的调用栈」—— 父节点的函数没执行完，子节点的调用就无法独立存在；反过来，子节点的递归没返回，父节点的函数也无法结束。</code></strong></li>
</ul>
<p>举个通俗例子：</p>
<ul>
<li>Fiber 模式：每个节点是「独立的快递包裹」，处理一个包裹只需要包裹本身的信息，不用管其他包裹，能拆成一个个独立任务；</li>
<li>Stack 递归模式：所有节点是「一串连在一起的鞭炮」，要炸到第 5 个鞭炮，必须先点第 1 个，且中间不能停 —— 第 5 个的爆炸依赖前 4 个的传导，无法单独拆出第 5 个来炸。</li>
</ul>
<h4 data-id="heading-21">二、底层限制：JS 调用栈的「同步不可中断性」</h4>
<p>Stack Reconciler 依赖 JS 函数调用栈实现递归，而调用栈的特性决定了「一旦开始递归，必须执行到底」：</p>





















<table><thead><tr><th>Fiber 架构（迭代+链表）</th><th>Stack Reconciler（递归+调用栈）</th></tr></thead><tbody><tr><td>用「变量记录当前节点」（<code>workInProgress</code>），中断时只需保存这个变量</td><td>用「调用栈记录执行位置」，栈的层级和节点嵌套深度绑定</td></tr><tr><td>中断时：保存当前节点变量，直接退出循环，调用栈清空</td><td>中断时：无法退出——调用栈必须等嵌套的递归函数全部返回才能清空</td></tr><tr><td>恢复时：从保存的节点变量继续迭代，无需恢复调用栈</td><td>恢复时：无法实现——调用栈一旦弹出，无法还原之前的嵌套状态</td></tr></tbody></table>
<h5 data-id="heading-22">关键举例：递归调用栈的「不可回退性」</h5>
<p>假设组件树是 <code>App → Header → Logo</code>，递归处理时调用栈的变化是：</p>
<ol>
<li>调用 <code>reconcile(App)</code> → 栈：<code>[reconcile(App)]</code></li>
<li>遍历 App 的子节点，调用 <code>reconcile(Header)</code> → 栈：<code>[reconcile(App), reconcile(Header)]</code></li>
<li>遍历 Header 的子节点，调用 <code>reconcile(Logo)</code> → 栈：<code>[reconcile(App), reconcile(Header), reconcile(Logo)]</code></li>
</ol>
<p>此时如果想「中断处理 Logo，先处理其他任务」，不可能：</p>
<ul>
<li>要中断，必须让 <code>reconcile(Logo)</code> 执行完并返回 → 栈变成 <code>[reconcile(App), reconcile(Header)]</code>；</li>
<li>再让 <code>reconcile(Header)</code> 执行完并返回 → 栈变成 <code>[reconcile(App)]</code>；</li>
<li>最后让 <code>reconcile(App)</code> 执行完 → 栈清空。</li>
</ul>
<p><strong><code>整个过程中，你无法「暂停在 Logo 节点」，因为调用栈的层级和节点处理深度是强绑定的 —— 栈的状态就是执行位置，而栈无法被「冻结」或「保存」，只能按顺序弹出。 </code></strong></p>
<p>而 Fiber 架构中，执行位置是靠「变量（<code>workInProgress</code>）」记录的，不是调用栈：</p>
<ul>
<li>处理到 Logo 节点时，<code>workInProgress = Logo</code>；</li>
<li>想中断？直接退出循环，保存 <code>workInProgress = Logo</code> 即可，调用栈完全清空；</li>
<li>恢复时，把 <code>workInProgress</code> 设为 Logo，重新启动循环就能继续处理，无需依赖任何栈状态。</li>
</ul>
<h4 data-id="heading-23">三、处理单元的本质：「整树遍历」vs「单个节点处理」</h4>
<p>Stack Reconciler 的「最小处理单元」是「整棵树的遍历」，而 Fiber 的「最小处理单元」是「单个节点的处理」—— 这是能否拆分的根本：</p>
<ol>
<li>
<p><strong>Stack Reconciler</strong>：</p>
<ul>
<li>开发者调用 <code>setState</code> 后，React 启动的是「整棵树的 reconcile 任务」，这个任务是「不可分割的整体」；</li>
<li>即使你只想更新一个 Logo 节点，也必须从 App 根节点开始，递归遍历到 Logo，再逐层返回 —— 整个过程是一个「大任务」，没有更小的可执行单元。</li>
</ul>
</li>
<li>
<p><strong>Fiber 架构</strong>：</p>
<ul>
<li>启动的是「遍历链表的工作循环」，这个循环的「最小执行单元」是「处理单个 Fiber 节点」；</li>
<li>想更新 Logo 节点？工作循环可以只执行「处理 Logo 节点」这个小任务，时间不够就暂停，完全不影响其他节点的处理状态。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-24">总结（核心关键点）</h4>
<ol>
<li><strong>独立性差异</strong>：Stack 递归中，子节点处理是父节点逻辑的嵌套部分，依赖父节点的调用上下文，无法拆成独立任务；Fiber 节点包含全部处理信息，单个节点处理无需依赖其他节点；</li>
<li><strong>执行载体差异</strong>：Stack 依赖 JS 调用栈，栈的同步特性决定了递归必须执行到底，无法中断/保存状态；Fiber 依赖变量记录当前节点，迭代执行，可随时中断并保存执行位置；</li>
<li><strong>最小单元差异</strong>：Stack 的最小处理单元是「整树遍历」，Fiber 的最小处理单元是「单个节点处理」—— 这是能否拆分的核心。</li>
</ol>
<p>简单来说：Stack Reconciler 就像「用一根绳子串起所有珠子，要拿最后一颗必须把整串拉到底」；而 Fiber 是「每个珠子都有独立的标签和位置信息，想拿哪颗就拿哪颗，拿一半放下也能记住位置」。这就是递归遍历无法拆分，而 Fiber 能拆分的根本原因。</p>
<h3 data-id="heading-25">「中断后能恢复」的关键是<strong>能否精准记住「下一个该处理的节点」</strong></h3>
<p>本质上，「中断后能恢复」的关键是 <strong><code>能否精准记住「下一个该处理的节点」</code></strong> —— 递归栈的执行逻辑天然做不到这一点，而 Fiber 链表通过「显式的节点引用 + 独立变量记录」完美解决了这个问题。下面我用「通俗例子 + 逻辑拆解 + 对比」的方式讲透。</p>
<h4 data-id="heading-26">一、先明确：中断点需要记录什么？</h4>
<p>不管是递归还是 Fiber，想中断后恢复，必须记住一个核心信息：</p>
<blockquote>
<p><strong>中断时，下一个该处理的节点是谁？</strong>
比如处理到 <code>App → Header → Logo</code> 后中断，需要记住「接下来该处理 Logo 的兄弟节点 Nav」，恢复时直接从 Nav 开始，而不是从头重新处理 App。</p>
</blockquote>
<p>这是恢复的核心前提 —— 递归栈做不到记录这个信息，而链表可以。</p>
<h4 data-id="heading-27">二、递归栈为什么「无法记录中断点」？</h4>
<p><strong><code>递归栈的执行位置，是靠 **JS 调用栈的「层级」和「函数执行上下文」** 来隐式记录的，而非显式的节点引用 —— 这意味着一旦中断，这些上下文会全部丢失，无法还原。</code></strong></p>
<h5 data-id="heading-28">1. 递归栈的「执行位置」绑定调用栈层级</h5>
<p>举个具体例子：组件树是 <code>App → Header → Logo（子）/ Nav（兄弟）</code>，递归处理时的调用栈变化：</p>
<pre><code class="hljs language-css" lang="css">// 步骤<span class="hljs-number">1</span>：调用 reconcile(App) → 栈：<span class="hljs-selector-attr">[reconcile(App)]</span>
// 步骤<span class="hljs-number">2</span>：遍历 App 子节点，调用 reconcile(<span class="hljs-selector-tag">Header</span>) → 栈：<span class="hljs-selector-attr">[reconcile(App), reconcile(Header)]</span>
// 步骤<span class="hljs-number">3</span>：遍历 <span class="hljs-selector-tag">Header</span> 子节点，调用 reconcile(Logo) → 栈：<span class="hljs-selector-attr">[reconcile(App), reconcile(Header), reconcile(Logo)]</span>
</code></pre>
<p>此时想中断（比如时间不足），要处理的下一个节点是 <code>Nav</code>（Logo 的兄弟），但递归栈的问题来了：</p>
<ul>
<li>「下一个该处理 Nav」这个信息，只存在于 <code>reconcile(Header)</code> 函数的<strong>执行上下文</strong>中（比如循环变量 <code>i=1</code>，对应 Header 子节点的第二个元素）；</li>
<li>调用栈的层级只记录「当前正在执行 reconcile(Logo)」，但<strong>无法直接记录「下一个节点是 Nav」</strong>；</li>
<li>如果强行中断（比如退出函数），<code>reconcile(Logo)</code> 会返回，<code>reconcile(Header)</code> 的执行上下文（循环变量 <code>i</code>、Header 节点的引用）会被销毁，调用栈回到 <code>[reconcile(App)]</code>；</li>
<li>等恢复时，你只知道「之前执行到过 Logo」，但完全不知道「下一个该处理 Nav」—— 只能从头重新调用 <code>reconcile(App)</code>，相当于白执行了前面的步骤。</li>
</ul>
<h5 data-id="heading-29">2. 递归栈的「不可恢复性」核心</h5>





















<table><thead><tr><th>递归栈的特性</th><th>导致的问题</th></tr></thead><tbody><tr><td>执行位置靠「栈层级 + 函数上下文」隐式记录</td><td>中断时函数上下文销毁，无法记住「下一个节点」</td></tr><tr><td>调用栈只能「先进后出」，无法暂停/保存</td><td>要么执行完当前递归，要么全部退出，没有中间状态</td></tr><tr><td>没有独立变量记录「待处理节点」</td><td>恢复时只能从头开始，无法从中断点继续</td></tr></tbody></table>
<p>通俗比喻：递归栈就像「在纸上写作业，没写完就被擦掉」—— 你只知道写到了第3题，但不知道第3题写完后该写第4题，只能重新从第1题开始写。</p>
<h4 data-id="heading-30">三、Fiber 链表为什么「能记录中断点」？</h4>
<p>Fiber 架构放弃了递归栈，改用 <strong>「独立变量 + 链表指针」显式记录中断点</strong> —— 中断点的核心信息（下一个待处理节点）被保存在一个独立变量（<code>workInProgress</code>）中，和调用栈无关，就算中断也不会丢失。</p>
<h5 data-id="heading-31">1. 链表的「执行位置」绑定「节点引用」</h5>
<p>还是同一个例子：组件树 <code>App → Header → Logo / Nav</code>，Fiber 处理时的逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化：待处理节点 = App</span>
<span class="hljs-keyword">let</span> workInProgress = <span class="hljs-title class_">App</span>;

<span class="hljs-comment">// 步骤1：处理 App → 找到下一个节点（App.child = Header）→ workInProgress = Header</span>
<span class="hljs-comment">// 步骤2：处理 Header → 找到下一个节点（Header.child = Logo）→ workInProgress = Logo</span>
<span class="hljs-comment">// 步骤3：处理 Logo → 找到下一个节点（Logo.sibling = Nav）→ workInProgress = Nav</span>
</code></pre>
<p>此时想中断：</p>
<ul>
<li>只需要保存 <code>workInProgress = Nav</code> 这个变量（记录「下一个该处理 Nav」），然后直接退出循环即可；</li>
<li>调用栈会被清空（因为是迭代而非递归），但 <code>workInProgress</code> 变量不会消失；</li>
<li>恢复时，直接把 <code>workInProgress</code> 设为 Nav，重新启动循环：<code>处理 Nav → 找到下一个节点（Nav.return = Header → Header.sibling = Content）→ workInProgress = Content</code>，完美继续。</li>
</ul>
<h5 data-id="heading-32">2. 链表指针让「中断点可追溯」</h5>
<p>Fiber 节点的 <code>child</code>/<code>sibling</code>/<code>return</code> 指针，让每个节点都能「找到自己的下一个节点」，无需依赖调用栈：</p>
<ul>
<li>就算中断时只记住了 <code>Nav</code>，通过 <code>Nav.return</code> 能找到 Header，通过 <code>Header.sibling</code> 能找到 Content，永远不会「迷路」；</li>
<li>而递归栈一旦丢失上下文，节点之间的关系就无从追溯。</li>
</ul>
<h5 data-id="heading-33">3. 链表的「可恢复性」核心</h5>





















<table><thead><tr><th>Fiber 链表的特性</th><th>解决的问题</th></tr></thead><tbody><tr><td>执行位置靠「workInProgress 变量」显式记录</td><td>中断时只需保存这个变量，上下文不丢失</td></tr><tr><td>节点关系靠指针（child/sibling/return）显式关联</td><td>从任意节点都能找到下一个待处理节点</td></tr><tr><td>迭代执行，调用栈随时可清空</td><td>中断时不依赖栈层级，恢复时直接用变量继续</td></tr></tbody></table>
<p>通俗比喻：Fiber 链表就像「在作业本上贴便利贴，写不完就贴在第4题上」—— 就算合上书，下次打开看到便利贴，直接从第4题开始写就行，不用重新写。</p>
<h4 data-id="heading-34">四、直观对比：递归栈 vs Fiber 链表（中断恢复）</h4>






























<table><thead><tr><th>场景</th><th>递归栈</th><th>Fiber 链表</th></tr></thead><tbody><tr><td>处理到 Logo 后中断</td><td>调用栈层级丢失，循环变量销毁，不知道下一个是 Nav</td><td>保存 workInProgress = Nav，变量不丢失</td></tr><tr><td>恢复执行</td><td>只能重新从 App 开始递归，重复处理 App/Header/Logo</td><td>直接从 workInProgress = Nav 开始，处理 Nav/Content/...</td></tr><tr><td>核心记录方式</td><td>隐式（栈层级 + 函数上下文）</td><td>显式（独立变量 + 节点引用）</td></tr><tr><td>能否恢复</td><td>❌ 不能，只能重跑</td><td>✅ 能，精准继续</td></tr></tbody></table>
<h4 data-id="heading-35">总结（核心关键点）</h4>
<ol>
<li><strong>中断点的核心是记录「下一个待处理节点」</strong>：<strong><code>递归栈靠「调用栈层级 + 函数上下文」隐式记录，中断后上下文销毁，无法还原；Fiber 靠 </code>workInProgress<code> 变量显式记录节点引用，中断后变量不丢失。</code></strong></li>
<li><strong>链表指针是恢复的基础</strong>：<code>child</code>/<code>sibling</code>/<code>return</code> 让每个节点都能找到下一个节点，无需依赖调用栈，从任意中断点都能继续遍历。</li>
<li><strong>递归栈的本质是「依赖栈状态」，链表的本质是「依赖节点引用」</strong>：栈状态不可保存，节点引用可保存 —— 这是「能否中断恢复」的根本区别。</li>
</ol>
<p>简单来说：递归栈是「靠记忆记位置」，中断后忘了就只能重来了；Fiber 链表是「靠笔记记位置」，中断后看笔记就能精准继续。这就是链表能记录中断点、递归栈做不到的核心原因。</p>
<h3 data-id="heading-36">2. Fiber 分片/中断的执行机制 -- Scheduler</h3>
<p>Fiber 的执行分为两个核心阶段，只有第一个阶段可中断：</p>























<table><thead><tr><th>阶段</th><th>名称</th><th>核心操作</th><th>是否可中断</th></tr></thead><tbody><tr><td>阶段1</td><td>Reconciliation（协调/渲染）</td><td>对比新旧 Fiber 树、标记 DOM 变更（副作用）</td><td>✅ 可中断、可暂停、可重启</td></tr><tr><td>阶段2</td><td>Commit（提交）</td><td>将标记的副作用应用到真实 DOM</td><td>❌ 不可中断（DOM 操作必须一次性完成，避免页面不完整）</td></tr></tbody></table>
<p><strong>分片/中断的具体执行流程</strong>：</p>
<ol>
<li><strong>任务调度</strong>：当组件触发更新（如 setState），Scheduler 会根据任务优先级（比如用户输入 &gt; 数据请求）将任务加入调度队列；</li>
<li><strong>启动迭代遍历</strong>：不再递归遍历组件树，而是基于 Fiber 链表做迭代式深度优先遍历：
<ul>
<li>先处理当前 Fiber 节点（比如计算 props、对比子节点）；</li>
<li>处理完后，检查“剩余空闲时间”：如果还有时间，就取下一个 Fiber 节点（child → sibling → return）继续处理；如果没有时间，就暂停遍历；</li>
</ul>
</li>
<li><strong>中断逻辑</strong>：暂停时，React 会记录当前“工作中的 Fiber 节点”（workInProgress），然后调用 <code>requestIdleCallback</code>（或 React 模拟的空闲回调），把控制权还给浏览器，让浏览器执行布局、绘制等操作；</li>
<li><strong>恢复逻辑</strong>：当浏览器进入下一次空闲期，Scheduler 会唤醒暂停的任务，从之前记录的 workInProgress 节点继续遍历，直到所有 Fiber 节点处理完毕；</li>
<li><strong>提交阶段</strong>：协调阶段完成后，React 会一次性执行所有标记的 DOM 变更，这个过程不可中断，保证 DOM 状态的一致性。</li>
</ol>
<h3 data-id="heading-37">Scheduler 调度器的具体实现原理</h3>
<p>Scheduler 本质是一个「智能任务调度中心」，核心目标是<strong>让高优先级任务优先执行，低优先级任务利用空闲时间执行，且所有任务都能被中断/恢复</strong>。下面我会从「优先级设计」「空闲时间计算」「任务执行/暂停控制」三个核心维度，拆解它的实现逻辑，还会附上简化代码模拟核心流程。</p>
<h4 data-id="heading-38">一、核心前置认知</h4>
<p>Scheduler 是独立于 React 核心的模块（甚至可以单独使用），它的实现不依赖 Fiber 架构，但为 Fiber 提供了「可中断渲染」的基础能力。其核心设计思路是：</p>
<ul>
<li><strong><code>用「过期时间」量化任务优先级，而非单纯的“高/中/低”标签；</code></strong></li>
<li><strong><code>用「requestAnimationFrame + postMessage」模拟高精度空闲回调，替代原生 </code>requestIdleCallback<code>；</code></strong></li>
<li><strong><code>用「工作循环 + 时间检查」实现任务的执行、中断与恢复。</code></strong></li>
</ul>
<h4 data-id="heading-39">二、模块1：任务优先级的实现</h4>
<p>Scheduler 不直接用“优先级等级”，而是用<strong>过期时间（expirationTime）</strong> 来定义优先级——优先级越高，任务的过期时间越短（越早需要执行）。</p>
<h5 data-id="heading-40">1. 优先级与过期时间的映射</h5>
<p>React 定义了 5 类核心优先级（对应不同的过期时间阈值），本质是「任务必须在多久内执行，否则用户会感知到卡顿」：</p>









































<table><thead><tr><th>优先级名称</th><th>过期时间（当前时间 + X）</th><th>适用场景</th><th>核心特点</th></tr></thead><tbody><tr><td>ImmediatePriority</td><td>0ms（立即过期）</td><td>同步执行的紧急任务（如报错）</td><td>阻塞渲染，必须立即执行</td></tr><tr><td>UserBlockingPriority</td><td>250ms</td><td>用户交互（点击/输入/滚动）</td><td>250ms内执行，否则感知卡顿</td></tr><tr><td>NormalPriority</td><td>5000ms</td><td>普通任务（如网络请求回调）</td><td>不紧急，可延迟</td></tr><tr><td>LowPriority</td><td>10000ms</td><td>低优先级任务（如非关键数据加载）</td><td>可大幅延迟</td></tr><tr><td>IdlePriority</td><td>Infinity（永不过期）</td><td>空闲任务（如日志/统计）</td><td>只有浏览器空闲时才执行</td></tr></tbody></table>
<h5 data-id="heading-41">2. 优先级队列的实现：最小堆（小顶堆）</h5>
<p>Scheduler 用<strong>最小堆</strong>管理所有待执行任务，<strong><code>堆的排序依据是「过期时间」——堆顶永远是「过期时间最早（优先级最高）」的任务，保证高优先级任务先执行。</code></strong></p>
<ul>
<li>为什么用最小堆？<strong><code>堆的「取顶（O(1)）」「插入（O(logn)）」效率远高于普通数组排序，适合频繁新增/取出任务的场景；</code></strong></li>
<li>核心操作：
<ul>
<li>新增任务：插入堆中，堆自动调整，保持堆顶是最高优先级任务；</li>
<li>执行任务：每次从堆顶取出任务执行，执行完后重新调整堆。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-42">三、模块2：空闲时间计算的实现</h4>
<p>原生 <code>requestIdleCallback</code> 有两个致命问题：① 兼容性差；② 触发时机不稳定（帧率低于 60fps 时可能不触发）。因此 Scheduler 用「requestAnimationFrame (rAF) + postMessage」模拟高精度的空闲时间计算。</p>
<h5 data-id="heading-43">1. 核心原理</h5>
<p>浏览器每帧（16.6ms）的执行顺序是：</p>
<pre><code class="hljs">事件处理 → 宏任务 → 微任务 → rAF → 布局 → 绘制 → 空闲时间
</code></pre>
<p>Scheduler 利用 rAF 精准获取每帧的开始时间，再用 postMessage 触发宏任务，在宏任务中计算「当前帧剩余的空闲时间」。</p>
<h5 data-id="heading-44">2. 空闲时间计算的步骤（代码级逻辑）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 步骤1：用 rAF 获取每帧的开始时间</span>
<span class="hljs-keyword">let</span> frameStartTime = <span class="hljs-number">0</span>;
<span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
  frameStartTime = timestamp; <span class="hljs-comment">// 记录当前帧的开始时间（ms）</span>
});

<span class="hljs-comment">// 步骤2：计算当前帧的剩余空闲时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateRemainingTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 16.6ms = 1000ms / 60fps（每帧总时长）</span>
  <span class="hljs-keyword">const</span> frameDuration = <span class="hljs-number">16.6</span>;
  <span class="hljs-keyword">const</span> elapsedTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - frameStartTime; <span class="hljs-comment">// 已用时间</span>
  <span class="hljs-keyword">const</span> remainingTime = frameDuration - elapsedTime; <span class="hljs-comment">// 剩余空闲时间</span>
  <span class="hljs-comment">// 预留 5ms 安全阈值，避免占用渲染时间</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, remainingTime - <span class="hljs-number">5</span>);
}

<span class="hljs-comment">// 步骤3：用 postMessage 触发空闲任务执行</span>
<span class="hljs-comment">// 原因：postMessage 的宏任务会在「绘制完成后、下一次 rAF 前」执行，正好对应空闲时间</span>
<span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
channel.<span class="hljs-property">port2</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> remainingTime = <span class="hljs-title function_">calculateRemainingTime</span>();
  <span class="hljs-keyword">if</span> (remainingTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 有空闲时间，执行调度任务</span>
    <span class="hljs-title function_">workLoop</span>(remainingTime);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 无空闲时间，等待下一次 rAF</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(channel.<span class="hljs-property">port1</span>.<span class="hljs-property">postMessage</span>.<span class="hljs-title function_">bind</span>(channel.<span class="hljs-property">port1</span>));
  }
};
</code></pre>
<h5 data-id="heading-45">3. 5ms 阈值的作用</h5>
<p>计算剩余时间时，会强制减去 5ms——这是为了预留足够时间给浏览器完成「布局/绘制」，避免任务执行超时导致丢帧。</p>
<h4 data-id="heading-46">四、模块3：任务执行/暂停的实现</h4>
<p>Scheduler 的核心是「工作循环（workLoop）」，它会逐次取出高优先级任务，执行“一小段”后检查剩余时间，不足则暂停，空闲时恢复。</p>
<h5 data-id="heading-47">1. 核心流程（简化代码模拟）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟：最小堆任务队列（简化版，仅示意）</span>
<span class="hljs-keyword">const</span> taskQueue = [];

<span class="hljs-comment">// 1. 新增任务（带优先级）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleTask</span>(<span class="hljs-params">callback, priorityLevel</span>) {
  <span class="hljs-comment">// 步骤1：计算过期时间（当前时间 + 优先级对应的阈值）</span>
  <span class="hljs-keyword">const</span> expirationTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + <span class="hljs-title function_">getExpirationTimeByPriority</span>(priorityLevel);
  <span class="hljs-comment">// 步骤2：插入最小堆队列</span>
  taskQueue.<span class="hljs-title function_">push</span>({ callback, expirationTime, <span class="hljs-attr">isPending</span>: <span class="hljs-literal">true</span> });
  taskQueue.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">expirationTime</span> - b.<span class="hljs-property">expirationTime</span>); <span class="hljs-comment">// 简化堆排序</span>
  <span class="hljs-comment">// 步骤3：触发调度（启动工作循环）</span>
  <span class="hljs-title function_">startWorkLoop</span>();
}

<span class="hljs-comment">// 2. 工作循环（核心：执行/中断/恢复）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">remainingTime</span>) {
  <span class="hljs-comment">// 取出堆顶任务（最高优先级）</span>
  <span class="hljs-keyword">let</span> currentTask = taskQueue[<span class="hljs-number">0</span>];
  
  <span class="hljs-keyword">while</span> (currentTask &amp;&amp; remainingTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 检查任务是否过期/取消</span>
    <span class="hljs-keyword">if</span> (currentTask.<span class="hljs-property">expirationTime</span> &lt; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() || !currentTask.<span class="hljs-property">isPending</span>) {
      taskQueue.<span class="hljs-title function_">shift</span>(); <span class="hljs-comment">// 移除过期/取消的任务</span>
      currentTask = taskQueue[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-comment">// 执行任务的「一小段」（而非一次性执行完）</span>
    <span class="hljs-comment">// 关键点：callback 返回是否需要继续执行（true=未完成，false=完成）</span>
    <span class="hljs-keyword">const</span> needContinue = currentTask.<span class="hljs-title function_">callback</span>(remainingTime);
    
    <span class="hljs-keyword">if</span> (needContinue) {
      <span class="hljs-comment">// 任务未完成，计算剩余时间（模拟执行消耗）</span>
      remainingTime -= <span class="hljs-number">1</span>; <span class="hljs-comment">// 假设执行一小段消耗 1ms</span>
      <span class="hljs-comment">// 剩余时间不足 5ms，中断任务</span>
      <span class="hljs-keyword">if</span> (remainingTime &lt; <span class="hljs-number">5</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'⚠️ 时间不足，暂停任务'</span>);
        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 退出循环，任务留在队列中</span>
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 任务完成，移除队列</span>
      taskQueue.<span class="hljs-title function_">shift</span>();
      currentTask = taskQueue[<span class="hljs-number">0</span>];
    }
  }

  <span class="hljs-comment">// 任务未执行完，下次空闲时恢复</span>
  <span class="hljs-keyword">if</span> (currentTask) {
    <span class="hljs-comment">// 重新触发 postMessage，等待下一次空闲</span>
    channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'continue'</span>);
  }
}

<span class="hljs-comment">// 3. 启动工作循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">startWorkLoop</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
    frameStartTime = timestamp;
    channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'start'</span>); <span class="hljs-comment">// 触发 postMessage 回调</span>
  });
}

<span class="hljs-comment">// 辅助函数：根据优先级获取过期时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getExpirationTimeByPriority</span>(<span class="hljs-params">priority</span>) {
  <span class="hljs-keyword">const</span> priorities = {
    <span class="hljs-string">'immediate'</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">'user-blocking'</span>: <span class="hljs-number">250</span>,
    <span class="hljs-string">'normal'</span>: <span class="hljs-number">5000</span>,
    <span class="hljs-string">'low'</span>: <span class="hljs-number">10000</span>,
    <span class="hljs-string">'idle'</span>: <span class="hljs-title class_">Infinity</span>
  };
  <span class="hljs-keyword">return</span> priorities[priority] || <span class="hljs-number">5000</span>;
}

<span class="hljs-comment">// 测试：新增一个用户交互任务（高优先级）</span>
<span class="hljs-title function_">scheduleTask</span>(<span class="hljs-function">(<span class="hljs-params">remainingTime</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`执行任务，剩余时间：<span class="hljs-subst">${remainingTime}</span>ms`</span>);
  <span class="hljs-comment">// 模拟任务需要多次执行（返回 true 表示未完成）</span>
  <span class="hljs-keyword">return</span> remainingTime &gt; <span class="hljs-number">10</span>; <span class="hljs-comment">// 剩余时间&gt;10ms 才继续，否则暂停</span>
}, <span class="hljs-string">'user-blocking'</span>);
</code></pre>
<h5 data-id="heading-48">2. 关键逻辑拆解</h5>
<ul>
<li><strong>任务可中断</strong>：任务的回调函数不是一次性执行完，而是返回「是否需要继续执行」——如果剩余时间不足，工作循环会退出，任务留在队列中；</li>
<li><strong>任务可恢复</strong>：中断后，Scheduler 会再次触发 <code>postMessage</code>，下一次空闲时重新启动工作循环，从队列中取出未完成的任务继续执行；</li>
<li><strong>任务取消</strong>：每个任务都有 <code>isPending</code> 标记，外部可通过修改该标记取消任务，工作循环会跳过已取消的任务。</li>
</ul>
<h4 data-id="heading-49">五、Scheduler 与 Fiber 的联动</h4>
<p>Scheduler 并不直接操作 Fiber 节点，而是给 Fiber 的「工作循环」提供“时间切片”能力：</p>
<ol>
<li>Fiber 把「处理单个节点」作为小任务，传给 Scheduler；</li>
<li>Scheduler 按优先级调度这个小任务，执行前检查空闲时间；</li>
<li>时间不足时，Scheduler 暂停执行，通知 Fiber 记录当前 <code>workInProgress</code> 节点；</li>
<li>下一次空闲时，Scheduler 恢复执行，Fiber 从 <code>workInProgress</code> 继续处理节点。</li>
</ol>
<h4 data-id="heading-50">总结（核心关键点）</h4>
<ol>
<li><strong>优先级实现</strong>：用「过期时间」量化优先级，结合「最小堆」保证高优先级任务先执行；</li>
<li><strong>空闲时间计算</strong>：基于 <code>rAF + postMessage</code> 模拟高精度空闲回调，替代原生 <code>requestIdleCallback</code>，并预留 5ms 安全阈值；</li>
<li><strong>执行/暂停控制</strong>：工作循环逐次执行任务的“小单元”，执行中持续检查剩余时间，不足则中断，下次空闲时从断点恢复。</li>
</ol>
<p>简单来说，Scheduler 就像「交通调度员」：给紧急车辆（高优先级任务）开绿灯，普通车辆（低优先级任务）错峰通行，且所有车辆都能临时靠边（中断），等道路空闲后再继续行驶（恢复）。</p>
<h3 data-id="heading-51">调度逻辑的核心底气：单个 Fiber 执行足够短</h3>
<p>React 这套调度逻辑的核心底气：<strong>从设计上把「单个 Fiber 执行足够短」做成「必然结果」，而非「偶然运气」</strong>，因此哪怕多执行一个，带来的耗时增量也只是微秒级，完全在浏览器的帧时间安全范围内，不会有任何“大碍”。</p>
<p>更准确地说，这个「坚信」不是凭空的设计自信，而是<strong>三层硬约束下的必然结论</strong>，让「单个 Fiber 执行短」成为不可打破的规则，这也是整个 Scheduler 敢放弃“精准预估”、采用“实时校验+容忍多执行一个”的底层前提：</p>
<h4 data-id="heading-52">1. 处理逻辑的硬约束：只做「纯内存原子操作」</h4>
<p>单个 Fiber 节点的处理被严格限定在<strong>无阻塞、无复杂计算、无IO</strong>的内存操作内：
props浅对比、副作用标记、链表指针读取，这些操作的耗时由 JS 引擎的内存访问速度决定，<strong>天然稳定在 0.1ms 以内</strong>，不会出现任何耗时突变。
不存在“一个 Fiber 处理突然花了 1ms”的可能，因为这类操作从根源上被排除在单个 Fiber 的处理逻辑之外。</p>
<h4 data-id="heading-53">2. 组件拆分的工程要求：复杂逻辑必须拆分为多个 Fiber - 对开发者，非强制</h4>
<p>React 的 Fiber 树构建规则强制要求：<strong>任何包含复杂计算/逻辑的组件，必须拆分为子组件</strong>，进而对应多个 Fiber 节点。
比如一个渲染时要做大量数据计算的组件，React 会要求开发者拆成「计算子组件+展示子组件」，让每个子组件对应一个 Fiber，单个 Fiber 只承担一部分简单逻辑，从拆分层面保证单个处理的轻量化。</p>
<h4 data-id="heading-54">3. 阶段隔离的硬约束：耗时操作被彻底排除在 Reconciliation 阶段</h4>
<p>React 把<strong>所有耗时操作</strong>（DOM 操作、样式计算、动画执行）都隔离到「Commit 阶段」，而 Reconciliation 阶段（Fiber 节点处理的阶段）只做纯内存的对比和标记。
Commit 阶段本身是不可中断的，但它的耗时操作是<strong>批量一次性执行</strong>的，且基于 Fiber 阶段的标记精准执行，不会有冗余操作，而 Fiber 阶段的轻量化则完全不受这些耗时操作的影响。</p>
<h4 data-id="heading-55">再补一层：“多执行一个也无碍”的实际体感</h4>
<p>假设剩余时间是 1.6ms，单个 Fiber 执行耗时 0.1ms，就算因为实时校验的时机问题，<strong>多执行了3个</strong>，总耗时也只是增加 0.3ms，达到 1.9ms，远低于浏览器 16.6ms 的帧时长，更低于 5ms 的安全阈值。
这个增量在浏览器层面属于「微秒级误差」，不会导致帧丢失，用户完全感知不到任何卡顿——这就是 React 敢“容忍多执行一个”的核心原因：<strong>增量耗时在人类感知和浏览器渲染的安全范围内</strong>。</p>
<h4 data-id="heading-56">最终结论</h4>
<p>你的判断切中了核心：<strong>React 所有的调度策略（执行前预估、执行后实时校验、可中断恢复），都是建立在「单个 Fiber 执行足够短」这个不可动摇的基础上的</strong>。
这个基础不是“坚信”出来的，而是通过「逻辑限定、组件拆分、阶段隔离」三层硬约束做出来的，正是因为这个基础的存在，Scheduler 才不用纠结于“精准预估耗时”，不用害怕“多执行一个”，只用做简单的实时时间校验，就能实现高效、不阻塞的调度。</p>
<p>简单说：<strong>先把单个任务的耗时压到极致，再谈调度的容错性</strong>——这是 React Fiber 架构最底层的设计哲学。</p>
<h3 data-id="heading-57">剩余空闲时间 的具体计算方法</h3>
<p>简单来说，剩余时间的计算核心是：<strong>以浏览器每帧的总时长（≈16.6ms）为基准，减去当前帧已消耗的时间，再预留 5ms 安全阈值，最终得到可用于执行 React 任务的空闲时间</strong>。下面我用「原理 + 代码 + 例子」的方式把计算逻辑拆透。</p>
<h4 data-id="heading-58">一、计算的核心前提</h4>
<p>浏览器要保证页面流畅（60fps），每帧的总时长必须控制在 <code>1000ms ÷ 60 ≈ 16.666ms</code>（以下简称 16.6ms）。每帧内浏览器需要依次完成：</p>
<pre><code class="hljs language-scss" lang="scss">事件处理 → 宏任务 → 微任务 → <span class="hljs-built_in">requestAnimationFrame</span>(rAF) → 布局(Layout) → 绘制(Paint) → 空闲时间
</code></pre>
<p>Scheduler 计算的「剩余时间」，就是<strong>当前帧总时长 - 已消耗时长</strong>，代表浏览器完成核心工作（布局、绘制）后，还剩多少时间可以执行 React 的低优先级任务。</p>
<h4 data-id="heading-59">二、剩余时间的完整计算步骤（带代码模拟）</h4>
<p>Scheduler 对剩余时间的计算分为 4 步，核心依赖 <code>requestAnimationFrame (rAF)</code> 的高精度时间戳（而非 <code>Date.now()</code>），保证计算准确性：</p>
<h5 data-id="heading-60">步骤1：获取当前帧的「开始时间」（核心基准）</h5>
<p><code>rAF</code> 的回调函数会接收一个<strong>高精度时间戳（timestamp）</strong>，这个时间戳是浏览器给出的「当前帧开始执行的时间」，是计算的唯一基准（比 <code>Date.now()</code> 更准，避免系统时间偏差）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 存储当前帧的开始时间（全局变量）</span>
<span class="hljs-keyword">let</span> frameStartTime = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 注册 rAF，在每帧开始时记录帧起始时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">registerFrameStartTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
    <span class="hljs-comment">// timestamp：浏览器提供的高精度时间戳（单位：ms），代表当前帧的开始时间</span>
    frameStartTime = timestamp;
    <span class="hljs-comment">// 每帧都要重新注册，保证帧开始时间实时更新</span>
    <span class="hljs-title function_">registerFrameStartTime</span>();
  });
}

<span class="hljs-comment">// 启动帧时间监听</span>
<span class="hljs-title function_">registerFrameStartTime</span>();
</code></pre>
<h5 data-id="heading-61">步骤2：计算「当前帧已消耗的时间」</h5>
<p>从帧开始到「当前时刻」，已经用掉的时间，公式为：</p>
<pre><code class="hljs">已消耗时间 = 当前高精度时间 - 帧开始时间
</code></pre>
<p>代码实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取当前高精度时间（兼容浏览器）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// performance.now() 是高精度时间（微秒级），比 Date.now() 更适合计算短时间间隔</span>
  <span class="hljs-keyword">return</span> performance.<span class="hljs-title function_">now</span>();
}

<span class="hljs-comment">// 计算已消耗时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getElapsedTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">getCurrentTime</span>() - frameStartTime;
}
</code></pre>
<h5 data-id="heading-62">步骤3：计算「原始剩余时间」</h5>
<p>原始剩余时间 = 每帧总时长（16.6ms） - 已消耗时间，代表当前帧理论上还剩的全部时间：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每帧总时长（60fps 下的标准值）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FRAME_DURATION</span> = <span class="hljs-number">1000</span> / <span class="hljs-number">60</span>; <span class="hljs-comment">// ≈16.666ms</span>

<span class="hljs-comment">// 计算原始剩余时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getRawRemainingTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> elapsedTime = <span class="hljs-title function_">getElapsedTime</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">FRAME_DURATION</span> - elapsedTime;
}
</code></pre>
<h5 data-id="heading-63">步骤4：应用「安全阈值」并处理边界情况</h5>
<p>为了避免 React 任务占用过多时间导致浏览器来不及完成「布局/绘制」，Scheduler 会预留 <strong>5ms 安全阈值</strong>，并保证剩余时间不会为负数（负数代表当前帧已超时）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 安全阈值：预留 5ms 给浏览器完成布局/绘制</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SAFE_THRESHOLD</span> = <span class="hljs-number">5</span>;

<span class="hljs-comment">// 最终可用的剩余时间（Scheduler 实际使用的）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getRemainingTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> rawRemaining = <span class="hljs-title function_">getRawRemainingTime</span>();
  <span class="hljs-comment">// 1. 减去安全阈值；2. 保证结果 ≥ 0（避免负数）</span>
  <span class="hljs-keyword">const</span> remaining = rawRemaining - <span class="hljs-variable constant_">SAFE_THRESHOLD</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, remaining);
}
</code></pre>
<h4 data-id="heading-64">三、关键细节解释（为什么要这么算？）</h4>
<h5 data-id="heading-65">1. 为什么用 <code>performance.now()</code> 而非 <code>Date.now()</code>？</h5>
<ul>
<li><code>Date.now()</code> 是「系统时间」，精度低（毫秒级），且可能被用户手动修改、时区同步等影响；</li>
<li><code>performance.now()</code> 是「相对时间」（从页面加载开始计时），精度高达微秒级（1ms = 1000μs），完全不受系统时间影响——适合计算「帧内短时间间隔」。</li>
</ul>
<h5 data-id="heading-66">2. 为什么要减 5ms 安全阈值？</h5>
<p>16.6ms 的帧时长中，浏览器需要至少 10ms 左右完成「布局 + 绘制」（这是实践验证的经验值）。如果 React 任务把剩余时间用完（比如剩 5ms 全占用），浏览器会来不及完成渲染，导致帧丢失、页面卡顿。
减 5ms 后，即使 React 用满剩余时间，浏览器仍有足够时间完成核心渲染工作。</p>
<h5 data-id="heading-67">3. 剩余时间为 0 意味着什么？</h5>
<p>如果 <code>getRemainingTime()</code> 返回 0，说明：</p>
<ul>
<li>当前帧已消耗的时间 ≥ 11.6ms（16.6 - 5）；</li>
<li>没有空闲时间执行 React 任务，Scheduler 会立即暂停任务，等待下一次帧的空闲时间。</li>
</ul>
<h4 data-id="heading-68">四、实际场景举例（直观理解）</h4>
<p>假设当前帧的执行情况如下：</p>
<ul>
<li>帧开始时间（frameStartTime）：1000.0ms；</li>
<li>当前时间（performance.now()）：1010.0ms；</li>
</ul>
<p>计算过程：</p>
<ol>
<li>已消耗时间 = 1010.0 - 1000.0 = 10ms；</li>
<li>原始剩余时间 = 16.6 - 10 = 6.6ms；</li>
<li>最终剩余时间 = 6.6 - 5 = 1.6ms（取正值）；</li>
</ol>
<p>结论：Scheduler 只会给 React 任务分配 1.6ms 的执行时间，超时就中断。</p>
<p>再举一个超时场景：</p>
<ul>
<li>已消耗时间 = 15ms；</li>
<li>原始剩余时间 = 16.6 - 15 = 1.6ms；</li>
<li>最终剩余时间 = 1.6 - 5 = -3.4ms → 取 0；</li>
</ul>
<p>结论：无空闲时间，暂停任务。</p>
<h4 data-id="heading-69">总结（核心关键点）</h4>
<ol>
<li><strong>计算基准</strong>：以 60fps 下每帧 16.6ms 为总时长，剩余时间 = 总时长 - 已消耗时间 - 5ms 安全阈值；</li>
<li><strong>时间精度</strong>：依赖 <code>rAF</code> 的高精度时间戳和 <code>performance.now()</code>，避免系统时间偏差；</li>
<li><strong>边界处理</strong>：剩余时间最小为 0，保证不会出现负数（超时则暂停任务）；</li>
<li><strong>核心目的</strong>：预留足够时间给浏览器完成渲染，避免 React 任务阻塞页面流畅性。</li>
</ol>
<p>简单来说，剩余时间的计算逻辑就是：<strong>先算当前帧还剩多少时间，再扣掉浏览器必须的渲染时间，剩下的才给 React 用</strong>——这是时间切片能「不阻塞渲染」的根本保障。</p>
<h3 data-id="heading-70">rAF 和 postMessage 的分工</h3>
<p>Scheduler 并不是「在 requestAnimationFrame (rAF) 里开启任务」，而是用 rAF 获取「帧开始时间」（作为计算剩余时间的基准），真正执行任务的时机是在 <code>postMessage</code> 的宏任务回调中；时间不足时暂停任务后，也不是直接由 postMessage 触发处理剩余任务，而是<strong>下一次帧周期重新走「rAF 记时间 → postMessage 执行任务」的流程</strong>。</p>
<p>下面我用「精准流程拆解 + 通俗比喻」把这个逻辑讲透，你就能清楚 rAF 和 postMessage 的分工，以及任务暂停/恢复的完整链路：</p>
<h4 data-id="heading-71">一、先纠正核心偏差：rAF 和 postMessage 的核心分工</h4>

























<table><thead><tr><th>角色</th><th>requestAnimationFrame (rAF)</th><th>postMessage 宏任务</th></tr></thead><tbody><tr><td>执行时机</td><td>每帧「布局/绘制前」（帧内核心工作前）</td><td>每帧「绘制完成后」（帧内空闲时间）</td></tr><tr><td>核心作用</td><td>记录「帧开始时间」（计算剩余时间的基准）</td><td>执行 React 任务（Fiber 处理）+ 检查剩余时间</td></tr><tr><td>是否直接执行任务</td><td>❌ 不执行，只记时间</td><td>✅ 是，真正的任务执行入口</td></tr></tbody></table>
<h4 data-id="heading-72">二、Scheduler 完整执行流程（纠正后的准确版本）</h4>
<p>用步骤拆解，你能清晰看到「记时间 → 算剩余 → 执行任务 → 暂停/恢复」的全链路：</p>
<h5 data-id="heading-73">步骤1：rAF 标记「帧开始时间」（准备工作）</h5>
<p>浏览器每帧启动时，先触发 rAF 回调：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
  <span class="hljs-comment">// 记录当前帧的开始时间（高精度时间戳），作为后续计算剩余时间的基准</span>
  frameStartTime = timestamp;
});
</code></pre>
<p>👉 这一步<strong>不执行任何 React 任务</strong>，只做「时间基准标记」，为后续计算“这一帧还剩多少空闲时间”铺路。</p>
<h5 data-id="heading-74">步骤2：postMessage 触发「任务执行」（核心）</h5>
<p>rAF 执行后，浏览器会完成「布局/绘制」等核心工作，之后触发 postMessage 宏任务（这才是空闲时间）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
channel.<span class="hljs-property">port2</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 1. 先计算当前帧的剩余空闲时间（基于 rAF 记录的 frameStartTime）</span>
  <span class="hljs-keyword">const</span> remainingTime = <span class="hljs-title function_">getRemainingTime</span>(); <span class="hljs-comment">// 比如算出 1.6ms</span>

  <span class="hljs-keyword">if</span> (remainingTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 2. 有空闲时间 → 执行 React 任务（处理 Fiber 节点）</span>
    <span class="hljs-keyword">const</span> hasMoreWork = <span class="hljs-title function_">workLoop</span>(remainingTime); <span class="hljs-comment">// 执行任务，返回是否有剩余任务</span>
    
    <span class="hljs-keyword">if</span> (hasMoreWork) {
      <span class="hljs-comment">// 3. 任务没做完（时间不足暂停）→ 等待下一次帧周期</span>
      <span class="hljs-comment">// 不是直接触发 postMessage，而是等下一次 rAF 后再走流程</span>
      <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">''</span>));
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 4. 无空闲时间 → 直接等下一次帧周期</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">''</span>));
  }
};
</code></pre>
<h5 data-id="heading-75">步骤3：workLoop 执行任务 + 时间不足则暂停</h5>
<p><code>workLoop</code> 里就是处理 Fiber 节点的核心逻辑：</p>
<ul>
<li>每处理一个 Fiber 节点，就检查「已用时间是否 ≥ 剩余时间」；</li>
<li>时间不足时，<code>workLoop</code> 返回 <code>true</code>（表示有剩余任务），Scheduler 就停止执行；</li>
<li>剩余任务不会立刻由 postMessage 触发，而是<strong>等下一个帧周期</strong>：先由 rAF 重新记录帧开始时间，再由 postMessage 回调执行剩余任务。</li>
</ul>
<h4 data-id="heading-76">三、通俗比喻：把「帧周期」比作「一节课」</h4>
<ul>
<li>rAF = 上课铃：打铃时记录“上课开始时间”（帧开始时间），只记时间，不讲课；</li>
<li>浏览器的布局/绘制 = 老师讲核心知识点：必须优先完成，不能打断；</li>
<li>postMessage = 课间休息：核心知识点讲完后，才有休息时间，此时才可以做“刷题（处理 Fiber 任务）”；</li>
<li>剩余时间不足 = 课间休息快结束了：刷不完题就暂停，把剩下的题留到「下一节课的课间休息」（下一次帧的 postMessage）再做；</li>
<li>下一次 rAF = 下一节课的上课铃：先记新的上课时间，再等新的课间休息（postMessage）刷题。</li>
</ul>
<h4 data-id="heading-77">总结（核心关键点）</h4>
<ol>
<li><strong><code>rAF 只记时间，不执行任务</code></strong>：<strong><code>它的作用是给剩余时间计算提供基准，不是任务执行入口；</code></strong></li>
<li><strong><code>postMessage 才是任务执行的核心时机</code></strong>：<strong><code>只有在绘制完成后的空闲时间（postMessage 回调），才会处理 Fiber 任务；</code></strong></li>
<li><strong><code>暂停后不是立即触发 postMessage</code></strong>：<strong><code>剩余任务会等「下一次帧周期」，重新走「rAF 记时间 → postMessage 执行任务」的流程，保证始终在空闲时间执行任务，不阻塞渲染。</code></strong></li>
</ol>
<p>简单来说：<strong><code>Scheduler 是「先靠 rAF 定时间基准，再靠 postMessage 找空闲时间执行任务，时间不够就等下一轮空闲时间继续」—— 而非“rAF 开任务，postMessage 收尾”。</code></strong></p>
<h3 data-id="heading-78"><code>requestIdleCallback</code>:想法很好，落地很拉垮</h3>
<h4 data-id="heading-79">一、先明确：requestIdleCallback 到底是干啥的？</h4>
<p><code>requestIdleCallback</code> 是<strong>浏览器原生提供的「空闲时间调度 API」</strong>，核心设计目标和 React Scheduler 一致——<strong>让开发者在浏览器“没活儿干”的时候执行低优先级任务</strong>，避免占用核心渲染时间导致卡顿。</p>
<h5 data-id="heading-80">1. 核心工作逻辑</h5>
<p>浏览器每帧（16.6ms）的执行顺序是：</p>
<pre><code class="hljs language-scss" lang="scss">事件处理 → 宏任务 → 微任务 → <span class="hljs-built_in">requestAnimationFrame</span>(rAF) → 布局 → 绘制 → 【空闲时间】→ requestIdleCallback 回调
</code></pre>
<p>只有当「布局+绘制」完成后，当前帧还有剩余时间（比如只用了 10ms，剩 6.6ms），浏览器才会触发 <code>requestIdleCallback</code> 的回调函数。</p>
<h5 data-id="heading-81">2. 核心能力</h5>
<p>回调函数会接收一个 <code>IdleDeadline</code> 对象，能拿到两个关键信息：</p>
<ul>
<li><code>timeRemaining()</code>：返回当前帧还剩多少空闲时间（比如 6.6ms）；</li>
<li><code>didTimeout</code>：标记任务是否过期（若浏览器长期无空闲，任务会强制触发）。</li>
</ul>
<h5 data-id="heading-82">3. 简单示例（原生用法）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注册一个空闲任务</span>
<span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function">(<span class="hljs-params">deadline</span>) =&gt;</span> {
  <span class="hljs-comment">// 只要还有空闲时间，就执行任务</span>
  <span class="hljs-keyword">while</span> (deadline.<span class="hljs-title function_">timeRemaining</span>() &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">doLowPriorityWork</span>(); <span class="hljs-comment">// 比如日志收集、非紧急数据处理</span>
  }
});
</code></pre>
<p>简单说：<code>requestIdleCallback</code> 就是浏览器给开发者的「空闲时间接口」，让你把不紧急的任务塞到帧的空闲期执行。</p>
<h4 data-id="heading-83">二、为什么 React 不用它？（核心还是那两个致命问题，展开讲透）</h4>
<p>虽然 <code>requestIdleCallback</code> 的设计初衷和 React Scheduler 一致，但它的两个硬伤让 React 完全无法用——咱们之前提过「兼容性差、触发时机不稳定」，这里结合实际场景展开：</p>

























<table><thead><tr><th>问题</th><th>具体表现</th><th>对 React 的致命影响</th></tr></thead><tbody><tr><td>兼容性极差</td><td>- IE 全版本不支持<br/>- iOS Safari 仅 14.5+ 支持<br/>- 安卓 WebView 大量不支持</td><td>React 要适配多端/多浏览器，依赖它会导致旧设备用户直接失去「可中断渲染」能力，退回卡顿状态</td></tr><tr><td>触发时机极不稳定</td><td>- 帧率 &lt; 60fps 时（页面卡顿），浏览器判定「无空闲时间」，回调<strong>完全不触发</strong><br/>- 浏览器为了“保核心渲染”，会刻意压缩触发机会</td><td>React 的低优先级任务（比如列表渲染）会无限积压，甚至永远不执行；中断后的任务也无法恢复</td></tr><tr><td>无优先级调度能力</td><td>所有注册的任务都是“同等优先级”，无法让用户交互（高优先级）插队</td><td>用户点击按钮后，低优先级任务还在占用空闲时间，导致交互响应卡顿</td></tr></tbody></table>
<h4 data-id="heading-84">三、关键补充：React 自研 Scheduler（rAF + postMessage）和 requestIdleCallback 的核心差异</h4>
<p>React 不是“不用空闲时间调度”，而是「抛弃原生的 requestIdleCallback，自己实现了一个更靠谱的版本」：</p>






























<table><thead><tr><th>特性</th><th>原生 requestIdleCallback</th><th>React Scheduler（rAF + postMessage）</th></tr></thead><tbody><tr><td>兼容性</td><td>差（仅新版浏览器支持）</td><td>好（rAF + postMessage 是基础 API，全浏览器兼容）</td></tr><tr><td>触发稳定性</td><td>帧率低时完全不触发</td><td>不管帧率多少，每帧都会尝试执行（剩余时间为0就等下一帧，不会积压）</td></tr><tr><td>优先级调度</td><td>无</td><td>支持5级优先级，高优先级任务（比如点击）可插队中断低优先级任务</td></tr><tr><td>时间控制精度</td><td>依赖浏览器内置计算，无法自定义 5ms 安全阈值</td><td>自研剩余时间计算，可精准预留 5ms 给浏览器渲染</td></tr></tbody></table>
<h4 data-id="heading-85">总结（核心关键点）</h4>
<ol>
<li><code>requestIdleCallback</code> 是浏览器原生的「空闲时间调度 API」，作用是在帧的空闲期执行低优先级任务；</li>
<li>React 不用它的核心原因：<strong>兼容性差（覆盖不全）、触发不稳定（帧率低时不执行）、无优先级调度</strong>，无法满足 Fiber 架构“可中断、高优先级优先”的核心需求；</li>
<li>React 转而用 <code>rAF + postMessage</code> 自研 Scheduler，本质是「重新实现了一个更稳定、更可控、带优先级的 requestIdleCallback」。</li>
</ol>
<p>简单来说：<code>requestIdleCallback</code> 是个“想法很好但落地拉胯”的原生 API，React 嫌它不好用，就自己造了个更强大的版本——这就是 Scheduler 的本质。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js 变形动画-打造花瓣绽放]]></title>    <link>https://juejin.cn/post/7600068892988653578</link>    <guid>https://juejin.cn/post/7600068892988653578</guid>    <pubDate>2026-01-28T10:01:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600068892988653578" data-draft-id="7600234310964838438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js 变形动画-打造花瓣绽放"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-28T10:01:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js 变形动画-打造花瓣绽放
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:01:41.000Z" title="Wed Jan 28 2026 10:01:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>本文将详细介绍如何使用 Three.js 实现变形动画效果。我们将学习如何利用 Morph Targets（形态目标）技术，让 3D 模型在不同形状之间平滑过渡，创造出花瓣绽放等生动的动画效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/014543e98fbc4129bc37fe0992bc4393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199625&amp;x-signature=GnMhv1W0tbYWAJyd45BlfEWXlxE%3D" alt="screenshot_2026-01-28_17-56-51.gif" loading="lazy"/></p>
<h2 data-id="heading-1">准备工作</h2>
<p>首先，我们需要引入必要的 Three.js 库和相关工具：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-comment">// 导入轨道控制器</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/controls/OrbitControls"</span>;
<span class="hljs-comment">// 导入动画库</span>
<span class="hljs-keyword">import</span> gsap <span class="hljs-keyword">from</span> <span class="hljs-string">"gsap"</span>;
<span class="hljs-comment">// 导入dat.gui</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dat <span class="hljs-keyword">from</span> <span class="hljs-string">"dat.gui"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DRACOLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/DRACOLoader"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/GLTFLoader"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RGBELoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/RGBELoader"</span>;
</code></pre>
<h2 data-id="heading-2">场景初始化</h2>
<p>首先，我们需要创建一个基本的 Three.js 场景：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> gui = <span class="hljs-keyword">new</span> dat.<span class="hljs-title function_">GUI</span>();
<span class="hljs-comment">// 1、创建场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();

<span class="hljs-comment">// 2、创建相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
  <span class="hljs-number">75</span>,
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
  <span class="hljs-number">0.1</span>,
  <span class="hljs-number">1000</span>
);
camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
<span class="hljs-comment">// 更新摄像机的投影矩阵</span>
camera.<span class="hljs-title function_">updateProjectionMatrix</span>();

<span class="hljs-comment">// 设置相机位置</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>);
scene.<span class="hljs-title function_">add</span>(camera);
</code></pre>
<h2 data-id="heading-3">环境设置</h2>
<p>添加 HDR 环境纹理，提升场景的真实感：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加hdr环境纹理</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RGBELoader</span>();
loader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./textures/038.hdr"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">texture</span>) {
  texture.<span class="hljs-property">mapping</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">EquirectangularReflectionMapping</span>;
  scene.<span class="hljs-property">environment</span> = texture;
});
</code></pre>
<h2 data-id="heading-4">DRACO 压缩模型加载</h2>
<p>使用 DRACO 压缩技术加载 GLB 模型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 加载压缩的glb模型</span>
<span class="hljs-keyword">const</span> gltfLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
<span class="hljs-keyword">const</span> dracoLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DRACOLoader</span>();
dracoLoader.<span class="hljs-title function_">setDecoderPath</span>(<span class="hljs-string">"./draco/gltf/"</span>);
dracoLoader.<span class="hljs-title function_">setDecoderConfig</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"js"</span> });
dracoLoader.<span class="hljs-title function_">preload</span>();
gltfLoader.<span class="hljs-title function_">setDRACOLoader</span>(dracoLoader);
</code></pre>
<h2 data-id="heading-5">变形动画核心实现</h2>
<p>这是变形动画的关键部分，通过 Morph Targets 技术实现模型变形：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> params = {
  <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">value1</span>: <span class="hljs-number">0</span>,
};

<span class="hljs-keyword">let</span> mixer;
<span class="hljs-keyword">let</span> stem, petal, stem1, petal1, stem2, petal2;

<span class="hljs-comment">// 加载第一个模型（初始状态）</span>
gltfLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./model/f4.glb"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf1</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gltf1);
  stem = gltf1.<span class="hljs-property">scene</span>.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>];
  petal = gltf1.<span class="hljs-property">scene</span>.<span class="hljs-property">children</span>[<span class="hljs-number">1</span>];
  gltf1.<span class="hljs-property">scene</span>.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>;

  <span class="hljs-comment">// 遍历场景中的对象并处理材质</span>
  gltf1.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Water"</span>) {
      item.<span class="hljs-property">material</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshStandardMaterial</span>({
        <span class="hljs-attr">color</span>: <span class="hljs-string">"skyblue"</span>,
        <span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">depthTest</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.5</span>,
      });
    }
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Stem"</span>) {
      stem = item;
    }
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Petal"</span>) {
      petal = item;
    }
  });

  <span class="hljs-comment">// 加载第二个模型（中间状态）</span>
  gltfLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./model/f2.glb"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf2</span>) {
    gltf2.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Stem"</span>) {
        stem1 = item;
        <span class="hljs-comment">// 将第二个模型的几何体作为第一个形态目标添加到基础模型</span>
        stem.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span> = [
          stem1.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>,
        ];
        stem.<span class="hljs-title function_">updateMorphTargets</span>();
      }
      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Petal"</span>) {
        petal1 = item;
        <span class="hljs-comment">// 将第二个模型的几何体作为第一个形态目标添加到基础模型</span>
        petal.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span> = [
          petal1.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>,
        ];
        petal.<span class="hljs-title function_">updateMorphTargets</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(petal.<span class="hljs-property">morphTargetInfluences</span>);
      }

      <span class="hljs-comment">// 加载第三个模型（最终状态）</span>
      gltfLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./model/f1.glb"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf2</span>) {
        gltf2.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Stem"</span>) {
            stem2 = item;
            <span class="hljs-comment">// 将第三个模型的几何体作为第二个形态目标添加到基础模型</span>
            stem.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">push</span>(
              stem2.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>
            );
            stem.<span class="hljs-title function_">updateMorphTargets</span>();
          }
          <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Petal"</span>) {
            petal2 = item;
            <span class="hljs-comment">// 将第三个模型的几何体作为第二个形态目标添加到基础模型</span>
            petal.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">push</span>(
              petal2.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>
            );
            petal.<span class="hljs-title function_">updateMorphTargets</span>();
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(petal.<span class="hljs-property">morphTargetInfluences</span>);
          }
        });
      });
    });
  });

  <span class="hljs-comment">// 使用 GSAP 创建变形动画</span>
  gsap.<span class="hljs-title function_">to</span>(params, {
    <span class="hljs-attr">value</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">duration</span>: <span class="hljs-number">4</span>,
    <span class="hljs-attr">onUpdate</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-comment">// 控制第一个形态目标的影响程度</span>
      stem.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">0</span>] = params.<span class="hljs-property">value</span>;
      petal.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">0</span>] = params.<span class="hljs-property">value</span>;
    },
    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-comment">// 在第一个动画完成后，开始第二个变形动画</span>
      gsap.<span class="hljs-title function_">to</span>(params, {
        <span class="hljs-attr">value1</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">duration</span>: <span class="hljs-number">4</span>,
        <span class="hljs-attr">onUpdate</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
          <span class="hljs-comment">// 控制第二个形态目标的影响程度</span>
          stem.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">1</span>] = params.<span class="hljs-property">value1</span>;
          petal.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">1</span>] = params.<span class="hljs-property">value1</span>;
        },
      });
    },
  });

  scene.<span class="hljs-title function_">add</span>(gltf1.<span class="hljs-property">scene</span>);
});
</code></pre>
<h2 data-id="heading-6">渲染器设置</h2>
<p>配置 WebGL 渲染器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化渲染器</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({
  <span class="hljs-attr">logarithmicDepthBuffer</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>,
});
<span class="hljs-comment">// 设置渲染的尺寸大小</span>
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-comment">// 开启场景中的阴影贴图</span>
renderer.<span class="hljs-property">shadowMap</span>.<span class="hljs-property">enabled</span> = <span class="hljs-literal">true</span>;
renderer.<span class="hljs-property">physicallyCorrectLights</span> = <span class="hljs-literal">true</span>;
renderer.<span class="hljs-title function_">setClearColor</span>(<span class="hljs-number">0xcccccc</span>, <span class="hljs-number">1</span>);
renderer.<span class="hljs-property">autoClear</span> = <span class="hljs-literal">false</span>;
<span class="hljs-comment">// 设置电影渲染模式</span>
renderer.<span class="hljs-property">toneMapping</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ACESFilmicToneMapping</span>;
renderer.<span class="hljs-property">outputEncoding</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">sRGBEncoding</span>;
renderer.<span class="hljs-property">sortObjects</span> = <span class="hljs-literal">true</span>;
renderer.<span class="hljs-property">logarithmicDepthBuffer</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 将webgl渲染的canvas内容添加到body</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);
</code></pre>
<h2 data-id="heading-7">控制器和动画循环</h2>
<p>设置轨道控制器和渲染循环：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建轨道控制器</span>
<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
<span class="hljs-comment">// 设置控制器阻尼，让控制器更有真实效果,必须在动画循环里调用.update()。</span>
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 添加坐标轴辅助器</span>
<span class="hljs-keyword">const</span> axesHelper = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AxesHelper</span>(<span class="hljs-number">5</span>);
scene.<span class="hljs-title function_">add</span>(axesHelper);

<span class="hljs-comment">// 设置时钟</span>
<span class="hljs-keyword">const</span> clock = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Clock</span>();
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> time = clock.<span class="hljs-title function_">getDelta</span>();
  <span class="hljs-keyword">if</span> (mixer) {
    mixer.<span class="hljs-title function_">update</span>(time);
  }
  controls.<span class="hljs-title function_">update</span>();

  renderer.<span class="hljs-title function_">render</span>(scene, camera);
  <span class="hljs-comment">// 渲染下一帧的时候就会调用render函数</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(render);
}

<span class="hljs-title function_">render</span>();
</code></pre>
<h2 data-id="heading-8">变形动画原理详解</h2>
<p>Morph Targets（形态目标）是一种在计算机图形学中用于实现网格变形的技术。其基本原理是：</p>
<ol>
<li><strong>基础几何体</strong>: 定义一个基础的网格几何体</li>
<li><strong>目标几何体</strong>: 定义一个或多个"目标"几何体，它们与基础几何体有相同的拓扑结构（相同的顶点数量和连接关系），但顶点位置不同</li>
<li><strong>权重控制</strong>: 通过权重值（0到1之间）来控制目标几何体对基础几何体的影响程度</li>
</ol>
<p>在代码中，我们使用 <code>morphTargetInfluences</code> 数组来控制每个形态目标的影响程度：</p>
<ul>
<li>当 <code>morphTargetInfluences[0] = 0</code> 时，模型呈现初始状态</li>
<li>当 <code>morphTargetInfluences[0] = 1</code> 时，模型完全变成第一个目标状态</li>
<li>当 <code>morphTargetInfluences[0] = 0.5</code> 时，模型是初始状态和目标状态的中间形态</li>
</ul>
<h2 data-id="heading-9">应用场景</h2>
<p>变形动画在 3D 应用中有广泛的应用：</p>
<ol>
<li><strong>角色面部表情</strong>: 实现人物的表情变化</li>
<li><strong>物体形态变化</strong>: 如花朵绽放、物体变形等</li>
<li><strong>动画过渡</strong>: 在不同模型状态之间平滑过渡</li>
<li><strong>程序化生成</strong>: 根据参数动态改变模型形状</li>
</ol>
<h2 data-id="heading-10">性能优化建议</h2>
<ol>
<li><strong>合理使用</strong>: Morph Targets 会增加内存消耗，只在必要时使用</li>
<li><strong>减少目标数量</strong>: 尽量减少形态目标的数量以提高性能</li>
<li><strong>压缩模型</strong>: 使用 DRACO 等压缩技术减少模型文件大小</li>
<li><strong>优化动画</strong>: 使用高效的动画库如 GSAP 来控制变形过程</li>
</ol>
<h2 data-id="heading-11">总结</h2>
<p>通过这个项目，我们学习了如何使用 Three.js 的 Morph Targets 技术：</p>
<ol>
<li>如何加载多个具有相同拓扑结构的模型</li>
<li>如何将目标模型的几何体作为形态目标添加到基础模型</li>
<li>如何通过控制权重来实现平滑的变形动画</li>
<li>如何使用 GSAP 等动画库来管理复杂的动画序列</li>
</ol>
<p>变形动画是一个强大而灵活的技术，能够为你的 3D 应用增添生动有趣的视觉效果，特别是在创建有机形态变化（如植物生长、花朵绽放等）方面特别有效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS-面试必考：手动实现一个标准的 Ajax 请求（XMLHttpRequest）]]></title>    <link>https://juejin.cn/post/7600234310964936742</link>    <guid>https://juejin.cn/post/7600234310964936742</guid>    <pubDate>2026-01-28T10:15:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310964936742" data-draft-id="7600068892988669962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS-面试必考：手动实现一个标准的 Ajax 请求（XMLHttpRequest）"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-28T10:15:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS-面试必考：手动实现一个标准的 Ajax 请求（XMLHttpRequest）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:15:37.000Z" title="Wed Jan 28 2026 10:15:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>虽然 <code>fetch</code> API 在现代开发中非常流行，但 <strong>XMLHttpRequest (XHR)</strong> 依然是理解 Web 网络编程的基石。无论是底层的 Ajax 封装，还是需要细粒度监控<strong>上传/下载进度</strong>的场景，XHR 依然不可替代。</p>
<h2 data-id="heading-1">一、 什么是 Ajax？</h2>
<p><strong>Ajax（Asynchronous JavaScript And XML）</strong> 并不是一种单一的编程语言，而是一套技术的组合。其核心是在不重新加载整个网页的情况下，通过与服务器进行异步数据交换，实现页面的<strong>局部刷新</strong>。</p>
<ul>
<li><strong>核心优势</strong>：提升用户体验，减少网络带宽占用。</li>
<li><strong>实现基础</strong>：JavaScript 和浏览器原生的 <code>XMLHttpRequest</code> 对象。</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、 XHR 操作的“五步法”逻辑</h2>
<h3 data-id="heading-3">1. 创建对象</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
</code></pre>
<h3 data-id="heading-4">2. 注册回调函数 (事件驱动)</h3>
<p>XHR 是基于事件驱动的，我们需要在请求发送前定义好如何处理各种状态。</p>
<ul>
<li><strong><code>onreadystatechange</code></strong>：监控请求的生命周期（状态 0-4）。</li>
<li><strong><code>onerror</code></strong>：处理网络层面的错误（如断网或 DNS 解析失败）。</li>
<li><strong><code>ontimeout</code></strong>：处理响应超时，需配合 <code>xhr.timeout</code> 使用。</li>
<li><strong><code>onprogress</code></strong>：数据传输进度监控。</li>
</ul>
<h3 data-id="heading-5">3. 配置请求参数</h3>
<p>通过 <code>open()</code> 方法初始化请求：</p>
<ul>
<li><strong><code>method</code></strong>：请求方法（GET, POST, PUT 等）。</li>
<li><strong><code>url</code></strong>：请求地址。</li>
<li><strong><code>async</code></strong>：是否异步（默认 <code>true</code>）。<strong>注意：</strong> 设为 <code>false</code> 会阻塞浏览器主线程，导致页面假死。</li>
</ul>
<h3 data-id="heading-6">4. 设置属性与请求头</h3>
<ul>
<li><code>responseType</code>：设置期望的返回格式（如 <code>json</code>, <code>blob</code>）。</li>
<li><code>setRequestHeader()</code>：手动添加自定义请求头（必须在 <code>open</code> 之后，<code>send</code> 之前调用）。</li>
</ul>
<h3 data-id="heading-7">5. 发送请求</h3>
<ul>
<li><code>send(data)</code>：正式发起请求。如果是 GET 请求，传 <code>null</code>；如果是 POST，传具体数据。</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、 详解 readyState：五种状态的演变</h2>
<p><code>readyState</code> 是排查 Ajax 问题的关键，它记录了请求的每一步进展：</p>



































<table><thead><tr><th><strong>取值</strong></th><th><strong>状态名称</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong>0</strong></td><td><strong>UNSENT</strong></td><td>初始化状态，对象已创建，尚未调用 <code>open()</code></td></tr><tr><td><strong>1</strong></td><td><strong>OPENED</strong></td><td>已调用 <code>open()</code>，尚未调用 <code>send()</code>，可设置 Header</td></tr><tr><td><strong>2</strong></td><td><strong>HEADERS_RECEIVED</strong></td><td>已调用 <code>send()</code>，接收到了响应头和状态码</td></tr><tr><td><strong>3</strong></td><td><strong>LOADING</strong></td><td>正在下载响应体，<code>responseText</code> 已包含部分数据</td></tr><tr><td><strong>4</strong></td><td><strong>DONE</strong></td><td><strong>数据接收完成</strong>，请求生命周期结束</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">四、 进度监控：如何实现进度条？</h2>
<p>XHR 相比 <code>fetch</code> 的一大优势就是对进度的原生支持。通过 <code>onprogress</code> 事件，我们可以计算出下载百分比：</p>
<ul>
<li><strong><code>lengthComputable</code></strong>：布尔值，表示服务器是否返回了 <code>Content-Length</code>。</li>
<li><strong><code>loaded</code></strong>：已接收的字节数。</li>
<li><strong><code>total</code></strong>：总字节数。</li>
</ul>
<hr/>
<h2 data-id="heading-10">五、 代码实现：封装一个标准的 Ajax 函数</h2>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">/**
 * 基于 XHR 封装的数据获取函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} URL 请求地址
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">GetWebData</span>(<span class="hljs-params">URL</span>) {
  <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

  <span class="hljs-comment">// 1. 状态监控：只在 DONE 阶段处理逻辑</span>
  xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) { 
      <span class="hljs-comment">// 兼容性判断：2xx 范围和 304 缓存均认为成功</span>
      <span class="hljs-keyword">if</span> ((xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) || xhr.<span class="hljs-property">status</span> === <span class="hljs-number">304</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请求成功:"</span>, xhr.<span class="hljs-property">response</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请求失败, 状态码:"</span>, xhr.<span class="hljs-property">status</span>);
      }
    }
  };

  <span class="hljs-comment">// 2. 进度监控</span>
  xhr.<span class="hljs-property">onprogress</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">lengthComputable</span>) {
      <span class="hljs-keyword">let</span> percent = (event.<span class="hljs-property">loaded</span> / event.<span class="hljs-property">total</span>) * <span class="hljs-number">100</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`下载进度: <span class="hljs-subst">${percent.toFixed(<span class="hljs-number">2</span>)}</span>%`</span>);
    }
  };

  <span class="hljs-comment">// 3. 异常与超时处理</span>
  xhr.<span class="hljs-property">timeout</span> = <span class="hljs-number">5000</span>; 
  xhr.<span class="hljs-property">ontimeout</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请求超时！"</span>);
  xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"网络异常或跨域错误"</span>);

  <span class="hljs-comment">// 4. 配置与发送</span>
  xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">"GET"</span>, <span class="hljs-variable constant_">URL</span>, <span class="hljs-literal">true</span>);
  xhr.<span class="hljs-property">responseType</span> = <span class="hljs-string">"json"</span>; <span class="hljs-comment">// 自动解析 JSON</span>
  xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">"X-Requested-With"</span>, <span class="hljs-string">"XMLHttpRequest"</span>);

  xhr.<span class="hljs-title function_">send</span>(<span class="hljs-literal">null</span>);
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>