<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[构建专业命令行工具：解析 Commander 与 Inquirer 的协作之道]]></title>    <link>https://juejin.cn/post/7600344784945381422</link>    <guid>https://juejin.cn/post/7600344784945381422</guid>    <pubDate>2026-01-29T06:23:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600344784945381422" data-draft-id="7600344784945348654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建专业命令行工具：解析 Commander 与 Inquirer 的协作之道"/> <meta itemprop="keywords" content="后端,前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-29T06:23:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建专业命令行工具：解析 Commander 与 Inquirer 的协作之道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:23:57.000Z" title="Thu Jan 29 2026 06:23:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Node.js 生态中，开发一个命令行界面（CLI）工具几乎是每个高级开发者的必经之路。然而，面对 <strong>Commander.js</strong> 和 <strong>Inquirer.js</strong> 这两个顶级库时，很多开发者会产生困惑：“我到底该选哪一个？”</p>
<p>实际上，这种困惑源于对两者定位的重叠性误解。Commander 负责的是**“命令的结构”<strong>，而 Inquirer 负责的是</strong>“互动的体验”**。本文将带你深入底层，看清它们的相同点与本质区别，助你做出最理性的技术选型。</p>
<hr/>
<h2 data-id="heading-0">1. Commander.js：CLI 的骨架与规则</h2>
<h3 data-id="heading-1">1.1 核心定位</h3>
<p>Commander 是一个完整的 Node.js 命令行解决方案。它效仿了 Ruby 的 <code>commander</code>，其核心目标是<strong>解析（Parsing）</strong>。它负责告诉程序：用户在启动时输入了什么指令、带了什么参数、设置了哪些选项。</p>
<h3 data-id="heading-2">1.2 核心功能特性</h3>
<ul>
<li><strong>参数解析</strong>：自动处理 <code>process.argv</code>，支持必填参数 <code>&lt;arg&gt;</code> 和可选参数 <code>[arg]</code>。</li>
<li><strong>选项定义</strong>：支持短选项（<code>-f</code>）和长选项（<code>--force</code>），并自动生成布尔值或参数值。</li>
<li><strong>子命令系统</strong>：通过 <code>.command()</code> 构建类似 <code>git push</code>、<code>git pull</code> 的嵌套结构。</li>
<li><strong>自动文档</strong>：基于定义自动生成 <code>-h, --help</code> 帮助信息。</li>
</ul>
<h3 data-id="heading-3">1.3 代码示例（基于文档）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { program } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'commander'</span>);

program
  .<span class="hljs-title function_">name</span>(<span class="hljs-string">'pizza-cli'</span>)
  .<span class="hljs-title function_">description</span>(<span class="hljs-string">'订购皮萨的工具'</span>)
  .<span class="hljs-title function_">version</span>(<span class="hljs-string">'1.0.0'</span>);

program
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'-s, --size &lt;type&gt;'</span>, <span class="hljs-string">'皮萨尺寸'</span>, <span class="hljs-string">'medium'</span>)
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'-d, --debug'</span>, <span class="hljs-string">'开启调试模式'</span>)
  .<span class="hljs-title function_">action</span>(<span class="hljs-function">(<span class="hljs-params">options</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`您订购了一个 <span class="hljs-subst">${options.size}</span> 尺寸的皮萨。`</span>);
  });

program.<span class="hljs-title function_">parse</span>();
</code></pre>
<hr/>
<h2 data-id="heading-4">2. Inquirer.js：CLI 的血肉与交互</h2>
<h3 data-id="heading-5">2.1 核心定位</h3>
<p>Inquirer 是一个交互式命令行用户界面的集合。它的目标是<strong>引导（Guiding）</strong>。当你的程序需要从用户那里获取非预设的、复杂的信息时，Inquirer 提供了丰富的 UI 组件。</p>
<h3 data-id="heading-6">2.2 核心功能特性</h3>
<ul>
<li><strong>多样化输入</strong>：支持 <code>input</code>（文本）、<code>password</code>（遮罩）、<code>confirm</code>（确认）、<code>select</code>（单选）、<code>checkbox</code>（多选）等。</li>
<li><strong>流式对话</strong>：可以根据上一步的回答动态决定下一步提问的内容。</li>
<li><strong>输入校验</strong>：内置 <code>validate</code> 钩子，实时反馈输入错误。</li>
<li><strong>新版优化</strong>：最新版（<code>@inquirer/prompts</code>）采用了更轻量、性能更高的架构，并支持更灵活的异步操作。</li>
</ul>
<h3 data-id="heading-7">2.3 代码示例（基于文档）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { input, select } <span class="hljs-keyword">from</span> <span class="hljs-string">'@inquirer/prompts'</span>;

<span class="hljs-keyword">const</span> name = <span class="hljs-keyword">await</span> <span class="hljs-title function_">input</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入您的名字'</span> });
<span class="hljs-keyword">const</span> color = <span class="hljs-keyword">await</span> <span class="hljs-title function_">select</span>({
  <span class="hljs-attr">message</span>: <span class="hljs-string">'选择你喜欢的颜色'</span>,
  <span class="hljs-attr">choices</span>: [
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'红色'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'red'</span> },
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'蓝色'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'blue'</span> },
  ],
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`你好 <span class="hljs-subst">${name}</span>，你选择了 <span class="hljs-subst">${color}</span>。`</span>);
</code></pre>
<hr/>
<h2 data-id="heading-8">3. 深度对比：相同点与不同点</h2>
<p>为了辅助选型，我们将两者进行多维度的横向对比：</p>



































<table><thead><tr><th align="left">维度</th><th align="left">Commander.js</th><th align="left">Inquirer.js</th></tr></thead><tbody><tr><td align="left"><strong>交互模式</strong></td><td align="left"><strong>静态/声明式</strong>：用户启动前决定一切</td><td align="left"><strong>动态/交互式</strong>：程序运行中实时问答</td></tr><tr><td align="left"><strong>主要职责</strong></td><td align="left">命令解析、版本管理、帮助信息、子命令调度</td><td align="left">收集用户输入、数据校验、流程引导、UI 呈现</td></tr><tr><td align="left"><strong>自动化支持</strong></td><td align="left"><strong>极佳</strong>：完美支持 CI/CD、脚本自动化调用</td><td align="left"><strong>较差</strong>：通常需要人工干预（除非 Mock 标准输入）</td></tr><tr><td align="left"><strong>学习曲线</strong></td><td align="left">低：主要是声明 API 及其回调</td><td align="left">中：需处理异步流程、逻辑分支和校验</td></tr><tr><td align="left"><strong>用户群体</strong></td><td align="left">高级用户（偏向脚本化、快速指令）</td><td align="left">普通用户（偏向配置向导、初始化工具）</td></tr></tbody></table>
<h3 data-id="heading-9">相同点</h3>
<ol>
<li><strong>基础环境</strong>：两者都运行在 Node.js 环境，均对原生 <code>process.stdin</code> 和 <code>process.stdout</code> 进行了高级封装。</li>
<li><strong>社区标准</strong>：它们都是各自领域的“事实标准”，npm 下载量均为千万级。</li>
<li><strong>扩展性</strong>：都支持自定义扩展，Commander 可以自定义配置 Help 类，Inquirer 可以开发自定义 Prompt 插件。</li>
</ol>
<h3 data-id="heading-10">核心区别</h3>
<ul>
<li><strong>触发时机不同</strong>：Commander 关注的是命令启动那一刻的状态；Inquirer 关注的是启动后与用户的持续对话。</li>
<li><strong>CI/CD 友好度不同</strong>：如果你的工具要在服务器脚本（如 Jenkins）中运行，Commander 是必须的，因为它可以通过 Flag（如 <code>--yes</code>）避开人工干预；而 Inquirer 在这种场景下会阻塞进程。</li>
</ul>
<hr/>
<h2 data-id="heading-11">4. 混合选型策略：1 + 1 &gt; 2</h2>
<p>在现代 CLI 开发中，**“Commander 构建骨架 + Inquirer 填充交互”**是最成熟的方案。</p>
<h3 data-id="heading-12">实践案例：脚手架初始化</h3>
<p>想象你要开发一个类似 <code>vue-cli</code> 的工具：</p>
<ol>
<li><strong>使用 Commander 解析指令</strong>：用户输入 <code>my-cli create my-project</code>。</li>
<li><strong>缺省检测</strong>：如果用户没传参数，或者需要进一步配置，则唤起 <strong>Inquirer</strong>。</li>
<li><strong>交互式问答</strong>：询问“是否使用 TypeScript？”、“是否集成 ESLint？”。</li>
<li><strong>结果合并</strong>：将 Commander 解析的初始参数与 Inquirer 收集的配置合并，最后执行文件创建任务。</li>
</ol>
<hr/>
<h2 data-id="heading-13">5. 结论与行动建议</h2>
<p>针对你的技术选型，我给出以下结论：</p>
<ol>
<li><strong>如果你的工具主要用于自动化脚本、数据处理或拥有大量复杂参数</strong>：请优先确保 <strong>Commander</strong> 的稳健实现。它能让你的工具像 <code>ls</code> 或 <code>git</code> 一样专业且易于集成。</li>
<li><strong>如果你的工具主要面向初级用户，或者涉及复杂的初始化配置（如脚手架、安装向导）</strong>：<strong>Inquirer</strong>（推荐使用新版 <code>@inquirer/prompts</code>）将极大提升用户体验。</li>
<li><strong>行动建议</strong>：
<ul>
<li><strong>立即可做</strong>：定义你的 CLI 核心命令结构，使用 Commander 建立第一个 <code>--help</code>。</li>
<li><strong>中期计划</strong>：识别用户容易输错或难以记忆的复杂参数，将其转化为 Inquirer 的交互式问答流程。</li>
</ul>
</li>
</ol>
<hr/>
<p><strong>参考来源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSBoudrias%2FInquirer.js" target="_blank" title="https://github.com/SBoudrias/Inquirer.js" ref="nofollow noopener noreferrer">Inquirer.js GitHub Repository</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftj%2Fcommander.js" target="_blank" title="https://github.com/tj/commander.js" ref="nofollow noopener noreferrer">Commander.js GitHub Repository</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最强Kimi K2.5 真能做到一句话开发一个应用 - 3分钟简单上手体验]]></title>    <link>https://juejin.cn/post/7600318091832197147</link>    <guid>https://juejin.cn/post/7600318091832197147</guid>    <pubDate>2026-01-29T06:24:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600318091832197147" data-draft-id="7600508556124143667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最强Kimi K2.5 真能做到一句话开发一个应用 - 3分钟简单上手体验"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-29T06:24:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最强Kimi K2.5 真能做到一句话开发一个应用 - 3分钟简单上手体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:24:06.000Z" title="Thu Jan 29 2026 06:24:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">最强Kimi K2.5 真能做到一句话开发一个应用 - 3分钟简单上手体验</h2>
<blockquote>
<p><strong>万少：华为HDE、鸿蒙极客、个人独立开发者</strong></p>
<p>个人主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.zbztb.cn%2F" target="_blank" title="https://blog.zbztb.cn/" ref="nofollow noopener noreferrer">blog.zbztb.cn/</a></p>
<p><strong>2025年参与孵化了20+鸿蒙应用、技术文章300+、鸿蒙知识库用户500+、鸿蒙免费课程2套。</strong></p>
<p>如果你也喜欢交流AI和鸿蒙技术，欢迎扣我。</p>
</blockquote>
<h3 data-id="heading-1">1月27日</h3>
<p>月之暗面 在1月27日 推出号称<strong>迄今为止最强大的开源模型</strong> 《<strong>Kimi K2.5</strong>》</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f683a8e85dc4ae1b704eae61d02e2c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=src4GufReTjAsuclocHIl8hBwv4%3D" alt="图片" loading="lazy"/></p>
<p>Kimi K2.5 基于 <strong>Kimi K2</strong> 构建，通过约 <strong>15T</strong> 混合视觉和文本 <strong>token</strong> 的持续预训练。</p>
<p>作为原生多模态模型，K2.5 提供了最先进的编码和视觉能力，以及自导向的代理群范式。</p>
<p>对于复杂任务，<strong>Kimi K2.5 可以自导向一个最多包含 100 个子代理的代理群，执行跨越最多 1,500 个工具调用的并行工作流</strong>。</p>
<p>与单代理设置相比，<strong>这可将执行时间缩短高达 4.5 倍</strong>。</p>
<p>代理群由 Kimi K2.5 自动创建和编排，无需任何预定义的子代理或工作流。</p>
<hr/>
<p>100多个子代理，这不就是一堆专家围着你转了吗？</p>
<p>想象一个场景:</p>
<p>你进到了饭店点一盘<strong>鱼香肉丝</strong>：</p>
<ol>
<li><strong>有农业专家帮你选择最好的食材</strong></li>
<li><strong>有营养专家帮你搭配最合适的食材比例</strong></li>
<li><strong>有大厨师帮你烹饪最美味的食物</strong></li>
<li><strong>有艺术家帮你做最精美的摆盘</strong></li>
<li><strong>有音乐家帮你在旁边奏乐</strong></li>
<li>。。。</li>
</ol>
<p>还有很多专家围绕你的需求去服务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb85d327c3d24a89838552514162c0b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=0AO9GMrEgsry9G4xpcxiYAKLkfE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">能力对比</h3>
<p>Kimi K2.5 可通过 Kimi.com、Kimi App、API 和 Kimi Code 获取。</p>
<p>Kimi.com &amp; Kimi App 现在支持 4 种模式：K2.5 即时模式、K2.5 思考模式、K2.5 代理模式和 K2.5 代理群（Beta 版）。</p>
<p>代理群目前在 Kimi.com 上处于 Beta 测试阶段，高等级付费用户可免费使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f0650a3cb2c463b9669a78694f8b6fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=r1nqMGNfolzn%2BkF2ACT5Qj4mznc%3D" alt="图片" loading="lazy"/></p>
<p>可以看到和国外顶尖的大模型相比也是毫不逊色。</p>
<h3 data-id="heading-3">如何体验</h3>
<p>大家如果想要简单体验一下，可以使用腾讯的<strong>CodeBuddy CN</strong>，它已经内置了K2.5模型，可以通过AI编辑器简单感受一下编程的能力。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcopilot.tencent.com%2Fpromotion%2F%3Fref%3Dvlt2x31eyhp8a1" target="_blank" title="https://copilot.tencent.com/promotion/?ref=vlt2x31eyhp8a1" ref="nofollow noopener noreferrer">copilot.tencent.com/promotion/?…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c40be741e4d34c3ab9d986cc82cf1dac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=lRs%2Btuew3hCtxRE1SvYE%2BPtkbZc%3D" alt="图片" loading="lazy"/></p>
<p>如果想要感受 100个代理（牛马）给你服务的感觉，你可以在Kimi官网上去体验一下。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2Fagent-swarm" target="_blank" title="https://www.kimi.com/agent-swarm" ref="nofollow noopener noreferrer">www.kimi.com/agent-swarm</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51575b805d94fb688d63c3dd6ee6daa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=qmfIxPctWgf1Vr453HPetzEFS%2Bg%3D" alt="图片" loading="lazy"/></p>
<p>目前新业务营业大酬宾 ￥4.99 可以享受7天的使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb3c6cec33d34e40a6f2a5795a18e35b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=cJzHM6tGgy7uMo9kkKR9G6Au5lA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-4">一句话生成应用</h3>
<p>回到<strong>CodeBuddy CN</strong>编辑器内，打开对话框，输入以下提示词：</p>
<blockquote>
<p>帮我做一个单机版本的 HarmonyOS应用单机唯美风格，主题是 时光心情簿。</p>
<p>1首屏上是 4个tab，分别是首页-记录-统计-我的 1 首页是一个透明有边框的存钱罐，点击不同的心情图标可以往存钱罐里面存图标，图标下落要有动画效果，存钱罐在瓶子里也有有真实的碰撞效果</p>
<p>2 记录页面是一个可以根据日历来添加心情状态的页面，接受上传最多3章图片</p>
<p>3 统计使用好看的图标技术，可以实现按照年、月、日、不同的心情种类开始统计</p>
<p>4 我的 页面提供常见的一些功能，比如设置风格、字体大小、震动等等 所有页面设计都要有好看的过渡动画，一些页面也可以加入你找到的免费的背景图</p>
</blockquote>
<p><strong>CodeBuddy CN</strong>会帮我制定计划，确认无误后，开始干活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59433c7a19f5480ab72e1283c55e1639~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=%2F099NrmsU6rSTJVlUbq7QFtBhO4%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-5">最终效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3407d10915c0410f8503306c3c01089c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770272645&amp;x-signature=QxHOjog9Dgnkig69%2BFb1Iu7sBxs%3D" alt="图片" loading="lazy"/></p>
<p>可以看到，<strong>UI 效果整体还是不错的</strong>，功能是还存在需要仔细调整的部分。</p>
<p>但是这个可是生成<strong>HarmonyOS 鸿蒙应用</strong>呀，</p>
<p>不是传统的安卓和 iOS，很多AI编辑器做鸿蒙开发还处在语法都不过关的时代！</p>
<hr/>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2Fblog%2Fkimi-k2-5.html" target="_blank" title="https://www.kimi.com/blog/kimi-k2-5.html" ref="nofollow noopener noreferrer">www.kimi.com/blog/kimi-k…</a></p>
<h3 data-id="heading-6">关注我</h3>
<p><strong>关注我</strong>，持续分享鸿蒙开发 + AI 提效的实战技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[断网、弱网、关页都不怕：前端日志上报怎么做到不丢包 | 掘金一周 1.29]]></title>    <link>https://juejin.cn/post/7600345782173466658</link>    <guid>https://juejin.cn/post/7600345782173466658</guid>    <pubDate>2026-01-29T06:43:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600345782173466658" data-draft-id="7600326947505946676" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="断网、弱网、关页都不怕：前端日志上报怎么做到不丢包 | 掘金一周 1.29"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T06:43:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金一周"/> <meta itemprop="url" content="https://juejin.cn/user/53218623894222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            断网、弱网、关页都不怕：前端日志上报怎么做到不丢包 | 掘金一周 1.29
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/53218623894222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金一周
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:43:08.000Z" title="Thu Jan 29 2026 06:43:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>本文字数1600+ ，阅读时间大约需要 5分钟。</em></p>
<blockquote>
<p>【掘金一周】本期亮点：</p>
</blockquote>
<ul>
<li>
<p><a href="https://juejin.cn/post/7596247009815412762" target="_blank" title="https://juejin.cn/post/7596247009815412762">断网、弱网、关页都不怕：前端日志上报怎么做到不丢包</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7596932640727056419" target="_blank" title="https://juejin.cn/post/7596932640727056419">AI辅助研发的落地实践：工具、效率与成长</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7596926832912498751" target="_blank" title="https://juejin.cn/post/7596926832912498751">还在无脑 .map().filter()？实测改用 Iterator Helpers 后，内存占用降低了 99%</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7597278451030294538" target="_blank" title="https://juejin.cn/post/7597278451030294538">一个月搞定100+表迁移：我的“偷师”Navicat实战复盘</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7596245612558319625" target="_blank" title="https://juejin.cn/post/7596245612558319625">Flutter 又迎大坑修改？iOS 26 键盘变化可能带来大量底层改动</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7598390354292621358" target="_blank" title="https://juejin.cn/post/7598390354292621358">Jetpack Compose重组稳定性分析器</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7597776334065516596" target="_blank" title="https://juejin.cn/post/7597776334065516596">Agent Skills在货拉拉AI应用尝试</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7596478936387108906" target="_blank" title="https://juejin.cn/post/7596478936387108906">从0开发大模型之实现Agent（Bash 到 SKILL）</a></p>
</li>
</ul>
<blockquote>
<p><strong>「上榜规则」</strong>：文章发布时间在本期「掘金一周」发布时间的前一周内；且符合各个栏目的内容定位和要求。 如发现文章有抄袭、洗稿等违反社区规则的行为，将取消当期及后续上榜资格。</p>
</blockquote>
<h2 data-id="heading-0">一周“金”选</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73d5bf990a124e3a87cffb06443ad9ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5LiA5ZGo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770273787&amp;x-signature=1xpz0ksz%2BLPwxKfHLV%2BRgtwKPjE%3D" alt="掘金一周 文章头图 1303x734.jpg" loading="lazy"/></p>
<p><em>内容评审们会在过去的一周内对社区深度技术好文进行挖掘和筛选，优质的技术文章有机会出现在下方榜单中，排名不分先后。</em></p>
<h3 data-id="heading-1">前端</h3>
<p><a href="https://juejin.cn/post/7596247009815412762" target="_blank" title="https://juejin.cn/post/7596247009815412762">断网、弱网、关页都不怕：前端日志上报怎么做到不丢包</a> <a href="https://juejin.cn/user/3035079961218551/posts" target="_blank" title="https://juejin.cn/user/3035079961218551/posts">@不一样的少年_</a></p>
<blockquote>
<p>我们用一个数组（<code>queue</code>）来暂存日志，然后通过  <strong>“量够了”、“时间到了”或“页面要关了”</strong>  这三个时机来触发发送，确保既不积压也不频繁打扰服务器。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7596932640727056419" target="_blank" title="https://juejin.cn/post/7596932640727056419">AI辅助研发的落地实践：工具、效率与成长</a> <a href="https://juejin.cn/user/3456520257288974/posts" target="_blank" title="https://juejin.cn/user/3456520257288974/posts">@政采云技术</a></p>
<blockquote>
<p>从整体来看，AI 辅助研发并不是简单的“用 AI 写代码”，而是一种<strong>分工明确、责任清晰的人机协作模式</strong>：   AI 擅长发散、整理、生成；人类擅长判断、取舍、收敛。当二者边界清晰、职责明确时，AI 才能真正成为研发效率的放大器，而不是新的复杂度来源。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7596926832912498751" target="_blank" title="https://juejin.cn/post/7596926832912498751">还在无脑 .map().filter()？实测改用 Iterator Helpers 后，内存占用降低了 99%</a> <a href="https://juejin.cn/user/2175258804632332/posts" target="_blank" title="https://juejin.cn/user/2175258804632332/posts">@也无风雨也雾晴</a></p>
<blockquote>
<p>Iterator Helpers 是 JavaScript 新加的特性，提供了一套"惰性求值"（lazy evaluation）的方法。关键区别是：<strong>传统数组方法</strong>，每一步都立即执行，创建中间数组；<strong>Iterator Helpers</strong>，只描述要做什么，真正需要数据时才执行。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7596970073750552612" target="_blank" title="https://juejin.cn/post/7596970073750552612">前端指纹技术是如何实现的？（Canvas、Audio、硬件API 核心原理解密）</a> <a href="https://juejin.cn/user/3878732754331096/posts" target="_blank" title="https://juejin.cn/user/3878732754331096/posts">@ErpanOmer</a></p>
<blockquote>
<p>所谓的前端指纹技术，本质上就是<strong>找不同</strong>的一种方式。开发者利用一切可以调用的 API（Canvas, Audio, WebGL, 硬件信息），强迫浏览器进行某种复杂的运算。由于硬件和驱动的细微差别，运算结果必然存在差异。这些差异被收集起来，生成了一个字符串。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7597314244269228086" target="_blank" title="https://juejin.cn/post/7597314244269228086">从痛点到架构：用 Chrome DevTools Panel 做埋点校验，我是怎么落地的</a> <a href="https://juejin.cn/user/606586148237431/posts" target="_blank" title="https://juejin.cn/user/606586148237431/posts">@转转技术团队</a></p>
<blockquote>
<p>Chrome MV3 是一堵墙，但技术不仅能砌墙，也能架桥。 通过对底层原理的深入挖掘，我们证明了即使在最严格的安全限制下，依然可以打造出极致的开发者工具。 希望本文能给你带来两方面的收获：一是关于 Chrome 插件开发的硬核知识，二是一种“不凑合、不妥协”的极客精神。</p>
</blockquote>
<h3 data-id="heading-2">后端</h3>
<p><a href="https://juejin.cn/post/7597278451030294538" target="_blank" title="https://juejin.cn/post/7597278451030294538">一个月搞定100+表迁移：我的“偷师”Navicat实战复盘</a> <a href="https://juejin.cn/user/3485898277388519/posts" target="_blank" title="https://juejin.cn/user/3485898277388519/posts">@一旅人</a></p>
<blockquote>
<p>100+张表，每张表的字段、类型、主键都不一样。传统MyBatis方式意味着要写100+个Mapper、100+个实体类。后续新增表还得继续写，<strong>代码复用度≈0</strong>。</p>
</blockquote>
<h3 data-id="heading-3">Android</h3>
<p><a href="https://juejin.cn/post/7596245612558319625" target="_blank" title="https://juejin.cn/post/7596245612558319625">Flutter 又迎大坑修改？iOS 26 键盘变化可能带来大量底层改动</a> <a href="https://juejin.cn/user/817692379985752/posts" target="_blank" title="https://juejin.cn/user/817692379985752/posts">@恋猫de小郭</a></p>
<blockquote>
<p>虽然问题看起来是一个圆角问题，但是实际上这是 <strong>iOS 26 系统键盘增加了“半透明”后带来的问题，Flutter 在键盘后面那一层在某些场景下没有正确渲染内容</strong>，导致键盘半透明区域透出来的不是底下 BottomSheet 的真实内容，而是一整块黑色区域。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7597900782910685203" target="_blank" title="https://juejin.cn/post/7597900782910685203">Android Gradle Plugin 9.0 发布，为什么这会是个史诗级大坑版本</a> <a href="https://juejin.cn/user/817692379985752/posts" target="_blank" title="https://juejin.cn/user/817692379985752/posts">@恋猫de小郭</a></p>
<blockquote>
<p>AGP 9.0 开始<strong>只暴露新的 public DSL interfaces</strong>，旧的 DSL 类型（比如历史上很多插件/脚本会强转到 <code>BaseExtension</code> 之类）不再提供，并且<strong>旧的 variant API（<code>applicationVariants</code> 等）也一起被切断</strong>，要迁移到 <code>androidComponents</code> API。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7598390354292621358" target="_blank" title="https://juejin.cn/post/7598390354292621358">Jetpack Compose重组稳定性分析器</a> <a href="https://juejin.cn/user/2788017216685784/posts" target="_blank" title="https://juejin.cn/user/2788017216685784/posts">@稀有猿诉</a></p>
<blockquote>
<p>本文将探讨 Compose 稳定性分析器的工作原理，包括：IntelliJ 插件（为你的 IDE 提供可视化的稳定性指示器）、编译器插件（启用运行时重组跟踪）以及稳定性验证系统（防止回归问题影响生产环境）。</p>
</blockquote>
<h3 data-id="heading-4">人工智能</h3>
<p><a href="https://juejin.cn/post/7597776334065516596" target="_blank" title="https://juejin.cn/post/7597776334065516596">Agent Skills在货拉拉AI应用尝试</a> <a href="https://juejin.cn/user/1768489241815070/posts" target="_blank" title="https://juejin.cn/user/1768489241815070/posts">@货拉拉技术</a></p>
<blockquote>
<p><strong>渐进式披露</strong>是Agent技能设计中的核心原则，它让智能体的技能体系既<strong>灵活又可扩展</strong>。就像一本结构清晰的说明书，先给目录，再分章节，最后附上详细附录——技能的设计也是如此，让Claude<strong>只在需要时</strong>才加载对应的信息。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7596478936387108906" target="_blank" title="https://juejin.cn/post/7596478936387108906">从0开发大模型之实现Agent（Bash 到 SKILL）</a> <a href="https://juejin.cn/user/3245414056989757/posts" target="_blank" title="https://juejin.cn/user/3245414056989757/posts">@周末程序猿</a></p>
<blockquote>
<p>模型、工具、指令三者构成了 <code>AI Agent</code> 的下限和上限，模型越强，对于指令和工具的调度能力更准确，但是从工程学的角度来考虑，较弱的模型通过对工具和指令的结合，一样能制造功能强大的 <code>Agent</code>。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7596926832913055807" target="_blank" title="https://juejin.cn/post/7596926832913055807">2026 最新 Claude Skills 保姆级教程及实践！</a> <a href="https://juejin.cn/user/588993963763405/posts" target="_blank" title="https://juejin.cn/user/588993963763405/posts">@苍何</a></p>
<blockquote>
<p>Skills 改变了我们与 AI 协作的基本方式。它们将一次性的提示，转变为持久、可组合的知识资产。通过为 AI 建立一个可扩展的程序性记忆库，Skills 正在为下一代代更强大、更自主、更能与人类专家无缝协作的 AI Agent 奠定基础。</p>
</blockquote>
<h2 data-id="heading-5">📖 投稿专区</h2>
<blockquote>
<p>大家可以在评论区推荐认为不错的文章，并附上链接和推荐理由，有机会呈现在下一期。文章创建日期必须在下期掘金一周发布前一周以内；可以推荐自己的文章、也可以推荐他人的文章。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浅出FastAPI：现代Python Web开发的利器]]></title>    <link>https://juejin.cn/post/7600333405979410473</link>    <guid>https://juejin.cn/post/7600333405979410473</guid>    <pubDate>2026-01-29T05:43:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600333405979410473" data-draft-id="7600491179499094070" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浅出FastAPI：现代Python Web开发的利器"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2026-01-29T05:43:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="诸神缄默不语"/> <meta itemprop="url" content="https://juejin.cn/user/2036746568087502"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浅出FastAPI：现代Python Web开发的利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2036746568087502/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    诸神缄默不语
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:43:31.000Z" title="Thu Jan 29 2026 05:43:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FPolarisRisingWar%2Farticle%2Fdetails%2F116396744" target="_blank" title="https://blog.csdn.net/PolarisRisingWar/article/details/116396744" ref="nofollow noopener noreferrer">诸神缄默不语-个人技术博文与视频目录</a></p>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffastapi.tiangolo.com%2F" target="_blank" title="https://fastapi.tiangolo.com/" ref="nofollow noopener noreferrer">FastAPI</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpypi.org%2Fproject%2Ffastapi%2F" target="_blank" title="https://pypi.org/project/fastapi/" ref="nofollow noopener noreferrer">fastapi · PyPI</a></p>
<blockquote>
<p>还在为Python Web开发的速度和性能发愁？FastAPI或许是你一直在寻找的解决方案！</p>
</blockquote>
<h2 data-id="heading-0">什么是FastAPI？</h2>
<p>FastAPI是一个现代、快速（高性能）的Python Web框架，专门用于构建API。它基于标准Python类型提示，使用Python 3.6+版本的类型提示特性，让API开发变得简单而强大。</p>
<h2 data-id="heading-1">FastAPI的核心优势</h2>
<ul>
<li>⚡ <strong>极快的性能</strong>：与NodeJS和Go相当，是Python领域最快的框架之一</li>
<li>🚀 <strong>高效的编码</strong>：开发速度提升约200%-300%</li>
<li>📝 <strong>更少的bug</strong>：减少约40%的人为错误</li>
<li>💡 <strong>直观的API</strong>：强大的编辑器支持，自动补全无处不在</li>
<li>📚 <strong>完整的标准</strong>：基于并完全兼容开放的API标准（OpenAPI和JSON Schema）</li>
</ul>
<h2 data-id="heading-2">安装FastAPI</h2>
<pre><code class="hljs language-bash" lang="bash">pip install <span class="hljs-string">"fastapi[standard]"</span>
</code></pre>
<h2 data-id="heading-3">第一个FastAPI应用</h2>
<p>让我们从一个简单的"Hello World"开始：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI

<span class="hljs-comment"># 创建FastAPI实例</span>
app = FastAPI()

<span class="hljs-comment"># 定义根路径的路由</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_root</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Hello World"</span>}

<span class="hljs-comment"># 带路径参数的路由</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items/{item_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span>, q: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"item_id"</span>: item_id, <span class="hljs-string">"q"</span>: q}
</code></pre>
<p>保存为 <code>try1.py</code>，然后运行：</p>
<pre><code class="hljs language-bash" lang="bash">python -m uvicorn try1:app --reload
</code></pre>
<p>访问 <code>http://127.0.0.1:8000</code>，你将看到JSON响应：<code>{"message": "Hello World"}</code></p>
<p>uvicorn也可以使用Python脚本运行：
创建一个 try2.py 文件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> uvicorn

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    uvicorn.run(<span class="hljs-string">"try1:app"</span>, host=<span class="hljs-string">"127.0.0.1"</span>, port=<span class="hljs-number">8000</span>, reload=<span class="hljs-literal">True</span>)
</code></pre>
<p>然后运行：</p>
<pre><code class="hljs">python try2.py
</code></pre>
<h2 data-id="heading-4">自动API文档</h2>
<p>FastAPI最酷的特性之一就是自动生成交互式API文档！</p>
<ul>
<li><strong>Swagger UI</strong>: <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8000%2Fdocs" target="_blank" title="http://127.0.0.1:8000/docs" ref="nofollow noopener noreferrer">http://127.0.0.1:8000/docs</a></li>
<li><strong>ReDoc</strong>: <a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8000%2Fredoc" target="_blank" title="http://127.0.0.1:8000/redoc" ref="nofollow noopener noreferrer">http://127.0.0.1:8000/redoc</a></li>
</ul>
<p>这些文档是完全交互的，你可以直接在浏览器中测试API！</p>
<p>由于网络问题，可能打开后无法显示内容，可以在F12中看到需要从外网下js：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86cb9cd4da764d13b49aac0e550f66bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-456We57yE6buY5LiN6K-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270213&amp;x-signature=Ttyazsag8IeoNOtuuY0vjM6c7SI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-5">深入FastAPI特性</h2>
<h3 data-id="heading-6">1. 类型提示和数据验证</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel

<span class="hljs-comment"># 定义数据模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    description: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
    price: <span class="hljs-built_in">float</span>
    tax: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">float</span>] = <span class="hljs-literal">None</span>

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/items/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_item</span>(<span class="hljs-params">item: Item</span>):
    item_dict = item.<span class="hljs-built_in">dict</span>()
    <span class="hljs-keyword">if</span> item.tax:
        price_with_tax = item.price + item.tax
        item_dict.update({<span class="hljs-string">"price_with_tax"</span>: price_with_tax})
    <span class="hljs-keyword">return</span> item_dict
</code></pre>
<h3 data-id="heading-7">2. 路径参数和查询参数</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelName</span>(<span class="hljs-built_in">str</span>, Enum):
    alexnet = <span class="hljs-string">"alexnet"</span>
    resnet = <span class="hljs-string">"resnet"</span>
    lenet = <span class="hljs-string">"lenet"</span>

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/models/{model_name}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_model</span>(<span class="hljs-params">model_name: ModelName</span>):
    <span class="hljs-keyword">if</span> model_name == ModelName.alexnet:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"model_name"</span>: model_name, <span class="hljs-string">"message"</span>: <span class="hljs-string">"Deep Learning FTW!"</span>}
    
    <span class="hljs-keyword">if</span> model_name.value == <span class="hljs-string">"lenet"</span>:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"model_name"</span>: model_name, <span class="hljs-string">"message"</span>: <span class="hljs-string">"LeCNN all the images"</span>}
    
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"model_name"</span>: model_name, <span class="hljs-string">"message"</span>: <span class="hljs-string">"Have some residuals"</span>}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/users/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_users</span>(<span class="hljs-params">skip: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>, limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>, q: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span></span>):
    <span class="hljs-comment"># 模拟从数据库获取用户</span>
    users = [{<span class="hljs-string">"id"</span>: i, <span class="hljs-string">"name"</span>: <span class="hljs-string">f"User <span class="hljs-subst">{i}</span>"</span>} <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>)]
    
    <span class="hljs-keyword">if</span> q:
        users = [user <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> users <span class="hljs-keyword">if</span> q.lower() <span class="hljs-keyword">in</span> user[<span class="hljs-string">"name"</span>].lower()]
    
    <span class="hljs-keyword">return</span> users[skip: skip + limit]
</code></pre>
<h3 data-id="heading-8">3. 请求体和复杂数据模型</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span>
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"John Doe"</span>
    signup_ts: <span class="hljs-type">Optional</span>[datetime] = <span class="hljs-literal">None</span>
    friends: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>] = []

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ComplexData</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    user: User
    items: <span class="hljs-type">List</span>[Item]

<span class="hljs-meta">@app.put(<span class="hljs-params"><span class="hljs-string">"/complex-data/{data_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_complex_data</span>(<span class="hljs-params">data_id: <span class="hljs-built_in">int</span>, data: ComplexData</span>):
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"data_id"</span>: data_id,
        <span class="hljs-string">"data"</span>: data.<span class="hljs-built_in">dict</span>(),
        <span class="hljs-string">"received_at"</span>: datetime.now()
    }
</code></pre>
<h3 data-id="heading-9">4. 依赖注入系统</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Depends, HTTPException, status

<span class="hljs-comment"># 简单的依赖</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">common_parameters</span>(<span class="hljs-params">
    skip: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>, 
    limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">100</span>,
    q: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"skip"</span>: skip, <span class="hljs-string">"limit"</span>: limit, <span class="hljs-string">"q"</span>: q}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_items</span>(<span class="hljs-params">commons: <span class="hljs-built_in">dict</span> = Depends(<span class="hljs-params">common_parameters</span>)</span>):
    <span class="hljs-keyword">return</span> commons

<span class="hljs-comment"># 更复杂的依赖注入示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Database</span>:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user</span>(<span class="hljs-params">self, user_id: <span class="hljs-built_in">int</span></span>):
        <span class="hljs-comment"># 模拟数据库查询</span>
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"user_id"</span>: user_id, <span class="hljs-string">"name"</span>: <span class="hljs-string">f"User <span class="hljs-subst">{user_id}</span>"</span>}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database</span>():
    <span class="hljs-keyword">return</span> Database()

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_current_user</span>(<span class="hljs-params">
    user_id: <span class="hljs-built_in">int</span>, 
    db: Database = Depends(<span class="hljs-params">get_database</span>)
</span>):
    user = <span class="hljs-keyword">await</span> db.get_user(user_id)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"User not found"</span>)
    <span class="hljs-keyword">return</span> user

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/users/me"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_current_user</span>(<span class="hljs-params">current_user: <span class="hljs-built_in">dict</span> = Depends(<span class="hljs-params">get_current_user</span>)</span>):
    <span class="hljs-keyword">return</span> current_user
</code></pre>
<h3 data-id="heading-10">5. 错误处理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> HTTPException
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> JSONResponse

<span class="hljs-comment"># 自定义异常处理器</span>
<span class="hljs-meta">@app.exception_handler(<span class="hljs-params">HTTPException</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">http_exception_handler</span>(<span class="hljs-params">request, exc</span>):
    <span class="hljs-keyword">return</span> JSONResponse(
        status_code=exc.status_code,
        content={<span class="hljs-string">"message"</span>: exc.detail, <span class="hljs-string">"error"</span>: <span class="hljs-literal">True</span>}
    )

<span class="hljs-comment"># 抛出HTTP异常</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/protected-route"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">protected_route</span>(<span class="hljs-params">token: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> token <span class="hljs-keyword">or</span> token != <span class="hljs-string">"secret-token"</span>:
        <span class="hljs-keyword">raise</span> HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=<span class="hljs-string">"Invalid authentication credentials"</span>,
            headers={<span class="hljs-string">"WWW-Authenticate"</span>: <span class="hljs-string">"Bearer"</span>},
        )
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Access granted"</span>}
</code></pre>
<h3 data-id="heading-11">6. 中间件和CORS</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi.middleware.cors <span class="hljs-keyword">import</span> CORSMiddleware
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 添加CORS中间件</span>
app.add_middleware(
    CORSMiddleware,
    allow_origins=[<span class="hljs-string">"*"</span>],  <span class="hljs-comment"># 生产环境中应该指定具体域名</span>
    allow_credentials=<span class="hljs-literal">True</span>,
    allow_methods=[<span class="hljs-string">"*"</span>],
    allow_headers=[<span class="hljs-string">"*"</span>],
)

<span class="hljs-comment"># 自定义中间件：添加处理时间头</span>
<span class="hljs-meta">@app.middleware(<span class="hljs-params"><span class="hljs-string">"http"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_process_time_header</span>(<span class="hljs-params">request, call_next</span>):
    start_time = time.time()
    response = <span class="hljs-keyword">await</span> call_next(request)
    process_time = time.time() - start_time
    response.headers[<span class="hljs-string">"X-Process-Time"</span>] = <span class="hljs-built_in">str</span>(process_time)
    <span class="hljs-keyword">return</span> response
</code></pre>
<h2 data-id="heading-12">完整示例：待办事项API</h2>
<p>让我们构建一个完整的待办事项管理API：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, HTTPException, Depends
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>
<span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> UUID, uuid4

app = FastAPI(title=<span class="hljs-string">"Todo API"</span>, version=<span class="hljs-string">"1.0.0"</span>)

<span class="hljs-comment"># 数据模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoItem</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-type">Optional</span>[UUID] = <span class="hljs-literal">None</span>
    title: <span class="hljs-built_in">str</span>
    description: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
    completed: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>

<span class="hljs-comment"># 模拟数据库</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoDB</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.todos: <span class="hljs-type">List</span>[TodoItem] = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[TodoItem]:
        <span class="hljs-keyword">return</span> self.todos
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, todo_id: UUID</span>) -&gt; <span class="hljs-type">Optional</span>[TodoItem]:
        <span class="hljs-keyword">for</span> todo <span class="hljs-keyword">in</span> self.todos:
            <span class="hljs-keyword">if</span> todo.<span class="hljs-built_in">id</span> == todo_id:
                <span class="hljs-keyword">return</span> todo
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">self, todo: TodoItem</span>) -&gt; TodoItem:
        todo.<span class="hljs-built_in">id</span> = uuid4()
        self.todos.append(todo)
        <span class="hljs-keyword">return</span> todo
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, todo_id: UUID, updated_todo: TodoItem</span>) -&gt; <span class="hljs-type">Optional</span>[TodoItem]:
        <span class="hljs-keyword">for</span> idx, todo <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(self.todos):
            <span class="hljs-keyword">if</span> todo.<span class="hljs-built_in">id</span> == todo_id:
                updated_todo.<span class="hljs-built_in">id</span> = todo_id
                self.todos[idx] = updated_todo
                <span class="hljs-keyword">return</span> updated_todo
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">self, todo_id: UUID</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">for</span> idx, todo <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(self.todos):
            <span class="hljs-keyword">if</span> todo.<span class="hljs-built_in">id</span> == todo_id:
                <span class="hljs-keyword">del</span> self.todos[idx]
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-comment"># 依赖注入</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db</span>():
    <span class="hljs-keyword">return</span> TodoDB()

<span class="hljs-comment"># API路由</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/todos"</span>, response_model=<span class="hljs-type">List</span>[TodoItem]</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_todos</span>(<span class="hljs-params">db: TodoDB = Depends(<span class="hljs-params">get_db</span>)</span>):
    <span class="hljs-keyword">return</span> db.get_all()

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/todos/{todo_id}"</span>, response_model=TodoItem</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_todo</span>(<span class="hljs-params">todo_id: UUID, db: TodoDB = Depends(<span class="hljs-params">get_db</span>)</span>):
    todo = db.get(todo_id)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> todo:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"Todo not found"</span>)
    <span class="hljs-keyword">return</span> todo

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/todos"</span>, response_model=TodoItem</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_todo</span>(<span class="hljs-params">todo: TodoItem, db: TodoDB = Depends(<span class="hljs-params">get_db</span>)</span>):
    <span class="hljs-keyword">return</span> db.create(todo)

<span class="hljs-meta">@app.put(<span class="hljs-params"><span class="hljs-string">"/todos/{todo_id}"</span>, response_model=TodoItem</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_todo</span>(<span class="hljs-params">todo_id: UUID, updated_todo: TodoItem, db: TodoDB = Depends(<span class="hljs-params">get_db</span>)</span>):
    todo = db.update(todo_id, updated_todo)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> todo:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"Todo not found"</span>)
    <span class="hljs-keyword">return</span> todo

<span class="hljs-meta">@app.delete(<span class="hljs-params"><span class="hljs-string">"/todos/{todo_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_todo</span>(<span class="hljs-params">todo_id: UUID, db: TodoDB = Depends(<span class="hljs-params">get_db</span>)</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> db.delete(todo_id):
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"Todo not found"</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Todo deleted successfully"</span>}
</code></pre>
<h2 data-id="heading-13">部署FastAPI应用</h2>
<p>使用Uvicorn部署：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开发环境（带热重载）</span>
uvicorn main:app --reload --host 0.0.0.0 --port 8000

<span class="hljs-comment"># 生产环境</span>
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
</code></pre>
<p>使用Docker + uvicorn部署：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM python:3.9

WORKDIR /code

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "80"]
</code></pre>
<h2 data-id="heading-14">常见bug</h2>
<ol>
<li><kbd>Ctrl+C</kbd>无法关闭进程，无法返回终端prompt
如果运行<code>uv run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload</code>就无法正常关闭，只能用Python脚本来运行。就直接在入口脚本（<code>uvicorn.run()</code>的脚本）上直接加：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">receive_signal</span>(<span class="hljs-params">signalNumber, frame</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'\nReceived signal:'</span>, signalNumber)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'正在关闭FastAPI服务...'</span>)
    <span class="hljs-comment"># 强制退出，不等待子进程</span>
    os._exit(<span class="hljs-number">0</span>)

<span class="hljs-comment"># 注册信号处理</span>
signal.signal(signal.SIGINT, receive_signal)  <span class="hljs-comment"># 处理Ctrl+C</span>
signal.signal(signal.SIGTERM, receive_signal)  <span class="hljs-comment"># 处理终止信号</span>
</code></pre>
参考资料：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F74116435" target="_blank" title="https://stackoverflow.com/questions/74116435" ref="nofollow noopener noreferrer">stackoverflow.com/questions/7…</a></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f59d79eb36e242dab687d0ea1a7b688d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-456We57yE6buY5LiN6K-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270213&amp;x-signature=J6KVu0ebYtI2Stc%2FUUaEtlgCmvg%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 震惊！GaussDB事务中断后拒绝执行后续操作]]></title>    <link>https://juejin.cn/post/7600341731047129123</link>    <guid>https://juejin.cn/post/7600341731047129123</guid>    <pubDate>2026-01-29T05:58:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600341731047129123" data-draft-id="7600341731047096355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 震惊！GaussDB事务中断后拒绝执行后续操作"/> <meta itemprop="keywords" content="Java,数据库"/> <meta itemprop="datePublished" content="2026-01-29T05:58:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户903846366581"/> <meta itemprop="url" content="https://juejin.cn/user/1602415871147403"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 震惊！GaussDB事务中断后拒绝执行后续操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1602415871147403/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户903846366581
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:58:55.000Z" title="Thu Jan 29 2026 05:58:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">震惊！GaussDB事务中断后拒绝执行后续操作，你的Java程序可能正面临巨大风险！</h2>
<h3 data-id="heading-1">1. 生产问题引出：<code>current transaction is aborted, commands ignored until end of transaction block</code></h3>
<p>在生产环境中，抓取到这样的错误信息：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">org.postgresql.util.PSQLException: <span class="hljs-keyword">ERROR</span>: current transaction <span class="hljs-built_in">is</span> aborted, commands ignored <span class="hljs-keyword">until</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">of</span> transaction block
</code></pre>
<p>找开发，人家反馈业务代码当中明确捕获了异常的！！</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误的做法示例</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">badExample</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        userRepository.save(user);
        orderRepository.save(order); 
      
      	<span class="hljs-comment">// 构造日志，但写库失败了：比如某个字段超长、没满足非空约束、主键冲突...</span>
      	operateLogService.regiest(badLog); 
    } <span class="hljs-keyword">catch</span> (DataIntegrityViolationException e) {
        <span class="hljs-comment">// 即使捕获了异常，事务仍处于aborted状态</span>
        auditLogRepository.save(auditLog); <span class="hljs-comment">// 整个操作都废了，前面的正常操作也提交不了</span>
    }
}
</code></pre>
<p>纳尼！！ 这个ruleService入库因为一个not null约束导致失败，居然让主业务的入库也失败了！！</p>
<p><strong>特注：这不是个性专有数据库才出现的情况，在这种代码实现下，当前这些数据库都会失败，除非你显性做额外处理！</strong></p>
<h3 data-id="heading-2">2. 问题复现</h3>
<p>赶紧写个程序验证一下。</p>
<ol>
<li>准备一张测试表</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_test ( name <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>);
</code></pre>
<ol start="2">
<li>
<p>用原生jdbc模拟操作</p>
<blockquote>
<p>传统认识：执行完会有aa，bb两条记录。但实际上，啥也没有...</p>
</blockquote>
</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 这里就是获取连接，不重要，可自己写</span>
<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> JdbcUtil.initConnection();

<span class="hljs-comment">// 关闭事务自动提交</span>
conn.setAutoCommit(<span class="hljs-literal">false</span>);

<span class="hljs-comment">// 1. 模拟主业务的正常操作</span>
<span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstm</span> <span class="hljs-operator">=</span> conn.prepareStatement(<span class="hljs-string">"insert into t_test(name) values (?)"</span>);
pstm.setString(<span class="hljs-number">1</span>, <span class="hljs-string">"aa"</span>);
pstm.executeUpdate();

<span class="hljs-comment">// 2. 准备执行操作：插入一条""记录，预估失败，捕获异常，插入bb记录</span>
<span class="hljs-keyword">try</span>{
		pstm.setString(<span class="hljs-number">1</span>, <span class="hljs-string">""</span>);
		pstm.executeUpdate();
} <span class="hljs-keyword">catch</span>(Exception e){
    System.out.println(e);
  	pstm.setString(<span class="hljs-number">1</span>, <span class="hljs-string">"bb"</span>);
  	pstm.executeUpdate();
}

<span class="hljs-comment">// 正常提交</span>
<span class="hljs-number">3.</span> conn.commit();
</code></pre>
<ol start="3">
<li>查看数据库</li>
</ol>
<pre><code class="hljs language-css" lang="css">期望：数据库中有两条记录：aa，bb。但实际上，啥也没有... 啥也不是

突然想起这样的业务流程设计：
	先写<span class="hljs-selector-tag">A</span>表；再写<span class="hljs-selector-tag">B</span>表，如果失败了，C表登记一条异常记录；
交易结束，系统保存<span class="hljs-selector-tag">A</span>，<span class="hljs-selector-tag">B</span> 或者<span class="hljs-selector-tag">A</span>，C
</code></pre>
<p><strong>这种需求不少，实现都这样的。 不行，赶紧改代码去, 😭😭</strong></p>
<h3 data-id="heading-3">3. 常见误解：@Transactional方法内捕获异常的陷阱</h3>
<p>许多开发者存在一个常见误解：<strong>在<code>@Transactional</code>注解的方法内部捕获异常就能让逻辑符合期望的执行</strong>。如</p>
<p>这种理解在某些数据库系统中是正确的，但在PostgreSQL和GaussDB中却行不通。</p>
<h4 data-id="heading-4">传统认知 vs 现实情况</h4>
<p><strong>传统认知</strong>：</p>
<ul>
<li>在<code>@Transactional</code>方法中发生异常</li>
<li>使用try-catch捕获异常</li>
<li>执行补偿逻辑</li>
<li>操作都可以正常进行</li>
</ul>
<p><strong>现实情况（PostgreSQL/GaussDB）</strong>：</p>
<ul>
<li>一旦事务中的任何SQL语句失败</li>
<li>整个事务进入"aborted"状态</li>
<li>即使在应用层捕获了异常</li>
<li>后续的所有SQL操作都会失败</li>
</ul>
<h4 data-id="heading-5">PostgreSQL/GaussDB 行为</h4>
<ul>
<li>事务中任何错误都会导致整个事务进入"aborted"状态</li>
<li>后续所有SQL命令都会被忽略，直到事务结束</li>
<li>必须执行ROLLBACK或COMMIT来退出aborted状态</li>
<li>这种设计保证了数据的一致性，但限制了灵活性</li>
</ul>
<h4 data-id="heading-6">MySQL 行为（默认隔离级别）</h4>
<ul>
<li>对于非事务性存储引擎，行为类似PostgreSQL</li>
<li>对于InnoDB存储引擎，支持SAVEPOINT</li>
<li>可以在事务中设置保存点，部分回滚到保存点</li>
<li>相对更灵活，但需要显式使用SAVEPOINT</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- MySQL中使用SAVEPOINT的例子</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'Alice'</span>);
<span class="hljs-keyword">SAVEPOINT</span> sp1;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'invalid_order'</span>); <span class="hljs-comment">-- 失败</span>
<span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> <span class="hljs-keyword">SAVEPOINT</span> sp1; <span class="hljs-comment">-- 回滚到保存点</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'valid_order'</span>); <span class="hljs-comment">-- 成功</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h4 data-id="heading-7">Oracle 行为</h4>
<ul>
<li>类似PostgreSQL，错误会导致当前事务状态异常</li>
<li>支持SAVEPOINT机制</li>
<li>可以回滚到特定保存点而不影响整个事务</li>
<li>需要显式的错误处理和保存点管理</li>
</ul>
<h4 data-id="heading-8">关键差异总结</h4>





























<table><thead><tr><th>数据库</th><th>错误后行为</th><th>恢复方式</th><th>灵活性</th></tr></thead><tbody><tr><td>PostgreSQL/GaussDB</td><td>事务aborted，后续命令被忽略</td><td>ROLLBACK或重新开始事务</td><td>低</td></tr><tr><td>MySQL(InnoDB)</td><td>可使用SAVEPOINT部分恢复</td><td>SAVEPOINT + ROLLBACK TO SAVEPOINT</td><td>中等</td></tr><tr><td>Oracle</td><td>可使用SAVEPOINT部分恢复</td><td>SAVEPOINT + ROLLBACK TO SAVEPOINT</td><td>中等</td></tr></tbody></table>
<p>这种差异意味着同样的Java代码在不同数据库上可能表现完全不同，特别是在涉及复杂事务逻辑的应用中。</p>
<h3 data-id="heading-9">4. Java编程推荐实践</h3>
<p>面对PostgreSQL/GaussDB的这种事务行为，我们需要采用不同的策略来处理事务中的错误：</p>
<h4 data-id="heading-10">4.1 使用独立的事务 做不影响主业务的事情</h4>
<p>最直接的解决方案是将错误日志记录放在独立的事务中</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 省略注入</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUserWithOrder</span><span class="hljs-params">(User user, Order order)</span> {
      userRepository.save(user);
      orderRepository.save(order);

  		<span class="hljs-comment">// 独立子事务、吞吃异常</span>
      logService.busiLog(logvo);
}

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogService</span> {
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logError</span><span class="hljs-params">(logvo)</span> {
       <span class="hljs-keyword">try</span>{
       	 logRepository.save(logvo);
       } <span class="hljs-keyword">catch</span>(Exception e){
         <span class="hljs-comment">// 只打日志，不抛异常</span>
         log.error(e);
       }
    }
}
</code></pre>
<h4 data-id="heading-11">4.2 如果要不回滚，则要尽量规避db出现中断事务的异常</h4>
<p><strong>对联机操作：</strong></p>
<ul>
<li>插入时使用<code>UPSERT</code>语法或显示前检查</li>
<li>在db操作前，将待入库的vo做合规检查，如字段长度、非空约束等</li>
</ul>
<p><strong>对批量操作：</strong></p>
<ul>
<li>在框架层设计批量回滚机制，如批量回滚后逐笔独立事务重试或逐笔业务设置保存点，出现异常的则登记异常并跳过，后续继续，直到该批次处理完进入下一批。</li>
</ul>
<blockquote>
<p>只要不落库引起事务abort，一切都还在你掌控！</p>
</blockquote>
<h3 data-id="heading-12">5. 总结</h3>
<p>GaussDB作为兼容PostgreSQL协议的分布式数据库，继承了PostgreSQL严格的事务状态管理机制。当事务中的某个操作失败时，整个事务进入"aborted"状态，后续所有SQL操作都会被忽略，直到事务结束。这一特性虽然保证了数据一致性，但也给Java开发者带来了挑战。</p>
<p>本文深入分析了这一问题的本质，对比了主流数据库在事务错误处理方面的差异，并提供了多种Java编程推荐实践：关键在于理解数据库事务状态管理的差异，避免在PostgreSQL/GaussDB环境中使用仅适用于其他数据库的行为假设。通过合理的架构设计和事务管理策略，可以有效避免<code>current transaction is aborted</code>错误，确保应用程序的稳定性和可靠性。</p>
<p>对于使用GaussDB或PostgreSQL的企业级应用，建议开发团队充分了解这一特性，并在系统设计阶段就考虑相应的错误处理策略，以避免在生产环境中遇到意外的事务问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践]]></title>    <link>https://juejin.cn/post/7600341731047555107</link>    <guid>https://juejin.cn/post/7600341731047555107</guid>    <pubDate>2026-01-29T06:52:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600341731047555107" data-draft-id="7600491179499159606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2026-01-29T06:52:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:52:20.000Z" title="Thu Jan 29 2026 06:52:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>随着企业数字化转型加速推进，大数据业务规模呈现指数级增长，迭代变更越发频繁。此背景下，呈现"高频变更"与"超大规模"并存的特征，这种双重特性给大数据任务的发布变更带来了严峻挑战。</p>
<h2 data-id="heading-1">二、项目目标</h2>
<p><strong>离线数仓任务资产管理</strong></p>
<p>增量：通过大数据变更发布流水线进行卡点，确保末端任务发布前，消费场景&amp;风险等级完成绑定。增量任务发布消费场景绑定率100%覆盖。</p>
<p>存量：盘点存量资产任务，人工梳理打标，完成初始化消费场景绑定。</p>
<p><strong>大数据变更发布流水线</strong></p>
<p>数仓任务发布流水线管控100%覆盖，任务发布效率提升60%。</p>
<h2 data-id="heading-2">三、项目方案</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcbbcbdf03ae4c869a91b4799f8179fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=QZE13mEVp5cv6Tsx6rr6em2WzPM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-3">数仓任务资产管理</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d6954c35f584787b99df00ed967578b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=0jv6VAoQYcAFbrplwcLprBM8Bww%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>消费场景定义</strong></p>
<p>根据业务用途梳理消费端内容，根据风险高低定义风险等级P0、P1、P2，从末节点自动倒推追溯上游全链路，并全部打上风险等级P0、P1、P2标识，以相同的生产规范标准要求上下游各方协同保障。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6a1b928c3c4763afc4868e6ea87c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=c%2BYgadRA44Mj3ohKsnzatoBevSU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>风险等级定义</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eb42fe993c14ff0a996420bd470633f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=FKQ%2B9CuEQsB9NkMs20RLfQY7mk4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>消费场景注册&amp;绑定</strong></p>
<ul>
<li><strong>消费场景注册</strong></li>
</ul>
<p>当前数仓任务消费场景已经完成初步盘点和梳理，并且将盘点的消费场景数据初始化到平台中。随着迭代场景的新增，需要注册新的场景，从而应业务所需。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a44db55d88a747288596b986ae51adad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=Z6di80hvl2Zqe4JZzlXp2jaaApc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>存量资产任务绑定</strong></li>
</ul>
<p>针对当前数仓存量资产任务进行盘点，将adm、ads层表进行梳理、打标，最终初始化到平台中，完成存量资产绑定消费场景。</p>
<ul>
<li><strong>任务消费场景应用</strong></li>
</ul>
<p>任务和消费场景完成绑定后，从而决定任务的应用场景、风险等级，P0、P1任务将在变更管控、线上稳定性保障等得到重保。</p>
<h3 data-id="heading-4">数仓变更管控流水线</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd3ec25b6c174764bbefe31ef8f678c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=d%2BQ3NXjO3p3RJAzM6SFQySKci5g%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>质量定义(DQC)</strong></p>
<p>在离线数据仓库（数仓）中，数据质量检查（DQC，Data Quality Check）是确保数据准确性、一致性、完整性的重要环节。数仓ETL任务在加工完成后，会执行DQC检查，从而有效、及时发现数据质量问题，便于研发人员及时修复，避免问题数据对业务造成损失。</p>
<ul>
<li><strong>DQC强规则</strong></li>
</ul>
<p>当强规则执行不通过后，直接失败任务，及时通知任务Owner，并拦截下游任务执行，待修复后下游链路再继续执行。（拦截任务，需要值班人员及时修复。）</p>
<ul>
<li><strong>DQC弱规则</strong></li>
</ul>
<p>当弱规则执行不通过后，及时通知任务Owner。任务正常执行成功，下游任务也正在运行。（不拦截任务，会通知到任务Owner。）</p>
<p><strong>质量定义配置</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/974a23fb07ba43d98f01b66c0cecb206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=puuYyBdSDog231%2B8%2BeWtjjVbbIY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>通用型DQC规则</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3512b3f1aab4648b9ba778cdfb4c63e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=1UkUpg7fLuZGXTSivlugXMYoAyM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d98c1542c8154560927cf261bd0ff6e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=uLhY%2F6i5BBrqr4FmeAmcBgUuaNw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a2fa1812f748bcbb90081b3a5a25ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=vWv8spTY%2F7flnSngyhgL3v8Ni0M%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>质量定义通过可视化界面操作，让用户可以直接通过简单的勾选方式，即可生成对应的DQC规则，大大提高研发人员配置DQC的效率。</p>
<ul>
<li><strong>自定义DQC规则</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d810c6bbd9e14324826a623e71239657~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=gLG73ppalBoRWLZ8umEQIg9d3BM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>用户可以按照规则SQL补充规则逻辑，从而实现自定义验证SQL融入DQC-SQL中，达到自定义DQC规则的效果。</p>
<p><strong>强弱规则配置</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5962e1b7c45242d9bf90bfc4b3c2e965~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=XldHabsNTfOMJ6sPXO6znTkJFfw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>DQC强规则和弱规则的配置方式完全一致，通过Tab的切换，可以完成强弱规则的配置。</p>
<p><strong>质量DQC试运行</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63209616aa5c4f23a6585636ea201e16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=VwH6bLAI7qETWL86u9mqJsg1hZY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>所有DQC配置完成后，需要通过试运行之后才能保存上线，确保DQC配置的合理性、有效性。</p>
<p><strong>告警策略</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/924be0c0232847fb985fff63432c9d40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=u064XJgH0xNHpZMB15dZK2lysiA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>支持飞书、电话、短信、邮箱等方式告警通知。其中强规则一旦触发，必定电话告警（采取15分钟无响应即逐级上升原则）。</p>
<p><strong>发布流水线管控</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce8d58bbb15b4e5aa6bd4d3963452cc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=qcRcaLfzKFjoU3s1IRryc12MpeE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9feb9ce26724d57aa8ca88768e0a6a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=IK4SX69%2FGUyIHEnNW%2B5Q%2FTRsntk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>静态扫描</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32ad381e710944d2b45b515c01af2f0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=zOpY7suZOCLsCUZgMzDyZZcX0TM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b192059f63b44e3a4bfc774e33a628b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=%2B8iTU3GXC8epX8Vlh%2FPuIKmonmY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>检测规则：任务依赖、建表规范、编码规范、集成规范、DQC规范等。</p>
<p><strong>冒烟测试</strong></p>
<p>在数仓测试环境下，完成任务冒烟测试执行，执行内容包含：ETL任务、DQC规则。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eeb933954cb4c3e83e8255b003d02ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=8lcZK1qNQ1RISk1MXWUupsqFHPs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>CodeReview</strong></p>
<p>描述：根据业务熟悉对，由数据域数仓PM 或者 业务数仓技术负责人进行评审，给出评审结论。</p>
<p>内容：ETL代码、调度配置、质量定义配置、DQC-SQL等。</p>
<p>注意：审批人飞书会接收到来自“xx稳定中心”机器人推送的消息，点击进入审批详情完成审批即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ecd73992434cb79c77b75eab7164c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=7uX7O1vN6ZbbD7DDZttpIzF%2BAL4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>数据探查</strong></p>
<p>描述：针对表内所有字段进行探查和校验，主要场景：数字探查、字符探查、主键验证、无效字段验证、异常字段验证</p>
<p>PS：数字探查和字符探查会给出明显问题红色高亮标识。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd1305690b6d44dbb26c20f6057358f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=FrYlzF6QEGxUgVHxHaNfyPvgjGg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79697b5c131b432bac3440ceb2ec194e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=8o6JPjaV8O9lg%2F0iPBIC5e1Oep0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>数据比对</strong></p>
<p>描述：针对生产表和测试表进行数据比对，比对场景：数据量对比、聚合指标对比、明细对比。</p>
<p>注意信息：对比的两张表用户无法输入，用户需要输入执行分区、主键字段、去噪字段、风险阈值（针对明细对比生效）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fda58c471ee46108b5e520e644ecf4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=AwYFo9VTNy6Gw3%2BPoC%2F%2FxwV4Hy0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>发布审批</strong></p>
<p>描述：发布审批节点，用户输入本次发布的基础信息，提交审批即可。</p>
<p>所有需求都需要数据域PM和对应数据域的责任QA进行审批。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee84a4e7a23743dcbf98092ab8e909e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=iyZwVJ%2Fl3uvhqnWpTmGfNxQpEQw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-5">四、总结&amp;未来规划</h2>
<h3 data-id="heading-6">实践总结</h3>
<p>得物离线数仓发布流水线过去1年有着从0到1的建设，以及后期从1到10的优化和改进。当前流水线能力已经足以支撑数仓内部日常迭代变更需求的发布管控，为发布准出规则执行提供了巨大帮助。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c5761a470744a7e8d0d9fe86f1c8815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=mDN6ddVP0IZQze8m%2F1EMU3jFu%2Bg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>发布管控对于QA来说是最重要的一个环节，所有发布都能够达到准出标准的要求，从而才能守住发布的最后一道线。</p>
<h3 data-id="heading-7">未来规划</h3>
<p><strong>节点能力优化</strong></p>
<p>当前数仓表单分区大于3TB（十亿、百亿、千亿级别）存储数据后，数据探查、数据比对将不提供验证服务，主要源于数据量、存储过大、字段过多，对计算资源、计算存储带来巨大的消耗，严重影响其他任务的执行进度。后续通过数据抽样验证的方式从而降低资源的消耗，从而提升场景覆盖度。</p>
<p><strong>流水线能力补充</strong></p>
<p>数据探查未来考虑通过和历史探查结果比对参考的方式，给出诊断结果，进一步提升工具卡点能力。</p>
<h3 data-id="heading-8">往期回顾</h3>
<p>1.AI编程实践：从Claude Code实践到团队协作的优化思考｜得物技术</p>
<p>2.入选AAAI-PerFM｜得物社区推荐之基于大语言模型的新颖性推荐算法 </p>
<p>3.Galaxy比数平台功能介绍及实现原理｜得物技术</p>
<p>4.得物App智能巡检技术的探索与实践</p>
<p>5.深度实践：得物算法域全景可观测性从 0 到 1 的演进之路</p>
<h3 data-id="heading-9">文 /家森</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[miglite: 极简高效的数据库迁移工具]]></title>    <link>https://juejin.cn/post/7600326947506192436</link>    <guid>https://juejin.cn/post/7600326947506192436</guid>    <pubDate>2026-01-29T06:31:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326947506192436" data-draft-id="7600355625474359348" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="miglite: 极简高效的数据库迁移工具"/> <meta itemprop="keywords" content="Go,GitHub"/> <meta itemprop="datePublished" content="2026-01-29T06:31:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="inhere"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359829453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            miglite: 极简高效的数据库迁移工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359829453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    inhere
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:31:49.000Z" title="Thu Jan 29 2026 06:31:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🚀 miglite: 极简高效的数据库迁移工具！</p>
<blockquote>
<p>如果你厌倦了复杂庞大的数据库迁移工具，渴望一个轻量级、零配置且功能强大的解决方案，那么 miglite 绝对值得一试。它用最纯粹的方式解决数据库 Schema 迁移问题，让开发者回归编码本身。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">✨ 项目简介</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgookit%2Fmiglite" target="_blank" title="https://github.com/gookit/miglite" ref="nofollow noopener noreferrer">miglite</a> 是一个用 Golang 实现的<strong>极简数据库 Schema 迁移工具</strong>，它秉持"做一件事并做好"的设计哲学，提供了核心迁移功能的同时，保持了极致的轻量和易用性。</p>
<h3 data-id="heading-1">🎯 核心特性</h3>



































<table><thead><tr><th align="left">特性</th><th align="left">描述</th><th align="left">优势</th></tr></thead><tbody><tr><td align="left"><strong>🪶 极简依赖</strong></td><td align="left">基于 <code>database/sql</code> 接口开发，默认<strong>不添加</strong>任何驱动依赖包</td><td align="left">保持项目轻量，避免依赖冲突</td></tr><tr><td align="left"><strong>📝 原生 SQL</strong></td><td align="left">使用原始 SQL 文件作为迁移方式，无特定 DSL 学习成本</td><td align="left">直接利用现有 SQL 技能，迁移逻辑透明可控</td></tr><tr><td align="left"><strong>🔒 事务保障</strong></td><td align="left">所有迁移操作均在事务中执行，确保数据一致性</td><td align="left">出现问题可自动回滚，避免数据库处于不一致状态</td></tr><tr><td align="left"><strong>🔧 零配置支持</strong></td><td align="left">支持通过环境变量直接运行，自动加载 <code>.env</code> 和默认配置文件</td><td align="left">快速启动，减少配置烦恼</td></tr><tr><td align="left"><strong>🗄️ 多数据库支持</strong></td><td align="left">支持 MySQL、SQLite、PostgreSQL 等主流数据库</td><td align="left">一套工具，多个项目复用</td></tr></tbody></table>
<h2 data-id="heading-2">🛠️ 快速开始</h2>
<h3 data-id="heading-3">安装方式</h3>
<h4 data-id="heading-4">作为命令行工具使用</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 通过 go 安装</span>
go install github.com/gookit/miglite/cmd/miglite@latest
</code></pre>
<h4 data-id="heading-5">作为 Go 库集成</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加依赖</span>
go get github.com/gookit/miglite

<span class="hljs-comment"># 导入使用</span>
import <span class="hljs-string">"github.com/gookit/miglite"</span>
</code></pre>
<h3 data-id="heading-6">基本使用流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[安装 miglite] --&gt; B[配置数据库连接]
    B --&gt; C[创建迁移文件]
    C --&gt; D[编写 UP/DOWN SQL]
    D --&gt; E[执行迁移]
    E --&gt; F[查看状态]
    
    style A fill:#e3f2fd,stroke:#2196f3,color:#0d47a1
    style B fill:#bbdefb,stroke:#2196f3,color:#0d47a1
    style C fill:#90caf9,stroke:#2196f3,color:#ffffff
    style D fill:#64b5f6,stroke:#2196f3,color:#ffffff
    style E fill:#42a5f5,stroke:#2196f3,color:#ffffff
    style F fill:#2196f3,stroke:#2196f3,color:#ffffff
</code></pre>
<h2 data-id="heading-7">💻 实战演示</h2>
<h3 data-id="heading-8">1️⃣ 配置数据库连接</h3>
<p>miglite 提供了<strong>多种配置方式</strong>，从零配置到完整配置文件任你选择。</p>
<details>
<summary><strong>🔧 配置方式一：使用 miglite.yaml 文件（推荐）</strong></summary>
<p>创建项目根目录下创建 <code>miglite.yaml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">database:</span>
  <span class="hljs-attr">driver:</span> <span class="hljs-string">sqlite</span>  <span class="hljs-comment"># 支持 mysql, postgresql, sqlite</span>
  <span class="hljs-attr">dsn:</span> <span class="hljs-string">./miglite.db</span>  <span class="hljs-comment"># 数据库连接字符串或文件路径</span>
<span class="hljs-attr">migrations:</span>
  <span class="hljs-attr">path:</span> <span class="hljs-string">./migrations</span>  <span class="hljs-comment"># 迁移文件存放目录</span>
</code></pre>
</details>
<details>
<summary><strong>🔧 配置方式二：完全使用环境变量（零配置）</strong></summary>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置迁移文件路径</span>
<span class="hljs-built_in">export</span> MIGRATIONS_PATH=<span class="hljs-string">"./migrations"</span>

<span class="hljs-comment"># SQLite 示例</span>
<span class="hljs-built_in">export</span> DATABASE_URL=<span class="hljs-string">"sqlite://path/to/your.db"</span>

<span class="hljs-comment"># MySQL 示例</span>
<span class="hljs-built_in">export</span> DATABASE_URL=<span class="hljs-string">"mysql://user:passwd@tcp(127.0.0.1:3306)/local_test?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span>

<span class="hljs-comment"># PostgreSQL 示例</span>
<span class="hljs-built_in">export</span> DATABASE_URL=<span class="hljs-string">"postgres://host=localhost port=5432 user=username password=password dbname=dbname sslmode=disable"</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：MySQL 连接 URL 必须带上 <code>tcp</code> 协议标记，如 <code>tcp(127.0.0.1:3306)</code>。</p>
</blockquote>
</details>
<h3 data-id="heading-9">2️⃣ 创建迁移文件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建一个新的迁移文件</span>
miglite create add-users-table
</code></pre>
<p>这将在 <code>./migrations/</code> 目录下创建一个格式为 <code>YYYYMMDD-HHMMSS-{migration-name}.sql</code> 的文件，例如：</p>
<pre><code class="hljs language-bash" lang="bash">./migrations/20251105-102325-add-users-table.sql
</code></pre>
<h3 data-id="heading-10">3️⃣ 编写迁移 SQL</h3>
<p>迁移文件使用简单的注释标记来区分 <code>UP</code>（应用）和 <code>DOWN</code>（回滚）操作：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- Migrate:UP</span>
<span class="hljs-comment">-- 在这里添加迁移 SQL（创建表、添加字段等）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- Migrate:DOWN</span>
<span class="hljs-comment">-- 在这里添加回滚 SQL（删除表、移除字段等）</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> users;
</code></pre>
<details>
<summary><strong>📋 更复杂的迁移示例（包含索引和初始数据）</strong></summary>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- Migrate:UP</span>
<span class="hljs-comment">-- 创建文章表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> posts (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    content TEXT,
    user_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">FOREIGN</span> KEY (user_id) <span class="hljs-keyword">REFERENCES</span> users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE
);

<span class="hljs-comment">-- 创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_posts_user_id <span class="hljs-keyword">ON</span> posts(user_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_posts_created_at <span class="hljs-keyword">ON</span> posts(created_at);

<span class="hljs-comment">-- 插入初始数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> posts (title, content, user_id) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-string">'Welcome to miglite'</span>, <span class="hljs-string">'This is a sample post.'</span>, <span class="hljs-number">1</span>),
    (<span class="hljs-string">'Getting Started'</span>, <span class="hljs-string">'Learn how to use miglite effectively.'</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">-- Migrate:DOWN</span>
<span class="hljs-comment">-- 回滚操作（按相反顺序执行）</span>
<span class="hljs-keyword">DROP</span> INDEX IF <span class="hljs-keyword">EXISTS</span> idx_posts_created_at;
<span class="hljs-keyword">DROP</span> INDEX IF <span class="hljs-keyword">EXISTS</span> idx_posts_user_id;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> posts;
</code></pre>
</details>
<h3 data-id="heading-11">4️⃣ 执行迁移</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化迁移表（首次使用必须执行）</span>
miglite init

<span class="hljs-comment"># 应用所有待处理的迁移</span>
miglite up

<span class="hljs-comment"># 无需确认，立即执行所有迁移</span>
miglite up --<span class="hljs-built_in">yes</span>

<span class="hljs-comment"># 回滚最近的迁移</span>
miglite down

<span class="hljs-comment"># 回滚多个迁移（例如回滚最近3个）</span>
miglite down --number 3

<span class="hljs-comment"># 查看迁移状态</span>
miglite status
</code></pre>
<h2 data-id="heading-12">🧩 作为库使用集成</h2>
<p><code>miglite</code> 的强大之处在于它不仅可以作为 CLI 工具使用，还可以 <strong>无缝集成到你的 Go 项目中</strong>。</p>
<blockquote>
<p><code>github.com/gookit/miglite</code> 不依赖任何三方数据库驱动包，使用你项目中引入的数据库驱动</p>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"github.com/gookit/miglite"</span>
    _ <span class="hljs-string">"github.com/go-sql-driver/mysql"</span> <span class="hljs-comment">// 导入数据库驱动</span>
    <span class="hljs-string">"log"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 创建 miglite 实例 - 配置文件可以不存在，会自动读取相关ENV变量使用</span>
    m := miglite.New(<span class="hljs-string">"miglite.yaml"</span>)
    
    <span class="hljs-comment">// 初始化迁移表</span>
    <span class="hljs-keyword">if</span> err := m.Init(); err != <span class="hljs-literal">nil</span> {
        log.Fatal(err)
    }

    <span class="hljs-comment">// 应用迁移</span>
    <span class="hljs-keyword">if</span> err := m.Up(); err != <span class="hljs-literal">nil</span> {
        log.Fatal(err)
    }

    <span class="hljs-comment">// 查看迁移状态</span>
    status, err := m.Status()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatal(err)
    }
    log.Printf(<span class="hljs-string">"Migration status: %+v"</span>, status)
}
</code></pre>
<h3 data-id="heading-13">🎨 自定义命令行工具</h3>
<p>你还可以基于 miglite 库构建 <strong>自定义的迁移命令行工具</strong> (这是默认自带的功能)，只包含你需要的数据库驱动：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"github.com/gookit/miglite"</span>
    <span class="hljs-string">"github.com/gookit/miglite/pkg/command"</span>
    _ <span class="hljs-string">"github.com/go-sql-driver/mysql"</span> <span class="hljs-comment">// 只导入需要的驱动</span>
    <span class="hljs-comment">// _ "github.com/lib/pq"           // PostgreSQL 驱动（可选）</span>
    <span class="hljs-comment">// _ "modernc.org/sqlite"          // SQLite 驱动（可选）</span>
)

<span class="hljs-keyword">var</span> Version = <span class="hljs-string">"0.1.0"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 创建 CLI 应用</span>
    app := command.NewApp(<span class="hljs-string">"my-migrator"</span>, Version, <span class="hljs-string">"Custom migration tool"</span>)
    
    <span class="hljs-comment">// 运行应用</span>
    app.Run()
}
</code></pre>
<h2 data-id="heading-14">🔥 高级特性与技巧</h2>
<details>
<summary><strong>🧪 支持的数据库驱动选择</strong></summary>






























<table><thead><tr><th align="left">数据库</th><th align="left">推荐驱动</th><th align="left">特点</th></tr></thead><tbody><tr><td align="left"><strong>MySQL</strong></td><td align="left"><code>github.com/go-sql-driver/mysql</code></td><td align="left">纯 Go 实现，广泛使用</td></tr><tr><td align="left"><strong>PostgreSQL</strong></td><td align="left"><code>github.com/lib/pq</code> 或 <code>github.com/jackc/pgx/v5</code></td><td align="left">pgx 性能更好，lib/pq 更兼容</td></tr><tr><td align="left"><strong>SQLite</strong></td><td align="left"><code>modernc.org/sqlite</code></td><td align="left">CGO-free，跨平台友好</td></tr><tr><td align="left"><strong>MSSQL</strong></td><td align="left"><code>github.com/microsoft/go-mssqldb</code></td><td align="left">官方驱动，功能完整</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>提示</strong>：作为库使用时，你需要<strong>自己导入所需的数据库驱动</strong>。</p>
</blockquote>
</details>
<details>
<summary><strong>🔧 环境变量自动加载</strong></summary>
<p>miglite 会自动尝试加载项目目录下的 <code>.env</code> 文件，支持以下环境变量：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 数据库连接 URL</span>
DATABASE_URL=<span class="hljs-string">"sqlite://./myapp.db"</span>

<span class="hljs-comment"># 迁移文件目录</span>
MIGRATIONS_PATH=<span class="hljs-string">"./db/migrations"</span>

<span class="hljs-comment"># 其他配置...</span>
</code></pre>
</details>
<details>
<summary><strong>📊 迁移状态查看</strong></summary>
<p>使用 <code>miglite status</code> 命令可以查看详细的迁移状态，包括：</p>
<pre><code class="hljs language-bash" lang="bash">$ miglite status

Migration Status:
================
+----------------+---------+---------------------+
| Migration      | Status  | Applied At          |
+----------------+---------+---------------------+
| 20251105-102325 | UP      | 2025-11-05 10:25:30 |
| 20251106-091500 | UP      | 2025-11-06 09:20:15 |
| 20251107-143000 | DOWN    | 2025-11-07 14:35:00 |
+----------------+---------+---------------------+
</code></pre>
</details>
<h2 data-id="heading-15">🌟 为什么选择 miglite？</h2>
<p>与其他迁移工具相比，miglite 提供了独特的价值：</p>






















































<table><thead><tr><th align="left">特性</th><th align="left">miglite</th><th align="left">golang-migrate</th><th align="left">goose</th><th align="left">dbmate</th></tr></thead><tbody><tr><td align="left"><strong>依赖复杂度</strong></td><td align="left">极简</td><td align="left">中等</td><td align="left">中等</td><td align="left">简单</td></tr><tr><td align="left"><strong>配置方式</strong></td><td align="left">零配置/文件配置</td><td align="left">文件配置</td><td align="left">文件配置</td><td align="left">环境变量</td></tr><tr><td align="left"><strong>迁移方式</strong></td><td align="left">原生 SQL</td><td align="left">多种支持</td><td align="left">原生 SQL/Go</td><td align="left">原生 SQL</td></tr><tr><td align="left"><strong>事务支持</strong></td><td align="left">✅ 是</td><td align="left">✅ 是</td><td align="left">✅ 是</td><td align="left">✅ 是</td></tr><tr><td align="left"><strong>学习曲线</strong></td><td align="left">平缓</td><td align="left">陡峭</td><td align="left">平缓</td><td align="left">平缓</td></tr><tr><td align="left"><strong>库集成</strong></td><td align="left">✅ 优秀</td><td align="left">✅ 优秀</td><td align="left">✅ 一般</td><td align="left">❌ 否</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>核心优势</strong>：miglite 在<strong>保持功能完整的同时</strong>，实现了<strong>极致的简洁性和易用性</strong>，非常适合追求开发效率和代码质量的团队。</p>
</blockquote>
<h2 data-id="heading-16">🎓 使用场景</h2>
<ol>
<li><strong>个人项目</strong>：快速搭建项目原型，无需学习复杂配置</li>
<li><strong>团队项目</strong>：统一迁移规范，通过原生 SQL 保持迁移逻辑透明</li>
<li><strong>CI/CD 集成</strong>：零配置特性使其极易集成到自动化流程中</li>
</ol>
<h2 data-id="heading-17">🤝 贡献与反馈</h2>
<p>miglite 是一个开源项目，我们欢迎任何形式的贡献：</p>
<ul>
<li>🐛 报告 Bug</li>
<li>💡 提出新特性建议</li>
<li>📝 改进文档</li>
<li>🔧 提交代码修复</li>
</ul>
<p>请访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgookit%2Fmiglite" target="_blank" title="https://github.com/gookit/miglite" ref="nofollow noopener noreferrer">GitHub 项目主页</a> 获取更多信息或参与贡献。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[wireguard + iptables + dnsmasq实现异地组网, 端口转发, 自定义域名访问]]></title>    <link>https://juejin.cn/post/7600344784945692718</link>    <guid>https://juejin.cn/post/7600344784945692718</guid>    <pubDate>2026-01-29T06:53:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600344784945692718" data-draft-id="7600414546188697610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="wireguard + iptables + dnsmasq实现异地组网, 端口转发, 自定义域名访问"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T06:53:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kira9924"/> <meta itemprop="url" content="https://juejin.cn/user/274223726860586"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            wireguard + iptables + dnsmasq实现异地组网, 端口转发, 自定义域名访问
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/274223726860586/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kira9924
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:53:43.000Z" title="Thu Jan 29 2026 06:53:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">💰 前言：为什么选择这个方案？</h2>
<p>随着远程办公和跨地协作成为常态，我一直在寻找一个<strong>稳定、轻量且安全</strong>的异地网络互联方案。经过对比多种方案后，我选择了 <strong>WireGuard + iptables + dnsmasq</strong> 这套组合，并已<strong>稳定运行一年</strong>。</p>
<p>我的核心需求包括：</p>
<ul>
<li>✅ <strong>异地组网</strong>：公司电脑、家里NAS、手机随时互通</li>
<li>✅ <strong>端口映射</strong>：把内网服务暴露到公网（像frp一样）</li>
<li>✅ <strong>好记的域名</strong>：不想再记 <code>10.0.8.xx</code> 这种IP</li>
</ul>
<p>市面上方案很多，但要么重（OpenVPN），要么麻烦（frp+ddns）。<br/>
最后用 <strong>WireGuard + iptables + dnsmasq</strong> 三件套搞定，<strong>稳定运行一年</strong>，分享给大家。</p>
<hr/>
<h3 data-id="heading-1">🎯 本教程可实现：</h3>

























<table><thead><tr><th>功能</th><th>说明</th><th>体验</th></tr></thead><tbody><tr><td><strong>异地组网</strong></td><td>P2P直连，失败自动中继</td><td>延迟10-60ms，远程桌面流畅</td></tr><tr><td><strong>端口映射</strong></td><td>iptables转发，无需额外工具</td><td>可转发全端口，服务器占用&lt;10%</td></tr><tr><td><strong>内网DNS</strong></td><td>自定义域名访问内网设备</td><td><code>my.pc.home</code> 直接访问</td></tr></tbody></table>
<blockquote>
<p>📌 <strong>适合人群</strong>：有云服务器、需要远程访问内网服务、喜欢自建解决方案的玩家。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🚀 快速开始</h2>
<p>如果你不想看长篇教程，可以直接使用一键脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载脚本</span>
wget https://raw.githubusercontent.com/kira9924/wireguard-setup/refs/heads/main/wg_v2.sh
<span class="hljs-built_in">chmod</span> +x wg.sh

<span class="hljs-comment"># 交互式菜单</span>
./wg.sh
脚本支持：自动初始化配置、生成客户端、端口转发管理、SSH安全加固等。
点击查看完整脚本源码

⚠️ 注意：脚本会修改SSH配置，建议先通读文档再使用！
</code></pre>
<h2 data-id="heading-3">📦 基础部署：WireGuard异地组网</h2>
<h3 data-id="heading-4">1. 安装依赖（Ubuntu）</h3>
<pre><code class="hljs language-bash" lang="bash">apt update
apt install -y wireguard iptables lsof
</code></pre>
<h3 data-id="heading-5">2. 生成密钥对</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 服务端密钥</span>
wg genkey | <span class="hljs-built_in">tee</span> /etc/wireguard/server_private.key | wg pubkey &gt; /etc/wireguard/server_public.key

<span class="hljs-comment"># 客户端密钥（示例）</span>
wg genkey | <span class="hljs-built_in">tee</span> /etc/wireguard/client_private.key | wg pubkey &gt; /etc/wireguard/client_public.key
</code></pre>
<h3 data-id="heading-6">3. 服务端配置（/etc/wireguard/wg0.conf）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Interface]</span>
<span class="hljs-attr">PrivateKey</span> = &lt;server_private_key&gt;
<span class="hljs-attr">Address</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.1</span>/<span class="hljs-number">24</span>
<span class="hljs-attr">ListenPort</span> = <span class="hljs-number">50814</span>
<span class="hljs-attr">DNS</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.1</span>
<span class="hljs-attr">MTU</span> = <span class="hljs-number">1420</span>
<span class="hljs-attr">PostUp</span> = /etc/wireguard/iptable-up.sh
<span class="hljs-attr">PostDown</span> = /etc/wireguard/iptable-down.sh

<span class="hljs-section">[Peer]</span>
<span class="hljs-comment"># 客户端1</span>
<span class="hljs-attr">PublicKey</span> = &lt;client1_public_key&gt;
<span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.10</span>/<span class="hljs-number">32</span>
<span class="hljs-attr">PersistentKeepalive</span> = <span class="hljs-number">25</span>

<span class="hljs-section">[Peer]</span>
<span class="hljs-comment"># 客户端2</span>
<span class="hljs-attr">PublicKey</span> = &lt;client2_public_key&gt;
<span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.11</span>/<span class="hljs-number">32</span>
<span class="hljs-attr">PersistentKeepalive</span> = <span class="hljs-number">25</span>
💡 提示：PersistentKeepalive 是P2P连接的关键，保持25秒心跳可穿透大部分NAT。
</code></pre>
<h3 data-id="heading-7">4. 配置iptables转发脚本</h3>
<p>创建 /etc/wireguard/iptable-up.sh 和 iptable-down.sh，内容见 iptables配置。</p>
<h3 data-id="heading-8">5. 客户端配置</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Interface]</span>
<span class="hljs-attr">PrivateKey</span> = &lt;client_private_key&gt;
<span class="hljs-attr">Address</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.10</span>/<span class="hljs-number">32</span>
<span class="hljs-attr">MTU</span> = <span class="hljs-number">1420</span>
<span class="hljs-attr">DNS</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.1</span>, <span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>

<span class="hljs-section">[Peer]</span>
<span class="hljs-attr">PublicKey</span> = &lt;server_public_key&gt;
<span class="hljs-attr">Endpoint</span> = 你的公网IP:<span class="hljs-number">50814</span>
<span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">8.0</span>/<span class="hljs-number">24</span>
<span class="hljs-attr">PersistentKeepalive</span> = <span class="hljs-number">25</span>
</code></pre>
<h3 data-id="heading-9">6. 启动与测试</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动服务端</span>
wg-quick up wg0

<span class="hljs-comment"># 查看状态</span>
wg show

<span class="hljs-comment"># 测试连通性（从客户端）</span>
ping 10.0.8.1
</code></pre>
<h2 data-id="heading-10">🌉 进阶功能1：内网端口映射</h2>
<p>既然设备已经组网，就可以通过iptables将内网端口暴露到公网。</p>
<ul>
<li>为什么需要端口映射？</li>
<li>将家里的NAS网页界面暴露到公网</li>
<li>远程桌面访问公司电脑</li>
<li>搭建自己的网站/服务</li>
</ul>
<h3 data-id="heading-11">单端口转发示例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将公网8080端口转发到10.0.8.10:8080</span>
iptables -t nat -A WG-FORWARD-NAT -p tcp --dport 8080 -j DNAT --to 10.0.8.10:8080
iptables -t nat -A POSTROUTING -p tcp -d 10.0.8.10 --dport 8080 -j SNAT --to 10.0.8.1
iptables -A WG-FORWARD-FW -p tcp -d 10.0.8.10 --dport 8080 -j ACCEPT
</code></pre>
<h3 data-id="heading-12">批量端口转发</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成规则文件（示例：10000-10010端口）</span>
*nat
-A WG-FORWARD-NAT -p tcp --dport 10000 -j DNAT --to 10.0.8.10:10000
-A POSTROUTING -p tcp -d 10.0.8.10 --dport 10000 -j SNAT --to 10.0.8.1
COMMIT
*filter
-A WG-FORWARD-FW -p tcp -d 10.0.8.10 --dport 10000 -j ACCEPT
COMMIT
<span class="hljs-comment"># 导入规则</span>
iptables-restore --noflush &lt; rules.txt
</code></pre>
<blockquote>
<p>⚠️ 重要提醒：</p>
<ol>
<li>需要在云服务器控制台防火墙/安全组中放行对应端口</li>
<li>全端口转发存在安全风险，建议仅开放必要端口</li>
<li>可以使用脚本的批量转发功能，支持随机端口、范围端口等</li>
</ol>
</blockquote>
<h2 data-id="heading-13">🔗 进阶功能2：内网自定义DNS</h2>
<p>记住 <code>10.0.8.10</code> 这种IP太反人类，我们需要好记的域名。</p>
<h3 data-id="heading-14">为什么需要自建DNS？</h3>
<ul>
<li><code>my.pc.home</code> 比 <code>10.0.8.10</code> 好记</li>
<li>设备多了不用记IP表</li>
<li>浏览器直接输入域名访问</li>
</ul>
<h3 data-id="heading-15">安装配置dnsmasq</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止系统自带的DNS服务</span>
sudo systemctl stop systemd-resolved
sudo systemctl <span class="hljs-built_in">disable</span> systemd-resolved

<span class="hljs-comment"># 安装dnsmasq</span>
sudo apt install dnsmasq -y
</code></pre>
<h3 data-id="heading-16">配置dnsmasq</h3>
<p>编辑 /etc/dnsmasq.conf：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 仅监听WG网络</span>
<span class="hljs-attr">interface</span>=wg0
<span class="hljs-attr">listen-address</span>=<span class="hljs-number">10.0</span>.<span class="hljs-number">8.1</span>
bind-interfaces

<span class="hljs-comment"># 自定义域名文件</span>
<span class="hljs-attr">addn-hosts</span>=/etc/dnsmasq.hosts

<span class="hljs-comment"># 外网DNS兜底</span>
<span class="hljs-attr">server</span>=<span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span>
<span class="hljs-attr">server</span>=<span class="hljs-number">114.114</span>.<span class="hljs-number">114.114</span>

<span class="hljs-comment"># 性能优化</span>
<span class="hljs-attr">cache-size</span>=<span class="hljs-number">1000</span>
no-resolv
no-poll
</code></pre>
<p>###添加自定义域名
编辑 /etc/dnsmasq.hosts：</p>
<pre><code class="hljs language-ini" lang="ini">10.0.8.10 my.desktop.home
10.0.8.11 my.thinkpad.home
10.0.8.20 my.nas.home
</code></pre>
<h3 data-id="heading-17">验证DNS解析</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 服务端测试</span>
nslookup my.desktop.home 10.0.8.1

<span class="hljs-comment"># 客户端测试（需配置DNS为10.0.8.1）</span>
nslookup my.desktop.home
🚀 技巧：你可以用 home 作为顶级域名，完全自己掌控，比如 nas.home、router.home 等。
</code></pre>
<h3 data-id="heading-18">⚙️ 一键管理脚本（wg.sh）详解</h3>
<p>手动操作太繁琐？我写了这个全功能管理脚本。</p>
<h4 data-id="heading-19">脚本功能概览</h4>





























<table><thead><tr><th>功能模块</th><th>说明</th></tr></thead><tbody><tr><td>WG管理</td><td>启动/停止/重启/状态查看</td></tr><tr><td>客户端生成</td><td>一键生成多个客户端配置</td></tr><tr><td>端口转发</td><td>单端口、范围端口、随机端口转发</td></tr><tr><td>SSH安全</td><td>限制SSH仅WG网络可访问</td></tr><tr><td>网络配置</td><td>自定义IP段、子网等</td></tr></tbody></table>
<h4 data-id="heading-20">使用方法</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 交互式菜单（推荐新手）</span>
./wg.sh

<span class="hljs-comment"># 2. 命令行快速操作</span>
./wg.sh start          <span class="hljs-comment"># 启动WG</span>
./wg.sh client         <span class="hljs-comment"># 生成客户端配置</span>
./wg.sh forward        <span class="hljs-comment"># 端口转发管理</span>
./wg.sh config-ssh     <span class="hljs-comment"># 加固SSH（仅WG网络可访问）</span>
脚本界面预览
text
==================== WireGuard 全功能管理脚本 ====================
1. 启动 WG
2. 停止 WG
3. 重启 WG
4. 查看 WG/SSH/转发 状态
5. 端口转发管理
6. 生成客户端配置
7. 初始化/重置WireGuard配置
8. 批量添加客户端到服务器
9. 配置 SSH 仅监听 WG IP
10. 恢复 SSH 公网访问
11. 配置网络参数
12. 退出
===============================================================
请选择操作 [1-12]:
点击查看完整脚本源码
</code></pre>
<h3 data-id="heading-21">❓ 常见问题与解决方案</h3>
<ol>
<li>
<p>SSH被频繁扫描怎么办？</p>
<p><strong>问题</strong>：云服务器22端口被爆破，日志满是失败尝试。</p>
<p><strong>解决</strong>：使用脚本的 <code>配置 SSH 仅监听 WG IP</code> 功能，让SSH只监听WG内网IP（如 10.0.8.1:22）。
这样只有连接了WG的客户端才能SSH登录，公网无法访问。</p>
</li>
<li>
<p>跨运营商P2P不通？
问题：电信-移动之间直连失败。
解决：这是NAT穿透的硬伤，两种方案：</p>
</li>
</ol>
<ul>
<li>开启 PersistentKeepalive = 25（已配置）</li>
<li>接受走服务器中继（延迟40-60ms，依然可用）</li>
</ul>
<ol start="3">
<li>客户端连不上？
排查步骤：</li>
</ol>
<ul>
<li>检查服务端 wg show 命令是否有客户端握手</li>
<li>确认云服务器防火墙开放了 50814 端口（UDP）</li>
<li>检查客户端配置的Endpoint是否正确</li>
</ul>
<ol start="4">
<li>
<p>端口转发不生效？
可能原因：
云服务商安全组未放行
iptables规则未正确添加
目标服务未监听或防火墙阻挡</p>
</li>
<li>
<p>DNS解析失败？
检查项：</p>
</li>
</ol>
<ul>
<li>客户端DNS是否配置为 10.0.8.1</li>
<li>dnsmasq是否正常运行 systemctl status dnsmasq</li>
<li>域名是否添加到了 /etc/dnsmasq.hosts</li>
</ul>
<h3 data-id="heading-22">📊 性能实测数据</h3>





























<table><thead><tr><th>场景</th><th>延迟</th><th>带宽</th><th>体验</th></tr></thead><tbody><tr><td>同运营商P2P</td><td>8-15ms</td><td>打满家用上行</td><td>远程桌面无感</td></tr><tr><td>跨运营商中继</td><td>40-60ms</td><td>打满家用上行</td><td>轻度游戏可玩</td></tr><tr><td>文件传输</td><td>-</td><td>7MB/s</td><td>家用宽带基本跑满</td></tr></tbody></table>
<h3 data-id="heading-23">📌 我的使用场景：</h3>
<ul>
<li>ssh远程公司连公司电脑Docker开发环境, 体验接近本地</li>
<li>远程桌面家里台式机, 午休Mac也可以开一把炉石</li>
<li>搭建文件服务器映射到公网, 朋友零配置使用, 速度跑满宽带上传速度</li>
<li>访问家里Nas看电影, 流畅2k</li>
</ul>
<h3 data-id="heading-24">💬 最后的话</h3>
<p>这套方案我已经稳定使用一年多，从最初的简单组网，慢慢加入了端口映射、自定义DNS，最后写成了管理脚本。</p>
<p>它的优势在于：</p>
<p>✅ 轻量：WireGuard内核模块，资源占用极低</p>
<p>✅ 灵活：可按需配置流量路由</p>
<p>✅ 功能完整：组网、映射、DNS一站式解决</p>
<p>如果你在部署中遇到问题，欢迎在评论区留言。
如果觉得有用，可以收藏本文，或分享给有同样需求的朋友。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 组件缓存实战指南：从手写 KeepAlive 到 react-activation 深度应用]]></title>    <link>https://juejin.cn/post/7600318091832000539</link>    <guid>https://juejin.cn/post/7600318091832000539</guid>    <pubDate>2026-01-29T05:54:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600318091832000539" data-draft-id="7600260767688359962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 组件缓存实战指南：从手写 KeepAlive 到 react-activation 深度应用"/> <meta itemprop="keywords" content="React.js,性能优化,前端"/> <meta itemprop="datePublished" content="2026-01-29T05:54:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xhxxx"/> <meta itemprop="url" content="https://juejin.cn/user/3235201610941578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 组件缓存实战指南：从手写 KeepAlive 到 react-activation 深度应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3235201610941578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xhxxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:54:47.000Z" title="Thu Jan 29 2026 05:54:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 组件缓存指南：从手写 KeepAlive 到实战应用</h2>
<p>在现代前端开发中，尤其是移动端 H5 或混合 App 场景下，<strong>组件状态缓存</strong>几乎是一个“刚需”。试想这样一个常见流程：用户在商品列表页滑动到第 20 行，点击某商品进入详情页，返回时却发现列表回到了顶部，筛选条件重置，加载状态清零——这种体验不仅打断用户心智，甚至可能直接导致流失。</p>
<p>Vue 框架通过内置的 <code>&lt;keep-alive&gt;</code> 组件优雅地解决了这一问题，但 <strong>React 官方并未提供等效的原生能力</strong>。开发者要么接受“切换即销毁”的默认行为，要么自行实现缓存逻辑，要么引入第三方方案。</p>
<p>那么，在 React 中，我们该如何实现类似 <code>&lt;keep-alive&gt;</code> 的功能？</p>
<ul>
<li>是自己动手造轮子，深入理解缓存机制的本质？</li>
<li>还是直接采用成熟库，在生产环境中稳定落地？</li>
</ul>
<p>本文将分两部分为你系统解答：</p>
<ol>
<li><strong>原理篇</strong>：从零手写一个简易 <code>KeepAlive</code> 组件，揭示“缓存不销毁”的核心思想；</li>
<li><strong>实战篇</strong>：使用业界广泛采用的 <code>react-activation</code> 库，解决真实项目中的路由缓存、滚动位置恢复等复杂场景，并分享踩坑经验与最佳实践。</li>
</ol>
<p>无论你是想夯实基础，还是亟需上线功能，相信都能从中获得实用价值。</p>
<hr/>
<h3 data-id="heading-1">第一部分：手写一个简易版 KeepAlive</h3>
<p>核心思想非常简单：<strong>不要销毁组件，只是把它们藏起来。</strong></p>
<p>当用户切换 Tab 时，普通的 React 条件渲染（<code>{show &amp;&amp; &lt;Component /&gt;}</code>）会触发组件的卸载（Unmount）。而我们的 KeepAlive 组件会将所有渲染过的组件都存在一个 <code>Map</code>（对象）里，根据当前激活的 ID，控制它们的 <code>display</code> 样式。</p>
<h4 data-id="heading-2">1. 核心代码实现</h4>
<p>看看是怎么写的：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAlive</span> = (<span class="hljs-params">{ activeId, children }</span>) =&gt; {
  <span class="hljs-comment">// 1. 核心数据结构：缓存容器</span>
  <span class="hljs-comment">// 用一个对象来存储所有渲染过的 children，key 是 activeId</span>
  <span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>({});

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 2. 监听变化：一旦 activeId 变了，或者 children 变了</span>
    <span class="hljs-comment">// 如果这个 activeId 对应的组件还没缓存过，就把它存进去</span>
    <span class="hljs-keyword">if</span> (!cache[activeId]) {
      <span class="hljs-title function_">setCache</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> ({
        ...prev,
        [activeId]: children
      }))
    }
  }, [activeId, children, cache])

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {
        // 3. 渲染所有缓存：利用 Object.entries 遍历缓存对象
        // 关键点：所有组件都渲染出来了，只是通过 display 控制显隐
        Object.entries(cache).map(([id, component]) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
            <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span>
            // <span class="hljs-attr">4.</span> <span class="hljs-attr">样式控制</span>：<span class="hljs-attr">如果是当前激活的</span> <span class="hljs-attr">id</span>，<span class="hljs-attr">就</span> <span class="hljs-attr">block</span>，<span class="hljs-attr">否则</span> <span class="hljs-attr">none</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{{display:</span> <span class="hljs-attr">id</span> === <span class="hljs-string">activeId</span> ? '<span class="hljs-attr">block</span>'<span class="hljs-attr">:</span> '<span class="hljs-attr">none</span>'}}
          &gt;</span>
            {component}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))
      }
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-3">核心代码解析</h4>
<ol>
<li><code>const [cache, setCache] = useState({});</code> 使用状态管理来缓存已经渲染过的组件</li>
<li><code>useEffect</code>，使用副作用hook更新缓存，如果当前元素还没有加载过那就存入缓存</li>
<li><code> Object.entries</code> ：能够将键值对对象转换为<code>[key,value]</code>的数组，例如{id:1}会被转换为<code>['id',1]</code>,这里通过解构拿到被keepAlive组件包裹的组件元素，然后通过样式控制来控制对应组件的显示。</li>
</ol>
<h4 data-id="heading-4">2. 使用效果</h4>
<p>在需要的组件中使用它：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> {
  useState,
  useEffect
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">KeepAlive</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/KeepAlive.jsx'</span>


<span class="hljs-keyword">const</span> <span class="hljs-title function_">Counter</span> = (<span class="hljs-params">{name}</span>)=&gt;{
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"挂载"</span>,name)
    <span class="hljs-keyword">return</span> <span class="hljs-function">()=&gt;</span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"卸载"</span>,name)
    }
  },[])
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{padding:</span>'<span class="hljs-attr">20px</span>',<span class="hljs-attr">border:</span>'<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>'}}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{name}视图<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setCount(count+1)}&gt;加一<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">OtherCounter</span> = (<span class="hljs-params">{name}</span>)=&gt;{
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"挂载"</span>,name)
    <span class="hljs-keyword">return</span> <span class="hljs-function">()=&gt;</span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"卸载"</span>,name)
    }
  },[])
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{padding:</span>'<span class="hljs-attr">20px</span>',<span class="hljs-attr">border:</span>'<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>'}}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{name}视图<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setCount(count+1)}&gt;加一<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>)=&gt;{
  <span class="hljs-keyword">const</span> [activeTab, setActiveTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'A'</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{marginBottom:</span>'<span class="hljs-attr">20px</span>'}}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setActiveTab('A')}&gt;显示A组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setActiveTab('B')}&gt;显示B组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      {/* children 在react中是用来提升组件的定制能力 父组件方便 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">KeepAlive</span> <span class="hljs-attr">activeId</span>=<span class="hljs-string">{activeTab}</span>&gt;</span>
        {activeTab === 'A'? <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'A'</span>/&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">OtherCounter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'B'</span>/&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">KeepAlive</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>

</code></pre>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">KeepAlive</span> activeId={activeTab}&gt;
  {activeTab === <span class="hljs-string">'A'</span> ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'A'</span>/&gt;</span></span> : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">OtherCounter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'B'</span>/&gt;</span></span>}
&lt;/<span class="hljs-title class_">KeepAlive</span>&gt;
</code></pre>
<p><strong>效果</strong>：</p>
<ul>
<li>当你点击“显示 A 组件”，计数器加到 5。</li>
<li>切换到 B 组件，再切回 A 组件。</li>
<li><strong>A 组件的计数器依然是 5</strong>，而且控制台不会打印“卸载 A”。</li>
<li>这就实现了最基础的<strong>状态保留</strong>。</li>
</ul>
<h3 data-id="heading-5"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6c2debee41e474f8d9b17ea11dbf7a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270886&amp;x-signature=TxBAcL2MdzI8HKpMjC4uPpYa4NE%3D" alt="20260129-0520-34.0468753.gif" loading="lazy"/></h3>
<h3 data-id="heading-6">第二部分：生产环境实战 (react-activation)</h3>
<p>手写的版本虽然能用，但在复杂的路由场景（React Router）下往往力不从心。在真实项目中，我们通常使用成熟的第三方库，比如 <code>react-activation</code>。</p>
<h4 data-id="heading-7">1. 引入第三方库</h4>
<p>直接使用封装好的第三方库组件，与手写实现不同的是：第三方库的逻辑是： “骗”过 React 。
让 React 以为组件一直安稳地待在顶层，而实际上通过底层 DOM 操作，把它的“肉身”（DOM 节点）按需移动到用户看得到的地方。</p>
<p>在我们的移动端项目中，我们封装了一个 <code>KeepAliveHome</code> 组件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/components/KeepAliveHome.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">KeepAlive</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-activation'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/pages/Home'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAliveHome</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> (
        <span class="hljs-comment">// name: 缓存的唯一标识</span>
        <span class="hljs-comment">// saveScrollPosition="screen": 自动保存并恢复滚动位置</span>
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeepAlive</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'home'</span> <span class="hljs-attr">saveScrollPosition</span>=<span class="hljs-string">"screen"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Home</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">KeepAlive</span>&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">KeepAliveHome</span>
</code></pre>
<h5 data-id="heading-8">核心逻辑：Portal “乾坤大挪移”</h5>
<ol>
<li>
<p><strong>影子容器（<code>AliveScope</code>）</strong><br/>
库会在应用顶层创建一个不可见的容器（通常包裹整个应用），称为 <code>AliveScope</code>，可理解为组件的“休眠舱”。</p>
</li>
<li>
<p><strong>劫持渲染（Portal）</strong><br/>
当你写 <code>&lt;KeepAlive&gt;&lt;Home /&gt;&lt;/KeepAlive&gt;</code> 时，<code>&lt;Home /&gt;</code> 并不会渲染在当前位置，而是通过 <code>ReactDOM.createPortal</code> 渲染到 <code>AliveScope</code> 中。</p>
</li>
<li>
<p><strong>占位符（Placeholder）</strong><br/>
原位置只保留一个空的 <code>&lt;div&gt;</code> 或注释节点作为占位。</p>
</li>
<li>
<p><strong>搬运 DOM（Teleportation）</strong></p>
<ul>
<li><strong>显示时</strong>：将 <code>AliveScope</code> 中的真实 DOM 节点 <code>appendChild</code> 到占位符处；</li>
<li><strong>隐藏时</strong>（如切换路由）：将该节点移回 <code>AliveScope</code> 存储。</li>
</ul>
</li>
</ol>
<h5 data-id="heading-9">为什么这么做？</h5>
<p>因为 React 组件的生命周期与其在 <strong>虚拟 DOM 树中的位置</strong> 绑定：</p>
<ul>
<li>普通条件渲染会导致组件树位置变化 → React 卸载组件；</li>
<li>而通过 Portal，组件在 React 树中的位置 <strong>始终固定在 <code>AliveScope</code> 内部</strong>，从未改变；</li>
<li>因此 React 认为它“一直活着”，状态自然保留。</li>
</ul>
<blockquote>
<p>💡 注意：此处仅为演示。实际开发中，建议将 <code>KeepAlive</code> 封装为通用高阶组件，通过 <code>children</code> 接收任意需缓存的子组件。</p>
</blockquote>
<h4 data-id="heading-10">2. 配合路由使用</h4>
<p>在路由配置中，我们需要用 <code>AliveScope</code> 包裹整个应用（通常在 <code>Router</code> 内部）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/router/index.tsx</span>
&lt;<span class="hljs-title class_">Router</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AliveScope</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">KeepAliveHome</span> /&gt;</span>} /&gt;
      {/* ... */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">AliveScope</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Router</span>&gt;
</code></pre>
<p>当我们浏览时，即使从详情页出来也不会从顶部重新开始看了，而是停留在了上一次的浏览位置
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/835a5009890045d292b40171c3d393cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270886&amp;x-signature=gyEy%2FKrv65SzpogpElsu4CMmsbs%3D" alt="20260129-0537-14.7884793.gif" loading="lazy"/></p>
<h4 data-id="heading-11">3. 遇到的坑与最佳实践</h4>
<p>在使用 <code>react-activation</code> 时，有一个非常容易踩的坑：<strong>父组件卸载导致的缓存失效</strong>。</p>
<p>在 React Router v6 的嵌套路由中，如果你的结构是：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">"/"</span> element={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MainLayout</span> /&gt;</span></span>}&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">index</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">KeepAliveHome</span> /&gt;</span>} /&gt;</span>
&lt;/<span class="hljs-title class_">Route</span>&gt;
</code></pre>
<p>当你跳转到 <code>/detail</code>（一个不属于 <code>MainLayout</code> 的路由）时，<strong><code>MainLayout</code> 会被卸载</strong>。
根据 React 的规则，父组件卸载，子组件（哪怕包了 KeepAlive）也会随之销毁。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>提升层级</strong>：尽量将需要缓存的组件放在路由树的顶层，或者确保其父级 Layout 不会轻易卸载。</li>
<li><strong>静态引入</strong>：避免使用 <code>React.lazy</code> 懒加载包裹 KeepAlive 组件，有时会导致组件引用变化从而重置缓存。</li>
</ol>
<h4 data-id="heading-12">总结</h4>
<p>组件缓存看似是一个小功能，实则深刻影响着用户体验与开发复杂度。通过本文的探索，我们可以清晰地看到两种实现路径的定位与价值：</p>
<ul>
<li><strong>手写简易 KeepAlive</strong>：<br/>
它的核心在于“<strong>渲染但隐藏</strong>”——利用 <code>display: none</code> 配合状态缓存，避免组件卸载。这种方式代码透明、逻辑直观，非常适合学习 React 渲染机制和状态生命周期，也足以应对简单的 Tab 切换、面板切换等静态场景。但它无法处理路由跳转、DOM 结构变化或滚动位置恢复等复杂需求，<strong>更适合教学或轻量级 UI 控制</strong>。</li>
<li><strong>react-activation（生产级方案）</strong> ：<br/>
该库通过 <code>Portal</code> 将需要缓存的组件 DOM 节点“移出”原有树结构，托管到顶层的 <code>&lt;AliveScope&gt;</code> 中，从而在父组件卸载时仍能保留实例。它不仅支持完整的 React 生命周期（如 <code>useEffect</code> 不重复触发），还内置了 <code>saveScrollPosition</code> 等实用功能，<strong>真正实现了类 Vue <code>&lt;keep-alive&gt;</code> 的体验</strong>，是中大型项目中的可靠选择。</li>
</ul>
<blockquote>
<p>📌 <strong>关键认知</strong>：缓存的本质不是“不让组件消失”，而是“不让组件被销毁”。理解这一点，就能明白为何父组件卸载会导致子缓存失效——因为 React 的卸载是自上而下的。这也解释了为何 <code>react-activation</code> 必须依赖全局作用域（<code>AliveScope</code>）来“劫持”组件的挂载点。</p>
</blockquote>
<p>最终，<strong>工具服务于场景</strong>。当你面对一个需要极致体验的移动端应用时，不要犹豫，拥抱成熟的缓存方案；而当你在调试或教学中想透彻理解机制，不妨从一行 <code>Object.entries(cache)</code> 开始，亲手构建属于自己的 KeepAlive。</p>
<p>毕竟，最好的框架使用方式，永远建立在对原理的深刻理解之上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再只盯着 Lodash 了：这 3 个原生 API，才是 2026 年前端性能的“天花板”]]></title>    <link>https://juejin.cn/post/7600345782173188130</link>    <guid>https://juejin.cn/post/7600345782173188130</guid>    <pubDate>2026-01-29T06:16:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600345782173188130" data-draft-id="7600345782173171746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再只盯着 Lodash 了：这 3 个原生 API，才是 2026 年前端性能的“天花板”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T06:16:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户3905133219288"/> <meta itemprop="url" content="https://juejin.cn/user/3609051079121550"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再只盯着 Lodash 了：这 3 个原生 API，才是 2026 年前端性能的“天花板”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609051079121550/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户3905133219288
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:16:06.000Z" title="Thu Jan 29 2026 06:16:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 AI 辅助编程普及的今天，写出“能跑”的代码已经没有门槛了。但为什么同样的 Vue 3 或 React 项目，在大数据量或复杂交互下，别人的页面丝滑如 144Hz，你的却总有那种挥之不去的“果冻感”和微小卡顿？</p>
<p>秘密往往不在于你用了什么框架，而在于你是否掌握了浏览器原生调度逻辑。今天分享三个被大多数人忽略、却能解决性能“顽疾”的高效 API。</p>
<hr/>
<h2 data-id="heading-0">一、 Scheduler.yield()：打破长任务的“霸权”</h2>
<h3 data-id="heading-1">痛点：页面“假死”</h3>
<p>我们经常会遇到这种场景：处理一个超大 JSON 数组，或者在 Canvas 中一次性初始化数千个粒子。即便你的电脑性能再强，JS 执行时也会霸占主线程。此时用户点击按钮、滚动页面，浏览器都没法响应，这种“假死”是用户体验的杀手。</p>
<h3 data-id="heading-2">过去的做法：<code>setTimeout(0)</code></h3>
<p>我们习惯用 <code>setTimeout(() =&gt; {...}, 0)</code> 来切分任务。但它的问题是<strong>优先级不受控</strong>。浏览器可能会在两个任务块之间插入不必要的渲染，或者干脆延迟太久才执行。</p>
<h3 data-id="heading-3">2026 年的解法：<code>Scheduler.yield()</code></h3>
<p>这是现代浏览器（基于 Prioritized Task Scheduling API）提供的利器。它能让出主线程，允许浏览器去处理更高优先级的任务（如用户输入），然后<strong>立即</strong>回来继续执行剩下的逻辑。</p>
<pre><code class="hljs language-scss" lang="scss">async function <span class="hljs-built_in">processHugeData</span>(data) {
  for (const item of data) {
    <span class="hljs-comment">// 执行复杂的业务逻辑</span>
    <span class="hljs-built_in">performComplexCalculation</span>(item);

    <span class="hljs-comment">// 每处理 100 条数据，检查是否需要把控制权交给浏览器</span>
    if (shouldYield()) {
      await scheduler<span class="hljs-selector-class">.yield</span>(); 
    }
  }
}
</code></pre>
<p><strong>为什么它更高效？</strong><br/>
它不像 <code>setTimeout</code> 那样盲目等待，而是告诉浏览器：“如果你有急事（用户点了个赞），你先忙；如果你没事，咱们继续。” 这种<strong>协同式调度</strong>是实现高性能交互的基础。</p>
<hr/>
<h2 data-id="heading-4">二、 content-visibility: auto：CSS 里的“虚拟滚动”</h2>
<h3 data-id="heading-5">痛点：DOM 节点过多导致的重绘灾难</h3>
<p>在做数字孪生驾驶舱、长信息流或复杂的管理后台时，页面上可能有数千个 DOM 节点。即便它们在屏幕外面，浏览器依然会计算它们的几何属性。</p>
<h3 data-id="heading-6">传统的解法：虚拟列表</h3>
<p>手动实现虚拟列表（Virtual List）非常痛苦，需要计算高度、监听滚动，且对 SEO 不友好。</p>
<h3 data-id="heading-7">现代解法：<code>content-visibility</code></h3>
<p>只需一行 CSS，你就能获得接近虚拟列表的性能收益：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card-container</span> {
  <span class="hljs-attribute">content-visibility</span>: auto;
  <span class="hljs-attribute">contain</span>-intrinsic-size: <span class="hljs-number">0</span> <span class="hljs-number">500px</span>; <span class="hljs-comment">/* 给未渲染元素一个预估高度，防止滚动条抖动 */</span>
}
</code></pre>
<ul>
<li>• <strong>原理</strong>：当元素不在视口内时，浏览器会跳过该元素的渲染工作（包括布局和绘图）。</li>
<li>• <strong>收益</strong>：对于含有大量图表（Echarts）或复杂 Canvas 的项目，首屏加载时间和滚动流畅度会有量级的提升。</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、 AbortController：不仅仅是为了取消 Fetch</h2>
<h3 data-id="heading-9">痛点：内存泄漏与监听器地狱</h3>
<p>在 Vue 3 项目中，我们经常在 <code>onMounted</code> 里绑定一堆 <code>window</code> 监听器，然后在 <code>onUnmounted</code> 里一个个手动 <code>removeEventListener</code>。一旦漏写，就是内存泄漏。</p>
<h3 data-id="heading-10">高效技巧：一键“自毁”</h3>
<p><code>AbortController</code> 实际上是一个通用的信号发射器。现在，几乎所有的原生 Web API 都支持接收它的 <code>signal</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> { signal } = controller;

<span class="hljs-comment">// 绑定多个事件</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize, { signal });
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll, { signal });
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, handleMouseMove, { signal });

<span class="hljs-comment">// 请求数据</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>, { signal });

<span class="hljs-comment">// 需要清理时（比如 Vue 组件销毁），只需一行代码：</span>
controller.<span class="hljs-title function_">abort</span>(); 
</code></pre>
<p><strong>为什么这很优雅？</strong><br/>
你不再需要保存每一个函数的引用。当你调用 <code>abort()</code> 时，所有绑定了该信号的事件监听器、正在进行的 Fetch 请求、甚至是某些动画序列，都会被<strong>同时销毁</strong>。这对于构建复杂的交互系统（如手势控制游戏）来说，简直是代码洁癖者的福音。</p>
<hr/>
<h2 data-id="heading-11">总结：博主的私房话</h2>
<p>在 2026 年，前端开发的重心已经从“如何实现功能”转向了“如何优雅地调度资源”。</p>
<ul>
<li>• <strong><code>Scheduler.yield()</code></strong>  解决了 <strong>JS 逻辑层</strong>的阻塞。</li>
<li>• <strong><code>content-visibility</code></strong> 解决了 <strong>渲染层</strong>的冗余。</li>
<li>• <strong><code>AbortController</code></strong> 解决了 <strong>生命周期管理</strong>的混乱。</li>
</ul>
<p>这些 API 虽然冷门，但它们代表了 Web 标准进化的方向：<strong>把复杂的调度交给浏览器引擎，把清爽的代码留给我们自己。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一键部署！京东云上线Clawdbot云服务！]]></title>    <link>https://juejin.cn/post/7600318091831853083</link>    <guid>https://juejin.cn/post/7600318091831853083</guid>    <pubDate>2026-01-29T05:30:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600318091831853083" data-draft-id="7600508556103172146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一键部署！京东云上线Clawdbot云服务！"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-29T05:30:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一键部署！京东云上线Clawdbot云服务！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:30:54.000Z" title="Thu Jan 29 2026 05:30:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Clawdbot（现改名Moltbot）一夜爆火全球，这个能读文件、跑命令、写代码、管系统的开源 AI 智能体，现已正式登陆京东云，无需手动配置环境，一键即可开启，让你的 AI 助手秒级上线、全天候待命。</p>
<p>Moltbot是少数真正具备系统级操作能力的个人智能助理：</p>
<ul>
<li>本地长期记忆（对话数据自主可控）</li>
<li>跨平台推送（支持对接通讯类软件）</li>
<li>真实任务执行（文件整理、表单提交、代码生成）</li>
</ul>
<p>这样一个强大又敏感的 AI 助手，该运行在哪里？更安全、更稳定的方式，是将其部署在独立、隔离的云端环境中。</p>
<p>京东云全面上线 Moltbot！京东云轻量云主机现已预置 Moltbot 应用镜像，无需手动配置环境，三步即可完成部署，让你的 AI 助手秒级上线、全天候待命。</p>
<p><strong>第一步：一键创建实例</strong></p>
<p>在京东云控制台创建轻量云主机，选择：</p>
<p>镜像名称：Moltbot</p>
<p>规格建议：2 核 2G 起（推荐 2 核 4G 以获得更佳体验）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb5df39896994c999d39dbbbb5683c68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269455&amp;x-signature=HJNOu74gtVdWM%2F0oymthVkofXL4%3D" alt="图片" loading="lazy"/></p>
<p><strong>第二步：获取API-Key</strong></p>
<p>登录JoyBuilder 模型开发平台 2.0，进入API-KEY 管理页面：</p>
<p>1、点击「创建」按钮，生成新的 API-Key；</p>
<p>2、在“修改 API-KEY”页面中，为该 Key 配置可访问的模型服务，必须包含以下模型：DeepSeek-V3-0324、DeepSeek-V3.2、DeepSeek-v3、Qwen3-235B-A22B、Kimi-K2-0905-jcloud</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b2480fed61141f9bfd518706f771fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269455&amp;x-signature=0vC%2FTf1O1yhwC2ArcuFoS%2Fh1yNg%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c69dc9b127fa435eafdb313b981e5ca2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269455&amp;x-signature=kyWB4rE918egYuyAe%2BaBqt%2F0K3c%3D" alt="图片" loading="lazy"/></p>
<p><strong>第三步：初始化与启动服务</strong></p>
<p>通过控制台或者终端工具登轻量云主机。首次登陆需要执行脚本命令配置京东云模型服务：</p>
<p>bash init-clawdbot.sh pk-xxxxx # 替换为你的 API-Key</p>
<p>执行初始化命令：</p>
<p>clawdbot onboard</p>
<p>按引导完成相关配置：</p>
<p>风险确认</p>
<p>聊天渠道绑定（如 Discord、飞书机器人等）</p>
<p>……</p>
<p>以上配置完成后，即可上手使用。快上京东云开启一键部署，让 Moltbot 成为你专属的 24 小时数字员工！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Moltbot（Clawdbot） + 飞书机器人：一次接入实践]]></title>    <link>https://juejin.cn/post/7600380007885832242</link>    <guid>https://juejin.cn/post/7600380007885832242</guid>    <pubDate>2026-01-29T05:32:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600380007885832242" data-draft-id="7600333405978279977" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Moltbot（Clawdbot） + 飞书机器人：一次接入实践"/> <meta itemprop="keywords" content="后端,AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T05:32:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洛卡卡了"/> <meta itemprop="url" content="https://juejin.cn/user/888839672963544"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Moltbot（Clawdbot） + 飞书机器人：一次接入实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/888839672963544/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洛卡卡了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:32:02.000Z" title="Thu Jan 29 2026 05:32:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">简单认识一下 Clawdbot</h3>
<p>大家好，我是卡卡。最近 AI 圈被一款名为 <strong>Clawdbot</strong> 的产品刷屏了，这几天不管是在国内技术社区，还是我晚上没事刷 TG、X 的时候，几乎都能看到有人在讨论它。<br/>
看了一下官方文档，Clawdbot 本质上就是一个偏“个人智能助手”的东西，只不过它不是单独开一个网页给我们用，而是可以直接接入我们平时常用的聊天软件，比如 WhatsApp、Telegram、Discord、Slack、Signal，甚至 iMessage，都可以当作它的交互入口。</p>
<p>真正让技术圈开始认真看待它的，其实是这种使用方式：AI 不跑在某个平台上，而是跑在我们自己的环境里，可以是本地电脑，也可以是个人服务器；我们和它的交互，还是通过熟悉的聊天工具，就像跟一个同事发消息一样；在权限允许的情况下，它可以直接操作文件、执行命令，长期记住上下文，变成一个真正属于我们的 AI 助手；而相关数据也都掌握在我们自己手里，不需要交给第三方平台托管。</p>
<hr/>
<h3 data-id="heading-1">Clawdbot 和我们常用的 AI 聊天工具有什么不一样？</h3>
<p>我第一次安装后在CLI工具里面用 Clawdbot 的时候，其实很容易产生一种错觉：<br/>
<strong>感觉这不就是换了个聊天框在用 Claude / GPT 吗？</strong><br/>
不管是在终端里，还是后面接到飞书、Telegram，输入一句话、等 AI 回复，体验上和 Claude、ChatGPT、豆包、DeepSeek 这些聊天工具确实很像啊。</p>
<p>但真正用下来会发现，两者的定位其实不一样。我们平时用的这些 AI，更像是对话型工具，比如我们问问题、写文案、查资料，用完这一轮基本就结束了；而 Clawdbot 更像是把 AI 变成了一个<strong>长期在线、能干活的助手</strong>。它不是跑在某个平台的聊天页面里，而是直接跑在我们自己的环境中，可以在权限允许的情况下操作文件、执行命令、记住长期上下文，再通过聊天软件把结果反馈给我们。</p>
<p>所以表面上看是在聊天，本质上其实是在<strong>通过聊天工具远程指挥一个跑在自己环境里的 AI</strong>，这也是它和 Claude、GPT 这类纯聊天产品最大的区别。</p>
<hr/>
<h3 data-id="heading-2">Clawdbot 和 Moltbot 是什么关系</h3>
<p>还有一个很多人一开始都会困惑的点：<br/>
<strong>为什么有的地方叫 Clawdbot，有的地方又变成了 Moltbot？</strong></p>
<p>实际上简单了解一下就会知道这并不是两个项目，也不是重写了一套代码，而是同一个项目在近期做了一次命名调整。最早项目对外叫 Clawdbot，后来改成了 Moltbot，主要是出于品牌和命名上的原因；但在具体使用时，我们会发现核心 CLI、运行时以及很多命令里，仍然保留着 Clawdbot 这个名字。</p>
<p>所以在安装和配置过程中，同时看到 Moltbot 和 Clawdbot 是一件很正常的事情，可以简单理解为：<strong>Moltbot 是现在对外的项目名称，Clawdbot 仍然是内部和工具层面的实际名字</strong>。这一点如果不提前说明，第一次上手时确实很容易让人产生困惑。</p>
<hr/>
<h3 data-id="heading-3">关于 Clawdbot 的一些风险考虑</h3>
<p>在继续往下折腾之前，我还是简单考虑了一下 Clawdbot 这类工具本身带来的风险。<br/>
Clawdbot 需要运行在本地电脑或服务器上，并且在实际使用中会涉及文件读写、命令执行等操作，这决定了它并不是一个只聊天、不碰系统的工具。</p>
<p>从工程角度来看，只要涉及到较高权限，就不可避免会有安全层面的顾虑，比如配置是否足够隔离、代码是否完全可控，以及长期运行在一台机器上的影响等问题。这些点目前我自己也还在了解过程中，并没有形成特别成熟的判断。</p>
<p>基于这些考虑，我目前的使用方式还是比较保守：只在个人环境中搭建，用来体验功能和验证流程；在工程实践或生产环境中，暂时不打算直接引入这一套方案。这个使用角度方面大家结合自己的情况自行考虑哈。</p>
<hr/>
<h3 data-id="heading-4">安装环境说明</h3>
<p>接下来就开始安装了。因为我平时一直用的是 Mac，所以这次的安装过程也是基于 macOS 来记录的。<br/>
至于 Windows 或者直接在云服务器上的安装方式，我这边没有逐一去测试，整体思路是一样的，细节差异大家可以参考其他文章，已经有不少写得很详细了。</p>
<p>在正式安装之前，需要先准备好运行环境。Clawdbot / Moltbot 是基于 Node.js 的工具，所以本地需要提前安装好 Node 环境，版本不要太老即可，正常使用官方的 Node LTS 基本都没问题。如果这一步没装，后面执行安装脚本时会直接报错。</p>
<p>另外再强调一次哈，如果有些同学只是想体验功能、熟悉流程，其实不一定非要在我们自己主力电脑上折腾的。更稳妥的方式是单独买一台测试用的 VPS 或轻量服务器来跑，当作一个隔离的实验环境，用起来也会更安心一些。</p>
<hr/>
<h3 data-id="heading-5">可选方案说明</h3>
<p>如果有同学觉得从环境准备到一步步执行命令还是有点麻烦，其实也可以试试阿里云这边提供的 <strong>Clawdbot 一键安装方案</strong>。</p>
<p>阿里云已经把基础环境和安装流程打包好了，整体更偏向“开箱即用”，适合只是想快速体验一下的同学。相关入口在这里：  <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Factivity%2Fecs%2Fclawdbot%3FuserCode%3Doq2t54oi" target="_blank" title="https://www.aliyun.com/activity/ecs/clawdbot?userCode=oq2t54oi" ref="nofollow noopener noreferrer">一键部署</a></p>
<p>不过这篇文章里，我还是选择手动安装的方式来记录，一方面流程更清楚，另一方面也方便后面自己排查问题。如果只是图省事，一键安装也是一个可以考虑的选择。</p>
<hr/>
<h3 data-id="heading-6">安装 Moltbot</h3>
<blockquote>
<p>环境准备好之后，安装过程本身反而很简单，直接使用官方提供的安装脚本即可，一条命令就能完成基础安
装：</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://molt.bot/install.sh | bash
</code></pre>
<blockquote>
<p>这个脚本会自动完成 CLI 的下载和基础配置，安装完成后就可以使用 <code>clawdbot</code> 相关命令继续后面的初始化和配置流程。</p>
</blockquote>
<p><img src="https://typora.luokakale.com/typora/20260129095259067.png" alt="image-20260129095258962" loading="lazy"/></p>
<p>如果是第一次安装，过程会稍微慢一点，中间看起来像是卡住了，其实是在下载和初始化依赖，等它跑完就行。
当脚本执行完成后，终端里会自动进入 Clawdbot（现在也叫 Moltbot）的初始化引导界面:
<img src="https://typora.luokakale.com/typora/20260129095334650.png" alt="image-20260129095334616" loading="lazy"/></p>
<p>首先出现的就是这个安全确认提示。大概意思是：Clawdbot 属于权限比较高的 AI Agent，后面可能会涉及本地命令、文件读写等操作，官方在这里提前提醒存在一定风险，需要我们确认是否继续。<br/>
如果只是像本文一样做本地测试、体验功能、后面接入飞书聊天，这里<strong>直接选择 <code>Yes</code> 即可</strong>，继续后面的配置流程。</p>
<hr/>
<p>接下来是初始化方式的选择，这里有 <strong>QuickStart</strong> 和 <strong>Manual</strong> 两种模式。<br/>
QuickStart 相当于帮我们先用一套默认、安全的配置把 Clawdbot 跑起来，后面的模型、渠道、权限等都可以再单独调整；Manual 则是从一开始就自己一项一项配置，步骤会多一些。<br/>
为了先把流程跑通，这里我们直接选择 <strong>QuickStart</strong> 即可。
<img src="https://typora.luokakale.com/typora/20260129095458001.png" alt="image-20260129095457952" loading="lazy"/></p>
<hr/>
<p>接下来会进入模型和鉴权方式的选择，这里可以看到支持的模型非常多，包括 OpenAI、Qwen、MiniMax、Google、Copilot 等。<br/>
因为 Clawdbot 是一个常驻的 AI 助手，随时可能被调用，实际使用过程中对 token 的消耗会比较明显，所以如果只是长期挂着用，选择一些 <strong>免费或成本较低的模型</strong>（比如通义千问这一类）其实也完全没问题。<br/>
我这边本身有 <strong>ChatGPT Plus</strong>，主要也是为了体验 OpenAI 这条链路，所以这里直接选择了 <strong>OpenAI</strong> 作为模型来源。
<img src="https://typora.luokakale.com/typora/20260129095603277.png" alt="image-20260129095603225" loading="lazy"/></p>
<p>这里我选择OpenAI后 我选择OpenAI Codex 来进行ChatGPT OAuth授权</p>
<p><img src="https://typora.luokakale.com/typora/20260129095617412.png" alt="image-20260129095617361" loading="lazy"/></p>
<p>选中后会弹出提示使用ChatGPT 登录到Codex确认页面。</p>
<p><img src="https://typora.luokakale.com/typora/20260129095722415.png" alt="image-20260129095722356" loading="lazy"/></p>
<p>我们点击继续后 会弹出授权成功，然后我们复制地址栏回调地址到我们的命令窗口</p>
<p><img src="https://typora.luokakale.com/typora/20260129095741094.png" alt="image-20260129095741036" loading="lazy"/></p>
<p>这里我们在命令窗口黏贴我们上面授权成功的回调地址后就成了，然后就是选择使用哪个模型，这里我是保持使用gpt-5.2</p>
<p><img src="https://typora.luokakale.com/typora/20260129095935818.png" alt="image-20260129095935750" loading="lazy"/></p>
<p>接下来是聊天渠道的选择，Clawdbot 默认支持的渠道非常多，包括 Telegram、WhatsApp、Discord、Slack 等。<br/>
因为本文后面会单独介绍 <strong>飞书（Lark）</strong> 的配置方式，而飞书并不在这个 QuickStart 列表里，所以这里我们先<strong>不选择任何聊天渠道</strong>，直接选最下面的 <strong><code>Skip for now</code></strong>，先把基础环境跑起来，后续再手动配置飞书即可。
<img src="https://typora.luokakale.com/typora/20260129100047510.png" alt="image-20260129100047432" loading="lazy"/></p>
<p>接下来会询问是否要现在配置 Skills（技能）。这里可以理解为一些额外的自动化能力和扩展功能，但并不是安装和基础聊天所必需的内容。<br/>
为了先把整体流程跑通、减少干扰，这里我们<strong>直接选择 <code>No</code></strong>，后面如果有需要，再单独开启和配置即可。
<img src="https://typora.luokakale.com/typora/20260129100152734.png" alt="image-20260129100152655" loading="lazy"/></p>
<p>接下来是 Hooks 的配置，这里主要是一些用于自动化的小钩子，比如在特定指令触发时自动记录会话、保存上下文之类的功能。<br/>
这些能力对后续深度使用会比较有帮助，但并不是基础聊天或接入飞书所必需的内容。为了先把主流程走完，这里我们同样<strong>选择 <code>Skip for now</code></strong>，然后按空格键确认。后面有需要再单独开启即可。
<img src="https://typora.luokakale.com/typora/20260129100217401.png" alt="image-20260129100217324" loading="lazy"/>
<img src="https://typora.luokakale.com/typora/20260129100452586.png" alt="image-20260129100452502" loading="lazy"/></p>
<p>最后会询问以哪种方式启动（hatch）这个 bot，这里提供了终端交互（TUI）、Web 界面以及稍后再说三种方式。<br/>
因为我们接下来还要继续做飞书相关的配置，不急着马上启动交互界面，所以这里<strong>直接选择 <code>Do this later</code></strong>，先完成初始化流程，后续需要用的时候再手动启动即可。
<img src="https://typora.luokakale.com/typora/20260129100539236.png" alt="image-20260129100539148" loading="lazy"/></p>
<hr/>
<p>安装完成后，可以通过下面这个命令查看 Clawdbot 当前的运行状态：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot status
</code></pre>
<p>执行后会看到一份状态汇总信息，主要用来确认几件事：<br/>
服务是否已经正常启动、本地 Gateway 有没有跑起来、Dashboard 是否可以访问，以及当前使用的模型和会话状态。</p>
<p>如果像我这样能看到本地 <code>127.0.0.1</code> 的 Dashboard 地址，并且状态显示为 running，基本就说明安装和初始化都是正常的，可以继续往下折腾了。</p>
<p><img src="https://typora.luokakale.com/typora/20260129101023173.png" alt="image-20260129101023074" loading="lazy"/></p>
<hr/>
<p>接下来我们简单测试一下 Clawdbot 是否真的已经跑起来了。</p>
<p>直接在终端里执行：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot tui
</code></pre>
<p>会进入一个类似聊天窗口的界面，随便输入一句话或者一个简单指令。如果像上图这样能够正常收到回复，说明 Clawdbot 已经可以正常工作了，整个安装和基础配置也算完成。
<img src="https://typora.luokakale.com/typora/20260129101449801.png" alt="image-20260129101449696" loading="lazy"/></p>
<p>到这里为止，其实我们已经有了一个能对话、能响应的本地 AI 助手，后面要做的事情，就是把它接入到飞书里，用聊天的方式来用它。</p>
<hr/>
<h3 data-id="heading-7">飞书侧准备：创建企业自建应用</h3>
<p>接下来我们开始配置飞书相关流程。<br/>
第一步，先到飞书开放平台创建一个应用。</p>
<p>打开飞书开放平台：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fapp" target="_blank" title="https://open.feishu.cn/app" ref="nofollow noopener noreferrer">open.feishu.cn/app</a><br/>
进入后，切换到 <strong>「企业自建应用」</strong> 页面，点击 <strong>「创建企业自建应用」</strong>。<br/>
这里创建的是企业内部使用的应用，刚好符合我们把 Clawdbot 接入飞书做个人/团队助手的场景。
<img src="https://typora.luokakale.com/typora/20260129111019748.png" alt="image-20260129111019581" loading="lazy"/></p>
<p><img src="https://typora.luokakale.com/typora/20260129111113877.png" alt="image-20260129111113730" loading="lazy"/></p>
<p>创建好企业自建应用后，进入应用详情页，在 <strong>「凭证与基础信息」</strong> 页面中，就可以看到应用的 <strong>AppID</strong> 和 <strong>AppSecret</strong>。</p>
<p><img src="https://typora.luokakale.com/typora/20260129111156987.png" alt="image-20260129111156832" loading="lazy"/></p>
<p>这两个值是后面 Clawdbot 接入飞书时必须用到的身份凭证，记得先复制保存好，<strong>不要泄露给其他人</strong>。<br/>
接下来我们会把这两个参数配置到 Clawdbot 中，用来完成飞书侧的身份校验。</p>
<hr/>
<h3 data-id="heading-8">安装并配置 Clawdbot 飞书插件</h3>
<p>前面飞书应用已经创建好，也拿到了 <strong>AppID</strong> 和 <strong>AppSecret</strong>，接下来我们就可以开始配置 Clawdbot 这边了。</p>
<h4 data-id="heading-9">安装飞书插件</h4>
<p>首先安装 Clawdbot 的飞书插件，直接执行下面这条命令即可：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot plugins install @m1heng-clawd/feishu
</code></pre>
<p>安装过程如果没有报错，基本就说明插件已经就位了。
<img src="https://typora.luokakale.com/typora/20260129111715728.png" alt="image-20260129111715554" loading="lazy"/></p>
<h4 data-id="heading-10">配置飞书应用信息</h4>
<p>接下来把刚才在飞书后台拿到的 <strong>AppID</strong> 和 <strong>AppSecret</strong> 配置到 Clawdbot 中：</p>
<pre><code class="hljs language-arduino" lang="arduino">clawdbot config set channels.feishu.appId <span class="hljs-string">"你的AppID"</span>
clawdbot config set channels.feishu.appSecret <span class="hljs-string">"你的AppSecret"</span>
</code></pre>
<p>然后启用飞书这个 channel：</p>
<pre><code class="hljs language-arduino" lang="arduino">clawdbot config set channels.feishu.enabled <span class="hljs-literal">true</span>
</code></pre>
<p>上面的配置修改完成后，需要重启一次 Gateway 才会真正生效：</p>
<pre><code class="hljs">clawdbot gateway restart
</code></pre>
<p>到这里，Clawdbot 这一侧的飞书插件就算配置完成了，后面只需要在飞书里验证消息是否能正常收发即可。</p>
<p><img src="https://typora.luokakale.com/typora/20260129112009038.png" alt="image-20260129112008889" loading="lazy"/></p>
<h4 data-id="heading-11">如何确认飞书已经配置成功？</h4>
<p>飞书插件配置完成并重启 Gateway 之后，我们需要确认 <strong>Clawdbot 这边是否已经成功连上飞书</strong>。<br/>
最直接的方式就是查看实时日志。</p>
<p>在终端执行下面这条命令：</p>
<pre><code class="hljs language-css" lang="css">clawdbot logs <span class="hljs-attr">--follow</span>
</code></pre>
<p>如果日志中能看到类似下面这样的内容（如图所示）：
<img src="https://typora.luokakale.com/typora/20260129112108593.png" alt="image-20260129112108431" loading="lazy"/></p>
<p>说明 Clawdbot 已经成功启动了飞书通道，并且通过 <strong>WebSocket 长连接</strong> 等待飞书事件回调。</p>
<p>这一步出现这些日志，就可以基本确认：<br/>
<strong>Clawdbot 这一侧的飞书配置是 OK 的</strong></p>
<p>接下来要做的，就是回到 <strong>飞书开放平台</strong>，继续配置应用权限、事件订阅等内容，让飞书真正把消息推送过来。</p>
<h4 data-id="heading-12">在飞书开放平台配置应用权限</h4>
<p>前面 Clawdbot 和飞书插件我们已经跑起来了，但这一步<strong>非常关键</strong>：<br/>
不配置权限，机器人是<strong>收不到消息、也发不了消息的</strong>。</p>
<p>下面我们回到 <strong>飞书开放平台 → 当前应用 → 权限管理</strong>。
<img src="https://typora.luokakale.com/typora/20260129112534160.png" alt="image-20260129112533987" loading="lazy"/></p>
<h4 data-id="heading-13">使用 JSON 批量导入权限</h4>
<p>在权限管理页面，点击 <strong>「批量导入/导出权限」</strong>，选择 <strong>JSON 导入</strong>，把下面这段配置完整粘贴进去：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scopes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tenant"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"im:message.group_msg"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message.p2p_msg:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message.reactions:read"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:recall"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:send_as_bot"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:update"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:resource"</span><span class="hljs-punctuation">,</span>

      <span class="hljs-string">"contact:user.base:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"contact:contact.base:readonly"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"docx:document:readonly"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>这些权限是干什么用的</strong></p>
<p>简单说一下我们这些到底给了机器人什么能力：</p>
<ul>
<li>
<p><strong>消息相关</strong></p>
<ul>
<li>读取群聊和单聊消息</li>
<li>以机器人的身份发送消息</li>
<li>更新、撤回消息</li>
<li>读取消息里的表情、图片、文件等资源</li>
</ul>
</li>
<li>
<p><strong>事件相关</strong></p>
<ul>
<li>接收群聊中 @ 机器人的事件（这是机器人能被“叫醒”的关键）</li>
</ul>
</li>
<li>
<p><strong>通讯录相关</strong></p>
<ul>
<li>获取用户和通讯录的基础信息</li>
</ul>
</li>
<li>
<p><strong>文档相关</strong></p>
<ul>
<li>读取用户的飞书文档（后面做文章流、内容处理会用到）</li>
</ul>
</li>
</ul>
<p>这些权限基本是「能正常做一个飞书机器人」的最低配置。</p>
<h4 data-id="heading-14">确认并导入权限配置</h4>
<p>前面把权限 JSON 粘贴进去之后，点击 <strong>「下一步，确认新增权限」</strong> 就可以了。</p>
<p>我们会看到一个确认页，如图所示，列出了这次新增的权限列表。这里主要确认两点就行：</p>
<ul>
<li>应用身份权限里，消息、通讯录、资源相关的权限都在</li>
<li>用户身份权限里，有文档只读权限
<img src="https://typora.luokakale.com/typora/20260129113023462.png" alt="image-20260129113023297" loading="lazy"/></li>
</ul>
<p><img src="https://typora.luokakale.com/typora/20260129113322992.png" alt="image-20260129113322772" loading="lazy"/></p>
<p><img src="https://typora.luokakale.com/typora/20260129113406267.png" alt="image-20260129113406094" loading="lazy"/></p>
<p>如果这些都在，直接点 <strong>「申请开通」</strong>。</p>
<p>这时候页面顶部一般会提示一句话：</p>
<blockquote>
<p>应用发布后，当前配置方可生效</p>
</blockquote>
<p>这个不用慌，是飞书的正常流程。意思是：</p>
<ul>
<li>权限<strong>已经配置成功</strong></li>
<li>但还没有真正生效</li>
<li>需要后面 <strong>创建版本并发布应用</strong>，权限才会下发给这个应用</li>
</ul>
<p>所以到这里为止，<strong>权限配置这一步就算完成了</strong>。</p>
<hr/>
<h4 data-id="heading-15">配置飞书事件（接收消息）</h4>
<p>接下来需要配置飞书的事件回调。</p>
<p>在飞书开放平台里，进入左侧的「事件与回调」页面，先做事件配置。<br/>
订阅方式这里选择 <strong>使用长连接接收事件</strong>，这个方式不需要额外配置回调地址，和 Clawdbot 的工作方式是匹配的。选好之后直接点击保存。
<img src="https://typora.luokakale.com/typora/20260129113622363.png" alt="image-20260129113622145" loading="lazy"/></p>
<p>保存完成后，点击下面的「添加事件」按钮，在事件列表里找到 <strong>接收消息</strong>，勾选这一项，然后确认添加。</p>
<p><img src="https://typora.luokakale.com/typora/20260129113810247.png" alt="image-20260129113810037" loading="lazy"/></p>
<p>做到这一步，飞书在有人给机器人发消息时，就会把事件通过长连接推送给 Clawdbot，后面我们才能正常接收和处理消息。</p>
<h4 data-id="heading-16">发布应用</h4>
<p>前面的权限和事件都配置完成后，最后一步就是发布应用。</p>
<p>在左侧进入「版本管理与发布」，点击创建版本，填写版本号和更新说明。<br/>
移动端和桌面端的默认能力都选择「机器人」，保持默认即可。
<img src="https://typora.luokakale.com/typora/20260129113940867.png" alt="image-20260129113940671" loading="lazy"/></p>
<p>确认信息无误后，直接提交并发布。<br/>
如果页面提示“本次发布免审核，提交发布后即可上线使用”，说明这是企业自建应用，发布完成后权限和事件会立刻生效。</p>
<p>到这里，飞书侧的配置就全部完成了，机器人已经可以正常接收和回复消息了。</p>
<hr/>
<h3 data-id="heading-17">测试飞书聊天是否正常</h3>
<p>应用发布完成后，我们回到飞书客户端，直接和刚创建的机器人私聊即可。
<img src="https://typora.luokakale.com/typora/20260129120519655.png" alt="image-20260129120519327" loading="lazy"/></p>
<p>像图里这样，给机器人发一条普通消息，如果机器人能够正常回复，说明三件事都已经生效了：</p>
<ul>
<li>飞书应用已经成功发布</li>
<li>事件订阅（接收消息）配置正确</li>
<li>Clawdbot 本地服务和飞书通道已经连通</li>
</ul>
<p>只要能正常对话，说明整个飞书接入流程已经跑通，后面就可以开始接具体的自动化流程或业务逻辑了。</p>
<hr/>
<h3 data-id="heading-18">测试 Clawdbot 的本地自动化能力</h3>
<p>前面只是确认机器人能不能聊天，这一步我们来真正测一下 Clawdbot 能干什么。</p>
<p>在飞书聊天窗口里，直接对机器人输入一条指令，比如：</p>
<blockquote>
<p>帮我打开 ToDesk 远程工具</p>
</blockquote>
<p>如果配置正常，Clawdbot 会在本地自动执行这个动作，我们会看到 Mac 上的 ToDesk 应用被直接唤起，就像我们自己点开了一样。
<img src="https://typora.luokakale.com/typora/20260129122223815.gif" alt="output" loading="lazy"/></p>
<p>这个测试主要是为了确认两件事：</p>
<ul>
<li>飞书消息已经能正确传到本地的 Clawdbot</li>
<li>Clawdbot 已经具备执行本地指令、控制电脑的能力</li>
</ul>
<p>只要这一步能跑通，后面不管是打开应用、执行脚本，还是做更复杂的自动化流程，本质上都是在这个基础上往上叠功能。</p>
<hr/>
<h3 data-id="heading-19">那这个东西到底能干什么？</h3>
<p>前面我们已经试过了，一句话就能把本地的 ToDesk 打开。<br/>
看到这里，其实就能大概明白 Clawdbot 的定位了。</p>
<p>它不是用来聊天的，而是用来<strong>接管一些日常操作</strong>的。</p>
<p>从使用场景上看，我觉得大概可以分成几类。</p>
<p>第一类，是<strong>替代重复点击</strong>。<br/>
像打开某个软件、进入固定网站、启动一套常用工具，这些每天都会做，但又不值得专门写脚本的事情，都可以直接用一句话完成。</p>
<p>第二类，是<strong>固定流程的触发器</strong>。<br/>
平时有一整套顺序操作，比如连远程、起服务、看状态，不需要一步一步点，只要一句指令，剩下的交给它执行。</p>
<p>第三类，是<strong>个人习惯型操作</strong>。<br/>
有些动作只有自己知道，比如写东西前、下班前、排查问题时的一套固定操作，这些不通用，但很适合交给 Clawdbot记住。</p>
<p>整体来看，它更像是一个<strong>听得懂人话、又能真的去做事的工具</strong>。<br/>
不是回答问题，而是接收指令、执行动作。</p>
<p>也正因为这样，前面才需要配置插件、权限和事件。<br/>
这些都准备好之后，Clawdbot 才真正“进到系统里”。</p>
<hr/>
<h3 data-id="heading-20">写在最后</h3>
<p>到这里，Clawdbot 加飞书的整个流程我们基本就跑通了。<br/>
从下载安装到权限、事件配置，再到能在飞书里发消息、在本地执行操作，整体体验还是比较顺的。</p>
<p>需要注意的一点是，这种常驻型的 AI 助手，<strong>对模型调用是持续发生的</strong>，不像平时在网页里偶尔问几句。<br/>
如果接入的是按量计费的模型，实际使用时还是要留意一下 token 消耗，避免后台一直跑着却没注意到费用变化。</p>
<p>目前我这边更多还是把它当成个人助手来用，在自己可控的环境里慢慢试，先摸清楚边界和成本，再决定要不要接到更正式的场景里。</p>
<p>整体来看，这套东西更适合愿意折腾、也清楚自己在干什么的人。<br/>
至于值不值得上，还是看自己的使用习惯和场景哈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用skills做了一个AI语音助手，可呼唤AI语音军团帮我干活了]]></title>    <link>https://juejin.cn/post/7600326947505684532</link>    <guid>https://juejin.cn/post/7600326947505684532</guid>    <pubDate>2026-01-29T04:30:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326947505684532" data-draft-id="7600345782172680226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用skills做了一个AI语音助手，可呼唤AI语音军团帮我干活了"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T04:30:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="500佰"/> <meta itemprop="url" content="https://juejin.cn/user/3182441343757755"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用skills做了一个AI语音助手，可呼唤AI语音军团帮我干活了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3182441343757755/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    500佰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:30:39.000Z" title="Thu Jan 29 2026 04:30:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfd80ed077ed4f419d18a3730bebbc83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=OHuyePu7T%2BVuM5QUwHXeVuPaJT4%3D" alt="image-20260129000515998.png" loading="lazy"/></p>
<p>语音助手，我一直想自己拥有一个。</p>
<p>近期，浏览到语音输入动向，智谱AutoGLM、还有typeless语音助手，闪电的语音识别能力，于是自己动手vb coding了一个<code>语音助手</code>出来。</p>
<p>究其重点，我这个语音助手识别的速度和准确率一点也不输给AutoGLM。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99c5fda463d44dd1a4883e5cca55e2d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=fK%2B3G3TTuMpl%2FAwyb4pEitO4LCE%3D" alt="PixPin_2026-01-29_02-49-05.gif" loading="lazy"/></p>
<p>折腾了三个晚上，先借助了opencode的里面的skills来<code>制定产品规格文档</code>和UI设计，关于AI开发流程控制的4个skills可追<a href="https://juejin.cn/post/7597083743555813419" target="_blank" title="https://juejin.cn/post/7597083743555813419">AI 开发必用的4个skills组合，用来流畅掌控AI开发流程 ，灵活控制AI（opencode skills） </a>，这篇文章skills领取的人数已经超过<code>90位</code>了，非常推荐去使用这个4个skills指令式的去和AI进行高效对话。</p>
<p>然后，<code>语音桌面控制</code>和语音输入文字插入文档，这个两个功能借助的<code>Antigravity</code>编辑器去开发，近期还能使用Gemini 3 Flash、Claude Opus等强大模型。</p>
<p>后端部分，借助了科大讯飞语音识别API的Java实现，主要用于中文语音识别。提供HTTP服务器接口接收音频数据，直接处理音频文件的识别。</p>
<blockquote>
<p>语音助手我已经打包好了，一键安装即可，想试玩或语音输入党可后台发送语音助手，我可分享，提供语音APIkey。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/403e7be9e09c4ff7bdf0bbc30fdb6ef4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=IcxUoqs2BSY38RI2JFGECvC42N8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-0">01 全局语音唤醒</h4>
<p>全局语音唤醒，<code>Right Ctrl</code>键唤醒语音助手，长按即说，松开即执行，即便输入了很长的一段话，1秒就能将语音闪电般转换为文字，下面是我进行的一些语音对话记录（连续语音对话），语音识别正确率80%+。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6766cd9f71e04568a63d8927b7345b0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=fyyIwTCzGmgjltDPY3SdyQf%2BitI%3D" alt="image-20260129004823972.png" loading="lazy"/></p>
<h4 data-id="heading-1">02 语音桌面控制</h4>
<p><code>语音桌面控制</code>，核心不再手动配置应用路径，而动态扫描 Windows 开始菜单，支持所有桌面软件（.exe）和 <code>UWP</code> （应用商店应用）。</p>
<p>桌面应用启动，我通常工作时需要开启的桌面应用较多（写文档、微信、聊天、IDE、浏览器），有时候脑子空白时，通过语音助手能快速启动应用，特别对于桌面一团糟的人来说，就能提高查找效率，也能直接在当前的窗口，<code>直接唤起语音呼叫应用</code>的到来。</p>
<p>我增加了智能容错匹配，即便语音识别出同音字、缩写，或者加上了软件、应用等修词，语音助手也能精准找到目标桌面应用，精准<code>启动我们的桌面应用</code>。关闭功能我暂时删除了，关闭对于多数人来说，不如手动点击关闭，来得更痛快。</p>
<p>启动之前会提示确认/取消，enter一键确认启动。如果3秒超时未确认，则会自动取消。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7049f9cac3a44fc7ba617d50a10c4ee6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=LVxPsHBXjOglqxSLaNmMaPl5qVc%3D" alt="image-20260129011403665.png" loading="lazy"/></p>
<p>精确/变体匹配，先将语音识别出的文字进行去除空格、取首个单词等变形，尝试与系统 App 列表直接比对。如果第一步失败，会计算两个字符串之间的字符重叠比例。比如Focus See录屏软件，语音听成了Focus C 也能精确匹配到。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca1a9b22a314b6eb3b8cdc7741b4e47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=UchfsBqkBULmEMDZhAhpofgSfJc%3D" alt="PixPin_2026-01-29_03-07-28.gif" loading="lazy"/>
如果想语言丰富一些，比如 [ <code>你好你好，请启动Cursor</code> ]，也是可行的。下面是我写文超时取消了启动，我另外语音启动时的截图，启动时会自动模糊匹配应用的AppID。</p>
<blockquote>
<p>你好你好，请启动Cursor</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d18e3ad7e0ca4a84ac090c2282c5334a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=jxr08r2VN6HVg6AOs6lA%2BjgGl6M%3D" alt="image-20260129012021646.png" loading="lazy"/></p>
<blockquote>
<p>正在发送识别请求...<br/>
识别结果: 你好你好，我的助手请启动Cursor。<br/>
正在执行: { action: 'start', app: 'Cursor' }<br/>
[模糊查询] 匹配成功: "Cursor" -&gt; Cursor<br/>
找到应用 AppID: Anysphere.Cursor</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75cc435a3e794171bc9e276ecf1251e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNTAw5L2w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770265842&amp;x-signature=Y%2FcG5ytngQga%2FftwiGE2S9MqDe0%3D" alt="image-20260129012729971.png" loading="lazy"/></p>
<h4 data-id="heading-2">写在最后</h4>
<p>敲一下键盘就偷偷开始录音（PCM格式），利用 node-global-key-listener 监听键盘，它会不停轮询信号文件，发现文件存在就调用开始捕获麦克风数据，发现文件消失就停止把说的话实时丢给后端做语音转文字，后端识别完以后用 JS 正则表达式抓出指令，再交给 executeAppCommand 去执行，从键盘触发录音到语音指令执行的自动化流程，想想就挺丝滑的。</p>
<blockquote>
<p>语音助手我已经打包好了，一键安装即可，想试玩或语音输入党可后台发<code>送语音助手</code>，我可分享，提供语音APIkey。</p>
<p>关注我，获取更多编程/AI实战教程！</p>
<p>vx： <code>Auwubai</code> 添加，入AI技术动向社群，我们一起卷卷AI。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go公链实战0x06转账(1)]]></title>    <link>https://juejin.cn/post/7600318091831836699</link>    <guid>https://juejin.cn/post/7600318091831836699</guid>    <pubDate>2026-01-29T05:23:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600318091831836699" data-draft-id="6845075572612153352" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go公链实战0x06转账(1)"/> <meta itemprop="keywords" content="区块链,Go"/> <meta itemprop="datePublished" content="2026-01-29T05:23:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="chaors"/> <meta itemprop="url" content="https://juejin.cn/user/272334613646695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go公链实战0x06转账(1)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334613646695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    chaors
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:23:08.000Z" title="Thu Jan 29 2026 05:23:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上次基本实现了交易的数据结构,在此基础上便可以来实现转账,即区块链的普通交易.</p>
<h3 data-id="heading-0">cli转账命令</h3>
<p>我们知道挖矿的目的是找到一个公认的记账人把当前的所有交易打包到区块并添加到区块链上.之前我们使用addBlock命令实现添加区块到区块链的,这里转账包含挖矿并添加到区块链.所以,我们需要在cli工具类里用转账命令send代替addBlock命令.</p>
<p>其次我们都知道,一次区块可以包括多个交易.因此,这里我们的转账命令要设计成支持多笔转账.</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">//命令说明方法 打印目前左右命令使用方法</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">printUsage</span>() {
	fmt.<span class="hljs-type">Println</span>(<span class="hljs-string">"Usage:"</span>)
	fmt.<span class="hljs-type">Println</span>(<span class="hljs-string">"<span class="hljs-subst">\t</span>createBlockchain -address --创世区块地址 "</span>)
	fmt.<span class="hljs-type">Println</span>(<span class="hljs-string">"<span class="hljs-subst">\t</span>send -from FROM -to TO -amount AMOUNT --交易明细"</span>)
	fmt.<span class="hljs-type">Println</span>(<span class="hljs-string">"<span class="hljs-subst">\t</span>printchain --打印所有区块信息"</span>)
	fmt.<span class="hljs-type">Println</span>(<span class="hljs-string">"<span class="hljs-subst">\t</span>getbalance -address -- 输出区块信息."</span>)
}
</code></pre>

<pre><code class="hljs language-scss" lang="scss">func (cli *CLI) <span class="hljs-built_in">Run</span>() {

	<span class="hljs-built_in">isValidArgs</span>()

	<span class="hljs-comment">//自定义cli命令</span>
	<span class="hljs-comment">//转账</span>
	sendBlockCmd := flag.<span class="hljs-built_in">NewFlagSet</span>(<span class="hljs-string">"send"</span>, flag.ExitOnError)
	printchainCmd := flag.<span class="hljs-built_in">NewFlagSet</span>(<span class="hljs-string">"printchain"</span>, flag.ExitOnError)
	createBlockchainCmd := flag.<span class="hljs-built_in">NewFlagSet</span>(<span class="hljs-string">"createBlockchain"</span>, flag.ExitOnError)
	blanceBlockCmd := flag.<span class="hljs-built_in">NewFlagSet</span>(<span class="hljs-string">"getBalance"</span>, flag.ExitOnError)

	//addBlockCmd 设置默认参数
	flagSendBlockFrom := sendBlockCmd.<span class="hljs-built_in">String</span>(<span class="hljs-string">"from"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"源地址"</span>)
	flagSendBlockTo := sendBlockCmd.<span class="hljs-built_in">String</span>(<span class="hljs-string">"to"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"目标地址"</span>)
	flagSendBlockAmount := sendBlockCmd.<span class="hljs-built_in">String</span>(<span class="hljs-string">"amount"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"转账金额"</span>)
	flagCreateBlockchainAddress := createBlockchainCmd.<span class="hljs-built_in">String</span>(<span class="hljs-string">"address"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"创世区块地址"</span>)
	flagBlanceBlockAddress := blanceBlockCmd.<span class="hljs-built_in">String</span>(<span class="hljs-string">"address"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"输出区块信息"</span>)

	//解析输入的第二个参数是addBlock还是printchain，第一个参数为./main
	switch os.Args[<span class="hljs-number">1</span>] {
	case "send":
		//第二个参数为相应命令，取第三个参数开始作为参数并解析
		err := sendBlockCmd.<span class="hljs-built_in">Parse</span>(os.Args[<span class="hljs-number">2</span>:])
		if err != nil {
			log<span class="hljs-selector-class">.Panic</span>(err)
		}
	case "printchain":
		err := printchainCmd.<span class="hljs-built_in">Parse</span>(os.Args[<span class="hljs-number">2</span>:])
		if err != nil {
			log<span class="hljs-selector-class">.Panic</span>(err)
		}
	case "createBlockchain":
		err := createBlockchainCmd.<span class="hljs-built_in">Parse</span>(os.Args[<span class="hljs-number">2</span>:])
		if err != nil {
			log<span class="hljs-selector-class">.Panic</span>(err)
		}
	case "getBalance":
		err := blanceBlockCmd.<span class="hljs-built_in">Parse</span>(os.Args[<span class="hljs-number">2</span>:])
		if err != nil {
			log<span class="hljs-selector-class">.Panic</span>(err)
		}
	default:
		<span class="hljs-built_in">printUsage</span>()
		os.<span class="hljs-built_in">Exit</span>(<span class="hljs-number">1</span>)
	}

	<span class="hljs-comment">//对addBlockCmd命令的解析</span>
	if sendBlockCmd<span class="hljs-selector-class">.Parsed</span>() {

		if *flagSendBlockFrom == "" {

			<span class="hljs-built_in">printUsage</span>()
			os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)
		}
		if *flagSendBlockTo == "" {

			<span class="hljs-built_in">printUsage</span>()
			os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)
		}
		if *flagSendBlockAmount == "" {

			<span class="hljs-built_in">printUsage</span>()
			os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)
		}

		<span class="hljs-comment">//cli.addBlock(*flagAddBlockData)</span>

		<span class="hljs-comment">//这里真正地调用转账方法</span>
		<span class="hljs-comment">//fmt.Println(*flagSendBlockFrom)</span>
		<span class="hljs-comment">//fmt.Println(*flagSendBlockTo)</span>
		<span class="hljs-comment">//fmt.Println(*flagSendBlockAmount)</span>
		<span class="hljs-comment">//</span>
		<span class="hljs-comment">//fmt.Println(Json2Array(*flagSendBlockFrom))</span>
		<span class="hljs-comment">//fmt.Println(Json2Array(*flagSendBlockTo))</span>
		<span class="hljs-comment">//fmt.Println(Json2Array(*flagSendBlockAmount))</span>
		cli<span class="hljs-selector-class">.send</span>(
			Json2Array(*flagSendBlockFrom),
			<span class="hljs-built_in">Json2Array</span>(*flagSendBlockTo),
			<span class="hljs-built_in">Json2Array</span>(*flagSendBlockAmount),
			)
	}
	<span class="hljs-comment">//对printchainCmd命令的解析</span>
	if printchainCmd<span class="hljs-selector-class">.Parsed</span>() {

		cli<span class="hljs-selector-class">.printchain</span>()
	}
	<span class="hljs-comment">//</span>
	if createBlockchainCmd<span class="hljs-selector-class">.Parsed</span>() {

		if *flagCreateBlockchainAddress == "" {

			cli<span class="hljs-selector-class">.creatBlockchain</span>(*flagCreateBlockchainAddress)
		}

		cli<span class="hljs-selector-class">.creatBlockchain</span>(*flagCreateBlockchainAddress)
	}

	if blanceBlockCmd<span class="hljs-selector-class">.Parsed</span>() {

		if *flagBlanceBlockAddress == "" {

			<span class="hljs-built_in">printUsage</span>()
			os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)
		}

		cli<span class="hljs-selector-class">.getBlance</span>(*flagBlanceBlockAddress)
	}
}
</code></pre>
<h3 data-id="heading-1">Json2Arr</h3>
<p>命令行输入的都是字符串,要想让转账命令支持多笔转账,则输入的信息是json形式的数组.在编码实现解析并转账的时候,我们需要将Json字符串转化为数组类型.这个功能在utils里实现.</p>
<p>我们一般输入的转账命令是这样的:</p>
<pre><code class="hljs language-css" lang="css">send -<span class="hljs-selector-tag">from</span> '<span class="hljs-selector-attr">[<span class="hljs-string">"chaors"</span>, <span class="hljs-string">"ww"</span>]</span>' -<span class="hljs-selector-tag">to</span> '<span class="hljs-selector-attr">[<span class="hljs-string">"xyz"</span>, <span class="hljs-string">"dh"</span>]</span>' -amount '<span class="hljs-selector-attr">[<span class="hljs-string">"5"</span>, <span class="hljs-string">"100"</span>]</span>'
</code></pre>
<blockquote>
<p>send       转账命令
from       发送方
to           接收方
amount  转账金额
三个参数的数组分别一一对应,上述命令表示:
chaors转给xyx共5btc;
ww转给dh的100btc.</p>
</blockquote>
<p>utils.go</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 标准的JSON字符串转数组</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Json2Array</span><span class="hljs-params">(jsonString <span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">string</span> {

	<span class="hljs-comment">//json 到 []string</span>
	<span class="hljs-keyword">var</span> sArr []<span class="hljs-type">string</span>
	<span class="hljs-keyword">if</span> err := json.Unmarshal([]<span class="hljs-type">byte</span>(jsonString), &amp;sArr); err != <span class="hljs-literal">nil</span> {

		log.Panic(err)
	}
	<span class="hljs-keyword">return</span> sArr
}
</code></pre>
<h3 data-id="heading-2">转账的理解</h3>
<p>说到转账,就离不开交易.这里的转账便是普通交易,之前我们只实现了创币交易.这里需要实现普通交易.</p>
<p>为了更好地理解转账的过程,我们先将复杂问题简单化.假设每一个区块只有一笔交易,我们看一个简单的小🌰.</p>
<p>1.节点chaors挖到一个区块，产生25BTC的创币交易。由于是创币交易，其本身是不需要引用任何交易输出的，所以在输入对象TXInput的交易哈希为空，vount所在的下标为-1，数字签名为空或者随便填写；输出对象里btc拥有者为chaors，面值为25btc  创世区块交易结构</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-attr">txInput0</span> = &amp;TXInput{[]byte{},-<span class="hljs-number">1</span>,<span class="hljs-string">"Gensis Block"</span>}
 <span class="hljs-attr">txOutput0</span> = &amp;TXOutput{<span class="hljs-number">25</span>, <span class="hljs-string">"chaors"</span>}  //在gaVouts索引为<span class="hljs-number">0</span>

 CoinbaseTransaction{"00000",
			<span class="hljs-section">[]</span>*TXInput{txInput0},
			<span class="hljs-section">[]</span>*TXOutput{txOutput0}
}
</code></pre>
<p>2.chaors获得25btc后，他的好友ww知道后向他索要10btc.大方的chaors便把10btc转给ww.此时
交易的输入为chaors上笔交易获得的btc,TXInput对象的交易ID为奖励chaors的上一个交易ID，vount下标为chaors的TXOutput下标，签名此时且认为是来自chaors，填作"chaors" 此时chaors的25btc面值的TXOutput就被花费不复存在了，那么chaors还应该有15btc的找零哪去了？系统会为chaors的找零新生成一个面值15btc的TXOutput。所以，这次有一个输入，两个输出。</p>
<blockquote>
<p>chaors(25) 给 ww 转 10 -- &gt;&gt;  chaors(15) + ww(10)</p>
</blockquote>
<p>这次的交易结构为:</p>
<pre><code class="hljs language-ini" lang="ini"> //输入
 <span class="hljs-attr">txInput1</span> = &amp;TXInput{<span class="hljs-string">"00000"</span>,<span class="hljs-number">0</span>,<span class="hljs-string">"chaors"</span>}
 //"00000" 相当于来自于哈希为"00000"的交易
 //索引为零，相当于上一次的txOutput0为输入

 //输出
 <span class="hljs-attr">txOutput1</span> = &amp;TXOutput{<span class="hljs-number">10</span>, <span class="hljs-string">"ww"</span>}		//在该笔交易Vouts索引为<span class="hljs-number">0</span>  chaors转给ww的<span class="hljs-number">10</span>btc产生的输出
 <span class="hljs-attr">txOutput2</span> = &amp;TXOutput{<span class="hljs-number">15</span>, <span class="hljs-string">"chaors"</span>}    //在该笔交易Vouts索引为<span class="hljs-number">1</span>  给ww转账产生的找零
 Transaction1{"11111"，
			<span class="hljs-section">[]</span>*TXInput{txInput1}
			<span class="hljs-section">[]</span>*TXOutput{txOutput1, txOutput2}
}
</code></pre>
<p>3.ww感觉拥有比特币是一件很酷的事情，又来跟chaors要。出于兄弟情谊，chaors又转给ww7btc
这次的交易结构为:</p>
<pre><code class="hljs language-ini" lang="ini">//输入
 <span class="hljs-attr">txInput2</span> = &amp;TXInput{<span class="hljs-string">"11111"</span>,<span class="hljs-number">2</span>,<span class="hljs-string">"chaors"</span>}

 //输出
 <span class="hljs-attr">txOutput3</span> = &amp;TXOutput{<span class="hljs-number">7</span>, <span class="hljs-string">"ww"</span>}		  //在该笔交易Vouts索引为<span class="hljs-number">0</span>
 <span class="hljs-attr">txOutput4</span> = &amp;TXOutput{<span class="hljs-number">8</span>, <span class="hljs-string">"chaors"</span>}   //在该笔交易Vouts索引为<span class="hljs-number">1</span>
 Transaction2{"22222"，
			<span class="hljs-section">[]</span>*TXInput{txInput2}
			<span class="hljs-section">[]</span>*TXOutput{txOutput3, txOutput4}
}
</code></pre>
<p>4.消息传到他们共同的朋友xyz那里，xyz觉得btc很好玩向ww索要15btc.ww一向害怕xyx，于是尽管不愿意也只能屈服。</p>
<p>我们来看看ww此时的所有财产:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">txOutput1</span> = &amp;TXOutput{<span class="hljs-number">10</span>, <span class="hljs-string">"ww"</span>}		//来自Transaction1(hash:<span class="hljs-number">11111</span>)Vouts索引为<span class="hljs-number">0</span>的输出   
<span class="hljs-attr">txOutput3</span> = &amp;TXOutput{<span class="hljs-number">7</span>, <span class="hljs-string">"ww"</span>}		//来自Transaction2(hash:<span class="hljs-number">2222</span>)Vouts索引为<span class="hljs-number">0</span>的输出
</code></pre>
<p>想要转账15btc,ww的哪一笔txOutput都不够，这个时候就需要用ww的两个txOutput都作为
输入,这次的交易结构为:</p>
<pre><code class="hljs language-ini" lang="ini">//输入：
<span class="hljs-attr">txInput3</span> = &amp;TXInput{<span class="hljs-string">"11111"</span>,<span class="hljs-number">1</span>,<span class="hljs-string">"ww"</span>}
<span class="hljs-attr">txInput4</span> = &amp;TXInput{<span class="hljs-string">"22222"</span>,<span class="hljs-number">3</span>,<span class="hljs-string">"ww"</span>}

//输出
 <span class="hljs-attr">txOutput5</span> = &amp;TXOutput{<span class="hljs-number">15</span>, <span class="hljs-string">"xyz"</span>}		索引为<span class="hljs-number">5</span>
 <span class="hljs-attr">txOutput6</span> = &amp;TXOutput{<span class="hljs-number">2</span>, <span class="hljs-string">"ww"</span>}        索引为<span class="hljs-number">6</span>

 第四个区块交易结构
 Transaction3{"33333"，
			<span class="hljs-section">[]</span>*TXInput{txInput3, txInput4}
			<span class="hljs-section">[]</span>*TXOutput{txOutput5, txOutput6}
}
</code></pre>
<p>现在,我们来总结一下上述几个交易.</p>
<blockquote>
<p>A.chaors</p>
<blockquote>
<p>1.从CoinbaseTransaction获得TXOutput0总额25
2.Transaction1转给ww10btc,TXOutput0被消耗,获得txOutput2找零15btc
3.Transaction2转给ww7Btc,txOutput2被消耗,获得txOutput4找零8btc
4.最后只剩8btc的txOutput4作为未花费输出</p>
</blockquote>
</blockquote>
<blockquote>
<p>B.ww</p>
<blockquote>
<p>1.从Transaction1获得TXOutput1,总额10btc
2.从Transaction2获得TXOutput3,总额7btc
3.Transaction3转给xyz15btc,TXOutput1和TXOutput3都被消耗,获得txOutput6找零2btc
4.最后只剩2btc的txOutput6作为未花费输出</p>
</blockquote>
</blockquote>
<blockquote>
<p>C.xyz</p>
<blockquote>
<p>1.从Transaction3获得TXOutput5,总额15btc
2.拥有15btc的TXOutput5作为未花费输出</p>
</blockquote>
</blockquote>
<p>经过这个例子,我们可以发现转账具备几个特点:
#####1.每笔转账必须有输入TXInput和输出TXOutput
#####2.每笔输入必须有源可查(TXInput.TxHash)
#####3.每笔输入的输出引用必须是未花费的(没有被之前的交易输入所引用)
#####4.TXOutput是一个不可分割的整体,一旦被消耗就不可用.消费额度不对等时会有找零(产生新的TXOutput)</p>
<p>这个🌰很重要,对于后面转账的代码逻辑是个扎实的基础准备.</p>
<h3 data-id="heading-3">AddBlockToBlockchain --&gt; MineNewBlock</h3>
<p>既然在cli工具用转账命令send代替了添加区块,那么在实际的函数调用中,我们必须考虑到交易信息.上面对转账有了一定的理解,现在可以认为构造公链的第一笔交易.</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//2.普通交易</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTransaction</span><span class="hljs-params">(from []<span class="hljs-type">string</span>, to []<span class="hljs-type">string</span>, amount []<span class="hljs-type">string</span>)</span></span> *Transaction {


	<span class="hljs-comment">//单笔交易构造假数据测试交易</span>

	<span class="hljs-comment">//输入输出</span>
	<span class="hljs-keyword">var</span> txInputs []*TXInput
	<span class="hljs-keyword">var</span> txOutputs []*TXOutput

	<span class="hljs-comment">//输入,由于这里引用的TXOutput来自创世区块的奖励, 这里复制创世区块里创币交易的哈希作为交易输入对TXOutput的引用</span>
	txHash, _ := hex.DecodeString(<span class="hljs-string">"d3c17e00ad2c1bd7fec8f5afde710f2c3afd40478c3cca492d7e9a2b0cbe4808"</span>)
	txInput := &amp;TXInput {
		txHash,
		<span class="hljs-number">0</span>, 	<span class="hljs-comment">//要花费的TXOutput在对应交易的Vounts下标为0</span>
		from[<span class="hljs-number">0</span>],
	}

	fmt.Printf(<span class="hljs-string">"111--%x\n"</span>, txInput.TxHash)

	txInputs = <span class="hljs-built_in">append</span>(txInputs, txInput)

	<span class="hljs-comment">//转账</span>
	txOutput := &amp;TXOutput{
		<span class="hljs-number">10</span>,
	to[<span class="hljs-number">0</span>],
	}
	txOutputs = <span class="hljs-built_in">append</span>(txOutputs, txOutput)

	<span class="hljs-comment">//找零</span>
	txOutput = &amp;TXOutput{
		<span class="hljs-number">25</span><span class="hljs-number">-10</span>,
		from[<span class="hljs-number">0</span>],
	}
	txOutputs = <span class="hljs-built_in">append</span>(txOutputs, txOutput)

	tx := &amp;Transaction{
		[]<span class="hljs-type">byte</span>{},
		txInputs,
		txOutputs,
	}

	tx.HashTransactions()

	fmt.Printf(<span class="hljs-string">"222---%x\n"</span>, txInput.TxHash)

	<span class="hljs-keyword">return</span> tx


	<span class="hljs-comment">//1. 有一个函数，返回from这个人所有的未花费交易输出所对应的Transaction</span>
	<span class="hljs-comment">//unSpentTx := UnSpentTransactionsWithAddress("chaors")</span>
	<span class="hljs-comment">//fmt.Println(unSpentTx)</span>
}
</code></pre>
<p>我们在人为通过硬编码构造好一个基于创世区块的转账交易后,此时需要将这笔交易打包到区块并添加到区块链上.之前我们的AddBlockToBlockchain就需要做些改动.</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//2.新增一个区块到区块链 --&gt; 包含交易的挖矿</span>
<span class="hljs-comment">//func (blc *Blockchain) AddBlockToBlockchain(txs []*Transaction) {</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(blc *Blockchain)</span></span> MineNewBlock(from []<span class="hljs-type">string</span>, to []<span class="hljs-type">string</span>, amount []<span class="hljs-type">string</span>) {

	<span class="hljs-comment">//send -from '["chaors"]' -to '["xyx"]' -amount '["5"]'</span>

	tx := NewTransaction(from, to, amount)
	<span class="hljs-comment">//1.通过相关算法建立Transaction数组</span>
	<span class="hljs-keyword">var</span> txs []*Transaction
	txs = <span class="hljs-built_in">append</span>(txs, tx)

	fmt.Printf(<span class="hljs-string">"333---%x\n\n"</span>, txs[<span class="hljs-number">0</span>].Vins[<span class="hljs-number">0</span>].TxHash)

	<span class="hljs-comment">//2.挖矿</span>
	<span class="hljs-comment">//取上个区块的哈希和高度值</span>
	<span class="hljs-keyword">var</span> block *Block
	err := blc.DB.View(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span></span> <span class="hljs-type">error</span> {

		b := tx.Bucket([]<span class="hljs-type">byte</span>(blockTableName))
		<span class="hljs-keyword">if</span> b != <span class="hljs-literal">nil</span> {

			hash := b.Get([]<span class="hljs-type">byte</span>(newestBlockKey))
			block = DeSerializeBlock(b.Get(hash))
		}

		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

		log.Panic(err)
	}

	<span class="hljs-comment">//3.建立新区块</span>
	block = NewBlock(txs, block.Height+<span class="hljs-number">1</span>, block.Hash)

	<span class="hljs-comment">//4.存储新区块</span>
	err = blc.DB.Update(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span></span> <span class="hljs-type">error</span> {

		b := tx.Bucket([]<span class="hljs-type">byte</span>(blockTableName))
		<span class="hljs-keyword">if</span> b != <span class="hljs-literal">nil</span> {

			fmt.Printf(<span class="hljs-string">"444---%x\n\n"</span>, block.Txs[<span class="hljs-number">0</span>].Vins[<span class="hljs-number">0</span>].TxHash)
			fmt.Println(block)

			err = b.Put(block.Hash, block.Serialize())
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

				log.Panic(err)
			}

			err = b.Put([]<span class="hljs-type">byte</span>(newestBlockKey), block.Hash)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

				log.Panic(err)
			}

			blc.Tip = block.Hash
		}

		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {

		log.Panic(err)
		<span class="hljs-comment">//fmt.Print(err)</span>
	}
}
</code></pre>
<p>然后再CLI工具将send命令的具体实现添加好.</p>
<pre><code class="hljs language-css" lang="css">//转账
func (cli *CLI) send(<span class="hljs-selector-tag">from</span> <span class="hljs-selector-attr">[]</span>string, <span class="hljs-selector-tag">to</span> <span class="hljs-selector-attr">[]</span>string, amount <span class="hljs-selector-attr">[]</span>string)  {

	blockchain := <span class="hljs-built_in">GetBlockchain</span>()
	defer blockchain.DB.<span class="hljs-built_in">Close</span>()

	blockchain.<span class="hljs-built_in">MineNewBlock</span>(from, to, amount)
}
</code></pre>
<h3 data-id="heading-4">余额查询GetBalance</h3>
<p>转账和区块上链都实现了,Run也是没有问题的.那么怎么验证转账成功呢?毕竟此时我们不知道各自的余额是多少.这时候,我们就需要来实现余额查询方法.</p>
<p>首先在CLi工具里实现,getBlance命令的添加和解析其实在前面说到send命令时已经有了.回去看看即可.</p>
<p>余额查询的实现</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//余额查询</span>
func (cli *CLI) <span class="hljs-built_in">getBlance</span>(address string) {

	fmt<span class="hljs-selector-class">.Println</span>("地址：" + address)

	blockchain := <span class="hljs-built_in">GetBlockchain</span>()
	defer blockchain.DB.<span class="hljs-built_in">Close</span>()

	amount := blockchain.<span class="hljs-built_in">GetBalance</span>(address)

	fmt.<span class="hljs-built_in">Printf</span>(<span class="hljs-string">"%s一共有%d个Token\n"</span>, address, amount)
}
</code></pre>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">//查询余额</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(blc *Blockchain)</span></span> GetBalance(address <span class="hljs-type">string</span>) <span class="hljs-type">int64</span> {

	utxos := blc.UTXOs(address)

	<span class="hljs-keyword">var</span> amount <span class="hljs-type">int64</span>
	<span class="hljs-keyword">for</span> _, out := <span class="hljs-keyword">range</span> utxos {

		amount += out.Value
	}

	<span class="hljs-keyword">return</span> amount
}
</code></pre>
<h3 data-id="heading-5">UTXOs</h3>
<p>要想实现余额查询,必须知道某个账户未花费的TxOutput.这个时候我们需要遍历区块链上的区块,然后去每一笔交易里找.在每笔交易输出里被引用的TxOutput必定被消耗,只需要记录被消耗的TxOutput.然后再去比对每笔交易产生的TxOutput,做个去除即可得到当前账户在链上剩余的未花费的TxOutput.</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//5.返回一个地址对应的UTXO的交易UTXOs</span>
<span class="hljs-comment">//func (blc *Blockchain) UnSpentTransactionsWithAddress(address string) []*Transaction {</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(blc *Blockchain)</span></span> UTXOs(address <span class="hljs-type">string</span>) []*TXOutput {

	<span class="hljs-comment">//未花费的TXOutput</span>
	<span class="hljs-keyword">var</span> UTXOs []*TXOutput

	<span class="hljs-comment">//已经花费的TXOutput [hash:[]] [交易哈希：TxOutput对应的index]</span>
	<span class="hljs-keyword">var</span> spentTXOutputs = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]<span class="hljs-type">int</span>)

	<span class="hljs-comment">//遍历器</span>
	blcIterator := blc.Iterator()

	<span class="hljs-keyword">for</span> {

		block := blcIterator.Next()

		<span class="hljs-comment">//fmt.Println(block)</span>
		<span class="hljs-comment">//fmt.Println()</span>

		<span class="hljs-keyword">for</span> _, tx := <span class="hljs-keyword">range</span> block.Txs {

			<span class="hljs-comment">// txHash</span>

			<span class="hljs-comment">// Vins</span>
			<span class="hljs-comment">//判断当前交易是否为创币交易</span>
			<span class="hljs-keyword">if</span> tx.IsCoinbaseTransaction() == <span class="hljs-literal">false</span> {

				<span class="hljs-keyword">for</span> _, in := <span class="hljs-keyword">range</span> tx.Vins {

					<span class="hljs-comment">//验证当前输入是否是当前地址的</span>
					<span class="hljs-keyword">if</span> in.UnlockWithAddress(address) {

						key := hex.EncodeToString(in.TxHash)

						<span class="hljs-comment">//fmt.Printf("lll%x\n", in.TxHash)</span>
						<span class="hljs-comment">//fmt.Println(key)</span>
						spentTXOutputs[key] = <span class="hljs-built_in">append</span>(spentTXOutputs[key], in.Vout)
					}

				}
			}


			<span class="hljs-comment">// Vouts</span>
			<span class="hljs-keyword">for</span> index, out := <span class="hljs-keyword">range</span> tx.Vouts {

				<span class="hljs-comment">//验证当前输出是否是</span>
				<span class="hljs-keyword">if</span> out.UnLockScriptPubKeyWithAddress(address) {

					fmt.Printf(<span class="hljs-string">"%x"</span>, block.Hash)
					fmt.Println(index, out)

					<span class="hljs-comment">//判断是否曾发生过交易</span>
					<span class="hljs-keyword">if</span> spentTXOutputs != <span class="hljs-literal">nil</span> {

						<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(spentTXOutputs) != <span class="hljs-number">0</span> {

							<span class="hljs-comment">//遍历spentTXOutputs</span>
							<span class="hljs-keyword">for</span> txHash, indexArray := <span class="hljs-keyword">range</span> spentTXOutputs {

								<span class="hljs-comment">//遍历TXOutputs下标数组</span>
								<span class="hljs-keyword">for</span> _, i := <span class="hljs-keyword">range</span> indexArray {

									fmt.Printf(<span class="hljs-string">"%d--%d\n"</span>, index, i)
									fmt.Printf(<span class="hljs-string">"%s\n"</span>, txHash)
									fmt.Printf(<span class="hljs-string">"%x\n"</span>, tx.TxHAsh)
									fmt.Println(spentTXOutputs)
									fmt.Println(out)

									<span class="hljs-keyword">if</span> index == i &amp;&amp; txHash == hex.EncodeToString(tx.TxHAsh) {

										<span class="hljs-keyword">continue</span>
									} <span class="hljs-keyword">else</span> {

										<span class="hljs-comment">//fmt.Println(index,i)</span>
										<span class="hljs-comment">//fmt.Println(out)</span>
										<span class="hljs-comment">//fmt.Println(spentTXOutputs)</span>

										UTXOs = <span class="hljs-built_in">append</span>(UTXOs, out)
									}
								}
							}
						} <span class="hljs-keyword">else</span> {

							UTXOs = <span class="hljs-built_in">append</span>(UTXOs, out)
						}
					}
				}
			}
		}

		<span class="hljs-comment">//找到创世区块，跳出循环</span>
		<span class="hljs-keyword">var</span> hashInt big.Int
		hashInt.SetBytes(block.PrevBlockHash)

		<span class="hljs-comment">// Cmp compares x and y and returns:</span>
		<span class="hljs-comment">//</span>
		<span class="hljs-comment">//   -1 if x &lt;  y</span>
		<span class="hljs-comment">//    0 if x == y</span>
		<span class="hljs-comment">//   +1 if x &gt;  y</span>
		<span class="hljs-keyword">if</span> hashInt.Cmp(big.NewInt(<span class="hljs-number">0</span>)) == <span class="hljs-number">0</span> {

			<span class="hljs-keyword">break</span>
		}
	}

	<span class="hljs-keyword">return</span> UTXOs
}
</code></pre>
<h3 data-id="heading-6">Main_test</h3>
<pre><code class="hljs language-css" lang="css">package <span class="hljs-selector-tag">main</span>

import (

	"chaors<span class="hljs-selector-class">.com</span>/publicChaorsChain/part8-transfer-Prototype/BLC"
)

func <span class="hljs-selector-tag">main</span>() {

	cli := BLC.CLI{}
	cli<span class="hljs-selector-class">.Run</span>()

	//blc := BLC.<span class="hljs-built_in">CreateBlockchainWithGensisBlock</span>(<span class="hljs-string">"chaors"</span>)
	//utxos := blc.<span class="hljs-built_in">UnUTXOs</span>(<span class="hljs-string">"chaors"</span>)
	//fmt.<span class="hljs-built_in">Println</span>(utxos)
}
</code></pre>
<p>创建好创世区块后,执行第一次转账.
chaors(25btc) --&gt;ww(10) + chaors(15)</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/7/10/16484b5e1dd57662~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1240&amp;h=810&amp;s=576620&amp;e=png&amp;b=323131" alt="Main_test1.png" loading="lazy"/></p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/7/10/16484b5e1f0a1df3~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1240&amp;h=373&amp;s=368022&amp;e=png&amp;b=323131" alt="Main_test2.png" loading="lazy"/></p>
<h3 data-id="heading-7">总结</h3>
<p>当前的交易函数是人工硬编码，下次再具体实现。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchaors%2FPublicBlockChain_go" target="_blank" title="https://github.com/chaors/PublicBlockChain_go" ref="nofollow noopener noreferrer">源代码</a>在这,喜欢的朋友记得给个小star，或者fork.也欢迎大家一起探讨区块链相关知识，一起进步！</p>
<h3 data-id="heading-8">更多原创区块链技术文章请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fu%2Fa46bd6ade353" target="_blank" title="https://www.jianshu.com/u/a46bd6ade353" ref="nofollow noopener noreferrer">chaors</a></h3>
<p>.
.
.
.</p>
<blockquote>
<p>###互联网颠覆世界，区块链颠覆互联网!</p>
</blockquote>
<blockquote>
<h6 data-id="heading-9">---------------------------------------------20180703 23:47</h6>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 React 中手写 KeepAlive]]></title>    <link>https://juejin.cn/post/7600303087875768358</link>    <guid>https://juejin.cn/post/7600303087875768358</guid>    <pubDate>2026-01-29T03:48:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600303087875768358" data-draft-id="7600314093294469158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 React 中手写 KeepAlive"/> <meta itemprop="keywords" content="前端,性能优化,面试"/> <meta itemprop="datePublished" content="2026-01-29T03:48:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有意义"/> <meta itemprop="url" content="https://juejin.cn/user/1739866211617625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 React 中手写 KeepAlive
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739866211617625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有意义
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:48:15.000Z" title="Thu Jan 29 2026 03:48:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>在 Vue 中，<code>&lt;keep-alive&gt;</code> 是一个<strong>内置的组件</strong></p>
<p>用于缓存动态组件的状态，避免重复创建和销毁。</p>
<p>它常用于 <code>&lt;component :is="..."&gt;</code>、<code>&lt;router-view&gt;</code> 等场景，实现“切换时不销毁组件实例”的效果。</p>
<p>我们知道 React 基于原生 JavaScript，具有更强的灵活性和定制能力，接下来我们将用 React 来实现这一机制。</p>
<h2 data-id="heading-1">一、组件的状态的丢失</h2>
<p>在深入实现 <code>KeepAlive</code> 之前，我们可以先搭建一个简单场景，亲身体验一下：</p>
<p><strong>当动态切换组件时，其内部状态为何会意外丢失</strong>。</p>
<h3 data-id="heading-2">编写一个带状态的计数器组件</h3>
<p>我们需要一个具备本地状态的组件——例如一个计数器。在多个同类组件之间切换时，可以直观观察其状态是否被保留。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// src/App.jsx</span>
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">KeepAlive</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/KeepAlive.jsx'</span>;

<span class="hljs-comment">// 普通计数器组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Counter</span> = (<span class="hljs-params">{ name }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">//监听组件的挂载与卸载生命周期</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">` $ {name} 组件已挂载！`</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">` $ {name} 组件已被卸载...`</span>);
    };
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>', <span class="hljs-attr">margin:</span> '<span class="hljs-attr">10px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{name} 视图<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;加 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// 另一个计数器组件（逻辑完全一致）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">OtherCounter</span> = (<span class="hljs-params">{ name }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  $ {name} 组件已挂载！`</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  $ {name} 组件已被卸载...`</span>);
    };
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>', <span class="hljs-attr">margin:</span> '<span class="hljs-attr">10px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{name} 视图<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;加 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<blockquote>
<p>我们可以看到，尽管两个组件逻辑相同，但由于它们是不同的函数引用，React 会将其视为不同类型。因此，在条件渲染中切换时，React 会<strong>卸载旧组件并重新挂载新组件</strong>，导致状态丢失。</p>
</blockquote>
<p>当我们通过路由或状态控制在这两个组件之间切换时，会发现：<strong>每次返回原组件，计数器都会重置为 0</strong>。</p>
<p>再深入一点， <code>App.jsx</code> 文件中，通过状态 <code>activeTab</code> 来控制显示哪一个组件。这样你可以体验到当组件被条件渲染时，默认情况下它们的状态是如何丢失的。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用 'A' 或 'B' 控制当前显示哪个组件</span>
  <span class="hljs-keyword">const</span> [activeTab, setActiveTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'A'</span>); 

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
        {/* 按钮用于切换 activeTab 状态 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setActiveTab('A')}&gt;显示 A 组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setActiveTab('B')}&gt;显示 B 组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/*  注意：这里的三元运算符会导致组件在切换时被销毁和重建 */}
      {activeTab === 'A' ? <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"A"</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">OtherCounter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"B"</span> /&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>我们运行这段代码时</p>
<ol>
<li>点击“显示 A 组件”，然后多次点击“加 1”按钮，直到计数达到 5。</li>
<li>接着，点击“显示 B 组件”。此时，你应该会在控制台看到信息：“ A 组件已被卸载...” 和 “ B 组件已挂载！”。</li>
<li>最后，再次点击“显示 A 组件”。你会注意到控制台输出了“ A 组件已挂载！”，但遗憾的是，计数器已经重置为 0。</li>
</ol>
<p>这种行为展示了 React 中条件渲染（的本质：每次当 <code>activeTab</code> 发生变化时，相应的组件会被卸载和重新挂载，导致其内部状态丢失。</p>
<blockquote>
<p>而下一步，正是通过实现一个类似 Vue 中 <code>&lt;keep-alive&gt;</code> 的 <code>KeepAlive</code> 机制，让组件在切换后仍能<strong>保留其内部状态与 DOM 结构</strong>，从而提升用户体验与性能。</p>
</blockquote>
<h2 data-id="heading-3">二、：KeepAlive 的核心原理</h2>
<p>既然 React 在条件切换时会<strong>销毁组件并清空状态</strong>，</p>
<p>那我们能不能换个思路——</p>
<blockquote>
<p>不让组件被销毁，只让它“隐身”？</p>
</blockquote>
<p>答案是肯定的。关键在于：</p>
<blockquote>
<p>绕过 React 的卸载机制，用视觉隐藏代替真实移除。</p>
</blockquote>
<h3 data-id="heading-4">2.1 核心思想</h3>
<p><code>KeepAlive</code> 的底层逻辑并不复杂，核心就两点：</p>
<blockquote>
<p>所有需要缓存的子组件，一次性全部挂载到 DOM 中，永不卸载。</p>
<p>通过 CSS 的 <code>display</code> 属性控制谁“露脸”、谁“退场”。</p>
</blockquote>
<p>只要组件的真实节点还留在 DOM 树里（哪怕被设为 <code>display: none</code>），React 就不会触发它的卸载流程——<br/>
<code>useState</code> 的值依然保留<br/>
<code>useEffect</code> 的清理函数不会执行<br/>
整个组件实例在内存中“活着”，随时可以重新激活</p>
<p>这其实就是一种<strong>障眼法</strong>：</p>
<blockquote>
<p><strong>用户看到的是“切换视图”，而 React 看到的是“同一组组件，只是 visibility 变了”。</strong></p>
</blockquote>
<p>你不是在反复创建和销毁，而是在<strong>管理一组常驻组件的可见状态</strong>。既省去了重复初始化的开销，又完美保留了交互状态。</p>
<hr/>
<h3 data-id="heading-5">2.2 缓存结构设计</h3>
<p>为了让这套机制可复用、可追踪，我们需要一个<strong>缓存容器</strong>，用来记录所有已经渲染过的子组件。</p>
<p>最直观的方式，就是用一个对象（或 <code>Map</code>）来维护：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cache = {
  <span class="hljs-attr">A</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"A"</span> /&gt;</span></span>,
  <span class="hljs-attr">B</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">OtherCounter</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"B"</span> /&gt;</span></span>
};
</code></pre>
<p><strong>Key</strong>：由外部传入的唯一标识（如 <code>'A'</code>、<code>'B'</code>）决定，用于区分不同视图。</p>
<p><strong>Value</strong>：对应的 React 元素（即 JSX 表达式），<strong>仅在首次访问时生成并存入缓存</strong>，后续直接复用。</p>
<blockquote>
<p>虽然缓存的是 React 元素，但一旦它被挂载，其背后的状态、DOM 节点、Fiber 节点都会由 React 内部持续维护。只要不触发 unmount，一切状态都安然无恙。</p>
</blockquote>
<p>最终渲染时，你只需遍历 <code>cache</code>，把所有缓存项都 render 出来，再根据当前激活的 key 动态设置 <code>style={{ display: activeKey === key ? 'block' : 'none' }}</code>。</p>
<p>看起来简单，对吧？<br/>
但要把它封装成一个<strong>通用、健壮、支持动态 children 的 <code>&lt;KeepAlive&gt;</code> 组件</strong>，还需要处理不少细节。接下来，我们就动手实现它。</p>
<hr/>
<h2 data-id="heading-6">三、手写实战：实现 <code>KeepAlive</code> 组件</h2>
<p>现在，我们正式动手编写一个具备缓存能力的 <code>KeepAlive</code> 容器。<br/>
它将接管子组件的渲染逻辑，确保状态在切换中得以保留。</p>
<h3 data-id="heading-7">Props 与内部状态设计</h3>
<p>我们的 <code>KeepAlive</code> 组件需要两个关键输入：</p>
<ul>
<li><strong><code>activeId</code></strong>：标识当前应显示的视图（如 <code>'A'</code>、<code>'B'</code>）。</li>
<li><strong><code>children</code></strong>：当前传入的子组件（即待缓存的 React 元素）。</li>
</ul>
<p>同时，组件内部需维护一个<strong>缓存池</strong>，用于持久化所有已渲染过的子组件。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAlive</span> = (<span class="hljs-params">{ activeId, children }</span>) =&gt; {
  <span class="hljs-comment">// 缓存池：key 为视图 ID，value 为对应的 React 元素</span>
  <span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>({});
  
  <span class="hljs-comment">// ... 缓存与渲染逻辑</span>
};
</code></pre>
<blockquote>
<p>💡 注意：<code>children</code> 在 React 中本质是一个不可变的 React 元素（Element），将其存入状态是安全且合法的。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">3.2 缓存策略：按需存储，避免重复</h3>
<p>每当 <code>activeId</code> 或 <code>children</code> 发生变化时，我们需要判断：<strong>该视图是否首次出现？</strong></p>
<p>如果是，则将其 <code>children</code> 存入缓存；否则，直接复用已有内容。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 仅当当前 activeId 对应的组件尚未缓存时，才进行存储</span>
  <span class="hljs-keyword">if</span> (cache[activeId] == <span class="hljs-literal">null</span>) {
    <span class="hljs-title function_">setCache</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
      ...prev,
      [activeId]: children
    }));
  }
}, [activeId, children, cache]);
</code></pre>
<blockquote>
<p>这里依赖 <code>cache</code> 作为依赖项看似冗余，但能确保在严格模式（Strict Mode）或并发渲染下行为一致。实际项目中也可通过 <code>ref</code> 优化，但为保持逻辑清晰，此处暂用状态驱动。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">3.3 渲染机制：全量挂载 + CSS 显隐</h3>
<p>最关键的一步来了：<strong>不要用条件渲染！</strong></p>
<p>我们要将<strong>所有已缓存的组件全部挂载到 DOM 中</strong>，仅通过 <code>display: none/block</code> 控制可见性。这样，React 不会触发卸载，状态自然得以保留。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
    {Object.entries(cache).map(([id, component]) =&gt; (
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">display:</span> <span class="hljs-attr">id</span> === <span class="hljs-string">activeId</span> ? '<span class="hljs-attr">block</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">none</span>',
          // <span class="hljs-attr">可选</span>：<span class="hljs-attr">防止隐藏组件影响布局</span>
          <span class="hljs-attr">position:</span> '<span class="hljs-attr">absolute</span>',
          <span class="hljs-attr">top:</span> <span class="hljs-attr">0</span>,
          <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span>,
          <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%'
        }}
      &gt;</span>
        {component}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    ))}
  <span class="hljs-tag">&lt;/&gt;</span></span>
);
</code></pre>
<blockquote>
<p>每个缓存项都始终存在于 DOM 树中，只是视觉上被隐藏。<br/>
React Fiber 树持续维护其状态，<code>useState</code>、<code>useRef</code>、<code>useEffect</code> 均正常工作。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">3.4 完整实现</h3>
<p>整合上述逻辑，得到一个简洁而有效的 <code>KeepAlive</code> 组件：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAlive</span> = (<span class="hljs-params">{ activeId, children }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>({});

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (cache[activeId] == <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">setCache</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
        ...prev,
        [activeId]: children
      }));
    }
  }, [activeId, children, cache]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {Object.entries(cache).map(([id, component]) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> <span class="hljs-attr">id</span> === <span class="hljs-string">activeId</span> ? '<span class="hljs-attr">block</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">none</span>' }}
        &gt;</span>
          {component}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};

0<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">KeepAlive</span>;
</code></pre>
<p>这个不到 40 行的组件，巧妙利用了 React 的渲染机制与 CSS 的显示控制，实现了类似 Vue <code>&lt;keep-alive&gt;</code> 的缓存能力。</p>
<p>接下来，只需在 <code>App.jsx</code> 中替换原来的三元表达式，就能见证“失忆症”的彻底治愈。</p>
<h3 data-id="heading-11">我们来看看效果：</h3>
<p>首先点击“显示 A 组件”，并将计数增加至 5。</p>
<p>随后切换至“显示 B 组件”。</p>
<p>此时观察控制台输出：<strong>没有出现“A 组件被卸载”的日志</strong>，仅打印了“B 组件已挂载”</p>
<p>这表明 A 组件并未被销毁，其对应的 <code>useEffect</code> 清理函数未被执行。</p>
<p>接着，重新切换回“显示 A 组件”。控制台<strong>未输出“A 组件已挂载”</strong> ，说明该组件实例未经历重新创建过程；同时，界面上的计数值依然保持为 5，状态完整保留。</p>
<p>这一结果验证了 <code>KeepAlive</code> 组件的核心能力：通过避免真实卸载、仅控制视觉显隐，成功实现了动态组件的状态持久化。组件在切换过程中维持了其内部状态、DOM 结构及生命周期上下文，达到了与 Vue 中 <code>&lt;keep-alive&gt;</code> 相似的效果。</p>
<h2 data-id="heading-12">总结</h2>
<p>通过手写实现，我们成功在 React 中模拟了类似 Vue <code>&lt;keep-alive&gt;</code> 的状态缓存能力。但值得注意的是，<strong>两者的实现机制和底层逻辑存在根本性差异</strong>。</p>
<p>在 <strong>Vue</strong> 中，<code>&lt;keep-alive&gt;</code> 是一个深度集成于渲染器（renderer）的<strong>内置抽象组件</strong>。它通过操作虚拟 DOM 的 <code>shapeFlag</code>，直接干预组件的挂载（mount）与卸载（unmount）流程：被缓存的组件不会触发 <code>beforeUnmount</code> 和 <code>unmounted</code>，而是进入“停用”（deactivated）状态；重新激活时调用 <code>activated</code> 钩子，整个过程由 Vue 的响应式系统和组件生命周期体系原生支持。</p>
<p>而在 <strong>React</strong> 中，并无类似的底层钩子或渲染器扩展机制。因此，我们的实现本质上是一种<strong>上层应用级的“障眼法”</strong> ：</p>
<ul>
<li>所有子组件始终处于挂载状态，从未真正卸载；</li>
<li>通过 CSS 的 <code>display: none</code> 实现视觉切换；</li>
<li>依赖 React 对已挂载组件状态的自然保留能力来维持数据。</li>
</ul>
<p>这意味着：</p>
<ul>
<li><strong>优势</strong>：实现简单，无需侵入 React 内部机制，兼容性好；</li>
<li><strong>局限</strong>：所有缓存组件持续占用内存和 DOM 节点，可能影响性能（尤其在缓存大量复杂组件时）；无法像 Vue 那样精确控制“激活/停用”生命周期（如暂停轮询、取消订阅等），需自行结合 <code>useEffect</code> 与 <code>activeId</code> 状态管理副作用。</li>
</ul>
<p>因此，React 版 <code>KeepAlive</code> 更适合<strong>轻量级、状态为主、副作用较少</strong>的场景；而 Vue 的 <code>&lt;keep-alive&gt;</code> 则提供了更精细的生命周期控制和更高效的内存管理策略。</p>
<p>归根结底：<strong>Vue 是“框架帮你管”，React 是“你自己想办法管”</strong> ——这也正是两种框架哲学差异的典型体现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-useReducer 在复杂状态管理中的妙用]]></title>    <link>https://juejin.cn/post/7600303087875833894</link>    <guid>https://juejin.cn/post/7600303087875833894</guid>    <pubDate>2026-01-29T04:00:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600303087875833894" data-draft-id="7600370554068828186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-useReducer 在复杂状态管理中的妙用"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2026-01-29T04:00:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-useReducer 在复杂状态管理中的妙用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:00:39.000Z" title="Thu Jan 29 2026 04:00:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>当你的组件状态逻辑变得复杂（例如：一个状态依赖于另一个状态，或者一个动作需要更新多个状态）时，<code>useState</code> 往往会显得力不从心。此时，React 提供的 <code>useReducer</code> 便成了最佳选择。它借鉴了 Redux 的思想，让状态更新逻辑更具可预测性和可测试性。</p>
<h2 data-id="heading-1">一、 核心概念：什么是 useReducer？</h2>
<p><code>useReducer</code> 是一个通过“动作（Action）”来驱动“状态（State）”转换的 Hook。</p>
<h3 data-id="heading-2">1. 语法拆解</h3>
<p><code>const [state, dispatch] = useReducer(reducer, initialState)</code></p>
<ul>
<li><strong>reducer</strong>：一个纯函数 <code>(state, action) =&gt; newState</code>。它接收当前状态和动作，返回新状态。</li>
<li><strong>initialState</strong>：初始状态值。</li>
<li><strong>state</strong>：当前的状态。</li>
<li><strong>dispatch</strong>：派发函数，用于派发操作给reducer，是改变状态的<strong>唯一途径</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、 实战：强类型下的计数器</h2>
<p>在 TypeScript 中，我们通过定义 <code>Action</code> 的联合类型（Union Types），可以获得完美的编辑器补全和类型检查。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useReducer } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 定义状态的类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">State</span> {
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 2. 定义 Action 的类型 (使用联合类型实现 Discriminated Unions)</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Action</span> =
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'INCREMENT'</span> }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'DECREMENT'</span> }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'RESET'</span>; <span class="hljs-attr">payload</span>: <span class="hljs-built_in">number</span> };

<span class="hljs-comment">// 3. 编写 Reducer 纯函数</span>
<span class="hljs-comment">// 确保逻辑独立于组件之外，易于测试</span>
<span class="hljs-keyword">const</span> counterReducer = (<span class="hljs-attr">state</span>: <span class="hljs-title class_">State</span>, <span class="hljs-attr">action</span>: <span class="hljs-title class_">Action</span>): <span class="hljs-function"><span class="hljs-params">State</span> =&gt;</span> {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'INCREMENT'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> };
    <span class="hljs-keyword">case</span> <span class="hljs-string">'DECREMENT'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> };
    <span class="hljs-keyword">case</span> <span class="hljs-string">'RESET'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">count</span>: action.<span class="hljs-property">payload</span> };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
};

<span class="hljs-comment">// 4. 组件实现</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Counter</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(counterReducer, { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> });

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>当前计数: {state.count}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'INCREMENT' })}&gt;+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'DECREMENT' })}&gt;-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'RESET', payload: 0 })}&gt;Reset<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Counter</span>;
</code></pre>
<hr/>
<h2 data-id="heading-4">三、 深度解析：useReducer 的优势与场景</h2>
<h3 data-id="heading-5">1. 使用场景</h3>
<ul>
<li><strong>复杂状态逻辑</strong>：当状态对象包含多个子属性，且更新逻辑互相依赖时。</li>
<li><strong>性能优化</strong>：如果你需要向深层子组件传递更新逻辑，传递 <code>dispatch</code> 比传递多个 <code>setXXX</code> 函数更高效。因为 <code>dispatch</code> 在组件生命周期内是<strong>恒定不变</strong>的，不会触发子组件多余的渲染。</li>
<li><strong>全局状态管理</strong>：常与 <code>useContext</code> 结合，构建轻量级的全局数据流，替代 Redux。</li>
</ul>
<h3 data-id="heading-6">2. 与 useState 的区别</h3>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>useState</strong></th><th><strong>useReducer</strong></th></tr></thead><tbody><tr><td><strong>逻辑负责度</strong></td><td>简单状态、基础类型</td><td>复杂对象、多个互关状态</td></tr><tr><td><strong>状态更新</strong></td><td>声明式，直接设置新值</td><td>响应式，通过 Action 派发逻辑</td></tr><tr><td><strong>可维护性</strong></td><td>逻辑散落在事件处理函数中</td><td>逻辑集中在 Reducer 纯函数中</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">四、 使用技巧</h2>
<p><strong>注意：</strong> Reducer 必须是纯函数。这意味着：</p>
<ul>
<li><strong>不要</strong>在 Reducer 里修改原 state（应返回新对象）。</li>
<li><strong>不要</strong>在 Reducer 里执行有副作用的操作（如 API 请求、随机数生成、Date.now()）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【前端开发】Vue3框架响应式数据详解（Proxy与ref，reactive）]]></title>    <link>https://juejin.cn/post/7600333405979033641</link>    <guid>https://juejin.cn/post/7600333405979033641</guid>    <pubDate>2026-01-29T04:03:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600333405979033641" data-draft-id="7600430748780560427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【前端开发】Vue3框架响应式数据详解（Proxy与ref，reactive）"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-29T04:03:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幻羽梦溪"/> <meta itemprop="url" content="https://juejin.cn/user/3950988619167705"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【前端开发】Vue3框架响应式数据详解（Proxy与ref，reactive）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3950988619167705/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幻羽梦溪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:03:11.000Z" title="Thu Jan 29 2026 04:03:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Vue3</strong>的响应式系统是其核心特性之一，<code>ref(data)</code>和<code>reactive(data)</code>是创建响应式数据的两种主要方式。</p>
<h2 data-id="heading-0">一、响应式基础：为什么需要ref和reactive？以及什么是Proxy代理对象？</h2>
<p>在Vue3中，响应式系统完全重写，使用Proxy替代了Vue2的Object.defineProperty。这带来了更好的性能和更强大的功能。<code>ref</code>和<code>reactive</code>是这套新系统的两个核心API，它们都用于创建响应式数据，但在使用方式和场景上有所不同。</p>
<p>Vue3的响应式系统正是基于Proxy实现的。</p>
<p><strong>Proxy</strong>是ES6（ECMAScript 2015）引入的一个强大特性，它允许你创建一个对象的代理，从而可以拦截和自定义该对象的基本操作。简单来说，Proxy就像是在目标对象前面架设一个"拦截层"，外界对该对象的访问和操作都需要先经过这个拦截层，从而实现对对象行为的完全控制。（其实有点类似于JavaWeb里面的Spring AOP切面）</p>
<p><code>const proxy = new Proxy(target, handler)</code></p>
<ul>
<li>
<p><strong>target</strong>：要代理的目标对象</p>
</li>
<li>
<p><strong>handler</strong>：一个包含"陷阱"（trap）的对象，用于定义代理行为</p>
</li>
<li>
<p><strong>proxy</strong>：返回的代理对象，可以像使用原对象一样使用它</p>
</li>
</ul>
<h3 data-id="heading-1">示例1：最简单的Proxy</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 目标对象</span>
<span class="hljs-keyword">const</span> target = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }

<span class="hljs-comment">// 处理器对象</span>
<span class="hljs-keyword">const</span> handler = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, property</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`正在读取属性: <span class="hljs-subst">${property}</span>`</span>)
    <span class="hljs-keyword">return</span> target[property] <span class="hljs-comment">// 返回实际值</span>
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, property, value</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`正在设置属性: <span class="hljs-subst">${property}</span> = <span class="hljs-subst">${value}</span>`</span>)
    target[property] = value
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 表示设置成功</span>
  }
}

<span class="hljs-comment">// 创建代理</span>
<span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, handler)

<span class="hljs-comment">// 使用代理</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(proxy.<span class="hljs-property">name</span>) <span class="hljs-comment">// 输出: 正在读取属性: name → Alice</span>
proxy.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>         <span class="hljs-comment">// 输出: 正在设置属性: age = 30</span>
</code></pre>
<h2 data-id="heading-2"/>
<h2 data-id="heading-3">二、ref详解：简单值的响应式包装</h2>
<p>对于<code>ref</code>我们一般会在里面放一些非对象类的简单数据，对其赋予响应式特征</p>
<h3 data-id="heading-4">基本用法</h3>
<pre><code class="hljs language-csharp" lang="csharp">import { <span class="hljs-keyword">ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 创建响应式数据</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-keyword">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> message = <span class="hljs-keyword">ref</span>(<span class="hljs-string">'Hello Vue3'</span>)
<span class="hljs-keyword">const</span> isVisible = <span class="hljs-keyword">ref</span>(<span class="hljs-literal">true</span>)

<span class="hljs-comment">// 访问值需要.value</span>
console.log(count.<span class="hljs-keyword">value</span>) <span class="hljs-comment">// 0</span>

<span class="hljs-comment">// 修改值</span>
count.<span class="hljs-keyword">value</span> = <span class="hljs-number">10</span>
</code></pre>
<h3 data-id="heading-5">特点</h3>
<ol>
<li><strong>包装基本类型</strong>：可以包装数字、字符串、布尔值等原始类型</li>
<li><strong>.value访问</strong>：需要通过<code>.value</code>属性访问或修改值</li>
<li><strong>模板中无需.value</strong>：在模板中自动解包，直接使用变量名</li>
<li><strong>对象也可包装</strong>：虽然常用于基本类型，但也可以包装对象</li>
</ol>
<h3 data-id="heading-6">适用场景</h3>
<ul>
<li>基本数据类型（字符串、数字、布尔值）</li>
<li>需要在多处引用的单个值</li>
<li>需要明确知道何时访问/修改值的情况</li>
</ul>
<h2 data-id="heading-7">三、reactive详解：对象的深度响应式</h2>
<h3 data-id="heading-8">基本用法</h3>
<pre><code class="hljs language-php" lang="php">import { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 创建响应式对象</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">user</span> = <span class="hljs-title function_ invoke__">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
  <span class="hljs-attr">profile</span>: {
    <span class="hljs-attr">email</span>: <span class="hljs-string">'zhangsan@example.com'</span>,
    <span class="hljs-attr">address</span>: {
      <span class="hljs-attr">city</span>: <span class="hljs-string">'北京'</span>,
      <span class="hljs-attr">street</span>: <span class="hljs-string">'朝阳路'</span>
    }
  }
})

<span class="hljs-comment">// 直接访问属性</span>
console.<span class="hljs-title function_ invoke__">log</span>(user.name) <span class="hljs-comment">// 张三</span>
user.age = <span class="hljs-number">26</span> <span class="hljs-comment">// 自动响应式更新</span>

<span class="hljs-comment">// 嵌套属性也是响应式的</span>
user.profile.address.city = <span class="hljs-string">'上海'</span>
</code></pre>
<h3 data-id="heading-9">特点</h3>
<ol>
<li><strong>深度响应式</strong>：对象的所有嵌套属性都是响应式的</li>
<li><strong>直接访问</strong>：不需要<code>.value</code>，直接使用属性</li>
<li><strong>仅限对象</strong>：只能用于对象类型（对象、数组、Map、Set等）</li>
<li><strong>保持引用</strong>：返回的是原始对象的Proxy代理</li>
</ol>
<h3 data-id="heading-10">适用场景</h3>
<ul>
<li>复杂对象或数据结构</li>
<li>表单数据</li>
<li>需要深度监听的对象</li>
<li>状态管理中的模块状态</li>
</ul>
<h2 data-id="heading-11">四、ref vs reactive：核心差异对比</h2>








































<table><thead><tr><th>特性</th><th>ref</th><th>reactive</th></tr></thead><tbody><tr><td>数据类型</td><td>任意类型</td><td>仅对象类型</td></tr><tr><td>访问方式</td><td>需要<code>.value</code></td><td>直接访问属性</td></tr><tr><td>模板使用</td><td>自动解包</td><td>直接使用</td></tr><tr><td>重新分配</td><td>可重新赋值整个<code>.value</code></td><td>不能重新赋值整个对象</td></tr><tr><td>解构问题</td><td>保持响应式需<code>toRefs</code>配合</td><td>直接解构会丢失响应式</td></tr><tr><td>TypeScript支持</td><td>更好的类型推断</td><td>类型保持</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-useImmerReducer进阶]]></title>    <link>https://juejin.cn/post/7600370554068975642</link>    <guid>https://juejin.cn/post/7600370554068975642</guid>    <pubDate>2026-01-29T04:09:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600370554068975642" data-draft-id="7600508556102991922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-useImmerReducer进阶"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2026-01-29T04:09:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-useImmerReducer进阶
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:09:29.000Z" title="Thu Jan 29 2026 04:09:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在 React 中，<code>useReducer</code> 是处理复杂状态的首选方案。但传统的 Reducer 要求我们必须返回一个新的状态对象，这导致代码中充斥着大量的展开运算符（Spread Operator）。通过结合 <code>Immer</code>，我们可以像修改普通对象一样操作状态，同时保持 React 要求的“不可变性”。</p>
<h2 data-id="heading-1">一、 为什么选择 useImmerReducer？</h2>
<h3 data-id="heading-2">1. 产生背景</h3>
<p>原生 <code>useReducer</code> 的核心是“不可变性”，更新深层嵌套对象时非常繁琐：</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-comment">// 原生 useReducer 的痛苦：需要手动保证不可变性</span>
<span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">user</span>: { ...state.<span class="hljs-property">user</span>, <span class="hljs-attr">age</span>: state.<span class="hljs-property">user</span>.<span class="hljs-property">age</span> + <span class="hljs-number">1</span> } };
</code></pre>
<h3 data-id="heading-3">2. useImmerReducer 的优势</h3>
<ul>
<li><strong>直接修改</strong>：可以使用 <code>push</code>、<code>pop</code> 或直接赋值（<code>draft.count++</code>）。</li>
<li><strong>无需显式返回</strong>：Immer 会自动帮你对比 <code>draft</code> 的变化并生成新的 <code>state</code>。</li>
<li><strong>代码极简</strong>：消除冗长的结构赋值，让 Reducer 逻辑更聚焦于业务。</li>
</ul>
<hr/>
<h2 data-id="heading-4">二、 语法拆解</h2>
<p>在使用前，请确保安装了相关依赖：<code>npm install immer use-immer</code>。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useImmerReducer</span>(reducer, initialState);
</code></pre>
<ul>
<li><strong>reducer</strong>: <code>(draft, action) =&gt; void</code>。此时第一个参数不再是不可变的 <code>state</code>，而是可直接修改的代理对象 <strong><code>draft</code></strong>（草稿）。</li>
<li><strong>initialState</strong>: 初始状态。</li>
<li><strong>dispatch</strong>: 与原生 <code>useReducer</code> 一致，用于派发动作。</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、 TSX 实战示例：强类型计数器</h2>
<p>在 TSX 中，我们通过定义接口和联合类型来确保类型安全。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useImmerReducer } <span class="hljs-keyword">from</span> <span class="hljs-string">'use-immer'</span>;

<span class="hljs-comment">// 1. 定义状态类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">CounterState</span> {
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">history</span>: <span class="hljs-built_in">string</span>[]; <span class="hljs-comment">// 增加一个数组，演示 Immer 的便捷性</span>
}

<span class="hljs-comment">// 2. 定义 Action 类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CounterAction</span> =
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'INCREMENT'</span> }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'DECREMENT'</span> }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">'RESET'</span>; payload?: <span class="hljs-built_in">number</span> };

<span class="hljs-comment">// 3. 编写 Immer 风格的 Reducer</span>
<span class="hljs-comment">// 注意：参数是 draft，且不需要 return</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">counterReducer</span> = (<span class="hljs-params">draft: CounterState, action: CounterAction</span>) =&gt; {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"INCREMENT"</span>:
      draft.<span class="hljs-property">count</span> += <span class="hljs-number">1</span>;
      draft.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'加一'</span>); <span class="hljs-comment">// 直接使用数组原生方法</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"DECREMENT"</span>:
      draft.<span class="hljs-property">count</span> -= <span class="hljs-number">1</span>;
      draft.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'减一'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"RESET"</span>:
      draft.<span class="hljs-property">count</span> = action.<span class="hljs-property">payload</span> || <span class="hljs-number">0</span>;
      draft.<span class="hljs-property">history</span> = []; <span class="hljs-comment">// 重置数组</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-attr">default</span>:
      <span class="hljs-comment">// 无需处理 default 情况下的返回，Immer 会自动处理</span>
      <span class="hljs-keyword">break</span>;
  }
};

<span class="hljs-comment">// 4. 组件实现</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Counter</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useImmerReducer</span>(counterReducer, { 
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>, 
    <span class="hljs-attr">history</span>: [] 
  });

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前数值: {state.count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'INCREMENT' })}&gt;+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'DECREMENT' })}&gt;-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'RESET', payload: 0 })}&gt;重置<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>操作历史记录：<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {state.history.map((item, index) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>{item}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Counter</span>;
</code></pre>
<hr/>
<h2 data-id="heading-6">四、 核心细节与进阶补充</h2>
<h3 data-id="heading-7">1. 为什么不需要 <code>return</code>？</h3>
<p>在 <code>useImmerReducer</code> 中，Immer 内部使用了 <strong>Proxy</strong>。当你修改 <code>draft</code> 时，它会记录所有的“变更指令”。函数执行结束时，Immer 会根据这些指令生成一个全新的、不可变的状态对象。</p>
<h3 data-id="heading-8">2. 性能开销</h3>
<p>虽然创建 <code>Proxy</code> 代理会有细微的性能开销，但在绝大多数业务场景下（如复杂的表单管理、大型列表操作），它减少了大量解构赋值带来的内存开销和逻辑复杂度，是完全值得的。</p>
<h3 data-id="heading-9">3. 注意事项</h3>
<ul>
<li><strong>不要尝试返回 <code>draft</code></strong>：Reducer 函数内部直接操作即可，不需要 <code>return draft</code>。</li>
<li><strong>不要在外部持有 <code>draft</code> 引用</strong>：<code>draft</code> 仅在 Reducer 函数执行期间有效。</li>
<li><strong>配合 TypeScript</strong>：使用 TSX 时，明确定义 <code>Action</code> 的类型可以获得完美的智能补全，防止拼写错误（如把 <code>INCREMENT</code> 拼成 <code>INCREEMENT</code>）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【CesiumJS】1. 快速开始]]></title>    <link>https://juejin.cn/post/7600380007885652018</link>    <guid>https://juejin.cn/post/7600380007885652018</guid>    <pubDate>2026-01-29T05:00:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600380007885652018" data-draft-id="7600260767688081434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【CesiumJS】1. 快速开始"/> <meta itemprop="keywords" content="cesium,数据可视化"/> <meta itemprop="datePublished" content="2026-01-29T05:00:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数佳"/> <meta itemprop="url" content="https://juejin.cn/user/1733274175541037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【CesiumJS】1. 快速开始
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1733274175541037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    数佳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:00:23.000Z" title="Thu Jan 29 2026 05:00:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>官方 CesiumJS 教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcesium.com%2Flearn%2Fcesiumjs-learn%2F" target="_blank" title="https://cesium.com/learn/cesiumjs-learn/" ref="nofollow noopener noreferrer">cesium.com/learn/cesiu…</a></p>
<ul>
<li>Cesium 是一款开源 JavaScript 库，是面向网页端的 3D 地理空间可视化开发平台。</li>
<li>在高精度 WGS84 地球模型上进行可视化与分析。</li>
</ul>
<h2 data-id="heading-0">1. 创建账户并获取 token</h2>
<p>Cesium ion 是一款用于 3D 内容流式传输与托管的开放式平台。</p>
<p>免费<a href="https://link.juejin.cn?target=https%3A%2F%2Fion.cesium.com%2Fsignup" target="_blank" title="https://ion.cesium.com/signup" ref="nofollow noopener noreferrer">注册</a>一个 Cesium ion 账户，即可在应用中获取全球卫星图像和真实世界的 3D 内容。</p>
<p>进入 <code>Access Tokens</code> tab，复制 token。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/062a67d6d8f44387a028db65df29c7b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770267623&amp;x-signature=TuQy9x8MXLAjGUH3DUqco0lnxEI%3D" alt="4.png" loading="lazy"/></p>
<h2 data-id="heading-1">2. 搭建 CesiumJS 客户端</h2>
<p>CesiumJS 是一款开源的 JavaScript 引擎。我们将通过它来可视化从 Cesium ion 加载的内容。</p>
<p>注：将 <code>your_access_token</code> 替换为 2.1. 中获取的 token</p>
<h3 data-id="heading-2">2.1 CDN 引入</h3>
<p>使用 Cesium 需要引入两个文件，分别是<code>Cesium.js</code> 和 <code>widgets.css</code> 。</p>
<p>使用 <code>Open With Live Server</code> 打开才可以正确运行。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- Include the CesiumJS JavaScript and CSS files --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Cesium.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cesium.com/downloads/cesiumjs/releases/1.135/Build/Cesium/Widgets/widgets.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cesiumContainer"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// Your access token can be found at: https://ion.cesium.com/tokens.</span>
    <span class="hljs-comment">// This is the default access token from your ion account</span>

    <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Ion</span>.<span class="hljs-property">defaultAccessToken</span> = <span class="hljs-string">'your_access_token'</span>;

    <span class="hljs-comment">// Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.</span>
    <span class="hljs-keyword">const</span> viewer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Viewer</span>(<span class="hljs-string">'cesiumContainer'</span>);    
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">2.2 npm 安装</h3>
<p>如果使用 Webpack、Parcel 或 Rollup 等模块打包工具构建应用，则可以通过运行以下命令安装 CesiumJS：</p>
<pre><code class="hljs language-bash" lang="bash">npm install cesium
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// The URL on your server where CesiumJS's static files are hosted.</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">CESIUM_BASE_URL</span> = <span class="hljs-string">'/'</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Ion</span>, <span class="hljs-title class_">Viewer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'cesium'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"cesium/Build/Cesium/Widgets/widgets.css"</span>;

<span class="hljs-comment">// Your access token can be found at: https://ion.cesium.com/tokens.</span>
<span class="hljs-comment">// This is the default access token from your ion account</span>
<span class="hljs-title class_">Ion</span>.<span class="hljs-property">defaultAccessToken</span> = <span class="hljs-string">'your_access_token'</span>;

<span class="hljs-comment">// Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.</span>
<span class="hljs-keyword">const</span> viewer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Viewer</span>(<span class="hljs-string">'cesiumContainer'</span>);
</code></pre>
<p><strong>配置 CESIUM_BASE_URL</strong></p>
<p>CesiumJS 需要一些静态文件托管在您的服务器上，例如 Web Worker 和 SVG 图标。</p>
<p>请将以下目录复制到项目中，并和前端项目一起部署至自己的服务器，将它们作为静态文件提供。</p>
<ul>
<li><code>node_modules/cesium/Build/Cesium/Workers</code></li>
<li><code>node_modules/cesium/Build/Cesium/ThirdParty</code></li>
<li><code>node_modules/cesium/Build/Cesium/Assets</code></li>
<li><code>node_modules/cesium/Build/Cesium/Widgets</code></li>
</ul>
<p>必须在导入 CesiumJS 之前设置全局变量 <code>window.CESIUM_BASE_URL</code> 。它必须指向提供这四个目录的 URL。例如将上述四个文件复制至 public 目录下，则 <code>window.CESIUM_BASE_URL = "/"</code> 。</p>
<p><strong>在 React 的 Next 框架中使用Cesium</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"use client"</span>;

<span class="hljs-comment">// The URL on your server where CesiumJS's static files are hosted.</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">"undefined"</span>) {
  (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">CESIUM_BASE_URL</span> = <span class="hljs-string">"/"</span>;
}

<span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Ion</span>,
  <span class="hljs-title class_">Terrain</span>,
  <span class="hljs-title class_">Viewer</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"cesium"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"cesium/Build/Cesium/Widgets/widgets.css"</span>;

<span class="hljs-comment">// Your access token can be found at: https://ion.cesium.com/tokens.</span>
<span class="hljs-comment">// This is the default access token from your ion account</span>
<span class="hljs-title class_">Ion</span>.<span class="hljs-property">defaultAccessToken</span> = <span class="hljs-string">"your_access_token"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> cesiumContainerRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> viewerRef = useRef&lt;<span class="hljs-title class_">Viewer</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 确保容器存在后再初始化 Viewer</span>
    <span class="hljs-keyword">if</span> (!cesiumContainerRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// Initialize the Cesium Viewer</span>
    <span class="hljs-keyword">const</span> viewer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Viewer</span>(cesiumContainerRef.<span class="hljs-property">current</span>);

    viewerRef.<span class="hljs-property">current</span> = viewer;

    <span class="hljs-comment">// 组件卸载时销毁 viewer</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (viewerRef.<span class="hljs-property">current</span>) {
        viewerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">destroy</span>();
        viewerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
      }
    };
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{cesiumContainerRef}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> "<span class="hljs-attr">100</span>%", <span class="hljs-attr">height:</span> "<span class="hljs-attr">100vh</span>" }} /&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-4">3. Cesium 目录结构</h2>
<p>下载源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcesium.com%2Fdownloads%2F" target="_blank" title="https://cesium.com/downloads/" ref="nofollow noopener noreferrer">cesium.com/downloads/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fbbe6d709744aec94d16ee1b3656092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770267623&amp;x-signature=JQCIk8DJOJbXzZiTwEV0V0bBhXQ%3D" alt="1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a6df51447ea4548a2e623c53d460bf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770267623&amp;x-signature=jGBZT%2FEUCHxjCe4j7C1GyIkYxrg%3D" alt="2.png" loading="lazy"/></p>
<ul>
<li><code>Apps</code>: Cesium 示例代码和数据。
<ul>
<li><code>CesiumViewer</code>：一个简单的 Cesium 初始化示例。</li>
<li><code>SampleData</code>：所有示例代码所用到的数据，包括 json、geoJson、topojson、kml、czml、gltf、3dtiles 以及图片等。</li>
<li><code>Sandcastle</code>：Ceisum 的示例程序代码，查阅每一个示例代码，一定会有新的收获。</li>
<li><code>TimelineDemo</code>：时间轴示例代码。</li>
</ul>
</li>
<li><code>Build</code>：用于生产环境的包和文档。
<ul>
<li><code>Cesium</code>：打包之后的 Cesium 库（压缩）。</li>
<li><code>CesiumUnminified</code>：打包之后的 Cesium 库（未压缩），引用该文件可方便开发人员进行调试，找到程序异常或报错的具体代码位置。</li>
<li><code>Documentation</code>：打包之后的 API 文档。</li>
</ul>
</li>
<li><code>packages</code>：Cesium 源码，主要分为 engine（引擎）和 widgets（部件）。</li>
<li><code>Source</code>：Cesium 源码的索引文件。</li>
<li><code>Specs</code>：自动化单元测试，采用了 Jasmine 框架 ，可以实现接口的自动化测试以及接口覆盖率等统计效果。</li>
<li><code>ThirdParty</code>：所依赖的第三方库，比如代码编辑器 codemirror、单元测试框架库 Jasmine、JavaScript 语法和风格的检查工具 JSHint 等。</li>
<li><code>CHANGES.md</code>：Cesium 每个版本的变更记录。</li>
<li><code>gulpfile.js</code>：打包脚本，记录了 Cesium 的所有打包流程，包括 GLSL 语法的转义、压缩和未压缩库文件的打包、API 文档的生成以及自动化单元测试等。</li>
<li><code>index.html</code>：Web 首页。</li>
<li><code>server.js</code>：Cesium 内置的 Node 服务器文件，命令 <code>npm run start</code> 以及 <code>npm run start-public</code> 实际上执行的文件。</li>
</ul>
<p>用 <code>VS Code</code> 打开解压后的文件夹，打开根目录下的 <code>index.html</code>，右击 <code>Open With Live Server</code> ；或者 <code>npm install</code>，<code>npm run start</code>运行界面如下：</p>
<ul>
<li><code>Cesium ion</code>：Cesium 的数据服务平台，包含在线资源-地形(createWorldTerrain)、影像(createWorldImagery/IonImageryProvider)、OSM (createOsmBuildings)、点云 (IonResource.fromAssetId)、3DTiles 等。</li>
<li><code>Local links</code>：Cesium 本地资源链接，文档、示例、单元测试等。</li>
<li><code>External links</code>：Cesium 外部资源链接，社区、博客、GitHub等。</li>
</ul>
<p>Local links 选项包含了文档和示例等，打开后和官网一样，可以使用下载的包部署一个离线版本，方便没有网络时使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bcc7c9f1e6f409d9bbaaad4df526f79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5L2z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770267623&amp;x-signature=F0%2BIQMDF8rZaRHf%2BAdFGWL2%2Blqc%3D" alt="3.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Nuxt 3 中使用 transformers.js 实现浏览器端中英翻译（支持本地模型与进度条）]]></title>    <link>https://juejin.cn/post/7600508556103090226</link>    <guid>https://juejin.cn/post/7600508556103090226</guid>    <pubDate>2026-01-29T05:09:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600508556103090226" data-draft-id="7600370554069155866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Nuxt 3 中使用 transformers.js 实现浏览器端中英翻译（支持本地模型与进度条）"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2026-01-29T05:09:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不知处"/> <meta itemprop="url" content="https://juejin.cn/user/3461681342332408"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Nuxt 3 中使用 transformers.js 实现浏览器端中英翻译（支持本地模型与进度条）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3461681342332408/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不知处
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:09:39.000Z" title="Thu Jan 29 2026 05:09:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景与目标</h2>
<p>本文介绍如何在 <strong>Nuxt 3</strong> 项目中，利用 <strong>transformers.js + Xenova 翻译模型</strong>，实现完全运行在浏览器端的中英文互译能力，并满足：</p>
<ul>
<li>模型文件<strong>部署在公司内网服务器</strong>，无外网依赖。</li>
<li>首次加载模型时有<strong>下载进度提示</strong>。</li>
<li>支持中 → 英、英 → 中双向翻译。</li>
</ul>
<p>整套方案适合对隐私敏感（不想把文本发云端）、且希望快速集成前端 AI 翻译能力的业务场景。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F1620027" target="_blank" title="https://developer.aliyun.com/article/1620027" ref="nofollow noopener noreferrer"/></p>
<hr/>
<h2 data-id="heading-1">1. 模型选型与部署方案</h2>
<h2 data-id="heading-2">1.1 模型选型</h2>
<p>在浏览器端做翻译，需要在 <strong>效果</strong> 与 <strong>体积</strong> 之间权衡。常见选择：</p>
<ol>
<li>
<p><strong>Xenova/opus-mt-zh-en &amp; Xenova/opus-mt-en-zh</strong></p>
<ul>
<li>基于 Helsinki-NLP 的 OPUS-MT（Marian）模型的 ONNX 版本。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FXenova%2Fopus-mt-en-zh" target="_blank" title="https://huggingface.co/Xenova/opus-mt-en-zh" ref="nofollow noopener noreferrer"/></li>
<li>针对中英单语对，体积相对较小（单模型约几十 MB 级）。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgist.github.com%2Fcomaniac%2Fd6d037ce3189e3ecd63eb99f1c4d53a2" target="_blank" title="https://gist.github.com/comaniac/d6d037ce3189e3ecd63eb99f1c4d53a2" ref="nofollow noopener noreferrer"/>​</li>
<li>已由 Xenova 适配 transformers.js，开箱即用。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40xenova%2Ftransformers" target="_blank" title="https://www.npmjs.com/package/@xenova/transformers" ref="nofollow noopener noreferrer"/></li>
<li>综合考虑浏览器加载性能与实现难度，是当前<strong>最现实的中英文浏览器端翻译方案</strong>。</li>
</ul>
</li>
<li>
<p><strong>Xenova/nllb-200-distilled-600M</strong>（更高质量但更大）</p>
<ul>
<li>基于 Meta NLLB-200 的 600M 蒸馏版，可翻译 200 语言。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Ftransformers%2Fmodel_doc%2Fnllb" target="_blank" title="https://huggingface.co/docs/transformers/model_doc/nllb" ref="nofollow noopener noreferrer"/></li>
<li>翻译效果普遍优于 OPUS-MT，但体积大（600M 级），浏览器端首次加载时间明显增加。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FXenova%2Fnllb-200-distilled-600M" target="_blank" title="https://huggingface.co/Xenova/nllb-200-distilled-600M" ref="nofollow noopener noreferrer"/></li>
<li>更适合桌面环境或对质量极度敏感的场景。</li>
</ul>
</li>
</ol>
<p>在公司内部部署、关注首屏性能的前提下，本文采用：</p>
<ul>
<li><code>Xenova/opus-mt-zh-en</code>：中文 → 英文。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FXenova%2Fopus-mt-zh-en" target="_blank" title="https://huggingface.co/Xenova/opus-mt-zh-en" ref="nofollow noopener noreferrer"/>​</li>
<li><code>Xenova/opus-mt-en-zh</code>：英文 → 中文。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FXenova%2Fopus-mt-en-zh" target="_blank" title="https://huggingface.co/Xenova/opus-mt-en-zh" ref="nofollow noopener noreferrer"/>​</li>
</ul>
<h2 data-id="heading-3">1.2 模型下载与目录结构</h2>
<p>在 Nuxt 项目根目录下，使用 <code>public</code> 作为静态资源目录（Nuxt 会原样暴露为静态资源）：<a href="https://juejin.cn/post/7238570834344067131" target="_blank" title="https://juejin.cn/post/7238570834344067131"/>​</p>
<pre><code class="hljs language-bash" lang="bash">bash
<span class="hljs-comment"># 在项目根目录执行</span>
<span class="hljs-built_in">mkdir</span> -p public/models/Xenova

<span class="hljs-comment"># 下中 -&gt; 英</span>
git <span class="hljs-built_in">clone</span> https://huggingface.co/Xenova/opus-mt-zh-en public/models/Xenova/opus-mt-zh-en

<span class="hljs-comment"># 下英 -&gt; 中</span>
git <span class="hljs-built_in">clone</span> https://huggingface.co/Xenova/opus-mt-en-zh public/models/Xenova/opus-mt-en-zh
</code></pre>
<p>目录结构大致如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">text
your-nuxt-app/
  <span class="hljs-keyword">public</span>/
    models/
      Xenova/
        opus-mt-zh-en/
          config.json
          tokenizer.json
          vocab files...
          onnx/
            model.onnx
            ...
        opus-mt-en-zh/
          ...
</code></pre>
<p>Nuxt 打包后，可直接通过 URL 访问：</p>
<ul>
<li><code>/models/Xenova/opus-mt-zh-en/config.json</code></li>
<li><code>/models/Xenova/opus-mt-en-zh/onnx/model.onnx</code></li>
</ul>
<p>浏览器端的 transformers.js 会按模型 ID 映射到这些路径读取文件。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhugging-face.cn%2Fdocs%2Ftransformers.js%2Fapi%2Fenv" target="_blank" title="https://hugging-face.cn/docs/transformers.js/api/env" ref="nofollow noopener noreferrer"/></p>
<hr/>
<h2 data-id="heading-4">2. 在 Nuxt 3 中集成 transformers.js</h2>
<h2 data-id="heading-5">2.1 安装依赖</h2>
<pre><code class="hljs language-bash" lang="bash">bash
npm install @xenova/transformers
</code></pre>
<p><code>@xenova/transformers</code> 是 transformers.js 在 npm 上的包名，支持浏览器环境、提供 ONNX 推理能力。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40xenova%2Ftransformers" target="_blank" title="https://www.npmjs.com/package/@xenova/transformers" ref="nofollow noopener noreferrer"/>​</p>
<h2 data-id="heading-6">2.2 创建 Nuxt 插件：统一封装翻译逻辑</h2>
<p>我们在 <code>plugins/transformers.client.ts</code> 中：</p>
<ul>
<li>配置 transformers.js 使用本地模型路径。</li>
<li>提供 <code>translate(text, dir)</code> 方法供组件调用。</li>
<li>增加 <code>progress_callback</code>，用于显示模型下载进度。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Ftransformers.js%2Fissues%2F735" target="_blank" title="https://github.com/huggingface/transformers.js/issues/735" ref="nofollow noopener noreferrer"/></li>
</ul>
<pre><code class="hljs language-ini" lang="ini">ts
// plugins/transformers.client.ts
import { defineNuxtPlugin } from '<span class="hljs-comment">#app';</span>
import { pipeline, env } from '@xenova/transformers'<span class="hljs-comment">;</span>

export default defineNuxtPlugin(() =&gt; {
  // 只用本地模型，不访问外网
  <span class="hljs-attr">env.allowRemoteModels</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  // 指向 /public/models 目录
  <span class="hljs-attr">env.localModelPath</span> = <span class="hljs-string">'/models/'</span><span class="hljs-comment">;            // 注意末尾斜杠</span>
  // 开启浏览器缓存（IndexedDB + Cache Storage）
  <span class="hljs-attr">env.useBrowserCache</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;                 // 下次加载更快</span>

  // 用于 UI 层显示加载状态
  const <span class="hljs-attr">loadingStatus</span> = ref({
    model: null as string | null,
    progress: 0,
    status: 'idle' as 'idle' | 'loading' | 'ready' | 'error',
    message: '',
  })<span class="hljs-comment">;</span>

  let zh2enPromise: Promise&lt;any&gt; | <span class="hljs-attr">null</span> = null<span class="hljs-comment">;</span>
  let en2zhPromise: Promise&lt;any&gt; | <span class="hljs-attr">null</span> = null<span class="hljs-comment">;</span>

  // transformers.js 的下载 / 加载进度回调<span class="hljs-section">[web:66]</span><span class="hljs-section">[web:67]</span><span class="hljs-section">[web:68]</span><span class="hljs-section">[web:70]</span>
  const <span class="hljs-attr">progressCallback</span> = (args: any) =&gt; {
    if (<span class="hljs-attr">args.status</span> === <span class="hljs-string">'progress'</span>) {
      <span class="hljs-attr">loadingStatus.value.progress</span> = Math.round(args.progress)<span class="hljs-comment">;</span>
      <span class="hljs-attr">loadingStatus.value.message</span> = args.file || <span class="hljs-string">'模型文件'</span><span class="hljs-comment">;</span>
    } else if (<span class="hljs-attr">args.status</span> === <span class="hljs-string">'loading'</span>) {
      <span class="hljs-attr">loadingStatus.value.status</span> = <span class="hljs-string">'loading'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">loadingStatus.value.model</span> = args.model<span class="hljs-comment">;</span>
      <span class="hljs-attr">loadingStatus.value.message</span> = <span class="hljs-string">'开始加载模型'</span><span class="hljs-comment">;</span>
    } else if (<span class="hljs-attr">args.status</span> === <span class="hljs-string">'ready'</span>) {
      <span class="hljs-attr">loadingStatus.value.status</span> = <span class="hljs-string">'ready'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">loadingStatus.value.message</span> = <span class="hljs-string">'模型加载完成'</span><span class="hljs-comment">;</span>
    } else if (<span class="hljs-attr">args.status</span> === <span class="hljs-string">'error'</span>) {
      <span class="hljs-attr">loadingStatus.value.status</span> = <span class="hljs-string">'error'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">loadingStatus.value.message</span> = <span class="hljs-string">'模型加载失败'</span><span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">getZh2En</span> = () =&gt; {
    if (!zh2enPromise) {
      <span class="hljs-attr">loadingStatus.value.model</span> = <span class="hljs-string">'Xenova/opus-mt-zh-en'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">zh2enPromise</span> = pipeline(<span class="hljs-string">'translation'</span>, <span class="hljs-string">'Xenova/opus-mt-zh-en'</span>, {
        progress_callback: progressCallback,
      })<span class="hljs-comment">;</span>
    }
    return zh2enPromise<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">getEn2Zh</span> = () =&gt; {
    if (!en2zhPromise) {
      <span class="hljs-attr">loadingStatus.value.model</span> = <span class="hljs-string">'Xenova/opus-mt-en-zh'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">en2zhPromise</span> = pipeline(<span class="hljs-string">'translation'</span>, <span class="hljs-string">'Xenova/opus-mt-en-zh'</span>, {
        progress_callback: progressCallback,
      })<span class="hljs-comment">;</span>
    }
    return en2zhPromise<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">translate</span> = async (text: string, dir: <span class="hljs-string">'zh-en'</span> | <span class="hljs-string">'en-zh'</span>) =&gt; {
    const <span class="hljs-attr">pipe</span> = dir === <span class="hljs-string">'zh-en'</span> ? await getZh2En() : await getEn2Zh()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">out</span> = await pipe(text)<span class="hljs-comment">;</span>
    return out<span class="hljs-section">[0]</span>?.translation_text ?? ''<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return {
    provide: {
      translate,
      loadingStatus,
    },
  }<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>说明：</p>
<ul>
<li><code>env.localModelPath</code> 会让 transformers.js 在 <code>localModelPath/&lt;model-id&gt;/</code> 下寻找模型文件。<a href="https://link.juejin.cn?target=http%3A%2F%2Fcodesandbox.io%2Fp%2Fgithub%2FTrawmoney%2Ftransformers.js-clone" target="_blank" title="http://codesandbox.io/p/github/Trawmoney/transformers.js-clone" ref="nofollow noopener noreferrer"/></li>
<li><code>env.useBrowserCache = true</code> 后，下载的模型会缓存到浏览器，下次访问无需重新下载。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Ftransformers.js%2Fissues%2F735" target="_blank" title="https://github.com/huggingface/transformers.js/issues/735" ref="nofollow noopener noreferrer"/></li>
<li><code>progress_callback</code> 中的 <code>status</code>、<code>progress</code>、<code>file</code> 等可用于 UI 展示下载进度。<a href="https://link.juejin.cn?target=https%3A%2F%2Fzenn.dev%2Fhiraoku%2Farticles%2Fdc226873ee6262" target="_blank" title="https://zenn.dev/hiraoku/articles/dc226873ee6262" ref="nofollow noopener noreferrer"/></li>
</ul>
<hr/>
<h2 data-id="heading-7">3. 构建一个翻译页面：输入、输出与进度条</h2>
<p>在 <code>pages/translate.vue</code> 中实现一个简单的翻译工具页，支持方向选择、进度显示。</p>
<pre><code class="hljs language-xml" lang="xml">text
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> input = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> output = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> direction = ref&lt;<span class="hljs-string">'zh-en'</span> | <span class="hljs-string">'en-zh'</span>&gt;(<span class="hljs-string">'zh-en'</span>);
<span class="hljs-keyword">const</span> translating = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">const</span> error = ref&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">const</span> { $translate, $loadingStatus } = <span class="hljs-title function_">useNuxtApp</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">doTranslate</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (!input.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span>;

  translating.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">try</span> {
    output.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> $translate(input.<span class="hljs-property">value</span>, direction.<span class="hljs-property">value</span>);
  } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: any) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
    error.<span class="hljs-property">value</span> = <span class="hljs-string">'翻译失败，请联系管理员检查模型文件和路径'</span>;
  } <span class="hljs-keyword">finally</span> {
    translating.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"p-4 max-w-3xl mx-auto"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 模型加载进度提示 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">v-if</span>=<span class="hljs-string">"$loadingStatus.status === 'loading'"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-4 p-3 border rounded bg-blue-50"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center gap-2 mb-1"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-2 h-2 bg-blue-500 rounded-full animate-spin"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>加载中：{{ $loadingStatus.model }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center gap-2 text-sm text-gray-600"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ $loadingStatus.message }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ml-auto"</span>&gt;</span>{{ Math.round($loadingStatus.progress) }}%<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full bg-gray-200 rounded-full h-2 mt-1"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-blue-500 h-2 rounded-full transition-all"</span>
          <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ width: `${$loadingStatus.progress}%` }"</span>
        &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 翻译方向选择 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mb-3 flex gap-2 items-center"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>翻译方向：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"direction"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"border px-2 py-1"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"zh-en"</span>&gt;</span>中 → 英<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"en-zh"</span>&gt;</span>英 → 中<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 输入文本 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span>
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"input"</span>
      <span class="hljs-attr">rows</span>=<span class="hljs-string">"5"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full border p-2 mb-2"</span>
      <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"$loadingStatus.status === 'loading'"</span>
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入要翻译的文本（首次使用会自动下载模型）"</span>
    /&gt;</span>

    <span class="hljs-comment">&lt;!-- 操作按钮 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"border px-4 py-1"</span>
      <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"translating || $loadingStatus.status === 'loading'"</span>
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"doTranslate"</span>
    &gt;</span>
      {{ translating ? '翻译中…' : '翻译' }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"border px-3 py-1 ml-2 text-sm"</span>
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"resetModels"</span>
    &gt;</span>
      清除模型缓存（测试下载进度）
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 错误提示 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"error"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-red-500 mt-2"</span>&gt;</span>{{ error }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 输出结果 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span>
      <span class="hljs-attr">:value</span>=<span class="hljs-string">"output"</span>
      <span class="hljs-attr">readonly</span>
      <span class="hljs-attr">rows</span>=<span class="hljs-string">"5"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full border p-2 mt-2 bg-gray-50"</span>
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"翻译结果"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>上面模板里用到了 <code>resetModels</code>，见下一节。</p>
<hr/>
<h2 data-id="heading-8">4. 清除浏览器缓存，重复触发首次下载进度</h2>
<p>为了测试和演示下载进度，需要能清空 transformers.js 在浏览器里的模型缓存。transformers.js 默认使用 Cache Storage（如 <code>transformers-cache</code>）以及 IndexedDB 来缓存模型文件。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Ftransformers.js-examples%2Fissues%2F20" target="_blank" title="https://github.com/huggingface/transformers.js-examples/issues/20" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-9">4.1 提供一个 composable 清缓存</h2>
<p><code>composables/useTransformersCache.ts</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript">ts
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTransformersCache</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 清除 transformers.js 的所有缓存（包括所有模型）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearAll</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'caches'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">await</span> caches.<span class="hljs-title function_">delete</span>(<span class="hljs-string">'transformers-cache'</span>); <span class="hljs-comment">// 默认缓存名[web:66][web:88]</span>
  };

  <span class="hljs-comment">// 仅清除包含某个模型名的缓存请求</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearModel</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">modelName: string</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'caches'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">await</span> caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">'transformers-cache'</span>);
    <span class="hljs-keyword">const</span> keys = <span class="hljs-keyword">await</span> cache.<span class="hljs-title function_">keys</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> req <span class="hljs-keyword">of</span> keys) {
      <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(modelName)) {
        <span class="hljs-keyword">await</span> cache.<span class="hljs-title function_">delete</span>(req);             <span class="hljs-comment">// 官方 issue 中的用法[web:86]</span>
      }
    }
  };

  <span class="hljs-keyword">return</span> { clearAll, clearModel };
}
</code></pre>
<h2 data-id="heading-10">4.2 页面中使用清缓存按钮</h2>
<p>在 <code>pages/translate.vue</code> 的 <code>&lt;script setup&gt;</code> 中加入：</p>
<pre><code class="hljs language-scss" lang="scss">ts
const { clearAll } = <span class="hljs-built_in">useTransformersCache</span>();

const resetModels = async () =&gt; {
  await <span class="hljs-built_in">clearAll</span>();
  location<span class="hljs-selector-class">.reload</span>(); <span class="hljs-comment">// 刷新后再翻译，就会重新触发下载与进度条</span>
};
</code></pre>
<p>调试流程：</p>
<ol>
<li>打开翻译页面，首次翻译时看到模型下载进度条。</li>
<li>点击“清除模型缓存”按钮，页面自动刷新。</li>
<li>再次翻译，确认下载进度条再次出现。</li>
</ol>
<p>如果只想在调试阶段每次都看到进度，可以临时将 <code>env.useBrowserCache = false</code>，关闭缓存。<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fgitblog_00349%2Farticle%2Fdetails%2F151214871" target="_blank" title="https://blog.csdn.net/gitblog_00349/article/details/151214871" ref="nofollow noopener noreferrer"/></p>
<hr/>
<h2 data-id="heading-11">5. 部署与注意事项</h2>
<h2 data-id="heading-12">5.1 Nuxt 部署方式</h2>
<ul>
<li>本文方案完全运行在 <strong>浏览器端</strong>，Nuxt 可使用 SSR 或静态导出（<code>nuxt generate</code>），对翻译功能无影响。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.shiniest.cn%2Fblog%2Farticle%2F163" target="_blank" title="https://www.shiniest.cn/blog/article/163" ref="nofollow noopener noreferrer"/>​</li>
<li>需要确保生产环境的静态资源可通过 <code>/models/...</code> 路径访问；若应用部署在子路径（如 <code>/app/</code>），需相应调整 <code>env.localModelPath = '/app/models/'</code>。</li>
</ul>
<h2 data-id="heading-13">5.2 内网环境建议</h2>
<ul>
<li>模型文件托管在公司内部服务器，可以通过 <code>git clone</code> 预拉取到构建机 / 静态服务器，避免运行时从外网下载。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fharisnae%2Fmultilingual-translator-offline" target="_blank" title="https://github.com/harisnae/multilingual-translator-offline" ref="nofollow noopener noreferrer"/></li>
<li>内网带宽充足时，OPUS-MT 这一级别模型首次加载通常在 2–5 秒内完成，配合进度条体验较好。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgist.github.com%2Fcomaniac%2Fd6d037ce3189e3ecd63eb99f1c4d53a2" target="_blank" title="https://gist.github.com/comaniac/d6d037ce3189e3ecd63eb99f1c4d53a2" ref="nofollow noopener noreferrer"/></li>
</ul>
<hr/>
<h2 data-id="heading-14">6. 扩展方向</h2>
<p>在上述基础上，可以进一步扩展：</p>
<ul>
<li>
<p><strong>划词翻译 / 悬浮翻译</strong>：监听 <code>selectionchange</code>，获取用户选中文本，调用 <code>translate</code> 并展示浮层。</p>
</li>
<li>
<p><strong>与 @nuxtjs/i18n 集成</strong>：</p>
<ul>
<li>固定 UI 文案使用 i18n 语言包。</li>
<li>动态内容（用户输入、后台数据）使用浏览器端翻译作为辅助。</li>
</ul>
</li>
<li>
<p><strong>换更高质量模型</strong>：对于桌面场景，可以尝试 <code>Xenova/nllb-200-distilled-600M</code> 替换 OPUS-MT，并根据项目情况接受更长的首次加载时间。<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Ftransformers%2Fmodel_doc%2Fnllb" target="_blank" title="https://huggingface.co/docs/transformers/model_doc/nllb" ref="nofollow noopener noreferrer"/></p>
</li>
</ul>
<hr/>
<h2 data-id="heading-15">总结</h2>
<p>通过 <strong>Nuxt 3 + transformers.js + Xenova OPUS-MT 模型</strong>，我们可以在浏览器中实现：</p>
<ul>
<li>纯前端中英翻译（无服务端 API）。</li>
<li>模型文件本地化部署到公司内网。</li>
<li>首次加载带下载进度展示，可复现测试。</li>
</ul>
<p>这套方案对于强调数据隐私、安全边界清晰、且愿意在前端接受一定模型体积的业务来说，是一条非常实用的落地路径。<a href="https://juejin.cn/post/7413629689253625910" target="_blank" title="https://juejin.cn/post/7413629689253625910"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python路径处理全方案：Path、os、shutil等核心工具详解与对比]]></title>    <link>https://juejin.cn/post/7600316828486500367</link>    <guid>https://juejin.cn/post/7600316828486500367</guid>    <pubDate>2026-01-29T05:33:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600316828486500367" data-draft-id="7600316828486483983" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python路径处理全方案：Path、os、shutil等核心工具详解与对比"/> <meta itemprop="keywords" content="Python,后端"/> <meta itemprop="datePublished" content="2026-01-29T05:33:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喝茶与编码"/> <meta itemprop="url" content="https://juejin.cn/user/3378136041922423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python路径处理全方案：Path、os、shutil等核心工具详解与对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3378136041922423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喝茶与编码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:33:35.000Z" title="Thu Jan 29 2026 05:33:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python路径处理全方案：Path、os、shutil等核心工具详解与对比</h2>
<p>在Python开发中，文件路径处理是贯穿项目全流程的基础需求，无论是配置文件读取、目录遍历、文件操作还是跨平台部署，都需要可靠的路径处理方案。Python提供了多套路径处理工具，核心包括<code>pathlib</code>模块的<code>Path</code>、<code>PurePath</code>等类，传统的<code>os</code>模块（含<code>os.path</code>子模块），以及辅助高级文件操作的<code>shutil</code>模块。</p>
<p>本文将系统梳理这些工具的核心用法，重点对比各工具的优劣差异、适用场景，并给出针对性的使用建议，帮助开发者根据项目需求快速选择合适的路径处理方案，规避跨平台兼容、代码冗余等常见问题。</p>
<h3 data-id="heading-1">一、核心工具概览</h3>
<p>Python路径处理工具可分为三大类，各类工具功能互补、侧重不同，核心成员及定位如下：</p>
<ul>
<li>
<p><strong>pathlib模块</strong>：Python 3.4+引入的面向对象路径处理方案，核心类包括<code>Path</code>（文件系统交互类）、<code>PurePath</code>（纯路径解析类，含<code>PurePosixPath</code>、<code>PureWindowsPath</code>两个系统专属子类）；</p>
</li>
<li>
<p><strong>os模块</strong>：Python内置传统工具，核心为<code>os.path</code>子模块（基于字符串的路径处理），配合<code>os.mkdir()</code>、<code>os.listdir()</code>等方法完成基础路径操作；</p>
</li>
<li>
<p><strong>shutil模块</strong>：高级文件/目录操作辅助工具，不专注于路径解析，但可配合前两类工具完成复制、移动、递归删除等复杂操作。</p>
</li>
</ul>
<p>下面先逐一讲解各工具的核心用法，再进行全面对比与建议。</p>
<h3 data-id="heading-2">二、各核心工具详细用法</h3>
<h4 data-id="heading-3">2.1 pathlib模块：面向对象的现代方案</h4>
<p><code>pathlib</code>模块的核心优势是“面向对象”，将路径封装为对象，通过方法调用完成各类操作，代码可读性强、跨平台兼容性好，是Python 3.4+的推荐方案。核心类分为“纯路径类”和“文件系统交互类”两类。</p>
<h5 data-id="heading-4">2.1.1 PurePath：纯路径解析（不交互文件系统）</h5>
<p><code>PurePath</code>是抽象基类，仅负责路径字符串的解析、拼接、格式化，不与实际文件系统交互（无<code>exists()</code>、<code>mkdir()</code>等方法），适合仅需解析路径格式的场景。其两个子类用于强制指定系统路径规则，不受运行环境影响。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> PurePath, PurePosixPath, PureWindowsPath

<span class="hljs-comment"># 1. 基础用法：自动适配当前系统（类似Path，但无文件系统交互）</span>
pp = PurePath(<span class="hljs-string">"data"</span>, <span class="hljs-string">"logs"</span>, <span class="hljs-string">"app.log"</span>)
<span class="hljs-built_in">print</span>(pp.name)        <span class="hljs-comment"># 输出：app.log（提取文件名）</span>
<span class="hljs-built_in">print</span>(pp.parent)      <span class="hljs-comment"># 输出：data/logs（提取父目录）</span>
<span class="hljs-built_in">print</span>(pp.suffix)      <span class="hljs-comment"># 输出：.log（提取文件后缀）</span>
<span class="hljs-built_in">print</span>(pp.joinpath(<span class="hljs-string">"backup"</span>))  <span class="hljs-comment"># 输出：data/logs/app.log/backup（路径拼接）</span>

<span class="hljs-comment"># 2. PurePosixPath：强制按Unix/Linux规则解析（无论运行系统）</span>
posix_pp = PurePosixPath(<span class="hljs-string">"C:/Users/xxx/test.txt"</span>)
<span class="hljs-built_in">print</span>(posix_pp)       <span class="hljs-comment"># 输出：C:/Users/xxx/test.txt（分隔符保持/）</span>
<span class="hljs-built_in">print</span>(posix_pp.root)  <span class="hljs-comment"># 输出：/（Unix风格根目录）</span>

<span class="hljs-comment"># 3. PureWindowsPath：强制按Windows规则解析（无论运行系统）</span>
windows_pp = PureWindowsPath(<span class="hljs-string">"/usr/local/bin/python3"</span>)
<span class="hljs-built_in">print</span>(windows_pp)     <span class="hljs-comment"># 输出：\usr\local\bin\python3（分隔符转为\）</span>
<span class="hljs-built_in">print</span>(windows_pp.root)<span class="hljs-comment"># 输出：\（Windows风格根目录）</span>
</code></pre>
<h5 data-id="heading-5">2.1.2 Path：文件系统交互（核心推荐）</h5>
<p><code>Path</code>是<code>pathlib</code>模块的核心类，继承自<code>PurePath</code>，在纯路径解析功能基础上，增加了与实际文件系统交互的方法（如创建文件/目录、读取文件内容等），是日常开发的首选。</p>
<p>注：<code>Path</code>是工厂类，会根据当前运行系统自动实例化为<code>PosixPath</code>（Unix/Linux/Mac）或<code>WindowsPath</code>（Windows），二者功能一致，仅适配不同系统。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-comment"># 1. 路径创建与拼接（推荐用/运算符，比os.path.join更直观）</span>
p = Path(<span class="hljs-string">"data"</span>) / <span class="hljs-string">"logs"</span> / <span class="hljs-string">"app.log"</span>  <span class="hljs-comment"># 相对路径</span>
abs_p = Path(<span class="hljs-string">"/usr/local/bin/python3"</span>) <span class="hljs-comment"># 绝对路径（Unix）</span>

<span class="hljs-comment"># 2. 路径解析（继承自PurePath）</span>
<span class="hljs-built_in">print</span>(p.name)         <span class="hljs-comment"># 输出：app.log</span>
<span class="hljs-built_in">print</span>(p.stem)         <span class="hljs-comment"># 输出：app（无后缀文件名）</span>
<span class="hljs-built_in">print</span>(p.parent)       <span class="hljs-comment"># 输出：data/logs</span>
<span class="hljs-built_in">print</span>(p.resolve())    <span class="hljs-comment"># 输出：/当前工作目录/data/logs/app.log（解析为真实绝对路径）</span>

<span class="hljs-comment"># 3. 文件系统交互（核心功能）</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> p.parent.exists():  <span class="hljs-comment"># 判断父目录是否存在</span>
    p.parent.mkdir(parents=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 创建多层目录（类似os.makedirs）</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> p.exists():          <span class="hljs-comment"># 判断文件是否存在</span>
    p.touch()               <span class="hljs-comment"># 创建空文件</span>
    p.write_text(<span class="hljs-string">"Hello Path!"</span>)  <span class="hljs-comment"># 写入文本内容（无需手动打开文件）</span>
content = p.read_text()     <span class="hljs-comment"># 读取文本内容</span>
<span class="hljs-built_in">print</span>(content)              <span class="hljs-comment"># 输出：Hello Path!</span>

<span class="hljs-comment"># 4. 目录遍历与匹配</span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> p.parent.iterdir():  <span class="hljs-comment"># 遍历目录下所有文件/子目录</span>
    <span class="hljs-built_in">print</span>(file.name)
py_files = <span class="hljs-built_in">list</span>(Path(<span class="hljs-string">"."</span>).glob(<span class="hljs-string">"*.py"</span>))  <span class="hljs-comment"># 匹配当前目录下所有.py文件</span>
<span class="hljs-built_in">print</span>(py_files)
</code></pre>
<h4 data-id="heading-6">2.2 os模块：传统字符串式路径处理</h4>
<p><code>os</code>模块是Python最早的路径处理工具，核心为<code>os.path</code>子模块，基于字符串操作实现路径处理，无面向对象特性，但兼容性极强（支持Python 2.x+），至今仍广泛用于老项目和简单场景。</p>
<h5 data-id="heading-7">2.2.1 os.path子模块（核心）</h5>
<p><code>os.path</code>提供了一系列字符串处理函数，覆盖路径拼接、解析、判断、规范化等核心需求，自动适配跨平台路径分隔符。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 1. 路径拼接（最常用，替代手动写分隔符）</span>
path = os.path.join(<span class="hljs-string">"data"</span>, <span class="hljs-string">"logs"</span>, <span class="hljs-string">"app.log"</span>)
abs_path = os.path.join(<span class="hljs-string">"/usr/local"</span>, <span class="hljs-string">"bin"</span>, <span class="hljs-string">"python3"</span>)  <span class="hljs-comment"># Unix</span>

<span class="hljs-comment"># 2. 路径解析</span>
<span class="hljs-built_in">print</span>(os.path.basename(path))  <span class="hljs-comment"># 输出：app.log（提取文件名）</span>
<span class="hljs-built_in">print</span>(os.path.dirname(path))   <span class="hljs-comment"># 输出：data/logs（提取目录名）</span>
<span class="hljs-built_in">print</span>(os.path.split(path))     <span class="hljs-comment"># 输出：('data/logs', 'app.log')（同时提取目录和文件名）</span>
<span class="hljs-built_in">print</span>(os.path.splitext(path))  <span class="hljs-comment"># 输出：('data/logs/app', '.log')（提取后缀）</span>

<span class="hljs-comment"># 3. 路径判断</span>
<span class="hljs-built_in">print</span>(os.path.exists(path))    <span class="hljs-comment"># 判断路径是否存在（文件/目录通用）</span>
<span class="hljs-built_in">print</span>(os.path.isfile(path))    <span class="hljs-comment"># 判断是否为文件</span>
<span class="hljs-built_in">print</span>(os.path.isdir(os.path.dirname(path)))  <span class="hljs-comment"># 判断是否为目录</span>
<span class="hljs-built_in">print</span>(os.path.isabs(path))     <span class="hljs-comment"># 判断是否为绝对路径</span>

<span class="hljs-comment"># 4. 路径规范化</span>
messy_path = <span class="hljs-string">"/usr/local/../bin//python3/."</span>
norm_path = os.path.normpath(messy_path)  <span class="hljs-comment"># 清理冗余片段（//、.、..）</span>
<span class="hljs-built_in">print</span>(norm_path)  <span class="hljs-comment"># 输出：/usr/bin/python3</span>
abs_norm_path = os.path.abspath(norm_path)  <span class="hljs-comment"># 转换为绝对路径</span>
<span class="hljs-built_in">print</span>(abs_norm_path)
</code></pre>
<h5 data-id="heading-8">2.2.2 os模块辅助路径操作</h5>
<p>除<code>os.path</code>外，<code>os</code>模块本身提供了目录创建、遍历、切换等辅助方法，配合<code>os.path</code>完成完整操作流程。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 1. 获取/切换当前工作目录</span>
current_dir = os.getcwd()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"当前工作目录：<span class="hljs-subst">{current_dir}</span>"</span>)
os.chdir(<span class="hljs-string">"/tmp"</span>)  <span class="hljs-comment"># 切换工作目录（Unix，Windows需写"C:\\tmp"）</span>

<span class="hljs-comment"># 2. 目录创建与删除</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">"new_dir"</span>):
    os.mkdir(<span class="hljs-string">"new_dir"</span>)  <span class="hljs-comment"># 创建单层目录</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">"new_dir/sub_dir/child_dir"</span>):
    os.makedirs(<span class="hljs-string">"new_dir/sub_dir/child_dir"</span>)  <span class="hljs-comment"># 创建多层目录</span>
os.rmdir(<span class="hljs-string">"new_dir/sub_dir/child_dir"</span>)  <span class="hljs-comment"># 删除空目录（非空报错）</span>

<span class="hljs-comment"># 3. 目录遍历</span>
dir_content = os.listdir(<span class="hljs-string">"data"</span>)  <span class="hljs-comment"># 返回目录下所有文件/子目录名称列表</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"data目录内容：<span class="hljs-subst">{dir_content}</span>"</span>)
</code></pre>
<h4 data-id="heading-9">2.3 shutil模块：高级文件操作辅助工具</h4>
<p><code>shutil</code>模块不专注于路径解析，而是提供高级文件/目录操作功能，可配合<code>pathlib.Path</code>或<code>os.path</code>使用，解决复杂场景下的文件操作需求（如复制、移动、递归删除非空目录等）。</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 1. 文件复制（配合Path）</span>
src_file = Path(<span class="hljs-string">"data/app.log"</span>)
dst_file = Path(<span class="hljs-string">"backup/app.log"</span>)
shutil.copy(src_file, dst_file)  <span class="hljs-comment"># 复制文件内容和权限</span>
<span class="hljs-comment"># 配合os.path</span>
shutil.copy(os.path.join(<span class="hljs-string">"data"</span>, <span class="hljs-string">"app.log"</span>), os.path.join(<span class="hljs-string">"backup"</span>, <span class="hljs-string">"app.log"</span>))

<span class="hljs-comment"># 2. 目录复制（递归复制所有内容）</span>
src_dir = Path(<span class="hljs-string">"data/logs"</span>)
dst_dir = Path(<span class="hljs-string">"backup/logs"</span>)
shutil.copytree(src_dir, dst_dir)  <span class="hljs-comment"># 目标目录不存在时自动创建</span>

<span class="hljs-comment"># 3. 文件/目录移动</span>
shutil.move(src_file, Path(<span class="hljs-string">"backup/app_new.log"</span>))  <span class="hljs-comment"># 移动并可重命名</span>

<span class="hljs-comment"># 4. 递归删除非空目录（比os.rmdir更强大）</span>
shutil.rmtree(dst_dir)  <span class="hljs-comment"># 无需手动删除目录内文件，直接递归删除</span>

<span class="hljs-comment"># 5. 文件归档（压缩）</span>
shutil.make_archive(<span class="hljs-string">"backup/logs_archive"</span>, <span class="hljs-string">"zip"</span>, src_dir)  <span class="hljs-comment"># 将logs目录压缩为zip文件</span>
</code></pre>
<h3 data-id="heading-10">三、核心工具优劣对比</h3>
<p>为便于快速选择，下面从编程风格、核心功能、兼容性、可读性等维度，对<code>pathlib</code>（含Path、PurePath等）、<code>os.path</code>、<code>shutil</code>进行全面对比（注：shutil侧重高级操作，不与前两者直接竞争，对比重点为路径解析/基础操作能力）。</p>



























































<table><thead><tr><th>对比维度</th><th>pathlib（Path/PurePath等）</th><th>os.path（含os模块辅助方法）</th><th>shutil</th></tr></thead><tbody><tr><td>编程风格</td><td>面向对象，路径为对象，支持链式调用（如p.parent.exists()）</td><td>函数式，基于字符串操作，需多次函数嵌套</td><td>函数式，专注操作执行，依赖路径参数输入</td></tr><tr><td>核心能力</td><td>路径解析、拼接、格式化，文件系统交互（创建、读写等），基础遍历匹配</td><td>路径解析、拼接、格式化，基础目录/文件操作（创建、遍历等）</td><td>高级操作（复制、移动、递归删除、压缩等），无独立路径解析能力</td></tr><tr><td>跨平台兼容性</td><td>优秀，自动适配分隔符，PurePosixPath/PureWindowsPath可强制指定规则</td><td>良好，自动适配分隔符，但无强制系统规则的功能</td><td>优秀，基于系统底层操作，自动适配跨平台场景</td></tr><tr><td>Python版本支持</td><td>3.4+（不支持2.x）</td><td>全版本（2.x+、3.x+），兼容性极强</td><td>全版本（2.x+、3.x+），核心功能无版本限制</td></tr><tr><td>代码可读性</td><td>优秀，语义清晰，链式调用减少冗余（如p.write_text()替代open()）</td><td>一般，复杂操作需多函数嵌套（如提取无后缀文件名需os.path.splitext(os.path.basename(path))）</td><td>良好，函数语义明确（如shutil.copytree()即递归复制目录）</td></tr><tr><td>学习成本</td><td>中等，需理解面向对象思想，熟悉类方法</td><td>低，仅需记忆常用函数，逻辑简单直白</td><td>低，功能聚焦，仅需在需要时调用对应函数</td></tr><tr><td>优势场景</td><td>Python 3.x新项目、复杂路径操作、追求代码可读性的场景</td><td>老项目维护、简单路径操作、需要兼容Python 2.x的场景</td><td>复制/移动文件/目录、递归删除非空目录、文件压缩等高级操作</td></tr><tr><td>不足</td><td>不支持Python 2.x，老项目迁移成本高</td><td>非面向对象，代码冗余，无内置文件读写、递归匹配功能</td><td>无独立路径解析能力，必须配合pathlib或os.path使用</td></tr></tbody></table>
<h3 data-id="heading-11">四、分场景使用建议</h3>
<p>结合各工具的优劣特性，针对不同开发场景给出明确使用建议，帮助开发者快速决策：</p>
<h4 data-id="heading-12">4.1 新项目开发（Python 3.4+）</h4>
<p>优先选择 <code>pathlib.Path</code> 作为核心路径处理工具，配合 <code>shutil</code>完成高级操作：</p>
<ul>
<li>
<p>日常路径解析、拼接、文件/目录基础操作（创建、读写、遍历）：使用<code>Path</code>类，代码更简洁、可读性更强；</p>
</li>
<li>
<p>需要固定路径系统规则（如生成跨平台配置文件）：使用<code>PurePosixPath</code>（强制Unix规则）或<code>PureWindowsPath</code>（强制Windows规则）；</p>
</li>
<li>
<p>涉及文件/目录复制、移动、递归删除、压缩：配合<code>shutil</code>模块（如<code>shutil.copytree()</code>、<code>shutil.rmtree()</code>）。</p>
</li>
</ul>
<p>示例组合用法：</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">import</span> shutil

<span class="hljs-comment"># 用Path处理路径，shutil处理高级操作</span>
src_dir = Path(<span class="hljs-string">"data/logs"</span>)
dst_dir = Path(<span class="hljs-string">"backup/logs"</span>)

<span class="hljs-comment"># 路径判断与目录创建（Path）</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> dst_dir.parent.exists():
    dst_dir.parent.mkdir(parents=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 递归复制目录（shutil）</span>
shutil.copytree(src_dir, dst_dir)

<span class="hljs-comment"># 读取复制后的文件内容（Path）</span>
copied_file = dst_dir / <span class="hljs-string">"app.log"</span>
<span class="hljs-built_in">print</span>(copied_file.read_text())
</code></pre>
<h4 data-id="heading-13">4.2 老项目维护（Python 2.x或3.x老版本）</h4>
<p>以 <code>os.path</code> 为核心，配合 <code>os</code> 模块辅助方法，必要时引入 <code>shutil</code> 处理高级操作：</p>
<ul>
<li>
<p>路径拼接、解析、判断：使用<code>os.path</code>子模块（如<code>os.path.join()</code>、<code>os.path.exists()</code>）；</p>
</li>
<li>
<p>基础目录/文件操作（创建、遍历、切换目录）：使用<code>os.mkdir()</code>、<code>os.listdir()</code>、<code>os.chdir()</code>等；</p>
</li>
<li>
<p>高级操作（复制、递归删除）：配合<code>shutil</code>模块，避免手动编写递归逻辑。</p>
</li>
</ul>
<p>示例组合用法：</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> shutil

<span class="hljs-comment"># 用os.path处理路径，os和shutil处理操作</span>
src_path = os.path.join(<span class="hljs-string">"data"</span>, <span class="hljs-string">"logs"</span>, <span class="hljs-string">"app.log"</span>)
dst_path = os.path.join(<span class="hljs-string">"backup"</span>, <span class="hljs-string">"app.log"</span>)

<span class="hljs-comment"># 路径判断与目录创建</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(os.path.dirname(dst_path)):
    os.makedirs(os.path.dirname(dst_path))

<span class="hljs-comment"># 复制文件</span>
shutil.copy(src_path, dst_path)

<span class="hljs-comment"># 遍历目录</span>
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> os.listdir(os.path.dirname(src_path)):
    <span class="hljs-built_in">print</span>(item)
</code></pre>
<h4 data-id="heading-14">4.3 特殊场景专项建议</h4>
<ul>
<li>
<p>仅需解析路径格式（不操作文件系统）：优先使用<code>PurePath</code>（跨平台自动适配）或其子类（强制系统规则），比<code>os.path</code>更专注、代码更清晰；</p>
</li>
<li>
<p>批量文件匹配（如查找所有.py文件）：Python 3.x用<code>Path.glob()</code>（简洁），Python 2.x用<code>glob</code>模块（配合<code>os.path</code>）；</p>
</li>
<li>
<p>跨平台项目开发：优先用<code>pathlib.Path</code>或<code>os.path</code>，避免手动写死路径分隔符（如“/”“\”），必要时用<code>PurePosixPath</code>/<code>PureWindowsPath</code>统一路径格式。</p>
</li>
</ul>
<h3 data-id="heading-15">五、常见问题与避坑指南</h3>
<h4 data-id="heading-16">5.1 跨平台路径分隔符问题</h4>
<p>避坑建议：无论使用哪种工具，均不要手动写死分隔符（如<code>"data/logs"</code>或<code>"data\\logs"</code>），优先用工具自带的拼接方式：</p>
<ul>
<li>
<p>pathlib：用<code>Path("data") / "logs"</code>；</p>
</li>
<li>
<p>os.path：用<code>os.path.join("data", "logs")</code>。</p>
</li>
</ul>
<h4 data-id="heading-17">5.2 路径存在性判断遗漏</h4>
<p>避坑建议：在进行文件/目录操作（创建、读取、删除、复制）前，必须先判断路径存在性及类型（是文件还是目录），避免抛出异常：</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-comment"># 错误示例：直接创建目录，若已存在会报错</span>
os.mkdir(<span class="hljs-string">"new_dir"</span>)

<span class="hljs-comment"># 正确示例（os.path）</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">"new_dir"</span>) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> os.path.isdir(<span class="hljs-string">"new_dir"</span>):
    os.mkdir(<span class="hljs-string">"new_dir"</span>)

<span class="hljs-comment"># 正确示例（Path）</span>
p = Path(<span class="hljs-string">"new_dir"</span>)
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> p.exists() <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> p.is_dir():
    p.mkdir()
</code></pre>
<h4 data-id="heading-18">5.3 递归删除目录风险</h4>
<p>避坑建议：使用<code>shutil.rmtree()</code>递归删除目录时，务必确认路径正确性，避免误删重要文件，可增加二次校验：</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

del_dir = Path(<span class="hljs-string">"temp_dir"</span>)
<span class="hljs-comment"># 二次校验：确保是临时目录且非空</span>
<span class="hljs-keyword">if</span> del_dir.exists() <span class="hljs-keyword">and</span> del_dir.is_dir() <span class="hljs-keyword">and</span> <span class="hljs-string">"temp"</span> <span class="hljs-keyword">in</span> del_dir.name:
    shutil.rmtree(del_dir)
</code></pre>
<h3 data-id="heading-19">六、总结</h3>
<p>Python路径处理工具各有侧重，无“最优方案”，只有“最适配场景的方案”：</p>
<ol>
<li>
<p><code>pathlib</code>模块（Path/PurePath等）：Python 3.x新项目的首选，面向对象、可读性强、功能完整，兼顾路径解析与文件系统交互；</p>
</li>
<li>
<p><code>os</code>模块（os.path）：老项目维护和简单场景的核心，兼容性极强，逻辑直白，适合不需要复杂功能的场景；</p>
</li>
<li>
<p><code>shutil</code>模块：所有场景的“辅助工具”，专注高级文件/目录操作，需与前两类工具配合使用。</p>
</li>
</ol>
<p>核心建议：掌握<code>pathlib.Path</code>和<code>os.path</code>的核心用法，根据项目版本（是否兼容2.x）和复杂度选择核心工具，必要时用<code>shutil</code>补充高级功能，同时规避跨平台、路径判断等常见坑点，才能高效完成路径处理相关开发工作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Glide 图片加载库源码流程浅析]]></title>    <link>https://juejin.cn/post/7600316828485976079</link>    <guid>https://juejin.cn/post/7600316828485976079</guid>    <pubDate>2026-01-29T03:05:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600316828485976079" data-draft-id="7599852579066626063" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Glide 图片加载库源码流程浅析"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-29T03:05:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yen"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426633214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Glide 图片加载库源码流程浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426633214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:05:50.000Z" title="Thu Jan 29 2026 03:05:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>注：本文基于Glide 4.16版本</strong></p>
<p>通常来说，使用Glide.with(context).load(model).into(imageView)就可以加载图片了，具体的执行流程是怎样的呢？</p>
<h2 data-id="heading-0">一、with方法基本流程</h2>
<h4 data-id="heading-1">1. with重载方法</h4>
<p>首先，让我们来看看with的重载方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Glide.java</span>

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
  <span class="hljs-keyword">return</span> getRetriever(context).get(context);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@Deprecated</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Activity activity)</span> {
  <span class="hljs-keyword">return</span> with(activity.getApplicationContext());
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> FragmentActivity activity)</span> {
  <span class="hljs-keyword">return</span> getRetriever(activity).get(activity);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Fragment fragment)</span> {
  <span class="hljs-keyword">return</span> getRetriever(fragment.getContext()).get(fragment);
}

<span class="hljs-meta">@Deprecated</span>
<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> android.app.Fragment fragment)</span> {
  <span class="hljs-type">Activity</span> <span class="hljs-variable">activity</span> <span class="hljs-operator">=</span> fragment.getActivity();
  Preconditions.checkNotNull(activity, DESTROYED_ACTIVITY_WARNING);
  <span class="hljs-keyword">return</span> with(activity.getApplicationContext());
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RequestManager <span class="hljs-title function_">with</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View view)</span> {
  <span class="hljs-keyword">return</span> getRetriever(view.getContext()).get(view);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RequestManagerRetriever <span class="hljs-title function_">getRetriever</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Context context)</span> {
  <span class="hljs-comment">// Context could be null for other reasons (ie the user passes in null), but in practice it will</span>
  <span class="hljs-comment">// only occur due to errors with the Fragment lifecycle.</span>
  Preconditions.checkNotNull(context, DESTROYED_ACTIVITY_WARNING);
  <span class="hljs-keyword">return</span> Glide.get(context).getRequestManagerRetriever();
}
</code></pre>
<p>可以看到，with方法内部会通过getRetriever方法拿到RequestManagerRetriever对象，然后再调用RequestManagerRetriever的get方法得到RequestManager</p>
<h4 data-id="heading-2">2. Glide.get(context)方法</h4>
<p>我们接着来看看Glide.get(context)方法里面都做了些什么</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NonNull</span>
<span class="hljs-comment">// Double checked locking is safe here.</span>
<span class="hljs-meta">@SuppressWarnings("GuardedBy")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Glide <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
  <span class="hljs-keyword">if</span> (glide == <span class="hljs-literal">null</span>) {
    <span class="hljs-type">GeneratedAppGlideModule</span> <span class="hljs-variable">annotationGeneratedModule</span> <span class="hljs-operator">=</span>
        getAnnotationGeneratedGlideModules(context.getApplicationContext());
    <span class="hljs-keyword">synchronized</span> (Glide.class) {
      <span class="hljs-keyword">if</span> (glide == <span class="hljs-literal">null</span>) {
        checkAndInitializeGlide(context, annotationGeneratedModule);
      }
    }
  }

  <span class="hljs-keyword">return</span> glide;
}
</code></pre>
<p>可以看到，使用了双重校验单例来获取Glide对象，继续查看checkAndInitializeGlide方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GuardedBy("Glide.class")</span>
<span class="hljs-meta">@VisibleForTesting</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAndInitializeGlide</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> GeneratedAppGlideModule generatedAppGlideModule)</span> {
  <span class="hljs-comment">// In the thread running initGlide(), one or more classes may call Glide.get(context).</span>
  <span class="hljs-comment">// Without this check, those calls could trigger infinite recursion.</span>
  <span class="hljs-keyword">if</span> (isInitializing) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(
        <span class="hljs-string">"Glide has been called recursively, this is probably an internal library error!"</span>);
  }
  isInitializing = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 重点</span>
    initializeGlide(context, generatedAppGlideModule);
  } <span class="hljs-keyword">finally</span> {
    isInitializing = <span class="hljs-literal">false</span>;
  }
}
</code></pre>
<p>checkAndInitializeGlide 里面会调用 initializeGlide 方法进行初始化</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GuardedBy("Glide.class")</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeGlide</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> GeneratedAppGlideModule generatedAppGlideModule)</span> {
  initializeGlide(context, <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlideBuilder</span>(), generatedAppGlideModule);
}

<span class="hljs-meta">@GuardedBy("Glide.class")</span>
<span class="hljs-meta">@SuppressWarnings("deprecation")</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeGlide</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Context context,
    <span class="hljs-meta">@NonNull</span> GlideBuilder builder,
    <span class="hljs-meta">@Nullable</span> GeneratedAppGlideModule annotationGeneratedModule)</span> {
  ...
  <span class="hljs-type">Glide</span> <span class="hljs-variable">glide</span> <span class="hljs-operator">=</span> builder.build(applicationContext, manifestModules, annotationGeneratedModule);
  applicationContext.registerComponentCallbacks(glide);
  Glide.glide = glide;
}
</code></pre>
<p>可以看到，通过建造者模式去构建glide对象</p>
<h4 data-id="heading-3">3. GlideBuilder.build方法</h4>
<p>里面会创建sourceExecutor、diskCacheExecutor、animationExecutor、memorySizeCalculator、bitmapPool、engine等对象</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GlideBuilder.java</span>

<span class="hljs-meta">@NonNull</span>
Glide <span class="hljs-title function_">build</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Context context,
    List&lt;GlideModule&gt; manifestModules,
    AppGlideModule annotationGeneratedGlideModule)</span> {
  <span class="hljs-keyword">if</span> (sourceExecutor == <span class="hljs-literal">null</span>) {
    sourceExecutor = GlideExecutor.newSourceExecutor();
  }

  <span class="hljs-keyword">if</span> (diskCacheExecutor == <span class="hljs-literal">null</span>) {
    diskCacheExecutor = GlideExecutor.newDiskCacheExecutor();
  }

  <span class="hljs-keyword">if</span> (animationExecutor == <span class="hljs-literal">null</span>) {
    animationExecutor = GlideExecutor.newAnimationExecutor();
  }

  <span class="hljs-keyword">if</span> (memorySizeCalculator == <span class="hljs-literal">null</span>) {
    memorySizeCalculator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemorySizeCalculator</span>.Builder(context).build();
  }

  <span class="hljs-keyword">if</span> (connectivityMonitorFactory == <span class="hljs-literal">null</span>) {
    connectivityMonitorFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConnectivityMonitorFactory</span>();
  }

  <span class="hljs-keyword">if</span> (bitmapPool == <span class="hljs-literal">null</span>) {
    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> memorySizeCalculator.getBitmapPoolSize();
    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) {
      bitmapPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LruBitmapPool</span>(size);
    } <span class="hljs-keyword">else</span> {
      bitmapPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BitmapPoolAdapter</span>();
    }
  }

  <span class="hljs-keyword">if</span> (arrayPool == <span class="hljs-literal">null</span>) {
    arrayPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LruArrayPool</span>(memorySizeCalculator.getArrayPoolSizeInBytes());
  }

  <span class="hljs-keyword">if</span> (memoryCache == <span class="hljs-literal">null</span>) {
    memoryCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LruResourceCache</span>(memorySizeCalculator.getMemoryCacheSize());
  }

  <span class="hljs-keyword">if</span> (diskCacheFactory == <span class="hljs-literal">null</span>) {
    diskCacheFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalCacheDiskCacheFactory</span>(context);
  }

  <span class="hljs-keyword">if</span> (engine == <span class="hljs-literal">null</span>) {
    engine =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Engine</span>(
            memoryCache,
            diskCacheFactory,
            diskCacheExecutor,
            sourceExecutor,
            GlideExecutor.newUnlimitedSourceExecutor(),
            animationExecutor,
            isActiveResourceRetentionAllowed);
  }

  <span class="hljs-keyword">if</span> (defaultRequestListeners == <span class="hljs-literal">null</span>) {
    defaultRequestListeners = Collections.emptyList();
  } <span class="hljs-keyword">else</span> {
    defaultRequestListeners = Collections.unmodifiableList(defaultRequestListeners);
  }

  <span class="hljs-type">GlideExperiments</span> <span class="hljs-variable">experiments</span> <span class="hljs-operator">=</span> glideExperimentsBuilder.build();
  <span class="hljs-comment">// 这里拿到RequestManagerRetriever对象</span>
  <span class="hljs-type">RequestManagerRetriever</span> <span class="hljs-variable">requestManagerRetriever</span> <span class="hljs-operator">=</span>
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestManagerRetriever</span>(requestManagerFactory);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Glide</span>(
      context,
      engine,
      memoryCache,
      bitmapPool,
      arrayPool,
      requestManagerRetriever,
      connectivityMonitorFactory,
      logLevel,
      defaultRequestOptionsFactory,
      defaultTransitionOptions,
      defaultRequestListeners,
      manifestModules,
      annotationGeneratedGlideModule,
      experiments);
}
</code></pre>
<h4 data-id="heading-4">4. RequestManagerRetriever.get方法</h4>
<p>RequestManagerRetriever.get有多个重载方法，会根据参数类型和调用线程做出不同决策</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RequestManagerRetriever.java</span>
<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
  <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"You cannot start a load on a null Context"</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Util.isOnMainThread() &amp;&amp; !(context <span class="hljs-keyword">instanceof</span> Application)) {
    <span class="hljs-keyword">if</span> (context <span class="hljs-keyword">instanceof</span> FragmentActivity) {
      <span class="hljs-keyword">return</span> get((FragmentActivity) context);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (context <span class="hljs-keyword">instanceof</span> ContextWrapper
        &amp;&amp; ((ContextWrapper) context).getBaseContext().getApplicationContext() != <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> get(((ContextWrapper) context).getBaseContext());
    }
  }
  <span class="hljs-keyword">return</span> getApplicationManager(context);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> FragmentActivity activity)</span> {
  <span class="hljs-keyword">if</span> (Util.isOnBackgroundThread()) {
    <span class="hljs-keyword">return</span> get(activity.getApplicationContext());
  }
  assertNotDestroyed(activity);
  frameWaiter.registerSelf(activity);
  <span class="hljs-type">boolean</span> <span class="hljs-variable">isActivityVisible</span> <span class="hljs-operator">=</span> isActivityVisible(activity);
  <span class="hljs-type">Glide</span> <span class="hljs-variable">glide</span> <span class="hljs-operator">=</span> Glide.get(activity.getApplicationContext());
  <span class="hljs-keyword">return</span> lifecycleRequestManagerRetriever.getOrCreate(
      activity,
      glide,
      activity.getLifecycle(),
      activity.getSupportFragmentManager(),
      isActivityVisible);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Fragment fragment)</span> {
  Preconditions.checkNotNull(
      fragment.getContext(),
      <span class="hljs-string">"You cannot start a load on a fragment before it is attached or after it is destroyed"</span>);
  <span class="hljs-keyword">if</span> (Util.isOnBackgroundThread()) {
    <span class="hljs-keyword">return</span> get(fragment.getContext().getApplicationContext());
  }
  <span class="hljs-keyword">if</span> (fragment.getActivity() != <span class="hljs-literal">null</span>) {
    frameWaiter.registerSelf(fragment.getActivity());
  }
  <span class="hljs-type">FragmentManager</span> <span class="hljs-variable">fm</span> <span class="hljs-operator">=</span> fragment.getChildFragmentManager();
  <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> fragment.getContext();
  <span class="hljs-type">Glide</span> <span class="hljs-variable">glide</span> <span class="hljs-operator">=</span> Glide.get(context.getApplicationContext());
  <span class="hljs-keyword">return</span> lifecycleRequestManagerRetriever.getOrCreate(
      context, glide, fragment.getLifecycle(), fm, fragment.isVisible());
}

<span class="hljs-meta">@Deprecated</span>
<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Activity activity)</span> {
  <span class="hljs-keyword">return</span> get(activity.getApplicationContext());
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View view)</span> {
  <span class="hljs-keyword">if</span> (Util.isOnBackgroundThread()) {
    <span class="hljs-keyword">return</span> get(view.getContext().getApplicationContext());
  }

  Preconditions.checkNotNull(view);
  Preconditions.checkNotNull(
      view.getContext(), <span class="hljs-string">"Unable to obtain a request manager for a view without a Context"</span>);
  <span class="hljs-type">Activity</span> <span class="hljs-variable">activity</span> <span class="hljs-operator">=</span> findActivity(view.getContext());
  <span class="hljs-comment">// The view might be somewhere else, like a service.</span>
  <span class="hljs-keyword">if</span> (activity == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> get(view.getContext().getApplicationContext());
  }

  <span class="hljs-keyword">if</span> (activity <span class="hljs-keyword">instanceof</span> FragmentActivity) {
    <span class="hljs-type">Fragment</span> <span class="hljs-variable">fragment</span> <span class="hljs-operator">=</span> findSupportFragment(view, (FragmentActivity) activity);
    <span class="hljs-keyword">return</span> fragment != <span class="hljs-literal">null</span> ? get(fragment) : get((FragmentActivity) activity);
  }

  <span class="hljs-comment">// Standard Fragments.</span>
  <span class="hljs-keyword">return</span> get(view.getContext().getApplicationContext());
}
</code></pre>
<h4 data-id="heading-5">5. LifecycleRequestManagerRetriever.getOrCreate方法</h4>
<p>RequestManager对象是通过lifecycleRequestManagerRetriever.getOrCreate获取的</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// LifecycleRequestManagerRetriever.java</span>

RequestManager <span class="hljs-title function_">getOrCreate</span><span class="hljs-params">(
    Context context,
    Glide glide,
    <span class="hljs-keyword">final</span> Lifecycle lifecycle,
    FragmentManager childFragmentManager,
    <span class="hljs-type">boolean</span> isParentVisible)</span> {
  Util.assertMainThread();
  <span class="hljs-type">RequestManager</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getOnly(lifecycle);
  <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 传入lifecycle</span>
    <span class="hljs-type">LifecycleLifecycle</span> <span class="hljs-variable">glideLifecycle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleLifecycle</span>(lifecycle);
    result =
        factory.build(
            glide,
            glideLifecycle,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SupportRequestManagerTreeNode</span>(childFragmentManager),
            context);
    lifecycleToRequestManager.put(lifecycle, result);
    glideLifecycle.addListener(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleListener</span>() {
          <span class="hljs-meta">@Override</span>
          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> {}

          <span class="hljs-meta">@Override</span>
          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStop</span><span class="hljs-params">()</span> {}

          <span class="hljs-meta">@Override</span>
          <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> {
            lifecycleToRequestManager.remove(lifecycle);
          }
        });
        
    <span class="hljs-keyword">if</span> (isParentVisible) {
      result.onStart();
    }
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-6">6. RequestManagerFactory工厂方法</h4>
<p>通过RequestManagerFactory 创建了一个RequestManager对象</p>
<pre><code class="hljs language-java" lang="java">RequestManagerRetriever.java

<span class="hljs-comment">/** Used internally to create {<span class="hljs-doctag">@link</span> RequestManager}s. */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RequestManagerFactory</span> {
  <span class="hljs-meta">@NonNull</span>
  RequestManager <span class="hljs-title function_">build</span><span class="hljs-params">(
      <span class="hljs-meta">@NonNull</span> Glide glide,
      <span class="hljs-meta">@NonNull</span> Lifecycle lifecycle,
      <span class="hljs-meta">@NonNull</span> RequestManagerTreeNode requestManagerTreeNode,
      <span class="hljs-meta">@NonNull</span> Context context)</span>;
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">RequestManagerFactory</span> <span class="hljs-variable">DEFAULT_FACTORY</span> <span class="hljs-operator">=</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestManagerFactory</span>() {
      <span class="hljs-meta">@NonNull</span>
      <span class="hljs-meta">@Override</span>
      <span class="hljs-keyword">public</span> RequestManager <span class="hljs-title function_">build</span><span class="hljs-params">(
          <span class="hljs-meta">@NonNull</span> Glide glide,
          <span class="hljs-meta">@NonNull</span> Lifecycle lifecycle,
          <span class="hljs-meta">@NonNull</span> RequestManagerTreeNode requestManagerTreeNode,
          <span class="hljs-meta">@NonNull</span> Context context)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestManager</span>(glide, lifecycle, requestManagerTreeNode, context);
      }
    };
</code></pre>
<h4 data-id="heading-7">7.RequestManager构造方法</h4>
<p>RequestManager本身实现LifecycleListener接口，并执行lifecycle.addListener(this)，完成生命周期绑定</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestManager</span>
    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ComponentCallbacks2</span>, LifecycleListener, ModelTypes&lt;RequestBuilder&lt;Drawable&gt;&gt;

<span class="hljs-keyword">public</span> <span class="hljs-title function_">RequestManager</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Glide glide,
    <span class="hljs-meta">@NonNull</span> Lifecycle lifecycle,
    <span class="hljs-meta">@NonNull</span> RequestManagerTreeNode treeNode,
    <span class="hljs-meta">@NonNull</span> Context context)</span> {
  <span class="hljs-built_in">this</span>(
      glide,
      lifecycle,
      treeNode,
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestTracker</span>(),
      glide.getConnectivityMonitorFactory(),
      context);
}

<span class="hljs-comment">// Our usage is safe here.</span>
<span class="hljs-meta">@SuppressWarnings("PMD.ConstructorCallsOverridableMethod")</span>
RequestManager(
    Glide glide,
    Lifecycle lifecycle,
    RequestManagerTreeNode treeNode,
    RequestTracker requestTracker,
    ConnectivityMonitorFactory factory,
    Context context) {
  <span class="hljs-built_in">this</span>.glide = glide;
  <span class="hljs-built_in">this</span>.lifecycle = lifecycle;
  <span class="hljs-built_in">this</span>.treeNode = treeNode;
  <span class="hljs-built_in">this</span>.requestTracker = requestTracker;
  <span class="hljs-built_in">this</span>.context = context;

  connectivityMonitor =
      factory.build(
          context.getApplicationContext(),
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestManagerConnectivityListener</span>(requestTracker));

  glide.registerRequestManager(<span class="hljs-built_in">this</span>);

  <span class="hljs-keyword">if</span> (Util.isOnBackgroundThread()) {
    Util.postOnUiThread(addSelfToLifecycle);
  } <span class="hljs-keyword">else</span> {
    lifecycle.addListener(<span class="hljs-built_in">this</span>);
  }
  lifecycle.addListener(connectivityMonitor);

  defaultRequestListeners =
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;(glide.getGlideContext().getDefaultRequestListeners());
  setRequestOptions(glide.getGlideContext().getDefaultRequestOptions());
}
</code></pre>
<h4 data-id="heading-8">8. RequestManager生命周期回调方法</h4>
<p>RequestManager相关生命周期回调方法具体如下</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> {
  resumeRequests();
  targetTracker.onStart();
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStop</span><span class="hljs-params">()</span> {
  targetTracker.onStop();
  <span class="hljs-keyword">if</span> (clearOnStop) {
    clearRequests();
  } <span class="hljs-keyword">else</span> {
    pauseRequests();
  }
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> {
  targetTracker.onDestroy();
  clearRequests();
  requestTracker.clearRequests();
  lifecycle.removeListener(<span class="hljs-built_in">this</span>);
  lifecycle.removeListener(connectivityMonitor);
  Util.removeCallbacksOnUiThread(addSelfToLifecycle);
  glide.unregisterRequestManager(<span class="hljs-built_in">this</span>);
}
</code></pre>
<h2 data-id="heading-9">二、load()方法基本流程</h2>
<p><code>RequestManager.load()</code> 是 Glide API 的<strong>核心入口</strong>，它负责将各种数据模型统一转换为可管理的加载请求。这个方法的设计体现了 Glide <strong>灵活的数据源支持</strong>和<strong>类型安全的构建器模式</strong>。</p>
<h4 data-id="heading-10">1. RequestManager.load()重载方法</h4>
<p>load方法实际上是一系列<strong>重载方法</strong>，支持不同类型的数据源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LifecycleListener</span> {
    
    <span class="hljs-comment">// 1. 加载网络/本地图片路径</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String string)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(string);
    }
    
    <span class="hljs-comment">// 2. 加载Uri</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Uri uri)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(uri);
    }
    
    <span class="hljs-comment">// 3. 加载File</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> File file)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(file);
    }
    
    <span class="hljs-comment">// 4. 加载资源ID</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@RawRes</span> <span class="hljs-meta">@DrawableRes</span> <span class="hljs-meta">@Nullable</span> Integer resourceId)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(resourceId);
    }
    
    <span class="hljs-comment">// 5. 加载URL对象</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> URL url)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(url);
    }
    
    <span class="hljs-comment">// 6. 加载字节数组</span>
    <span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] model)</span> {
        <span class="hljs-keyword">return</span> asDrawable().load(model);
    }
    
    <span class="hljs-comment">// 7. 加载任意对象（泛型方法）</span>
    <span class="hljs-keyword">public</span> &lt;ResourceType&gt; RequestBuilder&lt;ResourceType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object model)</span> {
        <span class="hljs-keyword">return</span> as(ResourceType.class).load(model);
    }
}
</code></pre>
<h4 data-id="heading-11">2. load方法内部类型推断与转换</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 当你调用：Glide.with(context).load("https://example.com/image.jpg")</span>
<span class="hljs-comment">// 实际执行流程：</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String string)</span> {
    <span class="hljs-comment">// 步骤1: 确定资源类型为Drawable</span>
    <span class="hljs-keyword">return</span> asDrawable()  <span class="hljs-comment">//  创建指定类型的RequestBuilder</span>
             .load(string); <span class="hljs-comment">//  设置数据模型</span>
}

<span class="hljs-comment">// asDrawable()的实现</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;Drawable&gt; <span class="hljs-title function_">asDrawable</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> as(Drawable.class);
}

<span class="hljs-comment">// 通用的as()方法</span>
<span class="hljs-keyword">public</span> &lt;ResourceType&gt; RequestBuilder&lt;ResourceType&gt; <span class="hljs-title function_">as</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Class&lt;ResourceType&gt; resourceClass)</span> {
    
    <span class="hljs-comment">// 创建对应资源类型的RequestBuilder</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestBuilder</span>&lt;&gt;(
        glide,                     <span class="hljs-comment">// Glide单例</span>
        <span class="hljs-built_in">this</span>,                      <span class="hljs-comment">// RequestManager自身</span>
        resourceClass,             <span class="hljs-comment">// 目标资源类型（Drawable.class）</span>
        context                    <span class="hljs-comment">// 上下文</span>
    );
}
</code></pre>
<h4 data-id="heading-12">3. RequestBuilder的初始化</h4>
<p><code>RequestBuilder</code> 是真正的<strong>请求建造者</strong>，它存储了请求的所有配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// We only override the method to change the return type, not the functionality.</span>
<span class="hljs-meta">@SuppressLint("CheckResult")</span>
<span class="hljs-meta">@SuppressWarnings("PMD.ConstructorCallsOverridableMethod")</span>
<span class="hljs-keyword">protected</span> <span class="hljs-title function_">RequestBuilder</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Glide glide,
    RequestManager requestManager,
    Class&lt;TranscodeType&gt; transcodeClass,
    Context context)</span> {
  <span class="hljs-built_in">this</span>.glide = glide;
  <span class="hljs-built_in">this</span>.requestManager = requestManager;
  <span class="hljs-built_in">this</span>.transcodeClass = transcodeClass;
  <span class="hljs-built_in">this</span>.context = context;
  <span class="hljs-built_in">this</span>.transitionOptions = requestManager.getDefaultTransitionOptions(transcodeClass);
  <span class="hljs-built_in">this</span>.glideContext = glide.getGlideContext();

  initRequestListeners(requestManager.getDefaultRequestListeners());
  apply(requestManager.getDefaultRequestOptions());
}
</code></pre>
<h4 data-id="heading-13">4. RequestBuilder.load重载方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@SuppressWarnings("unchecked")</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object model)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(model);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">loadGeneric</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object model)</span> {
  <span class="hljs-keyword">if</span> (isAutoCloneEnabled()) {
    <span class="hljs-keyword">return</span> clone().loadGeneric(model);
  }
  <span class="hljs-built_in">this</span>.model = model;
  isModelSet = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> selfOrThrowIfLocked();
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bitmap bitmap)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(bitmap).apply(diskCacheStrategyOf(DiskCacheStrategy.NONE));
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Drawable drawable)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(drawable).apply(diskCacheStrategyOf(DiskCacheStrategy.NONE));
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String string)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(string);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Uri uri)</span> {
  <span class="hljs-keyword">return</span> maybeApplyOptionsResourceUri(uri, loadGeneric(uri));
}

<span class="hljs-keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">maybeApplyOptionsResourceUri</span><span class="hljs-params">(
    <span class="hljs-meta">@Nullable</span> Uri uri, RequestBuilder&lt;TranscodeType&gt; requestBuilder)</span> {
  <span class="hljs-keyword">if</span> (uri == <span class="hljs-literal">null</span> || !ContentResolver.SCHEME_ANDROID_RESOURCE.equals(uri.getScheme())) {
    <span class="hljs-keyword">return</span> requestBuilder;
  }
  <span class="hljs-keyword">return</span> applyResourceThemeAndSignature(requestBuilder);
}

<span class="hljs-keyword">private</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">applyResourceThemeAndSignature</span><span class="hljs-params">(
    RequestBuilder&lt;TranscodeType&gt; requestBuilder)</span> {
  <span class="hljs-keyword">return</span> requestBuilder
      .theme(context.getTheme())
      .signature(AndroidResourceSignature.obtain(context));
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> File file)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(file);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@RawRes</span> <span class="hljs-meta">@DrawableRes</span> <span class="hljs-meta">@Nullable</span> Integer resourceId)</span> {
  <span class="hljs-keyword">return</span> applyResourceThemeAndSignature(loadGeneric(resourceId));
}

<span class="hljs-meta">@Deprecated</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> URL url)</span> {
  <span class="hljs-keyword">return</span> loadGeneric(url);
}

<span class="hljs-meta">@NonNull</span>
<span class="hljs-meta">@CheckResult</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> RequestBuilder&lt;TranscodeType&gt; <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> <span class="hljs-type">byte</span>[] model)</span> {
  RequestBuilder&lt;TranscodeType&gt; result = loadGeneric(model);
  <span class="hljs-keyword">if</span> (!result.isDiskCacheStrategySet()) {
    result = result.apply(diskCacheStrategyOf(DiskCacheStrategy.NONE));
  }
  <span class="hljs-keyword">if</span> (!result.isSkipMemoryCacheSet()) {
    result = result.apply(skipMemoryCacheOf(<span class="hljs-literal">true</span> <span class="hljs-comment">/*skipMemoryCache*/</span>));
  }
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-14">5.设计思想总结</h4>
<p><code>RequestManager.load()</code> 的设计体现了几个重要原则：</p>
<ul>
<li><strong>单一职责</strong>：<code>load()</code> 只负责接收和存储数据模型，不处理具体加载逻辑。</li>
<li><strong>延迟执行</strong>：配置在 <code>into()</code> 调用时才真正生效，支持完整的链式配置。</li>
<li><strong>类型安全</strong>：通过泛型确保资源类型的正确性。</li>
<li><strong>灵活扩展</strong>：支持任意数据模型类型（通过 <code>ModelLoader</code> 机制）。</li>
</ul>
<p>理解 <code>RequestManager.load()</code> 的机制，就掌握了 Glide API 设计的精髓：<strong>通过流畅的构建器模式，将复杂的图片加载过程封装成简单、直观的链式调用，同时保持高度的可配置性和扩展性</strong>。</p>
<h2 data-id="heading-15">三、into()方法基本流程</h2>
<p>into()方法（在RequestBuilder类中）会做几件关键的事：</p>
<ul>
<li>构建Target：将ImageView包装成一个ImageViewTarget</li>
<li>创建并启动请求：调用RequestManager.track()，最终会创建一个SingleRequest对象，并调用它的bedin()方法</li>
</ul>
<h4 data-id="heading-16">1. into重载方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NonNull</span>
<span class="hljs-keyword">public</span> &lt;Y <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Target</span>&lt;TranscodeType&gt;&gt; Y <span class="hljs-title function_">into</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Y target)</span> {
  <span class="hljs-keyword">return</span> into(target, <span class="hljs-comment">/* targetListener= */</span> <span class="hljs-literal">null</span>, Executors.mainThreadExecutor());
}

<span class="hljs-meta">@NonNull</span>
&lt;Y <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Target</span>&lt;TranscodeType&gt;&gt; Y <span class="hljs-title function_">into</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Y target,
    <span class="hljs-meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,
    Executor callbackExecutor)</span> {
  <span class="hljs-keyword">return</span> into(target, targetListener, <span class="hljs-comment">/* options= */</span> <span class="hljs-built_in">this</span>, callbackExecutor);
}

<span class="hljs-keyword">private</span> &lt;Y <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Target</span>&lt;TranscodeType&gt;&gt; Y <span class="hljs-title function_">into</span><span class="hljs-params">(
    <span class="hljs-meta">@NonNull</span> Y target,
    <span class="hljs-meta">@Nullable</span> RequestListener&lt;TranscodeType&gt; targetListener,
    BaseRequestOptions&lt;?&gt; options,
    Executor callbackExecutor)</span> {
  Preconditions.checkNotNull(target);
  <span class="hljs-keyword">if</span> (!isModelSet) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"You must call #load() before calling #into()"</span>);
  }

  <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> buildRequest(target, targetListener, options, callbackExecutor);

  <span class="hljs-type">Request</span> <span class="hljs-variable">previous</span> <span class="hljs-operator">=</span> target.getRequest();
  <span class="hljs-keyword">if</span> (request.isEquivalentTo(previous)
      &amp;&amp; !isSkipMemoryCacheWithCompletePreviousRequest(options, previous)) {
    <span class="hljs-keyword">if</span> (!Preconditions.checkNotNull(previous).isRunning()) {
      previous.begin();
    }
    <span class="hljs-keyword">return</span> target;
  }

  requestManager.clear(target);
  target.setRequest(request);
  requestManager.track(target, request);

  <span class="hljs-keyword">return</span> target;
}
</code></pre>
<h4 data-id="heading-17">2. requestManager.track方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">track</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Target&lt;?&gt; target, <span class="hljs-meta">@NonNull</span> Request request)</span> {
  targetTracker.track(target);
  requestTracker.runRequest(request);
}

<span class="hljs-comment">/** Starts tracking the given request. */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runRequest</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Request request)</span> {
  requests.add(request);
  <span class="hljs-keyword">if</span> (!isPaused) {
    request.begin();
  } <span class="hljs-keyword">else</span> {
    request.clear();
    <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) {
      Log.v(TAG, <span class="hljs-string">"Paused, delaying request"</span>);
    }
    pendingRequests.add(request);
  }
}
</code></pre>
<h4 data-id="heading-18">3.SingleRequest.begin方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">begin</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">synchronized</span> (requestLock) {
    assertNotCallingCallbacks();
    stateVerifier.throwIfRecycled();
    startTime = LogTime.getLogTime();
    <span class="hljs-keyword">if</span> (model == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) {
        width = overrideWidth;
        height = overrideHeight;
      }
      onLoadFailed(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GlideException</span>(<span class="hljs-string">"Received null model"</span>), logLevel);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (status == Status.RUNNING) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Cannot restart a running request"</span>);
    }

    <span class="hljs-keyword">if</span> (status == Status.COMPLETE) {
      onResourceReady(
          resource, DataSource.MEMORY_CACHE, <span class="hljs-comment">/* isLoadedFromAlternateCacheKey= */</span> <span class="hljs-literal">false</span>);
      <span class="hljs-keyword">return</span>;
    }

    experimentalNotifyRequestStarted(model);

    cookie = GlideTrace.beginSectionAsync(TAG);
    status = Status.WAITING_FOR_SIZE;
    <span class="hljs-keyword">if</span> (Util.isValidDimensions(overrideWidth, overrideHeight)) {
      onSizeReady(overrideWidth, overrideHeight);
    } <span class="hljs-keyword">else</span> {
      target.getSize(<span class="hljs-built_in">this</span>);
    }

    <span class="hljs-keyword">if</span> ((status == Status.RUNNING || status == Status.WAITING_FOR_SIZE)
        &amp;&amp; canNotifyStatusChanged()) {
      target.onLoadStarted(getPlaceholderDrawable());
    }
    <span class="hljs-keyword">if</span> (IS_VERBOSE_LOGGABLE) {
      logV(<span class="hljs-string">"finished run method in "</span> + LogTime.getElapsedMillis(startTime));
    }
  }
}
</code></pre>
<h4 data-id="heading-19">4. onSizeReady方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSizeReady</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> {
  stateVerifier.throwIfRecycled();
  <span class="hljs-keyword">synchronized</span> (requestLock) {
    <span class="hljs-keyword">if</span> (IS_VERBOSE_LOGGABLE) {
      logV(<span class="hljs-string">"Got onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));
    }
    <span class="hljs-keyword">if</span> (status != Status.WAITING_FOR_SIZE) {
      <span class="hljs-keyword">return</span>;
    }
    status = Status.RUNNING;

    <span class="hljs-type">float</span> <span class="hljs-variable">sizeMultiplier</span> <span class="hljs-operator">=</span> requestOptions.getSizeMultiplier();
    <span class="hljs-built_in">this</span>.width = maybeApplySizeMultiplier(width, sizeMultiplier);
    <span class="hljs-built_in">this</span>.height = maybeApplySizeMultiplier(height, sizeMultiplier);

    <span class="hljs-keyword">if</span> (IS_VERBOSE_LOGGABLE) {
      logV(<span class="hljs-string">"finished setup for calling load in "</span> + LogTime.getElapsedMillis(startTime));
    }
    loadStatus =
        <span class="hljs-comment">// 重点</span>
        engine.load(
            glideContext,
            model,
            requestOptions.getSignature(),
            <span class="hljs-built_in">this</span>.width,
            <span class="hljs-built_in">this</span>.height,
            requestOptions.getResourceClass(),
            transcodeClass,
            priority,
            requestOptions.getDiskCacheStrategy(),
            requestOptions.getTransformations(),
            requestOptions.isTransformationRequired(),
            requestOptions.isScaleOnlyOrNoTransform(),
            requestOptions.getOptions(),
            requestOptions.isMemoryCacheable(),
            requestOptions.getUseUnlimitedSourceGeneratorsPool(),
            requestOptions.getUseAnimationPool(),
            requestOptions.getOnlyRetrieveFromCache(),
            <span class="hljs-built_in">this</span>,
            callbackExecutor);

    <span class="hljs-keyword">if</span> (status != Status.RUNNING) {
      loadStatus = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">if</span> (IS_VERBOSE_LOGGABLE) {
      logV(<span class="hljs-string">"finished onSizeReady in "</span> + LogTime.getElapsedMillis(startTime));
    }
  }
}
</code></pre>
<h4 data-id="heading-20">5.Engine.load()方法</h4>
<p>这里是整个加载流程的总调度中心，也是缓存检查的第一关</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> &lt;R&gt; LoadStatus <span class="hljs-title function_">load</span><span class="hljs-params">(
    GlideContext glideContext,
    Object model,
    Key signature,
    <span class="hljs-type">int</span> width,
    <span class="hljs-type">int</span> height,
    Class&lt;?&gt; resourceClass,
    Class&lt;R&gt; transcodeClass,
    Priority priority,
    DiskCacheStrategy diskCacheStrategy,
    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,
    <span class="hljs-type">boolean</span> isTransformationRequired,
    <span class="hljs-type">boolean</span> isScaleOnlyOrNoTransform,
    Options options,
    <span class="hljs-type">boolean</span> isMemoryCacheable,
    <span class="hljs-type">boolean</span> useUnlimitedSourceExecutorPool,
    <span class="hljs-type">boolean</span> useAnimationPool,
    <span class="hljs-type">boolean</span> onlyRetrieveFromCache,
    ResourceCallback cb,
    Executor callbackExecutor)</span> {
  <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> VERBOSE_IS_LOGGABLE ? LogTime.getLogTime() : <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 1. 创建唯一缓存Key：根据model、签名、ImageView宽高等参数生成EngineKey</span>
  <span class="hljs-type">EngineKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span>
      keyFactory.buildKey(
          model,
          signature,
          width,
          height,
          transformations,
          resourceClass,
          transcodeClass,
          options);

  EngineResource&lt;?&gt; memoryResource;
  <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
    <span class="hljs-comment">// 加载内存缓存</span>
    memoryResource = loadFromMemory(key, isMemoryCacheable, startTime);

    <span class="hljs-keyword">if</span> (memoryResource == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> waitForExistingOrStartNewJob(
          glideContext,
          model,
          signature,
          width,
          height,
          resourceClass,
          transcodeClass,
          priority,
          diskCacheStrategy,
          transformations,
          isTransformationRequired,
          isScaleOnlyOrNoTransform,
          options,
          isMemoryCacheable,
          useUnlimitedSourceExecutorPool,
          useAnimationPool,
          onlyRetrieveFromCache,
          cb,
          callbackExecutor,
          key,
          startTime);
    }
  }

  cb.onResourceReady(
      memoryResource, DataSource.MEMORY_CACHE, <span class="hljs-comment">/* isLoadedFromAlternateCacheKey= */</span> <span class="hljs-literal">false</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h4 data-id="heading-21">6. loadFromMemory方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Nullable</span>
<span class="hljs-keyword">private</span> EngineResource&lt;?&gt; loadFromMemory(
    EngineKey key, <span class="hljs-type">boolean</span> isMemoryCacheable, <span class="hljs-type">long</span> startTime) {
  <span class="hljs-keyword">if</span> (!isMemoryCacheable) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  <span class="hljs-comment">// 检查【活动资源缓存】（ActiveResources，弱引用）</span>
  EngineResource&lt;?&gt; active = loadFromActiveResources(key);
  <span class="hljs-keyword">if</span> (active != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {
      logWithTimeAndKey(<span class="hljs-string">"Loaded resource from active resources"</span>, startTime, key);
    }
    <span class="hljs-keyword">return</span> active;
  }
  检查【LRU内存缓存】（LruResourceCache）
  EngineResource&lt;?&gt; cached = loadFromCache(key);
  <span class="hljs-keyword">if</span> (cached != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {
      logWithTimeAndKey(<span class="hljs-string">"Loaded resource from cache"</span>, startTime, key);
    }
    <span class="hljs-keyword">return</span> cached;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h4 data-id="heading-22">7. waitForExistingOrStartNewJob方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> &lt;R&gt; LoadStatus <span class="hljs-title function_">waitForExistingOrStartNewJob</span><span class="hljs-params">(
    GlideContext glideContext,
    Object model,
    Key signature,
    <span class="hljs-type">int</span> width,
    <span class="hljs-type">int</span> height,
    Class&lt;?&gt; resourceClass,
    Class&lt;R&gt; transcodeClass,
    Priority priority,
    DiskCacheStrategy diskCacheStrategy,
    Map&lt;Class&lt;?&gt;, Transformation&lt;?&gt;&gt; transformations,
    <span class="hljs-type">boolean</span> isTransformationRequired,
    <span class="hljs-type">boolean</span> isScaleOnlyOrNoTransform,
    Options options,
    <span class="hljs-type">boolean</span> isMemoryCacheable,
    <span class="hljs-type">boolean</span> useUnlimitedSourceExecutorPool,
    <span class="hljs-type">boolean</span> useAnimationPool,
    <span class="hljs-type">boolean</span> onlyRetrieveFromCache,
    ResourceCallback cb,
    Executor callbackExecutor,
    EngineKey key,
    <span class="hljs-type">long</span> startTime)</span> {

  <span class="hljs-comment">// 检查是否有相同Key的【正在执行的请求】</span>
  EngineJob&lt;?&gt; current = jobs.get(key, onlyRetrieveFromCache);
  <span class="hljs-keyword">if</span> (current != <span class="hljs-literal">null</span>) {
    current.addCallback(cb, callbackExecutor);
    <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {
      logWithTimeAndKey(<span class="hljs-string">"Added to existing load"</span>, startTime, key);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadStatus</span>(cb, current);
  }
  <span class="hljs-comment">//【缓存未命中】需要创建新任务</span>
  EngineJob&lt;R&gt; engineJob =
      engineJobFactory.build(
          key,
          isMemoryCacheable,
          useUnlimitedSourceExecutorPool,
          useAnimationPool,
          onlyRetrieveFromCache);

  DecodeJob&lt;R&gt; decodeJob =
      decodeJobFactory.build(
          glideContext,
          model,
          key,
          signature,
          width,
          height,
          resourceClass,
          transcodeClass,
          priority,
          diskCacheStrategy,
          transformations,
          isTransformationRequired,
          isScaleOnlyOrNoTransform,
          onlyRetrieveFromCache,
          options,
          engineJob);

  jobs.put(key, engineJob);

  engineJob.addCallback(cb, callbackExecutor);
  <span class="hljs-comment">// 启动DecodeJob</span>
  engineJob.start(decodeJob);

  <span class="hljs-keyword">if</span> (VERBOSE_IS_LOGGABLE) {
    logWithTimeAndKey(<span class="hljs-string">"Started new load"</span>, startTime, key);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadStatus</span>(cb, engineJob);
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>四级缓存在这里检查了两级（活动资源和内存缓存）</li>
<li>EngineKey是缓存的唯一标识，任何参数变化都会生成不同的Key</li>
<li>jobs 是一个存储正在执行任务的Map，用于请求合并</li>
</ul>
<h4 data-id="heading-23">8. EngineJob：任务管理和线程切换器</h4>
<p>EngineJob是一个管理和协调者，本身不执行加载，而是管理 DecodeJob的执行和回调</p>
<p>EngineJob.start(decodeJob)做了什么？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(DecodeJob&lt;R&gt; decodeJob)</span> {
  <span class="hljs-built_in">this</span>.decodeJob = decodeJob;
  <span class="hljs-type">GlideExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span>
      decodeJob.willDecodeFromCache() ? diskCacheExecutor : getActiveSourceExecutor();
  <span class="hljs-comment">// 将decodeJob提交到线程池</span>
  executor.execute(decodeJob);
}
</code></pre>
<p><strong>EngineJob的核心职责</strong>：</p>
<ul>
<li>持有DecodeJob：负责将DecodeJob提交到合适的线程池执行</li>
<li>管理回调：一个EngineJob可能对应多个Target（请求合并）</li>
<li>线程切换：当DecodeJob在子线程完成解码后，EngineJob负责将结果切换回主线程通知Target</li>
<li>资源释放：通过EngineResource的引用计数机制，跟踪资源使用情况</li>
</ul>
<h4 data-id="heading-24">9. DecodeJob：真正执行加载器</h4>
<p>DecodeJob 实现了Runable接口，是真正执行加载，解码，变换的“工人”，它的run（）方法是核心<br/>
DecodeJob.run()的主流程如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// We need to rethrow only CallbackException, but not other types of Throwables.</span>
<span class="hljs-meta">@SuppressWarnings("PMD.AvoidRethrowingException")</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
  GlideTrace.beginSectionFormat(<span class="hljs-string">"DecodeJob#run(reason=%s, model=%s)"</span>, runReason, model);
  DataFetcher&lt;?&gt; localFetcher = currentFetcher;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (isCancelled) {
      notifyFailed();
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">// 核心方法：执行解码</span>
    runWrapped();
  } <span class="hljs-keyword">catch</span> (CallbackException e) {
    <span class="hljs-keyword">throw</span> e;
  } <span class="hljs-keyword">catch</span> (Throwable t) {
    <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) {
      Log.d(
          TAG,
          <span class="hljs-string">"DecodeJob threw unexpectedly"</span> + <span class="hljs-string">", isCancelled: "</span> + isCancelled + <span class="hljs-string">", stage: "</span> + stage,
          t);
    }
    <span class="hljs-keyword">if</span> (stage != Stage.ENCODE) {
      throwables.add(t);
      notifyFailed();
    }
    <span class="hljs-keyword">if</span> (!isCancelled) {
      <span class="hljs-keyword">throw</span> t;
    }
    <span class="hljs-keyword">throw</span> t;
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">if</span> (localFetcher != <span class="hljs-literal">null</span>) {
      localFetcher.cleanup();
    }
    GlideTrace.endSection();
  }
}
</code></pre>
<h4 data-id="heading-25">10. runWrapped方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runWrapped</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">switch</span> (runReason) {
    <span class="hljs-keyword">case</span> INITIALIZE:
      <span class="hljs-comment">// 根据缓存策略，决定从哪个阶段开始</span>
      stage = getNextStage(Stage.INITIALIZE);
      currentGenerator = getNextGenerator();
      <span class="hljs-comment">// 开始执行</span>
      runGenerators();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_TO_SOURCE_SERVICE:
      runGenerators();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DECODE_DATA:
      decodeFromRetrievedData();
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Unrecognized run reason: "</span> + runReason);
  }
}
</code></pre>
<p><strong>DecodeJob的三阶段工作流（DataFetcher）</strong></p>
<p>DecodeJob内部使用三个DataFetcherGenerator来按顺序尝试获取数据：</p>
<ul>
<li>ResourceCacheGenerator：尝试从磁盘缓存（转换后的图片）加载</li>
<li>DataCacheGenerator：尝试从磁盘缓存（原始数据）加载</li>
<li>SourceGenerator：最后从原始源（网络、文件等）加载</li>
</ul>
<h4 data-id="heading-26">11. runGenerators方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runGenerators</span><span class="hljs-params">()</span> {
  currentThread = Thread.currentThread();
  startFetchTime = LogTime.getLogTime();
  <span class="hljs-type">boolean</span> <span class="hljs-variable">isStarted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">while</span> (!isCancelled
      &amp;&amp; currentGenerator != <span class="hljs-literal">null</span>
      &amp;&amp; !(isStarted = currentGenerator.startNext())) {
    <span class="hljs-comment">// 如果当前Generator无法获取数据（未命中），则切换到下一个</span>
    stage = getNextStage(stage);
    currentGenerator = getNextGenerator();

    <span class="hljs-keyword">if</span> (stage == Stage.SOURCE) {
      <span class="hljs-comment">// 当回退到SOURCE阶段时，需要切回主线程回调进度等</span>
      reschedule(RunReason.SWITCH_TO_SOURCE_SERVICE);
      <span class="hljs-keyword">return</span>;
    }
  }
  <span class="hljs-comment">// We've run out of stages and generators, give up.</span>
  <span class="hljs-keyword">if</span> ((stage == Stage.FINISHED || isCancelled) &amp;&amp; !isStarted) {
    notifyFailed();
  }

  <span class="hljs-comment">// Otherwise a generator started a new load and we expect to be called back in</span>
  <span class="hljs-comment">// onDataFetcherReady.</span>
}
</code></pre>
<h4 data-id="heading-27">12. startNext方法</h4>
<p>SourceGenerator的网络加载过程：  当回退到SourceGenerator时，会通过ModelLoader加载网络数据</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Concurrent access isn't supported.</span>
<span class="hljs-meta">@SuppressWarnings({"NonAtomicOperationOnVolatileField", "NonAtomicVolatileUpdate"})</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startNext</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">if</span> (dataToCache != <span class="hljs-literal">null</span>) {
    <span class="hljs-type">Object</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> dataToCache;
    dataToCache = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 先缓存原始数据</span>
      <span class="hljs-type">boolean</span> <span class="hljs-variable">isDataInCache</span> <span class="hljs-operator">=</span> cacheData(data);
      <span class="hljs-keyword">if</span> (!isDataInCache) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) {
        Log.d(TAG, <span class="hljs-string">"Failed to properly rewind or write data to cache"</span>, e);
      }
    }
  }
  
  <span class="hljs-keyword">if</span> (sourceCacheGenerator != <span class="hljs-literal">null</span> &amp;&amp; sourceCacheGenerator.startNext()) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  sourceCacheGenerator = <span class="hljs-literal">null</span>;

  loadData = <span class="hljs-literal">null</span>;
  <span class="hljs-type">boolean</span> <span class="hljs-variable">started</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">while</span> (!started &amp;&amp; hasNextModelLoader()) {
    <span class="hljs-comment">// 通过ModelLoader获取DataFetcher</span>
    loadData = helper.getLoadData().get(loadDataListIndex++);
    <span class="hljs-keyword">if</span> (loadData != <span class="hljs-literal">null</span>
        &amp;&amp; (helper.getDiskCacheStrategy().isDataCacheable(loadData.fetcher.getDataSource())
            || helper.hasLoadPath(loadData.fetcher.getDataClass()))) {
      started = <span class="hljs-literal">true</span>;
      <span class="hljs-comment">// 开始加载</span>
      startNextLoad(loadData);
    }
  }
  <span class="hljs-keyword">return</span> started;
}
</code></pre>
<h4 data-id="heading-28">13. startNextLoad方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startNextLoad</span><span class="hljs-params">(<span class="hljs-keyword">final</span> LoadData&lt;?&gt; toStart)</span> {
  loadData.fetcher.loadData(
      helper.getPriority(),
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataCallback</span>&lt;Object&gt;() {
        <span class="hljs-comment">// 加载完成的回调</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDataReady</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object data)</span> {
          <span class="hljs-keyword">if</span> (isCurrentRequest(toStart)) {
            onDataReadyInternal(toStart, data);
          }
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLoadFailed</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Exception e)</span> {
          <span class="hljs-keyword">if</span> (isCurrentRequest(toStart)) {
            onLoadFailedInternal(toStart, e);
          }
        }
      });
}
</code></pre>
<h4 data-id="heading-29">14. onDataReadyInternal方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SuppressWarnings("WeakerAccess")</span>
<span class="hljs-meta">@Synthetic</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">onDataReadyInternal</span><span class="hljs-params">(LoadData&lt;?&gt; loadData, Object data)</span> {
  <span class="hljs-type">DiskCacheStrategy</span> <span class="hljs-variable">diskCacheStrategy</span> <span class="hljs-operator">=</span> helper.getDiskCacheStrategy();
  <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span> &amp;&amp; diskCacheStrategy.isDataCacheable(loadData.fetcher.getDataSource())) {
    <span class="hljs-comment">// 标记需要缓存</span>
    dataToCache = data;
    cb.reschedule();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 将数据交给DecodeJob继续处理（解码、变换）</span>
    cb.onDataFetcherReady(
        loadData.sourceKey,
        data,
        loadData.fetcher,
        loadData.fetcher.getDataSource(),
        originalKey);
  }
}
</code></pre>
<h4 data-id="heading-30">15. DecodeJob.decodeFromRetrievedData方法</h4>
<p>数据解码与变换流程：  当获取到数据后，会回到DecodeJob.decodeFromRetrievedData()</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDataFetcherReady</span><span class="hljs-params">(
    Key sourceKey, Object data, DataFetcher&lt;?&gt; fetcher, DataSource dataSource, Key attemptedKey)</span> {
  <span class="hljs-built_in">this</span>.currentSourceKey = sourceKey;
  <span class="hljs-built_in">this</span>.currentData = data;
  <span class="hljs-built_in">this</span>.currentFetcher = fetcher;
  <span class="hljs-built_in">this</span>.currentDataSource = dataSource;
  <span class="hljs-built_in">this</span>.currentAttemptingKey = attemptedKey;
  <span class="hljs-built_in">this</span>.isLoadingFromAlternateCacheKey = sourceKey != decodeHelper.getCacheKeys().get(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">if</span> (Thread.currentThread() != currentThread) {
    reschedule(RunReason.DECODE_DATA);
  } <span class="hljs-keyword">else</span> {
    GlideTrace.beginSection(<span class="hljs-string">"DecodeJob.decodeFromRetrievedData"</span>);
    <span class="hljs-keyword">try</span> {
      decodeFromRetrievedData();
    } <span class="hljs-keyword">finally</span> {
      GlideTrace.endSection();
    }
  }
}
</code></pre>
<h4 data-id="heading-31">16. decodeFromRetrievedData方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decodeFromRetrievedData</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) {
    logWithTimeAndKey(
        <span class="hljs-string">"Retrieved data"</span>,
        startFetchTime,
        <span class="hljs-string">"data: "</span>
            + currentData
            + <span class="hljs-string">", cache key: "</span>
            + currentSourceKey
            + <span class="hljs-string">", fetcher: "</span>
            + currentFetcher);
  }
  Resource&lt;R&gt; resource = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 核心解码方法</span>
    resource = decodeFromData(currentFetcher, currentData, currentDataSource);
  } <span class="hljs-keyword">catch</span> (GlideException e) {
    e.setLoggingDetails(currentAttemptingKey, currentDataSource);
    throwables.add(e);
  }
  <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 通知EngineJob资源就绪</span>
    notifyEncodeAndRelease(resource, currentDataSource, isLoadingFromAlternateCacheKey);
  } <span class="hljs-keyword">else</span> {
    runGenerators();
  }
}

<span class="hljs-keyword">private</span> &lt;Data&gt; Resource&lt;R&gt; <span class="hljs-title function_">decodeFromData</span><span class="hljs-params">(
    DataFetcher&lt;?&gt; fetcher, Data data, DataSource dataSource)</span> <span class="hljs-keyword">throws</span> GlideException {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> LogTime.getLogTime();
    Resource&lt;R&gt; result = decodeFromFetcher(data, dataSource);
    <span class="hljs-keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE)) {
      logWithTimeAndKey(<span class="hljs-string">"Decoded result "</span> + result, startTime);
    }
    <span class="hljs-keyword">return</span> result;
  } <span class="hljs-keyword">finally</span> {
    fetcher.cleanup();
  }
}

<span class="hljs-keyword">private</span> &lt;Data&gt; Resource&lt;R&gt; <span class="hljs-title function_">decodeFromFetcher</span><span class="hljs-params">(Data data, DataSource dataSource)</span>
    <span class="hljs-keyword">throws</span> GlideException {
  LoadPath&lt;Data, ?, R&gt; path = decodeHelper.getLoadPath((Class&lt;Data&gt;) data.getClass());
  <span class="hljs-keyword">return</span> runLoadPath(data, dataSource, path);
}

<span class="hljs-keyword">private</span> &lt;Data, ResourceType&gt; Resource&lt;R&gt; <span class="hljs-title function_">runLoadPath</span><span class="hljs-params">(
    Data data, DataSource dataSource, LoadPath&lt;Data, ResourceType, R&gt; path)</span>
    <span class="hljs-keyword">throws</span> GlideException {
  <span class="hljs-type">Options</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> getOptionsWithHardwareConfig(dataSource);
  DataRewinder&lt;Data&gt; rewinder = glideContext.getRegistry().getRewinder(data);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// ResourceType in DecodeCallback below is required for compilation to work with gradle.</span>
    <span class="hljs-comment">// 通过LoadPath执行解码链：解码 -&gt; 变换 -&gt; 转码</span>
    <span class="hljs-keyword">return</span> path.load(
        rewinder, options, width, height, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DecodeCallback</span>&lt;ResourceType&gt;(dataSource));
  } <span class="hljs-keyword">finally</span> {
    rewinder.cleanup();
  }
}
</code></pre>
<h4 data-id="heading-32">17. notifyEncodeAndRelease方法</h4>
<p>回到EngineJob：结果分发</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyEncodeAndRelease</span><span class="hljs-params">(
    Resource&lt;R&gt; resource, DataSource dataSource, <span class="hljs-type">boolean</span> isLoadedFromAlternateCacheKey)</span> {
  GlideTrace.beginSection(<span class="hljs-string">"DecodeJob.notifyEncodeAndRelease"</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (resource <span class="hljs-keyword">instanceof</span> Initializable) {
      ((Initializable) resource).initialize();
    }

    Resource&lt;R&gt; result = resource;
    LockedResource&lt;R&gt; lockedResource = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (deferredEncodeManager.hasResourceToEncode()) {
      lockedResource = LockedResource.obtain(resource);
      result = lockedResource;
    }

    notifyComplete(result, dataSource, isLoadedFromAlternateCacheKey);

    stage = Stage.ENCODE;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (deferredEncodeManager.hasResourceToEncode()) {
        deferredEncodeManager.encode(diskCacheProvider, options);
      }
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">if</span> (lockedResource != <span class="hljs-literal">null</span>) {
        lockedResource.unlock();
      }
    }
    onEncodeComplete();
  } <span class="hljs-keyword">finally</span> {
    GlideTrace.endSection();
  }
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyComplete</span><span class="hljs-params">(
    Resource&lt;R&gt; resource, DataSource dataSource, <span class="hljs-type">boolean</span> isLoadedFromAlternateCacheKey)</span> {
  setNotifiedOrThrow();
  callback.onResourceReady(resource, dataSource, isLoadedFromAlternateCacheKey);
}
</code></pre>
<h4 data-id="heading-33">18. EngineJob.onResourceReady方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResourceReady</span><span class="hljs-params">(
    Resource&lt;R&gt; resource, DataSource dataSource, <span class="hljs-type">boolean</span> isLoadedFromAlternateCacheKey)</span> {
  <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
    <span class="hljs-built_in">this</span>.resource = resource;
    <span class="hljs-built_in">this</span>.dataSource = dataSource;
    <span class="hljs-built_in">this</span>.isLoadedFromAlternateCacheKey = isLoadedFromAlternateCacheKey;
  }
  <span class="hljs-comment">// 通知回调</span>
  notifyCallbacksOfResult();
}

<span class="hljs-meta">@SuppressWarnings({
  "WeakerAccess",
  "PMD.AvoidInstantiatingObjectsInLoops",
  "PMD.AccessorMethodGeneration"
})</span>
<span class="hljs-meta">@Synthetic</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyCallbacksOfResult</span><span class="hljs-params">()</span> {
  ResourceCallbacksAndExecutors copy;
  Key localKey;
  EngineResource&lt;?&gt; localResource;
  <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
    stateVerifier.throwIfRecycled();
    <span class="hljs-keyword">if</span> (isCancelled) {
      resource.recycle();
      release();
      <span class="hljs-keyword">return</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cbs.isEmpty()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Received a resource without any callbacks to notify"</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hasResource) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Already have resource"</span>);
    }
    engineResource = engineResourceFactory.build(resource, isCacheable, key, resourceListener);
    
    hasResource = <span class="hljs-literal">true</span>;
    copy = cbs.copy();
    incrementPendingCallbacks(copy.size() + <span class="hljs-number">1</span>);

    localKey = key;
    localResource = engineResource;
  }

  engineJobListener.onEngineJobComplete(<span class="hljs-built_in">this</span>, localKey, localResource);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> ResourceCallbackAndExecutor entry : copy) {
    entry.executor.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CallResourceReady</span>(entry.cb));
  }
  decrementPendingCallbacks();
}
</code></pre>
<h4 data-id="heading-34">19. into方法流程总结</h4>
<pre><code class="hljs language-text" lang="text">into() 
→ SingleRequest.begin() 
→ Engine.load() 
    ├→ 命中活动资源 → 直接返回
    ├→ 命中内存缓存 → 直接返回  
    └→ 未命中 → 创建EngineJob &amp; DecodeJob
        → EngineJob.start(decodeJob) 
        → 线程池执行DecodeJob.run()
        → DecodeJob.runWrapped()
            ├→ ResourceCacheGenerator (转换后缓存)
            ├→ DataCacheGenerator (原始数据缓存)
            └→ SourceGenerator (网络/文件)
                → ModelLoader.loadData() 
                → DataFetcher (如HttpUrlFetcher)
                → 获取数据后回调
        → 解码 → 变换 → 得到最终Resource
        → EngineJob.onResourceReady()
        → 切换主线程 → 回调Target → 显示图片
        → EngineResource引用计数管理
</code></pre>
<h2 data-id="heading-35">四、完整调用链总结</h2>
<pre><code class="hljs language-text" lang="text">Glide.with(context)                    // 1. 获取RequestManager（绑定生命周期）
    .load(model)                       // 2. 创建RequestBuilder，设置数据模型
    .apply(options)                    // 3. 配置请求参数
    .thumbnail(...)                    // 4. 可选：设置缩略图
    .listener(...)                     // 5. 可选：设置监听器
    .into(target)                      // 6. 构建并提交请求，开始加载
        ↓
    RequestManager.track(target, request) // 7. 生命周期跟踪
        ↓
    Engine.load()                         // 8. 缓存检查与任务调度
        ↓
    DecodeJob.run()                       // 9. 执行解码任务
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详解 patch-package：如何优雅地修改 node_modules（打补丁）]]></title>    <link>https://juejin.cn/post/7600370554069221402</link>    <guid>https://juejin.cn/post/7600370554069221402</guid>    <pubDate>2026-01-29T05:18:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600370554069221402" data-draft-id="7600370554069205018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详解 patch-package：如何优雅地修改 node_modules（打补丁）"/> <meta itemprop="keywords" content="React Native"/> <meta itemprop="datePublished" content="2026-01-29T05:18:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨狂之逸才"/> <meta itemprop="url" content="https://juejin.cn/user/624178332441166"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详解 patch-package：如何优雅地修改 node_modules（打补丁）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624178332441166/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨狂之逸才
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:18:59.000Z" title="Thu Jan 29 2026 05:18:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">详解 patch-package：如何优雅地修改 node_modules（打补丁）</h2>
<p>在开发过程中，我们经常会遇到第三方库（<code>node_modules</code>）有 bug 或者不支持某些功能的情况。直接修改 <code>node_modules</code> 下的文件虽然能暂时解决问题，但一旦重新运行 <code>npm install</code> 或者同事拉取代码，这些修改就会丢失。</p>
<p><code>patch-package</code> 就是为了解决这个问题而生的。它允许你<strong>持久化</strong>对 <code>node_modules</code> 的修改，并确保团队中的每个人都能自动应用这些修改。</p>
<h3 data-id="heading-1">1. 核心原理与配置解读</h3>
<p>你提到的 <code>package.json</code> 中的两行代码是整个机制的核心：</p>
<h4 data-id="heading-2">L117: 工具依赖</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"patch-package"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.0.1"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>作用</strong>：安装 <code>patch-package</code> 这个工具本身。</li>
<li><strong>目的</strong>：让你能够使用 <code>npx patch-package &lt;库名&gt;</code> 命令来生成补丁文件。</li>
</ul>
<h4 data-id="heading-3">L13: 自动化钩子 (Hook)</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"postinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"patch-package"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>作用</strong>：这是一个 npm 生命周期钩子。</li>
<li><strong>目的</strong>：<strong>这是最关键的一步</strong>。每当你（或者你的 CI/CD 系统）运行 <code>npm install</code> 或 <code>yarn</code> 安装依赖<strong>完成之后</strong>，npm 会自动执行 <code>postinstall</code> 指定的命令。</li>
<li><strong>流程</strong>：<code>npm install</code> (下载原始包) -&gt; <code>postinstall</code> (触发 <code>patch-package</code>) -&gt; <code>patch-package</code> 会查找 <code>patches/</code> 目录下的补丁文件 -&gt; <strong>自动将补丁应用到 node_modules 中</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-4">2. 环境要求</h3>
<p>使用 <code>patch-package</code> 不需要复杂的环境，只需要标准的 Node.js 开发环境：</p>
<ul>
<li><strong>Node.js</strong>: &gt;= 14 (推荐 LTS 版本)</li>
<li><strong>包管理器</strong>: npm, yarn, 或 pnpm 均可。</li>
<li><strong>Git</strong>: 用于版本控制（必须提交生成的 <code>.patch</code> 文件）。</li>
</ul>
<hr/>
<h3 data-id="heading-5">3. 完整操作流程 (Workflow)</h3>
<p>假设我们要修改 <code>@ant-design/icons-react-native</code> 这个库（就像刚才做的那样）。</p>
<h4 data-id="heading-6">第一步：安装 patch-package (一次性设置)</h4>
<p>如果项目中还没有配置，需要先安装并设置 <code>postinstall</code> 脚本。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装</span>
npm install patch-package --save-dev
<span class="hljs-comment"># 或者</span>
yarn add patch-package -D

<span class="hljs-comment"># 配置 package.json (手动添加或修改)</span>
<span class="hljs-comment"># "scripts": {</span>
<span class="hljs-comment">#   "postinstall": "patch-package"</span>
<span class="hljs-comment"># }</span>
</code></pre>
<h4 data-id="heading-7">第二步：直接修改源码</h4>
<p>在你的 IDE 中，直接打开 <code>node_modules/@ant-design/icons-react-native/react-native.config.js</code>，进行你想要的修改。</p>
<ul>
<li><strong>修改前</strong>：<code>assets: ['fonts']</code></li>
<li><strong>修改后</strong>：<code>// assets: ['fonts']</code> (注释掉，避免字体链接错误)</li>
</ul>
<h4 data-id="heading-8">第三步：生成补丁 (Snapshot)</h4>
<p>修改完成后，运行以下命令告诉 <code>patch-package</code> 你修改了哪个包：</p>
<pre><code class="hljs language-bash" lang="bash">npx patch-package @ant-design/icons-react-native
</code></pre>
<p><strong>结果</strong>：
工具会在你的项目根目录下自动生成一个文件夹 <code>patches/</code>，里面有一个文件，例如 <code>@ant-design+icons-react-native+2.3.2.patch</code>。这个文件记录了你的修改内容（diff）。</p>
<h4 data-id="heading-9">第四步：提交代码</h4>
<p>将生成的 <code>patches/</code> 目录和 <code>package.json</code> 的变动提交到 Git。</p>
<pre><code class="hljs language-bash" lang="bash">git add patches/ package.json
git commit -m <span class="hljs-string">"fix: patch @ant-design/icons-react-native to disable font linking"</span>
</code></pre>
<h4 data-id="heading-10">第五步：验证与自动应用</h4>
<ul>
<li><strong>你自己</strong>：下次你删除了 <code>node_modules</code> 重新 <code>yarn</code> 时，补丁会自动应用。</li>
<li><strong>你的同事</strong>：拉取最新代码并运行 <code>yarn</code> 后，补丁也会自动应用，他们的 <code>node_modules</code> 会和你的一模一样。</li>
</ul>
<hr/>
<h3 data-id="heading-11">4. 总结</h3>

























<table><thead><tr><th align="left">文件/命令</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left"><code>node_modules/...</code></td><td align="left">你<strong>临时</strong>修改源码的地方。</td></tr><tr><td align="left"><code>npx patch-package &lt;包名&gt;</code></td><td align="left">将你的临时修改<strong>保存</strong>为补丁文件。</td></tr><tr><td align="left"><code>patches/*.patch</code></td><td align="left">补丁文件，必须<strong>提交到 Git</strong>。</td></tr><tr><td align="left"><code>"postinstall": "patch-package"</code></td><td align="left">确保每次安装依赖后，补丁都会被<strong>重新应用</strong>。</td></tr></tbody></table>
<p>这就是为什么我们在 <code>package.json</code> 中需要那两行配置。它们保证了“一次修改，永久生效，团队共享”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python对象的自连接]]></title>    <link>https://juejin.cn/post/7600489282822733874</link>    <guid>https://juejin.cn/post/7600489282822733874</guid>    <pubDate>2026-01-29T03:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282822733874" data-draft-id="7600489282822701106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python对象的自连接"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-29T03:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深度涌现"/> <meta itemprop="url" content="https://juejin.cn/user/2524932621734990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python对象的自连接
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524932621734990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深度涌现
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:59:42.000Z" title="Thu Jan 29 2026 03:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python对象的自连接</h2>
<p>在Python中，<strong>字符串可以与数字相乘</strong>。</p>
<h2 data-id="heading-1">将字符串连接到数字不起作用。</h2>
<p>在Python中，字符串和数字之间不能使用加号（ <code>+</code> ）：</p>
<pre><code class="hljs language-sql" lang="sql">prefix <span class="hljs-operator">=</span> "year: "
<span class="hljs-keyword">year</span> <span class="hljs-operator">=</span> <span class="hljs-number">1999</span>
prefix <span class="hljs-operator">+</span> <span class="hljs-keyword">year</span>
Traceback (most recent <span class="hljs-keyword">call</span> <span class="hljs-keyword">last</span>):
  File "&lt;python-input-4&gt;", line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">module</span><span class="hljs-operator">&gt;</span>
    prefix <span class="hljs-operator">+</span> <span class="hljs-keyword">year</span>
    <span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">^</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span><span class="hljs-operator">~</span>
TypeError: can <span class="hljs-keyword">only</span> concatenate str (<span class="hljs-keyword">not</span> "int") <span class="hljs-keyword">to</span> str
</code></pre>
<p>您可以使用加号将<strong>两个数字相加</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">year</span> <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
<span class="hljs-number">2000</span>
</code></pre>
<p>或者将<strong>两个字符串连接起来</strong>：</p>
<pre><code class="hljs language-python" lang="python">prefix + <span class="hljs-built_in">str</span>(year)
<span class="hljs-string">'year: 1999'</span>
</code></pre>
<p>但它<strong>不适用于字符串和数字之间</strong>。</p>
<h2 data-id="heading-2">将字符串乘以数字</h2>
<p>有趣的是，你<em>可以</em><strong>将一个字符串乘以一个数字</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"ha"</span> * <span class="hljs-number">3</span>
<span class="hljs-string">'hahaha'</span>
</code></pre>
<p>你可以把这理解为<strong>自连接</strong>。我们将这个字符串与自身连接特定的次数：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"ha"</span> + <span class="hljs-string">"ha"</span> + <span class="hljs-string">"ha"</span>
<span class="hljs-string">'hahaha'</span>
</code></pre>
<h2 data-id="heading-3">自连接仅适用于整数。</h2>
<p>字符串只能用整数自连接：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"ha"</span> * <span class="hljs-number">2.5</span>
<span class="hljs-built_in">Traceback</span> (most recent call last):
  <span class="hljs-built_in">File</span> <span class="hljs-string">"&lt;python-input-2&gt;"</span>, line <span class="hljs-number">1</span>, in &lt;<span class="hljs-keyword">module</span>&gt;
    <span class="hljs-string">"ha"</span> * <span class="hljs-number">2.5</span>
    ~~~~~^~~~~
TypeError: can<span class="hljs-number">'</span>t multiply sequence by non-<span class="hljs-type">int</span> of type <span class="hljs-string">'float'</span>
</code></pre>
<p>字符串相乘非整数次是没有意义的。</p>
<p>有趣的是，<strong>负数*也可以*</strong>用于自连接，只是结果总是空字符串：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"ha"</span> * -3
<span class="hljs-string">''</span>
</code></pre>
<p>当你将一个字符串乘以<code>0</code>时，也会发生同样的情况：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"ha"</span> * 0
<span class="hljs-string">''</span>
</code></pre>
<h2 data-id="heading-4">序列通常支持自连接</h2>
<p>任何支持字符串拼接的对象，很可能也支持自拼接。</p>
<p>因此，其他序列，如列表、元组和字节串，也可以进行自连接：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[2, 1, 3]</span> * <span class="hljs-number">2</span>
<span class="hljs-selector-attr">[2, 1, 3, 2, 1, 3]</span>
(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>) * <span class="hljs-number">3</span>
(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
<span class="hljs-selector-tag">b</span>"text " * <span class="hljs-number">3</span>
<span class="hljs-selector-tag">b</span>'text text text '
</code></pre>
<h2 data-id="heading-5">自连接的实际应用</h2>
<p>这算是一个挺有意思的功能，但它存在的意义是什么？它真的有用吗？</p>
<p>我偶尔会使用自连接来<strong>创建具有特定默认值的特定大小的列表</strong>。</p>
<p>例如，我们可以使用自连接来创建一个表示一年中 12 个月的列表，以统计该列表中某个事物出现的次数，并且我们希望将所有计数默认设置为零：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">0</span>] * <span class="hljs-number">12</span>
[<span class="hljs-meta">0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span>]
</code></pre>
<p>但更多时候，我使用这个功能来<strong>创建一个由相同字符重复特定次数的字符串</strong>。</p>
<p>例如，我可能想在程序的输出部分之间打印 80 个连字符（ <code>-</code> ）。</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">80</span>)
<span class="hljs-comment">--------------------------------------------------------------------------------</span>
</code></pre>
<h2 data-id="heading-6">自连接不会复制</h2>
<p>就像在 Python 中创建新的数据结构或分配变量一样，<strong>自连接不会复制任何内容</strong>。</p>
<p>在Python中，给变量赋值并不会复制该值：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span> = <span class="hljs-selector-attr">[2, 1, 3]</span>
<span class="hljs-selector-tag">b</span> = <span class="hljs-selector-tag">a</span>
</code></pre>
<p><strong>Python 中的变量类似于指针</strong>。因此，更改<code>b</code>指向的列表也会更改<code>a</code>指向的列表：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.append</span>(<span class="hljs-number">4</span>)
<span class="hljs-selector-tag">b</span>
<span class="hljs-selector-attr">[2, 1, 3, 4]</span>
<span class="hljs-selector-tag">a</span>
<span class="hljs-selector-attr">[2, 1, 3, 4]</span>
</code></pre>
<p>这是因为<strong>这两个变量指向同一个对象</strong>。这就是Python中赋值操作的作用。</p>
<p>就像给变量赋值不会复制该值一样，使用列表或元组的自连接也不会复制这些项。</p>
<p>所以，如果我们尝试将一个包含列表的列表乘以<code>3</code> ，从而将其自身连接三次：</p>
<pre><code class="hljs language-lua" lang="lua">rows = <span class="hljs-string">[[0, 0, 0]]</span> * <span class="hljs-number">3</span>
</code></pre>
<p>最终我们会得到一个包含相同三项的列表：</p>
<pre><code class="hljs language-lua" lang="lua">rows
<span class="hljs-string">[[0, 0, 0], [0, 0, 0], [0, 0, 0]]</span>
</code></pre>
<p>也就是说，索引<code>0</code>与索引<code>1</code>是同一个对象：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">rows</span>[<span class="hljs-number">0</span>] <span class="hljs-keyword">is</span> <span class="hljs-keyword">rows</span>[<span class="hljs-number">1</span>]
<span class="hljs-literal">True</span>
</code></pre>
<p>也就是说，如果我们修改其中一个内部列表，<em>所有</em>内部列表都会随之改变：</p>
<pre><code class="hljs language-css" lang="css">rows<span class="hljs-selector-attr">[1]</span><span class="hljs-selector-attr">[1]</span> = <span class="hljs-number">7</span>
rows
<span class="hljs-selector-attr">[[0, 7, 0]</span>, <span class="hljs-selector-attr">[0, 7, 0]</span>, <span class="hljs-selector-attr">[0, 7, 0]</span>]
</code></pre>
<p>这是因为<strong>它们都属于同一个列表</strong>。</p>
<h2 data-id="heading-7">不要将可变项的列表自连接起来。</h2>
<p>与大多数操作一样，<strong>自连接不会创建副本</strong>。</p>
<p>实际上，这意味着自连接通常<strong>只用于包含不可变项的序列</strong>，而不用于包含可变项的序列。</p>
<h2 data-id="heading-8">何时使用自连接</h2>
<p>自连接可用于创建包含相同字符或相同字符序列且重复次数固定的字符串。它也适用于预先填充包含特定数量默认值的列表。</p>
<p>但是自连接不会复制任何内容，所以不要尝试用它来创建可变值的列表，例如列表的列表。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pythonmorsels.com%2Fself-concatenation%2F" target="_blank" title="https://www.pythonmorsels.com/self-concatenation/" ref="nofollow noopener noreferrer">www.pythonmorsels.com/self-concat…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F4Qd7IoOR8YNhIpGFGWQrAw" target="_blank" title="https://mp.weixin.qq.com/s/4Qd7IoOR8YNhIpGFGWQrAw" ref="nofollow noopener noreferrer">Python对象的自连接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Claude Code】Windows环境下ClaudeCode自定义路径安装及更新PowerShell脚本]]></title>    <link>https://juejin.cn/post/7600370554068959258</link>    <guid>https://juejin.cn/post/7600370554068959258</guid>    <pubDate>2026-01-29T04:02:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600370554068959258" data-draft-id="7600370554068926490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Claude Code】Windows环境下ClaudeCode自定义路径安装及更新PowerShell脚本"/> <meta itemprop="keywords" content="开源,Claude"/> <meta itemprop="datePublished" content="2026-01-29T04:02:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="等光的影子"/> <meta itemprop="url" content="https://juejin.cn/user/1640889048639277"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Claude Code】Windows环境下ClaudeCode自定义路径安装及更新PowerShell脚本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1640889048639277/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    等光的影子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:02:36.000Z" title="Thu Jan 29 2026 04:02:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">背景</h4>
<p>由于本人对各应用的安装目录有洁癖, 但ClaudeCode官方推出的本地化安装模式无法设置安装路径, 故此基于官方安装脚本进行完善扩展。</p>
<h4 data-id="heading-1">特性</h4>
<ul>
<li>可检查版本是否有更新</li>
<li>可强制覆盖安装</li>
<li>可指定目录安装/更新</li>
<li>可指定具体版本号(2.0.70)/stable/latest版本安装/更新</li>
<li>失败自动重试</li>
<li>自动添加环境变量</li>
<li>文件SHA256校验及更新备份</li>
<li>自动创建ClaudeCode所需本地链接</li>
</ul>
<h4 data-id="heading-2">使用方法</h4>
<p>目录结构如下, 由于安装目录已经配置环境变量, 因此可直接使用, 未配置环境变量则使用如下格式</p>
<blockquote>
<p>.\update-cc.ps1 -h
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d474e844d054444a92a88347d649cae7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562J5YWJ55qE5b2x5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770264155&amp;x-signature=VJfQWY1GMqv4mrjrUA%2BjiKvd%2FUI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<pre><code class="hljs language-powershell" lang="powershell"># 显示帮助
update-cc -h
# 更新到最新版本
update-cc
# 安装稳定版
update-cc stable
# 安装指定版本
update-cc 2.0.71
# 强制更新
update-cc -f
# 安装指定目录
update-cc -i "C:\ClaudeCode"
</code></pre>
<h4 data-id="heading-3">脚本内容</h4>
<pre><code class="hljs language-powershell" lang="powershell"># Windows - Claude Code 安装及更新脚本
# 作者: SmallBaby
# 版本: v1.1

param(
    [Parameter(Position=0)]
    [ValidatePattern('^(stable|latest|\d+\.\d+\.\d+(-[^\s]+)?)$')]
    [string]$Target = "latest",

    [switch]$Force,
    [switch]$Help,
    [string]$InstallDir = "C:\Software\ClaudeCode",
    [string]$Platform = "win32-x64"
)

$ErrorActionPreference = "Stop"
$script:ScriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
$script:InstallPath = Join-Path -Path $InstallDir -ChildPath "claude.exe"

# 配置常量
$script:CONSTANTS = @{
    REPO_URL = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases"
    TEMP_DIR = $env:TEMP
    DEFAULT_PLATFORM = "win32-x64"
    MAX_RETRY_COUNT = 3
    RETRY_DELAY_MS = 1000
    DEFAULT_CONNECT_TIMEOUT = 30
    DEFAULT_DOWNLOAD_TIMEOUT = 600
    LOG_LEVEL = @{
        SUCCESS = "SUCCESS"
        INFO = "INFO"
        WARN = "WARN"
        ERROR = "ERROR"
    }
}

# 验证32位系统
function Validate-SystemArchitecture {
    if (-not [Environment]::Is64BitProcess) {
        Write-Log "Claude Code 不支持 32 位 Windows，请使用 64 位版本" $script:CONSTANTS.LOG_LEVEL.ERROR
        exit 1
    }
}

# 主函数
function Show-Help {
    Write-Host @"
Windows - Claude Code 安装及更新脚本 © SmallBaby

用法:
    update-cc.ps1 [选项] [版本]

参数:
    目标版本 (可选):
        stable          安装稳定版本
        latest          安装最新版本 (默认)
        2.0.70          安装指定的版本号

    选项:
        -f,-Force       强制更新，即使当前版本已是最新
        -h,-Help        显示此帮助信息并退出
        -i,-InstallDir  指定 Claude Code 的安装目录
                        默认: C:\Software\ClaudeCode
                        示例: -i "C:\Tools"

示例:
    update-cc.ps1
        检查更新并提示安装最新版本

    update-cc.ps1 stable
        安装稳定版本

    update-cc.ps1 2.0.70
        安装指定的 2.0.70 版本

    update-cc.ps1 -Force
        强制重新安装最新版本，不提示确认

    update-cc.ps1 -InstallDir "C:\Tools"
        安装到指定目录 C:\Tools
"@ -ForegroundColor White
}

function Write-Log {
    param(
        [string]$Message,
        [string]$Level = "INFO"
    )

    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $color = if ($Level -eq "ERROR") { "Red" }
             elseif ($Level -eq "WARN") { "Yellow" }
             elseif ($Level -eq "SUCCESS") { "Green" }
             else { "White" }

    Write-Host "[$timestamp] [$Level] $Message" -ForegroundColor $color
}

# 下载函数
function Download-Claude {
    param(
        [string]$Version,
        [string]$Platform = $script:CONSTANTS.DEFAULT_PLATFORM,
        [int]$RetryCount = 0
    )

    try {
        $downloadUrl = "$($script:CONSTANTS.REPO_URL)/$Version/$Platform/claude.exe"
        $tempPath = Join-Path $script:CONSTANTS.TEMP_DIR "claude-${Version}-${Platform}.exe"

        Write-Log "正在下载 Claude Code $Version..."
        Write-Log "下载地址: $downloadUrl"

        $response = Invoke-RestMethod -Uri $downloadUrl -Method Get -UseBasicParsing -TimeoutSec $script:CONSTANTS.DEFAULT_DOWNLOAD_TIMEOUT
        Write-Log "使用 Invoke-RestMethod 下载..." "INFO"
        Invoke-WebRequest -Uri $downloadUrl -OutFile $tempPath -TimeoutSec $script:CONSTANTS.DEFAULT_DOWNLOAD_TIMEOUT -UseBasicParsing

        if (Test-Path $tempPath) {
            $fileSize = (Get-Item $tempPath).Length / 1MB
            Write-Log "下载完成，文件大小: $([math]::Round($fileSize, 2)) MB" "SUCCESS"

            # 校验文件完整性
            Write-Log "正在校验文件完整性..."
            $expectedChecksum = Get-Checksum -Version $Version -Platform $Platform
            if (-not $expectedChecksum) { throw "无法获取校验和" }
            
            $actualChecksum = (Get-FileHash -Path $tempPath -Algorithm SHA256).Hash.ToLower()

            if ($actualChecksum -ne $expectedChecksum) {
                Remove-Item -Path $tempPath -Force -ErrorAction SilentlyContinue
                throw "校验和不匹配，文件可能已损坏"
            }

            Write-Log "文件校验通过" "SUCCESS"
            return $tempPath
        } else {
            throw "下载失败，文件未找到"
        }
    }
    catch {
        if ($RetryCount -lt $script:CONSTANTS.MAX_RETRY_COUNT) {
            Write-Log "下载失败 (第$($RetryCount + 1)次), 重试中...: $($_.Exception.Message)" "WARN"
            Start-Sleep -Milliseconds $script:CONSTANTS.RETRY_DELAY_MS
            return Download-Claude -Version $Version -Platform $Platform -RetryCount ($RetryCount + 1)
        } else {
            Write-Log "下载失败 (所有重试均失败): $($_.Exception.Message)" "ERROR"
            throw
        }
    }
}

# 版本信息获取函数
function Get-VersionInfo {
    [CmdletBinding()]
    param(
        [string]$Target,
        [int]$RetryCount = 0
    )

    try {
        Write-Log "正在获取版本信息... (目标: $Target)"

        if ($Target -match '^\d+\.\d+\.\d+') {
            Write-Log "使用指定版本: $Target"
            return $Target
        }

        $versionUrl = "$($script:CONSTANTS.REPO_URL)/$Target"
        $version = Invoke-RestMethod -Uri $versionUrl -TimeoutSec $script:CONSTANTS.DEFAULT_CONNECT_TIMEOUT -ErrorAction Stop
        $version = $version.Trim()

        Write-Log "获取到 $Target 版本: $version"
        return $version
    }
    catch {
        if ($RetryCount -lt $script:CONSTANTS.MAX_RETRY_COUNT) {
            Write-Log "获取版本信息失败 (第$($RetryCount + 1)次), 重试中...: $($_.Exception.Message)" "WARN"
            Start-Sleep -Milliseconds $script:CONSTANTS.RETRY_DELAY_MS
            return Get-VersionInfo -Target $Target -RetryCount ($RetryCount + 1)
        } else {
            Write-Log "获取版本信息失败 (所有重试均失败): $($_.Exception.Message)" "ERROR"
            throw
        }
    }
}

# 当前版本获取函数
function Get-CurrentVersion {
    try {
        Write-Log "正在检查当前版本..."

        # 检查已安装路径
        if (Test-Path $script:InstallPath) {
            try {
                $versionOutput = &amp; $script:InstallPath -v 2&gt;&amp;1
                if ($versionOutput -match '(\d+\.\d+\.\d+)') {
                    $currentVersion = $matches[1]
                    Write-Log "当前版本 (路径): $currentVersion"
                    return $currentVersion
                }
            }
            catch {
                Write-Log "无法从 $script:InstallPath 获取版本: $($_.Exception.Message)" "WARN"
            }
        }

        # 检查PATH中的claude
        try {
            $claudeVersion = &amp; claude -v 2&gt;&amp;1
            if ($claudeVersion -match '(\d+\.\d+\.\d+)') {
                $currentVersion = $matches[1]
                Write-Log "当前版本 (PATH): $currentVersion"
                return $currentVersion
            }
        }
        catch {
            Write-Log "claude command not found in PATH" "WARN"
        }

        Write-Log "未找到已安装的 Claude Code" "WARN"
        return $null
    }
    catch {
        Write-Log "获取当前版本失败: $($_.Exception.Message)" "ERROR"
        return $null
    }
}

# 更新尝试函数
function Try-ClaudeUpdate {
    param(
        [string]$Target
    )

    try {
        Write-Log "尝试使用 claude update 命令更新..." "INFO"

        $claudeCmd = Get-Command claude -ErrorAction SilentlyContinue
        if (-not $claudeCmd) {
            Write-Log "未找到 claude 命令，跳过内置更新" "WARN"
            return $false
        }

        $updateArgs = @("update")
        if ($Target -ne "latest") {
            $updateArgs += $Target
        }

        Write-Log "执行: claude $ $($updateArgs -join ' ')"
        
        # 执行更新并捕获退出代码
        $processInfo = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo.FileName = $claudeCmd.Source
        $processInfo.Arguments = ($updateArgs -join ' ')
        $processInfo.UseShellExecute = $false
        
        $process = [System.Diagnostics.Process]::Start($processInfo)
        $process.WaitForExit()

        Write-Log "claude update 退出代码: $($process.ExitCode)" "INFO"

        if ($process.ExitCode -eq 0) {
            $newVersion = Get-CurrentVersion
            $targetVersion = Get-VersionInfo -Target $Target

            if ($newVersion -eq $targetVersion) {
                Write-Log "使用 claude update 成功更新到版本: $newVersion" "SUCCESS"
                return $true
            } else {
                Write-Log "claude update 未更新到目标版本，将使用下载方式" "INFO"
                return $false
            }
        } else {
            Write-Log "claude update 失败，退出代码: $($process.ExitCode)" "WARN"
            return $false
        }
    }
    catch {
        Write-Log "claude update 失败: $($_.Exception.Message)" "WARN"
        return $false
    }
}

# 版本比较函数
function Compare-Version {
    param(
        [string]$Version1,
        [string]$Version2
    )

    try {
        # 使用[version]对象进行比较
        $v1 = [System.Version]$Version1
        $v2 = [System.Version]$Version2

        if ($v1 -gt $v2) { return 1 }
        elseif ($v1 -lt $v2) { return -1 }
        else { return 0 }
    }
    catch {
        Write-Log "版本比较失败: $($_.Exception.Message)" "ERROR"
        Write-Log "尝试字符串比较..." "WARN"
        
        # 如果版本对象比较失败，使用字符串比较
        $v1Components = $Version1.Split('.')
        $v2Components = $Version2.Split('.')
        
        $maxLen = [Math]::Max($v1Components.Count, $v2Components.Count)
        for ($i = 0; $i -lt $maxLen; $i++) {
            $c1 = [int]($v1Components[$i] ?? 0)
            $c2 = [int]($v2Components[$i] ?? 0)
            
            if ($c1 -gt $c2) { return 1 }
            elseif ($c1 -lt $c2) { return -1 }
        }
        return 0
    }
}

# 校验和获取函数
function Get-Checksum {
    [CmdletBinding()]
    param(
        [string]$Version,
        [string]$Platform = $script:CONSTANTS.DEFAULT_PLATFORM,
        [int]$RetryCount = 0
    )

    try {
        $manifestUrl = "$($script:CONSTANTS.REPO_URL)/$Version/manifest.json"
        Write-Log "获取清单: $manifestUrl"
        
        $manifest = Invoke-RestMethod -Uri $manifestUrl -TimeoutSec $script:CONSTANTS.DEFAULT_CONNECT_TIMEOUT -ErrorAction Stop
        $checksum = $manifest.platforms.$Platform.checksum

        if (-not $checksum) {
            throw "清单中未找到平台 $Platform"
        }

        Write-Log "获取到校验和: $($checksum.Substring(0, 16))..."
        return $checksum.ToLower()
    }
    catch {
        if ($RetryCount -lt $script:CONSTANTS.MAX_RETRY_COUNT) {
            Write-Log "获取校验和失败 (第$($RetryCount + 1)次), 重试中...: $($_.Exception.Message)" "WARN"
            Start-Sleep -Milliseconds $script:CONSTANTS.RETRY_DELAY_MS
            return Get-Checksum -Version $Version -Platform $Platform -RetryCount ($RetryCount + 1)
        } else {
            Write-Log "获取校验和失败 (所有重试均失败): $($_.Exception.Message)" "ERROR"
            throw
        }
    }
}

# 备份函数
function Backup-CurrentClaude {
    param(
        [string]$CurrentVersion
    )

    try {
        if (Test-Path $script:InstallPath) {
            $directory = Split-Path -Path $script:InstallPath -Parent

            # 清理旧备份
            $backupPattern = "claude.exe.*.bak"
            $backupFiles = Get-ChildItem -Path $directory -Name $backupPattern -ErrorAction SilentlyContinue
            if ($backupFiles.Count -gt 0) {
                Write-Log "正在清理旧备份文件..."
                foreach ($backupFile in $backupFiles) {
                    $backupPath = Join-Path -Path $directory -ChildPath $backupFile
                    Remove-Item -Path $backupPath -Force -ErrorAction SilentlyContinue
                    Write-Log "已删除旧备份: $backupFile"
                }
            }

            $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
            $backupPath = Join-Path -Path $directory -ChildPath "claude.exe.$CurrentVersion.$timestamp.bak"
            Write-Log "正在备份当前文件到: $backupPath"
            Copy-Item -Path $script:InstallPath -Destination $backupPath -Force -ErrorAction Stop
            Write-Log "备份创建成功" "SUCCESS"
            return $backupPath
        }
        return $null
    }
    catch {
        Write-Log "备份失败: $($_.Exception.Message)" "WARN"
        return $null
    }
}

# 环境变量函数
function Add-To-Path {
    param(
        [string]$PathToAdd
    )

    try {
        $directory = Split-Path -Path $PathToAdd -Parent
        $userPath = [Environment]::GetEnvironmentVariable("PATH", "User") -split ';' | Where-Object { $_ -ne $null -and $_ -ne '' }

        if ($userPath -notcontains $directory) {
            Write-Log "正在添加环境变量: $directory"
            $newPath = $userPath + $directory | Where-Object { $_ -ne $null -and $_ -ne '' } 
            [Environment]::SetEnvironmentVariable("PATH", ($newPath -join ';'), "User")
            Write-Log "环境变量已添加，请重启终端或重新登录以使更改生效" "SUCCESS"
        } else {
            Write-Log "环境变量已存在，跳过添加" "INFO"
        }
    }
    catch {
        Write-Log "添加环境变量失败: $($_.Exception.Message)" "WARN"
    }
}

# 链接创建函数
function Create-Links {
    param(
        [string]$Version
    )

    try {
        Write-Log "正在创建链接..." "INFO"

        $installDirectory = Split-Path -Path $script:InstallPath -Parent
        $userProfile = $env:USERPROFILE

        # 创建用户目录下的 .claude 软链接
        $claudeUserDir = Join-Path $userProfile ".claude"
        if (Test-Path $claudeUserDir) {
            Remove-Item -Path $claudeUserDir -Force -Recurse -ErrorAction SilentlyContinue
            Write-Log "已删除现有链接: $claudeUserDir"
        }

        New-Item -ItemType SymbolicLink -Path $claudeUserDir -Value $installDirectory -Force -ErrorAction Stop | Out-Null
        Write-Log "已创建软链接: $claudeUserDir -&gt; $installDirectory" "SUCCESS"

        # 创建各种配置文件的软链接
        $configFiles = @('.claude.json', '.claude.json.backup')
        foreach ($configFile in $configFiles) {
            $sourcePath = Join-Path $installDirectory $configFile
            $targetPath = Join-Path $userProfile $configFile

            if (Test-Path $sourcePath) {
                if (Test-Path $targetPath) {
                    Remove-Item -Path $targetPath -Force -ErrorAction SilentlyContinue
                    Write-Log "已删除现有链接: $targetPath"
                }
                try {
                    New-Item -ItemType SymbolicLink -Path $targetPath -Value $sourcePath -Force -ErrorAction Stop | Out-Null
                    Write-Log "已创建软链接: $targetPath -&gt; $sourcePath" "SUCCESS"
                }
                catch {
                    Write-Log "创建软链接失败 (不影响主功能): $($_.Exception.Message)" "WARN"
                }
            }
        }

        # 创建 .local 目录结构
        $binDir = Join-Path $userProfile ".local\bin"
        $versionsDir = Join-Path $userProfile ".local\share\claude\versions"

        foreach ($dir in @($binDir, $versionsDir)) {
            if (-not (Test-Path $dir)) {
                New-Item -ItemType Directory -Path $dir -Force -ErrorAction Stop | Out-Null
                Write-Log "已创建目录: $dir"
            }
        }

        # 创建到 .local/bin 的软链接
        $binLinkPath = Join-Path $binDir "claude.exe"
        if (Test-Path $binLinkPath) {
            Remove-Item -Path $binLinkPath -Force -ErrorAction SilentlyContinue
            Write-Log "已删除现有链接: $binLinkPath"
        }

        try {
            New-Item -ItemType SymbolicLink -Path $binLinkPath -Value $script:InstallPath -Force -ErrorAction Stop | Out-Null
            Write-Log "已创建软链接: $binLinkPath -&gt; $script:InstallPath" "SUCCESS"
        }
        catch {
            Write-Log "创建软链接失败 (不影响主功能): $($_.Exception.Message)" "WARN"
        }

        Write-Log "链接创建完成" "SUCCESS"
    }
    catch {
        Write-Log "创建链接失败: $($_.Exception.Message)" "WARN"
        Write-Log "此错误通常不影响核心功能" "INFO"
    }
}

# 清理临时文件
function Cleanup-TempFiles {
    param(
        [string]$TempFile = $null,
        [string]$LogFile = $null
    )

    try {
        if ($TempFile -and (Test-Path $TempFile)) {
            Remove-Item -Path $TempFile -Force -ErrorAction SilentlyContinue
            Write-Log "已清理临时文件" "INFO"
        }
        if ($LogFile -and (Test-Path $LogFile)) {
            Remove-Item -Path $LogFile -Force -ErrorAction SilentlyContinue
        }
    }
    catch {
        Write-Log "清理临时文件时出错: $($_.Exception.Message)" "WARN"
    }
}

# 进程检查
function Check-And-KillClaudeProcess {
    Write-Log "检查 Claude Code 运行进程..." "INFO"
    
    # 获取并终止相关进程
    $processes = Get-Process -Name "claude", "Claude*" -ErrorAction SilentlyContinue
    
    if ($processes) {
        foreach ($proc in $processes) {
            # 检查进程是否使用了目标路径中的文件
            if ($proc.Path -and $proc.Path -like "*claude.exe*") {
                Write-Log "发现运行中的 claude 进程 PID: $($proc.Id), 已启动: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'), 运行时间: $((Get-Date) - $proc.StartTime)" "WARN"
                
                try {
                    Stop-Process -Id $proc.Id -Force -ErrorAction Stop
                    Write-Log "已终止进程 PID: $($proc.Id)" "INFO"
                    Start-Sleep -Seconds 2
                }
                catch {
                    Write-Log "终止进程失败: $($_.Exception.Message)" "WARN"
                }
            }
        }
    }
    
    # 多次检查进程是否完全终止
    for ($i = 1; $i -le 3; $i++) {
        $remaining = Get-Process -Name "claude" -ErrorAction SilentlyContinue
        if ($remaining.Count -eq 0) {
            Write-Log "claude 进程已全部终止" "INFO"
            break
        } else {
            Write-Log "仍有 $([array]$remaining.Count) 个 claude 进程存在，等待 $($i*2) 秒后重试..." "INFO"
            Start-Sleep -Seconds ($i * 2)
        }
    }
    
    # 检查目标文件是否仍然被锁定
    $targetExists = Test-Path $script:InstallPath
    if ($targetExists) {
        try {
            # 尝试访问文件以确认是否被锁定
            $fileInfo = Get-Item $script:InstallPath
            Write-Log "目标文件存在，最后一次写入: $($fileInfo.LastWriteTime)" "INFO"
        }
        catch {
            Write-Log "目标文件被锁定: $($_.Exception.Message)" "WARN"
        }
    }
    
    # 给系统一些时间来清理文件锁
    Start-Sleep -Seconds 2
}

# 主执行逻辑
function Main {
    if ($Help) {
        Show-Help
        return
    }

    try {
        Write-Log "=== Claude Code 自动更新脚本启动 ===" "SUCCESS"
        Write-Log "目标安装路径: $script:InstallPath"
        Write-Log "目标版本: $Target"
        Write-Log "平台架构: $Platform"
        Write-Log "安装目录: $(Split-Path -Path $script:InstallPath -Parent)"

        # 验证系统架构
        Validate-SystemArchitecture

        $targetVersion = Get-VersionInfo -Target $Target
        $backupPath = $null
        $tempFile = $null

        # 如果用户指定了特定版本号，直接走下载流程
        if ($Target -match '^\d+\.\d+\.\d+') {
            Write-Log "检测到指定版本，跳过版本比较，直接下载" "INFO"
        } else {
            # 非指定版本，执行原有检查逻辑
            $currentVersion = Get-CurrentVersion
            
            if ($currentVersion) {
                $comparison = Compare-Version -Version1 $targetVersion -Version2 $currentVersion

                if ($comparison -eq 0) {
                    Write-Log "版本 $currentVersion 已是最新版本" "SUCCESS"
                    if (-not $Force) {
                        Write-Log "如需强制更新，请使用 -Force 参数"
                        return
                    } else {
                        Write-Log "强制模式下，继续更新" "INFO"
                    }
                }
                elseif ($comparison -eq 1) {
                    Write-Log "发现新版本: $currentVersion -&gt; $targetVersion" "INFO"
                }
                else {
                    Write-Log "当前版本 $currentVersion 比目标版本 $targetVersion 更新" "WARN"
                    if (-not $Force) {
                        Write-Log "如需强制更新，请使用 -Force 参数"
                        return
                    }
                }

                # 尝试使用内建更新功能
                if (-not $Force -and $Target -ne "latest" -and $Target -ne "stable") {
                    Write-Log "尝试使用 claude update 功能..." "INFO"
                    $updateSuccess = Try-ClaudeUpdate -Target $Target
                    if ($updateSuccess) {
                        Create-Links -Version (Get-CurrentVersion)
                        Write-Log "=== Claude Code 更新完成 (使用内建更新) ===" "SUCCESS"
                        return
                    }
                }
            } else {
                Write-Log "未找到已安装版本，执行全新安装" "INFO"
            }
        }

        # 用户确认（仅对非指定版本）
        if (-not $Force -and -not ($Target -match '^\d+\.\d+\.\d+')) {
            $choice = Read-Host "是否继续下载并安装 Claude Code $targetVersion ? (y/N)"
            if ($choice -notmatch '^[Yy]$') {
                Write-Log "用户取消更新"
                return
            }
        }

        # 创建安装目录
        $installDirectory = Split-Path -Path $script:InstallPath -Parent
        if (-not (Test-Path $installDirectory)) {
            New-Item -ItemType Directory -Path $installDirectory -Force -ErrorAction Stop | Out-Null
            Write-Log "已创建安装目录: $installDirectory"
        }

        # 对于非指定版本的场景才备份
        if ($Target -notmatch '^\d+\.\d+\.\d+') {
            $currentVersion = Get-CurrentVersion
            if ($currentVersion) {
                $backupPath = Backup-CurrentClaude -CurrentVersion $currentVersion
            }
        }

        # 直接下载新版本
        Write-Log "开始下载文件..." "INFO"
        $tempFile = Download-Claude -Version $targetVersion -Platform $Platform

        try {
            Write-Log "正在安装到: $script:InstallPath"
            Check-And-KillClaudeProcess
            Start-Sleep -Seconds 2
            Copy-Item -Path $tempFile -Destination $script:InstallPath -Force -ErrorAction Stop

            if (Test-Path $script:InstallPath) {
                # 等待文件操作完成
                Start-Sleep -Seconds 2
                
                # 验证安装
                $newVersion = Get-CurrentVersion
                if ($newVersion -eq $targetVersion) {
                    Write-Log "Claude Code 更新安装成功！版本: $targetVersion" "SUCCESS"
                    
                    if ($backupPath) {
                        Write-Log "备份文件保存在: $backupPath" "INFO"
                    }

                    # 创建符号链接和环境变量
                    Create-Links -Version $targetVersion
                    Add-To-Path -PathToAdd $script:InstallPath
                } else {
                    throw "安装验证失败: 期望版本 $targetVersion, 实际版本 $newVersion"
                }
            } else {
                throw "文件复制失败"
            }
        }
        catch {
            Write-Log "安装失败: $($_.Exception.Message)" "ERROR"

            # 恢复备份
            if ($backupPath -and (Test-Path $backupPath)) {
                Write-Log "正在恢复备份..."
                Check-And-KillClaudeProcess
                Start-Sleep -Seconds 2
                Copy-Item -Path $backupPath -Destination $script:InstallPath -Force -ErrorAction SilentlyContinue
                Write-Log "已恢复到之前的版本" "WARN"
            }

            throw
        }
        finally {
            Cleanup-TempFiles -TempFile $tempFile
        }

        Write-Log "=== Claude Code 更新完成 ===" "SUCCESS"
        Write-Log "新版本: $targetVersion" "SUCCESS"
        Write-Log "请重新打开终端以使用新版本" "INFO"
    }
    catch {
        Write-Log "脚本执行失败: $($_.Exception.Message)" "ERROR"
        exit 1
    }
}


# 执行主函数
Main
</code></pre>
<h4 data-id="heading-4">引用</h4>
<ul>
<li>Github地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FShadowSmallBaby%2FOneToolkit.git" target="_blank" title="https://github.com/ShadowSmallBaby/OneToolkit.git" ref="nofollow noopener noreferrer">OneToolkit</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[git版本控制]git branch(详解)]]></title>    <link>https://juejin.cn/post/7600260767688376346</link>    <guid>https://juejin.cn/post/7600260767688376346</guid>    <pubDate>2026-01-29T05:18:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600260767688376346" data-draft-id="7600260767688294426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[git版本控制]git branch(详解)"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-01-29T05:18:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [git版本控制]git branch(详解)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:18:59.000Z" title="Thu Jan 29 2026 05:18:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我来为您详细介绍一下 <code>git branch</code> 命令。它是 Git 版本控制中最核心、最常用的命令之一，用于<strong>管理分支</strong>。</p>
<h2 data-id="heading-0">核心概念：什么是分支？</h2>
<p>在深入命令之前，理解“分支”的概念至关重要。</p>
<ul>
<li>分支就像一条独立的<strong>时间线</strong>或<strong>工作线</strong>。</li>
<li>默认情况下，每个 Git 仓库都有一个主时间线，叫做 <code>master</code> 或 <code>main</code> 分支。</li>
<li>你可以从任意时间点创建新的分支，在新分支上进行开发、实验或修复Bug，而不会影响到主分支。</li>
<li>分支之间可以自由切换、合并，这使得并行开发和版本管理变得非常灵活。</li>
</ul>
<p><code>git branch</code> 命令就是用来<strong>创建、列出、重命名和删除</strong>这些分支的工具。</p>
<hr/>
<h2 data-id="heading-1">命令详解及常用选项</h2>
<h5 data-id="heading-2">1. <strong>列出分支</strong></h5>
<p>这是最常用的功能，用于查看当前仓库的所有分支(只显示本地分支)。</p>
<pre><code class="hljs language-bash" lang="bash">git branch
</code></pre>
<ul>
<li>输出列表中，当前所在的分支前会有一个星号 <code>*</code>。</li>
<li>只显示本地分支。</li>
</ul>
<p><strong>查看更多信息</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch -v
<span class="hljs-comment"># 或</span>
git branch --verbose
</code></pre>
<ul>
<li>显示每个分支最后一次提交的提交哈希和提交信息。</li>
</ul>
<p><strong>查看所有分支（包括远程跟踪分支）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch -a
<span class="hljs-comment"># 或</span>
git branch --all
</code></pre>
<ul>
<li>本地分支会正常显示。</li>
<li>远程跟踪分支（如 <code>origin/main</code>）会以红色或特定颜色显示，通常前缀为 <code>remotes/</code>。</li>
</ul>
<p><strong>查看已合并/未合并到当前分支的分支</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch --merged    <span class="hljs-comment"># 查看已合并到当前分支的分支</span>
git branch --no-merged <span class="hljs-comment"># 查看未合并到当前分支的分支</span>
</code></pre>
<ul>
<li>这对于清理已完成功能的分支非常有用。</li>
</ul>
<h5 data-id="heading-3">2. <strong>创建分支</strong></h5>
<p>创建一个新的分支，但<strong>不会自动切换</strong>到该分支。</p>
<pre><code class="hljs language-bash" lang="bash">git branch &lt;branch-name&gt;
</code></pre>
<ul>
<li><strong>示例</strong>：<code>git branch feature-login</code></li>
<li>新分支会从你<strong>当前所在分支的最新提交（HEAD）</strong> 创建出来。</li>
<li>创建后，你仍然在当前分支, 并不会切换到新的分支"feature-login"</li>
</ul>
<p><strong>从特定提交创建分支</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch &lt;branch-name&gt; &lt;commit-hash&gt;
</code></pre>
<ul>
<li><strong>示例</strong>：<code>git branch hotfix abc1234</code></li>
<li>这在需要基于某个历史版本进行修复时非常有用。</li>
</ul>
<h5 data-id="heading-4">3. <strong>删除分支</strong></h5>
<p>当一个分支的工作已经完成并合并后，通常可以删除它。</p>
<p><strong>安全删除（如果分支已合并）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch -d &lt;branch-name&gt;
<span class="hljs-comment"># 或</span>
git branch --delete &lt;branch-name&gt;
</code></pre>
<ul>
<li>如果该分支的改动已经合并到其他分支，Git 会允许删除。</li>
<li>如果分支未合并，Git 会阻止删除，以防止数据丢失。</li>
</ul>
<p><strong>强制删除（无论是否合并）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch -D &lt;branch-name&gt;
</code></pre>
<ul>
<li><strong>谨慎使用！</strong> 这会直接删除分支及其所有未合并的提交。</li>
</ul>
<p><strong>删除远程跟踪分支（在本地清理）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git branch -d -r origin/&lt;branch-name&gt; <span class="hljs-comment"># 删除本地的远程跟踪引用</span>
</code></pre>
<ul>
<li>这并不会真正删除远程仓库的分支。要删除远程分支，需要使用：
<pre><code class="hljs language-bash" lang="bash">git push origin --delete &lt;branch-name&gt;
</code></pre>
</li>
</ul>
<h5 data-id="heading-5">4. <strong>重命名分支</strong></h5>
<pre><code class="hljs language-bash" lang="bash">git branch -m &lt;old-name&gt; &lt;new-name&gt; <span class="hljs-comment"># 重命名指定分支</span>
git branch -m &lt;new-name&gt;            <span class="hljs-comment"># 重命名当前分支</span>
</code></pre>
<ul>
<li><strong>示例</strong>：<code>git branch -m fix-typo feature-awesome</code></li>
</ul>
<h5 data-id="heading-6">5. <strong>设置跟踪关系</strong></h5>
<p>这是高级但重要的功能，将本地分支与远程分支关联起来。</p>
<pre><code class="hljs language-bash" lang="bash">git branch -u origin/&lt;remote-branch-name&gt;
<span class="hljs-comment"># 或</span>
git branch --set-upstream-to=origin/&lt;remote-branch-name&gt;
</code></pre>
<ul>
<li>设置后，在该分支上使用 <code>git push</code> 或 <code>git pull</code> 时，如果不指定参数，Git 就知道该推送到或从哪里拉取代码。</li>
<li>通常，在创建分支时使用 <code>git checkout -b &lt;branch&gt; origin/&lt;branch&gt;</code> 或 <code>git switch -c &lt;branch&gt; origin/&lt;branch&gt;</code> 会更方便地建立跟踪。</li>
</ul>
<hr/>
<h2 data-id="heading-7">与其他关键命令的协作</h2>
<p><code>git branch</code> 通常不单独使用，而是与以下命令紧密配合：</p>
<ol>
<li>
<p><strong><code>git checkout &lt;branch-name&gt;</code></strong> 或 <strong><code>git switch &lt;branch-name&gt;</code></strong>：</p>
<ul>
<li><code>git branch</code> 创建分支，<code>git checkout/switch</code> 切换分支。</li>
<li><strong>组合技（创建并切换）</strong>：
<pre><code class="hljs language-bash" lang="bash">git checkout -b &lt;new-branch-name&gt;
<span class="hljs-comment"># 或（更语义化）</span>
git switch -c &lt;new-branch-name&gt;
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>git merge &lt;branch-name&gt;</code></strong>：</p>
<ul>
<li>将指定分支的修改合并到<strong>当前分支</strong>。</li>
<li>完成功能开发后，你会切回 <code>main</code> 分支，然后执行 <code>git merge feature-xxx</code>。</li>
</ul>
</li>
<li>
<p><strong><code>git push</code></strong>：</p>
<ul>
<li>将本地分支推送到远程仓库，与团队共享。</li>
<li><strong>首次推送新分支</strong>：<code>git push -u origin &lt;branch-name&gt;</code> （<code>-u</code> 参数会同时设置跟踪关系）。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-8">典型工作流示例</h2>
<p>假设你要开发一个新功能：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确保在主分支，并获取最新代码</span>
git checkout main       <span class="hljs-comment"># 在本地切换到主分支main</span>
git pull origin main    <span class="hljs-comment"># 获取最新的代码</span>

<span class="hljs-comment"># 2. 创建并切换到功能分支</span>
git checkout -b feature-user-profile  <span class="hljs-comment"># 创建一个新分支, 用于本次的修改和迭代</span>

<span class="hljs-comment"># 3. 进行开发，多次提交...</span>
git add .
git commit -m <span class="hljs-string">"完成用户头像上传功能"</span>

<span class="hljs-comment"># 4. 将分支推送到远程（首次）-u的作用是建立上游关系, upstream</span>
git push -u origin feature-user-profile

<span class="hljs-comment"># 5. 功能完成后，在主分支上进行合并</span>
git checkout main
git pull origin main <span class="hljs-comment"># 再次确保最新的代码</span>
git merge feature-user-profile  <span class="hljs-comment">#  把新分支的开发, 合并到main分支上来.</span>
git push origin main     <span class="hljs-comment"># 推到远程的仓库</span>

<span class="hljs-comment"># 6. （可选）删除本地和远程的功能分支</span>
git branch -d feature-user-profile
git push origin --delete feature-user-profile
</code></pre>
<h2 data-id="heading-9">总结：<code>git branch</code> 常用命令速查表</h2>













































<table><thead><tr><th align="left">命令</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left"><code>git branch</code></td><td align="left">列出本地分支</td></tr><tr><td align="left"><code>git branch -a</code></td><td align="left">列出所有分支（本地+远程）</td></tr><tr><td align="left"><code>git branch &lt;name&gt;</code></td><td align="left">创建新分支（不切换）</td></tr><tr><td align="left"><code>git branch -d &lt;name&gt;</code></td><td align="left">安全删除分支（已合并）</td></tr><tr><td align="left"><code>git branch -D &lt;name&gt;</code></td><td align="left">强制删除分支（未合并）</td></tr><tr><td align="left"><code>git branch -m &lt;new-name&gt;</code></td><td align="left">重命名<code>当前分支</code></td></tr><tr><td align="left"><code>git branch --merged</code></td><td align="left">查看已合并分支</td></tr><tr><td align="left"><code>git checkout -b &lt;name&gt;</code></td><td align="left"><strong>创建并切换</strong>到新分支（经典）</td></tr><tr><td align="left"><code>git switch -c &lt;name&gt;</code></td><td align="left"><strong>创建并切换</strong>到新分支（推荐）</td></tr></tbody></table>
<p>理解并熟练使用 <code>git branch</code> 是掌握 Git 工作流的基础，它让你能安全、高效地在不同任务间并行工作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go公链实战0x05交易（1）]]></title>    <link>https://juejin.cn/post/7600489282822881330</link>    <guid>https://juejin.cn/post/7600489282822881330</guid>    <pubDate>2026-01-29T05:22:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282822881330" data-draft-id="6845075572612136968" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go公链实战0x05交易（1）"/> <meta itemprop="keywords" content="后端,Go,区块链"/> <meta itemprop="datePublished" content="2026-01-29T05:22:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="chaors"/> <meta itemprop="url" content="https://juejin.cn/user/272334613646695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go公链实战0x05交易（1）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334613646695/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    chaors
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:22:38.000Z" title="Thu Jan 29 2026 05:22:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>区块链区块的作用是打包链上产生的交易,可以说交易是区块链至关重要的一个组成部分.在区块链中,交易一旦被创建，就没有任何人能够再去修改或是删除它.</p>
<p>关于交易的结构,可以参照以前的这篇:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2F3447aab7e864" target="_blank" title="https://www.jianshu.com/p/3447aab7e864" ref="nofollow noopener noreferrer">比特币源码研读(3)数据结构-交易Transaction</a></p>
<p>我们之前定义的区块结构简单地用一个字符串描述交易内容,今后将正式用新的结构来表示交易:</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Block <span class="hljs-keyword">struct</span> {
	<span class="hljs-comment">//1.区块高度</span>
	Height <span class="hljs-type">int64</span>
	<span class="hljs-comment">//2.上一个区块HAsh</span>
	PrevBlockHash []<span class="hljs-type">byte</span>
	<span class="hljs-comment">//3.交易数据</span>
	<span class="hljs-comment">//Data []byte    //只前简单地对交易的描述</span>
        Txs [] *Transaction   <span class="hljs-comment">//Transaction结构数组表示交易</span>
	<span class="hljs-comment">//4.时间戳</span>
	Timestamp <span class="hljs-type">int64</span>
	<span class="hljs-comment">//5.Hash</span>
	Hash []<span class="hljs-type">byte</span>
	<span class="hljs-comment">//6.Nonce  符合工作量证明的随机数</span>
	Nonce <span class="hljs-type">int64</span>
}
</code></pre>
<h3 data-id="heading-0">Transaction结构</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Transaction <span class="hljs-keyword">struct</span> {
	<span class="hljs-comment">//1.交易哈希值</span>
	TxHAsh []<span class="hljs-type">byte</span>
	<span class="hljs-comment">//2.交易输入</span>
	Vins []*TXInput
	<span class="hljs-comment">//3.交易输出</span>
	Vouts []*TXOutput
}
</code></pre>
<h3 data-id="heading-1">TXInput</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> TXInput <span class="hljs-keyword">struct</span> {
	<span class="hljs-comment">//交易ID 引用上一笔交易输出作为输入</span>
	TxHash []<span class="hljs-type">byte</span>
	<span class="hljs-comment">//存储TXOutput在Vout里的索引</span>
	Vout <span class="hljs-type">int</span>
	<span class="hljs-comment">//数字签名  暂时可理解为用户名</span>
	ScriptSig <span class="hljs-type">string</span>
}
</code></pre>
<p>交易输入作为本次交易的消费源,输入来源于之前交易的输出.如上,TxHash是引用的上一笔输出所在的交易的交易哈希;Vout是该输出在相应交易中的输出索引;ScriptSig,可以暂时理解为用户名,表示哪一个用户拥有这一笔输入.ScriptSig的设定是为了保证用户只能话费自己名下的代币.</p>
<h3 data-id="heading-2">TXOutput</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> TXOutput <span class="hljs-keyword">struct</span> {
	<span class="hljs-comment">//面值</span>
	Value <span class="hljs-type">int64</span>
	<span class="hljs-comment">//暂时理解为用户名</span>
	ScriptPubKey <span class="hljs-type">string</span>
}
</code></pre>
<p>这里的交易输出就是上面交易输入里引用的输出.Value是该输出的面值,ScriptPubKey暂时理解为用户名,表示谁将拥有这笔输出.</p>
<p>了解比特币的人都知道,交易输出是一个完整的不可分割的结构.什么意思呢?就是我们在引用TXOutput,必须全部引用,不能仅仅使用其一部分.举个简单的🌰:</p>
<p>假如你有一个25btc的TXOutput,你需要花费10btc.这个交易的过程并不是:你花费了25btc中的10btc,你的原有TXOutput依旧有15btc的余额.真正的过程是,你花费了整个原有的TXOutput,由于消费额不匹配,这里会产生一个15btc的找零.消费的结果是:你25btc的TXOutput被话费已不复存在,系统重新为你生成一个15btc面值的TXOutput.这两个TXOutput是完全不同的两个对象!!!</p>
<h3 data-id="heading-3">CoinbaseTransaction</h3>
<p>我们知道,当矿工成功挖到一个区块时会获得一笔奖励.那么这笔奖励是怎么交付到矿工账户的.这就有赖于一笔叫做创币交易的交易.</p>
<p>创币交易是区块内的第一笔交易,它负责将系统产生的奖励给挖出区块的矿工.由于它并不是普通意义上的转账,所以交易输入里并不需要引用任何一笔交易输出.</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//创建创币交易</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewCoinbaseTransaction</span><span class="hljs-params">(address <span class="hljs-type">string</span>)</span></span> *Transaction {

	<span class="hljs-comment">//交易输入  由于区块第一笔交易其实没有输入，所以交易哈希传空，TXOutput索引传-1，签名随你</span>
	txInput := &amp;TXInput{
		[]<span class="hljs-type">byte</span>{},
		<span class="hljs-number">-1</span>,
		<span class="hljs-string">"CoinbaseTransaction"</span>,
	}

	<span class="hljs-comment">//交易输出  产生一笔奖励给挖矿者address</span>
	txOutput := &amp;TXOutput{<span class="hljs-number">25</span>, address}
	txCoinbase := &amp;Transaction{
		[]<span class="hljs-type">byte</span>{},	<span class="hljs-comment">//暂时将交易哈希置空</span>
		[]*TXInput{txInput},
		[]*TXOutput{txOutput},
	}
		
	<span class="hljs-comment">//交易哈希的计算</span>
	txCoinbase.HashTransactions()

	<span class="hljs-keyword">return</span> txCoinbase
}
</code></pre>
<h3 data-id="heading-4">HashTransactions</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//将交易信息转换为字节数组</span>
func (tx *Transaction) <span class="hljs-built_in">HashTransactions</span>() {

	<span class="hljs-comment">//交易信息序列化</span>
	<span class="hljs-selector-tag">var</span> result bytes<span class="hljs-selector-class">.Buffer</span>
	encoder := gob.<span class="hljs-built_in">NewEncoder</span>(&amp;result)

	err := encoder.<span class="hljs-built_in">Encode</span>(tx)
	if err != nil {

		log<span class="hljs-selector-class">.Panic</span>(err)
	}

	<span class="hljs-comment">//设置hash</span>
	txHash := sha256.<span class="hljs-built_in">Sum256</span>(result.<span class="hljs-built_in">Bytes</span>())
	tx.TxHAsh = txHash[:]
}
</code></pre>
<h3 data-id="heading-5">NewBlock改动</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//1.创建新的区块</span>
func <span class="hljs-built_in">NewBlock</span>(txs []*Transaction, height int64, prevBlockHash []byte) *Block {

	<span class="hljs-comment">//创建区块</span>
	block := &amp;Block{
		<span class="hljs-attribute">Height</span>:        height,
		PrevBlockHash: prevBlockHash,
		Txs:           txs,
		Timestamp:     time.<span class="hljs-built_in">Now</span>().<span class="hljs-built_in">Unix</span>(),
		Hash:          nil,
		Nonce:         <span class="hljs-number">0</span>}

	<span class="hljs-comment">//调用工作量证明返回有效的Hash</span>
	pow := <span class="hljs-built_in">NewProofOfWork</span>(block)
	hash, nonce := pow.<span class="hljs-built_in">Run</span>()
	block.Hash = hash[:]
	block.Nonce = nonce

	fmt.<span class="hljs-built_in">Printf</span>(<span class="hljs-string">"\r######%d-%x\n"</span>, nonce, hash)

	return block
}
</code></pre>
<h3 data-id="heading-6">CreateBlockchainWithGensisBlock改动</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//1.创建创世区块</span>
func <span class="hljs-built_in">CreateBlockchainWithGensisBlock</span>(address string) {

	<span class="hljs-comment">//判断数据库是否存在</span>
	if <span class="hljs-built_in">IsDBExists</span>(dbName) {

		fmt<span class="hljs-selector-class">.Println</span>("创世区块已存在...")
		os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)

		<span class="hljs-comment">//创建并打开数据库</span>
		db, err := bolt.<span class="hljs-built_in">Open</span>(dbName, <span class="hljs-number">0600</span>, nil)
		if err != nil {
			log<span class="hljs-selector-class">.Fatal</span>(err)
		}

		<span class="hljs-selector-tag">var</span> block *Block
		err = db<span class="hljs-selector-class">.View</span>(func(tx *bolt.Tx) error {

			<span class="hljs-selector-tag">b</span> := tx.<span class="hljs-built_in">Bucket</span>([]<span class="hljs-built_in">byte</span>(blockTableName))
			if b != nil {

				hash := b.<span class="hljs-built_in">Get</span>([]<span class="hljs-built_in">byte</span>(newestBlockKey))
				block = <span class="hljs-built_in">DeSerializeBlock</span>(b.<span class="hljs-built_in">Get</span>(hash))
				fmt.<span class="hljs-built_in">Printf</span>(<span class="hljs-string">"\r######%d-%x\n"</span>, block.Nonce, hash)
			}

			return nil
		})
		if err != nil {

			log<span class="hljs-selector-class">.Panic</span>(err)
		}

		os<span class="hljs-selector-class">.Exit</span>(<span class="hljs-number">1</span>)
	}

	fmt<span class="hljs-selector-class">.Println</span>("正在创建创世区块...")

	<span class="hljs-comment">//创建并打开数据库</span>
	db, err := bolt.<span class="hljs-built_in">Open</span>(dbName, <span class="hljs-number">0600</span>, nil)
	if err != nil {
		log<span class="hljs-selector-class">.Fatal</span>(err)
	}
	err = db<span class="hljs-selector-class">.Update</span>(func(tx *bolt.Tx) error {

		<span class="hljs-selector-tag">b</span>, err := tx.<span class="hljs-built_in">CreateBucket</span>([]<span class="hljs-built_in">byte</span>(blockTableName))
		if err != nil {

			log<span class="hljs-selector-class">.Panic</span>(err)
		}

		if <span class="hljs-selector-tag">b</span> != nil {

			<span class="hljs-comment">//创币交易</span>
			txCoinbase := <span class="hljs-built_in">NewCoinbaseTransaction</span>(address)
			//创世区块
			gensisBlock := <span class="hljs-built_in">CreateGenesisBlock</span>([]*Transaction{txCoinbase})
			<span class="hljs-comment">//存入数据库</span>
			err := b.<span class="hljs-built_in">Put</span>(gensisBlock.Hash, gensisBlock.<span class="hljs-built_in">Serialize</span>())
			if err != nil {
				log<span class="hljs-selector-class">.Panic</span>(err)
			}

			<span class="hljs-comment">//存储最新区块hash</span>
			err = <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.Put</span>([]byte(newestBlockKey), gensisBlock<span class="hljs-selector-class">.Hash</span>)
			if err != nil {
				log<span class="hljs-selector-class">.Panic</span>(err)
			}
		}

		return nil
	})
	<span class="hljs-comment">//更新数据库失败</span>
	if err != nil {
		log<span class="hljs-selector-class">.Fatal</span>(err)
	}
}
</code></pre>
<h3 data-id="heading-7">POW/prepareData改动</h3>
<p>添加交易后,POW挖矿时也必须相应地把交易信息考虑进去.这里需要改动prepareData方法</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//拼接区块属性，返回字节数组</span>
func (pow *ProofOfWork) <span class="hljs-built_in">prepareData</span>(nonce int) <span class="hljs-selector-attr">[]</span>byte {

	data := bytes.<span class="hljs-built_in">Join</span>(
		[][]byte{
			pow<span class="hljs-selector-class">.Block</span><span class="hljs-selector-class">.PrevBlockHash</span>,
			pow<span class="hljs-selector-class">.Block</span><span class="hljs-selector-class">.HashTransactions</span>(),
			<span class="hljs-built_in">IntToHex</span>(pow.Block.Timestamp),
			<span class="hljs-built_in">IntToHex</span>(int64(targetBits)),
			<span class="hljs-built_in">IntToHex</span>(int64(nonce)),
			<span class="hljs-built_in">IntToHex</span>(int64(pow.Block.Height)),
		},
		<span class="hljs-selector-attr">[]</span>byte{},
	)

	return data
}
</code></pre>
<p>这里POW计算目标哈希并不需要将所有的交易信息拼接,我们只需要将每一个交易的交易哈希拼接起来即可.因为,交易哈希是交易所有信息的哈希值.这样做也能保证交易信息的完整性.所以,我们需要在Block新增一个方法:</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//将交易信息转换为字节数组</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(block *Block)</span></span> HashTransactions() []<span class="hljs-type">byte</span>  {

	<span class="hljs-keyword">var</span> txHashes [][]<span class="hljs-type">byte</span>
	<span class="hljs-keyword">var</span> txHash [<span class="hljs-number">32</span>]<span class="hljs-type">byte</span>

	<span class="hljs-keyword">for</span> _, tx := <span class="hljs-keyword">range</span> block.Txs {

		txHashes = <span class="hljs-built_in">append</span>(txHashes, tx.TxHAsh)
	}

	txHash = sha256.Sum256(bytes.Join(txHashes, []<span class="hljs-type">byte</span>{}))

	<span class="hljs-keyword">return</span> txHash[:]
}
</code></pre>
<h3 data-id="heading-8">Printchain添加交易信息打印</h3>
<p>现在,整个交易的数据结构就搭起来了.我们再改动区块链打印方法,将区块的交易信息添加到打印.</p>
<pre><code class="hljs language-erlang" lang="erlang">//<span class="hljs-number">3</span>.X 优化区块链遍历方法
<span class="hljs-function"><span class="hljs-title">func</span> <span class="hljs-params">(blc *Blockchain)</span> P<span class="hljs-title">rintchain</span><span class="hljs-params">()</span> {
	//迭代器
	<span class="hljs-title">blcIterator</span> := <span class="hljs-title">blc</span>.I<span class="hljs-title">terator</span><span class="hljs-params">()</span>
	<span class="hljs-title">for</span> {

		<span class="hljs-title">block</span> := <span class="hljs-title">blcIterator</span>.N<span class="hljs-title">ext</span><span class="hljs-params">()</span>

		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintln</span><span class="hljs-params">(<span class="hljs-string">"------------------------------"</span>)</span>
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Height：%d\n"</span>, block.Height)</span>
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"PrevBlockHash：%x\n"</span>, block.PrevBlockHash)</span>
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Timestamp：%s\n"</span>, time.Unix(block.Timestamp, <span class="hljs-number">0</span>)</span>.F<span class="hljs-title">ormat</span><span class="hljs-params">(<span class="hljs-string">"2006-01-02 03:04:05 PM"</span>)</span>)
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Hash：%x\n"</span>, block.Hash)</span>
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Nonce：%d\n"</span>, block.Nonce)</span>
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintln</span><span class="hljs-params">(<span class="hljs-string">"Txs:"</span>)</span>
		<span class="hljs-title">for</span> _,<span class="hljs-title">tx</span> := <span class="hljs-title">range</span> <span class="hljs-title">block</span>.T<span class="hljs-title">xs</span> {

			<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"%x\n"</span>, tx.TxHAsh)</span>
			<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintln</span><span class="hljs-params">(<span class="hljs-string">"Vins:"</span>)</span>
			<span class="hljs-title">for</span> _,<span class="hljs-title">in</span> := <span class="hljs-title">range</span> <span class="hljs-title">tx</span>.V<span class="hljs-title">ins</span>  {
				<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"txHash:%x\n"</span>, in.TxHash)</span>
				<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Vout:%d\n"</span>, in.Vout)</span>
				<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"ScriptSig:%s\n\n"</span>, in.ScriptSig)</span>
			}

			<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintln</span><span class="hljs-params">(<span class="hljs-string">"Vouts:"</span>)</span>
			<span class="hljs-title">for</span> _,<span class="hljs-title">out</span> := <span class="hljs-title">range</span> <span class="hljs-title">tx</span>.V<span class="hljs-title">outs</span>  {
				<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"Value:%x\n"</span>, out.Value)</span>
				<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintf</span><span class="hljs-params">(<span class="hljs-string">"ScriptPubKey:%x\n\n"</span>, out.ScriptPubKey)</span>
			}
		}
		<span class="hljs-title">fmt</span>.P<span class="hljs-title">rintln</span><span class="hljs-params">(<span class="hljs-string">"------------------------------"</span>)</span>

		<span class="hljs-title">var</span> <span class="hljs-title">hashInt</span> <span class="hljs-title">big</span>.I<span class="hljs-title">nt</span>
		<span class="hljs-title">hashInt</span>.S<span class="hljs-title">etBytes</span><span class="hljs-params">(block.PrevBlockHash)</span>

		<span class="hljs-title">if</span> <span class="hljs-title">big</span>.N<span class="hljs-title">ewInt</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span>.C<span class="hljs-title">mp</span><span class="hljs-params">(&amp;hashInt)</span> == 0 {

			<span class="hljs-title">break</span>
		}
	}
}
</span></code></pre>
<h3 data-id="heading-9">Main_Test</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"chaors.com/LearnGo/publicChaorsChain/part7-transaction-Prototype/BLC"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {

	cli := BLC.CLI{}
	cli.Run()
}
</code></pre>
<p>打印创世区块的结果为:</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/7/10/16484b583b85666d~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.awebp#?w=1240&amp;h=530&amp;s=253184&amp;e=png&amp;b=2c2c2c" alt="main_test" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchaors%2FPublicBlockChain_go" target="_blank" title="https://github.com/chaors/PublicBlockChain_go" ref="nofollow noopener noreferrer">源代码</a>在这,喜欢的朋友记得给个小star，或者fork.也欢迎大家一起探讨区块链相关知识，一起进步！</p>
<h3 data-id="heading-10">更多原创区块链技术文章请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fu%2Fa46bd6ade353" target="_blank" title="https://www.jianshu.com/u/a46bd6ade353" ref="nofollow noopener noreferrer">chaors</a></h3>
<p>.
.
.
.</p>
<blockquote>
<p>###互联网颠覆世界，区块链颠覆互联网!</p>
</blockquote>
<blockquote>
<h6 data-id="heading-11">---------------------------------------------20180703 20:40</h6>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Python版 2026 从零学Langchain 1.x】（二）结构化输出和工具调用]]></title>    <link>https://juejin.cn/post/7600333405979312169</link>    <guid>https://juejin.cn/post/7600333405979312169</guid>    <pubDate>2026-01-29T05:26:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600333405979312169" data-draft-id="7600491179498750006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Python版 2026 从零学Langchain  1.x】（二）结构化输出和工具调用"/> <meta itemprop="keywords" content="Python,LangChain,Agent"/> <meta itemprop="datePublished" content="2026-01-29T05:26:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂踩坑人"/> <meta itemprop="url" content="https://juejin.cn/user/1011206430698574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Python版 2026 从零学Langchain  1.x】（二）结构化输出和工具调用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1011206430698574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂踩坑人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:26:02.000Z" title="Thu Jan 29 2026 05:26:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🔥本系列文章（文章末尾附录了代码和TS版本文章）：<br/>
<a href="https://juejin.cn/post/7599708108622364723" target="_blank" title="https://juejin.cn/post/7599708108622364723">【Python版 2026 从零学Langchain 1.x】（一）快速开始和LCEL</a><br/>
<a href="https://juejin.cn/spost/7600333405979312169" target="_blank" title="https://juejin.cn/spost/7600333405979312169">【Python版 2026 从零学Langchain  1.x】（二）结构化输出和工具调用</a></p>
<h2 data-id="heading-0">一、结构化输出 - Structured</h2>
<h3 data-id="heading-1">1. 概念介绍</h3>
<p>这里的结构化输出主要是指大模型可以输出符合要求的JSON数据，JSON数据的正确分两方面来看：</p>
<ul>
<li>JSON格式正确。比如<code>{"count":1}</code>正确，而<code>{"count":1</code>不正确。</li>
<li>JSON的字段语义正确。比如定义了count字段为数值，那么<code>{"count":1}</code>正确，而<code>{"count":"一"}</code>不正确。</li>
</ul>
<p><code>Langchain</code>（python）提供了- <code>Pydantic</code>、 <code>TypedDict</code>、 <code>JSON Schema</code> 三种方式来定义结构，常用的是<code>Pydantic</code>.</p>
<p>但是早期模型其实不支持JSON格式化输出（API层不提供支持），所以早期的Langchain是通过注入指令/提示词 + 正则提取的方式实现。</p>
<p>到2026年了，很多主流模型都是支持格式化输出了，几乎成了一种标准能力。</p>
<h3 data-id="heading-2">2. 返回对象（词典）</h3>
<p>🌰例子：我想要了解某个电影的信息，并期望以结构化的数据返回。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> app.config <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> HumanMessage, AIMessage, SystemMessage
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

model = ChatOpenAI(
    model=settings.glm_model,
    base_url=settings.siliconflow_base_url,
    api_key=settings.siliconflow_api_key,
    temperature=<span class="hljs-number">0.9</span>,
    max_tokens=<span class="hljs-number">3000</span>,
    timeout=<span class="hljs-number">60</span>,
    verbosity=<span class="hljs-literal">True</span>
)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Movie</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""电影的相关信息"""</span>
    title: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"电影名称"</span>)
    year: <span class="hljs-built_in">int</span> = Field(..., description=<span class="hljs-string">"电影上映时间"</span>)
    director: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"电影的导演"</span>)
    rating: <span class="hljs-built_in">float</span> = Field(..., description=<span class="hljs-string">"电影的豆瓣评分"</span>)

model_with_structure = model.with_structured_output(Movie)
response = model_with_structure.invoke(<span class="hljs-string">"介绍下电影《罗小黑战记2》"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(response)) &lt;<span class="hljs-keyword">class</span> <span class="hljs-string">'__main__.Movie'</span>&gt;
<span class="hljs-built_in">print</span>(response)  <span class="hljs-comment"># title='电影《罗小黑战记2》的最新情况' year=2024 director='不思凡 / MTJJ (疑似联合执导)' rating=5.0</span>
</code></pre>
<p>可以看出，我的提示词里面并没有要求LLM如何提取信息，但是返回结果却是按照我给的Pydantic模型定义提取了信息，最终返回一个Pydantic对象。 （P.S. 这里的代码，langchain可没有去做增强我们的提示词的事哦，而是把结构化输出的任务交给了LLM provider）</p>
<p>现在主流LLM都支持结构化输出，看看<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Fstructured-outputs%3Fapi-mode%3Dchat%23examples" target="_blank" title="https://platform.openai.com/docs/guides/structured-outputs?api-mode=chat#examples" ref="nofollow noopener noreferrer">openAI的文档</a>，这些LLM provider内部会做工程化，完成结构化输出这个能力，并提供API。</p>
<p>LLM provider内部工程化，会使用提示词要求大模型按"格式"输出。此外，一方面对大模型加掩码控制一些不合法的输出，另一方面对输出的结果进行校验（如果不满足pydantic的校验，则反馈错误给大模型重试）</p>
<p>最终提取的信息准确度，取决于提示词和LLM的能力。这里如果把提示词换成<code>介绍下电影《罗小黑战记2》，获取title、year、director、rating信息</code> 效果会更好点。</p>
<p>在代码顶部加上下面代码，打印所有的调用日志信息</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.<span class="hljs-built_in">globals</span> <span class="hljs-keyword">import</span> set_debug

<span class="hljs-comment"># 开启全局详细模式</span>
set_debug(<span class="hljs-literal">True</span>)
</code></pre>
<p>另外，我还做了下实验：下面是我用deepseek v3.2 作为LLM, 跑上面代码，打印的中间信息，可以看出LLM返回了一个序列化的JSON数据（title重复了，说明deepseek v3.2在结构化输出这方面能力还是较差）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8244125407ee4ba08157a1950fe77558~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269394&amp;x-signature=UWPR3lj4QY%2FAMGU6WV17KlesBlQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">3. 返回列表结构</h3>
<p>🌰例子：我希望LLM对我的需求拆分成任务列表。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> app.config <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field, RootModel
<span class="hljs-keyword">from</span> langchain_core.<span class="hljs-built_in">globals</span> <span class="hljs-keyword">import</span> set_debug

<span class="hljs-comment"># 开启全局详细模式</span>
set_debug(<span class="hljs-literal">True</span>)


model = ChatOpenAI(
    model=settings.glm_model,
    base_url=settings.siliconflow_base_url,
    api_key=settings.siliconflow_api_key,
    temperature=<span class="hljs-number">0.9</span>,
    max_tokens=<span class="hljs-number">3000</span>,
    timeout=<span class="hljs-number">60</span>,
)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DevProcessList</span>(RootModel[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]]):
    <span class="hljs-string">"""按顺序的软件开发流程字符串列表"""</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_structure_list</span>():
    model_with_structure = model.with_structured_output(DevProcessList)
    response = model_with_structure.invoke(
        [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"软件开发的流程是？请给我一个有顺序的字符串列表"</span>}], 
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(response)) <span class="hljs-comment"># &lt;class '__main__.DevProcessList'&gt;</span>
    <span class="hljs-built_in">print</span>(response.model_dump()) <span class="hljs-comment"># ['需求分析', '系统设计', '编码实现', '软件测试', '部署发布', '运维维护']</span>
</code></pre>
<p>你可以看出<code>model.with_structured_output</code>这种方式，LLM是严格返回列表（序列化的json）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3266cbfbc5147f28e2709239df080aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269394&amp;x-signature=unKG1HRZqL6XKeyokAjHTUO5efg%3D" alt="image.png" loading="lazy"/></p>
<p>还有种方式，很多教程都有提到——<code>PydanticOutputParser</code>，核心代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> PydanticOutputParser

model_with_structure = model | PydanticOutputParser(pydantic_object=DevProcessList)
    response = model_with_structure.invoke(
        [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"软件开发的流程是？请给我一个有顺序的字符串列表"</span>}], 
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(response)) <span class="hljs-comment"># &lt;class '__main__.DevProcessList'&gt;</span>
    <span class="hljs-built_in">print</span>(response.model_dump()) <span class="hljs-comment"># ['需求分析', '系统设计', '编码实现', '软件测试', '部署发布', '运维维护']</span>
</code></pre>
<p>LLM的实际输出如下，并不是一个序列化的JSON。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d38d3e8be3834e39b17aa7b5f336f922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269394&amp;x-signature=Cm15uTCwnBh1LBcTJUUsNBReqBo%3D" alt="image.png" loading="lazy"/></p>
<p>但是langchain还是能正确给我们返回 一个 列表。 原因在于<code>PydanticOutputParser</code>解析器，解析器会在用户提示词注入格式化指令（也是提示词），然后对结构进行正则匹配拿到列表/pydantic对象。
而<code>model.with_structured_output</code>则是通过LLM provider提供的API参数，明确获取结构化数据（几乎100%可靠）</p>
<p><code>langchain_core</code> 提供了4种结构化输出的解析器<code>CommaSeparatedListOutputParser</code>、<code>StructuredOutputParser</code>、
<code>JsonOutputParser</code>、<code>PydanticOutputParser</code> 。
这些解析器都依赖langchain的指令注入和正则匹配，可靠性一般，生产环境更推荐<code>model.with_structured_output</code>。</p>
<p>P.S 关于列表生成，更推荐使用<code>PydanticOutputParser</code> ，而不是<code>CommaSeparatedListOutputParser</code>，因为<code>CommaSeparatedListOutputParser</code>是langchain根据逗号进行分割和去空格的方式，准确性会存在问题，比如下面：</p>
<ul>
<li>LLM的返回：</li>
</ul>

<pre><code class="hljs language-swift" lang="swift"><span class="hljs-string">"text"</span>: <span class="hljs-string">"以下是标准软件开发流程（SDLC）的字符串列表：<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>1. 需求分析<span class="hljs-subst">\n</span>2. 系统设计<span class="hljs-subst">\n</span>3. 开发实施<span class="hljs-subst">\n</span>4. 软件测试<span class="hljs-subst">\n</span>5. 部署上线<span class="hljs-subst">\n</span>6. 运维与迭代"</span>
</code></pre>
<ul>
<li>langchain解析后返回：</li>
</ul>
<pre><code class="hljs language-python" lang="python">[<span class="hljs-string">'以下是标准软件开发流程（SDLC）的字符串列表：'</span>, <span class="hljs-string">'1. 需求分析'</span>, <span class="hljs-string">'2. 系统设计'</span>, <span class="hljs-string">'3. 开发实施'</span>, <span class="hljs-string">'4. 软件测试'</span>, <span class="hljs-string">'5. 部署上线'</span>, <span class="hljs-string">'6. 运维与迭代'</span>]
</code></pre>
<h3 data-id="heading-4">4. agent的结构化输出策略</h3>
<p>在 LangChain（尤其是在较新版本的 <code>create_agent</code> 或 LangGraph 架构中）中，<code>ToolStrategy</code> 和 <code>ProviderStrategy</code> 是实现**结构化输出（Structured Output）**的两种核心策略。</p>
<p>简单来说，它们的区别在于“是利用模型原生的结构化能力，还是通过‘欺骗’模型调用工具来间接实现结构化”。</p>
<p><code>create_agent</code>的参数response_format 支持下面4个类型值：</p>
<ul>
<li><code>ProviderStrategy</code> 使用提供者原生的结构化输出</li>
<li><code>ToolStrategy</code> 使用工具调用以获得结构化输出</li>
<li><code>type</code> 模式类型 - 根据模型能力自动选择最佳策略</li>
<li><code>None</code> 无格式化要求（默认）</li>
</ul>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContactInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""Contact information for a person."""</span>
    name: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The name of the person"</span>)
    email: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The email address of the person"</span>)
    phone: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The phone number of the person"</span>)

<span class="hljs-comment"># 自动选择策略（推荐）：</span>
agent = create_agent(model, tools, response_format=ContactInfo) 

<span class="hljs-comment"># 使用模型原生提供的，前提是模型API支持</span>
agent = create_agent(model, tools, response_format=ProviderStrategy(ContactInfo)) 

<span class="hljs-comment"># 强制使用 ToolStrategy：</span>
<span class="hljs-keyword">from</span> langchain.agents.structured_output <span class="hljs-keyword">import</span> ToolStrategy
agent = create_agent(model, tools, response_format=ToolStrategy(ContactInfo))
</code></pre>
<h4 data-id="heading-5">ToolStrategy vs. ProviderStrategy 的区别</h4>



































<table><thead><tr><th align="left">维度</th><th align="left">ToolStrategy (工具策略)</th><th align="left">ProviderStrategy (厂商原生策略)</th></tr></thead><tbody><tr><td align="left"><strong>实现机制</strong></td><td align="left"><strong>模拟工具调用</strong>：将你需要的输出 Schema 包装成一个“虚构工具”，让模型去调用它。</td><td align="left"><strong>原生 API 支持</strong>：直接利用模型厂商提供的结构化输出功能（如 OpenAI 的 JSON Mode 或 Strict Mode）。</td></tr><tr><td align="left"><strong>兼容性</strong></td><td align="left"><strong>极高</strong>：只要模型支持工具调用（Function Calling），就能使用。</td><td align="left"><strong>有限</strong>：仅支持提供原生结构化接口的厂商（如 OpenAI, Anthropic, Google）。</td></tr><tr><td align="left"><strong>可靠性</strong></td><td align="left">中等：依赖模型对工具参数的遵循能力。</td><td align="left"><strong>最高</strong>：厂商在模型底层和 API 层做了强校验，输出更稳定。</td></tr><tr><td align="left"><strong>使用场景</strong></td><td align="left">模型不支持原生结构化输出，或需要高度通用的代码实现时。</td><td align="left">追求最高成功率和严谨的 Schema 校验时。</td></tr><tr><td align="left"><strong>默认行为</strong></td><td align="left">在模型不支持原生结构化时作为备选方案（Fallback）。</td><td align="left">LangChain 在识别到支持的模型时会默认优先选择。</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-6">选择建议</h4>
<ul>
<li><strong>什么时候用 ProviderStrategy？</strong>
只要你的模型支持（如 GPT-4o, Claude 3.5 Sonnet），<strong>永远优先使用 ProviderStrategy</strong>。它在底层有更强的约束，能够减少模型胡言乱语（Hallucination）或格式错误的概率。</li>
<li><strong>什么时候用 ToolStrategy？</strong>
当你使用的模型较旧、或是某些国产/开源模型仅支持 Function Calling 但没有专门的 JSON Schema 模式时，使用 <code>ToolStrategy</code> 是实现结构化数据提取的唯一可靠途径。</li>
</ul>
<p>大多数情况下，建议直接传入type（pydantic对象），让Langchain自己选择策略。</p>
<h2 data-id="heading-7">二、工具调用 - Tools</h2>
<h3 data-id="heading-8">1. 工具调用的演变</h3>
<p>主流 LLM 实现工具调用的方式经历了三个阶段，这决定了它们对结构化输出的依赖程度：</p>
<p><strong>第一阶段：纯 Prompt 时代的“软约束”</strong></p>
<ul>
<li><strong>做法</strong>：在 Prompt 里写：“如果你想查天气，请输出 JSON 格式：<code>{"action": "weather", "city": "xxx"}</code>”。</li>
<li><strong>现状</strong>：这是早期的做法（如 GPT-3 时代）。</li>
<li><strong>问题</strong>：模型经常“掉链子”，生成的格式不对，这就往往需要正则来提取函数名和参数。此时，<strong>工具调用非常依赖模型的自觉性</strong>，解析错误率高。</li>
</ul>
<p><strong>第二阶段：模型微调的“半强约束”（主流现状）</strong></p>
<ul>
<li><strong>做法</strong>：OpenAI (GPT-3.5/4)、Anthropic (Claude 3/3.5)、Google (Gemini) 对模型进行了专门的工具调用微调。</li>
<li><strong>现状</strong>：模型看到 <code>tools</code> 参数时，会进入一种“工具模式”。</li>
<li><strong>依赖关系</strong>：虽然模型努力输出结构化 JSON，但<strong>由于没有底层的硬性限制，它仍然可能偶尔输出错误的 JSON 结构</strong>。</li>
</ul>
<p><strong>第三阶段：语法级别（Grammar）的“硬约束”（即 Structured Outputs）</strong></p>
<ul>
<li><strong>做法</strong>：这是 OpenAI 在 2024 年 8 月推出的功能（<code>strict: true</code>）。</li>
<li><strong>原理</strong>：在模型生成 Token 的每一瞬间，系统会根据 JSON Schema 过滤掉所有不符合语法的 Token。</li>
<li><strong>现状</strong>：<strong>这是工具调用的终极形态</strong>。此时，工具调用与结构化输出完全合为一体。如果定义了 Schema，模型<strong>物理上不可能</strong>输出格式错误的 JSON。</li>
</ul>
<h3 data-id="heading-9">2. Function Calling</h3>
<p>OpenAI最早提出<code>Function Calling</code> 的概念和功能。<code>Function Calling</code> 就是一种<code>Tools Calling</code> （在Langchain中所有LLM provider的 "工具使用"，包括Function Calling 都被抽象为<code>Tools Calling</code>）。</p>
<p><strong>Function Calling 的流程（5 个步骤）：</strong></p>
<ol>
<li><strong>定义函数</strong>：你在调用 API 时，提供一份“说明书”（JSON Schema），告诉模型你有几个函数、它们的作用是什么、需要什么参数。</li>
<li><strong>模型判断</strong>：用户提问（如“帮我查下明天的北京天气”）。模型发现这匹配了你定义的函数，于是返回一个特殊的“函数调用请求” JSON。</li>
<li><strong>程序执行</strong>：你的后端代码解析这个 JSON，<strong>实际运行</strong>对应的函数（如去访问气象局 API），并拿到结果。</li>
<li><strong>结果反馈</strong>：你将函数的运行结果（如“北京明天多云转晴，20度”）发回给模型。</li>
<li><strong>自然回复</strong>：模型根据这个真实数据，组织语言给用户一个自然的最终回答。</li>
</ol>
<p><strong>关键特性</strong></p>
<ul>
<li><strong>并行调用 (Parallel Function Calling)</strong>：模型可以一次性决定调用多个函数。例如，问“北京和伦敦天气如何？”，模型会一次性输出两个函数调用指令。</li>
<li><strong>强制/自动模式 (tool_choice)</strong>：你可以强制模型必须调用某个工具，或者让它根据对话自行判断是否需要。</li>
<li><strong>结构化输出 (Structured Outputs)</strong>：OpenAI 的最新版本保证了输出的参数百分之百符合你定义的格式要求，极大地提高了生产环境的稳定性。</li>
</ul>
<h3 data-id="heading-10">3. Function Calling vs. MCP的区别</h3>
<p>先说总结：<mark>MCP是依赖Function Calling 的能力，是对Function Calling （简称FC） 能力的拓展。FC是一种基础能力，而MCP是一种架构协议（这意味这个更好拓展，有利于系统级别开发）。</mark></p>
<p>MCP 包含了3部分</p>
<ul>
<li><strong>MCP Host</strong>：AI 软件（如 Claude Desktop）。</li>
<li><strong>MCP Client</strong>：协议层，负责协调。</li>
<li><strong>MCP Server</strong>：数据源或工具的提供者（如 Google Drive 插件、数据库查询器）。</li>
</ul>
<p>在FC中，需要定义函数...调用函数，这些都是在定义流程，并确保LLM能完成这一流程。</p>
<p>而MCP，则是明确分工了。MCP Server负责定义工具/函数；MCP Client负责把这些工具/函数 暴露给LLM并识别LLM的结果调用工具；
这个MCP Server从 「主应用」中抽离出来，可以被多个「应用」复用——只要「应用」实现了MCP Client。
因此，MCP还定义了 MCP Client和 MCP Server之间的通信协议。</p>
<h3 data-id="heading-11">4. Langchain 的 Tools设计</h3>
<h4 data-id="heading-12">工具定义和使用</h4>
<h5 data-id="heading-13">基础使用</h5>
<p>这里我先假设一个场景——<strong>电影分析</strong>：<br/>
用户希望能准确获取一些《罗小黑》电影的分析，具体来说，希望分析出为什么有人喜欢，有人吐槽。那么就需要真实的影评数据。</p>
<p>首先我们定义一个函数（模拟能从数据库获取 影评 数据）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_reviews</span>(<span class="hljs-params">positive: <span class="hljs-built_in">bool</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""
    获取罗小黑电影评论列表
    Args:
        positive: 是否获取正面评论, True 表示获取正面评论, False 表示获取负面评论
    Returns:
        评论列表
    """</span>
    positive_reviews = [
        <span class="hljs-string">"原来两三岁的小孩也可以不扯女孩裙子啊；原来不整屎尿屁也可以做出让全场大笑的效果啊；原来女角色也可以不穿超短裙高开叉高跟鞋啊；原来男师父女徒弟也可以不暧昧纯师徒情啊；原来一个动画片里正派之间也可以有不同的价值观啊；原来不喊口号不献祭亲朋好友父老乡亲也能表达反战的思想啊。罗小黑你还是太超前了。"</span>,
        <span class="hljs-string">"瑕不掩瑜。非常好的一点是，一点儿爹味都没有，不judge任何人（妖精），没有任何人（妖精）需要被打败或悔过。这在中国的大型说教重灾区———国漫中已是十分可贵。"</span>,
        <span class="hljs-string">"“无限虽然爱装逼，但是他没有跟鹿野搞花千骨，此乃一胜；没有跟罗小黑搞黑猫和他的蓝发师尊，此乃二胜；没有和哪吒搞男同，此乃三胜”"</span>,
        <span class="hljs-string">"我宣布鹿野是我唯一的姐！太帅了！！！工装裤配T恤，低马尾，非传统女性角色，太帅了5555555希望越来越强，早日拳打无限脚踢各大长老！！！ 以及，真是好多场经费爆炸的打斗啊"</span>,
    ]
    negative_reviews = [
        <span class="hljs-string">"呃…片方到底懂不懂自己的IP魅力在哪啊！搞什么武器、战争的宏大场面啊，又搞不明白，妥妥露怯！整个剧情就是，稀碎…"</span>,
    ]
    <span class="hljs-keyword">return</span> positive_reviews <span class="hljs-keyword">if</span> positive <span class="hljs-keyword">else</span> negative_reviews
</code></pre>
<p>使用 <code>@tool</code> 装饰器。默认情况下，函数名就是暴露给LLM的名称，函数的 docstring（函数文档字符串） 会成为工具的描述，帮助模型理解何时使用它。</p>
<p>你也可以自定义，比如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@tool(<span class="hljs-params"><span class="hljs-string">"get_movie_reviews"</span>, description=<span class="hljs-string">"获取罗小黑电影评论列表"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_reviews</span>(<span class="hljs-params">positive: <span class="hljs-built_in">bool</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""..."""</span>
    ...
</code></pre>
<p>这里我通过 docstring 来进行了参数说明，对于复杂的参数类型描述，你也可以使用pydantic来声明参数，然后类似下面这样使用</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReviewsInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""查询影评的输入参数"""</span>
    include_forecast: <span class="hljs-built_in">bool</span> = Field(
        default=<span class="hljs-literal">False</span>,
        description=<span class="hljs-string">"是否获取正面评论, True 表示获取正面评论, False 表示获取负面评论"</span>
    )
<span class="hljs-meta">@tool(<span class="hljs-params"><span class="hljs-string">"get_movie_reviews"</span>, args_schema=ReviewsInput</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_reviews</span>(<span class="hljs-params">positive: <span class="hljs-built_in">bool</span></span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""获取罗小黑电影评论列表"""</span>
    ...
</code></pre>
<p>测试 是否能正常调用Tool，代码如下，可以看出LLM识别出我们的意图，然后响应说“你可以发起函数调用”</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_tool_calling</span>():
    <span class="hljs-string">"""
    测试工具调用
    """</span>
    <span class="hljs-comment"># reviews = get_reviews.invoke({"positive": True})</span>
    <span class="hljs-comment"># print(reviews) # 输出reviews列表: ["原来两三岁...",...]</span>
    model_with_tools = model.bind_tools([get_reviews])
    response = model_with_tools.invoke(<span class="hljs-string">"请分析罗小黑电影的负面评论原因？"</span>) <span class="hljs-comment"># 返回 AIMessage</span>
    <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
        <span class="hljs-comment"># 查看函数调用</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Tool: <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Args: <span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>"</span>)
        <span class="hljs-comment"># Tool: get_reviews</span>
        <span class="hljs-comment"># Args: {'positive': False}</span>
</code></pre>
<p>模型输出的结果如图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b311a7eed34c40ed9a8baf7383f23919~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770269394&amp;x-signature=PPkpwUfT5WoqM46bMl8cpjefZ6o%3D" alt="image.png" loading="lazy"/></p>
<p><code>tool_calls</code>数组有内容说明是成功调用了工具，希望我们提供影评数据。下面就带上影评数据进行第二请求。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_tool_calling_2</span>():
    <span class="hljs-string">"""
    测试工具调用2
    """</span>
    model_with_tools = model.bind_tools([get_reviews])
    prompt = <span class="hljs-string">"请分析罗小黑电影的正面评论原因？"</span>
    response = model_with_tools.invoke(prompt) <span class="hljs-comment"># AIMessage</span>

    tool_messages: <span class="hljs-built_in">list</span>[ToolMessage] = []
    <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Tool: <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Args: <span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>"</span>)
        reviews = get_reviews.invoke(tool_call[<span class="hljs-string">"args"</span>])
        tool_messages.append(
            ToolMessage(
                content=json.dumps(reviews, ensure_ascii=<span class="hljs-literal">False</span>),
                tool_call_id=tool_call[<span class="hljs-string">"id"</span>],
            )
        )

    final_response = model_with_tools.invoke([HumanMessage(content=prompt), response, *tool_messages])
    <span class="hljs-built_in">print</span>(final_response.content)
	<span class="hljs-string">'''输出：
        ## 🎬 正面评论原因分析
        ### 1. **儿童教育价值出色**
        ...
    '''</span>
</code></pre>
<p>这里用<code>ToolMessage</code> 来封装这些影评数据，然后和历史记录一起发送给LLM。</p>
<blockquote>
<p>每个由工具返回的 <code>ToolMessage</code> 都包含一个与原始工具调用匹配的 <code>tool_call_id</code> ，这有助于模型将结果与请求关联起来。</p>
</blockquote>
<p>下面贴出两次请求的提示词，你可以看到Langchain帮我做了那些事。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"Human: 请分析罗小黑电影的正面评论原因？"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"Human: 请分析罗小黑电影的正面评论原因？\nAI: 我来帮您获取罗小黑电影的正面评论，然后分析其中的正面评价原因。[{'name': 'get_reviews', 'args': {'positive': True}, 'id': '019bf500873b7d3b26cbb49ba71c4984', 'type': 'tool_call'}]\nTool: [\"原来两三岁的小孩也可以不扯女孩裙子啊；原来不整屎尿屁也可以做出让全场大笑的效果啊；原来女角色也可以不穿超短裙高开叉高跟鞋啊；原来男师父女徒弟也可以不暧昧纯师徒情啊；原来一个动画片里正派之间也可以有不同的价值观啊；原来不喊口号不献祭亲朋好友父老乡亲也能表达反战的思想啊。罗小黑你还是太超前了。\", \"瑕不掩瑜。非常好的一点是，一点儿爹味都没有，不judge任何人（妖精），没有任何人（妖精）需要被打败或悔过。这在中国的大型说教重灾区———国漫中已是十分可贵。\", \"“无限虽然爱装逼，但是他没有跟鹿野搞花千骨，此乃一胜；没有跟罗小黑搞黑猫和他的蓝发师尊，此乃二胜；没有和哪吒搞男同，此乃三胜”\", \"我宣布鹿野是我唯一的姐！太帅了！！！工装裤配T恤，低马尾，非传统女性角色，太帅了5555555希望越来越强，早日拳打无限脚踢各大长老！！！ 以及，真是好多场经费爆炸的打斗啊\"]"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>P.S. invoke会将Message列表 序列化成字符串，其中ToolMessage就是：</p>
<pre><code class="hljs language-ini" lang="ini">Tool: <span class="hljs-section">[工具调用返回的消息]</span>
</code></pre>
<h5 data-id="heading-14">强制工具使用</h5>
<blockquote>
<p>默认情况下，模型会根据用户的输入自由选择使用哪个绑定工具。但是，你可能希望强制选择一个工具，确保模型使用特定的工具或给定列表中的任何工具：</p>
</blockquote>
<pre><code class="hljs language-python" lang="python">model_with_tools = model.bind_tools([tool_1], tool_choice=<span class="hljs-string">"tool_1"</span>)
</code></pre>
<h5 data-id="heading-15">并行工具调用</h5>
<blockquote>
<p>许多模型在适当的情况下支持并行调用多个工具。这使模型能够同时从不同来源收集信息。</p>
</blockquote>
<p>你留意到了吗？前面的<code>tool_calls</code>字段是一个数组，意味着可以调用多个工具。那么我们试一试下面的提问（只是把问题改了，看下结果）：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"请分析罗小黑电影的正面评论原因和负面评论原因？"</span>
</code></pre>
<p>现在问题同时包含“正面原因分析”和“负面原因分析”，LLM会调用两次工具 分别查询出正面评论和负面评论吗？</p>
<p>结论：会。</p>
<p>回答结果如下：</p>
<pre><code class="hljs language-shell" lang="shell">基于获取的评论数据，我来为您分析罗小黑电影的正面和负面评论原因：
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 正面评论的主要原因：</span></span>
... 
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 负面评论的主要原因：</span></span>
...
</code></pre>
<h5 data-id="heading-16">流工具调用</h5>
<p>这里直接贴出官方的例子吧~</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> model_with_tools.stream(
    <span class="hljs-string">"What's the weather in Boston and Tokyo?"</span>
):
    <span class="hljs-comment"># Tool call chunks arrive progressively</span>
    <span class="hljs-keyword">for</span> tool_chunk <span class="hljs-keyword">in</span> chunk.tool_call_chunks:
        <span class="hljs-keyword">if</span> name := tool_chunk.get(<span class="hljs-string">"name"</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Tool: <span class="hljs-subst">{name}</span>"</span>)
        <span class="hljs-keyword">if</span> id_ := tool_chunk.get(<span class="hljs-string">"id"</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ID: <span class="hljs-subst">{id_}</span>"</span>)
        <span class="hljs-keyword">if</span> args := tool_chunk.get(<span class="hljs-string">"args"</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Args: <span class="hljs-subst">{args}</span>"</span>)

<span class="hljs-comment"># Output:</span>
<span class="hljs-comment"># Tool: get_weather</span>
<span class="hljs-comment"># ID: call_SvMlU1TVIZugrFLckFE2ceRE</span>
<span class="hljs-comment"># Args: {"lo</span>
<span class="hljs-comment"># Args: catio</span>
<span class="hljs-comment"># Args: n": "B</span>
<span class="hljs-comment"># Args: osto</span>
<span class="hljs-comment"># Args: n"}</span>
<span class="hljs-comment"># Tool: get_weather</span>
<span class="hljs-comment"># ID: call_QMZdy6qInx13oWKE7KhuhOLR</span>
<span class="hljs-comment"># Args: {"lo</span>
<span class="hljs-comment"># Args: catio</span>
<span class="hljs-comment"># Args: n": "T</span>
<span class="hljs-comment"># Args: okyo</span>
<span class="hljs-comment"># Args: "}</span>
</code></pre>
<h4 data-id="heading-17">访问上下文</h4>
<p>试想一下，如果下面的<code>get_reviews</code>想要访问一些其他信息，这些信息又不应该暴露给LLM使用，那么如何处理呢？Langchain给出了答案：<code>ToolRuntime</code>。</p>
<pre><code class="hljs language-python;" lang="python;">@tool
def get_reviews(positive: bool) -&gt; list[str]:
	"""
	"""
	pass
</code></pre>
<p>其实很简单，就是给你定义的工具函数传入一个<code>ToolRuntime</code>的参数（句柄），这个句柄可以获取上下文信息。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_reviews_with_runtime</span>(<span class="hljs-params">
    positive: <span class="hljs-built_in">bool</span>, 
    runtime: ToolRuntime[Context] <span class="hljs-comment"># ToolRuntime 对模型不可见, 最终的实际tool 函数的参数不会包含runtime</span>
</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""
    获取罗小黑电影评论列表
    Args:
        positive: 是否获取正面评论, True 表示获取正面评论, False 表示获取负面评论
    Returns:
        评论列表
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1.查看对话的状态"</span>)
    <span class="hljs-built_in">print</span>(runtime.state[<span class="hljs-string">"messages"</span>])
    <span class="hljs-comment"># [HumanMessage(content='请分析罗小黑电影的正面评论原因？'), IMessage(content='我来帮您获取罗小黑电影的正面评论并分析其中的原因。'), ...]</span>

    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2.借助user_id，可以查询user的个人信息"</span>)
    user_id = runtime.context.user_id
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"user_id: <span class="hljs-subst">{user_id}</span>"</span>)
    <span class="hljs-comment"># user_id: user123</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"3.在长任务中，使用stream_writer反馈进度，通常配合langgraph使用"</span>)
    writer = runtime.stream_writer
    writer({<span class="hljs-string">"status"</span>: <span class="hljs-string">"starting"</span>, <span class="hljs-string">"message"</span>: <span class="hljs-string">f"正在处理查询"</span>})
    writer({<span class="hljs-string">"status"</span>: <span class="hljs-string">"progress"</span>, <span class="hljs-string">"message"</span>: <span class="hljs-string">f"完成50%"</span>})
        
    <span class="hljs-comment">#...</span>
</code></pre>
<p>运行agent，调用工具，查看上下文信息打印。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_tool_runtime</span>():
    agent = create_agent(
        model,
        tools=[get_reviews_with_runtime],
        context_schema=Context,
    )
    result = agent.invoke(
        {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"请分析罗小黑电影的正面评论原因？"</span>}]},
        context=Context(user_id=<span class="hljs-string">"user123"</span>)
    )
</code></pre>
<h2 data-id="heading-18">附录</h2>
<h3 data-id="heading-19">代码 - 传送门</h3>
<p>本章节对应的代码：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffkcaikengren%2Flangchain-tutorials%2Ftree%2Fmain%2Flangchain_py%2Fapp%2F2" target="_blank" title="https://github.com/fkcaikengren/langchain-tutorials/tree/main/langchain_py/app/2" ref="nofollow noopener noreferrer">langchain_py 篇2</a></p>
<h3 data-id="heading-20">系列 - 传送门</h3></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝 AI 写“烂代码”：深度解读 antfu/skills 与前端 AI 的新范式]]></title>    <link>https://juejin.cn/post/7600380007885897778</link>    <guid>https://juejin.cn/post/7600380007885897778</guid>    <pubDate>2026-01-29T05:51:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600380007885897778" data-draft-id="7600370554069401626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝 AI 写“烂代码”：深度解读 antfu/skills 与前端 AI 的新范式"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-29T05:51:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝 AI 写“烂代码”：深度解读 antfu/skills 与前端 AI 的新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:51:51.000Z" title="Thu Jan 29 2026 05:51:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，Vue/Vite 核心成员 Anthony Fu 发布了 <code>antfu/skills</code> 项目，引发了社区热议。这不仅是一个新工具，更标志着 AI 辅助编程正在从“通用大模型”向“精细化上下文管理”转型。本文将带你了解什么是 AI Skills，以及它为何能解决 AI 写过时代码的痛点。</p>
<hr/>
<p>在 AI 辅助编程（AI Coding）日益普及的今天，我们经常遇到一个尴尬的场景：你让 ChatGPT 或 Cursor 写一个 Vue 组件，它却给你吐出了一段 Vue 2 的 Options API 代码，或者使用了一些两年前就已经废弃的配置写法。</p>
<p>为什么会这样？因为大模型是基于历史数据训练的，它不懂“最新”，也不懂“最佳实践”。</p>
<p>最近，前端圈的一个新名词 <strong>"Skills"</strong> 开始频繁出现，特别是 Anthony Fu 发布的 <strong><code>antfu/skills</code></strong> 项目，正是为了解决这个问题而生。</p>
<h2 data-id="heading-0">什么是 AI 的 "Skills"？</h2>
<p>在 AI Agent（智能体）的语境下，大模型（LLM）被视为大脑，而 <strong>Skills（技能）</strong> —— 有时也被称为 Tools（工具）或 Context（上下文）—— 则是它的外挂知识库和手脚。</p>
<p>如果不加干预，AI 就像一个虽然博学但仅仅读过 2023 年之前旧书的程序员。</p>
<p><strong>Skills 的作用，就是把最新的“参考手册”和“操作指南”塞给 AI。</strong></p>
<h2 data-id="heading-1">为什么我们需要 <code>antfu/skills</code>？</h2>
<p>虽然我们可以通过 Prompt（提示词）告诉 AI “请使用 Vue 3.5 的写法”，但这非常依赖开发者个人的 Prompt Engineering 能力。</p>
<p><code>antfu/skills</code> 的核心价值在于：<strong>它是由框架作者维护的标准答案。</strong></p>
<h3 data-id="heading-2">1. 解决“版本时差”问题</h3>
<p>AI 最容易犯的错误就是“幻觉”和“过时”。Anthony Fu 的这个项目通过自动化脚本，从 <strong>Vue, Nuxt, Vite, Vitest</strong> 等官方文档中抓取最新的核心概念和 API 变动。</p>
<p>当你向 AI 注入这个 Skill，它瞬间就从“凭借旧印象写代码”变成了“看着最新官方文档写代码”。</p>
<h3 data-id="heading-3">2. 也是一种 Opinionated（独断）的最佳实践</h3>
<p>除了官方文档，该项目还包含了一个 <code>antfu</code> 专属 Skill。这是 Anthony Fu 基于维护数十个开源项目的经验，总结出的一套高效开发流：</p>
<ul>
<li>如何配置最高效的 ESLint 规则？</li>
<li>如何使用 UnoCSS 进行原子化开发？</li>
<li>目录结构应该如何组织？</li>
</ul>
<p>通过使用这个 Skill，你可以让 AI 直接复刻顶尖开发者的工程化思维。</p>
<h2 data-id="heading-4">技术原理：MCP 与上下文工程</h2>
<p><code>antfu/skills</code> 的出现并非偶然，它背后对应的是 <strong>MCP (Model Context Protocol)</strong> 协议的兴起。</p>
<ul>
<li><strong>过去</strong>：我们需要手动把文档复制粘贴给 ChatGPT。</li>
<li><strong>现在</strong>：通过 <code>npx skills</code> 命令行工具生成 Prompt。</li>
<li><strong>未来 (MCP)</strong> ：你的 IDE（如 Cursor, Windsurf）将原生支持 MCP 协议。你只需要在设置里勾选“Vue Skills”，IDE 就会自动连接到这个知识库。</li>
</ul>
<p>这意味着，以后“如何写出高质量代码”的 Prompt，不再需要我们自己去摸索，而是由开源库的作者直接提供。</p>
<h2 data-id="heading-5">实际使用场景</h2>
<p>虽然该项目还在早期阶段，但我们已经可以这样利用它：</p>
<ol>
<li>
<p><strong>生成高质量配置</strong>：</p>
<p>当你需要初始化一个 Vite + Vue + TS 项目时，使用 Skill 生成的配置，一定是目前最符合生态标准的，没有任何过时依赖。</p>
</li>
<li>
<p><strong>代码审查 (Code Review)</strong> ：</p>
<p>你可以将 <code>antfu/skills</code> 的规则作为系统提示词（System Prompt），让 AI 检查你的现有代码：“根据这些最佳实践，我的代码有什么可以优化的地方？”</p>
</li>
<li>
<p><strong>学习最新特性</strong>：</p>
<p>甚至不需要写代码，你可以直接问 AI：“根据 Vue Skill，3.5 版本引入的 <code>useTemplateRef</code> 和旧的 <code>ref</code> 有什么区别？” AI 会基于最新的上下文给你准确解答。</p>
</li>
</ol>
<h2 data-id="heading-6">总结</h2>
<p><code>antfu/skills</code> 的发布释放了一个重要信号：<strong>Prompt Engineering（提示词工程）正在转变为 Context Engineering（上下文工程）。</strong></p>
<p>未来的开发者可能不再需要背诵复杂的 API，也不需要费尽心思去调教 AI。我们只需要选择合适的 <strong>Skills</strong> —— 就像给游戏角色装备不同的技能卡片一样 —— 就能让通用的 AI 瞬间变身为特定领域的资深专家。</p>
<p>对于 Vue/Vite 生态的开发者来说，这无疑是一个必须关注的利器；而对于其他领域的开发者，这也预示着一种全新的 AI 协作模式即将到来。</p>
<hr/>
<p><em>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Fskills" target="_blank" title="https://github.com/antfu/skills" ref="nofollow noopener noreferrer">github.com/antfu/skill…</a></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JustGRPO：扩散语言模型的极简主义回归]]></title>    <link>https://juejin.cn/post/7600326947505930292</link>    <guid>https://juejin.cn/post/7600326947505930292</guid>    <pubDate>2026-01-29T05:52:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326947505930292" data-draft-id="7600341731047030819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JustGRPO：扩散语言模型的极简主义回归"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-01-29T05:52:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JustGRPO：扩散语言模型的极简主义回归
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:52:16.000Z" title="Thu Jan 29 2026 05:52:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>扩散语言模型（Diffusion LLMs, dLLMs）因支持「任意顺序生成」和并行解码而备受瞩目。直觉上，打破传统自回归（AR）「从左到右」的束缚，理应赋予模型更广阔的解空间，从而在数学、代码等复杂任务上解锁更强的推理潜力。</p>
<p>然而，本研究揭示了一个反直觉的现实：当前的任意顺序生成，反而通过「规避不确定性」收窄了模型的推理边界。</p>
<p>基于此，本文提出了一种回归极简的方法——JustGRPO。实验表明，在 RL 阶段让模型自回归生成，并直接用标准的 GRPO 进行训练，即可超越当前各类针对 dLLM 设计的 RL 算法表现。更重要的是，这种训练方式在提升推理表现的同时，并未牺牲 dLLM 引以为傲的并行解码能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ed42f013b4d473e9873b77ecd77013e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=oZtS8LMO8qmnbAROCjZ85He6bgs%3D" alt="图片" loading="lazy"/></p>

<ul>
<li>论文标题：The Flexibility Trap: Why Arbitrary Order Limits Reasoning Potential in Diffusion Language Models</li>
<li>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fpapers%2F2601.15165" target="_blank" title="https://huggingface.co/papers/2601.15165" ref="nofollow noopener noreferrer">huggingface.co/papers/2601…</a></li>
<li>项目主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnzl-thu.github.io%2Fthe-flexibility-trap" target="_blank" title="https://nzl-thu.github.io/the-flexibility-trap" ref="nofollow noopener noreferrer">nzl-thu.github.io/the-flexibi…</a></li>
<li>论文代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLeapLabTHU%2FJustGRPO" target="_blank" title="https://github.com/LeapLabTHU/JustGRPO" ref="nofollow noopener noreferrer">github.com/LeapLabTHU/…</a></li>
</ul>
<h3 data-id="heading-0">「灵活性陷阱」：</h3>
<h3 data-id="heading-1">为什么选择多反而考不好？</h3>
<p>为了探究「灵活性是否等同于推理潜力」，本文引入了 Pass@k 作为核心衡量指标。该指标量化了在 k 次采样中至少生成一个正确答案的概率，能够有效反映模型解空间的覆盖广度以及 RL 训练可激发的推理潜力上限（Yue et al., 2025）。</p>
<p>对比实验涵盖了两种主要的解码模式：</p>
<ul>
<li>
<p><strong>任意顺序（Arbitrary Order）</strong> ：允许模型根据置信度动态选择生成顺序，这是扩散语言模型的标准解码方式。</p>
</li>
<li>
<p><strong>AR 顺序（AR Order）</strong> ：约束模型遵循传统 LLM 从左到右的生成顺序。</p>
</li>
</ul>
<p>实验结果揭示了一个值得深思的趋势：虽然任意顺序在 k=1 时表现尚可，但随着采样次数 k 的增加，AR 顺序的 Pass@k 曲线不仅攀升速率更快，且最终达到的上限显著更高。这表明，在涉及复杂推理时，AR 顺序实际上可帮助模型覆盖更广阔的正确解空间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1be1394657f14ab8a1c4bc5358d39732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=1hmZGXsmOgZp6Qx6O6sPJAlRiFg%3D" alt="图片" loading="lazy"/></p>
<p>图：限制 dLLM 使用标准的 AR 顺序，反而比灵活的任意顺序拥有更高的推理上限。</p>
<h3 data-id="heading-2">熵坍塌现象</h3>
<h3 data-id="heading-3"/>
<p>为何看似受限的 AR 顺序反而更具潜力？这与两种顺序如何处理不确定性有关。</p>
<p>在自回归模式下，模型被迫直面第一个未知 Token；而在任意顺序模式下，模型则有跳过（bypass）当前不确定 Token、优先填充后续更确定的内容的「特权」。统计显示，被频繁跳过的往往是诸如「Therefore」、「Thus」、「To」等逻辑衔接词（下图左）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec64900df09e44c5a6cee273bfeabc8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=ZQLwEXE1hzKiGPX64wr0quFYSG8%3D" alt="图片" loading="lazy"/></p>
<p>图左：任意顺序下，模型倾向于跳过不确定token而先填后续token，且这些被跳过的token往往是一些逻辑衔接词；图右：这些逻辑衔接词解码时的entropy显著低于自回归顺序（虚线代表average token entropy）。以上结果为LLaDA-Instruct在MATH-500数据集的结果。</p>
<p>已有工作（Wang et al., 2025）表明，这些逻辑衔接词往往起到通往不同推理路径的功能，且将这些词保持高熵状态对模型探索丰富的解空间至关重要。而在任意顺序下，这些衔接词被解码时的熵（Entropy）显著低于自回归顺序（上图右）。</p>
<p>我们将这种现象称为「熵降级」（Entropy Degradation）。形象地说，模型利用了任意顺序的灵活性进行了一种「局部贪婪优化」：它跳过了艰难的推理决策点，试图通过先生成后续上下文来「凑」出逻辑连接。虽然这在单次生成中可能有效，但却牺牲了对多样化推理路径的有效探索。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6b78b1bfa6f4e43bbc7777a6f945285~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=k6k%2FaSm6xK%2BBCdvI8ppircM8KgM%3D" alt="图片" loading="lazy"/></p>
<p>图：任意顺序生成倾向于绕过高熵的逻辑连接词，导致解空间过早坍缩。</p>
<h3 data-id="heading-4">返璞归真：</h3>
<h3 data-id="heading-5">JustGRPO</h3>
<p>既然「任意顺序」反而可能限制推理路径的探索，本文提出了一种回归极简的方法——JustGRPO。不同于现有 RL 算法，JustGRPO 不再试图用各种近似处理以显式保留任意顺序特性，而是选择了一条更为彻底的路径：</p>
<p>在 RL 训练阶段，直接摒弃对任意顺序的执念，强制扩散语言模型采用自回归（AR）顺序生成。这样不仅保持了更广阔的推理路径，同时也让我们得以直接复用成熟的 GRPO 算法进行优化。这种「生成轨迹的确定性」也自然使得强化学习时的信用分配（Credit Assignment）更加清晰，有助于模型更有效地学习鲁棒的联合分布。</p>
<p>值得一提的是：<strong>「训练时的约束」≠「推理时的退化」</strong>。</p>
<p>自回归的约束仅存在于训练阶段。它的目的是为了让模型更有效地进行 RL 阶段的探索与信用分配，模型本身的双向注意力机制并未被破坏。一旦训练完成，我们依然可以在推理阶段无损地应用并行解码，在享受 AR 训练带来的更优推理表现的同时，保留扩散模型引以为傲的生成速度。</p>
<h3 data-id="heading-6">实验结果：</h3>
<h3 data-id="heading-7">简单，但极其有效</h3>
<h4 data-id="heading-8">性能大幅提升</h4>
<p>在数学推理和代码生成这两类通用的推理任务上，JustGRPO 均有优秀的表现：</p>
<ul>
<li>
<p><strong>数学推理</strong>：在 GSM8K 和 MATH-500 上，模型展现了极高的推理上限，准确率最高分别可达 89.8% 和 45.2%，相比之前的最佳方法（SPG）显著提升。</p>
</li>
<li>
<p><strong>代码生成</strong>：在 HumanEval 与 MBPP 数据集上，准确率分别达到 49.4% 和 52.4%。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb6dbf83a2354e1eaad638958a270bd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=sJku5l4iCi7OzXTvFHYMDA0YE54%3D" alt="图片" loading="lazy"/></p>
<p>表：JustGRPO在多个基准测试中超越了现有的 dLLM 强化学习方法，基座模型：LLaDA-Instruct。注：LLaDA-1.5使用了大规模私有数据集训练、LLaDOU在训练中引入了额外模块，因此未列入对比。</p>
<h4 data-id="heading-9">并行能力不仅没丢，还更强了</h4>
<p>一个可能的担忧是：用 AR 方式训练是否会让 dLLM 退化，失去其并行优势？实验结果恰恰相反。使用现成的 training-free 并行采样器（Ben-Hamu et al., 2025），JustGRPO 训练后的模型在并行解码下表现更佳。例如在 MBPP 数据集上，当每步并行解码 5 个 Token 时，JustGRPO 相比基座模型（LLaDA-Instruct）的准确率优势从单步的 10.6% 扩大到了 25.5%。</p>
<p>这表明训练后的模型学到了更鲁棒的联合分布，使其更能适应并行采样过程中的近似误差。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4931ac51e437477d8a2d4aae670f28c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270738&amp;x-signature=ZnMNR1K98j9fnVCJACd4f%2B7XR3E%3D" alt="图片" loading="lazy"/></p>
<p>图：JustGRPO 训练后的模型在并行解码时表现出更好的速度-精度权衡。</p>
<h3 data-id="heading-10">结语：</h3>
<h3 data-id="heading-11">少即是多</h3>
<p>这篇工作挑战了该领域的一个普遍假设，即「必须在 RL 中保留任意顺序灵活性」。事实证明，通过限制训练时的生成顺序，迫使模型直面逻辑分叉点的高不确定性，反而能更有效地激发 dLLMs 的推理潜能。</p>
<p>JustGRPO 以一种极简的方式，实现了推理能力的大幅提升，同时未牺牲扩散模型标志性的推理速度。也希望借此工作启发社区重新审视「任意顺序生成」在通用推理任务中的真实价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot开发者的5个痛点和解决方案，第3个90%的人都遇到过！]]></title>    <link>https://juejin.cn/post/7600342201793642511</link>    <guid>https://juejin.cn/post/7600342201793642511</guid>    <pubDate>2026-01-29T04:20:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600342201793642511" data-draft-id="7600342201793626127" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot开发者的5个痛点和解决方案，第3个90%的人都遇到过！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T04:20:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot开发者的5个痛点和解决方案，第3个90%的人都遇到过！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:20:27.000Z" title="Thu Jan 29 2026 04:20:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot开发者的5个痛点和解决方案，第3个90%的人都遇到过！</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>SpringBoot作为Java生态中最流行的框架之一，凭借其"约定优于配置"的理念和强大的自动化能力，极大地简化了企业级应用的开发。然而，在实际开发中，开发者仍然会遇到许多令人头疼的问题。这些问题可能来自框架本身的设计、依赖管理的复杂性，或是生产环境中的性能调优。本文将深入探讨SpringBoot开发者的5个常见痛点，并提供切实可行的解决方案。其中第3个问题——"依赖冲突"，据统计90%的开发者都曾遇到过！</p>
<hr/>
<h3 data-id="heading-2">1. 配置文件的混乱管理</h3>
<h4 data-id="heading-3">痛点描述</h4>
<p>SpringBoot支持多种配置文件（如<code>application.yml</code>、<code>application.properties</code>），但在多环境（dev/test/prod）下，配置文件的管理容易变得混乱。例如：</p>
<ul>
<li>不同环境的配置分散在多个文件中，难以维护。</li>
<li>敏感信息（如数据库密码）硬编码在配置文件中，存在安全隐患。</li>
</ul>
<h4 data-id="heading-4">解决方案</h4>
<ol>
<li><strong>多环境配置分离</strong>：<br/>
使用<code>spring.profiles.active</code>指定环境，并通过<code>application-{profile}.yml</code>分离配置。例如：
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application-dev.yml</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
<span class="hljs-comment"># application-prod.yml</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
</code></pre>
</li>
<li><strong>敏感信息加密</strong>：<br/>
结合Spring Cloud Config和Vault工具实现配置加密，或使用Jasypt库：
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> StandardPBEStringEncryptor <span class="hljs-title function_">encryptor</span><span class="hljs-params">()</span> {
    <span class="hljs-type">StandardPBEStringEncryptor</span> <span class="hljs-variable">encryptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardPBEStringEncryptor</span>();
    encryptor.setPassword(<span class="hljs-string">"secure-key"</span>);
    <span class="hljs-keyword">return</span> encryptor;
}
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-5">2. 启动速度缓慢</h3>
<h4 data-id="heading-6">痛点描述</h4>
<p>随着项目规模增长，SpringBoot应用的启动时间可能从几秒延长到几十秒甚至分钟级。主要原因包括：</p>
<ul>
<li>过多的自动配置类扫描（Auto-Configuration）。</li>
<li>依赖注入的Bean数量过多。</li>
</ul>
<h4 data-id="heading-7">解决方案</h4>
<ol>
<li><strong>延迟初始化（Lazy Initialization）</strong>：<br/>
在<code>application.yml</code>中启用延迟加载：
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">main:</span>
    <span class="hljs-attr">lazy-initialization:</span> <span class="hljs-literal">true</span>
</code></pre>
注意：此方案可能导致首次请求响应变慢。</li>
<li><strong>排除不必要的自动配置</strong>：<br/>
通过<code>@SpringBootApplication(exclude)</code>禁用特定自动配置类：
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})</span>
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-8">3. 依赖冲突（90%的开发者遇到过！）</h3>
<h4 data-id="heading-9">痛点描述</h4>
<p>Maven或Gradle项目中，不同库引入的相同依赖版本不一致，导致运行时异常（如<code>NoSuchMethodError</code>或<code>ClassNotFoundException</code>）。例如：</p>
<ul>
<li>SpringBoot Starter Web和Spring Cloud Starter Feign引入的Jackson版本冲突。</li>
</ul>
<h4 data-id="heading-10">解决方案</h4>
<ol>
<li><strong>依赖树分析</strong>：<br/>
使用Maven命令定位冲突：
<pre><code class="hljs language-bash" lang="bash">mvn dependency:tree -Dverbose
</code></pre>
</li>
<li><strong>强制统一版本号</strong>：<br/>
在<code>pom.xml</code>中显式指定版本：
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">jackson.version</span>&gt;</span>2.12.3<span class="hljs-tag">&lt;/<span class="hljs-name">jackson.version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jackson.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-11">4. 性能监控与调优困难</h3>
<h4 data-id="heading-12">痛点描述</h4>
<p>生产环境中，应用可能出现内存泄漏、线程阻塞或数据库连接池耗尽等问题，但缺乏有效的监控手段定位根因。</p>
<h4 data-id="heading-13">解决方案</h4>
<ol>
<li><strong>集成Micrometer + Prometheus + Grafana</strong>：<br/>
通过Spring Boot Actuator暴露指标数据：
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,metrics,prometheus</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-attr">export:</span>
      <span class="hljs-attr">prometheus:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
</code></pre>
</li>
<li><strong>APM工具集成</strong>：<br/>
使用SkyWalking或Elastic APM实现分布式追踪：
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> ElasticApmTracer <span class="hljs-title function_">apmTracer</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> ElasticApmTracer.Builder.create().build();
}
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-14">5. Spring Boot版本升级兼容性问题</h3>
<h4 data-id="heading-15">痛点描述</h4>
<p>从低版本（如1.x）升级到高版本（如3.x）时，可能遇到以下问题：</p>
<ul>
<li>API废弃导致编译错误（如<code>JpaRepository#findOne</code>改为<code>findById</code>）。</li>
<li>Spring Security配置语法变更。</li>
</ul>
<h4 data-id="heading-16">解决方案</h4>
<ol>
<li><strong>逐步升级策略</strong>：<br/>
参考官方迁移指南（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-boot%2Fwiki" target="_blank" title="https://github.com/spring-projects/spring-boot/wiki" ref="nofollow noopener noreferrer">Spring Boot Release Notes</a>），分阶段升级（如2.4 → 2.7 → 3.x）。</li>
<li><strong>自动化测试覆盖</strong>：<br/>
确保单元测试和集成测试覆盖率足够高，升级后立即运行测试验证兼容性。</li>
</ol>
<hr/>
<h3 data-id="heading-17">总结</h3>
<p>SpringBoot虽然极大提升了开发效率，但仍需开发者深入理解其底层机制以规避常见陷阱。本文提到的5个痛点——配置文件管理、启动速度、依赖冲突、性能监控和版本升级——涵盖了从开发到运维的全生命周期问题。尤其是依赖冲突问题，90%的开发者都会遇到！通过合理的工具链设计和最佳实践积累，这些问题完全可以被系统化解决。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型到底更容易取代哪些工程师，前端还是后端？]]></title>    <link>https://juejin.cn/post/7600345782172712994</link>    <guid>https://juejin.cn/post/7600345782172712994</guid>    <pubDate>2026-01-29T04:37:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600345782172712994" data-draft-id="7600326947505635380" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型到底更容易取代哪些工程师，前端还是后端？"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T04:37:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月亮有石头"/> <meta itemprop="url" content="https://juejin.cn/user/3526889032395613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型到底更容易取代哪些工程师，前端还是后端？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889032395613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月亮有石头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T04:37:41.000Z" title="Thu Jan 29 2026 04:37:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着AI特别是大语言模型的不断发展，我们不得不面对一个问题：<strong>哪些工作岗位最容易被大模型取代？</strong> 以往的观点往往认为，AI取代的将是那些重复性强、劳动强度大的工作。然而，随着AI技术的进步，我们开始发现一些反直觉的现象。其实，大模型在一些我们认为“简单”的任务上表现得不如人类，在那些我们认为“复杂”的领域里，它反而能迅速占据一席之地。</p>
<p><strong>那么，前端还是后端更容易被大模型取代呢？</strong> 这个问题背后，隐藏了对大模型能力的误解。让我们从另一个角度去看待这个问题：有些工作对大模型来说很简单，而另一些看起来简单的任务，却可能让它束手无策。换句话说，大模型对复杂的算法问题往往能够更得心应手，而对于一些看似简单的、需要理解和调整细节的工作，它却可能陷入困境。</p>
<h4 data-id="heading-0">1. 反直觉：简单任务对大模型更难</h4>
<p><strong>家务活和打螺丝的启示</strong><br/>
想象一下，大模型被要求做家务。我们通常认为，家务活（比如打扫卫生、洗衣服、晾晒衣服）是非常基础的工作，应该由AI来做，让我们有更多时间去做更有创意的事情，比如写诗、创作音乐。然而，实际情况却常常是反过来的：我们依旧在为这些琐事忙碌，而大模型反倒在为我们创作高质量的音乐、诗歌，甚至处理更加复杂的任务。</p>
<p>这就像是我们曾认为，打螺丝这种重复性极高的工作，应该由机器人代替。然而，反而在更复杂的工艺流程中，AI和自动化技术可以显著提升效率。与之相对，打扫卫生、整理房间等需要细致观察和实时调整的任务，机器人却常常难以做到“人性化”。这类任务虽然看似简单，却需要强大的感知和判断能力，而这些正是现阶段大模型的短板。</p>
<p><strong>大模型的应用局限性</strong><br/>
回到软件开发领域，前端工程师的工作往往涉及到与用户直接交互的界面设计。这些任务似乎是最适合AI替代的，毕竟AI可以生成UI布局、编写代码并处理响应式设计。然而，前端的核心挑战不仅是技术实现，还包括用户体验、创意设计和情感交互。这些需要大量感知和细致入微的调整，AI虽然能生成代码和提供推荐，但要完全替代人类工程师，仍然面临着巨大的挑战。</p>
<h4 data-id="heading-1">2. 反直觉：后端开发或许更容易被大模型取代</h4>
<p><strong>后端的高难度与大模型的优势</strong><br/>
相对前端，后端开发的任务通常更加结构化和规则化。后端涉及的任务，包括数据库设计、API开发、系统架构优化等，看起来很有条理。但这正是大模型的强项。特别是在一些标准化的任务上，大模型的能力远超人类开发者。</p>
<p>例如，<strong>数据库查询优化</strong>、<strong>API文档自动生成</strong>、甚至<strong>系统架构建议</strong>等，已经有AI工具可以完成。这些任务虽然看似非常困难，但其背后需要系统性思维和大量的数据处理，正是大模型能够帮助提升效率的地方。</p>
<h4 data-id="heading-2">3. 期待与现实的落差：大模型在做创作</h4>
<p>很多人都有一个幻想，认为AI应该替代我们的繁重体力劳动，比如<strong>家务</strong>、<strong>洗衣</strong>、<strong>做饭</strong>等工作，让我们有更多时间去从事创造性活动。然而，现实却常常是AI并没有去做家务，而是在高效地生成<strong>诗歌</strong>、<strong>音乐</strong>、<strong>图像</strong>等创意内容。我们可能原本希望AI能够为我们减轻生活负担，但事实上，AI反倒为我们提供了更多的精神和创作支持。</p>
<p>回到软件开发的讨论，虽然很多开发者希望大模型能够代替他们进行简单的编码工作，甚至进行复杂的业务逻辑设计，但其实，AI正在逐步取代的不是那些简单的重复性任务，而是更具挑战性的内容，如<strong>代码生成</strong>、<strong>架构设计</strong>，甚至是<strong>错误调试</strong>。换句话说，我们原本期望AI来为我们减轻基础性的工作负担，然而，它却在更高层次上为我们提供了更强大的支持。</p>
<h4 data-id="heading-3">4. 总结：大模型与工程师的协作</h4>
<p>综上所述，<strong>前端</strong>和<strong>后端</strong>都面临着被大模型影响和取代的可能性。但在不同的维度上，大模型的适应性却不完全一样。前端的琐碎兼容和用户体验设计仍然需要大量人类开发者的参与，而后端开发的系统性和标准化任务则更容易被AI取代。</p>
<p><strong>重要的是，AI与工程师之间的协作将成为未来的主流模式</strong>。我们不应过度担忧AI取代我们的工作，而是要思考如何与AI协同工作，发挥各自的优势。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GitHub 上狂揽 5 万 Star！26 年爆火的个人 AI 助手。]]></title>    <link>https://juejin.cn/post/7600340964083351558</link>    <guid>https://juejin.cn/post/7600340964083351558</guid>    <pubDate>2026-01-29T03:17:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600340964083351558" data-draft-id="7600326291553648646" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GitHub 上狂揽 5 万 Star！26 年爆火的个人 AI 助手。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-29T03:17:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GitHub 上狂揽 5 万 Star！26 年爆火的个人 AI 助手。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:17:28.000Z" title="Thu Jan 29 2026 03:17:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个叫 ClawdBot 的开源项目，可能是最近最火的 GitHub 项目了。最近几天的 Star 从 5K 飙升到了 5W+ Star。它把主动型、本地 AI 助手做成了一个可跑的现实项目，而不是停留在概念层面。本文就手把手教你部署 MiniMax 2.1 + ClawdBot，快速上手。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfcd9783809845138bfdb57a46c1cfb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=Ozwuh9K%2FjA3HyNN30MKRexsT4DQ%3D" alt="图片" loading="lazy"/></p>
<p>ClawdBot 是一个开源的个人 AI 助手，跑在你自己的设备上，入口是你手机上的聊天应用，能够 24 小时 7 天不间断工作。这个开源项目要的权限很高，所以很多人不会直接在自己电脑上部署。而是专门买一台 Mac Mini 来跑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e77e4be81e9d4823a9f7fc2aa57c2958~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=FVFpw8GGQM3MWwKgMPMffLkWOW0%3D" alt="图片" loading="lazy"/></p>
<p>近期这个开源项目火起来一个原因就是它带动了 Mac Mini 的销量，网上有很多 Mac Mini 被抢光的讨论。<br/>
另外有一个提醒：由于玩起来 Clawdbot ，得授权很高的系统权限，如果直接暴露在公网且没有防护，非常危险。新手小白搭建的时候一定不要忽略安全性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/141d293df3884058b11860da586c7af7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=JTT0umlYzPF%2Fmr1umjpCsey70nQ%3D" alt="图片" loading="lazy"/></p>
<p>有安全大佬建议设置： Cloudflare Tunnel + Zero-Trust login 或者 Nginx + HTTPS + password，这样 Clawd 就绝不会在没有认证的情况下暴露给外界。国内开发者推荐接入 MiniMax 2.1 作为 ClawdBot 的 AI 大脑，它在工具调用方面表现非常出色，而且相当准确。<br/>
MiniMax 2.1 与 Clawdbot 高度适配，并且配合 Coding Plan 套餐，性价比超高。而且 ClawdBot 的作者本人也多次推荐使用 MiniMax M2.1。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ff32f9dfa294db19d8627def37aefa6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=NZNDxVXB1sY5DzlP1ShQQ8fKFG8%3D" alt="图片" loading="lazy"/></p>
<p>01</p>
<p><strong>开源项目简介</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3431092f0cc34834867084ae37828f34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=V9Zp4wN95cLnyI3eGvvpWtD%2BZXw%3D" alt="图片" loading="lazy"/></p>
<p>你可以把 ClawdBot 接入到 WhatsApp、Telegram、Slack、Discord、Google Chat、Signal、iMessage 等聊天软件里面。直接在聊天框和 ClawdBot 沟通，和他聊天、让他帮你干活儿。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e9ef41b2606459faf476b621124cee1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=cScQzXmwBoaQmZNHtk8eaCLfyYg%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/clawdbot/clawdbot</span>
</code></pre>
<p>和 ChatGPT 这种 AI 助手相比，除了 ClawdBot 在聊天应用里面使用，还有下面几个核心能力维度。① 主动性像是 ChatGPT、Siri 都是你问它答，但是这个开源项目可以先找你，比如场景是每天早上发一份结合日历、Todoist、Notion、邮件的日常简报。定时检查航班、订阅源、价格变化，满足条件就给你发消息啥的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/969b1240e38341e79902417204c56107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=sgJ3%2BKPOfgSj4YAJ%2B8jpsN%2B%2BJ8g%3D" alt="图片" loading="lazy"/></p>
<p>② 系统级操作与自动化ClawdBot 很敢给自己系统级权限，目前这一点外网讨论很多，很多人不敢把它部署在自己日常使用的电脑上，都是先跑在一个闲置设备上。比如获取文件系统权限，可以读写文件，整理文档、生成报告、归档日志。还有 Shell 命令，能执行脚本、部署项目、跑测试、重启服务。也能浏览器控制，通过受控的 Chrome 完成网页浏览、表单填写、抓取数据。甚至集成外部服务，比如邮件、日历 、Notion啥的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a4efb91db504ee29b0dbdb08d083e9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=l1HOa%2FXr5ad0l0Vmoj3IJ6PZ56Q%3D" alt="图片" loading="lazy"/></p>
<p>③  持久记忆与个性化它有 <strong>Persistent Memory</strong> ，能记住你的个人偏好、项目结构、常用网站啥的。背后长期任务的上下文，可以不用每个对话都从头开始，而且记忆存储在本地电脑上，可持久化管理，隐私上对一些用户更可接受。④ Skills 与插件生态 </p>
<p>现在已经有 awesome-clawdbot-skills 项目了，列出 565+ Skill，按用途分类。</p>
<p>这个 ClawdBot 的武器库可以收藏起来，你能在这里下载各种插件来把你的 AI 变成超级助理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/630c5adf98864482a087caee94bbb96c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=70wZjNQswxTkjqqEvRkYIo3qOf4%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">开源地址：https://github.com/VoltAgent/awesome-clawdbot-skills
</code></pre>
<p>Skill 的安装方式也很简单：</p>
<p>直接把技能目录下载下来，放入 ~/.clawdbot/skills/ 就行了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe77269224dd41e5bf8b24defaaf650c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=B8OBJ0eKIX2FSypInQLAcQqjGuU%3D" alt="图片" loading="lazy"/></p>
<p>02</p>
<p><strong>如何使用</strong></p>
<p>① 准备工作</p>
<p>在开始之前，你需要准备：</p>
<p>API Key: 推荐使用 MiniMax API Key，前往 MiniMax 的开放平台获取密钥，后面会用到。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bb9202bb3d24d589bf6bda0189b8a30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=2PzaTUBzDlKjaJfvrbVXRKio%2F%2Fw%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-vbnet" lang="vbnet">开放平台地址：https://platform.minimaxi.com/user-center/basic-information/<span class="hljs-keyword">interface</span>-<span class="hljs-keyword">key</span>
</code></pre>
<p>Node.js: 如果通过源码或 npm 安装，需要 Node.js v22 或更高版本。</p>
<p>聊天软件账号: 如 WhatsApp 手机端、Telegram 账号（需申请 Bot Token）。</p>
<p>② 使用 npm 命令行部署</p>
<p>这是官方最推荐的方式，自带向导，配置最简单。打开终端，运行以下命令全局安装：</p>
<pre><code class="hljs language-ruby" lang="ruby">npm install -g clawdbot<span class="hljs-variable">@latest</span><span class="hljs-comment"># 或者使用 pnpm (推荐)# pnpm add -g clawdbot<span class="hljs-doctag">@latest</span></span>
</code></pre>
<p>③ 运行初始化向导</p>
<p>安装完成后，运行 onboarding 向导，它会引导你完成所有配置，比如 API Key、聊天软件连接等：</p>
<pre><code class="hljs language-css" lang="css">clawdbot onboard <span class="hljs-attr">--install-daemonclawdbot</span> gateway <span class="hljs-attr">--port</span> <span class="hljs-number">18789</span> <span class="hljs-attr">--verbose</span># 发送一条消息clawdbot message send <span class="hljs-attr">--to</span> +<span class="hljs-number">1234567890</span> <span class="hljs-attr">--message</span> "Hello <span class="hljs-selector-tag">from</span> Clawdbot"# 与助手对话（并可选择将回复发回给任何已连接的渠道，如 WhatsApp、Telegram、Slack 等...）clawdbot agent <span class="hljs-attr">--message</span> "Ship checklist" <span class="hljs-attr">--thinking</span> high
</code></pre>
<p>重点是输入了 onboard 向导后的步骤，可以参考我下面的步骤：</p>
<p>首先会让你知悉 Claudbot 很强的也会有潜在危险，继续就行了。然后你可以选择 QuickStart，然后再模型提供商的地方选择 MiniMax 2.1</p>
<p> 然后把你刚刚复制的密钥粘贴进去就行了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/328f87c906844627851973922c8b0900~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=awdLH%2FYVUI2M6AWoVAm503%2BHpRg%3D" alt="图片" loading="lazy"/></p>
<p>然后要选着一个聊天应用的渠道了，我这里使用的是 WhatsAPP。</p>
<p>你需要有一个美区账号的 AppleID，然后登录 AppStore 后下载 WhatsAPP。手机下载完成后，就可以先登录一下。</p>
<p>手机上登录成功后，你可以回到命令行终端，选择 WhatsAPP。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/495058842d854a1cb35b4c3bed900324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=ikw3rbUQvzIFNnbVCMz4%2FfHy768%3D" alt="图片" loading="lazy"/></p>
<p>然后在终端会显示两个二维码，你打开 WhatsAPP 扫描就行了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d05ec65614c64c03be2e90ca2d4018d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=06%2F%2FPoi7ozl%2F1S8c1EDCyI3zQLM%3D" alt="图片" loading="lazy"/></p>
<p>然后输入手机号，注意前面需要加上国家代码，比如中国 +86。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e590310ba63049219bf19fbc87c65b0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=XC7GN4bGLHMVhHMQ1PxP7boPlcI%3D" alt="图片" loading="lazy"/></p>
<p>输入完手机号，可以选择 Open the Web UI。这个时候会在你浏览器打开一个控制台，你可以在控制台里面管理你的 Clawdbot。</p>
<p>然后你自己的 WhatsAPP 账号就加持上了 MiniMax 了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d48fce9852b4feb897f1c83f0a3c47e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=XTro6JluB9IdWp%2Fuyt6pB3oMS8Q%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/590e003ca3094fc0a56d8ce7b80c3be8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261648&amp;x-signature=Wqq9k8r5T0WczzbVHYbgXMcaaIU%3D" alt="图片" loading="lazy"/></p>
<p>另外下面这个视频是使用 Telegram + MiniMax 2.1 + ClawdBot 的教程，感兴趣的可以看看：</p>
<pre><code class="hljs language-arduino" lang="arduino">地址：https:<span class="hljs-comment">//www.bilibili.com/video/BV1TNzYBiER6</span>
</code></pre>
<p>视频讲解原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlAlkNb4wUHAVKh5zXI_FVg" target="_blank" title="https://mp.weixin.qq.com/s/lAlkNb4wUHAVKh5zXI_FVg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/lAlkNb4wU…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vivo GPU容器与 AI 训练平台探索与实践]]></title>    <link>https://juejin.cn/post/7600326947505406004</link>    <guid>https://juejin.cn/post/7600326947505406004</guid>    <pubDate>2026-01-29T03:19:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326947505406004" data-draft-id="7600326291553419270" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vivo GPU容器与 AI 训练平台探索与实践"/> <meta itemprop="keywords" content="容器,云原生,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T03:19:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vivo互联网技术"/> <meta itemprop="url" content="https://juejin.cn/user/993614243303053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vivo GPU容器与 AI 训练平台探索与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614243303053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vivo互联网技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:19:24.000Z" title="Thu Jan 29 2026 03:19:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：互联网容器团队-Chen Han、AI 研发团队 - Liu Dong Yang</p>
<p>在大规模GPU容器集群与模型训练场景，面临稳定性和资源利用率等多重挑战。本文展示vivo GPU平台的总体架构，介绍容器平台在大规模GPU容器集群稳定性建设措施，以及探索多种GPU容器降本提效的解决方案。分享AI工程训练平台大规模训练稳定性建设，及GPU利用率提升实践经验。</p>
</blockquote>
<p>本文为2025年 vivo 开发者大会互联网技术专场分享内容之一，在微信公众号“vivo互联网技术”对话框回复【2025VDC】获取 2025VDC 互联网技术会场议题相关资料。</p>
<p>1分钟看图掌握核心观点👇</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f610388f42a4f9cbe3452976e0c1952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=rNJ0I0TqsghC55Rt%2B0TFJQJnH2g%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/965bab3924e84ea1bc9b77b3eeb96f52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=CFXE9iXpoLbfXYuHuIvJl1pKCXk%3D" alt="图片" loading="lazy"/></p>
<p><em>图1 VS 图2，您更倾向于哪张图来辅助理解全文呢？欢迎在评论区留言</em></p>
<h2 data-id="heading-0">一、GPU平台架构</h2>
<p>vivo的GPU平台由物理层、容器平台层与AI工程层三方面构成。由多种GPU服务器和分布式存储以及高性能网络等基础设施，构成了可靠的物理层。容器平台层的GPU容器能力，主要包含了资源管理、编排调度、GPU虚拟化与多容器网络这四个方面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40514a3f9b6d4d73be8830a7647e285b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=E0maMkvhnf45qBtegOrF7L3pshI%3D" alt="图片" loading="lazy"/></p>
<p>其中资源管理，表现为多种架构资源池的部署与管理能力。编排调度能力，由GPU弹性伸缩、训推潮汐部署以及多种卡调度策略组成。自研的GPU虚拟化囊括了业界主流的MIG虚拟化、内核层虚拟化以及CUDA层虚拟化三种技术。由传统的Underlay网络以及SRIOV的RDMA直通网络，组成了丰富的容器网络架构。容器平台提供了开放的API接口，为AI工程层的训练和推理平台，提供了坚实的算力底座。通过训练和推理平台，支撑公司内的智能计算业务。</p>
<h2 data-id="heading-1">二、GPU容器能力实践</h2>
<p>GPU容器能力实践分为两个模块，首先是大规模容器集群稳定性建设，其次是GPU容器提效降本方案。先了解下容器平台在大规模容器集群场景，如何进行稳定性建设的。</p>
<h3 data-id="heading-2">2.1 大规模容器集群稳定性</h3>
<p>集群稳定性是一切的基石。当集群规模大时，任务多，调度频繁，导致核心组件负载激增，极易发生集群崩溃。随着节点规模扩大，运维复杂度呈指数级增长，日常运维工作繁重，发现问题不及时。同时故障处理也面临严峻挑战，故障中涉及的复杂场景多，故障处理的难度大。稳定性建设需要解决上述问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c044968771b44386ae6a2834a092ff5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=jwKOODpcVjxXUCx944%2Ff8Fxsv%2FM%3D" alt="图片" loading="lazy"/></p>
<p>为了解决高频调度导致的核心组件高负载问题，我们针对Apiserver、etcd、CoreDNS，这3个核心组件进行了架构和性能优化，具体的方案如图所示。通过这些优化手段提升了组件性能，并且降低了组件负载，有利于大规模集群的平稳运行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21cadb9c98614277a832575f4e719778~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=vm8tJrN40PkZZ3n4Vp3SIzpAl2E%3D" alt="图片" loading="lazy"/></p>
<p>为了减轻集群运维负担，我们重点建设了自动化节点管理方案。把重复性的运维事项自动化。同时我们还完善了监控告警体系，开发了自动化巡检功能，使运维人员能够及时发现集群问题，快速介入，处理潜在风险，保障集群能够长久稳定运行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5892abaf577e409883b4a749c5aeddf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=CH%2FVIo7rUmr15enKVtEyvVTdJhI%3D" alt="图片" loading="lazy"/></p>
<p>故障处理是集群稳定的兜底措施，我们针对多个核心组件都做了，各类故障处理预案。结合可能存在的故障特点，构造故障场景，进行故障恢复演练，确保故障发生时，能够第一时间找到合理的解决方案，准确的处理问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f13d9e95b524726afb8fa156a234db7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=Bag2qkh2kYkcBft5whX8VvUB%2FDE%3D" alt="图片" loading="lazy"/></p>
<p>通过上述的措施，在集群稳定性方面取得了不错的效果，首先日常的集群可用性稳定保持在99.99%水平，其次平台的年度故障复盘数相较于上一年下降60%。核心组件方面的优化也达到了不错效果，其中Apiserver的CPU负载下降70%，etcd提交延迟，从秒级缩短到毫秒级，CoreDNS的毛刺现象消失了，并且负载量下降了90%左右。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/585ef08de25b47c0b6a253fc2d34c01a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=aYFN2UFuDuY9R6AuWMi5zgXLuk0%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 GPU容器提效降本实践</h3>
<p>容器平台的核心竞争力之一就是助力业务提效降本，我们从不同业务维度，对GPU容器提效降本方案进行了探索。</p>
<ul>
<li>
<p>首先在<strong>单卡</strong>维度，通过自研GPU虚拟化方案，使多个容器，互不干扰的共享一张卡资源。</p>
</li>
<li>
<p>其次是在<strong>单服务</strong>维度，使业务能够自动应对，负载变化的GPU弹性扩缩容方案。</p>
</li>
<li>
<p>在<strong>多服务</strong>维度，能够让推理服务和训练服务，分时复用整机资源的，训推潮汐部署方案。</p>
</li>
<li>
<p>最后是在<strong>多机多卡的分布式场景</strong>中，让GPU容器搭配RDMA网络，来解决跨节点通信的瓶颈问题。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41c3006334e14aa9a88a08f7bc6d79f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=nFKAVZFdCKLN232n306A%2FaugzGQ%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-4">2.2.1 单卡共享-GPU虚拟化</h4>
<p>如何让一张卡同时运行多个容器又不互相干扰，就涉及到GPU虚拟化技术。GPU虚拟化一直是AI云原生领域的热门话题之一，各大云厂商都有成熟的解决方案售卖。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c93ac3dc94e41218a151bd332dd36cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=PswBklmkC%2BWeoUwsqrI9b3cS8A0%3D" alt="图片" loading="lazy"/></p>
<p>vivo容器平台的自研GPU虚拟化方案，主要为了解决业务的三大痛点，</p>
<ul>
<li>
<p>首先是部分推理业务负载偏低，无法有效用满整卡资源，需要通过共享部署方式，减少资源总量，降低业务成本，提升利用率。</p>
</li>
<li>
<p>其次是不同业务共享同一张卡时，对于安全性以及隔离性的要求各不相同，就需要使用不同的GPU虚拟化技术来满足不同业务诉求。</p>
</li>
<li>
<p>最后在Dev开发机场景，用户使用频率偏低，需要通过显存超售，来提升资源复用率，但显存超售后又需要避免某个用户将显存耗尽，导致OOM错误影响同卡的其他用户。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/513192fe9fdd49e9bcf7effe4068ae84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=lpwEA0onGkY6HOXUt%2F%2BYvZ6ez9c%3D" alt="图片" loading="lazy"/></p>
<p>自研GPU虚拟化方案包含MIG虚拟化、内核层虚拟化、CUDA层虚拟化这三种技术。结合业务场景，提供了丰富的卡调度策略，例如尽量聚集的Binpack策略、尽量分散的Spread策略，每个卡只有一个实例的CardOnlyOne策略，以及自定义节点和卡分配关系的CustomTopo策略。通过自研模块与组件，接入Kubernetes体系，对外提供统一调度能力。</p>
<p>首先，MIG虚拟化技术，是基于Nvidia硬件提供的，切块组合能力，能够按规则把计算单元和显存单元进行组合，组成MIG实例挂载到容器内，提供完全独立的运行环境。MIG方案的优点是拥有Nvidia官方支持，可以集成到自研体系中。由于是在硬件层面实现的算力和显存限制，所以隔离性和安全性最好。缺点就是仅支持Ampere及以后架构的部分卡，而且限定了切分比例。主要应用场景是对算力隔离有强需求的线上业务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e0bcdfe9145439ebda4d093f8f979ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=jo98WPPuM5ed3oZZsnw4vJDEpZ0%3D" alt="图片" loading="lazy"/></p>
<p>内核层虚拟化技术，是通过自研内核模块，创建虚拟字符设备替换原有的Nvidia字符设备，在内核态拦截IOCTL请求后，实现的算力和显存限制。优点是上层应用无感。并且内核态拥有良好的安全性。缺点是当前无开源方案，开发难度大，而且算力隔离的并不充分。主要应用场景是常规线上业务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/123b51ecf8144a65a71da9193a2fb250~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=f3%2FX%2F8fOZ02eZy%2BsFUsHL0fde5k%3D" alt="图片" loading="lazy"/></p>
<p>CUDA层虚拟化技术的原理：使用拦截库替换Nvidia Driver的原始库，建立拦截库与原始库的，API函数映射关系，从而拦截调用函数，实现算力和显存的限制。</p>
<p><strong>优点</strong>是有开源方案，使用起来比较灵活。并且可以基于Nvidia提供的统一内存模型，开发显存超售能力。能够在显存不足时，使用内存替代，虽然处理速度下降，但是能够有效避免，显存OOM导致用户程序报错。</p>
<p><strong>缺点</strong>是用户态导致安全性不足，并且算力隔离能力偏弱，主要应用场景是Dev开发机场景。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1407fe26b0914d4da9be7f98aaab12c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=1nMyluLUOYueribk9%2FV8FfulyL4%3D" alt="图片" loading="lazy"/></p>
<p>将自研的内核层虚拟化方案与业界方案，进行了自测性能对比，如图所示，可以看到自研方案在性能上，已经达到业界先进水平。业务使用该方案，与独占整卡部署相比较，平均单卡虚拟化率300%左右，就是把1张物理卡当3张卡使用，同时整机GPU利用率提升了30%+，成本优化超过50%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7b07f0e83e4433999e0996cb4f2612d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=cvWayCoVmBPMIpIFhBcq4eAUgZ0%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-5">2.2.2 服务提效-GPU弹性扩缩容</h4>
<p>在单服务维度，如何帮助业务自动管理大量的GPU容器是提效的关键。我们引入了GPU弹性扩缩容方案。</p>
<ul>
<li>
<p>首先弹性扩缩容能力，能够快速响应负载变化，自动调节实例数量，减少人工干预次数，有利于业务在突发场景的平稳运行。</p>
</li>
<li>
<p>其次是业务方在生产环境部署后，非生产环境的实例通常会闲置，这会浪费稀缺的GPU资源。</p>
</li>
<li>
<p>最后由于Kubernetes原生，并不支持GPU维度的弹性扩缩容，需要寻找合适的方案来满足业务诉求。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b64c279ed15c46b688f06fcb4f2871df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=lytvtiS3nbvu2hvvGM2pGcC%2Fn%2BU%3D" alt="图片" loading="lazy"/></p>
<p>如图所示，我们是基于开源的KEDA框架，自研了GPU-Scaler组件，使用Prometheus中存储，来自DCGM-Exporter的GPU指标，汇聚为扩缩容事件，用于触发KEDA框架，调整实例个数，以此实现了GPU弹性扩缩容能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f66deb2e0b94989a3f522946a206b8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=cgV8MLkqiWu6xuxsPYPdTCmfOkc%3D" alt="图片" loading="lazy"/></p>
<p>由于KEDA框架支持将Workload实例数缩容到0，所以在非生产环境部署的GPU业务，默认开启无负载时，自动缩容到零的功能，以此自动回收，长期闲置的GPU资源。</p>
<p>最终的使用效果，线上业务资源不足类告警，下降了80%，单业务平均减少约每周1小时的，扩缩容工作量，有效降低了GPU业务的运维成本。</p>
<h4 data-id="heading-6">2.2.3 多服务降本-训推潮汐部署</h4>
<p>在多服务维度，训练服务的资源短缺问题，与推理服务，低峰时段资源空闲问题，相对突出。考虑让训练业务利用推理的空闲资源，即训推潮汐部署方案。</p>
<p>首先推理和训练业务都需要稳定的运行环境。而且推理业务潮汐特征明显，夜晚负载低，资源空闲多，导致平均利用率偏低。并且多机多卡训练任务，需要整机资源，且资源需求日益增长，采购新设备，难且慢，导致训练资源缺口明显。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2b8f967cbbd46a78e5fc661c7c8a728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=AADmXZ1GVlboJgJcM8MrdEEeY34%3D" alt="图片" loading="lazy"/></p>
<p>训推潮汐部署就是整机资源分时复用的逻辑，如图所示，推理业务在白天高负载时，稳定运行，在夜晚低峰时段，自动腾挪出空闲整机资源，借给训练业务使用。在清晨时段，训练业务结束，把整机资源还给推理业务，如此达到分时复用的效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6680369cbf7744fbafdcc9be81d155fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=qjeCCYhziFkWol0OBpzm%2FV2TyF0%3D" alt="图片" loading="lazy"/></p>
<p>如图所示。推理业务在部署前，需要评估保底负载容量。在部署时填入维持业务稳定的最少Pod数量。基于OpenKruise组件的，WorkloadSpread功能，管理不同的Subset，分别在稳定池和潮汐池中按需部署。同时配置CronHPA，定时缩容，自动调整副本数，到稳定Pod数量，优先删除潮汐池中的Pod。以此达到把潮汐池的节点整机腾空的效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee6672408c9142aab12b3bfd61542a0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=rwKAjkUz8bZux88aFmyakH2hp68%3D" alt="图片" loading="lazy"/></p>
<p>其中我们还针对Workload的缩容优先级进行了优化。当缩容发生时，结合Pod和节点的拓扑关系，把所在节点实例数少的Pod优先缩容，达到更快的腾空效果。</p>
<p>通过上述方案，训推潮汐部署的降本效果明显，使推理业务，成本下降30%，同时整机GPU利用率提升20%多，有效缓解了训练资源短缺问题。</p>
<h4 data-id="heading-7">2.2.4 多机多卡提效-容器RDMA高性能网络</h4>
<p>当前分布式训练和推理业务，对算力和显存的需求巨大，单节点资源不足，需要使用多机多卡资源，那么网络通信容易成为性能瓶颈。RDMA技术允许GPU直接访问支持RDMA设备中的数据，无需经过主机CPU或内存，实现跨节点的零拷贝数据传输，有效减少了CPU开销和网络延迟。所以从多机多卡维度，使用RDMA技术是网络提效的有效措施。从容器平台角度，GPU容器更加需要结合RDMA技术，提供简单高效的解决方案，方便业务使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e71cb5a733d414fb0d89c24f3199d34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=9AFXKNbgQHT%2BIOZ0m1Mkz%2BRuAT4%3D" alt="图片" loading="lazy"/></p>
<p>如图所示，RDMA容器有两个网卡，一个是使用Calico-CNI插件，通过veth创建的eth0网卡，对应的是Underlay网络。另一个是使用Sriov-CNI插件，通过VF创建的eth1网卡，对应的RoCE_v2或IB协议网络。我们引入了Multus-CNI组件，能够在单容器创建时，按需调用多种CNI插件。同时我们选择使用Spiderpool组件管理IP池，以及进行IP分配和路由策略配置。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee61f6cfb5214b9987b4cde75814645f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=ryoufoO7IclEjNZcBw5HGFLl1qw%3D" alt="图片" loading="lazy"/></p>
<p>通过上述组件，在Kubernetes体系中实现了RDMA容器的全生命周期管理能力。基于容器RDMA能力，在大规模训练和推理场景，业务能够提速20%到30%之间，提升效果明显。</p>
<h2 data-id="heading-8">三、AI工程训练平台实践</h2>
<h3 data-id="heading-9">3.1 训练平台整体架构</h3>
<p>VTraining训练平台是由vivo AI计算平台团队打造的一站式大模型训练方案，它面向算法工程师，提供模型开发、模型训练和海量样本存储等能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/934a7d65fadb4286b22c68f309f21cd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=065e2GaSIMxbo4T8VB7WHZQn8%2F8%3D" alt="图片" loading="lazy"/></p>
<p>VTraining底层是基于vivo容器平台、及高性能计算、网络、存储等基础设施之上构建，通过提供模型开发、模型训练、资产管理等能力，支撑公司的大模型训练业务。</p>
<p>像vivo手机的蓝心小V、相册等核心产品的大模型训练，都是在VTraining平台进行迭代的。</p>
<h3 data-id="heading-10">3.2 大规模训练稳定性实践</h3>
<h4 data-id="heading-11">3.2.1 稳定性背景</h4>
<p>稳定性问题是大规模训练的痛点。任务在大规模的同步训练过程中需要依赖计算、网络、存储、容器调度等复杂的基础设施环境，任何环节出问题都会导致任务中断，问题定位、恢复困难。</p>
<p>例如知名头部公司千亿参数大模型的大规模训练任务，平均每3小时触发一次意外中断。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e284e4a958c846d89ac7bbe139a86af5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=KFuGl5XZPBY7RYf%2FarzEOnNukJg%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-12">3.2.2 稳定性实践-高频故障专项治理</h4>
<p>其中一个问题，是GPU集群投入使用初期机器故障率会很高，训练任务会经常被中断。为了降低机器故障率，我们进行了高频故障专项治理。首先对GPU集群进行了大规模测试诊断、然后进行高频故障统计和修复，把有问题的软硬件进行维修、替换、升级或修复。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c255b7e4da294b20ab953068f48da4b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=Nwn5wJvewUyTXT0NLtEPs%2BbbDnk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-13">3.2.3 稳定性实践-故障处置流程完善</h4>
<p>另一个问题，是任务故障就是不可避免的，所以为了缩短任务中断时间，尽快恢复任务运行，我们对故障处置流程进行了重点建设完善。</p>
<ul>
<li>
<p>**训练前，**我们会针对GPU机器、网络通信等环境进行大规模检测，剔除异常节点、慢节点等问题节点，降低故障风险。</p>
</li>
<li>
<p>**训练中，**会开启自动化容错机制，以便能及时发现基础设施或任务异常，快速进行故障定位和故障容错，自动隔离故障、自动重启恢复任务运行。</p>
</li>
<li>
<p>**训练后，**对新问题进行搜集分析，完善异常特征库，增强问题诊断能力，以便后续遇到类似的故障可以快速容错。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5909555e25741adb4f3c50d2abdc31c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=4chGfVx5Avb%2FNqKTDTTervXKfGM%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-14">3.2.4 稳定性实践-效果与总结</h4>
<p>通过减少基础设施高频故障、完善任务故障处置流程两大措施，我们取得了良好效果：机器每天故障率由原来的百分之二下降到千分之一；千卡任务有效训练时长由原来的60%提升到99%，达到了行业一流水平。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6be76074c14706a6e7fb554618a3d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=Qw5t%2BgpfdLTEa9AbgFS8TAHnJT8%3D" alt="图片" loading="lazy"/></p>
<p>同时我们也积累了相关的稳定性经验：</p>
<ul>
<li>
<p>GPU集群由不稳定到稳定，需要一个软硬件磨合过程。因为不同的软硬件环境会触发不同的稳定性问题。</p>
</li>
<li>
<p>大规模训练前，尽量剔除历史故障率高的机器。我们发现稳定的机器一般会一直很稳定，而故障率高的机器即使修复后出问题的概率也比较大。</p>
</li>
<li>
<p>提升任务有效训练时长，需结合基础设施、训练框架、平台容错机制综合优化。例如秒级监控告警能力、checkpoint持久化策略等等都需要进行持续深入的优化。</p>
</li>
</ul>
<h3 data-id="heading-15">3.3 GPU利用率提升实践</h3>
<h4 data-id="heading-16">3.3.1 GPU利用率提升-业务背景及问题</h4>
<p>GPU是稀缺资源，但是差异化的业务场景下GPU难以高效利用，利用率提升困难。比如GPU场景常见业务形态：有训练任务、推理业务、数据生产、开发调试等等类型。他们各有特点：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2849b45a128f445791877026394dd373~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=uuHfG25qytlSK0bvXCjjK%2BPQMTA%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p>训练任务虽然GPU利用率高，但是偶尔也会出现碎片化空闲资源，比如算法同学偶尔会将任务停下来排查问题，调下参数之类的操作，任务并不是一直不间断地在跑的。</p>
</li>
<li>
<p>推理业务有很明显的潮汐特性，白天流量高峰期GPU利用率高、到了夜间流量低峰期利用率会比较低。</p>
</li>
<li>
<p>数据生产任务属于离线任务，GPU利用率高、资源需求大、但难申请到资源；开发调试任务的话GPU利用率低并且要长期占用资源，导致GPU利用率长期低下。</p>
</li>
</ul>
<p>所以不同的业务形态有不同的利用率特点，接下来介绍下我们的GPU利用率提升措施。</p>
<h4 data-id="heading-17">3.3.2 利用率提升措施一：低优任务</h4>
<p>对于训练任务场景，偶现的碎片化空闲资源，我们 通过低优数据生产任务进行充分利用。如图所示，我们通过低优数据生产任务调度，复用训练场景偶现的碎片化资源，当正常任务需要资源时，可随时抢占低优资源，不会影响正常训练任务的调度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69b3f0eb5383463b8c0dca2505ea68b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=zJ0tag%2FQVuDv6zCjN61k4ZV2Rw0%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-18">3.3.3 利用率提升措施二：训推潮汐部署</h4>
<p>对于推理业务场景，在夜间流量低峰期可以释放大量GPU资源，我们通过训推潮汐部署给离线业务复用。如图所示，通过训推潮汐部署机制，我们将夜间推理流量低峰期缩容的机器腾挪到了离线GPU资源池，给离线业务使用，白天再腾挪回在线GPU资源池进行扩容，达到潮汐复用的目的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa3106c6e2b54b49a0c885936c61b966~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=xLukEvUN4VxG3vPx8h4Qux6Mo9s%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-19">3.3.4 利用率提升措施三：GPU虚拟化</h4>
<p>对于开发任务场景，长期独占GPU资源且利用率低，我们通过vivo自研VGPU虚拟化技术，减少开发任务占用的物理GPU卡数，释放冗余算力。如图所示，我们可以将单机4卡GPU机器，通过开启VGPU虚拟出16卡VGPU，相当于一卡顶四卡。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b203bed4af94079ba6d6062b0798c56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=cG7KbAKgNuo5IDRuMk6uVaWCaCo%3D" alt="图片" loading="lazy"/></p>
<p>VGPU的优点是：可支持1:2、1:4超卖、还可以用内存补充显存不足，所以对用户是无感知使用的，很适用于开发任务这种对性能要求低的场景。</p>
<h4 data-id="heading-20">3.3.5 利用率提升总结与规划</h4>
<p>总之，训练平台通过低优任务、训推潮汐部署、GPU虚拟化等策略，深度适配差异化业务场景特性，实现了资源高效复用。AI整体GPU利用率均值绝对值提升了5个百分点，接近行业一流水平。</p>
<p>未来训练平台也会持续对GPU利用率进行综合治理。例如进行低效任务治理、低效资源盘活、成本账单统计、奖励与惩罚措施的实施等等，让稀缺的GPU资源发挥更大价值！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0739f9a9f3ec4772a903d180869e8d7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=uubFbO4j7y28l2fbNTrmem5OdYU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-21">四、GPU平台未来展望</h2>
<p>在容器平台层面，我们会从多集群联邦调度、在离线GPU混部、国产异构计算芯片支持、GPU资源池化等方面能力进行综合建设，支撑上层平台业务对GPU资源的高效利用。</p>
<p>训练平台层面，我们会增强故障预警、任务动态容错等能力，增强业务稳定性；同时完善对大模型训练全流程能力的支撑，以及对GPU资源进行更精细化的运营，从而让GPU业务更加稳定、资源利用更加高效！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b301ae38a4834eb688ca93739460d36d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-S6kuiBlOe9keaKgOacrw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770261754&amp;x-signature=s5Y3WgLkM4vipBakI8NJY4LDAyA%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-状态管理进阶：useImmer进阶指南]]></title>    <link>https://juejin.cn/post/7600489282822553650</link>    <guid>https://juejin.cn/post/7600489282822553650</guid>    <pubDate>2026-01-29T03:20:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282822553650" data-draft-id="7600303087875604518" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-状态管理进阶：useImmer进阶指南"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2026-01-29T03:20:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-状态管理进阶：useImmer进阶指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:20:13.000Z" title="Thu Jan 29 2026 03:20:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在 React 中，状态是不可变的（Immutable）。当我们使用 <code>useState</code> 处理深层嵌套的对象或大型数组时，频繁的结构解构会让代码变得支离破碎。<strong>useImmer</strong> 的出现，让我们能够以“声明式修改”的方式，享受“不可变数据”带来的性能红利。</p>
<h2 data-id="heading-1">一、 为什么需要 useImmer？（产生背景）</h2>
<p>在原生 <code>useState</code> 中，更新一个深层嵌套的对象通常是痛苦的：</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-comment">// useState 的痛苦写法</span>
<span class="hljs-title function_">setUser</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
  ...prev,
  <span class="hljs-attr">address</span>: {
    ...prev.<span class="hljs-property">address</span>,
    <span class="hljs-attr">city</span>: <span class="hljs-string">'Beijing'</span>
  }
}));
</code></pre>
<p><strong><code>useImmer</code> 的核心优势：</strong></p>
<ol>
<li><strong>告别展开运算符</strong>：不再需要层层 <code>{...state}</code>。</li>
<li><strong>原生语法支持</strong>：可以直接使用 <code>push</code>、<code>pop</code>、<code>splice</code> 等会改变原数组的方法，而无需担心破坏不可变性。</li>
<li><strong>代码高可读性</strong>：逻辑更接近于直接修改对象，代码简洁直观。</li>
</ol>
<hr/>
<h2 data-id="heading-2">二、 基础语法与 TSX 实战</h2>
<p>在使用前，请确保已安装：<code>npm install immer use-immer</code>。</p>
<h3 data-id="heading-3">1. 处理复杂对象</h3>
<p>在 TSX 中，建议为状态定义明确的 <code>interface</code>。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { useImmer } <span class="hljs-keyword">from</span> <span class="hljs-string">"use-immer"</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserProfile</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">info</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  };
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserSettings</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> [user, setUser] = useImmer&lt;<span class="hljs-title class_">UserProfile</span>&gt;({
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">info</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"Gemini"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> }
  });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateName</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 这里的 draft 是一个 Proxy 代理对象</span>
    <span class="hljs-title function_">setUser</span>(<span class="hljs-function">(<span class="hljs-params">draft</span>) =&gt;</span> {
      draft.<span class="hljs-property">info</span>.<span class="hljs-property">name</span> = <span class="hljs-string">"New Name"</span>; <span class="hljs-comment">// 直接修改属性，极其丝滑</span>
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>姓名: {user.info.name}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{updateName}</span>&gt;</span>修改姓名<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">UserSettings</span>;
</code></pre>
<h3 data-id="heading-4">2. 处理数组</h3>
<p>无需再使用 <code>[...list, newItem]</code>。</p>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ListDemo</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> [list, setList] = useImmer&lt;<span class="hljs-built_in">string</span>[]&gt;([<span class="hljs-string">"React"</span>, <span class="hljs-string">"Vue"</span>]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addItem</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setList</span>(<span class="hljs-function">(<span class="hljs-params">draft</span>) =&gt;</span> {
      draft.<span class="hljs-title function_">push</span>(<span class="hljs-string">"Angular"</span>); <span class="hljs-comment">// 直接 push，Immer 会自动生成新数组</span>
    });
  };

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{addItem}</span>&gt;</span>{list.join(", ")}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
};
</code></pre>
<hr/>
<h2 data-id="heading-5">三、 核心避坑指南（注意事项）</h2>
<h3 data-id="heading-6">1. 性能边界：何时不该用？</h3>
<p>如果状态只是 <strong>数字、字符串、布尔值</strong> 等基本类型，请坚持使用 <code>useState</code>。</p>
<ul>
<li><strong>原因</strong>：<code>useImmer</code> 内部基于 <code>Proxy</code> 实现。为简单类型创建代理对象会带来额外的内存开销和计算耗时，得不偿失。</li>
</ul>
<h3 data-id="heading-7">2. Draft 的生命周期禁区</h3>
<p><strong>切记：不能将 <code>draft</code> 整体赋值给外部变量，或在异步闭包中使用。</strong></p>
<ul>
<li><strong>原理</strong>：<code>draft</code> 是一个基于 <strong>Proxy</strong> 的临时代理。它的使命在 <code>setState</code> 的回调函数执行完毕后就结束了。</li>
<li><strong>后果</strong>：如果你尝试在修改函数之外持有 <code>draft</code> 的引用，会导致状态更新逻辑错乱，或者触发“非法访问代理”的报错。</li>
</ul>
<hr/>
<h2 data-id="heading-8">四、 总结：useImmer 的心智模型</h2>
<p>你可以把 <code>useImmer</code> 想象成在<strong>草稿纸Draft</strong>上改写数据。你随便涂抹、修改、删除，当你提交（回调结束）时，Immer 会根据你在草稿纸上的改动，为你生成一份全新的、不可变的正式文档。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[同源策略 ≠ 万能盾牌：为什么你的后端仍需防范"盲打"攻击？]]></title>    <link>https://juejin.cn/post/7600489282822570034</link>    <guid>https://juejin.cn/post/7600489282822570034</guid>    <pubDate>2026-01-29T03:22:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282822570034" data-draft-id="7600260767687983130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 同源策略 ≠ 万能盾牌：为什么你的后端仍需防范&quot;盲打&quot;攻击？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T03:22:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Assby"/> <meta itemprop="url" content="https://juejin.cn/user/2496307079162410"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             同源策略 ≠ 万能盾牌：为什么你的后端仍需防范"盲打"攻击？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2496307079162410/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Assby
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:22:09.000Z" title="Thu Jan 29 2026 03:22:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<blockquote>
<p><strong>一个常见的认知误区</strong>：很多开发者认为浏览器的同源策略（Same-Origin Policy）已经阻止了跨域攻击，因此忽略了后端对请求来源的校验。然而事实残酷——同源策略只管"读"，不管"写"。恶意网站完全可以在你不知情的情况下，用你的身份执行转账、删号等高危操作。</p>
</blockquote>
<h2 data-id="heading-0">一、同源策略的"盲区"：它只管数据泄露，不管数据篡改</h2>
<p>当我们谈到浏览器安全时，同源策略（SOP）总是被首先提及。它确实有效地防止了以下场景：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你在 a.com 登录了银行</span>
<span class="hljs-comment">// a.com 的 JS 试图读取 b.com 的数据</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://b.com/api/balance'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)); <span class="hljs-comment">// ❌ 被浏览器拦截：CORS policy blocked</span>
</code></pre>
<p><strong>但是</strong>，如果我们换个写法——不关心服务器返回什么，只让服务器执行操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 恶意网站 evil.com 的代码</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://bank.com/transfer?to=hacker&amp;amount=10000'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-comment">// 甚至不需要处理响应...</span>
});
</code></pre>
<p><strong>会发生什么？</strong></p>
<ol>
<li>✅ 请求<strong>确实发出去了</strong>（带上了你的 Cookie）</li>
<li>✅ 银行服务器<strong>已经执行了转账</strong>（钱没了）</li>
<li>✅ 响应<strong>也回到了浏览器</strong>（你可以在 DevTools 里看到 200 OK）</li>
<li>❌ <strong>JS 拿不到响应数据</strong>（同源策略只拦住了这一步）</li>
</ol>
<p>这就是CSRF（跨站请求伪造）攻击的核心：<strong>恶意网站不需要知道你的余额，它只需要让你的浏览器去执行操作</strong>。</p>
<h2 data-id="heading-1">二、CSRF 攻击实战模拟</h2>
<p>想象这样一个场景：</p>
<p><strong>上午 9:00</strong>：你在银行网站 <code>bank.com</code> 登录，浏览器保存了 Session Cookie。</p>
<p><strong>上午 10:00</strong>：你没关浏览器，打开了钓鱼邮件里的链接 <code>evil.com</code>。</p>
<p><strong>evil.com 的 HTML</strong>（极其简单，甚至不需要 JS）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>精美壁纸下载中...<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 图片自动加载，触发 GET 请求 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://bank.com/transfer?to=attacker&amp;amount=50000"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"0"</span> /&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 或者自动提交的表单 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"csrf"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"https://bank.com/change-email"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"hacker@evil.com"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'csrf'</span>).<span class="hljs-title function_">submit</span>();</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<p><strong>结果</strong>：你的银行卡转账 5 万元，或者绑定邮箱被改成了黑客的。整个过程<strong>不需要 JavaScript 读取任何返回数据</strong>，同源策略对此<strong>完全无能为力</strong>。</p>
<h2 data-id="heading-2">三、后端校验：守护最后一道防线</h2>
<p>既然浏览器"靠不住"，<strong>服务端必须承担校验责任</strong>。目前业界主流的防御方案有三层：</p>
<h3 data-id="heading-3">1. CSRF Token（最经典可靠）</h3>
<p><strong>原理</strong>：在表单或请求头中嵌入一个随机生成的、只有服务器和当前页面知道的 Token。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 银行页面渲染时生成随机 Token --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/transfer"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"csrf_token"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"dW5pcXVlLWhhc2gtdmFsdWU="</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"amount"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1000"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>转账<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring Boot 示例</span>
<span class="hljs-meta">@PostMapping("/transfer")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">transfer</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String amount, 
                      <span class="hljs-meta">@RequestParam</span> String csrf_token,
                      HttpSession session)</span> {
    <span class="hljs-comment">// 校验 Token 是否与会存中存储的一致</span>
    <span class="hljs-keyword">if</span> (!csrf_token.equals(session.getAttribute(<span class="hljs-string">"csrf_token"</span>))) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityException</span>(<span class="hljs-string">"疑似 CSRF 攻击！"</span>);
    }
    <span class="hljs-comment">// 执行转账...</span>
}
</code></pre>
<p><strong>关键</strong>：恶意网站 <code>evil.com</code> <strong>无法读取</strong> <code>bank.com</code> 的页面内容（同源策略这时候起作用了！），因此<strong>拿不到 Token</strong>，请求自然被后端拒绝。</p>
<h3 data-id="heading-4">2. SameSite Cookie（现代浏览器的防线）</h3>
<p>通过设置 Cookie 属性，让浏览器<strong>不在跨域请求中携带</strong>敏感 Cookie：</p>
<pre><code class="hljs language-http" lang="http">Set-Cookie: sessionId=abc123; SameSite=Strict; HttpOnly; Secure
</code></pre>
<ul>
<li><code>SameSite=Strict</code>：完全禁止第三方 Cookie（最安全，但可能影响从微信/邮件点击链接的体验）</li>
<li><code>SameSite=Lax</code>：允许顶级导航（如 <code>&lt;a&gt;</code> 标签跳转）携带 Cookie，但阻止 POST/PUT 等危险操作（推荐折中方案）</li>
</ul>
<h3 data-id="heading-5">3. Origin/Referer 校验（请求来源验证）</h3>
<p>检查 HTTP Header 中的来源信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/sensitive")</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; sensitiveOperation(<span class="hljs-meta">@RequestHeader("Origin")</span> String origin) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-string">"https://bank.com"</span>.equals(origin)) {
        <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">403</span>).body(<span class="hljs-string">"非法来源"</span>);
    }
    <span class="hljs-comment">// 继续处理...</span>
}
</code></pre>
<p><strong>注意</strong>：Referer 可以被抹除（HTTPS 跳 HTTP 时不带），所以优先校验 <code>Origin</code> 头，同时<strong>不能作为唯一防线</strong>。</p>
<h2 data-id="heading-6">四、总结：两道门的安全哲学</h2>
<p>理解同源策略和 CSRF 防护的关系，可以用一个比喻：</p>
<blockquote>
<p><strong>同源策略</strong>是<strong>阅览室的保安</strong>：防止外人偷看你的文件（保护数据隐私）。
<strong>CSRF 防护</strong>是<strong>金库的指纹锁</strong>：确保操作者真的是你本人（保护操作安全）。</p>
</blockquote>
<p><strong>两者缺一不可</strong>：</p>
<ul>
<li>没有同源策略，坏人能直接<strong>读取</strong>你的敏感信息（余额、 Token）。</li>
<li>没有 CSRF 防护，坏人能<strong>盲打</strong>执行高危操作（转账、改密），即使你收不到回执。</li>
</ul>
<p><strong>给开发者的建议</strong>：</p>
<ol>
<li><strong>高风险操作</strong>（资金、隐私修改）必须实施 CSRF Token 验证，不能仅靠前端校验。</li>
<li><strong>逐步淘汰</strong>纯 Cookie 鉴权，采用 <code>Authorization: Bearer Token</code> 方案（Token 不自动携带，需 JS 显式写入 Header，天然防 CSRF）。</li>
<li><strong>开启 SameSite=Lax</strong>，作为兜底防护。</li>
</ol>
<p>同源策略解决了"<strong>谁能看到</strong>"的问题，但"<strong>谁能操作</strong>"必须由你的后端来回答。别让浏览器的"好意"成为安全架构的盲点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[godot-rust（gdext）你的第一个2D游戏 - 3]]></title>    <link>https://juejin.cn/post/7600326291553517574</link>    <guid>https://juejin.cn/post/7600326291553517574</guid>    <pubDate>2026-01-29T03:08:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326291553517574" data-draft-id="7599924721007509567" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="godot-rust（gdext）你的第一个2D游戏 - 3"/> <meta itemprop="keywords" content="游戏"/> <meta itemprop="datePublished" content="2026-01-29T03:08:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="柚要做甚码"/> <meta itemprop="url" content="https://juejin.cn/user/2200546203156138"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            godot-rust（gdext）你的第一个2D游戏 - 3
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2200546203156138/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    柚要做甚码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:08:03.000Z" title="Thu Jan 29 2026 03:08:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>本文以<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fzh-cn%2F4.5%2Fgetting_started%2Ffirst_2d_game%2Findex.html" target="_blank" title="https://docs.godotengine.org/zh-cn/4.5/getting_started/first_2d_game/index.html" ref="nofollow noopener noreferrer">你的第一个 2D 游戏 — Godot Engine (4.5) 简体中文文档</a>为蓝本撰写，godot-rust提供了该教程的一个rust的实现<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgodot-rust%2Fdemo-projects%2Ftree%2Fmaster%2Fdodge-the-creeps" target="_blank" title="https://github.com/godot-rust/demo-projects/tree/master/dodge-the-creeps" ref="nofollow noopener noreferrer">dodge-the-creeps</a>，与本文方法会稍有不同。如果你对rust、godot等内容比较生疏或感到疑惑，可以先阅读<a href="https://link.juejin.cn/?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Findex.html" title="https://link.juejin.cn/?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Findex.html" target="_blank">godot-rust入门文档</a>。</p>
<p>本文搭建在<a href="https://juejin.cn/post/7599566082212986932" target="_blank" title="https://juejin.cn/post/7599566082212986932">godot-rust（gdext）创建项目</a>的基础之上，如果你对该部分内容感到生疏，可以先阅读这部分内容，为接下来的操作做好准备。</p>
<p><strong>注意，本文使用的godot版本为4.5.1，godot版本的变化可能会导致一些内容失效</strong>。</p>
<p>本文操作均在Windows上执行。</p>
<h2 data-id="heading-1">正文</h2>
<h3 data-id="heading-2">编写玩家代码</h3>
<p>回到rust，向<code>Player</code>添加两个字段，并更新<code>init</code>方法：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(GodotClass)]</span>
<span class="hljs-meta">#[class(base=Area2D)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Player</span> {
    <span class="hljs-meta">#[export]</span> <span class="hljs-comment">// 向godot暴露这个字段</span>
    speed: real,
    screen_size: Vector2,

    base: Base&lt;Area2D&gt;,
}
<span class="hljs-meta">#[godot_api]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">IArea2D</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Player</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(base: Base&lt;Area2D&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {
            speed: <span class="hljs-number">400.0</span>,
            screen_size: Vector2::ZERO,
            base,
        }
    }
}
</code></pre>
<p>rust编译后，你可以在godot编辑器的<strong>检查器</strong>中发现这个字段，并可以手动调整：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/048b179323f247e48cc8b0688b7d21c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770260883&amp;x-signature=%2BgZhlxYfsfaypa9CJZ2zK44W9sk%3D" alt="向godot暴露字段" loading="lazy"/></p>
<p>在<code>impl IArea2D for Player</code>模块中重写<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rs%2Fgodot%2F0.4.5%2Fgodot%2Fclasses%2Ftrait.IArea2D.html%23method.ready" target="_blank" title="https://docs.rs/godot/0.4.5/godot/classes/trait.IArea2D.html#method.ready" ref="nofollow noopener noreferrer"><code>ready()</code>方法</a>：</p>
<blockquote>
<p>当节点进入场景树时，<code>ready()</code> 函数被调用，这是查看游戏窗口大小的好时机：</p>
</blockquote>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">ready</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
    <span class="hljs-keyword">self</span>.screen_size = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>().<span class="hljs-title function_ invoke__">get_viewport_rect</span>().size;
}
</code></pre>
<p>我们需要重写的另一个方法是<code>process()</code></p>
<blockquote>
<p>现在我们可以使用<code>process()</code>函数定义玩家将执行的操作。<code>process()</code>在每一帧都被调用，因此我们将使用它来更新我们希望会经常变化的游戏元素。对于玩家（即<code>Player</code>）而言，我们需要执行以下操作：</p>
<ul>
<li>检查输入。</li>
<li>沿给定方向移动。</li>
<li>播放合适的动画。</li>
</ul>
</blockquote>
<p>重写<code>process()</code>之前我们对需要godot捕获的输入进行配置，点击<strong>项目</strong>-&gt;<strong>项目设置</strong>-&gt;<strong>输入映射</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4e9779f12064e2ba595d5a1261836e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770260883&amp;x-signature=y7O7LqmPhLCfmsrCLwy7WeqHlZE%3D" alt="输入映射" loading="lazy"/></p>
<p>添加新<strong>输入映射</strong>名称</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd8b4a7b9cd64b5792dd7e0de1b54045~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770260883&amp;x-signature=uuL%2F8U0sYXDRJOkN%2FGOVWJXyDE0%3D" alt="添加新的输入映射" loading="lazy"/></p>
<p>为映射添加<strong>事件</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a265b1ef16f49a5b97ea753f5b6904f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770260883&amp;x-signature=z7TtJfdauKomT3m%2FjqC4Uv489Ys%3D" alt="添加事件" loading="lazy"/></p>
<p>选择<code>键盘按键</code>-&gt;<code>Right</code>，点击确定</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24e7b1b1e86d46f3b9a54c2370f34274~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770260883&amp;x-signature=aMBWxOlOq52sTFJ7ETOshfvlies%3D" alt="选择键盘右箭头事件" loading="lazy"/></p>
<p>我们一共要配置四个输入映射：</p>
<ul>
<li><code>move_right</code>映射到<code>键盘按键-&gt;右箭头键</code></li>
<li><code>move_left</code> 映射到<code>键盘按键-&gt;左箭头键</code></li>
<li><code>move_up</code> 映射到<code>键盘按键-&gt;上箭头键</code></li>
<li><code>move_down</code> 映射到<code>键盘按键-&gt;向下箭头键</code></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a988c9220264a93aeac5fdfe57a949e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770260883&amp;x-signature=yiAL6aWBxKm3U6dVPKnvppnp4rg%3D" alt="配置四个输入映射" loading="lazy"/></p>
<blockquote>
<p>我们只将一个键映射到每个输入动作，但你可以将多个键、操纵杆按钮或鼠标按钮映射到同一个输入动作。</p>
</blockquote>
<p>回到rust，在<code>impl IArea2D for Player</code>模块中重写<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rs%2Fgodot%2F0.4.5%2Fgodot%2Fclasses%2Ftrait.IArea2D.html%23method.process" target="_blank" title="https://docs.rs/godot/0.4.5/godot/classes/trait.IArea2D.html#method.process" ref="nofollow noopener noreferrer"><code>process()</code>方法</a></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">process</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, delta: <span class="hljs-type">f32</span>) {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">velocity</span> = Vector2::ZERO;  <span class="hljs-comment">// 初始化一个零向量，即默认Player无移动</span>

        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">input</span> = Input::<span class="hljs-title function_ invoke__">singleton</span>(); <span class="hljs-comment">// 获得输入单例</span>
        <span class="hljs-keyword">if</span> input.<span class="hljs-title function_ invoke__">is_action_pressed</span>(<span class="hljs-string">"move_right"</span>) { <span class="hljs-comment">// 与godot中设置名称保持一致</span>
            <span class="hljs-comment">// 添加向右向量</span>
            velocity += Vector2::RIGHT;
        }
        <span class="hljs-keyword">if</span> input.<span class="hljs-title function_ invoke__">is_action_pressed</span>(<span class="hljs-string">"move_left"</span>) { <span class="hljs-comment">// 与godot中设置名称保持一致</span>
            <span class="hljs-comment">// 添加向左向量</span>
            velocity += Vector2::LEFT;
        }
        <span class="hljs-keyword">if</span> input.<span class="hljs-title function_ invoke__">is_action_pressed</span>(<span class="hljs-string">"move_down"</span>) { <span class="hljs-comment">// 与godot中设置名称保持一致</span>
            <span class="hljs-comment">// 添加向下向量</span>
            velocity += Vector2::DOWN;
        }
        <span class="hljs-keyword">if</span> input.<span class="hljs-title function_ invoke__">is_action_pressed</span>(<span class="hljs-string">"move_up"</span>) { <span class="hljs-comment">// 与godot中设置名称保持一致</span>
            <span class="hljs-comment">// 添加向上向量</span>
            velocity += Vector2::UP;
        }

        <span class="hljs-comment">// 获得Player节点下的AnimatedSprite2D节点，注意传入函数的参数与godot中设置的名称一致</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">animated_sprite</span> = <span class="hljs-keyword">self</span>
            .<span class="hljs-title function_ invoke__">base</span>()
            .get_node_as::&lt;AnimatedSprite2D&gt;(<span class="hljs-string">"AnimatedSprite2D"</span>);

        <span class="hljs-comment">// 判断是否有移动</span>
        <span class="hljs-keyword">if</span> velocity.<span class="hljs-title function_ invoke__">length</span>() &gt; <span class="hljs-number">0.0</span> {
            <span class="hljs-comment">// 将移动向量长度归一化，始终保持“1”，比如你同时按下“上”和“右”时</span>
            velocity = velocity.<span class="hljs-title function_ invoke__">normalized</span>() * <span class="hljs-keyword">self</span>.speed;
            animated_sprite.<span class="hljs-title function_ invoke__">play</span>(); <span class="hljs-comment">// 播放动画</span>
        } <span class="hljs-keyword">else</span> {
            animated_sprite.<span class="hljs-title function_ invoke__">stop</span>(); <span class="hljs-comment">// 停止动画</span>
        }
        
        <span class="hljs-comment">// 计算Player当前位置</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">position</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>().<span class="hljs-title function_ invoke__">get_position</span>() + velocity * delta;
        <span class="hljs-comment">// 使用clamp()方法来方式Player离开屏幕</span>
        position = position.<span class="hljs-title function_ invoke__">clamp</span>(Vector2::ZERO, <span class="hljs-keyword">self</span>.screen_size);
        <span class="hljs-comment">// 更新Player位置</span>
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base_mut</span>().<span class="hljs-title function_ invoke__">set_position</span>(position);
    }
</code></pre>
<p>编译rust</p>
<pre><code class="hljs">cargo build
</code></pre>
<p>回到godot编辑器，按<code>F6</code>或者在编辑器右上方（<strong>检查器</strong>的上方）点击<strong>运行当前场景</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b69061a0954474f848b1a53f2ff87a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770260883&amp;x-signature=lmXIcv6UGlc0sD5cgIYu9%2FjCb6w%3D" alt="运行当前场景" loading="lazy"/></p>
<p>确认你能够在屏幕中沿任一方向移动<code>Player</code>。</p>
<h3 data-id="heading-3">选择动画</h3>
<p>如果进行了测试，细心的你会发现<code>Player</code>在移动时播放的动画是固定，即你在前面设置的<code>walk</code>。但这不符合我们日常体验，正常情况下<code>Player</code>应随前进方向的不同而播放对应的动画。在本文中我们设定<code>walk</code>是向右走，向左时就将<code>walk</code>水平翻转，<code>up</code>是向上走，向下时就将<code>up</code>垂直翻转。</p>
<p>在rust的<code>animated_sprite.play()</code>这行上方添加播放动画的判断逻辑</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">if</span> velocity.x != <span class="hljs-number">0.0</span> { <span class="hljs-comment">// 当有向横向移动时</span>
    animated_sprite.<span class="hljs-title function_ invoke__">set_animation</span>(<span class="hljs-string">"walk"</span>); <span class="hljs-comment">// 设置为动画为walk，注意与你在godot中名称一致</span>
    animated_sprite.<span class="hljs-title function_ invoke__">set_flip_v</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 恢复垂直翻转，否则在向下移动后动画播放会稍许奇怪</span>
    animated_sprite.<span class="hljs-title function_ invoke__">set_flip_h</span>(velocity.x &lt; <span class="hljs-number">0.0</span>); <span class="hljs-comment">// 根据左右方向判断是否水平翻转</span>
} <span class="hljs-keyword">else</span> {
    animated_sprite.<span class="hljs-title function_ invoke__">set_animation</span>(<span class="hljs-string">"up"</span>); <span class="hljs-comment">// 设置为动画为up，注意与你在godot中名称一致</span>
    animated_sprite.<span class="hljs-title function_ invoke__">set_flip_v</span>(velocity.y &gt; <span class="hljs-number">0.0</span>) <span class="hljs-comment">// 根据上下方向判断是否垂直翻转</span>
}
animated_sprite.<span class="hljs-title function_ invoke__">play</span>(); <span class="hljs-comment">// 原播放代码处</span>
</code></pre>
<p>编译rust</p>
<pre><code class="hljs">cargo build
</code></pre>
<p>再进行测试，你应该发现<code>Player</code>随移动方向变化，动画播放也随之发生变化。</p>
<p>确认Player能够正常工作后，在<code>ready()</code>函数最后面添加代码，在游戏开始时隐藏<code>Player</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base_mut</span>().<span class="hljs-title function_ invoke__">hide</span>();
</code></pre>
<h3 data-id="heading-4">准备碰撞</h3>
<p>游戏中我们希望能够检测Player是否被敌人碰撞，虽然目前游戏中我们还没有敌人。定义一个信号，注意不是在<code>impl IArea2D for Player</code>模块中，而是<code>impl Player</code>，同时<code>#[godot_api]</code>不能忘记。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[godot_api]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Player</span> {
    <span class="hljs-meta">#[signal]</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">hit</span>(); <span class="hljs-comment">// 被碰撞的信号</span>
}
</code></pre>
<p>编译后你可以在godot编辑器内看到这个信号：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/779caa6288154dc1a85614d84773156c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770260883&amp;x-signature=%2BQBAAgmsZvBYhCvYdd5421he1D8%3D" alt="Player的hit信号" loading="lazy"/></p>
<p>我们先需要一个<code>handle</code>来处理发生碰撞后要干什么，在<code>impl Player</code>模块中加入以下代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_body_entered</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, _body: Gd&lt;Node2D&gt;) {
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base_mut</span>().<span class="hljs-title function_ invoke__">hide</span>(); <span class="hljs-comment">// Player隐藏</span>
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">signals</span>().<span class="hljs-title function_ invoke__">hit</span>().<span class="hljs-title function_ invoke__">emit</span>(); <span class="hljs-comment">// 发出hit信号</span>
    
    <span class="hljs-comment">// 获得Player节点下的CollisionShape2D节点，注意传入函数的参数与godot中设置的名称一致</span>
    <span class="hljs-comment">// 禁用碰撞形状</span>
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>()
        .get_node_as::&lt;CollisionShape2D&gt;(<span class="hljs-string">"CollisionShape2D"</span>)
        .<span class="hljs-title function_ invoke__">set_deferred</span>(<span class="hljs-string">"disabled"</span>, &amp;<span class="hljs-literal">true</span>.<span class="hljs-title function_ invoke__">to_variant</span>());
}
</code></pre>
<p>然后将碰撞信号和上面的<code>handle</code>连接起来，我们在<code>ready()</code>的最后面添加以下代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">signals</span>()
    .<span class="hljs-title function_ invoke__">body_entered</span>()
    .<span class="hljs-title function_ invoke__">connect_self</span>(<span class="hljs-keyword">Self</span>::on_body_entered);
</code></pre>
<p>最后，为<code>Player</code>添加一个游戏开始方法，用于启动游戏，在在<code>impl Player</code>模块中加入以下代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">start</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, pos: Vector2) {
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base_mut</span>().<span class="hljs-title function_ invoke__">set_position</span>(pos); <span class="hljs-comment">// 重置Player位置</span>
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base_mut</span>().<span class="hljs-title function_ invoke__">show</span>(); <span class="hljs-comment">// 将Player显示出来</span>
    
    <span class="hljs-comment">// 启用碰撞形状</span>
    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">base</span>()
        .get_node_as::&lt;CollisionShape2D&gt;(<span class="hljs-string">"CollisionShape2D"</span>)
        .<span class="hljs-title function_ invoke__">set_deferred</span>(<span class="hljs-string">"disabled"</span>, &amp;<span class="hljs-literal">false</span>.<span class="hljs-title function_ invoke__">to_variant</span>());
}
</code></pre>
<p>当然，目前<code>start()</code>方法并没有在任何位置被调用。</p>
<h2 data-id="heading-5">参考</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fzh-cn%2F4.5%2Fgetting_started%2Ffirst_2d_game%2Findex.html" target="_blank" title="https://docs.godotengine.org/zh-cn/4.5/getting_started/first_2d_game/index.html" ref="nofollow noopener noreferrer">你的第一个 2D 游戏 — Godot Engine (4.5) 简体中文文档</a></li>
<li><a href="https://juejin.cn/post/7599566082212986932" target="_blank" title="https://juejin.cn/post/7599566082212986932">godot-rust（gdext）创建项目 - 掘金</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rs%2Fgodot%2F0.4.5%2Fgodot%2F" target="_blank" title="https://docs.rs/godot/0.4.5/godot/" ref="nofollow noopener noreferrer">godot - Rust</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgodot-rust%2Fdemo-projects%2Ftree%2Fmaster%2Fdodge-the-creeps" target="_blank" title="https://github.com/godot-rust/demo-projects/tree/master/dodge-the-creeps" ref="nofollow noopener noreferrer">demo-projects/dodge-the-creeps at master · godot-rust/demo-projects · GitHub</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我不允许谁还不清楚function call在AI-Agent领域中流砥柱的地位]]></title>    <link>https://juejin.cn/post/7600296037543854080</link>    <guid>https://juejin.cn/post/7600296037543854080</guid>    <pubDate>2026-01-29T03:26:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600296037543854080" data-draft-id="7600293373476765696" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我不允许谁还不清楚function call在AI-Agent领域中流砥柱的地位"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T03:26:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有态度的下等马"/> <meta itemprop="url" content="https://juejin.cn/user/448256476727662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我不允许谁还不清楚function call在AI-Agent领域中流砥柱的地位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256476727662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有态度的下等马
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:26:45.000Z" title="Thu Jan 29 2026 03:26:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前文提要：还有比ollama更傻瓜式的大模型本地部署方式吗 ？</p>
<h2 data-id="heading-0">1.<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40jamestang%2Fllm-function-calling-explained-a-deep-dive-into-the-request-and-response-payloads-894800fcad75" title="https://medium.com/@jamestang/llm-function-calling-explained-a-deep-dive-into-the-request-and-response-payloads-894800fcad75" target="_blank" ref="nofollow noopener noreferrer">function calling</a> 底层工作原理</h2>
<p>大模型重塑了我们与软件应用的交互方式， 其中最重要的特性就是 function calling 。</p>
<p>一种<strong>利用结构化输入/输出在LLM和编程应用之间建立桥梁</strong>的方式。</p>
<p>不管是当前火热的AI-agent还是MCP，了解function calling底层工作原理都至关重要，特别是request和response payload。</p>
<p>回顾上文我们与qwen大模型的对话：</p>
<p><code>what is the temperature in the capital of china today？</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93c158ad999046ebab870e1aabadd442~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262882&amp;x-signature=DbQP0xBsQB3dWsK1v%2FffgV3QqmA%3D" alt="" loading="lazy"/></p>
<p>一个由LLM驱动的应用， 回答这个问题，应用与LLM经历了三次对话。</p>
<p>① 第一次请求payload：</p>
<ul>
<li>message：标准的历史对话， 提供上下文context</li>
<li>tools：一系列的工具函数定义， 提供给LLM来选择</li>
</ul>
<p>LLM的响应payload：</p>
<ul>
<li><code>tool_calls.function.name</code>： LLM选中的工具函数<code>get_currentDate</code></li>
<li><code>tool_calls.id</code>： 由LLM为这个函数指定的id，后面会用到</li>
</ul>
<p>② 第二次request：</p>
<ul>
<li><code>messages.role.assistant</code>: 告诉LLM我们这次请求包含了上次function calling的结果</li>
<li><code>messages.role.tool</code>： 上次function calling执行的结果<code>2026-01-24</code></li>
</ul>
<p>LLM的响应payload：</p>
<p>如第一次类似：
本例也有<code>tool_calls</code>:包含LLM选中的函数<code>get_temperature()</code> 和所有的参数<code>beijing</code> <code>2026-01-24</code>。</p>
<p>③ 应用最后一次请求，包含所有信息</p>
<p>LLM推理认为不再需要外部工具，不再返回<code>tool_calls</code>,给出结合外部工具的对话结果。</p>
<hr/>
<p>从三次请求对话来看， LLM在三次对话的响应中体现了它的思考和逻辑步骤，应用持续被LLM引导做出行动，同时LLM也持续对应用的行为做出进一步思考和反馈。</p>
<h2 data-id="heading-1">2. agent的实现原理</h2>
<p>大模型是 AI 的大脑，其核心是理解自然语言，并做出回应，(文本)大模型本身只能接收一段文本，然后输出一段文本。</p>
<p>而当你希望大模型能使用一些工具自行获取所需的信息、执行一些动作，就需要使用 Tool 来实现了，拥有了 Tool 的大模型就像是拥有了手脚，可以和当下已有的 IT 基础设施进行交互。</p>
<blockquote>
<p>RAG给LLM装上实时知识外挂， 通过将信息检索与文本生成结合，让模型能引用外部权威信息生成回答，既保证了时效性，又提升了准确性。</p>
</blockquote>
<p>字节开源的<code>Eino</code>标榜的优势在于：</p>
<ol>
<li>
<p>LangChain，LlamaIndex等主流框架虽然起源自python强大的AI生态，但是也继承了python“弱类型检查”和“长期维护成本高”的诟病。 Eino作为golang下的开源agent开发框架，规避了这一问题。</p>
</li>
<li>
<p>另一方面， 借助字节系在agent领域的工程化实践，Eino既封装了领域内不变的通用核心和最佳实践，也能敏捷的反映业内技术动向。</p>
</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudwego.io%2Fzh%2Fdocs%2Feino%2Fquick_start%2F" title="https://www.cloudwego.io/zh/docs/eino/quick_start/" target="_blank" ref="nofollow noopener noreferrer">Eino</a>框架结构图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f8174a2cdb14bb2a570e232d69f5e1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262882&amp;x-signature=ahn0eXegCeZFRHfrCgU1BcH5JdM%3D" alt="" loading="lazy"/></p>
<p>Eino 有三大稳定内核： compose编排、components组件，common公共库。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudwego.io%2Fzh%2Fdocs%2Feino%2Foverview%2Fbytedance_eino_practice%2F" target="_blank" title="https://www.cloudwego.io/zh/docs/eino/overview/bytedance_eino_practice/" ref="nofollow noopener noreferrer">组件</a>一抹多,是原子能力的最小单位， <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudwego.io%2Fzh%2Fdocs%2Feino%2Fcore_modules%2Fchain_and_graph_orchestration%2F" target="_blank" title="https://www.cloudwego.io/zh/docs/eino/core_modules/chain_and_graph_orchestration/" ref="nofollow noopener noreferrer">编排</a>对这些组件进行组合、串连。</p>
<h2 data-id="heading-2">3.  中国首都今天的天气怎么样? 我母鸡啊</h2>
<p>我们使用Eino框架来实现本文的题目：
<code>what is  the temperature in the capital of china today</code>。</p>
<p>按照我们的分析，
从LLM的视角，要回答这个问题，经历了“思考-行动-观察-思考” 循环， 这是一个<code>ReAct</code>模式的agent。</p>
<p>下面基于阿里百炼 千问大模型，实现了天气对话，请自行从阿里百炼平台申请的apiKey替换到54行。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"time"</span>

	<span class="hljs-string">"github.com/cloudwego/eino-ext/components/model/qwen"</span>
	<span class="hljs-string">"github.com/cloudwego/eino/components/tool"</span>
	<span class="hljs-string">"github.com/cloudwego/eino/components/tool/utils"</span>
	<span class="hljs-string">"github.com/cloudwego/eino/compose"</span>
	<span class="hljs-string">"github.com/cloudwego/eino/schema"</span>
)

<span class="hljs-comment">// what is  the temperature in the capital of china today</span>

<span class="hljs-keyword">type</span> weatherReqParam <span class="hljs-keyword">struct</span> {
	City <span class="hljs-type">string</span> <span class="hljs-string">`json:"city"  jsonschema:"description=the name of the city"`</span>
	Date <span class="hljs-type">string</span> <span class="hljs-string">`json:"date"  jsonschema:"description=the date in the format of YYYY-MM-DD"`</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetTemperatureFunc</span><span class="hljs-params">(_ context.Context, p weatherReqParam)</span></span> (<span class="hljs-type">float64</span>, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 这里直接mock一个温度值，实际应用中应该替换为真实的API调用</span>
	<span class="hljs-keyword">return</span> <span class="hljs-number">32</span>, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetCurrentDateFunc</span><span class="hljs-params">(_ context.Context, _ <span class="hljs-keyword">struct</span>{})</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">return</span> time.Now().Format(<span class="hljs-string">"2006-01-02"</span>), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">of</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(t T)</span></span> *T {
	<span class="hljs-keyword">return</span> &amp;t
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	getDateTool, err := utils.InferTool(<span class="hljs-string">"get_currentDate"</span>, <span class="hljs-string">"Get the current date"</span>, GetCurrentDateFunc)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}
	getTemperatureTool, err := utils.InferTool(<span class="hljs-string">"get_temperature"</span>, <span class="hljs-string">"Get the temperature in the capital of the city"</span>, GetTemperatureFunc)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}

	<span class="hljs-comment">// 初始化 tools</span>
	weatherTools := []tool.BaseTool{
		getDateTool,
		getTemperatureTool,
	}

	apiKey := os.Getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)
	apiKey = <span class="hljs-string">"{}"</span>  <span class="hljs-comment">// 在阿里百炼平台申请签名</span>
	modelName := os.Getenv(<span class="hljs-string">"MODEL_NAME"</span>)
	modelName = <span class="hljs-string">"qwen3-max"</span>
	chatModel, err := qwen.NewChatModel(context.Background(), &amp;qwen.ChatModelConfig{
		BaseURL:     <span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
		APIKey:      apiKey,
		Timeout:     <span class="hljs-number">0</span>,
		Model:       modelName,
		MaxTokens:   of(<span class="hljs-number">2048</span>),
		Temperature: of(<span class="hljs-type">float32</span>(<span class="hljs-number">0.7</span>)),
		TopP:        of(<span class="hljs-type">float32</span>(<span class="hljs-number">0.7</span>)),
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"NewChatModel of qwen failed, err=%v"</span>, err)
	}

	<span class="hljs-keyword">var</span> ctx = context.Background()
	<span class="hljs-comment">// 获取工具信息并绑定到 ChatModel</span>
	toolInfos := <span class="hljs-built_in">make</span>([]*schema.ToolInfo, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(weatherTools))
	<span class="hljs-keyword">for</span> _, tool := <span class="hljs-keyword">range</span> weatherTools {
		info, err := tool.Info(ctx)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			log.Fatal(err)
		}
		toolInfos = <span class="hljs-built_in">append</span>(toolInfos, info)
	}
	err = chatModel.BindTools(toolInfos)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 创建 tools 节点</span>
	weatherToolsNode, err := compose.NewToolNode(context.Background(), &amp;compose.ToolsNodeConfig{
		Tools: weatherTools,
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 构建基于 Graph 的 Agent，实现 ReAct 模式（自动执行工具并生成自然语言回复）</span>

	<span class="hljs-comment">// 定义状态，用于保存对话历史</span>
	<span class="hljs-keyword">type</span> appState <span class="hljs-keyword">struct</span> {
		messages []*schema.Message
	}

	graph := compose.NewGraph[[]*schema.Message, *schema.Message](
		compose.WithGenLocalState(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> *appState {
			<span class="hljs-keyword">return</span> &amp;appState{}
		}),
	)

	<span class="hljs-comment">// 添加 ChatModel 节点</span>
	err = graph.AddChatModelNode(<span class="hljs-string">"qwen_chat_model"</span>, chatModel,
		compose.WithStatePreHandler(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, input []*schema.Message, state *appState)</span></span> ([]*schema.Message, <span class="hljs-type">error</span>) {
			<span class="hljs-comment">// 如果是第一次进入（从 Start），将输入（用户问题）添加到历史</span>
			<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(state.messages) == <span class="hljs-number">0</span> {
				state.messages = <span class="hljs-built_in">append</span>(state.messages, input...)
			}
			<span class="hljs-comment">// 始终将完整的历史记录作为 ChatModel 的输入</span>
			<span class="hljs-keyword">return</span> state.messages, <span class="hljs-literal">nil</span>
		}),
		compose.WithStatePostHandler(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, output *schema.Message, state *appState)</span></span> (*schema.Message, <span class="hljs-type">error</span>) {
			<span class="hljs-comment">// 将 ChatModel 的输出（可能是工具调用或最终回复）添加到历史</span>
			state.messages = <span class="hljs-built_in">append</span>(state.messages, output)
			<span class="hljs-keyword">return</span> output, <span class="hljs-literal">nil</span>
		}),
	)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 添加 Tools 节点</span>
	err = graph.AddToolsNode(<span class="hljs-string">"agent_tools"</span>, weatherToolsNode,
		compose.WithStatePostHandler(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, output []*schema.Message, state *appState)</span></span> ([]*schema.Message, <span class="hljs-type">error</span>) {
			<span class="hljs-comment">// 将工具执行结果添加到历史</span>
			state.messages = <span class="hljs-built_in">append</span>(state.messages, output...)
			<span class="hljs-keyword">return</span> output, <span class="hljs-literal">nil</span>
		}),
	)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 添加边和分支</span>
	_ = graph.AddEdge(compose.START, <span class="hljs-string">"qwen_chat_model"</span>)

	<span class="hljs-comment">// 如果有工具调用，流转到 tools；否则结束</span>
	_ = graph.AddBranch(<span class="hljs-string">"qwen_chat_model"</span>, compose.NewGraphBranch(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, msg *schema.Message)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(msg.ToolCalls) &gt; <span class="hljs-number">0</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-string">"agent_tools"</span>, <span class="hljs-literal">nil</span>
		}
		<span class="hljs-keyword">return</span> compose.END, <span class="hljs-literal">nil</span>
	}, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>{<span class="hljs-string">"agent_tools"</span>: <span class="hljs-literal">true</span>, compose.END: <span class="hljs-literal">true</span>}))

	<span class="hljs-comment">// 工具执行完后，回流到 chat_model 生成回复</span>
	_ = graph.AddEdge(<span class="hljs-string">"agent_tools"</span>, <span class="hljs-string">"qwen_chat_model"</span>)

	<span class="hljs-comment">// 编译运行</span>
	agent, err := graph.Compile(ctx)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 运行示例</span>
	resp, err := agent.Invoke(ctx, []*schema.Message{
		{
			Role:    schema.User,
			Content: <span class="hljs-string">"what is the temperature in the capital of china today? please answer in a humam like way."</span>,
		},
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 输出结果</span>
	fmt.Println(resp.Content)
}

</code></pre>
<p>一开始我参照的官网的<code>chain</code>编排Eino组件，但是得到的结果是数字“32”， 并不是LLM对话的类人语言。</p>
<p>使用Trae的编码agent，20s就帮我改成了Graph形式的正确编码， 输出：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">The temperature <span class="hljs-keyword">in</span> Beijing, the capital of China, today (January <span class="hljs-number">28</span>, <span class="hljs-number">2026</span>) <span class="hljs-keyword">is</span> a warm <span class="hljs-number">32</span>°C! That’s quite hot <span class="hljs-keyword">for</span> <span class="hljs-keyword">this</span> time of year—make sure to stay hydrated and cool <span class="hljs-keyword">if</span> you’re <span class="hljs-keyword">out</span> and about!
</code></pre>
<blockquote>
<p>本例实际也可以使用<code>Chain</code>来完成，chain是一种特殊的、简化的graph，chain不能回头，本例需要手动串起来，Chain更适合确定性的编排。</p>
</blockquote>
<p>Graph就像一个自动化的流水线（loop），工人是 chat_model 和 tools ：</p>
<p>本例的Graph图如下，读者可以结合源代码理解。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afe66b9b3e89498f8802096181aa56dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262882&amp;x-signature=%2BJulP4zHryucNgMwa07hjemOEPE%3D" alt="" loading="lazy"/></p>
<ol>
<li>START -&gt; chat_model
<ul>
<li>ChatModel 拿到用户问题，思考后说：“我需要查日期。”（输出包含 ToolCall）</li>
</ul>
</li>
<li>chat_model -&gt; tools (由 Branch 判断)
<ul>
<li>Tools 听到指令，去查日期，得到 "2026-01-24"。</li>
</ul>
</li>
<li>tools -&gt; chat_model (由 AddEdge 强制流转)
<ul>
<li>ChatModel 再次被唤醒。这次它的输入包含了之前的历史（用户问题 + 刚才的 ToolCall + 刚才的结果）。</li>
<li>它再次思考：“我知道日期了，现在我要查北京的温度。”（输出包含 ToolCall）</li>
</ul>
</li>
<li>chat_model -&gt; tools (再次循环)
<ul>
<li>Tools 去查温度，得到 "32度"。</li>
</ul>
</li>
<li>tools -&gt; chat_model (再次循环)
<ul>
<li>ChatModel 再次被唤醒。现在的输入更丰富了（所有历史）。</li>
<li>它再次思考：“日期有了，温度也有了，我可以直接回答用户了。”（输出 不包含 ToolCall）</li>
</ul>
</li>
<li>chat_model -&gt; END (由 Branch 判断)
<ul>
<li>循环结束。</li>
</ul>
</li>
</ol>
<p>最后我们重温全文，function calling（function tools）在agent中的作用：
在由LLM驱动的agent应用中，function calling（function tools）作为LLM的手脚，让LLM具备使用工具从外部获取最新信息并指导应用行为的能力，这一过程由结构化的输入输出参数来传递。</p>
<p>最近股市长虹，祝大家发大财。😄😄😄</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 驱动的 Web 调试新范式：让编码智能体直接“看”懂你的浏览器]]></title>    <link>https://juejin.cn/post/7600430748780412971</link>    <guid>https://juejin.cn/post/7600430748780412971</guid>    <pubDate>2026-01-29T03:27:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600430748780412971" data-draft-id="7600340964083367942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 驱动的 Web 调试新范式：让编码智能体直接“看”懂你的浏览器"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-29T03:27:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿虎儿"/> <meta itemprop="url" content="https://juejin.cn/user/3394908210857901"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 驱动的 Web 调试新范式：让编码智能体直接“看”懂你的浏览器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394908210857901/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿虎儿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:27:46.000Z" title="Thu Jan 29 2026 03:27:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI 驱动的 Web 调试新范式：让编码智能体直接“看”懂你的浏览器</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43be8918b5ab4083b6c664f12ebab19a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6JmO5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262065&amp;x-signature=mBKQJmCvrpwPG0CUJOn3WzvZkz0%3D" alt="image.png" loading="lazy"/></p>
<p>在 AI 辅助编程日益普及的今天，开发者们常常面临一个断层：<strong>编码智能体（Coding Agents）通常运行在沙盒中，无法触及你当前正在操作的浏览器环境。</strong></p>
<p>这意味着，当你遇到一个只有在登录后、经过一些列复杂操作才会出现的 Bug 时，AI 往往束手无策，因为它无法复现那个特定的上下文。</p>
<p>今天，我们将介绍一种基于 <strong>MCP (Model Context Protocol)</strong> 的全新调试工作流。通过 <strong>Chrome DevTools MCP 服务器</strong>的最新增强功能，你可以让 AI 智能体直接连接到你活跃的浏览器会话中。这不仅打通了代码与运行时的隔阂，更开启了“人机协同调试”的新篇章。</p>
<hr/>
<h3 data-id="heading-1">为什么要连接活跃会话？</h3>
<p>将 AI 接入实时浏览器会话，解决了传统 AI 编程助手的三大痛点：</p>
<h4 data-id="heading-2">1. 告别繁琐的上下文复现</h4>
<p><strong>痛点</strong>：以往为了让 AI 修复 Bug，你需要向它解释“先登录，点击A，再点击B...”。
<strong>现在</strong>：AI 直接复用你现有的浏览器会话。无论是需要复杂验证的后台系统，还是包含大量本地状态的单页应用（SPA），AI 可以直接在当前状态下开始工作，无需重新登录或手动复现步骤。</p>
<h4 data-id="heading-3">2. 实时获取动态数据</h4>
<p><strong>痛点</strong>：AI 只能看到静态代码，看不到运行时的网络请求头或动态计算的 DOM 属性。
<strong>现在</strong>：智能体可以访问开发者工具（DevTools）中的实时数据。它能像人类专家一样，查看“网络(Network)”面板的失败请求，或分析“元素(Elements)”面板中的布局问题。</p>
<h4 data-id="heading-4">3. 无缝的人机协作</h4>
<p>你负责宏观的操作和定位（例如手动复现 Bug），然后直接指挥 AI：“分析刚才那个报错的接口”。这种“人类引导 + AI 分析”的模式效率极高。</p>
<hr/>
<h3 data-id="heading-5">技术原理与安全机制</h3>
<p>这一工作流基于 Chrome 浏览器的<strong>远程调试协议</strong>构建。为了确保安全性，Chrome 引入了严格的授权机制：</p>
<ul>
<li><strong>默认关闭</strong>：远程调试功能默认是禁用的，必须由开发者显式开启。</li>
<li><strong>人工授权</strong>：当 AI 智能体试图连接你的浏览器时，Chrome 会弹出明确的确认对话框。</li>
<li><strong>全程透明</strong>：在调试期间，浏览器会显示醒目的横幅，提示当前正受到自动化软件的控制，确保你对浏览器状态拥有完全的知情权。</li>
</ul>
<hr/>
<h3 data-id="heading-6">实操指南：如何配置</h3>
<p>只要你的工具链支持 MCP 协议（如 Claude Desktop, Cursor, Windsurf 或各类 CLI 智能体），都可以按照以下步骤配置。</p>
<h4 data-id="heading-7">第一步：准备浏览器环境</h4>
<p>你需要使用较新版本的 Chrome（建议 Chrome 144+ 或 Beta/Canary 版本）以支持增强的远程调试功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb4a65e5f262424bb1a298d4cf14938a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6JmO5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262065&amp;x-signature=G2H1OwDYKUPNS5UJjQGjsN1FkiA%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>在地址栏输入 <code>chrome://inspect/#remote-debugging</code>。</li>
<li>勾选 <strong>“Enable remote debugging”</strong>（开启远程调试）。</li>
<li>保持此选项卡开启或最小化。</li>
</ol>
<h4 data-id="heading-8">第二步：配置 MCP 服务器</h4>
<p>在你的 AI 客户端配置文件中（通常是 <code>mcpServers</code> 配置块），添加 Chrome DevTools 的配置，并务必加上 <code>--autoConnect</code> 参数。</p>
<p>以通用的 JSON 配置为例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"chrome-devtools-mcp@latest"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--autoConnect"</span><span class="hljs-punctuation">,</span> 
        <span class="hljs-string">"--channel=beta"</span> <span class="hljs-comment">//正式版一定要删除</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><em>注意：如果你使用的是稳定版 Chrome，需要调整 <code>channel</code> 参数或省略它。建议正式版本删除，否则会连接不上</em></p>
<p><em>如果遇到mcp安装失败 spawn ENOENT，请参考文章： <a href="https://juejin.cn/post/7600326291553255430" target="_blank" title="https://juejin.cn/post/7600326291553255430">Windows 下 VS Code 配置 MCP 服务避坑指南：解决spawn *** ENOENT 报错</a></em></p>
<p><strong>常用参数说明：</strong></p>
<ul>
<li><code>--autoConnect</code>：启用自动连接到现有会话</li>
<li><code>--port</code>：指定连接端口</li>
<li><code>--channel</code>：指定应用版本通道（如 stable/beta）</li>
</ul>
<h4 data-id="heading-9">第三步：开始协同调试</h4>
<p>重启你的 AI 客户端，输入类似以下的提示词进行测试：</p>
<blockquote>
<p>“检查当前 Chrome 标签页中 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.chrome.com" target="_blank" title="https://developers.chrome.com" ref="nofollow noopener noreferrer">developers.chrome.com</a> 的加载性能。”</p>
</blockquote>
<p>此时，Chrome 会弹出权限请求，点击<strong>允许</strong>，你将看到 AI 开始读取页面信息并生成报告。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25c5941b853541578850a13247b308e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6JmO5YS_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262065&amp;x-signature=KkJveoYBDM%2FuV4sd%2BqnJUAPKwNI%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10">典型应用场景</h3>
<p>打通这一链路后，你可以尝试以下几种高效的调试策略：</p>
<h4 data-id="heading-11">场景 A：UI/CSS 视觉修复</h4>
<p><strong>操作</strong>：在浏览器中选中一个对齐错误的按钮。
<strong>Prompt</strong>：“我选中了一个元素，它的 CSS 布局有问题，看起来没有垂直居中，请检查并提供修复建议。”
<strong>优势</strong>：AI 能直接读取该元素计算后的样式（Computed Style），比只看源代码更准确。</p>
<h4 data-id="heading-12">场景 B：API 故障排查</h4>
<p><strong>操作</strong>：在页面上触发一个操作，导致出现红色的报错提示。
<strong>Prompt</strong>：“刚才的网络请求中有一个返回了 500 错误，请分析该请求的响应体，并根据我的后端代码推测可能的原因。”
<strong>优势</strong>：AI 结合前端报错信息和后端代码库，能进行端到端的分析。</p>
<h4 data-id="heading-13">场景 C：性能优化</h4>
<p><strong>Prompt</strong>：“对当前页面进行性能分析，找出导致主线程阻塞的主要原因。”
<strong>优势</strong>：利用 AI 强大的数据分析能力，解读复杂的 Performance 面板数据。</p>
<hr/>
<h3 data-id="heading-14">结语</h3>
<p>让编码智能体接管调试，并不是要取代开发者的工作，而是赋予开发者一套更强大的“外骨骼”。通过 <strong>Chrome DevTools MCP</strong>，我们将 AI 的能力从代码编辑器延伸到了运行时环境，这是迈向真正“全栈智能开发”的重要一步。</p>
<p>现在就配置你的 MCP 服务器，体验下一代 Web 调试工作流吧！</p>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FChromeDevTools%2Fchrome-devtools-mcp" target="_blank" title="https://github.com/ChromeDevTools/chrome-devtools-mcp" ref="nofollow noopener noreferrer">GitHub 项目主页与详细文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kafka简介：了解现代分布式消息队列的基石]]></title>    <link>https://juejin.cn/post/7600260767688114202</link>    <guid>https://juejin.cn/post/7600260767688114202</guid>    <pubDate>2026-01-29T03:27:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600260767688114202" data-draft-id="7492648484967202831" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kafka简介：了解现代分布式消息队列的基石"/> <meta itemprop="keywords" content="Kafka,消息队列,性能优化"/> <meta itemprop="datePublished" content="2026-01-29T03:27:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Go高并发架构_王工"/> <meta itemprop="url" content="https://juejin.cn/user/446863555701561"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kafka简介：了解现代分布式消息队列的基石
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446863555701561/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Go高并发架构_王工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:27:26.000Z" title="Thu Jan 29 2026 03:27:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言</h2>
<p>在微服务、实时分析和云原生架构盛行的今天，<strong>分布式消息队列</strong>就像现代系统的神经网络，负责在复杂环境中高效、可靠地传递数据。而在众多消息队列技术中，Apache Kafka无疑是一颗耀眼的明星。它不仅是一个高性能的消息队列，更是一个功能强大的分布式流处理平台。想象Kafka是一条数据高速公路：它能以极高的速度和可靠性运输海量消息，支撑从实时监控到事件驱动架构的各种场景。</p>
<p>为什么选择Kafka？Kafka诞生于LinkedIn，最初用于处理每天数百万的用户事件，如今已成为Apache顶级项目，被Netflix、Uber、Airbnb等公司广泛采用。它每天能处理<strong>数万亿条消息</strong>，以低延迟和高可用性著称。相比传统消息队列（如RabbitMQ），Kafka集消息传递、数据存储和流处理于一体，提供了无与伦比的灵活性。</p>
<p>本文的目标是帮助开发者深入理解Kafka的核心优势，并通过实战经验提升应用能力。我们将从基础概念入手，剖析Kafka的特色功能，分享生产环境中的优化技巧，并揭示常见问题及解决方案。读完后，你将能更自信地在项目中驾驭Kafka。</p>
<p><strong>目标读者</strong>：如果你有1-2年的Kafka开发经验，想从基础迈向精通，这篇文章为你量身定制。让我们一起开启Kafka的探索之旅！</p>
<hr/>
<h3 data-id="heading-1">过渡</h3>
<p>在动手写代码之前，我们先打好基础，了解Kafka的核心概念和架构。这些知识就像地图，指引我们在Kafka的世界中游刃有余。</p>
<hr/>
<h2 data-id="heading-2">2. Kafka核心概念与架构</h2>
<h3 data-id="heading-3">Kafka简介</h3>
<p>Kafka于2010年诞生于LinkedIn，旨在解决海量事件流（如用户点击、页面访问）的实时处理难题。你可以把Kafka想象成一个<strong>分布式日志</strong>：消息按时间顺序追加存储，多个系统可以并行读写。它从一个简单的消息队列，逐步演变为Apache顶级项目，如今被定位为<strong>高吞吐、可扩展的流处理平台</strong>。</p>
<p><strong>核心定位</strong>：Kafka不仅仅是消息队列（像ActiveMQ），它还是一个集发布、存储和处理数据流于一体的分布式系统，适合日志聚合、实时分析等场景。</p>
<h3 data-id="heading-4">核心组件</h3>
<p>Kafka的架构由几个关键组件构成，每个组件各司其职，共同构建高效的系统：</p>
<ul>
<li><strong>Topic（主题）</strong>：消息的分类或通道，类似收件箱的标签（例如<code>user-clicks</code>）。</li>
<li><strong>Partition（分区）</strong>：主题被拆分为多个分区，用于并行处理和负载均衡，每个分区是一个有序日志。</li>
<li><strong>Producer（生产者）</strong>：向主题发送消息的客户端。</li>
<li><strong>Consumer（消费者）</strong>：从主题读取消息的客户端，通常以组的形式并行消费。</li>
<li><strong>Broker（代理）</strong>：Kafka集群中的服务器，负责存储和管理消息。</li>
<li><strong>Offset（偏移量）</strong>：分区中每条消息的唯一标识，用于追踪消费进度。</li>
<li><strong>Consumer Group（消费者组）</strong>：一组消费者，共同分担主题分区的消费任务。</li>
</ul>
<p><strong>示意图</strong>：Kafka架构概览</p>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">-----------------+        +-----------------+        +-----------------+</span>
|  生产者 <span class="hljs-number">1</span>       | <span class="hljs-comment">-----&gt; |   主题 A        | &lt;----- |  消费者 1       |</span>
|  生产者 <span class="hljs-number">2</span>       | <span class="hljs-comment">-----&gt; | (分区 0,1)      | &lt;----- |  消费者 2       |</span>
+<span class="hljs-comment">-----------------+        |   Broker 1      |        | (消费者组)      |</span>
                           +<span class="hljs-comment">-----------------+        +-----------------+</span>
                           |   Broker <span class="hljs-number">2</span>      |
                           +<span class="hljs-comment">-----------------+</span>
                           |   Broker <span class="hljs-number">3</span>      |
                           +<span class="hljs-comment">-----------------+</span>
</code></pre>
<h3 data-id="heading-5">架构优势</h3>
<p>Kafka的设计在<strong>性能</strong>、<strong>扩展性</strong>和<strong>可靠性</strong>之间取得了巧妙平衡：</p>
<ul>
<li><strong>高吞吐量</strong>：通过顺序写磁盘和<strong>零拷贝</strong>技术，Kafka每秒可处理数百万条消息，极大降低CPU开销。</li>
<li><strong>分布式设计</strong>：Broker组成集群，支持水平扩展，分区分散负载，副本保证容错。</li>
<li><strong>数据持久化</strong>：消息可存储数天甚至更久（可配置保留周期，如7天），为消费者提供可靠的缓冲。</li>
</ul>
<p><strong>表格</strong>：Kafka与传统消息队列对比</p>


































<table><thead><tr><th>特性</th><th>Kafka</th><th>传统消息队列（如RabbitMQ）</th></tr></thead><tbody><tr><td><strong>吞吐量</strong></td><td>每秒百万级</td><td>每秒千级</td></tr><tr><td>**持久"`</td><td/></tr><tr><td><strong>持久化</strong></td><td>长期存储</td><td>短期排队</td></tr><tr><td><strong>扩展性</strong></td><td>水平扩展（分区）</td><td>垂直扩展（单节点）</td></tr><tr><td><strong>适用场景</strong></td><td>流处理、日志</td><td>任务队列、RPC</td></tr></tbody></table>
<h3 data-id="heading-6">示例代码：基础生产者和消费者</h3>
<p>让我们通过一个简单的Java/Spring Boot示例，看看Kafka如何工作。以下代码实现了一个生产者发送消息到主题，以及一个消费者读取消息。</p>
<p><strong>生产者代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;
<span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;
<span class="hljs-keyword">import</span> java.util.Properties;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleProducer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 配置生产者属性</span>
        <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        props.put(<span class="hljs-string">"bootstrap.servers"</span>, <span class="hljs-string">"localhost:9092"</span>);
        props.put(<span class="hljs-string">"key.serializer"</span>, <span class="hljs-string">"org.apache.kafka.common.serialization.StringSerializer"</span>);
        props.put(<span class="hljs-string">"value.serializer"</span>, <span class="hljs-string">"org.apache.kafka.common.serialization.StringSerializer"</span>);

        <span class="hljs-comment">// 创建生产者实例</span>
        <span class="hljs-keyword">try</span> (KafkaProducer&lt;String, String&gt; producer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaProducer</span>&lt;&gt;(props)) {
            <span class="hljs-comment">// 向test-topic发送10条消息</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
                ProducerRecord&lt;String, String&gt; record = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerRecord</span>&lt;&gt;(<span class="hljs-string">"test-topic"</span>, <span class="hljs-string">"key-"</span> + i, <span class="hljs-string">"Message-"</span> + i);
                producer.send(record, (metadata, exception) -&gt; {
                    <span class="hljs-keyword">if</span> (exception == <span class="hljs-literal">null</span>) {
                        System.out.println(<span class="hljs-string">"发送至分区: "</span> + metadata.partition());
                    } <span class="hljs-keyword">else</span> {
                        exception.printStackTrace();
                    }
                });
            }
        }
    }
}
</code></pre>
<p><strong>消费者代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;
<span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;
<span class="hljs-keyword">import</span> java.time.Duration;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.Properties;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleConsumer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 配置消费者属性</span>
        <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        props.put(<span class="hljs-string">"bootstrap.servers"</span>, <span class="hljs-string">"localhost:9092"</span>);
        props.put(<span class="hljs-string">"group.id"</span>, <span class="hljs-string">"test-group"</span>);
        props.put(<span class="hljs-string">"key.deserializer"</span>, <span class="hljs-string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);
        props.put(<span class="hljs-string">"value.deserializer"</span>, <span class="hljs-string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);
        props.put(<span class="hljs-string">"auto.offset.reset"</span>, <span class="hljs-string">"earliest"</span>);

        <span class="hljs-comment">// 创建消费者实例</span>
        <span class="hljs-keyword">try</span> (KafkaConsumer&lt;String, String&gt; consumer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaConsumer</span>&lt;&gt;(props)) {
            <span class="hljs-comment">// 订阅主题</span>
            consumer.subscribe(Collections.singletonList(<span class="hljs-string">"test-topic"</span>));

            <span class="hljs-comment">// 循环拉取消息</span>
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(<span class="hljs-number">100</span>));
                records.forEach(record -&gt; {
                    System.out.printf(<span class="hljs-string">"消费消息: key=%s, value=%s, 分区=%d, 偏移量=%d%n"</span>,
                            record.key(), record.value(), record.partition(), record.offset());
                });
            }
        }
    }
}
</code></pre>
<p><strong>代码说明</strong>：</p>
<ul>
<li>生产者异步发送消息，并通过回调处理成功或失败。</li>
<li>消费者通过轮询（poll）获取消息，使用组ID实现负载均衡。</li>
<li>配置项如<code>auto.offset.reset</code>决定消费者从哪里开始读取（<code>earliest</code>表示从头开始）。</li>
</ul>
<hr/>
<h3 data-id="heading-7">过渡</h3>
<p>掌握了Kafka的基础后，我们来探索它的独特功能——从极致的性能到强大的流处理能力，这些特性让Kafka在生产环境中大放异彩。</p>
<hr/>
<h2 data-id="heading-8">3. Kafka的特色功能</h2>
<h3 data-id="heading-9">高性能与低延迟</h3>
<p>Kafka的性能令人叹服，每秒可处理<strong>数百万条消息</strong>，延迟通常在毫秒级。以下是关键技术：</p>
<ul>
<li><strong>批量处理与压缩</strong>：生产者将消息打包发送，减少网络开销；压缩算法（如GZIP、Snappy）显著降低消息体积，提升吞吐量。</li>
<li><strong>零拷贝技术</strong>：Kafka直接从磁盘映射到网络缓冲区，跳过传统的数据拷贝流程，就像直接把书交给读者，而非逐页复印。</li>
</ul>
<p><strong>示意图</strong>：零拷贝与传统I/O对比</p>
<pre><code class="hljs language-rust" lang="rust">传统I/O: 磁盘 <span class="hljs-punctuation">-&gt;</span> 内核缓冲区 <span class="hljs-punctuation">-&gt;</span> 用户缓冲区 <span class="hljs-punctuation">-&gt;</span> 套接字缓冲区 <span class="hljs-punctuation">-&gt;</span> 网络
零拷贝:   磁盘 --------------------------<span class="hljs-punctuation">-&gt;</span> 套接字缓冲区 <span class="hljs-punctuation">-&gt;</span> 网络
</code></pre>
<h3 data-id="heading-10">强大的扩展性</h3>
<p>Kafka的扩展能力让它轻松应对业务增长：</p>
<ul>
<li><strong>分区扩展与重平衡</strong>：增加分区可提升吞吐量；消费者组动态加入或退出时，Kafka自动重新分配分区。</li>
<li><strong>动态Broker管理</strong>：新Broker可无缝加入集群，分区会自动重新分布。</li>
</ul>
<h3 data-id="heading-11">数据可靠性与一致性</h3>
<p>Kafka确保消息不丢失且一致性强：</p>
<ul>
<li><strong>副本与ISR</strong>：每个分区有多个副本，**同步副本（ISR）**与Leader保持一致。Broker故障时，副本可接管。</li>
<li><strong>ACK机制</strong>：生产者可选择确认级别（<code>acks=0</code>、<code>1</code>或<code>all</code>），在速度与可靠性间取舍。</li>
</ul>
<p><strong>表格</strong>：ACK模式对比</p>





























<table><thead><tr><th>模式</th><th>描述</th><th>可靠性</th><th>延迟</th></tr></thead><tbody><tr><td><code>acks=0</code></td><td>无确认</td><td>低</td><td>最快</td></tr><tr><td><code>acks=1</code></td><td>Leader确认</td><td>中</td><td>较快</td></tr><tr><td><code>acks=all</code></td><td>所有ISR确认</td><td>高</td><td>稍慢</td></tr></tbody></table>
<h3 data-id="heading-12">流处理能力</h3>
<p>Kafka不仅是消息系统，还是流处理平台。<strong>Kafka Streams</strong>是一个轻量级库，适合实时处理，如事件聚合或异常检测。</p>
<p><strong>对比</strong>：Kafka Streams与Flink/Spark</p>






























<table><thead><tr><th>特性</th><th>Kafka Streams</th><th>Flink/Spark</th></tr></thead><tbody><tr><td><strong>部署方式</strong></td><td>库（嵌入应用）</td><td>集群部署</td></tr><tr><td><strong>延迟</strong></td><td>亚秒级</td><td>秒级</td></tr><tr><td><strong>复杂度</strong></td><td>API简单</td><td>学习曲线陡</td></tr><tr><td><strong>适用场景</strong></td><td>流连接、聚合</td><td>复杂ETL、机器学习</td></tr></tbody></table>
<h3 data-id="heading-13">示例场景</h3>
<ul>
<li><strong>日志收集</strong>：Kafka的高吞吐量轻松处理每日TB级的日志数据，输送至Elasticsearch进行分析。例如，某媒体公司用Kafka实时收集用户点击日志，优化内容推荐。</li>
<li><strong>实时数据管道</strong>：在ETL流程中，Kafka作为数据源（如数据库）与目标（如数据仓库）间的缓冲，确保数据流畅可靠。</li>
</ul>
<hr/>
<h3 data-id="heading-14">过渡</h3>
<p>理论固然重要，但在生产环境中，Kafka的真正价值通过实战展现。接下来，我将分享在电商和分析项目中积累的经验，带你优化生产者、消费者和集群。</p>
<hr/>
<h2 data-id="heading-15">4. 项目实战经验与最佳实践</h2>
<p>基于我在电商订单系统和实时分析平台中使用Kafka的经验，以下是如何在实际项目中优化Kafka的技巧。</p>
<h3 data-id="heading-16">生产者优化</h3>
<p>生产者是数据的入口，优化它们对性能至关重要：</p>
<ul>
<li><strong>批量与异步发送</strong>：批量发送减少网络请求，异步模式提升应用响应速度。</li>
<li><strong>ACK与重试调优</strong>：设置<code>acks=1</code>平衡可靠性和性能，合理配置重试次数应对短暂故障。</li>
</ul>
<p><strong>示例代码</strong>：优化生产者</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;
<span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;
<span class="hljs-keyword">import</span> java.util.Properties;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedProducer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        props.put(<span class="hljs-string">"bootstrap.servers"</span>, <span class="hljs-string">"localhost:9092"</span>);
        props.put(<span class="hljs-string">"key.serializer"</span>, <span class="hljs-string">"org.apache.kafka.common.serialization.StringSerializer"</span>);
        props.put(<span class="hljs-string">"value.serializer"</span>, <span class="hljs-string">"org.apache.kafka.common.serialization.StringSerializer"</span>);
        <span class="hljs-comment">// 优化配置</span>
        props.put(<span class="hljs-string">"acks"</span>, <span class="hljs-string">"1"</span>); <span class="hljs-comment">// 仅Leader确认</span>
        props.put(<span class="hljs-string">"retries"</span>, <span class="hljs-number">3</span>); <span class="hljs-comment">// 重试3次</span>
        props.put(<span class="hljs-string">"batch.size"</span>, <span class="hljs-number">16384</span>); <span class="hljs-comment">// 16KB批次</span>
        props.put(<span class="hljs-string">"linger.ms"</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// 等待5ms凑批次</span>
        props.put(<span class="hljs-string">"buffer.memory"</span>, <span class="hljs-number">33554432</span>); <span class="hljs-comment">// 32MB缓冲区</span>

        <span class="hljs-keyword">try</span> (KafkaProducer&lt;String, String&gt; producer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaProducer</span>&lt;&gt;(props)) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
                producer.send(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerRecord</span>&lt;&gt;(<span class="hljs-string">"orders"</span>, <span class="hljs-string">"order-"</span> + i, <span class="hljs-string">"Details-"</span> + i));
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-17">消费者优化</h3>
<p>消费者需要精心调优以避免瓶颈：</p>
<ul>
<li><strong>消费者组管理</strong>：利用消费者组实现水平扩展，监控重平衡以减少延迟。</li>
<li><strong>手动提交偏移量</strong>：在消息处理后再提交偏移量，避免故障导致重复消费。</li>
</ul>
<p><strong>示例代码</strong>：可靠消费者</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;
<span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;
<span class="hljs-keyword">import</span> java.time.Duration;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.Properties;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReliableConsumer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        props.put(<span class="hljs-string">"bootstrap.servers"</span>, <span class="hljs-string">"localhost:9092"</span>);
        props.put(<span class="hljs-string">"group.id"</span>, <span class="hljs-string">"order-group"</span>);
        props.put(<span class="hljs-string">"enable.auto.commit"</span>, <span class="hljs-string">"false"</span>); <span class="hljs-comment">// 手动提交</span>
        props.put(<span class="hljs-string">"key.deserializer"</span>, <span class="hljs-string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);
        props.put(<span class="hljs-string">"value.deserializer"</span>, <span class="hljs-string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);

        <span class="hljs-keyword">try</span> (KafkaConsumer&lt;String, String&gt; consumer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaConsumer</span>&lt;&gt;(props)) {
            consumer.subscribe(Collections.singletonList(<span class="hljs-string">"orders"</span>));
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(<span class="hljs-number">100</span>));
                records.forEach(record -&gt; {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">// 模拟业务处理</span>
                        System.out.println(<span class="hljs-string">"处理: "</span> + record.value());
                        <span class="hljs-comment">// 手动提交偏移量</span>
                        consumer.commitSync();
                    } <span class="hljs-keyword">catch</span> (Exception e) {
                        System.err.println(<span class="hljs-string">"处理错误: "</span> + e.getMessage());
                    }
                });
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-18">集群管理</h3>
<p>生产环境的Kafka需要持续监控和规划：</p>
<ul>
<li><strong>监控运维</strong>：跟踪<strong>消费者滞后（Lag）</strong>、吞吐量和Broker健康状况，使用工具如<strong>Kafka Manager</strong>或<strong>Burrow</strong>。</li>
<li><strong>容量规划</strong>：根据吞吐量（例如每分区1MB/s）和保留策略估算Broker和分区需求。</li>
</ul>
<h3 data-id="heading-19">最佳实践</h3>
<ul>
<li><strong>主题设计</strong>：根据吞吐量需求选择分区数（例如10MB/s用10个分区），副本数至少设为3以确保高可用。</li>
<li><strong>消息格式</strong>：推荐使用<strong>Avro</strong>结合Schema Registry（如Confluent提供），确保类型安全和 schema 演化。</li>
<li><strong>性能调优</strong>：调整<code>num.io.threads</code>和<code>compression.type</code>（如<code>snappy</code>）优化CPU和带宽使用。</li>
</ul>
<h3 data-id="heading-20">实际应用场景</h3>
<ul>
<li><strong>案例1：电商订单系统</strong>：Kafka传输订单事件（如<code>place-order</code>、<code>update-inventory</code>），通过<code>acks=all</code>确保低延迟和高可靠。</li>
<li><strong>案例2：实时推荐系统</strong>：用户行为数据（如点击）通过Kafka收集，Kafka Streams处理后送至机器学习模型，生成个性化推荐。</li>
</ul>
<hr/>
<h3 data-id="heading-21">过渡</h3>
<p>即使有最佳实践，Kafka部署仍可能遇到问题。接下来，我将分享常见坑点和解决方案，帮助你打造稳健的系统。</p>
<hr/>
<h2 data-id="heading-22">5. 踩坑经验与问题解决</h2>
<h3 data-id="heading-23">常见问题</h3>
<p>Kafka功能强大，但复杂性也带来挑战。以下是常见问题及应对：</p>
<ul>
<li><strong>消费者滞后堆积</strong>：原因可能是消费者处理慢或分区不足。<strong>解决</strong>：增加分区、扩展消费者或优化处理逻辑。</li>
<li><strong>消息丢失/重复消费</strong>：<code>acks=0</code>或过早提交偏移量可能导致丢失；重试或错误提交引发重复。<strong>解决</strong>：用<code>acks=all</code>和手动提交。</li>
<li><strong>集群故障</strong>：Broker宕机或网络问题触发重平衡风暴。<strong>解决</strong>：确保副本同步，监控ISR健康。</li>
</ul>
<h3 data-id="heading-24">踩坑案例</h3>
<ul>
<li><strong>案例1：热点分区</strong>：键设计不当（例如用时间戳）导致消息集中到一个分区，造成负载不均。<strong>修复</strong>：使用均衡键（如用户ID），监控分区分布。</li>
<li><strong>案例2：重复消费</strong>：自动提交偏移量在处理前完成，故障时导致重复。<strong>修复</strong>：改为处理后手动提交。</li>
<li><strong>案例3：网络抖动</strong>：间歇性延迟导致消息延迟。<strong>修复</strong>：增加<code>request.timeout.ms</code>，调优<code>replication.factor</code>。</li>
</ul>
<h3 data-id="heading-25">解决方案</h3>
<ul>
<li><strong>日志与监控</strong>：使用<strong>Prometheus</strong>和<strong>Grafana</strong>可视化滞后和吞吐量，启用调试日志快速定位问题。</li>
<li><strong>配置优化</strong>：设置<code>min.insync.replicas=2</code>提升可靠性，调整<code>max.poll.records</code>控制消费者负载。</li>
</ul>
<p><strong>示例代码</strong>：健壮消费者带重试</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;
<span class="hljs-keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;
<span class="hljs-keyword">import</span> java.time.Duration;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.Properties;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RobustConsumer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        props.put(<span class="hljs-string">"bootstrap.servers"</span>, <span class="hljs-string">"localhost:9092"</span>);
        props.put(<span class="hljs-string">"group.id"</span>, <span class="hljs-string">"robust-group"</span>);
        props.put(<span class="hljs-string">"enable.auto.commit"</span>, <span class="hljs-string">"false"</span>);
        props.put(<span class="hljs-string">"key.deserializer"</span>, <span class="hljs-string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);
        props.put(<span class="hljs-string">"value.deserializer"</span>, <span class="hljs-string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);

        <span class="hljs-keyword">try</span> (KafkaConsumer&lt;String, String&gt; consumer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaConsumer</span>&lt;&gt;(props)) {
            consumer.subscribe(Collections.singletonList(<span class="hljs-string">"events"</span>));
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(<span class="hljs-number">100</span>));
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> record : records) {
                    <span class="hljs-type">int</span> <span class="hljs-variable">retries</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
                    <span class="hljs-keyword">while</span> (retries &gt; <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-comment">// 模拟业务处理</span>
                            processRecord(record.value());
                            consumer.commitSync();
                            <span class="hljs-keyword">break</span>;
                        } <span class="hljs-keyword">catch</span> (Exception e) {
                            retries--;
                            <span class="hljs-keyword">if</span> (retries == <span class="hljs-number">0</span>) {
                                System.err.println(<span class="hljs-string">"重试失败: "</span> + e.getMessage());
                            }
                            Thread.sleep(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 退避重试</span>
                        }
                    }
                }
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processRecord</span><span class="hljs-params">(String value)</span> {
        <span class="hljs-comment">// 模拟业务逻辑</span>
        System.out.println(<span class="hljs-string">"已处理: "</span> + value);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-26">过渡</h3>
<p>了解了Kafka的优势和坑点后，让我们总结它的核心价值，展望未来趋势，并给出学习建议。</p>
<hr/>
<h2 data-id="heading-27">6. 总结与展望</h2>
<p>Kafka是现代数据管道的支柱，助力系统轻松应对海量实时数据流。它在<strong>高吞吐量</strong>、<strong>持久化</strong>和<strong>流处理</strong>上的出色表现，使其成为电商、物联网等领域的核心组件。</p>
<p><strong>未来趋势</strong>：</p>
<ul>
<li><strong>云原生融合</strong>：Kafka与Kubernetes、Serverless结合更紧密，Strimzi等工具简化部署。</li>
<li><strong>生态扩展</strong>：<strong>Kafka Connect</strong>（数据集成）和<strong>KSQL</strong>（流查询）日益流行，减少自定义开发。</li>
<li><strong>AI与分析</strong>：Kafka在向机器学习管道提供实时数据方面作用凸显，连接事件流与预测模型。</li>
</ul>
<p><strong>个人心得</strong>：用了几年的Kafka，我依然为它在压力下的稳定性惊叹。建议从简单场景入手，熟悉基础后尝试Kafka Streams，逐步解锁更多可能。</p>
<p><strong>实践建议</strong>：</p>
<ol>
<li><strong>优先监控</strong>：用Grafana等工具尽早发现问题。</li>
<li><strong>测试故障</strong>：模拟Broker宕机，验证系统健壮性。</li>
<li><strong>探索生态</strong>：尝试Kafka Connect实现开箱即用的集成。</li>
</ol>
<p>Kafka是一场旅程——大胆尝试，持续学习，构建可扩展的分布式系统！</p>
<hr/>
<h2 data-id="heading-28">附录</h2>
<h3 data-id="heading-29">推荐资源</h3>
<ul>
<li><strong>官方文档</strong>：kafka.apache.org</li>
<li><strong>Confluent社区</strong>：confluent.io（教程、Schema Registry）</li>
<li><strong>书籍</strong>：《Kafka权威指南》（Neha Narkhede等）</li>
</ul>
<h3 data-id="heading-30">常见问题FAQ</h3>
<ul>
<li><strong>问：分区数该设多少？</strong><br/>
答：低吞吐量用1-2个分区/Broker，高负载用10-20个，避免过多分区增加开销。</li>
<li><strong>问：消费者为什么滞后？</strong><br/>
答：检查处理速度，增加消费者或分区。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dart - 完全解剖await/async原理]]></title>    <link>https://juejin.cn/post/7600489282822602802</link>    <guid>https://juejin.cn/post/7600489282822602802</guid>    <pubDate>2026-01-29T03:25:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282822602802" data-draft-id="7600333405978705961" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dart - 完全解剖await/async原理"/> <meta itemprop="keywords" content="Flutter,Dart"/> <meta itemprop="datePublished" content="2026-01-29T03:25:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="浩辉"/> <meta itemprop="url" content="https://juejin.cn/user/1134351728786711"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dart - 完全解剖await/async原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1134351728786711/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    浩辉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:25:04.000Z" title="Thu Jan 29 2026 03:25:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>准备好了吗？我们要把你习以为常的代码撕碎，看看它的内脏长什么样。</p>
<hr/>
<h2 data-id="heading-0">第一章：拆解 —— 编译器的“剪刀”</h2>
<p>作为 Dart 开发者，我们每天都在写 <code>async</code> 和 <code>await</code>。它们就像空气一样自然，以至于我们常常忘记了它们的存在。</p>
<p>看下面这段代码，它优雅、线性，符合人类的直觉：</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; makeCoffee() <span class="hljs-keyword">async</span> {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 开始烧水..."</span>);
  <span class="hljs-keyword">await</span> boilWater(); <span class="hljs-comment">// 耗时操作</span>
  
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 放入咖啡粉..."</span>);
  <span class="hljs-keyword">await</span> brew();      <span class="hljs-comment">// 耗时操作</span>
  
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 咖啡做好了，开喝！"</span>);
}

</code></pre>
<p>我们要问一个触及灵魂的问题：
<strong>Dart 是单线程的。既然代码在 <code>await boilWater()</code> 这一行“停”住了，为什么你的 App 界面没有卡死？为什么在这个等待期间，用户点击按钮还有反应？</strong></p>
<p>如果你回答“因为它在后台线程跑”，那就大错特错了（除非你用了 Isolate）。这段代码自始至终都跑在 <strong>UI 线程（Main Isolate）</strong> 上。</p>
<p>真相只有一个：<strong>虚拟机根本就没看到上面那段代码。</strong> 它是编译器为你编织的一个完美的谎言。</p>
<h3 data-id="heading-1">1.1 编译器的“剪刀” (The Compiler's Scissors)</h3>
<p>在编译阶段，Dart 编译器手里拿着一把“隐形的剪刀”。它会扫描你的 <code>async</code> 函数，寻找每一个 <code>await</code> 关键字。</p>
<p><strong><code>await</code> 对你来说是“等待”，但对编译器来说，它是一个“切分点” (Split Point)。</strong></p>
<p>每遇到一个 <code>await</code>，编译器就会咔嚓剪一刀，把你原本完整的函数切成好几段“碎片”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/427ef322906d4ed59c9b841fd165b1c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWp6L6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262139&amp;x-signature=s9qVnIZL1PxFQYNfA0fm%2FbDW0G8%3D" alt="Gemini_Generated_Image_qeg52cqeg52cqeg5.png" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 还原真相：降维打击 (Desugaring)</h3>
<p>如果我们要把这种“碎片化”还原成 Dart 1.0 时代的代码，它长什么样？</p>
<p>所谓的 <code>await</code>，本质上就是把**“剪刀后面的所有代码”<strong>打包，注册为</strong>“剪刀前面那个 Future”**的回调。</p>
<p>让我们手动进行一次 <strong>Desugaring (脱糖)</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 编译器眼里的 makeCoffee（伪代码）</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; makeCoffee() {
  <span class="hljs-comment">// --- 碎片 1：同步执行部分 ---</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 开始烧水..."</span>);
  
  <span class="hljs-comment">// 遇到第一个 await，函数其实在这里就 RETURN 了！</span>
  <span class="hljs-comment">// 它把剩下的代码打包成了 callback</span>
  <span class="hljs-keyword">return</span> boilWater().then((_) {
    
    <span class="hljs-comment">// --- 碎片 2：第一个回调 ---</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 放入咖啡粉..."</span>);
    
    <span class="hljs-keyword">return</span> brew().then((_) {
      
      <span class="hljs-comment">// --- 碎片 3：第二个回调 ---</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 咖啡做好了，开喝！"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    });
  });
}

</code></pre>
<p><strong>看清了吗？</strong></p>
<ol>
<li><strong>没有暂停</strong>：函数并没有神奇地停在中间，而是通过 <code>.then</code> 注册完回调后，<strong>立刻返回（Return）了</strong>。</li>
<li><strong>回调地狱</strong>：<code>async/await</code> 并没有消除回调地狱，它只是把它<strong>藏</strong>起来了。</li>
</ol>
<h3 data-id="heading-3">1.3 控制流的“蹦床”</h3>
<p>理解了“立即返回”，你就能理解为什么 UI 不会卡死了。</p>
<p>因为 <code>makeCoffee</code> 在执行到第一个 <code>await</code> 时，实际上是把控制权**交还（Yield）**给了 <strong>Event Loop</strong>。主线程就像一个只有一条跑道的操场，<code>makeCoffee</code> 跑了一半离场了，Event Loop 赶紧安排“UI 绘制任务”上跑道去跑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb3ef54bf33d47a2a01f6a0c10ab3cf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWp6L6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262139&amp;x-signature=8sv5TE4aUSZVasWs8QWaIucbaPU%3D" alt="Gemini_Generated_Image_cx15t4cx15t4cx15.png" loading="lazy"/></p>
<h3 data-id="heading-4">1.4 理论升华：CPS (Continuation-Passing Style)</h3>
<p>现在，请把目光聚焦在那些被剪下来的“后续代码碎片”上：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 这一坨代码，就是等待 boilWater 完成后要执行的东西</span>
(_) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 放入咖啡粉..."</span>);
  <span class="hljs-keyword">return</span> brew().then(...);
}

</code></pre>
<p>在计算机科学中，这种**“在特定时刻之后剩余的所有计算逻辑”**，有一个非常优雅的学名——<strong>Continuation (续体)</strong>，意为“待续的部分”。</p>
<p>而这种**“不直接返回结果，而是把‘接下来要做的事’打包成一个函数传给下一步”**的编程风格，就叫做 <strong>CPS (Continuation-Passing Style，续体传递风格)</strong>。</p>
<p><strong>总结一下第一章的核心结论：</strong>
Dart 编译器是一个勤劳的翻译官。它将你写的 <code>async/await</code> 代码（Direct Style），悄悄翻译成了 CPS 风格的代码。</p>
<ul>
<li><code>await</code> 不是暂停，是 <strong>Return</strong>。</li>
<li><code>await</code> 后面的代码，是 <strong>Continuation</strong>。</li>
</ul>
<p>但是，如果一个函数里有 10 个 <code>await</code>，就会切出 11 个碎片。如果用嵌套的 <code>.then</code> 来管理，代码会变成无法维护的“金字塔”。</p>
<p>编译器是如何优雅地管理这一地碎片的？它没有用 <code>.then</code>，而是生成了一个复杂的<strong>类</strong>。
这就引出了下一章的主角——<strong>状态机 (State Machine)</strong>。
这是 <strong>《解剖 async/await —— 状态机与控制流》</strong> 系列的第二章。</p>
<p>在第一章中，我们见识了编译器的“剪刀”，它把我们线性的代码切成了一地碎片（Continuations）。现在面临的问题是：怎么把这些碎片重新粘合起来，让它们能按正确的顺序执行，并且还能记住之前的状态？</p>
<p>欢迎来到编译器的核心魔术现场。这一章，我们将见证 <strong>状态机 (State Machine)</strong> 的诞生。</p>
<hr/>
<h2 data-id="heading-5">第二章：重组 —— 状态机的诞生</h2>
<p>如果说第一章是“破”，这一章就是“立”。我们要揭示隐藏在优雅的 <code>async</code> 关键字背后的那个庞大而精巧的数据结构。</p>
<h3 data-id="heading-6">2.1 核心冲突：丢失的上下文 (The Vanishing Context)</h3>
<p>让我们回到第一章的结论：当代码执行到 <code>await</code> 时，当前的函数实际上是执行了 <strong>Return</strong> 操作，把控制权交还给了事件循环。</p>
<p>在计算机底层原理中，<strong>“函数返回”意味着一个严重的后果：该函数的栈帧 (Stack Frame) 被销毁了</strong>。</p>
<p>保存在栈帧里的东西——所有的局部变量、临时参数——都会灰飞烟灭。</p>
<p>来看看我们稍微复杂一点的 <code>makeCoffee</code>：</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; makeCoffee(<span class="hljs-built_in">String</span> type) <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 局部变量，住在栈上</span>
  <span class="hljs-built_in">int</span> waterAmount = type == <span class="hljs-string">"Espresso"</span> ? <span class="hljs-number">50</span> : <span class="hljs-number">200</span>; 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"准备制作 <span class="hljs-subst">$type</span>，需要水量: <span class="hljs-subst">$waterAmount</span> ml"</span>);

  <span class="hljs-keyword">await</span> boilWater(waterAmount); 
  
  <span class="hljs-comment">// 恢复执行时，type 和 waterAmount 必须从堆里找回来</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"放入咖啡粉，开始萃取 <span class="hljs-subst">$type</span>..."</span>); 
  ![image](https:<span class="hljs-comment">//note.youdao.com/yws/res/17314/WEBRESOURCEdfb3e94273735a7e07981ed9d51f64bf)</span>
  <span class="hljs-keyword">await</span> brew();
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 咖啡做好了，开喝！"</span>);
}

</code></pre>
<p><strong>冲突点</strong>：异步执行需要跨越时间。在等待期间，我们必须找个地方把这些局部变量“存”起来，而且这个地方不能是“用完即弃”的栈，必须是能长期存储的 <strong>堆 (Heap)</strong>。</p>
<h3 data-id="heading-7">2.2 惊人转变：从函数到对象 (From Function to Object)</h3>
<p>编译器是如何解决“上下文保存”问题的？答案极具想象力。</p>
<p><strong>揭秘时刻：每一个被你标记为 <code>async</code> 的函数，在编译后，实际上都变成了一个自定义的 类 (Class)。</strong></p>
<p>Dart 编译器会为你悄悄生成一个类，通常命名类似于 <code>_MakeCoffeeStateMachine</code>。</p>
<h4 data-id="heading-8">“变量搬家”工程</h4>
<p>编译器会进行一次大规模的“搬家”行动：它会扫描你的异步函数，把所有需要在 <code>await</code> 之后继续使用的<strong>局部变量</strong>，统统提升为这个生成类的<strong>成员变量 (Fields)</strong>。</p>
<p>这样一来，这些变量就从“暂住的栈”搬到了“永居的堆”（因为对象是分配在堆上的）。只要这个状态机对象不死，这些变量就一直存在。</p>
<p>此外，这个类还需要一个最重要的核心变量：<strong>状态指针 (<code>_state</code>)</strong>。它是一个整数，用来记住当前代码执行到了第几个碎片。</p>
<h3 data-id="heading-9">2.3 核心结构：巨大的 Switch-Case</h3>
<p>现在，变量有了安身之所，那执行逻辑呢？那些代码碎片怎么组织？</p>
<p>生成的状态机类中，会有一个核心方法（我们姑且叫它 <code>moveNext()</code>）。这个方法的内部，就是一个巨大的 <strong><code>switch-case</code></strong> 结构，用来分发我们在第一章切出来的那些代码碎片。</p>
<p>让我们来看看编译器视角下的代码结构图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1df3b9d01524ed1837537f0b6f71972~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWp6L6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262139&amp;x-signature=C3ncqcj72idYa7gVdyX4IeCSc%2BE%3D" alt="Gemini_Generated_Image_gm99xpgm99xpgm99.png" loading="lazy"/></p>
<h3 data-id="heading-10">2.4 拼图完成：伪代码全貌</h3>
<p>结合变量搬家和 Switch 结构，我们可以写出编译器生成的那个“幕后黑手”的伪代码了：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 编译器生成的幕后类</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MakeCoffeeStateMachine</span> </span>{
  <span class="hljs-comment">// --- 1. 成员变量 (搬家后的局部变量) ---</span>
  <span class="hljs-built_in">int</span> _state = <span class="hljs-number">0</span>; <span class="hljs-comment">// 状态指针，初始为 0</span>
  <span class="hljs-built_in">String</span> type;    <span class="hljs-comment">// 以前是参数</span>
  <span class="hljs-built_in">int</span> waterAmount; <span class="hljs-comment">// 以前是局部变量</span>
  Completer&lt;<span class="hljs-keyword">void</span>&gt; _completer = Completer(); <span class="hljs-comment">// 用来控制最终返回的那个 Future</span>

  <span class="hljs-comment">// 构造函数接收初始参数</span>
  _MakeCoffeeStateMachine(<span class="hljs-keyword">this</span>.type);

  <span class="hljs-comment">// --- 2. 核心方法：推动状态机运转 ---</span>
  <span class="hljs-keyword">void</span> moveNext() {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">switch</span> (_state) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-comment">// --- 碎片 1：立即执行部分 ---</span>
          waterAmount = type == <span class="hljs-string">"Espresso"</span> ? <span class="hljs-number">50</span> : <span class="hljs-number">200</span>;
          <span class="hljs-built_in">print</span>(<span class="hljs-string">"准备制作 <span class="hljs-subst">$type</span>，需要水量: <span class="hljs-subst">$waterAmount</span> ml"</span>);
          
          <span class="hljs-comment">// 关键：修改状态，准备去下一个 case</span>
          _state = <span class="hljs-number">1</span>; 
          <span class="hljs-comment">// 注册回调，然后立即 RETURN (挂起)</span>
          <span class="hljs-comment">// 注意：这里把 `this.moveNext` 注册为了回调！</span>
          boilWater(waterAmount).then((_) =&gt; <span class="hljs-keyword">this</span>.moveNext());
          <span class="hljs-keyword">return</span>; 

        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-comment">// --- 碎片 2：第一个回调恢复 ---</span>
          <span class="hljs-comment">// 此时 waterAmount 和 type 依然从成员变量里读取，数据还在！</span>
          <span class="hljs-built_in">print</span>(<span class="hljs-string">"放入咖啡粉，开始萃取 <span class="hljs-subst">$type</span>..."</span>);
          
          _state = <span class="hljs-number">2</span>;
          brew().then((_) =&gt; <span class="hljs-keyword">this</span>.moveNext());
          <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 再次挂起</span>

        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-comment">// --- 碎片 3：最后的部分 ---</span>
          <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 咖啡做好了，开喝！"</span>);
          <span class="hljs-comment">// 任务全部完成，通知外界</span>
          _completer.complete(); 
          <span class="hljs-keyword">return</span>;
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 处理异常（第四章细讲）</span>
      _completer.completeError(e);
    }
  }

  <span class="hljs-comment">// 对外暴露的 Future</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; <span class="hljs-keyword">get</span> future =&gt; _completer.future;
}

</code></pre>
<p><strong>总结一下第二章：</strong>
所谓“异步函数”，在骨子里是一个<strong>对象</strong>。
编译器通过把函数转换成类，把局部变量提升为成员变量，成功地在堆上保存了执行上下文。而那个巨大的 <code>switch-case</code> 结构，就是管理代码碎片执行顺序的调度器。</p>
<p>现在，结构已经搭好了，静态的模型已经建立。
那么，这个机器是怎么动起来的？是谁在调用 <code>moveNext()</code>？控制权是如何在状态机和事件循环之间倒手的？</p>
<p>下一章，我们将让这个状态机运转起来，看看它的<strong>动态流转过程</strong>。</p>
<p>这是 <strong>《解剖 async/await —— 状态机与控制流》</strong> 系列的第三章。</p>
<p>在前两章里，我们像法医一样，把一个活生生的异步函数“解剖”成了碎片（CPS），然后又看着编译器像弗兰肯斯坦一样，把这些碎片缝合成了一个怪异的物体——<strong>状态机对象 (State Machine Object)</strong>。</p>
<p>此刻，这个对象静静地躺在堆内存里，拥有了结构（Switch-Case）和记忆（成员变量），但它还没有生命。</p>
<p>这一章，我们将接通电源。我们要亲眼目睹控制权是如何在<strong>状态机</strong>和<strong>事件循环</strong>之间像打乒乓球一样来回传递的。这才是“非阻塞”的终极奥义。</p>
<hr/>
<h2 data-id="heading-11">第三章：流转 —— 暂停与恢复的艺术</h2>
<p>我们常说 <code>await</code> 让函数“暂停”和“恢复”了。这听起来很神奇，仿佛时间静止了一样。</p>
<p>但学完前两章你已经知道，底层的世界里没有魔法，只有冷冰冰的 <strong>Return (函数返回)</strong> 和 <strong>Callback (回调)</strong>。</p>
<p>所谓的“暂停与恢复”，本质上是一场精心编排的**“接力赛”**。</p>
<h3 data-id="heading-12">3.1 启动：第一推力 (The Ignition)</h3>
<p>一切始于你在一行普通的同步代码中调用了这个异步函数：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"主程序开始"</span>);
  <span class="hljs-comment">// 这一行，就是点火时刻</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; coffeeFuture = makeCoffee(<span class="hljs-string">"Espresso"</span>); 
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"主程序继续做其他事..."</span>);
  <span class="hljs-comment">// ...</span>
}

</code></pre>
<p>当你执行 <code>makeCoffee("Espresso")</code> 时，机器内部发生了什么？</p>
<ol>
<li><strong>创建实例</strong>：在堆上 new 了一个 <code>_MakeCoffeeStateMachine</code> 的实例对象。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MakeCoffeeStateMachine</span> </span>{
  <span class="hljs-comment">// --- 1. 成员变量 (搬家后的局部变量) ---</span>
  <span class="hljs-built_in">int</span> _state = <span class="hljs-number">0</span>; <span class="hljs-comment">// 状态指针，初始为 0</span>
  <span class="hljs-built_in">String</span> type;    <span class="hljs-comment">//参数</span>
  <span class="hljs-built_in">int</span> waterAmount; /是局部变量
  Completer&lt;<span class="hljs-keyword">void</span>&gt; _completer = Completer(); <span class="hljs-comment">// 用来控制最终返回的那个 Future</span>

  <span class="hljs-comment">// 构造函数接收初始参数</span>
  _MakeCoffeeStateMachine(<span class="hljs-keyword">this</span>.type);

  <span class="hljs-comment">// --- 2. 核心方法：推动状态机运转 ---</span>
  <span class="hljs-keyword">void</span> moveNext() {
      <span class="hljs-comment">//...省略</span>
  }
</code></pre>
<ol start="2">
<li><strong>保存参数</strong>：把字符串 <code>"Espresso"</code> 存入对象的成员变量 <code>this.type</code>。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MakeCoffeeStateMachine</span> </span>{
 <span class="hljs-comment">// --- 1. 成员变量 (搬家后的局部变量) ---</span>
 <span class="hljs-built_in">int</span> _state = <span class="hljs-number">0</span>; <span class="hljs-comment">// 状态指针，初始为 0</span>
 <span class="hljs-built_in">String</span> type;    <span class="hljs-comment">//参数--------------------------------------&gt;保存参数</span>
 <span class="hljs-built_in">int</span> waterAmount; /是局部变量
 Completer&lt;<span class="hljs-keyword">void</span>&gt; _completer = Completer(); <span class="hljs-comment">// 用来控制最终返回的那个 Future</span>

 <span class="hljs-comment">// 构造函数接收初始参数</span>
 _MakeCoffeeStateMachine(<span class="hljs-keyword">this</span>.type);

 <span class="hljs-comment">// --- 2. 核心方法：推动状态机运转 ---</span>
 <span class="hljs-keyword">void</span> moveNext() {
     <span class="hljs-comment">//...省略</span>
 }
</code></pre>
<ol start="3">
<li><strong>手动点火（关键！）</strong>：编译器会自动插入一行代码，<strong>手动调用一次</strong>这个对象的 <code>moveNext()</code> 方法。</li>
</ol>
<p>这是第一张多米诺骨牌。</p>
<p>此时，<code>_state</code> 是 0。<code>switch</code> 跳到 <code>case 0</code>，开始同步执行第一段代码：计算水量，打印 "开始烧水..."。</p>
<h3 data-id="heading-13">3.2 交权：关键的“握手” (The Handover)</h3>
<p>代码一路狂奔，直到撞上了第一个墙壁：<code>await boilWater()</code>。</p>
<p>这是整个机制中最精彩的瞬间。状态机不能在这里干等，否则主线程就卡死了。它必须把控制权交出去。</p>
<p>在伪代码层面，这一刻发生了两个关键动作：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
  <span class="hljs-comment">// ... 执行同步代码 ...</span>

  <span class="hljs-comment">// 动作 A：记住下一步该去哪</span>
  _state = <span class="hljs-number">1</span>; 
  
  <span class="hljs-comment">// 动作 B：关键握手！</span>
  <span class="hljs-comment">// 状态机对自己说：“boilWater，等你完事了，记得叫我一声。”</span>
  <span class="hljs-comment">// “我是谁？我就是这个 moveNext 方法本身！”</span>
  boilWater().then((_) =&gt; <span class="hljs-keyword">this</span>.moveNext());

  <span class="hljs-comment">// 动作 C：立即撤退！控制权交还给 Event Loop</span>
  <span class="hljs-keyword">return</span>; 

</code></pre>
<p>看懂了吗？状态机并没有“暂停”，它只是<strong>把自己（<code>moveNext</code> 方法）注册成了回调，然后光荣退场了（Return）</strong>。</p>
<p>此时，主线程空闲下来，Event Loop 愉快地接过控制权，去处理界面刷新、响应按钮点击等其他任务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2e432cb7ec54802b5c841ee8b3f2f9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWp6L6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262139&amp;x-signature=rtTAre6BFbbgEOJUOVqT9lnzLX0%3D" alt="Gemini_Generated_Image_fgl5yqfgl5yqfgl5.png" loading="lazy"/></p>
<p>几秒钟后，烧水任务完成了。</p>
<ol>
<li>系统底层发出信号。</li>
<li>Event Loop 查看之前的记录，发现这个任务完成时需要调用一个回调。</li>
<li>Event Loop 执行回调，也就是<strong>再次调用了状态机的 <code>moveNext()</code> 方法</strong>。</li>
</ol>
<p>这次进来时，<code>_state</code> 已经是 1 了。</p>
<p><code>switch</code> 精准地跳过了 <code>case 0</code>，直接落入了 <code>case 1</code>。这就仿佛代码从上次离开的地方“恢复”了一样！</p>
<ul>
<li>它从成员变量里读取之前存下的 <code>type</code>（上下文恢复了！）。</li>
<li>打印 "开始萃取..."。</li>
<li>遇到 <code>await brew()</code>。</li>
<li><strong>历史重演</strong>：<code>_state</code> 变成 2，注册 <code>this.moveNext</code> 为回调，然后再次 <strong>Return</strong>，把控制权像打乒乓球一样又打回给了 Event Loop。</li>
</ul>
<p>这就是“非阻塞”的真相：<strong>不是一条线程在死等，而是控制权在状态机和事件循环之间高频、有序地切换。</strong></p>
<h3 data-id="heading-14">3.4 终局：Completer 的使命</h3>
<p>终于，最后一步 <code>brew()</code> 也完成了。Event Loop 第三次调用 <code>moveNext()</code>。</p>
<p>这一次，<code>_state</code> 是 2，进入最后一个 <code>case</code>。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 咖啡做好了，开喝！"</span>);
  <span class="hljs-comment">// 游戏结束。</span>
  <span class="hljs-comment">// 那个在最外面等待 makeCoffee() 的人，还在痴痴地等呢。</span>
  <span class="hljs-comment">// 是时候通知他了！</span>
  _completer.complete(); 
  <span class="hljs-keyword">return</span>;

</code></pre>
<p>还记得我们在第二章状态机里埋下的那个 <code>Completer</code> 成员变量吗？它是连接状态机内部世界和外部调用者的桥梁。</p>
<p>调用 <code>_completer.complete()</code> 的瞬间，外部那个 <code>coffeeFuture</code> 终于变成了 "Completed" 状态。外部跟着的 <code>.then()</code> 或 <code>await</code> 后面的代码得以继续执行。</p>
<p>至此，整个异步任务圆满结束，状态机对象完成了它的历史使命，等待被垃圾回收 (GC)。</p>
<hr/>
<p><strong>总结一下第三章的顿悟时刻：</strong></p>
<p>你以为的“恢复执行”，并不是虚拟机真的有一个“时光倒流”按钮回到过去。</p>
<p>真相是：<strong>函数被重新调用了一次 (Re-entry)</strong>。</p>
<p>只是因为这个函数变成了一个对象，并且它肚子里有一个 <code>_state</code> 变量记住了“上次读到哪一页了”，所以它每次都能精准地接着往下读。</p>
<p>现在，我们已经彻底搞清了正常流程。但是，如果烧水的时候炉子炸了怎么办？
下一章，我们将揭开最后一个谜团：<strong>在这一堆支离破碎的回调和状态跳转中，Dart 是如何实现跨越时空的异常捕获 (try-catch) 的？</strong></p>
<p>好的，这个要求非常合理。只有看到“尸体解剖”后的完整代码，才能真正理解异常是如何流转的。</p>
<p>我们将按照**“源代码 -&gt; 反编译代码 -&gt; 流程逐帧解析 -&gt; 总结”**的顺序来完成这一章的核心部分。</p>
<hr/>
<h2 data-id="heading-15">第四章：异常 —— 跨越时空的救赎</h2>
<h3 data-id="heading-16">4.1 核心：反编译全貌 (The Decompiled Reality)</h3>
<p>首先，这是我们写的<strong>源代码</strong>，简单直接：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 源代码</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; makeCoffee() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// [State 0]</span>
    <span class="hljs-keyword">await</span> boilWater(); 
    <span class="hljs-comment">// [State 1]</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"水开了"</span>);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// [State 2]</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"炸炉了: <span class="hljs-subst">$e</span>"</span>);
  }
}

</code></pre>
<p>下面是编译器生成的<strong>状态机伪代码</strong>。请仔细观察 <code>moveNext</code> 方法中的 <code>try-catch</code> 结构，以及底部的 <code>_handleException</code>（模拟异常跳转表）。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 编译器生成的幕后类（反编译视角）</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MakeCoffeeStateMachine</span> </span>{
  <span class="hljs-comment">// --- 1. 成员变量 ---</span>
  <span class="hljs-built_in">int</span> _state = <span class="hljs-number">0</span>;              <span class="hljs-comment">// 状态指针</span>
  <span class="hljs-built_in">Object?</span> _pendingError;       <span class="hljs-comment">// 暂存异步带回来的错误</span>
  Completer&lt;<span class="hljs-keyword">void</span>&gt; _completer = Completer(); 

  <span class="hljs-comment">// --- 2. 核心驱动方法 ---</span>
  <span class="hljs-keyword">void</span> moveNext() {
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) { <span class="hljs-comment">// 一个循环，用来支持 state 的连续跳转</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// [关键点 A]: 如果有上次异步任务留下的错误，先在这里抛出来！</span>
        <span class="hljs-comment">// 这样就能被下面的 catch 捕获，从而进入路由逻辑。</span>
        <span class="hljs-keyword">if</span> (_pendingError != <span class="hljs-keyword">null</span>) {
          <span class="hljs-keyword">var</span> error = _pendingError;
          _pendingError = <span class="hljs-keyword">null</span>;
          <span class="hljs-keyword">throw</span> error; 
        }

        <span class="hljs-comment">// --- 核心 switch 分发 ---</span>
        <span class="hljs-keyword">switch</span> (_state) {
          <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: 
            <span class="hljs-comment">// --- 对应源代码：try { await boilWater(); } ---</span>
            _state = <span class="hljs-number">1</span>; <span class="hljs-comment">// 设定好：如果成功，下次去 case 1</span>
            
            <span class="hljs-comment">// 调用异步任务</span>
            <span class="hljs-keyword">var</span> future = boilWater();
            
            <span class="hljs-comment">// [关键点 B]: 注册回调</span>
            <span class="hljs-comment">// 无论成功还是失败，都把结果存一下，然后再次调用 moveNext</span>
            future.then(
              (value) {
                <span class="hljs-comment">// 成功：直接回调</span>
                <span class="hljs-keyword">this</span>.moveNext();
              },
              onError: (error) {
                <span class="hljs-comment">// 失败：存下错误，标记为待处理，然后回调</span>
                <span class="hljs-keyword">this</span>._pendingError = error;
                <span class="hljs-keyword">this</span>.moveNext();
              }
            );
            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 挂起！交出控制权</span>

          <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
            <span class="hljs-comment">// --- 对应源代码：print("水开了"); ---</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"水开了"</span>);
            <span class="hljs-comment">// 任务正常结束</span>
            _completer.complete();
            <span class="hljs-keyword">return</span>;

          <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
            <span class="hljs-comment">// --- 对应源代码：catch (e) { ... } ---</span>
            <span class="hljs-comment">// 这里能拿到刚才抛出的异常</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"炸炉了: <span class="hljs-subst">${_currentException}</span>"</span>); 
            _completer.complete();
            <span class="hljs-keyword">return</span>;
        }
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-comment">// --- 3. 全局救生网 ---</span>
        <span class="hljs-comment">// [关键点 C]: 一旦发生异常，查表！</span>
        _handleException(e);
      }
    }
  }

  <span class="hljs-comment">// --- 4. 异常跳转表 (Exception Table) ---</span>
  <span class="hljs-keyword">void</span> _handleException(<span class="hljs-built_in">Object</span> exception) {
    <span class="hljs-comment">// 编译器在这里硬编码了路由逻辑：</span>
    <span class="hljs-comment">// "如果当前是在 State 0 或 1 炸的，就去 State 2 (catch块)"</span>
    <span class="hljs-keyword">if</span> (_state == <span class="hljs-number">0</span> || _state == <span class="hljs-number">1</span>) {
      _state = <span class="hljs-number">2</span>; <span class="hljs-comment">// &lt;--- 强制变轨！</span>
      _currentException = exception; <span class="hljs-comment">// 把错误对象交给 catch 块</span>
      <span class="hljs-comment">// 注意：这里没有 return，循环会继续，马上执行 case 2</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 如果 State 2 (catch块) 里也炸了，或者没写 try-catch</span>
      <span class="hljs-comment">// 那就彻底没救了，通知外界 Future 失败</span>
      _completer.completeError(exception);
    }
  }
  
  <span class="hljs-built_in">Object?</span> _currentException; <span class="hljs-comment">// 临时存一下给 catch 块用的变量</span>
}

</code></pre>
<hr/>
<h3 data-id="heading-17">4.2 慢动作回放：异常流转七步曲</h3>
<p>现在，我们假设 <code>boilWater()</code> 在 3 秒后抛出了一个 "Boom!" 异常。让我们看看上面的代码是如何一步步执行的。</p>
<h4 data-id="heading-18">第一阶段：埋雷</h4>
<ol>
<li><strong>State 0 启动</strong>: <code>moveNext()</code> 首次运行，进入 <code>case 0</code>。</li>
<li><strong>设定路线</strong>: 将 <code>_state</code> 设为 1（默认成功路径）。</li>
<li><strong>挂起</strong>: 调用 <code>boilWater()</code>，注册了回调，状态机 <code>return</code>。主线程去干别的事了。</li>
</ol>
<h4 data-id="heading-19">第二阶段：引爆</h4>
<ol start="4">
<li><strong>异步回调</strong>: 3 秒后，<code>boilWater</code> 失败。Future 触发 <code>onError</code> 回调。</li>
<li><strong>存雷</strong>: 回调函数执行 <code>this._pendingError = "Boom!"</code>。</li>
<li><strong>重启</strong>: 回调函数再次调用 <code>this.moveNext()</code>。</li>
</ol>
<h4 data-id="heading-20">第三阶段：排雷与变轨</h4>
<ol start="7">
<li><strong>Re-entry (重入)</strong>: <code>moveNext()</code> 再次开始执行。</li>
<li><strong>抛雷 [关键点 A]</strong>: 代码一进来检查 <code>if (_pendingError != null)</code>，发现有雷！于是 <code>throw "Boom!"</code>。</li>
<li><strong>被捕获 [关键点 C]</strong>: 这个 <code>throw</code> 瞬间被外层的 <code>catch (e)</code> 捕获。<code>switch</code> 根本没机会执行。</li>
<li><strong>查表</strong>: 进入 <code>_handleException(e)</code>。</li>
</ol>
<ul>
<li>检查：刚才我本来打算去哪？(<code>_state</code> 此时是 1)。</li>
<li>规则：State 0 和 1 都在 <code>try</code> 块保护范围内。</li>
<li>动作：<strong>把 <code>_state</code> 强行改为 2</strong> (即用户的 catch 块)。</li>
</ul>
<h4 data-id="heading-21">第四阶段：软着陆</h4>
<ol start="11">
<li><strong>Loop 继续</strong>: 因为 <code>_handleException</code> 里没有 return，<code>while(true)</code> 循环继续转动。</li>
<li><strong>进入 Case 2</strong>: 这一次，<code>switch(_state)</code> 看到的是 2。</li>
<li><strong>执行救灾</strong>: 执行 <code>print("炸炉了: Boom!")</code>。</li>
<li><strong>完成</strong>: <code>_completer.complete()</code>。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ca880509355462785b099dfe928a27d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWp6L6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262139&amp;x-signature=RyK6%2FB7UJjjAKEUoLCd%2BG3hr8hI%3D" alt="Gemini_Generated_Image_tnrs69tnrs69tnrs.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-22">4.3 总结</h3>
<p>通过这次反编译和流转分析，我们可以得出关于 Dart 异步异常处理的三个终极结论：</p>
<ol>
<li><strong>没有真正的“异步捕获”</strong>：
所谓的跨越时空捕获，其实是**“异步传递 + 同步抛出”**。错误先被存在变量里 (<code>_pendingError</code>)，等状态机再次运行时，在同步环境里被主动 <code>throw</code> 出来，从而利用了同步的 <code>try-catch</code> 机制。</li>
<li><strong>State Machine 是个“作弊者”</strong>：
它不仅记住了代码执行到哪一行（<code>_state</code>），还随身带着一张地图（Exception Table）。一旦出事，它知道该把代码强行跳转到哪里。</li>
<li><strong>try-catch 只是路由规则</strong>：
在异步代码中，<code>try-catch</code> 不再是运行时的栈保护结构，它在编译时就被硬编码成了状态机的<strong>状态跳转逻辑 (GOTO State X)</strong>。</li>
</ol>
<p>这一章彻底揭开了 <code>async/await</code> 最晦涩的一面。现在，你已经完全理解了 Future 的所有底层机制。
下一章（终章），我们将跳出微观，去俯瞰 Dart 的并发全景图，看看 Future、Stream 和 Isolate 到底该怎么选。</p>
<p>这是 <strong>《解剖 async/await —— 状态机与控制流》</strong> 系列的最终章。</p>
<p>在前四章，我们将显微镜推到了极致，看清了每一颗螺丝钉。现在，是时候收起显微镜，拿出望远镜，站在上帝视角来审视这一切了。</p>
<p>懂得原理，不仅仅是为了炫技，更是为了在实战中做出更聪明的决策。</p>
<hr/>
<h2 data-id="heading-23">第五章：总结</h2>
<h3 data-id="heading-24">5.1 原理反哺实战：给老司机的三条建议</h3>
<p>既然你已经知道了 <code>async</code> 函数背后是一个状态机，那么在写代码时，你的直觉应该发生改变。以下是三条基于底层原理的高级建议：</p>
<h4 data-id="heading-25">1. 警惕“蹦床效应” (The Trampoline Cost)</h4>
<ul>
<li><strong>原理回顾</strong>：每次 <code>await</code>，本质上都是一次 <code>return</code>（挂起）和一次基于 Event Loop 的回调（恢复）。这就像在蹦床上跳跃，虽然不阻塞线程，但“起跳”和“落地”是有调度成本的。</li>
<li><strong>实战建议</strong>：<strong>不要滥用 <code>await</code>。</strong>
如果任务 B 不依赖任务 A 的结果，<strong>千万不要</strong>串行地写 <code>await A(); await B();</code>。这会导致状态机频繁地挂起和恢复，浪费调度资源。
**请使用 <code>Future.wait([A(), B()])**</code>。这能让两个任务并行跑在 Event Loop 上，状态机只需挂起一次，等待它们全部回来。</li>
</ul>
<h4 data-id="heading-26">2. 关注“堆内存膨胀” (Heap Bloat)</h4>
<ul>
<li><strong>原理回顾</strong>：<code>async</code> 函数里的局部变量，会被“搬家”到堆上的状态机对象里成为成员变量。</li>
<li><strong>实战建议</strong>：<strong>避免编写巨型的 <code>async</code> 函数。</strong>
如果你写了一个几百行的 <code>async</code> 函数，里面定义了几十个大对象（List, Map 等）作为临时变量。哪怕你只在第一行用了它们，它们也可能会一直赖在状态机对象里，直到整个函数结束才能被 GC（垃圾回收）。
<strong>拆分函数</strong>，让小的状态机尽快销毁，释放内存。</li>
</ul>
<h4 data-id="heading-27">3. 看懂“骗人”的堆栈 (The Lying Stack Trace)</h4>
<ul>
<li><strong>原理回顾</strong>：异常流转是“存雷”再“抛雷”的过程，真实的物理调用栈早断了。</li>
<li><strong>实战建议</strong>：<strong>调整心态。</strong>
当你看到异步报错的 Stack Trace 时，不要困惑为什么有些帧看起来很奇怪（充满了 <code>_rootRun</code>, <code>microtaskLoop</code> 等系统底层方法）。你现在知道，这是 Dart VM 尽力为你“伪造”的一个逻辑调用栈。理解了这一点，调试异步 Bug 时你会更加从容。</li>
</ul>
<h3 data-id="heading-28">5.2 重绘地图：三驾马车的最终定论</h3>
<p>回到我们最开始的问题：Future、Stream、Isolate 到底怎么选？站在状态机的视角，界限非常清晰：</p>
<ol>
<li><strong>Future (状态机)</strong>：<strong>主线程上的时间管理大师。</strong></li>
</ol>
<ul>
<li>本质是<strong>切分</strong>。它把一个长任务切成碎片，利用等待时间让出 CPU。</li>
<li><em>适用</em>：网络请求、文件读写、数据库操作。</li>
</ul>
<ol start="2">
<li><strong>Isolate (真线程)</strong>：<strong>主线程的替身使者。</strong></li>
</ol>
<ul>
<li>如果状态机里某个 <code>case</code> 的<strong>同步代码</strong>（比如解析 10MB 的 JSON，或图像处理）执行时间太长（超过 16ms），<code>moveNext</code> 就会卡住，导致主线程掉帧。</li>
<li>这时候，必须把这个计算任务扔给 Isolate。</li>
<li><em>适用</em>：繁重的 CPU 计算。</li>
</ul>
<ol start="3">
<li><strong>Stream (流水线)</strong>：<strong>可循环触发的状态机。</strong></li>
</ol>
<ul>
<li>Future 的状态机跑到终点就结束了（Completer 完成）。</li>
<li>Stream 可以理解为一个<strong>不立即销毁</strong>的状态机。它可以被多次唤醒，源源不断地吐出数据。</li>
</ul>
<h3 data-id="heading-29">5.3 核心思想总结：同步的幻象，异步的真相</h3>
<p>最后，为了回应你对 <code>async/await</code> 本质的好奇，我们用一段话来总结这套语法的哲学内核：</p>
<p><strong><code>async/await</code> 本质上是一场精彩的编译器魔术，旨在消除“人类思维”与“机器执行”之间的鸿沟。</strong></p>
<ul>
<li><strong>人类的思维是线性的</strong>：我们习惯顺序做事（烧水 -&gt; 倒粉 -&gt; 喝咖啡），这种风格被称为 <strong>Direct Style（直接风格）</strong>。</li>
<li><strong>机器的高效是碎片的</strong>：为了不阻塞线程，代码必须写成 <strong>CPS（Continuation-Passing Style，续体传递风格）</strong>，即“做完这步，回调下一步”。</li>
</ul>
<p>Dart 编译器利用 <strong>状态机 (State Machine)</strong> 作为桥梁，在编译阶段将我们写给人看的<strong>线性代码</strong>，切割并重组为机器喜欢的<strong>CPS 碎片</strong>。</p>
<p>它让代码在<strong>形式上</strong>保持了同步逻辑的连贯性与可读性，却在<strong>执行上</strong>拥有了异步逻辑的非阻塞与高并发。这就是 <code>async/await</code> 最大的魅力——<strong>写的是同步的诗，跑的是异步的魂。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp+vue3+pinia+pinia-plugin-persistedstate主题管理]]></title>    <link>https://juejin.cn/post/7600333405978886185</link>    <guid>https://juejin.cn/post/7600333405978886185</guid>    <pubDate>2026-01-29T03:29:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600333405978886185" data-draft-id="7600326291553730566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp+vue3+pinia+pinia-plugin-persistedstate主题管理"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T03:29:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陌羽"/> <meta itemprop="url" content="https://juejin.cn/user/1508952759340541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp+vue3+pinia+pinia-plugin-persistedstate主题管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1508952759340541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陌羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:29:07.000Z" title="Thu Jan 29 2026 03:29:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<blockquote>
<p>注：当前为我自己项目经验的方案，如果大家有更好的希望可以在评论区告诉我                </p>
</blockquote>
<h5 data-id="heading-0">安装pinia-plugin-persistedstate</h5>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> pinia-plugin-persistedstate
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-1">配置pinia-plugin-persistedstate</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//main.js文件</span>
<span class="hljs-comment">// #ifndef VUE3</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./uni.promisify.adaptor'</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property">config</span>.<span class="hljs-property">productionTip</span> = <span class="hljs-literal">false</span>
<span class="hljs-title class_">App</span>.<span class="hljs-property">mpType</span> = <span class="hljs-string">'app'</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
    ...<span class="hljs-title class_">App</span>
})
app.$mount()
<span class="hljs-comment">// #endif</span>
<span class="hljs-comment">// #ifdef VUE3</span>
<span class="hljs-keyword">import</span> {
    createSSRApp
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> {
    createPinia
} <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> piniaPluginPersistedstate <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createApp</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createSSRApp</span>(<span class="hljs-title class_">App</span>)
    <span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()
    pinia.<span class="hljs-title function_">use</span>(piniaPluginPersistedstate)
    app.<span class="hljs-title function_">use</span>(pinia)
    <span class="hljs-keyword">return</span> {
        app,
        pinia
    }
}
<span class="hljs-comment">// #endif</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-2">配置主题管理pinia全局缓存文件</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// stores/theme.js</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useThemeStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'theme'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 当前主题名称</span>
    <span class="hljs-keyword">const</span> themeName = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'KFC'</span>)
    <span class="hljs-comment">// 添加一个标记，表示主题是否已初始化</span>
    <span class="hljs-keyword">const</span> isThemeInitialized = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

<span class="hljs-comment">// 主题配置映射</span>
<span class="hljs-comment">// --dominant-color：如主背景色、按钮颜色、提示性文字色，金额</span>
<span class="hljs-comment">// --text-color：标题、正文信息颜色</span>
<span class="hljs-comment">// --text-secondary：标题、正文信息颜色</span>
<span class="hljs-comment">// --text-auxiliary：用于辅助、次要级信息颜色</span>
<span class="hljs-comment">// --bg-color：背景色</span>
<span class="hljs-comment">// --border-color：边框颜色</span>
<span class="hljs-comment">// --dividing-line：分割线颜色</span>
<span class="hljs-comment">// --card-bg：卡片背景色</span>
<span class="hljs-comment">// --mask-bg：遮罩背景色</span>
<span class="hljs-comment">// --shadow-color：阴影颜色</span>
<span class="hljs-keyword">const</span> themeConfig = <span class="hljs-title function_">ref</span>({
    <span class="hljs-attr">KFC</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'KFC'</span>,
        <span class="hljs-string">'--primary-color'</span>: <span class="hljs-string">'#007aff'</span>,
        <span class="hljs-string">'--secondary-color'</span>: <span class="hljs-string">'#5856d6'</span>,
        <span class="hljs-string">'--success-color'</span>: <span class="hljs-string">'#4cd964'</span>,
        <span class="hljs-string">'--warning-color'</span>: <span class="hljs-string">'#ff9500'</span>,
        <span class="hljs-string">'--danger-color'</span>: <span class="hljs-string">'#ff3b30'</span>,
        <span class="hljs-string">'--dominant-color'</span>: <span class="hljs-string">'#E40031'</span>,
        <span class="hljs-string">'--bg-color'</span>: <span class="hljs-string">'#E40031'</span>,
        <span class="hljs-string">'--text-color'</span>: <span class="hljs-string">'#222222'</span>,
        <span class="hljs-string">'--text-secondary'</span>: <span class="hljs-string">'#666666'</span>,
        <span class="hljs-string">'--text-auxiliary'</span>: <span class="hljs-string">'#999999'</span>,
        <span class="hljs-string">'--border-color'</span>: <span class="hljs-string">'#e0e0e0'</span>,
        <span class="hljs-string">'--card-bg'</span>: <span class="hljs-string">'#ffffff'</span>,
        <span class="hljs-string">'--mask-bg'</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.4)'</span>,
        <span class="hljs-string">'--shadow-color'</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.1)'</span>
    },
    <span class="hljs-attr">MCD</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'MCD'</span>,
        <span class="hljs-string">'--dominant-color'</span>: <span class="hljs-string">'#E40031'</span>,
        <span class="hljs-string">'--primary-color'</span>: <span class="hljs-string">'#0a84ff'</span>,
        <span class="hljs-string">'--secondary-color'</span>: <span class="hljs-string">'#5e5ce6'</span>,
        <span class="hljs-string">'--success-color'</span>: <span class="hljs-string">'#30d158'</span>,
        <span class="hljs-string">'--warning-color'</span>: <span class="hljs-string">'#ff9f0a'</span>,
        <span class="hljs-string">'--danger-color'</span>: <span class="hljs-string">'#ff453a'</span>,
        <span class="hljs-string">'--bg-color'</span>: <span class="hljs-string">'#000000'</span>,
        <span class="hljs-string">'--text-color'</span>: <span class="hljs-string">'#ffffff'</span>,
        <span class="hljs-string">'--text-secondary'</span>: <span class="hljs-string">'#8e8e93'</span>,
        <span class="hljs-string">'--border-color'</span>: <span class="hljs-string">'#38383a'</span>,
        <span class="hljs-string">'--card-bg'</span>: <span class="hljs-string">'#1c1c1e'</span>,
        <span class="hljs-string">'--mask-bg'</span>: <span class="hljs-string">'rgba(255, 255, 255, 0.1)'</span>,
        <span class="hljs-string">'--shadow-color'</span>: <span class="hljs-string">'rgba(255, 255, 255, 0.1)'</span>
    },
    <span class="hljs-attr">LC</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'LC'</span>,
        <span class="hljs-string">'--dominant-color'</span>: <span class="hljs-string">'#E40031'</span>,
        <span class="hljs-string">'--primary-color'</span>: <span class="hljs-string">'#007aff'</span>,
        <span class="hljs-string">'--secondary-color'</span>: <span class="hljs-string">'#5856d6'</span>,
        <span class="hljs-string">'--success-color'</span>: <span class="hljs-string">'#4cd964'</span>,
        <span class="hljs-string">'--warning-color'</span>: <span class="hljs-string">'#ff9500'</span>,
        <span class="hljs-string">'--danger-color'</span>: <span class="hljs-string">'#ff3b30'</span>,
        <span class="hljs-string">'--bg-color'</span>: <span class="hljs-string">'#E40031'</span>,
        <span class="hljs-string">'--text-color'</span>: <span class="hljs-string">'#333333'</span>,
        <span class="hljs-string">'--text-secondary'</span>: <span class="hljs-string">'#666666'</span>,
        <span class="hljs-string">'--border-color'</span>: <span class="hljs-string">'#e0e0e0'</span>,
        <span class="hljs-string">'--card-bg'</span>: <span class="hljs-string">'#ffffff'</span>,
        <span class="hljs-string">'--mask-bg'</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.4)'</span>,
        <span class="hljs-string">'--shadow-color'</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.1)'</span>
    },
    <span class="hljs-attr">custom</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'custom'</span>,
        <span class="hljs-string">'--primary-color'</span>: <span class="hljs-string">'#ff6600'</span>,
        <span class="hljs-string">'--secondary-color'</span>: <span class="hljs-string">'#ff9966'</span>,
        <span class="hljs-string">'--success-color'</span>: <span class="hljs-string">'#67c23a'</span>,
        <span class="hljs-string">'--warning-color'</span>: <span class="hljs-string">'#e6a23c'</span>,
        <span class="hljs-string">'--danger-color'</span>: <span class="hljs-string">'#f56c6c'</span>,
        <span class="hljs-string">'--bg-color'</span>: <span class="hljs-string">'#f9f9f9'</span>,
        <span class="hljs-string">'--text-color'</span>: <span class="hljs-string">'#333333'</span>,
        <span class="hljs-string">'--text-secondary'</span>: <span class="hljs-string">'#606266'</span>,
        <span class="hljs-string">'--border-color'</span>: <span class="hljs-string">'#dcdfe6'</span>,
        <span class="hljs-string">'--card-bg'</span>: <span class="hljs-string">'#ffffff'</span>,
        <span class="hljs-string">'--mask-bg'</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.4)'</span>,
        <span class="hljs-string">'--shadow-color'</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.1)'</span>
    }
} <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)

<span class="hljs-comment">// 当前主题变量</span>
<span class="hljs-keyword">const</span> currentTheme = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> themeConfig.<span class="hljs-property">value</span>[themeName.<span class="hljs-property">value</span>])

<span class="hljs-comment">// 主题样式字符串（用于行内样式）</span>
<span class="hljs-keyword">const</span> themeStyleString = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> vars = currentTheme.<span class="hljs-property">value</span>
    <span class="hljs-keyword">let</span> style = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> vars) {
        <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'--'</span>)) {
            style += <span class="hljs-string">`<span class="hljs-subst">${key}</span>: <span class="hljs-subst">${vars[key]}</span>; `</span>
        }
    }
    <span class="hljs-keyword">return</span> style
})

<span class="hljs-comment">// 可用主题列表</span>
<span class="hljs-keyword">const</span> availableThemes = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(themeConfig.<span class="hljs-property">value</span>))

<span class="hljs-comment">// 初始化主题</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始初始化主题...'</span>)

    <span class="hljs-comment">// 方法1：直接从本地存储读取（绕过Pinia持久化）</span>
    <span class="hljs-keyword">const</span> saved = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'uni-theme'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'从uni存储读取的主题:'</span>, saved)

    <span class="hljs-comment">// 方法2：从Pinia持久化读取</span>
    <span class="hljs-keyword">const</span> piniaSaved = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'pinia-theme-store'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'从Pinia存储读取的数据:'</span>, piniaSaved)

    <span class="hljs-keyword">if</span> (saved &amp;&amp; themeConfig.<span class="hljs-property">value</span>[saved]) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'使用uni存储的主题:'</span>, saved)
        themeName.<span class="hljs-property">value</span> = saved
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (piniaSaved) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(piniaSaved)
            <span class="hljs-keyword">if</span> (parsed.<span class="hljs-property">themeName</span> &amp;&amp; themeConfig.<span class="hljs-property">value</span>[parsed.<span class="hljs-property">themeName</span>]) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'使用Pinia存储的主题:'</span>, parsed.<span class="hljs-property">themeName</span>)
                themeName.<span class="hljs-property">value</span> = parsed.<span class="hljs-property">themeName</span>
            }
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'解析Pinia存储失败:'</span>, e)
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'使用默认主题: KFC'</span>)
        themeName.<span class="hljs-property">value</span> = <span class="hljs-string">'KFC'</span>
    }

    <span class="hljs-comment">// 应用主题</span>
    <span class="hljs-title function_">applyTheme</span>()
    isThemeInitialized.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>

    <span class="hljs-comment">// 监听系统主题变化</span>
    <span class="hljs-title function_">watchSystemTheme</span>()
}

<span class="hljs-comment">// 应用主题到页面</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">applyTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'应用主题:'</span>, themeName.<span class="hljs-property">value</span>)
    <span class="hljs-keyword">const</span> theme = currentTheme.<span class="hljs-property">value</span>

    <span class="hljs-keyword">if</span> (!theme) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'主题配置不存在:'</span>, themeName.<span class="hljs-property">value</span>)
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 设置CSS变量（H5端）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">document</span> !== <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">const</span> root = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> theme) {
            <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'--'</span>)) {
                root.<span class="hljs-property">style</span>.<span class="hljs-title function_">setProperty</span>(key, theme[key])
            }
        }
        root.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-theme'</span>, theme.<span class="hljs-property">name</span>)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CSS变量已设置'</span>)
    }

    <span class="hljs-comment">// 发送主题变化事件</span>
    uni.$emit(<span class="hljs-string">'theme:change'</span>, theme)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主题变化事件已发送:'</span>, theme.<span class="hljs-property">name</span>)

    <span class="hljs-comment">// 保存到存储</span>
    uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'uni-theme'</span>, themeName.<span class="hljs-property">value</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主题已保存到存储:'</span>, themeName.<span class="hljs-property">value</span>)
}

<span class="hljs-comment">// 监听系统主题</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">watchSystemTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// H5端监听系统主题</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">matchMedia</span>) {
        <span class="hljs-keyword">const</span> darkModeMedia = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">'(prefers-color-scheme: MCD)'</span>)

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleThemeChange</span> = (<span class="hljs-params">e : <span class="hljs-built_in">any</span></span>) =&gt; {
            <span class="hljs-keyword">if</span> (uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'uni-theme-follow-system'</span>) === <span class="hljs-literal">true</span>) {
                <span class="hljs-title function_">setTheme</span>(e.<span class="hljs-property">matches</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'KFC'</span>)
            }
        }

        darkModeMedia.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, handleThemeChange)
    }

    <span class="hljs-comment">// App端监听系统主题</span>
    <span class="hljs-keyword">if</span> (uni.<span class="hljs-property">getSystemSetting</span>) {
        <span class="hljs-keyword">const</span> systemSetting = uni.<span class="hljs-title function_">getSystemSetting</span>()
        <span class="hljs-keyword">if</span> (systemSetting) {
            <span class="hljs-comment">// App端逻辑</span>
        }
    }
}

<span class="hljs-comment">// 设置主题</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setTheme</span> = (<span class="hljs-params">name : <span class="hljs-built_in">any</span></span>) =&gt; {
    <span class="hljs-keyword">if</span> (!themeConfig.<span class="hljs-property">value</span>[name]) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`主题 "<span class="hljs-subst">${name}</span>" 不存在`</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }

    themeName.<span class="hljs-property">value</span> = name
    <span class="hljs-title function_">applyTheme</span>()
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-comment">// 切换主题</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> themes = availableThemes.<span class="hljs-property">value</span>
    <span class="hljs-keyword">const</span> currentIndex = themes.<span class="hljs-title function_">indexOf</span>(themeName.<span class="hljs-property">value</span>)
    <span class="hljs-keyword">const</span> nextIndex = (currentIndex + <span class="hljs-number">1</span>) % themes.<span class="hljs-property">length</span>
    <span class="hljs-title function_">setTheme</span>(themes[nextIndex])
}

<span class="hljs-comment">// 自定义主题变量</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateCustomTheme</span> = (<span class="hljs-params">key : <span class="hljs-built_in">any</span>, value : <span class="hljs-built_in">any</span></span>) =&gt; {
    <span class="hljs-keyword">if</span> (!key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'--'</span>)) {
        key = <span class="hljs-string">`--<span class="hljs-subst">${key}</span>`</span>
    }

    themeConfig.<span class="hljs-property">value</span>.<span class="hljs-property">custom</span>[key] = value

    <span class="hljs-keyword">if</span> (themeName.<span class="hljs-property">value</span> === <span class="hljs-string">'custom'</span>) {
        <span class="hljs-title function_">applyTheme</span>()
    }
}

<span class="hljs-comment">// 创建新主题</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createTheme</span> = (<span class="hljs-params">name : <span class="hljs-built_in">any</span>, config : <span class="hljs-built_in">any</span></span>) =&gt; {
    <span class="hljs-keyword">if</span> (themeConfig.<span class="hljs-property">value</span>[name]) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`主题 "<span class="hljs-subst">${name}</span>" 已存在`</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }

    themeConfig.<span class="hljs-property">value</span>[name] = {
        name,
        ...themeConfig.<span class="hljs-property">value</span>.<span class="hljs-property">KFC</span>, <span class="hljs-comment">// 基于亮色主题</span>
        ...config
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-comment">// 跟随系统主题</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">followSystemTheme</span> = (<span class="hljs-params">enable = <span class="hljs-literal">true</span></span>) =&gt; {
    uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'uni-theme-follow-system'</span>, enable)

    <span class="hljs-keyword">if</span> (enable) {
        <span class="hljs-keyword">const</span> isDark = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(<span class="hljs-string">'(prefers-color-scheme: MCD)'</span>).<span class="hljs-property">matches</span>
        <span class="hljs-title function_">setTheme</span>(isDark ? <span class="hljs-string">'MCD'</span> : <span class="hljs-string">'KFC'</span>)
    }
}

<span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// State</span>
    themeName,
    themeConfig,
    isThemeInitialized, <span class="hljs-comment">// 导出初始化标记</span>

    <span class="hljs-comment">// Getters</span>
    currentTheme,
    themeStyleString,
    availableThemes,

    <span class="hljs-comment">// Actions</span>
    initTheme,
    setTheme,
    toggleTheme,
    updateCustomTheme,
    createTheme,
    followSystemTheme
}
}, {
    <span class="hljs-attr">persist</span>: {
        <span class="hljs-attr">key</span>: <span class="hljs-string">'pinia-theme-store'</span>,
        <span class="hljs-attr">storage</span>: {
            <span class="hljs-attr">getItem</span>: <span class="hljs-function">(<span class="hljs-params">key:<span class="hljs-built_in">any</span></span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> result = uni.<span class="hljs-title function_">getStorageSync</span>(key)
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Pinia持久化读取:'</span>, key, result)
                <span class="hljs-keyword">return</span> result
            },
            <span class="hljs-attr">setItem</span>: <span class="hljs-function">(<span class="hljs-params">key:<span class="hljs-built_in">any</span>, value:<span class="hljs-built_in">any</span></span>) =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Pinia持久化保存:'</span>, key, value)
                uni.<span class="hljs-title function_">setStorageSync</span>(key, value)
            },
            <span class="hljs-attr">removeItem</span>: <span class="hljs-function">(<span class="hljs-params">key:<span class="hljs-built_in">any</span></span>) =&gt;</span> {
                uni.<span class="hljs-title function_">removeStorageSync</span>(key)
            }
        },
        <span class="hljs-attr">paths</span>: [<span class="hljs-string">'themeName'</span>, <span class="hljs-string">'themeConfig.custom'</span>]
    }
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-3">引用示例</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- :style="themeStore.themeConfig[themeStore.themeName]"这个是在这个页面引用当前使用的主题样式 --&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"themeStore.themeConfig[themeStore.themeName]"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 当前为行内样式使用方法 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color: var(--dominant-color);"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
	<span class="hljs-keyword">import</span> {
		onShow, onLoad
	} <span class="hljs-keyword">from</span> <span class="hljs-string">'@dcloudio/uni-app'</span>;
	<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
	<span class="hljs-keyword">import</span> {
		useThemeStore
	} <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/theme'</span>;

	<span class="hljs-keyword">const</span> usersStore = <span class="hljs-title function_">useUsersStore</span>();
	<span class="hljs-keyword">const</span> themeStore = <span class="hljs-title function_">useThemeStore</span>()

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--dominant-color); //<span class="hljs-attr">--dominant-color</span>为你在主题管理定义的key
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<blockquote>
<p>注：我本来想的是全局引用，但是不知道为什么一直引用失败，所以只能每个页面单独引入使用，如果各位有更好的方法可以用自己的方法。</p>
</blockquote>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 从入门到精通（二）：核心基石 - 深入理解 Modifier 与布局系统]]></title>    <link>https://juejin.cn/post/7600342663319388201</link>    <guid>https://juejin.cn/post/7600342663319388201</guid>    <pubDate>2026-01-29T03:31:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600342663319388201" data-draft-id="7600430748780445739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 从入门到精通（二）：核心基石 - 深入理解 Modifier 与布局系统"/> <meta itemprop="keywords" content="Android,Kotlin,JetBrains"/> <meta itemprop="datePublished" content="2026-01-29T03:31:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邹阿涛涛涛涛涛涛涛涛"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009106839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 从入门到精通（二）：核心基石 - 深入理解 Modifier 与布局系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009106839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邹阿涛涛涛涛涛涛涛涛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:31:20.000Z" title="Thu Jan 29 2026 03:31:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本篇文章将从源码层面深入解析 Compose 的核心机制，帮助你真正理解 Modifier 的设计哲学、布局系统的测量流程，以及 LazyColumn 的惰性加载原理。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言</h2>
<p>在上一篇中，我们完成了 Compose 的入门。但如果你只停留在"会用"的层面，遇到复杂场景时就会束手无策。比如：</p>
<ul>
<li>为什么 Modifier 的调用顺序会影响最终效果？</li>
<li>LazyColumn 为什么能流畅处理上万条数据？</li>
<li>自定义 Layout 时，Constraints 到底该怎么用？</li>
<li>什么时候应该用 ConstraintLayout，什么时候用嵌套 Column/Row？</li>
</ul>
<p>本篇文章将带你<strong>深入原理层</strong>，不仅告诉你"怎么做"，更要让你理解"为什么这样做"。准备好了吗？让我们开始深度探索！</p>
<hr/>
<h2 data-id="heading-1">一、Modifier 深度解析：从设计哲学到源码实现</h2>
<h3 data-id="heading-2">1.1 为什么需要 Modifier？</h3>
<p>在传统 View 系统中，每个 View 都有一大堆属性方法：<code>setPadding()</code>、<code>setBackground()</code>、<code>setOnClickListener()</code>... 这不仅让 View 类变得臃肿，也限制了扩展性。</p>
<p>Compose 采用了完全不同的设计：<strong>将修饰能力从组件中分离出来</strong>，形成独立的 Modifier 系统。</p>
<p><strong>设计哲学</strong>：</p>
<ul>
<li><strong>单一职责</strong>：Text 只负责显示文字，修饰交给 Modifier</li>
<li><strong>可组合</strong>：通过链式调用组合各种修饰效果</li>
<li><strong>可扩展</strong>：随时可以增加新的 Modifier，无需修改组件</li>
</ul>
<h3 data-id="heading-3">1.2 Modifier 的本质：接口与链表</h3>
<p>Modifier 是一个<strong>接口</strong>，它的核心设计非常精巧：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 简化版源码</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Modifier</span> {
    <span class="hljs-comment">// 从左到右遍历所有 Element</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldIn</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">R</span>, <span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R
    
    <span class="hljs-comment">// 从右到左遍历所有 Element</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldOut</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">Element</span>, <span class="hljs-type">R</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R
    
    <span class="hljs-comment">// 检查是否有满足条件的 Element</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">any</span><span class="hljs-params">(predicate: (<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    
    <span class="hljs-comment">// 检查是否所有 Element 都满足条件</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">all</span><span class="hljs-params">(predicate: (<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    
    <span class="hljs-comment">// 组合两个 Modifier</span>
    <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">then</span><span class="hljs-params">(other: <span class="hljs-type">Modifier</span>)</span></span>: Modifier
    
    <span class="hljs-comment">// 空的 Modifier 实例</span>
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> : Modifier {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldIn</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">R</span>, <span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R = initial
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldOut</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">Element</span>, <span class="hljs-type">R</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R = initial
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">then</span><span class="hljs-params">(other: <span class="hljs-type">Modifier</span>)</span></span>: Modifier = other
    }
}
</code></pre>
<p><strong>关键设计</strong>：Modifier 内部使用<strong>链表结构</strong>存储所有的修饰元素。</p>
<h3 data-id="heading-4">1.3 链式调用的秘密</h3>
<p>当我们写下这样的代码时，发生了什么？</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Modifier
    .padding(<span class="hljs-number">16.</span>dp)
    .background(Color.Blue)
    .size(<span class="hljs-number">100.</span>dp)
</code></pre>
<p><strong>执行过程</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">步骤</span> <span class="hljs-attr">1:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">(空)</span> 
        <span class="hljs-string">↓</span> <span class="hljs-string">then()</span>
<span class="hljs-string">步骤</span> <span class="hljs-attr">2:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">+</span> <span class="hljs-string">PaddingModifier</span>
        <span class="hljs-string">↓</span> <span class="hljs-string">then()</span>
<span class="hljs-string">步骤</span> <span class="hljs-attr">3:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">+</span> <span class="hljs-string">PaddingModifier</span> <span class="hljs-string">+</span> <span class="hljs-string">BackgroundModifier</span>
        <span class="hljs-string">↓</span> <span class="hljs-string">then()</span>
<span class="hljs-string">步骤</span> <span class="hljs-attr">4:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">+</span> <span class="hljs-string">PaddingModifier</span> <span class="hljs-string">+</span> <span class="hljs-string">BackgroundModifier</span> <span class="hljs-string">+</span> <span class="hljs-string">SizeModifier</span>
</code></pre>
<p><strong>源码实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Modifier.kt</span>
<span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">then</span><span class="hljs-params">(other: <span class="hljs-type">Modifier</span>)</span></span>: Modifier = 
    <span class="hljs-keyword">if</span> (other === Modifier) <span class="hljs-keyword">this</span> <span class="hljs-keyword">else</span> CombinedModifier(<span class="hljs-keyword">this</span>, other)

<span class="hljs-comment">// CombinedModifier 将两个 Modifier 组合在一起</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CombinedModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> outer: Modifier,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> <span class="hljs-keyword">inner</span>: Modifier
) : Modifier {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldIn</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">R</span>, <span class="hljs-type">Modifier</span>.<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R =
        <span class="hljs-keyword">inner</span>.foldIn(outer.foldIn(initial, operation), operation)
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldOut</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">Modifier</span>.<span class="hljs-type">Element</span>, <span class="hljs-type">R</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R =
        outer.foldOut(<span class="hljs-keyword">inner</span>.foldOut(initial, operation), operation)
}
</code></pre>
<p><strong>核心洞察</strong>：<code>CombinedModifier</code> 是一个<strong>二叉树结构</strong>，<code>outer</code> 指向链表头部，<code>inner</code> 指向链表尾部。</p>
<h3 data-id="heading-5">1.4 执行顺序：为什么顺序很重要？</h3>
<p>这是 Modifier 最容易让人困惑的地方。让我们通过一个例子理解：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 情况 A</span>
Modifier
    .padding(<span class="hljs-number">16.</span>dp)        <span class="hljs-comment">// 外层</span>
    .background(Color.Blue) <span class="hljs-comment">// 中间</span>
    .padding(<span class="hljs-number">8.</span>dp)         <span class="hljs-comment">// 内层</span>
    .size(<span class="hljs-number">100.</span>dp)
</code></pre>
<p><strong>视觉效果</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────┐  ← 外层 <span class="hljs-attribute">padding</span> (<span class="hljs-number">16</span>dp) - 透明区域
│                             │
│  ┌───────────────────────┐  │
│  │  蓝色背景             │  │
│  │  ┌─────────────────┐  │  │
│  │  │                 │  │  │  ← 内层 <span class="hljs-attribute">padding</span> (<span class="hljs-number">8</span>dp) - 蓝色区域内
│  │  │    <span class="hljs-number">100</span>x100      │  │  │
│  │  │     内容        │  │  │
│  │  │                 │  │  │
│  │  └─────────────────┘  │  │
│  │                       │  │
│  └───────────────────────┘  │
│                             │
└─────────────────────────────┘
</code></pre>
<p><strong>设计原则</strong>：Modifier 的执行遵循**"从外到内"**的顺序。先应用的 Modifier 在外层，后应用的在内层。</p>
<h3 data-id="heading-6">1.5 Modifier 的遍历机制</h3>
<p>Compose 需要遍历 Modifier 链表来应用各种效果。遍历有两种方式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// foldIn: 从左到右（outer → inner）</span>
modifier.foldIn(initialValue) { acc, element -&gt;
    <span class="hljs-comment">// 处理每个 Element</span>
    acc + element
}

<span class="hljs-comment">// foldOut: 从右到左（inner → outer）</span>
modifier.foldOut(initialValue) { element, acc -&gt;
    <span class="hljs-comment">// 处理每个 Element</span>
    element + acc
}
</code></pre>
<p><strong>应用场景</strong>：</p>
<ul>
<li><strong>foldIn</strong>：测量、布局时，需要从外到内传递约束</li>
<li><strong>foldOut</strong>：绘制时，需要从内到外绘制内容</li>
</ul>
<h3 data-id="heading-7">1.6 Modifier 的分类与内部实现</h3>
<h4 data-id="heading-8">1.6.1 布局类 Modifier</h4>
<p><strong>size() 的实现原理</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// SizeModifier 简化版</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SizeModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> minWidth: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> minHeight: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> maxWidth: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> maxHeight: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> enforceIncoming: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span>
) : LayoutModifier {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> MeasureScope.<span class="hljs-title">measure</span><span class="hljs-params">(
        measurable: <span class="hljs-type">Measurable</span>,
        constraints: <span class="hljs-type">Constraints</span>
    )</span></span>: MeasureResult {
        <span class="hljs-comment">// 解析尺寸值</span>
        <span class="hljs-keyword">val</span> resolvedMinWidth = <span class="hljs-keyword">if</span> (minWidth != Dp.Unspecified) {
            minWidth.roundToPx()
        } <span class="hljs-keyword">else</span> {
            constraints.minWidth
        }
        
        <span class="hljs-keyword">val</span> resolvedMaxWidth = <span class="hljs-keyword">if</span> (maxWidth != Dp.Unspecified) {
            maxWidth.roundToPx()
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (enforceIncoming) constraints.maxWidth <span class="hljs-keyword">else</span> Constraints.Infinity
        }
        
        <span class="hljs-comment">// ... 高度同理</span>
        
        <span class="hljs-comment">// 创建新的约束</span>
        <span class="hljs-keyword">val</span> wrappedConstraints = Constraints(
            minWidth = resolvedMinWidth,
            maxWidth = resolvedMaxWidth,
            minHeight = resolvedMinHeight,
            maxHeight = resolvedMaxHeight
        )
        
        <span class="hljs-comment">// 测量子元素</span>
        <span class="hljs-keyword">val</span> placeable = measurable.measure(wrappedConstraints)
        
        <span class="hljs-comment">// 返回测量结果</span>
        <span class="hljs-keyword">return</span> layout(placeable.width, placeable.height) {
            placeable.placeRelative(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        }
    }
}
</code></pre>
<p><strong>关键洞察</strong>：SizeModifier 是一个 <code>LayoutModifier</code>，它拦截了测量过程，修改了传递给子元素的 Constraints。</p>
<h4 data-id="heading-9">1.6.2 绘制类 Modifier</h4>
<p><strong>background() 的实现原理</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// BackgroundModifier 简化版</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BackgroundModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> color: Color? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> brush: Brush? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> shape: Shape = RectangleShape,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> alpha: <span class="hljs-built_in">Float</span> = <span class="hljs-number">1.0f</span>
) : DrawModifier {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> ContentDrawScope.<span class="hljs-title">draw</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 绘制背景</span>
        <span class="hljs-keyword">if</span> (shape == RectangleShape) {
            <span class="hljs-comment">// 矩形背景</span>
            <span class="hljs-keyword">if</span> (color != <span class="hljs-literal">null</span>) {
                drawRect(color = color, alpha = alpha)
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (brush != <span class="hljs-literal">null</span>) {
                drawRect(brush = brush, alpha = alpha)
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 圆角/自定义形状背景</span>
            <span class="hljs-keyword">val</span> outline = shape.createOutline(size, layoutDirection, <span class="hljs-keyword">this</span>)
            <span class="hljs-keyword">if</span> (color != <span class="hljs-literal">null</span>) {
                drawOutline(outline, color = color, alpha = alpha)
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (brush != <span class="hljs-literal">null</span>) {
                drawOutline(outline, brush = brush, alpha = alpha)
            }
        }
        
        <span class="hljs-comment">// 绘制内容（调用 drawContent 继续链式绘制）</span>
        drawContent()
    }
}
</code></pre>
<p><strong>关键洞察</strong>：<code>DrawModifier</code> 拦截了绘制流程，先绘制背景，再通过 <code>drawContent()</code> 继续绘制后续内容和子元素。</p>
<h4 data-id="heading-10">1.6.3 交互类 Modifier</h4>
<p><strong>clickable() 的实现原理</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// clickable 的 Modifier 链</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Modifier.<span class="hljs-title">clickable</span><span class="hljs-params">(
    enabled: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>,
    onClickLabel: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>,
    role: <span class="hljs-type">Role</span>? = <span class="hljs-literal">null</span>,
    onClick: () -&gt; <span class="hljs-type">Unit</span>
)</span></span>: Modifier = composed(
    inspectorInfo = debugInspectorInfo { ... }
) {
    <span class="hljs-keyword">val</span> interactionSource = remember { MutableInteractionSource() }
    <span class="hljs-keyword">val</span> indication = LocalIndication.current
    
    Modifier
        .clickable(
            interactionSource = interactionSource,
            indication = indication,
            enabled = enabled,
            onClickLabel = onClickLabel,
            role = role,
            onClick = onClick
        )
}
</code></pre>
<p><strong>clickable 内部 Modifier 链</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">clickable
├── focusableInNonTouchMode  (焦点管理)
├── pointerInput             (手势检测)
├── semantics                (无障碍支持)
├── indication               (涟漪效果)
└── isComposeRootInScrollableContainer (滚动容器检测)
</code></pre>
<h3 data-id="heading-11">1.7 自定义 Modifier 的完整指南</h3>
<h4 data-id="heading-12">1.7.1 简单自定义：使用 composed</h4>
<p>适用于需要访问 CompositionLocal 或 remember 状态的场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义带阴影的圆角背景</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Modifier.<span class="hljs-title">shadowBackground</span><span class="hljs-params">(
    color: <span class="hljs-type">Color</span>,
    cornerRadius: <span class="hljs-type">Dp</span> = <span class="hljs-number">8.</span>dp,
    shadowElevation: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp
)</span></span>: Modifier = composed {
    <span class="hljs-comment">// 可以在这里使用 remember 和 CompositionLocal</span>
    <span class="hljs-keyword">val</span> density = LocalDensity.current
    <span class="hljs-keyword">val</span> shadowPx = with(density) { shadowElevation.toPx() }
    
    remember(color, cornerRadius, shadowElevation) {
        Modifier
            .shadow(shadowElevation, RoundedCornerShape(cornerRadius))
            .background(color, RoundedCornerShape(cornerRadius))
            .padding(cornerRadius)
    }
}
</code></pre>
<h4 data-id="heading-13">1.7.2 中级自定义：实现 Modifier.NodeElement</h4>
<p>适用于需要自定义测量、布局或绘制的场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义绘制对角线的 Modifier</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DiagonalLineElement</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> color: Color,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> strokeWidth: <span class="hljs-built_in">Float</span>
) : ModifierNodeElement&lt;DiagonalLineNode&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span>: DiagonalLineNode = 
        DiagonalLineNode(color, strokeWidth)
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(node: <span class="hljs-type">DiagonalLineNode</span>)</span></span> {
        node.color = color
        node.strokeWidth = strokeWidth
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> =
        color.hashCode() * <span class="hljs-number">31</span> + strokeWidth.hashCode()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">equals</span><span class="hljs-params">(other: <span class="hljs-type">Any</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> =
        other <span class="hljs-keyword">is</span> DiagonalLineElement &amp;&amp;
        other.color == color &amp;&amp;
        other.strokeWidth == strokeWidth
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DiagonalLineNode</span>(
    <span class="hljs-keyword">var</span> color: Color,
    <span class="hljs-keyword">var</span> strokeWidth: <span class="hljs-built_in">Float</span>
) : Modifier.Node(), DrawModifierNode {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> ContentDrawScope.<span class="hljs-title">draw</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 先绘制内容</span>
        drawContent()
        
        <span class="hljs-comment">// 再绘制对角线</span>
        drawLine(
            color = color,
            start = Offset(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>),
            end = Offset(size.width, size.height),
            strokeWidth = strokeWidth
        )
    }
}

<span class="hljs-comment">// 使用扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Modifier.<span class="hljs-title">diagonalLine</span><span class="hljs-params">(
    color: <span class="hljs-type">Color</span>,
    strokeWidth: <span class="hljs-type">Float</span> = <span class="hljs-number">2</span>f
)</span></span>: Modifier = <span class="hljs-keyword">this</span>.then(DiagonalLineElement(color, strokeWidth))
</code></pre>
<h4 data-id="heading-14">1.7.3 高级自定义：LayoutModifier</h4>
<p>适用于需要自定义测量和布局逻辑的场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义 AspectRatio Modifier（保持宽高比）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectRatioElement</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> ratio: <span class="hljs-built_in">Float</span>
) : ModifierNodeElement&lt;AspectRatioNode&gt;() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span> = AspectRatioNode(ratio)
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(node: <span class="hljs-type">AspectRatioNode</span>)</span></span> {
        node.ratio = ratio
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectRatioNode</span>(<span class="hljs-keyword">var</span> ratio: <span class="hljs-built_in">Float</span>) : 
    Modifier.Node(), 
    LayoutModifierNode {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> MeasureScope.<span class="hljs-title">measure</span><span class="hljs-params">(
        measurable: <span class="hljs-type">Measurable</span>,
        constraints: <span class="hljs-type">Constraints</span>
    )</span></span>: MeasureResult {
        <span class="hljs-comment">// 根据约束计算合适的尺寸</span>
        <span class="hljs-keyword">val</span> width = constraints.maxWidth
        <span class="hljs-keyword">val</span> height = (width / ratio).toInt()
        
        <span class="hljs-comment">// 确保不超过最大高度</span>
        <span class="hljs-keyword">val</span> finalHeight = <span class="hljs-keyword">if</span> (height &gt; constraints.maxHeight) {
            constraints.maxHeight
        } <span class="hljs-keyword">else</span> {
            height
        }
        
        <span class="hljs-comment">// 重新计算宽度以保持比例</span>
        <span class="hljs-keyword">val</span> finalWidth = (finalHeight * ratio).toInt()
        
        <span class="hljs-comment">// 测量子元素</span>
        <span class="hljs-keyword">val</span> placeable = measurable.measure(
            Constraints.fixed(finalWidth, finalHeight)
        )
        
        <span class="hljs-keyword">return</span> layout(finalWidth, finalHeight) {
            placeable.placeRelative(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-15">1.8 Intrinsic 测量：解决"先有鸡还是先有蛋"</h3>
<h4 data-id="heading-16">1.8.1 问题场景</h4>
<p>考虑这样一个需求：两个 Text 垂直排列，要求 Divider 的宽度等于两个 Text 中最宽的那个。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Column {
    Text(<span class="hljs-string">"Short"</span>)
    Text(<span class="hljs-string">"Longer text"</span>)
    Divider() <span class="hljs-comment">// 宽度应该等于 "Longer text" 的宽度</span>
}
</code></pre>
<p><strong>问题</strong>：在测量 Divider 时，Column 还不知道两个 Text 的宽度，因为 Text 还没被测量。</p>
<h4 data-id="heading-17">1.8.2 Intrinsic 测量的原理</h4>
<p>Intrinsic 测量允许父组件在正式测量前，<strong>预先询问子元素的期望尺寸</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IntrinsicMeasurable</span> {
    <span class="hljs-comment">// 给定高度，返回最小/最大宽度</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">minIntrinsicWidth</span><span class="hljs-params">(height: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxIntrinsicWidth</span><span class="hljs-params">(height: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
    
    <span class="hljs-comment">// 给定宽度，返回最小/最大高度  </span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">minIntrinsicHeight</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxIntrinsicHeight</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
}
</code></pre>
<p><strong>使用 Intrinsic 测量解决 Divider 问题</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">IntrinsicWidthDemo</span><span class="hljs-params">()</span></span> {
    Column(
        modifier = Modifier.width(IntrinsicSize.Max)  <span class="hljs-comment">// 使用最大固有宽度</span>
    ) {
        Text(<span class="hljs-string">"Short text"</span>)
        Text(<span class="hljs-string">"This is a longer text"</span>)
        Divider(
            modifier = Modifier.fillMaxWidth(),
            color = Color.Black
        )
    }
}
</code></pre>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> Column 收到 IntrinsicSize.Max 约束
<span class="hljs-bullet">2.</span> Column 询问所有子元素的 maxIntrinsicWidth
<span class="hljs-bullet">3.</span> Text 返回自己的文本宽度
<span class="hljs-bullet">4.</span> Column 取最大值作为自身宽度
<span class="hljs-bullet">5.</span> Column 正式测量，将宽度约束传递给子元素
<span class="hljs-bullet">6.</span> Divider 收到与最宽 Text 相同的宽度
</code></pre>
<h4 data-id="heading-18">1.8.3 IntrinsicSize.Min 与 IntrinsicSize.Max</h4>




















<table><thead><tr><th>类型</th><th>说明</th><th>应用场景</th></tr></thead><tbody><tr><td><code>IntrinsicSize.Min</code></td><td>使用子元素的最小固有尺寸</td><td>按钮等需要紧凑尺寸的场景</td></tr><tr><td><code>IntrinsicSize.Max</code></td><td>使用子元素的最大固有尺寸</td><td>表单等需要对齐的场景</td></tr></tbody></table>
<h3 data-id="heading-19">1.9 Modifier 性能优化</h3>
<h4 data-id="heading-20">1.9.1 避免不必要的重组</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：每次重组都创建新的 Modifier</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BadExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Text(
        text = <span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>,
        modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)  <span class="hljs-comment">// 每次重组都创建新实例</span>
    )
}

<span class="hljs-comment">// ✅ 正确：使用 remember 缓存 Modifier</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GoodExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    <span class="hljs-keyword">val</span> modifier = remember { Modifier.padding(<span class="hljs-number">16.</span>dp) }
    
    Text(
        text = <span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>,
        modifier = modifier  <span class="hljs-comment">// 复用同一个实例</span>
    )
}

<span class="hljs-comment">// ✅ 更好：将 Modifier 作为参数，由父组件提供</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BestExample</span><span class="hljs-params">(
    text: <span class="hljs-type">String</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier  <span class="hljs-comment">// 由调用方提供</span>
)</span></span> {
    Text(
        text = text,
        modifier = modifier
    )
}
</code></pre>
<h4 data-id="heading-21">1.9.2 Modifier 的相等性优化</h4>
<p>Compose 使用 <code>equals()</code> 判断 Modifier 是否变化，从而决定是否跳过重组：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义 Modifier 时，务必实现 equals 和 hashCode</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> color: Color,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> size: Dp
) : Modifier.Element {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">equals</span><span class="hljs-params">(other: <span class="hljs-type">Any</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> === other) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> (other !<span class="hljs-keyword">is</span> MyModifier) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">return</span> color == other.color &amp;&amp; size == other.size
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> color.hashCode() * <span class="hljs-number">31</span> + size.hashCode()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-22">二、布局系统深度解析：从测量到绘制</h2>
<h3 data-id="heading-23">2.1 Compose 布局的三阶段</h3>
<p>Compose 的渲染流程分为三个阶段：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────┐
│                      Composition                            │
│  执行 Composable 函数，构建 UI 树（LayoutNode 树）            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        Layout                               │
│  测量每个节点的尺寸（Measure），确定位置（Place）              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        Drawing                              │
│  将 UI 绘制到 <span class="hljs-selector-tag">Canvas</span> 上                                      │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-24">2.2 Layout 节点的数据结构</h3>
<p>每个 Composable 在布局阶段都会对应一个 <code>LayoutNode</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 简化版 LayoutNode 结构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LayoutNode</span> {
    <span class="hljs-comment">// 父节点</span>
    <span class="hljs-keyword">var</span> parent: LayoutNode? = <span class="hljs-literal">null</span>
    
    <span class="hljs-comment">// 子节点列表</span>
    <span class="hljs-keyword">val</span> children: MutableList&lt;LayoutNode&gt; = mutableListOf()
    
    <span class="hljs-comment">// Modifier 链表</span>
    <span class="hljs-keyword">var</span> modifier: Modifier = Modifier
    
    <span class="hljs-comment">// 测量结果</span>
    <span class="hljs-keyword">var</span> width: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> height: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 位置</span>
    <span class="hljs-keyword">var</span> x: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> y: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 测量函数（由 Layout Composable 提供）</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> measurePolicy: MeasurePolicy
}
</code></pre>
<h3 data-id="heading-25">2.3 Constraints：布局的约束条件</h3>
<p>Constraints 是 Compose 布局系统的核心，它定义了尺寸的限制范围：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Constraints</span> {
    <span class="hljs-keyword">val</span> minWidth: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">val</span> maxWidth: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">val</span> minHeight: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">val</span> maxHeight: <span class="hljs-built_in">Int</span>
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 创建固定尺寸约束</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fixed</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span>: Constraints
        
        <span class="hljs-comment">// 创建最大尺寸约束</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxWidth</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>)</span></span>: Constraints
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxHeight</span><span class="hljs-params">(height: <span class="hljs-type">Int</span>)</span></span>: Constraints
        
        <span class="hljs-comment">// 无限约束</span>
        <span class="hljs-keyword">val</span> Infinity = <span class="hljs-built_in">Int</span>.MAX_VALUE
    }
}
</code></pre>
<p><strong>约束类型</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────┐
│                    约束类型图解                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  精确约束                    范围约束                       │
│  ┌─────────┐               ┌───────────────────────────┐   │
│  │         │               │  minWidth          maxWidth│   │
│  │ 100x100 │               │  ├─────────────────────┤   │   │
│  │         │               │       可以是任意值          │   │
│  └─────────┘               └───────────────────────────┘   │
│  <span class="hljs-attr">minWidth</span> = maxWidth = <span class="hljs-number">100</span>                                  │
│                                                             │
│  无约束                                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    Infinity                          │   │
│  │  可以是任意大的尺寸                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│  <span class="hljs-attr">maxWidth</span> = Int.MAX_VALUE                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-26">2.4 测量流程详解</h3>
<p>测量是一个<strong>自顶向下</strong>的过程：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 父节点测量子节点的流程</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">measureChild</span><span class="hljs-params">(child: <span class="hljs-type">Measurable</span>, constraints: <span class="hljs-type">Constraints</span>)</span></span>: Placeable {
    <span class="hljs-comment">// 1. 根据父节点的约束，计算给子节点的约束</span>
    <span class="hljs-keyword">val</span> childConstraints = calculateChildConstraints(constraints)
    
    <span class="hljs-comment">// 2. 让子节点测量自己</span>
    <span class="hljs-keyword">val</span> placeable = child.measure(childConstraints)
    
    <span class="hljs-comment">// 3. 返回测量结果（Placeable）</span>
    <span class="hljs-keyword">return</span> placeable
}
</code></pre>
<p><strong>完整测量流程示例</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MeasureDemo</span><span class="hljs-params">()</span></span> {
    Layout(
        content = {
            Text(<span class="hljs-string">"Child 1"</span>)
            Text(<span class="hljs-string">"Child 2"</span>)
        }
    ) { measurables, constraints -&gt;
        <span class="hljs-comment">// constraints: 父节点给当前节点的约束</span>
        println(<span class="hljs-string">"父约束: minW=<span class="hljs-subst">${constraints.minWidth}</span>, maxW=<span class="hljs-subst">${constraints.maxWidth}</span>"</span>)
        
        <span class="hljs-comment">// 测量子节点</span>
        <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
            <span class="hljs-comment">// 可以给子节点不同的约束</span>
            <span class="hljs-keyword">val</span> childConstraints = Constraints(
                minWidth = <span class="hljs-number">0</span>,
                maxWidth = constraints.maxWidth / <span class="hljs-number">2</span>,  <span class="hljs-comment">// 每个子节点最多一半宽度</span>
                minHeight = <span class="hljs-number">0</span>,
                maxHeight = constraints.maxHeight
            )
            measurable.measure(childConstraints)
        }
        
        <span class="hljs-comment">// 计算自己的尺寸</span>
        <span class="hljs-keyword">val</span> width = placeables.sumOf { it.width }
        <span class="hljs-keyword">val</span> height = placeables.maxOf { it.height }
        
        <span class="hljs-comment">// 布局</span>
        layout(width, height) {
            <span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>
            placeables.forEach { placeable -&gt;
                placeable.placeRelative(x, <span class="hljs-number">0</span>)
                x += placeable.width
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-27">2.5 Column 的测量与布局原理</h3>
<p>让我们深入分析 Column 的实现：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Column 的简化实现</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Column</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    verticalArrangement: <span class="hljs-type">Arrangement</span>.<span class="hljs-type">Vertical</span> = Arrangement.Top,
    horizontalAlignment: <span class="hljs-type">Alignment</span>.<span class="hljs-type">Horizontal</span> = Alignment.Start,
    content: @<span class="hljs-type">Composable</span> <span class="hljs-type">ColumnScope</span>.() -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-keyword">val</span> measurePolicy = columnMeasurePolicy(
        verticalArrangement = verticalArrangement,
        horizontalAlignment = horizontalAlignment
    )
    
    Layout(
        content = { ColumnScopeInstance.content() },
        measurePolicy = measurePolicy,
        modifier = modifier
    )
}

<span class="hljs-comment">// Column 的测量策略</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">columnMeasurePolicy</span><span class="hljs-params">(
    verticalArrangement: <span class="hljs-type">Arrangement</span>.<span class="hljs-type">Vertical</span>,
    horizontalAlignment: <span class="hljs-type">Alignment</span>.<span class="hljs-type">Horizontal</span>
)</span></span>: MeasurePolicy = MeasurePolicy { measurables, constraints -&gt;
    <span class="hljs-comment">// 1. 测量所有子元素</span>
    <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
        measurable.measure(constraints)
    }
    
    <span class="hljs-comment">// 2. 计算 Column 的尺寸</span>
    <span class="hljs-keyword">val</span> width = placeables.maxOf { it.width }
        .coerceIn(constraints.minWidth, constraints.maxWidth)
    
    <span class="hljs-keyword">val</span> height = placeables.sumOf { it.height }
        .coerceIn(constraints.minHeight, constraints.maxHeight)
    
    <span class="hljs-comment">// 3. 计算垂直位置（根据 Arrangement）</span>
    <span class="hljs-keyword">val</span> positions = verticalArrangement.arrange(
        totalSize = height,
        sizes = placeables.map { it.height },
        layoutDirection = layoutDirection
    )
    
    <span class="hljs-comment">// 4. 布局</span>
    layout(width, height) {
        placeables.forEachIndexed { index, placeable -&gt;
            <span class="hljs-comment">// 计算水平位置（根据 Alignment）</span>
            <span class="hljs-keyword">val</span> x = horizontalAlignment.align(
                size = placeable.width,
                space = width,
                layoutDirection = layoutDirection
            )
            placeable.placeRelative(x, positions[index])
        }
    }
}
</code></pre>
<p><strong>关键设计</strong>：</p>
<ul>
<li>Column 给子元素的约束是<strong>完整的父约束</strong>，子元素可以决定自己的高度</li>
<li>Column 的总高度是子元素高度之和</li>
<li>Arrangement 决定子元素的垂直分布</li>
<li>Alignment 决定子元素的水平对齐</li>
</ul>
<h3 data-id="heading-28">2.6 Row 的测量与布局原理</h3>
<p>Row 与 Column 类似，只是方向不同：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Row 的测量策略</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rowMeasurePolicy</span><span class="hljs-params">(
    horizontalArrangement: <span class="hljs-type">Arrangement</span>.<span class="hljs-type">Horizontal</span>,
    verticalAlignment: <span class="hljs-type">Alignment</span>.<span class="hljs-type">Vertical</span>
)</span></span>: MeasurePolicy = MeasurePolicy { measurables, constraints -&gt;
    <span class="hljs-comment">// 1. 测量所有子元素</span>
    <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
        measurable.measure(constraints)
    }
    
    <span class="hljs-comment">// 2. 计算 Row 的尺寸</span>
    <span class="hljs-keyword">val</span> width = placeables.sumOf { it.width }
        .coerceIn(constraints.minWidth, constraints.maxWidth)
    
    <span class="hljs-keyword">val</span> height = placeables.maxOf { it.height }
        .coerceIn(constraints.minHeight, constraints.maxHeight)
    
    <span class="hljs-comment">// 3. 计算水平位置（根据 Arrangement）</span>
    <span class="hljs-keyword">val</span> positions = horizontalArrangement.arrange(
        totalSize = width,
        sizes = placeables.map { it.width },
        layoutDirection = layoutDirection
    )
    
    <span class="hljs-comment">// 4. 布局</span>
    layout(width, height) {
        placeables.forEachIndexed { index, placeable -&gt;
            <span class="hljs-comment">// 计算垂直位置（根据 Alignment）</span>
            <span class="hljs-keyword">val</span> y = verticalAlignment.align(
                size = placeable.height,
                space = height
            )
            placeable.placeRelative(positions[index], y)
        }
    }
}
</code></pre>
<h3 data-id="heading-29">2.7 Box 的测量与布局原理</h3>
<p>Box 是层叠布局，子元素可以重叠：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Box 的测量策略</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">boxMeasurePolicy</span><span class="hljs-params">(alignment: <span class="hljs-type">Alignment</span>)</span></span>: MeasurePolicy = 
    MeasurePolicy { measurables, constraints -&gt;
        <span class="hljs-comment">// 1. 测量所有子元素</span>
        <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
            measurable.measure(constraints)
        }
        
        <span class="hljs-comment">// 2. 计算 Box 的尺寸</span>
        <span class="hljs-keyword">val</span> width = placeables.maxOf { it.width }
            .coerceIn(constraints.minWidth, constraints.maxWidth)
        
        <span class="hljs-keyword">val</span> height = placeables.maxOf { it.height }
            .coerceIn(constraints.minHeight, constraints.maxHeight)
        
        <span class="hljs-comment">// 3. 布局（所有子元素都使用相同的对齐方式）</span>
        layout(width, height) {
            placeables.forEach { placeable -&gt;
                <span class="hljs-keyword">val</span> x = alignment.align(
                    size = placeable.width,
                    space = width,
                    layoutDirection = layoutDirection
                )
                <span class="hljs-keyword">val</span> y = alignment.align(
                    size = placeable.height,
                    space = height
                )
                placeable.placeRelative(x, y)
            }
        }
    }
</code></pre>
<p><strong>Box 的特殊之处</strong>：</p>
<ul>
<li>所有子元素都测量为最大尺寸</li>
<li>子元素默认使用 contentAlignment 对齐</li>
<li>可以单独指定子元素的对齐方式（使用 Modifier.align）</li>
</ul>
<h3 data-id="heading-30">2.8 自定义 Layout 的设计思路</h3>
<h4 data-id="heading-31">2.8.1 设计自定义布局的步骤</h4>
<ol>
<li><strong>明确需求</strong>：要实现什么样的布局效果？</li>
<li><strong>确定约束</strong>：子元素的尺寸如何确定？</li>
<li><strong>设计测量策略</strong>：如何测量子元素？</li>
<li><strong>设计布局策略</strong>：子元素如何排列？</li>
</ol>
<h4 data-id="heading-32">2.8.2 实战：自定义瀑布流布局</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 瀑布流布局（StaggeredGrid）
 * 
 * 设计思路：
 * 1. 将子元素分配到多列中
 * 2. 每列独立计算高度
 * 3. 新元素添加到最短的列
 */</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StaggeredGrid</span><span class="hljs-params">(
    columns: <span class="hljs-type">Int</span> = <span class="hljs-number">2</span>,
    horizontalGap: <span class="hljs-type">Dp</span> = <span class="hljs-number">8.</span>dp,
    verticalGap: <span class="hljs-type">Dp</span> = <span class="hljs-number">8.</span>dp,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Layout(
        content = content,
        modifier = modifier
    ) { measurables, constraints -&gt;
        <span class="hljs-keyword">val</span> hGapPx = horizontalGap.roundToPx()
        <span class="hljs-keyword">val</span> vGapPx = verticalGap.roundToPx()
        
        <span class="hljs-comment">// 计算每列的宽度</span>
        <span class="hljs-keyword">val</span> columnWidth = (constraints.maxWidth - (columns - <span class="hljs-number">1</span>) * hGapPx) / columns
        
        <span class="hljs-comment">// 创建列高度追踪器</span>
        <span class="hljs-keyword">val</span> columnHeights = IntArray(columns) { <span class="hljs-number">0</span> }
        
        <span class="hljs-comment">// 存储每个子元素的位置信息</span>
        <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemInfo</span>(
            <span class="hljs-keyword">val</span> placeable: Placeable,
            <span class="hljs-keyword">val</span> column: <span class="hljs-built_in">Int</span>,
            <span class="hljs-keyword">val</span> x: <span class="hljs-built_in">Int</span>,
            <span class="hljs-keyword">val</span> y: <span class="hljs-built_in">Int</span>
        )
        
        <span class="hljs-keyword">val</span> itemInfos = mutableListOf&lt;ItemInfo&gt;()
        
        <span class="hljs-comment">// 测量并放置每个子元素</span>
        measurables.forEach { measurable -&gt;
            <span class="hljs-comment">// 测量子元素（宽度固定为列宽，高度不限）</span>
            <span class="hljs-keyword">val</span> placeable = measurable.measure(
                Constraints.fixedWidth(columnWidth)
            )
            
            <span class="hljs-comment">// 找到最短的列</span>
            <span class="hljs-keyword">val</span> shortestColumn = columnHeights.indices.minByOrNull { columnHeights[it] } ?: <span class="hljs-number">0</span>
            
            <span class="hljs-comment">// 计算位置</span>
            <span class="hljs-keyword">val</span> x = shortestColumn * (columnWidth + hGapPx)
            <span class="hljs-keyword">val</span> y = columnHeights[shortestColumn]
            
            <span class="hljs-comment">// 更新列高度</span>
            columnHeights[shortestColumn] += placeable.height + vGapPx
            
            itemInfos.add(ItemInfo(placeable, shortestColumn, x, y))
        }
        
        <span class="hljs-comment">// 计算总高度（最高列的高度）</span>
        <span class="hljs-keyword">val</span> totalHeight = columnHeights.maxOrNull()?.let { 
            it - vGapPx  <span class="hljs-comment">// 减去最后一个间隙</span>
        } ?: <span class="hljs-number">0</span>
        
        <span class="hljs-comment">// 布局</span>
        layout(constraints.maxWidth, totalHeight.coerceIn(constraints.minHeight, constraints.maxHeight)) {
            itemInfos.forEach { info -&gt;
                info.placeable.placeRelative(info.x, info.y)
            }
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StaggeredGridDemo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> items = listOf(
        <span class="hljs-string">"短文本"</span> to <span class="hljs-number">80</span>,
        <span class="hljs-string">"这是一个比较长的文本内容"</span> to <span class="hljs-number">120</span>,
        <span class="hljs-string">"中等"</span> to <span class="hljs-number">100</span>,
        <span class="hljs-string">"很长很长很长的文本内容在这里"</span> to <span class="hljs-number">150</span>,
        <span class="hljs-string">"短"</span> to <span class="hljs-number">60</span>,
    )
    
    StaggeredGrid(
        columns = <span class="hljs-number">2</span>,
        horizontalGap = <span class="hljs-number">8.</span>dp,
        verticalGap = <span class="hljs-number">8.</span>dp,
        modifier = Modifier.fillMaxWidth()
    ) {
        items.forEach { (text, height) -&gt;
            Card(
                modifier = Modifier.height(height.dp)
            ) {
                Text(
                    text = text,
                    modifier = Modifier.padding(<span class="hljs-number">8.</span>dp)
                )
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-33">2.9 SubcomposeLayout：延迟组合</h3>
<p>SubcomposeLayout 允许在测量阶段动态创建子元素，这在某些场景下非常有用。</p>
<h4 data-id="heading-34">2.9.1 使用场景</h4>
<ol>
<li><strong>根据测量结果决定子元素内容</strong></li>
<li><strong>实现复杂的自适应布局</strong></li>
<li><strong>动态加载内容</strong></li>
</ol>
<h4 data-id="heading-35">2.9.2 实战：响应式文本</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 响应式文本：根据可用宽度自动调整字体大小
 */</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ResponsiveText</span><span class="hljs-params">(
    text: <span class="hljs-type">String</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    minFontSize: <span class="hljs-type">TextUnit</span> = <span class="hljs-number">12.</span>sp,
    maxFontSize: <span class="hljs-type">TextUnit</span> = <span class="hljs-number">48.</span>sp
)</span></span> {
    SubcomposeLayout(modifier = modifier) { constraints -&gt;
        <span class="hljs-keyword">var</span> fontSize = maxFontSize
        <span class="hljs-keyword">var</span> placeable: Placeable? = <span class="hljs-literal">null</span>
        
        <span class="hljs-comment">// 二分查找合适的字体大小</span>
        <span class="hljs-keyword">while</span> (fontSize &gt;= minFontSize) {
            <span class="hljs-keyword">val</span> measurable = subcompose(<span class="hljs-string">"text_<span class="hljs-variable">$fontSize</span>"</span>) {
                Text(
                    text = text,
                    fontSize = fontSize,
                    maxLines = <span class="hljs-number">1</span>
                )
            }[<span class="hljs-number">0</span>]
            
            <span class="hljs-keyword">val</span> testPlaceable = measurable.measure(constraints)
            
            <span class="hljs-keyword">if</span> (testPlaceable.width &lt;= constraints.maxWidth) {
                placeable = testPlaceable
                <span class="hljs-keyword">break</span>
            }
            
            fontSize *= <span class="hljs-number">0.9f</span>
        }
        
        placeable = placeable ?: subcompose(<span class="hljs-string">"text_min"</span>) {
            Text(text = text, fontSize = minFontSize, maxLines = <span class="hljs-number">1</span>)
        }[<span class="hljs-number">0</span>].measure(constraints)
        
        layout(placeable.width, placeable.height) {
            placeable.placeRelative(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-36">三、LazyColumn 深度解析：惰性加载的艺术</h2>
<h3 data-id="heading-37">3.1 为什么需要惰性加载？</h3>
<p>假设我们要显示 10000 条数据的列表：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用普通 Column - 会创建 10000 个 Text 组件！</span>
Column {
    repeat(<span class="hljs-number">10000</span>) { index -&gt;
        Text(<span class="hljs-string">"Item <span class="hljs-variable">$index</span>"</span>)
    }
}
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>内存占用：10000 个 Text 组件同时存在</li>
<li>首次加载：需要测量和布局所有 item</li>
<li>滑动性能：大量视图参与绘制</li>
</ul>
<h3 data-id="heading-38">3.2 LazyColumn 的解决方案</h3>
<p>LazyColumn 采用<strong>视口渲染 + 对象池复用</strong>策略：</p>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────────────────┐
│                     LazyColumn 视口                            │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐     │
│  │                    可见区域 (Viewport)                  │     │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │     │
│  │  │ Item <span class="hljs-number">5</span>  │  │ Item <span class="hljs-number">6</span>  │  │ Item <span class="hljs-number">7</span>  │  │ Item <span class="hljs-number">8</span>  │  │     │
│  │  │ (可见)  │  │ (可见)  │  │ (可见)  │  │ (可见)  │  │     │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │     │
│  └──────────────────────────────────────────────────────┘     │
│                                                                │
│  Item <span class="hljs-number">1</span>-<span class="hljs-number">4</span>: 已滑出视口，组件被回收，状态保存                      │
│  Item <span class="hljs-number">9</span>+:  未进入视口，组件未创建                                │
│                                                                │
└────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-39">3.3 LazyColumn 的架构设计</h3>
<pre><code class="hljs language-scss" lang="scss">LazyColumn
├── LazyListState          (状态管理)
│   ├── firstVisibleItemIndex
│   ├── firstVisibleItemScrollOffset
│   └── layoutInfo
├── LazyListLayoutInfo     (布局信息)
│   ├── visibleItemsInfo   (可见 item 信息)
│   ├── totalItemsCount
│   └── viewportSize
└── LazyListItemProvider   (Item 提供器)
    └── itemProvider       (根据索引创建 item)
</code></pre>
<h3 data-id="heading-40">3.4 测量与布局流程</h3>
<p>LazyColumn 的测量流程与普通 Layout 不同：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LazyColumn 的测量策略（简化版）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">measureLazyList</span><span class="hljs-params">(constraints: <span class="hljs-type">Constraints</span>)</span></span>: MeasureResult {
    <span class="hljs-comment">// 1. 计算视口大小</span>
    <span class="hljs-keyword">val</span> viewportWidth = constraints.maxWidth
    <span class="hljs-keyword">val</span> viewportHeight = constraints.maxHeight
    
    <span class="hljs-comment">// 2. 确定可见 item 范围</span>
    <span class="hljs-keyword">val</span> firstVisibleIndex = calculateFirstVisibleItem()
    <span class="hljs-keyword">val</span> lastVisibleIndex = calculateLastVisibleItem(viewportHeight)
    
    <span class="hljs-comment">// 3. 测量可见 item</span>
    <span class="hljs-keyword">val</span> visiblePlaceables = mutableListOf&lt;Placeable&gt;()
    <span class="hljs-keyword">for</span> (index <span class="hljs-keyword">in</span> firstVisibleIndex..lastVisibleIndex) {
        <span class="hljs-keyword">val</span> placeable = measureItem(index, constraints)
        visiblePlaceables.add(placeable)
    }
    
    <span class="hljs-comment">// 4. 计算总高度（预估）</span>
    <span class="hljs-keyword">val</span> totalHeight = <span class="hljs-keyword">if</span> (hasMoreItems) {
        estimateTotalHeight()
    } <span class="hljs-keyword">else</span> {
        visiblePlaceables.sumOf { it.height }
    }
    
    <span class="hljs-comment">// 5. 布局</span>
    <span class="hljs-keyword">return</span> layout(viewportWidth, totalHeight) {
        <span class="hljs-keyword">var</span> y = -scrollOffset
        visiblePlaceables.forEach { placeable -&gt;
            placeable.placeRelative(<span class="hljs-number">0</span>, y)
            y += placeable.height
        }
    }
}
</code></pre>
<h3 data-id="heading-41">3.5 key 的作用与 diff 算法</h3>
<h4 data-id="heading-42">3.5.1 为什么需要 key？</h4>
<p>当列表数据变化时，Compose 需要知道：</p>
<ul>
<li>哪些 item 是新增的？</li>
<li>哪些 item 被删除了？</li>
<li>哪些 item 移动了位置？</li>
</ul>
<p><strong>没有 key 的问题</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 假设列表初始状态</span>
items = [A, B, C]

<span class="hljs-comment">// 删除 A 后</span>
items = [B, C]

<span class="hljs-comment">// 没有 key 时，Compose 会认为：</span>
<span class="hljs-comment">// - 位置 0 的内容从 A 变成了 B</span>
<span class="hljs-comment">// - 位置 1 的内容从 B 变成了 C</span>
<span class="hljs-comment">// - 位置 2 被删除</span>
<span class="hljs-comment">// 结果是：B 和 C 都会重组，状态丢失！</span>
</code></pre>
<p><strong>有 key 时</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">items(items, key = { it.id }) { item -&gt;
    ItemCard(item)
}

<span class="hljs-comment">// 删除 A 后</span>
<span class="hljs-comment">// Compose 知道：</span>
<span class="hljs-comment">// - A 被删除了</span>
<span class="hljs-comment">// - B 和 C 只是位置变了</span>
<span class="hljs-comment">// 结果是：只有 A 的组件被销毁，B 和 C 只是移动位置</span>
</code></pre>
<h4 data-id="heading-43">3.5.2 key 的 diff 算法</h4>
<p>Compose 使用类似 React 的 diff 算法：</p>
<pre><code class="hljs language-ini" lang="ini">旧列表: <span class="hljs-section">[A(key=1), B(key=2), C(key=3)]</span>
新列表: <span class="hljs-section">[B(key=2), C(key=3), D(key=4)]</span>

Diff 结果:
<span class="hljs-attr">1. key</span>=<span class="hljs-number">1</span> 的 A 不在新列表中 → 删除 A
<span class="hljs-attr">2. key</span>=<span class="hljs-number">2</span> 的 B 在位置 <span class="hljs-number">0</span> → 移动到位置 <span class="hljs-number">0</span>
<span class="hljs-attr">3. key</span>=<span class="hljs-number">3</span> 的 C 在位置 <span class="hljs-number">1</span> → 移动到位置 <span class="hljs-number">1</span>  
<span class="hljs-attr">4. key</span>=<span class="hljs-number">4</span> 的 D 是新元素 → 创建 D
</code></pre>
<h3 data-id="heading-44">3.6 列表状态管理</h3>
<h4 data-id="heading-45">3.6.1 记住滚动位置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LazyColumnWithState</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// rememberLazyListState 会自动保存和恢复滚动位置</span>
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    
    LazyColumn(state = listState) {
        items(<span class="hljs-number">1000</span>) { index -&gt;
            Text(<span class="hljs-string">"Item <span class="hljs-variable">$index</span>"</span>)
        }
    }
    
    <span class="hljs-comment">// 滚动到指定位置</span>
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        listState.scrollToItem(<span class="hljs-number">100</span>)
    }
    
    <span class="hljs-comment">// 平滑滚动</span>
    scope.launch {
        listState.animateScrollToItem(<span class="hljs-number">100</span>)
    }
}
</code></pre>
<h4 data-id="heading-46">3.6.2 监听滚动状态</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LazyColumnWithScrollListener</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    
    <span class="hljs-comment">// 使用 derivedStateOf 优化频繁变化的状态</span>
    <span class="hljs-keyword">val</span> firstVisibleItem <span class="hljs-keyword">by</span> remember {
        derivedStateOf { listState.firstVisibleItemIndex }
    }
    
    <span class="hljs-keyword">val</span> isScrolling <span class="hljs-keyword">by</span> remember {
        derivedStateOf { listState.isScrollInProgress }
    }
    
    <span class="hljs-comment">// 判断是否滑到底部</span>
    <span class="hljs-keyword">val</span> isAtBottom <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            <span class="hljs-keyword">val</span> layoutInfo = listState.layoutInfo
            <span class="hljs-keyword">val</span> visibleItems = layoutInfo.visibleItemsInfo
            <span class="hljs-keyword">val</span> lastVisibleItem = visibleItems.lastOrNull()
            
            lastVisibleItem != <span class="hljs-literal">null</span> &amp;&amp; 
            lastVisibleItem.index &gt;= layoutInfo.totalItemsCount - <span class="hljs-number">1</span>
        }
    }
    
    LazyColumn(state = listState) {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<h3 data-id="heading-47">3.7 分页加载实现</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PaginatedList</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    <span class="hljs-keyword">var</span> items <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;List&lt;Item&gt;&gt;(emptyList()) }
    <span class="hljs-keyword">var</span> isLoading <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    <span class="hljs-keyword">var</span> hasMore <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }
    
    <span class="hljs-comment">// 监听是否需要加载更多</span>
    <span class="hljs-keyword">val</span> shouldLoadMore <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            <span class="hljs-keyword">val</span> layoutInfo = listState.layoutInfo
            <span class="hljs-keyword">val</span> visibleItems = layoutInfo.visibleItemsInfo
            <span class="hljs-keyword">val</span> lastVisibleItem = visibleItems.lastOrNull()
            
            <span class="hljs-comment">// 当最后一个可见 item 是倒数第 5 个时，开始加载</span>
            lastVisibleItem != <span class="hljs-literal">null</span> &amp;&amp;
            lastVisibleItem.index &gt;= layoutInfo.totalItemsCount - <span class="hljs-number">5</span> &amp;&amp;
            !isLoading &amp;&amp; hasMore
        }
    }
    
    <span class="hljs-comment">// 加载数据</span>
    LaunchedEffect(shouldLoadMore) {
        <span class="hljs-keyword">if</span> (shouldLoadMore) {
            isLoading = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">val</span> newItems = repository.loadMore(items.size, pageSize = <span class="hljs-number">20</span>)
            items = items + newItems
            hasMore = newItems.size &gt;= <span class="hljs-number">20</span>
            isLoading = <span class="hljs-literal">false</span>
        }
    }
    
    LazyColumn(state = listState) {
        items(items, key = { it.id }) { item -&gt;
            ItemCard(item)
        }
        
        <span class="hljs-keyword">if</span> (isLoading) {
            item {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(<span class="hljs-number">16.</span>dp),
                    contentAlignment = Alignment.Center
                ) {
                    CircularProgressIndicator()
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-48">3.8 性能优化最佳实践</h3>
<h4 data-id="heading-49">3.8.1 使用 key</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：使用 key</span>
items(dataList, key = { it.id }) { item -&gt;
    ItemCard(item)
}

<span class="hljs-comment">// ❌ 错误：不使用 key</span>
items(dataList) { item -&gt;
    ItemCard(item)
}
</code></pre>
<h4 data-id="heading-50">3.8.2 避免在 item 中创建新的对象</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：每次重组都创建新的 lambda</span>
items(dataList, key = { it.id }) { item -&gt;
    ItemCard(
        item = item,
        onClick = { viewModel.onItemClick(item) }  <span class="hljs-comment">// 每次重组都创建</span>
    )
}

<span class="hljs-comment">// ✅ 正确：使用 remember 缓存 lambda</span>
items(dataList, key = { it.id }) { item -&gt;
    <span class="hljs-keyword">val</span> onClick = remember(item.id) {
        { viewModel.onItemClick(item) }
    }
    ItemCard(item = item, onClick = onClick)
}
</code></pre>
<h4 data-id="heading-51">3.8.3 使用 contentType 优化不同类型 item</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">LazyColumn {
    items(
        items = mixedList,
        key = { it.id },
        contentType = { it.type }  <span class="hljs-comment">// 帮助 Compose 复用 item</span>
    ) { item -&gt;
        <span class="hljs-keyword">when</span> (item.type) {
            Type.HEADER -&gt; HeaderItem(item)
            Type.CONTENT -&gt; ContentItem(item)
            Type.FOOTER -&gt; FooterItem(item)
        }
    }
}
</code></pre>
<h4 data-id="heading-52">3.8.4 合理使用 remember 缓存计算</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ItemCard</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span> {
    <span class="hljs-comment">// ✅ 缓存格式化后的价格</span>
    <span class="hljs-keyword">val</span> formattedPrice = remember(item.price) {
        NumberFormat.getCurrencyInstance().format(item.price)
    }
    
    <span class="hljs-comment">// ✅ 缓存渐变 Brush</span>
    <span class="hljs-keyword">val</span> gradient = remember(item.color) {
        Brush.linearGradient(
            colors = listOf(item.color, item.color.copy(alpha = <span class="hljs-number">0.5f</span>))
        )
    }
    
    Text(text = formattedPrice)
}
</code></pre>
<hr/>
<h2 data-id="heading-53">四、ConstraintLayout 深度解析</h2>
<h3 data-id="heading-54">4.1 ConstraintLayout 的设计哲学</h3>
<p>ConstraintLayout 的核心思想是<strong>通过约束条件描述布局</strong>，而不是通过嵌套层次。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>扁平的视图层级（通常只有一层）</li>
<li>灵活的相对定位</li>
<li>更好的性能（减少测量次数）</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>复杂的表单页面</li>
<li>需要相对定位的布局</li>
<li>需要动态调整位置的元素</li>
</ul>
<h3 data-id="heading-55">4.2 约束求解原理</h3>
<p>ConstraintLayout 的布局过程可以看作是一个<strong>约束求解问题</strong>：</p>
<pre><code class="hljs language-css" lang="css">变量：每个 View 的 x, y, <span class="hljs-attribute">width</span>, <span class="hljs-attribute">height</span>
约束条件：
  - View <span class="hljs-selector-tag">A</span> 的左边与父布局左边对齐
  - View <span class="hljs-selector-tag">B</span> 的左边与 View <span class="hljs-selector-tag">A</span> 的右边对齐
  - View C 在父布局中水平居中
  - ...

求解目标：找到满足所有约束的 x, y, <span class="hljs-attribute">width</span>, <span class="hljs-attribute">height</span>
</code></pre>
<h3 data-id="heading-56">4.3 与嵌套布局的选择策略</h3>



































<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>简单线性排列</td><td>Column/Row</td><td>代码更简洁，语义更清晰</td></tr><tr><td>需要相对定位</td><td>ConstraintLayout</td><td>减少嵌套层级</td></tr><tr><td>复杂表单</td><td>ConstraintLayout</td><td>标签和输入框对齐更方便</td></tr><tr><td>列表项</td><td>Column/Row</td><td>性能更好，代码更易读</td></tr><tr><td>需要动态位置</td><td>ConstraintLayout</td><td>约束可以动态修改</td></tr></tbody></table>
<h3 data-id="heading-57">4.4 性能对比</h3>
<pre><code class="hljs language-diff" lang="diff">场景：一个包含 10 个子元素的复杂布局

嵌套 Column + Row:
<span class="hljs-deletion">- 测量次数：O(n²) 级别</span>
<span class="hljs-deletion">- 视图层级：3-4 层</span>

ConstraintLayout:
<span class="hljs-deletion">- 测量次数：O(n) 级别</span>
<span class="hljs-deletion">- 视图层级：1 层</span>
</code></pre>
<p><strong>建议</strong>：</p>
<ul>
<li>简单布局优先使用 Column/Row</li>
<li>复杂布局考虑 ConstraintLayout</li>
<li>不要过度优化，先保证代码可读性</li>
</ul>
<hr/>
<h2 data-id="heading-58">五、常见问题与解决方案</h2>
<h3 data-id="heading-59">5.1 Modifier 相关问题</h3>
<p><strong>Q: 为什么 Modifier.padding() 和 Modifier.background() 的顺序会影响效果？</strong></p>
<p>A: 因为 Modifier 是从外到内执行的。先应用的 Modifier 在外层，后应用的在内层。</p>
<p><strong>Q: 如何实现点击区域比实际 View 大？</strong></p>
<p>A: 使用 <code>Modifier.clickable</code> 配合 <code>Modifier.padding</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Box(
    modifier = Modifier
        .clickable { <span class="hljs-comment">/* 点击处理 */</span> }
        .padding(<span class="hljs-number">16.</span>dp)  <span class="hljs-comment">// 点击区域包含 padding</span>
        .background(Color.Blue)
) {
    Text(<span class="hljs-string">"Click me"</span>)
}
</code></pre>
<h3 data-id="heading-60">5.2 布局相关问题</h3>
<p><strong>Q: 如何实现宽高比固定的组件？</strong></p>
<p>A: 使用 <code>AspectRatio</code> Modifier：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Image(
    painter = painterResource(R.drawable.image),
    contentDescription = <span class="hljs-literal">null</span>,
    modifier = Modifier.aspectRatio(<span class="hljs-number">16f</span> / <span class="hljs-number">9f</span>)
)
</code></pre>
<p><strong>Q: 如何让子元素填满剩余空间？</strong></p>
<p>A: 使用 <code>Modifier.weight</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Column {
    Text(<span class="hljs-string">"Header"</span>)
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .weight(<span class="hljs-number">1f</span>)  <span class="hljs-comment">// 填满剩余空间</span>
    )
    Text(<span class="hljs-string">"Footer"</span>)
}
</code></pre>
<h3 data-id="heading-61">5.3 LazyColumn 相关问题</h3>
<p><strong>Q: 列表滑动卡顿怎么办？</strong></p>
<p>A: 检查以下几点：</p>
<ol>
<li>是否使用了 key</li>
<li>item 中是否避免了创建新对象</li>
<li>是否使用了 derivedStateOf 优化频繁变化的状态</li>
<li>item 的布局是否过于复杂</li>
</ol>
<p><strong>Q: 如何实现粘性 Header？</strong></p>
<p>A: 使用 <code>stickyHeader</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">LazyColumn {
    stickyHeader {
        Text(<span class="hljs-string">"Section A"</span>, modifier = Modifier.background(Color.Gray))
    }
    items(itemsA) { Item(it) }
    
    stickyHeader {
        Text(<span class="hljs-string">"Section B"</span>, modifier = Modifier.background(Color.Gray))
    }
    items(itemsB) { Item(it) }
}
</code></pre>
<hr/>
<h2 data-id="heading-62">六、本篇小结</h2>
<p>今天我们深入探讨了 Compose 的核心基石：</p>
<h3 data-id="heading-63">Modifier</h3>
<ul>
<li>理解了 Modifier 的接口设计和链表结构</li>
<li>掌握了链式调用的执行顺序</li>
<li>学会了自定义 Modifier 的三种方式</li>
<li>了解了 Intrinsic 测量的原理</li>
</ul>
<h3 data-id="heading-64">布局系统</h3>
<ul>
<li>理解了 Composition → Layout → Drawing 的三阶段</li>
<li>掌握了 Constraints 的使用方法</li>
<li>深入了解了 Column、Row、Box 的测量与布局原理</li>
<li>学会了自定义 Layout 的设计思路</li>
</ul>
<h3 data-id="heading-65">LazyColumn</h3>
<ul>
<li>理解了惰性加载的视口渲染机制</li>
<li>掌握了 key 的作用和 diff 算法</li>
<li>学会了列表状态管理和分页加载</li>
<li>了解了性能优化的最佳实践</li>
</ul>
<h3 data-id="heading-66">ConstraintLayout</h3>
<ul>
<li>理解了约束求解的原理</li>
<li>掌握了与嵌套布局的选择策略</li>
</ul>
<hr/>
<h2 data-id="heading-67">下篇预告</h2>
<p><strong>第三篇：状态管理</strong> 将深入讲解：</p>
<ul>
<li>状态与重组机制深度解析（Slot Table 原理）</li>
<li>remember、mutableStateOf 源码分析</li>
<li>状态提升（State Hoisting）设计模式</li>
<li>ViewModel 与 Compose 的最佳实践</li>
<li>CompositionLocal 原理与应用</li>
</ul>
<p>敬请期待！</p>
<hr/>
<h2 data-id="heading-68">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flayouts" target="_blank" title="https://developer.android.com/jetpack/compose/layouts" ref="nofollow noopener noreferrer">Compose 布局官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flists" target="_blank" title="https://developer.android.com/jetpack/compose/lists" ref="nofollow noopener noreferrer">Lazy 列表官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fframeworks%2Fsupport%2F%2B%2Fandroidx-main%2Fcompose%2F" target="_blank" title="https://android.googlesource.com/platform/frameworks/support/+/androidx-main/compose/" ref="nofollow noopener noreferrer">Compose 源码</a></li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>系列文章导航</strong></p>
<ul>
<li>第一篇：初识 Compose ✅</li>
<li>第二篇：核心基石（当前）✅</li>
<li>第三篇：状态管理</li>
<li>第四篇：Material 组件与主题</li>
<li>第五篇：动画与交互</li>
<li>第六篇：架构与工程化</li>
<li>第七篇：高级特性与实战</li>
</ul>
</blockquote>
<hr/>
<p>如果这篇文章对你有帮助，欢迎 <strong>点赞</strong>、<strong>收藏</strong>、<strong>关注</strong>！有任何问题可以在评论区留言。</p>
<p><del>Generated by Kimi K2.5 Agent</del></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 网页布局练习]]></title>    <link>https://juejin.cn/post/7600318091831558171</link>    <guid>https://juejin.cn/post/7600318091831558171</guid>    <pubDate>2026-01-29T03:28:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600318091831558171" data-draft-id="7600303087875457062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 网页布局练习"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2026-01-29T03:28:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云自无心"/> <meta itemprop="url" content="https://juejin.cn/user/1726704870491139"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 网页布局练习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1726704870491139/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云自无心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:28:44.000Z" title="Thu Jan 29 2026 03:28:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：为什么学习 CSS 布局？</h2>
<p>CSS 布局是前端开发的核心技能之一。无论你是刚入门的新手，还是有一定经验的开发者，掌握扎实的布局知识都能让你的页面开发事半功倍。</p>
<h3 data-id="heading-1">布局技能的重要性</h3>





















<table><thead><tr><th><strong>阶段</strong></th><th><strong>需要的布局能力</strong></th></tr></thead><tbody><tr><td>入门</td><td>理解盒子模型、掌握 Flexbox 基础</td></tr><tr><td>进阶</td><td>响应式设计、Grid 布局、复杂组件</td></tr><tr><td>精通</td><td>性能优化、无障碍设计、系统架构</td></tr></tbody></table>
<h2 data-id="heading-2">入门级题目</h2>
<h3 data-id="heading-3">题目1：两栏布局（左侧固定，右侧自适应）</h3>
<p>要求 ：</p>
<ul>
<li>创建HTML结构，包含左侧边栏和右侧主内容区</li>
<li>左侧边栏宽度固定为 250px</li>
<li>右侧内容区占据剩余空间</li>
<li>使用 Flexbox 或 Grid 实现</li>
<li>最小化代码量</li>
</ul>
<p>HTML模板：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>两栏布局练习<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-comment">/* 在这里编写 CSS */</span>
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sidebar"</span>&gt;</span>侧边栏<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-content"</span>&gt;</span>主内容区<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>知识点 ：</p>
<ul>
<li>Flexbox: flex: 1 或 flex-grow: 1</li>
<li>Grid: 1fr 单位</li>
<li>高度统一问题</li>
</ul>
<p>预期效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/726f06c4070e4c9684a9b1d2244a2732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=JKEVjyhioVzCPvFaD1INokBQBQ8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">题目2：三栏布局（圣杯布局）</h3>
<p>要求 ：</p>
<ul>
<li>创建一个经典的三栏布局</li>
<li>左中右三栏排列，顺序为：左侧边栏、主内容区、右侧边栏</li>
<li>主内容区优先渲染（在DOM中放在最前面）</li>
<li>左右侧边栏宽度固定为 200px</li>
<li>主内容区自适应</li>
<li>整体高度占满视口</li>
</ul>
<p>HTML模板：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>头部区域<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main"</span>&gt;</span>主内容区（最先渲染）<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"left"</span>&gt;</span>左侧边栏<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"right"</span>&gt;</span>右侧边栏<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>底部区域<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<p>知识点 ：</p>
<ul>
<li>Flexbox 排序： order 属性</li>
<li>圣杯布局原理</li>
<li>负 margin 技术</li>
</ul>
<p>预期效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04dfae55b9cb412597c485d16b60d748~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=mKVAHOzDDX7eKlWkFjrauIrm4xs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">题目3：等高卡片布局</h3>
<p>要求 ：</p>
<ul>
<li>创建 4 个卡片并排显示</li>
<li>卡片内容高度不一致时，自动保持高度一致</li>
<li>使用 Flexbox 实现</li>
<li>添加边框和阴影效果</li>
</ul>
<p>HTML模板：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>卡片 1<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>简短内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>卡片 2<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>中等长度的内容区域<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>占两行显示<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>卡片 3<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>简短内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>卡片 4<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>很长的内容需要更多的空间来展示<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这使得卡片高度增加<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>其他卡片需要自动匹配高度<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>知识点 ：</p>
<ul>
<li>Flexbox 默认行为</li>
<li>align-items 默认为 stretch</li>
<li>卡片间距： gap 或 margin</li>
</ul>
<p>预期效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f8beb47deb64170800dd9cf7db42b00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=XshzqOONkP%2BdV54ksvbRyEzKCpI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">进阶级题目</h2>
<h3 data-id="heading-7">题目4：响应式图片网格</h3>
<p>要求 ：</p>
<ul>
<li>创建图片画廊布局</li>
<li>在大屏幕（&gt;1200px）显示 4 列</li>
<li>在中等屏幕（768px-1200px）显示 2 列</li>
<li>在小屏幕（&lt;768px）显示 1 列</li>
<li>使用 CSS Grid 实现</li>
<li>图片使用 object-fit: cover 保持比例</li>
</ul>
<p>HTML模板：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"gallery"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"gallery-item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://picsum.photos/400/300"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"gallery-item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://picsum.photos/400/300"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"gallery-item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://picsum.photos/400/300"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"gallery-item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://picsum.photos/400/300"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"gallery-item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://picsum.photos/400/300"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"gallery-item"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://picsum.photos/400/300"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>

<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.gallery</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-comment">/* 你的代码在这里 */</span>
}

<span class="hljs-selector-class">.gallery-item</span> <span class="hljs-selector-tag">img</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">object-fit</span>: cover;
}
</code></pre>
<p>知识点 ：</p>
<ul>
<li>CSS Grid： grid-template-columns 、 repeat()</li>
<li>媒体查询： @media</li>
<li>minmax() 函数</li>
</ul>
<p>预期结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ecae8f8812d4f059b1d9551d402a276~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=L2wPcRXAG2vw4uO1fEqiW8LmpjY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e1501e84644d7880d7829b12847419~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=Wns10J1WFLV6eoVTCqNnzZYOoEo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ed4ef3ef3114dc5b1af4167f90db7c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=2rGR2zi%2BWBdvMTywFKKJs8Vw0a0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">题目5：响应式导航栏</h3>
<p>要求 ：</p>
<ul>
<li>创建导航栏，在大屏幕显示水平菜单</li>
<li>在小屏幕显示汉堡菜单（点击展开/收起）</li>
<li>导航项包括：首页、关于、服务、联系</li>
<li>使用纯 CSS 实现（不用 JavaScript）</li>
</ul>
<p>HTML模板：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;nav <span class="hljs-keyword">class</span>=<span class="hljs-string">"navbar"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo"</span>&gt;</span>Logo<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"menu-toggle"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"menu-checkbox"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"menu-toggle"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"menu-icon"</span>&gt;</span>☰<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"menu"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>关于<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>服务<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>联系<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>
</code></pre>
<p>知识点 ：</p>
<ul>
<li>纯 CSS 交互： :checked + ~ 选择器</li>
<li>Flexbox 水平排列</li>
<li>媒体查询断点设计</li>
<li>position: absolute 定位菜单</li>
</ul>
<p>预期效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cd1fd311346422686ad17199b37ad6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=DgItqOtJstpHx0xSDtvTSrOrpQY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a7227116955482a9629deaf99abb35f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=2wvxE0NpXv7MH1Q5IUn%2FDrdqIfQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45b6617302454b73ac1333c459297c55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=fg%2F%2FUyDZedykm%2BAKlie7fedbtIY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">题目6：栅格系统</h3>
<p>要求 ：</p>
<ul>
<li>创建类似 Bootstrap 的 12 栅格系统</li>
<li>实现 .row 和 .col-* 类</li>
<li>支持不同屏幕尺寸的列宽：</li>
</ul>

<ul>
<li>
<ul>
<li>.col-12 （100%）</li>
<li>.col-6 （50%）</li>
<li>.col-4 （33.33%）</li>
<li>.col-3 （25%）</li>
</ul>
</li>
</ul>

<ul>
<li>添加列之间的间距</li>
</ul>
<p>HTML模板：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"col-3"</span>&gt;<span class="hljs-number">1</span>/<span class="hljs-number">4</span> 宽度&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"col-3"</span>&gt;<span class="hljs-number">1</span>/<span class="hljs-number">4</span> 宽度&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"col-3"</span>&gt;<span class="hljs-number">1</span>/<span class="hljs-number">4</span> 宽度&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"col-3"</span>&gt;<span class="hljs-number">1</span>/<span class="hljs-number">4</span> 宽度&lt;/div&gt;
  &lt;/div&gt;
  
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"col-6"</span>&gt;<span class="hljs-number">1</span>/<span class="hljs-number">2</span> 宽度&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"col-6"</span>&gt;<span class="hljs-number">1</span>/<span class="hljs-number">2</span> 宽度&lt;/div&gt;
  &lt;/div&gt;
  
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"col-4"</span>&gt;<span class="hljs-number">1</span>/<span class="hljs-number">3</span> 宽度&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"col-4"</span>&gt;<span class="hljs-number">1</span>/<span class="hljs-number">3</span> 宽度&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"col-4"</span>&gt;<span class="hljs-number">1</span>/<span class="hljs-number">3</span> 宽度&lt;/div&gt;
  &lt;/div&gt;

  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"row"</span>&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"col-12"</span>&gt;<span class="hljs-number">12</span>/<span class="hljs-number">12</span>宽度&lt;/div&gt;
  &lt;div&gt;
&lt;/div&gt;
</code></pre>
<p>知识点 ：</p>
<ul>
<li>浮动布局或 Flexbox 布局</li>
<li>百分比宽度计算</li>
<li>calc() 函数</li>
<li>box-sizing: border-box 重要性</li>
</ul>
<p>预期效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d975940fe3814cde81361de60783be95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=OQsojbu03s3HpNs4DrYCtdhmKvM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">综合实战题目</h2>
<h3 data-id="heading-11">题目7：个人作品集页面布局</h3>
<p>要求 ：</p>
<ul>
<li>使用你学过的所有布局技术创建一个作品集页面</li>
<li>页面结构包含：</li>
</ul>
<ol>
<li>
<ol>
<li>顶部导航栏（Logo + 菜单）</li>
<li>英雄区域（大背景图 + 标题 + CTA按钮）</li>
<li>关于我区域（左侧图片 + 右侧文本）</li>
<li>作品展示区域（响应式卡片网格）</li>
<li>联系表单区域（表单布局）</li>
<li>底部版权信息</li>
</ol>
</li>
</ol>
<p>设计要求 ：</p>
<ul>
<li>使用 CSS 变量定义颜色和间距</li>
<li>使用 Flexbox 布局导航和表单</li>
<li>使用 Grid 布局作品集卡片</li>
<li>响应式设计（移动端适配）</li>
<li>添加平滑的过渡动画</li>
</ul>
<p>HTML模板：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hero"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我的作品集<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cta"</span>&gt;</span>查看作品<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"about"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"about-image"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"about-text"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"portfolio"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>我的作品<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"portfolio-grid"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 6 个作品卡片 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"contact"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>联系我<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<p>预期效果（粗略制作 仅供参考）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/934add075ebe473085caec0ed1d32525~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=vRZXMDHrvHrNz4xp3cmFGC%2Bk0o0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">题目8：电商产品列表布局</h3>
<p>要求 ：</p>
<ul>
<li>创建一个电商网站的产品列表页面</li>
<li>左侧边栏包含筛选条件（分类、价格范围）</li>
<li>右侧显示产品网格</li>
<li>产品卡片包含：图片、标题、价格、加入购物车按钮</li>
<li>排序和分页功能</li>
</ul>
<p>布局要求 ：</p>
<ul>
<li>侧边栏固定宽度：250px</li>
<li>产品网格响应式列数</li>
<li>购物车按钮悬停效果</li>
<li>页面整体占满视口高度</li>
</ul>
<p>HTML模板：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page-container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"shop-header"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Shop<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sort-select"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span>&gt;</span>价格从低到高<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span>&gt;</span>价格从高到低<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span>&gt;</span>最新发布<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"shop-layout"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"filters"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>分类<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>&gt;</span> 电子产品<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>&gt;</span> 服装<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>&gt;</span> 家居<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>价格范围<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span> <span class="hljs-attr">min</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"1000"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"product-grid"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 8-12 个产品卡片 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"product-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"..."</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>产品名称<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"price"</span>&gt;</span>$99.00<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>加入购物车<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>预期效果（粗略制作 仅供参考）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5ed93404e474b3db107ccd72e1fbd2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=T%2FqAJxkSsFdwYsLUHDlXUP9tIAI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">题目9：完美居中布局</h3>
<p>要求 ：</p>
<ul>
<li>在页面正中心放置一个登录框</li>
<li>登录框包含：Logo、用户名输入框、密码输入框、登录按钮</li>
<li>无论页面大小如何，登录框始终居中</li>
<li>添加背景渐变效果</li>
</ul>
<p>HTML模板：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-box"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo"</span>&gt;</span>Logo<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"用户名"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"密码"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<p>知识点 ：</p>
<ul>
<li>Flexbox 居中： justify-content + align-items</li>
<li>Grid 居中： place-items: center</li>
<li>min-height: 100vh</li>
</ul>
<p>预期效果（粗略制作 仅供参考）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60ee1d8d50b64838810494353573d6d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=5CQ9c4tFGVRcofxa4UKTi7Silfc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">题目10：Timeline 时间线布局</h3>
<p>要求 ：</p>
<ul>
<li>创建垂直时间线布局</li>
<li>显示 5 个时间节点</li>
<li>每个节点包含：日期、内容、图标</li>
<li>交替在左右两侧显示内容</li>
<li>添加连接线和动画效果</li>
</ul>
<p>HTML模板：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"timeline"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"timeline-item"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"timeline-date"</span>&gt;</span>2024年1月<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"timeline-content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>项目启动<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>项目开始规划和设计<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"timeline-item"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"timeline-date"</span>&gt;</span>2024年3月<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"timeline-content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>第一阶段<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>完成核心功能开发<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 更多时间节点... --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>知识点 ：</p>
<ul>
<li>Flexbox 纵向排列</li>
<li>伪元素绘制连接线</li>
<li>:nth-child() 选择器</li>
<li>:hover 动画效果</li>
</ul>
<p>预期效果（粗略制作 仅供参考）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20170e002945498996afa5337d6eb51c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR6Ieq5peg5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262123&amp;x-signature=DFG6RNg7FkDgxsr3R8qMI7oyeXA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">寄语</h2>
<p>CSS 布局不难，难的是理解其背后的设计思想。</p>
<p>学习布局不是记忆属性，而是理解 空间分配 和 元素关系 的过程。</p>
<p>希望这 10 道练习题能帮助你建立扎实的 CSS 布局基础。记住，优秀的布局不仅要看起来美观，更要HTML 结构合理、适配各种设备噢。祝你学习愉快，代码整洁！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp使用stomp.js链接WebSocket连接hook]]></title>    <link>https://juejin.cn/post/7600342663319355433</link>    <guid>https://juejin.cn/post/7600342663319355433</guid>    <pubDate>2026-01-29T03:30:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600342663319355433" data-draft-id="7600340964083466246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp使用stomp.js链接WebSocket连接hook"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T03:30:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陌羽"/> <meta itemprop="url" content="https://juejin.cn/user/1508952759340541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp使用stomp.js链接WebSocket连接hook
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1508952759340541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陌羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:30:17.000Z" title="Thu Jan 29 2026 03:30:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>这篇是使用stomp.js组件库连接WebSocket，为了兼容后端框架使用。但由于uni-app的 <code>SocketTask</code> 与 STOMP 客户端不兼容。所以需要写一个适配器</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ref, onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Client</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">IFrame</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@stomp/stompjs'</span>;

<span class="hljs-comment">/**
 * uni-app WebSocket 适配器类
 * 提供与标准 WebSocket API 兼容的接口，适配 uni-app 的 SocketTask
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UniWebSocket</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">socketTask</span>: <span class="hljs-title class_">UniApp</span>.<span class="hljs-property">SocketTask</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// uni-app 的 WebSocket 实例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-attr">onopen</span>: (<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;           <span class="hljs-comment">// 连接打开回调</span>
    <span class="hljs-keyword">public</span> <span class="hljs-attr">onmessage</span>: (<span class="hljs-function">(<span class="hljs-params">event: { data: <span class="hljs-built_in">string</span> }</span>) =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 消息接收回调</span>
    <span class="hljs-keyword">public</span> <span class="hljs-attr">onclose</span>: (<span class="hljs-function">(<span class="hljs-params">event: { code: <span class="hljs-built_in">number</span>; reason: <span class="hljs-built_in">string</span> }</span>) =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 连接关闭回调</span>
    <span class="hljs-keyword">public</span> <span class="hljs-attr">onerror</span>: (<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 错误处理回调</span>
    <span class="hljs-keyword">public</span> readyState = <span class="hljs-number">0</span>; <span class="hljs-comment">// 连接状态：0=CONNECTING, 1=OPEN, 2=CLOSING, 3=CLOSED</span>

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 初始状态为连接中</span>
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 创建 uni-app WebSocket 连接</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketTask</span> = uni.<span class="hljs-title function_">connectSocket</span>({
                url,
                <span class="hljs-attr">success</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🟢 WebSocket 创建成功'</span>),
                <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'🔴 WebSocket 创建失败:'</span>, err);
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onerror</span>?.(err);
                }
            });

            <span class="hljs-comment">// 连接打开事件</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketTask</span>.<span class="hljs-title function_">onOpen</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ WebSocket 连接已打开'</span>);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 更新状态为已打开</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">onopen</span>?.(); <span class="hljs-comment">// 触发打开回调</span>
            });

            <span class="hljs-comment">// 消息接收事件</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketTask</span>.<span class="hljs-title function_">onMessage</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
                <span class="hljs-comment">// 过滤心跳消息</span>
                <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span> &amp;&amp; res.<span class="hljs-property">data</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'"type":"heartbeat"'</span>)) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'❤️ 收到心跳响应'</span>);
                    <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">onmessage</span>?.({ <span class="hljs-attr">data</span>: res.<span class="hljs-property">data</span> }); <span class="hljs-comment">// 触发消息回调</span>
            });

            <span class="hljs-comment">// 连接关闭事件</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketTask</span>.<span class="hljs-title function_">onClose</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`⛔ WebSocket 关闭 (code: <span class="hljs-subst">${res.code}</span>, reason: <span class="hljs-subst">${res.reason}</span>)`</span>);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// 更新状态为已关闭</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">onclose</span>?.({ <span class="hljs-attr">code</span>: res.<span class="hljs-property">code</span>, <span class="hljs-attr">reason</span>: res.<span class="hljs-property">reason</span> }); <span class="hljs-comment">// 触发关闭回调</span>
            });

            <span class="hljs-comment">// 错误事件</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketTask</span>.<span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ WebSocket 错误:'</span>, error);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">onerror</span>?.(error); <span class="hljs-comment">// 触发错误回调</span>
            });
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'创建 WebSocket 时出错:'</span>, error);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">onerror</span>?.(error);
        }
    }

    <span class="hljs-comment">/**
     * 发送消息
     * <span class="hljs-doctag">@param</span> data 要发送的数据
     */</span>
    <span class="hljs-title function_">send</span>(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">socketTask</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> === <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketTask</span>!.<span class="hljs-title function_">send</span>({
                    data,
                    <span class="hljs-attr">success</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(),
                    <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(err)
                });
            });
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'WebSocket not connected'</span>);
        }
    }

    <span class="hljs-comment">/**
     * 关闭连接
     * <span class="hljs-doctag">@param</span> code 关闭代码 (可选)
     * <span class="hljs-doctag">@param</span> reason 关闭原因 (可选)
     */</span>
    <span class="hljs-title function_">close</span>(<span class="hljs-params">code?: <span class="hljs-built_in">number</span>, reason?: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">socketTask</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> === <span class="hljs-number">1</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// 更新状态为关闭中</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketTask</span>.<span class="hljs-title function_">close</span>({
                <span class="hljs-attr">code</span>: code || <span class="hljs-number">1000</span>,
                <span class="hljs-attr">reason</span>: reason || <span class="hljs-string">'Normal closure'</span>
            });
        }
    }
}

<span class="hljs-comment">/**
 * 使用 STOMP over WebSocket 的自定义 Hook
 * <span class="hljs-doctag">@param</span> url WebSocket 服务器地址
 * <span class="hljs-doctag">@param</span> onMessage 消息接收回调函数
 * <span class="hljs-doctag">@param</span> heartbeatInterval 心跳间隔 (毫秒)，默认 10000
 * <span class="hljs-doctag">@returns</span> 包含连接状态和操作方法的对象
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useStompWebSocket</span>(<span class="hljs-params">
    url: <span class="hljs-built_in">string</span>,
    onMessage: (res: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">void</span>,
    heartbeatInterval = <span class="hljs-number">10000</span>
</span>) {
    <span class="hljs-comment">// 响应式状态变量</span>
    <span class="hljs-keyword">const</span> stompClient = ref&lt;<span class="hljs-title class_">Client</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);         <span class="hljs-comment">// STOMP 客户端实例</span>
    <span class="hljs-keyword">const</span> isDisconnect = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);                      <span class="hljs-comment">// 是否手动断开连接</span>
    <span class="hljs-keyword">const</span> isConnected = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);                       <span class="hljs-comment">// 是否已连接</span>
    <span class="hljs-keyword">const</span> reconnectAttempts = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);                     <span class="hljs-comment">// 重连尝试次数</span>
    <span class="hljs-keyword">const</span> maxReconnectAttempts = <span class="hljs-number">5</span>;                       <span class="hljs-comment">// 最大重连尝试次数</span>
    <span class="hljs-keyword">const</span> topic = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'/topic/global'</span>);                   <span class="hljs-comment">// 当前订阅的主题</span>
    <span class="hljs-keyword">const</span> subscriptionActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);                <span class="hljs-comment">// 订阅是否激活</span>
    <span class="hljs-keyword">const</span> subscriptionId = ref&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);      <span class="hljs-comment">// 订阅ID</span>
    <span class="hljs-keyword">const</span> isConnecting = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);                      <span class="hljs-comment">// 是否正在连接中</span>
    <span class="hljs-keyword">const</span> lastError = ref&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);           <span class="hljs-comment">// 最后发生的错误信息</span>
    <span class="hljs-keyword">const</span> protocolVersion = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'1.2'</span>);                   <span class="hljs-comment">// STOMP 协议版本</span>
    <span class="hljs-keyword">const</span> connectionAttempt = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);                     <span class="hljs-comment">// 连接尝试次数计数器</span>

    <span class="hljs-comment">// 定时器引用</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">reconnectTimer</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;             <span class="hljs-comment">// 重连定时器</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">heartbeatTimeout</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;           <span class="hljs-comment">// 心跳超时定时器</span>

    <span class="hljs-comment">/**
     * 清理资源
     * 清除定时器并重置状态
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">cleanup</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// 清除重连定时器</span>
        <span class="hljs-keyword">if</span> (reconnectTimer) {
            <span class="hljs-built_in">clearTimeout</span>(reconnectTimer);
            reconnectTimer = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-comment">// 清除心跳超时定时器</span>
        <span class="hljs-keyword">if</span> (heartbeatTimeout) {
            <span class="hljs-built_in">clearTimeout</span>(heartbeatTimeout);
            heartbeatTimeout = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-comment">// 重置状态</span>
        subscriptionActive.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
        lastError.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
    };

    <span class="hljs-comment">/**
     * 心跳监控
     * 检测心跳是否超时，如果超时则断开连接
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">startHeartbeatMonitor</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// 清除现有心跳超时定时器</span>
        <span class="hljs-keyword">if</span> (heartbeatTimeout) {
            <span class="hljs-built_in">clearTimeout</span>(heartbeatTimeout);
        }
        
        <span class="hljs-comment">// 设置心跳超时时间（比发送间隔长一点）</span>
        <span class="hljs-keyword">const</span> timeout = heartbeatInterval + <span class="hljs-number">5000</span>;
        
        <span class="hljs-comment">// 设置新的心跳超时定时器</span>
        heartbeatTimeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (isConnected.<span class="hljs-property">value</span>) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'💔 心跳超时，连接可能已断开'</span>);
                lastError.<span class="hljs-property">value</span> = <span class="hljs-string">'心跳超时，连接已断开'</span>;
                <span class="hljs-title function_">handleDisconnection</span>();
            }
        }, timeout) <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
    };

    <span class="hljs-comment">/**
     * 处理断开连接
     * 重置状态并尝试重连
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDisconnection</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// 更新连接状态</span>
        isConnected.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
        isConnecting.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
        subscriptionActive.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
        
        <span class="hljs-comment">// 清理 STOMP 客户端</span>
        <span class="hljs-keyword">if</span> (stompClient.<span class="hljs-property">value</span>) {
            <span class="hljs-keyword">try</span> {
                stompClient.<span class="hljs-property">value</span>.<span class="hljs-title function_">deactivate</span>();
            } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'断开连接时出错:'</span>, e);
            }
            stompClient.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-comment">// 如果不是手动断开且未达到最大重连次数，则尝试重连</span>
        <span class="hljs-keyword">if</span> (!isDisconnect.<span class="hljs-property">value</span> &amp;&amp; reconnectAttempts.<span class="hljs-property">value</span> &lt; maxReconnectAttempts) {
            <span class="hljs-title function_">handleReconnect</span>();
        }
    };

    <span class="hljs-comment">/**
     * 初始化 STOMP 连接
     * 创建并激活 STOMP 客户端
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">connect</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// 修复：在连接前重置 isDisconnect 状态</span>
        <span class="hljs-keyword">if</span> (isDisconnect.<span class="hljs-property">value</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🔃 重置断开状态，允许重新连接'</span>);
            isDisconnect.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-comment">// 如果已连接或正在手动断开，则不再尝试连接</span>
        <span class="hljs-keyword">if</span> (isConnected.<span class="hljs-property">value</span> || isDisconnect.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>;
        
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🔌 STOMP连接中...'</span>, url);
        <span class="hljs-comment">// 更新连接状态</span>
        isConnecting.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
        isConnected.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
        subscriptionActive.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
        connectionAttempt.<span class="hljs-property">value</span>++;
        
        <span class="hljs-comment">// 清理现有连接（如果存在）</span>
        <span class="hljs-keyword">if</span> (stompClient.<span class="hljs-property">value</span>) {
            <span class="hljs-keyword">try</span> {
                stompClient.<span class="hljs-property">value</span>.<span class="hljs-title function_">deactivate</span>();
            } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'清理旧连接时出错:'</span>, e);
            }
            stompClient.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">// 创建新的 STOMP 客户端</span>
        stompClient.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Client</span>({
            <span class="hljs-attr">brokerURL</span>: url,                     <span class="hljs-comment">// WebSocket 服务器地址</span>
            <span class="hljs-attr">reconnectDelay</span>: <span class="hljs-number">0</span>,                   <span class="hljs-comment">// 禁用内置重连，使用自定义重连逻辑</span>
            <span class="hljs-attr">heartbeatIncoming</span>: <span class="hljs-number">0</span>,                <span class="hljs-comment">// 不期望服务器心跳</span>
            <span class="hljs-attr">heartbeatOutgoing</span>: heartbeatInterval, <span class="hljs-comment">// 客户端发送心跳间隔</span>
            <span class="hljs-attr">debug</span>: <span class="hljs-function">(<span class="hljs-params">str</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'STOMP DEBUG:'</span>, str), <span class="hljs-comment">// 调试日志</span>
            
            <span class="hljs-comment">// 使用 uni-app 适配器</span>
            <span class="hljs-attr">webSocketFactory</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UniWebSocket</span>(url) <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>,
            
            <span class="hljs-comment">// 连接头信息</span>
            <span class="hljs-attr">connectHeaders</span>: {
                <span class="hljs-string">'accept-version'</span>: protocolVersion.<span class="hljs-property">value</span>, <span class="hljs-comment">// 支持的协议版本</span>
                <span class="hljs-string">'heart-beat'</span>: <span class="hljs-string">`<span class="hljs-subst">${heartbeatInterval}</span>,0`</span>   <span class="hljs-comment">// 心跳配置（发送，不接收）</span>
            },
            
            <span class="hljs-comment">// 连接成功回调</span>
            <span class="hljs-attr">onConnect</span>: <span class="hljs-function">(<span class="hljs-params">frame: IFrame</span>) =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ STOMP连接成功'</span>, frame);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'协议版本:'</span>, frame.<span class="hljs-property">headers</span>.<span class="hljs-property">version</span>);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'服务器心跳:'</span>, frame.<span class="hljs-property">headers</span>[<span class="hljs-string">'heart-beat'</span>]);
                
                <span class="hljs-comment">// 更新连接状态</span>
                isConnected.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
                isConnecting.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
                reconnectAttempts.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>;
                
                <span class="hljs-comment">// 启动心跳监控</span>
                <span class="hljs-title function_">startHeartbeatMonitor</span>();
                
                <span class="hljs-comment">// 订阅主题</span>
                <span class="hljs-title function_">subscribeTopic</span>();
            },
            
            <span class="hljs-comment">// STOMP 协议错误处理</span>
            <span class="hljs-attr">onStompError</span>: <span class="hljs-function">(<span class="hljs-params">frame: IFrame</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> errorMsg = frame.<span class="hljs-property">headers</span>.<span class="hljs-property">message</span> || <span class="hljs-string">'STOMP协议错误'</span>;
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ STOMP协议错误:'</span>, errorMsg);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误详情:'</span>, frame.<span class="hljs-property">body</span>);
                
                <span class="hljs-comment">// 保存错误信息</span>
                lastError.<span class="hljs-property">value</span> = <span class="hljs-string">`STOMP错误: <span class="hljs-subst">${errorMsg}</span>`</span>;
                
                <span class="hljs-comment">// 协议版本降级策略</span>
                <span class="hljs-keyword">if</span> (errorMsg.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'version'</span>)) {
                    <span class="hljs-keyword">if</span> (protocolVersion.<span class="hljs-property">value</span> === <span class="hljs-string">'1.2'</span>) {
                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'尝试降级到STOMP 1.1协议'</span>);
                        protocolVersion.<span class="hljs-property">value</span> = <span class="hljs-string">'1.1'</span>;
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (protocolVersion.<span class="hljs-property">value</span> === <span class="hljs-string">'1.1'</span>) {
                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'尝试降级到STOMP 1.0协议'</span>);
                        protocolVersion.<span class="hljs-property">value</span> = <span class="hljs-string">'1.0'</span>;
                    }
                }
                
                <span class="hljs-comment">// 处理断开连接</span>
                <span class="hljs-title function_">handleDisconnection</span>();
            },
            
            <span class="hljs-comment">// WebSocket 错误处理</span>
            <span class="hljs-attr">onWebSocketError</span>: <span class="hljs-function">(<span class="hljs-params">event: Event</span>) =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ WebSocket错误:'</span>, event);
                lastError.<span class="hljs-property">value</span> = <span class="hljs-string">`WebSocket错误: <span class="hljs-subst">${event.<span class="hljs-keyword">type</span>}</span>`</span>;
                <span class="hljs-title function_">handleDisconnection</span>();
            },
            
            <span class="hljs-comment">// 连接断开回调</span>
            <span class="hljs-attr">onDisconnect</span>: <span class="hljs-function">(<span class="hljs-params">frame</span>) =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'⛔ STOMP连接关闭'</span>, frame);
                lastError.<span class="hljs-property">value</span> = frame.<span class="hljs-property">headers</span>.<span class="hljs-property">message</span> || <span class="hljs-string">'连接已关闭'</span>;
                <span class="hljs-title function_">handleDisconnection</span>();
            },
            
            <span class="hljs-comment">// 连接前回调</span>
            <span class="hljs-attr">beforeConnect</span>: <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'⌛ 正在建立连接...'</span>);
            }
        });

        <span class="hljs-comment">// 激活客户端连接</span>
        stompClient.<span class="hljs-property">value</span>.<span class="hljs-title function_">activate</span>();
    };

    <span class="hljs-comment">/**
     * 处理重连逻辑
     * 实现指数退避重连策略
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReconnect</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// 如果手动断开或达到最大重连次数，则不再重连</span>
        <span class="hljs-keyword">if</span> (isDisconnect.<span class="hljs-property">value</span> || reconnectAttempts.<span class="hljs-property">value</span> &gt;= maxReconnectAttempts) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'停止重连，已达最大尝试次数'</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 清理资源</span>
        <span class="hljs-title function_">cleanup</span>();
        reconnectAttempts.<span class="hljs-property">value</span>++;

        <span class="hljs-comment">// 指数退避重连策略（2^attempts * 2000，最大30秒）</span>
        <span class="hljs-keyword">const</span> delay = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">2000</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, reconnectAttempts.<span class="hljs-property">value</span>), <span class="hljs-number">30000</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`⌛ <span class="hljs-subst">${delay}</span>ms 后尝试重连 (#<span class="hljs-subst">${reconnectAttempts.value}</span>)`</span>);

        <span class="hljs-comment">// 设置重连定时器</span>
        reconnectTimer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">connect</span>();
        }, delay) <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
    };

    <span class="hljs-comment">/**
     * 订阅主题
     * <span class="hljs-doctag">@returns</span> 订阅是否成功
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">subscribeTopic</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// 检查连接状态</span>
        <span class="hljs-keyword">if</span> (!stompClient.<span class="hljs-property">value</span> || !isConnected.<span class="hljs-property">value</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'STOMP 尚未连接，无法订阅主题'</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">// 如果已订阅，则不再重复订阅</span>
        <span class="hljs-keyword">if</span> (subscriptionActive.<span class="hljs-property">value</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主题已订阅，无需重复订阅'</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 生成唯一订阅ID</span>
            <span class="hljs-keyword">const</span> id = <span class="hljs-string">`sub-<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>)}</span>`</span>;
            subscriptionId.<span class="hljs-property">value</span> = id;

            <span class="hljs-comment">// 执行订阅</span>
            stompClient.<span class="hljs-property">value</span>.<span class="hljs-title function_">subscribe</span>(
                topic.<span class="hljs-property">value</span>, <span class="hljs-comment">// 订阅的主题</span>
                <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'📥 收到STOMP消息:'</span>, message.<span class="hljs-property">body</span>);
                        
                        <span class="hljs-comment">// 重置心跳监控（每次收到消息都重置）</span>
                        <span class="hljs-title function_">startHeartbeatMonitor</span>();
                        
                        <span class="hljs-comment">// 解析消息体</span>
                        <span class="hljs-keyword">let</span> data;
                        <span class="hljs-keyword">try</span> {
                            data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(message.<span class="hljs-property">body</span>);
                        } <span class="hljs-keyword">catch</span> (e) {
                            <span class="hljs-comment">// 如果解析失败，保持原始数据</span>
                            data = message.<span class="hljs-property">body</span>;
                        }
                        
                        <span class="hljs-comment">// 传递给外部处理程序</span>
                        <span class="hljs-title function_">onMessage</span>(data);
                    } <span class="hljs-keyword">catch</span> (e) {
                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❗ 消息处理失败:'</span>, e, <span class="hljs-string">'原始数据:'</span>, message.<span class="hljs-property">body</span>);
                    }
                },
                { id, <span class="hljs-attr">ack</span>: <span class="hljs-string">'auto'</span> } <span class="hljs-comment">// 订阅选项（ID和自动确认模式）</span>
            );

            <span class="hljs-comment">// 更新订阅状态</span>
            subscriptionActive.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ 已订阅主题: <span class="hljs-subst">${topic.value}</span>`</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ 订阅失败: <span class="hljs-subst">${topic.value}</span>`</span>, error);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    };

    <span class="hljs-comment">/**
     * 更新订阅主题
     * <span class="hljs-doctag">@param</span> newTopicValue 新的主题值
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateTopic</span> = (<span class="hljs-params">newTopicValue: <span class="hljs-built_in">string</span></span>) =&gt; {
        <span class="hljs-comment">// 取消旧订阅（如果存在）</span>
        <span class="hljs-keyword">if</span> (subscriptionId.<span class="hljs-property">value</span> &amp;&amp; stompClient.<span class="hljs-property">value</span>) {
            stompClient.<span class="hljs-property">value</span>.<span class="hljs-title function_">unsubscribe</span>(subscriptionId.<span class="hljs-property">value</span>);
            subscriptionActive.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`已取消订阅: <span class="hljs-subst">${topic.value}</span>`</span>);
        }

        <span class="hljs-comment">// 更新主题</span>
        topic.<span class="hljs-property">value</span> = newTopicValue;

        <span class="hljs-comment">// 如果已连接，则订阅新主题</span>
        <span class="hljs-keyword">if</span> (isConnected.<span class="hljs-property">value</span>) {
            <span class="hljs-title function_">subscribeTopic</span>();
        }
    };

    <span class="hljs-comment">/**
     * 断开连接
     * 手动关闭 WebSocket 连接
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">disconnect</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主动断开STOMP连接'</span>);
        <span class="hljs-comment">// 更新状态</span>
        isDisconnect.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
        isConnected.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
        isConnecting.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
        subscriptionActive.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;

        <span class="hljs-comment">// 清理 STOMP 客户端</span>
        <span class="hljs-keyword">if</span> (stompClient.<span class="hljs-property">value</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 取消订阅</span>
                <span class="hljs-keyword">if</span> (subscriptionId.<span class="hljs-property">value</span>) {
                    stompClient.<span class="hljs-property">value</span>.<span class="hljs-title function_">unsubscribe</span>(subscriptionId.<span class="hljs-property">value</span>);
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`已取消订阅: <span class="hljs-subst">${topic.value}</span>`</span>);
                }

                <span class="hljs-comment">// 断开连接</span>
                stompClient.<span class="hljs-property">value</span>.<span class="hljs-title function_">deactivate</span>();
            } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ 断开连接时出错:'</span>, e);
            }
            stompClient.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-comment">// 清理资源</span>
        <span class="hljs-title function_">cleanup</span>();
    };

    <span class="hljs-comment">/**
     * 发送消息
     * <span class="hljs-doctag">@param</span> message 要发送的消息内容
     * <span class="hljs-doctag">@returns</span> Promise 表示发送操作的结果
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMessage</span> = (<span class="hljs-params">message: <span class="hljs-built_in">any</span></span>) =&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            <span class="hljs-comment">// 检查连接状态</span>
            <span class="hljs-keyword">if</span> (!stompClient.<span class="hljs-property">value</span> || !isConnected.<span class="hljs-property">value</span>) {
                <span class="hljs-title function_">reject</span>(<span class="hljs-string">'STOMP未连接'</span>);
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 确保目标地址格式正确</span>
                <span class="hljs-keyword">const</span> destination = topic.<span class="hljs-property">value</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/app'</span>) 
                    ? topic.<span class="hljs-property">value</span> 
                    : <span class="hljs-string">`/app<span class="hljs-subst">${topic.value}</span>`</span>;

                <span class="hljs-comment">// 发布消息</span>
                stompClient.<span class="hljs-property">value</span>.<span class="hljs-title function_">publish</span>({
                    destination, <span class="hljs-comment">// 目标地址</span>
                    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-comment">// 消息体</span>
                        <span class="hljs-attr">type</span>: <span class="hljs-string">'custom'</span>,
                        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
                        <span class="hljs-attr">content</span>: message
                    }),
                    <span class="hljs-attr">headers</span>: { 
                        <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'application/json'</span>,
                        <span class="hljs-string">'persistent'</span>: <span class="hljs-string">'true'</span> <span class="hljs-comment">// 持久化消息</span>
                    }
                });
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'📤 消息发送成功:'</span>, message);
                <span class="hljs-title function_">resolve</span>();
            } <span class="hljs-keyword">catch</span> (err) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'❌ 消息发送失败:'</span>, err);
                <span class="hljs-title function_">reject</span>(err);
            }
        });
    };

    <span class="hljs-comment">// 生命周期钩子：组件挂载时连接</span>
    <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
        isDisconnect.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-title function_">connect</span>();
    });

    <span class="hljs-comment">// 生命周期钩子：组件卸载时断开连接</span>
    <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">disconnect</span>();
    });

    <span class="hljs-comment">// 返回公开的API</span>
    <span class="hljs-keyword">return</span> {
        isConnected,          <span class="hljs-comment">// 是否已连接</span>
        isConnecting,         <span class="hljs-comment">// 是否正在连接中</span>
        subscriptionActive,   <span class="hljs-comment">// 订阅是否激活</span>
        lastError,            <span class="hljs-comment">// 最后发生的错误</span>
        reconnectAttempts,    <span class="hljs-comment">// 重连尝试次数</span>
        protocolVersion,      <span class="hljs-comment">// 当前协议版本</span>
        connect,              <span class="hljs-comment">// 连接方法</span>
        disconnect,           <span class="hljs-comment">// 断开连接方法</span>
        sendMessage,          <span class="hljs-comment">// 发送消息方法</span>
        <span class="hljs-attr">subscribe</span>: subscribeTopic, <span class="hljs-comment">// 订阅主题方法</span>
        updateTopic           <span class="hljs-comment">// 更新主题方法</span>
    };
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp自定义WebSocket连接hook]]></title>    <link>https://juejin.cn/post/7600342663319371817</link>    <guid>https://juejin.cn/post/7600342663319371817</guid>    <pubDate>2026-01-29T03:30:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600342663319371817" data-draft-id="7600333405978935337" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp自定义WebSocket连接hook"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T03:30:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陌羽"/> <meta itemprop="url" content="https://juejin.cn/user/1508952759340541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp自定义WebSocket连接hook
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1508952759340541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陌羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:30:56.000Z" title="Thu Jan 29 2026 03:30:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p> 这是使用uniapp原生方法连接的WebSocket，所以需要跟后端沟通信息接收与发送的信息格式</p>
<pre><code class="hljs language-ini" lang="ini">import { ref, onMounted, onUnmounted } from 'vue'<span class="hljs-comment">;</span>

export default function useUniWebSocket(
	url : string,
	onMessage : (res : any) =&gt; void,
	<span class="hljs-attr">heartbeatInterval</span> = <span class="hljs-number">30000</span>,
) {
	const <span class="hljs-attr">socketTask</span> = ref&lt;UniApp.SocketTask | null&gt;(null)<span class="hljs-comment">;</span>
	const <span class="hljs-attr">isDisconnect</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
	const <span class="hljs-attr">isConnected</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
	const <span class="hljs-attr">reconnectAttempts</span> = ref(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
	const <span class="hljs-attr">maxReconnectAttempts</span> = <span class="hljs-number">5</span><span class="hljs-comment">;</span>
	const <span class="hljs-attr">topic</span> = ref(<span class="hljs-string">'/topic/global'</span>)<span class="hljs-comment">; // 默认订阅主题</span>
	const <span class="hljs-attr">subscriptionActive</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">; // 跟踪订阅状态</span>
	const <span class="hljs-attr">heartbeatCount</span> = ref(<span class="hljs-number">0</span>)<span class="hljs-comment">; // 添加心跳计数器</span>
	const <span class="hljs-attr">heartbeatStatus</span> = ref(<span class="hljs-string">'inactive'</span>)<span class="hljs-comment">; // 'active' | 'inactive'</span>

	let heartbeatTimer : number | <span class="hljs-attr">null</span> = null<span class="hljs-comment">;</span>
	let reconnectTimer : number | <span class="hljs-attr">null</span> = null<span class="hljs-comment">;</span>

	// 清理资源
	const <span class="hljs-attr">cleanup</span> = () =&gt; {
		if (heartbeatTimer) {
			clearInterval(heartbeatTimer)<span class="hljs-comment">;</span>
			<span class="hljs-attr">heartbeatTimer</span> = null<span class="hljs-comment">;</span>
		}
		if (reconnectTimer) {
			clearTimeout(reconnectTimer)<span class="hljs-comment">;</span>
			<span class="hljs-attr">reconnectTimer</span> = null<span class="hljs-comment">;</span>
		}
		<span class="hljs-attr">reconnectAttempts.value</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
		<span class="hljs-attr">subscriptionActive.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
		<span class="hljs-attr">heartbeatStatus.value</span> = <span class="hljs-string">'inactive'</span><span class="hljs-comment">;</span>
	}<span class="hljs-comment">;</span>

	// 修复后的心跳函数
	const <span class="hljs-attr">startHeartbeat</span> = () =&gt; {
		// 关键修复：清除现有定时器
		if (heartbeatTimer) {
			clearInterval(heartbeatTimer)<span class="hljs-comment">;</span>
			<span class="hljs-attr">heartbeatTimer</span> = null<span class="hljs-comment">;</span>
		}

		<span class="hljs-attr">heartbeatTimer</span> = setInterval(() =&gt; {
			if (socketTask.value &amp;&amp; isConnected.value) {
				socketTask.value.send({
					data: JSON.stringify({
						type: 'heartbeat',
						timestamp: Date.now(),
						count: heartbeatCount.value++ // 添加计数跟踪
					}),
					success: () =&gt; console.log('♥️ 心跳发送成功'),
					fail: (err) =&gt; console.error('心跳发送失败:', err)
				})<span class="hljs-comment">;</span>
				sendMessage('我发送信息了')
			}
		}, heartbeatInterval) as unknown as number<span class="hljs-comment">;</span>
		<span class="hljs-attr">heartbeatStatus.value</span> = <span class="hljs-string">'active'</span><span class="hljs-comment">;</span>
	}<span class="hljs-comment">;</span>

	// 初始化WebSocket连接
	const <span class="hljs-attr">connect</span> = () =&gt; {
		if (isConnected.value || isDisconnect.value) return<span class="hljs-comment">;</span>

		console.log('🔌 WebSocket连接中...', url)<span class="hljs-comment">;</span>
		<span class="hljs-attr">isConnected.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
		<span class="hljs-attr">subscriptionActive.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

		// 关闭现有连接（如果存在）
		if (socketTask.value) {
			try {
				socketTask.value.close({})<span class="hljs-comment">;</span>
			} catch (e) {
				console.warn('关闭旧连接时出错:', e)<span class="hljs-comment">;</span>
			}
			<span class="hljs-attr">socketTask.value</span> = null<span class="hljs-comment">;</span>
		}

		try {
			<span class="hljs-attr">socketTask.value</span> = uni.connectSocket({
				url,
				success: () =&gt; console.log('🟢 WebSocket创建成功'),
				fail: (err) =&gt; {
					console.error('🔴 WebSocket创建失败:', err)<span class="hljs-comment">;</span>
					handleReconnect()<span class="hljs-comment">;</span>
				}
			})<span class="hljs-comment">;</span>

			// 事件监听
			socketTask.value.onOpen((res:any) =&gt; {
				console.log('✅ WebSocket连接已打开回调',res)<span class="hljs-comment">;</span>
				console.log('✅ WebSocket连接已打开')<span class="hljs-comment">;</span>
				<span class="hljs-attr">isConnected.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
				<span class="hljs-attr">reconnectAttempts.value</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
				startHeartbeat()<span class="hljs-comment">;</span>
				subscribeTopic()<span class="hljs-comment">; // 连接成功后订阅主题</span>
			})<span class="hljs-comment">;</span>

			socketTask.value.onClose((res) =&gt; {
				console.log('⛔ WebSocket连接关闭', res)<span class="hljs-comment">;</span>
				<span class="hljs-attr">isConnected.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
				<span class="hljs-attr">subscriptionActive.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
				cleanup()<span class="hljs-comment">;</span>

				if (!isDisconnect.value &amp;&amp; reconnectAttempts.value &lt; maxReconnectAttempts) {
					handleReconnect()<span class="hljs-comment">;</span>
				}
			})<span class="hljs-comment">;</span>

			socketTask.value.onError((error) =&gt; {
				console.error('❌ WebSocket错误:', error)<span class="hljs-comment">;</span>
				<span class="hljs-attr">isConnected.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
				handleReconnect()<span class="hljs-comment">;</span>
			})<span class="hljs-comment">;</span>

			socketTask.value.onMessage((res : { data : string }) =&gt; {
				try {
					console.log('📥 收到原始消息:', res.data)<span class="hljs-comment">;</span>

					// 尝试解析JSON
					let data<span class="hljs-comment">;</span>
					try {
						<span class="hljs-attr">data</span> = JSON.parse(res.data)<span class="hljs-comment">;</span>
					} catch (e) {
						// 如果解析失败，保持原始数据
						<span class="hljs-attr">data</span> = res.data<span class="hljs-comment">;</span>
					}

					// 检查是否是订阅确认消息
					if (data &amp;&amp; <span class="hljs-attr">data.type</span> === <span class="hljs-string">'subscribed'</span> &amp;&amp; data.topic === topic.value) {
						console.log(`✅ 主题订阅确认: ${topic.value}`)<span class="hljs-comment">;</span>
						<span class="hljs-attr">subscriptionActive.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
						return<span class="hljs-comment">;</span>
					}

					// 检查是否是心跳响应
					if (data &amp;&amp; <span class="hljs-attr">data.type</span> === <span class="hljs-string">'heartbeat_ack'</span>) {
						console.log('❤️‍🔥 收到心跳响应')<span class="hljs-comment">;</span>
						return<span class="hljs-comment">;</span>
					}

					// 传递给外部处理程序
					onMessage(data)<span class="hljs-comment">;</span>
				} catch (e) {
					console.error('❗ 消息处理失败:', e, '原始数据:', res.data)<span class="hljs-comment">;</span>
				}
			})<span class="hljs-comment">;</span>

		} catch (error) {
			console.error('创建WebSocket时异常:', error)<span class="hljs-comment">;</span>
			handleReconnect()<span class="hljs-comment">;</span>
		}
	}<span class="hljs-comment">;</span>

	// 处理重连逻辑
	const <span class="hljs-attr">handleReconnect</span> = () =&gt; {
		if (isDisconnect.value || reconnectAttempts.value &gt;= maxReconnectAttempts) {
			console.warn('停止重连，已达最大尝试次数')<span class="hljs-comment">;</span>
			return<span class="hljs-comment">;</span>
		}

		cleanup()<span class="hljs-comment">;</span>
		reconnectAttempts.value++<span class="hljs-comment">;</span>

		const <span class="hljs-attr">delay</span> = Math.min(<span class="hljs-number">3000</span> * reconnectAttempts.value, <span class="hljs-number">15000</span>)<span class="hljs-comment">;</span>
		console.log(`⌛ ${delay}ms 后尝试重连 (<span class="hljs-comment">#${reconnectAttempts.value})`);</span>

		<span class="hljs-attr">reconnectTimer</span> = setTimeout(() =&gt; {
			connect()<span class="hljs-comment">;</span>
		}, delay) as unknown as number<span class="hljs-comment">;</span>
	}<span class="hljs-comment">;</span>

	// 订阅主题
	const <span class="hljs-attr">subscribeTopic</span> = () =&gt; {
		if (!socketTask.value || !isConnected.value) {
			console.warn('WebSocket 尚未连接，无法订阅主题')<span class="hljs-comment">;</span>
			return false<span class="hljs-comment">;</span>
		}

		if (subscriptionActive.value) {
			console.log('主题已订阅，无需重复订阅')<span class="hljs-comment">;</span>
			return true<span class="hljs-comment">;</span>
		}

		const <span class="hljs-attr">subscriptionMessage</span> = JSON.stringify({
			type: 'subscribe',
			topic: topic.value,
			timestamp: Date.now()
		})<span class="hljs-comment">;</span>

		socketTask.value.send({
			data: subscriptionMessage,
			success: (res:any) =&gt; {
				console.log(`📤 订阅成功回调: ${res}`)<span class="hljs-comment">;</span>
				console.log(`📤 订阅请求已发送: ${topic.value}`)<span class="hljs-comment">;</span>
			},
			fail: (err) =&gt; {
				console.error(`❌ 订阅请求发送失败: ${topic.value}`, err)<span class="hljs-comment">;</span>
			}
		})<span class="hljs-comment">;</span>

		return true<span class="hljs-comment">;</span>
	}<span class="hljs-comment">;</span>

	// 更新订阅主题
	const <span class="hljs-attr">updateTopic</span> = (newTopicValue : string) =&gt; {
		<span class="hljs-attr">topic.value</span> = newTopicValue<span class="hljs-comment">;</span>
		<span class="hljs-attr">subscriptionActive.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">; // 重置订阅状态</span>

		if (isConnected.value) {
			subscribeTopic()<span class="hljs-comment">;</span>
		}
	}<span class="hljs-comment">;</span>

	// 断开连接
	const <span class="hljs-attr">disconnect</span> = () =&gt; {
		console.log('主动断开WebSocket连接')<span class="hljs-comment">;</span>
		<span class="hljs-attr">isDisconnect.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
		<span class="hljs-attr">isConnected.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
		<span class="hljs-attr">subscriptionActive.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

		if (socketTask.value) {
			try {
				// 发送取消订阅消息
				if (subscriptionActive.value) {
					const <span class="hljs-attr">unsubscribeMessage</span> = JSON.stringify({
						type: 'unsubscribe',
						topic: topic.value
					})<span class="hljs-comment">;</span>

					socketTask.value.send({
						data: unsubscribeMessage,
						success: () =&gt; console.log(`取消订阅请求已发送: ${topic.value}`),
						fail: (err) =&gt; console.error(`取消订阅请求发送失败: ${err}`)
					})<span class="hljs-comment">;</span>
				}

				// 关闭连接
				socketTask.value.close({ reason: '用户主动断开' })<span class="hljs-comment">;</span>
			} catch (e) {
				console.error('❌ 关闭连接时出错:', e)<span class="hljs-comment">;</span>
			}
			<span class="hljs-attr">socketTask.value</span> = null<span class="hljs-comment">;</span>
		}
		cleanup()<span class="hljs-comment">;</span>
	}<span class="hljs-comment">;</span>

	// 发送消息
	const <span class="hljs-attr">sendMessage</span> = (message : any) =&gt; {
		console.log(message)<span class="hljs-comment">;</span>
		return new Promise&lt;void&gt;((resolve, reject) =&gt; {
			if (!socketTask.value || !isConnected.value) {
				reject('WebSocket未连接')<span class="hljs-comment">;</span>
				return<span class="hljs-comment">;</span>
			}

			// const <span class="hljs-attr">payload</span> = typeof message === <span class="hljs-string">'string'</span>
			// 	? message
			// 	: JSON.stringify(message)<span class="hljs-comment">;</span>
				
			const <span class="hljs-attr">payload</span> = JSON.stringify({
				type: 'custom',
				topic: '/app',
				timestamp: Date.now(),
				content:message
			})<span class="hljs-comment">;</span>

			socketTask.value.send({
				data: payload,
				success: () =&gt; resolve(),
				fail: (err) =&gt; reject(err)
			})<span class="hljs-comment">;</span>
		})<span class="hljs-comment">;</span>
	}<span class="hljs-comment">;</span>

	// 生命周期钩子
	onMounted(() =&gt; {
		<span class="hljs-attr">isDisconnect.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
		connect()<span class="hljs-comment">;</span>
	})<span class="hljs-comment">;</span>

	onUnmounted(() =&gt; {
		disconnect()<span class="hljs-comment">;</span>
	})<span class="hljs-comment">;</span>

	return {
		socketTask,
		isConnected,
		subscriptionActive,
		connect,
		disconnect,
		sendMessage,
		subscribe: subscribeTopic,
		updateTopic,
		reconnectAttempts
	}<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nuxt引入quill]]></title>    <link>https://juejin.cn/post/7600326291553796102</link>    <guid>https://juejin.cn/post/7600326291553796102</guid>    <pubDate>2026-01-29T03:31:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326291553796102" data-draft-id="7600340964083482630" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nuxt引入quill"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T03:31:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陌羽"/> <meta itemprop="url" content="https://juejin.cn/user/1508952759340541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nuxt引入quill
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1508952759340541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陌羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:31:33.000Z" title="Thu Jan 29 2026 03:31:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">1.安装</h2>
<blockquote>
<p>终端输入：npm install vue-quill-editor --save</p>
</blockquote>
<h2 data-id="heading-1">2.配置js文件</h2>
<p>在plugins文件夹内创建一个nuxt-quill-plugin.js的文件，内容如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'quill/dist/quill.core.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'quill/dist/quill.snow.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'quill/dist/quill.bubble.css'</span>
<span class="hljs-comment">// 引入quill</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Quill</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'quill'</span>
<span class="hljs-comment">// 设置字体工具栏</span>
<span class="hljs-keyword">var</span> sizes = [<span class="hljs-literal">false</span>, <span class="hljs-string">'14px'</span>, <span class="hljs-string">'16px'</span>, <span class="hljs-string">'20px'</span>, <span class="hljs-string">'24px'</span>, <span class="hljs-string">'36px'</span>];
<span class="hljs-keyword">var</span> <span class="hljs-title class_">Size</span> = <span class="hljs-title class_">Quill</span>.<span class="hljs-keyword">import</span>(<span class="hljs-string">"formats/size"</span>);
<span class="hljs-title class_">Size</span>.<span class="hljs-property">whitelist</span> = sizes;
<span class="hljs-comment">// 加一个浏览器端判断，只在浏览器端才渲染就不会报错了</span>
<span class="hljs-keyword">if</span> (process.<span class="hljs-property">browser</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">VueQuillEditor</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vue-quill-editor/dist/ssr'</span>)
  <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueQuillEditor</span>)
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<blockquote>
<p>注释：由于nuxt很多东西都是自生成或者服务端的一个东西，虽然是基于vue框架，但是和vue框架的配置方法很不一样。而quill富文本的字体大小只是默认的那几种所以定制化需要手动配置。按照一般的vue配置方法会报错。（当然本人是报错了，其他人不知道有没有这种情况）</p>
</blockquote>
<h2 data-id="heading-2">3.配置nuxt.config.js </h2>
<pre><code class="hljs language-arduino" lang="arduino">css: [
    <span class="hljs-string">'element-ui/lib/theme-chalk/index.css'</span>,
<span class="hljs-string">'@/static/css/common.scss'</span>,
 <span class="hljs-comment">// quill富文本</span>
    <span class="hljs-string">'quill/dist/quill.snow.css'</span>,
    <span class="hljs-string">'quill/dist/quill.bubble.css'</span>,
    <span class="hljs-string">'quill/dist/quill.core.css'</span>,
  ],
plugins: [
    {src:<span class="hljs-string">'@/plugins/store-cache'</span>,ssr:<span class="hljs-literal">false</span>},
    <span class="hljs-string">'@/plugins/element-ui'</span>,
    <span class="hljs-string">'@/plugins/axios'</span>,
    <span class="hljs-string">'@/plugins/utils.js'</span>,
    <span class="hljs-comment">// quill富文本</span>
    {
      src: <span class="hljs-string">'@/plugins/nuxt-quill-plugin.js'</span>,
      ssr: <span class="hljs-literal">false</span> <span class="hljs-comment">//仅在客户端渲染</span>
    },
  ],
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-3">4.组件使用</h2>
<p>这段代码里包含了上传图片的功能，其余自定义工具栏配置百度百科即可</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"VueQuillEditor"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-upload</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">"display: none"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"quill-avatar-uploader"</span>
      <span class="hljs-attr">:action</span>=<span class="hljs-string">"upUrl"</span>
      <span class="hljs-attr">:headers</span>=<span class="hljs-string">"headers"</span>
      <span class="hljs-attr">:show-file-list</span>=<span class="hljs-string">"false"</span>
      <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/png, image/jpeg, image/jpg"</span>
      <span class="hljs-attr">:before-upload</span>=<span class="hljs-string">"beforeAvatarUpload"</span>
      <span class="hljs-attr">:on-success</span>=<span class="hljs-string">"handleAvatarSuccess"</span>
     &gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-upload</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
      <span class="hljs-attr">class</span>=<span class="hljs-string">"quill-editor"</span> 
      <span class="hljs-attr">ref</span>=<span class="hljs-string">"myQuillEditor"</span>
      <span class="hljs-attr">:content</span>=<span class="hljs-string">"contentHtml"</span> 
      <span class="hljs-attr">v-quill:myQuillEditor</span>=<span class="hljs-string">"editorOption"</span>
      <span class="hljs-attr">:style</span>=<span class="hljs-string">"cusStyle"</span>
      <span class="hljs-attr">:width</span> = <span class="hljs-string">"toolBarwidth"</span>
      @<span class="hljs-attr">change</span>=<span class="hljs-string">"onEditorChange($event)"</span> 
      @<span class="hljs-attr">paste</span>=<span class="hljs-string">"pasteMe($event)"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 100px;"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: {
    <span class="hljs-comment">// 内容</span>
    <span class="hljs-attr">content</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">''</span>
    },
    <span class="hljs-comment">// 配置项</span>
    <span class="hljs-attr">containerOptions</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>,
      <span class="hljs-keyword">default</span> () {
        <span class="hljs-keyword">return</span> [
          [<span class="hljs-string">'bold'</span>, <span class="hljs-string">'italic'</span>],
          [<span class="hljs-string">'blockquote'</span>, <span class="hljs-string">'code-block'</span>],
          [<span class="hljs-string">'image'</span>],
          [{ <span class="hljs-string">'list'</span>: <span class="hljs-string">'ordered'</span> }, { <span class="hljs-string">'list'</span>: <span class="hljs-string">'bullet'</span> }],
        ]
      }
    },
    <span class="hljs-comment">// 自定义样式</span>
    <span class="hljs-attr">cusStyle</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">''</span>
    },
    <span class="hljs-comment">// 宽度</span>
    <span class="hljs-attr">toolBarwidth</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'500px'</span>
    },
    <span class="hljs-attr">maxLength</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-number">100</span>
    }
  },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">editorOption</span>: {
        <span class="hljs-comment">// some quill options</span>
        <span class="hljs-attr">modules</span>: {
          <span class="hljs-attr">toolbar</span>: {
            <span class="hljs-attr">container</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">containerOptions</span>,
            <span class="hljs-attr">handlers</span>: {
              <span class="hljs-string">'image'</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) {
                <span class="hljs-keyword">if</span> (value) {
                  <span class="hljs-comment">// 点击图片按触发elmentui上传的input选择图片事件.quill-avatar-uploader是上传文件组件的那个类名</span>
                  <span class="hljs-variable language_">document</span>
                    .<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">".quill-avatar-uploader input"</span>)
                    .<span class="hljs-title function_">click</span>();
                } <span class="hljs-keyword">else</span> {
                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">quill</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">"image"</span>, <span class="hljs-literal">false</span>);
                }
              }
            }
          }
        }
      },
      <span class="hljs-attr">contentHtml</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>,
      <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">progress</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">upUrl</span>: <span class="hljs-string">"/api/member/member/upload"</span>,
      <span class="hljs-attr">headers</span>: { <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">'Bearer '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">auth</span>.<span class="hljs-property">token</span>}
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">onEditorChange</span>(<span class="hljs-params">{ editor, html, text }</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'editor editor!'</span>, editor)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'editor html!'</span>, html)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'editor text!'</span>, text)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">contentHtml</span> = html
    },
    <span class="hljs-comment">// 图片上传前---格式与大小验证</span>
    <span class="hljs-title function_">beforeAvatarUpload</span>(<span class="hljs-params">file</span>) {
      <span class="hljs-keyword">let</span> isPass = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (
        file.<span class="hljs-property">type</span> === <span class="hljs-string">"image/png"</span> ||
        file.<span class="hljs-property">type</span> === <span class="hljs-string">"image/jpeg"</span> ||
        file.<span class="hljs-property">type</span> === <span class="hljs-string">"image/jpg"</span>
      ) {
        isPass = <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">const</span> isLt = file.<span class="hljs-property">size</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> &lt; <span class="hljs-number">5</span>;
      <span class="hljs-keyword">if</span> (!isPass) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"当前仅支持上传图片JPG/jpeg/png格式!"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">if</span> (!isLt) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"上传图片大小不能超过 5MB!"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">return</span> isPass &amp;&amp; isLt;
    },
    <span class="hljs-title function_">handleAvatarSuccess</span>(<span class="hljs-params">res, file</span>) {
      <span class="hljs-comment">// 图片上传成功后的回调</span>
      <span class="hljs-comment">// let quill = this.$refs.myQuillEditor.quill</span>
      <span class="hljs-comment">// 如果上传成功，res.url为服务器返回的图片地址</span>
      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span> !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 获取光标所在位置</span>
        <span class="hljs-comment">// let length = quill.getSelection().index</span>
        <span class="hljs-comment">// let url = this.$utils.pictureStitching( res.data, 'editor')</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">contentHtml</span> += <span class="hljs-string">`&lt;img src="<span class="hljs-subst">${res.data}</span>" alt="内容图片"&gt;`</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">contentHtml</span> =  <span class="hljs-variable language_">this</span>.<span class="hljs-property">$utils</span>.<span class="hljs-title function_">richText</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">contentHtml</span>)
        <span class="hljs-comment">// 插入图片 </span>
        <span class="hljs-comment">// quill.insertEmbed(length, 'image', url)</span>
        <span class="hljs-comment">// 调整光标到最后</span>
        <span class="hljs-comment">// quill.setSelection(length + 1)</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'图片插入失败'</span>)
      }
    },
  },
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<blockquote>
<p>注释：我这里使用其他方式插入图片失败了，所以直接采用了字符串拼接的方式，可以使用不同方法</p>
</blockquote>
<p> 5.Quill工具栏</p>
<blockquote>
<p>["bold", "italic", "underline", "strike"],       // 加粗 斜体 下划线 删除线<br/>
["blockquote", "code-block"],                    // 引用  代码块<br/>
[{ list: "ordered" }, { list: "bullet" }],       // 有序、无序列表<br/>
[{ indent: "-1" }, { indent: "+1" }],            // 缩进<br/>
[{ size: ["small", false, "large", "huge"] }],   // 字体大小<br/>
[{ header: [1, 2, 3, 4, 5, 6, false] }],         // 标题<br/>
[{ color: [] }, { background: [] }],             // 字体颜色、字体背景颜色<br/>
[{ align: [] }],                                 // 对齐方式<br/>
["clean"],                                       // 清除文本格式<br/>
["link", "image", "video"]                       // 链接、图片、视频</p>
</blockquote>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git 常用指南]]></title>    <link>https://juejin.cn/post/7600326947505504308</link>    <guid>https://juejin.cn/post/7600326947505504308</guid>    <pubDate>2026-01-29T03:35:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326947505504308" data-draft-id="7600341731046637603" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git 常用指南"/> <meta itemprop="keywords" content="GitHub,Git"/> <meta itemprop="datePublished" content="2026-01-29T03:35:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一用书生"/> <meta itemprop="url" content="https://juejin.cn/user/3192637496236926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git 常用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3192637496236926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一用书生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:35:30.000Z" title="Thu Jan 29 2026 03:35:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">认证</h3>
<ul>
<li>ssh 密钥是可以共享的，即多个平台可以使用一份密钥（gitlab、github等）</li>
</ul>
<h3 data-id="heading-1">远程连接相关</h3>
<ul>
<li>与远程仓库新建立连接</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">git remote <span class="hljs-keyword">add</span> origin xxx
</code></pre>
<p><em>注：</em>  1.本地一个仓库可以和n个远程仓库建立连接，且不限于一个服务器如gitlab\github\coding</p>
<ul>
<li>修改远程仓库连接</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">git remote set-url origin xxx
</code></pre>
<p><em>注：</em>  修改连接前提是，存在 origin 连接。</p>
<ul>
<li>查看连接状态</li>
</ul>
<pre><code class="hljs">git remote -v
</code></pre>
<p><em>注：</em>  如果是通过 <code>git clone</code> 下载下来的代码，已经存在默认连接。本地 <code>git init</code>则需要手动添加。</p>
<h2 data-id="heading-2">Branch</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frowthan%2Frowthan.github.io%2Ftree%2Fmaster%2Fv1%23branch" target="_blank" title="https://github.com/rowthan/rowthan.github.io/tree/master/v1#branch" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-3">越少越好</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frowthan%2Frowthan.github.io%2Ftree%2Fmaster%2Fv1%23%25E8%25B6%258A%25E5%25B0%2591%25E8%25B6%258A%25E5%25A5%25BD" target="_blank" title="https://github.com/rowthan/rowthan.github.io/tree/master/v1#%E8%B6%8A%E5%B0%91%E8%B6%8A%E5%A5%BD" ref="nofollow noopener noreferrer"/></p>
<blockquote>
<p>发布的代码只有一份，如果不是要达到分发衍生的效果（如Unix操作系统）分支应该尽可能少。用完即删，复用分支。</p>
</blockquote>
<pre><code class="hljs">git branch -m old_branch new_branch
</code></pre>
<h3 data-id="heading-4">命名清晰</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frowthan%2Frowthan.github.io%2Ftree%2Fmaster%2Fv1%23%25E5%2591%25BD%25E5%2590%258D%25E6%25B8%2585%25E6%2599%25B0" target="_blank" title="https://github.com/rowthan/rowthan.github.io/tree/master/v1#%E5%91%BD%E5%90%8D%E6%B8%85%E6%99%B0" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-bash" lang="bash">git checkout -b feature/login
</code></pre>
<h3 data-id="heading-5">保证分支commit节点干净</h3>
<blockquote>
<p>合并分支时，若未交付本分支代码（指本分支代码没有被合并至其他分支，没有被其他人公共使用），使用rebase更新。</p>
</blockquote>
<pre><code class="hljs language-css" lang="css">git commit -m '功能<span class="hljs-number">1</span>' // <span class="hljs-selector-tag">a</span>
git commit -m '功能<span class="hljs-number">2</span>' // <span class="hljs-selector-tag">b</span>
git pull origin master <span class="hljs-attr">--rebase</span>
// 通过rebase操作后，<span class="hljs-selector-tag">a</span>、<span class="hljs-selector-tag">b</span> 节点 hash 会发生改变为 a1,b1（故要求<span class="hljs-selector-tag">a</span>、<span class="hljs-selector-tag">b</span>没有被其他地方使用到），此操作能保证 a1,b1将位于整个commit树最前沿。
</code></pre>
<h3 data-id="heading-6">CURD</h3>
<ul>
<li>查看本地分支以及远程分支（-a 参数会显示远程分支）</li>
</ul>
<pre><code class="hljs language-css" lang="css">git branch -<span class="hljs-selector-tag">a</span>
</code></pre>
<ul>
<li>从远程分支下拉取到创建新分支,如果本地不存在该分支，则新建分支。不必 checkout -b 创建分支。</li>
</ul>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">fetch</span> origin originBranch:newBranch
</code></pre>
<ul>
<li>一次性更新本地所有分支</li>
</ul>
<pre><code class="hljs language-swift" lang="swift">git branch <span class="hljs-operator">|</span> awk '<span class="hljs-type">BEGIN</span>{print <span class="hljs-string">"echo ****Update all local branch...@daimon***"</span>}{<span class="hljs-keyword">if</span>(<span class="hljs-variable">$1</span><span class="hljs-operator">==</span><span class="hljs-string">"*"</span>){current<span class="hljs-operator">=</span>substr(<span class="hljs-variable">$0</span>,<span class="hljs-number">3</span>)};print a<span class="hljs-string">"git checkout "</span>substr(<span class="hljs-variable">$0</span>,<span class="hljs-number">3</span>);print <span class="hljs-string">"git pull --all"</span>;}<span class="hljs-type">END</span>{print <span class="hljs-string">"git checkout "</span> current}' <span class="hljs-operator">|</span>sh
</code></pre>
<ul>
<li>批量删除远程已经合并的分支</li>
</ul>
<pre><code class="hljs language-perl" lang="perl">git branch -r --merged | <span class="hljs-keyword">grep</span> origin | <span class="hljs-keyword">grep</span> -v -e master | sed s/origin\/// |  xargs -I{} git <span class="hljs-keyword">push</span> origin --<span class="hljs-keyword">delete</span> {}
</code></pre>
<h2 data-id="heading-7">Commit</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frowthan%2Frowthan.github.io%2Ftree%2Fmaster%2Fv1%23commit" target="_blank" title="https://github.com/rowthan/rowthan.github.io/tree/master/v1#commit" ref="nofollow noopener noreferrer"/></p>
<blockquote>
<p>好的 commit 的记录，对项目质量分析、发布日志管理、代码回滚都有很大的帮助。</p>
</blockquote>
<h3 data-id="heading-8">忽略文件跟踪</h3>
<p><code>.gitignore</code> <code>git rm --cached file</code></p>
<h3 data-id="heading-9">可交付性提交</h3>
<blockquote>
<p>按可交付功能为单位提交。保证reset到任意一个commit节点，系统都能正常工作。</p>
</blockquote>
<pre><code class="hljs language-arduino" lang="arduino">git commit -m <span class="hljs-string">'登录框UI初始化'</span> <span class="hljs-comment">// a</span>
git commit -m <span class="hljs-string">'接入登录接口'</span> <span class="hljs-comment">// b</span>
git commit -m <span class="hljs-string">'修改登录按钮样式'</span> <span class="hljs-comment">//c</span>
</code></pre>
<p>优化1-&gt;</p>
<pre><code class="hljs language-arduino" lang="arduino">git reset HEAD~<span class="hljs-number">3</span>
git commit -m <span class="hljs-string">'新增登录功能'</span> <span class="hljs-comment">//d</span>
</code></pre>
<p>优化2-&gt;</p>
<pre><code class="hljs language-arduino" lang="arduino">git commit -m <span class="hljs-string">'登录框UI初始化'</span> <span class="hljs-comment">// e</span>
git commit -m --amend <span class="hljs-string">'接入登录接口'</span> <span class="hljs-comment">//f</span>
git commit -m --amend <span class="hljs-string">'新增登录功能'</span> <span class="hljs-comment">//g</span>
</code></pre>
<p>优化3-&gt;</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 合并多次commit节点</span>
git rebase -i head~<span class="hljs-number">2</span> <span class="hljs-comment">// 然后修改 pick 为 s</span>
</code></pre>
<h3 data-id="heading-10">注释可读性</h3>
<blockquote>
<p>三段式注释。GitHub、JIRA 等系统能够通过特定的 commit 内容关联到相关链接。如GitHub：#456 能够自动关闭#456 issue。避免无明显意义的注释，如<code>bugfix</code> <code>修复缺陷</code>。</p>
</blockquote>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">refactor:</span> change <span class="hljs-keyword">let</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">const</span>(#<span class="hljs-number">457</span>)

this patch:
- changes <span class="hljs-comment">'let' into 'canst'</span>
- adds eslint check <span class="hljs-keyword">to</span> prefer <span class="hljs-keyword">const</span> over <span class="hljs-keyword">let</span>
</code></pre>
<p>注释的首位标识符，可以根据规范使用，如：refactor、feature、bugfix 等，用于代码发布时读取commit记录，自动生成changelog。</p>
<ul>
<li>适当添加 emoji</li>
</ul>
<pre><code class="hljs language-rust" lang="rust">git commit -m ':bug:修复变量修饰符：<span class="hljs-keyword">const</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-keyword">let</span>' <span class="hljs-comment">// emoji支持见下方</span>
</code></pre>
<h3 data-id="heading-11">善用stash</h3>
<blockquote>
<p>开发阶段临时切换分支，不想commit 已修改内容，切换分支提示无法切换。与直接commit相比，不会生成commit记录。 stash为栈空间，可以存储多个。</p>
</blockquote>
<pre><code class="hljs language-arduino" lang="arduino">git stash save <span class="hljs-string">'暂存'</span> 
</code></pre>
<h2 data-id="heading-12">Tag</h2>
<blockquote>
<p>相比使用release功能分支做代码更新的机制，Tag能保证唯一性，代码不受被后续合并污染。结合CI能够更好的做到持续部署。</p>
</blockquote>
<h2 data-id="heading-13">MR</h2>
<blockquote>
<p>以功能单位进行合并，在gitlab网页操作时，可选squash操作：服务器端的commit压缩操作（类<code>git rebase -i</code>）。</p>
</blockquote>
<h2 data-id="heading-14">CI/CD</h2>
<blockquote>
<p>CI 主要是用于保证尽可能地快速发现错误、防止代码分支发生偏离。</p>
</blockquote>
<ul>
<li>快速迭代、尽可能早的将代码合并到主干分支中，避免发生不必要的冲突和偏离。</li>
<li>在CI中加入自动化（如自动化测试、代码质量扫描、代码分析等），代码变检测开始，早发现问题早解决。</li>
<li>保障代码重构，代码不敢重构是因为缺少足够的自动化测试，当有充分的测试时，重构就会变得极其简单。</li>
<li>通过 .gitlab-ci.yml 文件定义CI构建过程。</li>
<li>Gitlab 本身不提供构建服务，只提供触发机制。能保证代码变，系统变。</li>
<li>构建服务需要单独部署，通过与「注册」与Gitlab建立连接关系。构建服务可以被共享。</li>
</ul>
<h3 data-id="heading-15">reset VS revert</h3>
<ul>
<li>git reset 后是不是很危险，重置了就再也找不回来了？</li>
</ul>
<blockquote>
<p>否。通过 reflog 可以重新找回。</p>
</blockquote>
<ul>
<li>a commit 节点会删除 文件不会改动，a 节点提交的文件状态 为 unstage</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">git reset head^<span class="hljs-number">1</span>(a) <span class="hljs-attr">--mixed</span>(default)
</code></pre>
<ul>
<li>a commit 节点会被删除 文件不会改动，a 节点提交的文件状态为 staged</li>
</ul>
<pre><code class="hljs language-css" lang="css">git reset head^<span class="hljs-number">1</span>(<span class="hljs-selector-tag">a</span>) <span class="hljs-attr">--soft</span>
</code></pre>
<ul>
<li>完全恢复到 a 节点上，文件历史记录都会丢失</li>
</ul>
<pre><code class="hljs language-css" lang="css">git reset head^<span class="hljs-number">1</span>(<span class="hljs-selector-tag">a</span>) <span class="hljs-attr">--hard</span>
</code></pre>
<ul>
<li>撤销倒数第二次commit节点修改 reset 和 revert 效果看似相同，但原理不同。reset 是往后走，将head指针向后移动，之后再合并时，这些commit会被还原， revert是撤销之前的commit 并生成一个新的commit节点，这些commit不会被还原。相当于对之前的commit做了逆操作。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">git revert <span class="hljs-built_in">head</span>~2 
</code></pre>
<h3 data-id="heading-16">merge VS rebase</h3>
<blockquote>
<p>git pull == git fetch + git merge</p>
</blockquote>
<p>和merge不同的是不会新生成一个merge节点，并且会整个各个分支的commit节点到一起 rebase 高级用法</p>
<pre><code class="hljs language-css" lang="css">git rebase -<span class="hljs-selector-tag">i</span> commintNo 
git rebase branch
</code></pre>
<p>不要rebase一个已经push出去的分支</p>
<p>一次性将所有远程（remote）的代码更新至当前分支</p>
<pre><code class="hljs language-css" lang="css">git pull <span class="hljs-attr">--all</span>
</code></pre>
<h3 data-id="heading-17">cherry-pick</h3>
<pre><code class="hljs">git checkout master  
git cherry-pick 62ecb3 
</code></pre>
<h3 data-id="heading-18">选择性合并</h3>
<p>合并 a-b commit 到maser</p>
<pre><code class="hljs language-css" lang="css">git checkout -bnewbranch <span class="hljs-selector-tag">b</span> 
git rebase <span class="hljs-attr">--ontomaster</span> <span class="hljs-selector-tag">a</span>^
</code></pre>
<h3 data-id="heading-19">日志查看</h3>
<ul>
<li>提交历史 <a href="https://link.juejin.cn?target=http%3A%2F%2Fblog.csdn.net%2Fdwarven%2Farticle%2Fdetails%2F46550117" target="_blank" title="http://blog.csdn.net/dwarven/article/details/46550117" ref="nofollow noopener noreferrer">blog.csdn.net/dwarven/art…</a></li>
</ul>
<pre><code class="hljs language-lua" lang="lua">git <span class="hljs-built_in">log</span> <span class="hljs-comment">--oneline</span>
</code></pre>
<ul>
<li>统计单个作者修改量</li>
</ul>
<pre><code class="hljs language-swift" lang="swift">git log <span class="hljs-operator">--</span>author<span class="hljs-operator">=</span><span class="hljs-string">"rowthan"</span> <span class="hljs-operator">--</span>pretty<span class="hljs-operator">=</span>tformat: <span class="hljs-operator">--</span>numstat <span class="hljs-operator">|</span> gawk '{ add <span class="hljs-operator">+=</span> <span class="hljs-variable">$1</span> ; subs <span class="hljs-operator">+=</span> <span class="hljs-variable">$2</span> ; loc <span class="hljs-operator">+=</span> <span class="hljs-variable">$1</span> <span class="hljs-operator">+</span> <span class="hljs-variable">$2</span> } <span class="hljs-type">END</span> { printf <span class="hljs-string">"added lines: %s removed lines : %s total lines: %s<span class="hljs-subst">\n</span>"</span>,add,subs,loc }'
操作历史
</code></pre>
<ul>
<li>可以通过操作历史，查找reset丢失的commit节点</li>
</ul>
<pre><code class="hljs">git reflog
</code></pre>
<h3 data-id="heading-20">代码推送</h3>
<ul>
<li>默认下，不推送 tag</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">git <span class="hljs-attr">push</span> == git push --<span class="hljs-literal">no</span>-tags
</code></pre>
<h3 data-id="heading-21">暂存区</h3>
<pre><code class="hljs language-arduino" lang="arduino">git stash save <span class="hljs-string">"暂存"</span>  
git stash apply
</code></pre>
<h3 data-id="heading-22">git 快捷键</h3>
<pre><code class="hljs language-csharp" lang="csharp">git config --<span class="hljs-keyword">global</span> <span class="hljs-keyword">alias</span>.st status
</code></pre>
<h3 data-id="heading-23">work tree 整理</h3>
<p>work tree 太混乱有没有办法能够梳理干净一点？  <a href="https://link.juejin.cn?target=http%3A%2F%2Fblog.csdn.net%2Fwh_19910525%2Farticle%2Fdetails%2F7554489" target="_blank" title="http://blog.csdn.net/wh_19910525/article/details/7554489" ref="nofollow noopener noreferrer">blog.csdn.net/wh_19910525…</a></p>
<h2 data-id="heading-24">git hooks</h2>
<blockquote>
<p>支持钩子，如：在pre-commit钩子前对代码格式化检测，如不通过无法commit；commit自动修改commit注释内容，增加标识（如Gerrit系统）</p>
</blockquote>
<p>钩子函数配置位于项目相对路径 /.git/hooks</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.git-scm.com%2Fbook%2Fzh%2Fv2%2F%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589-Git-Git-%25E9%2592%25A9%25E5%25AD%2590" target="_blank" title="https://www.git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90" ref="nofollow noopener noreferrer">git hooks</a></p>
<h2 data-id="heading-25">Github</h2>
<ul>
<li>搭建自己的免费网站</li>
</ul>
<p>如用户名为 a,创意一个 a.github.io 的项目，将自动生成一个域名为 a.github.io 的静态服务。</p>
<h2 data-id="heading-26">Git emoji</h2>
































































































































































<table><thead><tr><th align="left">emoji</th><th align="left">emoji 代码</th><th align="left">commit 说明</th></tr></thead><tbody><tr><td align="left">🎨 (调色板)</td><td align="left"><code>:art:</code></td><td align="left">改进代码结构/代码格式</td></tr><tr><td align="left">⚡ (闪电) 🐎 (赛马)</td><td align="left"><code>:zap:</code> <code>:racehorse:</code></td><td align="left">提升性能</td></tr><tr><td align="left">🔥 (火焰)</td><td align="left"><code>:fire:</code></td><td align="left">移除代码或文件</td></tr><tr><td align="left">🐛 (bug)</td><td align="left"><code>:bug:</code></td><td align="left">修复 bug</td></tr><tr><td align="left">🚑 (急救车)</td><td align="left"><code>:ambulance:</code></td><td align="left">重要补丁</td></tr><tr><td align="left">✨ (火花)</td><td align="left"><code>:sparkles:</code></td><td align="left">引入新功能</td></tr><tr><td align="left">📝 (备忘录)</td><td align="left"><code>:memo:</code></td><td align="left">撰写文档</td></tr><tr><td align="left">🚀 (火箭)</td><td align="left"><code>:rocket:</code></td><td align="left">部署功能</td></tr><tr><td align="left">💄 (口红)</td><td align="left"><code>:lipstick:</code></td><td align="left">更新 UI 和样式文件</td></tr><tr><td align="left">🎉 (庆祝)</td><td align="left"><code>:tada:</code></td><td align="left">初次提交</td></tr><tr><td align="left">✅ (白色复选框)</td><td align="left"><code>:white_check_mark:</code></td><td align="left">增加测试</td></tr><tr><td align="left">🔒 (锁)</td><td align="left"><code>:lock:</code></td><td align="left">修复安全问题</td></tr><tr><td align="left">🍎 (苹果)</td><td align="left"><code>:apple:</code></td><td align="left">修复 macOS 下的问题</td></tr><tr><td align="left">🐧 (企鹅)</td><td align="left"><code>:penguin:</code></td><td align="left">修复 Linux 下的问题</td></tr><tr><td align="left">🏁 (旗帜)</td><td align="left"><code>:checked_flag:</code></td><td align="left">修复 Windows 下的问题</td></tr><tr><td align="left">🔖 (书签)</td><td align="left"><code>:bookmark:</code></td><td align="left">发行/版本标签</td></tr><tr><td align="left">🚨 (警车灯)</td><td align="left"><code>:rotating_light:</code></td><td align="left">移除 linter 警告</td></tr><tr><td align="left">🚧 (施工)</td><td align="left"><code>:construction:</code></td><td align="left">工作进行中</td></tr><tr><td align="left">💚 (绿心)</td><td align="left"><code>:green_heart:</code></td><td align="left">修复 CI 构建问题</td></tr><tr><td align="left">⬇️ (下降箭头)</td><td align="left"><code>:arrow_down:</code></td><td align="left">降级依赖</td></tr><tr><td align="left">⬆️ (上升箭头)</td><td align="left"><code>:arrow_up:</code></td><td align="left">升级依赖</td></tr><tr><td align="left">👷 (工人)</td><td align="left"><code>:construction_worker:</code></td><td align="left">添加 CI 构建系统</td></tr><tr><td align="left">📈 (上升趋势图)</td><td align="left"><code>:chart_with_upwards_trend:</code></td><td align="left">添加分析或跟踪代码</td></tr><tr><td align="left">🔨 (锤子)</td><td align="left"><code>:hammer:</code></td><td align="left">重大重构</td></tr><tr><td align="left">➖ (减号)</td><td align="left"><code>:heavy_minus_sign:</code></td><td align="left">减少一个依赖</td></tr><tr><td align="left">🐳 (鲸鱼)</td><td align="left"><code>:whale:</code></td><td align="left">Docker 相关工作</td></tr><tr><td align="left">➕ (加号)</td><td align="left"><code>:heavy_plus_sign:</code></td><td align="left">增加一个依赖</td></tr><tr><td align="left">🔧 (扳手)</td><td align="left"><code>:wrench:</code></td><td align="left">修改配置文件</td></tr><tr><td align="left">🌐 (地球)</td><td align="left"><code>:globe_with_meridians:</code></td><td align="left">国际化与本地化</td></tr><tr><td align="left">✏️ (铅笔)</td><td align="left"><code>:pencil2:</code></td><td align="left">修复 typo</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[屠榜 GitHub，被迫改名！这款 AI 助手杀疯了！]]></title>    <link>https://juejin.cn/post/7600260767688196122</link>    <guid>https://juejin.cn/post/7600260767688196122</guid>    <pubDate>2026-01-29T03:36:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600260767688196122" data-draft-id="7600318091831590939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="屠榜 GitHub，被迫改名！这款 AI 助手杀疯了！"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-29T03:36:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            屠榜 GitHub，被迫改名！这款 AI 助手杀疯了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:36:45.000Z" title="Thu Jan 29 2026 03:36:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>开源界最近发生了一件趣事：一个项目火得太快，直接惊动了 AI 巨头 Anthropic 的法务部。</p>
<p>这个项目原本叫 <strong>ClawdBot</strong>，大家最近应该都刷到过。作为一个能让 AI "住" 进 WhatsApp、 Telegram 和飞书的开源助理，它在发布短短几天内，GitHub Star 数就从 5K 飙升到了 <strong>7.5W+</strong> ，成为全网最热门的 AI Agent 项目之一。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d726977ada04c0d93eea4d686adbc9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=w9VYBMGTEPuAg8rZCRsStCXYAjI%3D" alt="" loading="lazy"/></p>
<p>但因为名字发音和 "Claude" 完全一致，且 Logo 也是个大钳子（Claw），它很快收到了 Anthropic 的改名要求。面对巨头的压力，作者 Peter Steinberger 并没有退缩，而是玩了一个巧妙的双关梗——他正式将项目更名为 <strong>Moltbot</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a052f67015e4492d906bd249ed141226~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=LP2gHLZ1MWhOXCKikEOqDNOAv0E%3D" alt="" loading="lazy"/></p>
<p><strong>"Molt"</strong> 意为（甲壳类动物）蜕皮。这不仅回应了之前的 "Claw"（蟹钳）元素，更象征着项目蜕去了旧的外壳，进化为更强大、更通用的形态。</p>
<p>虽然名字改了，但它的核心魔法没有变，甚至更强了。</p>
<h3 data-id="heading-0">01 ClawdBot 是什么？</h3>
<p><strong>ClawdBot（已更名为 Moltbot）</strong> 是一个开源的个人 AI 助手，跑在你自己的设备上，入口是你常用的聊天软件——<strong>WhatsApp、Telegram、Slack、Discord、Signal</strong> 等都能接入。</p>
<p>简单来说：你可以在聊天框里和它对话，让它帮你干活儿。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/967b5127f2c343ffa9b85d187b9c8405~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=NYonyoSLpN%2BZ7PI70AThawmY%2Bmc%3D" alt="" loading="lazy"/></p>
<p>和 ChatGPT 这种传统 AI 助手相比，ClawdBot 有几个核心差异：</p>
<ol>
<li><strong>主动性</strong> ：ChatGPT 是你问它答，但 ClawdBot 可以先找你。比如每天早上主动发一份结合日历、待办事项、邮件的简报；定时监控航班价格、订阅源更新，满足条件就通知你。</li>
<li><strong>系统级操作</strong>：它能获取文件系统权限、执行 Shell 命令、控制浏览器、集成外部服务（邮件、日历、Notion 等）。功能强大，所以很多人会专门买一台 Mac Mini 来跑，而不是日常主力机。</li>
<li><strong>持久记忆</strong>：它能记住你的偏好、项目结构、常用习惯，所有记忆存储在本地，隐私友好。</li>
<li><strong>插件生态</strong>：目前已有 565+ Skill 插件，涵盖各种用途，让你的 AI 变身超级助理。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fd00773bf494224a2690aac6fda3a91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=oNZMHsmr9N32h%2Fixwa%2B16PxO668%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">02 为什么官方推荐 MiniMax M2.1？</h3>
<p>有趣的是，这个火爆全球的开源项目 ClawdBot 的作者 Peter Steinberger 多次公开推荐使用 <strong>MiniMax M2.1</strong> 作为 AI 大脑，海外开发者也纷纷晒出自己的使用体验。这背后有四个现实原因：</p>
<p><strong>第一，官方深度适配</strong></p>
<p>ClawdBot 的官方 Discord 机器人就是由 MiniMax 2.1 驱动的，这意味着作者团队已经针对该模型做了大量优化。在 prompt 格式、响应速度、功能支持上都有最佳实践，踩坑成本更低。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f636c6d0736e472b8eccb23694c32d28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=kPCVl%2B3eS2Rm%2FMnGhfKPazTVIKo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f55eb1aa78a4c27a39c829c98108054~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=fjiwgfJumOwmNULOsx%2B9mCneg4I%3D" alt="" loading="lazy"/></p>
<p><strong>第二，性格像 Claude，但更省钱</strong></p>
<p>M2.1 的回答风格接近 Claude——执行任务时会详细说明过程，略显啰嗦但不跳步。这种风格在复杂任务中反而更可靠，因为你能看到它的"思考链"，出错时更容易定位问题。而价格方面，MiniMax 的计费比 Claude 优惠很多，对于需要 24 小时持续运行、定时心跳的场景，成本差异会非常明显。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bc95fab6b584c3e92becdcc8f817bd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=wTlGxIPBtiNIi6eAP95XqEnh%2FwA%3D" alt="" loading="lazy"/></p>
<p><strong>第三，响应速度快</strong></p>
<p>在主动型场景中（如监控航班价格、订阅源更新），AI 需要频繁处理请求。M2.1 在响应速度上表现优秀，配合 MiniMax 的 Coding Plan 套餐，可以实现高频调用而不卡顿。</p>
<p><strong>第四，海外开发者实测好评</strong></p>
<p>不少海外开发者发文分享使用 M2.1 × ClawdBot 的体验，称"完全够用"、"性价比无敌"。这说明国产模型在全球开发者社区中已经建立了口碑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/542ee23c4e5546e4adffb6be94941c15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=7FuhA4sJ5qufr49jEjwdVtD6rUY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">03 快速上手指南</h3>
<p><strong>1. 准备工作：</strong></p>
<ul>
<li>MiniMax API Key（前往 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.minimaxi.com%2Fuser-center%2Fbasic-information%2Finterface-key" target="_blank" title="https://platform.minimaxi.com/user-center/basic-information/interface-key" ref="nofollow noopener noreferrer">platform.minimaxi.com/user-center…</a></strong> 获取）</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/418389e9ad774118bad8bb90867f0f9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=KiiDfKMN3ttPhp7bGsst2JfYVd4%3D" alt="" loading="lazy"/></p>
<ul>
<li>Node.js v22+</li>
<li>聊天软件账号（推荐 WhatsApp 配置最简单；如需使用飞书，请搜索相关插件配置）</li>
</ul>
<p><strong>2. 安装步骤：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c51ffee877846f2b034017b6e230238~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=%2BT2Zo91RoeXixDdxKAe%2FdCJ%2F5Yw%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局安装 clawdbot</span>
npm install -g clawdbot@latest

<span class="hljs-comment"># 运行初始化向导</span>
clawdbot onboard --install-daemon
</code></pre>
<p>向导会引导你完成：</p>
<ol>
<li>选择模型提供商 → 选择 <strong>MiniMax 2.1</strong></li>
<li>粘贴你的 API Key</li>
<li>选择聊天渠道
<ol>
<li>使用 WhatsApp 扫描二维码进行绑定</li>
<li>输入手机号,只允许改手机号发送的消息,clawdbot 能接收并响应</li>
</ol>
</li>
<li>完成绑定</li>
<li>愉快的开始聊天吧！</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb01cf7a6d3844aa988bfc2e9ee8e7eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=vueYEA9Q37cxmpio70tW8fwZb%2FI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/137b52caa01143428547c0566bf578a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=qdG%2B0KNHvqF%2FjfeFHyAPm4F3rg4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d0264e40fef4532881801f822f880b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=sIBtTyixzA97SiHdUlK1GsAL3I4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43ca424221844abab009344aabac0a24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=0TD3aZQh9ae5m1PVamwEbM4tl78%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70785ecfab9b4442b56d1bd838b91a73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=K1Dix4Kycp1xYBAkh96K5OC99gg%3D" alt="" loading="lazy"/></p>
<p>可以看到，我们这里是用 WhatsApp 接入的。目前也有开发者开发了用飞书接入插件，感兴趣的可以试试看。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6103e7f40d9945a28083bbea894b083d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=f6xc9tVaLRA8MXKOrvSoYFXEdR0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/634dc1f329ce43699f448907edf8b58c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=DGhsfrkjazpmMQlCl6TSGAe0NxA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ba6adb25c154690ad54102c03c333be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=P%2BI8Vye%2Fqj4hC%2BRJEL4tcErj9lw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17b55a39aacd4bb8acbf6e916e4f843a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=EIN484%2FyGddOR%2BzpurHdz1gb%2F1s%3D" alt="" loading="lazy"/></p>
<p>完成后，你就可以在聊天框里和你的 AI 助手对话了,并且我们能看到移动端与网页端是同步的！：</p>
<blockquote>
<p>"我今天心情不错"</p>
<p>"帮我查看下今天的天气"</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c88bbfbfcb6f49acafff961bcbf32c8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=G4PuhV%2B9t%2Bl%2FmA10v6ZQAIb0he8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a250a1609d7420d94281cb6792b4967~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=qMKb1VKCKPLzevJH9GLxzdRA86I%3D" alt="" loading="lazy"/></p>
<p>对于开发者来说，你可以让它：</p>
<ul>
<li><strong>代码审查</strong>："检查 src 目录下所有到代码文件，找出可能有 bug 的地方"</li>
<li><strong>自动化测试</strong>："执行测试，如果失败就把错误日志发给我"</li>
<li><strong>GitHub 监控</strong>："关注我 star 的所有仓库，有新 Release 就通知我"</li>
<li><strong>文档整理</strong>："扫描我的项目 README，生成一个 API 文档草稿"</li>
</ul>
<p><strong>视频教程</strong></p>
<p>如果想看手把手演示的话，B 站上有完整的视频教程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4b2126ed9c14ebf9973f0907bae6065~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262604&amp;x-signature=uDPgAxvsQPbVsxMMPqOe%2BaWL7YY%3D" alt="" loading="lazy"/></p>
<p>👉 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1TNzYBiER6" target="_blank" title="https://www.bilibili.com/video/BV1TNzYBiER6" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1TN…</a></strong></p>
<h3 data-id="heading-3">04 总结</h3>
<p>ClawdBot 的核心价值可以概括为一句话：<strong>把 AI 助手从"被动问答工具"升级为"主动服务管家"，并集成在你最常用的聊天软件里</strong>。</p>
<p>它不是功能最强大的 AI 框架，也不是最容易配置的自动化工具，但它做到了一件最重要的事：让 AI 助手真正融入你的日常工作流，而不是让你去适应 AI 的操作方式。</p>
<p>配合 MiniMax M2.1 这款国产模型，ClawdBot 在性能、速度、性价比上找到了不错的平衡点。</p>
<ul>
<li>GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">github.com/moltbot/mol…</a></li>
<li>MiniMax 平台：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.minimaxi.com" target="_blank" title="https://platform.minimaxi.com" ref="nofollow noopener noreferrer">platform.minimaxi.com</a></li>
<li>视频教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1TNzYBiER6" target="_blank" title="https://www.bilibili.com/video/BV1TNzYBiER6" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1TN…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>