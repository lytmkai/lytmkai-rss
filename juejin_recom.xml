<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[使用LangSmith评估智能体]]></title>    <link>https://juejin.cn/post/7573679820632719395</link>    <guid>https://juejin.cn/post/7573679820632719395</guid>    <pubDate>2025-11-18T09:21:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573679820632719395" data-draft-id="7573670400153714740" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用LangSmith评估智能体"/> <meta itemprop="keywords" content="Agent,LangChain,Python"/> <meta itemprop="datePublished" content="2025-11-18T09:21:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用LangSmith评估智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:21:29.000Z" title="Tue Nov 18 2025 09:21:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>评估（Evaluations）是衡量大模型（LLM）应用程序性能的一种量化方式。LLM 的行为可能存在不确定性，即便对提示词、模型或输入做出微小调整，也可能对结果产生显著影响。而评估能够提供一种结构化方法，帮助识别故障、对比版本，并构建更可靠的人工智能应用程序。</p>
<p>在LangSmith中执行评估需要三个关键组件：</p>
<ul>
<li>数据集（Dataset）：一组测试输入（可选包含预期输出）。</li>
<li>目标函数（Target function）：你希望测试的应用程序部分 —— 可能是使用新提示词的单次LLM调用、某个模块，或是整个工作流程。</li>
<li>评估器（Evaluators）：为目标函数的输出打分的函数。</li>
</ul>
<p>本文将使用LangSmith SDK带你完成一次基础评估（验证LLM 响应的正确性）。</p>
<h2 data-id="heading-0">准备</h2>
<ul>
<li>一个 LangSmith 账号：可在 smith.langchain.com 注册或登录。</li>
<li>一个 LangSmith API 密钥：请参考《创建 API 密钥指南》操作。</li>
<li>一个 OpenAI API 密钥：可在 OpenAI 控制台（dashboard）中生成</li>
</ul>
<h2 data-id="heading-1">安装依赖</h2>
<pre><code class="hljs language-bash" lang="bash">pip install -U langsmith openevals openai
</code></pre>
<h2 data-id="heading-2">设置环境变量</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> LANGSMITH_TRACING=<span class="hljs-literal">true</span>
<span class="hljs-built_in">export</span> LANGSMITH_API_KEY=<span class="hljs-string">"&lt;your-langsmith-api-key&gt;"</span>
<span class="hljs-built_in">export</span> OPENAI_API_KEY=<span class="hljs-string">"&lt;your-openai-api-key&gt;"</span>
<span class="hljs-built_in">export</span> LANGSMITH_WORKSPACE_ID=<span class="hljs-string">"&lt;your-workspace-id&gt;"</span>
</code></pre>
<h2 data-id="heading-3">创建数据集</h2>
<p>创建一个文件并添加以下代码，代码将实现以下功能：</p>
<ul>
<li>导入 Client 以连接 LangSmith。</li>
<li>创建一个数据集。</li>
<li>定义示例输入和输出。</li>
<li>在 LangSmith 中关联输入输出对与该数据集，以便它们能在评估中使用。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># dataset.py</span>
<span class="hljs-keyword">from</span> langsmith <span class="hljs-keyword">import</span> Client

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    client = Client()

    <span class="hljs-comment"># Programmatically create a dataset in LangSmith</span>
    dataset = client.create_dataset(
        dataset_name=<span class="hljs-string">"Sample dataset"</span>,
        description=<span class="hljs-string">"A sample dataset in LangSmith."</span>
    )

    <span class="hljs-comment"># Create examples</span>
    examples = [
        {
            <span class="hljs-string">"inputs"</span>: {<span class="hljs-string">"question"</span>: <span class="hljs-string">"Which country is Mount Kilimanjaro located in?"</span>},
            <span class="hljs-string">"outputs"</span>: {<span class="hljs-string">"answer"</span>: <span class="hljs-string">"Mount Kilimanjaro is located in Tanzania."</span>},
        },
        {
            <span class="hljs-string">"inputs"</span>: {<span class="hljs-string">"question"</span>: <span class="hljs-string">"What is Earth's lowest point?"</span>},
            <span class="hljs-string">"outputs"</span>: {<span class="hljs-string">"answer"</span>: <span class="hljs-string">"Earth's lowest point is The Dead Sea."</span>},
        },
    ]

    <span class="hljs-comment"># Add examples to the dataset</span>
    client.create_examples(dataset_id=dataset.<span class="hljs-built_in">id</span>, examples=examples)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Created dataset:"</span>, dataset.name)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<p>运行文件以创建数据集：</p>
<pre><code class="hljs language-bash" lang="bash">python dataset.py
</code></pre>
<h2 data-id="heading-4">创建目标函数</h2>
<p>定义一个包含待评估内容的目标函数（target function）。在本文中，将定义一个目标函数，该函数包含一次用于回答问题的大模型调用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># eval.py</span>
<span class="hljs-keyword">from</span> langsmith <span class="hljs-keyword">import</span> Client, wrappers
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

<span class="hljs-comment"># Wrap the OpenAI client for LangSmith tracing</span>
openai_client = wrappers.wrap_openai(OpenAI())

<span class="hljs-comment"># Define the application logic you want to evaluate inside a target function</span>
<span class="hljs-comment"># The SDK will automatically send the inputs from the dataset to your target function</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">target</span>(<span class="hljs-params">inputs: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    response = openai_client.chat.completions.create(
        model=<span class="hljs-string">"gpt-5-mini"</span>,
        messages=[
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Answer the following question accurately"</span>},
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: inputs[<span class="hljs-string">"question"</span>]},
        ],
    )
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"answer"</span>: response.choices[<span class="hljs-number">0</span>].message.content.strip()}
</code></pre>
<h2 data-id="heading-5">定义评估器</h2>
<p>在本步骤中，你需要告知LangSmith如何为应用程序生成的答案评分。从openevals中导入一个预构建的评估提示词（CORRECTNESS_PROMPT），以及一个辅助工具 —— 该工具会将其封装为 “以 LLM 作为评判者” 的评估器，此评估器将为应用程序的输出打分。
该评估器会对以下三类信息进行对比：
输入（inputs）：传入目标函数的内容（例如，问题文本）。
输出（outputs）：目标函数返回的内容（例如，模型生成的答案）。
参考输出（reference_outputs）：在创建数据集时，你为每个数据集示例附加的基准真值答案（即 “标准答案”）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langsmith <span class="hljs-keyword">import</span> Client, wrappers
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> openevals.llm <span class="hljs-keyword">import</span> create_llm_as_judge
<span class="hljs-keyword">from</span> openevals.prompts <span class="hljs-keyword">import</span> CORRECTNESS_PROMPT

<span class="hljs-comment"># Wrap the OpenAI client for LangSmith tracing</span>
openai_client = wrappers.wrap_openai(OpenAI())

<span class="hljs-comment"># Define the application logic you want to evaluate inside a target function</span>
<span class="hljs-comment"># The SDK will automatically send the inputs from the dataset to your target function</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">target</span>(<span class="hljs-params">inputs: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    response = openai_client.chat.completions.create(
        model=<span class="hljs-string">"gpt-5-mini"</span>,
        messages=[
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Answer the following question accurately"</span>},
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: inputs[<span class="hljs-string">"question"</span>]},
        ],
    )
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"answer"</span>: response.choices[<span class="hljs-number">0</span>].message.content.strip()}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">correctness_evaluator</span>(<span class="hljs-params">inputs: <span class="hljs-built_in">dict</span>, outputs: <span class="hljs-built_in">dict</span>, reference_outputs: <span class="hljs-built_in">dict</span></span>):
    evaluator = create_llm_as_judge(
        prompt=CORRECTNESS_PROMPT,
        model=<span class="hljs-string">"openai:o3-mini"</span>,
        feedback_key=<span class="hljs-string">"correctness"</span>,
    )
    <span class="hljs-keyword">return</span> evaluator(
        inputs=inputs,
        outputs=outputs,
        reference_outputs=reference_outputs
    )
</code></pre>
<h2 data-id="heading-6">运行评估实验</h2>
<p>若要运行评估实验，需调用 evaluate(...) 函数，该函数将执行以下操作：</p>
<ul>
<li>从数据集里提取示例数据。</li>
<li>将每个示例的输入传递至目标函数。</li>
<li>收集输出结果（即模型生成的答案）。</li>
<li>将输出结果与参考输出一同传递至评估器。</li>
<li>在LangSmith中以实验形式记录所有结果，以便你在界面（UI）中查看。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langsmith <span class="hljs-keyword">import</span> Client, wrappers
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> openevals.llm <span class="hljs-keyword">import</span> create_llm_as_judge
<span class="hljs-keyword">from</span> openevals.prompts <span class="hljs-keyword">import</span> CORRECTNESS_PROMPT

<span class="hljs-comment"># Wrap the OpenAI client for LangSmith tracing</span>
openai_client = wrappers.wrap_openai(OpenAI())

<span class="hljs-comment"># Define the application logic you want to evaluate inside a target function</span>
<span class="hljs-comment"># The SDK will automatically send the inputs from the dataset to your target function</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">target</span>(<span class="hljs-params">inputs: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    response = openai_client.chat.completions.create(
        model=<span class="hljs-string">"gpt-5-mini"</span>,
        messages=[
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Answer the following question accurately"</span>},
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: inputs[<span class="hljs-string">"question"</span>]},
        ],
    )
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"answer"</span>: response.choices[<span class="hljs-number">0</span>].message.content.strip()}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">correctness_evaluator</span>(<span class="hljs-params">inputs: <span class="hljs-built_in">dict</span>, outputs: <span class="hljs-built_in">dict</span>, reference_outputs: <span class="hljs-built_in">dict</span></span>):
    evaluator = create_llm_as_judge(
        prompt=CORRECTNESS_PROMPT,
        model=<span class="hljs-string">"openai:o3-mini"</span>,
        feedback_key=<span class="hljs-string">"correctness"</span>,
    )
    <span class="hljs-keyword">return</span> evaluator(
        inputs=inputs,
        outputs=outputs,
        reference_outputs=reference_outputs
    )

<span class="hljs-comment"># After running the evaluation, a link will be provided to view the results in langsmith</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    client = Client()
    experiment_results = client.evaluate(
        target,
        data=<span class="hljs-string">"Sample dataset"</span>,
        evaluators=[
            correctness_evaluator,
            <span class="hljs-comment"># can add multiple evaluators here</span>
        ],
        experiment_prefix=<span class="hljs-string">"first-eval-in-langsmith"</span>,
        max_concurrency=<span class="hljs-number">2</span>,
    )
    <span class="hljs-built_in">print</span>(experiment_results)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 入门实战：音乐专辑管理 API]]></title>    <link>https://juejin.cn/post/7573899782802587694</link>    <guid>https://juejin.cn/post/7573899782802587694</guid>    <pubDate>2025-11-18T10:11:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573899782802587694" data-draft-id="7573988811916148786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 入门实战：音乐专辑管理 API"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-18T10:11:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OlahOlah"/> <meta itemprop="url" content="https://juejin.cn/user/1576016232062667"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 入门实战：音乐专辑管理 API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1576016232062667/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OlahOlah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T10:11:17.000Z" title="Tue Nov 18 2025 10:11:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为 Go 新手，光看语法很难真正掌握编程。通过实践一个小项目，你可以同时了解 <strong>Go 基础语法、数据库操作和 Web 开发</strong>。</p>
<h2 data-id="heading-0">数据库设计</h2>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> music_store;
USE music_store;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> albums (
    id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    artist <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> albums (id, title, artist, price) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-string">'1'</span>, <span class="hljs-string">'Blue Train'</span>, <span class="hljs-string">'John Coltrane'</span>, <span class="hljs-number">56.99</span>),
(<span class="hljs-string">'2'</span>, <span class="hljs-string">'Jeru'</span>, <span class="hljs-string">'Gerry Mulligan'</span>, <span class="hljs-number">17.99</span>),
(<span class="hljs-string">'3'</span>, <span class="hljs-string">'Sarah Vaughan and Clifford Brown'</span>, <span class="hljs-string">'Sarah Vaughan'</span>, <span class="hljs-number">39.99</span>);
</code></pre>
<h2 data-id="heading-1">代码示例</h2>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"net/http"</span>

	<span class="hljs-string">"github.com/gin-gonic/gin"</span>
	<span class="hljs-string">"gorm.io/driver/mysql"</span>
	<span class="hljs-string">"gorm.io/gorm"</span>
)

<span class="hljs-comment">// Album 定义音乐专辑的数据模型</span>
<span class="hljs-keyword">type</span> Album <span class="hljs-keyword">struct</span> {
	ID     <span class="hljs-type">string</span>  <span class="hljs-string">`json:"id" gorm:"primaryKey"`</span> <span class="hljs-comment">// 主键</span>
	Title  <span class="hljs-type">string</span>  <span class="hljs-string">`json:"title"`</span>                <span class="hljs-comment">// 专辑标题</span>
	Artist <span class="hljs-type">string</span>  <span class="hljs-string">`json:"artist"`</span>               <span class="hljs-comment">// 艺术家</span>
	Price  <span class="hljs-type">float64</span> <span class="hljs-string">`json:"price"`</span>                <span class="hljs-comment">// 价格</span>
}

<span class="hljs-keyword">var</span> db *gorm.DB
<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initDB</span><span class="hljs-params">()</span></span> {
	dsn := <span class="hljs-string">"root:123456@tcp(127.0.0.1:3306)/music_store"</span>
	db, err = gorm.Open(mysql.Open(dsn), &amp;gorm.Config{}) <span class="hljs-comment">// 连接数据库</span>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		fmt.Println(<span class="hljs-string">"连接数据库失败:"</span>, err)
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">"连接数据库失败"</span>)
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	initDB()                  <span class="hljs-comment">// 初始化数据库连接</span>
	router := gin.Default()   <span class="hljs-comment">// 创建 Gin 路由实例</span>

	<span class="hljs-comment">// 路由定义</span>
	router.GET(<span class="hljs-string">"/albums"</span>, getAlbums)        <span class="hljs-comment">// 获取所有专辑</span>
	router.GET(<span class="hljs-string">"/albums/:id"</span>, getAlbumByID) <span class="hljs-comment">// 根据 ID 获取专辑</span>
	router.POST(<span class="hljs-string">"/albums"</span>, postAlbum)       <span class="hljs-comment">// 创建新专辑</span>

	router.Run(<span class="hljs-string">"localhost:8080"</span>) <span class="hljs-comment">// 启动 HTTP 服务</span>
}

<span class="hljs-comment">// 获取所有专辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getAlbums</span><span class="hljs-params">(c *gin.Context)</span></span> {
	<span class="hljs-keyword">var</span> albums []Album
	db.Find(&amp;albums)                    <span class="hljs-comment">// 查询所有专辑</span>
	c.IndentedJSON(http.StatusOK, albums) <span class="hljs-comment">// 返回 JSON</span>
}

<span class="hljs-comment">// 根据 ID 获取专辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getAlbumByID</span><span class="hljs-params">(c *gin.Context)</span></span> {
	id := c.Param(<span class="hljs-string">"id"</span>)                 <span class="hljs-comment">// 获取 URL 参数</span>
	<span class="hljs-keyword">var</span> album Album
	db.First(&amp;album, <span class="hljs-string">"id = ?"</span>, id)      <span class="hljs-comment">// 查询指定 ID 的专辑</span>
	c.IndentedJSON(http.StatusOK, album) <span class="hljs-comment">// 返回 JSON</span>
}

<span class="hljs-comment">// 创建新专辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">postAlbum</span><span class="hljs-params">(c *gin.Context)</span></span> {
	<span class="hljs-keyword">var</span> newAlbum Album
	c.BindJSON(&amp;newAlbum)               <span class="hljs-comment">// 解析请求 JSON</span>
	db.Create(&amp;newAlbum)                <span class="hljs-comment">// 插入数据库</span>
	c.IndentedJSON(http.StatusCreated, newAlbum) <span class="hljs-comment">// 返回创建结果</span>
}
</code></pre>
<h2 data-id="heading-2">测试 API</h2>
<p>启动服务后，可使用 <code>curl</code> 测试接口：</p>
<ol>
<li>获取所有专辑：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:8080/albums
</code></pre>
<ol start="2">
<li>获取单个专辑：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:8080/albums/2
</code></pre>
<ol start="3">
<li>新增专辑：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">curl -X POST http://localhost:8080/albums \
-H <span class="hljs-string">"Content-Type: application/json"</span> \
-d <span class="hljs-string">'{"id":"4","title":"New Album","artist":"New Artist","price":29.99}'</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【穿越Effective C++】条款21：必须返回对象时，别妄想返回其reference——对象返回的语义与效率平衡]]></title>    <link>https://juejin.cn/post/7573988811916214322</link>    <guid>https://juejin.cn/post/7573988811916214322</guid>    <pubDate>2025-11-18T10:15:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573988811916214322" data-draft-id="7573710392213815323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【穿越Effective C++】条款21：必须返回对象时，别妄想返回其reference——对象返回的语义与效率平衡"/> <meta itemprop="keywords" content="C++,面试"/> <meta itemprop="datePublished" content="2025-11-18T10:15:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐怡旸"/> <meta itemprop="url" content="https://juejin.cn/user/2875978146656750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【穿越Effective C++】条款21：必须返回对象时，别妄想返回其reference——对象返回的语义与效率平衡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978146656750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐怡旸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T10:15:14.000Z" title="Tue Nov 18 2025 10:15:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个条款揭示了C++函数返回语义的核心原则：当函数必须返回新对象时，应该直接返回值而非引用。试图返回局部对象的引用会导致悬空引用，而返回其他生命周期受控对象的引用则会带来接口复杂性和潜在错误。</p>
<hr/>
<h3 data-id="heading-0"><strong>思维导图：对象返回策略的完整体系</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b84346e6e9c148c0870ef9b038dfc2a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5oCh5pe4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065714&amp;x-signature=YZGfs79PEmf3a6L3b%2FBug7tJolE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1"><strong>关键洞见与行动指南</strong></h3>
<h4 data-id="heading-2"><strong>必须遵守的核心原则：</strong></h4>
<ol>
<li><strong>绝不返回局部对象的引用</strong>：局部对象在函数结束时销毁，返回其引用必然导致悬空引用</li>
<li><strong>优先直接返回对象</strong>：依赖编译器的RVO和移动语义优化，而非手动返回引用</li>
<li><strong>明确所有权语义</strong>：返回值意味着所有权转移，引用意味着共享访问</li>
<li><strong>信任编译器优化</strong>：现代编译器能高效处理对象返回，无需手动优化</li>
</ol>
<h4 data-id="heading-3"><strong>现代C++开发建议：</strong></h4>
<ol>
<li><strong>利用移动语义</strong>：为资源管理类实现移动操作，使返回大对象变得廉价</li>
<li><strong>使用智能指针</strong>：当需要返回动态分配对象时，使用智能指针明确所有权</li>
<li><strong>依赖RVO/NRVO</strong>：直接返回局部对象，让编译器处理优化</li>
<li><strong>避免过度工程</strong>：简单的返回值通常比复杂的引用返回更优</li>
</ol>
<h4 data-id="heading-4"><strong>设计原则总结：</strong></h4>
<ol>
<li><strong>语义正确性原则</strong>：接口行为应该清晰明确，不依赖隐晦的生命周期假设</li>
<li><strong>简单性原则</strong>：最简单的解决方案往往是最正确和最高效的</li>
<li><strong>零开销抽象原则</strong>：在不牺牲性能的前提下提供清晰的抽象</li>
<li><strong>最小惊讶原则</strong>：返回值的行为应该符合用户的合理预期</li>
</ol>
<h4 data-id="heading-5"><strong>需要警惕的陷阱：</strong></h4>
<ol>
<li><strong>悬空引用陷阱</strong>：返回局部stack对象的引用</li>
<li><strong>内存泄漏陷阱</strong>：返回堆对象引用导致无法正确释放</li>
<li><strong>线程安全陷阱</strong>：返回静态对象引用在多线程环境中的竞争</li>
<li><strong>封装破坏陷阱</strong>：返回成员变量引用破坏类的封装性</li>
</ol>
<p><strong>最终建议：</strong> 将对象返回视为语言设计者已经优化过的常见操作。培养"值语义思维"——在需要返回新对象时，直接返回对象值，让编译器的RVO、移动语义和拷贝省略为你工作。只有在确实需要共享现有对象且其生命周期明确受控时，才考虑返回引用。</p>
<p>记住：<strong>在C++中，返回对象值通常是安全、清晰且高效的。试图通过返回引用来优化往往适得其反，引入复杂性和错误。</strong> 条款21教会我们的不仅是一种技术选择，更是对C++对象模型和编译器能力的深刻信任。</p>
<hr/>
<h3 data-id="heading-6"><strong>深入解析：返回引用的致命陷阱</strong></h3>
<h4 data-id="heading-7"><strong>1. 问题根源：悬空引用的必然性</strong></h4>
<p><strong>返回局部对象引用的经典错误：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExpensiveResource</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ExpensiveResource</span>(<span class="hljs-type">const</span> std::string&amp; name) : <span class="hljs-built_in">name_</span>(name) {
        data_.<span class="hljs-built_in">resize</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">42</span>);  <span class="hljs-comment">// 模拟昂贵资源</span>
        std::cout &lt;&lt; <span class="hljs-string">"构造 ExpensiveResource: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
    ~<span class="hljs-built_in">ExpensiveResource</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"析构 ExpensiveResource: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
    <span class="hljs-built_in">ExpensiveResource</span>(<span class="hljs-type">const</span> ExpensiveResource&amp; other) 
        : <span class="hljs-built_in">name_</span>(other.name_ + <span class="hljs-string">"(拷贝)"</span>), <span class="hljs-built_in">data_</span>(other.data_) {
        std::cout &lt;&lt; <span class="hljs-string">"拷贝构造: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
    <span class="hljs-built_in">ExpensiveResource</span>(ExpensiveResource&amp;&amp; other) <span class="hljs-keyword">noexcept</span> 
        : <span class="hljs-built_in">name_</span>(std::<span class="hljs-built_in">move</span>(other.name_)), <span class="hljs-built_in">data_</span>(std::<span class="hljs-built_in">move</span>(other.data_)) {
        std::cout &lt;&lt; <span class="hljs-string">"移动构造: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">use</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"使用资源: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
<span class="hljs-keyword">private</span>:
    std::string name_;
    std::vector&lt;<span class="hljs-type">int</span>&gt; data_;
};

<span class="hljs-comment">// 错误示例1：返回局部对象的引用</span>
<span class="hljs-function"><span class="hljs-type">const</span> ExpensiveResource&amp; <span class="hljs-title">createResourceWrong1</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">ExpensiveResource <span class="hljs-title">local</span><span class="hljs-params">(<span class="hljs-string">"局部资源"</span>)</span></span>;
    <span class="hljs-keyword">return</span> local;  <span class="hljs-comment">// 致命错误：返回局部对象的引用！</span>
}

<span class="hljs-comment">// 错误示例2：返回临时对象的引用  </span>
<span class="hljs-function"><span class="hljs-type">const</span> ExpensiveResource&amp; <span class="hljs-title">createResourceWrong2</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ExpensiveResource</span>(<span class="hljs-string">"临时资源"</span>);  <span class="hljs-comment">// 更糟：返回临时对象的引用！</span>
}

<span class="hljs-comment">// 错误示例3：返回动态分配对象的引用</span>
<span class="hljs-function"><span class="hljs-type">const</span> ExpensiveResource&amp; <span class="hljs-title">createResourceWrong3</span><span class="hljs-params">()</span> </span>{
    ExpensiveResource* resource = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ExpensiveResource</span>(<span class="hljs-string">"堆资源"</span>);
    <span class="hljs-keyword">return</span> *resource;  <span class="hljs-comment">// 内存泄漏！调用者不知道需要delete</span>
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_dangling_references</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"=== 演示悬空引用问题 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 情况1：局部对象引用</span>
    std::cout &lt;&lt; <span class="hljs-string">"1. 返回局部对象引用:"</span> &lt;&lt; std::endl;
    <span class="hljs-type">const</span> ExpensiveResource&amp; ref1 = <span class="hljs-built_in">createResourceWrong1</span>();
    <span class="hljs-comment">// 此时local已销毁，ref1是悬空引用！</span>
    <span class="hljs-comment">// ref1.use();  // 未定义行为！可能崩溃或输出乱码</span>
    
    <span class="hljs-comment">// 情况2：临时对象引用</span>
    std::cout &lt;&lt; <span class="hljs-string">"2. 返回临时对象引用:"</span> &lt;&lt; std::endl;
    <span class="hljs-type">const</span> ExpensiveResource&amp; ref2 = <span class="hljs-built_in">createResourceWrong2</span>();
    <span class="hljs-comment">// 临时对象立即销毁，ref2是悬空引用！</span>
    <span class="hljs-comment">// ref2.use();  // 未定义行为！</span>
    
    <span class="hljs-comment">// 情况3：堆对象引用泄漏</span>
    std::cout &lt;&lt; <span class="hljs-string">"3. 返回堆对象引用:"</span> &lt;&lt; std::endl;
    <span class="hljs-type">const</span> ExpensiveResource&amp; ref3 = <span class="hljs-built_in">createResourceWrong3</span>();
    ref3.<span class="hljs-built_in">use</span>();  <span class="hljs-comment">// 虽然能工作，但内存泄漏！</span>
    <span class="hljs-comment">// 调用者不知道需要delete，也无法正确delete（没有原始指针）</span>
    <span class="hljs-comment">// delete &amp;ref3;  // 可能工作，但接口设计糟糕</span>
    
    std::cout &lt;&lt; <span class="hljs-string">"=== 悬空引用演示结束 ==="</span> &lt;&lt; std::endl;
}
</code></pre>
<h4 data-id="heading-8"><strong>2. 静态对象引用的线程安全问题</strong></h4>
<p><strong>返回静态对象引用的陷阱：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Configuration</span>(<span class="hljs-type">const</span> std::string&amp; name) : <span class="hljs-built_in">name_</span>(name) {
        std::cout &lt;&lt; <span class="hljs-string">"初始化配置: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
        data_ = std::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>);
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">use</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"使用配置: "</span> &lt;&lt; name_ &lt;&lt; <span class="hljs-string">" (数据大小: "</span> &lt;&lt; data_.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">()</span> </span>{
        data_.<span class="hljs-built_in">push_back</span>(<span class="hljs-number">42</span>);  <span class="hljs-comment">// 修改内部状态</span>
        std::cout &lt;&lt; <span class="hljs-string">"修改配置: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
<span class="hljs-keyword">private</span>:
    std::string name_;
    std::vector&lt;<span class="hljs-type">int</span>&gt; data_;
};

<span class="hljs-comment">// 危险的单例模式实现</span>
<span class="hljs-function"><span class="hljs-type">const</span> Configuration&amp; <span class="hljs-title">getGlobalConfig</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function"><span class="hljs-type">static</span> Configuration <span class="hljs-title">config</span><span class="hljs-params">(<span class="hljs-string">"全局配置"</span>)</span></span>;  <span class="hljs-comment">// 第一次调用时构造</span>
    <span class="hljs-keyword">return</span> config;
}

<span class="hljs-comment">// 线程安全的单例模式</span>
<span class="hljs-function">Configuration&amp; <span class="hljs-title">getThreadSafeConfig</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function"><span class="hljs-type">static</span> Configuration <span class="hljs-title">config</span><span class="hljs-params">(<span class="hljs-string">"线程安全配置"</span>)</span></span>;
    <span class="hljs-keyword">return</span> config;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_static_reference_issues</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"=== 静态对象引用问题 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 单线程下看似正常工作</span>
    <span class="hljs-type">const</span> Configuration&amp; config1 = <span class="hljs-built_in">getGlobalConfig</span>();
    config1.<span class="hljs-built_in">use</span>();
    
    <span class="hljs-type">const</span> Configuration&amp; config2 = <span class="hljs-built_in">getGlobalConfig</span>();
    config2.<span class="hljs-built_in">use</span>();  <span class="hljs-comment">// 同一个对象</span>
    
    <span class="hljs-comment">// 多线程环境下的问题</span>
    <span class="hljs-keyword">auto</span> worker = [](<span class="hljs-type">int</span> id) {
        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));
        Configuration&amp; config = <span class="hljs-built_in">getThreadSafeConfig</span>();  <span class="hljs-comment">// 注意：返回非const引用！</span>
        config.<span class="hljs-built_in">modify</span>();  <span class="hljs-comment">// 多个线程可能同时修改！</span>
        std::cout &lt;&lt; <span class="hljs-string">"线程 "</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">" 修改配置"</span> &lt;&lt; std::endl;
    };
    
    std::cout &lt;&lt; <span class="hljs-string">"=== 多线程竞争演示 ==="</span> &lt;&lt; std::endl;
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(worker, <span class="hljs-number">1</span>)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(worker, <span class="hljs-number">2</span>)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t3</span><span class="hljs-params">(worker, <span class="hljs-number">3</span>)</span></span>;
    
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    t3.<span class="hljs-built_in">join</span>();
    
    <span class="hljs-comment">// 数据竞争！未定义行为！</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-9"><strong>解决方案：正确返回对象</strong></h3>
<h4 data-id="heading-10"><strong>1. 直接返回对象值 + 编译器优化</strong></h4>
<p><strong>依赖RVO和移动语义的正确方式：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedReturn</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 正确方式1：返回匿名临时对象 - RVO优化</span>
    <span class="hljs-function"><span class="hljs-type">static</span> ExpensiveResource <span class="hljs-title">createWithRVO</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">ExpensiveResource</span>(<span class="hljs-string">"RVO优化"</span>);  <span class="hljs-comment">// 直接构造到调用者位置</span>
    }
    
    <span class="hljs-comment">// 正确方式2：返回具名局部对象 - NRVO优化</span>
    <span class="hljs-function"><span class="hljs-type">static</span> ExpensiveResource <span class="hljs-title">createWithNRVO</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-function">ExpensiveResource <span class="hljs-title">local</span><span class="hljs-params">(<span class="hljs-string">"NRVO优化"</span>)</span></span>;
        <span class="hljs-comment">// 一些处理...</span>
        local.<span class="hljs-built_in">use</span>();
        <span class="hljs-keyword">return</span> local;  <span class="hljs-comment">// 编译器可能直接构造到调用者位置</span>
    }
    
    <span class="hljs-comment">// 正确方式3：多路径返回 - 仍然可能优化</span>
    <span class="hljs-function"><span class="hljs-type">static</span> ExpensiveResource <span class="hljs-title">createWithMultiplePaths</span><span class="hljs-params">(<span class="hljs-type">int</span> type)</span> </span>{
        <span class="hljs-keyword">if</span> (type == <span class="hljs-number">1</span>) {
            <span class="hljs-function">ExpensiveResource <span class="hljs-title">resource</span><span class="hljs-params">(<span class="hljs-string">"类型1"</span>)</span></span>;
            <span class="hljs-keyword">return</span> resource;  <span class="hljs-comment">// NRVO可能仍然工作</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">ExpensiveResource</span>(<span class="hljs-string">"类型2"</span>);  <span class="hljs-comment">// RVO</span>
        }
    }
    
    <span class="hljs-comment">// 正确方式4：返回移动语义优化的对象</span>
    <span class="hljs-function"><span class="hljs-type">static</span> std::vector&lt;std::string&gt; <span class="hljs-title">createStrings</span><span class="hljs-params">()</span> </span>{
        std::vector&lt;std::string&gt; strings;
        strings.<span class="hljs-built_in">reserve</span>(<span class="hljs-number">100</span>);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; ++i) {
            strings.<span class="hljs-built_in">push_back</span>(<span class="hljs-string">"字符串_"</span> + std::<span class="hljs-built_in">to_string</span>(i));
        }
        
        <span class="hljs-keyword">return</span> strings;  <span class="hljs-comment">// 移动语义或NRVO</span>
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_correct_object_return</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"=== 正确返回对象演示 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 情况1：RVO优化</span>
    std::cout &lt;&lt; <span class="hljs-string">"1. RVO优化返回:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> resource1 = OptimizedReturn::<span class="hljs-built_in">createWithRVO</span>();
    resource1.<span class="hljs-built_in">use</span>();
    
    <span class="hljs-comment">// 情况2：NRVO优化</span>
    std::cout &lt;&lt; <span class="hljs-string">"2. NRVO优化返回:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> resource2 = OptimizedReturn::<span class="hljs-built_in">createWithNRVO</span>();
    resource2.<span class="hljs-built_in">use</span>();
    
    <span class="hljs-comment">// 情况3：多路径返回</span>
    std::cout &lt;&lt; <span class="hljs-string">"3. 多路径返回:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> resource3 = OptimizedReturn::<span class="hljs-built_in">createWithMultiplePaths</span>(<span class="hljs-number">1</span>);
    resource3.<span class="hljs-built_in">use</span>();
    
    <span class="hljs-comment">// 情况4：移动语义优化</span>
    std::cout &lt;&lt; <span class="hljs-string">"4. 移动语义优化:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> strings = OptimizedReturn::<span class="hljs-built_in">createStrings</span>();
    std::cout &lt;&lt; <span class="hljs-string">"创建字符串数量: "</span> &lt;&lt; strings.<span class="hljs-built_in">size</span>() &lt;&lt; std::endl;
    
    std::cout &lt;&lt; <span class="hljs-string">"=== 正确返回演示结束 ==="</span> &lt;&lt; std::endl;
}

<span class="hljs-comment">// 测试编译器优化</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_compiler_optimizations</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 编译器优化验证 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 观察构造/析构调用，验证优化</span>
    std::cout &lt;&lt; <span class="hljs-string">"创建资源..."</span> &lt;&lt; std::endl;
    ExpensiveResource res = OptimizedReturn::<span class="hljs-built_in">createWithRVO</span>();
    std::cout &lt;&lt; <span class="hljs-string">"资源使用中..."</span> &lt;&lt; std::endl;
    res.<span class="hljs-built_in">use</span>();
    std::cout &lt;&lt; <span class="hljs-string">"资源即将销毁..."</span> &lt;&lt; std::endl;
}
</code></pre>
<h4 data-id="heading-11"><strong>2. 移动语义的革命性影响</strong></h4>
<p><strong>移动语义使返回大对象变得廉价：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MoveOptimized</span> {
<span class="hljs-keyword">private</span>:
    std::vector&lt;<span class="hljs-type">int</span>&gt; data_;
    std::string name_;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">MoveOptimized</span>(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">size_t</span> size) 
        : <span class="hljs-built_in">name_</span>(name), <span class="hljs-built_in">data_</span>(size, <span class="hljs-number">42</span>) {
        std::cout &lt;&lt; <span class="hljs-string">"构造 "</span> &lt;&lt; name_ &lt;&lt; <span class="hljs-string">" (大小: "</span> &lt;&lt; data_.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; std::endl;
    }
    
    <span class="hljs-comment">// 移动构造函数 - 关键！</span>
    <span class="hljs-built_in">MoveOptimized</span>(MoveOptimized&amp;&amp; other) <span class="hljs-keyword">noexcept</span> 
        : <span class="hljs-built_in">name_</span>(std::<span class="hljs-built_in">move</span>(other.name_))
        , <span class="hljs-built_in">data_</span>(std::<span class="hljs-built_in">move</span>(other.data_)) {
        std::cout &lt;&lt; <span class="hljs-string">"移动构造 "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
    <span class="hljs-comment">// 移动赋值运算符</span>
    MoveOptimized&amp; <span class="hljs-keyword">operator</span>=(MoveOptimized&amp;&amp; other) <span class="hljs-keyword">noexcept</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != &amp;other) {
            name_ = std::<span class="hljs-built_in">move</span>(other.name_);
            data_ = std::<span class="hljs-built_in">move</span>(other.data_);
            std::cout &lt;&lt; <span class="hljs-string">"移动赋值 "</span> &lt;&lt; name_ &lt;&lt; std::endl;
        }
        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;
    }
    
    <span class="hljs-comment">// 拷贝控制：禁止拷贝（或实现深拷贝）</span>
    <span class="hljs-built_in">MoveOptimized</span>(<span class="hljs-type">const</span> MoveOptimized&amp;) = <span class="hljs-keyword">delete</span>;
    MoveOptimized&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> MoveOptimized&amp;) = <span class="hljs-keyword">delete</span>;
    
    ~<span class="hljs-built_in">MoveOptimized</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"析构 "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">use</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"使用 "</span> &lt;&lt; name_ &lt;&lt; <span class="hljs-string">" (数据: "</span> &lt;&lt; data_.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">" 元素)"</span> &lt;&lt; std::endl;
    }
    
    <span class="hljs-comment">// 工厂方法 - 高效返回</span>
    <span class="hljs-function"><span class="hljs-type">static</span> MoveOptimized <span class="hljs-title">createLargeObject</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; name)</span> </span>{
        <span class="hljs-function">MoveOptimized <span class="hljs-title">obj</span><span class="hljs-params">(name, <span class="hljs-number">1000000</span>)</span></span>;  <span class="hljs-comment">// 百万元素！</span>
        <span class="hljs-comment">// 一些处理...</span>
        <span class="hljs-keyword">return</span> obj;  <span class="hljs-comment">// NRVO或移动语义</span>
    }
    
    <span class="hljs-comment">// 返回处理后的对象</span>
    <span class="hljs-function">MoveOptimized <span class="hljs-title">process</span><span class="hljs-params">()</span> &amp;&amp; </span>{  <span class="hljs-comment">// 右值引用限定符</span>
        std::cout &lt;&lt; <span class="hljs-string">"处理右值对象: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
        std::<span class="hljs-built_in">transform</span>(data_.<span class="hljs-built_in">begin</span>(), data_.<span class="hljs-built_in">end</span>(), data_.<span class="hljs-built_in">begin</span>(),
                      [](<span class="hljs-type">int</span> x) { <span class="hljs-keyword">return</span> x * <span class="hljs-number">2</span>; });
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">move</span>(*<span class="hljs-keyword">this</span>);  <span class="hljs-comment">// 显式移动</span>
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_move_semantics</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"=== 移动语义演示 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 情况1：移动构造优化</span>
    std::cout &lt;&lt; <span class="hljs-string">"1. 工厂方法返回:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> obj1 = MoveOptimized::<span class="hljs-built_in">createLargeObject</span>(<span class="hljs-string">"大对象1"</span>);
    obj1.<span class="hljs-built_in">use</span>();
    
    <span class="hljs-comment">// 情况2：链式移动操作</span>
    std::cout &lt;&lt; <span class="hljs-string">"2. 链式处理:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> obj2 = MoveOptimized::<span class="hljs-built_in">createLargeObject</span>(<span class="hljs-string">"大对象2"</span>).<span class="hljs-built_in">process</span>();
    obj2.<span class="hljs-built_in">use</span>();
    
    <span class="hljs-comment">// 情况3：容器中的移动</span>
    std::cout &lt;&lt; <span class="hljs-string">"3. 容器存储:"</span> &lt;&lt; std::endl;
    std::vector&lt;MoveOptimized&gt; objects;
    objects.<span class="hljs-built_in">reserve</span>(<span class="hljs-number">3</span>);
    
    <span class="hljs-comment">// 使用emplace_back或移动插入</span>
    objects.<span class="hljs-built_in">push_back</span>(MoveOptimized::<span class="hljs-built_in">createLargeObject</span>(<span class="hljs-string">"容器对象1"</span>));
    objects.<span class="hljs-built_in">emplace_back</span>(<span class="hljs-string">"容器对象2"</span>, <span class="hljs-number">500000</span>);  <span class="hljs-comment">// 原位构造</span>
    
    std::cout &lt;&lt; <span class="hljs-string">"容器大小: "</span> &lt;&lt; objects.<span class="hljs-built_in">size</span>() &lt;&lt; std::endl;
    
    std::cout &lt;&lt; <span class="hljs-string">"=== 移动语义演示结束 ==="</span> &lt;&lt; std::endl;
}
</code></pre>
<hr/>
<h3 data-id="heading-12"><strong>智能指针的正确使用</strong></h3>
<h4 data-id="heading-13"><strong>1. 工厂模式与所有权转移</strong></h4>
<p><strong>明确所有权的智能指针返回：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdexcept&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PolymorphicBase</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">PolymorphicBase</span>() = <span class="hljs-keyword">default</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::unique_ptr&lt;PolymorphicBase&gt; <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteA</span> : <span class="hljs-keyword">public</span> PolymorphicBase {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ConcreteA</span>() { std::cout &lt;&lt; <span class="hljs-string">"构造 ConcreteA"</span> &lt;&lt; std::endl; }
    ~<span class="hljs-built_in">ConcreteA</span>() <span class="hljs-keyword">override</span> { std::cout &lt;&lt; <span class="hljs-string">"析构 ConcreteA"</span> &lt;&lt; std::endl; }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"ConcreteA::execute"</span> &lt;&lt; std::endl;
    }
    
    <span class="hljs-function">std::unique_ptr&lt;PolymorphicBase&gt; <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;ConcreteA&gt;(*<span class="hljs-keyword">this</span>);
    }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteB</span> : <span class="hljs-keyword">public</span> PolymorphicBase {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">ConcreteB</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> : value_(value) {</span>
        std::cout &lt;&lt; <span class="hljs-string">"构造 ConcreteB: "</span> &lt;&lt; value_ &lt;&lt; std::endl;
    }
    ~<span class="hljs-built_in">ConcreteB</span>() <span class="hljs-keyword">override</span> { std::cout &lt;&lt; <span class="hljs-string">"析构 ConcreteB"</span> &lt;&lt; std::endl; }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"ConcreteB::execute: "</span> &lt;&lt; value_ &lt;&lt; std::endl;
    }
    
    <span class="hljs-function">std::unique_ptr&lt;PolymorphicBase&gt; <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;ConcreteB&gt;(*<span class="hljs-keyword">this</span>);
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> value_;
};

<span class="hljs-comment">// 正确的工厂模式实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectFactory</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 返回unique_ptr - 明确所有权转移</span>
    <span class="hljs-function"><span class="hljs-type">static</span> std::unique_ptr&lt;PolymorphicBase&gt; <span class="hljs-title">createObject</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; type)</span> </span>{
        <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"A"</span>) {
            <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;ConcreteA&gt;();
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"B"</span>) {
            <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;ConcreteB&gt;(<span class="hljs-number">42</span>);
        }
        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">"未知类型: "</span> + type);
    }
    
    <span class="hljs-comment">// 返回shared_ptr - 共享所有权</span>
    <span class="hljs-function"><span class="hljs-type">static</span> std::shared_ptr&lt;PolymorphicBase&gt; <span class="hljs-title">createSharedObject</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; type)</span> </span>{
        <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"A"</span>) {
            <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_shared</span>&lt;ConcreteA&gt;();
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"B"</span>) {
            <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_shared</span>&lt;ConcreteB&gt;(<span class="hljs-number">100</span>);
        }
        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">"未知类型: "</span> + type);
    }
    
    <span class="hljs-comment">// 返回unique_ptr的容器</span>
    <span class="hljs-type">static</span> std::vector&lt;std::unique_ptr&lt;PolymorphicBase&gt;&gt; <span class="hljs-built_in">createObjectCollection</span>() {
        std::vector&lt;std::unique_ptr&lt;PolymorphicBase&gt;&gt; objects;
        objects.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">make_unique</span>&lt;ConcreteA&gt;());
        objects.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">make_unique</span>&lt;ConcreteB&gt;(<span class="hljs-number">1</span>));
        objects.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">make_unique</span>&lt;ConcreteB&gt;(<span class="hljs-number">2</span>));
        <span class="hljs-keyword">return</span> objects;  <span class="hljs-comment">// 移动语义！</span>
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_smart_pointer_factory</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"=== 智能指针工厂演示 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 情况1：unique_ptr工厂</span>
    std::cout &lt;&lt; <span class="hljs-string">"1. unique_ptr工厂:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> obj1 = ObjectFactory::<span class="hljs-built_in">createObject</span>(<span class="hljs-string">"A"</span>);
    obj1-&gt;<span class="hljs-built_in">execute</span>();
    
    <span class="hljs-keyword">auto</span> obj2 = ObjectFactory::<span class="hljs-built_in">createObject</span>(<span class="hljs-string">"B"</span>);
    obj2-&gt;<span class="hljs-built_in">execute</span>();
    
    <span class="hljs-comment">// 情况2：shared_ptr工厂</span>
    std::cout &lt;&lt; <span class="hljs-string">"2. shared_ptr工厂:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> shared1 = ObjectFactory::<span class="hljs-built_in">createSharedObject</span>(<span class="hljs-string">"A"</span>);
    <span class="hljs-keyword">auto</span> shared2 = shared1;  <span class="hljs-comment">// 共享所有权</span>
    shared1-&gt;<span class="hljs-built_in">execute</span>();
    shared2-&gt;<span class="hljs-built_in">execute</span>();
    
    std::cout &lt;&lt; <span class="hljs-string">"共享引用计数: "</span> &lt;&lt; shared1.<span class="hljs-built_in">use_count</span>() &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 情况3：对象集合</span>
    std::cout &lt;&lt; <span class="hljs-string">"3. 对象集合:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> collection = ObjectFactory::<span class="hljs-built_in">createObjectCollection</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; obj : collection) {
        obj-&gt;<span class="hljs-built_in">execute</span>();
    }
    
    <span class="hljs-comment">// 情况4：克隆模式</span>
    std::cout &lt;&lt; <span class="hljs-string">"4. 克隆模式:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> original = ObjectFactory::<span class="hljs-built_in">createObject</span>(<span class="hljs-string">"A"</span>);
    <span class="hljs-keyword">auto</span> cloned = original-&gt;<span class="hljs-built_in">clone</span>();
    original-&gt;<span class="hljs-built_in">execute</span>();
    cloned-&gt;<span class="hljs-built_in">execute</span>();
    
    std::cout &lt;&lt; <span class="hljs-string">"=== 智能指针工厂结束 ==="</span> &lt;&lt; std::endl;
}
</code></pre>
<h4 data-id="heading-14"><strong>2. 构建器模式的流畅接口</strong></h4>
<p><strong>返回*this引用的正确使用场景：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sstream&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span>;  <span class="hljs-comment">// 前向声明</span>
    
    <span class="hljs-comment">// 只能通过Builder构造</span>
    <span class="hljs-function"><span class="hljs-type">static</span> Builder <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">Builder</span>(); }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"连接到: "</span> &lt;&lt; host_ &lt;&lt; <span class="hljs-string">":"</span> &lt;&lt; port_ 
                  &lt;&lt; <span class="hljs-string">" 用户: "</span> &lt;&lt; username_ &lt;&lt; std::endl;
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-built_in">DatabaseConnection</span>() = <span class="hljs-keyword">default</span>;
    
    std::string host_;
    <span class="hljs-type">int</span> port_ = <span class="hljs-number">3306</span>;
    std::string username_;
    std::string password_;
    <span class="hljs-type">int</span> timeout_ = <span class="hljs-number">30</span>;
    
    <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span>::Builder {
<span class="hljs-keyword">private</span>:
    std::unique_ptr&lt;DatabaseConnection&gt; connection_;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Builder</span>() : <span class="hljs-built_in">connection_</span>(std::<span class="hljs-built_in">make_unique</span>&lt;DatabaseConnection&gt;()) {}
    
    <span class="hljs-comment">// 流畅接口 - 返回Builder&amp;引用</span>
    <span class="hljs-function">Builder&amp; <span class="hljs-title">setHost</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; host)</span> </span>{
        connection_-&gt;host_ = host;
        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;
    }
    
    <span class="hljs-function">Builder&amp; <span class="hljs-title">setPort</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> </span>{
        <span class="hljs-keyword">if</span> (port &lt;= <span class="hljs-number">0</span> || port &gt; <span class="hljs-number">65535</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">"端口无效"</span>);
        }
        connection_-&gt;port_ = port;
        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;
    }
    
    <span class="hljs-function">Builder&amp; <span class="hljs-title">setCredentials</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; username, <span class="hljs-type">const</span> std::string&amp; password)</span> </span>{
        connection_-&gt;username_ = username;
        connection_-&gt;password_ = password;
        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;
    }
    
    <span class="hljs-function">Builder&amp; <span class="hljs-title">setTimeout</span><span class="hljs-params">(<span class="hljs-type">int</span> timeout)</span> </span>{
        <span class="hljs-keyword">if</span> (timeout &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">"超时无效"</span>);
        }
        connection_-&gt;timeout_ = timeout;
        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;
    }
    
    <span class="hljs-comment">// 关键：返回unique_ptr，明确所有权转移</span>
    <span class="hljs-function">std::unique_ptr&lt;DatabaseConnection&gt; <span class="hljs-title">build</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 验证必填参数</span>
        <span class="hljs-keyword">if</span> (connection_-&gt;host_.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">logic_error</span>(<span class="hljs-string">"必须设置主机"</span>);
        }
        <span class="hljs-keyword">if</span> (connection_-&gt;username_.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">logic_error</span>(<span class="hljs-string">"必须设置用户名"</span>);
        }
        
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">move</span>(connection_);  <span class="hljs-comment">// 转移所有权</span>
    }
    
    <span class="hljs-comment">// 返回shared_ptr的版本</span>
    <span class="hljs-function">std::shared_ptr&lt;DatabaseConnection&gt; <span class="hljs-title">buildShared</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">move</span>(connection_);  <span class="hljs-comment">// 从unique_ptr转换</span>
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_builder_pattern</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"=== 构建器模式演示 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 流畅接口构建</span>
        <span class="hljs-keyword">auto</span> connection = DatabaseConnection::<span class="hljs-built_in">create</span>()
            .<span class="hljs-built_in">setHost</span>(<span class="hljs-string">"localhost"</span>)
            .<span class="hljs-built_in">setPort</span>(<span class="hljs-number">3306</span>)
            .<span class="hljs-built_in">setCredentials</span>(<span class="hljs-string">"admin"</span>, <span class="hljs-string">"secret"</span>)
            .<span class="hljs-built_in">setTimeout</span>(<span class="hljs-number">60</span>)
            .<span class="hljs-built_in">build</span>();  <span class="hljs-comment">// 返回unique_ptr</span>
        
        connection-&gt;<span class="hljs-built_in">connect</span>();
        
        <span class="hljs-comment">// shared_ptr版本</span>
        <span class="hljs-keyword">auto</span> shared_connection = DatabaseConnection::<span class="hljs-built_in">create</span>()
            .<span class="hljs-built_in">setHost</span>(<span class="hljs-string">"127.0.0.1"</span>)
            .<span class="hljs-built_in">setPort</span>(<span class="hljs-number">5432</span>)
            .<span class="hljs-built_in">setCredentials</span>(<span class="hljs-string">"user"</span>, <span class="hljs-string">"pass"</span>)
            .<span class="hljs-built_in">buildShared</span>();
        
        shared_connection-&gt;<span class="hljs-built_in">connect</span>();
        
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cout &lt;&lt; <span class="hljs-string">"构建错误: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
    }
    
    std::cout &lt;&lt; <span class="hljs-string">"=== 构建器模式结束 ==="</span> &lt;&lt; std::endl;
}
</code></pre>
<hr/>
<h3 data-id="heading-15"><strong>编译器优化的信任与验证</strong></h3>
<h4 data-id="heading-16"><strong>1. RVO/NRVO的实际验证</strong></h4>
<p><strong>测试编译器优化能力：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizationTest</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">OptimizationTest</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"默认构造"</span> &lt;&lt; std::endl;
    }
    
    <span class="hljs-built_in">OptimizationTest</span>(<span class="hljs-type">const</span> OptimizationTest&amp; other) {
        std::cout &lt;&lt; <span class="hljs-string">"拷贝构造"</span> &lt;&lt; std::endl;
    }
    
    <span class="hljs-built_in">OptimizationTest</span>(OptimizationTest&amp;&amp; other) <span class="hljs-keyword">noexcept</span> {
        std::cout &lt;&lt; <span class="hljs-string">"移动构造"</span> &lt;&lt; std::endl;
    }
    
    ~<span class="hljs-built_in">OptimizationTest</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"析构"</span> &lt;&lt; std::endl;
    }
};

<span class="hljs-comment">// 测试各种返回场景</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizationDemonstrator</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 场景1：RVO - 返回匿名临时对象</span>
    <span class="hljs-function"><span class="hljs-type">static</span> OptimizationTest <span class="hljs-title">testRVO</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">OptimizationTest</span>();  <span class="hljs-comment">// 应该只有一次构造</span>
    }
    
    <span class="hljs-comment">// 场景2：NRVO - 返回具名局部对象</span>
    <span class="hljs-function"><span class="hljs-type">static</span> OptimizationTest <span class="hljs-title">testNRVO</span><span class="hljs-params">()</span> </span>{
        OptimizationTest local;
        <span class="hljs-keyword">return</span> local;  <span class="hljs-comment">// 应该只有一次构造</span>
    }
    
    <span class="hljs-comment">// 场景3：多路径返回</span>
    <span class="hljs-function"><span class="hljs-type">static</span> OptimizationTest <span class="hljs-title">testMultiplePaths</span><span class="hljs-params">(<span class="hljs-type">bool</span> flag)</span> </span>{
        <span class="hljs-keyword">if</span> (flag) {
            OptimizationTest local1;
            <span class="hljs-keyword">return</span> local1;  <span class="hljs-comment">// NRVO可能工作</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">OptimizationTest</span>();  <span class="hljs-comment">// RVO</span>
        }
    }
    
    <span class="hljs-comment">// 场景4：阻止NRVO - 使用std::move</span>
    <span class="hljs-function"><span class="hljs-type">static</span> OptimizationTest <span class="hljs-title">testBlockedNRVO</span><span class="hljs-params">()</span> </span>{
        OptimizationTest local;
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">move</span>(local);  <span class="hljs-comment">// 阻止NRVO，强制移动构造</span>
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_optimization_verification</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"=== 编译器优化验证 ==="</span> &lt;&lt; std::endl;
    
    std::cout &lt;&lt; <span class="hljs-string">"1. RVO测试:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> obj1 = OptimizationDemonstrator::<span class="hljs-built_in">testRVO</span>();
    
    std::cout &lt;&lt; <span class="hljs-string">"2. NRVO测试:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> obj2 = OptimizationDemonstrator::<span class="hljs-built_in">testNRVO</span>();
    
    std::cout &lt;&lt; <span class="hljs-string">"3. 多路径测试:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> obj3 = OptimizationDemonstrator::<span class="hljs-built_in">testMultiplePaths</span>(<span class="hljs-literal">true</span>);
    
    std::cout &lt;&lt; <span class="hljs-string">"4. 阻止NRVO测试:"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">auto</span> obj4 = OptimizationDemonstrator::<span class="hljs-built_in">testBlockedNRVO</span>();
    
    std::cout &lt;&lt; <span class="hljs-string">"=== 优化验证结束 ==="</span> &lt;&lt; std::endl;
}

<span class="hljs-comment">// 性能基准测试</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceTest</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">static</span> std::vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">createVectorByValue</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span> </span>{
        std::vector&lt;<span class="hljs-type">int</span>&gt; vec;
        vec.<span class="hljs-built_in">reserve</span>(size);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; size; ++i) {
            vec.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(i));
        }
        <span class="hljs-keyword">return</span> vec;  <span class="hljs-comment">// NRVO或移动语义</span>
    }
    
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">benchmark</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> size = <span class="hljs-number">1000000</span>;
        <span class="hljs-type">const</span> <span class="hljs-type">int</span> iterations = <span class="hljs-number">100</span>;
        
        std::cout &lt;&lt; <span class="hljs-string">"=== 性能基准测试 ==="</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="hljs-string">"向量大小: "</span> &lt;&lt; size &lt;&lt; <span class="hljs-string">", 迭代次数: "</span> &lt;&lt; iterations &lt;&lt; std::endl;
        
        <span class="hljs-keyword">auto</span> start = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; iterations; ++i) {
            <span class="hljs-keyword">auto</span> vec = <span class="hljs-built_in">createVectorByValue</span>(size);
            <span class="hljs-comment">// 使用vec...</span>
            (<span class="hljs-type">void</span>)vec.<span class="hljs-built_in">size</span>();  <span class="hljs-comment">// 防止优化</span>
        }
        
        <span class="hljs-keyword">auto</span> end = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();
        <span class="hljs-keyword">auto</span> duration = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(end - start);
        
        std::cout &lt;&lt; <span class="hljs-string">"总耗时: "</span> &lt;&lt; duration.<span class="hljs-built_in">count</span>() &lt;&lt; <span class="hljs-string">"ms"</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="hljs-string">"平均每次: "</span> &lt;&lt; duration.<span class="hljs-built_in">count</span>() / <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">double</span>&gt;(iterations) &lt;&lt; <span class="hljs-string">"ms"</span> &lt;&lt; std::endl;
    }
};
</code></pre>
<hr/>
<h3 data-id="heading-17"><strong>现代C++的最佳实践总结</strong></h3>
<p><strong>最终决策框架与示例：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModernBestPractices</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 规则1：小型对象直接返回值</span>
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">calculateSum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> a + b;  <span class="hljs-comment">// 内置类型直接返回</span>
    }
    
    <span class="hljs-comment">// 规则2：标准库容器依赖移动语义</span>
    <span class="hljs-function">std::vector&lt;std::string&gt; <span class="hljs-title">getStrings</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"hello"</span>, <span class="hljs-string">"world"</span>, <span class="hljs-string">"modern"</span>, <span class="hljs-string">"C++"</span>};  <span class="hljs-comment">// 移动语义优化</span>
    }
    
    <span class="hljs-comment">// 规则3：自定义大对象实现移动语义</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">LargeData</span> {
    <span class="hljs-keyword">public</span>:
        <span class="hljs-built_in">LargeData</span>() = <span class="hljs-keyword">default</span>;
        <span class="hljs-built_in">LargeData</span>(LargeData&amp;&amp;) <span class="hljs-keyword">noexcept</span> = <span class="hljs-keyword">default</span>;
        LargeData&amp; <span class="hljs-keyword">operator</span>=(LargeData&amp;&amp;) <span class="hljs-keyword">noexcept</span> = <span class="hljs-keyword">default</span>;
        
        <span class="hljs-comment">// 禁止拷贝（或实现深拷贝）</span>
        <span class="hljs-built_in">LargeData</span>(<span class="hljs-type">const</span> LargeData&amp;) = <span class="hljs-keyword">delete</span>;
        LargeData&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> LargeData&amp;) = <span class="hljs-keyword">delete</span>;
        
        <span class="hljs-function"><span class="hljs-type">static</span> LargeData <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>{
            LargeData data;
            <span class="hljs-comment">// 初始化...</span>
            <span class="hljs-keyword">return</span> data;  <span class="hljs-comment">// NRVO或移动</span>
        }
    };
    
    <span class="hljs-comment">// 规则4：多态对象返回智能指针</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::unique_ptr&lt;ModernBestPractices&gt; <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;ModernBestPractices&gt;(*<span class="hljs-keyword">this</span>);
    }
    
    <span class="hljs-comment">// 规则5：工厂方法返回unique_ptr</span>
    <span class="hljs-function"><span class="hljs-type">static</span> std::unique_ptr&lt;ModernBestPractices&gt; <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;ModernBestPractices&gt;();
    }
    
    <span class="hljs-comment">// 规则6：构建器返回对象值或智能指针</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">public</span>:
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {
        <span class="hljs-keyword">public</span>:
            <span class="hljs-function">Builder&amp; <span class="hljs-title">setValue</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> </span>{ value_ = val; <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>; }
            
            <span class="hljs-function">Config <span class="hljs-title">build</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">Config</span>(value_);  <span class="hljs-comment">// 返回值</span>
            }
            
            <span class="hljs-function">std::unique_ptr&lt;Config&gt; <span class="hljs-title">buildUnique</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
                <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;Config&gt;(value_);  <span class="hljs-comment">// 返回智能指针</span>
            }
            
        <span class="hljs-keyword">private</span>:
            <span class="hljs-type">int</span> value_ = <span class="hljs-number">0</span>;
        };
        
    <span class="hljs-keyword">private</span>:
        <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">Config</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> : value_(value) {</span>}
        <span class="hljs-type">int</span> value_;
    };
};

<span class="hljs-comment">// 最终建议的实用模板</span>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectCreator</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 通用工厂方法</span>
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span>... Args&gt;
    <span class="hljs-type">static</span> T <span class="hljs-title">create</span><span class="hljs-params">(Args&amp;&amp;... args)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">T</span>(std::forward&lt;Args&gt;(args)...);  <span class="hljs-comment">// 完美转发 + RVO</span>
    }
    
    <span class="hljs-comment">// 智能指针工厂</span>
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span>... Args&gt;
    <span class="hljs-type">static</span> std::unique_ptr&lt;T&gt; <span class="hljs-title">createUnique</span><span class="hljs-params">(Args&amp;&amp;... args)</span> </span>{
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;T&gt;(std::forward&lt;Args&gt;(args)...);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span>... Args&gt;
    <span class="hljs-type">static</span> std::shared_ptr&lt;T&gt; <span class="hljs-title">createShared</span><span class="hljs-params">(Args&amp;&amp;... args)</span> </span>{
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_shared</span>&lt;T&gt;(std::forward&lt;Args&gt;(args)...);
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_modern_best_practices</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"=== 现代C++最佳实践 ==="</span> &lt;&lt; std::endl;
    
    ModernBestPractices practices;
    
    <span class="hljs-comment">// 1. 小型对象返回值</span>
    <span class="hljs-type">int</span> sum = practices.<span class="hljs-built_in">calculateSum</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
    std::cout &lt;&lt; <span class="hljs-string">"和: "</span> &lt;&lt; sum &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 2. 容器移动语义</span>
    <span class="hljs-keyword">auto</span> strings = practices.<span class="hljs-built_in">getStrings</span>();
    std::cout &lt;&lt; <span class="hljs-string">"字符串数量: "</span> &lt;&lt; strings.<span class="hljs-built_in">size</span>() &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 3. 大对象移动语义</span>
    <span class="hljs-keyword">auto</span> largeData = ModernBestPractices::LargeData::<span class="hljs-built_in">create</span>();
    
    <span class="hljs-comment">// 4. 智能指针工厂</span>
    <span class="hljs-keyword">auto</span> obj = ModernBestPractices::<span class="hljs-built_in">create</span>();
    <span class="hljs-keyword">auto</span> cloned = obj-&gt;<span class="hljs-built_in">clone</span>();
    
    <span class="hljs-comment">// 5. 构建器模式</span>
    <span class="hljs-keyword">auto</span> config1 = ModernBestPractices::Config::<span class="hljs-built_in">Builder</span>().<span class="hljs-built_in">setValue</span>(<span class="hljs-number">42</span>).<span class="hljs-built_in">build</span>();
    <span class="hljs-keyword">auto</span> config2 = ModernBestPractices::Config::<span class="hljs-built_in">Builder</span>().<span class="hljs-built_in">setValue</span>(<span class="hljs-number">100</span>).<span class="hljs-built_in">buildUnique</span>();
    
    <span class="hljs-comment">// 6. 通用对象创建器</span>
    <span class="hljs-keyword">auto</span> created = ObjectCreator&lt;std::vector&lt;<span class="hljs-type">int</span>&gt;&gt;::<span class="hljs-built_in">create</span>(<span class="hljs-number">10</span>, <span class="hljs-number">42</span>);
    std::cout &lt;&lt; <span class="hljs-string">"创建的向量大小: "</span> &lt;&lt; created.<span class="hljs-built_in">size</span>() &lt;&lt; std::endl;
    
    std::cout &lt;&lt; <span class="hljs-string">"=== 最佳实践演示结束 ==="</span> &lt;&lt; std::endl;
}

<span class="hljs-comment">// 最终的性能建议验证</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">final_performance_advice</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 最终性能建议 ==="</span> &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"1. 默认直接返回对象值"</span> &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"2. 为资源管理类实现移动语义"</span> &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"3. 多态对象使用智能指针工厂"</span> &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"4. 信任编译器的RVO/NRVO优化"</span> &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"5. 实际测量性能，而非猜测"</span> &lt;&lt; std::endl;
    
    PerformanceTest::<span class="hljs-built_in">benchmark</span>();
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">demonstrate_dangling_references</span>();
    <span class="hljs-built_in">demonstrate_static_reference_issues</span>();
    <span class="hljs-built_in">demonstrate_correct_object_return</span>();
    <span class="hljs-built_in">demonstrate_move_semantics</span>();
    <span class="hljs-built_in">demonstrate_smart_pointer_factory</span>();
    <span class="hljs-built_in">demonstrate_builder_pattern</span>();
    <span class="hljs-built_in">demonstrate_optimization_verification</span>();
    <span class="hljs-built_in">demonstrate_modern_best_practices</span>();
    <span class="hljs-built_in">final_performance_advice</span>();
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>通过以上全面分析，我们深刻理解了条款21的核心智慧：当必须返回新对象时，应该直接返回对象值，而非试图通过返回引用来优化。现代C++的编译器优化（RVO/NRVO）和语言特性（移动语义）已经使得对象返回变得高效，而试图手动优化往往引入复杂性和错误。正确的做法是信任语言设计者和编译器，编写语义清晰、正确性有保证的代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[本地 AI Code Review 探索及落地]]></title>    <link>https://juejin.cn/post/7573680361990750248</link>    <guid>https://juejin.cn/post/7573680361990750248</guid>    <pubDate>2025-11-18T10:15:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573680361990750248" data-draft-id="7573679820632604707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="本地 AI Code Review 探索及落地"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2025-11-18T10:15:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三金得鑫"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335130216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            本地 AI Code Review 探索及落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335130216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三金得鑫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T10:15:56.000Z" title="Tue Nov 18 2025 10:15:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近期在参与实现本地 AI Code Review 的事情，以下是一些思考输出。感兴趣的小伙伴可以在评论区一起讨论～</p>
<h3 data-id="heading-0">引言</h3>
<p>从 AI Code Review 的目的上看，我们更多的是需要增强代码的健壮性和稳定性，然后是代码的可读性及保证风格统一，持续推进项目标准化、规范化。</p>
<p>这样既能保证发布后的产品稳定，又能确保项目可以有节奏地、清晰地进行演进，还能让其他同学在 CR 过程中取长补短、查漏补缺，进行自我提升。</p>
<h3 data-id="heading-1">目标</h3>
<p>那有哪些问题是我们需要在 CR 中找出并必须让同学进行修改的？我认为有以下几种：</p>
<ul>
<li>明显的语法问题、边界问题、异常处理、竞态问题等；</li>
<li>潜在的逻辑漏洞或者其他 bug；</li>
<li>业务逻辑耦合，可读性和可维护性差！</li>
<li>不符合项目规范，代码风格差异大；</li>
<li>存在安全漏洞；</li>
<li>代码变更风险等级：主要通过静态分析来进行评估，分为深度和广度。
<ul>
<li>深度：比如该代码属于基础函数，被多个其他函数所使用；</li>
<li>广度：比如该代码属于公共函数，被多个模块所使用；</li>
<li>其实从业务层面来讲，这里也可以 hack 一些风险数据，不同的模块会命中不同的风险等级；</li>
</ul>
</li>
</ul>
<p>而 CR 本身也应该从两个维度进行：</p>
<ul>
<li>个人本地 CR（AI 主力 - 模型为 GLM 4.6）
<ul>
<li>缺点：高频触发 CR，耗费时间</li>
<li>解决：制定一些软链、工具或者直接脚本，将是否触发交给开发人员。但默认需要触发！</li>
</ul>
</li>
<li>团队 CR（AI + 人工协作）</li>
</ul>
<h3 data-id="heading-2">应该</h3>
<p>在实际过程中，我们应该参考或者遵循以 Spec 驱动的方式来制定 CR 规范。比如通用的 CR 规则 + 项目编码规范和工作流程 + 团队内部知识库积累。</p>
<blockquote>
<p>如果并没有项目规范和知识库，我们需要同时推动规范落地和知识积累。从长远收益来看，它是非常有必要的。</p>
</blockquote>
<p>这里列举一些比较常规的 Spec：</p>
<ul>
<li>项目编码规范；</li>
<li>内部框架或当前使用框架文档；</li>
<li>最佳 Code Style 以及优秀的案例文档；</li>
<li>遵循 MR（Merge Request）规则，明确规定需要使用 Git 的哪些命令获取正确的 diff 文件和内容；</li>
<li>其他</li>
</ul>
<h3 data-id="heading-3">需要了解的前置知识</h3>
<p>既然要实现 Code Review，那么就需要知道 Code Review 的时机以及内容。</p>
<p>通常来说，我们一般只有在提交完代码，并发起一个 Merge Request （MR）的时候，才会触发 Code Review。而需要评审的内容：是自开发分支从指定分支（比如 master 或者 main）分叉以来的增量代码（避免把指定分支上最新的变更都算进来）。</p>
<p>可以认为是在本地以 merge-base 为基准的三点比较，这是与 PR/MR 最接近的 Diff 手段。同时还需要启用 -M（重命名检测）和 -C（复制检测），避免混入一些不必要的文件内容到 CR 当中。</p>
<p>对于本地 AI CR 来说，我们把 CR 时机放在 pre-commit 这一环节，那 CR 的内容就是「已提交的内容 + 暂存区」的内容，最简单的实现方式就是：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">计算变更基线</span>
BASE=$(git merge-base origin/master HEAD)
<span class="hljs-meta prompt_">
# </span><span class="bash">查看差异文件</span>
git diff --name-only --cached "$BASE"
<span class="hljs-meta prompt_">
# </span><span class="bash">查看完整补丁</span>
git diff --cached -M -C "$BASE"
</code></pre>
<p><strong>用 merge-base 作为变更基线的什么意思呢？</strong></p>
<p>要知道在做分支比较时，我们不会直接拿 master 的快照来当左侧基线，而是先找到 master 与当前分支的“共同祖先”（通常来说就是分支分叉点），使用它来作为对比起点。这样得到的差异就是——从分支创建以来你真正引入的改动，从而避免被 master 分支上后续 push 进去的代码提交所污染。</p>
<p>用 merge-base 就是获取该分叉点的主要手段，<code>git diff master...HEAD</code> （或者 <code>git merge-base master HEAD</code>) 只会展示——从分叉点到你当前分支头部的增量，在 PR/MR 中基本都采用这种三点（...）语义。</p>
<p><strong>为什么要在 pre-commit 发起 AI CR？</strong></p>
<ul>
<li>很多开发者都有一些“陋习”，只管码代码，不自测。这就导致一些很低级的代码问题被提交到仓库；</li>
<li>开发任我行，和项目编码规范偏差十万八千里，在整个项目“一枝独秀”；</li>
<li>能 “run” 不能看，业务耦合度堪称防御性输出典范——谁敢动我的代码试试！</li>
<li>「commit-push -&gt; CR -&gt; 修改」流程，往返好几遍才达到发布标准；评审人员也无法保证立即 CR 你的代码，整个流程下来费时费力</li>
</ul>
<p>综上，我们在 pre-commit 环节借助 AI CR，可以缩短整个评审周期和发布周期。既减少了 commit 次数，又能保证代码质量和功能稳定，还能减轻评审人的压力，何乐而不为？</p>
<h3 data-id="heading-4">落地</h3>
<p>我们直接使用 Shell 脚本的方式搭配 Claude Code 或者 iflow 来实现本地 AI Code Review。以 iflow 为例：</p>
<ul>
<li>首先需要进行安装 <code>npm install -g iflow</code>；</li>
<li>然后在项目根目录中的 <code>.husky/pre-commit</code> 文件中增加调用脚本
<ul>
<li>先设定获取 diff 的脚本，主要是上述内容中 Git diff 的命令；</li>
<li>再通过 <code>iflow -y -p "your_prompt"</code> 的形势，触发 iflow 终端运行</li>
<li>通过“必须通过项”或者 AI 打分的形势，在不符合预期时进行拦截，直至开发者修改通过后方可 commit 成功；</li>
<li>iflow 报错不可 block 用户 commit 操作；</li>
<li>需要提供跳过 AI CR 的能力，防止在一些紧急状况下拦截开发者提交；</li>
<li>基于上一条，可以选择继续评审，但将评审结果和代码一起提交至仓库</li>
</ul>
</li>
<li>最终的形式是脚本 + AI CR</li>
</ul>
<h3 data-id="heading-5">附加项</h3>
<ul>
<li>是否增加 RAG 和内部知识库</li>
</ul>
<p>这个是扩展项，如果从知识库的角度来进行 Code Review，可以有效地提高准确率（预期）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 Hologres 构建智能驾驶图像高性能分析系统]]></title>    <link>https://juejin.cn/post/7573708620870975540</link>    <guid>https://juejin.cn/post/7573708620870975540</guid>    <pubDate>2025-11-18T10:16:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573708620870975540" data-draft-id="7573679820632342563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 Hologres 构建智能驾驶图像高性能分析系统"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2025-11-18T10:16:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 Hologres 构建智能驾驶图像高性能分析系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T10:16:35.000Z" title="Tue Nov 18 2025 10:16:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着人工智能技术的深入发展，企业对数据的利用已不再局限于传统的结构化数据分析。越来越多的行业开始依赖多模态数据进行智能决策，涵盖商品推荐、驾驶行为分析、金融风控、教育个性化等多个场景。这些场景普遍具备一个共同特征：<strong>数据形态多样、分析需求复杂、检索方式多元</strong>。Hologres 4.0的整体架构围绕“多模态分析检索 all-in-one”设计，实现“一份数据、一份计算、多模分析”的一站式目标，一条SQL即可完成从数据接入、AI加工到多模查询的全流程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/954b03bd631747bc9ecdbc804bc7276b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065957&amp;x-signature=UXzee7usV9IDcPSda96iKERLGV8%3D" alt="image.png" loading="lazy"/></p>
<p>智能驾驶场景中，可以看到采集的车机各种信号数据，以大宽表的形式存储在数据库中。这些信号数据通常会包含结构化数据（车辆状态、车机版本等）、半结构化数据（车机信号）、非结构化数据（轨迹照片等）。在业务应用的时候，要进行点查、OLAP分析、全文检索、向量检索、混合检索等多种场景。</p>
<p>传统架构往往依赖多个独立引擎协同工作，导致系统复杂、成本高昂、数据不一致等问题频发。AI时代的应用需要在一个统一平台上完成OLAP分析、点查服务、全文检索、向量搜索以及AI推理等多种能力的融合使用。本文以自动驾驶图像数据集为例，介绍Hologres如何在传统的结构化分析的基础上，完成文搜图、图搜图等多模态分析场景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51e2915b7deb45cea3632a5a2ee92aea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065957&amp;x-signature=gavDrk9mOWaDApHcEgrFfrQ12UA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>基于Hologres构建自动驾驶图像高性能分析系统</strong></h2>
<p>在自动驾驶系统中，车辆图片分析是环境感知模块的核心场景之一，主要用于实时解析车辆内外部摄像头捕捉的视觉信息，以实现对周围环境的精准理解与决策。本文以BDD自动驾驶数据集为例模拟自动驾驶场景，模拟真实驾驶场景，采集10万张包括驾驶区域、地理、环境、天气多样性等数据的图片，通过对图片的分析与检索，进行了行驶轨迹分析、环境感知优化及行人车辆识别精度提升等全栈技术验证，提升系统对复杂交通场景的适应能力、安全性和用户体验。</p>
<p>基于Hologres构建自动驾驶图像高性能分析系统包含的主要能力如下：</p>
<ul>
<li>非结构化数据（Object Table）：支持通过表的形式读取OSS中非结构化数据（PDF、IMAGE、PPT等）。</li>
<li>AI Function：在Hologres中可以用标准SQL的方式调用Function，自动调用内置大模型，完成AI服务建设场景。
<ul>
<li>数据加工：提供Embed、Chunk算子，可以对非结构化数据加工成结构化数据存储，无需使用外部算法就能自动Embed。</li>
<li>数据检索和分析：提供ai_gen、ai_summarize等算子，使用SQL就能对数据进行推理、问题总结以及翻译等能力。</li>
</ul>
</li>
<li>Dynamic Table介绍：支持增量刷新模式对非结构化数据自动加工，每次只计算增量的数据有效减少重复计算，降低资源利用率。</li>
<li>向量检索：支持标准SQL的向量检索，用于非结构化数据的相似度搜索、场景识别等，在同一个查询中可以自由地实现向量和标量的检索。</li>
<li>全文检索：通过倒排索引、分词等机制实现对非结构化数据的高效检索，支持关键词匹配、短语检索等丰富的检索方式，实现更加灵活的检索。</li>
</ul>
<h2 data-id="heading-1"><strong>方案优势</strong></h2>
<p>通过如上核心能力，在Hologres中对图片检索的核心优势如下：</p>
<ul>
<li><strong>完整的<strong><strong>AI</strong></strong>数据处理流程</strong>：涵盖从数据Embed、Chunk、增量加工和检索/分析的全流程，与使用大数据系统一样轻松构建AI应用。</li>
<li><strong>标准<strong><strong>SQL</strong></strong>加工图片数据</strong>：无需使用专用开发语言，<strong>纯SQL</strong>就能完成图片数据提取、加工。</li>
<li><strong>一个平台支持跨模态检索</strong>：支持以文搜图、以图搜图，语义理解突破关键词局限，在Hologres就能实现跨模态检索。</li>
<li><strong>检索更精准、灵活和智能</strong>：可以轻松构建“关键词+语义+多模态”的混合检索链路，覆盖从精准搜索到意图理解的全场景需求。还能结合AI Function实现对用户意图的深度理解，语义关联和上下文推理，实现更智能的检索能力。</li>
<li><strong>数据不出库，安全性更高</strong>：不需要将数据导出到外部系统，与Hologres的多种安全能力无缝集成，并高效保护数据安全。</li>
</ul>
<h2 data-id="heading-2">方案流程</h2>
<p>本次方案的流程如下：</p>
<ol>
<li>数据集准备。</li>
</ol>
<p>将图片数据上传至OSS存储。</p>
<ol start="2">
<li>图片加工。</li>
</ol>
<p>使用Object Table读取图片的元数据信息，然后创建增量刷新的Dynamic Table对数据进行Embed，并为Dynamic Table构建向量索引，以便后续检索能够充分利用索引的功能。</p>
<ol start="3">
<li>使用ai_embed算子将自然语言的问题进行Embedding，然后使用向量检索输出Top N的结果。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61d6d9715947417bbfa09193822f216c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065957&amp;x-signature=GSSEtM2lHOc6a8afhygWFOuFuuc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>准备工作</strong></h2>
<ol>
<li>数据准备</li>
</ol>
<p>本文使用ModelScope公开的BDD100K 自动驾驶图像数据集中<code>val.zip</code>文件，模拟多个车辆真是行驶数据。</p>
<ol start="2">
<li>环境准备</li>
</ol>
<ul>
<li>购买Hologres V4.0及以上版本实例并创建数据库。</li>
<li>购买AI资源。</li>
</ul>
<p>本文以<code>large-96core-512GB-384GB</code>、1个节点为例。</p>
<ul>
<li>模型部署。本次方案使用的模型以及分配的资源为：</li>
</ul>







<table><thead><tr><th/><th/></tr></thead></table>





































<table><thead><tr><th align="left"><strong>类别</strong></th><th align="left"><strong>示例值</strong></th></tr></thead><tbody><tr><td align="left"><strong>模型名称</strong></td><td align="left">image_embed</td></tr><tr><td align="left"><strong>模型类别</strong></td><td align="left">clip-ViT-B-32</td></tr><tr><td align="left"><strong>模型作用描述</strong></td><td align="left">图片Embedding</td></tr><tr><td align="left"><strong>单副本CPU（Core）</strong></td><td align="left">7</td></tr><tr><td align="left"><strong>单副本内存</strong></td><td align="left">30 GB</td></tr><tr><td align="left"><strong>单副本GPU</strong></td><td align="left">1卡(96 GB)</td></tr><tr><td align="left"><strong>资源副本数</strong></td><td align="left">1</td></tr></tbody></table>
<p><strong>说明：</strong>上述模型的资源均为默认分配的资源。</p>
<h2 data-id="heading-4"><strong>操作步骤</strong></h2>
<p>1.下载图片数据并导入至OSS。</p>
<ul>
<li>下载BDD100K 自动驾驶图像数据集中的文件。</li>
<li>登录OSS管理控制台，创建Bucket并将已下载的文件上传至该Bucket路径下。上传操作详情，请参见简单上传。</li>
</ul>
<p><strong>说明：</strong>文件夹名称请使用小写。</p>
<ol start="2">
<li>账号授权。</li>
</ol>
<p>a. 登录RAM控制台，创建阿里云RAM角色并授予OSS的相关权限。
推荐授予AliyunOSSReadOnlyAccess权限。</p>
<p>b.为上述阿里云RAM角色添加登录和Hologres的访问权限。</p>
<ul>
<li>阿里云账号（主账号）</li>
</ul>
<p>修改RAM角色的信任策略。重点需更新如下参数：</p>
<ul>
<li>Action:更新为 sts:AssumeRole.</li>
<li>Service:更新为 hologres.aliyuncs.com</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sts:AssumeRole"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Principal"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"RAM"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"acs:ram::1866xxxx:root"</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"hologres.aliyuncs.com"</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>RAM用户（子账号）</li>
</ul>
<ol>
<li>为RAM用户授权。</li>
</ol>
<ul>
<li>在<strong>权限管理 &gt; 权限策略</strong>页面，单击<strong>创建权限策略</strong>，并选择<strong>脚本编辑</strong>模式创建权限策略。具体操作，请参见创建自定义权限策略</li>
</ul>
<p>Hologres可通过该策略判断当前RAM用户是否具备创建对应RAM角色的权限。权限策略内容如下。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hologram:GrantAssumeRole"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;arn账号&gt;"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>在<strong>身份管理 &gt; 用户</strong>页面，单击目标RAM用户<strong>操作</strong>列中的<strong>添加权限</strong>，为RAM用户（子账号）授予上述步骤已创建的权限策略。具体操作，请参见为RAM用户授权。</li>
</ul>
<ol start="2">
<li>为已创建的RAM角色授权。</li>
</ol>
<p>修改RAM角色的信任策略。重点需更新如下参数：</p>
<ul>
<li>Action：更新为sts:AssumeRole。</li>
<li>Service：更新为hologres.aliyuncs.com。</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sts:AssumeRole"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Principal"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"RAM"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"acs:ram::1866xxxx:root"</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"hologres.aliyuncs.com"</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="3">
<li>对图片进行Embedding。</li>
</ol>
<p>创建Object Table和Dynamic Table读取图片元数据，并对图片加工Embedding。因为流程较长，Hologres直接将过程封装成附录：存储过程。该存储过程包括的能力如下：</p>
<ul>
<li>创建一张Object Table，用于读取图片的元数据。</li>
<li>创建一张增量刷新的Dynamic Table结果表，用于存储加工后的数据，并设置向量索引。该Dynamic Table未设置自动刷新，需要手动刷新。</li>
<li>Dynamic Table的刷新过程中会使用ai_embed对图片进行Embedding。</li>
</ul>
<p>该存储过程的使用如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--存储过程，创建Object Table和Dynamic Table，使用dt对图片进行Embedding</span>
<span class="hljs-keyword">CALL</span> create_image_table_from_oss(
    oss_path <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'oss://xxxx/bdd100k/val/images'</span>,
    oss_endpoint <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'oss-cn-hangzhou-internal.aliyuncs.com'</span>,
    oss_role_arn <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'acs:ram::1xxxx:role/xxxx'</span>,
    image_table <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'public.dt_image_bdd100k'</span>,
    embedding_model <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span><span class="hljs-string">'image_embed'</span>
);
</code></pre>
<ol start="4">
<li>刷新结果表。</li>
</ol>
<p>通过上述步骤创建的Object Table和Dynamic Table都需要手动刷新，才能完成数据加工。该步骤已被封装为附录：存储过程，该存储过程包括的能力如下：</p>
<ul>
<li>刷新一次Object Table获取图片元数据。</li>
<li>刷新一次Dynamic Table，进行图片的Embedding加工。</li>
</ul>
<p>该存储过程的使用如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--刷新Dynamic Table，将图片Embedding</span>
<span class="hljs-keyword">CALL</span> refresh_image_table(
    image_table <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'public.dt_image_bdd100k'</span>
);
</code></pre>
<ol start="5">
<li>图片检索。</li>
</ol>
<p>图片数据处理过后可以使用向量检索和AI Function进行检索。</p>
<p><strong>以文搜图：</strong></p>
<p>如果使用clip-ViT-B-32模型进行以文搜图，问题请使用英文。如果是中文问题，请换成LLM模型。以文搜图的示例SQL如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--以文搜图</span>
<span class="hljs-keyword">SELECT</span>
    object_uri,
    approx_cosine_distance (embedding_vector, ai_embed (<span class="hljs-string">'image_embed'</span>, <span class="hljs-string">'a red car in the rain'</span>)) <span class="hljs-keyword">AS</span> score
<span class="hljs-keyword">FROM</span>
    public.dt_image_bdd100k
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    score <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">1</span>;

                            object_uri                         <span class="hljs-operator">|</span>  score   
<span class="hljs-comment">---------------------------------------------------------------+-------</span>
 oss:<span class="hljs-operator">/</span><span class="hljs-comment">/****/</span>bd<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>k<span class="hljs-operator">/</span>val<span class="hljs-operator">/</span>images<span class="hljs-operator">/</span>b836b14a<span class="hljs-operator">-</span>fb13<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>.jpg｜ <span class="hljs-number">0.322337151</span>
(<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span>)
</code></pre>
<p>在OSS中找到第一个结果的图片如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74b4c914d822445ebf39ca0181b51a47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065957&amp;x-signature=pKp7g4Lu4ubZpCntviH6qdPW6H8%3D" alt="image.png" loading="lazy"/></p>
<p><strong>以图搜图：</strong></p>
<p>以图搜图的示例SQL如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--以图搜图</span>
<span class="hljs-keyword">SELECT</span>
    object_uri,
    approx_cosine_distance (embedding_vector, ai_embed (<span class="hljs-string">'image_embed'</span>, to_file (<span class="hljs-string">'oss://xxxx/val/images/b9b53753-91a5d5f8.jpg'</span>, <span class="hljs-string">'oss-cn-hangzhou-internal.aliyuncs.com'</span>, <span class="hljs-string">'acs:ram::18xxx:role/xxx'</span>))) <span class="hljs-keyword">AS</span> score
<span class="hljs-keyword">FROM</span>
    public.dt_image_bdd100k
<span class="hljs-keyword">WHERE</span>
    object_uri <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">'oss://hm-**-hangzhou/bd****k/val/images/b9b53753-91a5****.jpg'</span> <span class="hljs-comment">--排除自身</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    score <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">1</span>;

                          object_uri                           <span class="hljs-operator">|</span>  score   
<span class="hljs-comment">---------------------------------------------------------------+------</span>
 oss:<span class="hljs-operator">/</span><span class="hljs-comment">/****/</span>bd<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>k<span class="hljs-operator">/</span>val<span class="hljs-operator">/</span>images<span class="hljs-operator">/</span>c0e9b7c4<span class="hljs-operator">-</span>cd8b<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>.jpg <span class="hljs-operator">|</span> <span class="hljs-number">0.918008327</span>
</code></pre>
<p>在OSS中找到召回的图片，并做对比，结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98bb4d9d1b17467990c1a03b84160c69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065957&amp;x-signature=3ZVmWanJAhS%2B0GlZ%2Bd3H1XZjW%2FY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">附录：存储过程</h2>
<ul>
<li>创建Object Table和Dynamic Table </li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- Query查询结果默认限制200行，如需更多数据请修改limit，最多展示10000行或20M。</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">PROCEDURE</span> create_image_table_from_oss(
    oss_path TEXT,
    oss_endpoint TEXT,
    oss_role_arn TEXT,
    image_table TEXT,
    embedding_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    overwrite <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>
)
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    image_schema_name TEXT;
    image_table_name TEXT;
    obj_table_name TEXT;
    full_image_table_ident TEXT;
    full_obj_ident TEXT;
    embed_expr TEXT;
    create_sql TEXT;
    embedding_dims <span class="hljs-type">INT</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- 1. 拆 schema name + table name</span>
    IF <span class="hljs-built_in">position</span>(<span class="hljs-string">'.'</span> <span class="hljs-keyword">in</span> image_table) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
        image_schema_name :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">1</span>);
        image_table_name  :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">ELSE</span>
        image_schema_name :<span class="hljs-operator">=</span> <span class="hljs-string">'public'</span>;
        image_table_name  :<span class="hljs-operator">=</span> image_table;
    <span class="hljs-keyword">END</span> IF;

    obj_table_name :<span class="hljs-operator">=</span> image_table_name <span class="hljs-operator">||</span> <span class="hljs-string">'_obj_table'</span>;

    full_image_table_ident :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, image_table_name);
    full_obj_ident    :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, obj_table_name);
    
    <span class="hljs-comment">-- 2. 如果需要覆盖，先删表和索引</span>
    IF overwrite <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">DECLARE</span>
            dyn_table_exists <span class="hljs-type">BOOLEAN</span>;
            rec RECORD;
        <span class="hljs-keyword">BEGIN</span>
            <span class="hljs-comment">-- 检查 dynamic table 是否存在</span>
            <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">EXISTS</span> (
                <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
                <span class="hljs-keyword">FROM</span> pg_class c
                <span class="hljs-keyword">JOIN</span> pg_namespace n <span class="hljs-keyword">ON</span> n.oid <span class="hljs-operator">=</span> c.relnamespace
                <span class="hljs-keyword">WHERE</span> c.relname <span class="hljs-operator">=</span> image_table_name
                <span class="hljs-keyword">AND</span> n.nspname <span class="hljs-operator">=</span> image_schema_name
            )
            <span class="hljs-keyword">INTO</span> dyn_table_exists;

            IF dyn_table_exists <span class="hljs-keyword">THEN</span>
                <span class="hljs-comment">-- 2.1 关闭动态表自动刷新</span>
                <span class="hljs-comment">-- RAISE NOTICE 'Disabling auto refresh for %', full_image_table_ident;</span>
                <span class="hljs-comment">-- EXECUTE format('ALTER TABLE IF EXISTS %s SET (auto_refresh_enable=false)', full_image_table_ident);</span>

                <span class="hljs-comment">-- 2.2 查找 RUNNING 刷新任务并取消</span>
                <span class="hljs-keyword">FOR</span> rec <span class="hljs-keyword">IN</span>
                    <span class="hljs-keyword">EXECUTE</span> format(
                        $f$
                        <span class="hljs-keyword">SELECT</span> query_job_id
                            <span class="hljs-keyword">FROM</span> hologres.hg_dynamic_table_refresh_log(<span class="hljs-operator">%</span>L)
                            <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'RUNNING'</span>;
                        $f$,
                        image_table
                    )
                LOOP
                    RAISE NOTICE <span class="hljs-string">'Found running refresh job: %'</span>, rec.query_job_id;
                    IF hologres.hg_internal_cancel_query_job(rec.query_job_id::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">THEN</span>
                        RAISE NOTICE <span class="hljs-string">'Cancel job % succeeded.'</span>, rec.query_job_id;
                    <span class="hljs-keyword">ELSE</span>
                        RAISE WARNING <span class="hljs-string">'Cancel job % failed.'</span>, rec.query_job_id;
                    <span class="hljs-keyword">END</span> IF;
                <span class="hljs-keyword">END</span> LOOP;

                <span class="hljs-comment">-- 2.3 删除 Dynamic Table</span>
                <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP TABLE IF EXISTS %s;'</span>, full_image_table_ident);
            <span class="hljs-keyword">ELSE</span>
                RAISE NOTICE <span class="hljs-string">'Dynamic table % does not exist, skip cancel job and drop.'</span>, full_image_table_ident;
            <span class="hljs-keyword">END</span> IF;

            <span class="hljs-comment">-- 2.4 无论如何，Object Table 都要删除</span>
            <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP OBJECT TABLE IF EXISTS %s;'</span>, full_obj_ident);
        <span class="hljs-keyword">END</span>;
    <span class="hljs-keyword">END</span> IF;

    <span class="hljs-comment">-- 3. 创建 Object Table</span>
    RAISE NOTICE <span class="hljs-string">'Create object table: %'</span>, obj_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(
        $f$
        <span class="hljs-keyword">CREATE</span> OBJECT <span class="hljs-keyword">TABLE</span> <span class="hljs-operator">%</span>s
        <span class="hljs-keyword">WITH</span> (
            path <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L,
            oss_endpoint <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L,
            role_arn <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L
        );
        $f$,
        full_obj_ident,
        oss_path,
        oss_endpoint,
        oss_role_arn
    );

    <span class="hljs-keyword">COMMIT</span>;

    <span class="hljs-comment">-- 4. 刷新 Object Table</span>
    RAISE NOTICE <span class="hljs-string">'Refresh object table: %'</span>, obj_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'REFRESH OBJECT TABLE %s;'</span>, full_obj_ident);

    <span class="hljs-keyword">COMMIT</span>;

    <span class="hljs-comment">-- 5. embedding 模型选择</span>
    IF embedding_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">OR</span> length(<span class="hljs-built_in">trim</span>(embedding_model)) <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
        embed_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed(file)'</span>;

        <span class="hljs-keyword">EXECUTE</span> <span class="hljs-string">'SELECT array_length(ai_embed(''dummy''), 1)'</span>
        <span class="hljs-keyword">INTO</span> embedding_dims;
    <span class="hljs-keyword">ELSE</span>
        embed_expr :<span class="hljs-operator">=</span> format(<span class="hljs-string">'ai_embed(%L, file)'</span>, embedding_model);

        <span class="hljs-keyword">EXECUTE</span> format(
            <span class="hljs-string">'SELECT array_length(ai_embed(%L, ''dummy''), 1)'</span>,
            embedding_model
        )
        <span class="hljs-keyword">INTO</span> embedding_dims;
    <span class="hljs-keyword">END</span> IF;

    RAISE NOTICE <span class="hljs-string">'embedding dimension is: %'</span>, embedding_dims;

    <span class="hljs-comment">-- 6. 创建 RAG 输出动态表</span>
    RAISE NOTICE <span class="hljs-string">'create dynamic table: %'</span>, image_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(
        $f$
        <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DYNAMIC</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-operator">%</span>s(
            <span class="hljs-keyword">CHECK</span>(array_ndims(embedding_vector) <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> array_length(embedding_vector, <span class="hljs-number">1</span>) <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>s)
        )
        <span class="hljs-keyword">WITH</span> (
            vectors <span class="hljs-operator">=</span> <span class="hljs-string">'{
                "embedding_vector": {
                    "algorithm": "HGraph",
                    "distance_method": "Cosine",
                    "builder_params": {
                    "base_quantization_type": "sq8_uniform",
                    "max_degree": 64,
                    "ef_construction": 400,
                    "precise_quantization_type": "fp32",
                    "use_reorder": true
                    }
                }
            }'</span>,
            auto_refresh_mode <span class="hljs-operator">=</span> <span class="hljs-string">'incremental'</span>,
            freshness <span class="hljs-operator">=</span> <span class="hljs-string">'5 minutes'</span>,
            auto_refresh_enable <span class="hljs-operator">=</span> <span class="hljs-string">'false'</span>
        ) <span class="hljs-keyword">AS</span>
        <span class="hljs-keyword">SELECT</span>
            object_uri,
            etag,
            <span class="hljs-operator">%</span>s <span class="hljs-keyword">AS</span> embedding_vector
        <span class="hljs-keyword">FROM</span> <span class="hljs-operator">%</span>s;
        $f$,
        full_image_table_ident,
        embedding_dims,
        embed_expr,
        obj_table_name
    );

    <span class="hljs-keyword">COMMIT</span>;

    RAISE NOTICE <span class="hljs-string">''</span>;
    RAISE NOTICE <span class="hljs-string">'Create image table success: %'</span>, image_table;
    RAISE NOTICE <span class="hljs-string">'    Vector index is: %.embedding_vector'</span>, image_table;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<ul>
<li>Object Table和Dynamic Table</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">PROCEDURE</span> refresh_image_table(
    image_table TEXT
)
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    image_schema_name TEXT;
    image_table_name   TEXT;
    obj_table_name TEXT;
    full_image_table_ident TEXT;
    full_obj_ident    TEXT;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- 1. 解析 schema 和表名</span>
    IF <span class="hljs-built_in">position</span>(<span class="hljs-string">'.'</span> <span class="hljs-keyword">in</span> image_table) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
        image_schema_name :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">1</span>);
        image_table_name  :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">ELSE</span>
        image_schema_name :<span class="hljs-operator">=</span> <span class="hljs-string">'public'</span>;
        image_table_name  :<span class="hljs-operator">=</span> image_table;
    <span class="hljs-keyword">END</span> IF;

    obj_table_name :<span class="hljs-operator">=</span> image_table_name <span class="hljs-operator">||</span> <span class="hljs-string">'_obj_table'</span>;

    full_image_table_ident :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, image_table_name);
    full_obj_ident    :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, obj_table_name);

    <span class="hljs-comment">-- 2. 刷新 Object Table</span>
    RAISE NOTICE <span class="hljs-string">'Refreshing Object Table: %'</span>, obj_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'REFRESH OBJECT TABLE %s;'</span>, full_obj_ident);

    <span class="hljs-comment">-- 3. 刷新 Dynamic Table</span>
    RAISE NOTICE <span class="hljs-string">'Refreshing Dynamic Table: %'</span>, image_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'REFRESH TABLE %s;'</span>, full_image_table_ident);

    RAISE NOTICE <span class="hljs-string">'Refresh image table complete: %'</span>, image_table;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<ul>
<li>删除存储过程</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">PROCEDURE</span> drop_image_table(
    image_table TEXT
)
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    image_schema_name TEXT;
    image_table_name   TEXT;
    obj_table_name TEXT;
    full_image_table_ident TEXT;
    full_obj_ident    TEXT;
    rec RECORD;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- 1. 解析 schema 和表名</span>
    IF <span class="hljs-built_in">position</span>(<span class="hljs-string">'.'</span> <span class="hljs-keyword">in</span> image_table) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
        image_schema_name :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">1</span>);
        image_table_name   :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">ELSE</span>
        image_schema_name :<span class="hljs-operator">=</span> <span class="hljs-string">'public'</span>;
        image_table_name   :<span class="hljs-operator">=</span> image_table;
    <span class="hljs-keyword">END</span> IF;

    obj_table_name :<span class="hljs-operator">=</span> image_table_name <span class="hljs-operator">||</span> <span class="hljs-string">'_obj_table'</span>;

    full_image_table_ident :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, image_table_name);
    full_obj_ident    :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, obj_table_name);

    <span class="hljs-comment">-- 2. 删除表</span>
    <span class="hljs-comment">-- 2.1 关闭动态表自动刷新</span>
    <span class="hljs-comment">-- RAISE NOTICE 'Disabling auto refresh for %', full_image_table_ident;</span>
    <span class="hljs-comment">-- EXECUTE format('ALTER TABLE IF EXISTS %s SET (auto_refresh_enable=false)', full_image_table_ident);</span>

    <span class="hljs-comment">-- 2.2 查找 RUNNING 刷新任务并取消</span>
    <span class="hljs-keyword">FOR</span> rec <span class="hljs-keyword">IN</span>
        <span class="hljs-keyword">EXECUTE</span> format(
            $f$
            <span class="hljs-keyword">SELECT</span> query_job_id
                <span class="hljs-keyword">FROM</span> hologres.hg_dynamic_table_refresh_log(<span class="hljs-operator">%</span>L)
                <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'RUNNING'</span>;
            $f$,
            image_table
        )
    LOOP
        RAISE NOTICE <span class="hljs-string">'Found running refresh job: %'</span>, rec.query_job_id;
        IF hologres.hg_internal_cancel_query_job(rec.query_job_id::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">THEN</span>
            RAISE NOTICE <span class="hljs-string">'Cancel job % succeeded.'</span>, rec.query_job_id;
        <span class="hljs-keyword">ELSE</span>
            RAISE WARNING <span class="hljs-string">'Cancel job % failed.'</span>, rec.query_job_id;
        <span class="hljs-keyword">END</span> IF;
    <span class="hljs-keyword">END</span> LOOP;

    <span class="hljs-comment">-- 2.3 删除 Dynamic Table</span>
    RAISE NOTICE <span class="hljs-string">'Dropping Dynamic Table: %'</span>, image_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP TABLE IF EXISTS %s;'</span>, full_image_table_ident);

    <span class="hljs-comment">-- 2.4 删除 Object Table</span>
    RAISE NOTICE <span class="hljs-string">'Dropping Object Table: %'</span>, obj_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP OBJECT TABLE IF EXISTS %s;'</span>, full_obj_ident);

    RAISE NOTICE <span class="hljs-string">'Drop image table complete: %'</span>, image_table;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<p>如果想体验更多操作流程，欢迎到阿里云官网领取Hologres免费试用，开通Hologres4.0，并按照操作文档实践。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fhologres%2Fuser-guide%2Fvisual-data-analysis-for-autonomous-driving" target="_blank" title="https://help.aliyun.com/zh/hologres/user-guide/visual-data-analysis-for-autonomous-driving" ref="nofollow noopener noreferrer">help.aliyun.com/zh/hologres…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[入围名单公布｜2025 MGPIC 决赛即将拉开帷幕！]]></title>    <link>https://juejin.cn/post/7573679820633047075</link>    <guid>https://juejin.cn/post/7573679820633047075</guid>    <pubDate>2025-11-18T10:09:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573679820633047075" data-draft-id="7573864324713480244" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="入围名单公布｜2025 MGPIC 决赛即将拉开帷幕！"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2025-11-18T10:09:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MoonBit"/> <meta itemprop="url" content="https://juejin.cn/user/3609050528885565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            入围名单公布｜2025 MGPIC 决赛即将拉开帷幕！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609050528885565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MoonBit
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T10:09:42.000Z" title="Tue Nov 18 2025 10:09:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>总决赛名单公布</strong></p>
<p>MoonBit 编程创新挑战赛由粤港澳大湾区数字经济研究院基础软件中心主办，是面向全球开发者的年度技术挑战赛事。自连续两届举办以来，赛事累计吸引全球<strong>上千名选手参赛</strong>，已成为编程语言与基础软件领域的重要创新舞台。</p>
<p>历经两个多月的角逐，本年度大赛正式进入 <strong>决赛阶段</strong>。来自全球的优秀参赛者在双赛道中展现出卓越的工程能力与创造力，竞争异常激烈。</p>
<p>截至 11 月 14 日，本届「编程语言赛道」与「游戏开发赛道」双赛道作品提交已全部结束。本次比赛整体质量远超往年，两个赛道均涌现出数量可观的高水准作品。</p>
<p>为了让更多优秀的创作者获得展示舞台，我们决定<strong>扩大名额</strong>，经过专家评委的细致评审与严格打分，共甄选出 <strong>15 支最具实力的队伍/参赛者</strong> 参与本年度现场总决赛！</p>
<p>同时，今年的决赛现场我们特别邀请了来自学界与工业界的 <strong>10 余位重磅嘉宾</strong> 到场评审和颁奖，与你共同见证年度最高舞台的荣耀时刻。</p>
<p>以下为 <strong>2025 MoonBit 全球编程挑战赛 · 决赛入围名单</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c19485ed4d6941398ed942fa8b7aaf28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065382&amp;x-signature=5FP4QAiKC1lMEkmr5znlxo%2BlA8s%3D" alt="图片" loading="lazy"/></p>
<p><strong>决赛地址</strong></p>
<p>深圳市福田保税区河套科创中心一层报告厅</p>
<p><strong>决赛邀请</strong></p>
<p>决赛现场将汇聚多位业界大咖，他们将作为评委和嘉宾，为参赛者们带来专业的点评和宝贵的建议。这不仅是一次展示才华的舞台，更是一次与行业领袖面对面交流的难得机会。此外，我们还准备了精美的赛事礼包以及 MoonBit 专属周边、茶歇等，让每位参与者在享受比赛的同时，也能收获满满的惊喜。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e22e6f7186e24eabba237237574e7873~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065382&amp;x-signature=5E4PWGB4G9z1keGG2t3Z2lEb70E%3D" alt="图片" loading="lazy"/>现场场地<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e5ca0d65ad74c6882ec349b97518dc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065382&amp;x-signature=8cA%2Bz1FI2RdZZ%2Bj4cMBccKEQWdg%3D" alt="图片" loading="lazy"/>茶歇</p>
<p>我们诚挚邀请所有参赛选手携带您的亲友、同学一同来到决赛现场，共同见证这场编程界的盛宴。11月23日，我们不见不散！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2329483f35934f64a83fa2b3f93177a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9vbkJpdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065382&amp;x-signature=qzSk%2BTXIYmfJLse4EHEddjwPgjc%3D" alt="图片" loading="lazy"/>欢迎各位一同现场见证冠军的诞生！</p>
<p>对于无法亲临现场的朋友，我们也为您准备了线上直播的便利。本次决赛将同步进行全程直播，让您无论身在何处，都能实时感受比赛的紧张刺激和精彩瞬间，直播信息稍后公布，欢迎持续关注～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[真机RL！最强VLA模型π*0.6来了，机器人在办公室开起咖啡厅]]></title>    <link>https://juejin.cn/post/7573896789364867110</link>    <guid>https://juejin.cn/post/7573896789364867110</guid>    <pubDate>2025-11-18T10:29:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573896789364867110" data-draft-id="7573988811916230706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="真机RL！最强VLA模型π*0.6来了，机器人在办公室开起咖啡厅"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-18T10:29:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            真机RL！最强VLA模型π*0.6来了，机器人在办公室开起咖啡厅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T10:29:43.000Z" title="Tue Nov 18 2025 10:29:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>新方法大幅提升了具身智能的成功率、处理效率。</p>
</blockquote>
<p>完全使用真实世界数据训练的具身智能，具备什么级别的能力？</p>
<p>本周，美国具身智能创业公司 Physical Intelligence（简称 PI 或 π）发布了旗下的最新机器人基础模型 π*0.6。</p>
<p>PI 是一家总部位于旧金山的机器人与 AI 创业公司，其使命是将通用人工智能从数字世界带入物理世界：他们的首个机器人通用基础模型名为 π₀，让同一套软件控制多种物理平台执行各类任务。  </p>
<p>在 2024 年，PI 获得超过 4 亿美元融资，估值突破 20 亿美元，成为具身智能赛道最受瞩目的玩家之一。</p>
<p>PI 的技术路线强调 「视觉 - 语言 - 动作」（VLA）模型，通过大规模机器人感知与动作数据训练出具备泛化能力的策略，使机器人不再局限于预设动作，而能在未知环境中灵活执行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baf5dbd84a874be99dfa96c6af52dab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066583&amp;x-signature=9I5ZVqosK5wdbEhcQC6NE3Fa%2BDY%3D" alt="图片" loading="lazy"/></p>
<p>机器学习与决策控制领域的知名专家、UC Berkeley 副教授、Physical Intelligence 联合创始人 Sergey Levine 表示，搭载这个模型的机器人已经可以在公司的办公室里为人们制作拿铁、美式和意式咖啡了。</p>
<p>Sergey Levine 表示，通过对 π*0.6 模型进行微调，可以使其在多种任务上表现出色，除了处理衣物之外的任务都可以达到 90% 成功率，而且任务处理的效率也大大提升了。</p>
<p>在 Physical Intelligence 的一篇博客中，工程师们详细介绍了 π*0.6 的机制与性能。</p>
<p>想一下，要组装一个纸箱需要哪些步骤？</p>
<p>作为人类，想要快速高效地完成这个任务，首先你应该会请人教你一些基础知识：哪些方法有效，常见的错误有哪些，以及正确的技巧是什么。其次，一位优秀的老师不仅会演示如何操作，还会指导你，纠正你自行操作时犯的错误。但是，仅仅依靠指导是不够的：最终熟能生巧，成为纸箱组装大师的第三步是反复练习，直到熟练掌握，成为一种本能反应。</p>
<p>过去一年，我们在机器人学习领域看到的许多令人瞩目的成果，都仅仅使用了第一步 —— 通过人提供的演示来训练机器人。仅凭这一步，让机器人成功完成一半的任务并不难，但要让它每次都成功却非常困难，更不用说在复杂的实际任务中达到人类水平的效率了。这是一个很大的问题，因为实际的机器人任务需要一个能够可靠且快速运行的系统。</p>
<p>基于这样的思考，Physical Intelligence 开发了一种名为 Recap（基于优势条件策略的经验与纠错强化学习）的方法，它实现了所有三个步骤：通过演示训练机器人、通过纠错指导机器人，并使其能够从自主经验中改进。作者使用 Recap 改进了最新版本的视觉 - 语言 - 动作 (VLA) 模型 π(0.6)，使其能够稳健高效地执行复杂任务，例如制作意式浓缩咖啡、组装纸箱和折叠各种衣物。</p>
<p>这款经过强化学习训练后的模型称为 π*(0.6)，利用 Recap 在自主经验上训练 π*(0.6) 可以将一些最困难任务的吞吐量提高一倍以上，并将失败率降低 2 倍或更多。这使得 π*(0.6) 达到了实际应用所需的鲁棒性水平：它能够连续运行一整天制作意式浓缩咖啡，在新家中连续数小时不间断地折叠各种衣物，以及组装工厂实际包装所需的纸箱。</p>
<p>模仿是远远不够的</p>
<p>我们可能会想，为什么 VLA 仅依靠监督学习（即模仿）时难以持续取得成功，而监督学习在 LLMs 和其他机器学习系统中却效果很好。这个问题的原因实际上已经被很好地理解了，不过此前一直缺乏实用的解决方案。</p>
<p>当一个通过模仿训练的 VLA 控制机器人时，它会像任何模型一样犯一些小错误 —— 它可能把夹爪放在略微错误的位置、抓取失败，或撞倒一个物体。</p>
<p>由于机器人在真实的物理环境中进行交互，这些错误会产生与训练数据略有不同的情境，而在这些情境中，错误是会累积的。机器人更可能犯下另一个更大的错误，小错误是可以修复的，但累积错误会导致失败。</p>
<p>对于产生静态输出的 AI 系统（例如 LLMs）来说，这并不是一个大问题；但在模型作为一个持续与外部环境互动的控制策略时（例如现实世界中的机器人），这就是一个特定的问题。实际上，这意味着，虽然让 VLA 偶尔完成某项任务相对容易，但让它们可靠，稳定的实现成功却非常困难。</p>
<p>如果我们使用来自 VLA 自身行为的额外数据，本质上让它在真实世界中纠正它实际犯下的错误，就像人类可以通过练习在某项任务上不断提高一样，通过允许 VLA 反复练习，就可以解决累积错误的问题。</p>
<p>但对于这种类型的经验，能用什么作为真实标签？如果我们训练策略只是去复制它之前做过的事情，那我们只是教会它继续犯相同的错误。让模型能够从经验中学习的关键，是从糟糕的经验数据中提取出良好的训练信号。</p>
<p>纠正式指导与强化学习</p>
<p>Recap 使我们能够从「质量较差」的经验数据中获得良好的训练信号，途径包括两种：</p>
<ul>
<li>
<p>纠正式指导（coaching with corrections）：由专家展示机器人如何修复错误或做得更好；</p>
</li>
<li>
<p>强化学习（reinforcement learning）：机器人依据整个任务过程的最终结果自行判断哪些行为更好或更差，并通过迭代学习强化好的行为、避免不好的行为。</p>
</li>
</ul>
<p>纠正式指导要发挥作用，专家远程操作人员需要提供纠正信号，展示如何从机器人在真实世界中实际犯下的错误中恢复。</p>
<p>实践中，这意味着运行当前最强的策略，并在机器人出错时通过手动远程接管（teleoperation）控制。这种干预可以作为监督信号使用，但与用于训练原始策略的演示不同，该干预针对的正是策略实际将机器人带入的那些状态，从而解决错误累积的问题。</p>
<p>然而，仅依靠纠正式指导是有限的：这类监督的质量受制于人类是否能及时判断应当介入以及是否能提供高质量的纠正。对于明显或严重的错误，这种方式可以奏效，但若想获得最佳性能 —— 即快速、可靠且一致地完成任务 —— 机器人必须能够自主学习。</p>
<p>从任务结果中通过强化学习进行学习的核心挑战在于信用分配（credit assignment）：即理解机器人执行的哪些动作导致了好的结果，哪些导致了坏的结果。</p>
<p>如果机器人以错误的方式抓起意式咖啡机的手柄（portafilter），它在插入时可能会遇到困难。错误并不发生在插入阶段，而是在最初的抓取动作上。一个正确的信用分配方法应当将该失败归因于抓取错误，即使失败只是在之后的步骤中表现出来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ce71cbbe8eb423a98407a0c78643ea2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066583&amp;x-signature=E%2BSEauDn1w5J%2FMK0HP0U6HehzB4%3D" alt="图片" loading="lazy"/></p>
<p>仅通过模仿学习训练的基础模型在将手柄插入意式咖啡机时会遇到困难。导致失败的错误可能发生在更早的阶段。</p>
<p>信用分配是强化学习中的一个关键挑战。Recap 通过训练一个价值函数来解决这一问题。</p>
<p>举例来说，在象棋这类游戏中，智能体只有在赢得比赛时才会获得奖励，那么价值函数就会根据当前棋局预测智能体获胜的概率。使价值函数上升的动作是应该被鼓励的好动作；而使价值函数下降的动作则应被抑制。</p>
<p>下图展示了价值函数在任务执行过程中所做的预测。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae931bc9632d4eb08c8173d47cc6bac8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066583&amp;x-signature=Ef0SeYr2qso40%2BI3zQc1GXapNFM%3D" alt="图片" loading="lazy"/></p>
<p>在一个回合中不同时间点的值函数预测。这个值函数预测完成任务的（负）步数。请注意，当机器人取得进展时预测会增加，而当进展很小时预测会保持平稳。</p>
<p>在训练好价值函数之后，我们需要利用它来得到一个更好的策略。实现这一点的方法有多种，但我们需要的是一种可扩展、并且能够与大型 VLA 模型结合使用的方法。</p>
<p>在 Recap 中，Physical Intelligence 将 VLA 在价值变化上调整：使用所有训练数据（包括好的和不好的动作），同时告诉 VLA 哪些动作是好是坏。由于模型在拥有大量数据时通常具有最佳的泛化能力，在训练中保留全部数据并仅仅将价值变化注释作为输入，是一个非常具有吸引力的选择。</p>
<p>在强化学习中，这种「价值变化」被称为优势（advantage）。在执行阶段，我们只需让这个按优势条件化的 VLA 去选择高优势的动作，从而得到一个比训练数据本身更优的策略。</p>
<p>面向真实世界任务</p>
<p>Physical Intelligence 使用 Recap 来训练 π*(0.6) 模型，使其能够执行多项真实世界应用。π*(0.6) 是基于 π(0.6) 模型训练得到的，而 π(0.6) 则是早期 π(0.5) 模型的改进版本。</p>
<p>它采用了稍大一些的骨干网络，并能够处理更加异质化的提示与条件信息，如下图所示。关于 π(0.6) 模型架构的更详细描述，请参阅模型卡。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwebsite.pi-asset.com%2Fpi06star%2FPI06_model_card.pdf" target="_blank" title="https://website.pi-asset.com/pi06star/PI06_model_card.pdf" ref="nofollow noopener noreferrer">website.pi-asset.com/pi06star/PI…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b71e5a81c4a40958d640983a1770305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066583&amp;x-signature=XYTBQ%2FcrlJxEBDb7xSAi4dF8h9Q%3D" alt="图片" loading="lazy"/></p>
<p>Physical Intelligence 研究了三个应用场景：制作意式咖啡饮品、折叠多种类型的衣物，以及组装包装用的纸盒。Recap 的第一阶段，是使用离线强化学习（offline RL）对 π*(0.6) 模型进行预训练，这与基础 π(0.6) 和 π(0.5) VLA 所采用的标准监督学习方法形成对比。在此基础上，再通过示范数据对 π*(0.6) 进行任务级微调，随后利用机器人在真实环境中收集的额外数据继续通过强化学习进行训练，其中包括专家提供的纠正（用于修复大的错误）以及来自奖励的反馈（用于根据自主经验进一步改进）。</p>
<p>下方的图表对比了不同阶段模型的性能：监督学习训练的基础 π(0.6) 模型；使用离线强化学习预训练的基础 π*(0.6) 模型（即 Recap 的第一阶段）；通过示范对每个任务微调后的 π*(0.6) 模型；以及结合机器人真实执行经验进行微调后的最终 π*(0.6) 模型。对每个任务，Physical Intelligence 测量了吞吐量（每小时成功完成任务的次数）以及成功率。</p>
<p>值得注意的是，对于一些最困难的任务（如制作意式咖啡），加入机器人真实执行经验后，吞吐量和成功率都提升了超过两倍。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d7ce49edf974c298144124743496107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066583&amp;x-signature=B2yc%2Bi2q9mCPaA6DtK3%2B%2FQPKhu8%3D" alt="图片" loading="lazy"/></p>
<p>Recap 在所有任务中都显著提升了吞吐量，并且通常还能带来成功率的大幅提升。</p>
<p>从质量上看，最终的 π*(0.6) 模型在结合示范数据和机器人自身经验学习后，能够熟练掌握每个应用任务。下面的视频展示了这些任务的一些评估亮点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2c8ee8a8d9d4fe49fe37df2cc78d92b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066583&amp;x-signature=Efz9%2B%2BnMoxKkfypTDU34HW514Lw%3D" alt="图片" loading="lazy"/></p>
<p>π*(0.6) 在每项真实世界任务中的质性示例。π*(0.6) 能够应对多种条件，并从错误中恢复。</p>
<p>每一项任务都包含许多挑战，使得实现高吞吐量的自主执行变得困难。</p>
<p>箱子组装任务需要执行高度复杂的物理操作 —— 在保持箱体结构的同时折叠箱盖。此外，该任务需要反复执行并处理各种边缘情况，正如上方视频中所示：有时扁平的纸箱会粘在一起，导致机器人一次抓起多个箱子，此时它必须将多余的箱子放回去；有时在出现错误后还需要重新折叠箱子。</p>
<p>衣物折叠任务则需要处理高度的多样性，并在不同初始条件和不同衣物种类之间实现泛化。这非常困难，因为不仅不同的衣物需要不同的折叠策略，不同材质的布料也具有不同的动力学特性。</p>
<p>最后，意式咖啡制作任务需要处理一个跨度非常长的操作序列，新模型使用了类似于之前 π(0.5) 模型的高层语言策略。该任务还涉及倒液体、判断咖啡研磨机和意式咖啡机何时完成工作、以及在制作结束后用布巾清洁机器。</p>
<p>这些步骤对当前最先进的 VLA 模型来说都极具挑战性，而 π*(0.6) 能够以超过 90% 的成功率完成这些任务。</p>
<p>下一步？</p>
<p>目前，机器人基础模型主要依赖人为收集的示范数据（例如通过远程操作）。这种方式使训练过程简单直接，但也带来了一个严重的障碍：数据需要大量人工投入，模型的速度与可靠性受限于人类的操作水平，而机器人本身无法通过经验不断变得更好。像 Recap 这样的方法在原理上能够解决这些限制，因为它还能直接从机器人自身的经验中学习。</p>
<p>随着机器人在真实世界中的部署越来越广泛，从经验中学习可能会成为一种重要的数据来源，并成为实现高性能模型不可或缺的组成部分。</p>
<p>就像人类通过「指导 — 辅导 — 练习」的组合方式成长一样，机器人同样将从多种不同的数据来源中学习。但这些数据来源会承担不同的角色：专家示范用于定义新的行为，纠正式指导用于改进策略，而自主经验 —— 可能是规模最大的数据来源 —— 则用于打磨行为，使其最终有可能达到超越人类的表现。</p>
<p>参考链接：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pi.website%2Fblog%2Fpistar06%255B%23where%255D()-are-we-headed" target="_blank" title="https://www.pi.website/blog/pistar06%5B#where%5D()-are-we-headed" ref="nofollow noopener noreferrer">www.pi.website/blog/pistar…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[马斯克Grok 4.1低调发布！通用能力碾压其他一切模型]]></title>    <link>https://juejin.cn/post/7573890735578529802</link>    <guid>https://juejin.cn/post/7573890735578529802</guid>    <pubDate>2025-11-18T10:30:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573890735578529802" data-draft-id="7573988811916247090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="马斯克Grok 4.1低调发布！通用能力碾压其他一切模型"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-18T10:30:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            马斯克Grok 4.1低调发布！通用能力碾压其他一切模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T10:30:35.000Z" title="Tue Nov 18 2025 10:30:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>几乎毫无预兆，马斯克人工智能公司 xAI 发布了最新模型 Grok 4.1。</p>
<p>就在刚刚，xAI 宣布，Grok 4.1 已经向所有用户开放，可以在 Grok 官网、X 以及 iOS 和 Android 应用中使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b844101a3594d75bb6022df3c2373df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=4Cqbu%2Fwpr9pVtRknWAJOX1qesx4%3D" alt="图片" loading="lazy"/></p>
<p>Grok 4.1将立即在 Auto 模式中推送，并可在模型选择器中手动选择。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b60ee01e9b404475b5aba85467730c87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=oTrf4zhHRHhKutXm0rxTaR7caO8%3D" alt="图片" loading="lazy"/></p>
<p>此次，Grok 4.1 将在真实世界可用性方面带来显著提升，尤其是在创造力、情感互动和协作交互方面表现出色。Grok 4.1 对细微意图的感知能力更强，与用户对话更加吸引人，整体人格也更连贯，同时完全保留了前代模型强大的智能与可靠性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55ddd725adf74b11b465b770714b331b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=vm%2Beoo2n%2Ba%2B1oAndakPJ5eVRPIE%3D" alt="图片" loading="lazy"/></p>
<p>马斯克在 x 上宣传一波自家模型。</p>
<p>为实现这些提升，xAI 在支撑 Grok 4 的同一套大规模强化学习基础设施上进一步优化了模型的风格、个性、助人性和对齐性。并且，为了优化这些不可直接验证的奖励信号，xAI 开发了全新的方法，能够利用前沿的智能体式推理模型作为奖励模型，从而可以大规模自主评估并迭代输出结果。</p>
<p>与此前的线上生产模型相比，Grok 4.1 在对比评估中有 64.78% 的概率被用户偏好选择。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dcd91aa78964f02828c77cb7685a16f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=0RyrGnPSiiXvTbF%2B6SUZ8ZXApVU%3D" alt="图片" loading="lazy"/></p>
<p>接下来看 Grok 4.1 的能力特征。</p>
<p>SOTA 通用能力</p>
<p>Grok 4.1 在盲测的人类偏好评估中树立了全新的标杆。</p>
<p>在 LMArena 的 Text Arena 排行榜上，Grok 4.1 的推理模式（代号：quasarflux）以 1483 的 Elo 分数位居总榜首位，领先最高的非 xAI 模型整整 31 分。</p>
<p>Grok 4.1 的非推理模式（代号：tensor）无需使用思维 token 便能即时响应，在排行榜上以 1465 Elo 分数位居第二。即便不启用推理，Grok 4.1 也超越了其他所有模型在启用完整推理配置下的表现。</p>
<p>与 Grok 4 相比，Grok 4.1 的整体表现实现了大幅超越 ，前者此前的总排名仅为第 33 名。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67f16f9f7ec04a0da2e0896c2e9561ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=ROe4bkPKux4pFyQz%2FVIXpOAaBDw%3D" alt="图片" loading="lazy"/></p>
<p>情感智能</p>
<p>为了评估模型在个性与人际互动能力方面的进展，xAI 在 EQ-Bench3 上对 Grok 4.1 进行了测试。</p>
<p>EQ-Bench 是一个由大语言模型评判的测试，用于评估主动情绪智能，包括情绪理解、洞察力、同理心以及人际交往技能。测试集包含 45 个具有挑战性的角色扮演场景，其中大多数由预先编写的三轮对话提示组成。该基准通过多项标准验证模型的回答质量，以评估模型表现。此外，它还通过成对对比的方式，为排行榜中的每个模型计算归一化的 Elo 分数。</p>
<p>xAI 使用官方基准仓库运行测试，并报告评分细则（rubric score）与归一化 Elo 分数。所有分数均在遵循基准要求的条件下计算：使用默认采样参数、指定的评判模型（Claude Sonnet 3.7），并且不添加 system prompt。</p>
<p>结果显示，Grok 4.1 的推理模式和非推理模式位居榜单前两名。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb20cbc5d0874a41b5ffbd384303efca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=3EGpUXBspq31AGKxpW53R3CT4tU%3D" alt="图片" loading="lazy"/></p>
<p>以下示例展示了 Grok 4.1 对情绪类提示的回应方式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41dde2d05f38484ea824284d420ee7a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=vAHJ7rsrr0wwnEmechI7YwFbwBw%3D" alt="图片" loading="lazy"/></p>
<p>创意写作</p>
<p>xAI 还在 Creative Writing v3 基准测试上评估了 4.1 系列模型的表现。</p>
<p>在该基准中，模型需要针对 32 个不同的写作提示生成回答，并进行 3 轮迭代。与 EQ-Bench 类似，评分同时基于评分细则（rubrics）和模型对战的归一化 Elo 分数进行计算。</p>
<p>结果显示，Grok 4.1 的推理模式和非推理模式位居基准测试第二和第三名，仅次于早期 GPT 5.1。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19a8047a80c4433981049c8c8b857362~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=wlDcVgLfG07AJe9%2BRXMj257T%2BPY%3D" alt="图片" loading="lazy"/></p>
<p>以下示例展示了 Grok 4.1 在创意写作提示下的回答方式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de820a06b4024c079d5c287d971d2e24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=hFuhayXLZvZeA%2FeanQqvnaHY1zA%3D" alt="图片" loading="lazy"/></p>
<p>减少幻觉</p>
<p>配备搜索工具的 Fast（非推理）模型能够提供即时答案，但由于推理深度受限、工具调用次数有限，它们更容易出现事实性错误。</p>
<p>在 Grok 4.1 的后训练过程中，xAI 着重降低了信息查询类提示的事实幻觉。随后，xAI 在抽样的生产环境信息查询提示中观察到了幻觉率的显著下降。</p>
<p>xAI 使用来自生产流量的真实信息查询请求，按类别分层抽样评估模型幻觉率。同时，也评测了 FActScore —— 一个包含 500 个关于不同人物的传记类问题的公共基准测试。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5b7d51746a443569438d0dc42e7d139~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=tVBi1VDTkn%2B4T2XcEE9sFgZHpVk%3D" alt="图片" loading="lazy"/></p>
<p>更多 Grok 4.1 的技术细节请参阅模型卡：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf8541313064a3f956bbf61a7b9d566~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764066635&amp;x-signature=gALyFvA2LRt%2BaFcIZjeHGeMV%2B0w%3D" alt="图片" loading="lazy"/></p>
<p>模型卡地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdata.x.ai%2F2025-11-17-grok-4-1-model-card.pdf" target="_blank" title="https://data.x.ai/2025-11-17-grok-4-1-model-card.pdf" ref="nofollow noopener noreferrer">data.x.ai/2025-11-17-…</a></p>
<p>官方博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.ai%2Fnews%2Fgrok-4-1%255B%23silent%255D()-rollout-november-114-2025" target="_blank" title="https://x.ai/news/grok-4-1%5B#silent%5D()-rollout-november-114-2025" ref="nofollow noopener noreferrer">x.ai/news/grok-4…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如果让我从头再来学习并发编程]]></title>    <link>https://juejin.cn/post/7573876900230627391</link>    <guid>https://juejin.cn/post/7573876900230627391</guid>    <pubDate>2025-11-18T10:44:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573876900230627391" data-draft-id="7573506713867190323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如果让我从头再来学习并发编程"/> <meta itemprop="keywords" content="Java,性能优化,设计模式"/> <meta itemprop="datePublished" content="2025-11-18T10:44:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如果让我从头再来学习并发编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T10:44:59.000Z" title="Tue Nov 18 2025 10:44:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大学时，我学习了一本国外的教科书，书名叫做《计算机网络——自顶向下方法》，这本书改变了我看待学习的角度。学习的顺序不是一成不变的，常规的路线通常从底层学习，这本书从应用层面入手，逐步讲解到底层，以一种对常规学习路线相反的方向学习，在我看来恰恰学习计算机网络最轻松上手的路径。很多时候我们追求一步到位，鞭辟入里的理解，反而忽略对于初学者，最佳的学习路线往往是兴趣与试错、感性和求索交织的，认识是逐渐深刻的。</p>
<p>知之者往往陷入知识的诅咒，知道的内容很难遗忘，甚至忘记了自己也是从不理解到懂的。有些书籍和文章对于初学者来说是不友好的，它们往往默认你掌握了很多前置知识。如果让我重头学习并发编程，我希望有类似自顶向下的学习路线。</p>
<p>以下是我总结的学习路线，感兴趣的朋友可以参考：</p>
<p>一、基础（并发与并行，性能与瓶颈，SIMD，MISD，进程、线程模型，虚拟线程，生命周期，上下文切换的开销有多大，跳过同步器、JMM等底层内容）<br/>
二、常用的并发模式</p>
<ol>
<li>单线程（单线程实现简单且高效，很多多线程问题可以使用单线程解决）</li>
<li>ThreadLocal/ScopedValue/TTL</li>
<li>消息队列（生产者消费者模式）</li>
<li>结构化并发（任务编排、资源安全管理、可观测性、快速失败思想）</li>
<li>函数式解决方案（纯函数、不可变对象、CopyOnWrite）</li>
<li>执行器与线程池（分离任务与执行的思想、资源管理与生命周期、多种执行器的特点(缓存执行器、固定线程执行器、线性执行器、直接执行器)、舱壁模式）</li>
<li>异步编程：CompletableFuture/ListenableFuture(函数式思想、回调地狱、任务编排/拆分、取消传播）</li>
<li>调度器（ScheduledExecutorService（常常被忽略却很有用），资源管理与调度算法)</li>
<li>延迟计算与记忆化，缓存与SingleFlight模式</li>
<li>ForkJoin框架，并行流，分治思想</li>
<li>EventLoop</li>
</ol>
<p>三、并发集合类，使用与陷阱，阻塞队列<br/>
四、原子操作与原子类<br/>
五、锁（临界区、锁接口设计、锁的特点、可重入锁、读写锁、等待队列、条件队列，原生隐式同步锁，选择/构造线程安全的数据结构）<br/>
六、同步器和相关类（信号量、mutex、几种栅栏）<br/>
七、活性问题：死锁、饥饿、活锁，如何避免<br/>
八、性能优化、测试、监控、debug<br/>
九、底层实现原理（可见性、原子性、有序性）JMM，volatile实现（可见性窗口技巧），竞争条件，happens-before，DCL，VarHandler</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[啊？微博7800美元训的大模型，数学能力超了DeepSeek-R1]]></title>    <link>https://juejin.cn/post/7573864324713037876</link>    <guid>https://juejin.cn/post/7573864324713037876</guid>    <pubDate>2025-11-18T09:12:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573864324713037876" data-draft-id="7573708620870484020" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="啊？微博7800美元训的大模型，数学能力超了DeepSeek-R1"/> <meta itemprop="keywords" content="DeepSeek,AI编程"/> <meta itemprop="datePublished" content="2025-11-18T09:12:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            啊？微博7800美元训的大模型，数学能力超了DeepSeek-R1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:12:07.000Z" title="Tue Nov 18 2025 09:12:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当整个 AI 行业陷入 “参数竞赛” 的狂热时，<strong>微博 AI</strong> 交出了一份出乎意料的答卷，为沸腾的大模型战场开辟了一条充满想象力的新路径。</p>
<p>近日，微博正式发布首个自研开源大模型 <strong>VibeThinker</strong>，这个仅拥有 15 亿参数的 “轻量级选手”，在国际顶级数学竞赛基准测试上击败了参数量是其数百倍的、高达 6710 亿的 DeepSeek R1 模型。</p>
<p>更令人瞩目的是，其单次 “后训练” 的成本仅 <strong>7800 美元</strong>，对比 DeepSeek-R1 和 MiniMax-M1 等成本直接降低了几十倍。</p>
<p>这一突破不仅重新定义了大模型的技术评价标准，更有望推动 AI 产业从 “规模竞赛” 转向“效率革命”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a59affe4dde4148b88ef0ba6dc61ef9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061927&amp;x-signature=IC1buZbQ0ls%2FLvC%2FNUjegmZWFQo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">行业黑马：小模型打破参数崇拜</h2>
<p>在 AI 发展史上，参数量曾被视为衡量模型能力的核心指标。</p>
<p>行业普遍认为，复杂推理能力需要 1000 亿以上参数才能涌现，而小模型则因无法处理高难度问题被视为 “天生不足”。</p>
<p>但如果从小模型入手，通过巧妙的训练策略，能否挖掘出隐藏的推理能力？</p>
<p>微博自研开源大模型 VibeThinker，给出了行业一个肯定的答案。</p>
<p>当大多数 AI 厂商仍遵循着 “规模扩大即智能提升” 的 Scaling Law 法则时，微博 AI 研发人员转而优化模型结构和训练范式，并创新提出了 <strong>“频谱到信号原理”（SSP）方法训练</strong>，创造出了一个仅拥有 15 亿参数的 “轻量级选手”，但在 AI 竞技场上战胜了超越其数百倍体量的 “巨人”。</p>
<p>VibeThinker 一经发布，立即引起了全球 AI 研究界的广泛关注，因其在一系列涵盖数学、编码的权威基准测试中，交出了一份出乎意料的答卷：</p>
<h6 data-id="heading-1"><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04aa5cd0871c4584ade49bb031827622~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061927&amp;x-signature=mkEvGgyjTUN48nHTqdei7pTl3rg%3D" alt="" loading="lazy"/>△</strong>HuggingFace 官方主动下场发文宣传 VibeThinker 论文</h6>
<p>在 AIME24、AIME25 以及 HMMT25 三个高难度数学测试集上的表现，VibeThinker 超越了参数量超其 400 倍的模型 DeepSeek-R1-0120 版本_（模型大小 671B）_，与规模为 456B 的 MiniMax-M1 效果接近或相当，甚至媲美 Gemini 2.5 flash 和 Claude Opus 4。</p>
<p>此外，在 LiveCodeBench v6_（编程算法题测试集）_中的成绩，VibeThinker 成功追平参数量数超其数十倍的模型，比如欧洲领先 AI 企业 Minstral.AI 的深度思考模型 Magistral-Medium-2506 版本。</p>
<p>VibeThinker 雄辩地证明，通过精巧的算法设计和训练策略，一个小规模模型完全有潜力在复杂的逻辑推理任务上，达到甚至超越那些体量庞大数百倍的巨型模型，更为 AI 产业的成本结构、技术路线和资本布局带来了全新的思考路径。</p>
<p>需要说明的是，VibeThinker 目前发布的版本尚处于实验性版本，其研发重点主要集中于极大强化小模型复杂数学与竞赛编程等方面的能力，其在日常聊天等能力还没有做过针对性训练优化，所以暂不适合作为日常聊天工具进行互动，更适用于<strong>数学和代码</strong>等高智能应用场景。</p>
<h2 data-id="heading-2">成本革命：7800 美元门槛重塑产业生态</h2>
<p>训练成本一直是制约 AI 技术普及的关键瓶颈，VibeThinker 的成就不仅在于惊艳的性能，更在于其极致的成本效益。</p>
<p>根据公开数据，2025 年主流大模型单次后训练_（Post-Training）_成本普遍在数十万美元级别。</p>
<p>上海 AI 企业 MiniMax 于今年 6 月发布的 M1 模型，使用 512 块 H800 GPU 训练三周，租赁成本约 53.5 万美元，创始人发文表示：“第一次感觉到大山不是不能翻越。”</p>
<p>今年 9 月，AI 初创公司 DeepSeek_（深度求索）_的论文登上《自然》杂志。论文首次揭示了训练 R1 的成本：仅为 29.4 万美元。这不包括 DeepSeek 公司在开发 R1 所基于的基础 LLM（即 DeepSeek-V3）上花费的约 600 万美元，但总成本仍然远低于竞争对手模型被认为花费的数千万美元。</p>
<p>在这样的行业背景下，VibeThinker 整个后训练过程_（包括 SFT 和 RL 阶段）_总共只花费了约 3900 个 GPU 小时。按照当时的市场租赁价格，总计算成本仅 <strong>7800 美元</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de4b4818825547d8bd4890a3433f90e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061927&amp;x-signature=35reAQHx62rIIVmSIdApDIrxXXg%3D" alt="" loading="lazy"/></p>
<p>这也意味着，其用不到 8000 美元的成本，达到了需要花费 30 万、甚至 50 万美元才能企及的性能水平，成本效益比达到了惊人的 <strong>30 到 60 倍</strong>。</p>
<p>这种成本上的显著优势，也意味着强大的 AI 推理能力不再是少数科技巨头的专利，原本被巨头垄断的技术资源得以普惠，更多中小型公司、研究机构和大学，都有机会参与到前沿 AI 创新开发中来，极大地促进了 AI 研究的普惠化，推动整个行业朝着更开放、更多元、更具活力的方向发展。</p>
<h2 data-id="heading-3">应用落地：微博 AI 生态多点开花</h2>
<p>技术突破的最终价值在于<strong>应用落地</strong>。</p>
<p>微博积极拥抱人工智能发展趋势，全面促进 AI 技术在多项业务场景的落地。</p>
<p>2024 年，微博自主研发 <strong>“知微” 大语言模型</strong>，并成功通过备案，更陆续推出微博智搜、内容总结、AI 互动号等前沿功能，优化用户体验，提升内容生产和互动效率。</p>
<p>基于自研的 “知微” 大模型，微博构建了适配微博场景的 AI 应用生态，并创造了两大顶流 AI 产品：</p>
<ul>
<li>
<p>一是<strong>微博智搜</strong>，它通过深度分析平台内海量优质内容，构建可信知识图谱，实现 “精准捕捉用户需求、理解情感与场景” 的突破性体验，6 月智搜月活跃用户突破 5000 万；</p>
</li>
<li>
<p>二是<strong>评论罗伯特</strong>，作为 AI 互动账号，它从毒舌风格起步，逐渐进化出温情与聪明版本，成为广大用户 “又爱又恨” 的交流对象，全网粉丝近 200 万，展现了 AI 评论助手的另一种可能性。</p>
</li>
</ul>
<p>随着自研大模型 VibeThinker 取得突破，更标志着微博 AI 战略迈入新阶段。</p>
<p>立足于自研大模型 VibeThinker，微博的未来规划凸显了鲜明的 “数据赋能” 路径。公司计划深度融合其在心理等垂直领域积累的独特数据资产，目标是打造一个更洞悉公众情绪、更能服务社会化需求的专属模型。</p>
<p>微博不仅是在优化一个大模型，更是在解锁其数据生态的深层价值，以提供更精准、更懂用户心理状态的下一代社交服务。</p>
<p>VibeThinker 的强大技术能力，或将成为驱动微博 AI 应用 “多点开花” 的核心引擎，深度融入平台全业务生态。</p>
<p>未来，VibeThinker 有望在微博智搜等核心 AI 产品中落地，不仅能持续提升用户使用体验，更有望打破场景边界，裂变出兼具社交属性与智能服务的下一个 “社交超级生态”。</p>
<p>此外，VibeThinker 的技术突破有望大幅降低微博 AI 应用成本。</p>
<p>无论是智能搜索的算力损耗，还是实时互动场景的 AI 响应成本，都将得到高效优化，让平台在规模化投入 AI 能力时无需承担过高的资源压力，进一步释放微博的生态创新能力，为用户带来更丰富、更便捷的智能体验。</p>
<ul>
<li>本文系量子位获授权刊载，观点仅为原作者所有。</li>
</ul>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[App Store 上架条件全解析，开发者必备资质、技术要求与跨平台工具指南]]></title>    <link>https://juejin.cn/post/7573863952116269062</link>    <guid>https://juejin.cn/post/7573863952116269062</guid>    <pubDate>2025-11-18T09:22:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573863952116269062" data-draft-id="7573855399717191699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="App Store 上架条件全解析，开发者必备资质、技术要求与跨平台工具指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-18T09:22:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS开发上架哦"/> <meta itemprop="url" content="https://juejin.cn/user/3336394949004844"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            App Store 上架条件全解析，开发者必备资质、技术要求与跨平台工具指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3336394949004844/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS开发上架哦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:22:54.000Z" title="Tue Nov 18 2025 09:22:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>对于许多首次准备发布 iOS 应用的开发者来说，“满足 App Store 上架条件” 比写代码更让人焦虑。
有人认为只要上传 IPA 就好，有人认为必须要用 Mac，还有人被证书、截图、隐私政策等要求卡得寸步难行。</p>
<p>事实上，App Store 上架并不是神秘流程，而是由一系列明确且严格的条件组成。
只要理解这些条件背后的逻辑，准备工作会非常高效；
甚至在 <strong>Windows 或 Linux</strong> 环境下，也可以顺利完成整个上架流程。</p>
<p>本文将以开发者实战角度，拆解 <strong>App Store 上架必须满足的条件</strong>，并给出在不同系统环境下的可行实现方案。</p>
<hr/>
<h2 data-id="heading-0">一、App Store 上架的基本条件是什么？</h2>
<p>苹果对于应用上架有明确要求，总体可分为三类：</p>
<h3 data-id="heading-1"><strong>1. 开发者资质条件</strong></h3>
<p>必须满足：</p>
<ul>
<li>购买 Apple Developer Program（$99/年）</li>
<li>提供真实的开发者身份信息（个人或企业）</li>
<li>通过 App Store Connect 创建应用项目</li>
</ul>
<h3 data-id="heading-2"><strong>2. 技术条件</strong></h3>
<p>包括：</p>
<ul>
<li>合法签名（证书 + 描述文件）</li>
<li>生成正确的 iOS IPA 文件</li>
<li>应用可在真机稳定运行</li>
<li>权限用途说明完整（Info.plist）</li>
<li>应用截图满足规范</li>
</ul>
<h3 data-id="heading-3"><strong>3. 审核条件</strong></h3>
<p>审核主要检查：</p>
<ul>
<li>功能是否完整</li>
<li>是否存在隐私违规</li>
<li>页面内容是否真实</li>
<li>是否使用安全的登录与支付方式</li>
</ul>
<p>任何一个环节不符合要求，都可能导致拒审。</p>
<hr/>
<h2 data-id="heading-4">二、开发者账号：上架的基础条件</h2>
<p>申请 App Store 上架必须满足以下账号条件：</p>
<ol>
<li><strong>加入 Apple Developer Program（付费）</strong></li>
<li>账号状态正常（无未支付费用或合规问题）</li>
<li>能访问 App Store Connect 和证书管理页面</li>
</ol>
<p>企业账号（Company）可以邀请多个成员协作，而个人账号（Individual）权限比较集中。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c27b0384d34c444396e8515c6582e9e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T5byA5Y-R5LiK5p625ZOm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764062574&amp;x-signature=fNeV9nFvV7TdqzL78REUOxRixJY%3D" alt="账号" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-5">三、证书与描述文件：技术条件的核心</h2>
<p>iOS 应用发布需要满足完整的签名体系，包括：</p>
<ul>
<li><strong>iOS Distribution Certificate</strong>（发布证书）</li>
<li><strong>App Store Provisioning Profile</strong>（描述文件）</li>
<li><strong>App ID（Bundle Identifier）</strong></li>
</ul>
<p>没有正确证书，App Store 不会接受上传。</p>
<h3 data-id="heading-6">传统方式</h3>
<p>在 macOS 上使用钥匙串助手生成 CSR 再生成证书。</p>
<h3 data-id="heading-7">跨平台方式（无需 Mac）</h3>
<p>如今开发者可在 Windows 上生成证书，使用开心上架（Appuploader）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49fd295050104dcf8f475d07615e3f01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T5byA5Y-R5LiK5p625ZOm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764062574&amp;x-signature=fURB1r5v5ZZfAUBEfwYjuqGpq4U%3D" alt="证书" loading="lazy"/></p>
<p>即可生成：</p>
<ul>
<li>p12 证书</li>
<li>描述文件</li>
<li>与 Apple 账号匹配的配置</li>
</ul>
<p>支持跨电脑使用，适合团队协作。</p>
<hr/>
<h2 data-id="heading-8">四、IPA 构建要求：上架必须提供正确的包文件</h2>
<p>苹果要求上传 IPA 文件（iOS App 的打包格式），必须满足：</p>
<ul>
<li>版本号合法（遵循 major.minor.patch）</li>
<li>使用 App Store 描述文件签名</li>
<li>支持 64 位架构</li>
<li>无调试符号和开发者残留配置</li>
</ul>
<h3 data-id="heading-9">技术栈不同，IPA 构建方式不同：</h3>
<h4 data-id="heading-10"><strong>1. 原生 iOS（Xcode）</strong></h4>
<p>必须使用 macOS 构建。</p>
<h4 data-id="heading-11"><strong>2. uni-app / HBuilderX</strong></h4>
<p>可使用云端打包服务，Windows 和 Linux 均可生成 IPA。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959f67ac27244185b5c6bed5d3b0e92f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T5byA5Y-R5LiK5p625ZOm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764062574&amp;x-signature=6krt9RtBK9%2BbiQSbxqvqNGAIER0%3D" alt="hb打包" loading="lazy"/></p>
<h4 data-id="heading-12"><strong>3. Flutter / React Native / Cocos / Unity</strong></h4>
<p>常用云构建平台：</p>
<ul>
<li>Codemagic</li>
<li>Bitrise</li>
<li>GitHub Actions（Mac Runner）</li>
</ul>
<p>构建完成后即可获得 IPA。</p>
<hr/>
<h2 data-id="heading-13">五、IPA 上传条件：必须使用符合苹果协议的上传方式</h2>
<p>苹果规定 IPA 必须通过官方协议上传。</p>
<h3 data-id="heading-14">苹果官方方式（仅 macOS）</h3>





















<table><thead><tr><th>工具</th><th>说明</th></tr></thead><tbody><tr><td>Xcode Organizer</td><td>支持发布</td></tr><tr><td>Transporter</td><td>图形化 IPA 上传</td></tr><tr><td>altool</td><td>已废弃</td></tr></tbody></table>
<h3 data-id="heading-15">跨平台上传方式（Windows / Linux 可用）</h3>
<p>开发者可使用跨平台上传工具，例如：</p>
<h4 data-id="heading-16"><strong>开心上架（Appuploader）命令行上传 IPA</strong></h4>
<p>示例命令：</p>
<pre><code class="hljs language-bash" lang="bash">appuploader_cli -u ios@team.com -p xxx-xxx-xxx-xxx -c 2 -f ./output/app.ipa
</code></pre>
<p>可以满足苹果上传条件，且支持：</p>
<ul>
<li>新旧两种上传通道</li>
<li>全平台系统（Win/Mac/Linux）</li>
<li>自动化脚本</li>
<li>无需登录 Xcode 或 Transporter</li>
</ul>
<p>上传成功后，可在：</p>
<ul>
<li>TestFlight</li>
<li>App Store Connect “构建版本”</li>
</ul>
<p>看到构建记录。</p>
<hr/>
<h2 data-id="heading-17">六、App Store Connect 信息填写条件</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc81dac899648ef87aef789e73c225a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T5byA5Y-R5LiK5p625ZOm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764062574&amp;x-signature=wT2IzcGkX7eNYN1F1d4wZbJxSJY%3D" alt="asc" loading="lazy"/></p>
<p>苹果有严格的元数据要求，包括：</p>
<h3 data-id="heading-18"><strong>1. 截图要求</strong></h3>
<p>必须上传真实截图（不同设备尺寸）：</p>
<ul>
<li>6.5 寸 iPhone</li>
<li>5.5 寸 iPhone</li>
<li>iPad（如适配）</li>
</ul>
<h3 data-id="heading-19"><strong>2. 隐私政策 URL</strong></h3>
<p>必须是能访问的网页。</p>
<h3 data-id="heading-20"><strong>3. 权限用途说明</strong></h3>
<p>如应用使用：</p>
<ul>
<li>相机</li>
<li>麦克风</li>
<li>相册</li>
<li>定位</li>
</ul>
<p>必须在 Info.plist 中提供用途描述。</p>
<h3 data-id="heading-21"><strong>4. 分类、评级、联系方式</strong></h3>
<p>必须按照要求填写完整。</p>
<p>不符合条件会直接退回审核。</p>
<hr/>
<h2 data-id="heading-22">七、审核条件：功能完整、合规、可用</h2>
<p>苹果最重视以下几点：</p>

































<table><thead><tr><th>审核项</th><th>描述</th></tr></thead><tbody><tr><td>功能完整性</td><td>App 不可闪退、不可出现空白页</td></tr><tr><td>内容真实性</td><td>截图与功能必须一致</td></tr><tr><td>隐私合规</td><td>不得泄露用户数据</td></tr><tr><td>登录机制</td><td>必须规范（含 Apple 登录规则）</td></tr><tr><td>支付规范</td><td>不得绕过 IAP 机制</td></tr><tr><td>版权内容</td><td>不得侵犯版权（音乐、视频、图片等）</td></tr></tbody></table>
<p>审核人员会真机测试 App，如果表现异常，会直接拒绝。</p>
<hr/>
<h2 data-id="heading-23">满足条件后，上架流程变得简单</h2>
<p>一旦满足这些条件：</p>
<ul>
<li>有开发者账号</li>
<li>有合法证书</li>
<li>能构建 IPA</li>
<li>能上传 IPA</li>
<li>能填写完整元数据</li>
</ul>
<p>上架流程实际上是可控、可复用、可自动化的工程步骤。</p>
<p>无论是在 macOS、Windows 还是 Linux 环境中，都可以完成整个流程。
参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.applicationloader.net%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://www.applicationloader.net/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">www.applicationloader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解析视觉：视觉识别的七层模型]]></title>    <link>https://juejin.cn/post/7573863952116285446</link>    <guid>https://juejin.cn/post/7573863952116285446</guid>    <pubDate>2025-11-18T09:26:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573863952116285446" data-draft-id="7573738017988280363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解析视觉：视觉识别的七层模型"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-18T09:26:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Juchecar"/> <meta itemprop="url" content="https://juejin.cn/user/284133851925070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解析视觉：视觉识别的七层模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/284133851925070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Juchecar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:26:16.000Z" title="Tue Nov 18 2025 09:26:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>将视觉识别划分为一个从低到高、从具体到抽象的<strong>七层模型</strong>。这个模型不仅涵盖了已知过程，也自然引向了更低和更高的层次。</p>
<hr/>
<h3 data-id="heading-0">视觉识别的七层模型</h3>
<p>下面的流程图清晰地展示了这七个层次如何逐级演进，从底层的信号处理直至顶层的哲学思考：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A["第1层&lt;br&gt;物理信号检测"] --&gt; B["第2层&lt;br&gt;特征提取"]
    B --&gt; C["第3层&lt;br&gt;初步整合"]
    C --&gt; D["第4层&lt;br&gt;客体识别"]
    D --&gt; E["第5层&lt;br&gt;意义赋予"]
    E --&gt; F["第6层&lt;br&gt;审美判断"]
    F --&gt; G["第7层&lt;br&gt;哲学反思"]
</code></pre>
<h4 data-id="heading-1"><strong>层次 1 &amp; 2: 从物理信号到视觉特征</strong></h4>
<p>这是视觉处理的起点。首先，<strong>视网膜</strong>上的感光细胞（第1层）捕获光子，完成光电转换。随后，信号在视网膜内和<strong>初级视觉皮层</strong>进行初步加工（第2层），提取出线条、朝向、颜色、运动方向等最基本的视觉特征。此时，大脑处理的仍是“数据”，而非“形象”。</p>
<h4 data-id="heading-2"><strong>层次 3 &amp; 4: 从局部特征到完整客体</strong></h4>
<p>大脑开始将零散的特征“组装”起来。在<strong>V2、V4等视觉区</strong>（第3层），线段被组合成轮廓，颜色和形状被初步绑定。随后，在<strong>下颞叶皮层</strong>等高级区域（第4层），这些信息被整合成有意义的、独立的“客体”，如一张脸、一把椅子、一个单词。这时，你知道了“<strong>那里有什么</strong>”。</p>
<h4 data-id="heading-3"><strong>层次 5 &amp; 6: 从客体识别到价值判断</strong></h4>
<p>这是产生“意义”和“感受”的关键跃迁。当客体被识别后，大脑的<strong>记忆系统（海马体）、情绪系统（杏仁核）和奖赏系统</strong>被广泛激活（第5层），为你识别的客体赋予含义和情感价值——它是朋友的脸、是危险的蛇、是心爱的礼物。</p>
<p>在此基础上，一个更复杂的评估网络开始工作（第6层）。这个网络综合了来自本能、文化、个人经验的信号，对这个客体做出一个<strong>情感性和价值性</strong>的判断——它是美的、丑的、吸引人的还是令人厌恶的。这就是<strong>审美判断</strong>的形成。</p>
<h4 data-id="heading-4"><strong>层次 7: 超越个体的哲学反思</strong></h4>
<p>这是最高、最抽象的层次。它超越了即时的、个人的好恶，涉及<strong>元认知</strong>和<strong>抽象思维</strong>，主要依赖于高度发达的<strong>前额叶皮层</strong>。在这个层面，我们反思的已不是对象本身，而是“美”的本质：</p>
<ul>
<li>“为什么我认为这是美的？”</li>
<li>“美是客观存在的吗？”</li>
<li>“我的审美观是如何被社会塑造的？”</li>
<li>“丑在艺术中可以扮演什么角色？”</li>
</ul>
<hr/>
<h3 data-id="heading-5">还有更低或更高的层次吗？</h3>
<p><strong>1. 更低的层次：亚神经处理与物理世界</strong>
从严格意义上讲，在视网膜处理之前，还存在：</p>
<ul>
<li><strong>物理光学层</strong>：光线在通过角膜、晶状体时的折射，瞳孔对光量的调节。这属于物理过程。</li>
<li><strong>光化学层</strong>：视色素分子在吸收光子后发生的异构化反应。这属于生物化学过程。</li>
</ul>
<p>但这些通常不被认为是“神经识别”的一部分，而是视觉系统的<strong>前置信号准备</strong>阶段。因此，我们的模型从神经信号的产生和初步检测开始是合理的。</p>
<p><strong>2. 更高的层次：系统级影响与哲学建构</strong>
在哲学反思之上，视觉识别的影响还能继续向外延伸，进入更广阔的系统：</p>
<ul>
<li><strong>文化建构层</strong>：个人的审美判断汇聚成群体性的审美潮流，进而影响艺术批评、设计哲学和整个时代的文化风貌。一个人的辨别行为，成为了社会文化建构的一部分。</li>
<li><strong>形而上学层</strong>：这是最极致的“高阶层”，它追问的是视觉识别与存在本身的关系。例如：“我们通过视觉所辨别的世界，是世界的本来面目吗？”（康德的自在之物问题），或“视觉经验如何塑造了我们对‘实在’的理解？”</li>
</ul>
<h3 data-id="heading-6">结论</h3>
<p>这个七层模型是一个强大的框架，它清晰地描绘了视觉信息如何从物理信号一步步转化为人类最复杂的抽象思维和情感体验。<strong>层次越低，处理越自动、越普遍（几乎所有视觉健全的人类都共享）；层次越高，处理越受控、越具个体性和文化特异性。</strong></p>
<p>因此，从“看见红色”到“认为一幅红色调的画作是杰作”，中间跨越的正是这个从感觉感知到价值创造、从生物学到哲学的宏大光谱。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习React-DnD：实现多任务项拖动-维护多任务项数组]]></title>    <link>https://juejin.cn/post/7573864324713185332</link>    <guid>https://juejin.cn/post/7573864324713185332</guid>    <pubDate>2025-11-18T09:28:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573864324713185332" data-draft-id="7573680361990471720" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习React-DnD：实现多任务项拖动-维护多任务项数组"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-11-18T09:28:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Wect"/> <meta itemprop="url" content="https://juejin.cn/user/4185164878720068"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习React-DnD：实现多任务项拖动-维护多任务项数组
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185164878720068/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Wect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:28:44.000Z" title="Tue Nov 18 2025 09:28:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、功能承接与需求概述</h2>
<p>上一篇文档中，我们已完成单个任务项的拖动排序功能。本次迭代的核心需求是实现<strong>多个任务项的批量选中</strong>，具体需达成以下目标：</p>
<ul>
<li>扩展状态管理，支持存储选中的任务项集合</li>
<li>新增选中、取消选中任务项的操作逻辑</li>
<li>在任务项组件中关联单选框与选中状态的交互</li>
</ul>
<h2 data-id="heading-1">二、核心状态扩展（TodoProvider）</h2>
<p>要实现多任务选中与拖拽，首先需要在全局状态中新增“选中任务集合”字段，并同步更新上下文供组件调用。</p>
<h3 data-id="heading-2">2.1 初始化状态修改</h3>
<p>在<code>initialState</code>中添加<code>selectedTodos</code>数组，用于存储当前选中的任务项，同时确保任务项模型的完整性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> initialState = {
  <span class="hljs-attr">todos</span>: [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'Learn React'</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">selected</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'Build a Todo App'</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">selected</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'Build a Demo'</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">selected</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'Fix a Bug'</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">selected</span>: <span class="hljs-literal">true</span> },

  ],
  <span class="hljs-comment">// 当前选中的任务数组</span>
  <span class="hljs-attr">selectedTodos</span>: [{ <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'Fix a Bug'</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">selected</span>: <span class="hljs-literal">true</span> }],
};
</code></pre>
<h3 data-id="heading-3">2.2 上下文同步更新</h3>
<p>将新增的<code>selectedTodos</code>状态注入上下文，确保子组件能获取到选中任务集合：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// TodoProvider内部的上下文值配置</span>
<span class="hljs-keyword">const</span> contextValue = {
  <span class="hljs-attr">todos</span>: state.<span class="hljs-property">todos</span>,
  <span class="hljs-attr">selectedTodos</span>: state.<span class="hljs-property">selectedTodos</span>,
  ...actions,
};
</code></pre>
<h2 data-id="heading-4">三、核心操作逻辑实现（Reducer）</h2>
<p>基于需求新增两个核心操作类型：<code>ADD_SELECT_TODOS</code>（添加选中任务）、<code>REMOVE_SELECT_TODOS</code>（移除选中任务），以下是完整实现逻辑。</p>
<h3 data-id="heading-5">3.1 操作类型常量定义（建议单独维护）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ActionTypes.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ActionTypes</span> = {
  <span class="hljs-comment">// 原有操作类型...</span>
  <span class="hljs-attr">ADD_SELECT_TODOS</span>: <span class="hljs-string">'ADD_SELECT_TODOS'</span>,
  <span class="hljs-attr">REMOVE_SELECT_TODOS</span>: <span class="hljs-string">'REMOVE_SELECT_TODOS'</span>,
};
</code></pre>
<h3 data-id="heading-6">3.2 添加选中任务（ADD_SELECT_TODOS）</h3>
<p>通过任务ID查找目标任务，确保任务存在且未被选中后，添加到<code>selectedTodos</code>集合中，避免重复选中：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ADD_SELECT_TODOS</span>
<span class="hljs-keyword">case</span> <span class="hljs-title class_">ActionTypes</span>.<span class="hljs-property">ADD_SELECT_TODOS</span>:
  {
    <span class="hljs-comment">// 找到要添加的todo对象</span>
    <span class="hljs-keyword">const</span> todoToAdd = state.<span class="hljs-property">todos</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> === action.<span class="hljs-property">payload</span>.<span class="hljs-property">id</span>);
    <span class="hljs-comment">// 确保todo存在且尚未被选中（避免重复添加）</span>
    <span class="hljs-keyword">if</span> (todoToAdd &amp;&amp; !state.<span class="hljs-property">selectedTodos</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> === todoToAdd.<span class="hljs-property">id</span>)) {
      <span class="hljs-keyword">return</span> {
        ...state,
        <span class="hljs-attr">selectedTodos</span>: [...state.<span class="hljs-property">selectedTodos</span>, todoToAdd],
      };
    }
    <span class="hljs-keyword">return</span> state;
  }
</code></pre>
<h3 data-id="heading-7">3.3 移除选中任务（REMOVE_SELECT_TODOS）</h3>
<p>根据任务ID从<code>selectedTodos</code>集合中过滤掉目标任务：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// REMOVE_SELECT_TODOS</span>
<span class="hljs-keyword">case</span> <span class="hljs-title class_">ActionTypes</span>.<span class="hljs-property">REMOVE_SELECT_TODOS</span>:
  <span class="hljs-keyword">return</span> {
    ...state,
    <span class="hljs-attr">selectedTodos</span>: state.<span class="hljs-property">selectedTodos</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> !== action.<span class="hljs-property">payload</span>.<span class="hljs-property">id</span>),
  };
</code></pre>
<h2 data-id="heading-8">四、任务项组件交互（TodoItem）</h2>
<p>在TodoItem组件中，通过Ref绑定单选框，并在单选框状态变化时，触发选中/取消选中的操作，实现视图与状态的同步。</p>
<h3 data-id="heading-9">4.1 组件核心逻辑</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useContext, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> useTodoContext <span class="hljs-keyword">from</span> <span class="hljs-string">'@/context/TodoContext/useTodoContext'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoItem</span> = (<span class="hljs-params">{ todo }</span>) =&gt; {
  <span class="hljs-keyword">const</span> { addSelectTodos, removeSelectTodos } = <span class="hljs-title function_">useTodoContext</span>();
  <span class="hljs-comment">// 用Ref绑定单选框元素，便于后续操作（如主动获取状态）</span>
  <span class="hljs-keyword">const</span> checkboxRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 单选框状态变化处理函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCheckboxChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-title function_">toggleSelected</span>(todo.<span class="hljs-property">id</span>);
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-property">checked</span>) {
      <span class="hljs-comment">// 选中：调用添加选中任务的action</span>
      <span class="hljs-title function_">addSelectTodos</span>(todo.<span class="hljs-property">id</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 取消选中：调用移除选中任务的action</span>
      <span class="hljs-title function_">removeSelectTodos</span>(todo.<span class="hljs-property">id</span>);
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">todo-item</span>${<span class="hljs-attr">isDragging</span> ? ' <span class="hljs-attr">isDragging</span>' <span class="hljs-attr">:</span> ''}`} <span class="hljs-attr">ref</span>=<span class="hljs-string">{divRef}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-item-content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
          <span class="hljs-attr">id</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">todo-</span>${<span class="hljs-attr">todo.id</span>}`}
          <span class="hljs-attr">checked</span>=<span class="hljs-string">{todo.selected}</span>
          <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleCheckboxChange}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-checkbox"</span>
          <span class="hljs-attr">ref</span>=<span class="hljs-string">{checkboxRef}</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      {/* 原有单个任务拖拽相关逻辑 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoItem</span>;
</code></pre>
<p>注意：仅保留必需内容，不包含TodoItem组件的所有内容。</p>
<h3 data-id="heading-10">4.2 关键交互说明</h3>
<ul>
<li><strong>Ref绑定</strong>：通过<code>checkboxRef</code>可在需要时主动控制单选框（如全选/取消全选功能），提升组件灵活性。</li>
<li><strong>状态双向绑定</strong>：单选框的<code>checked</code>属性直接绑定任务项的<code>selected</code>状态，确保视图与全局状态一致。</li>
<li><strong>操作触发</strong>：状态变化时通过上下文获取的<code>addSelectTodos</code>和<code>removeSelectTodos</code>方法更新全局状态，实现跨组件状态同步。</li>
</ul>
<h2 data-id="heading-11">五、配套Action函数实现</h2>
<p>为了让组件更便捷地调用上述操作，需在TodoProvider中定义对应的action函数，并注入上下文：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> actions = {
  <span class="hljs-comment">// 原有action...</span>
  
    <span class="hljs-comment">// 添加选中任务</span>
    <span class="hljs-attr">addSelectTodos</span>: <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
      <span class="hljs-title function_">dispatch</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">ActionTypes</span>.<span class="hljs-property">ADD_SELECT_TODOS</span>,
        <span class="hljs-attr">payload</span>: { id },
      });
    },

    <span class="hljs-comment">// 移除选中任务</span>
    <span class="hljs-attr">removeSelectTodos</span>: <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
      <span class="hljs-title function_">dispatch</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">ActionTypes</span>.<span class="hljs-property">REMOVE_SELECT_TODOS</span>,
        <span class="hljs-attr">payload</span>: { id },
      });
    },
    
};
</code></pre>
<h2 data-id="heading-12">六、测试要点</h2>
<ol>
<li>单个任务选中/取消：勾选单选框后，<code>selectedTodos</code>应同步增减，任务项<code>selected</code>状态正确。</li>
<li>多个任务选中：选中多个任务后，<code>selectedTodos</code>应包含所有选中项，无重复数据。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CentOS 7/8/9 上安装 MySQL 8.0+ 完整指南]]></title>    <link>https://juejin.cn/post/7573670400153813044</link>    <guid>https://juejin.cn/post/7573670400153813044</guid>    <pubDate>2025-11-18T09:29:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573670400153813044" data-draft-id="7573670400153763892" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CentOS 7/8/9 上安装 MySQL 8.0+ 完整指南"/> <meta itemprop="keywords" content="Linux,MySQL"/> <meta itemprop="datePublished" content="2025-11-18T09:29:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LumenL1u"/> <meta itemprop="url" content="https://juejin.cn/user/3406736546858211"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CentOS 7/8/9 上安装 MySQL 8.0+ 完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3406736546858211/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LumenL1u
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:29:06.000Z" title="Tue Nov 18 2025 09:29:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、流程图</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[安装前准备] --&gt; B{选择安装方式}
    B --&gt;|推荐新手| C[1.使用包管理器安装]
    B --&gt;|需要更多控制| D[2.手动安装二进制包]

    C --&gt; C1[添加Yum存储库]
    C1 --&gt; C2[安装mysql-server]
    C2 --&gt; C3[启动服务]
    C3 --&gt; F[重置账户密码]

    D --&gt; D1[下载并解压二进制包]
    D1 --&gt; D2[创建专用用户和组]
    D2 --&gt; D3[创建配置文件和初始化数据目录]
    D3 --&gt; D4[创建systemd 单元文件]
    D4 --&gt; D5[启动服务]
    D5 --&gt; F

    F --&gt; G[测试MySQL服务]
    G --&gt; H[开启远程访问权限]

</code></pre>
<h2 data-id="heading-1">二、安装前的准备工作</h2>
<p>在开始安装之前，建议你先完成以下步骤：</p>
<p>更新系统软件包： 更新系统，确保所有软件包都是最新状态。（对于启用 dnf 的系统，请在命令中将  <strong>yum</strong>  替换为  <strong>dnf</strong>）</p>
<pre><code class="hljs language-bash" lang="bash">yum update
</code></pre>
<p>检查是否已安装 MySQL：执行以下命令检查</p>
<pre><code class="hljs language-bash" lang="bash">yum list installed | grep mysql
yum list installed | grep mariadb
</code></pre>
<p>卸载：如果存在旧版本，建议卸载以避免冲突。</p>
<pre><code class="hljs language-bash" lang="bash">yum remove 包名
</code></pre>
<p>清理残留文件：卸载后建议删除相关配置文件和数据目录。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除配置文件</span>
<span class="hljs-built_in">rm</span> -rf /etc/my.cnf

<span class="hljs-comment"># 删除数据目录（注意：会删除所有数据）</span>
<span class="hljs-built_in">rm</span> -rf /var/lib/mysql

<span class="hljs-comment"># 删除日志文件</span>
<span class="hljs-built_in">rm</span> -rf /var/log/localhost.log
</code></pre>
<h2 data-id="heading-2">三、使用包管理器安装（简单，易管理）</h2>
<h3 data-id="heading-3">1. <strong>添加 MySQL Yum 存储库</strong></h3>
<p>从 MySQL Yum 存储库页面 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysqlserver.cn%2Fdownloads%2Frepo%2Fyum%2F)%25EF%25BC%2588%25E5%259C%25A8" target="_blank" title="https://dev.mysqlserver.cn/downloads/repo/yum/)%EF%BC%88%E5%9C%A8" ref="nofollow noopener noreferrer">dev.mysqlserver.cn/downloads/r…</a> MySQL 开发者专区）下载它。上传到服务器后执行（对于启用 dnf 的系统，请在命令中将  <strong>yum</strong>  替换为  <strong>dnf</strong>）</p>
<pre><code class="hljs language-bash" lang="bash">yum localinstall mysql84-community-release-el9-1.noarch.rpm
</code></pre>
<p>您可以通过以下命令检查 MySQL Yum 存储库是否已成功添加并启用</p>
<pre><code class="hljs language-bash" lang="bash">yum repolist enabled | grep mysql.*-community
</code></pre>
<h3 data-id="heading-4"><strong>2. 禁用默认的 MySQL 模块</strong></h3>
<p>(仅限 EL8 系统) 基于 EL8 的系统（例如 RHEL8 和 Oracle Linux 8）包含一个默认情况下启用的 MySQL 模块。</p>
<pre><code class="hljs language-bash" lang="bash">yum module <span class="hljs-built_in">disable</span> mysql
</code></pre>
<h3 data-id="heading-5"><strong>3. 安装 MySQL</strong></h3>
<p>通过以下命令安装 MySQL</p>
<pre><code class="hljs language-bash" lang="bash">yum install mysql-community-server
</code></pre>
<p>这将安装 MySQL 服务器软件包 (<code>mysql-community-server</code>)，以及运行服务器所需组件的软件包，包括客户端软件包 (<code>mysql-community-client</code>)、客户端和服务器的通用错误消息和字符集 (<code>mysql-community-common</code>) 以及共享客户端库 (<code>mysql-community-libs</code>)。</p>
<h3 data-id="heading-6">4. 启动 MySQL 服务器</h3>
<p>使用以下命令启动 MySQL 服务器。</p>
<pre><code class="hljs language-bash" lang="bash">systemctl start mysqld
</code></pre>
<p>您可以使用以下命令检查 MySQL 服务器的状态。</p>
<pre><code class="hljs language-bash" lang="bash">systemctl status mysqld
</code></pre>
<p>如果操作系统启用了 systemd，则应使用标准的  <strong>systemctl</strong>（或者，使用参数反转的  <strong>service</strong>）命令，例如  <strong>stop</strong>、<strong>start</strong>、<strong>status</strong>  和  <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysqlserver.cn%2Fdoc%2Frefman%2F9.0%2Fen%2Frestart.html" target="_blank" title="https://dev.mysqlserver.cn/doc/refman/9.0/en/restart.html" ref="nofollow noopener noreferrer"><strong>restart</strong></a>  来管理 MySQL 服务器服务。 <code>mysqld</code>  服务默认情况下处于启用状态，并且在系统重启时启动。</p>
<h2 data-id="heading-7">四、手动安装二进制包（难，但更灵活）</h2>
<h3 data-id="heading-8"><strong>1. MySQL Linux 通用二进制分发目录</strong></h3>





































<table><thead><tr><th><strong>目录</strong></th><th><strong>目录内容</strong></th></tr></thead><tbody><tr><td><code>bin</code></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysqlserver.cn%2Fdoc%2Frefman%2F9.0%2Fen%2Fmysqld.html" target="_blank" title="https://dev.mysqlserver.cn/doc/refman/9.0/en/mysqld.html" ref="nofollow noopener noreferrer"><strong>mysqld</strong></a>  服务器、客户端和实用程序</td></tr><tr><td><code>docs</code></td><td>Info 格式的 MySQL 手册</td></tr><tr><td><code>man</code></td><td>Unix 手册页</td></tr><tr><td><code>include</code></td><td>包含（头）文件</td></tr><tr><td><code>lib</code></td><td>库</td></tr><tr><td><code>share</code></td><td>错误消息、字典和用于数据库安装的 SQL</td></tr><tr><td><code>support-files</code></td><td>各种支持文件</td></tr></tbody></table>
<h3 data-id="heading-9"><strong>2. 命令序列如下所示</strong></h3>
<pre><code class="hljs language-bash" lang="bash">yum install libaio
tar -xvf /path/to/mysql-VERSION-OS.tar.xz
<span class="hljs-built_in">ln</span> -s full-path-to-mysql-VERSION-OS mysql
groupadd mysql
useradd -r -g mysql -s /bin/false mysql
<span class="hljs-built_in">cd</span> /etc
<span class="hljs-built_in">touch</span> my.cnf
<span class="hljs-built_in">chown</span> root:root my.cnf
<span class="hljs-built_in">cd</span> /usr/local/mysql
<span class="hljs-built_in">mkdir</span> data
<span class="hljs-built_in">chmod</span> 750 data
<span class="hljs-built_in">chown</span> mysql:mysql data
bin/mysqld --defaults-file=/etc/my.cnf --initialize
<span class="hljs-built_in">cat</span> data/localhost.localdomain.err
<span class="hljs-built_in">cd</span> /usr/lib/systemd/system
<span class="hljs-built_in">touch</span> mysqld.service
systemctl <span class="hljs-built_in">enable</span> mysqld.service
systemctl start mysqld
</code></pre>
<h3 data-id="heading-10">3. 安装二进制包</h3>
<p><strong>安装 libaio 库</strong>：MySQL 依赖于该<code>libaio</code>  库。如果未在本地安装此库，则数据目录初始化和后续服务器启动步骤将失败。如有必要，请使用适当的包管理器安装它。例如，在基于 Yum 的系统上：</p>
<pre><code class="hljs language-bash" lang="bash">yum search libaio  <span class="hljs-comment"># search for info</span>
yum install libaio <span class="hljs-comment"># install library</span>
</code></pre>
<p><strong>下载和解压</strong>：从 MySQL 官网<a href="https://link.juejin.cn?target=https%3A%2F%2Fdownloads.mysql.com%2Farchives%2Fcommunity%2F" target="_blank" title="https://downloads.mysql.com/archives/community/" ref="nofollow noopener noreferrer">下载</a>对应版本的二进制压缩包（如 mysql-9.4.0-linux-glibc2.28-x86_64.tar.xz），使用 <code>tar -xzf</code> 命令解压。</p>
<pre><code class="hljs language-bash" lang="bash">tar xvf mysql-9.4.0-linux-glibc2.28-x86_64.tar.xz -C /usr/local/
<span class="hljs-built_in">cd</span> /usr/local/

<span class="hljs-built_in">mv</span> mysql-9.4.0-linux-glibc2.28-x86_64 mysql
<span class="hljs-comment">#或</span>
<span class="hljs-built_in">ln</span> -s mysql-9.4.0-linux-glibc2.28-x86_64 mysql
</code></pre>
<p><strong>创建专用用户和组</strong>：创建一个不允许登录系统的 MySQL 专用用户，提升安全性。</p>
<pre><code class="hljs language-bash" lang="bash">groupadd mysql
useradd -r -g mysql -s /bin/false mysql
<span class="hljs-comment">#或</span>
useradd -r -g mysql -s /usr/sbin/nologin mysql
</code></pre>
<p><code>-s</code> 设置用户的登录 shell</p>
<p><code>/bin/false</code> 一个总是返回失败的程序，这样设置后，该用户<strong>无法通过 shell 登录系统</strong></p>
<p><code>/usr/sbin/nologin</code> 达到类似效果，并给出友好提示</p>
<h3 data-id="heading-11">4. 安装后配置</h3>
<p><strong>配置环境变量</strong>：将 mysql 加入环境变量中。</p>
<pre><code class="hljs language-bash" lang="bash">vim /etc/profile.d/mysql.sh
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#编辑mysql.sh内容</span>
<span class="hljs-built_in">export</span> MYSQL_HOME=/usr/local/mysql
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$MYSQL_HOME</span>/bin:<span class="hljs-variable">$PATH</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span> /etc/profile.d/mysql.sh
</code></pre>
<p><strong>创建配置文件</strong>：通过将它们放在 MySQL 配置文件中来指定 MySQL 服务器在启动时应使用的选项。如果不这样做，服务器将以其默认设置启动，要创建 MySQL 配置文件，请以 root 身份发出以下命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /etc
vim my.cnf
</code></pre>
<p>添加以下设置到配置文件中</p>
<pre><code class="hljs language-bash" lang="bash">[client]
socket=/usr/local/mysql/data/mysql.sock

[mysqld]
datadir=/usr/local/mysql/data
socket=/usr/local/mysql/data/mysql.sock
port=3306
log-error=/usr/local/mysql/data/localhost.log
user=mysql
secure_file_priv=NULL
local_infile=OFF
</code></pre>
<p><strong>初始化数据目录</strong>：进入 MySQL 目录并初始化数据目录</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /usr/local/mysql
<span class="hljs-built_in">mkdir</span> data
<span class="hljs-built_in">chmod</span> 750 data
<span class="hljs-built_in">chown</span> mysql:mysql data
bin/mysqld --defaults-file=/etc/my.cnf --initialize
</code></pre>
<p>初始化输出被打印到日志 ( <code>/usr/local/mysql/data/localhost.log</code>) 中。</p>
<h3 data-id="heading-12"><strong>5. 使用 systemd 启动服务器</strong></h3>
<p>添加一个 systemd 服务单元配置文件</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /usr/lib/systemd/system
vim mysqld.service
</code></pre>
<p>将此配置信息添加到 mysqld.service 文件中：</p>
<pre><code class="hljs language-bash" lang="bash">[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target

[Install]
WantedBy=multi-user.target

[Service]
User=mysql
Group=mysql

<span class="hljs-comment"># Have mysqld write its state to the systemd notify socket</span>
Type=notify

<span class="hljs-comment"># Disable service start and stop timeout logic of systemd for mysqld service.</span>
TimeoutSec=0

<span class="hljs-comment"># Start main service</span>
ExecStart=/usr/local/mysql/bin/mysqld --defaults-file=/etc/my.cnf <span class="hljs-variable">$MYSQLD_OPTS</span>

<span class="hljs-comment"># Use this to switch malloc implementation</span>
EnvironmentFile=-/etc/sysconfig/mysql

<span class="hljs-comment"># Sets open_files_limit</span>
LimitNOFILE = 10000

<span class="hljs-comment">#Restart=on-failure</span>

<span class="hljs-comment">#RestartPreventExitStatus=1</span>

<span class="hljs-comment"># Set environment variable MYSQLD_PARENT_PID. This is required for restart.</span>
<span class="hljs-comment">#Environment=MYSQLD_PARENT_PID=1</span>

<span class="hljs-comment">#PrivateTmp=false</span>
</code></pre>
<p>使用以下命令来管理 MySQL 服务。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#使mysqld服务在重新启动时自动启动。</span>
systemctl <span class="hljs-built_in">enable</span> mysqld.service

<span class="hljs-comment">#手动启动mysqld服务</span>
systemctl start mysqld

<span class="hljs-comment">#检查mysqld服务的状态</span>
systemctl status mysqld
</code></pre>
<h2 data-id="heading-13">五、重置 MySQL root 账户密码</h2>
<p>使用客户端，使用服务器在初始化序列期间生成的随机密码  <code>mysql</code>连接到服务器：<code>root@localhost</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Yum 安装</span>
grep <span class="hljs-string">'temporary password'</span> /var/log/mysqld.log
<span class="hljs-comment"># 二进制安装</span>
grep <span class="hljs-string">'temporary password'</span> /usr/local/mysql/data/*.err

mysql -u root -p
</code></pre>
<pre><code class="hljs language-sql" lang="sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'root'</span>@<span class="hljs-string">'localhost'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'password'</span>;
mysql<span class="hljs-operator">&gt;</span> exit
</code></pre>
<blockquote>
<p>💡 提示：如果启用了 validate_password 插件（默认开启），密码必须满足强度策略（大写、小写、数字、特殊字符、长度 ≥ 8）。</p>
</blockquote>
<h2 data-id="heading-14">六、测试 MySQL 服务器</h2>
<p>使用<strong>mysqlshow</strong>验证您是否可以从服务器检索信息。</p>
<pre><code class="hljs language-bash" lang="bash">mysqlshow -u root -p
</code></pre>
<p>使用<strong>mysqladmin</strong>查看 MySQL 服务器版本信息。</p>
<pre><code class="hljs language-bash" lang="bash">mysqladmin -u root -p version
</code></pre>
<h2 data-id="heading-15">七、开启远程访问权限</h2>
<p>需要登录到 MySQL 服务器，执行下面的命令：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 创建用户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'username'</span>@<span class="hljs-string">'%'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'password'</span>;

<span class="hljs-comment">-- 2. 授权</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> PRIVILEGES <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'username'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-comment">-- 3.刷新权限</span>
FLUSH PRIVILEGES;
</code></pre>
<p>这里的 <code>username</code> 和 <code>password</code> 分别是远程用户的用户名和密码，<code>%</code> 表示允许任何 IP 地址的用户连接。如果需要限制特定 IP 地址，可以将 <code>%</code> 替换为具体的 IP 地址。</p>
<p>编辑 MySQL 的配置文件 <code>my.cnf</code> ， 允许任意 IP 地址访问：</p>
<pre><code class="hljs language-bash" lang="bash">[mysqld]
<span class="hljs-comment"># 注释掉或删除这一行（如果存在）：</span>
<span class="hljs-comment"># 如果不想暴露MySQL，可以保留，通过SSH 隧道（端口转发）安全地连接，具体见常见问题</span>
<span class="hljs-comment"># bind-address = 127.0.0.1</span>

<span class="hljs-comment"># 或显式绑定到所有地址：</span>
bind-address = 0.0.0.0
</code></pre>
<p>修改后，保存文件并重启 MySQL 服务以使更改生效：</p>
<pre><code class="hljs language-bash" lang="bash">systemctl restart mysqld
</code></pre>
<p>在客户端计算机上，使用以下命令尝试连接到远程 MySQL 服务器：</p>
<pre><code class="hljs language-bash" lang="bash">mysql -h server_ip -P 3306 -u username -p

<span class="hljs-comment">#例如</span>
mysql -h192.168.100.128 -P3306 -uroot -p123456
</code></pre>
<h2 data-id="heading-16">八、常见问题</h2>
<h3 data-id="heading-17"><strong>1. MySQL 服务无法启动</strong></h3>
<p>可以运行 <code>systemctl status mysql</code> 查看服务状态，或者通过 <code>journalctl -xe</code> 查看系统日志来排查问题。</p>
<h3 data-id="heading-18"><strong>2. SELinux 或 AppArmor 阻止执行</strong></h3>
<p>临时禁用 SELinux 测试：</p>
<pre><code class="hljs language-bash" lang="bash">setenforce 0
systemctl start mysqld
</code></pre>
<p>如果成功，说明是 SELinux 策略问题。可恢复后添加策略：</p>
<pre><code class="hljs language-bash" lang="bash">setenforce 1
restorecon -R /usr/local/mysql
<span class="hljs-comment"># 或使用 audit2allow 生成自定义策略</span>
</code></pre>
<h3 data-id="heading-19"><strong>3. 客户端连接失败</strong>：</h3>
<p><strong>检查防火墙设置</strong>：确保服务器的防火墙开放了 MySQL 的默认 3306 端口。可以使用以下命令。</p>
<pre><code class="hljs language-bash" lang="bash">firewall-cmd --list-ports | grep 3306
</code></pre>
<p>如果没有放行（输出是空的），执行以下命令，重新检查</p>
<pre><code class="hljs language-bash" lang="bash">firewall-cmd --permanent --add-port=3306/tcp
firewall-cmd --reload
</code></pre>
<p><strong>检查 MySQL 绑定地址</strong>：查看 MySQL 配置文件（如 <code>/etc/mysql/my.cnf</code>）中的 <code>bind-address</code> 选项。如果希望从其他机器连接，需将其设置为服务器的 IP 地址或 <code>0.0.0.0</code>（注意安全风险），或者直接注释掉该行。</p>
<p>如果服务端只允许本机访问（127.0.0.1），则在客户端执行下面的命令：</p>
<pre><code class="hljs language-bash" lang="bash">ssh -L 3307:127.0.0.1:3306 user@your-server.com
<span class="hljs-comment">#或</span>
ssh -fNL 3307:127.0.0.1:3306 user@your-server.com

mysql -h 127.0.0.1 -P 3307 -u myuser -p
</code></pre>
<p><code>-L 3307:127.0.0.1:3306</code>：表示将本地机器的  <strong>3307 端口</strong>  转发到远程服务器上的  <code>127.0.0.1:3306</code> 。</p>
<p><code>user@your-server.com</code>：是你在远程服务器上的登录账户和主机地址。</p>
<p><code>-fNL</code> ：在后台运行，不执行远程命令，同时设置本地端口转发。</p>
<p>如果是后台运行，Linux/MacOS 用 <code>ps aux | grep ssh</code> ，Windows 用 <code>get-process ssh*</code> ，找到进程并 <code>kill &lt;PID&gt;</code> 。</p>
<h3 data-id="heading-20"><strong>4. 忘记 root 密码</strong>：</h3>
<ol>
<li>停止 MySQL 服务。</li>
<li>在配置文件中（如 <code>[mysqld]</code> 段下）添加 <code>skip-grant-tables</code>。</li>
<li>重启 MySQL 服务，此时可以不需密码登录。</li>
<li>执行 <code>FLUSH PRIVILEGES;</code> 后重设 root 密码。</li>
<li>移除 <code>skip-grant-tables</code> 配置，重启 MySQL 服务。</li>
</ol>
<p>参考：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysqlserver.cn%2Fdoc%2Frefman%2F9.0%2Fen%2Flinux-installation-yum-repo.html" target="_blank" title="https://dev.mysqlserver.cn/doc/refman/9.0/en/linux-installation-yum-repo.html" ref="nofollow noopener noreferrer">MySQL :: MySQL 9.0 参考手册 :: 2.5.1 使用 MySQL Yum 存储库在 Linux 上安装 MySQL - MySQL 数据库</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysqlserver.cn%2Fdoc%2Frefman%2F9.0%2Fen%2Fbinary-installation.html" target="_blank" title="https://dev.mysqlserver.cn/doc/refman/9.0/en/binary-installation.html" ref="nofollow noopener noreferrer">MySQL :: MySQL 9.0 参考手册 :: 2.2 在 Unix/Linux 上使用通用二进制文件安装 MySQL - MySQL 数据库</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmysql.net.cn%2Fdoc%2Fmysql-secure-deployment-guide%2F8.0%2Fen%2Fsecure-deployment-post-install.html" target="_blank" title="https://mysql.net.cn/doc/mysql-secure-deployment-guide/8.0/en/secure-deployment-post-install.html" ref="nofollow noopener noreferrer">第 5 章安装后设置_MySQL 8.0 安全部署指南</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Uniapp如何下载图片到本地相册]]></title>    <link>https://juejin.cn/post/7573710392213602331</link>    <guid>https://juejin.cn/post/7573710392213602331</guid>    <pubDate>2025-11-18T09:29:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573710392213602331" data-draft-id="7573669819029340170" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Uniapp如何下载图片到本地相册"/> <meta itemprop="keywords" content="前端,Vue.js,微信小程序"/> <meta itemprop="datePublished" content="2025-11-18T09:29:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="努力呆呆鸟"/> <meta itemprop="url" content="https://juejin.cn/user/1313268769494019"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Uniapp如何下载图片到本地相册
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1313268769494019/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    努力呆呆鸟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:29:48.000Z" title="Tue Nov 18 2025 09:29:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">uniapp如何下载图片到本地相册？</h2>
<blockquote>
<p>在一些特定的情况下面，我们需要在uniapp开发的小程序中将图片保存到本地相册，比如壁纸小程序其他小程序，这个使用情况还是十分普遍的，现在我来分享一下我的实现方法和思路</p>
</blockquote>
<h3 data-id="heading-1">实现方案</h3>
<p>文档地址：
saveImageToPhotosAlbum:<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fapi%2Fmedia%2Fimage.html%23saveimagetophotosalbum" target="_blank" title="https://uniapp.dcloud.net.cn/api/media/image.html#saveimagetophotosalbum" ref="nofollow noopener noreferrer">uniapp.dcloud.net.cn/api/media/i…</a>
getImageInfo: <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fapi%2Fmedia%2Fimage.html%23getimageinfo" target="_blank" title="https://uniapp.dcloud.net.cn/api/media/image.html#getimageinfo" ref="nofollow noopener noreferrer">uniapp.dcloud.net.cn/api/media/i…</a></p>
<p>我们通过查找uniapp官方文档可以发现里面有一个<code>uni.saveImageToPhotosAlbum({})</code>保存图片到系统相册的API接口可以让我们使用，其中最关键的就是<code>filePath</code>参数，这个参数不支持网络地址就是我们服务器返回的图片地址不可以使用</p>
<p>所以我们需要使用另外一个API接口来帮助我们生成一个临时的<code>filePath</code>路径这个api就是<code>uni.getImageInfo</code>
使用这个api就可以将我们接口返回的网络地址生成一个临时的file地址，这样我就可以配合<code>uni.saveImageToPhotosAlbum({})</code>来实现图片保存到本地相册的功能了</p>
<p><em><strong>实例代码：</strong></em></p>
<pre><code class="hljs language-js" lang="js">		uni.<span class="hljs-title function_">getImageInfo</span>({
			<span class="hljs-attr">src</span>: currentInfo.<span class="hljs-property">value</span>.<span class="hljs-property">picurl</span>,
			<span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
				uni.<span class="hljs-title function_">saveImageToPhotosAlbum</span>({
					<span class="hljs-attr">filePath</span>: res.<span class="hljs-property">path</span>,
					<span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">fileRes</span>) =&gt;</span> {
						<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fileRes, <span class="hljs-string">"图片"</span>);
					}
				})
			}
		})
</code></pre>
<h3 data-id="heading-2">需要注意的问题</h3>
<p>我们在小程序实现下载功能的时候我们还需要到小程序的配置当中将<code>downloadFile合法域名</code>行一个配置不然是无法完成下载的，同时还需要在小程序后台配置中进行一个授权不然也是无法实现保存到微信相册的。</p>
<h4 data-id="heading-3">1.downloadFile合法域名配置步骤</h4>
<p>进入到小程序配置信息页面 <strong>点击开发管理</strong> 同时在显示中的页面里面<strong>下滑到服务器域名位置</strong> 可以看见<strong>downloadFile合法域名</strong>的位置信息 点击<strong>右上角</strong>的 <strong>修改</strong> 然后将我们的downloadFile域名添加就可以了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d1dd17d8bb141a2860094d956724287~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yqq5Yqb5ZGG5ZGG6bif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764062988&amp;x-signature=dstWCt9FtIE5EqsCjPWYszO%2Fpp8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f08cdcbbf644b42b201b7e5071603b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yqq5Yqb5ZGG5ZGG6bif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764062988&amp;x-signature=B4HVSCECFWcyXc%2B54VQ9r4aA3hA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">2. 进行授权配置</h4>
<p>进入小程序后台设置 鼠标移入到头像上 根据你的小程序信息进行一个填写和备案 后面找到<code>服务内容声明</code>用户隐私保护指引 进入到里面根据信息提示就可以完成下载图片并且保存到手机本地相册的功能了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[item_get接口详解：高效获取某鱼商品详情数据]]></title>    <link>https://juejin.cn/post/7573708620870680628</link>    <guid>https://juejin.cn/post/7573708620870680628</guid>    <pubDate>2025-11-18T09:32:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573708620870680628" data-draft-id="7573864324713152564" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="item_get接口详解：高效获取某鱼商品详情数据"/> <meta itemprop="keywords" content="爬虫"/> <meta itemprop="datePublished" content="2025-11-18T09:32:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="电商api跨境独立站程序猿"/> <meta itemprop="url" content="https://juejin.cn/user/2900974868106540"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            item_get接口详解：高效获取某鱼商品详情数据
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2900974868106540/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    电商api跨境独立站程序猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:32:01.000Z" title="Tue Nov 18 2025 09:32:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在二手电商生态中，商品详情数据是数据分析、价格监控、智能推荐等业务场景的核心基础。某鱼平台的<code>item_get</code>接口为开发者提供了标准化的商品信息获取能力。本文将深度解析该接口的设计原理、调用方法及实战技巧。</p>
<hr/>
<h2 data-id="heading-0">一、接口定位与能力边界</h2>
<p><code>item_get</code>是某鱼开放平台的基础数据接口，用于<strong>实时获取单个商品的完整详情信息</strong>。其核心能力包括：</p>
<ul>
<li><strong>毫秒级响应</strong>：平均响应时长&lt;200ms，支持高并发调用</li>
<li><strong>全字段覆盖</strong>：包含商品标题、价格、描述、图片、卖家信息等30+维度</li>
<li><strong>数据新鲜度</strong>：实时读取源站数据，确保价格、库存等动态信息准确</li>
<li><strong>合规访问</strong>：通过OAuth 2.0授权，符合平台数据安全规范</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、接口技术规范</h2>
<h3 data-id="heading-2">2.1 基础信息</h3>
<pre><code class="hljs language-http" lang="http">请求地址：[https://api.xianyu.com/router/rest](https://o0b.cn/jelena    )
接口名称：xianyu.item.get
请求方式：GET/POST（推荐POST）
数据格式：JSON
字符编码：UTF-8
</code></pre>
<h3 data-id="heading-3">2.2 请求参数结构</h3>





























































<table><thead><tr><th align="left">参数名称</th><th align="left">类型</th><th align="left">必填</th><th align="left">说明</th><th align="left">示例值</th></tr></thead><tbody><tr><td align="left"><code>method</code></td><td align="left">string</td><td align="left">是</td><td align="left">固定值：xianyu.item.get</td><td align="left"><code>xianyu.item.get</code></td></tr><tr><td align="left"><code>app_key</code></td><td align="left">string</td><td align="left">是</td><td align="left">应用唯一标识</td><td align="left"><code>12345678</code></td></tr><tr><td align="left"><code>access_token</code></td><td align="left">string</td><td align="left">是</td><td align="left">OAuth授权令牌</td><td align="left"><code>6100a52b7c8d8a9d9e8f7g6h5</code></td></tr><tr><td align="left"><code>item_id</code></td><td align="left">string</td><td align="left">是</td><td align="left">商品数字ID</td><td align="left"><code>658767890123</code></td></tr><tr><td align="left"><code>fields</code></td><td align="left">string</td><td align="left">否</td><td align="left">指定返回字段（逗号分隔）</td><td align="left"><code>title,price,desc,images</code></td></tr><tr><td align="left"><code>timestamp</code></td><td align="left">string</td><td align="left">是</td><td align="left">请求时间戳（秒）</td><td align="left"><code>1731923400</code></td></tr><tr><td align="left"><code>sign</code></td><td align="left">string</td><td align="left">是</td><td align="left">签名串（MD5加密）</td><td align="left"><code>a1b2c3d4e5f6g7h8i9j0</code></td></tr></tbody></table>
<p><strong>签名生成规则</strong>：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 伪代码示例</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_sign</span>(<span class="hljs-params">params, secret</span>):
    <span class="hljs-comment"># 1. 过滤空值参数</span>
    <span class="hljs-comment"># 2. 按key升序排序</span>
    <span class="hljs-comment"># 3. 拼接key+value+secret</span>
    <span class="hljs-comment"># 4. MD5加密生成32位小写签名</span>
    sorted_params = <span class="hljs-built_in">sorted</span>(params.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>])
    sign_str = <span class="hljs-string">''</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{k}</span><span class="hljs-subst">{v}</span>"</span> <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> sorted_params]) + secret
    <span class="hljs-keyword">return</span> md5(sign_str.encode(<span class="hljs-string">'utf-8'</span>)).hexdigest()
</code></pre>
<hr/>
<h2 data-id="heading-4">三、返回数据模型详解</h2>
<p>成功调用后返回的JSON数据结构如下：</p>
<pre><code class="hljs language-JSON" lang="JSON"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"success"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"item"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"item_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"658767890123"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"iPhone 15 Pro 256G 原色"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"desc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"自用半年，成色99新，配件齐全..."</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"current"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"7200.00"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"original"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8999.00"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"currency"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CNY"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"images"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"https://img.xianyu.com/1.jpg"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"https://img.xianyu.com/2.jpg"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"50025526"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"手机"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"location"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"city"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"杭州市"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"district"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"西湖区"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"onsale"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// onsale/reserved/sold</span>
      <span class="hljs-attr">"publish_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-15 14:32:18"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"seller"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user_abc123"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"nick"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"数码达人小王"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"level"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"L3"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"credit_score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">95</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"verify_status"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stats"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"view_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1280</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"want_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">45</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"comment_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"sku"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"brand"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Apple"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"iPhone 15 Pro"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"原色钛金属"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"shipping"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"express"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"cost"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.00"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"free_shipping"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"tags"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"包邮"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"急售"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"可小刀"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"request_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"20251118143000_12345"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>核心字段速查表</strong>：</p>









































<table><thead><tr><th align="left">字段路径</th><th align="left">数据类型</th><th align="left">业务价值</th><th align="left">注意事项</th></tr></thead><tbody><tr><td align="left"><code>item.price.current</code></td><td align="left">decimal</td><td align="left">实时售价</td><td align="left">字符串格式，需转换计算</td></tr><tr><td align="left"><code>item.status</code></td><td align="left">enum</td><td align="left">销售状态</td><td align="left">sold商品不可再购买</td></tr><tr><td align="left"><code>item.seller.credit_score</code></td><td align="left">int</td><td align="left">信誉评估</td><td align="left">80分以上为优质卖家</td></tr><tr><td align="left"><code>item.stats.view_count</code></td><td align="left">int</td><td align="left">热度指标</td><td align="left">单位时间内增长趋势有价值</td></tr><tr><td align="left"><code>item.publish_time</code></td><td align="left">datetime</td><td align="left">上架时间</td><td align="left">UTC+8时区</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">四、多语言调用示例</h2>
<h3 data-id="heading-6">Python 实现</h3>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">class</span> <span class="hljs-title class_">XianyuClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, app_key, app_secret, access_token</span>):
        self.base_url = <span class="hljs-string">"https://api.xianyu.com/router/rest"</span>
        self.app_key = app_key
        self.app_secret = app_secret
        self.access_token = access_token
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_item_detail</span>(<span class="hljs-params">self, item_id, fields=<span class="hljs-literal">None</span></span>):
        params = {
            <span class="hljs-string">"method"</span>: <span class="hljs-string">"xianyu.item.get"</span>,
            <span class="hljs-string">"app_key"</span>: self.app_key,
            <span class="hljs-string">"access_token"</span>: self.access_token,
            <span class="hljs-string">"item_id"</span>: item_id,
            <span class="hljs-string">"timestamp"</span>: <span class="hljs-built_in">str</span>(<span class="hljs-built_in">int</span>(time.time())),
            <span class="hljs-string">"v"</span>: <span class="hljs-string">"2.0"</span>,
            <span class="hljs-string">"format"</span>: <span class="hljs-string">"json"</span>
        }
        <span class="hljs-keyword">if</span> fields:
            params[<span class="hljs-string">"fields"</span>] = fields
        
        <span class="hljs-comment"># 生成签名</span>
        params[<span class="hljs-string">"sign"</span>] = self._generate_sign(params)
        
        response = requests.post(self.base_url, data=params, timeout=<span class="hljs-number">10</span>)
        <span class="hljs-keyword">return</span> response.json()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_sign</span>(<span class="hljs-params">self, params</span>):
        sorted_params = <span class="hljs-built_in">sorted</span>(params.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>])
        sign_str = <span class="hljs-string">''</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{k}</span><span class="hljs-subst">{v}</span>"</span> <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> sorted_params]) + self.app_secret
        <span class="hljs-keyword">return</span> hashlib.md5(sign_str.encode(<span class="hljs-string">'utf-8'</span>)).hexdigest()

<span class="hljs-comment"># 调用示例</span>
client = XianyuClient(<span class="hljs-string">"your_app_key"</span>, <span class="hljs-string">"your_secret"</span>, <span class="hljs-string">"your_token"</span>)
result = client.get_item_detail(<span class="hljs-string">"658767890123"</span>, <span class="hljs-string">"title,price,desc"</span>)
<span class="hljs-built_in">print</span>(result[<span class="hljs-string">'data'</span>][<span class="hljs-string">'item'</span>][<span class="hljs-string">'title'</span>])
</code></pre>
<h3 data-id="heading-7">Node.js 实现</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">XianyuClient</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">appKey, appSecret, accessToken</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">baseURL</span> = <span class="hljs-string">'https://api.xianyu.com/router/rest'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">appKey</span> = appKey;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">appSecret</span> = appSecret;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">accessToken</span> = accessToken;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getItemDetail</span>(<span class="hljs-params">itemId, fields = <span class="hljs-literal">null</span></span>) {
    <span class="hljs-keyword">const</span> params = {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'xianyu.item.get'</span>,
      <span class="hljs-attr">app_key</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">appKey</span>,
      <span class="hljs-attr">access_token</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">accessToken</span>,
      <span class="hljs-attr">item_id</span>: itemId,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() / <span class="hljs-number">1000</span>).<span class="hljs-title function_">toString</span>(),
      <span class="hljs-attr">v</span>: <span class="hljs-string">'2.0'</span>,
      <span class="hljs-attr">format</span>: <span class="hljs-string">'json'</span>
    };
    
    <span class="hljs-keyword">if</span> (fields) params.<span class="hljs-property">fields</span> = fields;
    params.<span class="hljs-property">sign</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_generateSign</span>(params);

    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">baseURL</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(params), {
      <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>,
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/x-www-form-urlencoded'</span> }
    });
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
  }

  <span class="hljs-title function_">_generateSign</span>(<span class="hljs-params">params</span>) {
    <span class="hljs-keyword">const</span> sorted = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(params).<span class="hljs-title function_">sort</span>().<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${k}</span><span class="hljs-subst">${params[k]}</span>`</span>);
    <span class="hljs-keyword">const</span> signStr = sorted.<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>) + <span class="hljs-variable language_">this</span>.<span class="hljs-property">appSecret</span>;
    <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">createHash</span>(<span class="hljs-string">'md5'</span>).<span class="hljs-title function_">update</span>(signStr, <span class="hljs-string">'utf8'</span>).<span class="hljs-title function_">digest</span>(<span class="hljs-string">'hex'</span>);
  }
}

<span class="hljs-comment">// 调用示例</span>
<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XianyuClient</span>(<span class="hljs-string">'your_app_key'</span>, <span class="hljs-string">'your_secret'</span>, <span class="hljs-string">'your_token'</span>);
client.<span class="hljs-title function_">getItemDetail</span>(<span class="hljs-string">'658767890123'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">data</span>.<span class="hljs-property">item</span>.<span class="hljs-property">price</span>.<span class="hljs-property">current</span>))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err));
</code></pre>
<hr/>
<h2 data-id="heading-8">五、高频应用场景</h2>
<h3 data-id="heading-9">场景1：价格监控系统</h3>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 定时轮询核心商品</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">price_monitor</span>(<span class="hljs-params">item_id_list</span>):
    <span class="hljs-keyword">for</span> item_id <span class="hljs-keyword">in</span> item_id_list:
        detail = client.get_item_detail(item_id, <span class="hljs-string">"title,price,status"</span>)
        <span class="hljs-keyword">if</span> detail[<span class="hljs-string">'code'</span>] == <span class="hljs-number">200</span>:
            item = detail[<span class="hljs-string">'data'</span>][<span class="hljs-string">'item'</span>]
            <span class="hljs-comment"># 写入时序数据库</span>
            save_to_influxdb(item_id, item[<span class="hljs-string">'price'</span>][<span class="hljs-string">'current'</span>], item[<span class="hljs-string">'status'</span>])
</code></pre>
<h3 data-id="heading-10">场景2：智能选品决策</h3>
<p>通过分析商品详情中的<code>view_count</code>、<code>want_count</code>、<code>publish_time</code>等字段，计算商品热度指数：</p>
<p><code>热度指数 = (想要人数 × 0.6 + 浏览量 × 0.4) / 上架天数</code></p>
<h3 data-id="heading-11">场景3：供应链溯源</h3>
<p>结合<code>seller.verify_status</code>、<code>credit_score</code>及商品描述，构建可信度模型，识别高风险商品。</p>
<hr/>
<h2 data-id="heading-12">六、注意事项与问题排查</h2>
<h3 data-id="heading-13">6.1 调用限制</h3>
<ul>
<li><strong>频率限制</strong>：IP级100次/分钟，应用级1000次/分钟</li>
<li><strong>数据新鲜度</strong>：API数据有5分钟缓存，实时性要求高的场景需订阅Webhook推送</li>
<li><strong>字段精简</strong>：务必使用<code>fields</code>参数指定所需字段，减少带宽消耗</li>
</ul>
<h3 data-id="heading-14">6.2 错误码速查</h3>








































<table><thead><tr><th align="left">错误码</th><th align="left">说明</th><th align="left">处理建议</th></tr></thead><tbody><tr><td align="left">400</td><td align="left">参数错误</td><td align="left">检查item_id是否为纯数字</td></tr><tr><td align="left">401</td><td align="left">授权失效</td><td align="left">refresh_token或重新OAuth</td></tr><tr><td align="left">403</td><td align="left">权限不足</td><td align="left">申请item_get接口权限包</td></tr><tr><td align="left">404</td><td align="left">商品不存在</td><td align="left">商品已下架或ID错误</td></tr><tr><td align="left">429</td><td align="left">频率超限</td><td align="left">实现指数退避重试策略</td></tr><tr><td align="left">500</td><td align="left">服务异常</td><td align="left">联系技术支持并提供request_id</td></tr></tbody></table>
<h3 data-id="heading-15">6.3 性能优化技巧</h3>
<ul>
<li><strong>连接池</strong>：使用HTTP keep-alive，复用TCP连接</li>
<li><strong>批量查询</strong>：如需获取多个商品，使用<code>item_list_get</code>接口（支持20个ID）</li>
<li><strong>缓存策略</strong>：对非敏感字段（如商品标题）缓存10分钟</li>
<li><strong>降级方案</strong>：接口超时返回缓存数据，并异步更新</li>
</ul>
<hr/>
<h2 data-id="heading-16">七、数据合规与安全建议</h2>
<ol>
<li><strong>用户隐私保护</strong>：返回数据中的<code>seller.user_id</code>需脱敏后展示，禁止公开</li>
<li><strong>图片防盗链</strong>：<code>images</code>字段URL含时效token，有效期2小时，禁止永久存储</li>
<li><strong>价格数据使用</strong>：不得用于价格歧视或恶意竞价，遵守平台数据使用协议</li>
<li><strong>日志审计</strong>：记录所有API调用日志，保留90天以供合规审查</li>
</ol>
<hr/>
<h2 data-id="heading-17">八、未来能力展望</h2>
<p>某鱼平台正逐步开放更多高价值接口：</p>
<ul>
<li><code>item_recommendations_get</code>：获取相似商品推荐</li>
<li><code>seller_items_get</code>：批量获取卖家在售商品</li>
<li><code>price_trend_get</code>：获取商品价格走势图</li>
</ul>
<p>建议开发者关注开放平台动态，及时申请新能力权限。</p>
<hr/>
<h2 data-id="heading-18">结语</h2>
<p><code>item_get</code>接口是连接某鱼商品数据与业务创新的桥梁。通过合理的调用策略、健壮的错误处理与严格的数据合规，开发者可以基于此构建选品工具、数据分析平台、智能定价系统等多样化应用。记住：<strong>尊重数据价值，遵守平台规则</strong>，方能实现长期稳定的数据服务集成。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Gin 框架加载 HTML 模板：`LoadHTMLGlob` 和 `LoadHTMLFiles` 的比较与优化]]></title>    <link>https://juejin.cn/post/7573876900230348863</link>    <guid>https://juejin.cn/post/7573876900230348863</guid>    <pubDate>2025-11-18T09:38:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573876900230348863" data-draft-id="7573855399717273619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Gin 框架加载 HTML 模板：`LoadHTMLGlob` 和 `LoadHTMLFiles` 的比较与优化"/> <meta itemprop="keywords" content="后端,Go,Gin"/> <meta itemprop="datePublished" content="2025-11-18T09:38:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嘿嘿"/> <meta itemprop="url" content="https://juejin.cn/user/325111172830792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Gin 框架加载 HTML 模板：`LoadHTMLGlob` 和 `LoadHTMLFiles` 的比较与优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/325111172830792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嘿嘿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:38:37.000Z" title="Tue Nov 18 2025 09:38:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>PS:在使用gin框架渲染前端模板时遇到了问题，关于这俩方法的一个区别，记录下来备忘一下。</p>
<p>在使用 Gin 框架开发 Web 应用时，模板渲染是一个常见的需求。Gin 提供了 <code>LoadHTMLGlob</code> 和 <code>LoadHTMLFiles</code> 两个函数来加载 HTML 模板。本文将详细介绍这两个函数的用法，并结合实际项目需求，探讨如何更灵活地加载模板文件，特别是当模板文件分布在多个子文件夹中时。</p>
<h2 data-id="heading-0">1. <code>LoadHTMLGlob</code> 函数</h2>
<p><code>LoadHTMLGlob</code> 函数用于根据通配符模式加载模板文件。它的签名如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(engine *Engine)</span></span> LoadHTMLGlob(pattern <span class="hljs-type">string</span>)
</code></pre>
<h3 data-id="heading-1">用法示例</h3>
<pre><code class="hljs language-css" lang="css">r := gin.<span class="hljs-built_in">Default</span>()
r.<span class="hljs-built_in">LoadHTMLGlob</span>(<span class="hljs-string">"templates/*"</span>)
</code></pre>
<h3 data-id="heading-2">特点</h3>
<ul>
<li><strong>一次调用</strong>：<code>LoadHTMLGlob</code> <strong>只能调用一次，多次调用时只有最后一次调用生效。</strong></li>
<li><strong>通配符模式</strong>：支持通配符模式，可以一次性加载多个文件。</li>
<li><strong>灵活性</strong>：适用于模板文件位于同一目录下的情况。</li>
</ul>
<h3 data-id="heading-3">示例</h3>
<p>假设模板文件结构如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">web/
└── templates/
<span class="hljs-code">    ├── index.html
    └── user/
        └── profile.html
</span></code></pre>
<p>使用 <code>LoadHTMLGlob</code> 加载模板文件：</p>
<pre><code class="hljs language-arduino" lang="arduino">r.<span class="hljs-built_in">LoadHTMLGlob</span>(<span class="hljs-string">"web/templates/**/*"</span>)
</code></pre>
<h3 data-id="heading-4">注意事项</h3>
<ul>
<li>通配符模式需要正确设置，否则可能无法加载所有模板文件。</li>
<li><strong>只能调用一次，多次调用时只有最后一次生效</strong>。</li>
</ul>
<h2 data-id="heading-5">2. <code>LoadHTMLFiles</code> 函数</h2>
<p><code>LoadHTMLFiles</code> 函数用于加载指定的模板文件。它的签名如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(engine *Engine)</span></span> LoadHTMLFiles(files ...<span class="hljs-type">string</span>)
</code></pre>
<h3 data-id="heading-6">用法示例</h3>
<pre><code class="hljs language-css" lang="css">r := gin.<span class="hljs-built_in">Default</span>()
r.<span class="hljs-built_in">LoadHTMLFiles</span>(<span class="hljs-string">"templates/index.html"</span>, <span class="hljs-string">"templates/user/profile.html"</span>)
</code></pre>
<h3 data-id="heading-7">特点</h3>
<ul>
<li><strong>多次调用</strong>：可以多次调用，每次调用都会加载新的模板文件。</li>
<li><strong>指定文件</strong>：需要明确指定每个模板文件的路径。</li>
<li><strong>灵活性</strong>：适用于模板文件分布在多个目录下的情况。</li>
</ul>
<h3 data-id="heading-8">示例</h3>
<p>假设模板文件结构如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">web/
└── templates/
<span class="hljs-code">    ├── index.html
    └── user/
        └── profile.html
</span></code></pre>
<p>使用 <code>LoadHTMLFiles</code> 加载模板文件：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> tplFiles []<span class="hljs-type">string</span>
filepath.WalkDir(<span class="hljs-string">"./web/templates"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(path <span class="hljs-type">string</span>, d fs.DirEntry, err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">if</span> d.IsDir() {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
    tplFiles = <span class="hljs-built_in">append</span>(tplFiles, path)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
})
r.LoadHTMLFiles(tplFiles...)
</code></pre>
<h3 data-id="heading-9">注意事项</h3>
<ul>
<li>需要手动遍历目录并收集所有模板文件路径。</li>
<li>每次调用都会加载新的模板文件，可能会导致性能问题。</li>
</ul>
<h2 data-id="heading-10">优化方案</h2>
<p>在实际项目中，模板文件可能会分布在多个子文件夹中，使用 <code>LoadHTMLGlob</code> 可能无法满足需求。<code>LoadHTMLFiles</code> 提供了更大的灵活性，但需要手动收集模板文件路径。下面是一个优化方案，结合 <code>filepath.WalkDir</code> 和 <code>LoadHTMLFiles</code> 来灵活加载模板文件。</p>
<h3 data-id="heading-11">步骤</h3>
<ol>
<li><strong>遍历目录</strong>：使用 <code>filepath.WalkDir</code> 遍历模板目录，收集所有模板文件路径。</li>
<li><strong>加载模板</strong>：使用 <code>LoadHTMLFiles</code> 加载收集到的模板文件路径。</li>
</ol>
<h3 data-id="heading-12">实现代码</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"embed"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"log"</span>
    <span class="hljs-string">"net/http"</span>
    <span class="hljs-string">"path/filepath"</span>

    <span class="hljs-string">"github.com/gin-gonic/gin"</span>
)

<span class="hljs-comment">//go:embed web/templates</span>
<span class="hljs-keyword">var</span> templates embed.FS

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    r := gin.Default()

    <span class="hljs-comment">// 收集所有模板文件路径</span>
    <span class="hljs-keyword">var</span> tplFiles []<span class="hljs-type">string</span>
    err := filepath.WalkDir(<span class="hljs-string">"./web/templates"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(path <span class="hljs-type">string</span>, d fs.DirEntry, err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">error</span> {
        <span class="hljs-keyword">if</span> d.IsDir() {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }
        tplFiles = <span class="hljs-built_in">append</span>(tplFiles, path)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    })
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatalf(<span class="hljs-string">"Failed to walk templates directory: %v"</span>, err)
    }

    <span class="hljs-comment">// 加载模板文件</span>
    r.LoadHTMLFiles(tplFiles...)

    <span class="hljs-comment">// 定义路由</span>
    r.GET(<span class="hljs-string">"/"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
        c.HTML(http.StatusOK, <span class="hljs-string">"index.html"</span>, gin.H{
            <span class="hljs-string">"title"</span>: <span class="hljs-string">"Home Page"</span>,
        })
    })

    r.GET(<span class="hljs-string">"/user/profile"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
        c.HTML(http.StatusOK, <span class="hljs-string">"user/profile.html"</span>, gin.H{
            <span class="hljs-string">"title"</span>: <span class="hljs-string">"User Profile"</span>,
        })
    })

    <span class="hljs-comment">// 启动服务器</span>
    <span class="hljs-keyword">if</span> err := r.Run(<span class="hljs-string">":8080"</span>); err != <span class="hljs-literal">nil</span> {
        log.Fatalf(<span class="hljs-string">"Failed to start server: %v"</span>, err)
    }
}
</code></pre>
<h3 data-id="heading-13">详细说明</h3>
<ol>
<li>
<p><strong>遍历目录</strong>：</p>
<ul>
<li>使用 <code>filepath.WalkDir</code> 遍历 <code>web/templates</code> 目录，收集所有文件路径。</li>
<li><code>filepath.WalkDir</code> 会递归地遍历目录，确保所有子目录中的文件都被收集。</li>
</ul>
</li>
<li>
<p><strong>加载模板</strong>：</p>
<ul>
<li>使用 <code>r.LoadHTMLFiles(tplFiles...)</code> 加载所有收集到的模板文件路径。</li>
<li><code>LoadHTMLFiles</code> 可以多次调用，但这里只调用一次，确保所有模板文件都被加载。</li>
</ul>
</li>
<li>
<p><strong>定义路由</strong>：</p>
<ul>
<li>定义路由并渲染模板。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-14">优点</h3>
<ul>
<li><strong>灵活性</strong>：可以加载分布在多个子文件夹中的模板文件。</li>
<li><strong>可维护性</strong>：模板文件路径自动收集，无需手动指定。</li>
</ul>
<h3 data-id="heading-15">注意事项</h3>
<ul>
<li>确保模板文件路径正确。</li>
<li>大量模板文件时，遍历和加载可能会影响性能，可以考虑缓存模板文件。</li>
</ul>
<h2 data-id="heading-16">总结</h2>
<p><code>LoadHTMLGlob</code> 和 <code>LoadHTMLFiles</code> 都是 Gin 框架中用于加载 HTML 模板的函数，各有优缺点。<code>LoadHTMLGlob</code> 适用于模板文件位于同一目录下的情况，而 <code>LoadHTMLFiles</code> 提供了更大的灵活性，适用于模板文件分布在多个目录中的情况。通过结合 <code>filepath.WalkDir</code> 和 <code>LoadHTMLFiles</code>，可以更灵活地加载模板文件，满足复杂项目的需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[视觉分层，对人工神经网络的启示]]></title>    <link>https://juejin.cn/post/7573855399717306387</link>    <guid>https://juejin.cn/post/7573855399717306387</guid>    <pubDate>2025-11-18T09:39:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573855399717306387" data-draft-id="7573863952116318214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="视觉分层，对人工神经网络的启示"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-18T09:39:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Juchecar"/> <meta itemprop="url" content="https://juejin.cn/user/284133851925070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            视觉分层，对人工神经网络的启示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/284133851925070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Juchecar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:39:03.000Z" title="Tue Nov 18 2025 09:39:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>人脑视觉系统的层次化处理模型为人工神经网络（尤其是计算机视觉和AGI）的发展提供了至关重要的借鉴路线图、批判性镜子和灵感源泉。</p>
<p>以下是一些关键的借鉴意义：</p>
<h3 data-id="heading-0">1. 核心架构启示：层次化与模块化</h3>
<p><strong>人脑的启示</strong>：视觉通路是清晰的层次化结构（V1 -&gt; V2 -&gt; V4 -&gt; IT...），且存在一定程度的模块化（如面孔区、文字区）。</p>
<p><strong>对ANN的借鉴</strong>：</p>
<ul>
<li><strong>深度卷积网络的成功</strong>：CNN的“卷积层 -&gt; 池化层 -&gt; 全连接层”结构本身就是对大脑层次化处理的最直接致敬。浅层网络学习边缘、纹理等通用特征，深层网络学习更抽象的特征（如车轮、眼睛）。</li>
<li><strong>超越“端到端”的黑箱</strong>：当前很多模型是单一任务的“端到端”学习。大脑告诉我们，<strong>构建一些专门化的“子系统”可能更高效</strong>。例如，在通用视觉模型之上，微调出用于医疗影像、自动驾驶、工业质检的专用模块，这类似于大脑在通用物体识别区旁“长出”了面孔识别区。</li>
<li><strong>通向AGI的路径</strong>：要实现通用人工智能，不能只靠一个巨型网络。可能需要一个由多个专门化、层次化的子系统组成的“联盟”，就像大脑有不同的视觉流（腹侧通路“是什么”，背侧通路“在哪里”）。</li>
</ul>
<h3 data-id="heading-1">2. 处理策略启示：从通用到专用，从无监督到有监督</h3>
<p><strong>人脑的启示</strong>：大脑的低级视觉皮层（如V1）在出生时就具备了一定的结构，对线条、朝向等有先天偏好。随后通过海量的无监督学习（婴儿不停地看世界）来锤炼这些连接，最后才由文化教育（有监督学习）来精细调整高级区域（如文字识别区）。</p>
<p><strong>对ANN的借鉴</strong>：</p>
<ul>
<li><strong>预训练与迁移学习</strong>：这类似于大脑的“先天结构+无监督学习”。我们先在海量无标签数据（如ImageNet）上对模型进行预训练，让它学习通用的视觉特征，然后再用少量有标签数据对特定任务（如医学影像分类）进行微调。这正是大脑从“学会看”到“看懂特定东西”的缩影。</li>
<li><strong>重视无监督/自监督学习</strong>：大脑主要依靠无监督学习。这激励我们大力发展自监督学习算法，让模型能从世界本身的结构中学习，减少对昂贵人工标注数据的依赖。这才是通向更智能系统的关键。</li>
</ul>
<h3 data-id="heading-2">3. 信息流启示：前馈与反馈的闭环</h3>
<p><strong>人脑的启示</strong>：大脑中的“前馈连接”负责快速传递信息，但更有大量的是“反馈连接”。高级区域会不断向低级区域发送信号，调节其活动。这就是<strong>注意力机制</strong>和<strong>预测编码</strong> 的神经基础。你看到的不仅是你眼睛收到的，更是你大脑“预期”收到的。</p>
<p><strong>对ANN的借鉴</strong>：</p>
<ul>
<li><strong>注意力机制的普及</strong>：Transformer架构中的自注意力机制和CNN中的注意力模块，正是对这种反馈调节的模拟。它让模型能够“聚焦”于输入中更重要的部分，动态调整其处理资源，极大地提升了性能。</li>
<li><strong>生成式模型与预测学习</strong>：像GANs、Diffusion Models这样的生成式模型，其核心思想是让模型学习数据的分布，并能够“预测”或“生成”完整数据。这类似于大脑不断根据上下文和先验知识对感官输入进行预测和补全。未来的感知模型很可能将是“分析-生成”一体化的。</li>
</ul>
<h3 data-id="heading-3">4. 多模态融合启示：跨模态的深度融合</h3>
<p><strong>人脑的启示</strong>：当你看到一个苹果，你大脑中关于它的颜色、形状、触感、味道、名称的神经网络会同时激活。视觉识别不是孤立的，它与触觉、听觉、语义、情感记忆紧密交织。</p>
<p><strong>对ANN的借鉴</strong>：</p>
<ul>
<li><strong>多模态大模型是未来</strong>：CLIP模型的成功证明了这一点。通过将图像和文本在同一个嵌入空间中对齐，模型获得了强大的零样本推理能力。这正是对大脑“概念系统”的模仿，一个苹果的视觉表象和“apple”这个词义，在大脑中是指向同一个概念的。</li>
<li><strong>符号与感知的结合</strong>：纯连接主义模型（如ANN）在处理抽象推理和符号逻辑上仍有困难。大脑则完美地将亚符号的感知（一个红色的圆形物体）与符号化的概念（“苹果”、“食物”）结合在一起。这提示我们，<strong>下一代AI可能需要连接主义与符号主义的新融合</strong>。</li>
</ul>
<h3 data-id="heading-4">5. 对“美”的理解的启示：构建价值系统</h3>
<p><strong>人脑的启示</strong>：“美”的判断是一个多因素评估系统，涉及本能、学习、情感和文化的复杂互动。</p>
<p><strong>对ANN的借鉴</strong>：</p>
<ul>
<li><strong>超越分类和检测</strong>：当前AI的目标函数多是“准确分类”、“精确检测”。但要实现更高级的智能（如具身AI、创意AI），我们需要为它们引入<strong>内在动机和价值系统</strong>。</li>
<li><strong>AI艺术与评估</strong>：我们能否训练一个AI来评估“美感”？这需要为它提供不仅仅是物体标签的数据，而是融合了对称性、色彩和谐、文化语境、甚至情感共鸣的复杂训练目标。这实际上是尝试将人类的“价值判断”机制部分地编码到模型中。</li>
</ul>
<h3 data-id="heading-5">总结与挑战</h3>

































<table><thead><tr><th align="left">人脑特性</th><th align="left">对人工神经网络的借鉴与挑战</th></tr></thead><tbody><tr><td align="left"><strong>层次化与模块化</strong></td><td align="left">深度网络的成功；需发展更灵活的模块化架构。</td></tr><tr><td align="left"><strong>无监督学习为主</strong></td><td align="left">需大力发展自监督学习，减少对标注数据的依赖。</td></tr><tr><td align="left"><strong>强大的反馈连接</strong></td><td align="left">引入注意力机制、预测编码，构建分析-生成一体化模型。</td></tr><tr><td align="left"><strong>多模态深度融合</strong></td><td align="left">发展多模态大模型，探索符号与感知的结合。</td></tr><tr><td align="left"><strong>具身与互动</strong></td><td align="left">AI需要与世界互动，才能获得真正的“理解”。</td></tr><tr><td align="left"><strong>价值与情感系统</strong></td><td align="left">为高级AI构建内在动机和价值判断系统。</td></tr></tbody></table>
<p><strong>最终，人脑给我们的最大启示是：智能不是一个单一的“识别”任务，而是一个由感知、行动、记忆、情感和价值判断紧密交织而成的、与环境持续互动的动态过程。</strong> 当前的人工神经网络在“感知”的某些方面已经取得了惊人成就，但在走向更通用智能的道路上，我们必须借鉴大脑的这种整体性、互动性和价值导向性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS奇技淫巧：用你意想不到的4种属性实现裁剪遮罩效果]]></title>    <link>https://juejin.cn/post/7573680361990602792</link>    <guid>https://juejin.cn/post/7573680361990602792</guid>    <pubDate>2025-11-18T09:40:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573680361990602792" data-draft-id="7566537463567810600" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS奇技淫巧：用你意想不到的4种属性实现裁剪遮罩效果"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-18T09:40:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS奇技淫巧：用你意想不到的4种属性实现裁剪遮罩效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:40:33.000Z" title="Tue Nov 18 2025 09:40:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在公司开发图片裁剪功能时，需要实现一个裁剪框效果：选中区域清晰显示，而周围区域用半透明遮罩覆盖。正常我实现会用4个div分别盖住上、下、左、右四个区域用于裁剪框周围的遮罩。</p>
<p>本文将介绍几种纯CSS实现的巧妙实现方案，主要内容有：</p>
<ol>
<li>box-shadow 阴影方法</li>
<li>outline 轮廓法</li>
<li>clip-path 裁剪方法</li>
<li>background 渐变方法</li>
</ol>
<p>展示的效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc83681b2577489598c9f143929bd2af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764063633&amp;x-signature=ox%2FordQ53Rkxc%2BstSEbwr92EkEM%3D" alt="image.png" loading="lazy"/></p>
<p>下面分别介绍下每种方式的实现。</p>
<h2 data-id="heading-1">1. box-shadow 方法</h2>
<p>原理是利用 box-shadow 的扩散半径特性，设置一个超大的阴影覆盖整个画布。 优点是：代码量最少，只需一行CSS，实现简单。</p>
<pre><code class="hljs language-js" lang="js">.<span class="hljs-property">crop</span>-box {
  box-<span class="hljs-attr">shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> 9999px <span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>);
}
</code></pre>
<h2 data-id="heading-2">2. outline 方法</h2>
<p>原理和box-shadow 类似，使用超大的 outline 实现遮罩。
outline（轮廓）与border类似，但不占用文档流空间，且不会影响元素尺寸。通过超大outline覆盖非裁剪区域，实现遮罩效果。</p>
<pre><code class="hljs language-js" lang="js">.<span class="hljs-property">crop</span>-box {
  <span class="hljs-attr">outline</span>: 9999px solid <span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>);
}
</code></pre>
<h2 data-id="heading-3">3. 伪元素 + clip-path 方法</h2>
<p>原理是使用 ::before 伪元素创建遮罩，通过 clip-path 的 polygon 裁剪出中间镂空区域。</p>
<pre><code class="hljs language-js" lang="js">  .<span class="hljs-property">wrapper</span>::before {
      <span class="hljs-attr">content</span>: <span class="hljs-string">''</span>;
      <span class="hljs-attr">background</span>: <span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>);
      clip-<span class="hljs-attr">path</span>: <span class="hljs-title function_">polygon</span>(
          <span class="hljs-number">0</span> <span class="hljs-number">0</span>, <span class="hljs-number">0</span> <span class="hljs-number">100</span>%, 50px <span class="hljs-number">100</span>%, 50px 50px,
          250px 50px, 250px 200px, 50px 200px,
          50px <span class="hljs-number">100</span>%, <span class="hljs-number">100</span>% <span class="hljs-number">100</span>%, <span class="hljs-number">100</span>% <span class="hljs-number">0</span>
      );
  }
</code></pre>
<h2 data-id="heading-4">4. background 渐变方法</h2>
<p>原理是使用 linear-gradient 创建十字交叉的渐变遮罩。利用线性渐变（linear-gradient）的“颜色断层”特性，生成四宫格状的遮罩效果，非裁剪区域用半透明色覆盖，目标区域为透明。</p>
<pre><code class="hljs language-js" lang="js">.<span class="hljs-property">wrapper</span> {
    <span class="hljs-attr">position</span>: absolute;
    <span class="hljs-attr">inset</span>: <span class="hljs-number">0</span>;
    background-<span class="hljs-attr">image</span>:
        <span class="hljs-comment">/* 上方遮罩 */</span>
        linear-<span class="hljs-title function_">gradient</span>(<span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>), <span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>)),
        <span class="hljs-comment">/* 下方遮罩 */</span>
        linear-<span class="hljs-title function_">gradient</span>(<span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>), <span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>)),
        <span class="hljs-comment">/* 左侧遮罩 */</span>
        linear-<span class="hljs-title function_">gradient</span>(<span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>), <span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>)),
        <span class="hljs-comment">/* 右侧遮罩 */</span>
        linear-<span class="hljs-title function_">gradient</span>(<span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>), <span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>));
    background-<span class="hljs-attr">size</span>:
        <span class="hljs-number">100</span>% 50px,      <span class="hljs-comment">/* 上方 */</span>
        <span class="hljs-number">100</span>% <span class="hljs-title function_">calc</span>(<span class="hljs-number">100</span>% - 200px), <span class="hljs-comment">/* 下方 */</span>
        50px 150px,     <span class="hljs-comment">/* 左侧 */</span>
        <span class="hljs-title function_">calc</span>(<span class="hljs-number">100</span>% - 250px) 150px; <span class="hljs-comment">/* 右侧 */</span>
    background-<span class="hljs-attr">position</span>:
        <span class="hljs-number">0</span> <span class="hljs-number">0</span>,            <span class="hljs-comment">/* 上方 */</span>
        <span class="hljs-number">0</span> 200px,        <span class="hljs-comment">/* 下方 */</span>
        <span class="hljs-number">0</span> 50px,         <span class="hljs-comment">/* 左侧 */</span>
        250px 50px;     <span class="hljs-comment">/* 右侧 */</span>
    background-<span class="hljs-attr">repeat</span>: no-repeat;
    pointer-<span class="hljs-attr">events</span>: none;
}

</code></pre>
<h2 data-id="heading-5">总结</h2>
<p>最后总结一下：实现裁剪框遮罩效果有多种方案,在实际项目中，推荐使用 box-shadow 方法，简单高效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别终端低效，10个让同事直呼卧槽的小技巧]]></title>    <link>https://juejin.cn/post/7573988811916017714</link>    <guid>https://juejin.cn/post/7573988811916017714</guid>    <pubDate>2025-11-18T09:48:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573988811916017714" data-draft-id="7573899782802440238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别终端低效，10个让同事直呼卧槽的小技巧"/> <meta itemprop="keywords" content="后端,命令行"/> <meta itemprop="datePublished" content="2025-11-18T09:48:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别终端低效，10个让同事直呼卧槽的小技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:48:09.000Z" title="Tue Nov 18 2025 09:48:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 IDE 横行的今天，我们这些程序员依然需要跟终端打交道，三五年下来，谁还没踩过一些坑，又或者自己琢磨出一些能让效率起飞的小窍门呢？</p>
<p>今天不聊那些 <code>ls -la</code> 比 <code>ls</code> 好用之类的基础知识，只分享那些真正改变我工作流、甚至让旁边同事忍不住探过头来问“哥们，你这手速没单身30年练不下来吧”的实战技巧。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e28acc21c0c44b3b8d9d20be99840c43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064858&amp;x-signature=eaHurpyHPqlEfwxvIvtgxbAYC7Y%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-0">快速定位系统性能瓶颈</h3>
<p>服务器或者自己电脑突然变卡，得快速知道是谁在捣鬼。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看哪个目录最占硬盘空间（只看当前目录下一级）</span>
<span class="hljs-built_in">du</span> -ah --max-depth=1 | <span class="hljs-built_in">sort</span> -rh | <span class="hljs-built_in">head</span> -n 10

<span class="hljs-comment"># 按 CPU 使用率列出排名前 10 的进程</span>
ps aux --<span class="hljs-built_in">sort</span>=-%cpu | <span class="hljs-built_in">head</span> -n 11

<span class="hljs-comment"># 按内存使用率列出排名前 10 的进程</span>
ps aux --<span class="hljs-built_in">sort</span>=-%mem | <span class="hljs-built_in">head</span> -n 11
</code></pre>
<h3 data-id="heading-1">环境和配置管理？交给专业的来</h3>
<p>以前，管理本地开发环境简直是一场灾难。一会儿要配 PHP，一会儿又要弄 Node.js，还得装个 Python。各种环境变量、数据库配置写在 <code>.bashrc</code> 或 <code>.zshrc</code> 里，像这样：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 老办法：用函数切换环境</span>
<span class="hljs-function"><span class="hljs-title">switch_env</span></span>() {
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> = <span class="hljs-string">"proj_a"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">export</span> DB_HOST=<span class="hljs-string">"localhost"</span>
        <span class="hljs-built_in">export</span> DB_PORT=<span class="hljs-string">"3306"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"切换到项目 A 环境"</span>
    <span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> = <span class="hljs-string">"proj_b"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">export</span> DB_HOST=<span class="hljs-string">"127.0.0.1"</span>
        <span class="hljs-built_in">export</span> DB_PORT=<span class="hljs-string">"5432"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"切换到项目 B 环境"</span>
    <span class="hljs-keyword">fi</span>
}
</code></pre>
<p>这种方式手动维护起来很麻烦，项目一多，配置文件就变得特别臃肿，切换起来也容易出错。</p>
<p>但是，时代变了，朋友们。现在我处理本地开发环境，都用 ServBay。</p>
<p>请注意，ServBay不是命令行工具，而是一个集成的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">本地开发环境平台</a>。它把程序员常用的语言，比如 PHP、Node.js、Python、Go、Rust 都打包好了，需要哪个版本点一下就行，完全不用自己去折腾编译和环境变量。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f229b9b0b3047bf80e51111c6cc3dcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064858&amp;x-signature=XZuUaSxfK%2BPVtpIb5MAIfMJbXlU%3D" alt="CleanShot 2025-11-18 at 18.00.15@2x.png" loading="lazy"/></p>
<p>数据库也一样，无论是 SQL（MySQL, PostgreSQL）还是 NoSQL（Redis, MongoDB），都给你准备得妥妥的。而且它支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">一键部署本地 AI</a>，适合vibe coder。</p>
<p>用了 ServBay 之后，上面那些复杂的环境切换脚本我早就删了。所有环境和配置管理都通过一个清爽的图形界面搞定，我变强了，也变快了。</p>
<h3 data-id="heading-2">一行搞定网络调试</h3>
<p>简单测试一下端口通不通，或者 API 能不能访问，完全没必要打开 Postman 那么重的工具。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查本地 3306 端口是否开放</span>
nc -zv 127.0.0.1 3306

<span class="hljs-comment"># 快速给 API 发送一个 POST 请求</span>
curl -X POST http://localhost:8080/api/v1/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"username":"test","role":"admin"}'</span>
</code></pre>
<h3 data-id="heading-3">目录间的闪转腾挪：<code>pushd</code> 和 <code>popd</code></h3>
<p>还在用一连串的 <code>cd ../../..</code> 来返回之前的目录吗？那也太“复古”了。试试目录栈吧。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 你当前在 /Users/me/workspace/project-a/src</span>
<span class="hljs-built_in">pushd</span> /etc/nginx/conf.d
<span class="hljs-comment"># 这时你瞬间移动到了 Nginx 配置目录，并且终端会记住你来的地方</span>

<span class="hljs-comment"># 在这里查看和修改配置...</span>
vim default.conf

<span class="hljs-comment"># 搞定之后，想回去了？</span>
<span class="hljs-built_in">popd</span>
<span class="hljs-comment"># “嗖”的一下，你又回到了 /Users/me/workspace/project-a/src</span>
</code></pre>
<p><code>pushd</code> 可以多次使用，它会把目录一个个地压入一个“栈”里。可以用 <code>dirs -v</code> 查看这个栈，然后用 <code>pushd +N</code> 跳到指定的目录。对于需要在多个不相关的目录之间反复横跳的场景，这就是大杀器。</p>
<h3 data-id="heading-4">文件操作的骚操作</h3>
<p>用 <code>cp</code> 复制大文件时，看着光标一动不动，你是不是也曾怀疑过电脑是不是死机了？</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 rsync (macOS 自带，Linux 大部分也自带)</span>
<span class="hljs-comment"># 复制文件并显示进度条</span>
rsync -avh --progress source-large-file.zip /path/to/destination/
</code></pre>
<p>查找文件，<code>find</code> 命令固然强大，但参数复杂得像咒语。我更推荐用 <code>fd</code>，一个更快、更友好的替代品。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 fd (brew install fd / apt install fd-find)</span>
<span class="hljs-comment"># 查找所有 tsx 文件</span>
fd <span class="hljs-string">".tsx$"</span>

<span class="hljs-comment"># 查找并删除所有 .log 文件</span>
fd <span class="hljs-string">".log$"</span> --<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> {}
</code></pre>
<p>批量重命名文件，也不用再写复杂的脚本了。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 比如把所有的 .jpeg 后缀改成 .jpg</span>
<span class="hljs-keyword">for</span> img <span class="hljs-keyword">in</span> *.jpeg; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">mv</span> <span class="hljs-string">"<span class="hljs-variable">$img</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${img%.jpeg}</span>.jpg"</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h3 data-id="heading-5">历史命令的魔法：<code>!!</code> 和 <code>!$</code></h3>
<p>这个绝对是手残党和健忘症患者的良药。最常见的场景就是，刚敲了一个需要管理员权限的命令，然后……</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 信心满满地创建目录</span>
<span class="hljs-built_in">mkdir</span> /usr/local/my-app
<span class="hljs-comment"># 得到一个冷冰冰的 "Permission denied"</span>

<span class="hljs-comment"># 这时候别傻乎乎地重敲一遍，优雅地输入：</span>
sudo !!
<span class="hljs-comment"># 这行命令会自动展开成：sudo mkdir /usr/local/my-app</span>
</code></pre>
<p><code>!!</code> 代表上一条完整的命令。而 <code>!$</code> 则更精妙，它代表上一条命令的最后一个参数。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建一个藏得很深的项目目录</span>
<span class="hljs-built_in">mkdir</span> -p projects/a-very-long/and-nested/project-name

<span class="hljs-comment"># 紧接着，想进入这个目录</span>
<span class="hljs-built_in">cd</span> !$
<span class="hljs-comment"># 是的，它会自动展开成：cd projects/a-very-long/and-nested/project-name</span>

<span class="hljs-comment"># 或者，想在那个目录下创建一个文件</span>
<span class="hljs-built_in">touch</span> !$/index.js
</code></pre>
<p>自从熟练掌握了这两个符号，我的键盘方向上键和 <code>Ctrl+C</code> 的使用频率都降低了不少。</p>
<h3 data-id="heading-6">进程管理不用抓狂</h3>
<p>以前杀个进程，得先 <code>ps aux | grep xxx</code>，然后复制 PID，再 <code>kill -9 PID</code>，一套操作下来黄花菜都凉了。现在，我们可以更直接一点。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 按名字干掉某个进程</span>
pkill -f <span class="hljs-string">"gunicorn"</span>

<span class="hljs-comment"># 优雅地请所有 Python 脚本进程“离开”</span>
pkill -f <span class="hljs-string">"python.*.py"</span>
</code></pre>
<p>对于我们这些经常和端口打交道的开发者来说，端口被占用的问题更是家常便饭。下面这个函数，我把它写进了我的 <code>.zshrc</code> 里，谁用谁知道。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 定义一个函数，专门用来释放被占用的端口</span>
<span class="hljs-function"><span class="hljs-title">free_port</span></span>() {
    lsof -i tcp:<span class="hljs-variable">$1</span> | grep LISTEN | awk <span class="hljs-string">'{print $2}'</span> | xargs <span class="hljs-built_in">kill</span> -9
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"端口 <span class="hljs-variable">$1</span> 已释放"</span>
}

<span class="hljs-comment"># 比如，干掉占用 8000 端口的那个“钉子户”</span>
free_port 8000
</code></pre>
<h3 data-id="heading-7">给 Git 整个外挂</h3>
<p>把这些别名（alias）加到 <code>~/.gitconfig</code> 文件里，每天能省下无数次敲击键盘的力气。</p>
<pre><code class="hljs language-bash" lang="bash">[<span class="hljs-built_in">alias</span>]
    co = checkout
    br = branch
    ci = commit -m
    st = status -sb
    lg = <span class="hljs-built_in">log</span> --graph --pretty=format:<span class="hljs-string">'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset'</span>
    
    <span class="hljs-comment"># 把暂存区的修改撤销回来</span>
    unstage = reset HEAD --
    
    <span class="hljs-comment"># 彻底丢弃上一次提交，但保留代码改动</span>
    undo = reset --soft HEAD~1

    <span class="hljs-comment"># 一键推送当前分支到远程</span>
    pushup = <span class="hljs-string">"!git push --set-upstream origin <span class="hljs-subst">$(git rev-parse --abbrev-ref HEAD)</span>"</span>
</code></pre>
<p>还有一个我特别喜欢的，一键清理已经合并到主干的本地分支，分支列表干净清爽。</p>
<pre><code class="hljs language-bash" lang="bash">git branch --merged main | grep -v <span class="hljs-string">"*|main|develop"</span> | xargs -n 1 git branch -d
</code></pre>
<h3 data-id="heading-8">文本处理，快准狠</h3>
<p>从日志里捞个邮箱，或者快速格式化一坨 JSON，都是日常操作。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从文件里提取所有 URL</span>
grep -oE <span class="hljs-string">'https?://[a-zA-Z0-9./-]+'</span> access.log

<span class="hljs-comment"># 格式化粘贴板里的 JSON (macOS)</span>
pbpaste | jq .

<span class="hljs-comment"># 从 API 响应中只提取需要的字段</span>
curl -s <span class="hljs-string">'https://api.github.com/users/torvalds'</span> | jq <span class="hljs-string">'.name, .followers'</span>
</code></pre>
<h3 data-id="heading-9">把重复劳动变成自动化脚本</h3>
<p>真正拉开效率差距的，是把那些每天都在重复的操作，变成一个可以随时呼叫的函数或脚本。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 比如，创建一个新前端项目的完整流程</span>
<span class="hljs-function"><span class="hljs-title">new_react_project</span></span>() {
    npx create-react-app <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> &amp;&amp; <span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    git init &amp;&amp; git add .
    git commit -m <span class="hljs-string">"🎉 Initial commit"</span>
    <span class="hljs-comment"># 自动在 VS Code 中打开</span>
    code .
}

<span class="hljs-comment"># 比如，在执行危险操作前，快速打包备份当前目录</span>
<span class="hljs-function"><span class="hljs-title">backup</span></span>() {
    <span class="hljs-built_in">local</span> fname=<span class="hljs-string">"backup-<span class="hljs-subst">$(date +%Y%m%d-%H%M)</span>.tar.gz"</span>
    tar -czvf <span class="hljs-string">"<span class="hljs-variable">$fname</span>"</span> . --exclude-from=.gitignore
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"备份完成: <span class="hljs-variable">$fname</span>"</span>
}
</code></pre>
<p>把这些函数写进 <code>.bashrc</code> 或 <code>.zshrc</code>，下次再做同样的事情时，只需要敲一个命令就搞定了。</p>
<h3 data-id="heading-10">写在最后</h3>
<p>这些技巧本身并不复杂，但它们就像肌肉记忆，一旦养成习惯，就能在日常工作中节省大量时间。对程序员来说，时间就是头发。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Qt6 QML 实现DateTimePicker组件]]></title>    <link>https://juejin.cn/post/7573855399717371923</link>    <guid>https://juejin.cn/post/7573855399717371923</guid>    <pubDate>2025-11-18T09:49:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573855399717371923" data-draft-id="7573876900230414399" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Qt6 QML 实现DateTimePicker组件"/> <meta itemprop="keywords" content="前端,Qt"/> <meta itemprop="datePublished" content="2025-11-18T09:49:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Qt6 QML 实现DateTimePicker组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:49:52.000Z" title="Tue Nov 18 2025 09:49:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Qt6 QML 实现DateTimePicker组件</h2>
<h3 data-id="heading-1">实现代码</h3>
<p>基于QT6.10</p>
<pre><code class="hljs language-qmllang" lang="qmllang">// DateTimePicker.qml
import QtQuick
import QtQuick.Controls
import QtQuick.Layouts

Popup {
    id: dateTimePicker

    width: 650
    height: 480

    modal: true
    closePolicy: Popup.CloseOnEscape | Popup.CloseOnPressOutside
    padding: 0
    focus: true

    readonly property color colorBackground: "#2b2b2b"
    readonly property color colorSurface: "#1e1e1e"
    readonly property color colorSurfaceVariant: "#222"
    readonly property color colorBorder: "#444"
    readonly property color colorBorderLight: "#555"

    readonly property color colorPrimary: "#007AFF"
    readonly property color colorPrimaryHover: "#0066CC"

    readonly property color colorTextPrimary: "white"
    readonly property color colorTextSecondary: "#aaa"
    readonly property color colorTextTertiary: "#888"
    readonly property color colorTextDisabled: "#444"

    readonly property color colorHover: "#333"
    readonly property color colorHoverLight: "#444"
    readonly property color colorHoverDark: "#555"

    readonly property color colorScrollbar: "#555"
    readonly property color colorScrollbarHover: "#666"
    readonly property color colorScrollbarPressed: "#888"

    readonly property color colorDisabled: "#555"

    property string dateTime: Qt.formatDateTime(new Date(), "yyyy-MM-dd hh:mm:ss")
    property string dateFormat: "yyyy-MM-dd"
    property string timeFormat: "hh:mm:ss"
    property string minDateTime: ""
    property string maxDateTime: ""

    property date selectedDate: new Date()
    property int selectedHour: 0
    property int selectedMinute: 0
    property int selectedSecond: 0

    property int currentYear: new Date().getFullYear()
    property int currentMonth: new Date().getMonth()

    property bool hasSelection: false  // 选择状态标记

    // 焦点区域属性
    property int focusArea: 0  // 0: 日期, 1: 时, 2: 分, 3: 秒
    property int focusedDateIndex: 0  // 日历格子索引

    signal confirmed(date datetime)

    background: Rectangle {
        color: dateTimePicker.colorBackground
        radius: 8

        FocusScope {
            id: keyboardHandler
            anchors.fill: parent
            focus: true

            Keys.onPressed: function (event) {
                if (event.key === Qt.Key_Left) {
                    if (dateTimePicker.focusArea === 0) {
                        dateTimePicker.focusedDateIndex = Math.max(0, dateTimePicker.focusedDateIndex - 1)
                        dateTimePicker.selectedDate = getDateForCell(dateTimePicker.focusedDateIndex)
                        dateTimePicker.hasSelection = true
                    } else if (dateTimePicker.focusArea &gt; 0) {
                        dateTimePicker.focusArea = Math.max(0, dateTimePicker.focusArea - 1)
                    }
                    event.accepted = true
                } else if (event.key === Qt.Key_Right) {
                    if (dateTimePicker.focusArea === 0) {
                        dateTimePicker.focusedDateIndex = Math.min(41, dateTimePicker.focusedDateIndex + 1)
                        dateTimePicker.selectedDate = getDateForCell(dateTimePicker.focusedDateIndex)
                        dateTimePicker.hasSelection = true
                    } else if (dateTimePicker.focusArea &lt; 3) {
                        dateTimePicker.focusArea = Math.min(3, dateTimePicker.focusArea + 1)
                    }
                    event.accepted = true
                } else if (event.key === Qt.Key_Up) {
                    if (dateTimePicker.focusArea === 0) {
                        dateTimePicker.focusedDateIndex = Math.max(0, dateTimePicker.focusedDateIndex - 7)
                        dateTimePicker.selectedDate = getDateForCell(dateTimePicker.focusedDateIndex)
                        dateTimePicker.hasSelection = true
                    } else {
                        if (dateTimePicker.focusArea === 1) {
                            dateTimePicker.selectedHour = (dateTimePicker.selectedHour - 1 + 24) % 24
                        } else if (dateTimePicker.focusArea === 2) {
                            dateTimePicker.selectedMinute = (dateTimePicker.selectedMinute - 1 + 60) % 60
                        } else {
                            dateTimePicker.selectedSecond = (dateTimePicker.selectedSecond - 1 + 60) % 60
                        }
                        dateTimePicker.hasSelection = true
                    }
                    event.accepted = true
                } else if (event.key === Qt.Key_Down) {
                    if (dateTimePicker.focusArea === 0) {
                        dateTimePicker.focusedDateIndex = Math.min(41, dateTimePicker.focusedDateIndex + 7)
                        dateTimePicker.selectedDate = getDateForCell(dateTimePicker.focusedDateIndex)
                        dateTimePicker.hasSelection = true
                    } else {
                        if (dateTimePicker.focusArea === 1) {
                            dateTimePicker.selectedHour = (dateTimePicker.selectedHour + 1) % 24
                        } else if (dateTimePicker.focusArea === 2) {
                            dateTimePicker.selectedMinute = (dateTimePicker.selectedMinute + 1) % 60
                        } else {
                            dateTimePicker.selectedSecond = (dateTimePicker.selectedSecond + 1) % 60
                        }
                        dateTimePicker.hasSelection = true
                    }
                    event.accepted = true
                } else if (event.key === Qt.Key_Tab) {
                    dateTimePicker.focusArea = (dateTimePicker.focusArea + 1) % 4
                    event.accepted = true
                } else if (event.key === Qt.Key_Backtab) {
                    dateTimePicker.focusArea = (dateTimePicker.focusArea - 1 + 4) % 4
                    event.accepted = true
                } else if (event.key === Qt.Key_Return || event.key === Qt.Key_Enter) {
                    if (dateTimePicker.hasSelection) {
                        let dt = new Date(dateTimePicker.selectedDate)
                        dt.setHours(dateTimePicker.selectedHour)
                        dt.setMinutes(dateTimePicker.selectedMinute)
                        dt.setSeconds(dateTimePicker.selectedSecond)
                        dateTimePicker.confirmed(dt)
                        dateTimePicker.close()
                    }
                    event.accepted = true
                } else if (event.key === Qt.Key_Escape) {
                    dateTimePicker.close()
                    event.accepted = true
                }
            }
        }
    }

    ColumnLayout {
        anchors.fill: parent
        spacing: 0

        // 顶部日期时间显示
        Rectangle {
            Layout.fillWidth: true
            Layout.preferredHeight: 50
            color: dateTimePicker.colorSurface
            radius: 8

            Rectangle {
                anchors.left: parent.left
                anchors.right: parent.right
                anchors.bottom: parent.bottom
                height: 8
                color: parent.color
            }

            Label {
                id: dateTimeLabel

                anchors.centerIn: parent
                color: dateTimePicker.colorPrimary
                font.pixelSize: 16
                font.bold: true
                text: Qt.formatDateTime(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), selectedHour, selectedMinute, selectedSecond), dateFormat + " " + timeFormat)
            }
        }

        // 主内容区域
        RowLayout {
            Layout.fillWidth: true
            Layout.fillHeight: true
            Layout.margins: 20
            spacing: 20

            // 左侧日历区域
            ColumnLayout {
                Layout.fillWidth: true
                Layout.fillHeight: true
                spacing: 12

                // 月份导航栏
                RowLayout {
                    Layout.fillWidth: true
                    spacing: 8

                    Button {
                        text: "&lt;&lt;"
                        Layout.preferredWidth: 40
                        Layout.preferredHeight: 32
                        onClicked: {
                            currentYear -= 1
                        }
                        background: Rectangle {
                            color: parent.hovered ? dateTimePicker.colorHoverDark : dateTimePicker.colorBorder
                            radius: 4
                        }
                        contentItem: Text {
                            text: parent.text
                            color: dateTimePicker.colorTextPrimary
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                        }
                    }
                    Button {
                        text: "&lt;"
                        Layout.preferredWidth: 40
                        Layout.preferredHeight: 32
                        onClicked: {
                            currentMonth -= 1
                            if (currentMonth &lt; 0) {
                                currentMonth = 11
                                currentYear -= 1
                            }
                        }
                        background: Rectangle {
                            color: parent.hovered ? dateTimePicker.colorHoverDark : dateTimePicker.colorBorder
                            radius: 4
                        }
                        contentItem: Text {
                            text: parent.text
                            color: dateTimePicker.colorTextPrimary
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                        }
                    }
                    Label {
                        text: Qt.formatDate(new Date(currentYear, currentMonth), "yyyy年 M月")
                        color: dateTimePicker.colorTextPrimary
                        font.pixelSize: 16
                        font.bold: true
                        Layout.fillWidth: true
                        horizontalAlignment: Text.AlignHCenter
                    }
                    Button {
                        text: "&gt;"
                        Layout.preferredWidth: 40
                        Layout.preferredHeight: 32
                        onClicked: {
                            currentMonth += 1
                            if (currentMonth &gt; 11) {
                                currentMonth = 0
                                currentYear += 1
                            }
                        }
                        background: Rectangle {
                            color: parent.hovered ? dateTimePicker.colorHoverDark : dateTimePicker.colorBorder
                            radius: 4
                        }
                        contentItem: Text {
                            text: parent.text
                            color: dateTimePicker.colorTextPrimary
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                        }
                    }
                    Button {
                        text: "&gt;&gt;"
                        Layout.preferredWidth: 40
                        Layout.preferredHeight: 32
                        onClicked: {
                            currentYear += 1
                        }
                        background: Rectangle {
                            color: parent.hovered ? dateTimePicker.colorHoverDark : dateTimePicker.colorBorder
                            radius: 4
                        }
                        contentItem: Text {
                            text: parent.text
                            color: dateTimePicker.colorTextPrimary
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                        }
                    }
                }

                // 星期标题行
                GridLayout {
                    Layout.fillWidth: true
                    columns: 7
                    rowSpacing: 0
                    columnSpacing: 0

                    Repeater {
                        model: ["周一", "周二", "周三", "周四", "周五", "周六", "周日"]
                        Label {
                            text: modelData
                            color: dateTimePicker.colorTextTertiary
                            font.pixelSize: 12
                            horizontalAlignment: Text.AlignHCenter
                            verticalAlignment: Text.AlignVCenter
                            Layout.fillWidth: true
                            Layout.preferredHeight: 30
                        }
                    }
                }

                // 日期网格
                GridLayout {
                    Layout.fillWidth: true
                    Layout.fillHeight: true
                    columns: 7
                    rowSpacing: 8
                    columnSpacing: 8

                    Repeater {
                        model: 42
                        Rectangle {
                            Layout.fillWidth: true
                            Layout.fillHeight: true
                            Layout.minimumHeight: 40
                            radius: 4

                            color: {
                                if (!isInRange) return dateTimePicker.colorSurfaceVariant

                                let date = getDateForCell(index)
                                if (date.getDate() === selectedDate.getDate() &amp;&amp; date.getMonth() === selectedDate.getMonth() &amp;&amp; date.getFullYear() === selectedDate.getFullYear()) {
                                    return dateTimePicker.colorPrimary
                                }
                                return dateMouseArea.containsMouse ? dateTimePicker.colorBorder : "transparent"
                            }

                            border.color: {
                                let date = cellDate
                                if (date.getDate() === selectedDate.getDate() &amp;&amp; date.getMonth() === selectedDate.getMonth() &amp;&amp; date.getFullYear() === selectedDate.getFullYear()) {
                                    return "white"
                                }
                                return "transparent"
                            }
                            border.width: 2

                            property var cellDate: getDateForCell(index)

                            property bool isInRange: {
                                let testDate = new Date(cellDate)
                                testDate.setHours(selectedHour, selectedMinute, selectedSecond)
                                return isDateTimeInRange(testDate)
                            }

                            Label {
                                anchors.centerIn: parent
                                text: parent.cellDate.getDate()
                                color: {
                                    if (!parent.isInRange) return dateTimePicker.colorTextDisabled
                                    return parent.cellDate.getMonth() === currentMonth ? dateTimePicker.colorTextPrimary : dateTimePicker.colorBorderLight
                                }
                                font.pixelSize: 14
                            }

                            MouseArea {
                                id: dateMouseArea
                                anchors.fill: parent
                                hoverEnabled: true
                                enabled: parent.isInRange
                                cursorShape: enabled ? Qt.PointingHandCursor : Qt.ForbiddenCursor
                                onClicked: {
                                    if (parent.isInRange) {
                                        let clickedDate = parent.cellDate
                                        selectedDate = clickedDate

                                        // 如果点击的日期不在当前月,自动切换到该月
                                        if (clickedDate.getMonth() !== currentMonth || clickedDate.getFullYear() !== currentYear) {
                                            currentMonth = clickedDate.getMonth()
                                            currentYear = clickedDate.getFullYear()
                                        }

                                        dateTimePicker.hasSelection = true
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // 分隔线
            Rectangle {
                Layout.preferredWidth: 1
                Layout.fillHeight: true
                color: dateTimePicker.colorBorder
            }

            // 右侧时间选择区域
            RowLayout {
                Layout.preferredWidth: 210
                Layout.fillHeight: true
                spacing: 8

                // 时间列组件
                Repeater {
                    model: [{label: "时", value: selectedHour, max: 24}, {
                        label: "分", value: selectedMinute, max: 60
                    }, {label: "秒", value: selectedSecond, max: 60}]

                    ColumnLayout {
                        Layout.fillWidth: true
                        Layout.fillHeight: true
                        spacing: 8

                        property string timeLabel: modelData.label

                        Label {
                            text: timeLabel
                            color: dateTimePicker.colorTextTertiary
                            font.pixelSize: 12
                            Layout.alignment: Qt.AlignHCenter
                        }

                        Rectangle {
                            Layout.fillWidth: true
                            Layout.fillHeight: true
                            color: dateTimePicker.colorSurface
                            radius: 4
                            border.color: dateTimePicker.colorBorder
                            border.width: 1

                            ScrollView {
                                anchors.fill: parent
                                anchors.margins: 2
                                clip: true
                                ScrollBar.horizontal.policy: ScrollBar.AlwaysOff

                                ScrollBar.vertical: ScrollBar {
                                    policy: ScrollBar.AsNeeded
                                    width: 8

                                    contentItem: Rectangle {
                                        implicitWidth: 8
                                        radius: 4
                                        color: parent.pressed ? dateTimePicker.colorScrollbarPressed : (parent.hovered ? dateTimePicker.colorScrollbarHover : dateTimePicker.colorScrollbar)
                                    }

                                    background: Rectangle {
                                        implicitWidth: 6
                                        color: "transparent"
                                    }
                                }

                                ListView {
                                    id: timeListView

                                    model: modelData.max
                                    highlightFollowsCurrentItem: false
                                    highlightMoveDuration: 0
                                    snapMode: ListView.SnapToItem

                                    readonly property string timeType: timeLabel

                                    readonly property int currentValue: {
                                        if (timeType === "时") return dateTimePicker.selectedHour
                                        if (timeType === "分") return dateTimePicker.selectedMinute
                                        return dateTimePicker.selectedSecond
                                    }

                                    function selectTime(value) {
                                        console.log("Selected " + timeListView.timeType + ": " + value + ", hasSelection: " + dateTimePicker.hasSelection)

                                        dateTimePicker.hasSelection = true

                                        if (timeType === "时") {
                                            dateTimePicker.selectedHour = value
                                        } else if (timeType === "分") {
                                            dateTimePicker.selectedMinute = value
                                        } else {
                                            dateTimePicker.selectedSecond = value
                                        }

                                        // 滚动到列表顶部
                                        positionViewAtIndex(value, ListView.Beginning)
                                    }

                                    delegate: Rectangle {
                                        width: timeListView.width
                                        height: 44
                                        radius: 4

                                        color: {
                                            if (index === timeListView.currentValue) return dateTimePicker.colorPrimary
                                            return timeItemMouseArea.containsMouse ? dateTimePicker.colorHover : "transparent"
                                        }

                                        Label {
                                            anchors.centerIn: parent
                                            text: index.toString().padStart(2, '0')
                                            color: index === timeListView.currentValue ? dateTimePicker.colorTextPrimary : dateTimePicker.colorTextSecondary
                                            font.pixelSize: 16
                                            font.bold: index === timeListView.currentValue
                                        }

                                        MouseArea {
                                            id: timeItemMouseArea
                                            anchors.fill: parent
                                            hoverEnabled: true
                                            cursorShape: Qt.PointingHandCursor
                                            onClicked: {
                                                timeListView.selectTime(index)
                                            }
                                        }
                                    }

                                    Component.onCompleted: {
                                        positionViewAtIndex(modelData.value, ListView.Beginning)
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // 底部按钮区域
        Rectangle {
            Layout.fillWidth: true
            Layout.preferredHeight: 60
            color: dateTimePicker.colorSurface

            Rectangle {
                anchors.left: parent.left
                anchors.right: parent.right
                anchors.top: parent.top
                height: 8
                color: parent.color
            }

            RowLayout {
                anchors.fill: parent
                anchors.margins: 15
                spacing: 10

                Button {
                    text: qsTr("今天")
                    Layout.preferredWidth: 80
                    Layout.preferredHeight: 36
                    onClicked: {
                        var now = new Date()
                        selectedDate = now
                        selectedHour = now.getHours()
                        selectedMinute = now.getMinutes()
                        selectedSecond = now.getSeconds()
                        currentYear = now.getFullYear()
                        currentMonth = now.getMonth()
                        hasSelection = true
                    }
                    background: Rectangle {
                        color: parent.hovered ? dateTimePicker.colorHoverDark : dateTimePicker.colorBorder
                        radius: 4
                        border.color: dateTimePicker.colorBorderLight
                        border.width: 1
                    }
                    contentItem: Text {
                        text: parent.text
                        color: dateTimePicker.colorTextSecondary
                        font.pixelSize: 14
                        horizontalAlignment: Text.AlignHCenter
                        verticalAlignment: Text.AlignVCenter
                    }
                }

                Item {
                    Layout.fillWidth: true
                }

                Button {
                    text: qsTr("取消")
                    Layout.preferredWidth: 80
                    Layout.preferredHeight: 36
                    onClicked: dateTimePicker.close()
                    background: Rectangle {
                        color: parent.hovered ? dateTimePicker.colorHoverDark : dateTimePicker.colorBorder
                        radius: 4
                        border.color: dateTimePicker.colorBorderLight
                        border.width: 1
                    }
                    contentItem: Text {
                        text: parent.text
                        color: dateTimePicker.colorTextSecondary
                        font.pixelSize: 14
                        horizontalAlignment: Text.AlignHCenter
                        verticalAlignment: Text.AlignVCenter
                    }
                }

                Button {
                    text: qsTr("确定")
                    Layout.preferredWidth: 80
                    Layout.preferredHeight: 36
                    enabled: dateTimePicker.hasSelection
                    onClicked: {
                        let dt = new Date(selectedDate)
                        dt.setHours(selectedHour)
                        dt.setMinutes(selectedMinute)
                        dt.setSeconds(selectedSecond)

                        if (isDateTimeInRange(dt)) {
                            dateTimePicker.dateTime = formatDateTime(dt)
                            confirmed(dt)
                            close()
                        }
                    }
                    background: Rectangle {
                        color: {
                            if (!parent.enabled) return dateTimePicker.colorDisabled
                            return parent.hovered ? dateTimePicker.colorPrimaryHover : dateTimePicker.colorPrimary
                        }
                        radius: 4
                    }
                    contentItem: Text {
                        text: parent.text
                        color: parent.enabled ? dateTimePicker.colorTextPrimary : dateTimePicker.colorTextTertiary
                        font.pixelSize: 14
                        font.bold: true
                        horizontalAlignment: Text.AlignHCenter
                        verticalAlignment: Text.AlignVCenter
                    }
                }
            }
        }
    }

    function getDateForCell(index) {
        let firstDay = new Date(currentYear, currentMonth, 1)
        let dayOfWeek = (firstDay.getDay() + 6) % 7
        let cellDate = new Date(currentYear, currentMonth, 1 - dayOfWeek + index)
        return cellDate
    }

    function isDateTimeInRange(date) {
        if (minDateTime) {
            let minDt = new Date(minDateTime)
            if (!isNaN(minDt.getTime()) &amp;&amp; date &lt; minDt) {
                return false
            }
        }
        if (maxDateTime) {
            let maxDt = new Date(maxDateTime)
            if (!isNaN(maxDt.getTime()) &amp;&amp; date &gt; maxDt) {
                return false
            }
        }
        return true
    }

    function formatDateTime(date) {
        return Qt.formatDateTime(date, dateFormat + " " + timeFormat)
    }

    onDateTimeChanged: {
        if (!hasSelection) {
            let dt = new Date(dateTime)
            if (!isNaN(dt.getTime())) {
                selectedDate = dt
                selectedHour = dt.getHours()
                selectedMinute = dt.getMinutes()
                selectedSecond = dt.getSeconds()
                currentYear = dt.getFullYear()
                currentMonth = dt.getMonth()
            }
        }
    }

    Component.onCompleted: {
        if (dateTime) {
            let dt = new Date(dateTime)
            if (!isNaN(dt.getTime())) {
                selectedDate = dt
                selectedHour = dt.getHours()
                selectedMinute = dt.getMinutes()
                selectedSecond = dt.getSeconds()
                currentYear = dt.getFullYear()
                currentMonth = dt.getMonth()

                hasSelection = true
            }
        }

        // 初始化焦点位置
        let firstDay = new Date(currentYear, currentMonth, 1)
        let dayOfWeek = (firstDay.getDay() + 6) % 7
        focusedDateIndex = dayOfWeek + selectedDate.getDate() - 1

        // 延迟设置焦点,确保 FocusScope 已完全初始化
        Qt.callLater(function () {
            keyboardHandler.forceActiveFocus()
        })
    }
}
</code></pre>
<h3 data-id="heading-2">使用代码</h3>
<pre><code class="hljs language-qmllang" lang="qmllang">DateTimePicker {
    id: dateTimePicker

    width: 250
    height: 40

    // 初始值为当前日期时间
    dateTime: Qt.formatDateTime(new Date(), "yyyy-MM-dd hh:mm:ss")

    // 日期格式
    dateFormat: "yyyy-MM-dd"
    // 时间格式
    timeFormat: "hh:mm:ss"

    // 最小可选日期时间
    minDateTime: "2023-01-01 00:00:00"
    // 最大可选日期时间
    maxDateTime: "2024-12-31 23:59:59"

    onConfirmed: function (datetime) {
        startDateField.text = Qt.formatDateTime(datetime, "yyyy-MM-dd HH:mm")
    }
}
</code></pre>
<p>显示效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2122ba4d3e8f4e61a878cb995c2fa832~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15Liq5ZKq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064191&amp;x-signature=WoFWVkVZGgFQvlGfqYZlGoXAsoE%3D" alt="后台用户登录界面" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 14 新功能全面解析：提升生产力与性能的革命性更新]]></title>    <link>https://juejin.cn/post/7573886599432732723</link>    <guid>https://juejin.cn/post/7573886599432732723</guid>    <pubDate>2025-11-18T08:51:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573886599432732723" data-draft-id="7573890735578071050" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 14 新功能全面解析：提升生产力与性能的革命性更新"/> <meta itemprop="keywords" content="C#"/> <meta itemprop="datePublished" content="2025-11-18T08:51:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="葡萄城技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3227821868332765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 14 新功能全面解析：提升生产力与性能的革命性更新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821868332765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    葡萄城技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:51:44.000Z" title="Tue Nov 18 2025 08:51:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">C# 14 新功能全面解析：提升生产力与性能的革命性更新</h2>
<h3 data-id="heading-1"><strong>引言</strong></h3>
<p>C# 语言作为.NET生态的核心，始终致力于提升开发者的生产力与应用程序性能。C# 14带来了多项突破性特性，包括<strong>扩展成员</strong>、<strong>字段关键词</strong>、<strong>空条件赋值</strong>等，这些改进显著减少了样板代码，增强了类型系统的灵活性。本文将深入解析这些新功能的设计原理、应用场景及实际价值，帮助开发者快速掌握C# 14的核心优势。</p>
<h4 data-id="heading-2"><strong>1. 扩展成员：类型系统的革命性扩展</strong></h4>
<h5 data-id="heading-3"><strong>1.1 扩展属性的实现</strong></h5>
<p>C# 14的扩展成员（Extension Members）允许开发者在不修改原始类型的前提下，为现有类型添加属性、运算符甚至静态成员。这一特性通过<code>extension</code>语法块实现，且完全兼容既有扩展方法。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EnumerableExtensions</span>
{
    extension&lt;tsource&gt;(IEnumerable&lt;tsource&gt; source)
    {
        <span class="hljs-comment">// 扩展属性：判断集合是否为空</span>
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsEmpty =&amp;gt; !source.Any();

        <span class="hljs-comment">// 扩展运算符：合并两个集合</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IEnumerable&lt;tsource&gt; <span class="hljs-keyword">operator</span> +(
            IEnumerable&lt;tsource&gt; left, 
            IEnumerable&lt;tsource&gt; right) =&amp;gt; left.Concat(right);
    }
}
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span>[] data = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">if</span> (data.IsEmpty) { <span class="hljs-comment">/* ... */</span> }          <span class="hljs-comment">// 调用扩展属性</span>
<span class="hljs-keyword">var</span> combined = data + [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>];            <span class="hljs-comment">// 调用扩展运算符</span>
</code></pre>
<h5 data-id="heading-4"><strong>1.2 兼容性与迁移策略</strong></h5>
<p>扩展块设计为<strong>二进制兼容</strong>，允许逐步迁移现有扩展方法，依赖程序集无需重新编译。例如，原先的扩展方法可逐个替换为扩展块内的成员，而不会破坏现有代码。</p>
<hr/>
<h4 data-id="heading-5"><strong>2. 字段关键词：简化属性逻辑的利器</strong></h4>
<h5 data-id="heading-6"><strong>2.1 自动属性与字段的桥梁</strong></h5>
<p>传统属性开发中，简单的自动属性（Auto-Property）一旦需要添加逻辑（如空值检查），就必须重写完整属性。C# 14引入<code>field</code>关键词，允许仅在需要逻辑的访问器中注入代码：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// C# 14之前</span>
<span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> _message = <span class="hljs-string">""</span>;
<span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Message
{
    <span class="hljs-keyword">get</span> =&amp;gt; _message;
    <span class="hljs-keyword">init</span> =&amp;gt; _message = <span class="hljs-keyword">value</span> ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-keyword">nameof</span>(<span class="hljs-keyword">value</span>));
}

<span class="hljs-comment">// C# 14之后</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Message
{
    <span class="hljs-keyword">get</span>; <span class="hljs-comment">// 自动实现</span>
    <span class="hljs-keyword">init</span> =&amp;gt; field = <span class="hljs-keyword">value</span> ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-keyword">nameof</span>(<span class="hljs-keyword">value</span>));
}
</code></pre>
<h5 data-id="heading-7"><strong>2.2 优势与应用场景</strong></h5>
<ul>
<li><strong>减少样板代码</strong>：避免手动声明私有字段和重复的getter逻辑。</li>
<li><strong>视觉简洁性</strong>：类定义更紧凑，适合需要大量简单校验的场景（如DTO验证）。</li>
</ul>
<hr/>
<h4 data-id="heading-8"><strong>3. 空条件赋值：安全且简洁的链式操作</strong></h4>
<h5 data-id="heading-9"><strong>3.1 语法改进</strong></h5>
<p>此前，空值保护赋值需要显式条件判断，而C# 14允许直接在赋值左侧使用<code>?.</code>操作符：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 旧写法</span>
<span class="hljs-keyword">if</span> (customer <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>) 
{
    customer.Order = CreateOrder();
}

<span class="hljs-comment">// 新写法</span>
customer?.Order = CreateOrder();  <span class="hljs-comment">// 仅当customer非空时执行赋值</span>
</code></pre>
<h5 data-id="heading-10"><strong>3.2 复合赋值支持</strong></h5>
<p>该特性同样适用于<code>+=</code>等复合操作：</p>
<pre><code class="hljs language-csharp" lang="csharp">customer?.Total += CalculateIncrement();  <span class="hljs-comment">// 避免中间变量和重复检查</span>
</code></pre>
<hr/>
<h4 data-id="heading-11"><strong>4. 部分事件与构造函数：增强代码组织能力</strong></h4>
<h5 data-id="heading-12"><strong>4.1 分部类型的扩展</strong></h5>
<p>C# 14允许将<strong>事件</strong>和<strong>构造函数</strong>的逻辑拆分到多个文件中，这对大型生成代码（如Source Generators）尤为重要：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 文件1：声明部分</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Widget</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">event</span> EventHandler Changed;
}

<span class="hljs-comment">// 文件2：实现部分</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Widget</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">event</span> EventHandler Changed
    {
        <span class="hljs-keyword">add</span> =&amp;gt; _changed += <span class="hljs-keyword">value</span>;
        <span class="hljs-keyword">remove</span> =&amp;gt; _changed -= <span class="hljs-keyword">value</span>;
    }
}
</code></pre>
<h5 data-id="heading-13"><strong>4.2 主构造函数的分布式实现</strong></h5>
<p>主构造函数（Primary Constructor）现在支持在分部类中添加初始化逻辑：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Widget</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> size</span>)</span> 
{
    <span class="hljs-comment">// 主构造函数声明</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Widget</span>
{
    <span class="hljs-comment">// 添加初始化逻辑</span>
    <span class="hljs-keyword">public</span> Widget { Initialize(); }
}
</code></pre>
<hr/>
<h4 data-id="heading-14"><strong>5. 性能优化特性</strong></h4>
<h5 data-id="heading-15"><strong>5.1 隐式Span转换</strong></h5>
<p><code>Span&lt;t&gt;</code>和<code>ReadOnlySpan&lt;t&gt;</code>是高性能无分配API的核心。C# 14允许数组和字符串切片直接隐式转换为Span，减少显式调用<code>AsSpan()</code>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 旧写法</span>
ReadOnlySpan&lt;<span class="hljs-built_in">char</span>&gt; key = line.AsSpan(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);

<span class="hljs-comment">// 新写法</span>
ProcessKey(line[.<span class="hljs-number">.5</span>]);  <span class="hljs-comment">// 隐式转换为Span</span>
</code></pre>
<h5 data-id="heading-16"><strong>5.2 用户自定义复合赋值</strong></h5>
<p>高性能数值类型（如向量计算）可通过定义<code>+=</code>运算符避免临时对象：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> Vector3D
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-keyword">operator</span> +=(Vector3D other) 
    { 
        X += other.X; 
        Y += other.Y;
    }
}
</code></pre>
<p>此特性可提升SIMD和数学库的性能，减少循环中的中间结果分配。</p>
<hr/>
<h3 data-id="heading-17"><strong>结论</strong></h3>
<p>C# 14通过<strong>扩展成员</strong>、<strong>字段关键词</strong>等特性显著提升了开发效率，同时借助<strong>隐式Span转换</strong>和<strong>复合赋值</strong>优化了运行时性能。这些改进共同推动C#成为更强大、更灵活的语言选择。开发者可通过以下步骤快速上手：</p>
<ol>
<li>在现有项目中逐步替换扩展方法为扩展块；</li>
<li>使用<code>field</code>简化属性逻辑；</li>
<li>在资源敏感场景中应用Span和自定义运算符。</li>
</ol>
<p>C# 14不仅是语法糖的集合，更是对开发范式的升级，值得所有.NET开发者深入探索。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥 99%由 Trae AI 开发的 React KeepAlive 组件，竟然如此优雅！✨]]></title>    <link>https://juejin.cn/post/7573694361475285019</link>    <guid>https://juejin.cn/post/7573694361475285019</guid>    <pubDate>2025-11-18T09:38:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573694361475285019" data-draft-id="7573694361474891803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥 99%由 Trae AI 开发的 React KeepAlive 组件，竟然如此优雅！✨"/> <meta itemprop="keywords" content="前端,Trae"/> <meta itemprop="datePublished" content="2025-11-18T09:38:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端开发呀"/> <meta itemprop="url" content="https://juejin.cn/user/3562073406322600"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥 99%由 Trae AI 开发的 React KeepAlive 组件，竟然如此优雅！✨
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073406322600/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端开发呀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:38:19.000Z" title="Tue Nov 18 2025 09:38:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">🔥 99%由 Trae AI 开发的 React KeepAlive 组件，竟然如此优雅！✨</h2>
<blockquote>
<p><strong>温馨提示：除本文第一行提示之外，本项目的代码 99%由 Trae AI 开发，如您在使用过程中遇到任何问题，欢迎提交 Issue 或 Pull Request。</strong></p>
<p><strong>—— 项目 README</strong></p>
</blockquote>
<p>Hey 各位前端小伙伴们～ ଘ(੭<em>ˊᵕˋ)੭</em> ੈ✩</p>
<p>今天要给大家介绍一个超级有趣的 React 组件——<code>react-activity-keep-alive</code>！这个项目可不简单呢，它有 99% 的代码都是由 Trae AI 生成的，是不是很厉害？~ (｡♡‿♡｡)</p>
<h3 data-id="heading-1">🎯 为啥要做这个组件？</h3>
<p>用过 Vue 的小伙伴们都知道，Vue 有个超好用的 <code>&lt;KeepAlive&gt;</code> 组件，可以在路由切换时缓存页面状态。但是 React 一直缺少这样的优雅解决方案，对不对？٩(˘◡˘)۶</p>
<p>直到 React 19.2 引入了 <code>Activity</code> API，这个局面才有所改变。而我们这个项目，就是基于这个新 API 打造的 React 版 KeepAlive！</p>
<h3 data-id="heading-2">🌟 项目亮点一览</h3>
<p>让我来给大家介绍这个项目的几大亮点吧～ (≧∇≦)/</p>
<h4 data-id="heading-3">1. 🚀 99% AI 开发，质量还这么高！</h4>
<p>没错，你没看错！这个项目的源代码几乎全部由 Trae AI 生成。从架构设计到代码实现，从类型定义到注释文档，都是 AI 的杰作！是不是很震撼？ Σ(っ °Д °;)っ</p>
<h4 data-id="heading-4">2. 📱 完整的 KeepAlive 语义支持</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">KeepAlive</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-activity-keep-alive"</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeepAlive</span>
  <span class="hljs-attr">activeKey</span>=<span class="hljs-string">{pathname}</span>
  <span class="hljs-attr">include</span>=<span class="hljs-string">{[/^\/demo/]}</span> // <span class="hljs-attr">只缓存</span> /<span class="hljs-attr">demo</span> <span class="hljs-attr">开头的路由</span>
  <span class="hljs-attr">exclude</span>=<span class="hljs-string">{[/^\/admin/]}</span> // <span class="hljs-attr">不缓存</span> /<span class="hljs-attr">admin</span> <span class="hljs-attr">开头的路由</span>
  <span class="hljs-attr">max</span>=<span class="hljs-string">{3}</span> // <span class="hljs-attr">最多缓存</span> <span class="hljs-attr">3</span> <span class="hljs-attr">个</span>，<span class="hljs-attr">LRU</span> <span class="hljs-attr">策略</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Outlet</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">KeepAlive</span>&gt;</span></span>;
</code></pre>
<p>是不是很眼熟？没错，它完美复刻了 Vue KeepAlive 的 API 设计！☆*:.｡. o(≧▽≦)o .｡.:*☆</p>
<h4 data-id="heading-5">3. 🎪 丰富的演示场景</h4>
<p>项目内置了一个超棒的 playground，包含各种演示：</p>
<p>🌐 <strong>在线演示</strong>：你可以直接访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fliujiayii.github.io%2Freact-keep-alive%2F" target="_blank" title="https://liujiayii.github.io/react-keep-alive/" ref="nofollow noopener noreferrer">liujiayii.github.io/react-keep-…</a> 体验所有功能！不需要本地搭建～ ✨</p>
<ul>
<li><strong>LRU 缓存演示</strong>：观察缓存淘汰策略</li>
<li><strong>生命周期演示</strong>：看看激活/失活钩子的效果</li>
<li><strong>嵌套缓存演示</strong>：多层 KeepAlive 的复杂场景</li>
<li><strong>状态保持演示</strong>：输入框数据、滚动位置都能完美保持</li>
</ul>
<h4 data-id="heading-6">4. 🎛️ 强大的控制能力</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useAliveController } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-activity-keep-alive"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">CacheController</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { drop, dropScope, refresh, refreshScope, clear } = <span class="hljs-title function_">useAliveController</span>();

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> drop("/demo/a")}&gt;删除缓存<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> clear()}&gt;清空所有<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> refresh("/demo/b")}&gt;刷新缓存<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {/* 等等... */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>想要主动控制缓存？没问题！随意删除、刷新、清空，统统支持～ ( ◕‿◕ )</p>
<h3 data-id="heading-7">🔧 技术实现揭秘</h3>
<p>现在来聊聊技术实现吧～ ✧(≖ ◡ ≖)</p>
<h4 data-id="heading-8">历史背景：致敬 react-activation</h4>
<p>在 React 19.2 之前，社区里有一个非常优秀的库叫 <code>react-activation</code>！它为 React 生态带来了 KeepAlive 的概念，让无数开发者受益～ (´∀`)</p>
<p><strong>react-activation 的贡献</strong>：</p>
<ul>
<li>✅ 开创了 React KeepAlive 的先河，满足了无数开发者的需求</li>
<li>✅ 提供了完整的生命周期管理和状态保持功能</li>
<li>✅ 虽然使用了快照技术，但在当时的技术条件下是个很好的解决方案</li>
<li>✅ API 设计清晰，学习成本可控</li>
</ul>
<p>由于它基于 React 18 的技术栈设计，自然无法适配 React 19.2 的新特性。但正是它的存在，让我们看到了 KeepAlive 的巨大价值！</p>
<p>当 React 19.2 带来了原生的 <code>Activity</code> API 时，我们有了更好的技术基础来重新实现这个功能～ ✨ 这就是站在巨人肩膀上的力量！٩(˘◡˘)۶</p>
<h4 data-id="heading-9">基于 React 19.2 Activity</h4>
<p>这个组件的核心在于 React 19.2 的 <code>Activity</code> API：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Activity</span> active={isActive}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> <span class="hljs-attr">isActive</span> ? <span class="hljs-attr">undefined</span> <span class="hljs-attr">:</span> "<span class="hljs-attr">none</span>" }}&gt;</span>
    {/* 组件内容 */}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Activity</span>&gt;;
</code></pre>
<p><code>Activity</code> 的巧妙之处在于：<strong>失活的组件不会 unmount，只会隐藏</strong>！这就为 KeepAlive 提供了技术基础～ (｡◕‿◕｡)</p>
<h4 data-id="heading-10">LRU 缓存策略实现</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// LRU 队列：最旧在前，最新在后</span>
<span class="hljs-keyword">const</span> orderRef = useRef&lt;<span class="hljs-built_in">string</span>[]&gt;([]);

<span class="hljs-comment">// 淘汰超出容量的缓存</span>
<span class="hljs-keyword">while</span> (cache.<span class="hljs-property">size</span> &gt; max) {
  <span class="hljs-keyword">const</span> victim = orderRef.<span class="hljs-property">current</span>[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">if</span> (!victim || victim === activeKey)
    <span class="hljs-keyword">break</span>;
  orderRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">shift</span>();
  cacheRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">delete</span>(victim);
}
</code></pre>
<p>LRU 算法确保最近最少使用的缓存会被优先淘汰，保持缓存的高效利用～ ଘ(੭ˊᵕˋ)੭* ੈ</p>
<h4 data-id="heading-11">作用域嵌套管理</h4>
<h4 data-id="heading-12">作用域嵌套管理</h4>
<p>项目内部实现了作用域管理机制来支持多层 <code>&lt;KeepAlive&gt;</code> 的嵌套：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 内部实现（用户无需关心）</span>
&lt;<span class="hljs-title class_">AliveScopeProvider</span> name={key}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AliveItemProvider</span> <span class="hljs-attr">active</span>=<span class="hljs-string">{isActive}</span>&gt;</span>
    {node}
  <span class="hljs-tag">&lt;/<span class="hljs-name">AliveItemProvider</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">AliveScopeProvider</span>&gt;;
</code></pre>
<p>这个机制让项目能够优雅地处理复杂的嵌套缓存场景，自动管理不同层级的作用域～ ヾ(≧∇≦*)ゝ</p>
<h3 data-id="heading-13">🎮 实际使用效果</h3>
<p>让我给大家展示一下实际的使用效果吧！</p>
<p>假设我们有这样一个计数器页面：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">DemoPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>
        计数器：
        {count}
      <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;
        点我增加
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>切换路由再回来，看看数据还在不在～ (◕‿◕)<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>当你点击按钮增加到 10，然后切换到其他页面，再回来的时候：</p>
<p>✨ <strong>数据完全保持！还是 10！没有重新渲染！</strong> ✨</p>
<p>这就是 KeepAlive 的魅力所在～ (≧∇≦)/</p>
<h3 data-id="heading-14">🏗️ 项目结构一览</h3>
<pre><code class="hljs language-bash" lang="bash">react-keep-alive/
├── src/                    <span class="hljs-comment"># 核心库代码</span>
│   ├── KeepAlive.tsx      <span class="hljs-comment"># 主组件（244 行精华代码）</span>
│   ├── hooks.ts           <span class="hljs-comment"># 生命周期钩子</span>
│   └── context.tsx        <span class="hljs-comment"># 作用域管理</span>
├── playground/            <span class="hljs-comment"># 演示应用</span>
│   ├── src/pages/         <span class="hljs-comment"># 各种演示页面</span>
│   └── src/App.tsx        <span class="hljs-comment"># 主应用</span>
└── README.md              <span class="hljs-comment"># 超详细的文档</span>
</code></pre>
<p>整个项目只有 4 个主要文件，却实现了完整的 KeepAlive 功能，是不是很精简？ Σ(っ °Д °;)っ</p>
<h3 data-id="heading-15">🛠️ 开发体验</h3>
<p>开发这个项目的感觉真的很棒～ (｡♡‿♡｡)</p>
<ul>
<li><strong>TypeScript 支持</strong>：完整的类型定义，IDE 友好</li>
<li><strong>ESLint 配置</strong>：代码质量有保障</li>
<li><strong>Husky + lint-staged</strong>：提交前自动检查</li>
<li><strong>Playground 演示</strong>：边开发边验证</li>
</ul>
<p>最关键的是，有了 Trae AI 的加持，开发效率真的太高了！几乎所有的代码逻辑、类型定义、注释文档，都是 AI 自动生成的！</p>
<h3 data-id="heading-16">🎊 总结</h3>
<p>这个 <code>react-activity-keep-alive</code> 项目真的很让人兴奋呢～ ✨</p>
<ol>
<li><strong>技术先进</strong>：基于 React 19.2 Activity，性能优秀</li>
<li><strong>API 友好</strong>：完全对齐 Vue KeepAlive，学习成本低</li>
<li><strong>功能完整</strong>：LRU 缓存、生命周期、控制接口一应俱全</li>
<li><strong>AI 加持</strong>：99% 代码由 AI 生成，开发效率惊人</li>
<li><strong>演示丰富</strong>：内置 playground，所见即所得</li>
</ol>
<p>如果你的项目正在使用 React 19.2+，真的推荐试试这个组件！让你的路由切换体验更上一层楼～ ( ◕‿◕ )</p>
<h3 data-id="heading-17">🔗 相关链接</h3>
<ul>
<li><strong>GitHub 地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliujiayii%2Freact-keep-alive" target="_blank" title="https://github.com/liujiayii/react-keep-alive" ref="nofollow noopener noreferrer">github.com/liujiayii/r…</a></li>
<li><strong>🌐 在线演示</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fliujiayii.github.io%2Freact-keep-alive%2F" target="_blank" title="https://liujiayii.github.io/react-keep-alive/" ref="nofollow noopener noreferrer">liujiayii.github.io/react-keep-…</a> - 直接浏览器体验！</li>
<li><strong>本地演示</strong>：启动 playground：<code>pnpm -C playground dev</code></li>
</ul>
<hr/>
<p><strong>小贴士</strong>：项目要求 React 19.2+ 版本哦，如果你的项目还在用旧版本，建议升级一下～ ଘ(੭<em>ˊᵕˋ)੭</em> ੈ✩</p>
<p>好啦，今天的介绍就到这里！希望这个由 Trae AI 开发的 KeepAlive 组件能给大家带来帮助～ 如果觉得有用的话，记得给项目点个 Star 哦！☆*:.｡. o(≧▽≦)o .｡.:*☆</p>
<p>(◕‿◕)ﾉbye bye~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Canvas学习笔记（一）]]></title>    <link>https://juejin.cn/post/7573738017988640811</link>    <guid>https://juejin.cn/post/7573738017988640811</guid>    <pubDate>2025-11-18T09:49:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573738017988640811" data-draft-id="7573855399716470803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Canvas学习笔记（一）"/> <meta itemprop="keywords" content="前端,JavaScript,Canvas"/> <meta itemprop="datePublished" content="2025-11-18T09:49:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不是鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1704656590610676"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Canvas学习笔记（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1704656590610676/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不是鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:49:33.000Z" title="Tue Nov 18 2025 09:49:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">什么是 Canvas</h3>
<p>Canvas 是 HTML5 中新增的一种标签，表示一个画布，只是图形容器，绘制功能必须使用js来实现。</p>
<pre><code class="hljs language-js" lang="js">&lt;!doctype html&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>基础的HTML5页面<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"canvas"</span>&gt;</span>
            这里是canvas标签，当你的浏览器不支持canvas时，会显示这行文字
	<span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span> 

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</span></code></pre>
<p>打开后会是一个完全空白的画面，因为canvas本意就是一块画布，画布在html5中是透明的，不可见的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/646cf23d6a26415c90537a193f6ecaac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=zzyq3cyC2ZfdAXRL51Jr6L%2FArbo%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">绘制前的准备</h3>
<h5 data-id="heading-2">获取 Canvas 对象：</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'canvas'</span>);
</code></pre>
<h5 data-id="heading-3">获取画笔</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> context = canvas.<span class="hljs-title function_">getContext</span>(contextType, contextAttributes?);
<span class="hljs-keyword">const</span> context = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
<span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>, {
  <span class="hljs-attr">alpha</span>: <span class="hljs-literal">true</span>,          <span class="hljs-comment">// 启用透明通道（默认就是true）</span>
});
</code></pre>
<p><code>getContext</code>方法用于获取 Canvas 元素的绘图上下文，来对 Canvas 元素进行绘制操作，通常是 2D 类型，用于二维绘图。第一个参数是必须传的，第二个参数代表配置上下文的行为，不同的上下文的配置属性不同。</p>
<ul>
<li><code>2d</code></li>
</ul>






























<table><thead><tr><th>属性</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>alpha</code></td><td>是否包含alpha通道（透明度）</td><td><code>true</code></td></tr><tr><td><code>colorSpace</code></td><td>指定渲染上下文的色彩空间（<code>srgb</code>或<code>display-p3</code>）</td><td><code>srgb</code></td></tr><tr><td><code>desynchronized</code></td><td>是否将画布绘制周期与事件循环解耦以减少延迟</td><td><code>false</code></td></tr><tr><td><code>willReadFrequently</code></td><td>是否频繁读取像素（用于优化<code>getImageData()</code>性能）</td><td><code>false</code></td></tr></tbody></table>
<ul>
<li><code>webgl</code></li>
</ul>


















































<table><thead><tr><th>属性</th><th>作用</th><th>说明</th></tr></thead><tbody><tr><td><code>alpha</code></td><td>是否包含alpha通道</td><td>和2D一样</td></tr><tr><td><code>antialias</code></td><td>是否开启抗锯齿</td><td>让图形边缘更平滑</td></tr><tr><td><code>depth</code></td><td>是否包含深度缓冲区</td><td>用于3D场景的深度检测</td></tr><tr><td><code>failIfMajorPerformanceCaveat</code></td><td>性能低时是否创建上下文</td><td><code>true</code>：性能差时失败</td></tr><tr><td><code>powerPreference</code></td><td>GPU电源偏好</td><td><code>default</code>/<code>high-performance</code>/<code>low-power</code></td></tr><tr><td><code>premultipliedAlpha</code></td><td>是否预混合alpha</td><td>用于图像合成</td></tr><tr><td><code>preserveDrawingBuffer</code></td><td>是否保存缓冲区</td><td><code>true</code>：可以多次读取</td></tr><tr><td><code>stencil</code></td><td>是否包含模版缓冲区</td><td>用于复杂遮罩效果</td></tr></tbody></table>
<p>小结一下：准备工作就分为三步：</p>
<ol>
<li><strong>布置画布：通过添加</strong><code> &lt;canvas&gt; </code><strong>标签，添加canvas元素</strong></li>
<li><strong>获取画布：通过</strong><code> &lt;canvas&gt; </code><strong>标签的id，获得canvas对象</strong></li>
<li><strong>获得画笔：通过canvas对象的</strong><code>getContext("2d") </code><strong>方法，获得2D环境</strong></li>
</ol>
<hr/>
<h3 data-id="heading-4"><strong>绘制线段：</strong></h3>
<p>在Canvas中，<strong>是基于状态的绘制</strong>，所以前面几步都是在确定状态，直到最后一步才会具体绘制。</p>
<p>绘画步骤和现实中画画差不多，可以分为四步：</p>
<h6 data-id="heading-5">1.  首先移动画笔至绘画的起始位置</h6>
<pre><code class="hljs language-js" lang="js">context.<span class="hljs-title function_">moveTo</span>(x, y)
<span class="hljs-comment">// 将笔画移至 x, y 这个位置，canvas中是以画布的左上角为坐标原点，x轴的正方向向右，y轴的正方向向下</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eddbf10a40c648e79bca69ee62fc8c79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=KQQcZApygxHa46214P6J2b6iVxE%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-6">2.  确定第一笔的停止点</h6>
<pre><code class="hljs language-js" lang="js">context.<span class="hljs-title function_">lineTo</span>(x, y)
<span class="hljs-comment">// 从上一个笔的停止点，移动至x，y这里</span>
</code></pre>
<h6 data-id="heading-7">3.  规划好路线后，选择画笔（粗细，颜色，线条等）</h6>
<p>因为 Canvas 是基于状态的，所以我们在选择画笔粗细和颜色的同时，其实也是选择了线条的粗细和颜色。</p>









































<table><thead><tr><th>属性</th><th>说明</th><th>默认值</th><th>示例</th></tr></thead><tbody><tr><td><code>context.lineWidth</code></td><td><strong>线条粗细（宽度）</strong> ，单位是像素</td><td><code>1.0</code></td><td><code>ctx.lineWidth = 5;</code></td></tr><tr><td><code>context.strokeStyle</code></td><td><strong>描边颜色/样式</strong>（可为颜色、渐变、图案）</td><td><code>#000000</code>（黑色）</td><td><code>ctx.strokeStyle = "#AA394C";``ctx.strokeStyle = "red";``ctx.strokeStyle = gradient;</code></td></tr><tr><td><code>context.lineCap</code></td><td><strong>线段末端样式</strong></td><td><code>"butt"</code></td><td><code>"butt"</code>（平头） <code>"round"</code>（圆头） <code>"square"</code>（方头）</td></tr><tr><td><code>context.lineJoin</code></td><td><strong>两条线相交处的连接样式</strong></td><td><code>"miter"</code></td><td><code>"miter"</code>（尖角） <code>"round"</code>（圆角） <code>"bevel"</code>（斜角）</td></tr><tr><td><code>context.miterLimit</code></td><td><strong>尖角（miter）的最大长度限制</strong>（防止过长尖角）</td><td><code>10</code></td><td><code>ctx.miterLimit = 5;</code></td></tr></tbody></table>
<h6 data-id="heading-8">4. 进行绘制</h6>
<p>确定绘制有两种方法：</p>
<pre><code class="hljs language-js" lang="js">context.<span class="hljs-title function_">fill</span>() <span class="hljs-comment">// 填充</span>
context.<span class="hljs-title function_">stroke</span>() <span class="hljs-comment">// 描边</span>
</code></pre>
<h6 data-id="heading-9">5. 画一个线条！</h6>
<pre><code class="hljs language-js" lang="js">&lt;body&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myCanvas"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"border: 1px solid black;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myCanvas'</span>);
        <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
        
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);

        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'red'</span>;

        ctx.<span class="hljs-title function_">stroke</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
&lt;/body&gt;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4110ef73c4114e18963318062516e274~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=SsyKWdVRHvhf3uKvPmm1xVknuCs%3D" alt="image.png" loading="lazy"/></p>
<p>一条红色的线条就画好了。但是我们现在只给 Canvas 设置了边框，那它的宽高是从哪来的呢？</p>
<p>这是浏览器默认给 Canvas 分配的尺寸 300x150 像素的画布。如果我们要自己设置 Canvas 宽高的话有两种方法</p>
<ol>
<li>通过标签内部设置</li>
</ol>
<pre><code class="hljs language-js" lang="js"> &lt;canvas id=<span class="hljs-string">"myCanvas"</span> style=<span class="hljs-string">"border: 1px solid black;"</span> width = <span class="hljs-string">"500"</span> height = <span class="hljs-string">"500"</span>&gt;&lt;/canvas&gt;
</code></pre>
<ol start="2">
<li>通过 JS 设置</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myCanvas'</span>);

canvas.<span class="hljs-property">width</span> = <span class="hljs-number">500</span>;
canvas.<span class="hljs-property">height</span> = <span class="hljs-number">500</span>;
</code></pre>
<p>这两种方式设置的宽高是等效的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d52a13df55f64a10a2d554ccc2758a14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=0l8dw4moyAx3C8OT5wiXS5r5%2FtE%3D" alt="image.png" loading="lazy"/>
<strong>这里有一个特别需要注意的点：我们设置的是画布的物理宽高，也就是 Canvas 元素的真实宽高，并不是通过 Css 设置的样式宽高，如果我们通过 Css 设置了 Canvas 的宽高，效果其实是在物理宽高的基础上进行了等比的缩小或者拉伸</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;canvas id=<span class="hljs-string">"myCanvas"</span> 
    style=<span class="hljs-string">"border: 1px solid black; width: 100px; height: 100px;"</span> width=<span class="hljs-string">"500"</span> height=<span class="hljs-string">"500"</span>&gt;
&lt;/canvas&gt;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/346e123667244b89b96c41c560b51a44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=OTkv5MMzOxJOhOSImkGHzDB0MXI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">线条组成图形</h3>
<h6 data-id="heading-11">绘制折线</h6>
<p>当我们学会绘制线条后，就可以用线条来组成图形了，方法其实很简单，就是复用上文用过的<code>lineTo()</code> 方法即可：</p>
<pre><code class="hljs language-js" lang="js">    ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>, <span class="hljs-number">100</span>);
    ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>);

    ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
    ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'red'</span>;

    ctx.<span class="hljs-title function_">stroke</span>();
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acfa8e95b0114d508c7c6a1f1a012e8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=NR5MR5V6tN24HE1jz6s2JlGVWxo%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-12">绘制多条折线</h6>
<p>如果需要绘制多条不连接的线条，只需在绘制完一次后，再重新移动画笔，重新绘制一次即可</p>
<pre><code class="hljs language-js" lang="js">        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>, <span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'red'</span>;
        ctx.<span class="hljs-title function_">stroke</span>();

        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">150</span>, <span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'blue'</span>;
        ctx.<span class="hljs-title function_">stroke</span>(); 
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c6c2b8f523e4707b5718d1f60ca827a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=bA3T3WYG186JmI5Hm7yMfhgCOco%3D" alt="image.png" loading="lazy"/>
诶？这是不是很奇怪，明明是先红色再蓝色，为什么就全变为蓝色了呢？<strong>是因为上文说过的 Canvas 是基于状态绘制的。我们每次使用<code>stroke()</code> 时，它都会把之前设置的状态再次绘制一遍，第一次<code>stroke</code>时会绘制一条红色折线，第二次<code>stroke</code>时，会再次重新绘制之前那条红色的折线，但是画笔已经变为蓝色的了，所以画出的折线全是蓝色的</strong>。</p>
<p>为了解决这个问题，我们需要在每次重新绘制时加上<code>beginPath()</code>，这个 API 代表下次绘制的起始处为<code>beginPath()</code>之后的代码。</p>
<pre><code class="hljs language-js" lang="js">        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>, <span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'red'</span>;
        ctx.<span class="hljs-title function_">stroke</span>();
        
        ctx.<span class="hljs-title function_">beginPath</span>(); <span class="hljs-comment">// 重新定义起始位置</span>
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">150</span>, <span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'blue'</span>;
        ctx.<span class="hljs-title function_">stroke</span>(); 
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2051424865964361add06983e8ced723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=qfI07s%2Bfueduzns526hUJ1ojnZ4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">绘制矩形</h3>
<p>我们先使用绘制线条的方式绘制一个矩形</p>
<pre><code class="hljs language-js" lang="js">        <span class="hljs-comment">// 绘制一个矩形</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">50</span>);

        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">5</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">"black"</span>;

        ctx.<span class="hljs-title function_">stroke</span>();   
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/411bf8c2bde24ccc82a179d3ae34b4a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=JK89zyVVV7gQSVQmvVxRxJO1AGE%3D" alt="image.png" loading="lazy"/>
会发现此时最后一笔画时有一个小缺口，这种情况是因为我们设置了<code>lineWidth</code>导致的，如果是默认笔触为1的话是不会有问题的，但是如果笔触越大，线条越宽，这个小缺口就会越明显。此时需要使用<code>closePath()</code>闭合图形。</p>
<pre><code class="hljs language-js" lang="js">        <span class="hljs-comment">// 绘制一个矩形</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">100</span>);
        <span class="hljs-comment">// ctx.lineTo(50,50); // 最后一笔可以不画</span>
        ctx.<span class="hljs-title function_">closePath</span>();
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbc42c23f5504718ab0fb038c009fabc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=ujspluWf9vSFLeIbu6xk2SsdBfs%3D" alt="image.png" loading="lazy"/></p>
<p>所以我们在绘制图形时需要使用<code>beginPath()</code>和 <code>closePath()</code>包裹起来。</p>
<h6 data-id="heading-14">给矩形上色</h6>
<p>上文中有提过绘制的两种方法分别是<code>stroke()</code>和<code>fill()</code>，我们需要使用<code>fill()</code>方法给矩形上色。和使用<code>stroke</code>前相同，我们需要先给它设置好属性。</p>
<pre><code class="hljs language-js" lang="js">        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">closePath</span>();

        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">5</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">"black"</span>;

        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">"red"</span>;

        ctx.<span class="hljs-title function_">fill</span>();
        ctx.<span class="hljs-title function_">stroke</span>();   
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34d863746af641cf951ba66a6be6130f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=kLDHbM6wuZR2DRNNs9eTMRDR%2F5I%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-15">使用<code>rect()</code>方法绘制矩形</h6>
<p>由于矩形是常用的图形，所以 Canvas API 封装好了一个定义矩形位置信息的方法，这个方法接受四个参数，分别表示矩形的起点坐标和宽高。</p>
<pre><code class="hljs language-js" lang="js">        ctx.<span class="hljs-title function_">rect</span>(x,y,width,height);

        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">rect</span>(<span class="hljs-number">50</span>,<span class="hljs-number">50</span>,<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);
        
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">5</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">"black"</span>;
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">"red"</span>;

        ctx.<span class="hljs-title function_">fill</span>();
        ctx.<span class="hljs-title function_">stroke</span>();
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46338e599a61409da3d39828c7175cb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064172&amp;x-signature=rLsP6iePRQqqRkhjDjOr%2FcTtrZU%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>今天 Canvas 的学习就到这啦</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI视频进入“加速度”时代：30%加速＋细节随手P，等等党和抽卡党都有救了！]]></title>    <link>https://juejin.cn/post/7573864324713054260</link>    <guid>https://juejin.cn/post/7573864324713054260</guid>    <pubDate>2025-11-18T09:13:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573864324713054260" data-draft-id="7573679820632670243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI视频进入“加速度”时代：30%加速＋细节随手P，等等党和抽卡党都有救了！"/> <meta itemprop="keywords" content="AIGC,AI编程"/> <meta itemprop="datePublished" content="2025-11-18T09:13:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI视频进入“加速度”时代：30%加速＋细节随手P，等等党和抽卡党都有救了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:13:05.000Z" title="Tue Nov 18 2025 09:13:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>等等党和抽卡党们，这回做视频终于不用等！半！天！了！</p>
<p>相信大家都有这种感觉：每次用 AI 生成视频，刚按下按钮，屏幕就跳出来一句 “前方排队 xxx 人”，等吧，好不容易排到了，结果还得再磨个两三分钟才能出片……</p>
<p>而且生成效果到底咋样，几乎纯看运气，不满意还得重新抽卡，这次终于不一样了，等等党有救，抽卡党翻身～</p>
<p>现在，从点击生成到看到成片，不到一分钟就能轻松产出一条 5 秒的高清视频大片，画质妥妥拉满，效果 be like：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36e4f0c5ddce482aacbdb67f120974a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=8Gagp56jI%2FWB8IcctaAdC4tY%2FSI%3D" alt="" loading="lazy"/></p>
<p>你以为这就结束了？大 NO 特 NO！现在碰到不满意的视频也不用重新抽卡，直接在线精修，想怎么 P 就怎么 P。</p>
<p>周末来得刚刚好，蒙娜丽莎牵着兵马俑走进了魔都街头，这回不当文艺女神，当起了 “沪上阿姨”：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c56f0070b564cee91e02ef9fda1fe3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=OmU%2FnaAs22qUU31u6veO9otmUYQ%3D" alt="" loading="lazy"/></p>
<p>emm… 人都到上海了，手里却还举着杯可乐，怎么看都不太对劲，于是我顺手一改，把可乐 P 成了奶茶，这样才对嘛，入乡随俗入乡随俗～</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dd37fd6660148db9cae3ae448dbe0d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=EnV7FObt5q5sN5BLx43qfl%2Fl6OE%3D" alt="" loading="lazy"/></p>
<p>不卖关子，这就是「拍我 AI」（即 PixVerse）重磅上线的升级版：V5 Fast，视频生成速度提升超 <strong>30%</strong>，此外还上线了**「Modify」精修功能**，支持端到端视频编辑，生成完还能接着改～</p>
<p>两项关键能力一起落地，让视频创作第一次有了 “快＋可控” 的完整体验，目前新功能已在「拍我 AI」重磅上线，废话不多说，跟我一起 roll 起来吧！</p>
<h2 data-id="heading-0">AI 视频也实现 P 图自由了</h2>
<p>过去这一年，AI 视频从创作者工具变成了商业化生产力。</p>
<p>品牌在用它做 campaign，自媒体在手搓各种 AIGC 新玩法，商家用它做新品素材，而更能感受到变化的，是大众化的使用场景——</p>
<p>旅行时随手做个 vlog、给猫猫剪段日常、记录小朋友的成长瞬间…… 越来越多人不再只是看别人用 AI 做视频，而是开始用 AI 记录自己的生活、讲自己的故事、创作属于自己的灵感。</p>
<p>然而，现在市面上绝大多数的 AI 视频工具更像是一次生成定生死，一旦要改，流程立刻变得又慢又不确定：</p>
<p>一个细节的错位、一个画面的跳帧都可能让全片重来，角色不稳要返工，元素乱跳要重生，提示词不准又得重新 roll，专业团队焦虑，普通用户更无从下手，明明是小改动，时间精力的投入成本却很大。</p>
<p>这直接带来的影响是：对内容团队是流程割裂，对商用制作是交付风险，对普通用户更是一道专业门槛的困扰。</p>
<p>因此，可修改性目前已经成为现在 AI 视频市场最真实、也最迫切的需求之一。</p>
<p>拍我 AI 的 <strong>Modify</strong> 精修能力，就是顺着这条需求线自然进化出来的，它所代表的是一类真正意义上的「市场创新」。</p>
<p>它把单帧修改变成了模型对全片的重新理解和一致化处理，实现跨帧推理、统一风格、主体稳态等一系列高要求的流程。</p>
<p>这类底层架构的精修方式目前在业内极为稀缺，基本属于拍我 AI 的<strong>独特能力</strong>。</p>
<p>也就是让创作者的工作流真正闭环，也让普通用户第一次拥有了<strong>拍了视频还能随手改</strong>的自由度。</p>
<p>AI 视频从 “能生成” 走向 “能被每个人掌控” 这一步，终于变得可行了。</p>
<h4 data-id="heading-1">元素替换：实物级别的可控编辑</h4>
<p>在这次全新推出的「Modify」精修功能中，我们不必再因为某个元素生成得不对、哪一帧出了小差错就从头反复生成，也不用担心提示词没写准、没编辑到位会导致整段视频推倒重来。</p>
<p>现在我们可以想改哪里就改哪里，真的做到了<strong>万物皆可替换</strong>。</p>
<p>先从我们创作中出现频率最高、需求最迫切的<strong>物品替换</strong>能力说起，我先让 V5 Fast 帮我生成了一段 “男子在 KTV 放飞自我唱歌” 的视频：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a40895ba5e1406489ad9bdfe17d58bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=aUpiZ8BYa816jsB01NbxPEFN5F4%3D" alt="" loading="lazy"/></p>
<p>接着我在 Modify 里把男子换成了一只沉浸式飙歌的小猫：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/467861bb0a204018ae078c764552fa7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=KG0Yfsf7sSzoBuqvsj9oUEVrz1E%3D" alt="" loading="lazy"/></p>
<p>AI 不仅保留了原视频里人物的肢体姿势、口型节奏，连服装细节也一起 copy 过去了，最关键的是整个场景环境都没崩，替换得非常自然。</p>
<p>除了能替换物品、人物外，Modify 还能<strong>替换背景</strong>，我把一个超飒女孩登山的视频丢给了 AI：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb927405431d41269dfd0cc1240d5aa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=X7IViWAan9op0LQMG4pLDI78hO0%3D" alt="" loading="lazy"/></p>
<p>嗯… 感觉这身专业户外装备用来登一座普通小山多少有点 “杀鸡用牛刀”！于是我让 Modify 把背景换成积雪覆盖的雪山，这下才对味儿嘛：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddb71e6bb4924928bde989074baa6b64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=cHaj9aVtoYFlfkiux7ayi3mwxw0%3D" alt="" loading="lazy"/></p>
<p>这个替换的难点在于原视频的背景是移动的，但 AI 不仅完成了背景替换，还自动补足了每一帧的场景一致性，甚至连女孩发丝透出的光线，都和雪山环境的冷色调对上了，可以说是非常周到了～</p>
<p>这种级别的元素替换能力，实质上把「改视频」这件事从高门槛的专业技能，重新交回给了所有用户。</p>
<p>无论是换物件、调环境，还是修一个不满意的细节，都终于能简单到<strong>人人敢下手、人人能做好</strong>。</p>
<h4 data-id="heading-2">局部修改：从风格到质感都能调</h4>
<p>除了能修改那些 “看得见摸得着” 的视频元素外，一些更抽象、更细微的局部变化，比如光影、质感、整体氛围这种非实体的细节，Modify 也完全 hold 得住。</p>
<p>这类需求在行业里一直是痛点：元素替换容易量化，但<strong>无形的局部</strong>往往最难改，一不小心就会破坏整段视频的连贯性。</p>
<p>咱们不走简单路线，直接上点难度，先来考验一下 AI 的<strong>风格修改</strong>能力。</p>
<p>现在打工人的怨气是真越来越重了，看下面这位小哥，工作崩溃到想直接怒砸键盘（但还是忍住了）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f981dfabd0b43039252c5ced7a78698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=BgYgVpsuNaJIl1Py%2FfOlSdtC8BQ%3D" alt="" loading="lazy"/></p>
<p>我们就用 Modify 给他换个画风，试试把这场 “社畜崩溃现场” 重绘成「美式漫画」风格：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4a9066cd85245778efd51a6a2cd4752~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=dBsTYYye4FjJbgYS6NN05tIhwBs%3D" alt="" loading="lazy"/></p>
<p>不光是整体风格切得干净，连衣服的褶皱、肢体动作、情绪张力都被 1:1 保留下来，风格想怎么改就怎么改，还能保持动作一致性，这才叫真正的 “可控风格替换”～</p>
<p>不仅如此，Modify 还能对物品的「<strong>材质</strong>」进行精确修改，我先是用 V5 Fast 生成了一段黑色亮面跑车驰骋在公路上的视频：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddc961159f4f4067a57d1dd80d57d24e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=GkinEkCGN7h7f809%2BpO1a7wPwMc%3D" alt="" loading="lazy"/></p>
<p>随后让 Modify 把车身材质替换成红色哑光，在镜头运动不变、光影一致的前提下，AI 依然稳稳完成了替换：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2399481002414d61bce5bd81cd535e69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=xR0tlAIyOEAxmqhMB6zI4ESZoYU%3D" alt="" loading="lazy"/></p>
<p>亮面换哑光、金属换塑料、皮革换织物，看似只是质感变化，但牵涉光影反射、表面细节、镜头轨迹，一旦处理不到位就会立刻穿帮。</p>
<p>而 Modify 既做到了替换材质，又保证每帧视觉逻辑都成立。</p>
<p>除了能修改风格和材质，Modify 还能同步修改「<strong>光线</strong>」、「<strong>色调</strong>」等非实体细节，那些在传统视频制作里最费力、最考验眼力的部分，也终于能交给 AI 来稳稳搞定。</p>
<h4 data-id="heading-3">人物编辑：跟修图烦恼说 bye bye</h4>
<p>经常拍照的人应该都有这种痛苦体验——给视频「<strong>人物修图</strong>」真的太、太、太麻烦了！</p>
<p>毕竟图片想怎么修就怎么修，可视频一旦要改就麻烦得多，过去那些在修图软件里拖一拖、点两下就能解决的小调整，放到视频里往往得重做整条。</p>
<p>这次 Modify 也把这个现实痛点考虑进去了：</p>
<p>视频人物不仅能用一句提示词直接改，还能自由调整年龄、服装、气质，甚至做到 “整个状态” 一起同步变化。</p>
<p>这是我喂给 Modify 的一张游客照，一个和长颈鹿合影的小男孩，因为拍摄角度的原因，男孩的眼睛显得有点小，皮肤也有些小瑕疵：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ba29df1842f48c5857abc7d62d99622~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=MMTmRLhdbwSQfrJcKV9ndbj%2BjBs%3D" alt="" loading="lazy"/></p>
<p>于是乎，我给 AI 下的指令是，让男孩眼睛更大一点、皮肤更平滑一点，Modify 立刻就给出了效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c41c55113754497cb9bcb0c19f3a2302~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=WivAVx21hvpoep7uQ056n1cutt4%3D" alt="" loading="lazy"/></p>
<p>眼睛肉眼可见地放大，皮肤也有了明显的磨皮效果，不得不说，这波 P 图功底确实有点东西～</p>
<p>再来玩点有意思的，来试试 AI 邪修术之——<strong>年龄修改</strong>！我先喂给 AI 一段老奶奶的视频：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/179148cbc6ac4b77860defcd8d75583d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=NyLQJ0qRGXEMTTZgiXe3K7zfrGs%3D" alt="" loading="lazy"/></p>
<p>然后只对 Modify 说了三个字——变！年！轻！结果老奶奶直接年轻了三十岁：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a63380038dc9461eb47de73fb87db17f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=pW6e13nWqhlk5fBG%2FX0TPINCbu0%3D" alt="" loading="lazy"/></p>
<p>人物能被自由修改，并不只是创意玩法。</p>
<p>在这个过程中，行业得到了更可控的创作能力，但对普通人而言，更大的价值在于：<strong>影像不再只能记录当下，它还能记录 “可能的样子”</strong>。</p>
<p>爷爷奶奶可以看看年轻时的模样，普通人也可以看到自己理想中的自己，AI 视频让影像变得更温柔、更有想象力。</p>
<p>此外，Modify 还具备「<strong>尺寸修改</strong>」能力，哪怕第一次生成的比例不太对，也能用一句提示词随心调整，彻底摆脱 “尺寸错了只能重生” 的麻烦事儿。</p>
<p>随着 Modify 把「可编辑性」补齐，AI 视频终于从一次性生成的模型能力，走向可反复打磨的创作工具。</p>
<p>这不仅让专业内容生产更可控，也让普通人拥有了<strong>真正掌控动态影像的权利</strong>，未来的视频创作，不再由模型决定，而是由使用它的每一个人决定。</p>
<h2 data-id="heading-4">生成提速 30%，大片稳出不误事</h2>
<p>生成速度一直是 AI 视频创作里绕不过去的问题。</p>
<p>无论是内容团队、短视频创作者，还是需要频繁验证想法的品牌方，都面临同一个困扰：</p>
<p>目前绝大多数 AI 视频的生成速度，赶不上用户内容交付的节奏，也赶不上用户灵感增长的速度。</p>
<p>团队需要高频实时产出，短视频创作者需要快速 AB 测试，品牌方则需要在短周期内验证创意想法，只要生成一慢，所有链路就一起被卡住。</p>
<p>这次爱诗科技上线的拍我 AI（PixVerse）V5 Fast，就是在这个现实痛点上做了明显优化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c571786de4094611baa9dcd473e57536~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764061985&amp;x-signature=DfMlm3TvEtiRfKXxjh4JgTx5sfE%3D" alt="" loading="lazy"/></p>
<p>相比上一代 V5 模型，V5 Fast 生成速度提升了 30%+，举个直观的例子就是，原本 5 秒的高清视频要等 1～2 分钟，现在只需要在 1 分钟以内就能看到成片。</p>
<p>原因很简单，以前的 Sora、视频版 Stable Diffusion 都是直接用一个超级大的模型一次性预测几十上百帧，模型看得太多太远，算得特别慢。</p>
<p>而 V5 Fast 让模型推理结构变得轻量化、帧间计算依赖被缩短，高分辨率的视频生成不再是 “倍速变慢” 的瓶颈环节。</p>
<p>看似还是那条推理链，但加速点遍布每一个视频节点，速度自然就提升得非常明显。</p>
<p>最关键的是，速度提上来了，效果也没掉链子，动作细节和风格依旧在线，对内容创作者来说，这种 “赶得上点” 的生成速度，才是真正能用起来的节奏。</p>
<p>为了更直观地对比，我们测试了拍我 AI（PixVerse）V5 Fast 与市面主流产品在相同提示词 &amp; 参数条件下的表现，没见过比这更快的：</p>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">视频详情</a></p>
<p>拍我 AI(PixVerse) V5 Fast 约 40 秒即可生成完成 1080P 的 5 秒视频，等待过程更短、生成体验更连贯。符合社交平台传播的 360P 和 720P 生成速度更快，数秒也就完成了。</p>
<p>从 Modify 精修功能到 V5 Fast 提速模型，背后是「爱诗科技」在 AI 视频生成领域持续的技术投入与产品打磨。</p>
<p>今年 10 月，爱诗科技完成了 1 亿元人民币的 B+ 轮融资，仅用两年时间就完成了五次模型迭代、八个版本更新，率先在行业内实现了 DiT 架构、准实时生成、角色驱动视频等关键突破。</p>
<p>更值得注意的，爱诗还是最早在 V3.5 破 10 秒大关的（去年 12 月）。进入 2025 年 1 月，V4 进入 5 秒准实时生成时代的平台，在全球已具规模的视频生成平台中生成速度最快。</p>
<p>作为其旗下核心产品，海外版 PixVerse 与国内版「拍我 AI」累计服务超过一亿用户，月活突破 1600 万，自去年启动商业化以来，收入增长超 10 倍，成为全球增长最快的 AI 视频平台之一。</p>
<p>这次发布的 V5 Fast 模式与 Modify 精修功能，进一步降低了 AI 视频的创作门槛，提升了创作自由度，视频生成不再因「慢」和「一次定生死」而被卡住。</p>
<p>生成能跟上节奏，修改能随手完成，AI 视频创作的工作流才真正完整起来。灵感不再被速度拖住，视频也不再是一锤子买卖，而是成为人人都能打磨、能调整、能反复利用的创意载体。</p>
<p>更重要的是，那些平时不太被注意、却跟日常生活贴得很紧的小需求，也能被看到、被重视、被满足，AI 也不再高高在上，而是开始贴着我们的日常需求去跑，贴着每一个细微的小动作去做。</p>
<p>这次「拍我 AI」新功能上线的意义，也正是在这里：</p>
<p>每一个人都可以无差别享受先进 AI 技术的乐趣。</p>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android U 自由窗口(浮窗)——启动流程（system_server侧流程）]]></title>    <link>https://juejin.cn/post/7573708620870844468</link>    <guid>https://juejin.cn/post/7573708620870844468</guid>    <pubDate>2025-11-18T09:51:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573708620870844468" data-draft-id="7573708620870811700" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android U 自由窗口(浮窗)——启动流程（system_server侧流程）"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-18T09:51:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yi诺千金"/> <meta itemprop="url" content="https://juejin.cn/user/4464480371870584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android U 自由窗口(浮窗)——启动流程（system_server侧流程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4464480371870584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yi诺千金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:51:42.000Z" title="Tue Nov 18 2025 09:51:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>接 <a href="https://juejin.cn/editor/drafts/7566064705879867419" target="_blank" title="https://juejin.cn/editor/drafts/7566064705879867419">juejin.cn/editor/draf…</a></p>
<h2 data-id="heading-0">system_server侧流程</h2>
<p>代码路径：frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivityFromRecents</span><span class="hljs-params">(<span class="hljs-type">int</span> taskId, Bundle bOptions)</span> {
        mAmInternal.enforceCallingPermission(START_TASKS_FROM_RECENTS,
                <span class="hljs-string">"startActivityFromRecents()"</span>);
        <span class="hljs-comment">//获取</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">callingPid</span> <span class="hljs-operator">=</span> Binder.getCallingPid();
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">callingUid</span> <span class="hljs-operator">=</span> Binder.getCallingUid();
        <span class="hljs-comment">//封装options</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">SafeActivityOptions</span> <span class="hljs-variable">safeOptions</span> <span class="hljs-operator">=</span> SafeActivityOptions.fromBundle(bOptions);
        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">origId</span> <span class="hljs-operator">=</span> Binder.clearCallingIdentity();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> mTaskSupervisor.startActivityFromRecents(callingPid, callingUid, taskId,
                    safeOptions);
        } <span class="hljs-keyword">finally</span> {
            Binder.restoreCallingIdentity(origId);
        }
    }
</code></pre>
<p>这里<code>callingPid</code>和<code>callingUid</code>为桌面<strong>pid</strong>和<strong>uid</strong>，后续传递参数继续调用到ActivityTaskSupervisor.startActivityFromRecents。</p>
<p>代码路径：frameworks/base/services/core/java/com/android/server/wm/ActivityTaskSupervisor.java</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * Start the given task from the recent tasks. Do not hold WM global lock when calling this
     * method to avoid potential deadlock or permission deny by UriGrantsManager when resolving
     * activity (see {<span class="hljs-doctag">@link</span> ActivityStarter.Request#resolveActivity} and
     * {<span class="hljs-doctag">@link</span> com.android.server.am.ContentProviderHelper#checkContentProviderUriPermission}).
     *
     * <span class="hljs-doctag">@return</span> The result code of starter.
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">startActivityFromRecents</span><span class="hljs-params">(<span class="hljs-type">int</span> callingPid, <span class="hljs-type">int</span> callingUid, <span class="hljs-type">int</span> taskId,
            SafeActivityOptions options)</span> {
        <span class="hljs-keyword">final</span> Task task;
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> taskCallingUid;
        <span class="hljs-keyword">final</span> String callingPackage;
        <span class="hljs-keyword">final</span> String callingFeatureId;
        <span class="hljs-keyword">final</span> Intent intent;
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> userId;
        <span class="hljs-comment">//获取传递过来的options</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">ActivityOptions</span> <span class="hljs-variable">activityOptions</span> <span class="hljs-operator">=</span> options != <span class="hljs-literal">null</span>
                ? options.getOptions(<span class="hljs-built_in">this</span>)
                : <span class="hljs-literal">null</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">moveHomeTaskForward</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">synchronized</span> (mService.mGlobalLock) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isCallerRecents</span> <span class="hljs-operator">=</span> mRecentTasks.isCallerRecents(callingUid);
            <span class="hljs-type">int</span> <span class="hljs-variable">activityType</span> <span class="hljs-operator">=</span> ACTIVITY_TYPE_UNDEFINED;
            <span class="hljs-keyword">if</span> (activityOptions != <span class="hljs-literal">null</span>) {
                activityType = activityOptions.getLaunchActivityType();
                <span class="hljs-comment">//这里主要就是判断是否要 冻结当前最近的任务列表顺序，直到用户与当前应用程序进行交互或发生超时。</span>
                <span class="hljs-keyword">if</span> (activityOptions.freezeRecentTasksReordering() &amp;&amp; (isCallerRecents
                        || ActivityTaskManagerService.checkPermission(MANAGE_ACTIVITY_TASKS,
                                callingPid, callingUid) == PERMISSION_GRANTED)) {
                    mRecentTasks.setFreezeTaskListReordering();
                }
                <span class="hljs-comment">//传递过来options中没有设置过mLaunchRootTask，因此getLaunchRootTask()的值为空</span>
                <span class="hljs-keyword">if</span> (activityOptions.getLaunchRootTask() != <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// Don't move home activity forward if there is a launch root set.</span>
                    moveHomeTaskForward = <span class="hljs-literal">false</span>;
                }
            }
            <span class="hljs-comment">//判断当前activity类型的合法性</span>
            <span class="hljs-keyword">if</span> (activityType == ACTIVITY_TYPE_HOME || activityType == ACTIVITY_TYPE_RECENTS) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"startActivityFromRecents: Task "</span>
                        + taskId + <span class="hljs-string">" can't be launch in the home/recents root task."</span>);
            }

            <span class="hljs-type">boolean</span> <span class="hljs-variable">shouldStartActivity</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-comment">//延迟窗口布局</span>
            mService.deferWindowLayout();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">//根据taskId获取Task对象</span>
                task = mRootWindowContainer.anyTaskForId(taskId,
                        MATCH_ATTACHED_TASK_OR_RECENT_TASKS_AND_RESTORE, activityOptions, ON_TOP);
                <span class="hljs-comment">//task为空时，做窗口绘制处理并抛出异常</span>
                <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) {
                    mWindowManager.executeAppTransition();
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(
                            <span class="hljs-string">"startActivityFromRecents: Task "</span> + taskId + <span class="hljs-string">" not found."</span>);
                }

                <span class="hljs-keyword">if</span> (moveHomeTaskForward) {
                    <span class="hljs-comment">// We always want to return to the home activity instead of the recents</span>
                    <span class="hljs-comment">// activity from whatever is started from the recents activity, so move</span>
                    <span class="hljs-comment">// the home root task forward.</span>
                    <span class="hljs-comment">// TODO (b/115289124): Multi-display supports for recents.</span>
                    <span class="hljs-comment">//moveHomeRootTaskToFront会获取桌面rootTask，然后将其移至最前台</span>
                    mRootWindowContainer.getDefaultTaskDisplayArea().moveHomeRootTaskToFront(
                            <span class="hljs-string">"startActivityFromRecents"</span>);
                }

                <span class="hljs-comment">// If the user must confirm credentials (e.g. when first launching a work</span>
                <span class="hljs-comment">// app and the Work Challenge is present) let startActivityInPackage handle</span>
                <span class="hljs-comment">// the intercepting.</span>
                
                <span class="hljs-comment">//android 13之前的的版本可能会进入该流程，</span>
                <span class="hljs-comment">//本地使用的android 14，task.getRootActivity()为null，因此不进入此流程</span>
                <span class="hljs-keyword">if</span> (!mService.mAmInternal.shouldConfirmCredentials(task.mUserId)
                        &amp;&amp; task.getRootActivity() != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">final</span> <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">targetActivity</span> <span class="hljs-operator">=</span> task.getTopNonFinishingActivity();
                    ......
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">//这里是把自由窗口的Task移到最顶部前端</span>
                        mService.moveTaskToFrontLocked(<span class="hljs-literal">null</span> <span class="hljs-comment">/* appThread */</span>,
                                <span class="hljs-literal">null</span> <span class="hljs-comment">/* callingPackage */</span>, task.mTaskId, <span class="hljs-number">0</span>, options);
                        ......
                    } <span class="hljs-keyword">finally</span> {
                        mActivityMetricsLogger.notifyActivityLaunched(launchingState,
                                START_TASK_TO_FRONT, <span class="hljs-literal">false</span> <span class="hljs-comment">/* newActivityCreated */</span>,
                                targetActivity, activityOptions);
                    }

                    mService.getActivityStartController().postStartActivityProcessingForLastStarter(
                            task.getTopNonFinishingActivity(), ActivityManager.START_TASK_TO_FRONT,
                            task.getRootTask());

                    <span class="hljs-comment">// As it doesn't go to ActivityStarter.executeRequest() path, we need to resume</span>
                    <span class="hljs-comment">// app switching here also.</span>
                    mService.resumeAppSwitches();
                    <span class="hljs-keyword">return</span> ActivityManager.START_TASK_TO_FRONT;
                }
                <span class="hljs-comment">// The task is empty or needs to show the confirmation for credential.</span>
                shouldStartActivity = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-keyword">if</span> (!shouldStartActivity) {
                    <span class="hljs-comment">//继续窗口布局，与前面mService.deferWindowLayout()延迟窗口布局相呼应。</span>
                    mService.continueWindowLayout();
                }
            }
            ......
        }
        <span class="hljs-comment">// ActivityStarter will acquire the lock where the places need, so execute the request</span>
        <span class="hljs-comment">// outside of the lock.</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// We need to temporarily disable the explicit intent filter matching enforcement</span>
            <span class="hljs-comment">// because Task does not store the resolved type of the intent data, causing filter</span>
            <span class="hljs-comment">// mismatch in certain cases. (b/240373119)</span>
            PackageManagerServiceUtils.DISABLE_ENFORCE_INTENTS_TO_MATCH_INTENT_FILTERS.set(<span class="hljs-literal">true</span>);
            <span class="hljs-comment">//通过startActivityInPackage启动相应的Task中对应Activity并将其移至最前台，传递options、task等关键参数。</span>
            <span class="hljs-keyword">return</span> mService.getActivityStartController().startActivityInPackage(taskCallingUid,
                    callingPid, callingUid, callingPackage, callingFeatureId, intent, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>,
                    <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, options, userId, task, <span class="hljs-string">"startActivityFromRecents"</span>,
                    <span class="hljs-literal">false</span> <span class="hljs-comment">/* validateIncomingUser */</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/* originatingPendingIntent */</span>,
                    BackgroundStartPrivileges.NONE);
        } <span class="hljs-keyword">finally</span> {
            PackageManagerServiceUtils.DISABLE_ENFORCE_INTENTS_TO_MATCH_INTENT_FILTERS.set(<span class="hljs-literal">false</span>);
            <span class="hljs-keyword">synchronized</span> (mService.mGlobalLock) {
                <span class="hljs-comment">//继续窗口布局，与前面mService.deferWindowLayout()延迟窗口布局相呼应。</span>
                mService.continueWindowLayout();
            }
        }
    }
</code></pre>
<p>startActivityFromRecents方法主要做了两件事：</p>
<ol>
<li>使用<code>anyTaskForId</code>方法，通过taskId找到对应的Task并设置其windowingMode。</li>
<li>通过<code>startActivityInPackage</code>方法，启动Task中对应Activity并将其移至最前台。</li>
</ol>
<h3 data-id="heading-1">通过taskId找到对应的Task并设置其windowingMode</h3>
<pre><code class="hljs language-java" lang="java">task = mRootWindowContainer.anyTaskForId(taskId,
        MATCH_ATTACHED_TASK_OR_RECENT_TASKS_AND_RESTORE, activityOptions, ON_TOP);
</code></pre>
<p>这里主要传递应用taskId和activityOptions（携带需要设置的自由窗口相关参数）。</p>
<h4 data-id="heading-2">RootWindowContainer.anyTaskForId</h4>
<p>代码路径：frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * Returns a {<span class="hljs-doctag">@link</span> Task} for the input id if available. {<span class="hljs-doctag">@code</span> null} otherwise.
     *
     * <span class="hljs-doctag">@param</span> id        Id of the task we would like returned.
     * <span class="hljs-doctag">@param</span> matchMode The mode to match the given task id in.
     * <span class="hljs-doctag">@param</span> aOptions  The activity options to use for restoration. Can be null.
     * <span class="hljs-doctag">@param</span> onTop     If the root task for the task should be the topmost on the display.
     */</span>
    Task <span class="hljs-title function_">anyTaskForId</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-meta">@RootWindowContainer</span>.AnyTaskForIdMatchTaskMode <span class="hljs-type">int</span> matchMode,
            <span class="hljs-meta">@Nullable</span> ActivityOptions aOptions, <span class="hljs-type">boolean</span> onTop)</span> {
        <span class="hljs-comment">// If options are set, ensure that we are attempting to actually restore a task</span>
        <span class="hljs-keyword">if</span> (matchMode != MATCH_ATTACHED_TASK_OR_RECENT_TASKS_AND_RESTORE &amp;&amp; aOptions != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Should not specify activity options for non-restore"</span>
                    + <span class="hljs-string">" lookup"</span>);
        }

        <span class="hljs-comment">//简单说就是创建了一个 task -&gt; task.isTaskId(id) 的lamda表达式</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">PooledPredicate</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> PooledLambda.obtainPredicate(
                Task::isTaskId, PooledLambda.__(Task.class), id);
        <span class="hljs-comment">//查找符合条件的task</span>
        <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> getTask(p);
        <span class="hljs-comment">//将 PooledPredicate 对象回收到对象池中，以便重用，避免频繁的垃圾回收</span>
        p.recycle();

        <span class="hljs-keyword">if</span> (task != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (aOptions != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// Resolve the root task the task should be placed in now based on options</span>
                <span class="hljs-comment">// and reparent if needed.</span>
                <span class="hljs-comment">// TODO(b/229927851) For split-screen, setLaunchRootTask is no longer the "root"</span>
                <span class="hljs-comment">// task, consider to rename methods like "parentTask" instead of "rootTask".</span>
                <span class="hljs-comment">//找到rootTask</span>
                <span class="hljs-keyword">final</span> <span class="hljs-type">Task</span> <span class="hljs-variable">targetRootTask</span> <span class="hljs-operator">=</span>
                        getOrCreateRootTask(<span class="hljs-literal">null</span>, aOptions, task, onTop);
                <span class="hljs-comment">// When launch with ActivityOptions#getLaunchRootTask, the "root task" just mean the</span>
                <span class="hljs-comment">// parent of current launch, not the "root task" in hierarchy.</span>
                <span class="hljs-comment">//这里是判断当前Task的获取到的rootTask与其task.getRootTask()的场景</span>
                <span class="hljs-comment">//我们一般启动应用时情况如下：</span>
                <span class="hljs-comment">//targetRootTask != null,true</span>
                <span class="hljs-comment">//task.getRootTask() != targetRootTask，false</span>
                <span class="hljs-comment">//task.getParent() != targetRootTask，false</span>
                <span class="hljs-comment">//因此我们这里为false</span>
                <span class="hljs-comment">//这个场景一般是task参数在特殊情况变null时，getOrCreateRootTask中会重新创建Task</span>
                <span class="hljs-keyword">if</span> (targetRootTask != <span class="hljs-literal">null</span> &amp;&amp; task.getRootTask() != targetRootTask
                        &amp;&amp; task.getParent() != targetRootTask) {
                    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">reparentMode</span> <span class="hljs-operator">=</span> onTop
                            ? REPARENT_MOVE_ROOT_TASK_TO_FRONT : REPARENT_LEAVE_ROOT_TASK_IN_PLACE;
                    task.reparent(targetRootTask, onTop, reparentMode, ANIMATE, DEFER_RESUME,
                            <span class="hljs-string">"anyTaskForId"</span>);
                }
            }
            <span class="hljs-comment">//返回获取到的task</span>
            <span class="hljs-keyword">return</span> task;
        }

        <span class="hljs-comment">//task为空的其他情况，省略</span>
        ......
        
        <span class="hljs-keyword">if</span> (DEBUG_RECENTS) Slog.w(TAG_RECENTS, <span class="hljs-string">"Restored task id="</span> + id + <span class="hljs-string">" from in recents"</span>);
        <span class="hljs-keyword">return</span> task;
    }
</code></pre>
<p>这个方法实际上就是通过getOrCreateRootTask做一些操作，然后返回给targetRootTask，做后续的条件判断处理。
在代码我们分析了后面的流程一般情况不会去走，因此暂不考虑。这里最后return 通过<code>getTask(p)</code>获取到的task。</p>
<p>这里我们重点分析下getOrCreateRootTask方法。</p>
<pre><code class="hljs language-java" lang="java">                <span class="hljs-keyword">final</span> <span class="hljs-type">Task</span> <span class="hljs-variable">targetRootTask</span> <span class="hljs-operator">=</span>
                        getOrCreateRootTask(<span class="hljs-literal">null</span>, aOptions, task, onTop);
</code></pre>
<p>这里传递了从taskId中找到的对应task，以及前面创建options，其中参数<code>null</code>表示ActivityRecord为空。</p>
<h4 data-id="heading-3">RootWindowContainer.getOrCreateRootTask</h4>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * Returns the right root task to use for launching factoring in all the input parameters.
     *
     * <span class="hljs-doctag">@param</span> r              The activity we are trying to launch. Can be null.
     * <span class="hljs-doctag">@param</span> options        The activity options used to the launch. Can be null.
     * <span class="hljs-doctag">@param</span> candidateTask  The possible task the activity might be launched in. Can be null.
     * <span class="hljs-doctag">@param</span> sourceTask     The task requesting to start activity. Can be null.
     * <span class="hljs-doctag">@param</span> launchParams   The resolved launch params to use.
     * <span class="hljs-doctag">@param</span> launchFlags    The launch flags for this launch.
     * <span class="hljs-doctag">@param</span> realCallingPid The pid from {<span class="hljs-doctag">@link</span> ActivityStarter#setRealCallingPid}
     * <span class="hljs-doctag">@param</span> realCallingUid The uid from {<span class="hljs-doctag">@link</span> ActivityStarter#setRealCallingUid}
     * <span class="hljs-doctag">@return</span> The root task to use for the launch.
     */</span>
    Task <span class="hljs-title function_">getOrCreateRootTask</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ActivityRecord r,
            <span class="hljs-meta">@Nullable</span> ActivityOptions options, <span class="hljs-meta">@Nullable</span> Task candidateTask,
            <span class="hljs-meta">@Nullable</span> Task sourceTask, <span class="hljs-type">boolean</span> onTop,
            <span class="hljs-meta">@Nullable</span> LaunchParamsController.LaunchParams launchParams, <span class="hljs-type">int</span> launchFlags)</span> {
        <span class="hljs-comment">// First preference goes to the launch root task set in the activity options.</span>
        <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//这边传递过来的options没有设置过mLaunchRootTask</span>
            <span class="hljs-comment">//因此options.getLaunchRootTask()为null，因此不进入此流程</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">Task</span> <span class="hljs-variable">candidateRoot</span> <span class="hljs-operator">=</span> Task.fromWindowContainerToken(options.getLaunchRootTask());
            <span class="hljs-keyword">if</span> (candidateRoot != <span class="hljs-literal">null</span> &amp;&amp; canLaunchOnDisplay(r, candidateRoot)) {
                <span class="hljs-keyword">return</span> candidateRoot;
            }
        }

        <span class="hljs-comment">// Next preference goes to the task id set in the activity options.</span>
        <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//options.getLaunchRootTask()为null，因此不进入此流程</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">candidateTaskId</span> <span class="hljs-operator">=</span> options.getLaunchTaskId();
            <span class="hljs-keyword">if</span> (candidateTaskId != INVALID_TASK_ID) {
                ......
            }
        }

        <span class="hljs-comment">// Next preference goes to the TaskDisplayArea candidate from launchParams</span>
        <span class="hljs-comment">// or activity options.</span>
        <span class="hljs-type">TaskDisplayArea</span> <span class="hljs-variable">taskDisplayArea</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">//launchParams传递过来的值为null</span>
        <span class="hljs-keyword">if</span> (launchParams != <span class="hljs-literal">null</span> &amp;&amp; launchParams.mPreferredTaskDisplayArea != <span class="hljs-literal">null</span>) {
            taskDisplayArea = launchParams.mPreferredTaskDisplayArea;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) {<span class="hljs-comment">//options不为空，进入此流程给taskDisplayArea赋值</span>
            <span class="hljs-comment">//当前的options中没有设置，因此options.getLaunchTaskDisplayArea()值为空</span>
            <span class="hljs-comment">//即taskDisplayArea获取的值为null。</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">WindowContainerToken</span> <span class="hljs-variable">daToken</span> <span class="hljs-operator">=</span> options.getLaunchTaskDisplayArea();
            taskDisplayArea = daToken != <span class="hljs-literal">null</span>
                    ? (TaskDisplayArea) WindowContainer.fromBinder(daToken.asBinder()) : <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (taskDisplayArea == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">//options.getLaunchDisplayId()为null，因此不进入此流程</span>
                <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">launchDisplayId</span> <span class="hljs-operator">=</span> options.getLaunchDisplayId();
                <span class="hljs-keyword">if</span> (launchDisplayId != INVALID_DISPLAY) {
                    <span class="hljs-keyword">final</span> <span class="hljs-type">DisplayContent</span> <span class="hljs-variable">displayContent</span> <span class="hljs-operator">=</span> getDisplayContent(launchDisplayId);
                    <span class="hljs-keyword">if</span> (displayContent != <span class="hljs-literal">null</span>) {
                        taskDisplayArea = displayContent.getDefaultTaskDisplayArea();
                    }
                }
            }
        }

        <span class="hljs-comment">//获取activityType</span>
        <span class="hljs-comment">//我们这里r即ActivityRecord为空，因此获取candidateTask的type</span>
        <span class="hljs-comment">//即activityType为ACTIVITY_TYPE_STANDARD</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">activityType</span> <span class="hljs-operator">=</span> resolveActivityType(r, options, candidateTask);
        <span class="hljs-comment">//此时taskDisplayArea仍然为空</span>
        <span class="hljs-keyword">if</span> (taskDisplayArea != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (canLaunchOnDisplay(r, taskDisplayArea.getDisplayId())) {
                <span class="hljs-keyword">return</span> taskDisplayArea.getOrCreateRootTask(r, options, candidateTask,
                        sourceTask, launchParams, launchFlags, activityType, onTop);
            } <span class="hljs-keyword">else</span> {
                taskDisplayArea = <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment">// Give preference to the root task and display of the input task and activity if they</span>
        <span class="hljs-comment">// match the mode we want to launch into.</span>
        <span class="hljs-type">Task</span> <span class="hljs-variable">rootTask</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">//传递过来的candidateTask不为空，因此获取其rootTask</span>
        <span class="hljs-keyword">if</span> (candidateTask != <span class="hljs-literal">null</span>) {
            rootTask = candidateTask.getRootTask();
        }
        <span class="hljs-comment">//rootTask为空且ActivityRecord不为空的情况，通过ActivityRecord获取rootTask</span>
        <span class="hljs-keyword">if</span> (rootTask == <span class="hljs-literal">null</span> &amp;&amp; r != <span class="hljs-literal">null</span>) {
            rootTask = r.getRootTask();
        }
        <span class="hljs-comment">//launchParams为null，此时windowingMode为WINDOWING_MODE_UNDEFINED</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">windowingMode</span> <span class="hljs-operator">=</span> launchParams != <span class="hljs-literal">null</span> ? launchParams.mWindowingMode
                : WindowConfiguration.WINDOWING_MODE_UNDEFINED;
        <span class="hljs-keyword">if</span> (rootTask != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//获取rootTask对应的taskDisplayArea</span>
            taskDisplayArea = rootTask.getDisplayArea();
            <span class="hljs-comment">//此时taskDisplayArea不为null</span>
            <span class="hljs-comment">//canLaunchOnDisplay中传递的r（ActivityRecord）和DisplayContent的DisplayId</span>
            <span class="hljs-comment">//其中ActivityRecord为空，从canLaunchOnDisplay方法流程中可以得知该情况返回为true</span>
            <span class="hljs-keyword">if</span> (taskDisplayArea != <span class="hljs-literal">null</span>
                    &amp;&amp; canLaunchOnDisplay(r, taskDisplayArea.mDisplayContent.mDisplayId)) {
                <span class="hljs-comment">//此时windowingMode为WINDOWING_MODE_UNDEFINED</span>
                <span class="hljs-keyword">if</span> (windowingMode == WindowConfiguration.WINDOWING_MODE_UNDEFINED) {
                    <span class="hljs-comment">//该方法通过options.getLaunchWindowingMode()获取了自由窗口的windowingMode，其值为WINDOWING_MODE_FREEFORM</span>
                    windowingMode = taskDisplayArea.resolveWindowingMode(r, options, candidateTask);
                }
                <span class="hljs-comment">// Always allow organized tasks that created by organizer since the activity type</span>
                <span class="hljs-comment">// of an organized task is decided by the activity type of its top child, which</span>
                <span class="hljs-comment">// could be incompatible with the given windowing mode and activity type.</span>
                <span class="hljs-comment">//rootTask.isCompatible(windowingMode, activityType)，判断当前应用的windowingMode和activityType</span>
                <span class="hljs-comment">//和新设置的windowingMode和activityType是否一致，一致则返回true，不一致则返回false</span>
                <span class="hljs-comment">//简单来说这个方法就是判断windowingMode和activityType是否需要更新，如果需要更新就继续后面的流程。</span>
                <span class="hljs-comment">//rootTask.mCreatedByOrganizer从代码上看涉及TaskFragment才会有true的情况</span>
                <span class="hljs-keyword">if</span> (rootTask.isCompatible(windowingMode, activityType)
                        || rootTask.mCreatedByOrganizer) {
                    <span class="hljs-comment">//直接返回当前rootTask</span>
                    <span class="hljs-keyword">return</span> rootTask;
                }
            } <span class="hljs-keyword">else</span> {
                taskDisplayArea = <span class="hljs-literal">null</span>;
            }

        }

        <span class="hljs-comment">// Falling back to default task container</span>
        <span class="hljs-comment">//taskDisplayArea为空时，直接获取默认的taskDisplayArea</span>
        <span class="hljs-keyword">if</span> (taskDisplayArea == <span class="hljs-literal">null</span>) {
            taskDisplayArea = getDefaultTaskDisplayArea();
        }
        <span class="hljs-comment">//在taskDisplayArea中调用getOrCreateRootTask</span>
        <span class="hljs-keyword">return</span> taskDisplayArea.getOrCreateRootTask(r, options, candidateTask, sourceTask,
                launchParams, launchFlags, activityType, onTop);
    }
</code></pre>
<p>本次启动自由窗口时，<code>rootTask = candidateTask.getRootTask();</code>不为null，因此进入到<code>rootTask != null</code>的流程。
这里com.android.messaging进入自由窗口为例，使用dump命令<code>adb shell dumpsys activity containers</code>。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d8573140ff04da0b3fc3cab074d401d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeWnor7rljYPph5E=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764064301&amp;x-signature=hv%2FHvj9tcFTviO9NxDlmhvukHdE%3D" alt="在这里插入图片描述" loading="lazy"/>
从dump中可以看到com.android.messaging的task为1226，在其之上没有别的task，因此rootTask实际上就是candidateTask它本身。</p>
<p>在<code>rootTask.isCompatible(windowingMode, activityType) || rootTask.mCreatedByOrganizer</code>条件中，返回的是false，因此不会直接返回<code>rootTask</code>。
这里我们主要先讲解下<code>rootTask.isCompatible(windowingMode, activityType)</code>
代码路径：frameworks/base/services/core/java/com/android/server/wm/Task.java</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCompatible</span><span class="hljs-params">(<span class="hljs-type">int</span> windowingMode, <span class="hljs-type">int</span> activityType)</span> {
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Should we just move this to ConfigurationContainer?</span>
        <span class="hljs-keyword">if</span> (activityType == ACTIVITY_TYPE_UNDEFINED) {
            <span class="hljs-comment">// Undefined activity types end up in a standard root task once the root task is</span>
            <span class="hljs-comment">// created on a display, so they should be considered compatible.</span>
            activityType = ACTIVITY_TYPE_STANDARD;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.isCompatible(windowingMode, activityType);
    }
</code></pre>
<p>判断activityType类型是否是<code>ACTIVITY_TYPE_UNDEFINED</code>，如果是则改为<code>ACTIVITY_TYPE_STANDARD</code>，之后调用其父类ConfigurationContainer.isCompatible方法
代码路径：frameworks/base/services/core/java/com/android/server/wm/ConfigurationContainer.java</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * Returns true if this container is compatible with the input windowing mode and activity type.
     * The container is compatible:
     * - If {<span class="hljs-doctag">@param</span> activityType} and {<span class="hljs-doctag">@param</span> windowingMode} match this container activity type and
     * windowing mode.
     * - If {<span class="hljs-doctag">@param</span> activityType} is {<span class="hljs-doctag">@link</span> WindowConfiguration#ACTIVITY_TYPE_UNDEFINED} or
     * {<span class="hljs-doctag">@link</span> WindowConfiguration#ACTIVITY_TYPE_STANDARD} and this containers activity type is also
     * standard or undefined and its windowing mode matches {<span class="hljs-doctag">@param</span> windowingMode}.
     * - If {<span class="hljs-doctag">@param</span> activityType} isn't {<span class="hljs-doctag">@link</span> WindowConfiguration#ACTIVITY_TYPE_UNDEFINED} or
     * {<span class="hljs-doctag">@link</span> WindowConfiguration#ACTIVITY_TYPE_STANDARD} or this containers activity type isn't
     * also standard or undefined and its activity type matches {<span class="hljs-doctag">@param</span> activityType} regardless of
     * if {<span class="hljs-doctag">@param</span> windowingMode} matches the containers windowing mode.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCompatible</span><span class="hljs-params">(<span class="hljs-type">int</span> windowingMode, <span class="hljs-type">int</span> activityType)</span> {
        <span class="hljs-comment">//获取当前activityType和windowingMode</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">thisActivityType</span> <span class="hljs-operator">=</span> getActivityType();
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">thisWindowingMode</span> <span class="hljs-operator">=</span> getWindowingMode();
        <span class="hljs-comment">//比较当前activityType和windowingMode和传递过来的activityType和windowingMode</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">sameActivityType</span> <span class="hljs-operator">=</span> thisActivityType == activityType;
        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">sameWindowingMode</span> <span class="hljs-operator">=</span> thisWindowingMode == windowingMode;
        
        <span class="hljs-comment">//activityType和windowingMode均未发生变化</span>
        <span class="hljs-keyword">if</span> (sameActivityType &amp;&amp; sameWindowingMode) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-comment">//activityType发生了变化</span>
        <span class="hljs-keyword">if</span> ((activityType != ACTIVITY_TYPE_UNDEFINED &amp;&amp; activityType != ACTIVITY_TYPE_STANDARD)
                || !isActivityTypeStandardOrUndefined()) {
            <span class="hljs-comment">// Only activity type need to match for non-standard activity types that are defined.</span>
            <span class="hljs-keyword">return</span> sameActivityType;
        }

        <span class="hljs-comment">// Otherwise we are compatible if the windowing mode is the same.</span>
        <span class="hljs-comment">//windowingMode发生了变化</span>
        <span class="hljs-keyword">return</span> sameWindowingMode;
    }
</code></pre>
<p>通过getActivityType()和getWindowingMode()分别获取了当前activityType和windowingMode，然后进行变化，如果两者之一出现变化则返回false。</p>
<p>因此我们这里没有直接返回rootTask，而是调用到了taskDisplayArea.getOrCreateRootTask。</p>
<pre><code class="hljs language-java" lang="java">        <span class="hljs-keyword">return</span> taskDisplayArea.getOrCreateRootTask(r, options, candidateTask, sourceTask,
                launchParams, launchFlags, activityType, onTop);
</code></pre>
<p>这里先回顾说明下传递的参数：
<code>r</code>：ActivityRecord类型，其值由RootWindowContainer.anyTaskForId中传递过来，值为<code>null</code>。</p>
<p><code>options</code>：ActivityOptions类型，其值从最初桌面侧FreeformSystemShortcut.startActivity调用startActivityFromRecents传递过来，包含来设置 <strong>窗口模式(<code>mLaunchWindowingMode</code>)</strong> 和 <strong>窗口大小(<code>mLaunchBounds</code>)</strong> 参数。</p>
<p><code>candidateTask</code>：Task类型，其值由RootWindowContainer.anyTaskForId中传递过来，值为<code>桌面侧传递过来taskId对应的Task</code>。</p>
<p><code>sourceTask</code>：Task类型，其值由RootWindowContainer.getOrCreateRootTask传递，值为<code>null</code>。</p>
<p><code>activityType</code>：其值由RootWindowContainer.getOrCreateRootTask获取并传递，值为<code>ACTIVITY_TYPE_STANDARD</code>即<code>1</code>。</p>
<p><code>launchParams</code>：LaunchParamsController.LaunchParams类型，其值由RootWindowContainer.getOrCreateRootTask传递，值为<code>null</code>。</p>
<p><code>launchFlags</code>：int类型，其值由RootWindowContainer.getOrCreateRootTask传递，值为<code>0</code>。</p>
<p><code>onTop</code>：boolean类型，其值由ActivityTaskSupervisor.startActivityFromRecents的anyTaskForId中传递过来，值为
<code>ActivityTaskSupervisor.ON_TOP</code>即<code>true</code>。</p>
<h4 data-id="heading-4">TaskDisplayArea.getOrCreateRootTask</h4>
<p>代码路径：frameworks/base/services/core/java/com/android/server/wm/TaskDisplayArea.java</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * Returns an existing root task compatible with the input params or creates one
     * if a compatible root task doesn't exist.
     *
     * <span class="hljs-doctag">@see</span> #getOrCreateRootTask(int, int, boolean)
     */</span>
    Task <span class="hljs-title function_">getOrCreateRootTask</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ActivityRecord r, <span class="hljs-meta">@Nullable</span> ActivityOptions options,
            <span class="hljs-meta">@Nullable</span> Task candidateTask, <span class="hljs-meta">@Nullable</span> Task sourceTask,
            <span class="hljs-meta">@Nullable</span> LaunchParams launchParams, <span class="hljs-type">int</span> launchFlags, <span class="hljs-type">int</span> activityType, <span class="hljs-type">boolean</span> onTop)</span> {
        <span class="hljs-comment">//设置windowingMode初始值为WINDOWING_MODE_UNDEFINED</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">windowingMode</span> <span class="hljs-operator">=</span> WINDOWING_MODE_UNDEFINED;
        <span class="hljs-keyword">if</span> (launchParams != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// If launchParams isn't null, windowing mode is already resolved.</span>
            windowingMode = launchParams.mWindowingMode;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// If launchParams is null and options isn't let's use the windowing mode in the</span>
            <span class="hljs-comment">// options.</span>
            <span class="hljs-comment">//这里options不为空，options.getLaunchWindowingMode()值为WINDOWING_MODE_FREEFORM</span>
            windowingMode = options.getLaunchWindowingMode();
        }
        <span class="hljs-comment">// Validate that our desired windowingMode will work under the current conditions.</span>
        <span class="hljs-comment">// UNDEFINED windowing mode is a valid result and means that the new root task will inherit</span>
        <span class="hljs-comment">// it's display's windowing mode.</span>
        <span class="hljs-comment">//判断windowingMode有效性，并赋值</span>
        windowingMode = validateWindowingMode(windowingMode, r, candidateTask);
        <span class="hljs-comment">//继续传递参数</span>
        <span class="hljs-keyword">return</span> getOrCreateRootTask(windowingMode, activityType, onTop, candidateTask, sourceTask,
                options, launchFlags);
    }
</code></pre>
<p>这里主要就是通过<code>options.getLaunchWindowingMode()</code>获取了<code>windowingMode (WINDOWING_MODE_FREEFORM)</code>，在将其传递到getOrCreateRootTask方法中。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * When two level tasks are required for given windowing mode and activity type, returns an
     * existing compatible root task or creates a new one.
     * For one level task, the candidate task would be reused to also be the root task or create
     * a new root task if no candidate task.
     *
     * <span class="hljs-doctag">@param</span> windowingMode The windowing mode the root task should be created in.
     * <span class="hljs-doctag">@param</span> activityType  The activityType the root task should be created in.
     * <span class="hljs-doctag">@param</span> onTop         If true the root task will be created at the top of the display,
     *                      else at the bottom.
     * <span class="hljs-doctag">@param</span> candidateTask The possible task the activity might be launched in. Can be null.
     * <span class="hljs-doctag">@param</span> sourceTask    The task requesting to start activity. Used to determine which of the
     *                      adjacent roots should be launch root of the new task. Can be null.
     * <span class="hljs-doctag">@param</span> options       The activity options used to the launch. Can be null.
     * <span class="hljs-doctag">@param</span> launchFlags   The launch flags for this launch.
     * <span class="hljs-doctag">@return</span> The root task to use for the launch.
     * <span class="hljs-doctag">@see</span> #getRootTask(int, int)
     */</span>
    Task <span class="hljs-title function_">getOrCreateRootTask</span><span class="hljs-params">(<span class="hljs-type">int</span> windowingMode, <span class="hljs-type">int</span> activityType, <span class="hljs-type">boolean</span> onTop,
            <span class="hljs-meta">@Nullable</span> Task candidateTask, <span class="hljs-meta">@Nullable</span> Task sourceTask,
            <span class="hljs-meta">@Nullable</span> ActivityOptions options, <span class="hljs-type">int</span> launchFlags)</span> {
        <span class="hljs-comment">//我们这里windowingMode传递的是WINDOWING_MODE_FREEFORM，</span>
        <span class="hljs-comment">//因此resolvedWindowingMode为WINDOWING_MODE_FREEFORM</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">resolvedWindowingMode</span> <span class="hljs-operator">=</span>
                windowingMode == WINDOWING_MODE_UNDEFINED ? getWindowingMode() : windowingMode;
        <span class="hljs-comment">// Need to pass in a determined windowing mode to see if a new root task should be created,</span>
        <span class="hljs-comment">// so use its parent's windowing mode if it is undefined.</span>
        <span class="hljs-comment">//我们这里resolvedWindowingMode是WINDOWING_MODE_FREEFORM</span>
        <span class="hljs-comment">//activityType是ACTIVITY_TYPE_STANDARD，因此alwaysCreateRootTask为true</span>
        <span class="hljs-comment">//这取反为false，因此不进入该逻辑</span>
        <span class="hljs-keyword">if</span> (!alwaysCreateRootTask(resolvedWindowingMode, activityType)) {
            <span class="hljs-type">Task</span> <span class="hljs-variable">rootTask</span> <span class="hljs-operator">=</span> getRootTask(resolvedWindowingMode, activityType);
            <span class="hljs-keyword">if</span> (rootTask != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> rootTask;
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidateTask != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> onTop ? POSITION_TOP : POSITION_BOTTOM;
            <span class="hljs-comment">//这里getLaunchRootTask是同options获取，我们这里options没有设置过mLaunchRootTask，因此为null</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">Task</span> <span class="hljs-variable">launchParentTask</span> <span class="hljs-operator">=</span> getLaunchRootTask(resolvedWindowingMode, activityType,
                    options, sourceTask, launchFlags, candidateTask);
            <span class="hljs-comment">//launchParentTask为null不进入该流程</span>
            <span class="hljs-keyword">if</span> (launchParentTask != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (candidateTask.getParent() == <span class="hljs-literal">null</span>) {
                    launchParentTask.addChild(candidateTask, position);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidateTask.getParent() != launchParentTask) {
                    candidateTask.reparent(launchParentTask, position);
                }
            <span class="hljs-comment">//candidateTask.getDisplayArea()和this都是默认的TaskDisplayArea，即DefaultTaskDisplayArea</span>
            <span class="hljs-comment">//两者相同，即candidateTask.getDisplayArea() != this 为false，因此不进入该流程</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidateTask.getDisplayArea() != <span class="hljs-built_in">this</span> 
                    || candidateTask.getRootTask().mReparentLeafTaskIfRelaunch) {
                <span class="hljs-keyword">if</span> (candidateTask.getParent() == <span class="hljs-literal">null</span>) {
                    addChild(candidateTask, position);
                } <span class="hljs-keyword">else</span> {
                    candidateTask.reparent(<span class="hljs-built_in">this</span>, onTop);
                }
            }
            <span class="hljs-comment">// Update windowing mode if necessary, e.g. launch into a different windowing mode.</span>
            <span class="hljs-comment">//windowingMode传递的是WINDOWING_MODE_FREEFORM</span>
            <span class="hljs-comment">//candidateTask自身就是rootTask</span>
            <span class="hljs-comment">//candidateTask前后windowingMode有发生变化</span>
            <span class="hljs-keyword">if</span> (windowingMode != WINDOWING_MODE_UNDEFINED &amp;&amp; candidateTask.isRootTask()
                    &amp;&amp; candidateTask.getWindowingMode() != windowingMode) {
                <span class="hljs-comment">//ShellTransitions调用collect处理</span>
                candidateTask.mTransitionController.collect(candidateTask);
                <span class="hljs-comment">//设置task窗口模式</span>
                candidateTask.setWindowingMode(windowingMode);
            }
            <span class="hljs-comment">//返回candidateTask的rootTask</span>
            <span class="hljs-keyword">return</span> candidateTask.getRootTask();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Task</span>.Builder(mAtmService)
                .setWindowingMode(windowingMode)
                .setActivityType(activityType)
                .setOnTop(onTop)
                .setParent(<span class="hljs-built_in">this</span>)
                .setSourceTask(sourceTask)
                .setActivityOptions(options)
                .setLaunchFlags(launchFlags)
                .build();
    }
</code></pre>
<p>这里我们重点看这一段</p>
<pre><code class="hljs language-java" lang="java">            <span class="hljs-keyword">if</span> (windowingMode != WINDOWING_MODE_UNDEFINED &amp;&amp; candidateTask.isRootTask()
                    &amp;&amp; candidateTask.getWindowingMode() != windowingMode) {
                candidateTask.mTransitionController.collect(candidateTask);
                candidateTask.setWindowingMode(windowingMode);
            }
            <span class="hljs-keyword">return</span> candidateTask.getRootTask();
</code></pre>
<p>先解析下这个条件</p>
<ul>
<li>
<p><code>windowingMode != WINDOWING_MODE_UNDEFINED</code>
windowingMode传递的是WINDOWING_MODE_FREEFORM，因此该条件为true。</p>
</li>
<li>
<p><code>candidateTask.isRootTask()</code>
判断candidateTask是否是rootTask，关于这点前面有讲到，当前candidateTask就是rootTask，因此该条件为true。</p>
</li>
<li>
<p><code>candidateTask.getWindowingMode() != windowingMode)</code>
获取当前candidateTask的windowingMode，判断该windowingMode和传递过来的windowingMode是否一致，我们这里还没有启动到自由窗口，因此candidateTask.getWindowingMode()不是WINDOWING_MODE_FREEFORM，所以不一致，即该条件为true。</p>
</li>
</ul>
<p>综上，所有条件都满足，所有进入该条件。
其中<code>candidateTask.mTransitionController.collect(candidateTask);</code>涉及ShellTransitions，这里不涉及，暂不讲解。</p>
<p>最终通过<code>candidateTask.setWindowingMode(windowingMode)</code>方法给candidateTask的windowingMode设置成了WINDOWING_MODE_FREEFORM。</p>
<h4 data-id="heading-5">总结</h4>
<p>从<code>mRootWindowContainer.anyTaskForId</code>开始到<code>TaskDisplayArea.getOrCreateRootTask</code>结束，简单概括为一句话就是<strong>通过taskId获取对应task并设置该task的windowingMode为WINDOWING_MODE_FREEFORM（自由窗口）</strong>。</p>
<h3 data-id="heading-6">启动Task中对应Activity并将其移至最前台</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">return</span> mService.getActivityStartController().startActivityInPackage(taskCallingUid,
        callingPid, callingUid, callingPackage, callingFeatureId, intent, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>,
        <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, options, userId, task, <span class="hljs-string">"startActivityFromRecents"</span>,
        <span class="hljs-literal">false</span> <span class="hljs-comment">/* validateIncomingUser */</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/* originatingPendingIntent */</span>,
        BackgroundStartPrivileges.NONE);
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[订单超时自动取消：从业务场景到技术落地的完整设计方案]]></title>    <link>https://juejin.cn/post/7573886599433191475</link>    <guid>https://juejin.cn/post/7573886599433191475</guid>    <pubDate>2025-11-18T09:59:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573886599433191475" data-draft-id="7573899782802522158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="订单超时自动取消：从业务场景到技术落地的完整设计方案"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-11-18T09:59:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            订单超时自动取消：从业务场景到技术落地的完整设计方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:59:50.000Z" title="Tue Nov 18 2025 09:59:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">订单超时自动取消：从业务场景到技术落地的完整设计方案</h2>
<p>在电商、外卖、票务等业务中，“订单超时自动取消” 是保障资源高效利用的核心功能 —— 比如用户下单后 30 分钟未支付，若不自动取消，会导致商品库存被长期占用，其他用户无法购买；外卖订单 15 分钟未接单，若不取消，会让用户长时间等待。但当订单量达百万级、超时场景多样时，简单的 “定时遍历数据库” 会彻底失效，需设计一套适配高并发、保证数据一致性的方案。</p>
<p>本文从 “业务场景→核心需求→技术方案→工程落地” 四层，完整讲解订单超时自动取消的设计思路，覆盖不同业务规模的选型与避坑点。</p>
<h3 data-id="heading-1">一、先明确：哪些订单需要 “超时自动取消”？</h3>
<p>不同业务场景的超时规则差异极大，设计前需先分类梳理，避免 “一刀切” 的方案无法适配实际需求：</p>









































<table><thead><tr><th>订单类型</th><th>超时场景</th><th>超时时间</th><th>核心痛点（不取消的后果）</th></tr></thead><tbody><tr><td>电商普通订单</td><td>下单后未支付</td><td>30 分钟</td><td>库存占用，商品无法卖给其他用户</td></tr><tr><td>电商预售订单</td><td>付定金后未付尾款</td><td>24 小时</td><td>预售库存锁定，影响后续补货计划</td></tr><tr><td>外卖订单</td><td>商家未接单 / 骑手未取餐</td><td>15 分钟 / 30 分钟</td><td>用户长时间等待，投诉率升高</td></tr><tr><td>酒店 / 票务订单</td><td>预订后未支付</td><td>1 小时</td><td>房间 / 座位锁定，错失潜在客户</td></tr><tr><td>售后订单</td><td>退款申请后未上传凭证</td><td>72 小时</td><td>售后流程卡顿，用户体验差</td></tr></tbody></table>
<p><strong>核心共性</strong>：所有超时场景都需解决 “<strong>状态闭环</strong>”（超时后订单从 “待支付 / 待接单” 转为 “已取消”）和 “<strong>资源回补</strong>”（如库存、优惠券、座位释放）两大问题。</p>
<h3 data-id="heading-2">二、核心需求拆解：不止 “自动取消”，还要 “可靠”</h3>
<p>设计方案时，需满足以下功能性与非功能性需求，否则会出现 “取消失败导致资损”“延迟太久引发投诉” 等问题：</p>
<h4 data-id="heading-3">1. 功能性需求</h4>
<ul>
<li><strong>超时时间可配置</strong>：支持不同订单类型设置不同超时时间（如普通订单 30 分钟，预售订单 24 小时），且支持动态修改（如大促期间临时将未支付超时改为 15 分钟）；</li>
</ul>

<ul>
<li><strong>状态校验严格</strong>：取消前必须确认订单仍处于 “待超时状态”（如用户在超时前 1 秒支付了，不能再取消）；</li>
</ul>

<ul>
<li><strong>资源回补完整</strong>：取消后需同步回补关联资源（如释放库存、返还优惠券、解锁座位），且回补必须成功（不能出现 “订单取消了但库存没回来” 的情况）；</li>
</ul>

<ul>
<li><strong>通知触达</strong>：取消后需告知用户（如短信、APP 推送），说明取消原因（“订单超时未支付已自动取消”）。</li>
</ul>
<h4 data-id="heading-4">2. 非功能性需求</h4>
<ul>
<li><strong>数据一致性</strong>：100% 确保 “该取消的订单必须取消，不该取消的绝不取消”，不允许出现 “重复取消”（导致库存多回补）或 “漏取消”（导致库存长期占用）；</li>
</ul>

<ul>
<li><strong>实时性</strong>：超时后需在合理时间内取消（如超时后 1 分钟内），不能延迟太久（用户发现订单还在 “待支付”，但实际已超时，会困惑）；</li>
</ul>

<ul>
<li><strong>高并发支撑</strong>：大促期间订单量达百万级，方案需支撑每秒数百次的取消请求，且不影响核心下单流程；</li>
</ul>

<ul>
<li><strong>可监控可追溯</strong>：需记录每笔订单的 “超时时间、取消时间、取消结果、回补状态”，方便问题排查（如用户反馈 “订单没取消但扣了优惠券”，能快速定位原因）。</li>
</ul>
<h3 data-id="heading-5">三、技术方案对比：3 种主流方案的优劣与选型</h3>
<p>目前行业内实现订单超时自动取消的方案主要有 3 种，需根据业务规模、实时性要求选择适配方案：</p>





































<table><thead><tr><th>方案类型</th><th>核心原理</th><th>实时性</th><th>一致性</th><th>并发支撑</th><th>适用场景</th></tr></thead><tbody><tr><td>分布式定时任务</td><td>定时遍历数据库 / 缓存，筛选超时订单</td><td>中（分钟级）</td><td>高（需加锁）</td><td>中（百万级订单）</td><td>电商大促、库存占用敏感场景</td></tr><tr><td>延迟队列</td><td>订单创建时发送延迟消息，超时后消费</td><td>高（秒级）</td><td>高（消息可靠）</td><td>高（千万级订单）</td><td>外卖、票务等实时性要求高的场景</td></tr><tr><td>Redis 过期回调</td><td>订单 ID 作为 Redis Key，过期后触发回调</td><td>低（秒 - 分钟级，依赖 Redis 过期策略）</td><td>中（可能漏回调）</td><td>低（十万级订单）</td><td>中小业务、实时性要求不高的场景</td></tr></tbody></table>
<h4 data-id="heading-6">方案 1：分布式定时任务（适合海量订单，一致性优先）</h4>
<h5 data-id="heading-7">1. 原理</h5>
<ul>
<li>订单创建时，记录 “订单创建时间” 和 “超时时间”（如create_time=1688888888，timeout=1800秒）；</li>
</ul>

<ul>
<li>用分布式定时任务框架（如 XXL-Job、Elastic-Job）按固定频率（如每分钟）执行任务，筛选出 “当前时间 - create_time ≥ timeout” 且状态为 “待支付” 的订单；</li>
</ul>

<ul>
<li>对筛选出的订单执行取消逻辑（状态修改 + 资源回补）。</li>
</ul>
<h5 data-id="heading-8">2. 关键实现细节</h5>
<ul>
<li><strong>筛选优化</strong>：避免全表扫描，在create_time和order_status上建立联合索引（如idx_create_status (order_status, create_time)），查询 SQL 示例：</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> order_id <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> order_status <span class="hljs-operator">=</span> <span class="hljs-string">'PENDING_PAY'</span>  <span class="hljs-comment">-- 待支付状态</span>
  <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">+</span> timeout <span class="hljs-operator">&lt;=</span> UNIX_TIMESTAMP(NOW())  <span class="hljs-comment">-- 已超时</span>
LIMIT <span class="hljs-number">1000</span>;  <span class="hljs-comment">-- 分批处理，避免一次处理太多订单</span>
</code></pre>
<ul>
<li><strong>并发控制</strong>：用分布式锁（如 Redis 锁）防止同一订单被多个定时任务实例重复处理，锁 Key 为order:cancel:lock:{order_id}，持有时间设为 30 秒（足够完成一次取消流程）；</li>
</ul>

<ul>
<li><strong>失败重试</strong>：处理失败的订单（如资源回补失败），加入重试队列（如 Redis List），单独用一个定时任务重试（重试次数 3 次，每次间隔 5 分钟），仍失败则触发人工告警。</li>
</ul>
<h5 data-id="heading-9">3. 优劣势</h5>
<ul>
<li><strong>优势</strong>：不依赖复杂中间件，实现简单；支持海量订单筛选，适合大促场景；</li>
</ul>

<ul>
<li><strong>劣势</strong>：实时性中等（依赖定时频率，最快每分钟执行一次，超时后可能延迟 1 分钟才取消）；定时任务执行时会对数据库造成一定压力（需控制分批大小）。</li>
</ul>
<h5 data-id="heading-10">4. 选型建议</h5>
<p>适合 “订单量百万级 +，实时性要求不极致（允许 1 分钟延迟）” 的场景，如电商普通订单、预售订单。</p>
<h4 data-id="heading-11">方案 2：延迟队列（适合实时性高，中高并发）</h4>
<h5 data-id="heading-12">1. 原理</h5>
<ul>
<li>订单创建时，不直接写入数据库监控，而是向延迟队列发送一条 “延迟消息”，消息内容包含order_id，延迟时间设为订单的超时时间（如 30 分钟）；</li>
</ul>

<ul>
<li>延迟队列在消息达到延迟时间后，将消息投递到 “取消消费队列”；</li>
</ul>

<ul>
<li>消费端监听 “取消消费队列”，收到消息后执行订单取消逻辑。</li>
</ul>
<h5 data-id="heading-13">2. 主流延迟队列实现对比</h5>





























<table><thead><tr><th>中间件</th><th>实现方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>RabbitMQ</td><td>基于 “死信队列 + TTL”（消息过期后进入死信队列）</td><td>轻量，易集成，支持消息持久化</td><td>不支持动态修改延迟时间；延迟精度中等（秒级）</td></tr><tr><td>RocketMQ</td><td>原生支持定时消息（延迟级别或自定义时间）</td><td>延迟精度高（毫秒级），支持海量消息</td><td>依赖 RocketMQ，部署成本稍高；自定义延迟时间需配置</td></tr><tr><td>Kafka</td><td>基于 “时间轮 + 主题分区”（如 Kafka Streams）</td><td>高吞吐，适合千万级订单</td><td>实现复杂，需自定义时间轮逻辑；不支持消息重试</td></tr></tbody></table>
<h5 data-id="heading-14">3. 关键实现细节（以 RocketMQ 为例）</h5>
<ul>
<li><strong>消息发送</strong>：订单创建时发送定时消息，指定延迟时间为订单超时时间：</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// RocketMQ发送定时消息示例（Java）</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">sendDelayMsg</span><span class="hljs-params">(<span class="hljs-type">String</span> orderId, <span class="hljs-type">long</span> timeoutSeconds)</span> </span>{
    Message msg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Message</span>(<span class="hljs-string">"order_timeout_topic"</span>,  <span class="hljs-comment">// 主题</span>
                              <span class="hljs-string">"cancel_tag"</span>,           <span class="hljs-comment">// 标签</span>
                              orderId.<span class="hljs-built_in">getBytes</span>());    <span class="hljs-comment">// 消息体（订单ID）</span>
    <span class="hljs-comment">// 设置定时时间：timeoutSeconds秒后投递（RocketMQ支持自定义毫秒级延迟）</span>
    msg.<span class="hljs-built_in">setDelayTimeMs</span>(timeoutSeconds * <span class="hljs-number">1000</span>);
    <span class="hljs-comment">// 发送消息（开启事务，确保“订单创建成功”和“消息发送成功”原子性）</span>
    rocketMQTemplate.<span class="hljs-built_in">send</span>(msg);
}
</code></pre>
<ul>
<li><strong>事务保障</strong>：用 “本地事务表 + 消息确认” 确保 “订单创建” 和 “延迟消息发送” 的原子性（避免 “订单创建了但消息没发出去，导致漏取消”）：</li>
</ul>
<ol>
<li>
<ol>
<li>订单创建时，先写入 “订单表” 和 “本地事务表”（记录order_id和msg_status=UNSENT）；</li>
</ol>
</li>
</ol>

<ol>
<li>
<ol start="2">
<li>发送延迟消息，若发送成功，更新 “本地事务表”msg_status=SENT；</li>
</ol>
</li>
</ol>

<ol>
<li>
<ol start="3">
<li>启动定时任务，扫描 “本地事务表” 中msg_status=UNSENT的订单，重新发送消息。</li>
</ol>
</li>
</ol>
<ul>
<li><strong>消费逻辑</strong>：消费端收到消息后，先查订单状态，再执行取消：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@RocketMQMessageListener</span>(topic = <span class="hljs-string">"order_timeout_topic"</span>, consumerGroup = <span class="hljs-string">"cancel_consumer_group"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCancelConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;<span class="hljs-title class_">String</span>&gt; {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderService</span> orderService;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onMessage</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId</span>) {
        <span class="hljs-comment">// 1. 查订单当前状态（必须加锁，防止并发支付）</span>
        <span class="hljs-title class_">OrderDO</span> order = orderService.<span class="hljs-title function_">getOrderWithLock</span>(orderId);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span> || !<span class="hljs-string">"PENDING_PAY"</span>.<span class="hljs-title function_">equals</span>(order.<span class="hljs-title function_">getStatus</span>())) {
            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 订单不存在或已支付，不取消</span>
        }
        
        <span class="hljs-comment">// 2. 执行取消逻辑（状态修改+资源回补）</span>
        <span class="hljs-built_in">boolean</span> cancelSuccess = orderService.<span class="hljs-title function_">cancelOrder</span>(order);
        <span class="hljs-keyword">if</span> (!cancelSuccess) {
            <span class="hljs-comment">// 3. 取消失败，发送重试消息（延迟5分钟后重试）</span>
            <span class="hljs-title function_">sendDelayMsg</span>(orderId, <span class="hljs-number">300</span>);
        }
    }
}
</code></pre>
<h5 data-id="heading-15">4. 优劣势</h5>
<ul>
<li><strong>优势</strong>：实时性高（超时后秒级内取消）；消息持久化，不担心漏取消；支持高并发（RocketMQ 每秒可处理数万条消息）；</li>
</ul>

<ul>
<li><strong>劣势</strong>：依赖中间件（如 RocketMQ），需维护中间件集群；动态修改超时时间较复杂（需先删除旧消息，再发新消息）。</li>
</ul>
<h5 data-id="heading-16">5. 选型建议</h5>
<p>适合 “实时性要求高（如外卖、票务）、订单量中高（十万 - 千万级）” 的场景。</p>
<h4 data-id="heading-17">方案 3：Redis 过期回调（适合中小业务，快速落地）</h4>
<h5 data-id="heading-18">1. 原理</h5>
<ul>
<li>订单创建时，将order_id作为 Redis Key，值为订单状态（如PENDING_PAY），并设置 Key 的过期时间为订单超时时间（如 30 分钟）；</li>
</ul>

<ul>
<li>开启 Redis 的keyspace notifications（键空间通知），当 Key 过期时，Redis 会发送 “Key 过期事件”；</li>
</ul>

<ul>
<li>应用端监听 Redis 过期事件，收到事件后执行订单取消逻辑。</li>
</ul>
<h5 data-id="heading-19">2. 关键实现细节</h5>
<ul>
<li><strong>开启 Redis 通知</strong>：在 Redis 配置文件中开启过期通知（notify-keyspace-events "Ex"），或通过命令临时开启：</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">config set notify-keyspace-events Ex
</code></pre>
<ul>
<li><strong>监听过期事件</strong>：用 Redis 客户端（如 Redisson）监听事件：</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Redisson监听Redis过期事件示例</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">listenRedisExpireEvent</span><span class="hljs-params">()</span> </span>{
    RPatternTopic topic = redissonClient.<span class="hljs-built_in">getPatternTopic</span>(<span class="hljs-string">"__keyevent@0__:expired"</span>);
    topic.<span class="hljs-built_in">addListener</span>(<span class="hljs-type">String</span>.<span class="hljs-keyword">class</span>, (channel, orderId) -&gt; {
        <span class="hljs-comment">// 判断是否为订单超时Key（避免监听无关Key）</span>
        <span class="hljs-keyword">if</span> (orderId.<span class="hljs-built_in">startsWith</span>(<span class="hljs-string">"order:timeout:"</span>)) {
            <span class="hljs-type">String</span> realOrderId = orderId.<span class="hljs-built_in">replace</span>(<span class="hljs-string">"order:timeout:"</span>, <span class="hljs-string">""</span>);
            <span class="hljs-comment">// 执行取消逻辑（同延迟队列消费逻辑）</span>
            orderService.<span class="hljs-built_in">handleTimeoutCancel</span>(realOrderId);
        }
    });
}
</code></pre>
<ul>
<li><strong>规避 Redis 过期延迟</strong>：Redis 的过期删除采用 “惰性删除 + 定期删除” 策略，可能导致 Key 过期后几秒甚至几分钟才触发回调，需在取消逻辑中再次校验订单是否真的超时：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">public void handleTimeoutCancel(String orderId) {
    OrderDO <span class="hljs-attr">order</span> = orderService.getOrder(orderId)<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">order</span> == null) return<span class="hljs-comment">;</span>
    // 二次校验：当前时间是否真的超过订单超时时间（避免Redis回调延迟导致误判）
    long <span class="hljs-attr">currentTime</span> = System.currentTimeMillis() / <span class="hljs-number">1000</span><span class="hljs-comment">;</span>
    long <span class="hljs-attr">timeoutTime</span> = order.getCreateTime() + order.getTimeoutSeconds()<span class="hljs-comment">;</span>
    if (currentTime &lt; timeoutTime || !"PENDING_PAY".equals(order.getStatus())) {
        return<span class="hljs-comment">;</span>
    }
    // 执行取消逻辑
    orderService.cancelOrder(order)<span class="hljs-comment">;</span>
}
</code></pre>
<h5 data-id="heading-20">3. 优劣势</h5>
<ul>
<li><strong>优势</strong>：实现简单，无需依赖复杂中间件；开发成本低，适合中小团队；</li>
</ul>

<ul>
<li><strong>劣势</strong>：实时性低（依赖 Redis 过期策略，可能延迟几分钟）；Redis 集群环境下，过期事件可能丢失（部分客户端不支持集群监听）；不适合海量订单（Redis 处理过期事件的能力有限）。</li>
</ul>
<h5 data-id="heading-21">4. 选型建议</h5>
<p>适合 “中小业务、订单量十万级以内、实时性要求不高” 的场景（如小型电商、内部订单系统）。</p>
<h3 data-id="heading-22">四、核心业务逻辑：取消流程的 “避坑指南”</h3>
<p>无论选择哪种技术方案，订单取消的核心业务逻辑都需严格遵循 “<strong>校验→取消→回补→通知</strong>” 四步，且每一步都要处理异常，确保数据一致：</p>
<h4 data-id="heading-23">1. 第一步：订单状态严格校验（防误取消）</h4>
<p>取消前必须用 “<strong>排他锁</strong>” 锁定订单，防止用户在取消过程中支付（如用户超时前 1 秒支付，同时系统在执行取消）：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">// 用数据库行锁锁定订单（<span class="hljs-keyword">SELECT</span> ... <span class="hljs-keyword">FOR</span> UPDATE）
@Transactional
<span class="hljs-keyword">public</span> OrderDO getOrderWithLock(<span class="hljs-type">String</span> orderId) {
    <span class="hljs-keyword">return</span> orderMapper.selectByOrderIdForUpdate(orderId);
}
// 校验逻辑
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> checkCanCancel(OrderDO <span class="hljs-keyword">order</span>) {
    // <span class="hljs-number">1</span>. 订单状态必须是“待支付/待接单”等可取消状态
    <span class="hljs-keyword">if</span> (!Arrays.asList(<span class="hljs-string">"PENDING_PAY"</span>, <span class="hljs-string">"PENDING_ACCEPT"</span>).contains(<span class="hljs-keyword">order</span>.getStatus())) {
        log.info(<span class="hljs-string">"订单{}状态为{}，不可取消"</span>, <span class="hljs-keyword">order</span>.getOrderId(), <span class="hljs-keyword">order</span>.getStatus());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    // <span class="hljs-number">2</span>. 订单确实已超时（二次校验，避免定时任务/Redis回调延迟）
    <span class="hljs-type">long</span> currentTime = System.currentTimeMillis() / <span class="hljs-number">1000</span>;
    <span class="hljs-type">long</span> timeoutTime = <span class="hljs-keyword">order</span>.getCreateTime() + <span class="hljs-keyword">order</span>.getTimeoutSeconds();
    <span class="hljs-keyword">if</span> (currentTime &lt; timeoutTime) {
        log.info(<span class="hljs-string">"订单{}未超时（当前时间{}，超时时间{}），不可取消"</span>, 
                 <span class="hljs-keyword">order</span>.getOrderId(), currentTime, timeoutTime);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-24">2. 第二步：订单状态修改（原子性）</h4>
<p>修改订单状态必须在事务中执行，确保 “状态修改” 与 “资源回补” 要么同时成功，要么同时失败：</p>
<pre><code class="hljs language-php" lang="php">@Transactional
<span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title function_ invoke__">cancelOrder</span>(OrderDO order) {
    <span class="hljs-comment">// 1. 再次校验（防止事务等待期间状态变化）</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">checkCanCancel</span>(order)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 2. 修改订单状态为“已取消”</span>
    <span class="hljs-keyword">int</span> updateCount = orderMapper.<span class="hljs-title function_ invoke__">updateStatus</span>(order.<span class="hljs-title function_ invoke__">getOrderId</span>(), <span class="hljs-string">"CANCELED"</span>, <span class="hljs-string">"TIMEOUT"</span>);
    <span class="hljs-keyword">if</span> (updateCount != <span class="hljs-number">1</span>) {
        log.<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">"订单{}修改状态失败，影响行数{}"</span>, order.<span class="hljs-title function_ invoke__">getOrderId</span>(), updateCount);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"订单状态修改失败"</span>); <span class="hljs-comment">// 触发事务回滚</span>
    }
    
    <span class="hljs-comment">// 3. 回补关联资源（库存、优惠券、座位等）</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 回补库存</span>
        inventoryService.<span class="hljs-title function_ invoke__">releaseInventory</span>(order.<span class="hljs-title function_ invoke__">getSkuId</span>(), order.<span class="hljs-title function_ invoke__">getQuantity</span>());
        <span class="hljs-comment">// 回补优惠券（如果下单时锁定了优惠券）</span>
        <span class="hljs-keyword">if</span> (order.<span class="hljs-title function_ invoke__">getCouponId</span>() != <span class="hljs-literal">null</span>) {
            couponService.<span class="hljs-title function_ invoke__">unlockCoupon</span>(order.<span class="hljs-title function_ invoke__">getUserId</span>(), order.<span class="hljs-title function_ invoke__">getCouponId</span>());
        }
        <span class="hljs-comment">// 回补座位/房间（票务/酒店订单）</span>
        <span class="hljs-keyword">if</span> (order.<span class="hljs-title function_ invoke__">getOrderType</span>().<span class="hljs-title function_ invoke__">equals</span>(<span class="hljs-string">"TICKET"</span>)) {
            ticketService.<span class="hljs-title function_ invoke__">unlockSeat</span>(order.<span class="hljs-title function_ invoke__">getSeatId</span>());
        }
    } <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) {
        log.<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">"订单{}资源回补失败"</span>, order.<span class="hljs-title function_ invoke__">getOrderId</span>(), e);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"资源回补失败"</span>); <span class="hljs-comment">// 触发事务回滚，订单状态恢复为待支付</span>
    }
    
    <span class="hljs-comment">// 4. 记录取消日志（用于问题排查）</span>
    orderLogService.<span class="hljs-title function_ invoke__">recordLog</span>(order.<span class="hljs-title function_ invoke__">getOrderId</span>(), <span class="hljs-string">"ORDER_CANCELED"</span>, <span class="hljs-string">"订单超时自动取消"</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-25">3. 第三步：用户通知（提升体验）</h4>
<p>取消后需通过多渠道通知用户，说明原因和后续操作（如 “订单已取消，库存已释放，可重新下单”）：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">sendCancelNotice</span>(OrderDO order) {
    <span class="hljs-comment">// 1. 短信通知（核心渠道，确保用户能收到）</span>
    <span class="hljs-selector-tag">smsService</span><span class="hljs-selector-class">.send</span>(order.<span class="hljs-built_in">getPhone</span>(), String.<span class="hljs-built_in">format</span>(
        <span class="hljs-string">"【XX平台】您的订单%s因超时未支付已自动取消，库存已释放，可重新下单。"</span>, 
        order.<span class="hljs-built_in">getOrderId</span>()
    ));
    
    <span class="hljs-comment">// 2. APP推送（针对已安装APP的用户）</span>
    <span class="hljs-selector-tag">pushService</span><span class="hljs-selector-class">.send</span>(order.<span class="hljs-built_in">getUserId</span>(), <span class="hljs-string">"订单取消通知"</span>, 
        String.<span class="hljs-built_in">format</span>(<span class="hljs-string">"订单%s已自动取消，原因：超时未支付"</span>, order.<span class="hljs-built_in">getOrderId</span>()));
    
    <span class="hljs-comment">// 3. 站内信（补充渠道）</span>
    <span class="hljs-selector-tag">messageService</span><span class="hljs-selector-class">.sendInboxMsg</span>(order.<span class="hljs-built_in">getUserId</span>(), <span class="hljs-string">"订单取消"</span>, 
        String.<span class="hljs-built_in">format</span>(<span class="hljs-string">"订单%s于%s因超时未支付自动取消，如有疑问请联系客服。"</span>, 
        order.<span class="hljs-built_in">getOrderId</span>(), new <span class="hljs-built_in">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>).<span class="hljs-built_in">format</span>(new <span class="hljs-built_in">Date</span>())));
}
</code></pre>
<h3 data-id="heading-26">五、工程落地：监控与运维不可少</h3>
<p>即使方案设计完善，也需配套监控与运维措施，避免 “问题发生后才发现”：</p>
<h4 data-id="heading-27">1. 核心监控指标</h4>









































<table><thead><tr><th>指标名称</th><th>监控频率</th><th>阈值建议</th><th>告警方式</th></tr></thead><tbody><tr><td>超时订单总量</td><td>1 分钟</td><td>无（需观察趋势）</td><td>无（用于业务分析）</td></tr><tr><td>取消成功率</td><td>1 分钟</td><td>&lt;99.9%</td><td>短信 + 钉钉告警</td></tr><tr><td>取消延迟时间</td><td>1 分钟</td><td>&gt;3 分钟（超时后到取消的时间）</td><td>短信告警</td></tr><tr><td>资源回补失败率</td><td>1 分钟</td><td>&gt;0.1%</td><td>电话 + 短信告警</td></tr><tr><td>定时任务 / 延迟队列堆积数</td><td>10 秒</td><td>&gt;1000 条</td><td>钉钉 + 邮件告警</td></tr></tbody></table>
<h4 data-id="heading-28">2. 日志与追溯</h4>
<ul>
<li>每笔订单的取消流程需记录完整日志，包含 “订单 ID、触发方式（定时任务 / 延迟队列）、开始时间、结束时间、状态、回补资源列表、失败原因（如有）”；</li>
</ul>

<ul>
<li>用 ELK（Elasticsearch+Logstash+Kibana）存储和查询日志，支持按 “订单 ID、时间范围、失败原因” 检索，方便快速排查问题（如用户反馈 “订单没取消”，输入订单 ID 即可查看取消日志）。</li>
</ul>
<h4 data-id="heading-29">3. 应急方案</h4>
<ul>
<li><strong>取消失败应急</strong>：针对 “取消失败且重试多次仍失败” 的订单，触发人工介入流程（如发送工单给运营，手动取消并回补资源）；</li>
</ul>

<ul>
<li><strong>中间件故障应急</strong>：若延迟队列 / Redis 故障，临时切换为 “分布式定时任务” 方案，确保取消功能不中断；</li>
</ul>

<ul>
<li><strong>大促峰值应急</strong>：大促期间提前扩容定时任务 / 延迟队列的节点，避免因并发过高导致堆积。</li>
</ul>
<h3 data-id="heading-30">六、方案选型速查表</h3>





























<table><thead><tr><th>业务规模</th><th>实时性要求</th><th>推荐方案</th><th>关键注意点</th></tr></thead><tbody><tr><td>中小业务（&lt;10 万单 / 天）</td><td>低（允许 5 分钟延迟）</td><td>Redis 过期回调</td><td>开启 Redis 通知，二次校验超时时间</td></tr><tr><td>中业务（10 万 - 100 万单 / 天）</td><td>中（允许 1 分钟延迟）</td><td>分布式定时任务（XXL-Job）</td><td>分批处理，加分布式锁防重复取消</td></tr><tr><td>大业务（&gt;100 万单 / 天）</td><td>高（秒级）</td><td>延迟队列（RocketMQ）</td><td>消息持久化，事务保障订单与消息一致性</td></tr></tbody></table>
<h3 data-id="heading-31">总结</h3>
<p>订单超时自动取消功能的设计，核心不是 “选哪种技术方案”，而是 “<strong>确保一致性与可靠性</strong>”—— 无论用定时任务、延迟队列还是 Redis，都需做到：</p>
<ol>
<li>取消前严格校验订单状态，防误判；</li>
</ol>

<ol start="2">
<li>取消中用事务保障 “状态修改 + 资源回补” 原子性，防资损；</li>
</ol>

<ol start="3">
<li>取消后完善监控与日志，防问题不可追溯。</li>
</ol>
<p>最终，方案需适配自身业务规模与实时性要求：中小业务用 Redis 快速落地，中大规模用定时任务或延迟队列保障可靠，核心是 “不追求最复杂的技术，只选最适合的方案”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一张图 + 五条时间线，彻底拆透 StarRocks 主键表 UPSERT 链路]]></title>    <link>https://juejin.cn/post/7573708620870926388</link>    <guid>https://juejin.cn/post/7573708620870926388</guid>    <pubDate>2025-11-18T10:02:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573708620870926388" data-draft-id="7573864324713431092" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一张图 + 五条时间线，彻底拆透 StarRocks 主键表 UPSERT 链路"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-18T10:02:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shengjk1"/> <meta itemprop="url" content="https://juejin.cn/user/2647279732524957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一张图 + 五条时间线，彻底拆透 StarRocks 主键表 UPSERT 链路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2647279732524957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shengjk1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T10:02:41.000Z" title="Tue Nov 18 2025 10:02:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="gruvbox-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#282828}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#ebdbb2}.hljs-deletion,.hljs-formula,.hljs-keyword,.hljs-link,.hljs-selector-tag{color:#fb4934}.hljs-built_in,.hljs-emphasis,.hljs-name,.hljs-quote,.hljs-strong,.hljs-title,.hljs-variable{color:#83a598}.hljs-attr,.hljs-params,.hljs-template-tag,.hljs-type{color:#fabd2f}.hljs-builtin-name,.hljs-doctag,.hljs-literal,.hljs-number{color:#8f3f71}.hljs-code,.hljs-meta,.hljs-regexp,.hljs-selector-id,.hljs-template-variable{color:#fe8019}.hljs-addition,.hljs-meta-string,.hljs-section,.hljs-selector-attr,.hljs-selector-class,.hljs-string,.hljs-symbol{color:#b8bb26}.hljs-attribute,.hljs-bullet,.hljs-class,.hljs-function,.hljs-function .hljs-keyword,.hljs-meta-keyword,.hljs-selector-pseudo,.hljs-tag{color:#8ec07c}.hljs-comment{color:#928374}.hljs-link_label,.hljs-literal,.hljs-number{color:#d3869b}.hljs-comment,.hljs-emphasis{font-style:italic}.hljs-section,.hljs-strong,.hljs-tag{font-weight:700}</style><p>你好，我是 shengjk1，多年大厂经验，努力构建 通俗易懂的、好玩的编程语言教程。 欢迎关注！你会有如下收益：</p>
<ol>
<li>了解大厂经验</li>
<li>拥有和大厂相匹配的技术等</li>
</ol>
<p>希望看什么，评论或者私信告诉我！</p>
<h2 data-id="heading-0">一、 前言</h2>
<p>“为什么 StarRocks 主键表可以毫秒级 UPSERT，还能保证点查性能不崩，数据不丢？”<br/>
社区里 90% 的调优踩坑，归根结底是没把 <strong>dump</strong> 和 <strong>apply</strong> 这两件事分开。<br/>
今天用“一张图 + 五条时间线”把完整读写链路拆到代码级，让你 10 分钟变成“主键表懂王”。</p>
<hr/>
<h2 data-id="heading-1">二、 鸟瞰图：把 4 个核心组件先印在脑子里</h2>
<pre><code class="hljs language-sql" lang="sql">┌────────────┐  <span class="hljs-number">1</span>  write  ┌──────────────┐  <span class="hljs-number">2</span>  dump   ┌──────────────┐
│ Flink<span class="hljs-operator">/</span>Java │ ────────►  │ Memory       │ ────────►  │ Disk       │
│ Clients    │  <span class="hljs-keyword">INSERT</span><span class="hljs-operator">/</span>   │ DeltaBuffer  │  Mem→Disk  │ Delta RS <span class="hljs-operator">*</span> │
└────────────┘  <span class="hljs-keyword">UPDATE</span><span class="hljs-operator">/</span>   │ (跳表<span class="hljs-operator">+</span>索引)  │            │ (尚未合并) │
              <span class="hljs-keyword">DELETE</span>      └──────────────┘            └──────────────┘
                                                        │
                                                        │ <span class="hljs-number">3</span>  apply
                                                        ▼
┌────────────┐  <span class="hljs-number">4</span>  read   ┌──────────────┐            ┌──────────────┐
│ <span class="hljs-keyword">SQL</span>        │ ◄────────  │ Index        │ ◄────────  │ Base RS      │
│ <span class="hljs-keyword">SELECT</span>     │            │ PrimaryKey   │            │ (已合并)     │
└────────────┘            │ <span class="hljs-operator">+</span> DelVec     │            └──────────────┘
                          └──────────────┘
</code></pre>
<p>一句话注解：<br/>
<strong>写只碰 DeltaBuffer → dump 只落盘不合并 → apply 才真正把 Delta 合并进 Base → 读永远三路归并。</strong><br/>
把这张图截屏当桌面，后面所有概念都能一一映射回来。</p>
<hr/>
<h2 data-id="heading-2">2 五条时间线：写 → dump → apply → 读 → 后台维护</h2>
<h3 data-id="heading-3">2.1 写入：内存里完成 UPSERT，不到 1 ms</h3>






























<table><thead><tr><th>步骤</th><th>动作</th><th>并发保证</th></tr></thead><tbody><tr><td>① Write Ahead Log</td><td>追加写 <code>_wal/xxx.log</code></td><td>崩溃后可重放</td></tr><tr><td>② DeltaBuffer 插入</td><td>跳表（skiplist）按 pk 排序，同 key 覆盖</td><td>行级锁仅怼跳表，无 IO</td></tr><tr><td>③ 更新 PK Index</td><td>内存 B+ 树直接覆盖 RowLocation</td><td>无锁 CAS</td></tr><tr><td>④ 返回客户端</td><td>纯内存，延迟 P99 &lt; 1 ms</td><td>—</td></tr></tbody></table>
<p>关键点：</p>
<ul>
<li>跳表只保留 <strong>最新版本</strong>，天然 UPSERT。</li>
<li><strong>Base 数据文件零写入</strong>，因此没有随机写放大。</li>
</ul>
<h3 data-id="heading-4">2.2 dump：内存 → 磁盘，<strong>只写不合并</strong></h3>
<p>触发三件套：</p>
<ol>
<li>时间间隔：<code>pk_dump_interval_seconds</code>（默认 1 h）。</li>
<li>内存水位：<code>update_memory_limit_percent</code> 30%。</li>
<li>文件个数：Delta Rowset ≥ 1000。</li>
</ol>
<p>内部三步：</p>
<ol>
<li>把跳表顺序扫一遍 → 按主键排好序的列存块（含 DELETE 标记）。</li>
<li>写临时文件 <code>.dat/.idx</code> → 原子 rename 成 <code>DeltaRowsetID</code>。</li>
<li>释放整块 DeltaBuffer，内存瞬间掉回 0。</li>
</ol>
<p>结果：</p>
<ul>
<li>查询需要 <strong>Union 所有 Delta RS + 残留内存</strong>。</li>
<li><strong>不会去重 Base</strong>，所以 dump 越快，文件越碎，读放大越高。</li>
</ul>
<h3 data-id="heading-5">2.3 apply：磁盘 Delta + Base → 新 Base，<strong>真正合并</strong></h3>
<p>StarRocks 里叫 <strong>update compaction</strong>。<br/>
触发阈值：</p>
<ul>
<li>总 Delta 大小 ≥ 256 MB（<code>update_compaction_size_threshold</code>）。</li>
<li>Delta 文件数 ≥ 1000。</li>
<li>手动 <code>ADMIN COMPACT TABLE tbl;</code></li>
</ul>
<p>四步完成：</p>
<ol>
<li><strong>选集</strong>：挑一个 Base + 若干 Delta（主键区间对齐）。</li>
<li><strong>多路归并</strong>：顺序扫描，同 key 只保留最新一条；遇到 DELETE 就丢弃。</li>
<li><strong>写新 Base</strong>：全新 <code>.dat/.idx/.col/.del</code> 四件套。</li>
<li><strong>原子切换</strong>：元数据版本号 +1，老文件引用计数减 1，GC 线程 5 min 后物理删除。</li>
</ol>
<p>副作用：</p>
<ul>
<li>CPU 密集 + 读放大（要读旧 Base），但 <strong>查询无阻塞</strong>（快照隔离）。</li>
</ul>
<h3 data-id="heading-6">2.4 读取：点查 / 范围扫都靠“三路归并”</h3>
<p>可见性顺序（从新到旧）：</p>
<pre><code class="hljs">内存 DeltaBuffer → 磁盘 Delta RS → Base RS
</code></pre>
<p>点查流程：</p>
<ol>
<li>PK Index 先定位 &lt;RowSetId, RowId&gt;。</li>
<li>按类型取行：
<ul>
<li>DeltaBuffer → 直接返回。</li>
<li>Delta RS → 读主键索引页解析。</li>
<li>Base RS → 先查 DelVec，bit=1 表示已删，否则返回。<br/>
范围扫：对三路建迭代器 → 小顶堆归并 → 输出最新版本。</li>
</ul>
</li>
</ol>
<p>性能关键：</p>
<ul>
<li>PK Index 全内存，点查 <strong>O(logN)</strong> 毫秒级。</li>
<li>Delta RS 越多，堆归并层数越高 → 范围查询 CPU 飙升；<strong>因此需要 apply</strong>。</li>
</ul>
<h3 data-id="heading-7">2.5 后台维护：DelVec / GC / PIndex 重建</h3>
<ul>
<li><strong>DelVec</strong><br/>
每份 Base 一份位图，apply 时把删除标记合并进新 Base，旧 DelVec 直接扔。</li>
<li><strong>GC</strong><br/>
引用计数为 0 后延迟 5 min 删除，保证正在跑的查询快照不踩空。</li>
<li><strong>PK Index 重建</strong><br/>
老版本：BE 重启要扫 <strong>全量 Base + Delta</strong> 重建 B+ 树，10 亿行≈5 min。<br/>
3.1+：支持 <strong>持久化 pindex 快照</strong>，重启增量恢复，<strong>秒级</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、 dump vs apply 对照表：别再混淆！</h2>





























<table><thead><tr><th>误区</th><th>真相</th></tr></thead><tbody><tr><td>dump 就是合并</td><td>❌ 只落盘，<strong>不去重</strong> Base</td></tr><tr><td>dump 越频繁越好</td><td>❌ 文件更碎，读放大，IOPS 爆炸</td></tr><tr><td>apply 会锁表</td><td>❌ 快照隔离，<strong>读写无锁</strong></td></tr><tr><td>DelVec 会无限膨胀</td><td>❌ 每次 apply 生成新 Base，旧位图丢弃</td></tr><tr><td>主键表写放大严重</td><td>❌ 写只进内存，<strong>零随机写 Base</strong></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">四、 一张时序图再串一遍（文字版）</h2>
<pre><code class="hljs language-ini" lang="ini">时间轴 ──►
| 写入 ─┐                    ┌─ dump ─┐               ┌─ apply ─┐
|       │ DeltaBuffer        │ 新 Delta RS            │ 新 Base RS
| <span class="hljs-attr">key</span>=<span class="hljs-number">1</span> │ v1 → v2 → v3       │ v3 落盘                │ v3 进 Base
| <span class="hljs-attr">key</span>=<span class="hljs-number">2</span> │ delete             │ delete 标记落盘        │ 丢弃 key=<span class="hljs-number">2</span>
| 查询  │ 看 v3              │ 看 v3                   │ 仍看 v3（无锁切换）
</code></pre>
<h2 data-id="heading-10">五、 总结</h2>
<p>StarRocks 主键表 = <strong>内存 DeltaBuffer + 磁盘 Delta/Base + 内存 PKIndex + DelVec</strong> 四件套：<br/>
<strong>写只进内存，dump 不落基线，apply 真正合并，读三路归并，全程无锁。</strong></p>
<p>把 <strong>dump（落盘） vs apply（合并）</strong> 这条分界线刻进脑子，<br/>
以后任何“UPSERT 延迟高 / 点查毛刺 / 磁盘 IOPS 爆炸”的报警，<br/>
你都能 30 秒内说出根因和参数。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[milvus向量数据库详解与应用实战]]></title>    <link>https://juejin.cn/post/7573776814948237331</link>    <guid>https://juejin.cn/post/7573776814948237331</guid>    <pubDate>2025-11-18T08:15:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573776814948237331" data-draft-id="7573855399716814867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="milvus向量数据库详解与应用实战"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-18T08:15:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            milvus向量数据库详解与应用实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:15:29.000Z" title="Tue Nov 18 2025 08:15:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Milvus 是一款专为人工智能时代设计的<strong>开源向量数据库</strong>，核心使命是高效处理由非结构化数据（如图像、文本、音频、视频）生成的<strong>嵌入向量</strong>，并提供高效的相似性搜索。简单来说，它将非结构化数据转换为计算机可理解的多维向量，并能在海量数据中快速找到最相似的内容 。</p>
<p>下表清晰地展示了Milvus与其他主流向量数据库的核心差异，帮助您理解其独特定位。</p>









































<table><thead><tr><th>数据库名称</th><th>类型</th><th>核心优势</th><th>典型适用场景</th></tr></thead><tbody><tr><td><strong>Milvus</strong>​</td><td>开源/托管</td><td><strong>高性能、可扩展性极强</strong>，支持多种索引和分布式架构</td><td>大规模图像/视频检索、推荐系统、RAG系统</td></tr><tr><td><strong>Pinecone</strong>​</td><td>全托管</td><td><strong>开箱即用，易上手</strong>，无需管理基础设施</td><td>快速原型开发、实时推荐、语义搜索</td></tr><tr><td><strong>ChromaDB</strong>​</td><td>嵌入式</td><td><strong>轻量级，易用</strong>，适合本地开发和轻量级应用</td><td>轻量级AI应用、RAG系统、原型设计</td></tr><tr><td><strong>Weaviate</strong>​</td><td>开源/托管</td><td><strong>支持混合搜索</strong>（向量+关键字），内置模块化设计</td><td>知识图谱、混合搜索应用</td></tr><tr><td><strong>PgVector</strong>​</td><td>PostgreSQL扩展</td><td><strong>与PostgreSQL无缝集成</strong>，可使用标准SQL查询</td><td>已有PostgreSQL基础设施的中小规模AI应用</td></tr></tbody></table>
<h3 data-id="heading-0">🔄 核心工作原理：从数据到结果</h3>
<p>Milvus 的工作流程可以清晰地划分为以下四个关键步骤，下图展示了从数据注入到返回结果的完整路径：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b2af55162d41f68972b1f722b88776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764058528&amp;x-signature=Ez%2Bcnts2KfI3PFphi%2FFejreKFNU%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>
<p><strong>数据向量化</strong>：利用 Embedding 模型（如 BERT、ResNet）将图片、文本等非结构化数据转换为高维向量 。</p>
</li>
<li>
<p><strong>数据存储与索引</strong>：将这些向量及其对应的元数据（如ID、描述）插入Milvus。Milvus会为向量构建高效的索引（如HNSW、IVF_FLAT），将搜索从“大海捞针”变为“查图索骥”，这是实现高速检索的关键 。</p>
</li>
<li>
<p><strong>相似性搜索</strong>：当输入查询（例如一段问题文本）时，先将其转换为查询向量。Milvus会在索引中快速计算该查询向量与库中所有向量的距离（如欧氏距离L2、内积IP） 。</p>
</li>
<li>
<p><strong>返回结果</strong>：最后，根据距离远近（代表相似度高低），返回最相似的若干个向量及其关联的原始数据（如最相关的文档片段）作为结果 。</p>
</li>
</ol>
<h3 data-id="heading-1">🛠️ 实战：构建RAG知识库的核心步骤</h3>
<p>以下是一个使用 Python 构建 RAG 知识库的完整示例。</p>
<h4 data-id="heading-2">步骤一：环境准备与连接</h4>
<p>首先安装必要的库，并初始化 Milvus 客户端。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">from</span> pymilvus import connections, Collection, FieldSchema, CollectionSchema, DataType, utility

<span class="hljs-meta"># 连接到 Milvus 服务器（以单机版为例）</span>
connections.connect(<span class="hljs-keyword">alias</span>=<span class="hljs-string">"default"</span>, host=<span class="hljs-string">'localhost'</span>, port=<span class="hljs-string">'19530'</span>)
</code></pre>
<h4 data-id="heading-3">步骤二：设计数据表（Collection Schema）</h4>
<p>根据你的数据特征定义表结构，例如，一个用于存储知识库文档片段的集合可能需要以下字段：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 定义字段</span>
<span class="hljs-attr">fields</span> = [
    FieldSchema(name=<span class="hljs-string">"id"</span>, dtype=DataType.VARCHAR, is_primary=<span class="hljs-literal">True</span>, max_length=<span class="hljs-number">100</span>),  <span class="hljs-comment"># 主键</span>
    FieldSchema(name=<span class="hljs-string">"doc_id"</span>, dtype=DataType.VARCHAR, max_length=<span class="hljs-number">100</span>),  <span class="hljs-comment"># 文档ID</span>
    FieldSchema(name=<span class="hljs-string">"content"</span>, dtype=DataType.VARCHAR, max_length=<span class="hljs-number">1000</span>),  <span class="hljs-comment"># 文档内容文本</span>
    FieldSchema(name=<span class="hljs-string">"vector"</span>, dtype=DataType.FLOAT_VECTOR, dim=<span class="hljs-number">768</span>)  <span class="hljs-comment"># 向量字段，维度需与模型匹配</span>
]
<span class="hljs-comment"># 创建集合Schema</span>
<span class="hljs-attr">schema</span> = CollectionSchema(fields=fields, description=<span class="hljs-string">"RAG knowledge base collection"</span>)
<span class="hljs-comment"># 创建集合</span>
<span class="hljs-attr">rag_collection</span> = Collection(name=<span class="hljs-string">"rag_kb"</span>, schema=schema)
</code></pre>
<h4 data-id="heading-4">步骤三：配置索引</h4>
<p>为向量字段创建索引是保证高效查询的关键。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 配置索引参数（以IVF_FLAT索引为例）</span>
index_params = {
    <span class="hljs-string">"index_type"</span>: <span class="hljs-string">"IVF_FLAT"</span>,
    <span class="hljs-string">"metric_type"</span>: <span class="hljs-string">"L2"</span>,  <span class="hljs-comment"># 使用欧氏距离作为相似度度量</span>
    <span class="hljs-string">"params"</span>: {<span class="hljs-string">"nlist"</span>: 1024}  <span class="hljs-comment"># 聚类中心数量，值越大，精度越高，搜索越慢</span>
}
<span class="hljs-comment"># 为向量字段创建索引</span>
rag_collection.create_index(field_name=<span class="hljs-string">"vector"</span>, index_params=index_params)
</code></pre>
<h4 data-id="heading-5">步骤四：插入数据</h4>
<p>将文档向量及其元数据存入集合。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 假设 documents 是包含文档文本和对应向量的列表</span>
<span class="hljs-comment"># 示例数据</span>
<span class="hljs-attr">documents</span> = [
    {<span class="hljs-string">"doc_id"</span>: <span class="hljs-string">"doc1"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"机器学习是人工智能的核心领域之一..."</span>, <span class="hljs-string">"vector"</span>: [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, ..., <span class="hljs-number">0.768</span>]},
    {<span class="hljs-string">"doc_id"</span>: <span class="hljs-string">"doc2"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"深度学习是基于神经网络的技术..."</span>, <span class="hljs-string">"vector"</span>: [<span class="hljs-number">0.3</span>, <span class="hljs-number">0.4</span>, ..., <span class="hljs-number">0.768</span>]},
    <span class="hljs-comment"># ... 更多数据</span>
]

<span class="hljs-comment"># 准备插入的数据列表</span>
<span class="hljs-attr">data</span> = [
    [doc[<span class="hljs-string">"doc_id"</span>] for doc in documents],  <span class="hljs-comment"># ID列表，这里简单使用doc_id</span>
    [doc[<span class="hljs-string">"doc_id"</span>] for doc in documents],  <span class="hljs-comment"># 文档ID列表</span>
    [doc[<span class="hljs-string">"content"</span>] for doc in documents],  <span class="hljs-comment"># 内容列表</span>
    [doc[<span class="hljs-string">"vector"</span>] for doc in documents]   <span class="hljs-comment"># 向量列表</span>
]

<span class="hljs-comment"># 插入数据</span>
<span class="hljs-attr">insert_result</span> = rag_collection.insert(data)
rag_collection.flush()  <span class="hljs-comment"># 确保数据被持久化</span>
print(f"已插入 {len(insert_result.primary_keys)} 条数据。")
</code></pre>
<h4 data-id="heading-6">步骤五：执行相似性搜索</h4>
<p>用户查询时，先将其向量化，然后在 Milvus 中搜索。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 加载集合到内存（首次搜索前需要）</span>
rag_collection.load()

<span class="hljs-comment"># 2. 准备搜索参数（需与索引参数匹配）</span>
<span class="hljs-attr">search_params</span> = {<span class="hljs-string">"metric_type"</span>: <span class="hljs-string">"L2"</span>, <span class="hljs-string">"params"</span>: {<span class="hljs-string">"nprobe"</span>: <span class="hljs-number">10</span>}}  <span class="hljs-comment"># nprobe定义搜索的聚类中心数量</span>

<span class="hljs-comment"># 3. 执行搜索（假设 query_vector 是用户查询转换后的向量）</span>
<span class="hljs-attr">results</span> = rag_collection.search(
    <span class="hljs-attr">data</span>=[query_vector],
    <span class="hljs-attr">anns_field</span>=<span class="hljs-string">"vector"</span>,  <span class="hljs-comment"># 在哪个字段上搜索</span>
    <span class="hljs-attr">param</span>=search_params,
    <span class="hljs-attr">limit</span>=<span class="hljs-number">3</span>,  <span class="hljs-comment"># 返回最相似的3个结果</span>
    <span class="hljs-attr">output_fields</span>=[<span class="hljs-string">"id"</span>, <span class="hljs-string">"doc_id"</span>, <span class="hljs-string">"content"</span>]  <span class="hljs-comment"># 指定返回哪些元数据字段</span>
)

<span class="hljs-comment"># 4. 处理结果</span>
for hits in results:
    for hit in hits:
        print(f"ID: {hit.id}, 相似度距离: {hit.distance}")
        print(f"内容: {hit.entity.get('content')}")
        print("---")
</code></pre>
<h3 data-id="heading-7">💡 核心技巧与优化建议</h3>
<ol>
<li>
<p><strong>索引选择策略</strong>：</p>
<ul>
<li>
<p><strong>HNSW</strong>：适用于<strong>高召回率、低延迟</strong>的搜索场景，但内存占用较高 。</p>
</li>
<li>
<p><strong>IVF_FLAT/IVF_PQ</strong>：<strong>平衡精度、内存和速度</strong>的通用选择。IVF_PQ通过量化压缩向量，能显著减少内存占用，适合超大规模数据集，但会带来少量精度损失 。</p>
</li>
<li>
<p><strong>CAGRA</strong>：Milvus 2.4 新增，为<strong>GPU加速</strong>设计，特别适合需要极致性能的生成式AI应用 。</p>
</li>
<li>
<p><strong>FLAT</strong>：<strong>精度100%保证</strong>，适用于数据量小（如万级）或需要绝对精确结果的场景 。</p>
</li>
</ul>
</li>
<li>
<p><strong>性能调优参数</strong>：</p>
<ul>
<li>
<p><strong><code>nlist</code>和 <code>nprobe</code></strong>：在IVF索引中，<code>nlist</code>是聚类中心数，<code>nprobe</code>是搜索时涉及的聚类中心数。增加 <code>nprobe</code>能提高召回率，但会降低搜索速度，需要在两者间权衡 。</p>
</li>
<li>
<p><strong><code>ef</code></strong>：在HNSW索引中，控制搜索深度，值越大，结果越精确，但速度越慢 。</p>
</li>
</ul>
</li>
<li>
<p><strong>数据持久化与高可用</strong>：对于生产环境，务必使用<strong>分布式部署</strong>模式，并依赖 etcd 管理元数据，使用 MinIO 或 SSO作为对象存储，通过 Pulsar 等管理日志，以确保数据可靠和服务高可用 。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ChromaDB详解与应用实战]]></title>    <link>https://juejin.cn/post/7573738017988149291</link>    <guid>https://juejin.cn/post/7573738017988149291</guid>    <pubDate>2025-11-18T08:17:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573738017988149291" data-draft-id="7573776814948253715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ChromaDB详解与应用实战"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-18T08:17:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ChromaDB详解与应用实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:17:04.000Z" title="Tue Nov 18 2025 08:17:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ChromaDB 是一款专为AI应用设计的开源向量数据库，它让机器能够真正“理解”数据的语义，而不仅仅是匹配关键词。下面这张图能帮你快速把握它的核心运作机制：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14812f12de8d4a24852a00ccb004d9af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764058666&amp;x-signature=X9vn3ngfUanfXb5wlqNT8aqEZ%2Bw%3D" alt="image.png" loading="lazy"/></p>
<p>下面，我将带你深入了解如何用它解决实际问题。</p>
<h3 data-id="heading-0">🔄 ChromaDB 核心概念</h3>
<p>理解以下几个关键概念是熟练使用ChromaDB的基础 ：</p>
<ul>
<li>
<p><strong>集合（Collection）</strong> ：类似于关系型数据库中的“表”，是存储相关数据的基本单元。</p>
</li>
<li>
<p><strong>文档（Document）</strong> ：你想要存储和搜索的原始数据本身，比如一段文本。</p>
</li>
<li>
<p><strong>嵌入向量（Embedding）</strong> ：文档经过Embedding模型转换后得到的一串高维数字，代表了其语义特征。这是ChromaDB操作的真正对象。</p>
</li>
<li>
<p><strong>元数据（Metadata）</strong> ：与文档相关的附加信息（如作者、分类、来源），可用于精确过滤。</p>
</li>
<li>
<p><strong>嵌入函数（Embedding Function）</strong> ：负责将文档转换为向量的模型。ChromaDB支持多种内置及自定义模型。</p>
</li>
</ul>
<h3 data-id="heading-1">🛠️ 核心功能与实战应用</h3>
<h4 data-id="heading-2">1. 环境配置与快速开始</h4>
<p>首先安装ChromaDB，并根据你的使用场景选择合适的客户端 ：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 安装</span>
pip install chromadb

<span class="hljs-comment"># 场景1: 实验调试 - 使用内存客户端（数据不保存）</span>
<span class="hljs-attr">client</span> = chromadb.Client()

<span class="hljs-comment"># 场景2: 本地应用 - 使用持久化客户端（数据保存到磁盘）</span>
<span class="hljs-attr">client</span> = chromadb.PersistentClient(path=<span class="hljs-string">"./chroma_db"</span>)

<span class="hljs-comment"># 场景3: 生产环境 - 连接远程服务器 </span>
<span class="hljs-comment"># 首先用 Docker 启动服务端: docker run -p 8000:8000 chromadb/chroma</span>
<span class="hljs-attr">client</span> = chromadb.HttpClient(host=<span class="hljs-string">'localhost'</span>, port=<span class="hljs-number">8000</span>)
</code></pre>
<h4 data-id="heading-3">2. 创建集合并添加数据</h4>
<p>创建一个集合来管理你的数据。关键是选择合适的<strong>嵌入函数（Embedding Function）</strong> ，它直接影响向量化质量和搜索效果 。</p>
<pre><code class="hljs language-ini" lang="ini">import chromadb
from chromadb.utils import embedding_functions

<span class="hljs-comment"># 连接客户端</span>
<span class="hljs-attr">client</span> = chromadb.PersistentClient(path=<span class="hljs-string">"./my_chroma_db"</span>)

<span class="hljs-comment"># 选择嵌入函数 - 以 Sentence Transformer 为例（本地运行，免费）</span>
<span class="hljs-attr">sentence_transformer_ef</span> = embedding_functions.SentenceTransformerEmbeddingFunction(model_name=<span class="hljs-string">"all-MiniLM-L6-v2"</span>)

<span class="hljs-comment"># 创建集合时指定嵌入函数</span>
<span class="hljs-attr">collection</span> = client.get_or_create_collection(
    <span class="hljs-attr">name</span>=<span class="hljs-string">"my_knowledge_base"</span>,
    <span class="hljs-attr">embedding_function</span>=sentence_transformer_ef <span class="hljs-comment"># 指定嵌入函数</span>
)

<span class="hljs-comment"># 准备并添加数据</span>
<span class="hljs-attr">documents</span> = [
    <span class="hljs-string">"ChromaDB是一个开源的向量数据库。"</span>,
    <span class="hljs-string">"熊猫是中国的国宝，主要以竹子为食。"</span>,
    <span class="hljs-string">"大型语言模型（LLM）在自然语言处理中表现出色。"</span>,
    <span class="hljs-string">"北京是中国的首都，是一座历史悠久的城市。"</span>
]
<span class="hljs-attr">metadatas</span> = [
    {<span class="hljs-string">"topic"</span>: <span class="hljs-string">"database"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"tech"</span>},
    {<span class="hljs-string">"topic"</span>: <span class="hljs-string">"animal"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"nature"</span>},
    {<span class="hljs-string">"topic"</span>: <span class="hljs-string">"AI"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"tech"</span>},
    {<span class="hljs-string">"topic"</span>: <span class="hljs-string">"city"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"geography"</span>}
]
<span class="hljs-attr">ids</span> = [<span class="hljs-string">"doc1"</span>, <span class="hljs-string">"doc2"</span>, <span class="hljs-string">"doc3"</span>, <span class="hljs-string">"doc4"</span>]

<span class="hljs-comment"># 添加数据到集合，ChromaDB会自动调用嵌入函数将文档转为向量</span>
collection.add(
    <span class="hljs-attr">documents</span>=documents,
    <span class="hljs-attr">metadatas</span>=metadatas,
    <span class="hljs-attr">ids</span>=ids
)
print("数据添加成功！")
</code></pre>
<h4 data-id="heading-4">3. 执行语义搜索与过滤</h4>
<p>这是ChromaDB的核心能力，它能找到语义上最相近的结果，而不仅仅是关键词匹配。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 基础语义搜索：直接使用自然语言查询</span>
<span class="hljs-attr">results</span> = collection.query(
    <span class="hljs-attr">query_texts</span>=[<span class="hljs-string">"一种吃竹子的动物"</span>], <span class="hljs-comment"># 查询文本是“熊猫”的另一种说法</span>
    <span class="hljs-attr">n_results</span>=<span class="hljs-number">2</span>
)

print("语义搜索结果显示它能理解含义:")
for i, doc in enumerate(results<span class="hljs-section">['documents']</span><span class="hljs-section">[0]</span>):
    print(f"{i+1}. {doc} (ID: {results<span class="hljs-section">['ids']</span><span class="hljs-section">[0]</span><span class="hljs-section">[i]</span>})")
    print(f"   元数据: {results<span class="hljs-section">['metadatas']</span><span class="hljs-section">[0]</span><span class="hljs-section">[i]</span>}")
    print(f"   相似度距离: {results<span class="hljs-section">['distances']</span><span class="hljs-section">[0]</span><span class="hljs-section">[i]</span>:.4f}") <span class="hljs-comment"># 距离越小越相似</span>

<span class="hljs-comment"># 组合过滤查询：语义搜索 + 元数据条件 </span>
print("\n结合元数据过滤后的结果（只搜索技术类文档）:")
<span class="hljs-attr">filtered_results</span> = collection.query(
    <span class="hljs-attr">query_texts</span>=[<span class="hljs-string">"一种开源的数据库技术"</span>],
    <span class="hljs-attr">n_results</span>=<span class="hljs-number">2</span>,
    <span class="hljs-attr">where</span>={<span class="hljs-string">"type"</span>: <span class="hljs-string">"tech"</span>} <span class="hljs-comment"># 元数据过滤条件：只返回 type 为 tech 的文档</span>
)
for i, doc in enumerate(filtered_results<span class="hljs-section">['documents']</span><span class="hljs-section">[0]</span>):
    print(f"{i+1}. {doc}")
</code></pre>
<h4 data-id="heading-5">4. 实战案例：为AI Agent添加长期记忆</h4>
<p>这是一个非常经典的应用场景 。普通的AI对话机器人没有记忆，每次对话都是新的开始。利用ChromaDB，我们可以让它记住之前的对话内容。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentMemory</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, persist_directory=<span class="hljs-string">"./agent_memory"</span></span>):
        self.client = chromadb.PersistentClient(path=persist_directory)
        <span class="hljs-comment"># 使用一个能理解中文的嵌入模型</span>
        self.embedding_function = embedding_functions.SentenceTransformerEmbeddingFunction(model_name=<span class="hljs-string">"paraphrase-multilingual-MiniLM-L12-v2"</span>)
        self.collection = self.client.get_or_create_collection(
            name=<span class="hljs-string">"conversation_history"</span>,
            embedding_function=self.embedding_function
        )
        self._next_id = <span class="hljs-number">1</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">remember</span>(<span class="hljs-params">self, conversation_text, metadata=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""记住一段对话"""</span>
        doc_id = <span class="hljs-string">f"memory_<span class="hljs-subst">{self._next_id}</span>"</span>
        self._next_id += <span class="hljs-number">1</span>
        self.collection.add(
            documents=[conversation_text],
            metadatas=[metadata] <span class="hljs-keyword">if</span> metadata <span class="hljs-keyword">else</span> [{}],
            ids=[doc_id]
        )
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Agent 已记住一段对话 (ID: <span class="hljs-subst">{doc_id}</span>)"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recall_relevant_memories</span>(<span class="hljs-params">self, current_query, n_results=<span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""根据当前问题，回忆相关的历史对话"""</span>
        results = self.collection.query(
            query_texts=[current_query],
            n_results=n_results
        )
        <span class="hljs-keyword">return</span> results

<span class="hljs-comment"># 使用示例</span>
agent_brain = AgentMemory()

<span class="hljs-comment"># 模拟一些历史对话</span>
agent_brain.remember(<span class="hljs-string">"用户昨天说喜欢科幻电影，特别是关于时间旅行的。"</span>, metadata={<span class="hljs-string">"date"</span>: <span class="hljs-string">"2024-11-17"</span>, <span class="hljs-string">"topic"</span>: <span class="hljs-string">"preference"</span>})
agent_brain.remember(<span class="hljs-string">"我们上周讨论过《三体》这本书的黑暗森林法则。"</span>, metadata={<span class="hljs-string">"date"</span>: <span class="hljs-string">"2024-11-10"</span>, <span class="hljs-string">"topic"</span>: <span class="hljs-string">"discussion"</span>})

<span class="hljs-comment"># 今天用户提出了一个新问题</span>
today_question = <span class="hljs-string">"有没有类似《三体》那样有深度设定的电影推荐？"</span>
relevant_memories = agent_brain.recall_relevant_memories(today_question)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"用户当前问题:"</span>, today_question)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\nAgent 回忆起的相关历史对话："</span>)
<span class="hljs-keyword">for</span> i, memory <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(relevant_memories[<span class="hljs-string">'documents'</span>][<span class="hljs-number">0</span>]):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>. <span class="hljs-subst">{memory}</span>"</span>)
</code></pre>
<p>在这个例子中，当你问出新问题时，AI Agent不再是“失忆”的。它会自动从ChromaDB中找出语义上最相关的历史对话，从而给出更具连续性、更个性化的回答。这正是<strong>检索增强生成（RAG）</strong> ​ 系统的核心思想之一 。</p>
<h3 data-id="heading-6">💡 最佳实践与总结</h3>






























<table><thead><tr><th>特性/场景</th><th>推荐做法</th><th>说明</th></tr></thead><tbody><tr><td><strong>嵌入模型选择</strong>​</td><td><strong>起步/本地开发</strong>：<code>all-MiniLM-L6-v2</code> <strong>生产/重质量</strong>：<code>text-embedding-ada-002</code>(OpenAI) <strong>多语言/中文</strong>：<code>text2vec-base-chinese</code></td><td>模型选择直接影响搜索精度，中文应用务必选支持中文的模型。</td></tr><tr><td><strong>元数据设计</strong>​</td><td>提前规划好要记录的字段，如 <code>source</code>, <code>category</code>, <code>author</code>, <code>timestamp</code>。</td><td>丰富的元数据是实现精准过滤和高效管理的关键 。</td></tr><tr><td><strong>部署模式</strong>​</td><td><strong>开发测试</strong>：内存模式或持久化模式 <strong>生产环境</strong>：客户端-服务器模式（如Docker部署）</td><td>生产环境一定要用服务端模式，保证稳定性和可扩展性。</td></tr><tr><td><strong>性能优化</strong>​</td><td>对大规模数据集，可调整HNSW索引参数或在应用层添加缓存策略 。</td><td>根据数据量和性能要求进行调优。</td></tr></tbody></table>
<p><strong>ChromaDB的核心价值</strong>在于，它以一种开发者友好（API简单）且资源友好（轻量级）的方式，将强大的语义搜索能力带给了每一位开发者，极大地降低了构建智能应用的门槛 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python文件类型大全：从.py到.pyd，你见过几种？]]></title>    <link>https://juejin.cn/post/7573669819029209098</link>    <guid>https://juejin.cn/post/7573669819029209098</guid>    <pubDate>2025-11-18T08:16:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573669819029209098" data-draft-id="7573669819029176330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python文件类型大全：从.py到.pyd，你见过几种？"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-18T08:16:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员晚枫"/> <meta itemprop="url" content="https://juejin.cn/user/2327002779758760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python文件类型大全：从.py到.pyd，你见过几种？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2327002779758760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员晚枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:16:22.000Z" title="Tue Nov 18 2025 08:16:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/802ed047c120429a98105172c4ae2d97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5pma5p6r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764058582&amp;x-signature=WlKy41c0uGmX0id4N4%2Bi29rOMvg%3D" alt="image.png" loading="lazy"/></p>
<p>大家好，我是程序员晚枫。</p>
<p>最近有了[AI编程]，Python的热度降低了，我也终于有时间关注一直感兴趣的Python话题，而不是回答Python怎么安装这种入门问题了。</p>
<p>我对于Python兴趣的探索，主要基于两本书：《流畅的Python》、《Python高性能编程》。越深入了解Python高级语法，越能深入理解这门语言设计的精妙之处。</p>
<p>今天我们来聊聊Python世界中那些形形色色的文件类型。</p>
<blockquote>
<p>作为一个Python开发者，你肯定经常跟<code>.py</code>文件打交道。但Python生态中其实还有很多其他重要的文件类型，每种都有其独特的用途。</p>
</blockquote>
<h2 data-id="heading-0">📁 Python核心文件类型</h2>





















































<table><thead><tr><th>文件类型</th><th>主要用途</th><th>是否可读</th><th>生成方式</th></tr></thead><tbody><tr><td><strong>.py</strong></td><td>Python源代码</td><td>✅ 是</td><td>手动创建</td></tr><tr><td><strong>.pyc</strong></td><td>编译后的字节码</td><td>❌ 否</td><td>Python自动生成</td></tr><tr><td><strong>.pyo</strong></td><td>优化后的字节码</td><td>❌ 否</td><td>Python带-O参数生成</td></tr><tr><td><strong>.pyd</strong></td><td>Windows动态链接库</td><td>❌ 否</td><td>Cython/C扩展编译</td></tr><tr><td><strong>.so</strong></td><td>Linux/Mac动态库</td><td>❌ 否</td><td>Cython/C扩展编译</td></tr><tr><td><strong>.pyw</strong></td><td>无控制台Python脚本</td><td>✅ 是</td><td>手动创建</td></tr><tr><td><strong>.pyx</strong></td><td>Cython源代码</td><td>✅ 是</td><td>手动创建</td></tr></tbody></table>
<p>有一些文件类型你可能没见过，有2种原因：</p>
<ul>
<li>你没有这么复杂的工作场景，例如so文件的使用</li>
<li>部分类型被编辑器给自动屏蔽了，例如：pyc文件</li>
</ul>
<h2 data-id="heading-1">🔧 详细解析</h2>
<h3 data-id="heading-2">1. .py - Python源代码文件</h3>
<p>这是最常见的Python文件，包含人类可读的Python代码。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># hello.py</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>!"</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-built_in">print</span>(greet(<span class="hljs-string">"Python开发者: 程序员晚枫"</span>))
</code></pre>
<h3 data-id="heading-3">2. .pyc - 编译字节码文件</h3>
<p>Python解释器将.py文件编译成字节码，加速后续执行。</p>
<p><strong>生成方式</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Python会自动在__pycache__目录生成.pyc文件</span>
python -m py_compile hello.py
</code></pre>
<p><strong>文件结构</strong>：</p>
<ul>
<li>位于<code>__pycache__</code>目录</li>
<li>命名格式：<code>hello.cpython-39.pyc</code></li>
<li>包含Python字节码，不是机器码</li>
</ul>
<h3 data-id="heading-4">3. .pyd - Windows动态链接库</h3>
<p><code>.pyd</code>文件本质上是DLL文件，但可以被Python直接导入。</p>
<blockquote>
<p>这种类型，可以理解为java中的jar包格式，可以打包后给别人使用。</p>
</blockquote>
<p><strong>创建示例</strong>（使用Cython）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 安装Cython</span>
pip install cython

<span class="hljs-comment"># 创建Cython文件</span>
<span class="hljs-comment"># hello.pyx</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">cython_greet</span>(<span class="hljs-params">name</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello from Cython, <span class="hljs-subst">{name}</span>!"</span>

<span class="hljs-comment"># setup.py</span>
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup
<span class="hljs-keyword">from</span> Cython.Build <span class="hljs-keyword">import</span> cythonize

setup(ext_modules=cythonize(<span class="hljs-string">"hello.pyx"</span>))

<span class="hljs-comment"># 编译生成.pyd</span>
python setup.py build_ext --inplace
</code></pre>
<p><strong>使用.pyd文件</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 像普通模块一样导入</span>
<span class="hljs-keyword">import</span> hello
<span class="hljs-built_in">print</span>(hello.cython_greet(<span class="hljs-string">"程序员晚枫"</span>))
</code></pre>
<h3 data-id="heading-5">4. .pyx - Cython源代码文件</h3>
<p>Cython是Python的超集，允许编写C扩展。</p>
<pre><code class="hljs language-cython" lang="cython"># fastmath.pyx
def fibonacci(int n):
    cdef int i
    cdef double a = 0.0, b = 1.0
    for i in range(n):
        a, b = b, a + b
    return a
</code></pre>
<h3 data-id="heading-6">5. .pyw - 无控制台脚本</h3>
<p>在Windows上，<code>.pyw</code>文件运行时不会显示控制台窗口，适合GUI应用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># my_app.pyw</span>
<span class="hljs-keyword">import</span> tkinter <span class="hljs-keyword">as</span> tk

root = tk.Tk()
root.title(<span class="hljs-string">"无控制台应用"</span>)
root.mainloop()
</code></pre>
<h2 data-id="heading-7">📦 包与分发文件</h2>
<h3 data-id="heading-8">包相关文件</h3>

















<table><thead><tr><th>文件类型</th><th>用途</th></tr></thead><tbody><tr><td><strong><strong>init</strong>.py</strong></td><td>包初始化文件（Python 3.3+可选）</td></tr><tr><td><strong><strong>main</strong>.py</strong></td><td>包作为脚本执行时的入口</td></tr></tbody></table>
<h3 data-id="heading-9">分发与安装</h3>

































<table><thead><tr><th>文件类型</th><th>用途</th></tr></thead><tbody><tr><td><strong>.whl</strong></td><td>Python包的分发格式（wheel）</td></tr><tr><td><strong>.egg</strong></td><td>旧版包分发格式</td></tr><tr><td><strong>setup.py</strong></td><td>包安装脚本</td></tr><tr><td><strong>setup.cfg</strong></td><td>包配置</td></tr><tr><td><strong>pyproject.toml</strong></td><td>现代包配置</td></tr><tr><td><strong>requirements.txt</strong></td><td>依赖列表</td></tr></tbody></table>
<h2 data-id="heading-10">🛠️ 配置文件类型</h2>
<h3 data-id="heading-11">项目配置</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># pyproject.toml（现代Python项目）</span>
[build-system]
requires = [<span class="hljs-string">"setuptools"</span>, <span class="hljs-string">"wheel"</span>]

[project]
name = <span class="hljs-string">"my-project"</span>
version = <span class="hljs-string">"0.1.0"</span>

<span class="hljs-comment"># setup.cfg（传统配置）</span>
[metadata]
name = my-project
version = <span class="hljs-number">0.1</span><span class="hljs-number">.0</span>

<span class="hljs-comment"># requirements.txt</span>
requests&gt;=<span class="hljs-number">2.25</span><span class="hljs-number">.0</span>
pandas&gt;=<span class="hljs-number">1.3</span><span class="hljs-number">.0</span>
</code></pre>
<h3 data-id="heading-12">环境与工具配置</h3>

























<table><thead><tr><th>文件类型</th><th>用途</th></tr></thead><tbody><tr><td><strong>.python-version</strong></td><td>pyenv版本文件</td></tr><tr><td><strong>Pipfile</strong></td><td>pipenv依赖管理</td></tr><tr><td><strong>Pipfile.lock</strong></td><td>依赖锁文件</td></tr><tr><td><strong>environment.yml</strong></td><td>conda环境配置</td></tr></tbody></table>
<h2 data-id="heading-13">🔍 特殊用途文件</h2>
<h3 data-id="heading-14">1. .pyi - 存根文件</h3>
<p>用于类型提示，不包含实现代码。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># math.pyi</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sqrt</span>(<span class="hljs-params">x: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-built_in">float</span>: ...
<span class="hljs-keyword">def</span> <span class="hljs-title function_">pow</span>(<span class="hljs-params">x: <span class="hljs-built_in">float</span>, y: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-built_in">float</span>: ...
</code></pre>
<h3 data-id="heading-15">2. .pth - 路径配置文件</h3>
<p>在Python路径中添加自定义路径。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># my_paths.pth</span>
/home/user/my_python_libs
../relative/path/to/modules
</code></pre>
<h3 data-id="heading-16">3. .pyz - 自包含应用</h3>
<p>包含所有依赖的zip应用。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建.pyz文件</span>
python -m zipapp my_app -o app.pyz

<span class="hljs-comment"># 运行</span>
python app.pyz
</code></pre>
<h2 data-id="heading-17">💻 开发工具文件</h2>
<h3 data-id="heading-18">测试相关</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># test_example.py</span>
<span class="hljs-keyword">import</span> pytest

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_addition</span>():
    <span class="hljs-keyword">assert</span> <span class="hljs-number">1</span> + <span class="hljs-number">1</span> == <span class="hljs-number">2</span>

<span class="hljs-comment"># conftest.py（pytest配置）</span>
<span class="hljs-keyword">import</span> pytest

<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sample_data</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"key"</span>: <span class="hljs-string">"value"</span>}
</code></pre>
<h3 data-id="heading-19">代码质量</h3>

























<table><thead><tr><th>文件类型</th><th>用途</th></tr></thead><tbody><tr><td><strong>.pylintrc</strong></td><td>Pylint配置</td></tr><tr><td><strong>.flake8</strong></td><td>Flake8配置</td></tr><tr><td><strong>.coveragerc</strong></td><td>测试覆盖率配置</td></tr><tr><td><strong>.pre-commit-config.yaml</strong></td><td>Git钩子配置</td></tr></tbody></table>
<h2 data-id="heading-20">🎯 实际项目示例</h2>
<p>一个典型的Python项目结构：</p>
<pre><code class="hljs language-css" lang="css">my_project/
├── <span class="hljs-attribute">src</span>/
│   ├── __init__<span class="hljs-selector-class">.py</span>
│   ├── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span>
│   └── utils<span class="hljs-selector-class">.py</span>
├── tests/
│   ├── __init__<span class="hljs-selector-class">.py</span>
│   └── test_main<span class="hljs-selector-class">.py</span>
├── docs/
│   └── conf<span class="hljs-selector-class">.py</span>
├── <span class="hljs-selector-class">.python-version</span>
├── pyproject<span class="hljs-selector-class">.toml</span>
├── requirements<span class="hljs-selector-class">.txt</span>
├── setup<span class="hljs-selector-class">.py</span>
└── README<span class="hljs-selector-class">.md</span>
</code></pre>
<h2 data-id="heading-21">💡 实用技巧</h2>
<h3 data-id="heading-22">1. 查看.pyc文件内容</h3>
<pre><code class="hljs language-bash" lang="bash">python -m dis hello.pyc
</code></pre>
<h3 data-id="heading-23">2. 将Python包编译成.pyd</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用Cython批量编译</span>
<span class="hljs-keyword">from</span> Cython.Build <span class="hljs-keyword">import</span> cythonize
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup, Extension

extensions = [
    Extension(<span class="hljs-string">"my_module"</span>, [<span class="hljs-string">"my_module.pyx"</span>])
]

setup(ext_modules=cythonize(extensions))
</code></pre>
<h3 data-id="heading-24">3. 创建专业的分发包</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># setup.py</span>
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup, find_packages

setup(
    name=<span class="hljs-string">"my-package"</span>,
    version=<span class="hljs-string">"1.0.0"</span>,
    packages=find_packages(),
    install_requires=[
        <span class="hljs-string">"requests&gt;=2.25.0"</span>,
    ],
    entry_points={
        <span class="hljs-string">'console_scripts'</span>: [
            <span class="hljs-string">'my-command=my_package.cli:main'</span>,
        ],
    },
)
</code></pre>
<h2 data-id="heading-25">🚀 性能对比：.py vs .pyd</h2>
<p>在某些场景下，编译成.pyd可以显著提升性能：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 性能测试示例</span>
<span class="hljs-keyword">import</span> timeit

<span class="hljs-comment"># Python版本</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">python_fib</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> n
    <span class="hljs-keyword">return</span> python_fib(n-<span class="hljs-number">1</span>) + python_fib(n-<span class="hljs-number">2</span>)

<span class="hljs-comment"># Cython编译版本（假设已编译为.pyd）</span>
<span class="hljs-keyword">from</span> cython_fib <span class="hljs-keyword">import</span> cython_fib

<span class="hljs-comment"># 测试性能</span>
n = <span class="hljs-number">35</span>
python_time = timeit.timeit(<span class="hljs-keyword">lambda</span>: python_fib(n), number=<span class="hljs-number">1</span>)
cython_time = timeit.timeit(<span class="hljs-keyword">lambda</span>: cython_fib(n), number=<span class="hljs-number">1</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Python: <span class="hljs-subst">{python_time:<span class="hljs-number">.2</span>f}</span>s"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Cython: <span class="hljs-subst">{cython_time:<span class="hljs-number">.2</span>f}</span>s"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"加速比: <span class="hljs-subst">{python_time/cython_time:<span class="hljs-number">.1</span>f}</span>x"</span>)
</code></pre>
<h2 data-id="heading-26">📊 总结</h2>
<p>Python的文件生态系统非常丰富，从源代码到编译文件，从配置到分发，每种文件类型都有其特定用途：</p>
<ul>
<li><strong>开发阶段</strong>：主要使用<code>.py</code>、<code>.pyx</code></li>
<li><strong>运行阶段</strong>：涉及<code>.pyc</code>、<code>.pyd</code>、<code>.so</code></li>
<li><strong>分发阶段</strong>：使用<code>.whl</code>、<code>.egg</code></li>
<li><strong>配置管理</strong>：各种配置文件</li>
</ul>
<p>掌握这些文件类型的特点和用途，能够帮助你更好地组织项目、优化性能和管理依赖。</p>
<hr/>
<p><strong>互动话题</strong>：你在项目中还遇到过哪些特殊的Python文件类型？欢迎在评论区分享你的经验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨域问题深度剖析：为何CORS设置了还是报错？]]></title>    <link>https://juejin.cn/post/7573669819029028874</link>    <guid>https://juejin.cn/post/7573669819029028874</guid>    <pubDate>2025-11-18T07:56:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573669819029028874" data-draft-id="7573710392212881435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨域问题深度剖析：为何CORS设置了还是报错？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-18T07:56:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Function66"/> <meta itemprop="url" content="https://juejin.cn/user/2436173499477623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨域问题深度剖析：为何CORS设置了还是报错？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173499477623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Function66
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T07:56:57.000Z" title="Tue Nov 18 2025 07:56:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题背景</h2>
<p>最近在项目中遇到了一个棘手的跨域问题：B域名的网页被嵌入在A域名内部，B域名的接口请求也出现了跨域错误。尽管后端同学已经配置了<code>Access-Control-Allow-Origin</code>等CORS相关头部，但控制台仍然持续报跨域错误。</p>
<h2 data-id="heading-1">问题排查过程</h2>
<h3 data-id="heading-2">初步排查</h3>
<p>一开始我们按照常规跨域问题的排查思路：</p>
<ul>
<li>检查后端CORS配置是否正确</li>
<li>验证<code>Access-Control-Allow-Origin</code>头是否包含A域名</li>
<li>确认<code>Access-Control-Allow-Credentials</code>设置为true</li>
</ul>
<p>但所有这些配置都正确，问题依然存在。</p>
<h3 data-id="heading-3">深入分析</h3>
<p>经过仔细排查，发现了问题的本质：<strong>B域名没有成功携带A域名的Cookie</strong>，导致请求被服务端的passport权限拦截中间件拦截，从而触发了跨域错误。</p>
<p>这里的关键点是：即使后端正确配置了CORS，如果请求因为权限问题被前端中间件拦截，同样会表现为跨域错误。</p>
<h2 data-id="heading-4">解决方案</h2>
<h3 data-id="heading-5">方案一：种植Cookie方案</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// B页面中的请求处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">makeRequest</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
  
  <span class="hljs-comment">// 关键：添加x-requested-with头，阻止浏览器自动处理302重定向</span>
  xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">'x-requested-with'</span>, <span class="hljs-string">'XMLHttpRequest'</span>);
  
  xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) {
      <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> === <span class="hljs-number">302</span>) {
        <span class="hljs-comment">// 手动处理302重定向</span>
        <span class="hljs-keyword">const</span> redirectUrl = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>;
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">`/sso/logon?redirectUrl=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(redirectUrl)}</span>`</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 正常处理响应</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求成功'</span>, xhr.<span class="hljs-property">responseText</span>);
      }
    }
  };
  
  xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/api/data'</span>, <span class="hljs-literal">true</span>);
  xhr.<span class="hljs-title function_">send</span>();
}
</code></pre>
<p><strong>后端配合调整：</strong></p>
<p>java</p>
<pre><code class="hljs language-vbscript" lang="vbscript">// 当检测到x-requested-<span class="hljs-keyword">with</span>头时，不自动重定向
<span class="hljs-keyword">if</span> (<span class="hljs-string">"XMLHttpRequest"</span>.equals(<span class="hljs-built_in">request</span>.getHeader(<span class="hljs-string">"x-requested-with"</span>))) {
    <span class="hljs-built_in">response</span>.setStatus(<span class="hljs-number">302</span>);
    <span class="hljs-built_in">response</span>.setHeader(<span class="hljs-string">"Location"</span>, <span class="hljs-string">""</span>); // 清空或不设置Location头
    // 通过其他方式传递重定向URL，如响应体
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">response</span>.sendRedirect(<span class="hljs-string">"/sso/logon?redirectUrl="</span> + url);
}
</code></pre>
<p><strong>方案缺陷：</strong></p>
<ul>
<li>部分浏览器出于安全策略考虑，禁止跨域名种植Cookie</li>
<li>实现相对复杂，需要前后端协同调整</li>
</ul>
<h3 data-id="heading-6">方案二：同源部署方案（推荐）</h3>
<p>将B页面的模板直接部署到A域名的服务器上，从根本上消除跨域问题。</p>
<p><strong>实施步骤：</strong></p>
<ol>
<li>将B页面的前端资源打包部署到A域名服务</li>
<li>调整路由配置，确保B页面的访问路径在A域名下</li>
<li>更新所有相关的资源引用路径</li>
</ol>
<p>nginx</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Nginx配置示例</span>
server {
    listen 80;
    server_name a-domain.com;
    
    location /b-page/ {
        <span class="hljs-comment"># 代理到B页面服务或直接服务静态资源</span>
        proxy_pass http://b-service/;
        <span class="hljs-comment"># 或者直接服务本地文件</span>
        root /path/to/b-page-static-files;
    }
    
    location /api/ {
        proxy_pass http://b-api-service/;
    }
}
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>彻底解决跨域问题</li>
<li>Cookie自然共享，无需特殊处理</li>
<li>更好的性能和用户体验</li>
</ul>
<h2 data-id="heading-7">技术要点总结</h2>
<h3 data-id="heading-8">1. CORS与Cookie的关系</h3>
<ul>
<li>跨域请求默认不携带Cookie</li>
<li>需要设置<code>withCredentials: true</code>（前端）和<code>Access-Control-Allow-Credentials: true</code>（后端）</li>
<li><code>Access-Control-Allow-Origin</code>不能为<code>*</code>，必须指定具体域名</li>
</ul>
<h3 data-id="heading-9">2. 302重定向的Ajax处理</h3>
<ul>
<li>默认情况下，浏览器会自动处理302重定向，前端无法拦截</li>
<li>通过<code>x-requested-with: XMLHttpRequest</code>头告知后端需要特殊处理</li>
<li>后端据此决定是否让前端手动处理重定向</li>
</ul>
<h3 data-id="heading-10">3. 跨域问题的本质</h3>
<p>跨域问题不仅仅是技术配置问题，更是安全策略的体现。浏览器的同源策略是为了保护用户数据安全。</p>
<h2 data-id="heading-11">经验教训</h2>
<ol>
<li><strong>不要盲目相信错误信息</strong>：跨域错误可能是其他问题的表象</li>
<li><strong>系统化排查</strong>：从前端到后端，从网络到安全策略全面排查</li>
<li><strong>优先选择根本解决方案</strong>：相比各种workaround，从架构层面解决问题更可靠</li>
</ol>
<h2 data-id="heading-12">结语</h2>
<p>跨域问题是前端开发中的常见挑战，理解其背后的原理和浏览器安全策略至关重要。通过这次问题的解决，我们不仅修复了bug，更重要的是加深了对Web安全机制的理解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native 自定义字体导致 Text / TextInput 文本垂直不居中的终极解决方案]]></title>    <link>https://juejin.cn/post/7573968791202381870</link>    <guid>https://juejin.cn/post/7573968791202381870</guid>    <pubDate>2025-11-18T08:10:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573968791202381870" data-draft-id="7573694361474646043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native 自定义字体导致 Text / TextInput 文本垂直不居中的终极解决方案"/> <meta itemprop="keywords" content="React Native,前端"/> <meta itemprop="datePublished" content="2025-11-18T08:10:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="konh"/> <meta itemprop="url" content="https://juejin.cn/user/1345407452197118"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native 自定义字体导致 Text / TextInput 文本垂直不居中的终极解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345407452197118/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    konh
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:10:55.000Z" title="Tue Nov 18 2025 08:10:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">📝 <strong>React Native 自定义字体导致 Text / TextInput 文本垂直不居中的终极解决方案</strong></h2>
<blockquote>
<p>适用<br/>
✔ React Native（0.71+）<br/>
✔ Expo（所有版本）<br/>
✔ iOS + Android<br/>
✔ 自定义字体（TTF / OTF）</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">📌 一、问题背景</h2>
<p>当项目使用自定义字体（从设计师那拿的 TTF/OTF）时，Text 和 TextInput 常会出现这些问题：</p>
<ul>
<li>文字偏上 / 偏下</li>
<li>placeholder 和输入的文字不对齐</li>
<li>lineHeight 设置了但不生效</li>
<li>iOS 看似正常，Android 完全偏</li>
<li>同一个字体在不同组件间高度不一致</li>
</ul>
<p>这些问题在系统字体下不会出现，但是换成自定义字体后几乎必现。</p>
<hr/>
<h2 data-id="heading-2">📌 二、为什么会发生？——关键因素是 <strong>字体度量（Font Metrics）</strong></h2>
<p>每个字体内部都带有一套关键数据：</p>
<ul>
<li><strong>ascent</strong>：字体向上的高度</li>
<li><strong>descent</strong>：字体向下的高度</li>
<li><strong>lineGap</strong>：字体推荐的行间距</li>
<li><strong>unitsPerEm</strong>：字体的“单位体系”，决定比例</li>
<li><strong>baseline</strong>：文字真实摆放的位置</li>
</ul>
<p>React Native 的 Text / TextInput 会根据这些 metrics 来排版文字。</p>
<p>而自定义字体常常存在：</p>
<ul>
<li>ascent 特别高</li>
<li>descent 太大</li>
<li>lineGap &gt; 0（设计师字体常见）</li>
<li>unitsPerEm 不是系统常用的 1000 / 2048</li>
<li>baseline 偏移</li>
</ul>
<p>🔍 <strong>结果：文字在组件内部的位置发生偏移</strong></p>
<p>为什么系统字体没问题？<br/>
因为系统字体（San Francisco / Roboto）对移动端做过特殊优化，而自定义字体没有。</p>
<hr/>
<h2 data-id="heading-3">📌 三、平台差异（非常关键）</h2>
<h4 data-id="heading-4"><strong>iOS：比较宽容</strong></h4>
<ul>
<li>会自动平滑 baseline</li>
<li>会人为修正部分 ascent/descent</li>
<li>所以问题不明显</li>
</ul>
<h4 data-id="heading-5"><strong>Android：非常严格</strong></h4>
<ul>
<li>绝对使用字体真实 fontMetrics</li>
<li>lineHeight 必须由 dev 明确指定</li>
<li>不自动居中 TextInput 文字</li>
</ul>
<p>👉 所以大部分“文字偏上”的问题都出现在 Android。</p>
<hr/>
<h2 data-id="heading-6">📌 四、终极解决方案（按效果排序）</h2>
<hr/>
<h3 data-id="heading-7">✅ <strong>方案 1：为自定义字体设置合理的 lineHeight（最推荐）</strong></h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">&lt;TextInput</span>
  <span class="hljs-string">style={{</span>
    <span class="hljs-attr">fontFamily:</span> <span class="hljs-string">"YourFont"</span><span class="hljs-string">,</span>
    <span class="hljs-attr">fontSize:</span> <span class="hljs-number">16</span><span class="hljs-string">,</span>
    <span class="hljs-attr">lineHeight:</span> <span class="hljs-number">20</span><span class="hljs-string">,</span> <span class="hljs-string">//</span> <span class="hljs-string">常用:</span> <span class="hljs-string">fontSize</span> <span class="hljs-string">*</span> <span class="hljs-number">1.25</span>
  <span class="hljs-string">}}</span>
<span class="hljs-string">/&gt;</span>
</code></pre>
<p>经验公式：</p>
<h4 data-id="heading-8">iOS：</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">lineHeight</span> = fontSize * <span class="hljs-number">1.2</span>
</code></pre>
<h4 data-id="heading-9">Android：</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">lineHeight</span> = fontSize * <span class="hljs-number">1.3</span>
</code></pre>
<p>👉 这是能解决 <strong>90%</strong> 自定义字体问题的方案。</p>
<hr/>
<h3 data-id="heading-10">✅ <strong>方案 2：给 TextInput 外面套一层 View 并控制垂直居中</strong></h3>
<p>因为 TextInput 自己不擅长对齐 —— 尤其是 Android。</p>
<pre><code class="hljs language-less" lang="less">&lt;<span class="hljs-selector-tag">View</span> <span class="hljs-selector-tag">style</span>={{ <span class="hljs-attribute">height</span>: <span class="hljs-number">48</span>, <span class="hljs-attribute">justifyContent</span>: <span class="hljs-string">"center"</span> }}&gt;
  &lt;<span class="hljs-selector-tag">TextInput</span>
    <span class="hljs-selector-tag">style</span>={{
      fontFamily: "YourFont",
      fontSize: 16,
      lineHeight: 20,
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attribute">textAlignVertical</span>: <span class="hljs-string">"center"</span>, <span class="hljs-comment">// Android 必须加</span>
    }}
  /&gt;
&lt;/<span class="hljs-selector-tag">View</span>&gt;
</code></pre>
<p>⚠️ 关键点：</p>
<ul>
<li><strong>padding 必须设为 0</strong>（否则 Android 会额外加）</li>
<li><strong>textAlignVertical=center</strong>（Android 不加就会偏）</li>
</ul>
<hr/>
<h3 data-id="heading-11">✅ <strong>方案 3：统一 placeholder 与文字行高</strong></h3>
<p>React Native 的 placeholder 不跟随文字行高（尤其 Android）。</p>
<p>强制同步：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">placeholderTextColor</span>=<span class="hljs-string">"#888"</span>
</code></pre>
<p>并保持同样高度的 wrapper：</p>
<pre><code class="hljs language-less" lang="less">&lt;<span class="hljs-selector-tag">View</span> <span class="hljs-selector-tag">style</span>={{ <span class="hljs-attribute">height</span>: <span class="hljs-number">48</span>, <span class="hljs-attribute">justifyContent</span>: <span class="hljs-string">"center"</span> }}&gt;
  &lt;<span class="hljs-selector-tag">TextInput</span>
    <span class="hljs-comment">// same styles as above</span>
  /&gt;
&lt;/<span class="hljs-selector-tag">View</span>&gt;
</code></pre>
<hr/>
<h3 data-id="heading-12">🔧 <strong>方案 4（重量但最彻底）：修复字体文件的 metrics</strong></h3>
<p>如果一个字体怎么调都不对齐，那它就是 <em>本身度量有问题</em>。</p>
<p>可以用字体编辑器修：</p>
<ul>
<li>FontForge（免费）</li>
<li>Glyphs（macOS）</li>
<li>FontTools（CLI）</li>
</ul>
<p>需要修的字段：</p>
<ol>
<li>ascent → 调整到合理比例</li>
<li>descent → 调整到合理比例</li>
<li>lineGap → 设为 0（移动端最佳实践）</li>
<li>unitsPerEm → 1000 或 2048（常用规范）</li>
</ol>
<p>导出后 RN 的 Text/TextInput 高度立即正常。</p>
<hr/>
<h2 data-id="heading-13">📌 五、最佳实践组件（可直接复制到项目）</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Platform</span>, <span class="hljs-title class_">View</span>, <span class="hljs-title class_">TextInput</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-native"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Input</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">const</span> lineHeight = <span class="hljs-title class_">Platform</span>.<span class="hljs-property">OS</span> === <span class="hljs-string">"android"</span> ? <span class="hljs-number">22</span> : <span class="hljs-number">20</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> <span class="hljs-attr">48</span>, <span class="hljs-attr">justifyContent:</span> "<span class="hljs-attr">center</span>" }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TextInput</span>
        {<span class="hljs-attr">...props</span>}
        <span class="hljs-attr">style</span>=<span class="hljs-string">{[</span>
          {
            <span class="hljs-attr">fontFamily:</span> "<span class="hljs-attr">YourFont</span>",
            <span class="hljs-attr">fontSize:</span> <span class="hljs-attr">16</span>,
            <span class="hljs-attr">lineHeight</span>,
            <span class="hljs-attr">padding:</span> <span class="hljs-attr">0</span>,
            <span class="hljs-attr">textAlignVertical:</span> "<span class="hljs-attr">center</span>",
          },
          <span class="hljs-attr">props.style</span>,
        ]}
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-14">📌 六、快速判断是哪种问题（排查表）</h2>








































<table><thead><tr><th>现象</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td>文字偏上</td><td>ascent 太大</td><td>增加 lineHeight</td></tr><tr><td>placeholder 偏位置</td><td>TextInput baseline 变化</td><td>包 wrapper</td></tr><tr><td>Android 完全不对齐</td><td>不支持自动 baseline</td><td>加 textAlignVertical</td></tr><tr><td>iOS 正常、Android 不正常</td><td>Android 用真实 metrics</td><td>统一 lineHeight</td></tr><tr><td>不同设备看起来不一样</td><td>字体 degree scaling 不一致</td><td>wrapper + lineHeight</td></tr><tr><td>怎么调都不对</td><td>字体文件本身错误</td><td>修字体 metrics</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">📌 七、总结</h2>
<p>React Native 使用自定义字体后高度/对齐异常 <strong>不是 RN 的 bug</strong>，而是：</p>
<ul>
<li>自定义字体度量不规范</li>
<li>RN 必须遵守字体真实 metrics</li>
<li>Android 更严格</li>
<li>TextInput 本身对行高处理简单</li>
</ul>
<p>最有效的办法是：</p>
<ol>
<li><strong>统一 lineHeight</strong></li>
<li><strong>外包 wrapper</strong></li>
<li><strong>Android 加 textAlignVertical=center</strong></li>
<li>不行就 <strong>修字体度量</strong></li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解析视觉：大脑如何“辨别”美丑？]]></title>    <link>https://juejin.cn/post/7573738017988247595</link>    <guid>https://juejin.cn/post/7573738017988247595</guid>    <pubDate>2025-11-18T08:31:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573738017988247595" data-draft-id="7573855399716716563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解析视觉：大脑如何“辨别”美丑？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-18T08:31:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Juchecar"/> <meta itemprop="url" content="https://juejin.cn/user/284133851925070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解析视觉：大脑如何“辨别”美丑？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/284133851925070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Juchecar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:31:15.000Z" title="Tue Nov 18 2025 08:31:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一个比识别色彩、形状更深层、更复杂的问题，它触及了神经科学、心理学、进化生物学甚至哲学的交叉领域。大脑并没有一个专门的“美丑中心”，而是通过一个动态的、多层次的<strong>评估系统</strong>来综合判断美丑。</p>
<p>这个系统可以概括为三个主要层面的交互作用：</p>
<h3 data-id="heading-0">层面一：生物学与进化本能——“硬连线”的偏好</h3>
<p>这是我们与生俱来的审美基础，源于进化中对生存和繁衍有利的特质的偏好。</p>
<ol>
<li>
<p><strong>对称性</strong>：</p>
<ul>
<li><strong>为什么美？</strong> 在自然界中，身体对称性通常是发育健康、基因优良、抗病能力强的一个标志。不对称可能意味着疾病或基因缺陷。因此，我们的大脑会无意识地被对称的脸庞和身体所吸引。</li>
<li><strong>证据</strong>：大量研究表明，无论是人脸还是动物，人们普遍认为对称的个体更具吸引力。</li>
</ul>
</li>
<li>
<p><strong>平均化</strong>：</p>
<ul>
<li><strong>为什么美？</strong> “平均”的面孔意味着基因多样性、远离极端特征，从而预示着更稳定、更健康的基因。计算机合成的、将多张面孔融合而成的“平均脸”通常被认为比任何一张原始照片都更具吸引力。</li>
<li><strong>证据</strong>：这个现象在跨文化研究中都得到了验证，说明它是一种普遍的本能。</li>
</ul>
</li>
<li>
<p><strong>清晰肤色与特定腰臀比（女性）/肩腰比（男性）</strong>：</p>
<ul>
<li><strong>为什么美？</strong> 光滑、洁净的皮肤是健康和年轻的重要信号。对于女性，0.7左右的腰臀比被视为生育能力强的标志；对于男性，倒三角形的身材（肩宽腰细）则象征着力量和健康。</li>
<li><strong>证据</strong>：这些偏好具有跨文化的一致性，强烈暗示了其进化根源。</li>
</ul>
</li>
<li>
<p><strong>特定环境偏好</strong>：</p>
<ul>
<li><strong>为什么美？</strong> 我们祖先赖以生存的环境塑造了我们对风景的审美。我们本能地喜欢有水源、开阔的草原、散落的树木（可提供庇护）和一定视野的风景，因为这样的环境能提供生存所需的资源和安全。</li>
<li><strong>证据</strong>：这类风景画和公园设计普遍让人感到愉悦和放松。</li>
</ul>
</li>
</ol>
<p><strong>小结：</strong> 这个层面是<strong>快速、自动、无意识</strong>的，主要由大脑的奖赏系统（如腹侧被盖区、伏隔核）在接收到这些“好信号”后释放多巴胺，让我们产生愉悦感，从而定义为“美”。</p>
<hr/>
<h3 data-id="heading-1">层面二：文化与学习——“软件”的塑造</h3>
<p>如果说生物学本能是硬件，那么文化就是安装在上面的软件，它深刻影响着我们认为什么是美的。</p>
<ol>
<li>
<p><strong>社会规范与时尚</strong>：</p>
<ul>
<li><strong>如何影响？</strong> 不同文化、不同时代对美的标准差异巨大。比如，唐代以胖为美，而现代多以瘦为美；某些部落以长脖子、厚唇盘为美。这些标准通过媒体、艺术和社交不断强化，内化为我们个人的审美。</li>
<li><strong>大脑机制</strong>：这个过程涉及到<strong>前额叶皮层</strong>（负责社会认知、理解和内化规则）和<strong>镜像神经元系统</strong>（帮助我们模仿和学习他人的偏好）。</li>
</ul>
</li>
<li>
<p><strong>熟悉度与曝光效应</strong>：</p>
<ul>
<li><strong>如何影响？</strong> 我们倾向于喜欢自己熟悉的事物。仅仅因为反复看到某个面孔、某种设计风格，我们就会对它产生更积极的情感。这就是为什么我们常常会觉得“越看越顺眼”。</li>
<li><strong>大脑机制</strong>：曝光效应降低了大脑<strong>杏仁核</strong>（与恐惧和不确定性相关）的反应，从而增加了舒适感和偏好。</li>
</ul>
</li>
<li>
<p><strong>知识与背景故事</strong>：</p>
<ul>
<li><strong>如何影响？</strong> 了解一个艺术品背后的故事、创作背景、技术难度，会极大地影响我们对它的审美判断。一个看似简单的现代艺术作品，一旦你知道它蕴含的深刻理念，可能会瞬间觉得它“美”了起来。</li>
<li><strong>大脑机制</strong>：这涉及到<strong>高级认知区域</strong>的深度介入，将理性知识转化为情感体验。</li>
</ul>
</li>
</ol>
<p><strong>小结：</strong> 文化层面是<strong>灵活、可变的</strong>，它解释了为什么审美具有多样性和时代性。</p>
<hr/>
<h3 data-id="heading-2">层面三：个体经验与情感——“私人定制”的滤镜</h3>
<p>这是最个人化的层面，将美与我们的自身经历和情感紧密相连。</p>
<ol>
<li>
<p><strong>情感关联</strong>：</p>
<ul>
<li><strong>如何影响？</strong> 我们会对与美好回忆相关联的人、物、地方产生特殊的审美偏好。比如，一首老歌因为关联着你的初恋而变得无比动听；一个旧物件因为承载着家乡的记忆而显得格外珍贵。</li>
<li><strong>大脑机制</strong>：<strong>海马体</strong>（记忆中心）和<strong>杏仁核</strong>（情绪中心）与奖赏系统强烈互动，为中性刺激赋予了积极的情感价值。</li>
</ul>
</li>
<li>
<p><strong>性格与价值观</strong>：</p>
<ul>
<li><strong>如何影响？</strong> 一个追求刺激的人可能觉得极限运动很美，而一个性格恬静的人可能觉得静谧的山水很美。我们的内在性格决定了我们被何种特质吸引。</li>
<li><strong>大脑机制</strong>：这与个人的神经递质基础（如多巴胺水平）和大脑活动的整体模式有关。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">总结：大脑如何“辨别”美丑？</h3>
<p>这个过程是一个精彩的<strong>神经交响乐</strong>：</p>
<ol>
<li><strong>感知输入</strong>：视觉、听觉等信息进入大脑。</li>
<li><strong>特征处理</strong>：在视觉皮层等区域进行基础处理（如识别形状、颜色）。</li>
<li><strong>多系统评估</strong>：信息被同时发送到多个脑区进行评估：
<ul>
<li><strong>奖赏系统</strong>：评估其生物学价值（“它看起来健康吗？”）。</li>
<li><strong>前额叶皮层</strong>：评估其文化和社会意义（“它符合潮流和规范吗？”）。</li>
<li><strong>记忆与情绪系统</strong>：评估其个人情感价值（“它对我有特殊意义吗？”）。</li>
</ul>
</li>
<li><strong>达成共识与产生体验</strong>：当这些系统给出的积极信号足够强大且协调一致时，大脑就会产生一种<strong>愉悦、吸引、沉浸</strong>的体验——这就是我们所说的“美”的感觉。反之，如果信号是消极的（如不对称、不熟悉、引发坏回忆），我们就会感到“丑”或不悦。</li>
</ol>
<p><strong>一个关键现象：“丑”为何有时也吸引人？</strong></p>
<p>有时，一个对象可能违反了本能层面的“美”（比如怪异的艺术），但却在文化或个体层面引发了强烈的兴趣和深度思考。这种认知上的挑战和解决，本身也能激活奖赏系统，产生一种不同于纯粹“漂亮”的、更复杂的审美体验。</p>
<p>因此，辨别美丑，是大脑将<strong>本能、教养和自我</strong>三者融合后，所做的一个瞬间的、整体的情感判断。它既是普遍的，又是最私密的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 响应式原理：从零实现 Reactive]]></title>    <link>https://juejin.cn/post/7573694361474793499</link>    <guid>https://juejin.cn/post/7573694361474793499</guid>    <pubDate>2025-11-18T08:32:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573694361474793499" data-draft-id="7572961448537571355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 响应式原理：从零实现 Reactive"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-18T08:32:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云枫晖"/> <meta itemprop="url" content="https://juejin.cn/user/835284567331021"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 响应式原理：从零实现 Reactive
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/835284567331021/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云枫晖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:32:36.000Z" title="Tue Nov 18 2025 08:32:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>还记得第一次使用 Vue 时的那种惊艳吗？数据变了，视图自动更新，就像魔法一样！但作为一名有追求的前端开发者，我们不能只停留在"会用"的层面，更要深入理解背后的原理。</p>
<p>今天，我将带你从零实现一个 Vue3 的响应式系统，<strong>手写代码不到 200 行</strong>，却能覆盖核心原理。读完本文，你将彻底明白：</p>
<ul>
<li>🤔 <strong>为什么 Vue3 放弃 Object.defineProperty 选择 Proxy？</strong></li>
<li>🔥 <strong>依赖收集和触发更新的精妙设计</strong></li>
<li>🎯 <strong>数组方法的重写背后隐藏的智慧</strong></li>
<li>💡 <strong>Vue3 响应式相比 Vue2 的性能优势</strong></li>
</ul>
<h2 data-id="heading-1">什么是响应式？</h2>
<p>简单来说，响应式是<strong>当数据变化时，自动执行依赖数据的代码</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> });
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`count值变化：<span class="hljs-subst">${state.count}</span>`</span>);
});
state.<span class="hljs-property">count</span>++; <span class="hljs-comment">// count值变化：1</span>
state.<span class="hljs-property">count</span>++; <span class="hljs-comment">// count值变化：2</span>
</code></pre>
<h3 data-id="heading-2">vue2和vue3响应式区别</h3>






























<table><thead><tr><th>特性</th><th>vue2(Object.defineProperty)</th><th>vue3(proxy)</th></tr></thead><tbody><tr><td>对象新增属性</td><td>$set api实现响应式</td><td>直接支持</td></tr><tr><td>对象删除属性</td><td>$delete api 实现响应式</td><td>直接支持</td></tr><tr><td>数组拦截</td><td>改写数组原型方法</td><td>原生支持，重新包装</td></tr><tr><td>性能</td><td>递归遍历所有属性</td><td>懒代理，访问时才代理</td></tr></tbody></table>
<p>综上所述Proxy的优势非常的明显，这就是Vue3选择重构响应式系统的根本原因。</p>
<h2 data-id="heading-3">手写实现：从零构建响应式</h2>
<h3 data-id="heading-4">1. 项目结构</h3>
<pre><code class="hljs language-text" lang="text">├── reactive.js           // reactive 核心
├── effect.js             // 副作用管理
├── baseHandler.js        // Proxy 处理器
├── arrayInstrumentations.js // 数组方法重写
├── utils.js              // 工具函数
└── index.js              // 入口文件
</code></pre>
<h2 data-id="heading-5">响应式入口</h2>
<p>我们先从<code>reactive</code>函数着手，使用过<code>vue3</code>应该对<code>reactive</code>并不陌生。此函数接收一个对象，然后返回一个代理对象。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// reactive.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">target</span>) {
  <span class="hljs-comment">// 判断target是否一个对象</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isObject</span>(target)) {
    <span class="hljs-keyword">return</span> target;
  }
  <span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
      <span class="hljs-comment">// 后续收集依赖</span>
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
      <span class="hljs-keyword">const</span> oldValue = target[key];
      <span class="hljs-keyword">if</span> (oldValue != value) {
        <span class="hljs-comment">// 后续触发更新</span>
      }
    }
  })
  <span class="hljs-keyword">return</span> proxy;
}
</code></pre>
<p>目前已经搭建了<code>reactive</code>函数的框架，但是目前还有些问题：</p>
<ol>
<li>同一个对象代理多次，会返回不同的代理对象，这样性能上带来不必要的开销。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> originalObj = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Vue'</span>, <span class="hljs-attr">version</span>: <span class="hljs-number">3</span> }; <span class="hljs-comment">// 第一次调用 reactive </span>
<span class="hljs-keyword">const</span> proxy1 = <span class="hljs-title function_">reactive</span>(originalObj); <span class="hljs-comment">// 第二次调用 reactive（传入同一个对象)</span>
<span class="hljs-keyword">const</span> proxy2 = <span class="hljs-title function_">reactive</span>(originalObj); <span class="hljs-comment">// 验证两个代理是同一个实例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(proxy1 === proxy2); <span class="hljs-comment">// false</span>
</code></pre>
<p>可以通过缓存代理对象解决此类问题，采用<code>WeakMap</code>来缓存代理对象，<code>key</code>为<code>target</code>,<code>value</code>为代理对象。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 缓存代理对象，避免重复代理</span>
<span class="hljs-keyword">const</span> reactiveMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">target</span>) {
  <span class="hljs-comment">// 判断target是否一个对象</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isObject</span>(target)) {
    <span class="hljs-keyword">return</span> target;
  }
  <span class="hljs-comment">// 将target是否已经代理过，如果代理则返回缓存的代理对象。</span>
  <span class="hljs-keyword">const</span> existsProxy = reactiveMap.<span class="hljs-title function_">get</span>(target);
  <span class="hljs-keyword">if</span> (existsProxy) {
    <span class="hljs-keyword">return</span> existsProxy;
  }
  <span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, {
    <span class="hljs-comment">/* 此处暂时省略 */</span>
  })
  <span class="hljs-comment">// 缓存代理对象</span>
  reactiveMap.<span class="hljs-title function_">set</span>(target, proxy);
  <span class="hljs-keyword">return</span> proxy;
}
</code></pre>
<blockquote>
<p>💡 提示 <br/>
在上述代码中之所以采用<code>WeakMap</code>主要考虑<code>key</code>是一个对象并且<code>WeakMap</code>可以当<code>target</code>不再引用时会自动清理。</p>
</blockquote>
<ol start="2">
<li>当已经被<code>reactive</code>处理后，再次调用<code>reactive</code>时，又被代理。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> originalObj = { <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> }; <span class="hljs-comment">// 第一次创建响应式对象 </span>
<span class="hljs-keyword">const</span> proxy1 = <span class="hljs-title function_">reactive</span>(originalObj);
<span class="hljs-keyword">const</span> proxy2 = <span class="hljs-title function_">reactive</span>(proxy1); <span class="hljs-comment">// 将代理对象再次代理</span>
</code></pre>
<p>在<code>Vue3</code>的源码中通过<code>__v_isReactive</code>标记来判断：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ReactiveFlags</span> = {
  <span class="hljs-attr">IS_REACTIVE</span>: <span class="hljs-string">"__v_isReactive"</span>,
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">target</span>) {
  <span class="hljs-comment">// 判断target是否一个对象</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isObject</span>(target)) {
    <span class="hljs-keyword">return</span> target;
  }
  <span class="hljs-comment">// 避免重复代理</span>
  <span class="hljs-keyword">if</span> (target[<span class="hljs-title class_">ReactiveFlags</span>.<span class="hljs-property">IS_REACTIVE</span>]) {
    <span class="hljs-keyword">return</span> target;
  }
  <span class="hljs-comment">// 将target是否已经代理过，如果代理则返回缓存的代理对象。</span>
  <span class="hljs-keyword">const</span> existsProxy = reactiveMap.<span class="hljs-title function_">get</span>(target);
  <span class="hljs-keyword">if</span> (existsProxy) {
    <span class="hljs-keyword">return</span> existsProxy;
  }
  <span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
      <span class="hljs-keyword">if</span> (key === <span class="hljs-title class_">ReactiveFlags</span>.<span class="hljs-property">IS_REACTIVE</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    },
    <span class="hljs-comment">/* 此处暂时省略 */</span>
  })
  <span class="hljs-comment">// 缓存代理对象</span>
  reactiveProxy.<span class="hljs-title function_">set</span>(target, proxy);
  <span class="hljs-keyword">return</span> proxy;
}
</code></pre>
<ul>
<li>当第一次调用<code>reactive</code>时，检查<code>target</code>中是否已经存在<code>__v_isReactive</code>标记，正常情况下是<code>undefined</code>，返回一个<code>Proxy</code>代理对象。</li>
<li>如果将返回的<code>Proxy</code>代理对象，再次调用<code>reactive</code>函数，再次检查<code>__v_isReactive</code>是否存在，将会进入<code>Proxy</code>代理对象的<code>get</code>方法中，进入判断返回<code>true</code>。从而达到无论将相同代理对象调用多少次<code>reactive</code>都不会产生多层代理对象嵌套。</li>
</ul>
<p>在<code>Vue3</code>中<code>get</code>和<code>set</code>包裹的对象是抽离到一个单独的文件<code>baseHandlers</code>中的，我们也进行相同调整：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// baseHandlers.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ReactiveFlags</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./reactive"</span>; 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mutableHandlers = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
    <span class="hljs-comment">// 1. 响应式标识判断（Vue3 源码标准逻辑）</span>
    <span class="hljs-keyword">if</span> (key === <span class="hljs-title class_">ReactiveFlags</span>.<span class="hljs-property">IS_REACTIVE</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-comment">/* 后续实现依赖收集 */</span>
  },

  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
    <span class="hljs-keyword">const</span> oldValue = target[key];
    <span class="hljs-keyword">if</span> (oldValue !== value) {
     <span class="hljs-comment">// 后续触发更新</span>
    }
  },
};
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// reactive.js</span>
<span class="hljs-keyword">import</span> { mutableHandlers } <span class="hljs-keyword">from</span> <span class="hljs-string">"./baseHandler.js"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ReactiveFlags</span> = {
  <span class="hljs-attr">IS_REACTIVE</span>: <span class="hljs-string">"__v_isReactive"</span>,
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">target</span>) {
  <span class="hljs-comment">// 判断target是否一个对象</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isObject</span>(target)) {
    <span class="hljs-keyword">return</span> target;
  }
  <span class="hljs-comment">// 避免重复代理</span>
  <span class="hljs-keyword">if</span> (target[<span class="hljs-title class_">ReactiveFlags</span>.<span class="hljs-property">IS_REACTIVE</span>]) {
    <span class="hljs-keyword">return</span> target;
  }
  <span class="hljs-comment">// 将target是否已经代理过，如果代理则返回缓存的代理对象。</span>
  <span class="hljs-keyword">const</span> existsProxy = reactiveMap.<span class="hljs-title function_">get</span>(target);
  <span class="hljs-keyword">if</span> (existsProxy) {
    <span class="hljs-keyword">return</span> existsProxy;
  }
  <span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, mutableHandlers)
  <span class="hljs-comment">// 缓存代理对象</span>
  reactiveProxy.<span class="hljs-title function_">set</span>(target, proxy);
  <span class="hljs-keyword">return</span> proxy;
}
</code></pre>
<h2 data-id="heading-6">副作用管理</h2>
<p>在<code>Vue3</code>中提供了一个<code>effect</code>函数，接收一个函数，提供给用户获取数据渲染视图，数据变化后再次调用该函数更新视图。<code>effect</code>具体实现如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 当前响应器</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> activeEffect;
<span class="hljs-comment">// 清理依赖</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">cleanupEffect</span>(<span class="hljs-params">effect</span>) {
  effect.<span class="hljs-property">deps</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">dep</span>) =&gt;</span> {
    dep.<span class="hljs-title function_">delete</span>(effect);
  });
  effect.<span class="hljs-property">deps</span>.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>;
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveEffect</span> {
  active = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 是否激活状态</span>
  deps = []; <span class="hljs-comment">// 依赖集合数组</span>
  parent = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// 父级effect 处理嵌套effect</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">fn, scheduler</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fn</span> = fn; <span class="hljs-comment">// 用户提供的函数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scheduler</span> = scheduler <span class="hljs-comment">// 调度器（用于computed、watch）</span>
  }
  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">active</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fn</span>();
    }
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 建立effect的父子关系 确保依赖收集的准确性</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span> = activeEffect;
      activeEffect = <span class="hljs-variable language_">this</span>;
      <span class="hljs-comment">// 清除旧依赖 避免不必要的更新</span>
      <span class="hljs-title function_">cleanupEffect</span>(<span class="hljs-variable language_">this</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fn</span>();
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-comment">// 恢复父级effect</span>
      activeEffect = <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parent</span> = <span class="hljs-literal">undefined</span>;
    }
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">effect</span>(<span class="hljs-params">fn, options = {}</span>) {
  <span class="hljs-keyword">const</span> e = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReactiveEffect</span>(fn, options.<span class="hljs-property">scheduler</span>);
  e.<span class="hljs-title function_">run</span>();
  <span class="hljs-comment">// 给到用户自行控制响应</span>
  <span class="hljs-keyword">const</span> runner = e.<span class="hljs-property">run</span>.<span class="hljs-title function_">bind</span>(e); <span class="hljs-comment">// 确保this的指向</span>
  runner.<span class="hljs-property">effect</span> = e;
  <span class="hljs-keyword">return</span> runner;
}
<span class="hljs-comment">// 收集依赖函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">track</span>(<span class="hljs-params">target, key</span>) {}
<span class="hljs-comment">// 触发依赖</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">target, key</span>) {}
</code></pre>
<h3 data-id="heading-7">实现收集依赖</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'jim '</span>});
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'app'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`<span class="hljs-subst">${state.name}</span>`</span>;
})
</code></pre>
<p>当调用<code>effect</code>函数时，将会执行用户提供的函数逻辑，如上述代码执行<code>state.name</code>时将会进入代理对象的<code>get</code>方法，该方法中进行依赖收集。即调用<code>track</code>函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// baseHandler.js</span>
<span class="hljs-keyword">import</span> { isObject } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ReactiveFlags</span>, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">"./reactive"</span>;
<span class="hljs-keyword">import</span> { track } <span class="hljs-keyword">from</span> <span class="hljs-string">"./effect"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mutableHandlers = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
    <span class="hljs-comment">// 响应式标识判断（Vue3 源码标准逻辑）</span>
    <span class="hljs-keyword">if</span> (key === <span class="hljs-title class_">ReactiveFlags</span>.<span class="hljs-property">IS_REACTIVE</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-comment">// 收集依赖（所有属性访问都需要追踪）</span>
    <span class="hljs-title function_">track</span>(target, key);
    <span class="hljs-comment">// 执行原生 get 操作 </span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
    <span class="hljs-comment">// 深层响应式：嵌套对象/数组自动转为响应式（Vue3 懒代理特性）</span>
    <span class="hljs-keyword">if</span> (result &amp;&amp; <span class="hljs-title function_">isObject</span>(result)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reactive</span>(result);
    }

    <span class="hljs-keyword">return</span> result;
  },
  <span class="hljs-comment">/* set方法在此省略 */</span>
};
</code></pre>
<p>在<code>effect.js</code>中<code>track</code>函数中实现依赖收集</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 当前响应器</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> activeEffect;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> targetMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>(); <span class="hljs-comment">//  收集依赖</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">track</span>(<span class="hljs-params">target, key</span>) {
  <span class="hljs-keyword">if</span> (!activeEffect) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">let</span> depsMap = targetMap.<span class="hljs-title function_">get</span>(target);
  <span class="hljs-keyword">if</span> (!depsMap) {
    targetMap.<span class="hljs-title function_">set</span>(target, (depsMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()));
  }
  <span class="hljs-keyword">let</span> dep = depsMap.<span class="hljs-title function_">get</span>(key);
  <span class="hljs-keyword">if</span> (!dep) {
    depsMap.<span class="hljs-title function_">set</span>(key, (dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>())); <span class="hljs-comment">// Vue3内部是一个Dep类</span>
  }
  <span class="hljs-title function_">trackEffects</span>(dep);
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">trackEffects</span>(<span class="hljs-params">dep</span>) {
  <span class="hljs-keyword">let</span> shouldTrack = !dep.<span class="hljs-title function_">has</span>(activeEffect);
  <span class="hljs-keyword">if</span> (shouldTrack) {
    dep.<span class="hljs-title function_">add</span>(activeEffect);
    activeEffect.<span class="hljs-property">deps</span>.<span class="hljs-title function_">push</span>(dep); <span class="hljs-comment">// 双向记录</span>
  }
}
</code></pre>
<p>收集完毕后的依赖关系结构：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">WeakMap</span> {
  <span class="hljs-attr">target1</span>: <span class="hljs-title class_">Map</span> {
    <span class="hljs-attr">key1</span>: <span class="hljs-title class_">Set</span>[effect1, effect2],
    <span class="hljs-attr">key2</span>: <span class="hljs-title class_">Set</span>[effect3]
  },
  <span class="hljs-attr">target2</span>: <span class="hljs-title class_">Map</span> { ... }
}
</code></pre>
<h3 data-id="heading-8">实现触发依赖</h3>
<p>当用户对数据进行了修改时，需要根据收集的依赖自动对应执行<code>effect</code>的用户函数。</p>
<pre><code class="hljs language-js" lang="js">state.<span class="hljs-property">name</span> = <span class="hljs-string">'tom'</span>
</code></pre>
<p>在<code>baseHandle.js</code>中调用<code>trigger</code>函数。该函数实现具体的触发依赖</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// baseHandle.js</span>
<span class="hljs-keyword">import</span> { isObject } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ReactiveFlags</span>, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">"./reactive"</span>;
<span class="hljs-keyword">import</span> { track, trigger } <span class="hljs-keyword">from</span> <span class="hljs-string">"./effect"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mutableHandlers = {
  <span class="hljs-comment">/* get方法实现省略 */</span>
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
    <span class="hljs-keyword">const</span> oldValue = target[key];
    <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
    <span class="hljs-comment">// 7. 只有值变化且是自身属性时，才触发更新（避免原型链干扰）</span>
    <span class="hljs-keyword">if</span> (success &amp;&amp; oldValue !== value) {
      <span class="hljs-title function_">trigger</span>(target, key); <span class="hljs-comment">// 触发依赖</span>
    }
    <span class="hljs-keyword">return</span> success;
  },
};
</code></pre>
<p>在<code>effect.js</code>中实现<code>trigger</code>函数的实现</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 触发依赖</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">target, key</span>) {
  <span class="hljs-keyword">const</span> depsMap = targetMap.<span class="hljs-title function_">get</span>(target);
  <span class="hljs-keyword">if</span> (!depsMap) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">let</span> dep = depsMap.<span class="hljs-title function_">get</span>(key);
  <span class="hljs-keyword">if</span> (dep) <span class="hljs-title function_">triggerEffects</span>(dep);
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">triggerEffects</span>(<span class="hljs-params">dep</span>) {
  <span class="hljs-keyword">const</span> effects = [...dep]; <span class="hljs-comment">// 避免在遍历 Set 过程中修改 Set 本身导致的迭代器异常问题</span>
  effects.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">effect</span>) =&gt;</span> {
    <span class="hljs-comment">// 避免无限递归：当前正在执行的effect不再次触发</span>
    <span class="hljs-keyword">if</span> (effect != activeEffect) {
      <span class="hljs-keyword">if</span> (!effect.<span class="hljs-property">scheduler</span>) {
        effect.<span class="hljs-title function_">run</span>();
      } <span class="hljs-keyword">else</span> {
        effect.<span class="hljs-title function_">scheduler</span>();
      }
    }
  });
}
</code></pre>
<h2 data-id="heading-9">对数组响应式处理</h2>
<p>在<code>Vue3</code>源码中单独一个文件<code>arrayInstrumentations</code>对数组的方法重新包装了一下。我的处理与源码有点不同毕竟是简易版本，但是原理都是一样的</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// arrayInstrumentations.js</span>
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">"./reactive"</span>;
<span class="hljs-keyword">import</span> { trigger } <span class="hljs-keyword">from</span> <span class="hljs-string">"./effect"</span>;
<span class="hljs-keyword">import</span> { isArray } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils"</span>;

<span class="hljs-comment">// 需要特殊处理的数组修改方法（Vue3 源码中也是用 Set 存储）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> arrayInstrumentations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([
  <span class="hljs-string">"push"</span>,
  <span class="hljs-string">"pop"</span>,
  <span class="hljs-string">"shift"</span>,
  <span class="hljs-string">"unshift"</span>,
  <span class="hljs-string">"splice"</span>,
  <span class="hljs-string">"sort"</span>,
  <span class="hljs-string">"reverse"</span>,
]);

<span class="hljs-comment">/**
 * 包装数组修改方法，添加响应式能力
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">method</span> - 数组方法名
 * <span class="hljs-doctag">@returns</span> 包装后的函数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createArrayMethod</span>(<span class="hljs-params">method</span>) {
  <span class="hljs-comment">// 获取原生数组方法</span>
  <span class="hljs-keyword">const</span> originalMethod = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>[method];

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// 1. 执行原生数组方法（保证原有功能不变）</span>
    <span class="hljs-keyword">const</span> result = originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);

    <span class="hljs-comment">// 2. 处理新增元素的响应式转换（push/unshift/splice 可能添加新元素）</span>
    <span class="hljs-keyword">let</span> inserted;
    <span class="hljs-keyword">switch</span> (method) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"push"</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">"unshift"</span>:
        inserted = args; <span class="hljs-comment">// 这两个方法的参数就是新增元素</span>
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"splice"</span>:
        inserted = args.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// splice 第三个参数及以后是新增元素</span>
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-comment">// 新增元素转为响应式（递归处理对象/数组）</span>
    <span class="hljs-keyword">if</span> (inserted) {
      inserted.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> item === <span class="hljs-string">"object"</span> &amp;&amp; item !== <span class="hljs-literal">null</span>) {
          <span class="hljs-title function_">reactive</span>(item);
        }
      });
    }

    <span class="hljs-comment">// 3. 触发依赖更新（Vue3 源码中会触发 length 和对应索引的更新）</span>
    <span class="hljs-title function_">trigger</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">"length"</span>);
    <span class="hljs-keyword">return</span> result;
  };
}

<span class="hljs-comment">// 生成所有包装后的数组方法（键：方法名，值：包装函数）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> arrayMethods = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);
arrayInstrumentations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">method</span>) =&gt;</span> {
  arrayMethods[method] = <span class="hljs-title function_">createArrayMethod</span>(method);
});

<span class="hljs-comment">/**
 * 判断是否是需要拦截的数组方法
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">unknown</span>} <span class="hljs-variable">target</span> - 目标对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">key</span> - 属性名/方法名
 * <span class="hljs-doctag">@returns</span> <span class="hljs-variable">boolean</span>
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isArrayInstrumentation</span>(<span class="hljs-params">target, key</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">isArray</span>(target) &amp;&amp; arrayInstrumentations.<span class="hljs-title function_">has</span>(key);
}
</code></pre>
<p>然后在<code>baseHandler</code>中添加数组情况下的逻辑</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// baseHandler.js</span>
<span class="hljs-keyword">import</span> { isObject } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ReactiveFlags</span>, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">"./reactive"</span>;
<span class="hljs-keyword">import</span> { track, trigger } <span class="hljs-keyword">from</span> <span class="hljs-string">"./effect"</span>;
<span class="hljs-comment">// 引入抽离的数组工具</span>
<span class="hljs-keyword">import</span> { isArrayInstrumentation, arrayMethods } <span class="hljs-keyword">from</span> <span class="hljs-string">"./arrayInstrumentations"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mutableHandlers = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
    <span class="hljs-comment">// 1. 响应式标识判断（Vue3 源码标准逻辑）</span>
    <span class="hljs-keyword">if</span> (key === <span class="hljs-title class_">ReactiveFlags</span>.<span class="hljs-property">IS_REACTIVE</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-comment">// 2. 收集依赖（所有属性访问都需要追踪）</span>
    <span class="hljs-title function_">track</span>(target, key);
    <span class="hljs-comment">// 3. 执行原生 get 操作</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
    <span class="hljs-comment">// 4. 数组方法拦截：如果是需要处理的数组方法，返回包装后的函数</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isArrayInstrumentation</span>(target, key)) {
      <span class="hljs-comment">// 绑定 this 为目标数组，确保原生方法执行时上下文正确</span>
      <span class="hljs-keyword">return</span> arrayMethods[key].<span class="hljs-title function_">bind</span>(target);
    }
    <span class="hljs-comment">// 5. 深层响应式：嵌套对象/数组自动转为响应式（Vue3 懒代理特性）</span>
    <span class="hljs-keyword">if</span> (result &amp;&amp; <span class="hljs-title function_">isObject</span>(result)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reactive</span>(result);
    }

    <span class="hljs-keyword">return</span> result;
  },

  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
    <span class="hljs-keyword">const</span> oldValue = target[key];
    <span class="hljs-keyword">const</span> isArrayTarget = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(target);
    <span class="hljs-comment">// 6. 执行原生 set 操作</span>
    <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
    <span class="hljs-comment">// 7. 只有值变化且是自身属性时，才触发更新（避免原型链干扰）</span>
    <span class="hljs-keyword">if</span> (success &amp;&amp; oldValue !== value) {
      <span class="hljs-comment">// 数组索引设置：触发对应索引和 length 更新（Vue3 源码逻辑）</span>
      <span class="hljs-keyword">if</span> (isArrayTarget &amp;&amp; key !== <span class="hljs-string">"length"</span>) {
        <span class="hljs-keyword">const</span> index = <span class="hljs-title class_">Number</span>(key);
        <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span> &amp;&amp; index &lt; target.<span class="hljs-property">length</span>) {
          <span class="hljs-title function_">trigger</span>(target, key); <span class="hljs-comment">// 触发索引更新</span>
          <span class="hljs-title function_">trigger</span>(target, <span class="hljs-string">"length"</span>); <span class="hljs-comment">// 触发长度更新</span>
          <span class="hljs-keyword">return</span> success;
        }
      }
      <span class="hljs-comment">// 普通对象/数组 length 设置：触发对应 key 更新</span>
      <span class="hljs-title function_">trigger</span>(target, key);
    }
    <span class="hljs-keyword">return</span> success;
  },
};
</code></pre>
<h2 data-id="heading-10">完整代码使用示例</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { reactive, effect } <span class="hljs-keyword">from</span> <span class="hljs-string">"./packages/index"</span>;
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"vue"</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">"3.4.5"</span>,
  <span class="hljs-attr">author</span>: <span class="hljs-string">"vue team"</span>,
  <span class="hljs-attr">friends</span>: [<span class="hljs-string">"jake"</span>, <span class="hljs-string">"james"</span>],
});
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  app.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
    &lt;div&gt; Welcome <span class="hljs-subst">${state.name}</span> !&lt;/div&gt;
    &lt;div&gt; <span class="hljs-subst">${state.friends}</span> &lt;/div&gt;
  `</span>;
});
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  state.<span class="hljs-property">name</span> = <span class="hljs-string">"vue3"</span>; 
  state.<span class="hljs-property">friends</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">"jimmy"</span>);
}, <span class="hljs-number">1000</span>);
<span class="hljs-comment">// 一开始显示:</span>
<span class="hljs-comment">//    Welcome vue </span>
<span class="hljs-comment">//    'jake,james'</span>
<span class="hljs-comment">// 1秒钟后：</span>
<span class="hljs-comment">//    Welcome vue3</span>
<span class="hljs-comment">//    'jake,james,jimmy'</span>
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>通过这 200 行代码，我们实现了一个完整的 Vue3 响应式系统核心：</p>
<ul>
<li>✅ <strong>响应式代理</strong>: 基于 Proxy 的懒代理机制</li>
<li>✅ <strong>依赖收集</strong>: 精准的 effect 追踪</li>
<li>✅ <strong>批量更新</strong>: 避免重复执行的调度机制</li>
<li>✅ <strong>数组处理</strong>: 重写数组方法保持响应性</li>
<li>✅ <strong>嵌套支持</strong>: 自动的深层响应式转换</li>
</ul>
<p><strong>完整代码和资源</strong>
本文所有代码已开源，包含详细注释和测试用例：</p>
<p><strong>GitHub 仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgardenia83%2Fvue-source-code.git" target="_blank" title="https://github.com/gardenia83/vue-source-code.git" ref="nofollow noopener noreferrer">github.com/gardenia83/…</a></strong></p>
<p>这为我们理解 Vue3 的响应式原理提供了坚实的基础，也为学习更高级的特性如 computed、watch 等打下了基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用LangSmith追踪智能体运行]]></title>    <link>https://juejin.cn/post/7573687816431353866</link>    <guid>https://juejin.cn/post/7573687816431353866</guid>    <pubDate>2025-11-18T08:18:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573687816431353866" data-draft-id="7573968791202349102" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用LangSmith追踪智能体运行"/> <meta itemprop="keywords" content="Agent,LangChain,Python"/> <meta itemprop="datePublished" content="2025-11-18T08:18:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用LangSmith追踪智能体运行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:18:06.000Z" title="Tue Nov 18 2025 08:18:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">LangSmith简介</h2>
<p>LangSmith提供用于开发、调试和部署大型语言模型（LLM）应用程序的工具。它能帮助你在同一个平台中完成请求追踪、输出评估、提示词测试以及部署管理等操作。
LangSmith不依赖特定框架，因此无论你是否使用LangChain的开源库（langchain和langgraph），都可以正常使用该工具。你可以先在本地进行原型开发，随后无缝过渡到生产环境；同时，借助其集成的监控与评估功能，能够构建出更可靠的人工智能系统。</p>
<h2 data-id="heading-1">可观测性（Observability）</h2>
<p>对于使用大模型（LLM）构建的应用程序而言，可观测性（Observability）是一项关键需求。LLM具有非确定性特征，这意味着相同的提示词可能会生成不同的响应。这种特性使得LLM应用的调试与监控工作，比传统软件更具挑战性。</p>
<p>LangSmith为解决这一问题提供了方案：它能让你端到端地掌握应用程序处理请求的完整过程。每一个请求都会生成一条追踪记录（trace），该记录会完整捕捉整个过程中发生的所有事件。一条追踪记录包含多个独立运行单元（runs）—— 即应用程序执行的具体操作，例如一次LLM调用或一个信息检索步骤。通过对这些运行单元进行追踪，你可以检查、调试并验证应用程序的运行行为。</p>
<p>本文将搭建一个最小化的RAG应用程序，并为其添加LangSmith追踪功能。具体操作步骤如下：</p>
<ul>
<li>配置你的环境。</li>
<li>创建一个可检索上下文并调用LLM的应用程序。</li>
<li>启用追踪功能，以同时捕捉检索步骤和LLM调用过程。</li>
<li>在LangSmith界面中查看生成的追踪记录。</li>
</ul>
<h2 data-id="heading-2">准备</h2>
<p>你需要：</p>
<ul>
<li>一个LangSmith账号：可在smith.langchain.com注册或登录。</li>
<li>一个LangSmith API密钥：请参考《创建API密钥指南》操作。</li>
<li>安装langsmith</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">pip install -U langsmith
</code></pre>
<ul>
<li>设置环境变量：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> LANGSMITH_TRACING=<span class="hljs-literal">true</span>
<span class="hljs-built_in">export</span> LANGSMITH_API_KEY=<span class="hljs-string">"&lt;your-langsmith-api-key&gt;"</span>
<span class="hljs-built_in">export</span> LANGSMITH_WORKSPACE_ID=<span class="hljs-string">"&lt;your-workspace-id&gt;"</span>

</code></pre>
<h2 data-id="heading-3">构建智能体应用</h2>
<p>可以使用本步骤中列出的示例应用代码，为一个RAG应用程序添加埋点监测；也可以使用你自己包含大模型调用逻辑的应用代码。</p>
<p>以下是一个最小化的RAG应用程序，它直接使用OpenAI SDK，暂未添加任何LangSmith追踪功能。该应用包含三个核心部分：</p>
<ul>
<li>检索器函数（Retriever function）：模拟文档检索过程，且始终返回相同的字符串。</li>
<li>OpenAI 客户端（OpenAI client）：初始化一个基础的 OpenAI 客户端，用于发送聊天补全请求。</li>
<li>RAG 函数（RAG function）：将检索到的文档与用户的问题结合，构建系统提示词；调用 chat.completions.create() 接口；并返回助手的响应结果。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

<span class="hljs-keyword">def</span> <span class="hljs-title function_">retriever</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-comment"># Minimal example retriever</span>
    <span class="hljs-keyword">return</span> [<span class="hljs-string">"Harrison worked at Kensho"</span>]

<span class="hljs-comment"># OpenAI client call (no wrapping yet)</span>
client = OpenAI()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">rag</span>(<span class="hljs-params">question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    docs = retriever(question)
    system_message = (
        <span class="hljs-string">"Answer the user's question using only the provided information below:\n"</span>
        + <span class="hljs-string">"\n"</span>.join(docs)
    )

    <span class="hljs-comment"># This call is not traced yet</span>
    resp = client.chat.completions.create(
        model=<span class="hljs-string">"gpt-4o-mini"</span>,
        messages=[
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: system_message},
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: question},
        ],
    )
    <span class="hljs-keyword">return</span> resp.choices[<span class="hljs-number">0</span>].message.content

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-built_in">print</span>(rag(<span class="hljs-string">"Where did Harrison work?"</span>))
</code></pre>
<h2 data-id="heading-4">追踪LLM调用</h2>
<p>追踪所有的大模型调用，LangSmith提供了对应的包装器（wrapper）：</p>
<ul>
<li>Python语言：wrap_openai</li>
<li>TypeScript语言：wrapOpenAI</li>
</ul>
<p>此代码片段会对OpenAI客户端进行包装，这样后续每一次模型调用都会被自动记录，并作为LangSmith中一条追踪记录的子运行单元。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> langsmith.wrappers <span class="hljs-keyword">import</span> wrap_openai  <span class="hljs-comment"># traces openai calls</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">retriever</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> [<span class="hljs-string">"Harrison worked at Kensho"</span>]

client = wrap_openai(OpenAI())  <span class="hljs-comment"># log traces by wrapping the model calls</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">rag</span>(<span class="hljs-params">question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    docs = retriever(question)
    system_message = (
        <span class="hljs-string">"Answer the user's question using only the provided information below:\n"</span>
        + <span class="hljs-string">"\n"</span>.join(docs)
    )
    resp = client.chat.completions.create(
        model=<span class="hljs-string">"gpt-4o-mini"</span>,
        messages=[
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: system_message},
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: question},
        ],
    )
    <span class="hljs-keyword">return</span> resp.choices[<span class="hljs-number">0</span>].message.content

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-built_in">print</span>(rag(<span class="hljs-string">"Where did Harrison work?"</span>))
</code></pre>
<h2 data-id="heading-5">追踪整个应用</h2>
<p>你也可以使用traceable装饰器，来追踪整个应用程序，而不只是仅仅追踪大型语言模型的调用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> langsmith.wrappers <span class="hljs-keyword">import</span> wrap_openai
<span class="hljs-keyword">from</span> langsmith <span class="hljs-keyword">import</span> traceable

<span class="hljs-keyword">def</span> <span class="hljs-title function_">retriever</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> [<span class="hljs-string">"Harrison worked at Kensho"</span>]

client = wrap_openai(OpenAI())  <span class="hljs-comment"># keep this to capture the prompt and response from the LLM</span>

<span class="hljs-meta">@traceable</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">rag</span>(<span class="hljs-params">question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    docs = retriever(question)
    system_message = (
        <span class="hljs-string">"Answer the user's question using only the provided information below:\n"</span>
        + <span class="hljs-string">"\n"</span>.join(docs)
    )
    resp = client.chat.completions.create(
        model=<span class="hljs-string">"gpt-4o-mini"</span>,
        messages=[
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: system_message},
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: question},
        ],
    )
    <span class="hljs-keyword">return</span> resp.choices[<span class="hljs-number">0</span>].message.content

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-built_in">print</span>(rag(<span class="hljs-string">"Where did Harrison work?"</span>))
</code></pre>
<h2 data-id="heading-6">追踪LangChain应用</h2>
<ul>
<li>自动追踪</li>
</ul>
<p>LangSmith可与LangChain无缝集成，你只需要配置LangSmith的环境变量，即可自动追踪LangChain应用的运行。</p>
<ul>
<li>选择性跟踪</li>
</ul>
<p>有时候你并不需要追踪智能体所有的行为。你可能希望选择性的追踪一些行为。使用tracing_context上下文管理器可以实现选择性的追踪。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># You can opt-in to specific invocations..</span>
<span class="hljs-keyword">import</span> langsmith <span class="hljs-keyword">as</span> ls

<span class="hljs-keyword">with</span> ls.tracing_context(enabled=<span class="hljs-literal">True</span>):
    chain.invoke({<span class="hljs-string">"question"</span>: <span class="hljs-string">"Am I using a callback?"</span>, <span class="hljs-string">"context"</span>: <span class="hljs-string">"I'm using a callback"</span>})

<span class="hljs-comment"># This will NOT be traced (assuming LANGSMITH_TRACING is not set)</span>
chain.invoke({<span class="hljs-string">"question"</span>: <span class="hljs-string">"Am I being traced?"</span>, <span class="hljs-string">"context"</span>: <span class="hljs-string">"I'm not being traced"</span>})

<span class="hljs-comment"># This would not be traced, even if LANGSMITH_TRACING=true</span>
<span class="hljs-keyword">with</span> ls.tracing_context(enabled=<span class="hljs-literal">False</span>):
    chain.invoke({<span class="hljs-string">"question"</span>: <span class="hljs-string">"Am I being traced?"</span>, <span class="hljs-string">"context"</span>: <span class="hljs-string">"I'm not being traced"</span>})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[俄罗斯Yandex地图实战]]></title>    <link>https://juejin.cn/post/7573738017988165675</link>    <guid>https://juejin.cn/post/7573738017988165675</guid>    <pubDate>2025-11-18T08:18:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573738017988165675" data-draft-id="7573588675638345743" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="俄罗斯Yandex地图实战"/> <meta itemprop="keywords" content="API,Vue.js"/> <meta itemprop="datePublished" content="2025-11-18T08:18:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jason_yang"/> <meta itemprop="url" content="https://juejin.cn/user/2972704795802653"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            俄罗斯Yandex地图实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2972704795802653/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jason_yang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:18:29.000Z" title="Tue Nov 18 2025 08:18:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    33
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>由于地域限制，一般在俄语区只能使用Yandex做地图展示，这里介绍yandex 常用的一些api</p>
<blockquote>
<p>由于很多资料和ai都是2.1的版本，故此选择了较老的版本2.1做开发，最新更新到v3的版本</p>
</blockquote>
<h2 data-id="heading-0">1.初始化</h2>
<p>引入资源</p>
<pre><code class="hljs language-js" lang="js">&lt;script src=<span class="hljs-string">"https://api-maps.yandex.ru/2.1/?lang=zh_CN&amp;onload=initMap"</span> defer&gt;&lt;/script&gt;
 <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"map"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span> 
</code></pre>
<p>初始化</p>
<ul>
<li>第一个参数为div的id</li>
</ul>
<pre><code class="hljs language-js" lang="js">     <span class="hljs-keyword">let</span> map;
     
    <span class="hljs-comment">// 初始化地图</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">initMap</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> mapCenter = [<span class="hljs-number">31.0</span>, <span class="hljs-number">114.0</span>]; <span class="hljs-comment">// 中国中南部，让多个城市可见</span>
      map = <span class="hljs-keyword">new</span> ymaps.<span class="hljs-title class_">Map</span>(<span class="hljs-string">"map"</span>, {
        <span class="hljs-attr">center</span>: mapCenter,
        <span class="hljs-attr">zoom</span>: <span class="hljs-number">5</span>
      });
    } 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d2e31877ffe4cd1a878530c27024d2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=TkVareLnso9gPeyt%2BYtFbzlYaz8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">封装初始化</h3>
<p>为了方便维护，我们封装一下 yandex的初始化。</p>
<p>这里通过动态插入js方式初始化</p>
<blockquote>
<p>注意原来的onload 通过这种方式无法正常触发。可以正常同步方法编写代码即可。如在：<code>map = new (window as any).ymaps.Map(...)</code>初始化后下面接着写需要初始化的逻辑</p>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span> 
     <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-container"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"mapContainer"</span> <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { ref,  onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>   
  <span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
    <span class="hljs-attr">apiKey</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    },
  })  
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)   
  <span class="hljs-keyword">let</span> <span class="hljs-attr">map</span>: any | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>   
  <span class="hljs-keyword">const</span> mapContainer = ref&lt;<span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>) 

  <span class="hljs-comment">// 检查Yandex Maps是否已加载</span>
  <span class="hljs-keyword">const</span> isYandexMapsLoaded = (): <span class="hljs-function"><span class="hljs-params">boolean</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span> !== <span class="hljs-string">'undefined'</span>
  }
 
  <span class="hljs-keyword">const</span> loadYandexMaps = (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-comment">// 检查是否已经加载过</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isYandexMapsLoaded</span>()) {
        <span class="hljs-title function_">resolve</span>()
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-comment">// 创建script标签</span>
      <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>) 
      <span class="hljs-keyword">const</span> apiKey = props.<span class="hljs-property">apiKey</span> <span class="hljs-comment">//  //</span>
      script.<span class="hljs-property">src</span> = <span class="hljs-string">`https://api-maps.yandex.ru/2.1/?apikey=<span class="hljs-subst">${apiKey}</span>&amp;lang=ru_RU`</span>
      script.<span class="hljs-property">type</span> = <span class="hljs-string">'text/javascript'</span>
      script.<span class="hljs-property">defer</span> = <span class="hljs-literal">true</span>

      <span class="hljs-comment">// 加载完成回调</span>
      script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> { 
        ;(<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span>.<span class="hljs-title function_">ready</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-title function_">resolve</span>()
        })
      } 
      script.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load Yandex Maps API'</span>, error)
        <span class="hljs-title function_">reject</span>(error)
      } 
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script)
    })
  } 
  
  <span class="hljs-comment">// 初始化地图</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">initMap</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!mapContainer.<span class="hljs-property">value</span> || !<span class="hljs-title function_">isYandexMapsLoaded</span>()) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">let</span> initLat = <span class="hljs-number">55.751244</span>
    <span class="hljs-keyword">let</span> initLng = <span class="hljs-number">37.618423</span>
    <span class="hljs-keyword">let</span> initZoom = <span class="hljs-number">15</span>
 

    <span class="hljs-comment">// 创建地图实例</span>
    map = <span class="hljs-keyword">new</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span>.<span class="hljs-title class_">Map</span>(mapContainer.<span class="hljs-property">value</span>, {
      <span class="hljs-attr">center</span>: [initLat, initLng], <span class="hljs-comment">// 莫斯科坐标作为默认值</span>
      <span class="hljs-attr">zoom</span>: initZoom,
      <span class="hljs-attr">controls</span>: [<span class="hljs-string">'fullscreenControl'</span>] 
    }) 
    
    <span class="hljs-comment">// 在这里正常写同步的代码</span>
  }

  <span class="hljs-comment">// 组件卸载时清理地图实例</span>
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (map) {
      map.<span class="hljs-title function_">destroy</span>()
      map = <span class="hljs-literal">null</span>
    }
  })
 
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadYandexMaps</span>()  
      <span class="hljs-title function_">initMap</span>() 
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error onMounted:'</span>, error)
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
  })
 
  
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.main-container</span> {
    <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">70px</span>);
  } 
  <span class="hljs-selector-class">.loading</span> {
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#909399</span>;
  }
 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">2.标记</h2>
<h3 data-id="heading-3">系统自带标记</h3>
<ul>
<li>第一个参数为坐标</li>
<li>第二个为弹框内容</li>
</ul>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">const</span> placemark = <span class="hljs-keyword">new</span> ymaps.<span class="hljs-title class_">Placemark</span>(
         [<span class="hljs-number">39.9042</span>, <span class="hljs-number">116.4074</span>],
          { <span class="hljs-attr">balloonContent</span>: <span class="hljs-string">'&lt;h3&gt;北京站点&lt;/h3&gt;&lt;p&gt;这是首都核心站点，功能齐全。&lt;/p&gt;'</span> }, 
        );
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8d00b31ee24434990fdd8c1bd342216~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=Zk6Ral3kOrRcd0JEJtvVtaDkuec%3D" alt="image.png" loading="lazy"/></p>
<p>点击效果
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fb2ddd225fb47a699fe88e87ad2fae1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=AWijn1ce0uY%2FjbvtM6QRAyWFT3k%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">自定义标记图标</h3>
<p>由于自带的图标好丑，一般使用美工设计的icon。</p>
<ul>
<li>通过参数iconLayout 指定渲染类型</li>
<li>通过参数iconImageHref 设置对应的图片</li>
</ul>
<pre><code class="hljs language-js" lang="js">   myPlacemarkWithContent = <span class="hljs-keyword">new</span> ymaps.<span class="hljs-title class_">Placemark</span>(
           [<span class="hljs-number">39.9042</span>, <span class="hljs-number">116.4074</span>],
            {
                <span class="hljs-attr">hintContent</span>: <span class="hljs-string">"A custom placemark icon with contents"</span>,
                <span class="hljs-attr">balloonContent</span>: <span class="hljs-string">"This one — for Christmas"</span>, 
            },
            { 
                <span class="hljs-attr">iconLayout</span>: <span class="hljs-string">"default#imageWithContent"</span>, 
                <span class="hljs-attr">iconImageHref</span>: <span class="hljs-string">"dashboard/local1.png"</span>, <span class="hljs-comment">// 自定义图片</span>
                <span class="hljs-comment">// The size of the placemark.</span>
                <span class="hljs-attr">iconImageSize</span>: [<span class="hljs-number">40</span>, <span class="hljs-number">46</span>], 
                <span class="hljs-attr">iconImageOffset</span>: [-<span class="hljs-number">24</span>, -<span class="hljs-number">24</span>], 
                <span class="hljs-attr">iconContentOffset</span>: [<span class="hljs-number">15</span>, <span class="hljs-number">15</span>],  
            }
        );
        
    map.<span class="hljs-property">geoObjects</span>.<span class="hljs-title function_">add</span>(myPlacemarkWithContent);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86b120666e104c50aa91ab8a0b6c9acd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=RhxnuXu0PX0w63uGO%2FymSDtGgg4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">图标追加信息显示</h3>
<p>通过ymaps.templateLayoutFactory.createClass 我们可以在图标基础上追加信息</p>
<pre><code class="hljs language-js" lang="js">
        <span class="hljs-title class_">MyIconContentLayout</span> = ymaps.<span class="hljs-property">templateLayoutFactory</span>.<span class="hljs-title function_">createClass</span>(
            <span class="hljs-string">'&lt;div style="color: #FFFFFF; font-weight: bold;"&gt;$[properties.iconContent]&lt;/div&gt;'</span>
        ), 
        myPlacemarkWithContent = <span class="hljs-keyword">new</span> ymaps.<span class="hljs-title class_">Placemark</span>(
           [<span class="hljs-number">39.9042</span>, <span class="hljs-number">116.4074</span>],
            {
                <span class="hljs-attr">hintContent</span>: <span class="hljs-string">"A custom placemark icon with contents"</span>,
                <span class="hljs-attr">balloonContent</span>: <span class="hljs-string">"This one — for Christmas"</span>,
                <span class="hljs-attr">iconContent</span>: <span class="hljs-string">"M"</span>,
            },
            { 
                <span class="hljs-attr">iconLayout</span>: <span class="hljs-string">"default#imageWithContent"</span>,
                <span class="hljs-comment">// Custom image for the placemark icon.</span>
                <span class="hljs-attr">iconImageHref</span>: <span class="hljs-string">"dashboard/local1.png"</span>,
                <span class="hljs-comment">// The size of the placemark.</span>
                <span class="hljs-attr">iconImageSize</span>: [<span class="hljs-number">40</span>, <span class="hljs-number">46</span>], 
                <span class="hljs-attr">iconImageOffset</span>: [-<span class="hljs-number">24</span>, -<span class="hljs-number">24</span>], 
                <span class="hljs-attr">iconContentOffset</span>: [<span class="hljs-number">15</span>, <span class="hljs-number">15</span>], 
                <span class="hljs-attr">iconContentLayout</span>: <span class="hljs-title class_">MyIconContentLayout</span>,
            }
        );
        map.<span class="hljs-property">geoObjects</span>.<span class="hljs-title function_">add</span>(myPlacemarkWithContent);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2778f6319840421b94505f77a602b44b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=fgVLRCDj0qcDx1ISVCKGqFwdRB4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">3.汇总显示</h2>
<h3 data-id="heading-7">系统自带Clusterer</h3>
<p>系统自动Clusterer</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myMap = <span class="hljs-keyword">new</span> ymaps.<span class="hljs-title class_">Map</span>(
            <span class="hljs-string">"map"</span>,
            {
                <span class="hljs-attr">center</span>: [<span class="hljs-number">55.751574</span>, <span class="hljs-number">37.573856</span>],
                <span class="hljs-attr">zoom</span>: <span class="hljs-number">9</span>,
            },
            {
                <span class="hljs-attr">searchControlProvider</span>: <span class="hljs-string">"yandex#search"</span>,
            }
        ),
        clusterer = <span class="hljs-keyword">new</span> ymaps.<span class="hljs-title class_">Clusterer</span>({
            <span class="hljs-attr">preset</span>: <span class="hljs-string">"islands#invertedVioletClusterIcons"</span>,
            <span class="hljs-attr">clusterHideIconOnBalloonOpen</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">geoObjectHideIconOnBalloonOpen</span>: <span class="hljs-literal">false</span>,
        });

 

    <span class="hljs-keyword">var</span> getPointData = <span class="hljs-keyword">function</span> (<span class="hljs-params">index</span>) {
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">balloonContentBody</span>:
                    <span class="hljs-string">"placemark &lt;strong&gt;balloon "</span> + index + <span class="hljs-string">"&lt;/strong&gt;"</span>,
                <span class="hljs-attr">clusterCaption</span>: <span class="hljs-string">"placemark &lt;strong&gt;"</span> + index + <span class="hljs-string">"&lt;/strong&gt;"</span>,
            };
        },
        getPointOptions = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">preset</span>: <span class="hljs-string">"islands#violetIcon"</span>,
            };
        },
        points = [
            [<span class="hljs-number">55.831903</span>, <span class="hljs-number">37.411961</span>],
            [<span class="hljs-number">55.763338</span>, <span class="hljs-number">37.565466</span>],
            [<span class="hljs-number">55.763338</span>, <span class="hljs-number">37.565466</span>],
            [<span class="hljs-number">55.744522</span>, <span class="hljs-number">37.616378</span>],
            [<span class="hljs-number">55.780898</span>, <span class="hljs-number">37.642889</span>],
            [<span class="hljs-number">55.793559</span>, <span class="hljs-number">37.435983</span>],
            [<span class="hljs-number">55.800584</span>, <span class="hljs-number">37.675638</span>],
            [<span class="hljs-number">55.716733</span>, <span class="hljs-number">37.589988</span>],
            [<span class="hljs-number">55.775724</span>, <span class="hljs-number">37.56084</span>],
            [<span class="hljs-number">55.822144</span>, <span class="hljs-number">37.433781</span>],
            [<span class="hljs-number">55.87417</span>, <span class="hljs-number">37.669838</span>],
            [<span class="hljs-number">55.71677</span>, <span class="hljs-number">37.482338</span>],
            [<span class="hljs-number">55.78085</span>, <span class="hljs-number">37.75021</span>],
            [<span class="hljs-number">55.810906</span>, <span class="hljs-number">37.654142</span>],
            [<span class="hljs-number">55.865386</span>, <span class="hljs-number">37.713329</span>],
            [<span class="hljs-number">55.847121</span>, <span class="hljs-number">37.525797</span>],
            [<span class="hljs-number">55.778655</span>, <span class="hljs-number">37.710743</span>],
            [<span class="hljs-number">55.623415</span>, <span class="hljs-number">37.717934</span>],
            [<span class="hljs-number">55.863193</span>, <span class="hljs-number">37.737</span>],
            [<span class="hljs-number">55.86677</span>, <span class="hljs-number">37.760113</span>],
            [<span class="hljs-number">55.698261</span>, <span class="hljs-number">37.730838</span>],
            [<span class="hljs-number">55.6338</span>, <span class="hljs-number">37.564769</span>],
            [<span class="hljs-number">55.639996</span>, <span class="hljs-number">37.5394</span>],
            [<span class="hljs-number">55.69023</span>, <span class="hljs-number">37.405853</span>],
            [<span class="hljs-number">55.77597</span>, <span class="hljs-number">37.5129</span>],
            [<span class="hljs-number">55.775777</span>, <span class="hljs-number">37.44218</span>],
            [<span class="hljs-number">55.811814</span>, <span class="hljs-number">37.440448</span>],
            [<span class="hljs-number">55.751841</span>, <span class="hljs-number">37.404853</span>],
            [<span class="hljs-number">55.627303</span>, <span class="hljs-number">37.728976</span>],
            [<span class="hljs-number">55.816515</span>, <span class="hljs-number">37.597163</span>],
            [<span class="hljs-number">55.664352</span>, <span class="hljs-number">37.689397</span>],
            [<span class="hljs-number">55.679195</span>, <span class="hljs-number">37.600961</span>],
            [<span class="hljs-number">55.673873</span>, <span class="hljs-number">37.658425</span>],
            [<span class="hljs-number">55.681006</span>, <span class="hljs-number">37.605126</span>],
            [<span class="hljs-number">55.876327</span>, <span class="hljs-number">37.431744</span>],
            [<span class="hljs-number">55.843363</span>, <span class="hljs-number">37.778445</span>],
            [<span class="hljs-number">55.875445</span>, <span class="hljs-number">37.549348</span>],
            [<span class="hljs-number">55.662903</span>, <span class="hljs-number">37.702087</span>],
            [<span class="hljs-number">55.746099</span>, <span class="hljs-number">37.434113</span>],
            [<span class="hljs-number">55.83866</span>, <span class="hljs-number">37.712326</span>],
            [<span class="hljs-number">55.774838</span>, <span class="hljs-number">37.415725</span>],
            [<span class="hljs-number">55.871539</span>, <span class="hljs-number">37.630223</span>],
            [<span class="hljs-number">55.657037</span>, <span class="hljs-number">37.571271</span>],
            [<span class="hljs-number">55.691046</span>, <span class="hljs-number">37.711026</span>],
            [<span class="hljs-number">55.803972</span>, <span class="hljs-number">37.65961</span>],
            [<span class="hljs-number">55.616448</span>, <span class="hljs-number">37.452759</span>],
            [<span class="hljs-number">55.781329</span>, <span class="hljs-number">37.442781</span>],
            [<span class="hljs-number">55.844708</span>, <span class="hljs-number">37.74887</span>],
            [<span class="hljs-number">55.723123</span>, <span class="hljs-number">37.406067</span>],
            [<span class="hljs-number">55.858585</span>, <span class="hljs-number">37.48498</span>],
        ],
        geoObjects = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = points.<span class="hljs-property">length</span>; i &lt; len; i++) {
        geoObjects[i] = <span class="hljs-keyword">new</span> ymaps.<span class="hljs-title class_">Placemark</span>(
            points[i],
            <span class="hljs-title function_">getPointData</span>(i),
            <span class="hljs-title function_">getPointOptions</span>()
        );
    }

    clusterer.<span class="hljs-title function_">add</span>(geoObjects);
    myMap.<span class="hljs-property">geoObjects</span>.<span class="hljs-title function_">add</span>(clusterer);

    myMap.<span class="hljs-title function_">setBounds</span>(clusterer.<span class="hljs-title function_">getBounds</span>(), {
        <span class="hljs-attr">checkZoomRange</span>: <span class="hljs-literal">true</span>,
    });
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ae5718772104892b86d4585c5081bf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=Fhn8vPr4BDy9Oy3z6DKgXMIQjBE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bc93823be3d46158ac8f48d403c378d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=yZOSe1sUk41L%2F0vqBCA3Z9%2BcpHY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e346afd08bf540e7a5ffe053f417443e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=iizC3y7tJ28U4LdaPL0Acb9c1tM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c432457589b64e468b433e5d26bb1cbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=QBybwgtkCVd6T2Kjq8e8WfKEkEs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">验证自带clusterer的瓶颈</h3>
<p>通过随机方法创建4w节点</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span> 
     <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-container"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"mapContainer"</span> <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { ref,  onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>   
  <span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
    <span class="hljs-attr">apiKey</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    },
  })  
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)   
  <span class="hljs-keyword">let</span> <span class="hljs-attr">map</span>: any | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>   
  <span class="hljs-keyword">const</span> mapContainer = ref&lt;<span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>) 

  <span class="hljs-comment">// 检查Yandex Maps是否已加载</span>
  <span class="hljs-keyword">const</span> isYandexMapsLoaded = (): <span class="hljs-function"><span class="hljs-params">boolean</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span> !== <span class="hljs-string">'undefined'</span>
  }
 
  <span class="hljs-keyword">const</span> loadYandexMaps = (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-comment">// 检查是否已经加载过</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isYandexMapsLoaded</span>()) {
        <span class="hljs-title function_">resolve</span>()
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-comment">// 创建script标签</span>
      <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>) 
      <span class="hljs-keyword">const</span> apiKey = props.<span class="hljs-property">apiKey</span> <span class="hljs-comment">//  //</span>
      script.<span class="hljs-property">src</span> = <span class="hljs-string">`https://api-maps.yandex.ru/2.1/?apikey=<span class="hljs-subst">${apiKey}</span>&amp;lang=ru_RU`</span>
      script.<span class="hljs-property">type</span> = <span class="hljs-string">'text/javascript'</span>
      script.<span class="hljs-property">defer</span> = <span class="hljs-literal">true</span>

      <span class="hljs-comment">// 加载完成回调</span>
      script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> { 
        ;(<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span>.<span class="hljs-title function_">ready</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-title function_">resolve</span>()
        })
      } 
      script.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load Yandex Maps API'</span>, error)
        <span class="hljs-title function_">reject</span>(error)
      } 
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script)
    })
  } 
  
   <span class="hljs-keyword">const</span> <span class="hljs-title function_">getRandomData</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COUNT</span> = <span class="hljs-number">40000</span> <span class="hljs-comment">// 300000</span>
    <span class="hljs-keyword">const</span> locations = [] 
    <span class="hljs-comment">// 深圳市中心坐标范围（大致）</span>
    <span class="hljs-keyword">const</span> baseLat = <span class="hljs-number">55.751244</span>
    <span class="hljs-keyword">const</span> baseLng = <span class="hljs-number">37.618423</span>
  
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">COUNT</span>; i++) {
      <span class="hljs-keyword">const</span> lat = baseLat + (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">30.5</span> <span class="hljs-comment">// +-0.25范围</span>
      <span class="hljs-keyword">const</span> lng = baseLng + (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">100.5</span>
  
      locations.<span class="hljs-title function_">push</span>([ <span class="hljs-built_in">parseFloat</span>(lat.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">6</span>)),
        <span class="hljs-built_in">parseFloat</span>(lng.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">6</span>))])
    }
    <span class="hljs-keyword">return</span> locations
  }  <span class="hljs-comment">// 初始化地图</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">initMap</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!mapContainer.<span class="hljs-property">value</span> || !<span class="hljs-title function_">isYandexMapsLoaded</span>()) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">let</span> initLat = <span class="hljs-number">55.751244</span>
    <span class="hljs-keyword">let</span> initLng = <span class="hljs-number">37.618423</span>
    <span class="hljs-keyword">let</span> initZoom = <span class="hljs-number">15</span>
 

    <span class="hljs-comment">// 创建地图实例</span>
    map = <span class="hljs-keyword">new</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span>.<span class="hljs-title class_">Map</span>(mapContainer.<span class="hljs-property">value</span>, {
      <span class="hljs-attr">center</span>: [initLat, initLng], <span class="hljs-comment">// 莫斯科坐标作为默认值</span>
      <span class="hljs-attr">zoom</span>: initZoom,
      <span class="hljs-attr">controls</span>: [<span class="hljs-string">'fullscreenControl'</span>] 
    }) 

       <span class="hljs-keyword">let</span> clusterer =  <span class="hljs-keyword">new</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span>.<span class="hljs-title class_">Clusterer</span>({
            <span class="hljs-attr">preset</span>: <span class="hljs-string">"islands#invertedVioletClusterIcons"</span>,
            <span class="hljs-attr">clusterHideIconOnBalloonOpen</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">geoObjectHideIconOnBalloonOpen</span>: <span class="hljs-literal">false</span>,
        }); 
    <span class="hljs-keyword">let</span> getPointData = <span class="hljs-keyword">function</span> (<span class="hljs-params">index:number</span>) {
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">balloonContentBody</span>:
                    <span class="hljs-string">"placemark &lt;strong&gt;balloon "</span> + index + <span class="hljs-string">"&lt;/strong&gt;"</span>,
                <span class="hljs-attr">clusterCaption</span>: <span class="hljs-string">"placemark &lt;strong&gt;"</span> + index + <span class="hljs-string">"&lt;/strong&gt;"</span>,
            };
        },
        getPointOptions = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">preset</span>: <span class="hljs-string">"islands#violetIcon"</span>,
            };
        };
    <span class="hljs-keyword">let</span>    points = <span class="hljs-title function_">getRandomData</span>()
    <span class="hljs-keyword">let</span>    geoObjects = []

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = points.<span class="hljs-property">length</span>; i &lt; len; i++) {
        geoObjects[i] = <span class="hljs-keyword">new</span> ymaps.<span class="hljs-title class_">Placemark</span>(
            points[i],
            <span class="hljs-title function_">getPointData</span>(i),
            <span class="hljs-title function_">getPointOptions</span>()
        );
    }

    clusterer.<span class="hljs-title function_">add</span>(geoObjects);
    map.<span class="hljs-property">geoObjects</span>.<span class="hljs-title function_">add</span>(clusterer);

    map.<span class="hljs-title function_">setBounds</span>(clusterer.<span class="hljs-title function_">getBounds</span>(), {
        <span class="hljs-attr">checkZoomRange</span>: <span class="hljs-literal">true</span>,
    });

  }
  

  <span class="hljs-comment">// 组件卸载时清理地图实例</span>
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (map) {
      map.<span class="hljs-title function_">destroy</span>()
      map = <span class="hljs-literal">null</span>
    }
  })
 
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadYandexMaps</span>()  
      <span class="hljs-title function_">initMap</span>() 
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error onMounted:'</span>, error)
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
  })
 
  
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.main-container</span> {
    <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">70px</span>);
  } 
 

  <span class="hljs-selector-class">.loading</span> {
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#909399</span>;
  }
 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3edbbcd56de4725b418e0ea3661f66f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=bLtkWB5ItteZfTmIlvBL%2FKmjuxk%3D" alt="image.png" loading="lazy"/>
在渲染时已经开始卡了。</p>
<p>这里可以参考之前谷歌地图的优化方案
<a href="https://juejin.cn/post/7501119171796615219" target="_blank" title="https://juejin.cn/post/7501119171796615219">juejin.cn/post/750111…</a></p>
<p>所以这里我们还是不直接使用自带的cluster，我们通过后台计算，前台自定义渲染返回的汇总数据</p>
<h3 data-id="heading-9">自定义渲染后台汇总数据</h3>
<p>通过只绘制少量的汇总标记，来提升渲染效率</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span> 
     <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-container"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"mapContainer"</span> <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { ref,  onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>   
  <span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
    <span class="hljs-attr">apiKey</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    },
  })  
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)   
  <span class="hljs-keyword">let</span> <span class="hljs-attr">map</span>: any | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>   
  <span class="hljs-keyword">const</span> mapContainer = ref&lt;<span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>) 

  <span class="hljs-comment">// 检查Yandex Maps是否已加载</span>
  <span class="hljs-keyword">const</span> isYandexMapsLoaded = (): <span class="hljs-function"><span class="hljs-params">boolean</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span> !== <span class="hljs-string">'undefined'</span>
  }
 
  <span class="hljs-keyword">const</span> loadYandexMaps = (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-comment">// 检查是否已经加载过</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isYandexMapsLoaded</span>()) {
        <span class="hljs-title function_">resolve</span>()
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-comment">// 创建script标签</span>
      <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>) 
      <span class="hljs-keyword">const</span> apiKey = props.<span class="hljs-property">apiKey</span> <span class="hljs-comment">//  //</span>
      script.<span class="hljs-property">src</span> = <span class="hljs-string">`https://api-maps.yandex.ru/2.1/?apikey=<span class="hljs-subst">${apiKey}</span>&amp;lang=ru_RU`</span>
      script.<span class="hljs-property">type</span> = <span class="hljs-string">'text/javascript'</span>
      script.<span class="hljs-property">defer</span> = <span class="hljs-literal">true</span>

      <span class="hljs-comment">// 加载完成回调</span>
      script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> { 
        ;(<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span>.<span class="hljs-title function_">ready</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-title function_">resolve</span>()
        })
      } 
      script.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load Yandex Maps API'</span>, error)
        <span class="hljs-title function_">reject</span>(error)
      } 
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script)
    })
  } 
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getRandomData</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COUNT</span> = <span class="hljs-number">10</span> <span class="hljs-comment">// 300000</span>
    <span class="hljs-keyword">const</span> locations = []
  
    <span class="hljs-comment">// 深圳市中心坐标范围（大致）</span>
    <span class="hljs-keyword">const</span> baseLat = <span class="hljs-number">55.751244</span>
    <span class="hljs-keyword">const</span> baseLng = <span class="hljs-number">37.618423</span>
 
  
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">COUNT</span>; i++) {
      <span class="hljs-keyword">const</span> lat = baseLat + (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">35</span> <span class="hljs-comment">// +-0.25范围</span>
      <span class="hljs-keyword">const</span> lng = baseLng + (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">35</span>
  
      locations.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">id</span>: <span class="hljs-string">`<span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span>`</span>,
        <span class="hljs-attr">type</span>: i % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,
        <span class="hljs-attr">total</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>,
        <span class="hljs-attr">lat</span>: <span class="hljs-built_in">parseFloat</span>(lat.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">6</span>)),
        <span class="hljs-attr">lng</span>: <span class="hljs-built_in">parseFloat</span>(lng.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">6</span>))
      })
    }
    <span class="hljs-keyword">return</span> locations
  }

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">createClusterIcon</span> = (<span class="hljs-params">count: number, type: string, size: number = <span class="hljs-number">40</span></span>) =&gt; {
    <span class="hljs-keyword">const</span> color = type === <span class="hljs-string">'green'</span> ? <span class="hljs-string">'#00BD24'</span> : <span class="hljs-string">'#E0312C'</span>
    <span class="hljs-keyword">const</span> svg = <span class="hljs-string">`
    &lt;svg width="<span class="hljs-subst">${size}</span>" height="<span class="hljs-subst">${size}</span>" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"&gt;
      &lt;g opacity="0.280000"&gt;
        &lt;circle id="椭圆 201" cx="20" cy="20" r="20" fill="<span class="hljs-subst">${color}</span>" /&gt;
      &lt;/g&gt;
      &lt;g opacity="0.520000"&gt;
        &lt;circle id="椭圆 202" cx="20" cy="20" r="17" fill="<span class="hljs-subst">${color}</span>"  /&gt;
      &lt;/g&gt;
      &lt;circle id="椭圆 203" cx="20" cy="20" r="14" fill="<span class="hljs-subst">${color}</span>" /&gt;
      &lt;text x="20" y="25" font-size="10" fill="#fff" text-anchor="middle" dominant-baseline="top"&gt;
        <span class="hljs-subst">${count}</span>
      &lt;/text&gt;
    &lt;/svg&gt;
  `</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`data:image/svg+xml;charset=utf-8,<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(svg)}</span>`</span>
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">createCluster</span> = (<span class="hljs-params">title:string,own:number,total:number,lat:number,lng:number</span>) =&gt; {
      <span class="hljs-keyword">const</span> color = own === <span class="hljs-number">1</span> ? <span class="hljs-string">'green'</span> : <span class="hljs-string">'red'</span>
      <span class="hljs-comment">// 创建SVG格式的圆形图标</span>
      <span class="hljs-keyword">const</span> iconHref = <span class="hljs-title function_">createClusterIcon</span>(total, color, <span class="hljs-number">40</span>)

      <span class="hljs-comment">// 创建标记</span>
      <span class="hljs-keyword">const</span> placemark = <span class="hljs-keyword">new</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span>.<span class="hljs-title class_">Placemark</span>(
        [lat, lng],
        {
          <span class="hljs-attr">hintContent</span>: title, 
          <span class="hljs-comment">// 保存完整的标记数据</span>
          <span class="hljs-attr">markerData</span>: {
            <span class="hljs-attr">title</span>: title,
          },
        },
        {
          <span class="hljs-attr">iconLayout</span>: <span class="hljs-string">'default#image'</span>, <span class="hljs-comment">// 使用默认图片布局</span>
          <span class="hljs-attr">iconImageHref</span>: iconHref, <span class="hljs-comment">// 引用 SVG 的 Data URI</span>
          <span class="hljs-attr">iconImageSize</span>: [<span class="hljs-number">40</span>, <span class="hljs-number">40</span>], <span class="hljs-comment">// 图标显示尺寸</span>
          <span class="hljs-attr">iconImageOffset</span>: [-<span class="hljs-number">40</span> / <span class="hljs-number">2</span>, -<span class="hljs-number">40</span> / <span class="hljs-number">2</span>], <span class="hljs-comment">// 偏移量（中心点对齐坐标）</span>
        },
      ) 
      <span class="hljs-comment">// 将标记添加到地图</span>
      map.<span class="hljs-property">geoObjects</span>.<span class="hljs-title function_">add</span>(placemark)
      <span class="hljs-keyword">return</span> placemark
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">initMap</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!mapContainer.<span class="hljs-property">value</span> || !<span class="hljs-title function_">isYandexMapsLoaded</span>()) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">let</span> initLat = <span class="hljs-number">55.751244</span>
    <span class="hljs-keyword">let</span> initLng = <span class="hljs-number">37.618423</span>
    <span class="hljs-keyword">let</span> initZoom = <span class="hljs-number">5</span> 
    <span class="hljs-comment">// 创建地图实例</span>
    map = <span class="hljs-keyword">new</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">ymaps</span>.<span class="hljs-title class_">Map</span>(mapContainer.<span class="hljs-property">value</span>, {
      <span class="hljs-attr">center</span>: [initLat, initLng], <span class="hljs-comment">// 莫斯科坐标作为默认值</span>
      <span class="hljs-attr">zoom</span>: initZoom,
      <span class="hljs-attr">controls</span>: [<span class="hljs-string">'fullscreenControl'</span>] 
    }) 
 
    <span class="hljs-keyword">let</span> points = <span class="hljs-title function_">getRandomData</span>() 

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = points.<span class="hljs-property">length</span>; i &lt; len; i++) {
      <span class="hljs-keyword">const</span> obj = points[i]
      <span class="hljs-title function_">createCluster</span>(obj.<span class="hljs-property">id</span>,obj.<span class="hljs-property">type</span>, obj.<span class="hljs-property">total</span>, obj.<span class="hljs-property">lat</span>,obj.<span class="hljs-property">lng</span>) 
    }  
  }
  

  <span class="hljs-comment">// 组件卸载时清理地图实例</span>
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (map) {
      map.<span class="hljs-title function_">destroy</span>()
      map = <span class="hljs-literal">null</span>
    }
  })
 
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadYandexMaps</span>()  
      <span class="hljs-title function_">initMap</span>() 
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error onMounted:'</span>, error)
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
  })
 
  
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.main-container</span> {
    <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">70px</span>);
  } 
 

  <span class="hljs-selector-class">.loading</span> {
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#909399</span>;
  }
 
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bd54c26589e489696a43640777ea806~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=4b5SaYdqIpEhtl5SRpvujWiJa%2FA%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到现在汇总的只是一个标记，并没有完全在地图全部生成。</p>
<h2 data-id="heading-10">4.自定义弹框</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d35e9d96918c4c4a9e730d6904b88117~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgamFzb25feWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060690&amp;x-signature=NC0Hsu0qqbQxCMpHvbjUMZcR9EA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>通过参数balloonLayout 自定义弹框内容</li>
<li>通过placemark.options.set('iconImageHref'，‘xxx’) 实时修改原来自定义的标记图片</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span>;
    }

    <span class="hljs-selector-id">#map</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">600px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
    }

    <span class="hljs-comment">/* 气泡容器 - 用于三角定位 */</span>
    <span class="hljs-selector-class">.balloon-wrapper</span> {
      <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">overflow</span>: visible;
      <span class="hljs-comment">/* 确保三角不被裁剪 */</span>
    }

    <span class="hljs-comment">/* 气泡内容区域 */</span>
    <span class="hljs-selector-class">.custom-balloon</span> {
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">3px</span> <span class="hljs-number">14px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>);
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">z-index</span>: <span class="hljs-number">2</span>;
    }

    <span class="hljs-comment">/* 左上角三角 - 指向左侧标记 */</span>
    <span class="hljs-selector-class">.balloon-triangle</span> {
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-comment">/* 距离气泡顶部20px */</span>
      <span class="hljs-attribute">left</span>: -<span class="hljs-number">10px</span>;
      <span class="hljs-comment">/* 超出气泡左侧10px */</span>
      <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
      <span class="hljs-comment">/* 三角形指向左侧（右向三角形） */</span>
      <span class="hljs-attribute">border-top</span>: <span class="hljs-number">8px</span> solid transparent;
      <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">8px</span> solid transparent;
      <span class="hljs-attribute">border-right</span>: <span class="hljs-number">10px</span> solid <span class="hljs-number">#fff</span>;
      <span class="hljs-comment">/* 与气泡背景同色 */</span>
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">2px</span> <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
      <span class="hljs-comment">/* 右侧阴影增强立体感 */</span>
      <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">/* 加载状态样式 */</span>
    <span class="hljs-selector-class">.loading</span> {
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    }

    <span class="hljs-comment">/* 错误状态样式 */</span>
    <span class="hljs-selector-class">.error</span> {
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#e74c3c</span>;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    }

    <span class="hljs-comment">/* 气泡头部样式 */</span>
    <span class="hljs-selector-class">.balloon-header</span> {
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>;
      <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-number">10px</span>;
    }

    <span class="hljs-selector-class">.balloon-title</span> {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-number">0</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#2c3e50</span>;
    }

    <span class="hljs-comment">/* 图片样式 */</span>
    <span class="hljs-selector-class">.balloon-image</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-comment">/* 统计信息样式 */</span>
    <span class="hljs-selector-class">.balloon-stats</span> {
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span> <span class="hljs-number">0</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"map"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 引入 Yandex Maps API --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://api-maps.yandex.ru/2.1/?lang=zh_CN&amp;onload=initMap"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 基础标记数据</span>
    <span class="hljs-keyword">const</span> markersData = [
      { <span class="hljs-attr">coords</span>: [<span class="hljs-number">39.9042</span>, <span class="hljs-number">116.4074</span>], <span class="hljs-attr">title</span>: <span class="hljs-string">"北京"</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">"bj001"</span> },
      { <span class="hljs-attr">coords</span>: [<span class="hljs-number">31.2304</span>, <span class="hljs-number">121.4737</span>], <span class="hljs-attr">title</span>: <span class="hljs-string">"上海"</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">"sh002"</span> },
      { <span class="hljs-attr">coords</span>: [<span class="hljs-number">23.1291</span>, <span class="hljs-number">113.2644</span>], <span class="hljs-attr">title</span>: <span class="hljs-string">"广州"</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">"gz003"</span> },
      { <span class="hljs-attr">coords</span>: [<span class="hljs-number">22.3193</span>, <span class="hljs-number">114.1694</span>], <span class="hljs-attr">title</span>: <span class="hljs-string">"深圳"</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">"sz004"</span> }
    ];

    <span class="hljs-keyword">let</span> map;
    <span class="hljs-keyword">let</span> placemarks = [];
    <span class="hljs-keyword">let</span> dynamicBalloonLayout;
    <span class="hljs-keyword">let</span> activePlacemark = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INITIAL_ZOOM</span> = <span class="hljs-number">5</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEFAULT_COLOR</span> = <span class="hljs-string">'#3498db'</span>; <span class="hljs-comment">// 默认标记颜色</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ACTIVE_COLOR</span> = <span class="hljs-string">'#e74c3c'</span>;  <span class="hljs-comment">// 激活状态颜色</span>

    <span class="hljs-comment">// 生成带数字的圆形图标</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateCircleIconWithNumber</span>(<span class="hljs-params">num, color = DEFAULT_COLOR</span>) {
      <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
      <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
      <span class="hljs-keyword">const</span> size = <span class="hljs-number">50</span>; <span class="hljs-comment">// 图标大小</span>
      canvas.<span class="hljs-property">width</span> = size;
      canvas.<span class="hljs-property">height</span> = size;

      <span class="hljs-comment">// 白色填充</span>
      ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#ffffff'</span>;
      ctx.<span class="hljs-title function_">beginPath</span>();
      ctx.<span class="hljs-title function_">arc</span>(size / <span class="hljs-number">2</span>, size / <span class="hljs-number">2</span>, size / <span class="hljs-number">2</span> - <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>);
      ctx.<span class="hljs-title function_">fill</span>();

      <span class="hljs-comment">// 边框颜色</span>
      ctx.<span class="hljs-property">strokeStyle</span> = color;
      ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">3</span>;
      ctx.<span class="hljs-title function_">stroke</span>();

      <span class="hljs-comment">// 数字颜色</span>
      ctx.<span class="hljs-property">fillStyle</span> = color;
      ctx.<span class="hljs-property">font</span> = <span class="hljs-string">'bold 16px Arial'</span>;
      ctx.<span class="hljs-property">textAlign</span> = <span class="hljs-string">'center'</span>;
      ctx.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">'middle'</span>;
      ctx.<span class="hljs-title function_">fillText</span>(num.<span class="hljs-title function_">toString</span>(), size / <span class="hljs-number">2</span>, size / <span class="hljs-number">2</span>);

      <span class="hljs-keyword">return</span> canvas.<span class="hljs-title function_">toDataURL</span>();
    }

    <span class="hljs-comment">// 模拟API请求获取详细数据</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchMarkerDetails</span>(<span class="hljs-params">markerId</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">const</span> mockData = {
            <span class="hljs-string">"bj001"</span>: {
              <span class="hljs-attr">description</span>: <span class="hljs-string">"北京是中国的首都，政治、文化和国际交流中心。"</span>,
              <span class="hljs-attr">population</span>: <span class="hljs-string">"约2154万"</span>,
              <span class="hljs-attr">area</span>: <span class="hljs-string">"16,410.54平方公里"</span>,
              <span class="hljs-attr">image</span>: <span class="hljs-string">"https://picsum.photos/id/1016/400/200"</span>,
              <span class="hljs-attr">temperature</span>: <span class="hljs-string">"18°C"</span>,
              <span class="hljs-attr">updateTime</span>: <span class="hljs-string">"2023-10-01 12:00"</span>
            },
            <span class="hljs-string">"sh002"</span>: {
              <span class="hljs-attr">description</span>: <span class="hljs-string">"上海是中国的经济、金融中心，国际化大都市。"</span>,
              <span class="hljs-attr">population</span>: <span class="hljs-string">"约2487万"</span>,
              <span class="hljs-attr">area</span>: <span class="hljs-string">"6,340.5平方公里"</span>,
              <span class="hljs-attr">image</span>: <span class="hljs-string">"https://picsum.photos/id/1015/400/200"</span>,
              <span class="hljs-attr">temperature</span>: <span class="hljs-string">"20°C"</span>,
              <span class="hljs-attr">updateTime</span>: <span class="hljs-string">"2023-10-01 12:10"</span>
            },
            <span class="hljs-string">"gz003"</span>: {
              <span class="hljs-attr">description</span>: <span class="hljs-string">"广州是华南地区的经济中心和交通枢纽。"</span>,
              <span class="hljs-attr">population</span>: <span class="hljs-string">"约1530万"</span>,
              <span class="hljs-attr">area</span>: <span class="hljs-string">"7,434.4平方公里"</span>,
              <span class="hljs-attr">image</span>: <span class="hljs-string">"https://picsum.photos/id/1018/400/200"</span>,
              <span class="hljs-attr">temperature</span>: <span class="hljs-string">"25°C"</span>,
              <span class="hljs-attr">updateTime</span>: <span class="hljs-string">"2023-10-01 12:05"</span>
            },
            <span class="hljs-string">"sz004"</span>: {
              <span class="hljs-attr">description</span>: <span class="hljs-string">"深圳是中国的科技创新中心，新兴一线城市。"</span>,
              <span class="hljs-attr">population</span>: <span class="hljs-string">"约1303万"</span>,
              <span class="hljs-attr">area</span>: <span class="hljs-string">"1,997.47平方公里"</span>,
              <span class="hljs-attr">image</span>: <span class="hljs-string">"https://picsum.photos/id/1019/400/200"</span>,
              <span class="hljs-attr">temperature</span>: <span class="hljs-string">"24°C"</span>,
              <span class="hljs-attr">updateTime</span>: <span class="hljs-string">"2023-10-01 12:15"</span>
            }
          };
          <span class="hljs-title function_">resolve</span>(mockData[markerId]);
        }, <span class="hljs-number">800</span>);
      });
    }

    <span class="hljs-comment">// 创建自定义气泡布局（左上角三角）</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">createDynamicBalloonLayout</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> ymaps.<span class="hljs-property">templateLayoutFactory</span>.<span class="hljs-title function_">createClass</span>(
        <span class="hljs-comment">// 气泡结构：外层容器 -&gt; 内容区 + 左上角三角</span>
        <span class="hljs-string">'&lt;div class="balloon-wrapper"&gt;'</span> +
        <span class="hljs-string">'&lt;div id="dynamic-balloon-content" class="custom-balloon"&gt;&lt;/div&gt;'</span> +
        <span class="hljs-string">'&lt;div class="balloon-triangle"&gt;&lt;/div&gt;'</span> + <span class="hljs-comment">// 左上角三角</span>
        <span class="hljs-string">'&lt;/div&gt;'</span>,
        {
          <span class="hljs-comment">// 构建气泡时触发</span>
          <span class="hljs-attr">build</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">constructor</span>.<span class="hljs-property">superclass</span>.<span class="hljs-property">build</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);

            <span class="hljs-keyword">const</span> properties = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getData</span>().<span class="hljs-property">properties</span>;
            <span class="hljs-keyword">const</span> contentContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'dynamic-balloon-content'</span>);

            <span class="hljs-comment">// 显示加载状态</span>
            contentContainer.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
              &lt;div class="loading"&gt;
                &lt;p&gt;正在加载<span class="hljs-subst">${properties.get(<span class="hljs-string">'title'</span>)}</span>的详细信息...&lt;/p&gt;
                &lt;div style="margin-top:10px;"&gt;⏳&lt;/div&gt;
              &lt;/div&gt;
            `</span>;

            <span class="hljs-comment">// 加载并渲染数据</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadAndRenderData</span>(properties.<span class="hljs-title function_">get</span>(<span class="hljs-string">'id'</span>), contentContainer);
          },

          <span class="hljs-comment">// 加载数据并渲染内容</span>
          <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadAndRenderData</span>(<span class="hljs-params">markerId, container</span>) {
            <span class="hljs-keyword">try</span> {
              <span class="hljs-keyword">const</span> details = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchMarkerDetails</span>(markerId);
              <span class="hljs-keyword">const</span> baseInfo = markersData.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === markerId);

              <span class="hljs-comment">// 渲染气泡内容</span>
              container.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
                &lt;div class="balloon-header"&gt;
                  &lt;h3 class="balloon-title"&gt;<span class="hljs-subst">${baseInfo.title}</span>&lt;/h3&gt;
                  &lt;small&gt;数据更新于: <span class="hljs-subst">${details.updateTime}</span>&lt;/small&gt;
                &lt;/div&gt;
                &lt;img src="<span class="hljs-subst">${details.image}</span>" class="balloon-image" /&gt;
                &lt;p&gt;<span class="hljs-subst">${details.description}</span>&lt;/p&gt;
                &lt;div class="balloon-stats"&gt;
                  &lt;div&gt;人口: <span class="hljs-subst">${details.population}</span>&lt;/div&gt;
                  &lt;div&gt;面积: <span class="hljs-subst">${details.area}</span>&lt;/div&gt;
                &lt;/div&gt;
                &lt;div&gt;当前温度: <span class="hljs-subst">${details.temperature}</span>&lt;/div&gt;
                &lt;button onclick="handleBalloonAction('<span class="hljs-subst">${markerId}</span>')" style="margin-top:15px;padding:6px 12px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;"&gt;
                  查看更多信息
                &lt;/button&gt;
              `</span>;
            } <span class="hljs-keyword">catch</span> (error) {
              <span class="hljs-comment">// 错误状态</span>
              container.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
                &lt;div class="error"&gt;
                  &lt;p&gt;加载失败，请稍后重试&lt;/p&gt; 
                &lt;/div&gt;
              `</span>;
            }
          },

          <span class="hljs-comment">// 清除气泡时触发</span>
          <span class="hljs-attr">clear</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">constructor</span>.<span class="hljs-property">superclass</span>.<span class="hljs-property">clear</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);
          }
        }
      );
    }

    <span class="hljs-comment">// 重置所有标记为默认样式</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">resetAllMarkers</span>(<span class="hljs-params"/>) {
      placemarks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">placemark, index</span>) =&gt;</span> {
        placemark.<span class="hljs-property">options</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'iconImageHref'</span>,
          <span class="hljs-title function_">generateCircleIconWithNumber</span>(index + <span class="hljs-number">1</span>, <span class="hljs-variable constant_">DEFAULT_COLOR</span>));
      });
      activePlacemark = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// 设置标记为激活状态（红色）</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">setMarkerActive</span>(<span class="hljs-params">placemark, index</span>) {
      <span class="hljs-title function_">resetAllMarkers</span>();
      placemark.<span class="hljs-property">options</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'iconImageHref'</span>,
        <span class="hljs-title function_">generateCircleIconWithNumber</span>(index + <span class="hljs-number">1</span>, <span class="hljs-variable constant_">ACTIVE_COLOR</span>));
      activePlacemark = placemark;
    }

    <span class="hljs-comment">// 重试加载数据 </span>

    <span class="hljs-comment">// 气泡内按钮点击事件</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">handleBalloonAction</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">markerId</span>) {
      <span class="hljs-keyword">const</span> marker = markersData.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === markerId);
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">`您点击了<span class="hljs-subst">${marker.title}</span>的"查看更多信息"按钮，ID: <span class="hljs-subst">${markerId}</span>`</span>);
    };

    <span class="hljs-comment">// 关闭所有气泡</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">closeAllBalloons</span>(<span class="hljs-params"/>) {
      placemarks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">placemark</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (placemark.<span class="hljs-property">balloon</span>.<span class="hljs-title function_">isOpen</span>()) {
          placemark.<span class="hljs-property">balloon</span>.<span class="hljs-title function_">close</span>();
        }
      });
      <span class="hljs-title function_">resetAllMarkers</span>();
    }

    <span class="hljs-comment">// 初始化地图</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">initMap</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> mapCenter = [<span class="hljs-number">31.0</span>, <span class="hljs-number">114.0</span>];
      map = <span class="hljs-keyword">new</span> ymaps.<span class="hljs-title class_">Map</span>(<span class="hljs-string">"map"</span>, {
        <span class="hljs-attr">center</span>: mapCenter,
        <span class="hljs-attr">zoom</span>: <span class="hljs-variable constant_">INITIAL_ZOOM</span>
      });

      <span class="hljs-comment">// 点击地图空白处关闭气泡</span>
      map.<span class="hljs-property">events</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
        <span class="hljs-keyword">const</span> target = e.<span class="hljs-title function_">get</span>(<span class="hljs-string">'target'</span>);
        <span class="hljs-keyword">if</span> (target === map) {
          <span class="hljs-title function_">closeAllBalloons</span>();
        }
      });

      <span class="hljs-title function_">createCustomMarkers</span>();
    }

    <span class="hljs-comment">// 创建自定义标记</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">createCustomMarkers</span>(<span class="hljs-params"/>) {
      dynamicBalloonLayout = <span class="hljs-title function_">createDynamicBalloonLayout</span>();

      markersData.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">data, index</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> placemark = <span class="hljs-keyword">new</span> ymaps.<span class="hljs-title class_">Placemark</span>(
          data.<span class="hljs-property">coords</span>,
          {
            <span class="hljs-attr">title</span>: data.<span class="hljs-property">title</span>,
            <span class="hljs-attr">id</span>: data.<span class="hljs-property">id</span>
          },
          {
            <span class="hljs-attr">iconLayout</span>: <span class="hljs-string">'default#image'</span>,
            <span class="hljs-attr">iconImageHref</span>: <span class="hljs-title function_">generateCircleIconWithNumber</span>(index + <span class="hljs-number">1</span>),
            <span class="hljs-attr">iconImageSize</span>: [<span class="hljs-number">50</span>, <span class="hljs-number">50</span>],
            <span class="hljs-attr">iconImageOffset</span>: [-<span class="hljs-number">25</span>, -<span class="hljs-number">25</span>], <span class="hljs-comment">// 图标中心点对准坐标点</span>
            <span class="hljs-attr">balloonLayout</span>: dynamicBalloonLayout,
            <span class="hljs-comment">// 气泡偏移量：向右移动100px，向上微调20px（确保三角指向标记）</span>
            <span class="hljs-attr">balloonOffset</span>: [<span class="hljs-number">20</span>, -<span class="hljs-number">20</span>],
            <span class="hljs-attr">balloonShadow</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 禁用默认阴影，使用自定义阴影</span>
            <span class="hljs-attr">hideIconOnBalloonOpen</span>: <span class="hljs-literal">false</span>
          }
        );

        <span class="hljs-comment">// 标记点击事件</span>
        placemark.<span class="hljs-property">events</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
          <span class="hljs-title function_">setMarkerActive</span>(placemark, index);
        });

        map.<span class="hljs-property">geoObjects</span>.<span class="hljs-title function_">add</span>(placemark);
        placemarks.<span class="hljs-title function_">push</span>(placemark);
      });
    }

  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre>
<h2 data-id="heading-11">5.踩坑事项</h2>
<h3 data-id="heading-12">缩放与移动统一事件</h3>
<p>map.events.add('boundschange' 可以用来统一监听缩放与移动逻辑，不建议事情其他自带防止冲突</p>
<pre><code class="hljs language-js" lang="js">    map.<span class="hljs-property">events</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'boundschange'</span>, <span class="hljs-function">(<span class="hljs-params">event: any</span>) =&gt;</span> { 
      <span class="hljs-keyword">if</span> (event.<span class="hljs-title function_">get</span>(<span class="hljs-string">'newZoom'</span>) !== event.<span class="hljs-title function_">get</span>(<span class="hljs-string">'oldZoom'</span>)) { <span class="hljs-comment">// 缩放了</span>
        <span class="hljs-comment">//  console.log('进入缩放事件', event)</span>
        
      } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 只是移动 </span>
        <span class="hljs-comment">//  console.log('进入移动事件', event)  </span>
      }
    })
</code></pre>
<h3 data-id="heading-13">浏览器宽度变化，地图不能识别</h3>
<p>google可以自己自适应，yandex没有，需要实时监听容器变化</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-comment">// 创建 ResizeObserver 监听容器尺寸变化</span>
    <span class="hljs-keyword">const</span> resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(
      <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">entries: any</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span>(!mapContainer.<span class="hljs-property">value</span>) {
          <span class="hljs-keyword">return</span>
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> entry <span class="hljs-keyword">of</span> entries) { 
          <span class="hljs-keyword">if</span>(mapContainer.<span class="hljs-property">value</span> === entry.<span class="hljs-property">target</span>) { 
            map.<span class="hljs-property">container</span>.<span class="hljs-title function_">fitToViewport</span>()
            <span class="hljs-keyword">break</span>;
          } 
        }
      }, <span class="hljs-number">1000</span>),
    )

    <span class="hljs-comment">// 开始监听容器</span>
    resizeObserver.<span class="hljs-title function_">observe</span>(mapContainer.<span class="hljs-property">value</span>)
</code></pre>
<h3 data-id="heading-14">动态修改  marker.options.set('iconImageSize','xx'),再次访问异常</h3>
<p>yandex当通过marker.options.set('iconImageSize','xx')动态修改元素的物理渲染信息时候，会修改原来对象的引用，不能通过 全局引用的对象保留，需要重新遍历索引。</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-keyword">const</span> selectedMarker = ref&lt;any | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>) <span class="hljs-comment">// 如全局记录了上次选中对象</span>
  
  selectedMarker = xxx <span class="hljs-comment">// 点击选中赋值</span>
  selectedMarker.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">fire</span>(<span class="hljs-string">'click'</span>, {})  <span class="hljs-comment">// 这里会报错</span>
  
    <span class="hljs-keyword">if</span> (selectedMarker &amp;&amp; selectedMarker.<span class="hljs-property">value</span>) {
      <span class="hljs-keyword">const</span> storeId = <span class="hljs-title function_">getStoreIdByMarker</span>(selectedMarker.<span class="hljs-property">value</span>) 
      <span class="hljs-keyword">let</span> marker = <span class="hljs-title function_">findMarkerByStoreId</span>(storeId)  <span class="hljs-comment">// 每次重新再查找一遍</span>
      <span class="hljs-keyword">if</span> (marker) {
          marker.<span class="hljs-property">events</span>.<span class="hljs-title function_">fire</span>(<span class="hljs-string">'click'</span>, {}) 
      }
    }
 
</code></pre>
<h3 data-id="heading-15">移动和放大时候与boundschange事件冲突</h3>
<p>系统自带map.panTo(）来实现移动和放大，但是会导致触发boundschange事件的事件。可以通过全局状态位来控制逻辑</p>
<pre><code class="hljs language-js" lang="js">
  <span class="hljs-keyword">let</span> isPanToNow = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">myPanTo</span> = (<span class="hljs-params">targetCoords: any</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      isPanToNow = <span class="hljs-literal">true</span>
      <span class="hljs-comment">// 平滑移动</span>
      map.<span class="hljs-title function_">panTo</span>(targetCoords, { <span class="hljs-attr">duration</span>: <span class="hljs-number">500</span> , <span class="hljs-attr">flying</span>: <span class="hljs-literal">true</span> }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 再平滑移动</span>
        isPanToNow = <span class="hljs-literal">false</span>
        <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">null</span>)
      })
    })
  }
  
 <span class="hljs-comment">// 添加缩放 + 拖拽 事件监听</span>
    map.<span class="hljs-property">events</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'boundschange'</span>, <span class="hljs-function">(<span class="hljs-params">event: any</span>) =&gt;</span> { 
      <span class="hljs-keyword">if</span> (isPanToNow) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'isPanToNow 为 true'</span>, isPanToNow)
        <span class="hljs-keyword">return</span>
      }
     
    })
  
</code></pre>
<h3 data-id="heading-16">主动触发标记点击事件</h3>
<p>通过<code>marker.events.fire('click', {})</code> 主动触发，注意标记必须是渲染完成的，目前没找到稳定的回调渲染方法钩子，暂时加settimout再下一次事件循环里再触发确保已经渲染</p>
<pre><code class="hljs language-js" lang="js"> marker.<span class="hljs-property">events</span>.<span class="hljs-title function_">fire</span>(<span class="hljs-string">'click'</span>, {}) 
</code></pre>
<p>也可以通过提前加载图片，确保渲染标记时候不会阻塞</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> customIconUrl1 = <span class="hljs-string">"/dashboard/local1.png"</span>; 
<span class="hljs-keyword">const</span> customIconUrl2 = <span class="hljs-string">"/dashboard/local2.png"</span>; 
<span class="hljs-comment">// 预先加载图标图片的函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadIconImage</span>(<span class="hljs-params">url:string</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
    img.<span class="hljs-property">src</span> = url;
    img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(url); <span class="hljs-comment">// 图片加载完成</span>
    img.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">"图标加载失败"</span>);
  });
}
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadYandexMaps</span>() 
       <span class="hljs-comment">// 等待图标加载完成</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadIconImage</span>(customIconUrl1);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadIconImage</span>(customIconUrl2);

      <span class="hljs-title function_">initMap</span>() 
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error onMounted:'</span>, error)
      mapLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 发生错误时也关闭加载状态</span>
    }
  })

</code></pre>
<h2 data-id="heading-17">6.源码地址</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmjsong07%2Fyandex-map-vue3-cluster" target="_blank" title="https://github.com/mjsong07/yandex-map-vue3-cluster" ref="nofollow noopener noreferrer">github.com/mjsong07/ya…</a></p>
<h2 data-id="heading-18">7.资料参考</h2>
<p>官方api文档 v2.1
<a href="https://link.juejin.cn?target=https%3A%2F%2Fyandex.com%2Fdev%2Fjsapi-v2-1%2Fdoc%2Fen%2F" target="_blank" title="https://yandex.com/dev/jsapi-v2-1/doc/en/" ref="nofollow noopener noreferrer">yandex.com/dev/jsapi-v…</a></p>
<p>例子
<a href="https://link.juejin.cn?target=https%3A%2F%2Fyandex.com%2Fdev%2Fjsapi-v2-1%2Fdoc%2Fen%2Fv2-1%2Fexamples%2F" target="_blank" title="https://yandex.com/dev/jsapi-v2-1/doc/en/v2-1/examples/" ref="nofollow noopener noreferrer">yandex.com/dev/jsapi-v…</a></p>
<p>官方api文档 v3 
<a href="https://link.juejin.cn?target=https%3A%2F%2Fyandex.com%2Fmaps-api%2Fdocs%2Fjs-api%2Findex.html%3Flang%3Den" target="_blank" title="https://yandex.com/maps-api/docs/js-api/index.html?lang=en" ref="nofollow noopener noreferrer">yandex.com/maps-api/do…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI】👉提示词入门基础篇指南]]></title>    <link>https://juejin.cn/post/7573680361990275112</link>    <guid>https://juejin.cn/post/7573680361990275112</guid>    <pubDate>2025-11-18T08:05:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573680361990275112" data-draft-id="7573617944518950912" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI】👉提示词入门基础篇指南"/> <meta itemprop="keywords" content="AIGC,前端,后端"/> <meta itemprop="datePublished" content="2025-11-18T08:05:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="珑墨"/> <meta itemprop="url" content="https://juejin.cn/user/3069492194710797"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI】👉提示词入门基础篇指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3069492194710797/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    珑墨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:05:09.000Z" title="Tue Nov 18 2025 08:05:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>本篇以Cursor 提示词为例子</strong>，主要介绍提示词的基础概念、重要性和基本结构。其实各个ai产品提示词都差不多，主要还是边界和场景。</p>
</blockquote>
<h2 data-id="heading-0">什么是提示词？</h2>
<p>简单说：提示词就是把需求讲清楚，让 AI 照做。你负责告诉它“要什么、怎么做、有哪些限制、参考哪个文件”，AI 才能给你靠谱的结果。</p>
<p>再深入一点，提示词就是<strong>和大模型交流的协议</strong>。模型只会根据你给的文本来预测答案，语义越明确、细节越足，输出就越接近你想要的样子。</p>
<h3 data-id="heading-1">为什么 Cursor 的提示词特别重要？</h3>
<p>Cursor 使用的是大语言模型（LLM），这些模型有几个特点：</p>
<ol>
<li>
<p><strong>上下文窗口有限</strong>：虽然 Cursor 能读取项目文件，但模型能"记住"的上下文是有限的。好的提示词能最大化利用这个上下文窗口。</p>
</li>
<li>
<p><strong>模式匹配机制</strong>：模型通过匹配训练数据中的模式来生成代码。如果你的提示词能触发正确的模式，就能得到更好的结果。</p>
</li>
<li>
<p><strong>多轮对话能力</strong>：Cursor 支持多轮对话，但每轮对话的质量会影响后续对话。第一轮提示词写得好，后续优化就容易。</p>
</li>
<li>
<p><strong>代码感知能力</strong>：Cursor 能理解项目结构，但你需要明确告诉它要关注哪些文件、哪些模式。</p>
</li>
</ol>
<h3 data-id="heading-2">提示词的工作原理（技术层面）</h3>
<p>当你输入提示词时，Cursor 会：</p>
<ol>
<li><strong>解析提示词</strong>：提取关键信息（任务、约束、上下文）</li>
<li><strong>检索相关代码</strong>：根据提示词中的文件引用和关键词，从项目中检索相关代码</li>
<li><strong>构建上下文</strong>：将你的提示词、检索到的代码、项目结构组合成完整的上下文</li>
<li><strong>调用 AI 模型</strong>：将上下文发送给 AI 模型，模型生成代码</li>
<li><strong>后处理</strong>：对生成的代码进行格式化、验证等处理</li>
</ol>
<p>这个过程决定了：<strong>提示词中的每个细节都可能影响最终结果</strong>。</p>
<h3 data-id="heading-3">Cursor 里提示词能干啥？</h3>
<p>我用 Cursor 做的高频操作只有几类：写代码、改代码、修 bug、解释代码、写文档/测试、做审查或性能优化——基本上把这些场景的提示词写好，就能把它当强力队友。</p>
<h3 data-id="heading-4">Cursor 到底强在哪？</h3>
<p>说实话，我用过不少 AI 代码助手，Cursor 确实有它的优势：</p>
<ul>
<li><strong>自动理解上下文</strong>：你打开的文件、正在写的代码，它都能看到，不用你一遍遍解释</li>
<li><strong>理解整个项目</strong>：它不只是看当前文件，整个项目的代码库它都能理解</li>
<li><strong>智能补全</strong>：写代码的时候，它会根据上下文给你建议</li>
<li><strong>多文件编辑</strong>：一次可以改好几个相关文件，特别方便</li>
</ul>
<hr/>
<h2 data-id="heading-5">为什么提示词这么重要？</h2>
<h3 data-id="heading-6">提示词写得好，事半功倍</h3>
<p>我刚用 Cursor 时总是“写个 xxx”就递过去，结果要调好几轮才勉强可用；后来把需求讲清楚，基本一次成型。经验就是：<strong>提示词越具体，返工越少</strong>。</p>
<h3 data-id="heading-7">一个对比你就明白了</h3>
<p><strong>❌ 这样写（太简单）：</strong></p>
<pre><code class="hljs">写个函数
</code></pre>
<p><strong>✅ 这样写（清晰具体）：</strong></p>
<pre><code class="hljs language-sql" lang="sql">创建一个 TypeScript 函数，用于验证邮箱格式。
函数名：validateEmail
参数：email (string)
返回值：<span class="hljs-type">boolean</span>
要求：使用正则表达式验证，支持常见邮箱格式（如 <span class="hljs-keyword">user</span><span class="hljs-variable">@example</span>.com）
</code></pre>
<p>区别一眼可见：第二种提示词把语言、接口、要求说清楚，模型自然不需要猜。</p>
<h3 data-id="heading-8">深入理解：为什么会有这么大的差异？</h3>
<p>核心原因就三点：</p>
<p><strong>1. Token 概率分布</strong></p>
<p>当你只写"写个函数"时，模型看到的是：</p>
<ul>
<li>可能的语言：JavaScript、Python、TypeScript、Java...（概率分散）</li>
<li>可能的功能：任何功能（概率极度分散）</li>
<li>可能的风格：任何风格（概率分散）</li>
</ul>
<p>结果就是模型"猜"的成分很大，容易生成不符合预期的代码。</p>
<p>当你写详细提示词时：</p>
<ul>
<li>语言明确：TypeScript（概率集中）</li>
<li>功能明确：邮箱验证（概率集中）</li>
<li>要求明确：正则表达式（概率集中）</li>
</ul>
<p>模型就能准确预测出你想要的代码模式。</p>
<p><strong>2. 上下文检索</strong></p>
<p>Cursor 会根据提示词中的关键词检索相关代码。如果提示词太简单：</p>
<ul>
<li>检索到的代码可能不相关</li>
<li>模型可能参考错误的代码模式</li>
<li>生成的代码风格不一致</li>
</ul>
<p>详细的提示词能帮助 Cursor：</p>
<ul>
<li>准确检索到相关的代码文件</li>
<li>理解项目的代码风格和架构</li>
<li>生成符合项目规范的代码</li>
</ul>
<p><strong>3. 多轮对话</strong></p>
<p>第一轮提示词写得好：</p>
<ul>
<li>生成的代码基础好</li>
<li>后续优化只需要微调</li>
<li>对话上下文质量高</li>
</ul>
<p>第一轮提示词写得差：</p>
<ul>
<li>生成的代码需要大量修改</li>
<li>后续对话需要不断纠正</li>
<li>上下文被"污染"，影响后续生成</li>
</ul>
<h3 data-id="heading-9">实际数据对比</h3>
<p>我做过一个简单的测试，同样的功能，用不同质量的提示词：</p>





























<table><thead><tr><th>提示词质量</th><th>首次生成准确率</th><th>平均对话轮数</th><th>最终代码质量</th></tr></thead><tbody><tr><td>简单（1-2句话）</td><td>20%</td><td>5-8轮</td><td>中等</td></tr><tr><td>中等（基本要求）</td><td>60%</td><td>2-3轮</td><td>良好</td></tr><tr><td>详细（完整规范）</td><td>90%</td><td>1轮</td><td>优秀</td></tr></tbody></table>
<p><strong>结论很明显：花时间写好提示词，绝对值得。</strong></p>
<hr/>
<h2 data-id="heading-10">好提示词长什么样？</h2>
<p>一个靠谱的提示词通常包含 5 个要素：</p>
<h3 data-id="heading-11">1. 角色定义（可选，但有时候很有用）</h3>
<p>虽然 Cursor 本身就是代码助手，但有时候告诉它你的专业领域，它会更懂你的需求。</p>
<p><strong>比如：</strong></p>
<pre><code class="hljs">你是一位经验丰富的 React 开发工程师，擅长性能优化和最佳实践。
</code></pre>
<p>常规前端/后端其实不用强调角色，但跨领域（比如让它写数据管道、审安全）最好限定一下身份。</p>
<p><strong>深入理解：角色定义的作用机制</strong></p>
<p>角色定义其实是在调整模型的"注意力分布"。当你指定角色时：</p>
<ol>
<li>
<p><strong>激活相关模式</strong>：模型会优先激活与这个角色相关的训练数据模式</p>
<ul>
<li>"React 工程师" → 激活 React 最佳实践、Hooks、性能优化等模式</li>
<li>"数据科学家" → 激活数据处理、统计分析、机器学习等模式</li>
</ul>
</li>
<li>
<p><strong>调整输出风格</strong>：不同角色的代码风格不同</p>
<ul>
<li>前端工程师：更关注用户体验、响应式设计</li>
<li>后端工程师：更关注性能、安全性、可扩展性</li>
</ul>
</li>
<li>
<p><strong>影响技术选择</strong>：模型会根据角色选择合适的技术栈</p>
<ul>
<li>前端：React、Vue、Angular</li>
<li>后端：Node.js、Python、Go</li>
</ul>
</li>
</ol>
<p><strong>什么时候需要角色定义？</strong></p>
<ul>
<li>✅ 跨领域项目：前端做后端功能，需要明确角色</li>
<li>✅ 特定领域：数据科学、DevOps、嵌入式等专业领域</li>
<li>✅ 代码审查：需要特定视角（架构师、安全专家等）</li>
<li>❌ 常规开发：普通的前端/后端开发，Cursor 已经足够智能</li>
</ul>
<p><strong>高级技巧：组合角色</strong></p>
<p>对于复杂项目，可以组合多个角色：</p>
<pre><code class="hljs language-diff" lang="diff">你是一位资深的全栈开发工程师，同时具备：
<span class="hljs-deletion">- 前端：React 性能优化专家</span>
<span class="hljs-deletion">- 后端：Node.js 微服务架构师</span>
<span class="hljs-deletion">- DevOps：容器化和 CI/CD 实践者</span>
</code></pre>
<h3 data-id="heading-12">2. 任务描述（这个必须清楚）</h3>
<p>你得明确告诉 AI 要做什么。</p>
<p><strong>比如：</strong></p>
<pre><code class="hljs">重构以下组件，使用 React Hooks 替代类组件，并优化渲染性能。
</code></pre>
<p><strong>深入理解：任务描述的层次结构</strong></p>
<p>一段任务描述最好同时告诉它：</p>
<p><strong>层次 1：核心任务（必须）</strong></p>
<ul>
<li>做什么：重构、创建、修复、优化</li>
<li>对象：哪个组件、哪个函数、哪个文件</li>
</ul>
<p><strong>层次 2：具体目标（重要）</strong></p>
<ul>
<li>为什么：提高性能、改善可读性、修复 bug</li>
<li>怎么做：使用 Hooks、添加缓存、优化算法</li>
</ul>
<p><strong>层次 3：质量标准（加分）</strong></p>
<ul>
<li>性能指标：时间复杂度、渲染次数</li>
<li>代码质量：可读性、可维护性、可测试性</li>
</ul>
<p><strong>示例对比：</strong></p>
<p><strong>❌ 只有层次 1：</strong></p>
<pre><code class="hljs">重构这个组件
</code></pre>
<p><strong>✅ 包含层次 1+2：</strong></p>
<pre><code class="hljs">重构以下组件，使用 React Hooks 替代类组件，并优化渲染性能。
</code></pre>
<p><strong>✅✅ 包含所有层次：</strong></p>
<pre><code class="hljs language-diff" lang="diff">重构以下组件：
<span class="hljs-deletion">- 核心任务：将类组件转换为函数组件</span>
<span class="hljs-deletion">- 具体方法：使用 React Hooks（useState, useEffect, useCallback）</span>
<span class="hljs-deletion">- 性能目标：减少不必要的重新渲染，目标渲染次数 &lt; 3次/用户操作</span>
<span class="hljs-deletion">- 质量标准：保持功能完全一致，通过所有现有测试，代码可读性提升</span>
</code></pre>
<p><strong>任务描述的常见陷阱：</strong></p>
<ol>
<li><strong>动词不明确</strong>："优化"、"改进"太模糊，应该用"减少渲染"、"降低时间复杂度"</li>
<li><strong>目标冲突</strong>：同时要求"快速实现"和"完美代码"，应该明确优先级</li>
<li><strong>缺少验证标准</strong>：只说"优化性能"，不说如何验证，AI 不知道做到什么程度</li>
</ol>
<h3 data-id="heading-13">3. 上下文信息（很重要！）</h3>
<p>上下文不是越多越好，而是“刚好够用”。推荐按层次来给：</p>
<p><strong>比如：</strong></p>
<pre><code class="hljs language-css" lang="css">当前项目使用 TypeScript + React <span class="hljs-number">18</span>，状态管理使用 Redux Toolkit。
以下是需要重构的组件代码：
<span class="hljs-selector-attr">[代码片段]</span>
</code></pre>
<p><strong>深入理解：上下文信息的层次</strong></p>
<p>上下文信息应该包含多个层次：</p>
<p><strong>层次 1：项目级上下文（必须）</strong></p>
<ul>
<li>技术栈：框架、语言、版本</li>
<li>项目结构：目录组织、命名规范</li>
<li>依赖关系：使用的库、工具</li>
</ul>
<p><strong>层次 2：文件级上下文（重要）</strong></p>
<ul>
<li>相关文件：导入的文件、被导入的文件</li>
<li>代码风格：缩进、命名、注释风格</li>
<li>架构模式：设计模式、代码组织方式</li>
</ul>
<p><strong>层次 3：运行时上下文（加分）</strong></p>
<ul>
<li>环境信息：浏览器版本、Node 版本</li>
<li>性能要求：响应时间、内存限制</li>
<li>业务逻辑：功能需求、用户场景</li>
</ul>
<p><strong>示例：完整的上下文信息</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">项目上下文：
<span class="hljs-bullet">-</span> 技术栈：TypeScript 5.0 + React 18.2 + Redux Toolkit 1.9
<span class="hljs-bullet">-</span> 构建工具：Vite 4.0
<span class="hljs-bullet">-</span> 代码规范：ESLint + Prettier，遵循 Airbnb 规范
<span class="hljs-bullet">-</span> 项目结构：features-based 架构，每个功能模块独立

文件上下文：
<span class="hljs-bullet">-</span> 当前文件：src/features/user/components/UserProfile.tsx
<span class="hljs-bullet">-</span> 相关文件：
<span class="hljs-bullet">  *</span> src/features/user/types.ts（类型定义）
<span class="hljs-bullet">  *</span> src/features/user/hooks/useUser.ts（自定义 Hook）
<span class="hljs-bullet">  *</span> src/shared/components/Button.tsx（参考组件）
<span class="hljs-bullet">-</span> 代码风格：函数式组件，使用 Hooks，TypeScript 严格模式

运行时上下文：
<span class="hljs-bullet">-</span> 目标浏览器：Chrome 90+, Safari 14+, Firefox 88+
<span class="hljs-bullet">-</span> 性能要求：首屏渲染 &lt; 1s，交互响应 &lt; 100ms
<span class="hljs-bullet">-</span> 业务场景：用户资料展示，支持编辑和保存
</code></pre>
<p><strong>Cursor 的自动上下文 vs 手动上下文</strong></p>
<p>Cursor 会自动读取：</p>
<ul>
<li>✅ 当前打开的文件</li>
<li>✅ 项目结构</li>
<li>✅ 最近编辑的文件</li>
</ul>
<p>但你需要手动提供：</p>
<ul>
<li>⚠️ 业务逻辑和需求背景</li>
<li>⚠️ 性能要求和约束</li>
<li>⚠️ 代码风格偏好</li>
<li>⚠️ 架构决策和设计原则</li>
</ul>
<p><strong>技巧：利用文件引用</strong></p>
<p>在提示词中直接引用文件，Cursor 会自动读取：</p>
<pre><code class="hljs language-css" lang="css">参考 <span class="hljs-attribute">src</span>/components/<span class="hljs-selector-tag">Button</span><span class="hljs-selector-class">.tsx</span> 的实现方式，
创建一个类似的 <span class="hljs-selector-tag">Input</span> 组件。
要求保持一致的：
- TypeScript 接口定义风格
- 错误处理模式
- 测试覆盖方式
</code></pre>
<h3 data-id="heading-14">4. 约束条件（避免 AI 乱来）</h3>
<p>明确告诉 AI 什么必须做，什么不能做。</p>
<p><strong>比如：</strong></p>
<pre><code class="hljs language-diff" lang="diff">要求：
<span class="hljs-deletion">- 必须使用 TypeScript 严格模式</span>
<span class="hljs-deletion">- 遵循 ESLint 规则</span>
<span class="hljs-deletion">- 添加适当的错误处理</span>
<span class="hljs-deletion">- 包含 JSDoc 注释</span>
</code></pre>
<p><strong>深入理解：约束条件的分类</strong></p>
<p>常见约束可以分这几类：</p>
<p><strong>1. 技术约束（必须遵守）</strong></p>
<ul>
<li>语言版本：TypeScript 5.0 strict mode</li>
<li>框架版本：React 18.2，不能使用已废弃的 API</li>
<li>工具限制：必须通过 ESLint，不能使用 any 类型</li>
</ul>
<p><strong>2. 架构约束（保持一致性）</strong></p>
<ul>
<li>代码组织：遵循项目的 features-based 架构</li>
<li>设计模式：使用项目统一的状态管理模式</li>
<li>接口规范：遵循项目的 API 接口规范</li>
</ul>
<p><strong>3. 性能约束（量化指标）</strong></p>
<ul>
<li>渲染性能：组件重新渲染次数 &lt; 3次/用户操作</li>
<li>加载性能：首屏加载时间 &lt; 1s</li>
<li>内存限制：不能创建超过 1000 个 DOM 节点</li>
</ul>
<p><strong>4. 安全约束（防止漏洞）</strong></p>
<ul>
<li>输入验证：所有用户输入必须验证和转义</li>
<li>权限检查：敏感操作必须检查权限</li>
<li>数据保护：不能在前端存储敏感信息</li>
</ul>
<p><strong>5. 兼容性约束（确保可用性）</strong></p>
<ul>
<li>浏览器支持：Chrome 90+, Safari 14+, Firefox 88+</li>
<li>响应式设计：支持移动端（320px+）和桌面端（1920px+）</li>
<li>可访问性：符合 WCAG 2.1 AA 标准</li>
</ul>
<p><strong>高级技巧：约束条件的优先级</strong></p>
<p>当约束条件冲突时，明确优先级：</p>
<pre><code class="hljs language-markdown" lang="markdown">约束条件（按优先级排序）：
<span class="hljs-bullet">1.</span> P0（必须）：TypeScript 严格模式，通过所有测试
<span class="hljs-bullet">2.</span> P1（重要）：性能要求，代码可读性
<span class="hljs-bullet">3.</span> P2（可选）：代码注释，文档完整性

如果 P0 和 P1 冲突，优先满足 P0。
</code></pre>
<p><strong>常见陷阱：约束条件太宽泛</strong></p>
<p><strong>❌ 太宽泛：</strong></p>
<pre><code class="hljs">要求：代码质量要高
</code></pre>
<p><strong>✅ 具体明确：</strong></p>
<pre><code class="hljs language-diff" lang="diff">要求：
<span class="hljs-deletion">- 代码质量：通过 ESLint 检查，无 warning</span>
<span class="hljs-deletion">- 类型安全：TypeScript 严格模式，无 any 类型</span>
<span class="hljs-deletion">- 测试覆盖：单元测试覆盖率 &gt; 80%</span>
<span class="hljs-deletion">- 性能指标：组件渲染时间 &lt; 16ms（60fps）</span>
</code></pre>
<h3 data-id="heading-15">5. 输出格式（让结果更清晰）</h3>
<p>告诉 AI 你希望它怎么回答。</p>
<p><strong>比如：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">请以以下格式输出：
<span class="hljs-bullet">1.</span> 重构后的代码
<span class="hljs-bullet">2.</span> 改动说明
<span class="hljs-bullet">3.</span> 性能优化点
</code></pre>
<p><strong>深入理解：输出格式的重要性</strong></p>
<p>明确的输出格式有几个好处：</p>
<p><strong>1. 结构化信息，便于理解</strong></p>
<ul>
<li>代码和说明分离，容易阅读</li>
<li>改动点清晰，便于审查</li>
<li>性能数据量化，便于验证</li>
</ul>
<p><strong>2. 便于后续处理</strong></p>
<ul>
<li>可以直接复制代码使用</li>
<li>改动说明可以用于代码审查</li>
<li>性能数据可以用于报告</li>
</ul>
<p><strong>3. 减少歧义</strong></p>
<ul>
<li>明确告诉 AI 要输出什么</li>
<li>避免 AI 生成不必要的内容</li>
<li>确保关键信息不遗漏</li>
</ul>
<p><strong>高级输出格式示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini">请按以下格式输出：

<span class="hljs-comment">## 1. 重构后的代码</span>
<span class="hljs-section">[完整的代码，包含所有文件]</span>

<span class="hljs-comment">## 2. 改动说明</span>
<span class="hljs-comment">### 2.1 主要改动</span>
- <span class="hljs-section">[改动1]</span>：说明原因和影响
- <span class="hljs-section">[改动2]</span>：说明原因和影响

<span class="hljs-comment">### 2.2 性能优化</span>
- <span class="hljs-section">[优化1]</span>：优化前 vs 优化后的数据对比
- <span class="hljs-section">[优化2]</span>：优化前 vs 优化后的数据对比

<span class="hljs-comment">### 2.3 潜在风险</span>
- <span class="hljs-section">[风险1]</span>：说明和缓解措施
- <span class="hljs-section">[风险2]</span>：说明和缓解措施

<span class="hljs-comment">## 3. 测试建议</span>
- <span class="hljs-section">[测试用例1]</span>：需要测试的场景
- <span class="hljs-section">[测试用例2]</span>：需要测试的场景

<span class="hljs-comment">## 4. 后续优化建议</span>
- <span class="hljs-section">[建议1]</span>：可以进一步优化的点
- <span class="hljs-section">[建议2]</span>：可以进一步优化的点
</code></pre>
<p><strong>输出格式的常见问题：</strong></p>
<ol>
<li><strong>格式太简单</strong>：只说"输出代码"，没有说明、没有改动点</li>
<li><strong>格式太复杂</strong>：要求太多细节，AI 可能遗漏</li>
<li><strong>格式不匹配需求</strong>：代码审查和代码生成的格式应该不同</li>
</ol>
<p><strong>技巧：根据任务调整格式</strong></p>
<ul>
<li><strong>代码生成</strong>：代码 + 使用说明 + 注意事项</li>
<li><strong>代码重构</strong>：代码 + 改动说明 + 性能对比</li>
<li><strong>Bug 修复</strong>：修复方案 + 原因分析 + 预防措施</li>
<li><strong>代码审查</strong>：问题清单 + 严重程度 + 改进建议</li>
</ul>
<hr/>
<h2 data-id="heading-16">写提示词的几个黄金法则</h2>
<h3 data-id="heading-17">法则 1：越具体越好</h3>
<p><strong>❌ 太模糊：</strong></p>
<pre><code class="hljs">优化这个函数
</code></pre>
<p><strong>✅ 具体明确：</strong></p>
<pre><code class="hljs language-scss" lang="scss">优化这个函数的性能，将时间复杂度从 <span class="hljs-built_in">O</span>(n²) 降低到 <span class="hljs-built_in">O</span>(n log n)，
使用更高效的算法，并添加适当的缓存机制。
</code></pre>
<p>AI 不是人，它不会猜你的意思。你说得越具体，它越能理解。</p>
<p><strong>深入分析：具体性的维度</strong></p>
<p>"具体"不只是说更多细节，而是要在关键维度上明确：</p>
<p><strong>维度 1：技术维度</strong></p>
<ul>
<li>❌ "优化性能" → ✅ "将时间复杂度从 O(n²) 降到 O(n log n)"</li>
<li>❌ "用更好的方法" → ✅ "使用 Map 数据结构替代数组查找"</li>
<li>❌ "处理错误" → ✅ "捕获异常并返回 { error: string, data: null }"</li>
</ul>
<p><strong>维度 2：功能维度</strong></p>
<ul>
<li>❌ "做个搜索" → ✅ "实现实时搜索，支持中文拼音匹配，高亮显示结果"</li>
<li>❌ "加个按钮" → ✅ "添加主要操作按钮，支持 loading 状态，点击后调用 API"</li>
</ul>
<p><strong>维度 3：质量维度</strong></p>
<ul>
<li>❌ "代码要好" → ✅ "通过 ESLint 检查，TypeScript 严格模式，测试覆盖率 &gt; 80%"</li>
<li>❌ "性能要好" → ✅ "首屏渲染 &lt; 1s，交互响应 &lt; 100ms，内存占用 &lt; 50MB"</li>
</ul>
<p><strong>维度 4：边界维度</strong></p>
<ul>
<li>❌ "处理异常" → ✅ "处理网络错误（超时、断网）、服务器错误（4xx、5xx）、数据格式错误"</li>
<li>❌ "支持移动端" → ✅ "支持 320px-1920px 宽度，触摸操作，横竖屏切换"</li>
</ul>
<p><strong>实战技巧：使用量化指标</strong></p>
<p>把模糊的要求变成可测量的指标：</p>

























<table><thead><tr><th>模糊要求</th><th>量化指标</th></tr></thead><tbody><tr><td>"性能好"</td><td>"渲染时间 &lt; 16ms，内存 &lt; 100MB"</td></tr><tr><td>"代码质量高"</td><td>"ESLint 0 warning，测试覆盖率 &gt; 80%"</td></tr><tr><td>"用户体验好"</td><td>"首屏 &lt; 1s，交互响应 &lt; 100ms"</td></tr><tr><td>"兼容性好"</td><td>"Chrome 90+, Safari 14+, Firefox 88+"</td></tr></tbody></table>
<p><strong>常见陷阱：假具体</strong></p>
<p>看起来具体，实际上还是模糊：</p>
<p><strong>❌ 假具体：</strong></p>
<pre><code class="hljs">优化这个函数，让它更快、更好、更稳定
</code></pre>
<p><strong>✅ 真具体：</strong></p>
<pre><code class="hljs language-scss" lang="scss">优化这个函数：
- 性能：时间复杂度从 <span class="hljs-built_in">O</span>(n²) 降到 <span class="hljs-built_in">O</span>(n log n)
- 稳定性：添加输入验证，处理边界情况（空数组、null、undefined）
- 可维护性：添加 JSDoc 注释，提取可复用逻辑
</code></pre>
<h3 data-id="heading-18">法则 2：给足上下文</h3>
<p><strong>❌ 缺少上下文：</strong></p>
<pre><code class="hljs">修复这个 bug
</code></pre>
<p><strong>✅ 提供上下文：</strong></p>
<pre><code class="hljs language-bash" lang="bash">在用户登录功能中，当输入错误的密码时，页面会崩溃。
错误信息显示：<span class="hljs-string">'Cannot read property '</span>token<span class="hljs-string">' of undefined'</span>。
请检查登录 API 调用的错误处理逻辑。
</code></pre>
<p>没有上下文，AI 根本不知道你在说什么。</p>
<p><strong>深入分析：上下文的层次和优先级</strong></p>
<p>上下文不是越多越好，而是要<strong>相关且必要</strong>。我总结了一个上下文优先级模型：</p>
<p><strong>P0 上下文（必须）：</strong></p>
<ul>
<li>当前代码：正在处理的代码片段</li>
<li>错误信息：具体的错误消息和堆栈</li>
<li>复现步骤：如何触发问题</li>
</ul>
<p><strong>P1 上下文（重要）：</strong></p>
<ul>
<li>相关文件：导入的文件、被导入的文件</li>
<li>技术栈：使用的框架、库、版本</li>
<li>业务逻辑：功能需求和用户场景</li>
</ul>
<p><strong>P2 上下文（可选）：</strong></p>
<ul>
<li>项目结构：整体架构和组织方式</li>
<li>历史背景：为什么这样设计</li>
<li>未来计划：后续可能的变化</li>
</ul>
<p><strong>实战技巧：上下文的选择策略</strong></p>
<ol>
<li>
<p><strong>相关性原则</strong>：只提供与当前任务相关的上下文</p>
<ul>
<li>Bug 修复 → 错误信息、相关代码、复现步骤</li>
<li>代码重构 → 当前代码、相关文件、架构模式</li>
<li>性能优化 → 性能数据、瓶颈分析、优化目标</li>
</ul>
</li>
<li>
<p><strong>最小化原则</strong>：提供最少的必要上下文</p>
<ul>
<li>不要复制整个文件，只复制相关部分</li>
<li>不要列出所有依赖，只列出关键依赖</li>
<li>不要描述整个项目，只描述相关模块</li>
</ul>
</li>
<li>
<p><strong>结构化原则</strong>：用结构化的方式组织上下文</p>
<pre><code class="hljs language-ini" lang="ini">上下文信息：

<span class="hljs-comment">## 当前问题</span>
<span class="hljs-section">[问题描述]</span>

<span class="hljs-comment">## 相关代码</span>
<span class="hljs-section">[代码片段]</span>

<span class="hljs-comment">## 错误信息</span>
<span class="hljs-section">[错误详情]</span>

<span class="hljs-comment">## 环境信息</span>
<span class="hljs-section">[技术栈、版本等]</span>
</code></pre>
</li>
</ol>
<p><strong>高级技巧：动态上下文</strong></p>
<p>根据对话进展，动态调整上下文：</p>
<ul>
<li><strong>第一轮</strong>：提供基础上下文，让 AI 理解问题</li>
<li><strong>第二轮</strong>：如果 AI 理解有偏差，补充更具体的上下文</li>
<li><strong>第三轮</strong>：针对 AI 的问题，提供精确的上下文</li>
</ul>
<p><strong>常见陷阱：上下文过载</strong></p>
<p>提供太多不相关的上下文，反而会干扰 AI：</p>
<p><strong>❌ 上下文过载：</strong></p>
<pre><code class="hljs language-css" lang="css">修复这个 bug。项目是用 React <span class="hljs-number">18</span> + TypeScript <span class="hljs-number">5.0</span> + Vite <span class="hljs-number">4.0</span> 构建的，
使用了 Redux Toolkit 做状态管理，Tailwind CSS 做样式，Jest 做测试，
ESLint 做代码检查，Prettier 做格式化，GitHub Actions 做 CI/CD...
<span class="hljs-selector-attr">[然后才说实际的 bug]</span>
</code></pre>
<p><strong>✅ 精准上下文：</strong></p>
<pre><code class="hljs language-python" lang="python">修复以下 bug：
- 问题：用户登录后，页面显示空白
- 错误：控制台显示 <span class="hljs-string">'Cannot read property '</span>use<span class="hljs-string">r' of undefined'</span>
- 位置：src/features/auth/components/LoginForm.tsx:<span class="hljs-number">45</span>
- 相关代码：[只包含相关的代码片段]
</code></pre>
<h3 data-id="heading-19">法则 3：复杂任务分步骤</h3>
<p>遇到复杂的功能，别一次性说完，分步骤来。</p>
<p><strong>比如：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">请按以下步骤实现用户认证功能：
<span class="hljs-bullet">1.</span> 创建登录表单组件（包含邮箱和密码输入）
<span class="hljs-bullet">2.</span> 实现表单验证逻辑
<span class="hljs-bullet">3.</span> 集成认证 API
<span class="hljs-bullet">4.</span> 处理成功和失败场景
<span class="hljs-bullet">5.</span> 添加加载状态和错误提示
</code></pre>
<p>这样 AI 更容易理解，你也能一步步确认。</p>
<p><strong>深入分析：分步骤的策略</strong></p>
<p>分步骤不是简单的"1、2、3"，而是要遵循一定的策略：</p>
<p><strong>策略 1：依赖关系优先</strong></p>
<ul>
<li>先做基础功能，再做增强功能</li>
<li>先做核心逻辑，再做边缘情况</li>
<li>先做功能实现，再做性能优化</li>
</ul>
<p><strong>策略 2：可验证性优先</strong></p>
<ul>
<li>每个步骤都能独立验证</li>
<li>每个步骤都有明确的完成标准</li>
<li>每个步骤都能看到实际效果</li>
</ul>
<p><strong>策略 3：风险控制优先</strong></p>
<ul>
<li>高风险步骤先做，早发现问题</li>
<li>关键路径先做，确保核心功能</li>
<li>依赖外部系统的步骤后做，减少阻塞</li>
</ul>
<p><strong>高级分步骤示例：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">实现用户认证系统，按以下步骤进行：

<span class="hljs-section">## 阶段 1：基础功能（必须完成）</span>
<span class="hljs-bullet">1.</span> 创建登录表单 UI
<span class="hljs-bullet">   -</span> 输入框：邮箱、密码
<span class="hljs-bullet">   -</span> 按钮：登录、注册
<span class="hljs-bullet">   -</span> 验证：前端基础验证（非空、格式）
<span class="hljs-bullet">   -</span> 验证标准：表单能正常显示和输入

<span class="hljs-bullet">2.</span> 实现 API 集成
<span class="hljs-bullet">   -</span> 创建 API 服务函数
<span class="hljs-bullet">   -</span> 处理请求/响应
<span class="hljs-bullet">   -</span> 错误处理：网络错误、服务器错误
<span class="hljs-bullet">   -</span> 验证标准：能成功调用 API，处理错误

<span class="hljs-section">## 阶段 2：增强功能（重要）</span>
<span class="hljs-bullet">3.</span> 完善表单验证
<span class="hljs-bullet">   -</span> 邮箱格式验证
<span class="hljs-bullet">   -</span> 密码强度验证
<span class="hljs-bullet">   -</span> 实时反馈
<span class="hljs-bullet">   -</span> 验证标准：所有验证规则生效

<span class="hljs-bullet">4.</span> 状态管理
<span class="hljs-bullet">   -</span> 用户状态存储
<span class="hljs-bullet">   -</span> 登录状态持久化
<span class="hljs-bullet">   -</span> 路由保护
<span class="hljs-bullet">   -</span> 验证标准：登录状态正确保存和恢复

<span class="hljs-section">## 阶段 3：优化和增强（可选）</span>
<span class="hljs-bullet">5.</span> 用户体验优化
<span class="hljs-bullet">   -</span> 加载状态
<span class="hljs-bullet">   -</span> 错误提示
<span class="hljs-bullet">   -</span> 成功反馈
<span class="hljs-bullet">   -</span> 验证标准：用户操作有明确反馈

<span class="hljs-bullet">6.</span> 安全性增强
<span class="hljs-bullet">   -</span> Token 刷新
<span class="hljs-bullet">   -</span> 自动登出
<span class="hljs-bullet">   -</span> 安全存储
<span class="hljs-bullet">   -</span> 验证标准：符合安全最佳实践
</code></pre>
<p><strong>技巧：使用检查点</strong></p>
<p>在每个步骤后设置检查点，确保质量：</p>
<pre><code class="hljs language-diff" lang="diff">步骤 1：创建基础组件
<span class="hljs-deletion">- 完成标准：组件能正常渲染</span>
<span class="hljs-deletion">- 检查点：通过 TypeScript 编译，无 ESLint 错误</span>
<span class="hljs-deletion">- 下一步：确认后再继续</span>

步骤 2：添加功能逻辑
<span class="hljs-deletion">- 完成标准：功能正常工作</span>
<span class="hljs-deletion">- 检查点：通过单元测试，手动测试通过</span>
<span class="hljs-deletion">- 下一步：确认后再继续</span>
</code></pre>
<p><strong>常见陷阱：步骤划分不当</strong></p>
<ol>
<li><strong>步骤太细</strong>：每个小改动都算一步，导致步骤过多</li>
<li><strong>步骤太粗</strong>：一个步骤包含太多内容，难以验证</li>
<li><strong>步骤无序</strong>：没有考虑依赖关系，导致无法执行</li>
<li><strong>缺少验证</strong>：没有明确的完成标准，不知道什么时候算完成</li>
</ol>
<h3 data-id="heading-20">法则 4：给示例最管用</h3>
<p>有时候说再多，不如给个例子。</p>
<p><strong>比如：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">创建一个工具函数，用于格式化日期。
输入示例：<span class="hljs-string">'2024-01-15'</span>
输出示例：<span class="hljs-string">'2024年1月15日'</span>
</code></pre>
<p>看到例子，AI 立马就知道你要什么格式了。</p>
<p><strong>深入分析：示例的类型和作用</strong></p>
<p>示例不只是"输入输出"，有多种类型，每种都有不同的作用：</p>
<p><strong>类型 1：输入输出示例（最常用）</strong></p>
<ul>
<li>作用：明确数据格式和转换规则</li>
<li>适用：工具函数、数据转换、格式化</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">创建一个日期格式化函数：
输入：<span class="hljs-string">'2024-01-15'</span> → 输出：<span class="hljs-string">'2024年1月15日'</span>
输入：<span class="hljs-string">'2024-12-25'</span> → 输出：<span class="hljs-string">'2024年12月25日'</span>
</code></pre>
<p><strong>类型 2：代码风格示例（保持一致性）</strong></p>
<ul>
<li>作用：展示期望的代码风格和模式</li>
<li>适用：代码重构、新功能开发</li>
</ul>
<pre><code class="hljs language-css" lang="css">参考以下代码风格创建新组件：
<span class="hljs-selector-attr">[示例代码：展示命名、结构、注释风格]</span>

要求新组件保持相同的风格。
</code></pre>
<p><strong>类型 3：行为示例（明确交互）</strong></p>
<ul>
<li>作用：描述用户交互和系统响应</li>
<li>适用：UI 组件、交互功能</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">实现搜索功能：
- 用户输入 <span class="hljs-string">"react"</span> → 显示匹配结果，高亮 <span class="hljs-string">"react"</span>
- 用户输入空字符串 → 显示所有结果
- 用户输入不存在的关键词 → 显示 <span class="hljs-string">"未找到结果"</span>
</code></pre>
<p><strong>类型 4：边界情况示例（处理异常）</strong></p>
<ul>
<li>作用：明确如何处理边界和异常情况</li>
<li>适用：错误处理、数据验证</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">处理用户输入：
- 正常输入：<span class="hljs-string">"user@example.com"</span> → 通过验证
- 边界情况：<span class="hljs-string">""</span> → 返回错误 <span class="hljs-string">"邮箱不能为空"</span>
- 异常情况：<span class="hljs-literal">null</span> → 返回错误 <span class="hljs-string">"邮箱格式不正确"</span>
</code></pre>
<p><strong>类型 5：完整场景示例（端到端）</strong></p>
<ul>
<li>作用：展示完整的使用场景</li>
<li>适用：复杂功能、系统集成</li>
</ul>
<pre><code class="hljs language-markdown" lang="markdown">实现用户注册流程：
<span class="hljs-bullet">1.</span> 用户填写表单（邮箱、密码、确认密码）
<span class="hljs-bullet">2.</span> 点击注册按钮
<span class="hljs-bullet">3.</span> 显示加载状态
<span class="hljs-bullet">4.</span> 调用注册 API
<span class="hljs-bullet">5.</span> 成功：显示成功消息，跳转登录页
<span class="hljs-bullet">6.</span> 失败：显示错误消息，保持表单数据
</code></pre>
<p><strong>高级技巧：多示例对比</strong></p>
<p>用多个示例展示不同的场景：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">创建表单验证函数，支持以下场景：</span>

<span class="hljs-string">场景</span> <span class="hljs-number">1</span><span class="hljs-string">：正常情况</span>
<span class="hljs-string">输入：{</span> <span class="hljs-attr">email:</span> <span class="hljs-string">"user@example.com"</span><span class="hljs-string">,</span> <span class="hljs-attr">password:</span> <span class="hljs-string">"Password123"</span> <span class="hljs-string">}</span>
<span class="hljs-string">输出：{</span> <span class="hljs-attr">valid:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span> <span class="hljs-attr">errors:</span> {} <span class="hljs-string">}</span>

<span class="hljs-string">场景</span> <span class="hljs-number">2</span><span class="hljs-string">：邮箱格式错误</span>
<span class="hljs-string">输入：{</span> <span class="hljs-attr">email:</span> <span class="hljs-string">"invalid-email"</span><span class="hljs-string">,</span> <span class="hljs-attr">password:</span> <span class="hljs-string">"Password123"</span> <span class="hljs-string">}</span>
<span class="hljs-string">输出：{</span> <span class="hljs-attr">valid:</span> <span class="hljs-literal">false</span><span class="hljs-string">,</span> <span class="hljs-attr">errors:</span> { <span class="hljs-attr">email:</span> <span class="hljs-string">"邮箱格式不正确"</span> } <span class="hljs-string">}</span>

<span class="hljs-string">场景</span> <span class="hljs-number">3</span><span class="hljs-string">：密码太短</span>
<span class="hljs-string">输入：{</span> <span class="hljs-attr">email:</span> <span class="hljs-string">"user@example.com"</span><span class="hljs-string">,</span> <span class="hljs-attr">password:</span> <span class="hljs-string">"123"</span> <span class="hljs-string">}</span>
<span class="hljs-string">输出：{</span> <span class="hljs-attr">valid:</span> <span class="hljs-literal">false</span><span class="hljs-string">,</span> <span class="hljs-attr">errors:</span> { <span class="hljs-attr">password:</span> <span class="hljs-string">"密码至少8位"</span> } <span class="hljs-string">}</span>

<span class="hljs-string">场景</span> <span class="hljs-number">4</span><span class="hljs-string">：多个错误</span>
<span class="hljs-string">输入：{</span> <span class="hljs-attr">email:</span> <span class="hljs-string">"invalid"</span><span class="hljs-string">,</span> <span class="hljs-attr">password:</span> <span class="hljs-string">"123"</span> <span class="hljs-string">}</span>
<span class="hljs-string">输出：{</span> <span class="hljs-attr">valid:</span> <span class="hljs-literal">false</span><span class="hljs-string">,</span> <span class="hljs-attr">errors:</span> { <span class="hljs-attr">email:</span> <span class="hljs-string">"邮箱格式不正确"</span>, <span class="hljs-attr">password:</span> <span class="hljs-string">"密码至少8位"</span> } <span class="hljs-string">}</span>
</code></pre>
<p><strong>常见陷阱：示例不充分</strong></p>
<ol>
<li><strong>只有正常情况</strong>：没有边界情况和异常处理</li>
<li><strong>示例太少</strong>：只有一个示例，无法覆盖所有场景</li>
<li><strong>示例不典型</strong>：选择了不常见的场景，误导 AI</li>
<li><strong>示例过时</strong>：使用了旧版本的 API 或模式</li>
</ol>
<h3 data-id="heading-21">法则 5：明确边界</h3>
<p>告诉 AI 什么该做，什么不该做。</p>
<p><strong>比如：</strong></p>
<pre><code class="hljs language-diff" lang="diff">实现一个搜索功能：
<span class="hljs-deletion">- 应该：支持模糊搜索、实时搜索、高亮匹配结果</span>
<span class="hljs-deletion">- 不应该：修改现有的数据模型、影响其他功能</span>
</code></pre>
<p>这样 AI 就不会乱改你的代码了。</p>
<p><strong>深入分析：边界的多个维度</strong></p>
<p>边界不只是"应该"和"不应该"，要从多个维度明确：</p>
<p><strong>维度 1：功能边界</strong></p>
<ul>
<li>做什么：明确要实现的功能</li>
<li>不做什么：明确不要实现的功能</li>
<li>做到什么程度：明确功能的完整性和深度</li>
</ul>
<p><strong>维度 2：代码边界</strong></p>
<ul>
<li>可以修改：哪些文件可以改</li>
<li>不能修改：哪些文件不能动</li>
<li>可以新增：可以创建哪些新文件</li>
<li>不能新增：不能创建哪些文件</li>
</ul>
<p><strong>维度 3：影响边界</strong></p>
<ul>
<li>可以影响：哪些功能可以受影响</li>
<li>不能影响：哪些功能必须保持不变</li>
<li>兼容性要求：必须保持向后兼容</li>
</ul>
<p><strong>维度 4：技术边界</strong></p>
<ul>
<li>可以使用：哪些技术、库、API</li>
<li>不能使用：哪些技术被禁止</li>
<li>版本限制：必须使用特定版本</li>
</ul>
<p><strong>高级边界定义示例：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">实现搜索功能，边界如下：

<span class="hljs-section">## 功能边界</span>
应该实现：
<span class="hljs-bullet">-</span> ✅ 实时搜索（输入时即时显示结果）
<span class="hljs-bullet">-</span> ✅ 模糊匹配（支持部分关键词匹配）
<span class="hljs-bullet">-</span> ✅ 结果高亮（高亮匹配的关键词）
<span class="hljs-bullet">-</span> ✅ 空状态处理（无结果时显示提示）

不应该实现：
<span class="hljs-bullet">-</span> ❌ 搜索历史（不在本次需求内）
<span class="hljs-bullet">-</span> ❌ 搜索建议（不在本次需求内）
<span class="hljs-bullet">-</span> ❌ 高级筛选（不在本次需求内）

<span class="hljs-section">## 代码边界</span>
可以修改：
<span class="hljs-bullet">-</span> ✅ src/features/search/ 目录下的所有文件
<span class="hljs-bullet">-</span> ✅ src/shared/components/SearchInput.tsx（如果存在）

不能修改：
<span class="hljs-bullet">-</span> ❌ src/features/user/ 目录（用户相关功能）
<span class="hljs-bullet">-</span> ❌ src/api/ 目录（API 接口定义）
<span class="hljs-bullet">-</span> ❌ src/types/ 目录（全局类型定义）

可以新增：
<span class="hljs-bullet">-</span> ✅ src/features/search/components/ 下的新组件
<span class="hljs-bullet">-</span> ✅ src/features/search/hooks/ 下的新 Hook

<span class="hljs-section">## 影响边界</span>
可以影响：
<span class="hljs-bullet">-</span> ✅ 搜索结果展示区域
<span class="hljs-bullet">-</span> ✅ 搜索输入框的交互

不能影响：
<span class="hljs-bullet">-</span> ❌ 其他功能的正常使用
<span class="hljs-bullet">-</span> ❌ 现有的数据流和状态管理
<span class="hljs-bullet">-</span> ❌ 页面的其他部分

兼容性要求：
<span class="hljs-bullet">-</span> ✅ 必须保持现有 API 接口不变
<span class="hljs-bullet">-</span> ✅ 必须保持现有组件接口不变

<span class="hljs-section">## 技术边界</span>
必须使用：
<span class="hljs-bullet">-</span> ✅ React 18.2（项目当前版本）
<span class="hljs-bullet">-</span> ✅ TypeScript 5.0 strict mode
<span class="hljs-bullet">-</span> ✅ 项目现有的状态管理方案

不能使用：
<span class="hljs-bullet">-</span> ❌ 新的第三方库（除非必要且经过批准）
<span class="hljs-bullet">-</span> ❌ 实验性的 API 或特性
<span class="hljs-bullet">-</span> ❌ 已废弃的 API
</code></pre>
<p><strong>技巧：使用白名单和黑名单</strong></p>
<p>用白名单（允许）和黑名单（禁止）明确边界：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 白名单（允许）</span>
<span class="hljs-bullet">-</span> 可以使用的技术：React Hooks, TypeScript, Tailwind CSS
<span class="hljs-bullet">-</span> 可以修改的文件：src/components/Search/
<span class="hljs-bullet">-</span> 可以实现的功能：搜索、高亮、过滤

<span class="hljs-section">## 黑名单（禁止）</span>
<span class="hljs-bullet">-</span> 不能使用的技术：jQuery, class 组件
<span class="hljs-bullet">-</span> 不能修改的文件：src/api/, src/types/
<span class="hljs-bullet">-</span> 不能实现的功能：搜索历史、高级筛选
</code></pre>
<p><strong>常见陷阱：边界不明确</strong></p>
<ol>
<li><strong>只说"应该"，不说"不应该"</strong>：AI 可能实现多余的功能</li>
<li><strong>边界太宽泛</strong>："不影响其他功能"太模糊，应该具体说明</li>
<li><strong>边界冲突</strong>：同时说"可以修改"和"不能修改"同一文件</li>
<li><strong>缺少验证</strong>：没有说明如何验证边界是否被遵守</li>
</ol>
<hr/>
<h2 data-id="heading-22">总结</h2>
<ol>
<li><strong>提示词的本质</strong>：是与 AI 模型的交互协议，质量直接影响输出</li>
<li><strong>提示词的重要性</strong>：好的提示词能大幅提高开发效率</li>
<li><strong>提示词的结构</strong>：包含角色、任务、上下文、约束、输出格式 5 个部分</li>
<li><strong>黄金法则</strong>：具体明确、给足上下文、分步骤、给示例、明确边界</li>
</ol>
<p>掌握了这些基础知识，你就可以开始写有效的提示词了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[element-ui：el-autocomplete实现滚动触底翻页]]></title>    <link>https://juejin.cn/post/7573617944519147520</link>    <guid>https://juejin.cn/post/7573617944519147520</guid>    <pubDate>2025-11-18T08:38:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573617944519147520" data-draft-id="7573670400153501748" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="element-ui：el-autocomplete实现滚动触底翻页"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-18T08:38:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1099167360628462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            element-ui：el-autocomplete实现滚动触底翻页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167360628462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:38:29.000Z" title="Tue Nov 18 2025 08:38:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">需求描述</h3>
<p>element-ui的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3Del-autocomplete%26spm%3D1001.2101.3001.7020" target="_blank" title="https://so.csdn.net/so/search?q=el-autocomplete&amp;spm=1001.2101.3001.7020" ref="nofollow noopener noreferrer">el-autocomplete</a> 组件支持远程搜索输入建议，不过不能翻页，只能搜索到首页内容</p>
<p>要求实现下滑到底部的时候，触发翻页请求，查看更多结果</p>
<h3 data-id="heading-1">实现思路</h3>
<p>想办法监听到滚动事件，就能判断是否到达底部，然后进行<code>page++</code> 搜索</p>
<p>通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3D%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589%25E6%258C%2587%25E4%25BB%25A4%26spm%3D1001.2101.3001.7020" target="_blank" title="https://so.csdn.net/so/search?q=%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%87%E4%BB%A4&amp;spm=1001.2101.3001.7020" ref="nofollow noopener noreferrer">自定义指令</a><code>v-autocomplete-scroll</code> 来监听滚动事件，需要注意事件的监听与移除监听</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-autocomplete</span>
    <span class="hljs-attr">popper-class</span>=<span class="hljs-string">"mo-autocomplete"</span>
    <span class="hljs-attr">v-model</span>=<span class="hljs-string">"keyword"</span>
    <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 300px"</span>
    <span class="hljs-attr">:fetch-suggestions</span>=<span class="hljs-string">"querySearch"</span>
    <span class="hljs-attr">:debounce</span>=<span class="hljs-string">"800"</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"autocomplete"</span>
    <span class="hljs-attr">v-autocomplete-scroll</span>=<span class="hljs-string">"handleScroll"</span>
    <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"搜索"</span>
    @<span class="hljs-attr">blur</span>=<span class="hljs-string">"handleBlur"</span>
  &gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-autocomplete</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> apiData <span class="hljs-keyword">from</span> <span class="hljs-string">'./data.json'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,

  <span class="hljs-attr">props</span>: {},

  <span class="hljs-attr">computed</span>: {},

  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">size</span>: <span class="hljs-number">20</span>,
      <span class="hljs-attr">keyword</span>: <span class="hljs-string">''</span>,
    }
  },

  <span class="hljs-attr">directives</span>: {
    <span class="hljs-string">'autocomplete-scroll'</span>: {
      <span class="hljs-title function_">bind</span>(<span class="hljs-params">el, binding, vnode</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'bind'</span>)

        <span class="hljs-comment">// 此处为了简单，直接判断触底了</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params">e</span>) {
          <span class="hljs-keyword">let</span> isBottom =
            e.<span class="hljs-property">target</span>.<span class="hljs-property">clientHeight</span> + e.<span class="hljs-property">target</span>.<span class="hljs-property">scrollTop</span> == e.<span class="hljs-property">target</span>.<span class="hljs-property">scrollHeight</span>
          <span class="hljs-keyword">if</span> (isBottom &amp;&amp; !vnode.<span class="hljs-property">context</span>.<span class="hljs-property">loading</span>) {
            binding.<span class="hljs-title function_">value</span>()
          }
        }

        <span class="hljs-comment">// 监听滚动</span>
        <span class="hljs-keyword">let</span> wrapDom = el.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.el-autocomplete-suggestion__wrap'</span>)
        el.<span class="hljs-property">__handleScroll__</span> = handleScroll
        el.<span class="hljs-property">__wrapDom__</span> = wrapDom
        wrapDom.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll, <span class="hljs-literal">false</span>)
      },

      <span class="hljs-title function_">unbind</span>(<span class="hljs-params">el, binding, vnode</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'unbind'</span>)
        <span class="hljs-comment">// 解除事件监听</span>
        el.<span class="hljs-property">__wrapDom__</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, el.<span class="hljs-property">__handleScroll__</span>, <span class="hljs-literal">false</span>)
      },
    },
  },

  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">// 分页搜索</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">keywords</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'page'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span>)
      <span class="hljs-keyword">let</span> start = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span> - <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>
      <span class="hljs-keyword">let</span> end = start + <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>
      <span class="hljs-keyword">return</span> apiData.<span class="hljs-title function_">slice</span>(start, end)
    },

    <span class="hljs-comment">// 焦点触发搜索第一页</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">querySearch</span>(<span class="hljs-params">queryString, cb</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span> = <span class="hljs-number">1</span>
      <span class="hljs-keyword">let</span> list = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">search</span>(queryString)

      <span class="hljs-comment">// 调用 callback 返回建议列表的数据</span>
      <span class="hljs-title function_">cb</span>(list)
    },

    <span class="hljs-comment">// 滚动触发翻页</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'handleScroll'</span>)

      <span class="hljs-comment">// 限制翻页限度</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span> &gt; <span class="hljs-number">20</span>) {
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span>++

      <span class="hljs-keyword">let</span> list = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">search</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">keywords</span>)

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>[<span class="hljs-string">'autocomplete'</span>].<span class="hljs-property">$data</span>.<span class="hljs-property">suggestions</span>.<span class="hljs-title function_">push</span>(...list)
    },

    <span class="hljs-title function_">handleBlur</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'handleBlur'</span>)
      <span class="hljs-comment">// 避免上次数据影响</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>[<span class="hljs-string">'autocomplete'</span>].<span class="hljs-property">$data</span>.<span class="hljs-property">suggestions</span>.<span class="hljs-title function_">splice</span>(
        <span class="hljs-number">0</span>,
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>[<span class="hljs-string">'autocomplete'</span>].<span class="hljs-property">$data</span>.<span class="hljs-property">suggestions</span>.<span class="hljs-property">length</span>
      )
    },
  },

  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {},
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"less"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>



</code></pre>
<p>测试数据 data.json</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"三全鲜食（北新泾店）"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"长宁区新渔路144号"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"Hot honey 首尔炸鸡（仙霞路）"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区淞虹路661号"</span>  },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"新旺角茶餐厅"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市普陀区真北路988号创邑金沙谷6号楼113"</span>  },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"泷千家(天山西路店)"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"天山西路438号"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"胖仙女纸杯蛋糕（上海凌空店）"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区金钟路968号1幢18号楼一层商铺18-101"</span>  },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"贡茶"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区金钟路633号"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"豪大大香鸡排超级奶爸"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市嘉定区曹安公路曹安路1685号"</span>  },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"茶芝兰（奶茶，手抓饼）"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市普陀区同普路1435号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"十二泷町"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市北翟路1444弄81号B幢-107"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"星移浓缩咖啡"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市嘉定区新郁路817号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"阿姨奶茶/豪大大"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"嘉定区曹安路1611号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"新麦甜四季甜品炸鸡"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"嘉定区曹安公路2383弄55号"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"Monica摩托主题咖啡店"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"嘉定区江桥镇曹安公路2409号1F，2383弄62号1F"</span>  },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"浮生若茶（凌空soho店）"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海长宁区金钟路968号9号楼地下一层"</span>  },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"NONO JUICE  鲜榨果汁"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区天山西路119号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"CoCo都可(北新泾店）"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区仙霞西路"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"快乐柠檬（神州智慧店）"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区天山西路567号1层R117号店铺"</span>  },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"Merci Paul cafe"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市普陀区光复西路丹巴路28弄6号楼819"</span>  },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"猫山王（西郊百联店）"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区仙霞西路88号第一层G05-F01-1-306"</span>  },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"枪会山"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市普陀区棕榈路"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"纵食"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"元丰天山花园(东门) 双流路267号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"钱记"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区天山西路"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"壹杯加"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区通协路"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"唦哇嘀咖"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区新泾镇金钟路999号2幢（B幢）第01层第1-02A单元"</span>  },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"爱茜茜里(西郊百联)"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"长宁区仙霞西路88号1305室"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"爱茜茜里(近铁广场)"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市普陀区真北路818号近铁城市广场北区地下二楼N-B2-O2-C商铺"</span>  },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"鲜果榨汁（金沙江路和美广店）"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"普陀区金沙江路2239号金沙和美广场B1-10-6"</span>  },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"开心丽果（缤谷店）"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区威宁路天山路341号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"超级鸡车（丰庄路店）"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市嘉定区丰庄路240号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"妙生活果园（北新泾店）"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"长宁区新渔路144号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"香宜度麻辣香锅"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"长宁区淞虹路148号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"凡仔汉堡（老真北路店）"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市普陀区老真北路160号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"港式小铺"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区金钟路968号15楼15-105室"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"蜀香源麻辣香锅（剑河路店）"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"剑河路443-1"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"北京饺子馆"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"长宁区北新泾街道天山西路490-1号"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"饭典*新简餐（凌空SOHO店）"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区金钟路968号9号楼地下一层9-83室"</span>  },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"焦耳·川式快餐（金钟路店）"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市金钟路633号地下一层甲部"</span>  },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"动力鸡车"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"长宁区仙霞西路299弄3号101B"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"浏阳蒸菜"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"天山西路430号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"四海游龙（天山西路店）"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区天山西路"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"樱花食堂（凌空店）"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区金钟路968号15楼15-105室"</span>  },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"壹分米客家传统调制米粉(天山店)"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"天山西路428号"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"福荣祥烧腊（平溪路店）"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区协和路福泉路255弄57-73号"</span>  },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"速记黄焖鸡米饭"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区北新泾街道金钟路180号1层01号摊位"</span>  },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"红辣椒麻辣烫"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"上海市长宁区天山西路492号"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"(小杨生煎)西郊百联餐厅"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"长宁区仙霞西路88号百联2楼"</span> },  { <span class="hljs-string">"value"</span>: <span class="hljs-string">"阳阳麻辣烫"</span>, <span class="hljs-string">"address"</span>: <span class="hljs-string">"天山西路389号"</span> },  {    <span class="hljs-string">"value"</span>: <span class="hljs-string">"南拳妈妈龙虾盖浇饭"</span>,    <span class="hljs-string">"address"</span>: <span class="hljs-string">"普陀区金沙江路1699号鑫乐惠美食广场A13"</span>  }]</span>


</code></pre>
<p>参考<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_43877368%2Farticle%2Fdetails%2F123273563" target="_blank" title="https://blog.csdn.net/weixin_43877368/article/details/123273563" ref="nofollow noopener noreferrer">el-autocomplete 滚动到底部加载数据</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.runoob.com%2Fjsref%2Fmet-element-removeeventlistener.html" target="_blank" title="https://www.runoob.com/jsref/met-element-removeeventlistener.html" ref="nofollow noopener noreferrer">www.runoob.com/jsref/met-e…</a><br/>
<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.3qphp.com%2Fweb%2Fjavascript%2F4961.html" target="_blank" title="http://www.3qphp.com/web/javascript/4961.html" ref="nofollow noopener noreferrer">vue 解除鼠标的监听事件的方法</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LLM 四阶段和 Transformer 架构（一）]]></title>    <link>https://juejin.cn/post/7573855399717060627</link>    <guid>https://juejin.cn/post/7573855399717060627</guid>    <pubDate>2025-11-18T08:55:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573855399717060627" data-draft-id="7573776814947811347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LLM 四阶段和 Transformer 架构（一）"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-18T08:55:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小兵张健"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032405229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LLM 四阶段和 Transformer 架构（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032405229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小兵张健
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:55:58.000Z" title="Tue Nov 18 2025 08:55:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这篇文章从程序员视角，类比理解 LLM 的底层原理。</p>
<h2 data-id="heading-0">阶段一：设计蓝图</h2>
<p>LLM 现在都用 Transformer 架构，最开始也要设置一些额外的参数。</p>
<h3 data-id="heading-1">d_modle</h3>
<p>比如 4096，是 2 的 n 次方。代表内部向量的维度，常见的 xy 轴就是二维的，左边代表比如 [1,2]，4096 维度就用 [1,2,3....] 一共有 4096 个数字，所以不需要想象出 4096 维在现实世界是什么样的结构，我们用数学中的矩阵表示他们。</p>
<p>维度代表了思考的广度，比如我们从各个角度判断一个人，身高、体重、性别等等，每一个角度都类比一个维度。</p>
<h3 data-id="heading-2">Layers</h3>
<p>比如 96 层，每个 4096 的矩阵代表一层，每层里面有多个 4096 的矩阵，有不同的含义。后面会详细解释。</p>
<p>Layers 代表思考的深度。</p>
<h3 data-id="heading-3">Vocab Size</h3>
<p>比如 128k，这个是词汇表大小，词汇表配置了 LLM 有多少个 token。</p>
<p><strong>Token</strong> 是 <strong>Tokenizer</strong> 根据统计规律切分出来的，不完全等同于中文的每个字或者因为的每个单词，还包括标点符号、词、或短语，取决于 Tokenizer 是如何切分的，比如它发现 “奥利给” 经常出现在一起，也会把这个词标记为一个 token。</p>
<p>这些 token 和对应的向量坐标存在 Vocab Map 和 Embedding Table 中，Map 的数据是 token 和 Id 的对应。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// Vocab Map</span>
<span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"apple"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">501</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"cat"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">882</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"Java"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">998</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"love"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Embedding Table 中存的是 Id 和向量坐标，<strong>形状</strong>是[ VocabSize, d_modle]，即 [128k,4096]。</p>
<p>这里要重点解释下形状和向量。</p>
<h3 data-id="heading-4">Shape 形状和 Vector 向量</h3>
<p>形状的 [128k,4096] 表示 128k 行，4096 列的矩阵。</p>
<p>向量的 [128k,4096] 表示一个点在二维坐标系的方向和大小，先找到这个点的坐标，再从原点当起点画条线连接上这个点，就是向量。这个向量的形状是 [1,2]，因为是 1 行 2 列。</p>
<p>后续我都会严格的区分形状和向量，可以停顿下理解两者的区别。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbd81567e5c04312932a3a9462f1d000~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060958&amp;x-signature=s%2FqyWbBcBBpRPVftGIyXM7EQCPI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">阶段二：预训练</h2>
<p>在阶段一中设置好所有参数，阶段二就是通过海量数据学习，配置这些参数（矩阵）。</p>
<p>我们说的 LLM 好不好用，就是取决于这些 token 在向量的坐标地址、矩阵的转换等等是否合理。</p>
<p>举个例子，比如在阶段 1 定义了 2 个参数（实际上 LLM 要多得多，光 GPT3 就有  1760 亿），类比代码中新建一个对象 <code>new Person()</code> 有身高和体重两个参数。</p>
<p>经过阶段二后，这个对象就被默认赋值身高 170，体重 70kg（默认向量地址）。</p>
<p>而当上下文出现男字后，这个属性就变成了 175 和 75kg，出现女字就变成 165 和 55kg（矩阵转换）。</p>
<h3 data-id="heading-6">向量的位置</h3>
<p>还记得阶段一说的 Embedding Table 是一个形状为 [128k,4096] 的矩阵吗？通过 Transformer 训练后，LLM 决定把 “人” 这个 Token 放到一个特定的坐标 [1.3,0,4...]一共 4096 位。</p>
<p>我们不知道为什么是这个坐标，这是 LLM 黑盒的地方，既不知道 Why 但知道 How（Transformer 训练）。</p>
<p>“人” 这个字在中文里有太多含义，男人、女人、好人、好人等等，这些词又是不同的向量，向量正是这些向量合并的均值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/045de90c66454098a94828b6459ed234~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060958&amp;x-signature=L5IwbqMuX1M4s%2F7BrXH0t5hRvmc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">矩阵转换</h3>
<p>如果上下文有 “男” 这个字，整句话（其实是最后一句话最后一个 token 的向量，后面再解释）的向量就会朝着 “男人” 这个 token 的位置偏一点。</p>
<p>转换的方式，就是用的<strong>矩阵乘法</strong>。</p>
<p>举个例子解释这种转换，假设公司有 5 个初级 3 个中级 1 个高级开发工程师，用一个形状为 [3,1] 的矩阵表示，矩阵内容是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">v_{in} = \begin{bmatrix} 5 \\ 3 \\ 1 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span>。</p>
<p>如果想知道他们的总薪资成本和总代码量，这是个形状为 [2,1] 的矩阵，如何转换？</p>
<p>这就需要一个形状为 [2,3] 的规则矩阵，这里面定义了不同级别工程师的薪资和代码量。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>20</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>50</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>200</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>500</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1000</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">M = \begin{bmatrix} 
10 &amp; 20 &amp; 50 \\ 
200 &amp; 500 &amp; 1000 
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">10</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">200</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">20</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">500</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">50</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p>
<p>M 规则矩阵表示初级的薪资 是 10 代码量是 200，中级是 20 和 500，高级是 50 和 1000。</p>
<p>然后使用矩阵乘法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ae5309bfeb748919e29fcb6e14502de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060958&amp;x-signature=csFzeM8l0Hij2KEGiap0Xs1p4Hk%3D" alt="image.png" loading="lazy"/></p>
<p>矩阵乘法就是用前一个矩阵横行每一个值，乘以第二个矩阵纵列每一个值，即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>10</mn><mo>×</mo><mn>5</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>20</mn><mo>×</mo><mn>3</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>50</mn><mo>×</mo><mn>1</mn><mo stretchy="false">)</mo><mo>=</mo><mn>160</mn></mrow><annotation encoding="application/x-tex">(10 \times 5) + (20 \times 3) + (50 \times 1)= 160</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">20</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">3</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">50</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">160</span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>200</mn><mo>×</mo><mn>5</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>500</mn><mo>×</mo><mn>3</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1000</mn><mo>×</mo><mn>1</mn><mo stretchy="false">)</mo><mo>=</mo><mn>3500</mn></mrow><annotation encoding="application/x-tex">(200 \times 5) + (500 \times 3) + (1000 \times 1) = 3500</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">200</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">500</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">3</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1000</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">3500</span></span></span></span></span>，这就是<strong>点积</strong>。</p>
<p>简短解释下点积，点积是计算两个向量相似度的。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>a</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>a</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>a</mi><mn>3</mn></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">A = [a_1, a_2, a_3]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>b</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>b</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>b</mi><mn>3</mn></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">B = [b_1, b_2, b_3]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⋅</mo><mi>B</mi><mo>=</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mn>1</mn></msub><mo>×</mo><msub><mi>b</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mn>2</mn></msub><mo>×</mo><msub><mi>b</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mn>3</mn></msub><mo>×</mo><msub><mi>b</mi><mn>3</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A \cdot B = (a_1 \times b_1) + (a_2 \times b_2) + (a_3 \times b_3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>值为正数说明相似度很大，为 0 说明垂直（正交）没有关系，为负数说明方向相反。</p>
<p>回到矩阵乘法，这里要注意，规则矩阵 M 是放在前面的，不能反过来，矩阵乘法中第一个矩阵的列数必须等于第二个矩阵的列数，上面的计算用形状表示就是 [2,3] * [3,1] = [2,1]。</p>
<p>现在应该对矩阵乘法有个大致认知了吧，规则矩阵 * 原始值矩阵 = 结果矩阵，就是这么回事，不用太在意是怎么乘到底怎么算，只需要记住他们可以通过矩阵乘法转换。</p>
<p>LLM 中大量用到的这种转化，这也是我们刚刚说 “人” 的向量会偏向 “男人” 的原因，但实际上更复杂和精妙，让我们正式进入 Transfer 架构。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[js深入之从原型到原型链]]></title>    <link>https://juejin.cn/post/7573694361474957339</link>    <guid>https://juejin.cn/post/7573694361474957339</guid>    <pubDate>2025-11-18T08:52:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573694361474957339" data-draft-id="7573694361474220059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="js深入之从原型到原型链"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-18T08:52:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="米兰小铁匠17"/> <meta itemprop="url" content="https://juejin.cn/user/3201392514434440"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            js深入之从原型到原型链
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3201392514434440/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    米兰小铁匠17
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T08:52:08.000Z" title="Tue Nov 18 2025 08:52:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">构造函数创建对象</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> A {
}
<span class="hljs-keyword">let</span> a=<span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();
a.<span class="hljs-property">name</span>=<span class="hljs-string">"abc"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a.<span class="hljs-property">name</span>);
</code></pre>
<p>在这个例子中A就是一个构造函数，我们使用new创建了一个实例对象a</p>
<h3 data-id="heading-1">prototype</h3>
<p>每个函数都有一个prototype属性</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> A {
}
A.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">name</span>=<span class="hljs-string">"张三"</span>
<span class="hljs-keyword">let</span> a1=<span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();
<span class="hljs-keyword">let</span> a2=<span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a1.<span class="hljs-property">name</span>,a2.<span class="hljs-property">name</span>)
</code></pre>
<blockquote>
<p>prototype指向的是调用该函数创建的实例的原型，也就是例子中a1,a2的原型。
每一个对象（null除外）创建的时候，都会关联另外一个对象，这个对象就是原型，每个对象都会从原型“继承”属性</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86dd12c7a8c340cdacfb5c749ebd69a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Gz5YWw5bCP6ZOB5YygMTc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060728&amp;x-signature=RsCI3zACxDbeFicsil7OSMVCg8o%3D" alt="3bdfe951-d6de-4e73-ae8b-8db05e5d54bf.jpeg" loading="lazy"/></p>
<h3 data-id="heading-2">_<em>proto</em>_</h3>
<p>每个对象（除了null）都有一个__proto__属性，这个属性指向该对象的原型</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> A {
}
<span class="hljs-keyword">let</span> a=<span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a.<span class="hljs-property">__proto__</span>===A.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d3d535b7475465bbf6d6440ffd5ece8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Gz5YWw5bCP6ZOB5YygMTc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060728&amp;x-signature=oQjCdEHII0%2FKSMsqKUF%2FyB%2FDy1s%3D" alt="a8d6b4f1-e328-44f6-8c7b-421bcfe8ac22.jpeg" loading="lazy"/></p>
<h3 data-id="heading-3">constructor</h3>
<p>每个原型都有一个constructor属性指向关联的构造函数</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> A {
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(A.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>===A)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76f12e22807d406ca2a19477115867b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Gz5YWw5bCP6ZOB5YygMTc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060728&amp;x-signature=iUnWbGFhDDs15oc32MiSw5Gc67E%3D" alt="4e507f00-af31-4942-bf0a-ffc0c89cd49c.jpeg" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> A {
}
<span class="hljs-keyword">let</span> a=<span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(A.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>===A)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a.<span class="hljs-property">__proto__</span>===A.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a.<span class="hljs-property">contructor</span>===A.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>)
<span class="hljs-comment">// 顺便学习一个ES5的方法,可以获得对象的原型</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(a) === A.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
</code></pre>
<p>当读取实例属性时，如果找不到就会从与对象关联的原型上查找，如果还查不到就会查找原型的原型，一直找到最顶层为止。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> A {
}
A.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">name</span>=<span class="hljs-string">"test"</span>;
<span class="hljs-keyword">let</span> a=<span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();
a.<span class="hljs-property">name</span>=<span class="hljs-string">"aaa"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a.<span class="hljs-property">name</span>);<span class="hljs-comment">//aaa</span>
<span class="hljs-keyword">delete</span> a.<span class="hljs-property">name</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a.<span class="hljs-property">name</span>);<span class="hljs-comment">//test</span>
</code></pre>
<p>原型的原型，其实是有Object构造函数生成</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd6eb3c1fd644a7cae5a9014559c6043~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Gz5YWw5bCP6ZOB5YygMTc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060728&amp;x-signature=SheS5ZlbjF5Csvl0ak%2FC8v2iAyg%3D" alt="a15399d7-b5ff-4fbc-afa3-9026ca9cddb7.jpeg" loading="lazy"/></p>
<h3 data-id="heading-4">原型链</h3>
<p>红色部分就代表了原型链的形成</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34de0d66541d4771b21afeceb67f80ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Gz5YWw5bCP6ZOB5YygMTc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764060728&amp;x-signature=JcYxwRAMDypdI7nLoZg2NozLSDs%3D" alt="dd4ff7f1-95d8-4007-9c1e-551d3ea83545.jpeg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[loveqq 作为网关框架时如何修改请求体 / 响应体，和 spring 又有什么区别？]]></title>    <link>https://juejin.cn/post/7573694361474072603</link>    <guid>https://juejin.cn/post/7573694361474072603</guid>    <pubDate>2025-11-18T07:13:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573694361474072603" data-draft-id="7573710392212553755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="loveqq 作为网关框架时如何修改请求体 / 响应体，和 spring 又有什么区别？"/> <meta itemprop="keywords" content="后端,架构"/> <meta itemprop="datePublished" content="2025-11-18T07:13:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kfyty725"/> <meta itemprop="url" content="https://juejin.cn/user/2685462482255984"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            loveqq 作为网关框架时如何修改请求体 / 响应体，和 spring 又有什么区别？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2685462482255984/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kfyty725
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T07:13:13.000Z" title="Tue Nov 18 2025 07:13:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>loveqq-framework 作为网关框架使用时，修改响应体是一个十分常见的需求。</p>
<p>而作为一个使用过 spring gateway 的作者，我觉得 spring gateway 中修改响应体实在是复杂，因此 loveqq 框架在实现修改响应体时，则力求简洁易用。</p>
<h3 data-id="heading-1">如何实现？</h3>
<p> loveqq 框架修改响应体是基于网关过滤器（GatewayFilter）实现的，因此要实现修改响应体只需两步：</p>
<p>1、自定义网关过滤器</p>
<p>2、给指定的路由配置这个过滤器</p>
<p>下面给出相应的示例：</p>
<p>网关过滤器：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 这里手动设置 bean name 为：FormatResponseBody
     * 后面配置时会用到，当然自动生成的也可以，只是名称比较长而已
     * &lt;p&gt;
     * 注意：这里设置过滤器优先级为最低级别，因为需要转发请求之后才能获取下游响应体，而转发过滤器默认的级别比较低
     */</span>
    <span class="hljs-meta">@Order(Integer.MAX_VALUE)</span>
    <span class="hljs-meta">@Component("FormatResponseBody")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FormatResponseBodyGatewayFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GatewayFilter</span> {

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServerRequest request, ServerResponse response, GatewayFilterChain chain)</span> {
            <span class="hljs-keyword">return</span> chain.doFilter(request, response)
                    .then(Mono.defer(response::getAggregateBody))               <span class="hljs-comment">// 可以直接获取聚合后的响应体，避免 Flux 分段处理数据</span>
                    .map(e -&gt; {
                        <span class="hljs-type">byte</span>[] bytes = NIOUtil.read(e);
                        <span class="hljs-type">JSON</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span>();
                        json.put(<span class="hljs-string">"data"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes));
                        json.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">0</span>);
                        <span class="hljs-keyword">return</span> NIOUtil.from(json.toString());                   <span class="hljs-comment">// 修改响应体</span>
                    })
                    .flatMap(json -&gt; response.writeBody(Flux.just(json)))       <span class="hljs-comment">// 响应体写入响应</span>
                    .then();
        }
    }
</code></pre>
<p>应用过滤器：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">k:</span>
  <span class="hljs-attr">server:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://demo</span>
          <span class="hljs-attr">predicates:</span> <span class="hljs-string">Path=/api/demo/**</span>
          <span class="hljs-attr">filters:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">StripPrefix</span>               <span class="hljs-comment"># 去除 /api</span>
              <span class="hljs-attr">args:</span>
                <span class="hljs-attr">stripPrefix:</span> <span class="hljs-number">1</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">FormatResponseBody</span>        <span class="hljs-comment"># 修改响应体</span>
</code></pre>
<p>这样就可以了。</p>
<h4 data-id="heading-2">响应体校验不通过想抛出异常？</h4>
<p>很简单，直接抛出异常就可以了，例如：</p>
<pre><code class="hljs language-java" lang="java">        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServerRequest request, ServerResponse response, GatewayFilterChain chain)</span> {
            <span class="hljs-keyword">return</span> chain.doFilter(request, response)
                    .then(Mono.defer(response::getAggregateBody))               <span class="hljs-comment">// 可以直接获取聚合后的响应体，避免 Flux 分段处理数据</span>
                    .map(e -&gt; {
                        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(NIOUtil.read(e));
                        <span class="hljs-keyword">if</span> (body.charAt(<span class="hljs-number">0</span>) != <span class="hljs-string">'{'</span> || body.charAt(<span class="hljs-number">0</span>) != <span class="hljs-string">'['</span>) {
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResolvableException</span>(<span class="hljs-string">"not json"</span>);
                        }
                        <span class="hljs-type">JSON</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span>();
                        json.put(<span class="hljs-string">"data"</span>, body);
                        json.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">0</span>);
                        <span class="hljs-keyword">return</span> NIOUtil.from(json.toString());                   <span class="hljs-comment">// 修改响应体</span>
                    })
                    .flatMap(json -&gt; response.writeBody(Flux.just(json)))       <span class="hljs-comment">// 响应体写入响应</span>
                    .then();
        }
</code></pre>
<h4 data-id="heading-3">这样的话，网关会输出正常的错误信息吗？</h4>
<p>当然可以，因为网关异常同样可以走 mvc 模式的全局异常处理器进行处理！</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestControllerAdvice(supportAny = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    <span class="hljs-comment">/**
     * 异常处理
     *
     * <span class="hljs-doctag">@param</span> request 抽象的统一的请求对象
     * <span class="hljs-doctag">@param</span> e       异常
     * <span class="hljs-doctag">@return</span> 返回错误信息
     */</span>
    <span class="hljs-meta">@ExceptionHandler</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">onException</span><span class="hljs-params">(ServerRequest request, Exception e)</span> {
        <span class="hljs-keyword">return</span> e.getClass().getName() + <span class="hljs-string">":"</span> + e.getMessage();
    }
}
</code></pre>
<p>看起来相当简洁，几乎和修改请求体没什么区别，但是 spring gateway 修改请求体 / 响应体想必做过的各位懂的都懂。</p>
<p>感兴趣的同学可以尝试一下～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3+Cesium开发教程（14）---Cesium加载与删除geojson、kml、glb、3dtiles、czml数据]]></title>    <link>https://juejin.cn/post/7573699930259570714</link>    <guid>https://juejin.cn/post/7573699930259570714</guid>    <pubDate>2025-11-18T07:16:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573699930259570714" data-draft-id="7573687816430698506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3+Cesium开发教程（14）---Cesium加载与删除geojson、kml、glb、3dtiles、czml数据"/> <meta itemprop="keywords" content="cesium,GIS"/> <meta itemprop="datePublished" content="2025-11-18T07:16:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GisCoder"/> <meta itemprop="url" content="https://juejin.cn/user/3968552295476428"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3+Cesium开发教程（14）---Cesium加载与删除geojson、kml、glb、3dtiles、czml数据
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3968552295476428/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GisCoder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T07:16:08.000Z" title="Tue Nov 18 2025 07:16:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本学习系列将以Cesium + Vue3 + Vite +Typescript+elementplus作为主要技术栈展开，后续会循序渐进，持续探索Cesium的高级功能，相关源码全部<strong>免费公开</strong>。详情请查看原文<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fh0bzCJwupHpDjwXXscH5hA" target="_blank" title="https://mp.weixin.qq.com/s/h0bzCJwupHpDjwXXscH5hA" ref="nofollow noopener noreferrer">Cesium+Vue3学习系列（14）---Cesium加载与删除geojson、kml、glb、3dtiles、czml数据</a></p>
<p>1、geojson数据配置与加载方式</p>
<pre><code class="hljs language-bash" lang="bash">
//geojson测试数据
<span class="hljs-built_in">export</span> const geojsonTestInfo:ILayerItem = {
    <span class="hljs-built_in">id</span>: LayerIdFlag.GEOMSON_TEST,
    name: <span class="hljs-string">"geojsonTest"</span>,
    <span class="hljs-built_in">type</span>: <span class="hljs-string">"geojson"</span>,
    url: <span class="hljs-string">"/testdata/line.geojson"</span>,
    layer: <span class="hljs-string">"geojsonTest"</span>
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart">
<span class="hljs-keyword">case</span> <span class="hljs-string">'geojson'</span>:
                handle = <span class="hljs-keyword">await</span> Cesium.GeoJsonDataSource.load(item.url!, {
                    clampToGround: <span class="hljs-keyword">true</span>,
                });
                (handle <span class="hljs-keyword">as</span> Cesium.GeoJsonDataSource).<span class="hljs-keyword">show</span> = <span class="hljs-keyword">show</span>;
                <span class="hljs-keyword">this</span>.viewer.dataSources.add(handle)
                <span class="hljs-comment">//视角</span>
                <span class="hljs-keyword">this</span>.viewer.zoomTo(handle)
                <span class="hljs-keyword">break</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4c1e6ab9e2042bb932ac58944b49eac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lzQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764054967&amp;x-signature=iyL2wDXR8Np%2BNcjM2M9KblQODKw%3D" alt="" loading="lazy"/></p>
<p>2、kml数据配置与加载方式</p>
<pre><code class="hljs language-bash" lang="bash">
//kml测试数据
<span class="hljs-built_in">export</span> const kmlTestInfo:ILayerItem = {
    <span class="hljs-built_in">id</span>: LayerIdFlag.KML_TEST,
    name: <span class="hljs-string">"kmlTest"</span>,
    <span class="hljs-built_in">type</span>: <span class="hljs-string">"kml"</span>,
    url: <span class="hljs-string">"/testdata/gdpPerCapita2008.kmz"</span>,
    layer: <span class="hljs-string">"kmlTest"</span>
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart">
            <span class="hljs-keyword">case</span> <span class="hljs-string">'kml'</span>:
                handle = <span class="hljs-keyword">await</span> Cesium.KmlDataSource.load(item.url!, {
                    clampToGround: <span class="hljs-keyword">true</span>,
                });
                (handle <span class="hljs-keyword">as</span> Cesium.KmlDataSource).<span class="hljs-keyword">show</span> = <span class="hljs-keyword">show</span>
                <span class="hljs-keyword">this</span>.viewer.dataSources.add(handle)
                <span class="hljs-keyword">this</span>.viewer.zoomTo(handle)
                <span class="hljs-keyword">break</span>
</code></pre>
<p>3、glb数据配置与加载方式</p>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-string">//glb测试数据</span>
<span class="hljs-string">export</span> <span class="hljs-string">const</span> <span class="hljs-string">glbTestInfo:ILayerItem</span> <span class="hljs-string">=</span> {
    <span class="hljs-attr">id:</span> <span class="hljs-string">LayerIdFlag.GLB_TEST</span>,
    <span class="hljs-attr">name:</span> <span class="hljs-string">"glbTest"</span>,
    <span class="hljs-attr">type:</span> <span class="hljs-string">"glb"</span>,
    <span class="hljs-attr">url:</span> <span class="hljs-string">"/testdata/CesiumMilkTruck.glb"</span>,
    <span class="hljs-attr">layer:</span> <span class="hljs-string">"glbTest"</span>,
    <span class="hljs-attr">scale:</span> <span class="hljs-number">5</span>,
    <span class="hljs-attr">lon:</span> <span class="hljs-number">114.314521</span>,
    <span class="hljs-attr">lat:</span> <span class="hljs-number">22.543062</span>,
    <span class="hljs-attr">height:</span> <span class="hljs-number">0</span>,
    <span class="hljs-string">heading:45</span>,
    <span class="hljs-attr">pitch:</span> <span class="hljs-number">0</span>,
    <span class="hljs-attr">roll:</span> <span class="hljs-number">0</span>   
}
</code></pre>
<pre><code class="hljs language-ini" lang="ini">
            case 'glb':
                let <span class="hljs-attr">position</span> = Cesium.Cartesian3.fromDegrees(item.lon, item.lat, item.height || <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
                // 设置模型方向
                let <span class="hljs-attr">hpRoll</span> = new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(item.heading || <span class="hljs-number">45</span>), Cesium.Math.toRadians(item.pitch || <span class="hljs-number">0</span>), Cesium.Math.toRadians(item.roll || <span class="hljs-number">0</span>))<span class="hljs-comment">;</span>
                // 生成一个函数，该函数从以提供的原点为中心的参考帧到提供的椭圆体的固定参考帧计算4x4变换矩阵。
                let <span class="hljs-attr">fixedFrame</span> = Cesium.Transforms.localFrameToFixedFrameGenerator(<span class="hljs-string">'north'</span>, <span class="hljs-string">'west'</span>)<span class="hljs-comment">;</span>
                <span class="hljs-attr">handle</span> = await Cesium.Model.fromGltfAsync({
                    url: item.url!,
                    modelMatrix: Cesium.Transforms.headingPitchRollToFixedFrame(position, hpRoll, Cesium.Ellipsoid.WGS84, fixedFrame),
                    scale: item.scale || 1,
                })<span class="hljs-comment">;</span>
                <span class="hljs-attr">handle.show</span> = show<span class="hljs-comment">;</span>
                this.viewer.scene.primitives.add(handle)
                this.viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(item.lon, item.lat, 100),
                    duration: 2
                })
                break<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/842198e367ec427cbbc4956a8d0e313f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lzQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764054967&amp;x-signature=DbB%2FAkeffqnQYOzKGBeWF3QmP0A%3D" alt="" loading="lazy"/></p>
<p>4、3dtiles配置与加载方式。由于本示例中的3dtiles 数据高度较低，这里需要将其高度提升了500米。后续会出一个动态调整3dtiles位置的章节，敬请期待。</p>
<pre><code class="hljs language-arduino" lang="arduino">
<span class="hljs-comment">//3dtile测试数据</span>
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> model3dtilesTestInfo:ILayerItem = {
    id: LayerIdFlag.MODEL_3DTILES_TEST,
    name: <span class="hljs-string">"model3dtilesTest"</span>,
    type: <span class="hljs-string">"3dtiles"</span>,
    url: <span class="hljs-string">"/testdata/dayanta/tileset.json"</span>,
    layer: <span class="hljs-string">"model3dtilesTest"</span>
}
</code></pre>
<pre><code class="hljs language-ini" lang="ini">
 case '3dtiles':
                <span class="hljs-attr">handle</span> = await Cesium.Cesium3DTileset.fromUrl(item.url!)<span class="hljs-comment">;                </span>
                (handle as Cesium.Cesium3DTileset).<span class="hljs-attr">show</span> = show<span class="hljs-comment">;</span>
                this.viewer.scene.primitives.add(handle)
                this.viewer.zoomTo(handle, new Cesium.HeadingPitchRange(0.0, -0.3, 0.0))
               
                let <span class="hljs-attr">cartographic</span> = Cesium.Cartographic.fromCartesian(
                    handle.boundingSphere.center
                )<span class="hljs-comment">;</span>
                let <span class="hljs-attr">surface</span> = Cesium.Cartesian3.fromRadians(
                    cartographic.longitude,
                    cartographic.latitude,
                    0.0
                )<span class="hljs-comment">;</span>
                let <span class="hljs-attr">offset</span> = Cesium.Cartesian3.fromRadians(
                    cartographic.longitude,
                    cartographic.latitude,
                    500.0
                )<span class="hljs-comment">;</span>
                let <span class="hljs-attr">translation</span> = Cesium.Cartesian3.subtract(
                    offset,
                    surface,
                    new Cesium.Cartesian3()
                )<span class="hljs-comment">;</span>
                <span class="hljs-attr">handle.modelMatrix</span> = Cesium.Matrix4.fromTranslation(translation)<span class="hljs-comment">;</span>
                break
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed9282b311254e33aea1f56e13e8d592~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lzQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764054967&amp;x-signature=a7nUbeJf1bUltbdqcfk7HvbVjq4%3D" alt="" loading="lazy"/></p>
<p>5、czml数据配置与加载方式</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-built_in">export</span> const czmlTestInfo:ILayerItem = {
    <span class="hljs-built_in">id</span>: LayerIdFlag.CZML_TEST,
    name: <span class="hljs-string">"czmlTest"</span>,
    <span class="hljs-built_in">type</span>: <span class="hljs-string">"czml"</span>,
    url: <span class="hljs-string">"/testdata/simple.czml"</span>,
    layer: <span class="hljs-string">"czmlTest"</span>
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart">
          <span class="hljs-keyword">case</span> <span class="hljs-string">'czml'</span>:
                handle = <span class="hljs-keyword">await</span> Cesium.CzmlDataSource.load(item.url!);
                (handle <span class="hljs-keyword">as</span> Cesium.CzmlDataSource).<span class="hljs-keyword">show</span> = <span class="hljs-keyword">show</span>
                <span class="hljs-keyword">this</span>.viewer.dataSources.add(handle)
                 <span class="hljs-keyword">this</span>.viewer.zoomTo(handle)
                <span class="hljs-keyword">break</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5440b5268bf849a893f470ffb8fd515e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lzQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764054967&amp;x-signature=mkVZ2eiWJn1l%2BWtLW8XoErSP9XE%3D" alt="" loading="lazy"/></p>
<p>6、数据删除。</p>
<pre><code class="hljs language-csharp" lang="csharp">    Remove(id: <span class="hljs-built_in">string</span>): <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">const</span> item = <span class="hljs-keyword">this</span>.layersIdMap.<span class="hljs-keyword">get</span>(id)
        <span class="hljs-keyword">if</span> (!item) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">const</span> { type, handle } = item;
        <span class="hljs-keyword">switch</span> (type) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'imagery_wms'</span>:
            <span class="hljs-keyword">case</span> <span class="hljs-string">'imagery_wmts'</span>:
            <span class="hljs-keyword">case</span> <span class="hljs-string">'imagery_xyz'</span>:
                <span class="hljs-keyword">this</span>.viewer.imageryLayers.<span class="hljs-keyword">remove</span>(handle)
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'terrain'</span>:
                <span class="hljs-comment">// 回到默认椭球</span>
                <span class="hljs-keyword">this</span>.viewer.terrainProvider = <span class="hljs-keyword">new</span> Cesium.EllipsoidTerrainProvider()
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'geojson'</span>:
            <span class="hljs-keyword">case</span> <span class="hljs-string">'kml'</span>:
            <span class="hljs-keyword">case</span> <span class="hljs-string">'czml'</span>:
                <span class="hljs-keyword">this</span>.viewer.dataSources.<span class="hljs-keyword">remove</span>(handle)
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'3dtiles'</span>:
            <span class="hljs-keyword">case</span> <span class="hljs-string">'glb'</span>:
                <span class="hljs-keyword">this</span>.viewer.scene.primitives.<span class="hljs-keyword">remove</span>(handle)
                <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">this</span>.layersIdMap.delete(id);
    }
</code></pre>
<p>7、前端实现：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-data-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-data-title"</span>&gt;</span> 自定义数据 <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"text-align: left;"</span>&gt;</span>
           
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"data-items"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>图层信息<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">el-checkbox</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"geojsonChecked"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"geojson"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"changeGeojson"</span>/&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">el-checkbox</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"kmlChecked"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"KML"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"changeKml"</span>/&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">el-checkbox</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"glbChecked"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"glb"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"changeGlb"</span>/&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">el-checkbox</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"model3dtilesChecked"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"3dtiles"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"changeModel3dtiles"</span>/&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">el-checkbox</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"czmlChecked"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"czml"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"changeCzml"</span>/&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { czmlTestInfo, geojsonTestInfo, glbTestInfo, kmlTestInfo, <span class="hljs-title class_">LayerIdFlag</span>, model3dtilesTestInfo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/system/LayerManager/LayerConfig'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">LayerManager</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/system/LayerManager/LayerManager'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CesiumViewer</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/Viewer/CesiumViewer'</span>
<span class="hljs-keyword">const</span> viewer = <span class="hljs-title class_">CesiumViewer</span>.<span class="hljs-property">viewer</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">mLayerManager</span>: <span class="hljs-title class_">LayerManager</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
<span class="hljs-keyword">const</span> geojsonChecked = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> kmlChecked = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> glbChecked = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> model3dtilesChecked = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> czmlChecked = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    mLayerManager = <span class="hljs-title class_">LayerManager</span>.<span class="hljs-title function_">getInstance</span>(viewer!)
})
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeGeojson</span> = (<span class="hljs-params">val: string | number | boolean</span>) =&gt; {
  <span class="hljs-keyword">if</span> (val) {
    <span class="hljs-comment">// 加载geojson图层</span>
    mLayerManager?.<span class="hljs-title class_">Add</span>(geojsonTestInfo)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 移除geojson图层</span>
    mLayerManager?.<span class="hljs-title class_">Remove</span>(<span class="hljs-title class_">LayerIdFlag</span>.<span class="hljs-property">GEOMSON_TEST</span>)
  }
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeKml</span> = (<span class="hljs-params">val: string | number | boolean</span>) =&gt; {
  <span class="hljs-keyword">if</span> (val) {
    <span class="hljs-comment">// 加载kml图层</span>
    mLayerManager?.<span class="hljs-title class_">Add</span>(kmlTestInfo)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 移除kml图层</span>
    mLayerManager?.<span class="hljs-title class_">Remove</span>(<span class="hljs-title class_">LayerIdFlag</span>.<span class="hljs-property">KML_TEST</span>)
  }
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeGlb</span> = (<span class="hljs-params">val: string | number | boolean</span>) =&gt; {
  <span class="hljs-keyword">if</span> (val) {
    <span class="hljs-comment">// 加载glb图层</span>
    mLayerManager?.<span class="hljs-title class_">Add</span>(glbTestInfo)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 移除glb图层</span>
    mLayerManager?.<span class="hljs-title class_">Remove</span>(<span class="hljs-title class_">LayerIdFlag</span>.<span class="hljs-property">GLB_TEST</span>)
  }
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeModel3dtiles</span> = (<span class="hljs-params">val: string | number | boolean</span>) =&gt; {
  <span class="hljs-keyword">if</span> (val) {
    <span class="hljs-comment">// 加载3dtiles图层</span>
    mLayerManager?.<span class="hljs-title class_">Add</span>(model3dtilesTestInfo)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 移除3dtiles图层</span>
    mLayerManager?.<span class="hljs-title class_">Remove</span>(<span class="hljs-title class_">LayerIdFlag</span>.<span class="hljs-property">MODEL_3DTILES_TEST</span>)
  }
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeCzml</span> = (<span class="hljs-params">val: string | number | boolean</span>) =&gt; {
  <span class="hljs-keyword">if</span> (val) {
    <span class="hljs-comment">// 加载czml图层</span>
    mLayerManager?.<span class="hljs-title class_">Add</span>(czmlTestInfo)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 移除czml图层</span>
    mLayerManager?.<span class="hljs-title class_">Remove</span>(<span class="hljs-title class_">LayerIdFlag</span>.<span class="hljs-property">CZML_TEST</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.custom-data-container</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
    <span class="hljs-selector-class">.custom-data-title</span> {
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
        <span class="hljs-attribute">font-weight</span>: bold;
        <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
    }
    
    <span class="hljs-selector-class">.data-items</span> {
        <span class="hljs-selector-class">.el-checkbox</span> {
            <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">30px</span>;
        }
        :<span class="hljs-built_in">deep</span>(.el-checkbox__label) {
            <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">206</span>, <span class="hljs-number">194</span>, <span class="hljs-number">194</span>);
        }
    }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><strong>更多代码请查看原文</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fh0bzCJwupHpDjwXXscH5hA" target="_blank" title="https://mp.weixin.qq.com/s/h0bzCJwupHpDjwXXscH5hA" ref="nofollow noopener noreferrer">Cesium+Vue3学习系列（14）---Cesium加载与删除geojson、kml、glb、3dtiles、czml数据</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂-Jetpack与AndroidX]]></title>    <link>https://juejin.cn/post/7573617944518606848</link>    <guid>https://juejin.cn/post/7573617944518606848</guid>    <pubDate>2025-11-18T06:50:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573617944518606848" data-draft-id="7573670400153059380" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂-Jetpack与AndroidX"/> <meta itemprop="keywords" content="Android,Android Jetpack,Kotlin"/> <meta itemprop="datePublished" content="2025-11-18T06:50:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无知的前端"/> <meta itemprop="url" content="https://juejin.cn/user/2410561882569933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂-Jetpack与AndroidX
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2410561882569933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无知的前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T06:50:32.000Z" title="Tue Nov 18 2025 06:50:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 核心概念：一句话概括</h3>
<ul>
<li><strong>Jetpack</strong>： <strong>一套组件、工具和指南的集合</strong>。它的目的是帮助开发者遵循最佳实践，减少样板代码，并让应用在各种 Android 版本和设备上都能一致地工作。</li>
<li><strong>AndroidX</strong>： <strong>Jetpack 组件的</strong>  <strong>“包装”和“命名空间”</strong> 。它是 Android 支持库的重新设计和替代品，所有 Jetpack 组件都存放在 <code>androidx</code> 这个命名空间下。</li>
</ul>
<p>可以把它们的关系理解为：<br/>
<strong>Jetpack 是一个“品牌”或“生态”，而 AndroidX 是这个品牌下所有产品的“包装规格”和“出厂标准”。</strong></p>
<hr/>
<h3 data-id="heading-1">2. 详细介绍</h3>
<h4 data-id="heading-2">AndroidX</h4>
<p><strong>是什么？</strong><br/>
AndroidX 是对原始 Android 支持库（Android Support Library）的重大改进和替代。在 AndroidX 出现之前，开发者使用像 <code>com.android.support:appcompat-v7</code> 这样的支持库。</p>
<p><strong>为什么需要它？</strong></p>
<ol>
<li><strong>统一的命名空间</strong>： 旧的支持库包名混乱（<code>com.android.support.*</code>），与 Android 操作系统本身的包名（<code>android.*</code>）容易混淆。AndroidX 将所有库都迁移到清晰的 <code>androidx.*</code> 命名空间下。</li>
<li><strong>独立的版本控制</strong>： AndroidX 下的每个库（如 <code>androidx.appcompat</code>， <code>androidx.lifecycle</code>）都有自己独立的版本号，不再与 Android 平台版本绑定。这意味着你可以单独更新某个库，而不必等待整个系统更新。</li>
<li><strong>更好的语义化版本</strong>： 遵循严格的语义化版本控制，让开发者更清楚地了解版本升级带来的变化。</li>
<li><strong>更好的打包和模块化</strong>： 库被拆分得更细，你可以只引入你需要的部分，减少应用体积。</li>
</ol>
<p><strong>总结：AndroidX 是一个基础设施层面的改进，为 Jetpack 组件提供了统一的“家”。</strong></p>
<h4 data-id="heading-3">Jetpack</h4>
<p><strong>是什么？</strong><br/>
Jetpack 是一个由 Google 精心策划的组件集合，旨在加速 Android 应用开发。它不是一个单一的库，而是一个“全家桶”，涵盖了应用开发的各个方面。</p>
<p><strong>为什么需要它？</strong></p>
<ol>
<li><strong>遵循最佳实践</strong>： Jetpack 组件内置了 Google 推荐的最佳架构和实践（如 MVVM），帮助开发者构建健壮、可测试和可维护的应用。</li>
<li><strong>消除样板代码</strong>： 例如，<code>ViewModel</code> 和 <code>LiveData</code> 可以帮你以生命周期感知的方式管理界面相关的数据，无需手动处理生命周期带来的各种问题。</li>
<li><strong>保证向后兼容</strong>： Jetpack 组件通常会在旧版 Android 系统上提供新功能的实现，让你能轻松使用新 API，而无需担心系统版本碎片化。</li>
<li><strong>简化复杂任务</strong>： 例如，使用 <code>Room</code> 库操作 SQLite 数据库，使用 <code>WorkManager</code> 管理后台任务，都比使用原生 API 简单得多。</li>
</ol>
<p><strong>Jetpack 的组成部分：</strong><br/>
Jetpack 被分为四个大类：</p>
<ol>
<li>
<p><strong>架构组件（Architecture）</strong> ： 构建稳健、可测试、可维护应用的核心。</p>
<ul>
<li><code>Data Binding</code>： 以声明方式将布局界面组件绑定到应用中的数据源。</li>
<li><code>Lifecycle</code>： 管理 Activity 和 Fragment 的生命周期。</li>
<li><code>LiveData</code>： 在底层数据发生变化时通知视图的可观察数据持有者。</li>
<li><code>ViewModel</code>： 以注重生命周期的方式存储和管理界面相关的数据。</li>
<li><code>Room</code>： SQLite 数据库的抽象层，提供编译时校验和便利的 API。</li>
<li><code>Navigation</code>： 处理应用内导航。</li>
<li><code>Paging</code>： 逐步从数据源加载信息。</li>
</ul>
</li>
<li>
<p><strong>界面组件（UI）</strong> ： 提供各种界面控件和辅助工具。</p>
<ul>
<li><code>Fragment</code>： 模块化的界面组件。</li>
<li><code>Layout</code>： 用于排列视图的 XML 布局。</li>
<li><code>AppCompat</code>： 让应用在新版 Android 上也能拥有 Material Design 外观。</li>
<li><code>Emoji</code>： 确保设备在系统未更新时也能显示最新的 emoji。</li>
<li><code>Transition</code>： 处理界面之间的动画过渡。</li>
<li><code>Palette</code>： 从图片中提取有意义的颜色。</li>
</ul>
</li>
<li>
<p><strong>行为组件（Behavior）</strong> ： 与标准 Android 服务集成。</p>
<ul>
<li><code>Download Manager</code>： 处理长时间运行的 HTTP 文件下载。</li>
<li><code>Media &amp; Playback</code>： 用于媒体播放和路由（向后兼容）。</li>
<li><code>Notifications</code>： 提供向后兼容的通知 API。</li>
<li><code>Permissions</code>： 用于检查和请求应用权限。</li>
<li><code>Sharing</code>： 提供共享操作（如 <code>ShareActionProvider</code>）。</li>
<li><code>Slices</code>： 在 Google 搜索等地方展示应用的交互式内容。</li>
</ul>
</li>
<li>
<p><strong>基础组件（Foundation）</strong> ： 提供横向功能，如向后兼容、测试和 Kotlin 语言支持。</p>
<ul>
<li><code>AppCompat</code>： 为旧版 Android 提供 Material Design 的实现。</li>
<li><code>Android KTX</code>： 提供了一系列 Kotlin 扩展函数，让代码更简洁、更地道。</li>
<li><code>Multidex</code>： 为方法数超过 64K 的应用提供支持。</li>
<li><code>Test</code>： 用于进行单元测试和仪器测试的框架。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-4">3. 区别与联系</h3>






























<table><thead><tr><th>特性</th><th>Jetpack</th><th>AndroidX</th></tr></thead><tbody><tr><td><strong>定义</strong></td><td><strong>一套组件、工具和指南的集合</strong>（一个“生态”或“品牌”）。</td><td><strong>Jetpack 组件的官方命名空间和包结构</strong>（一个“包装标准”）。</td></tr><tr><td><strong>范围</strong></td><td>广泛，包含架构、UI、行为、基础等超过 100 个库。</td><td>具体，是所有 Jetpack 库的包名前缀。</td></tr><tr><td><strong>关系</strong></td><td><strong>内容</strong>。Jetpack 定义了“有什么库”和“这些库能做什么”。</td><td><strong>形式</strong>。AndroidX 定义了“这些库叫什么”和“如何被引入项目”。</td></tr><tr><td><strong>类比</strong></td><td>如同  <strong>“宜家家居”</strong>  这个品牌，它提供卧室、厨房、客厅等各种系列的家具。</td><td>如同宜家所有产品都遵循的  <strong>“平板包装”和“Allen Key 组装”</strong>  标准。</td></tr></tbody></table>
<p><strong>核心联系：</strong><br/>
<strong>所有 Jetpack 组件都使用 AndroidX 命名空间。</strong>  当你使用 Jetpack 时，你实际上是在使用 <code>androidx.*</code> 包下的库。</p>
<hr/>
<h3 data-id="heading-5">4. 用法示例</h3>
<h4 data-id="heading-6">1. 在项目中配置</h4>
<p>首先，在你的项目的 <code>build.gradle</code> 文件中，确保已经配置了 AndroidX：</p>
<p>gradle</p>
<pre><code class="hljs language-ini" lang="ini">// 在 gradle.properties 文件中（如果没有则添加）
<span class="hljs-attr">android.useAndroidX</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">android.enableJetifier</span>=<span class="hljs-literal">true</span> // 这个标志表示自动迁移旧的依赖到 AndroidX
</code></pre>
<h4 data-id="heading-7">2. 添加依赖</h4>
<p>然后，在你的 App 模块的 <code>build.gradle</code> 文件中，添加你需要的 Jetpack 组件（即 AndroidX 库）。</p>
<p><strong>示例 1：使用 ViewModel 和 LiveData（架构组件）</strong></p>
<p>gradle</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    def lifecycle_version = <span class="hljs-string">"2.6.2"</span>

    <span class="hljs-comment">// ViewModel</span>
    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-viewmodel-ktx:<span class="hljs-variable">$lifecycle_version</span>"</span>
    <span class="hljs-comment">// LiveData</span>
    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-livedata-ktx:<span class="hljs-variable">$lifecycle_version</span>"</span>
    <span class="hljs-comment">// 可选 - 生命周期感知组件，如默认的 LifecycleObserver</span>
    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-common-java8:<span class="hljs-variable">$lifecycle_version</span>"</span>
}
</code></pre>
<p><strong>在代码中使用：</strong></p>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// MainActivity.kt</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-comment">// 通过 ViewModelProvider 获取 ViewModel 实例</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModel: MainViewModel <span class="hljs-keyword">by</span> viewModels()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        <span class="hljs-comment">// 观察 LiveData，当数据变化时自动更新 UI</span>
        viewModel.myData.observe(<span class="hljs-keyword">this</span>) { <span class="hljs-keyword">data</span> -&gt;
            <span class="hljs-comment">// 更新 TextView 或其他 UI 组件</span>
            textView.text = <span class="hljs-keyword">data</span>
        }
    }
}

<span class="hljs-comment">// MainViewModel.kt</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-comment">// 使用 MutableLiveData 来持有可以被改变的数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _myData = MutableLiveData&lt;String&gt;()
    <span class="hljs-comment">// 对外暴露不可变的 LiveData，防止外部修改</span>
    <span class="hljs-keyword">val</span> myData: LiveData&lt;String&gt; = _myData

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateData</span><span class="hljs-params">(newData: <span class="hljs-type">String</span>)</span></span> {
        _myData.value = newData
    }
}
</code></pre>
<p><strong>示例 2：使用 Room（架构组件）</strong></p>
<p>gradle</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    def room_version = <span class="hljs-string">"2.5.2"</span>

    implementation <span class="hljs-string">"androidx.room:room-runtime:<span class="hljs-variable">$room_version</span>"</span>
    kapt <span class="hljs-string">"androidx.room:room-compiler:<span class="hljs-variable">$room_version</span>"</span> <span class="hljs-comment">// 对于 Kotlin，使用 kapt。Java 用 annotationProcessor</span>
    <span class="hljs-comment">// 可选 - Kotlin 扩展和协程支持</span>
    implementation <span class="hljs-string">"androidx.room:room-ktx:<span class="hljs-variable">$room_version</span>"</span>
}
</code></pre>
<p><strong>在代码中使用：</strong></p>
<p>kotlin</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 定义数据实体（Entity）</span>
<span class="hljs-variable">@Entity</span>
data class <span class="hljs-built_in">User</span>(
    <span class="hljs-variable">@PrimaryKey</span> val <span class="hljs-attribute">uid</span>: Int,
    <span class="hljs-variable">@ColumnInfo</span>(name = <span class="hljs-string">"first_name"</span>) val <span class="hljs-attribute">firstName</span>: String?,
    <span class="hljs-variable">@ColumnInfo</span>(name = <span class="hljs-string">"last_name"</span>) val <span class="hljs-attribute">lastName</span>: String?
)

<span class="hljs-comment">// 2. 定义数据访问对象（DAO）</span>
<span class="hljs-variable">@Dao</span>
interface UserDao {
    <span class="hljs-variable">@Query</span>(<span class="hljs-string">"SELECT * FROM user"</span>)
    fun <span class="hljs-built_in">getAll</span>(): List&lt;User&gt;

    <span class="hljs-variable">@Insert</span>
    fun <span class="hljs-built_in">insertAll</span>(vararg <span class="hljs-attribute">users</span>: User)
}

<span class="hljs-comment">// 3. 定义数据库（Database）</span>
<span class="hljs-variable">@Database</span>(entities = [<span class="hljs-attribute">User</span>::class], version = <span class="hljs-number">1</span>)
abstract class <span class="hljs-attribute">AppDatabase </span>: <span class="hljs-built_in">RoomDatabase</span>() {
    <span class="hljs-selector-tag">abstract</span> <span class="hljs-selector-tag">fun</span> <span class="hljs-selector-tag">userDao</span>(): <span class="hljs-selector-tag">UserDao</span>
}

<span class="hljs-comment">// 在 Activity 或 Application 中创建数据库实例</span>
<span class="hljs-selector-tag">val</span> <span class="hljs-selector-tag">db</span> = <span class="hljs-selector-tag">Room</span><span class="hljs-selector-class">.databaseBuilder</span>(
    applicationContext,
    <span class="hljs-attribute">AppDatabase</span>::class.java, <span class="hljs-string">"database-name"</span>
)<span class="hljs-selector-class">.build</span>()

<span class="hljs-comment">// 使用 DAO</span>
<span class="hljs-selector-tag">val</span> <span class="hljs-selector-tag">users</span> = <span class="hljs-selector-tag">db</span><span class="hljs-selector-class">.userDao</span>()<span class="hljs-selector-class">.getAll</span>()
</code></pre>
<hr/>
<h3 data-id="heading-8">总结</h3>
<ul>
<li><strong>AndroidX</strong> 是<strong>基础设施</strong>，是所有现代 Android 支持库的<strong>新家（<code>androidx.*</code> 包名）</strong> 。</li>
<li><strong>Jetpack</strong> 是建立在 AndroidX 之上的<strong>一套强大的开发工具集</strong>，它提供了构建优秀应用所需的各种组件和架构指导。</li>
</ul>
<p>对于开发者来说，<strong>你不需要在“使用 AndroidX”和“使用 Jetpack”之间做选择</strong>。当你开始一个新项目时，Android Studio 默认会使用 AndroidX。而当你引入任何一个 <code>androidx.*</code> 包下的库时，你就在使用 Jetpack。它们是现代 Android 开发的基石，强烈建议所有新项目都基于它们进行开发。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Playwright MCP玩转浏览器自动化]]></title>    <link>https://juejin.cn/post/7573687816430862346</link>    <guid>https://juejin.cn/post/7573687816430862346</guid>    <pubDate>2025-11-18T07:25:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573687816430862346" data-draft-id="7573669819028635658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Playwright MCP玩转浏览器自动化"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2025-11-18T07:25:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老克聊AI"/> <meta itemprop="url" content="https://juejin.cn/user/2596366815072922"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Playwright MCP玩转浏览器自动化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2596366815072922/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老克聊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T07:25:56.000Z" title="Tue Nov 18 2025 07:25:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，分享知识，乘风而行，我是老克。今天为大家分享一款MCP应用，Playwright MCP。通过这个MCP，你可以让Claude直接控制浏览器，自动完成网页操作、数据抓取、表单填写等任务。接下来，我将手把手教你如何安装配置，并通过两个实战案例展示它的强大功能。</p>
<h3 data-id="heading-0">Playwright MCP下载安装</h3>
<h4 data-id="heading-1">环境准备</h4>
<p>windows 11操作系统需要安装nodejs，我已经安装了版本是22.21.1。</p>
<h4 data-id="heading-2">安装Playwright</h4>
<pre><code class="hljs">npm install -g playwright
</code></pre>
<p>通过Playwright 安装浏览器</p>
<pre><code class="hljs">playwright install chromium
</code></pre>
<h4 data-id="heading-3">安装Playwright MCP</h4>
<p>Playwright MCP的在github中的项目地址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fexecuteautomation%2Fmcp-playwright" target="_blank" title="https://github.com/executeautomation/mcp-playwright" ref="nofollow noopener noreferrer">github.com/executeauto…</a> 通过smithery安装Playwright MCP</p>
<pre><code class="hljs language-sql" lang="sql">npx <span class="hljs-operator">-</span>y <span class="hljs-variable">@smithery</span><span class="hljs-operator">/</span>cli<span class="hljs-variable">@latest</span> install <span class="hljs-variable">@executeautomation</span><span class="hljs-operator">/</span>playwright<span class="hljs-operator">-</span>mcp<span class="hljs-operator">-</span>server <span class="hljs-comment">--client claude --key d46d0ada-0f5c-4392-b731-3304a101d362</span>
</code></pre>
<p>安装完成后打开Claude Desktop客户端，在Settings→Developer中可以看到已经安装的Playwright MCP。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3318a6d721ad4ed0844cc760edf9d378~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5YWL6IGKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055556&amp;x-signature=ZcE%2F9TnGESi8VRx3EEtTnd7Y9Gk%3D" alt="image.png" loading="lazy"/></p>
<p>注意：由于playwright-mcp-server中的对playwright的浏览器位置使用的是硬编码，playwright的浏览器必须使用chromium-1179——这一点可以改进一下，安装完成Playwright MCP，需要对Playwright中浏览器文件夹进行修改，找到安装目录：C:\Users\DELL\AppData\Local\ms-playwright\，浏览器文件夹修改为chromium-1179</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c62c03ace4da4c3180381e3993ff13c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5YWL6IGKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055556&amp;x-signature=KTx4stbF2%2BVaRTjjTSfZx3LJDsQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">实战一：百度热搜抓取</h3>
<p>演示目标，使用 Playwright MCP 访问百度，获取当天的热门搜索信息。</p>
<p><strong>1. 发送指令给 Claude：</strong></p>
<p><code>请帮我使用浏览器访问百度（www.baidu.com）， 找到今天的热搜榜单，并整理成列表返回给我。</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35677ca8f4a44d28b7f0f76e9332de05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5YWL6IGKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055556&amp;x-signature=DoKEKh5cz7y54ebLo1eU2JzSFo4%3D" alt="image.png" loading="lazy"/></p>
<p>Playwright打开浏览器，访问了百度浏览器。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b61ca71273943f5a19d3a5523490ffa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5YWL6IGKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055556&amp;x-signature=vrKvywuQQ10irVhn67iISSiAyPg%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到获取数据和原页面中的内容一致，能够很好的完成数据采集工作。</p>
<hr/>
<h3 data-id="heading-5">实战演示二：复杂表单填报</h3>
<h4 data-id="heading-6"><strong>准备工作：创建测试表单</strong></h4>
<p>我在本地创建了一个vite的vue项目，将index.html替换为表单</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>员工信息登记表<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: Arial; <span class="hljs-attribute">max-width</span>: <span class="hljs-number">600px</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
        <span class="hljs-selector-class">.form-group</span> { <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>; }
        <span class="hljs-selector-tag">label</span> { <span class="hljs-attribute">display</span>: block; <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">5px</span>; <span class="hljs-attribute">font-weight</span>: bold; }
        <span class="hljs-selector-tag">input</span>, select, <span class="hljs-selector-tag">textarea</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>; <span class="hljs-attribute">box-sizing</span>: border-box; }
        <span class="hljs-selector-tag">button</span> { <span class="hljs-attribute">background</span>: <span class="hljs-number">#007bff</span>; <span class="hljs-attribute">color</span>: white; <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>; <span class="hljs-attribute">border</span>: none; <span class="hljs-attribute">cursor</span>: pointer; }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>员工信息登记表<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"employeeForm"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>姓名 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>性别 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"gender"</span> <span class="hljs-attr">required</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>请选择<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"male"</span>&gt;</span>男<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"female"</span>&gt;</span>女<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>出生日期 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"date"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"birthday"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>联系电话 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"tel"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"phone"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>电子邮箱 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>部门 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"department"</span> <span class="hljs-attr">required</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>请选择部门<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tech"</span>&gt;</span>技术部<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"sales"</span>&gt;</span>销售部<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"hr"</span>&gt;</span>人力资源部<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"finance"</span>&gt;</span>财务部<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>职位 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"position"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>入职日期 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"date"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hireDate"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>教育程度 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"education"</span> <span class="hljs-attr">required</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>请选择<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"bachelor"</span>&gt;</span>本科<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"master"</span>&gt;</span>硕士<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"phd"</span>&gt;</span>博士<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"other"</span>&gt;</span>其他<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>技能特长<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"skills"</span> <span class="hljs-attr">rows</span>=<span class="hljs-string">"4"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请描述您的专业技能和特长"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"agreement"</span> <span class="hljs-attr">required</span>&gt;</span>
                我已阅读并同意公司相关规定
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'employeeForm'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'submit'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
            e.<span class="hljs-title function_">preventDefault</span>();
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'表单提交成功！'</span>);
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>启动项目，通过<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2F%25E8%25AE%25BF%25E9%2597%25AE%25E8%25A1%25A8%25E5%258D%2595" target="_blank" title="http://localhost:5173/%E8%AE%BF%E9%97%AE%E8%A1%A8%E5%8D%95" ref="nofollow noopener noreferrer">http://localhost:5173/访问表单</a></p>
<h4 data-id="heading-7">演示操作</h4>
<h5 data-id="heading-8">1.打开表单</h5>
<p>告诉claude 打开浏览器，访问<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2F" target="_blank" title="http://localhost:5173/" ref="nofollow noopener noreferrer">http://localhost:5173/</a></p>
<h5 data-id="heading-9">2.填写表单内容</h5>
<p>告诉claude，填写表单内容，命令如下：</p>
<pre><code class="hljs language-diff" lang="diff">请帮我填写这个员工登记表单（file:///path/to/complex-form.html），
使用以下信息：
<span class="hljs-deletion">- 姓名：张小明</span>
<span class="hljs-deletion">- 性别：男</span>
<span class="hljs-deletion">- 出生日期：1990-05-15</span>
<span class="hljs-deletion">- 联系电话：13800138000</span>
<span class="hljs-deletion">- 电子邮箱：zhangxiaoming@example.com</span>
<span class="hljs-deletion">- 部门：技术部</span>
<span class="hljs-deletion">- 职位：高级工程师</span>
<span class="hljs-deletion">- 入职日期：2024-01-15</span>
<span class="hljs-deletion">- 教育程度：硕士</span>
<span class="hljs-deletion">- 技能特长：精通Python、JavaScript，5年全栈开发经验</span>

然后勾选同意条款，并提交表单。
</code></pre>
<p>大家好，分享知识，乘风而行，我是老克。今天为大家分享一款MCP应用，Playwright MCP。通过这个MCP，你可以让Claude直接控制浏览器，自动完成网页操作、数据抓取、表单填写等任务。接下来，我将手把手教你如何安装配置，并通过两个实战案例展示它的强大功能。</p>
<h3 data-id="heading-10">Playwright MCP下载安装</h3>
<h4 data-id="heading-11">环境准备</h4>
<p>windows 11操作系统需要安装nodejs，我已经安装了版本是22.21.1。</p>
<h4 data-id="heading-12">安装Playwright</h4>
<pre><code class="hljs">npm install -g playwright
</code></pre>
<p>通过Playwright 安装浏览器</p>
<pre><code class="hljs">playwright install chromium
</code></pre>
<h4 data-id="heading-13">安装Playwright MCP</h4>
<p>Playwright MCP的在github中的项目地址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fexecuteautomation%2Fmcp-playwright" target="_blank" title="https://github.com/executeautomation/mcp-playwright" ref="nofollow noopener noreferrer">github.com/executeauto…</a> 通过smithery安装Playwright MCP</p>
<pre><code class="hljs language-sql" lang="sql">npx <span class="hljs-operator">-</span>y <span class="hljs-variable">@smithery</span><span class="hljs-operator">/</span>cli<span class="hljs-variable">@latest</span> install <span class="hljs-variable">@executeautomation</span><span class="hljs-operator">/</span>playwright<span class="hljs-operator">-</span>mcp<span class="hljs-operator">-</span>server <span class="hljs-comment">--client claude --key d46d0ada-0f5c-4392-b731-3304a101d362</span>
</code></pre>
<p>安装完成后打开Claude Desktop客户端，在Settings→Developer中可以看到已经安装的Playwright MCP。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b0135e46fcf4b3489da269d12db8f06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5YWL6IGKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055556&amp;x-signature=VJrYXrZn%2FhhoR%2BTKByYpZuc6b2k%3D" alt="image.png" loading="lazy"/></p>
<p>注意：由于playwright-mcp-server中的对playwright的浏览器位置使用的是硬编码，playwright的浏览器必须使用chromium-1179——这一点可以改进一下，安装完成Playwright MCP，需要对Playwright中浏览器文件夹进行修改，找到安装目录：C:\Users\DELL\AppData\Local\ms-playwright\，浏览器文件夹修改为chromium-1179</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b298a180bc3040eaa67b6232caa41cf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5YWL6IGKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055556&amp;x-signature=teEOxz55dpuxEd5Hw2S%2B4CYU8HQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-14">实战一：百度热搜抓取</h3>
<p>演示目标，使用 Playwright MCP 访问百度，获取当天的热门搜索信息。</p>
<p><strong>1. 发送指令给 Claude：</strong></p>
<p><code>请帮我使用浏览器访问百度（www.baidu.com）， 找到今天的热搜榜单，并整理成列表返回给我。</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3dcc316350847a9ba48b851cac05444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5YWL6IGKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055556&amp;x-signature=bRgWFHcVD9utcrUDFPotOv8aVyI%3D" alt="image.png" loading="lazy"/></p>
<p>Playwright打开浏览器，访问了百度浏览器。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fd4f203395d49e2ad61cdc08aeebf4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5YWL6IGKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055556&amp;x-signature=3p98t4okYZga%2BW%2F9nVitvhsoIL4%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到获取数据和原页面中的内容一致，能够很好的完成数据采集工作。</p>
<hr/>
<h3 data-id="heading-15">实战演示二：复杂表单填报</h3>
<h4 data-id="heading-16"><strong>准备工作：创建测试表单</strong></h4>
<p>我在本地创建了一个vite的vue项目，将index.html替换为表单</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>员工信息登记表<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: Arial; <span class="hljs-attribute">max-width</span>: <span class="hljs-number">600px</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
        <span class="hljs-selector-class">.form-group</span> { <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>; }
        <span class="hljs-selector-tag">label</span> { <span class="hljs-attribute">display</span>: block; <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">5px</span>; <span class="hljs-attribute">font-weight</span>: bold; }
        <span class="hljs-selector-tag">input</span>, select, <span class="hljs-selector-tag">textarea</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>; <span class="hljs-attribute">box-sizing</span>: border-box; }
        <span class="hljs-selector-tag">button</span> { <span class="hljs-attribute">background</span>: <span class="hljs-number">#007bff</span>; <span class="hljs-attribute">color</span>: white; <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>; <span class="hljs-attribute">border</span>: none; <span class="hljs-attribute">cursor</span>: pointer; }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>员工信息登记表<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"employeeForm"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>姓名 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>性别 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"gender"</span> <span class="hljs-attr">required</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>请选择<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"male"</span>&gt;</span>男<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"female"</span>&gt;</span>女<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>出生日期 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"date"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"birthday"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>联系电话 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"tel"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"phone"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>电子邮箱 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>部门 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"department"</span> <span class="hljs-attr">required</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>请选择部门<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tech"</span>&gt;</span>技术部<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"sales"</span>&gt;</span>销售部<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"hr"</span>&gt;</span>人力资源部<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"finance"</span>&gt;</span>财务部<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>职位 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"position"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>入职日期 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"date"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hireDate"</span> <span class="hljs-attr">required</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>教育程度 *<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"education"</span> <span class="hljs-attr">required</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>请选择<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"bachelor"</span>&gt;</span>本科<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"master"</span>&gt;</span>硕士<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"phd"</span>&gt;</span>博士<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"other"</span>&gt;</span>其他<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>技能特长<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"skills"</span> <span class="hljs-attr">rows</span>=<span class="hljs-string">"4"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请描述您的专业技能和特长"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-group"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"agreement"</span> <span class="hljs-attr">required</span>&gt;</span>
                我已阅读并同意公司相关规定
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'employeeForm'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'submit'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
            e.<span class="hljs-title function_">preventDefault</span>();
            <span class="hljs-title function_">alert</span>(<span class="hljs-string">'表单提交成功！'</span>);
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>启动项目，通过<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2F%25E8%25AE%25BF%25E9%2597%25AE%25E8%25A1%25A8%25E5%258D%2595" target="_blank" title="http://localhost:5173/%E8%AE%BF%E9%97%AE%E8%A1%A8%E5%8D%95" ref="nofollow noopener noreferrer">http://localhost:5173/访问表单</a></p>
<h4 data-id="heading-17">演示操作</h4>
<h5 data-id="heading-18">1.打开表单</h5>
<p>告诉claude 打开浏览器，访问<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2F" target="_blank" title="http://localhost:5173/" ref="nofollow noopener noreferrer">http://localhost:5173/</a></p>
<h5 data-id="heading-19">2.填写表单内容</h5>
<p>告诉claude，填写表单内容，命令如下：</p>
<pre><code class="hljs language-diff" lang="diff">请帮我填写这个员工登记表单（file:///path/to/complex-form.html），
使用以下信息：
<span class="hljs-deletion">- 姓名：张小明</span>
<span class="hljs-deletion">- 性别：男</span>
<span class="hljs-deletion">- 出生日期：1990-05-15</span>
<span class="hljs-deletion">- 联系电话：13800138000</span>
<span class="hljs-deletion">- 电子邮箱：zhangxiaoming@example.com</span>
<span class="hljs-deletion">- 部门：技术部</span>
<span class="hljs-deletion">- 职位：高级工程师</span>
<span class="hljs-deletion">- 入职日期：2024-01-15</span>
<span class="hljs-deletion">- 教育程度：硕士</span>
<span class="hljs-deletion">- 技能特长：精通Python、JavaScript，5年全栈开发经验</span>

然后勾选同意条款，并提交表单。
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/130773aca5bf48b0b6cea8c853147595~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5YWL6IGKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055556&amp;x-signature=N29AlOZnhWDcBxhNWp7WKyFSnIs%3D" alt="image3.png" loading="lazy"/></p>
<p>Claude按照指令一步步的将表单内容填写完善，填写结果完全符合预期，非常好！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dace789e8516411ca91dc46aae5b1bce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5YWL6IGKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055556&amp;x-signature=AX1KIWo5nXz8XHV6Mb8qsFHzKjU%3D" alt="after_submit-2025-11-18T03-02-53-324Z.png" loading="lazy"/></p>
<h2 data-id="heading-20">总结</h2>
<p>Playwright MCP让普通人在无需编程，只用自然语言描述就可以的情况下就可以通过浏览器完成信息采集和填报的自动化工作。应用场景有，信息采集和监控、自动化表单填报、网站功能测试、数据批量处理、定时任务执行。</p>
<p>如果这个视频对你有帮助，请给我一个免费的赞,关注我的账号！有任何问题欢迎在评论区留言，我会及时回复。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java + Spring 到 Python + FastAPI （二）]]></title>    <link>https://juejin.cn/post/7572997791451201574</link>    <guid>https://juejin.cn/post/7572997791451201574</guid>    <pubDate>2025-11-17T01:54:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572997791451201574" data-draft-id="7572048000301629481" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java + Spring 到 Python + FastAPI （二）"/> <meta itemprop="keywords" content="Java,Spring,Python"/> <meta itemprop="datePublished" content="2025-11-17T01:54:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小兵张健"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032405229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java + Spring 到 Python + FastAPI （二）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032405229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小兵张健
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T01:54:20.000Z" title="Mon Nov 17 2025 01:54:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">FastAPI 中 Depends 应用级使用</h2>
<p>除了单个函数方法的 Depends 外，还有整个应用层级的 Depends yield，以 Redis 初始化连接池为例。</p>
<p>连接池只在应用的启动的时候创建，停止时关闭。可以用 @app.on_event("startup") 和 @app.on_event("shutdown")，但更推荐用 lifespan。</p>
<p>老用法：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 逻辑被拆分在两个不同的函数里</span>
<span class="hljs-meta">@app.on_event(<span class="hljs-params"><span class="hljs-string">"startup"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">startup_event</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- 启动：创建连接池 ---"</span>)
    app.state.db_pool = <span class="hljs-keyword">await</span> create_db_pool()

<span class="hljs-meta">@app.on_event(<span class="hljs-params"><span class="hljs-string">"shutdown"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">shutdown_event</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- 关闭：销毁连接池 ---"</span>)
    <span class="hljs-keyword">await</span> app.state.db_pool.close()

app = FastAPI()
</code></pre>
<p>新用法：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> asynccontextmanager

<span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: FastAPI</span>):
    <span class="hljs-comment"># --- 启动时 ---</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- (Lifespan) 创建数据库连接池 (Engine)... ---"</span>)
    db_pool_engine = <span class="hljs-keyword">await</span> create_db_pool() <span class="hljs-comment"># 昂贵的操作，只做一次</span>
    
    <span class="hljs-comment"># 关键：把 '池' 挂载到 app.state 上</span>
    app.state.db_pool = db_pool_engine
    
    <span class="hljs-keyword">yield</span>
    
    <span class="hljs-comment"># --- 关闭时 ---</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- (Lifespan) 关闭数据库连接池... ---"</span>)
    <span class="hljs-keyword">await</span> app.state.db_pool.close()

<span class="hljs-comment"># 注册 lifespan</span>
app = FastAPI(lifespan=lifespan)
</code></pre>
<p>app.state 是 FastAPI 提供的一个全局状态对象，用于存储 Redis、MySQL 连接池等比较重的对象。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Request, Depends

<span class="hljs-comment"># 这是你的 'Depends' 依赖项</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db_session</span>(<span class="hljs-params">request: Request</span>):
    <span class="hljs-comment"># 1. 从 'request' 中拿到 'app'，再拿到 'state'</span>
    db_pool = request.app.state.db_pool
    
    <span class="hljs-comment"># 2. 从 '池' 中获取一个 '连接'</span>
    <span class="hljs-comment">#    'async with' 语句会自动 '借' 和 '还'</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> db_pool.acquire() <span class="hljs-keyword">as</span> connection:
        <span class="hljs-comment"># 3. 基于这个连接，创建事务</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> connection.begin() <span class="hljs-keyword">as</span> transaction:
            <span class="hljs-comment"># 4. 创建一个轻量级的 Session</span>
            <span class="hljs-comment">#    (注意：不同DB库实现不同，这里是概念)</span>
            session = create_session(connection, transaction) 
            
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 5. 'yield' 这个 session 给路由</span>
                <span class="hljs-keyword">yield</span> session
                <span class="hljs-comment"># 6. 路由成功，事务自动 commit</span>
            <span class="hljs-keyword">except</span> Exception:
                <span class="hljs-comment"># 7. 路由失败，事务自动 rollback</span>
                <span class="hljs-keyword">await</span> transaction.rollback()
                <span class="hljs-keyword">raise</span>
</code></pre>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/users/{user_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user</span>(<span class="hljs-params">
    user_id: <span class="hljs-built_in">int</span>,
    <span class="hljs-comment"># 'Depends' 会自动执行第 2 步</span>
    db: AsyncSession = Depends(<span class="hljs-params">get_db_session</span>) 
</span>):
    <span class="hljs-comment"># 'db' 就是那个被 'yield' 出来的、带事务的 session</span>
    user = <span class="hljs-keyword">await</span> user_repo.get_user(db, user_id)
    <span class="hljs-keyword">return</span> user
</code></pre>
<p>总结： lifespan (启动) -&gt; app.state (全局存储) -&gt; Request (传递 app) -&gt; Depends (读取 app.state) -&gt; yield (注入路由)。</p>
<h2 data-id="heading-1">资源连接池全局使用</h2>
<p>因为是 FastAPI 的，意味着必须在 http 环境内才能使用。如果在非 http 环境使用，需要这样改造。</p>
<p>先创建一个全局共用的 db_core.py。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># db_core.py</span>
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> create_async_engine, AsyncSession, AsyncEngine
<span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> sessionmaker
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> asynccontextmanager

<span class="hljs-comment"># 1. 在模块的顶层定义一个全局变量 (我们的“单例”)</span>
<span class="hljs-comment">#    它在所有导入此模块的文件中是 *共享* 的</span>
db_engine: AsyncEngine | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
_async_session_maker = <span class="hljs-literal">None</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_db_pool</span>():
    <span class="hljs-keyword">global</span> db_engine, _async_session_maker
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- (Core) 正在创建全局数据库连接池... ---"</span>)
    db_engine = create_async_engine(
        <span class="hljs-string">"mysql+aiomysql://..."</span>, 
        pool_size=<span class="hljs-number">10</span>, 
        max_overflow=<span class="hljs-number">5</span>
    )
    _async_session_maker = sessionmaker(
        db_engine, class_=AsyncSession, expire_on_commit=<span class="hljs-literal">False</span>
    )

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">close_db_pool</span>():
    <span class="hljs-keyword">global</span> db_engine
    <span class="hljs-keyword">if</span> db_engine:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- (Core) 正在关闭全局数据库连接池... ---"</span>)
        <span class="hljs-keyword">await</span> db_engine.dispose()

<span class="hljs-comment"># 2. 这就是你的“事务”依赖项！</span>
<span class="hljs-comment">#    注意：它现在 *不* 需要 'request: Request' 了！</span>
<span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db_session</span>():
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _async_session_maker:
        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"数据库连接池未初始化，请先调用 create_db_pool()"</span>)

    <span class="hljs-comment"># _async_session_maker() 会自动从 'db_engine' (池) 中获取连接</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> _async_session_maker() <span class="hljs-keyword">as</span> session:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">yield</span> session
            <span class="hljs-keyword">await</span> session.commit()
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">await</span> session.rollback()
            <span class="hljs-keyword">raise</span>
</code></pre>
<p>在 FastAPI 中使用 lifespan 包裹。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># main.py</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Depends
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> asynccontextmanager
<span class="hljs-keyword">from</span> db_core <span class="hljs-keyword">import</span> create_db_pool, close_db_pool, get_db_session

<span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: FastAPI</span>):
    <span class="hljs-comment"># 'lifespan' 负责触发全局单例的初始化</span>
    <span class="hljs-keyword">await</span> create_db_pool()
    <span class="hljs-keyword">yield</span>
    <span class="hljs-keyword">await</span> close_db_pool()

app = FastAPI(lifespan=lifespan)

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/users/{user_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user</span>(<span class="hljs-params">
    user_id: <span class="hljs-built_in">int</span>,
    <span class="hljs-comment"># 魔法！'get_db_session' 现在是一个“通用”依赖项</span>
    <span class="hljs-comment"># FastAPI 会自动处理 @asynccontextmanager</span>
    db: AsyncSession = Depends(<span class="hljs-params">get_DBSession</span>) 
</span>):
    <span class="hljs-comment"># 'db' 就是那个带事务的 session</span>
    user = <span class="hljs-keyword">await</span> user_repo.get_user(db, user_id)
    <span class="hljs-keyword">return</span> user
</code></pre>
<p>在非 http 环境中，则自己维护生命周期。比如 Kafka 消费。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># main.py</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Depends
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> asynccontextmanager
<span class="hljs-keyword">from</span> db_core <span class="hljs-keyword">import</span> create_db_pool, close_db_pool, get_db_session

<span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: FastAPI</span>):
    <span class="hljs-comment"># 'lifespan' 负责触发全局单例的初始化</span>
    <span class="hljs-keyword">await</span> create_db_pool()
    <span class="hljs-keyword">yield</span>
    <span class="hljs-keyword">await</span> close_db_pool()

app = FastAPI(lifespan=lifespan)

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/users/{user_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user</span>(<span class="hljs-params">
    user_id: <span class="hljs-built_in">int</span>,
    <span class="hljs-comment"># 魔法！'get_db_session' 现在是一个“通用”依赖项</span>
    <span class="hljs-comment"># FastAPI 会自动处理 @asynccontextmanager</span>
    db: AsyncSession = Depends(<span class="hljs-params">get_DBSession</span>) 
</span>):
    <span class="hljs-comment"># 'db' 就是那个带事务的 session</span>
    user = <span class="hljs-keyword">await</span> user_repo.get_user(db, user_id)
    <span class="hljs-keyword">return</span> user
</code></pre>
<p>用哪种取决于项目，纯 http API 项目全在 FastAPI 里面配合 BackgroundTasks 就够了，如果还有非 http 入口的处理，比如定时任务、Kafka 消费等，则用第二种。</p>
<p>BackgroundTasks 的作用和异步线程类似，比如用户注册成功后要发个邮件通知，这就可以用 BackgroundTasks 做，只不过原理不是真的有个异步线程池，而是 FastAPI 内部维护了一个 list 列表保存这些任务，在 http 处理完毕后，将 list 给 Ready Queue 执行，例如。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, BackgroundTasks

app = FastAPI()

<span class="hljs-comment"># 这是一个模拟的、'async' 的邮件发送函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_welcome_email</span>(<span class="hljs-params">email: <span class="hljs-built_in">str</span>, name: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-comment"># 模拟 2 秒钟的 I/O 延迟</span>
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- [后台任务]：邮件已发送给 <span class="hljs-subst">{email}</span> (姓名: <span class="hljs-subst">{name}</span>) ---"</span>)
    
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/users"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">
    email: <span class="hljs-built_in">str</span>,
    name: <span class="hljs-built_in">str</span>,
    background_tasks: BackgroundTasks  <span class="hljs-comment"># 1. 在这里声明</span>
</span>):
    <span class="hljs-comment"># ... 你的核心业务逻辑，比如保存用户到数据库 ...</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- (路由) 正在创建用户 <span class="hljs-subst">{name}</span> ... ---"</span>)
    
    <span class="hljs-comment"># 2. 添加后台任务</span>
    <span class="hljs-comment"># 它不会立即执行！</span>
    background_tasks.add_task(
        send_welcome_email,  <span class="hljs-comment"># 你要调用的函数</span>
        email,               <span class="hljs-comment"># 位置参数</span>
        name=name            <span class="hljs-comment"># 关键字参数</span>
    )
    
    <span class="hljs-comment"># 3. 立即返回响应</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- (路由) 立即返回响应给用户 ---"</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">f"用户 <span class="hljs-subst">{name}</span> 创建成功，欢迎邮件将在后台发送。"</span>}
</code></pre>
<h3 data-id="heading-2">遇到 CPU 密集型任务怎么办？</h3>
<p>在上一篇文章里面详细说过，为了方便做内存回收，Python 用 GLC 保证在同一个时刻只有一个线程拿到锁，io 任务除外。</p>
<p>所以 Python 没有多线程，即使用 asyncio.to_thread 执行，也会占用 GLC。</p>
<p>要真正的运行 CPU 密集型任务，只能用多进程。每个进程有自己的 GLC，相互不干扰，即新启一个 Python 程序。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ProcessPoolExecutor

<span class="hljs-keyword">def</span> <span class="hljs-title function_">my_cpu_heavy_task</span>():
    <span class="hljs-comment"># ... (5 秒钟的 CPU 密集型计算) ...</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Done"</span>

<span class="hljs-comment"># 你需要自己管理这个进程池</span>
cpu_pool = ProcessPoolExecutor()

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/cpu-task"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_cpu_task</span>():
    loop = asyncio.get_running_loop()
    
    <span class="hljs-comment"># 告诉事件循环：</span>
    <span class="hljs-comment"># "请在 'cpu_pool' (一个完全独立的进程) 里运行这个任务"</span>
    result = <span class="hljs-keyword">await</span> loop.run_in_executor(
        cpu_pool,  <span class="hljs-comment"># &lt;--- 使用进程池，而不是线程池</span>
        my_cpu_heavy_task
    )
    
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"result"</span>: result}
</code></pre>
<h2 data-id="heading-3">yield 的原理</h2>
<p>yield 是暂停一个函数，return 是返回一个函数。yield 把一个普通函数变为了生成器（Generator）。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_generator</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- 1. 生成器开始 ---"</span>)
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"Hello"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- 2. 我从 'Hello' 之后被唤醒了 ---"</span>)
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"World"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- 3. 我从 'World' 之后被唤醒了 ---"</span>)
    <span class="hljs-comment"># 没有更多的 yield，函数自动结束</span>
</code></pre>
<p>类似 Java 中 Iterator，每一个 yield 都是 next()，先判断 hasNext()，再执行。</p>
<p>在堆栈层面，普通的 return 执行后，堆栈里面的临时变量都销毁，而 yield 相当于暂停操作，保留内存中的数据，生命周期是创建 -&gt; 暂停 -&gt; 恢复 -&gt; ... -&gt; 死亡。</p>
<h2 data-id="heading-4">关键词和组件区分</h2>
<p>Python 的语言关键词有：async def / await、yield、with/async with，语言特性有 @...（只是提供@符号），Type Hints、装饰器（将函数变为方法入参，类似 Spring 的环绕通知），标准库有 asyncio、contextlib、typing。</p>
<p>FastAPI 的有 Depends（和 yield 搭配一起用），@app.get、 @app.post、@app.on_event("startup") 等框架装饰器，lifespan http 应用的生命周期，Pydantic（用 Type Hints 做校验和类型转换），Uvicorn（类似 Tomcat 容器）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-156 Apache Druid+Kafka 实时分析实战：JSON 拉平摄取与 SQL 指标全流程]]></title>    <link>https://juejin.cn/post/7573632156884271155</link>    <guid>https://juejin.cn/post/7573632156884271155</guid>    <pubDate>2025-11-18T07:32:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573632156884271155" data-draft-id="7573687816430960650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-156 Apache Druid+Kafka 实时分析实战：JSON 拉平摄取与 SQL 指标全流程"/> <meta itemprop="keywords" content="后端,大数据,NoSQL"/> <meta itemprop="datePublished" content="2025-11-18T07:32:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-156 Apache Druid+Kafka 实时分析实战：JSON 拉平摄取与 SQL 指标全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T07:32:50.000Z" title="Tue Nov 18 2025 07:32:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：电商点击/订单流入 Kafka，Druid 进行实时分析与可视化。</li>
<li>结论：嵌套 JSON 需预处理拉平；Kafka Indexing Service 设“从最早位点”与禁用 Rollup 更稳。</li>
<li>产出：Scala Producer→Druid 摄取→SQL 指标（订单/用户/支付/TopN）跑通与常见坑位清单。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96e3b98f8e0045dab35bca37731c0e0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=tmzytXLsKta1xtUbCYpNQLrdABM%3D" alt="大数据-156 Apache Druid+Kafka 实时分析实战：JSON 拉平摄取与 SQL 指标全流程" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79b3c8efd2754e8d802efa7441b9de26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=160VrMjbh3DJpZLiLNaFBRzZETA%3D" alt="Apache Druid" loading="lazy"/></p>
<h2 data-id="heading-1">整体流程</h2>
<ul>
<li>Kafka 数据源: Kafka 是一个分布式流处理平台，负责接收、存储并传输数据。它支持从各类应用、日志、传感器等设备采集实时数据，将数据划分为多个主题（Topic），并将消息分发给消费者。在这个案例中，Kafka 是 Druid 的数据源。</li>
<li>Kafka Producer: 数据生产者（Producer）负责将数据发送到 Kafka 的主题中。例如，应用程序可以向 Kafka 写入日志、用户行为数据、传感器数据等。每条消息可以是 JSON、Avro 等格式的数据记录。</li>
<li>Druid Kafka Ingestion: Druid 提供了对 Kafka 的原生支持。通过 Kafka Indexing Service，Druid 可以持续从 Kafka 的某个主题中消费数据，实时地将这些数据摄取到 Druid 中。摄取过程中，Druid 会将数据拆解为小的段（Segment），并将这些段存储在 Druid 集群的深度存储中（如 HDFS、S3 等）。</li>
<li>实时数据摄取和索引: Druid 的 Kafka 摄取任务会监听 Kafka 的分区，按照流数据的到达顺序消费数据，并在内部创建索引。这些索引结构化存储了数据，并通过分片和分区机制，保证了查询的高效性和水平扩展能力。</li>
<li>Druid 查询层: Druid 提供了非常强大的查询能力，可以通过 SQL 查询方式进行交互，也支持多维查询、聚合查询等。这些查询可以是低延迟的实时查询，也可以对历史数据进行复杂的分析。用户通过 Druid 查询接口或 BI 工具（如 Apache Superset、Tableau 等）向集群发送查询。</li>
<li>Kafka 消费者 Offset 管理: Druid 使用 Kafka 消费者模型，实时消费消息并管理 Offset（偏移量），确保数据不丢失或重复摄取。Offset 会被定期提交到 Kafka 中，保证即使任务重启，摄取进度也能从上一次的位置继续。</li>
<li>持久化和数据存储: 数据在经过摄取和索引后，Druid 会定期将数据段（Segment）持久化到深度存储中，并对旧数据进行合并和压缩，减少存储空间的占用。Druid 的集群架构支持分布式存储和查询，并能根据数据规模进行自动扩展。</li>
</ul>
<h2 data-id="heading-2">案例假设</h2>
<p>假设我们在构建一个用户行为分析系统，通过 Kafka 采集用户点击日志，并通过 Druid 实时分析用户行为。</p>
<ul>
<li>Kafka 数据生产: 电商平台的应用程序会将每次用户点击产生的日志记录（例如点击商品、页面浏览等）发送到 Kafka 中的 user-clicks 主题。每条记录都包含用户ID、商品ID、时间戳、页面信息等。</li>
<li>Druid 数据摄取: 配置 Druid 的 Kafka Indexing Service，从 user-clicks 主题消费数据。数据会实时流入 Druid 中，Druid 将数据按照时间范围切分为段，并存储到其深度存储中。</li>
<li>实时数据查询与分析: 业务方可以通过 SQL 查询或多维查询接口，实时分析用户的点击行为。查询的例子可能是统计每个小时的页面浏览量、分析不同商品的受欢迎程度等。这些查询可以直接反映用户的当前行为，帮助业务方做出快速决策。</li>
<li>可视化和报表: Druid 的查询结果可以通过 Apache Superset 等工具进行可视化展示，创建实时仪表盘，展示用户行为的各种关键指标。数据分析师和运营人员可以在可视化平台上直观地看到当前系统的运营状态。</li>
</ul>
<h2 data-id="heading-3">需求分析</h2>
<h3 data-id="heading-4">场景分析</h3>
<ul>
<li>数据量大，需要在这些数据中根据业务需要灵活查询</li>
<li>实时性要求高</li>
<li>数据实时的推过来，要在秒级对数据进行分析并查询出结果</li>
</ul>
<h3 data-id="heading-5">数据描述</h3>
<pre><code class="hljs language-shell" lang="shell">{"ts":1607499629841,"orderId":"1009388","userId":"807134","orderStatusId":1,"orderStatus":"已支付","payModeId":0,"payMode":"微信","payment":"933.90","products":
[{"productId":"102163","productName":"贝合xxx+粉","price":18.7,"productNum":3,"categoryid":"10360","catname1":"厨卫清洁、纸制用品","catname2":"生活日用","catname3":"浴室用品"},{"productId":"100349","productName":"COxxx0C","price":877.8,"productNum":1,"categoryid":"10302","catname1":"母婴、玩具乐器","catname2":"西洋弦乐器","catname3":"吉他"}]}
</code></pre>
<ul>
<li>ts 交易时间</li>
<li>orderId 订单编号</li>
<li>userId 用户id</li>
<li>orderStatusId 订单状态Id</li>
<li>orderStatus 订单状态 0-11：未支付,已支付,发货中,已发货,发货失败,已退款,已关单,订单过期,订单已失效,产品已失效,代付拒绝,支付中</li>
<li>payModelId 支付方式id</li>
<li>payMode 支付方式：0-6：微信,支付宝,信用卡,银联,货到付款,现金,其他</li>
<li>payment：支付金额</li>
<li>products：购买商品 （一个订单可能包含多个商品，这里是嵌套结构）</li>
<li>productId 商品Id</li>
<li>productName 商品名称</li>
<li>price 单价</li>
<li>productNum 购买数量</li>
<li>categoryid 商品分类Id</li>
<li>catname1 商品一级分类名称</li>
<li>catname2 商品二级分类名称</li>
<li>catname3 商品三级分类名称</li>
</ul>
<p>以上的嵌套的json数据格式，Druid不好处理，需要对数据进行预处理，将数据拉平，处理后的数据格式：</p>
<pre><code class="hljs language-shell" lang="shell">{"ts":1607499629841,"orderId":"1009388","userId":"807134","orderStatusId":1,"orderStatus":"已支付","payModeId":0,"payMode":"微信","payment":"933.90","product":
{"productId":"102163","productName":"贝合xxx+粉","price":18.7,"productNum":3,"categoryid":"10360","catname1":"厨卫清洁、纸制用品","catname2":"生活日用","catname3":"浴室用品"}}
{"ts":1607499629841,"orderId":"1009388","userId":"807134","orderStatusId":1,"orderStatus":"已支付","payModeId":0,"payMode":"微信","payment":"933.90","product":
{"productId":"100349","productName":"COxxx0C","price":877.8,"productNum":1,"categoryid":"10302","catname1":"母婴、玩具乐器","catname2":"西洋弦乐器","catname3":"吉他"}}
</code></pre>
<h2 data-id="heading-6">Kafka生产者</h2>
<p>好久没用Scala了，用Scala写一个：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> icu.wzk.kafka

<span class="hljs-keyword">import</span> org.apache.kafka.clients.producer.{<span class="hljs-type">KafkaProducer</span>, <span class="hljs-type">ProducerConfig</span>, <span class="hljs-type">ProducerRecord</span>}
<span class="hljs-keyword">import</span> org.apache.kafka.common.serialization.<span class="hljs-type">StringSerializer</span>

<span class="hljs-keyword">import</span> java.util.<span class="hljs-type">Properties</span>
<span class="hljs-keyword">import</span> scala.io.<span class="hljs-type">BufferedSource</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">KafkaProducerForDruid</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> brokers = <span class="hljs-string">"h121.wzk.icu:9092"</span>
    <span class="hljs-keyword">val</span> topic = <span class="hljs-string">"druid2"</span>
    <span class="hljs-keyword">val</span> prop = <span class="hljs-keyword">new</span> <span class="hljs-type">Properties</span>()
    prop.put(<span class="hljs-type">ProducerConfig</span>.<span class="hljs-type">BOOTSTRAP_SERVERS_CONFIG</span>, brokers)
    prop.put(<span class="hljs-type">ProducerConfig</span>.<span class="hljs-type">KEY_SERIALIZER_CLASS_CONFIG</span>, classOf[<span class="hljs-type">StringSerializer</span>])
    prop.put(<span class="hljs-type">ProducerConfig</span>.<span class="hljs-type">VALUE_SERIALIZER_CLASS_CONFIG</span>, classOf[<span class="hljs-type">StringSerializer</span>])

    <span class="hljs-keyword">val</span> producer = <span class="hljs-keyword">new</span> <span class="hljs-type">KafkaProducer</span>[<span class="hljs-type">String</span>, <span class="hljs-type">String</span>](prop);
    <span class="hljs-keyword">val</span> source: <span class="hljs-type">BufferedSource</span> = scala.io.<span class="hljs-type">Source</span>.fromFile(<span class="hljs-string">"orders1.json"</span>)
    <span class="hljs-keyword">val</span> iter: <span class="hljs-type">Iterator</span>[<span class="hljs-type">String</span>] = source.getLines();
    iter.foreach {
      line =&gt; <span class="hljs-keyword">val</span> msg = <span class="hljs-keyword">new</span> <span class="hljs-type">ProducerRecord</span>[<span class="hljs-type">String</span>, <span class="hljs-type">String</span>](topic, line);
        producer.send(msg)
        println(msg)
        <span class="hljs-type">Thread</span>.sleep(<span class="hljs-number">10</span>)
    }
    producer.close()
    source.close()
  }
}
</code></pre>
<p>运行结果如下图：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8adbe8be8b24d618eb695883a5cfa4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=YEkBpMeNO4WQyhejzdWg1uCNz2Y%3D" alt="Druid Kafka Producer" loading="lazy"/></p>
<h2 data-id="heading-7">Druid导入数据</h2>
<p>这里就不详细描述了，之前入门阶段已经走过完整的流程了：</p>
<ul>
<li>JSON数据要拉平</li>
<li>不定义 RollUp</li>
</ul>
<p>加载数据源：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1008894294984deea9332757d29231f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=S03d53ZQB7r0RpOM2bPqK21gCZc%3D" alt="Druid 查看数据" loading="lazy"/>
JSON 拉平：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cd1473c441a4173af7379263d732923~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=WYplXTf6idWHnI75jdvzcS5iQ%2Fs%3D" alt="Druid 展示数据" loading="lazy"/>
时间戳：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c6aa34e43c4266ad2302f9b7bb3b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=hHgwzwVP37SD60fkNXCCmKYrRvQ%3D" alt="Druid 数据时间戳" loading="lazy"/>
不要进行 RollUp：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4947ec0a0733417fbcd9a3348db174ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=mmcVxVKqHW5ym6ziriMAxR3dwDM%3D" alt="Druid 不进行 Roll Up" loading="lazy"/>
最终结果如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4167f58fad5a4be7899084c5e8dcf2ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=rTXZx66y0mbEG55eKPYO6ttTvFk%3D" alt="Druid JSON 数据展示" loading="lazy"/>
计算结果如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a05bfed8a5641d49a86cd68bcf68290~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=qB20PHA5mShyr1LfPY1jlWEvEA0%3D" alt="Druid 计算结果" loading="lazy"/>
运行测试的SQL，一切正常！
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05def1636abe4311a9de6200dfd3f5b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=5l9yJ7wXhplXUSHXSRzxnRmZZrM%3D" alt="Druid SQL 运行结果" loading="lazy"/></p>
<h2 data-id="heading-8">查询计算</h2>
<h3 data-id="heading-9">订单总数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询订单总数</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">distinct</span> orderId) <span class="hljs-keyword">as</span> orderscount
<span class="hljs-keyword">FROM</span> druid2
</code></pre>
<p>运行结果如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef56f55e67ef40be82ebf203223660f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=5E6ugYRl1nsB4MV5IiRnFLQ82yI%3D" alt="Druid SQL 执行界面" loading="lazy"/></p>
<h3 data-id="heading-10">用户总数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询用户总数</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">distinct</span> userId) <span class="hljs-keyword">as</span> usercount
<span class="hljs-keyword">FROM</span> druid2
</code></pre>
<p>运行结果如下图：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eea20f1e6e36451dbe398ac53431449a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=EQ93CnjJAzevu2oDAaYMZpEW%2F4U%3D" alt="Druid 查询用户的总数" loading="lazy"/></p>
<h3 data-id="heading-11">统计结果状态订单数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 统计各种订单状态的订单数</span>
<span class="hljs-keyword">SELECT</span> orderStatus, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)
<span class="hljs-keyword">FROM</span> (
  <span class="hljs-keyword">SELECT</span> orderId, orderStatus
  <span class="hljs-keyword">FROM</span> druid2
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> orderId, orderStatus
)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> orderStatus
</code></pre>
<p>执行结果如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6636a79402cf4eafb0830139a326c7f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=Mp5VmRAHWx08tt%2Fi65I0ZHQDQTc%3D" alt="Druid 进行聚合的结果" loading="lazy"/></p>
<h3 data-id="heading-12">统计各种支付方式的订单数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 统计各种支付方式订单数</span>
<span class="hljs-keyword">SELECT</span> payMode, <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> (
  <span class="hljs-keyword">SELECT</span> orderId, payMode
  <span class="hljs-keyword">FROM</span> druid2
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> orderId, payMode
)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> payMode
</code></pre>
<p>执行结果如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8da696a6b254c88800c8fdd21460503~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=jIT%2FPUa2LIGB7XGE3A1vKQ%2Bp9nI%3D" alt="Druid 聚合结果" loading="lazy"/></p>
<h3 data-id="heading-13">订单金额最大的前10名</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单金额最大的前10名</span>
<span class="hljs-keyword">SELECT</span> orderId, payment, <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">as</span> productcount, <span class="hljs-built_in">sum</span>("product.productNum") <span class="hljs-keyword">as</span> products
<span class="hljs-keyword">FROM</span> druid2
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> orderId, payment
</code></pre>
<p>执行结果如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60cb3756a8244551a435aac14f9b778a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764055970&amp;x-signature=CQ4j1xSrJTzv11pmynvJLV5G90A%3D" alt="Druid 订单金额最大的前10名" loading="lazy"/></p>
<h2 data-id="heading-14">案例小节</h2>
<ul>
<li>在配置摄入源时要设置为True从流的开始进行消费数据，否则在数据源中可能查不到数据</li>
<li>Druid的JOIN能力非常有限，分组或者聚合多的场景推荐使用</li>
<li>SQL支持能力非常受限</li>
<li>数据的分区组织只有时间序列一种方式</li>
</ul>
<h2 data-id="heading-15">错误速查</h2>






































































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>Druid 表无数据/很少消费</td><td>位点从 latest 开始，历史未扫</td><td>查任务日志与 Kafka Lag；在 ingestion spec 设 useEarliestOffset: true 或等价参数，重跑任务</td></tr><tr><td>时间筛选查不到数据</td><td>ts 单位/时区不符</td><td>SELECT __time FROM ... LIMIT 10；校正 timestampSpec（格式/时区/单位），确保 ts→__time 正确</td></tr><tr><td>数值列被当作字符串</td><td>JSON 字段类型不一致</td><td>查询 EXPLAIN/样例行；在预处理统一类型；或 Druid schema 中设正确类型并加转换</td></tr><tr><td>计数结果异常</td><td>启用/误用 Rollup 或重复展开</td><td>查 ingestionSpec 与样例明细；分析关 Rollup；数组展开仅一处进行，避免重复</td></tr><tr><td>订单数与行数不等</td><td>每个 product 拆行导致重复 orderId</td><td>COUNT(DISTINCT orderId)；解释口径差异；维度口径用 distinct/order 粒度子查询</td></tr><tr><td>摄取任务卡住 PENDING</td><td>MiddleManager/Indexer 资源槽不足</td><td>Overlord UI/任务日志；扩容 task slots 或降低并发；检查 YARN/K8s 资源</td></tr><tr><td>Kafka Lag 不断升高</td><td>任务并发 &lt; 分区数 / 单条太大</td><td>Kafka 分区与任务并发对比；任务数≥分区数；调大 maxRowsInMemory/批量与压缩</td></tr><tr><td>查询超时</td><td>Segment 过碎/历史节点压力大</td><td>Broker/Historical 指标；调整 segmentGranularity、合并段、加缓存与并行度/扩容</td></tr><tr><td>时间列为空或全 1970</td><td>时间解析失败</td><td>任务日志中 timestamp 错误；修正时间格式或单位（ms/秒）；必要时预处理转标准 ISO8601</td></tr><tr><td>维度过多导致慢</td><td>高基数维度未优化</td><td>CARDINALITY 指标；为高基数维度启用索引/字典压缩；必要时下推到离线层</td></tr><tr><td>SQL 报多值聚合错误</td><td>多值列用不支持的聚合</td><td>报错堆栈；使用 array_length/UNNEST/合适聚合，或预处理成单值</td></tr><tr><td>任务频繁重启</td><td>Offsets 提交/组 ID 配置不当</td><td>Kafka 消费组日志；固定 consumerProperties 与组 ID；启用稳定的提交策略</td></tr></tbody></table>
<h2 data-id="heading-16">其他系列</h2>
<h3 data-id="heading-17">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-127 Qwen2.5-Omni 深解：Thinker-Talker 双核、TMRoPE 与流式语音</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fw776341482%2Fcategory_12794137.html" target="_blank" title="https://blog.csdn.net/w776341482/category_12794137.html" ref="nofollow noopener noreferrer">🔗 AI模块直达链接 </a></p>
<h3 data-id="heading-18">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-174 FastFDS 从单机到分布式文件存储：实战与架构取舍</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 正在更新，深入浅出助你打牢基础！
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fw776341482%2Fcategory_12833348.html" target="_blank" title="https://blog.csdn.net/w776341482/category_12833348.html" ref="nofollow noopener noreferrer">🔗 Java模块直达链接</a></p>
<h3 data-id="heading-19">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fw776341482%2Fcategory_12713819.html" target="_blank" title="https://blog.csdn.net/w776341482/category_12713819.html" ref="nofollow noopener noreferrer">🔗 大数据模块直达链接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Chrome/Firefox 浏览器扩展开发完整指南]]></title>    <link>https://juejin.cn/post/7572997791452020774</link>    <guid>https://juejin.cn/post/7572997791452020774</guid>    <pubDate>2025-11-17T03:29:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572997791452020774" data-draft-id="7571729676344033343" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chrome/Firefox 浏览器扩展开发完整指南"/> <meta itemprop="keywords" content="前端,Chrome"/> <meta itemprop="datePublished" content="2025-11-17T03:29:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="至简简"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286819384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chrome/Firefox 浏览器扩展开发完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286819384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    至简简
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T03:29:00.000Z" title="Mon Nov 17 2025 03:29:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">浏览器扩展</h2>
<p>浏览器扩展（Browser Extension）是一种可以修改和增强浏览器功能的小型软件程序。它们使用 Web 技术（HTML、CSS、JavaScript）开发，可以在用户浏览网页时提供额外功能。</p>
<h3 data-id="heading-1">典型应用场景</h3>








































<table><thead><tr><th>类型</th><th>示例</th><th>技术要点</th></tr></thead><tbody><tr><td><strong>内容增强</strong></td><td>广告拦截器（AdBlock）、语法检查（Grammarly）</td><td>Content Scripts、DOM 操作</td></tr><tr><td><strong>生产力工具</strong></td><td>密码管理器、笔记工具、截图工具</td><td>Storage API、Context Menu</td></tr><tr><td><strong>数据获取</strong></td><td>价格追踪、天气查询、新闻订阅</td><td>Fetch API、定时任务</td></tr><tr><td><strong>页面修改</strong></td><td>暗黑模式、字体替换、样式调整</td><td>CSS 注入、动态 DOM</td></tr><tr><td><strong>开发工具</strong></td><td>React DevTools、Vue DevTools</td><td>DevTools API、消息传递</td></tr><tr><td><strong>标签管理</strong></td><td>OneTab、Session Buddy</td><td>Tabs API、Bookmarks API</td></tr></tbody></table>
<h3 data-id="heading-2">扩展的优势</h3>
<ul>
<li>✅ <strong>直接访问浏览器 API</strong>：比网页应用有更强的能力</li>
<li>✅ <strong>无需服务器</strong>：可以完全离线运行</li>
<li>✅ <strong>跨页面工作</strong>：可以在所有标签页中生效</li>
<li>✅ <strong>持久化存储</strong>：使用浏览器提供的存储 API</li>
<li>✅ <strong>用户基数大</strong>：Chrome Web Store 和 Firefox Add-ons 有庞大用户群</li>
</ul>
<h2 data-id="heading-3">核心概念</h2>
<h3 data-id="heading-4">1. Manifest 文件：扩展的身份证</h3>
<p>Manifest 是扩展的核心配置文件，定义了扩展的所有信息、权限和行为。</p>
<p><strong>基础结构：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"manifest_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的扩展"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这是一个示例扩展"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"16"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-16.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"48"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-48.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"128"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-128.png"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"storage"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"activeTab"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"host_permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"https://*/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"default_popup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"popup.html"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"default_icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-32.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"default_title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"点击打开"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Manifest主要有v2和v3两种，现在以 v3 为主</p>
<p><strong>Manifest V2 vs V3 主要差异：</strong></p>



































<table><thead><tr><th>特性</th><th>Manifest V2</th><th>Manifest V3</th></tr></thead><tbody><tr><td>后台脚本</td><td><code>background.page</code> / <code>background.scripts</code></td><td><code>background.service_worker</code></td></tr><tr><td>网络请求</td><td><code>webRequest</code> API（同步阻塞）</td><td><code>declarativeNetRequest</code>（声明式）</td></tr><tr><td>代码执行</td><td><code>executeScript</code></td><td><code>scripting.executeScript</code></td></tr><tr><td>远程代码</td><td>允许</td><td>禁止（必须打包在扩展内）</td></tr><tr><td>安全性</td><td>一般</td><td>更强（CSP 更严格）</td></tr></tbody></table>
<h3 data-id="heading-5">2. 五大核心组件详解</h3>
<h4 data-id="heading-6">组件架构图</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca126b36fd614f3fb5946616794b929a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763954940&amp;x-signature=GYU%2FazDjFUfHAOAho8DxpNq7uOA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>Background Script (后台脚本):</strong>  扩展的核心，持续运行在后台，处理事件和协调其他组件</li>
<li><strong>Popup (弹窗UI):</strong>  用户点击扩展图标时显示的界面</li>
<li><strong>Content Script (内容脚本):</strong>  注入到网页中的脚本，可以访问和修改页面DOM</li>
<li><strong>Options Page (选项页面):</strong>  扩展的设置页面，用于配置选项</li>
<li><strong>Web Page DOM:</strong>  实际网页的文档对象模型，Content Script可以直接操作</li>
</ul>
<h4 data-id="heading-7">组件对比表</h4>





















































<table><thead><tr><th>组件</th><th>运行环境</th><th>生命周期</th><th>能访问 DOM</th><th>能使用 Chrome API</th><th>通信方式</th></tr></thead><tbody><tr><td><strong>Background</strong></td><td>独立上下文</td><td>长期/事件触发</td><td>❌</td><td>✅ 全部</td><td><code>runtime.sendMessage</code></td></tr><tr><td><strong>Content Script</strong></td><td>网页上下文</td><td>随页面加载</td><td>✅ 页面 DOM</td><td>⚠️ 部分</td><td><code>runtime.sendMessage</code></td></tr><tr><td><strong>Popup</strong></td><td>独立窗口</td><td>弹窗打开时</td><td>✅ 自身 DOM</td><td>✅ 全部</td><td>直接调用或消息</td></tr><tr><td><strong>Options</strong></td><td>独立页面</td><td>设置页打开时</td><td>✅ 自身 DOM</td><td>✅ 全部</td><td>直接调用或消息</td></tr><tr><td><strong>DevTools</strong></td><td>DevTools 面板</td><td>DevTools 打开时</td><td>⚠️ 通过 inspectedWindow</td><td>✅ 部分</td><td><code>runtime.connect</code></td></tr></tbody></table>
<h3 data-id="heading-8">3. 权限系统</h3>
<h4 data-id="heading-9">权限类型</h4>
<p><strong>基本权限（permissions）：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"storage"</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 使用 chrome.storage API</span>
    <span class="hljs-string">"activeTab"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 访问当前活动标签页</span>
    <span class="hljs-string">"tabs"</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 访问标签页信息（URL、标题等）</span>
    <span class="hljs-string">"notifications"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 显示系统通知</span>
    <span class="hljs-string">"alarms"</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 定时任务</span>
    <span class="hljs-string">"contextMenus"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 右键菜单</span>
    <span class="hljs-string">"cookies"</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 访问 Cookie</span>
    <span class="hljs-string">"downloads"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 管理下载</span>
    <span class="hljs-string">"bookmarks"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 管理书签</span>
    <span class="hljs-string">"history"</span>        <span class="hljs-comment">// 访问历史记录</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>主机权限（host_permissions）：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"host_permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"https://api.example.com/*"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 特定域名</span>
    <span class="hljs-string">"https://*/*"</span><span class="hljs-punctuation">,</span>                 <span class="hljs-comment">// 所有 HTTPS 网站</span>
    <span class="hljs-string">"&lt;all_urls&gt;"</span>                   <span class="hljs-comment">// 所有网站（需谨慎）</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-10">权限最小化原则</h4>
<p>⚠️ <strong>重要</strong>：只请求必要的权限，过多权限会：</p>
<ul>
<li>降低用户信任度</li>
<li>增加审核难度</li>
<li>影响商店排名</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// ❌ 不好：请求了不必要的权限</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"tabs"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"history"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"bookmarks"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"&lt;all_urls&gt;"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// ✅ 好：只请求实际使用的权限</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"storage"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"activeTab"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">项目架构与技术栈</h2>
<h3 data-id="heading-12">技术选型</h3>
<p>笔者推荐直接使用现成的开发模板 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJohnBra%2Fvite-web-extension" target="_blank" title="https://github.com/JohnBra/vite-web-extension" ref="nofollow noopener noreferrer">github.com/JohnBra/vit…</a></p>
<h2 data-id="heading-13">以 vite-web-extension 模板开发的每日金价小例子</h2>
<h3 data-id="heading-14">1. 前置要求</h3>
<ul>
<li><strong>Node.js</strong>: &gt;= 16.x（推荐 18.x 或 20.x）</li>
<li><strong>包管理器</strong>: npm / yarn / pnpm（推荐 pnpm）</li>
<li><strong>浏览器</strong>: Chrome 或 Firefox 最新版</li>
</ul>
<p>检查版本：</p>
<pre><code class="hljs language-bash" lang="bash">node --version   <span class="hljs-comment"># v20.x.x</span>
npm --version    <span class="hljs-comment"># 10.x.x</span>
</code></pre>
<h3 data-id="heading-15">2. 项目初始化</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆项目或使用模板</span>
git <span class="hljs-built_in">clone</span> https://github.com/JohnBra/vite-web-extension

<span class="hljs-comment"># 安装依赖</span>
pnpm install

<span class="hljs-comment"># 或使用 npm</span>
npm install
</code></pre>
<h3 data-id="heading-16">3. 开发模式启动</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Chrome 开发模式（默认）</span>
pnpm dev
<span class="hljs-comment"># 或</span>
pnpm dev:chrome

<span class="hljs-comment"># Firefox 开发模式</span>
pnpm dev:firefox
</code></pre>
<p><strong>开发模式特性：</strong></p>
<ul>
<li>✅ 自动监听文件变化</li>
<li>✅ 热重载（nodemon 自动重新构建）</li>
<li>✅ Source Map 支持</li>
<li>✅ 开发环境专用图标</li>
<li>✅ 详细的错误日志</li>
</ul>
<h3 data-id="heading-17">4. 加载扩展到浏览器</h3>
<h4 data-id="heading-18">Chrome / Edge</h4>
<ol>
<li>
<p>打开扩展管理页面：</p>
<ul>
<li>地址栏输入 <code>chrome://extensions</code></li>
<li>或通过菜单：更多工具 → 扩展程序</li>
</ul>
</li>
<li>
<p>开启<strong>开发者模式</strong>（右上角开关）</p>
</li>
<li>
<p>点击 <strong>"加载已解压的扩展程序"</strong></p>
</li>
<li>
<p>选择项目的 <code>dist_chrome</code> 文件夹</p>
</li>
<li>
<p>扩展加载成功，可以看到开发版图标</p>
</li>
</ol>
<p><strong>常见问题：</strong></p>
<ul>
<li>⚠️ 如果修改了 Manifest，需要点击刷新按钮</li>
<li>⚠️ Content Script 修改后，需要刷新目标网页</li>
<li>⚠️ Popup 和 Options 页面可以直接刷新</li>
</ul>
<h4 data-id="heading-19">Firefox</h4>
<ol>
<li>
<p>打开调试页面：</p>
<ul>
<li>地址栏输入 <code>about:debugging#/runtime/this-firefox</code></li>
<li>或通过菜单：附加组件和主题 → 管理扩展 → 调试附加组件</li>
</ul>
</li>
<li>
<p>点击 <strong>"临时载入附加组件"</strong></p>
</li>
<li>
<p>选择 <code>dist_firefox</code> 文件夹中的 <code>manifest.json</code> 文件</p>
</li>
<li>
<p>扩展加载成功</p>
</li>
</ol>
<p><strong>注意：</strong></p>
<ul>
<li>⚠️ Firefox 的临时扩展在浏览器关闭后会被卸载</li>
<li>⚠️ 每次重启浏览器需要重新加载</li>
</ul>
<h3 data-id="heading-20">5. 验证安装</h3>
<p>加载扩展后，验证以下功能：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 打开 Popup</span>
<span class="hljs-comment">//    点击扩展图标，应该看到黄金价格查询界面</span>

<span class="hljs-comment">// 2. 查看 Background Script 日志</span>
<span class="hljs-comment">//    在扩展管理页面，点击"service worker"或"背景页"</span>
<span class="hljs-comment">//    控制台应该显示：'background script loaded'</span>

<span class="hljs-comment">// 3. 查看 Content Script</span>
<span class="hljs-comment">//    访问任意网站，打开开发者工具</span>
<span class="hljs-comment">//    应该看到页面左下角有黄色提示："content script loaded"</span>

<span class="hljs-comment">// 4. 打开 Options 页面</span>
<span class="hljs-comment">//    右键点击扩展图标 → 选项</span>
<span class="hljs-comment">//    应该显示设置页面</span>
</code></pre>
<hr/>
<h2 data-id="heading-21">Manifest 配置详解</h2>
<h3 data-id="heading-22">完整配置文件</h3>
<p>本项目的 <code>manifest.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"manifest_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"16"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-16.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"32"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-32.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"48"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-48.png"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"128"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-128.png"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"default_popup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/pages/popup/index.html"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"default_icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"32"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-32.png"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"default_title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"查看黄金价格"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"background"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"service_worker"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/pages/background/index.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"content_scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"http://*/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"https://*/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"&lt;all_urls&gt;"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/pages/content/index.tsx"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"css"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"contentStyle.css"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"run_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"document_idle"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"storage"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"activeTab"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"host_permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"https://chatbot-be-omega.vercel.app/*"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"options_ui"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"page"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/pages/options/index.html"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"open_in_tab"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"chrome_url_overrides"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"newtab"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/pages/newtab/index.html"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"devtools_page"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/pages/devtools/index.html"</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-attr">"web_accessible_resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"contentStyle.css"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"icon-128.png"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"icon-32.png"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&lt;all_urls&gt;"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-23">字段详解</h3>
<h4 data-id="heading-24">基础信息</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"manifest_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 必须是 3（新版）</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"扩展名称"</span><span class="hljs-punctuation">,</span>            <span class="hljs-comment">// 最多 45 个字符</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 语义化版本号</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"扩展描述"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 最多 132 个字符</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"作者名"</span>            <span class="hljs-comment">// 可选</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-25">图标配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"16"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-16.png"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 扩展页面的 favicon</span>
    <span class="hljs-attr">"48"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-48.png"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 扩展管理页面</span>
    <span class="hljs-attr">"128"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-128.png"</span>     <span class="hljs-comment">// 安装和 Chrome Web Store</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>图标设计建议：</strong></p>
<ul>
<li>使用简洁、可识别的设计</li>
<li>PNG 格式，透明背景</li>
<li>不同尺寸保持一致性</li>
<li>避免文字（太小看不清）</li>
</ul>
<h4 data-id="heading-26">Action（工具栏图标）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"default_popup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"popup.html"</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 点击图标打开的页面</span>
    <span class="hljs-attr">"default_icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"16"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-16.png"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"32"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"icon-32.png"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"default_title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"鼠标悬停提示文字"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>动态修改：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 修改图标</span>
chrome.<span class="hljs-property">action</span>.<span class="hljs-title function_">setIcon</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">"new-icon.png"</span> });

<span class="hljs-comment">// 修改标题</span>
chrome.<span class="hljs-property">action</span>.<span class="hljs-title function_">setTitle</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">"新标题"</span> });

<span class="hljs-comment">// 修改徽章</span>
chrome.<span class="hljs-property">action</span>.<span class="hljs-title function_">setBadgeText</span>({ <span class="hljs-attr">text</span>: <span class="hljs-string">"99+"</span> });
chrome.<span class="hljs-property">action</span>.<span class="hljs-title function_">setBadgeBackgroundColor</span>({ <span class="hljs-attr">color</span>: <span class="hljs-string">"#FF0000"</span> });
</code></pre>
<h4 data-id="heading-27">Content Scripts 配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"content_scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"https://www.example.com/*"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 匹配模式</span>
        <span class="hljs-string">"https://*.google.com/*"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"content.js"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// JavaScript 文件</span>
      <span class="hljs-attr">"css"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"content.css"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// CSS 文件</span>
      <span class="hljs-attr">"run_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"document_idle"</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 注入时机</span>
      <span class="hljs-attr">"all_frames"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// 是否注入到 iframe</span>
      <span class="hljs-attr">"match_about_blank"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>        <span class="hljs-comment">// 是否匹配 about:blank</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>run_at 选项：</strong></p>
<ul>
<li><code>document_start</code>: DOM 构建之前（最早）</li>
<li><code>document_end</code>: DOM 构建完成后</li>
<li><code>document_idle</code>: 页面空闲时（默认，推荐）</li>
</ul>
<h4 data-id="heading-28">Web Accessible Resources</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"web_accessible_resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"images/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"styles.css"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"https://example.com/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>用途：</strong> 允许网页访问扩展内的资源文件</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 Content Script 中使用扩展资源</span>
<span class="hljs-keyword">const</span> imageUrl = chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">getURL</span>(<span class="hljs-string">'images/logo.png'</span>);
<span class="hljs-keyword">const</span> img = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'img'</span>);
img.<span class="hljs-property">src</span> = imageUrl;
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(img);
</code></pre>
<hr/>
<h2 data-id="heading-29">核心组件开发实践</h2>
<h3 data-id="heading-30">1. Background Script（后台脚本）</h3>
<p>Background Script 是扩展的"大脑"，负责处理事件、管理状态、协调各组件。</p>
<h4 data-id="heading-31">Manifest V3 的变化</h4>
<p>在 Manifest V3 中，Background Page 被 <strong>Service Worker</strong> 取代：</p>






























<table><thead><tr><th>特性</th><th>Background Page (V2)</th><th>Service Worker (V3)</th></tr></thead><tbody><tr><td>生命周期</td><td>持续运行</td><td>事件驱动，空闲时休眠</td></tr><tr><td>DOM 访问</td><td>有 DOM</td><td>无 DOM</td></tr><tr><td>定时器</td><td>setTimeout/setInterval</td><td>chrome.alarms API</td></tr><tr><td>存储</td><td>变量持久化</td><td>需要使用 chrome.storage</td></tr></tbody></table>
<h4 data-id="heading-32">基础示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/background/index.ts</span>

<span class="hljs-comment">// 监听扩展安装或更新</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onInstalled</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">details</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (details.<span class="hljs-property">reason</span> === <span class="hljs-string">'install'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'扩展首次安装'</span>);
    <span class="hljs-comment">// 初始化默认设置</span>
    chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>({
      <span class="hljs-attr">settings</span>: {
        <span class="hljs-attr">refreshInterval</span>: <span class="hljs-number">30</span>,
        <span class="hljs-attr">notifications</span>: <span class="hljs-literal">true</span>
      }
    });
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (details.<span class="hljs-property">reason</span> === <span class="hljs-string">'update'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'扩展已更新到'</span>, chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">getManifest</span>().<span class="hljs-property">version</span>);
  }
});

<span class="hljs-comment">// 监听来自其他组件的消息</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">message, sender, sendResponse</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息:'</span>, message);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'来自:'</span>, sender.<span class="hljs-property">tab</span> ? <span class="hljs-string">`标签页 <span class="hljs-subst">${sender.tab.id}</span>`</span> : <span class="hljs-string">'扩展页面'</span>);
  
  <span class="hljs-keyword">if</span> (message.<span class="hljs-property">action</span> === <span class="hljs-string">'getGoldPrice'</span>) {
    <span class="hljs-comment">// 异步处理</span>
    <span class="hljs-title function_">fetchGoldPrice</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
      <span class="hljs-title function_">sendResponse</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, data });
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-title function_">sendResponse</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> });
    });
    
    <span class="hljs-comment">// 返回 true 表示异步响应</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-keyword">if</span> (message.<span class="hljs-property">action</span> === <span class="hljs-string">'openOptionsPage'</span>) {
    chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">openOptionsPage</span>();
  }
});

<span class="hljs-comment">// 监听标签页更新</span>
chrome.<span class="hljs-property">tabs</span>.<span class="hljs-property">onUpdated</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">tabId, changeInfo, tab</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (changeInfo.<span class="hljs-property">status</span> === <span class="hljs-string">'complete'</span> &amp;&amp; tab.<span class="hljs-property">url</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面加载完成:'</span>, tab.<span class="hljs-property">url</span>);
    <span class="hljs-comment">// 可以在这里注入 Content Script 或执行其他操作</span>
  }
});

<span class="hljs-comment">// 使用 Alarms API 实现定时任务</span>
chrome.<span class="hljs-property">alarms</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'fetchGoldPrice'</span>, {
  <span class="hljs-attr">periodInMinutes</span>: <span class="hljs-number">30</span>  <span class="hljs-comment">// 每 30 分钟执行一次</span>
});

chrome.<span class="hljs-property">alarms</span>.<span class="hljs-property">onAlarm</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">alarm</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (alarm.<span class="hljs-property">name</span> === <span class="hljs-string">'fetchGoldPrice'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时获取黄金价格'</span>);
    <span class="hljs-title function_">fetchGoldPrice</span>();
  }
});

<span class="hljs-comment">// 数据获取函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchGoldPrice</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/gold-price'</span>);
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    
    <span class="hljs-comment">// 保存到 storage</span>
    <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>({ <span class="hljs-attr">goldPrice</span>: data });
    
    <span class="hljs-comment">// 更新徽章</span>
    chrome.<span class="hljs-property">action</span>.<span class="hljs-title function_">setBadgeText</span>({ 
      <span class="hljs-attr">text</span>: data.<span class="hljs-property">price</span>.<span class="hljs-title function_">toString</span>() 
    });
    
    <span class="hljs-keyword">return</span> data;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取数据失败:'</span>, error);
    <span class="hljs-keyword">throw</span> error;
  }
}
</code></pre>
<h4 data-id="heading-33">高级用法：长连接</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Background Script</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onConnect</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">port</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'建立连接:'</span>, port.<span class="hljs-property">name</span>);
  
  port.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息:'</span>, message);
    <span class="hljs-comment">// 处理消息</span>
    port.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">response</span>: <span class="hljs-string">'processed'</span> });
  });
  
  port.<span class="hljs-property">onDisconnect</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接断开'</span>);
  });
});

<span class="hljs-comment">// Popup 或 Content Script</span>
<span class="hljs-keyword">const</span> port = chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">connect</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'my-channel'</span> });
port.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">action</span>: <span class="hljs-string">'subscribe'</span> });
port.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到推送:'</span>, message);
});
</code></pre>
<h3 data-id="heading-34">2. Content Script（内容脚本）</h3>
<p>Content Script 运行在网页上下文中，可以读取和修改页面 DOM，但有独立的 JavaScript 运行环境。</p>
<h4 data-id="heading-35">特性与限制</h4>
<p><strong>可以做：</strong></p>
<ul>
<li>✅ 访问和修改页面 DOM</li>
<li>✅ 监听页面事件</li>
<li>✅ 使用部分 Chrome API（runtime、storage、i18n 等）</li>
<li>✅ 与 Background Script 通信</li>
</ul>
<p><strong>不能做：</strong></p>
<ul>
<li>❌ 访问页面的 JavaScript 变量和函数</li>
<li>❌ 使用大部分 Chrome API（tabs、windows、bookmarks 等）</li>
<li>❌ 跨域请求（需要通过 Background）</li>
</ul>
<h4 data-id="heading-36">React 集成示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/content/index.tsx</span>
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>;

<span class="hljs-comment">// 创建容器</span>
<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
container.<span class="hljs-property">id</span> = <span class="hljs-string">'gold-price-extension-root'</span>;
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container);

<span class="hljs-comment">// React 组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">GoldPriceWidget</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [price, setPrice] = useState&lt;<span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [visible, setVisible] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 从 storage 获取价格</span>
    chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>([<span class="hljs-string">'goldPrice'</span>], <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">goldPrice</span>) {
        <span class="hljs-title function_">setPrice</span>(result.<span class="hljs-property">goldPrice</span>.<span class="hljs-property">price</span>);
      }
    });
    
    <span class="hljs-comment">// 监听 storage 变化</span>
    chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">onChanged</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">changes</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (changes.<span class="hljs-property">goldPrice</span>) {
        <span class="hljs-title function_">setPrice</span>(changes.<span class="hljs-property">goldPrice</span>.<span class="hljs-property">newValue</span>.<span class="hljs-property">price</span>);
      }
    });
  }, []);
  
  <span class="hljs-keyword">if</span> (!visible) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
        <span class="hljs-attr">className</span>=<span class="hljs-string">"gold-price-toggle"</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setVisible(true)}
      &gt;
        💰
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    );
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"gold-price-widget"</span>&gt;</span>
                // 。。。
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 渲染</span>
<span class="hljs-keyword">const</span> root = <span class="hljs-title function_">createRoot</span>(container);
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">GoldPriceWidget</span> /&gt;</span></span>);

<span class="hljs-comment">// 监听页面 DOM 变化</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations</span>) =&gt;</span> {
  mutations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">mutation</span>) =&gt;</span> {
    <span class="hljs-comment">// 检测特定元素并进行处理</span>
    <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'childList'</span>) {
      <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.target-class'</span>);
      <span class="hljs-keyword">if</span> (targetElement) {
        <span class="hljs-comment">// 在目标元素上添加功能</span>
        <span class="hljs-title function_">addCustomFeature</span>(targetElement);
      }
    }
  });
});

observer.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, {
  <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>
});

<span class="hljs-comment">// 自定义功能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addCustomFeature</span>(<span class="hljs-params">element: Element</span>) {
  <span class="hljs-keyword">const</span> button = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
  button.<span class="hljs-property">textContent</span> = <span class="hljs-string">'查看金价'</span>;
  button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>({ <span class="hljs-attr">action</span>: <span class="hljs-string">'openPopup'</span> });
  });
  element.<span class="hljs-title function_">appendChild</span>(button);
}
</code></pre>
<h4 data-id="heading-37">CSS 隔离</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* src/pages/content/style.css */</span>

<span class="hljs-comment">/* 使用唯一的类名前缀，避免与页面样式冲突 */</span>
<span class="hljs-selector-class">.gold-price-extension-root</span> {
  <span class="hljs-attribute">all</span>: initial; <span class="hljs-comment">/* 重置所有样式 */</span>
  <span class="hljs-attribute">font-family</span>: -apple-system, BlinkMacSystemFont, <span class="hljs-string">'Segoe UI'</span>, sans-serif;
}

<span class="hljs-selector-class">.gold-price-widget</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>);
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">999999</span>; <span class="hljs-comment">/* 确保在最上层 */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
}

<span class="hljs-comment">/* 使用 CSS-in-JS 也是不错的选择 */</span>
</code></pre>
<h4 data-id="heading-38">与页面脚本通信</h4>
<p>Content Script 和页面脚本运行在不同的上下文中，需要通过 <code>window.postMessage</code> 通信：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Content Script → 页面</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">postMessage</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'FROM_EXTENSION'</span>,
  <span class="hljs-attr">action</span>: <span class="hljs-string">'getData'</span>
}, <span class="hljs-string">'*'</span>);

<span class="hljs-comment">// 页面 → Content Script</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">source</span> !== <span class="hljs-variable language_">window</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'FROM_PAGE'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'来自页面的消息:'</span>, event.<span class="hljs-property">data</span>);
    
    <span class="hljs-comment">// 转发到 Background</span>
    chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>(event.<span class="hljs-property">data</span>);
  }
});
</code></pre>
<h3 data-id="heading-39">3. Popup（弹窗页面）</h3>
<p>Popup 是用户与扩展交互的主要界面，点击工具栏图标时弹出。</p>
<h4 data-id="heading-40">特点</h4>
<ul>
<li>⏱️ <strong>临时性</strong>：关闭后页面和状态会被销毁</li>
<li>📏 <strong>尺寸限制</strong>：最小 25x25px，最大 800x600px</li>
<li>⚡ <strong>快速加载</strong>：应该在 1 秒内完成初始化</li>
</ul>
<h4 data-id="heading-41">完整示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/popup/Popup.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GoldPriceData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./types"</span>;
<span class="hljs-keyword">import</span> { fetchGoldPriceData, refreshGoldPriceData } <span class="hljs-keyword">from</span> <span class="hljs-string">"./services/goldPriceService"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JewelryCard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/JewelryCard"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BankCard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/BankCard"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoadingSpinner</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/LoadingSpinner"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Popup</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = useState&lt;<span class="hljs-title class_">GoldPriceData</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [refreshing, setRefreshing] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [activeTab, setActiveTab] = useState&lt;<span class="hljs-string">"jewelry"</span> | <span class="hljs-string">"bank"</span>&gt;(<span class="hljs-string">"jewelry"</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">loadData</span>();
  }, []);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">const</span> goldData = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchGoldPriceData</span>();
      <span class="hljs-title function_">setData</span>(goldData);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"加载数据失败:"</span>, error);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRefresh</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">setRefreshing</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">const</span> goldData = <span class="hljs-keyword">await</span> <span class="hljs-title function_">refreshGoldPriceData</span>();
      <span class="hljs-title function_">setData</span>(goldData);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"刷新数据失败:"</span>, error);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setRefreshing</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-keyword">if</span> (loading) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[400px] h-[600px] flex items-center justify-center"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">LoadingSpinner</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[400px] h-[600px] bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 flex flex-col"</span>&gt;</span>
      {/* 头部 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-white/60 backdrop-blur-md shadow-sm px-4 py-3 flex items-center justify-between"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-base font-semibold"</span>&gt;</span>每日金价<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleRefresh}</span>
          <span class="hljs-attr">disabled</span>=<span class="hljs-string">{refreshing}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"p-1.5 rounded-full hover:bg-amber-100/50 transition-colors"</span>
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">RefreshIcon</span> <span class="hljs-attr">spinning</span>=<span class="hljs-string">{refreshing}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

      {/* 标签切换 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex border-b border-amber-100"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setActiveTab("jewelry")}
          className={`flex-1 py-2.5 text-sm ${
            activeTab === "jewelry" ? "text-amber-600" : "text-gray-500"
          }`}
        &gt;
          金饰品
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setActiveTab("bank")}
          className={`flex-1 py-2.5 text-sm ${
            activeTab === "bank" ? "text-amber-600" : "text-gray-500"
          }`}
        &gt;
          银行金条
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 内容区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 overflow-y-auto p-3"</span>&gt;</span>
        {activeTab === "jewelry" ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"grid grid-cols-2 gap-2"</span>&gt;</span>
            {data?.jewelryBrands.map((brand) =&gt; (
              <span class="hljs-tag">&lt;<span class="hljs-name">JewelryCard</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{brand.id}</span> <span class="hljs-attr">brand</span>=<span class="hljs-string">{brand}</span> /&gt;</span>
            ))}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col gap-2"</span>&gt;</span>
            {data?.bankGoldBars.map((bank) =&gt; (
              <span class="hljs-tag">&lt;<span class="hljs-name">BankCard</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{bank.id}</span> <span class="hljs-attr">bank</span>=<span class="hljs-string">{bank}</span> /&gt;</span>
            ))}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 底部信息 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"px-4 py-2 text-center"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs text-gray-500"</span>&gt;</span>更新时间: {data?.lastUpdate}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>Popup 设计原则：</strong></p>
<ul>
<li>🎯 <strong>单一目标</strong>：每个 Popup 应该有明确的用途</li>
<li>⚡ <strong>快速响应</strong>：优先显示缓存数据，后台刷新</li>
<li>📱 <strong>简洁 UI</strong>：空间有限，避免复杂交互</li>
<li>💾 <strong>状态管理</strong>：使用 <code>chrome.storage</code> 持久化重要状态</li>
</ul>
<hr/>
<h2 data-id="heading-42">组件间通信机制</h2>
<p>浏览器扩展的各个组件之间需要频繁通信，Chrome 提供了多种通信方式。</p>
<h3 data-id="heading-43">1. 一次性消息传递</h3>
<p><strong>适用场景：</strong> 简单的请求-响应模式</p>
<h4 data-id="heading-44">Content Script → Background</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Content Script</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>(
  { <span class="hljs-attr">action</span>: <span class="hljs-string">'getPrice'</span>, <span class="hljs-attr">item</span>: <span class="hljs-string">'gold'</span> },
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">success</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'价格:'</span>, response.<span class="hljs-property">data</span>);
    }
  }
);

<span class="hljs-comment">// Background Script</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">request, sender, sendResponse</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">action</span> === <span class="hljs-string">'getPrice'</span>) {
    <span class="hljs-title function_">fetchPrice</span>(request.<span class="hljs-property">item</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">price</span> =&gt;</span> {
      <span class="hljs-title function_">sendResponse</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: price });
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-title function_">sendResponse</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> });
    });
    
    <span class="hljs-comment">// 必须返回 true 表示异步响应</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
});
</code></pre>
<h4 data-id="heading-45">Popup → Background</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Popup</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>({
  <span class="hljs-attr">action</span>: <span class="hljs-string">'getData'</span>
});

<span class="hljs-comment">// 或者使用 callback</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>(
  { <span class="hljs-attr">action</span>: <span class="hljs-string">'getData'</span> },
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response);
  }
);
</code></pre>
<h4 data-id="heading-46">Background → Content Script</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Background: 向特定标签页发送消息</span>
chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">sendMessage</span>(
  tabId,
  { <span class="hljs-attr">action</span>: <span class="hljs-string">'updatePrice'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">520</span> },
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Content Script 响应:'</span>, response);
  }
);

<span class="hljs-comment">// Background: 向所有标签页广播</span>
chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">query</span>({}, <span class="hljs-function">(<span class="hljs-params">tabs</span>) =&gt;</span> {
  tabs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">tab</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (tab.<span class="hljs-property">id</span>) {
      chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">sendMessage</span>(tab.<span class="hljs-property">id</span>, { <span class="hljs-attr">action</span>: <span class="hljs-string">'refresh'</span> });
    }
  });
});

<span class="hljs-comment">// Content Script: 监听消息</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">request, sender, sendResponse</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">action</span> === <span class="hljs-string">'updatePrice'</span>) {
    <span class="hljs-title function_">updatePriceDisplay</span>(request.<span class="hljs-property">price</span>);
    <span class="hljs-title function_">sendResponse</span>({ <span class="hljs-attr">updated</span>: <span class="hljs-literal">true</span> });
  }
});
</code></pre>
<h3 data-id="heading-47">2. 长连接（Long-lived Connections）</h3>
<p><strong>适用场景：</strong> 需要持续通信、实时推送数据</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Content Script: 建立连接</span>
<span class="hljs-keyword">const</span> port = chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">connect</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'price-updates'</span> });

<span class="hljs-comment">// 发送消息</span>
port.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">action</span>: <span class="hljs-string">'subscribe'</span>, <span class="hljs-attr">symbol</span>: <span class="hljs-string">'GOLD'</span> });

<span class="hljs-comment">// 接收消息</span>
port.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到更新:'</span>, message);
  <span class="hljs-title function_">updateUI</span>(message.<span class="hljs-property">price</span>);
});

<span class="hljs-comment">// 监听断开</span>
port.<span class="hljs-property">onDisconnect</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接已断开'</span>);
});

<span class="hljs-comment">// Background Script: 监听连接</span>
<span class="hljs-keyword">const</span> connections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onConnect</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">port</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'新连接:'</span>, port.<span class="hljs-property">name</span>);
  
  connections.<span class="hljs-title function_">set</span>(port.<span class="hljs-property">name</span>, port);
  
  port.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (message.<span class="hljs-property">action</span> === <span class="hljs-string">'subscribe'</span>) {
      <span class="hljs-comment">// 开始推送数据</span>
      <span class="hljs-title function_">startPriceUpdates</span>(port, message.<span class="hljs-property">symbol</span>);
    }
  });
  
  port.<span class="hljs-property">onDisconnect</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">() =&gt;</span> {
    connections.<span class="hljs-title function_">delete</span>(port.<span class="hljs-property">name</span>);
  });
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">startPriceUpdates</span>(<span class="hljs-params">port, <span class="hljs-built_in">symbol</span></span>) {
  <span class="hljs-keyword">const</span> intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetchPrice</span>(<span class="hljs-built_in">symbol</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">price</span> =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        port.<span class="hljs-title function_">postMessage</span>({ price, <span class="hljs-built_in">symbol</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() });
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-comment">// 端口已断开</span>
        <span class="hljs-built_in">clearInterval</span>(intervalId);
      }
    });
  }, <span class="hljs-number">5000</span>);
}
</code></pre>
<h3 data-id="heading-48">3. Storage 变化监听</h3>
<p><strong>适用场景：</strong> 多个组件共享状态</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 任意组件：设置数据</span>
chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>({ <span class="hljs-attr">goldPrice</span>: <span class="hljs-number">520</span> });

<span class="hljs-comment">// 任意组件：监听变化</span>
chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">onChanged</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">changes, areaName</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (areaName === <span class="hljs-string">'local'</span> &amp;&amp; changes.<span class="hljs-property">goldPrice</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'价格更新:'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'  旧值:'</span>, changes.<span class="hljs-property">goldPrice</span>.<span class="hljs-property">oldValue</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'  新值:'</span>, changes.<span class="hljs-property">goldPrice</span>.<span class="hljs-property">newValue</span>);
    
    <span class="hljs-comment">// 更新 UI</span>
    <span class="hljs-title function_">updatePriceDisplay</span>(changes.<span class="hljs-property">goldPrice</span>.<span class="hljs-property">newValue</span>);
  }
});
</code></pre>
<h3 data-id="heading-49">4. 消息传递最佳实践</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义消息类型（TypeScript）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Message</span> {
  <span class="hljs-attr">action</span>: <span class="hljs-built_in">string</span>;
  data?: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Response</span> {
  <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>;
  data?: <span class="hljs-built_in">any</span>;
  error?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 封装消息发送</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">message: Message</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>(message, <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">lastError</span>) {
        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">lastError</span>.<span class="hljs-property">message</span>));
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">resolve</span>(response);
      }
    });
  });
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendMessage</span>({
    <span class="hljs-attr">action</span>: <span class="hljs-string">'getPrice'</span>,
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">symbol</span>: <span class="hljs-string">'GOLD'</span> }
  });
  
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">success</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">data</span>);
  }
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'通信失败:'</span>, error);
}
</code></pre>
<hr/>
<h2 data-id="heading-50">数据存储方案</h2>
<h3 data-id="heading-51">1. chrome.storage API</h3>
<p>Chrome Extension 提供了专门的存储 API，比 <code>localStorage</code> 更强大。</p>
<h4 data-id="heading-52">存储类型对比</h4>





























<table><thead><tr><th>存储类型</th><th>容量</th><th>同步</th><th>用途</th></tr></thead><tbody><tr><td><code>storage.local</code></td><td>10 MB</td><td>❌</td><td>本地数据缓存</td></tr><tr><td><code>storage.sync</code></td><td>100 KB</td><td>✅</td><td>用户设置（跨设备同步）</td></tr><tr><td><code>storage.session</code></td><td>10 MB</td><td>❌</td><td>临时会话数据（MV3）</td></tr></tbody></table>
<h4 data-id="heading-53">基础用法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 保存数据</span>
<span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>({
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> },
  <span class="hljs-attr">settings</span>: { <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span> },
  <span class="hljs-attr">prices</span>: [<span class="hljs-number">520</span>, <span class="hljs-number">530</span>, <span class="hljs-number">525</span>]
});

<span class="hljs-comment">// 读取数据</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>([<span class="hljs-string">'user'</span>, <span class="hljs-string">'settings'</span>]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">user</span>);      <span class="hljs-comment">// { name: 'John', age: 30 }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">settings</span>);  <span class="hljs-comment">// { theme: 'dark' }</span>

<span class="hljs-comment">// 读取所有数据</span>
<span class="hljs-keyword">const</span> allData = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// 删除数据</span>
<span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">remove</span>([<span class="hljs-string">'user'</span>]);

<span class="hljs-comment">// 清空所有数据</span>
<span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">clear</span>();

<span class="hljs-comment">// 获取存储使用量</span>
<span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">getBytesInUse</span>([<span class="hljs-string">'prices'</span>]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`使用了 <span class="hljs-subst">${bytes}</span> 字节`</span>);
</code></pre>
<h4 data-id="heading-54">封装 Storage 工具类</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/storage.ts</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StorageManager</span> {
  <span class="hljs-keyword">async</span> get&lt;T&gt;(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;T | <span class="hljs-literal">null</span>&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>(key);
    <span class="hljs-keyword">return</span> result[key] ?? <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">async</span> set&lt;T&gt;(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">value</span>: T): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>({ [key]: value });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">remove</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">remove</span>(key);
  }

  <span class="hljs-keyword">async</span> getMultiple&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;(
    <span class="hljs-attr">keys</span>: <span class="hljs-built_in">string</span>[]
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Partial</span>&lt;T&gt;&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>(keys);
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">setMultiple</span>(<span class="hljs-attr">items</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>(items);
  }

  <span class="hljs-title function_">onChange</span>(<span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">changes: <span class="hljs-built_in">any</span>, areaName: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-built_in">void</span> {
    chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">onChanged</span>.<span class="hljs-title function_">addListener</span>(callback);
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StorageManager</span>();

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">import</span> { storage } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/storage'</span>;

<span class="hljs-comment">// 保存</span>
<span class="hljs-keyword">await</span> storage.<span class="hljs-title function_">set</span>(<span class="hljs-string">'goldPrice'</span>, { <span class="hljs-attr">price</span>: <span class="hljs-number">520</span>, <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() });

<span class="hljs-comment">// 读取</span>
<span class="hljs-keyword">const</span> goldPrice = <span class="hljs-keyword">await</span> storage.<span class="hljs-property">get</span>&lt;{ <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">number</span> }&gt;(<span class="hljs-string">'goldPrice'</span>);

<span class="hljs-comment">// 监听变化</span>
storage.<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">changes, areaName</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (changes.<span class="hljs-property">goldPrice</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'价格更新:'</span>, changes.<span class="hljs-property">goldPrice</span>.<span class="hljs-property">newValue</span>);
  }
});
</code></pre>
<h3 data-id="heading-55">2. IndexedDB（大量数据）</h3>
<p>对于需要存储大量结构化数据的场景，可以使用 IndexedDB。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/indexedDB.ts</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GoldPriceDB</span> {
  <span class="hljs-keyword">private</span> dbName = <span class="hljs-string">'GoldPriceExtension'</span>;
  <span class="hljs-keyword">private</span> version = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">db</span>: <span class="hljs-title class_">IDBDatabase</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> request = indexedDB.<span class="hljs-title function_">open</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dbName</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">version</span>);

      request.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(request.<span class="hljs-property">error</span>);
      request.<span class="hljs-property">onsuccess</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span> = request.<span class="hljs-property">result</span>;
        <span class="hljs-title function_">resolve</span>();
      };

      request.<span class="hljs-property">onupgradeneeded</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> db = (event.<span class="hljs-property">target</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">IDBOpenDBRequest</span>).<span class="hljs-property">result</span>;
        
        <span class="hljs-comment">// 创建对象存储</span>
        <span class="hljs-keyword">if</span> (!db.<span class="hljs-property">objectStoreNames</span>.<span class="hljs-title function_">contains</span>(<span class="hljs-string">'prices'</span>)) {
          <span class="hljs-keyword">const</span> store = db.<span class="hljs-title function_">createObjectStore</span>(<span class="hljs-string">'prices'</span>, {
            <span class="hljs-attr">keyPath</span>: <span class="hljs-string">'id'</span>,
            <span class="hljs-attr">autoIncrement</span>: <span class="hljs-literal">true</span>
          });
          
          <span class="hljs-comment">// 创建索引</span>
          store.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">'timestamp'</span>, <span class="hljs-string">'timestamp'</span>, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
          store.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">'brand'</span>, <span class="hljs-string">'brand'</span>, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> });
        }
      };
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">addPrice</span>(<span class="hljs-attr">price</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
    <span class="hljs-keyword">const</span> transaction = <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>!.<span class="hljs-title function_">transaction</span>([<span class="hljs-string">'prices'</span>], <span class="hljs-string">'readwrite'</span>);
    <span class="hljs-keyword">const</span> store = transaction.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">'prices'</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> request = store.<span class="hljs-title function_">add</span>(price);
      request.<span class="hljs-property">onsuccess</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(request.<span class="hljs-property">result</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>);
      request.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(request.<span class="hljs-property">error</span>);
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getPrices</span>(limit = <span class="hljs-number">100</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>[]&gt; {
    <span class="hljs-keyword">const</span> transaction = <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>!.<span class="hljs-title function_">transaction</span>([<span class="hljs-string">'prices'</span>], <span class="hljs-string">'readonly'</span>);
    <span class="hljs-keyword">const</span> store = transaction.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">'prices'</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> request = store.<span class="hljs-title function_">getAll</span>(<span class="hljs-literal">undefined</span>, limit);
      request.<span class="hljs-property">onsuccess</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(request.<span class="hljs-property">result</span>);
      request.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(request.<span class="hljs-property">error</span>);
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getPricesByBrand</span>(<span class="hljs-attr">brand</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>[]&gt; {
    <span class="hljs-keyword">const</span> transaction = <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>!.<span class="hljs-title function_">transaction</span>([<span class="hljs-string">'prices'</span>], <span class="hljs-string">'readonly'</span>);
    <span class="hljs-keyword">const</span> store = transaction.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">'prices'</span>);
    <span class="hljs-keyword">const</span> index = store.<span class="hljs-title function_">index</span>(<span class="hljs-string">'brand'</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> request = index.<span class="hljs-title function_">getAll</span>(brand);
      request.<span class="hljs-property">onsuccess</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(request.<span class="hljs-property">result</span>);
      request.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(request.<span class="hljs-property">error</span>);
    });
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> goldPriceDB = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GoldPriceDB</span>();

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">await</span> goldPriceDB.<span class="hljs-title function_">init</span>();
<span class="hljs-keyword">await</span> goldPriceDB.<span class="hljs-title function_">addPrice</span>({
  <span class="hljs-attr">brand</span>: <span class="hljs-string">'周大福'</span>,
  <span class="hljs-attr">price</span>: <span class="hljs-number">520</span>,
  <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
});

<span class="hljs-keyword">const</span> prices = <span class="hljs-keyword">await</span> goldPriceDB.<span class="hljs-title function_">getPricesByBrand</span>(<span class="hljs-string">'周大福'</span>);
</code></pre>
<hr/>
<h2 data-id="heading-56">实战案例：黄金价格查询扩展</h2>
<p>让我们深入分析本项目的完整实现。</p>
<h3 data-id="heading-57">1. 项目架构</h3>
<pre><code class="hljs">数据流向：
API → Service Layer → Storage → UI Components
 ↓         ↓             ↓          ↓
外部数据  业务逻辑     缓存层    用户界面
</code></pre>
<h3 data-id="heading-58">2. 类型定义系统</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/popup/types.ts</span>

<span class="hljs-comment">/** 金饰品品牌价格 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">JewelryBrand</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;        <span class="hljs-comment">// 品牌名称</span>
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;       <span class="hljs-comment">// 价格（元/克）</span>
  <span class="hljs-attr">change</span>: <span class="hljs-built_in">number</span>;      <span class="hljs-comment">// 涨跌幅度（元）</span>
  <span class="hljs-attr">updateTime</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 更新时间</span>
}

<span class="hljs-comment">/** 银行金条价格 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BankGoldBar</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">bankName</span>: <span class="hljs-built_in">string</span>;    <span class="hljs-comment">// 银行名称</span>
  <span class="hljs-attr">buyPrice</span>: <span class="hljs-built_in">number</span>;    <span class="hljs-comment">// 买入价（元/克）</span>
  <span class="hljs-attr">sellPrice</span>: <span class="hljs-built_in">number</span>;   <span class="hljs-comment">// 卖出价（元/克）</span>
  <span class="hljs-attr">change</span>: <span class="hljs-built_in">number</span>;      <span class="hljs-comment">// 涨跌幅度（元）</span>
  <span class="hljs-attr">updateTime</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 更新时间</span>
}

<span class="hljs-comment">/** 黄金价格数据 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GoldPriceData</span> {
  <span class="hljs-attr">jewelryBrands</span>: <span class="hljs-title class_">JewelryBrand</span>[];
  <span class="hljs-attr">bankGoldBars</span>: <span class="hljs-title class_">BankGoldBar</span>[];
  <span class="hljs-attr">lastUpdate</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">/** API 响应类型 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BrandPriceData</span> {
  <span class="hljs-attr">brand</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">goldPrice</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">platinumPrice</span>: <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PriceResponse</span> {
  <span class="hljs-attr">status</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">data</span>: <span class="hljs-title class_">BrandPriceData</span>[];
}
</code></pre>
<h3 data-id="heading-59">3. Service Layer实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/popup/services/goldPriceService.ts</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_URL</span> = <span class="hljs-string">"https://chatbot-be-omega.vercel.app/api/goldPrice"</span>;

<span class="hljs-comment">// 定义品牌分类</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">JEWELRY_BRANDS</span> = [
  <span class="hljs-string">"周大福"</span>, <span class="hljs-string">"老凤祥"</span>, <span class="hljs-string">"周六福"</span>, <span class="hljs-string">"周生生"</span>, 
  <span class="hljs-string">"六福珠宝"</span>, <span class="hljs-string">"老庙"</span>, <span class="hljs-string">"金至尊"</span>, <span class="hljs-string">"菜百"</span>
  <span class="hljs-comment">// ... 更多品牌</span>
];

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BANK_BRANDS</span> = [<span class="hljs-string">"中国黄金"</span>, <span class="hljs-string">"高赛尔"</span>];

<span class="hljs-comment">/**
 * 从 API 获取黄金价格数据
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> fetchGoldPriceFromAPI = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">PriceResponse</span>&gt; =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-variable constant_">API_URL</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">"GET"</span>,
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> },
    });

    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`API 请求失败: <span class="hljs-subst">${response.status}</span>`</span>);
    }

    <span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">PriceResponse</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();

    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">status</span> !== <span class="hljs-string">"ok"</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"API 返回状态异常"</span>);
    }

    <span class="hljs-keyword">return</span> data;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"获取黄金价格失败:"</span>, error);
    <span class="hljs-keyword">throw</span> error;
  }
};

<span class="hljs-comment">/**
 * 将 API 数据转换为应用格式
 */</span>
<span class="hljs-keyword">const</span> transformAPIData = (<span class="hljs-attr">apiResponse</span>: <span class="hljs-title class_">PriceResponse</span>): <span class="hljs-function"><span class="hljs-params">GoldPriceData</span> =&gt;</span> {
  <span class="hljs-comment">// 转换金饰品数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">jewelryBrands</span>: <span class="hljs-title class_">JewelryBrand</span>[] = apiResponse.<span class="hljs-property">data</span>
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-variable constant_">JEWELRY_BRANDS</span>.<span class="hljs-title function_">includes</span>(item.<span class="hljs-property">brand</span>))
    .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> ({
      <span class="hljs-attr">id</span>: <span class="hljs-string">`jewelry-<span class="hljs-subst">${index}</span>`</span>,
      <span class="hljs-attr">name</span>: item.<span class="hljs-property">brand</span>,
      <span class="hljs-attr">price</span>: item.<span class="hljs-property">goldPrice</span>,
      <span class="hljs-attr">change</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">updateTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(apiResponse.<span class="hljs-property">timestamp</span>).<span class="hljs-title function_">toLocaleString</span>(<span class="hljs-string">"zh-CN"</span>, {
        <span class="hljs-attr">month</span>: <span class="hljs-string">"2-digit"</span>,
        <span class="hljs-attr">day</span>: <span class="hljs-string">"2-digit"</span>,
        <span class="hljs-attr">hour</span>: <span class="hljs-string">"2-digit"</span>,
        <span class="hljs-attr">minute</span>: <span class="hljs-string">"2-digit"</span>,
      }),
    }));

  <span class="hljs-comment">// 转换银行金条数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">bankGoldBars</span>: <span class="hljs-title class_">BankGoldBar</span>[] = apiResponse.<span class="hljs-property">data</span>
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-variable constant_">BANK_BRANDS</span>.<span class="hljs-title function_">includes</span>(item.<span class="hljs-property">brand</span>))
    .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> ({
      <span class="hljs-attr">id</span>: <span class="hljs-string">`bank-<span class="hljs-subst">${index}</span>`</span>,
      <span class="hljs-attr">bankName</span>: item.<span class="hljs-property">brand</span>,
      <span class="hljs-attr">buyPrice</span>: item.<span class="hljs-property">goldPrice</span>,
      <span class="hljs-attr">sellPrice</span>: <span class="hljs-keyword">typeof</span> item.<span class="hljs-property">platinumPrice</span> === <span class="hljs-string">"number"</span> 
        ? item.<span class="hljs-property">platinumPrice</span> 
        : item.<span class="hljs-property">goldPrice</span>,
      <span class="hljs-attr">change</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">updateTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(apiResponse.<span class="hljs-property">timestamp</span>).<span class="hljs-title function_">toLocaleString</span>(<span class="hljs-string">"zh-CN"</span>, {
        <span class="hljs-attr">month</span>: <span class="hljs-string">"2-digit"</span>,
        <span class="hljs-attr">day</span>: <span class="hljs-string">"2-digit"</span>,
        <span class="hljs-attr">hour</span>: <span class="hljs-string">"2-digit"</span>,
        <span class="hljs-attr">minute</span>: <span class="hljs-string">"2-digit"</span>,
      }),
    }));

  <span class="hljs-keyword">const</span> lastUpdate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(apiResponse.<span class="hljs-property">timestamp</span>).<span class="hljs-title function_">toLocaleString</span>(<span class="hljs-string">"zh-CN"</span>, {
    <span class="hljs-attr">year</span>: <span class="hljs-string">"numeric"</span>,
    <span class="hljs-attr">month</span>: <span class="hljs-string">"2-digit"</span>,
    <span class="hljs-attr">day</span>: <span class="hljs-string">"2-digit"</span>,
    <span class="hljs-attr">hour</span>: <span class="hljs-string">"2-digit"</span>,
    <span class="hljs-attr">minute</span>: <span class="hljs-string">"2-digit"</span>,
  });

  <span class="hljs-keyword">return</span> { jewelryBrands, bankGoldBars, lastUpdate };
};

<span class="hljs-comment">/**
 * 获取黄金价格数据（对外接口）
 * 带缓存机制
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> fetchGoldPriceData = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">GoldPriceData</span>&gt; =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 先尝试从缓存读取</span>
    <span class="hljs-keyword">const</span> cached = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>([<span class="hljs-string">'goldPriceData'</span>, <span class="hljs-string">'cacheTime'</span>]);
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> cacheAge = now - (cached.<span class="hljs-property">cacheTime</span> || <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 缓存有效期：5 分钟</span>
    <span class="hljs-keyword">if</span> (cached.<span class="hljs-property">goldPriceData</span> &amp;&amp; cacheAge &lt; <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'使用缓存数据'</span>);
      <span class="hljs-keyword">return</span> cached.<span class="hljs-property">goldPriceData</span>;
    }

    <span class="hljs-comment">// 缓存过期，重新获取</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取新数据'</span>);
    <span class="hljs-keyword">const</span> apiResponse = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchGoldPriceFromAPI</span>();
    <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">transformAPIData</span>(apiResponse);

    <span class="hljs-comment">// 保存到缓存</span>
    <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>({
      <span class="hljs-attr">goldPriceData</span>: data,
      <span class="hljs-attr">cacheTime</span>: now
    });

    <span class="hljs-keyword">return</span> data;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"获取并转换黄金价格数据失败:"</span>, error);
    
    <span class="hljs-comment">// 如果有缓存数据，即使过期也返回</span>
    <span class="hljs-keyword">const</span> cached = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>([<span class="hljs-string">'goldPriceData'</span>]);
    <span class="hljs-keyword">if</span> (cached.<span class="hljs-property">goldPriceData</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'API 失败，使用过期缓存'</span>);
      <span class="hljs-keyword">return</span> cached.<span class="hljs-property">goldPriceData</span>;
    }
    
    <span class="hljs-keyword">throw</span> error;
  }
};

<span class="hljs-comment">/**
 * 强制刷新数据
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> refreshGoldPriceData = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">GoldPriceData</span>&gt; =&gt; {
  <span class="hljs-comment">// 清除缓存时间，强制重新获取</span>
  <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">remove</span>([<span class="hljs-string">'cacheTime'</span>]);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchGoldPriceData</span>();
};
</code></pre>
<h3 data-id="heading-60">4. UI 组件实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/popup/components/JewelryCard.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JewelryBrand</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../types"</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">JewelryCardProps</span> {
  <span class="hljs-attr">brand</span>: <span class="hljs-title class_">JewelryBrand</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">JewelryCard</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">JewelryCardProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ brand }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> isPositive = brand.<span class="hljs-property">change</span> &gt;= <span class="hljs-number">0</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-white/80 backdrop-blur-sm rounded-lg p-3 shadow-sm hover:shadow-md transition-shadow"</span>&gt;</span>
      {/* 品牌名和涨跌 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-between mb-2"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-sm font-medium text-gray-800"</span>&gt;</span>{brand.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        {brand.change !== 0 &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">text-xs</span> <span class="hljs-attr">px-2</span> <span class="hljs-attr">py-0.5</span> <span class="hljs-attr">rounded-full</span> ${
              <span class="hljs-attr">isPositive</span> 
                ? "<span class="hljs-attr">bg-red-50</span> <span class="hljs-attr">text-red-600</span>" 
                <span class="hljs-attr">:</span> "<span class="hljs-attr">bg-green-50</span> <span class="hljs-attr">text-green-600</span>"
            }`}
          &gt;</span>
            {isPositive ? "+" : ""}{brand.change}
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 价格显示 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-baseline"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xl font-semibold text-amber-600"</span>&gt;</span>
          ¥{brand.price}
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs text-gray-500 ml-1"</span>&gt;</span>/克<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 更新时间 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-1 text-xs text-gray-400"</span>&gt;</span>
        {brand.updateTime}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/popup/components/BankCard.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BankGoldBar</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../types"</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">BankCardProps</span> {
  <span class="hljs-attr">bank</span>: <span class="hljs-title class_">BankGoldBar</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">BankCard</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">BankCardProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ bank }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> isPositive = bank.<span class="hljs-property">change</span> &gt;= <span class="hljs-number">0</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-white/80 backdrop-blur-sm rounded-lg p-3 shadow-sm hover:shadow-md transition-shadow"</span>&gt;</span>
      {/* 银行名和涨跌 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-between mb-2"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-sm font-medium text-gray-800"</span>&gt;</span>{bank.bankName}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        {bank.change !== 0 &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">text-xs</span> <span class="hljs-attr">px-2</span> <span class="hljs-attr">py-0.5</span> <span class="hljs-attr">rounded-full</span> ${
              <span class="hljs-attr">isPositive</span> 
                ? "<span class="hljs-attr">bg-red-50</span> <span class="hljs-attr">text-red-600</span>" 
                <span class="hljs-attr">:</span> "<span class="hljs-attr">bg-green-50</span> <span class="hljs-attr">text-green-600</span>"
            }`}
          &gt;</span>
            {isPositive ? "+" : ""}{bank.change}
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 买入/卖出价格 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex justify-between items-center"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs text-gray-500 mb-1"</span>&gt;</span>买入<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-base font-semibold text-blue-600"</span>&gt;</span>
            ¥{bank.buyPrice}
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-6 w-px bg-gray-200"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col items-end"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs text-gray-500 mb-1"</span>&gt;</span>卖出<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-base font-semibold text-purple-600"</span>&gt;</span>
            ¥{bank.sellPrice}
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 更新时间 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-2 text-xs text-gray-400 text-center"</span>&gt;</span>
        {bank.updateTime}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-61">5. 关键技术点</h3>
<h4 data-id="heading-62">错误处理与降级策略</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 多层次的错误处理</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchWithRetry</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, retries = <span class="hljs-number">3</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; retries; i++) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url);
      <span class="hljs-keyword">if</span> (response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span> response;
      
      <span class="hljs-keyword">if</span> (i === retries - <span class="hljs-number">1</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`请求失败: <span class="hljs-subst">${response.status}</span>`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (i === retries - <span class="hljs-number">1</span>) <span class="hljs-keyword">throw</span> error;
      
      <span class="hljs-comment">// 指数退避</span>
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, i) * <span class="hljs-number">1000</span>));
    }
  }
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Max retries reached'</span>);
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchWithRetry</span>(<span class="hljs-variable constant_">API_URL</span>);
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 降级到缓存数据</span>
  <span class="hljs-keyword">const</span> cached = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCachedData</span>();
  <span class="hljs-keyword">if</span> (cached) <span class="hljs-keyword">return</span> cached;
  
  <span class="hljs-comment">// 显示错误提示</span>
  <span class="hljs-title function_">showErrorNotification</span>(error);
}
</code></pre>
<h4 data-id="heading-63">性能优化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 防抖刷新</span>
<span class="hljs-keyword">function</span> debounce&lt;T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span>&gt;(
  <span class="hljs-attr">func</span>: T,
  <span class="hljs-attr">wait</span>: <span class="hljs-built_in">number</span>
): <span class="hljs-function">(<span class="hljs-params">...args: Parameters&lt;T&gt;</span>) =&gt;</span> <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">timeout</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args: Parameters&lt;T&gt;</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timeout);
    timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">func</span>(...args), wait);
  };
}

<span class="hljs-keyword">const</span> debouncedRefresh = <span class="hljs-title function_">debounce</span>(refreshGoldPriceData, <span class="hljs-number">1000</span>);

<span class="hljs-comment">// 2. 数据预加载</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onInstalled</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 安装时预先获取数据</span>
  <span class="hljs-title function_">fetchGoldPriceData</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
});

<span class="hljs-comment">// 3. 后台定时更新</span>
chrome.<span class="hljs-property">alarms</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'updatePrices'</span>, {
  <span class="hljs-attr">periodInMinutes</span>: <span class="hljs-number">30</span>
});

chrome.<span class="hljs-property">alarms</span>.<span class="hljs-property">onAlarm</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">alarm</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (alarm.<span class="hljs-property">name</span> === <span class="hljs-string">'updatePrices'</span>) {
    <span class="hljs-title function_">fetchGoldPriceData</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
  }
});
</code></pre>
<hr/>
<h2 data-id="heading-64">跨浏览器兼容性处理</h2>
<h3 data-id="heading-65">1. 使用 webextension-polyfill</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 安装</span>
npm install webextension-polyfill
npm install --save-dev <span class="hljs-meta">@types</span>/webextension-polyfill

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Browser</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'webextension-polyfill'</span>;

<span class="hljs-comment">// 统一的 Promise 风格 API</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Browser</span>.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'key'</span>);
<span class="hljs-keyword">const</span> tabs = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Browser</span>.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">query</span>({ <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span> });

<span class="hljs-comment">// 自动处理回调转 Promise</span>
<span class="hljs-title class_">Browser</span>.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>({ <span class="hljs-attr">action</span>: <span class="hljs-string">'test'</span> })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response))
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error));
</code></pre>
<h3 data-id="heading-66">2. Vite 配置差异</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.chrome.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">crx</span>({
      <span class="hljs-attr">manifest</span>: {
        ...baseManifest,
        <span class="hljs-attr">background</span>: {
          <span class="hljs-attr">service_worker</span>: <span class="hljs-string">'src/pages/background/index.ts'</span>,  <span class="hljs-comment">// Chrome: Service Worker</span>
          <span class="hljs-attr">type</span>: <span class="hljs-string">'module'</span>
        },
      },
      <span class="hljs-attr">browser</span>: <span class="hljs-string">'chrome'</span>,
    })
  ],
});

<span class="hljs-comment">// vite.config.firefox.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">crx</span>({
      <span class="hljs-attr">manifest</span>: {
        ...baseManifest,
        <span class="hljs-attr">background</span>: {
          <span class="hljs-attr">scripts</span>: [<span class="hljs-string">'src/pages/background/index.ts'</span>]  <span class="hljs-comment">// Firefox: Scripts Array</span>
        },
      },
      <span class="hljs-attr">browser</span>: <span class="hljs-string">'firefox'</span>,
    })
  ],
});
</code></pre>
<h3 data-id="heading-67">3. 浏览器特性检测</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/browser.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getBrowserInfo</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> userAgent = navigator.<span class="hljs-property">userAgent</span>;
  
  <span class="hljs-keyword">if</span> (userAgent.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'Edg/'</span>)) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'Edge'</span>, <span class="hljs-attr">isChromium</span>: <span class="hljs-literal">true</span> };
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userAgent.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'Chrome'</span>)) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'Chrome'</span>, <span class="hljs-attr">isChromium</span>: <span class="hljs-literal">true</span> };
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userAgent.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'Firefox'</span>)) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'Firefox'</span>, <span class="hljs-attr">isChromium</span>: <span class="hljs-literal">false</span> };
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userAgent.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'Safari'</span>)) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'Safari'</span>, <span class="hljs-attr">isChromium</span>: <span class="hljs-literal">false</span> };
  }
  
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'Unknown'</span>, <span class="hljs-attr">isChromium</span>: <span class="hljs-literal">false</span> };
};

<span class="hljs-comment">// 根据浏览器调整行为</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> isSidePanel <span class="hljs-title class_">Supported</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> { name } = <span class="hljs-title function_">getBrowserInfo</span>();
  <span class="hljs-keyword">return</span> name === <span class="hljs-string">'Chrome'</span> || name === <span class="hljs-string">'Edge'</span>;
};

<span class="hljs-comment">// 条件性使用 API</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'sidePanel'</span> <span class="hljs-keyword">in</span> chrome) {
  chrome.<span class="hljs-property">sidePanel</span>.<span class="hljs-title function_">setOptions</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'panel.html'</span> });
}
</code></pre>
<hr/>
<h2 data-id="heading-68">调试技巧与最佳实践</h2>
<h3 data-id="heading-69">1. 调试工具</h3>
<h4 data-id="heading-70">Background Script 调试</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Chrome</span>
1. 打开 chrome://extensions
2. 找到你的扩展
3. 点击 <span class="hljs-string">"service worker"</span> 或 <span class="hljs-string">"背景页"</span>
4. 打开 DevTools 控制台

<span class="hljs-comment"># Firefox</span>
1. 打开 about:debugging
2. 点击 <span class="hljs-string">"检查"</span>
3. 打开浏览器控制台
</code></pre>
<h4 data-id="heading-71">Content Script 调试</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 直接在网页中调试</span>
1. 打开目标网页
2. 按 F12 打开开发者工具
3. 在 Console 中可以看到 Content Script 的日志
4. 在 Sources/Debugger 标签可以找到注入的脚本
</code></pre>
<h4 data-id="heading-72">Popup 调试</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Chrome</span>
1. 右键点击扩展图标
2. 选择 <span class="hljs-string">"检查弹出内容"</span>
3. DevTools 会附加到 Popup

<span class="hljs-comment"># Firefox</span>
1. 右键点击扩展图标
2. 选择 <span class="hljs-string">"调试此扩展"</span>
</code></pre>
<h3 data-id="heading-73">2. 日志系统</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/logger.ts</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">LogLevel</span> {
  <span class="hljs-variable constant_">DEBUG</span> = <span class="hljs-number">0</span>,
  <span class="hljs-variable constant_">INFO</span> = <span class="hljs-number">1</span>,
  <span class="hljs-variable constant_">WARN</span> = <span class="hljs-number">2</span>,
  <span class="hljs-variable constant_">ERROR</span> = <span class="hljs-number">3</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Logger</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">level</span>: <span class="hljs-title class_">LogLevel</span> = <span class="hljs-title class_">LogLevel</span>.<span class="hljs-property">INFO</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">prefix</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">prefix: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prefix</span> = <span class="hljs-string">`[<span class="hljs-subst">${prefix}</span>]`</span>;
  }

  <span class="hljs-title function_">setLevel</span>(<span class="hljs-params">level: LogLevel</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">level</span> = level;
  }

  <span class="hljs-title function_">debug</span>(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">level</span> &lt;= <span class="hljs-title class_">LogLevel</span>.<span class="hljs-property">DEBUG</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prefix</span>, <span class="hljs-string">'[DEBUG]'</span>, ...args);
    }
  }

  <span class="hljs-title function_">info</span>(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">level</span> &lt;= <span class="hljs-title class_">LogLevel</span>.<span class="hljs-property">INFO</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prefix</span>, <span class="hljs-string">'[INFO]'</span>, ...args);
    }
  }

  <span class="hljs-title function_">warn</span>(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">level</span> &lt;= <span class="hljs-title class_">LogLevel</span>.<span class="hljs-property">WARN</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prefix</span>, <span class="hljs-string">'[WARN]'</span>, ...args);
    }
  }

  <span class="hljs-title function_">error</span>(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">level</span> &lt;= <span class="hljs-title class_">LogLevel</span>.<span class="hljs-property">ERROR</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prefix</span>, <span class="hljs-string">'[ERROR]'</span>, ...args);
    }
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-string">'GoldPrice'</span>);

<span class="hljs-comment">// 使用</span>
logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'获取价格数据'</span>);
logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'API 请求失败'</span>, error);
</code></pre>
<h3 data-id="heading-74">3. 性能监控</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 性能计时</span>
<span class="hljs-keyword">const</span> startTime = performance.<span class="hljs-title function_">now</span>();
<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchGoldPriceData</span>();
<span class="hljs-keyword">const</span> endTime = performance.<span class="hljs-title function_">now</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`数据获取耗时: <span class="hljs-subst">${(endTime - startTime).toFixed(<span class="hljs-number">2</span>)}</span>ms`</span>);

<span class="hljs-comment">// 使用 Performance API</span>
performance.<span class="hljs-title function_">mark</span>(<span class="hljs-string">'fetch-start'</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
performance.<span class="hljs-title function_">mark</span>(<span class="hljs-string">'fetch-end'</span>);
performance.<span class="hljs-title function_">measure</span>(<span class="hljs-string">'fetch-duration'</span>, <span class="hljs-string">'fetch-start'</span>, <span class="hljs-string">'fetch-end'</span>);

<span class="hljs-keyword">const</span> measures = performance.<span class="hljs-title function_">getEntriesByName</span>(<span class="hljs-string">'fetch-duration'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`数据获取耗时: <span class="hljs-subst">${measures[<span class="hljs-number">0</span>].duration}</span>ms`</span>);
</code></pre>
<hr/>
<h2 data-id="heading-75">性能优化策略</h2>
<h3 data-id="heading-76">1. Content Script 优化</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 不好：阻塞主线程</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.item'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  <span class="hljs-comment">// 大量 DOM 操作</span>
  item.<span class="hljs-property">innerHTML</span> = <span class="hljs-title function_">generateComplexHTML</span>();
});

<span class="hljs-comment">// ✅ 好：批量操作，使用 DocumentFragment</span>
<span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>();
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.item'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> newElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  newElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-title function_">generateComplexHTML</span>();
  fragment.<span class="hljs-title function_">appendChild</span>(newElement);
});
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(fragment);

<span class="hljs-comment">// ✅ 更好：使用 IntersectionObserver 延迟加载</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
      <span class="hljs-title function_">enhanceElement</span>(entry.<span class="hljs-property">target</span>);
      observer.<span class="hljs-title function_">unobserve</span>(entry.<span class="hljs-property">target</span>);
    }
  });
});

<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.item'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  observer.<span class="hljs-title function_">observe</span>(item);
});
</code></pre>
<h3 data-id="heading-77">2. 资源优化</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 代码分割</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadHeavyFeature</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./heavy-feature'</span>);
  <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">initialize</span>();
};

<span class="hljs-comment">// 图片懒加载</span>
<span class="hljs-keyword">const</span> imageUrl = chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">getURL</span>(<span class="hljs-string">'images/large-image.png'</span>);
<span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
img.<span class="hljs-property">loading</span> = <span class="hljs-string">'lazy'</span>;
img.<span class="hljs-property">src</span> = imageUrl;

<span class="hljs-comment">// 压缩数据</span>
<span class="hljs-keyword">import</span> pako <span class="hljs-keyword">from</span> <span class="hljs-string">'pako'</span>;

<span class="hljs-comment">// 保存时压缩</span>
<span class="hljs-keyword">const</span> compressed = pako.<span class="hljs-title function_">deflate</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(largeData));
<span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>({ <span class="hljs-attr">data</span>: compressed });

<span class="hljs-comment">// 读取时解压</span>
<span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'data'</span>);
<span class="hljs-keyword">const</span> decompressed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(pako.<span class="hljs-title function_">inflate</span>(data, { <span class="hljs-attr">to</span>: <span class="hljs-string">'string'</span> }));
</code></pre>
<h3 data-id="heading-78">3. 内存管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 及时清理监听器</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">listener</span>: (<span class="hljs-function">(<span class="hljs-params">changes: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">startMonitoring</span>(<span class="hljs-params"/>) {
  listener = <span class="hljs-function">(<span class="hljs-params">changes</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Storage changed:'</span>, changes);
  };
  chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">onChanged</span>.<span class="hljs-title function_">addListener</span>(listener);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">stopMonitoring</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (listener) {
    chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">onChanged</span>.<span class="hljs-title function_">removeListener</span>(listener);
    listener = <span class="hljs-literal">null</span>;
  }
}

<span class="hljs-comment">// 限制缓存大小</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">addToCache</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'cache'</span>) || {};
  <span class="hljs-keyword">const</span> cacheKeys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(cache);
  
  <span class="hljs-comment">// 最多保留 100 条</span>
  <span class="hljs-keyword">if</span> (cacheKeys.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">100</span>) {
    <span class="hljs-keyword">const</span> oldest = cacheKeys[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">delete</span> cache[oldest];
  }
  
  cache[key] = data;
  <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>({ cache });
}
</code></pre>
<hr/>
<h2 data-id="heading-79">打包构建与发布</h2>
<h3 data-id="heading-80">1. 生产构建</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建 Chrome 版本</span>
npm run build:chrome

<span class="hljs-comment"># 构建 Firefox 版本</span>
npm run build:firefox

<span class="hljs-comment"># 输出目录</span>
<span class="hljs-comment"># dist_chrome/   # Chrome 扩展文件</span>
<span class="hljs-comment"># dist_firefox/  # Firefox 扩展文件</span>
</code></pre>
<h3 data-id="heading-81">2. 打包为 ZIP</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 手动打包</span>
<span class="hljs-built_in">cd</span> dist_chrome
zip -r ../extension-chrome.zip *

<span class="hljs-built_in">cd</span> ../dist_firefox
zip -r ../extension-firefox.zip *

<span class="hljs-comment"># 或使用脚本</span>
npm install --save-dev archiver

// scripts/zip.js
const archiver = require(<span class="hljs-string">'archiver'</span>);
const fs = require(<span class="hljs-string">'fs'</span>);

<span class="hljs-keyword">function</span> zipDirectory(<span class="hljs-built_in">source</span>, out) {
  const archive = archiver(<span class="hljs-string">'zip'</span>, { zlib: { level: 9 } });
  const stream = fs.createWriteStream(out);

  <span class="hljs-built_in">return</span> new Promise((resolve, reject) =&gt; {
    archive
      .directory(source, false)
      .on('error', reject)
      .pipe(stream);

    stream.on('close', resolve);
    archive.finalize();
  });
}

zipDirectory('./dist_chrome', './extension-chrome.zip');
</code></pre>
<h3 data-id="heading-82">3. 发布到 Chrome Web Store</h3>
<h4 data-id="heading-83">准备工作</h4>
<ol>
<li>
<p><strong>注册开发者账号</strong></p>
<ul>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fchrome.google.com%2Fwebstore%2Fdevconsole%2F" target="_blank" title="https://chrome.google.com/webstore/devconsole/" ref="nofollow noopener noreferrer">Chrome Web Store Developer Dashboard</a></li>
<li>支付 $5 一次性注册费</li>
</ul>
</li>
<li>
<p><strong>准备资料</strong></p>
<ul>
<li>扩展 ZIP 文件</li>
<li>图标（128x128px）</li>
<li>截图（至少 1 张，1280x800 或 640x400）</li>
<li>推广图片（可选，440x280px）</li>
<li>详细描述（英文，最多 132 字符简介 + 详细说明）</li>
</ul>
</li>
</ol>
<h4 data-id="heading-84">发布流程</h4>
<pre><code class="hljs language-bash" lang="bash">1. 登录 Developer Dashboard
2. 点击 <span class="hljs-string">"New Item"</span>
3. 上传 ZIP 文件
4. 填写商店信息：
   - 名称和描述
   - 类别和语言
   - 截图和图标
   - 隐私政策（如果使用了用户数据）
5. 定价和分发：
   - 免费或付费
   - 发布地区
6. 提交审核
</code></pre>
<p><strong>审核时间：</strong> 通常 1-3 天</p>
<h3 data-id="heading-85">4. 发布到 Firefox Add-ons</h3>
<h4 data-id="heading-86">准备工作</h4>
<ol>
<li>
<p><strong>注册账号（免费）</strong></p>
<ul>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Faddons.mozilla.org%2Fdevelopers%2F" target="_blank" title="https://addons.mozilla.org/developers/" ref="nofollow noopener noreferrer">Firefox Add-on Developer Hub</a></li>
</ul>
</li>
<li>
<p><strong>签名要求</strong></p>
<ul>
<li>Firefox 要求所有扩展必须签名</li>
<li>可以选择自动签名（不上架）或完整审核（上架）</li>
</ul>
</li>
</ol>
<h4 data-id="heading-87">发布流程</h4>
<pre><code class="hljs language-bash" lang="bash">1. 登录 Developer Hub
2. Submit a New Add-on
3. 选择分发方式：
   - On this site (完整审核，公开发布)
   - On your own (自动签名，自行分发)
4. 上传 ZIP 文件
5. 填写信息：
   - 名称、描述、分类
   - 版本说明
   - 许可证
   - 隐私政策
6. 提交审核
</code></pre>
<p><strong>审核时间：</strong> 人工审核通常 1-5 天</p>
<h3 data-id="heading-88">5. GitHub Actions 自动化</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/release.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">and</span> <span class="hljs-string">Release</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'v*'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node.js</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-string">'20'</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">Chrome</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">build:chrome</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">Firefox</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">build:firefox</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">ZIP</span> <span class="hljs-string">files</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          cd dist_chrome &amp;&amp; zip -r ../extension-chrome.zip * &amp;&amp; cd ..
          cd dist_firefox &amp;&amp; zip -r ../extension-firefox.zip * &amp;&amp; cd ..
</span>      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">Release</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">softprops/action-gh-release@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">files:</span> <span class="hljs-string">|
            extension-chrome.zip
            extension-firefox.zip
</span>        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">GITHUB_TOKEN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">}}</span>
</code></pre>
<hr/>
<h2 data-id="heading-89">常见问题与解决方案</h2>
<h3 data-id="heading-90">1. Manifest 错误</h3>
<p><strong>问题：</strong> <code>Manifest version 3 is not supported</code></p>
<p><strong>解决：</strong></p>
<ul>
<li>确保 Chrome 版本 &gt;= 88</li>
<li>Firefox 需要特殊配置支持 MV3</li>
</ul>
<p><strong>问题：</strong> <code>Permission 'tabs' is not recognized</code></p>
<p><strong>解决：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"tabs"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"https://*/*"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"tabs"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"host_permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"https://*/*"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-91">2. Content Script 问题</h3>
<p><strong>问题：</strong> Content Script 无法访问页面变量</p>
<p><strong>解决：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 不能直接访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">pageVariable</span>);

<span class="hljs-comment">// ✅ 通过 postMessage 通信</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'GET_DATA'</span> }, <span class="hljs-string">'*'</span>);
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'DATA_RESPONSE'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">value</span>);
  }
});

<span class="hljs-comment">// 页面脚本</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'GET_DATA'</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">postMessage</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">'DATA_RESPONSE'</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageVariable</span>
    }, <span class="hljs-string">'*'</span>);
  }
});
</code></pre>
<h3 data-id="heading-92">3. CORS 问题</h3>
<p><strong>问题：</strong> <code>Fetch API cannot load due to CORS policy</code></p>
<p><strong>解决：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// manifest.json 添加 host_permissions</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"host_permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"https://api.example.com/*"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 或在 Background Script 中代理请求</span>
<span class="hljs-comment">// Content Script</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>({
  <span class="hljs-attr">action</span>: <span class="hljs-string">'fetch'</span>,
  <span class="hljs-attr">url</span>: <span class="hljs-string">'https://api.example.com/data'</span>
}, <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response);
});

<span class="hljs-comment">// Background Script</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">request, sender, sendResponse</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">action</span> === <span class="hljs-string">'fetch'</span>) {
    <span class="hljs-title function_">fetch</span>(request.<span class="hljs-property">url</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-title function_">sendResponse</span>(data))
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-title function_">sendResponse</span>({ <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> }));
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 异步响应</span>
  }
});
</code></pre>
<h3 data-id="heading-93">4. Storage 配额问题</h3>
<p><strong>问题：</strong> <code>QUOTA_BYTES quota exceeded</code></p>
<p><strong>解决：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 检查存储使用量</span>
<span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">getBytesInUse</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`已使用: <span class="hljs-subst">${bytes}</span> / <span class="hljs-subst">${chrome.storage.local.QUOTA_BYTES}</span>`</span>);

<span class="hljs-comment">// 定期清理旧数据</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> all = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(all);
  
  <span class="hljs-comment">// 删除超过 7 天的数据</span>
  <span class="hljs-keyword">const</span> sevenDaysAgo = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;
  <span class="hljs-keyword">const</span> toRemove = keys.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> item = all[key];
    <span class="hljs-keyword">return</span> item.<span class="hljs-property">timestamp</span> &amp;&amp; item.<span class="hljs-property">timestamp</span> &lt; sevenDaysAgo;
  });
  
  <span class="hljs-keyword">if</span> (toRemove.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">remove</span>(toRemove);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`清理了 <span class="hljs-subst">${toRemove.length}</span> 条过期数据`</span>);
  }
}
</code></pre>
<h3 data-id="heading-94">5. Service Worker 生命周期</h3>
<p><strong>问题：</strong> Background Service Worker 意外休眠</p>
<p><strong>解决：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 不要依赖全局变量</span>
<span class="hljs-keyword">let</span> cache = {};  <span class="hljs-comment">// Service Worker 休眠后会丢失</span>

<span class="hljs-comment">// ✅ 使用 chrome.storage</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCache</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'cache'</span>);
  <span class="hljs-keyword">return</span> result.<span class="hljs-property">cache</span> || {};
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setCache</span>(<span class="hljs-params">cache</span>) {
  <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>({ cache });
}

<span class="hljs-comment">// ❌ 不要使用 setTimeout</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">doSomething</span>();
}, <span class="hljs-number">60000</span>);  <span class="hljs-comment">// 可能不会执行</span>

<span class="hljs-comment">// ✅ 使用 chrome.alarms</span>
chrome.<span class="hljs-property">alarms</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'task'</span>, { <span class="hljs-attr">delayInMinutes</span>: <span class="hljs-number">1</span> });
chrome.<span class="hljs-property">alarms</span>.<span class="hljs-property">onAlarm</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">alarm</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (alarm.<span class="hljs-property">name</span> === <span class="hljs-string">'task'</span>) {
    <span class="hljs-title function_">doSomething</span>();
  }
});
</code></pre>
<hr/>
<h2 data-id="heading-95">参考资料</h2>
<h3 data-id="heading-96">官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2F" target="_blank" title="https://developer.chrome.com/docs/extensions/" ref="nofollow noopener noreferrer">Chrome Extensions 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FMozilla%2FAdd-ons%2FWebExtensions" target="_blank" title="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions" ref="nofollow noopener noreferrer">MDN Web Extensions</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fextensionworkshop.com%2F" target="_blank" title="https://extensionworkshop.com/" ref="nofollow noopener noreferrer">Firefox Extension Workshop</a></li>
</ul>
<h3 data-id="heading-97">工具和库</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcrxjs.dev%2Fvite-plugin" target="_blank" title="https://crxjs.dev/vite-plugin" ref="nofollow noopener noreferrer">@crxjs/vite-plugin</a> - Vite 插件</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmozilla%2Fwebextension-polyfill" target="_blank" title="https://github.com/mozilla/webextension-polyfill" ref="nofollow noopener noreferrer">webextension-polyfill</a> - 浏览器兼容层</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDefinitelyTyped%2FDefinitelyTyped%2Ftree%2Fmaster%2Ftypes%2Fchrome" target="_blank" title="https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/chrome" ref="nofollow noopener noreferrer">Chrome Types</a> - TypeScript 类型定义</li>
</ul>
<h3 data-id="heading-98">社区资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGoogleChrome%2Fchrome-extensions-samples" target="_blank" title="https://github.com/GoogleChrome/chrome-extensions-samples" ref="nofollow noopener noreferrer">Chrome Extension Samples</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffregante%2FAwesome-WebExtensions" target="_blank" title="https://github.com/fregante/Awesome-WebExtensions" ref="nofollow noopener noreferrer">Awesome Browser Extensions</a></li>
</ul>
<h2 data-id="heading-99">每日金价仓库地址是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Filcherry%2Fdaily-gold-price" target="_blank" title="https://github.com/ilcherry/daily-gold-price" ref="nofollow noopener noreferrer">github.com/ilcherry/da…</a></h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[App Store 上架 App 的完整指南，从开发准备到 IPA 上传的跨平台实战流程]]></title>    <link>https://juejin.cn/post/7573855399716519955</link>    <guid>https://juejin.cn/post/7573855399716519955</guid>    <pubDate>2025-11-18T07:34:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573855399716519955" data-draft-id="7573738017987887147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="App Store 上架 App 的完整指南，从开发准备到 IPA 上传的跨平台实战流程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-18T07:34:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="00后程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1159358440539900"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            App Store 上架 App 的完整指南，从开发准备到 IPA 上传的跨平台实战流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1159358440539900/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    00后程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T07:34:50.000Z" title="Tue Nov 18 2025 07:34:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动应用开发中，“App Store 上架 App” 往往是最容易让开发者紧张的一步。
无论是首次上架的新项目，还是迭代更新的商业 App，只要涉及证书体系、IPA 构建、审核流程，就常常会遇到各种问题——证书无效、上传失败、截图不合规、审核被拒……</p>
<p>但上架流程本身并不神秘，只要理解苹果的规范和工具链，就能系统化地完成整个过程。
本文将站在开发者的角度，给出一份 <strong>适用于 macOS / Windows / Linux 的完整上架方案</strong>，重点介绍 App Store 上架的关键流程与可选择的工具组合。</p>
<hr/>
<h2 data-id="heading-0">一、App Store 上架流程一览</h2>
<p>无论是原生开发还是跨平台开发，要上架 App Store 都必须完成以下步骤：</p>
<ol>
<li>创建开发者账号（Apple Developer Program）</li>
<li>准备 App ID、证书与描述文件</li>
<li>构建并签名 IPA 包</li>
<li>上传 IPA 到 App Store Connect</li>
<li>填写应用信息、截图、隐私政策</li>
<li>提交审核并等待结果</li>
</ol>
<p>虽然步骤固定，但实际操作受工具和平台影响很大，因此灵活选择工具是提升效率的关键。</p>
<hr/>
<h2 data-id="heading-1">二、上架前的基础准备：账号与应用资料</h2>
<h3 data-id="heading-2">1. 开发者账号</h3>
<p>所有 App Store 上架都必须使用付费开发者账号（$99 / 年）。
账号注册后可以使用：</p>
<ul>
<li>App Store Connect（应用管理）</li>
<li>证书生成与签名系统</li>
<li>TestFlight 测试</li>
<li>应用审核流程</li>
</ul>
<h3 data-id="heading-3">2. 应用资料清单</h3>
<p>在上传 IPA 前，需要提前准备：</p>
<ul>
<li>应用名称、简介、关键词</li>
<li>App 图标（1024×1024）</li>
<li>隐私政策链接</li>
<li>应用截图（6.5 寸、5.5 寸、iPad 尺寸等）</li>
<li>权限用途说明（麦克风、相机、定位等）</li>
</ul>
<p>这些内容将在 App Store Connect 中填写。</p>
<hr/>
<h2 data-id="heading-4">三、证书体系：上架最容易出问题的部分</h2>
<p>苹果通过证书体系确保上传者身份真实可信。
必须准备的证书包括：</p>

















<table><thead><tr><th>类型</th><th>用途</th></tr></thead><tbody><tr><td>iOS Distribution</td><td>用于发布到 App Store</td></tr><tr><td>Provisioning Profile</td><td>包含 Bundle ID、证书等信息，控制 IPA 签名</td></tr></tbody></table>
<p>过去必须使用 Mac 的钥匙串助手生成证书，但如今已经有跨平台方案。</p>
<hr/>
<h2 data-id="heading-5">四、跨平台证书生成：适用于没有 Mac 的开发者</h2>
<p>对于 Windows / Linux 用户，可以使用跨平台工具生成证书，例如：</p>
<h3 data-id="heading-6"><strong>开心上架（Appuploader CLI）生成证书</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f838c2971bf54c1a8a84811672b1b8be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMDDlkI7nqIvluo_lkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764056090&amp;x-signature=Fwq98fnMk68ccTm7r0f8PAhe2xA%3D" alt="证书" loading="lazy"/></p>
<p>生成内容包括：</p>
<ul>
<li>p12 证书</li>
<li>描述文件</li>
<li>与 Apple 账号绑定的签名文件</li>
</ul>
<p>证书可跨电脑共享，适合团队协作，也适合无 Mac 环境。</p>
<hr/>
<h2 data-id="heading-7">五、构建 IPA 包：根据开发方式选择对应工具</h2>
<p>不同开发方式对应不同构建方案：</p>
<h3 data-id="heading-8">1. 原生开发（Swift / Objective-C）</h3>
<p>使用 Mac + Xcode 构建：</p>
<pre><code class="hljs">Product → Archive → Export IPA
</code></pre>
<h3 data-id="heading-9">2. uni-app</h3>
<p>使用 HBuilderX 云打包即可获得 IPA，无需安装 Xcode。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebce08b202b64163a1efca069494d333~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMDDlkI7nqIvluo_lkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764056090&amp;x-signature=pukjxor%2BEO2ctKymdso1XQNY0AY%3D" alt="hb打包" loading="lazy"/></p>
<h3 data-id="heading-10">3. Flutter</h3>
<p>可使用以下云构建服务：</p>
<ul>
<li>Codemagic</li>
<li>Bitrise</li>
<li>GitHub Actions（远程 Mac Runner）</li>
</ul>
<h3 data-id="heading-11">4. React Native / Ionic / Capacitor</h3>
<p>可使用：</p>
<ul>
<li>Expo Cloud Build</li>
<li>第三方 CI 平台构建</li>
</ul>
<p>无论采用哪种方式，只要最终得到 <strong>签名正确的 IPA 文件</strong> 即可。</p>
<hr/>
<h2 data-id="heading-12">六、上传 IPA 到 App Store：工具对比与最佳解法</h2>
<p>苹果官方提供的上传方式包括：</p>

























<table><thead><tr><th>工具</th><th>平台</th><th>特点</th></tr></thead><tbody><tr><td>Xcode Organizer</td><td>macOS</td><td>官方、但完全依赖 Mac</td></tr><tr><td>Transporter</td><td>macOS</td><td>图形化上传，不支持自动化</td></tr><tr><td>altool</td><td>macOS</td><td>已弃用</td></tr></tbody></table>
<p>对于 Windows 或 Linux 开发者来说，这些方式不可用。</p>
<hr/>
<h2 data-id="heading-13">七、跨平台上传 IPA 的解决方案：命令行上传</h2>
<p>最灵活的 IPA 上传方式是使用跨平台的 CLI 工具，例如新版：</p>
<h3 data-id="heading-14"><strong>开心上架（Appuploader）命令行工具</strong></h3>
<p>示例上传命令：</p>
<pre><code class="hljs language-bash" lang="bash">appuploader_cli -u ios@team.com -p xxx-xxx-xxx-xxx -c 2 -f ./build/MyApp.ipa
</code></pre>
<p>参数说明：</p>

























<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>-u</code></td><td>Apple ID</td></tr><tr><td><code>-p</code></td><td>App 专用密码</td></tr><tr><td><code>-c</code></td><td>上传通道（1 旧协议、2 新协议）</td></tr><tr><td><code>-f</code></td><td>IPA 文件</td></tr></tbody></table>
<p>CLI 上传的优势：</p>
<ul>
<li>支持 Windows / Linux / macOS</li>
<li>可集成到 CI/CD 流水线</li>
<li>上传日志与错误信息明确</li>
<li>不依赖 Mac</li>
<li>适合自动化发布与团队协作</li>
</ul>
<p>上传完成后，构建会自动出现在：</p>
<ul>
<li>TestFlight</li>
<li>App Store Connect → 构建版本</li>
</ul>
<hr/>
<h2 data-id="heading-15">八、在 App Store Connect 中配置元数据与审核提交</h2>
<p>完成 IPA 上传后，还需配置：</p>
<ul>
<li>应用截图</li>
<li>功能介绍</li>
<li>隐私权限说明</li>
<li>年龄分级</li>
<li>关键词</li>
<li>联系方式</li>
<li>法务内容（隐私政策链接）</li>
</ul>
<p>最后选择构建版本，提交审核。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c8d6567aff74c7aac684a0685500efe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMDDlkI7nqIvluo_lkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764056090&amp;x-signature=ZWiqsqJhvOZE9zr5w1cqS4DHww4%3D" alt="asc" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-16">九、审核常见问题与最终上线</h2>
<p>App Store 审核严格，常见拒绝原因包括：</p>

























<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td>权限用途描述不完整</td><td>缺少 NSCameraUsageDescription 等字段</td></tr><tr><td>截图与功能不一致</td><td>必须真实展示应用界面</td></tr><tr><td>App 闪退</td><td>初始化阶段未处理好设备权限</td></tr><tr><td>账号登录机制异常</td><td>不符合 Apple 登录要求</td></tr></tbody></table>
<p>通常正常 App 的审核时间：</p>
<ul>
<li>首次上架：2–7 天</li>
<li>版本更新：1–3 天</li>
</ul>
<hr/>
<p>“App Store 上架 App” 看似复杂，但流程本质是清晰的：准备 → 构建 → 签名 → 上传 → 配置 → 审核。</p>
<p>如今无论你是否拥有 Mac，都能通过云打包 + 跨平台证书管理 + 跨系统 IPA 上传工具，完成完整的上架流程。</p>
<p>对开发者而言，关键不是平台，而是是否掌握了正确的流程与合适的工具组合。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>